/*                           
$Name:        irstartrepacc.mac
$Module:      Репозитарий
$Description: запуск, выполнение конвейера РУ
*/

//запуск на выполнение сервисной операции репозитарного учета
//формирование протокола сервисной операции репозитарного учета
import IRInter, BankInter, XmlRpcInter, "dllog_xml.mac", "DlReport_h.mac", "dldlngfun.mac";

const IR_REPACC_SRS     = 25;    //Вид конвейера - Формирование СРС
const IR_REPACC_SVODSRS = 26;    //Вид конвейера - Формирование сводных СРС
const IR_REPACC_SVODSRS093 = 28; //Вид конвейера - Формирование 093 СРС
const IR_REPACC_SRS_GA = 29;     //Вид конвейера - формирование СРС по ГС
const IR_REPACC_RECON = 30;      //Вид конвейера - процедура сверки
const IR_REPACC_SRS094 = 31;     //Вид конвейера - Формирование 094 СРС
const IR_REPACC_SRS092 = 32;     //Вид конвейера - Формирование 092 СРС


//класс с данными для строки протокола
class CIR_RepAccRepParm( _Action:string,
                         _DealCode:string,
                         _MsgCode:string,
                         _Status:string, 
                         _DealID:string,
                         _DealKind:string)
  var Action    = _Action;    //Действие                         
  var DealCode  = _DealCode;  //Код сделки
  var MsgCode   = _MsgCode;   //Код сообщения
  var Status    = _Status;    //Статус
  var DealID    = _DealID;
  var DealKind  = _DealKind;
end;

//класс с данными для списка ошибок в протоколе
class CIR_RepAccRepErr( _DealID:string, _DealKind:string, _DealCode:string, _MsgCode:string, _ErrStr:string, _Field:string, _Action:string, _FldNumber:integer)
 var DealCode  = _DealCode;
 var MsgCode   = _MsgCode;
 var ErrStr    = _ErrStr;
 var Field     = _Field;
 var Action    = _Action;
 var FldNumber = _FldNumber;
 var DealID    = _DealID;
 var DealKind  = _DealKind;
end;
                                                             
/*private*/ var RepErrArr = TArray(); //массив ошибок

class CMesCountry(/*_InternalMessageID:Integer,*/ _Country:Integer,/* _IrPartyID:Integer,*/ _PartyType:string)
//  var InternalMessageID = _InternalMessageID; // Идентификатор сообщения
  var Country           = _Country;           // Контрагент
//  var IrPartyID         = _IrPartyID;         // Идентификатор Ir_Party
  var PartyType         = _PartyType;         // CounterPartyN 
end;

var MesCountry = TArray();



CLASS (DL_LOG_FROM_XML) REPACC_LOG_FROM_XML(pDocKind:integer, pID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var DealData:CIR_RepAccRepParm;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACTION", V_STRING, DealData.Action) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALCODE", V_STRING, DealData.DealCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MSGCODE", V_STRING, DealData.MsgCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "STATUS", V_STRING, DealData.Status) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALID", V_STRING, DealData.DealID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALKIND", V_STRING, DealData.DealKind) == false)
        end;

        return DealData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pID, pType, pOnlyLastReport);

END;

/*лог ошибок*/
PRIVATE CLASS (DL_LOG_FROM_XML) IR_ERROR_LOG_FROM_XML(pDocKind:integer, pID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var ErrorData:CIR_RepAccRepErr;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALCODE", V_STRING, ErrorData.DealCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MSGCODE", V_STRING, ErrorData.MsgCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FIELD", V_STRING, ErrorData.Field) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ERRSTR", V_STRING, ErrorData.ErrStr) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACTION", V_STRING, ErrorData.Action) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FLDNUMBER", V_INTEGER, ErrorData.FldNumber) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALID", V_INTEGER, ErrorData.DealID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALKIND", V_INTEGER, ErrorData.DealKind) == false)
        end;
        
        return ErrorData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pID, pType, pOnlyLastReport);

END;

/*лог ошибок СО*/
CLASS (DL_LOG_DATA_XML) IR_REPACC_ERROR_LOG_DATA_XML(pDocKind:integer, pID:integer, pDataParms:TArray, pType:integer, pVersion:integer)

  PRIVATE MACRO СоздатьУзелОшибок(i)
     var УзелОшибок = null;

     if( m_Version == 1 )
        УзелОшибок = CreateElement("Property",
                                   "DealCode",  m_DataParms[i].DealCode,
                                   "MsgCode",   m_DataParms[i].MsgCode,
                                   "Field",     m_DataParms[i].Field,
                                   "ErrStr",    m_DataParms[i].ErrStr,
                                   "Action",    m_DataParms[i].Action,
                                   "FldNumber", m_DataParms[i].FldNumber,
                                   "DealID",    m_DataParms[i].DealID,
                                   "DealKind",  m_DataParms[i].DealKind
                                  );
     else
        УзелОшибок = CreateElement("Property");
     end;
     
     return УзелОшибок;
  END;

  initDL_LOG_DATA_XML(pDocKind, pID, pDataParms, pType, pVersion);
END;


MACRO IR_GetLogDataXML( DocKind:integer, ID:integer, Type:integer, OnlyLastReport:bool )
  var xml_obj = null;

  if( Type == LOG_TYPE_DATA )
     xml_obj = REPACC_LOG_FROM_XML(DocKind, ID, Type, OnlyLastReport);
  elif(Type == LOG_TYPE_ERROR )
     xml_obj = IR_ERROR_LOG_FROM_XML(DocKind, ID, Type, OnlyLastReport);
  end;

  return xml_obj;
END;

private macro SaveRepAccErrForReport_XML( RepErrArr, ID:integer, DocKind:integer )

  var RepXML = "";

  if( RepErrArr.Size > 0 )
     RepXML = IR_REPACC_ERROR_LOG_DATA_XML(DocKind, ID, RepErrArr, LOG_TYPE_ERROR).GetDataXML();
  end;

  if( RepXML != "" )
     var Header = DL_LOG_HEADER_XML(DocKind).GetHeaderXML();
    var ir_op = tbfile("ir_op.dbt");
    ir_op.rec.id = ID;
    if( ir_op.geteq() )
        var Oper = ir_op.rec.operator;
        DL_InsertHeaderLog(ID, DocKind, Oper, Header);
        DL_InsertLogXMLData(ID, DocKind, LOG_TYPE_ERROR, Oper, RepXML);
    end;
  end;

end;

private var N1RepHeaderStr = "           ПРОТОКОЛ ВЫПОЛНЕНИЯ ОПЕРАЦИИ РЕПОЗИТАРНОГО УЧЕТА\n" +
                             "  Дата операции: ##########  Код: #########";

private var N1TableHeader = "Обработанные сделки\n" +
                            "┌──────────┬───────────────┬──────────────────────────────────────────────────────────────┐\n"+
                            "│  Сделка  │ Код сообщения │ Статус                                                       │\n"+
                            "├──────────┼───────────────┼──────────────────────────────────────────────────────────────┤";

private var N2TableHeader = "Ошибки подготовки\n" +
                            "┌──────────┬───────────────┬─────────────────────┬──────────────────────────────────────────────────────────────┐\n"+
                            "│  Сделка  │ Код сообщения │       Атрибут       │ Сообщение                                                    │\n"+
                            "├──────────┼───────────────┼─────────────────────┼──────────────────────────────────────────────────────────────┤";

private var N1OprStateMsg = "\n#";

private var NFooter = "\n###############################################################\n"+
                      "######################################################################                 ################\n"+
                      "────────────────────────────────────────────────────────────────────── ───────────────   дата\n"+
                      "                                 ФИО                                      подпись";

private var ResultCountDeals =  "#######################################         ######\n" + 
                                "#######################################          ######\n" + 
                                "#######################################          ######\n" +
                                "#######################################\n" + 
                                "#######################################          ######\n";


VAR MAKEDEAL = 1;
VAR CHANGEDEAL = 2;
VAR OBLIGATIONCHANGE = 3;
VAR BULKREPORT = 4;
VAR MAKECONTRACT = 5;
VAR CLOSECONTRACT = 6;
VAR RECONCILIATION = 7;
VAR FAIRVALUE = 8;
VAR MAKEDEALWTHREQUEST = 9;
VAR CHANGEDEALWTHREQUEST = 10;
VAR MAKECONTRACTWTHREQUEST = 11;
VAR OBLIGATIONCHANGEWTHREQUEST = 12;

private macro GetTableHeader(Errors:bool, pPart:integer, pHasPrevPart:bool)
  var header = "";
  if ( Errors ) // Ошибки
    if ( not pHasPrevPart )
        header = header + "Ошибки подготовки\n";
    end;
    
    header = header +  "┌──────────────────────────┬────────────────────────────────────────────────────────────────────────────────────┐\n";
    
    if   ( (pPart == MAKEDEAL)          OR (pPart == MAKEDEALWTHREQUEST) )
      header = header +"│ Действие                 │   Заключение сделки                                                                │\n";
    elif ( (pPart == CHANGEDEAL)        OR (pPart == CHANGEDEALWTHREQUEST) )
      header = header +"│ Действие                 │   Изменение условий                                                                │\n";
    elif ( (pPart == OBLIGATIONCHANGE)  OR (pPart == OBLIGATIONCHANGEWTHREQUEST) )
      header = header +"│ Действие                 │   Изменение состояния обязательств                                                 │\n";
    elif ( pPart == BULKREPORT )
      header = header +"│ Действие                 │   Сводный отчет                                                                    │\n";
    elif ( (pPart == MAKECONTRACT)      OR (pPart == MAKECONTRACTWTHREQUEST) )
      header = header +"│ Действие                 │   Заключение договора                                                              │\n";
    elif ( pPart == CLOSECONTRACT )
      header = header +"│ Действие                 │   Закрытие договора                                                                │\n";
    elif ( pPart == RECONCILIATION )
      header = header +"│ Действие                 │   Сверка                                                                           │\n";  
    elif ( pPart == FAIRVALUE )
      header = header +"│ Действие                 │   Отчет о расчете справедливой стоимости                                           │\n"; 
    else
      header = header +"│ Действие                 │   -                                                                                │\n";
    end;

    header = header +  "├──────────┬───────────────┼─────────────────────┬──────────────────────────────────────────────────────────────┤\n"+
                       "│  Сделка  │ Код сообщения │       Атрибут       │ Ошибка                                                       │\n"+
                       "├──────────┼───────────────┼─────────────────────┼──────────────────────────────────────────────────────────────┤";
  else // Обработанные сделки
    if ( not pHasPrevPart )
        header = header + "Обработанные сделки\n";
    end;
    
    header = header +  "┌──────────┬──────────────────────────────────────────────────────────────────────────────┐\n";
    
    if   ( (pPart == MAKEDEAL)          OR (pPart == MAKEDEALWTHREQUEST) )
      header = header +"│ Действие │   Заключение сделки                                                          │\n";
    elif ( (pPart == CHANGEDEAL)        OR (pPart == CHANGEDEALWTHREQUEST) )
      header = header +"│ Действие │   Изменение условий                                                          │\n";
    elif ( (pPart == OBLIGATIONCHANGE)  OR (pPart == OBLIGATIONCHANGEWTHREQUEST) )
      header = header +"│ Действие │   Изменение состояния обязательств                                           │\n";
    elif ( pPart == BULKREPORT )
      header = header +"│ Действие │   Сводный отчет                                                              │\n";
    elif ( (pPart == MAKECONTRACT)      OR (pPart == MAKECONTRACTWTHREQUEST) )
      header = header +"│ Действие │   Заключение договора                                                        │\n";
    elif ( pPart == CLOSECONTRACT )
      header = header +"│ Действие │   Закрытие договора                                                          │\n";
    elif ( pPart == RECONCILIATION )
      header = header +"│ Действие │   Сверка                                                                     │\n";  
    elif ( pPart == FAIRVALUE )
      header = header +"│ Действие │   Отчет о расчете справедливой стоимости                                     │\n"; 
    else
      header = header +"│ Действие │   -                                                                          │\n";
    end;

    header = header +  "├──────────┼───────────────┬──────────────────────────────────────────────────────────────┤\n"+
                       "│  Сделка  │ Код сообщения │ Статус                                                       │\n"+
                       "├──────────┼───────────────┼──────────────────────────────────────────────────────────────┤";
  end;

  return header;
end;                      
                      
private macro GetActionName( pPart:integer ):string
    if   ( (pPart == MAKEDEAL) OR  (pPart == MAKEDEALWTHREQUEST) )
        return "Заключение сделки";
    elif ( (pPart == CHANGEDEAL) OR (pPart == CHANGEDEALWTHREQUEST) )
        return "Изменение условий";
    elif ( (pPart == OBLIGATIONCHANGE) OR (pPart == OBLIGATIONCHANGEWTHREQUEST) )
        return "Изменение состояния обязательств";
    elif ( pPart == BULKREPORT )
        return "Сводный отчет";
    elif ( (pPart == MAKECONTRACT) OR (pPart == MAKECONTRACTWTHREQUEST) )
        return "Заключение договора";
    elif ( pPart == CLOSECONTRACT )
        return "Закрытие договора";
    elif ( pPart == RECONCILIATION )
        return "Сверка";
    elif ( pPart == FAIRVALUE )
        return "Отчет о расчете справедливой стоимости"; 
    else
        return "-";
    end;
end;

PRIVATE CLASS (DL_CReportTemplate) IR_RepAcc_Report( ir_op, Mode, id )
  PRIVATE VAR m_PrintMode;
  PRIVATE VAR m_op = TRecHandler("ir_op");
  PRIVATE VAR m_IsExists = false;
  PRIVATE VAR m_IsExistsErr = false;
  PRIVATE var m_Executer = DepoExecuter( {oper} );
  PRIVATE var m_ID;
  private var SheetName = "Протокол"; 
  PRIVATE var NumbDeals = 0;
  PRIVATE var NumbDealsWthErr = 0;
  PRIVATE var NumbDealsWthRequest = 0;
  PRIVATE var NumbDealsWthRequestMsg = 0;

  PRIVATE MACRO CheckActionWthRequest(Action)
    if( (Action == MAKEDEALWTHREQUEST) OR
        (Action == CHANGEDEALWTHREQUEST) OR
        (Action == OBLIGATIONCHANGEWTHREQUEST) OR
        (Action == MAKECONTRACTWTHREQUEST))
        return true;
    end;
    return false;
  END;

  PRIVATE MACRO CountDeals(ReportLineData_XML:variant, ReportLineDataErr_XML:variant)
    var AllDeals = TArray();
    var AllDealsErr = TArray();
    var AllDealsWhtRequest = TArray();
    var DealData;
    var arrsize = AllDeals.size;
    var i = 0;
    var DealsFound = false;
    var messageSendingMode = false;
    GetRegistryValue("РЕПОЗИТАРИЙ\\ОБРАБОТКА ВХОДЯЩИХ СООБЩЕНИЙ", V_BOOL, @messageSendingMode, null);

    while ( ReportLineData_XML.Next )
        DealData = ReportLineData_XML.GetReportLineData();
          
        if( (DealData.DealID != NULL) AND (DealData.DealKind != NULL) AND (DealData.DealID != "") AND (DealData.DealKind != ""))
          arrsize = AllDeals.size;
          i = 0;
          DealsFound = false;
          while( i < arrsize)
            if (AllDeals[i] == (DealData.DealID + " " + int(DealData.DealKind)))
              DealsFound = true;
              break;
            end;
            i = i + 1;
          end;  
          if( not DealsFound )
            AllDeals[arrsize] = DealData.DealID + " " + int(DealData.DealKind);
            NumbDeals = NumbDeals + 1;
            if (CheckActionWthRequest(DealData.Action))
              NumbDealsWthRequest = NumbDealsWthRequest + 1;
              AllDealsWhtRequest[AllDealsWhtRequest.size] = DealData.DealID + " " + int(DealData.DealKind);
              if(messageSendingMode)
                if(DealData.MsgCode != "")
                  NumbDealsWthRequestMsg = NumbDealsWthRequestMsg + 1;
                end;
              end;
            end;
          else
            if (CheckActionWthRequest(DealData.Action))
              arrsize = AllDealsWhtRequest.size;
              i = 0;
              DealsFound = false;
              while( i < arrsize)
                if (AllDealsWhtRequest[i] == (DealData.DealID + " " + int(DealData.DealKind)))
                  DealsFound = true;
                  break;
                end;
                i = i + 1;
              end;
              if( not DealsFound )
                NumbDealsWthRequest = NumbDealsWthRequest + 1;
                AllDealsWhtRequest[AllDealsWhtRequest.size] = DealData.DealID + " " + int(DealData.DealKind);
                if(messageSendingMode)
                  if(DealData.MsgCode != "")
                    NumbDealsWthRequestMsg = NumbDealsWthRequestMsg + 1;
                  end;
                end;
              end;
            end;
          end;
        end;
    end;

    //Error -  больше нет   12.12.19 Судьяров
    while( ReportLineDataErr_XML.Next )
      DealData = ReportLineDataErr_XML.GetReportLineData();
        // есть ошибки, которые отмечаются только на форме, за ошибку подготовки они не считаются, сообщение должно подготавливаться. ErrStr у них = " "
      if( (DealData.DealID != NULL) AND (DealData.DealKind != NULL) AND (DealData.ErrStr != NULL) AND (DealData.ErrStr != " ") ) 
        arrsize = AllDealsErr.size;
        i = 0;
        DealsFound = false;
        while( i < arrsize)
          if (AllDealsErr[i] == (DealData.DealID + " " + int(DealData.DealKind)))
            DealsFound = true;
            break;
          end;
          i = i + 1;
        end;
        if( not DealsFound )
          AllDealsErr[arrsize] = DealData.DealID + " " + int(DealData.DealKind);
          NumbDealsWthErr = NumbDealsWthErr + 1;

          arrsize = AllDeals.size;
          i = 0;
          DealsFound = false;
          while( i < arrsize)
            if (AllDeals[i] == (DealData.DealID + " " + int(DealData.DealKind)))
              DealsFound = true;
              break;
            end;
            i = i + 1;
          end;
          if( not DealsFound )
            NumbDeals = NumbDeals + 1;
            AllDeals[arrsize] = DealData.DealID + " " + int(DealData.DealKind);
            if (CheckActionWthRequest(DealData.Action))
              arrsize = AllDealsWhtRequest.size;
              i = 0;
              DealsFound = false;
              while( i < arrsize)
                if (AllDealsWhtRequest[i] == (DealData.DealID + " " + int(DealData.DealKind)))
                  DealsFound = true;
                  break;
                end;
                i = i + 1;
              end;
              if( not DealsFound )
                NumbDealsWthRequest = NumbDealsWthRequest + 1;
                AllDealsWhtRequest[AllDealsWhtRequest.size] = DealData.DealID + " " + int(DealData.DealKind);
              end;
            end;
          end;
        end;
      end;
    end;
  END;  

  PRIVATE MACRO PrintMode():INTEGER
     return m_PrintMode;
  END;
  
  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;
  
  private macro PrintProcessedDeals( ReportLineData_XML:variant, pPart1:integer, pPart2:integer, pHasPrevPart:bool )
    var DealData:CIR_RepAccRepParm;
    var IsFirst = true;

    while ( ReportLineData_XML.Next )
        DealData = ReportLineData_XML.GetReportLineData();
                                               
        if ( DealData.Action != pPart1 )
            if (ValType(pPart2) != V_UNDEF)
              if ( DealData.Action != pPart2 )
                continue;
              end;
            else
              continue;
            end;
        end;

       m_IsExists = true;

        if ( IsFirst )
            PrintFormatString( "", "N1_Action", GetActionName(pPart1) );
            if ( pHasPrevPart )
                CopyAllSheetInTotalBook(SheetName, false, "N1_TableHeaderSecondary", 1, SheetName);
            else
                CopyAllSheetInTotalBook(SheetName, false, "N1_TableHeader", 1, SheetName);
            end;
            
            RegisterTable( "N1_MainTable", GetTableHeader(false, pPart1, pHasPrevPart),
                           "N1_DealCode",
                           "N1_MsgCode",
                           "N1_Status"
                         );            

            IsFirst = false;
       end;
        if (DealData.MsgCode != "")
          if (m_id and (DealData.DealCode != m_id))
                  continue;
              end;
              
        PrintTableLine( "N1_DealCode",  DealData.DealCode,  null,
                        "N1_MsgCode",   DealData.MsgCode,   null,
                        "N1_Status",    DealData.Status,    null 
                      );
        end;
    end;
    
    if ( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;

    return (not IsFirst);
  end;

  private macro PrintErrors( ReportLineData_XML:variant, pPart1:integer, pPart2:integer, pHasPrevPart:bool )
    var ErrData:CIR_RepAccRepErr;
      var IsFirst = true;

      while ( ReportLineData_XML.Next )
        ErrData = ReportLineData_XML.GetReportLineData();
    
        if ( ErrData.Action != pPart1 )
            if (ValType(pPart2) != V_UNDEF)
              if ( ErrData.Action != pPart2 )
                continue;
              end;
            else
              continue;
            end;
        end;
            
        m_IsExistsErr = true;
            
        if ( IsFirst )
            PrintFormatString("", "N2_Action", GetActionName(pPart1));
            if ( pHasPrevPart )
                CopyAllSheetInTotalBook(SheetName, false, "N2_TableHeaderSecondary", 1, SheetName);
            else
                CopyAllSheetInTotalBook(SheetName, false, "N2_TableHeader", 1, SheetName);
            end;

            RegisterTable( "N2_MainTable", GetTableHeader(true, pPart1, pHasPrevPart),
                       "N2_DealCode",
                       "N2_MsgCode",
                       "N2_Field",
                       "N2_ErrStr"
                  );

            IsFirst = false;
        end;
            
        if ( m_id and (ErrData.DealCode != m_id))
            continue;
        end;
        // пропустим строчки, в которых нет типа сообщения, наименования поля и ошибки - они только подсвечиваются на форме
        if((ErrData.DealCode != "") and (ErrData.FldNumber != 0) and (ErrData.MsgCode == " ") and (ErrData.Field == " ") and (ErrData.ErrStr == " "))
            continue;
        end;
            
        PrintTableLine( "N2_DealCode", ErrData.DealCode, null,
                        "N2_MsgCode",  ErrData.MsgCode,  null,
                        "N2_Field",    ErrData.Field,    null,
                        "N2_ErrStr",   ErrData.ErrStr,   null
                      );
      end;
      
      if ( not IsFirst )
        EndTable();
        CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
      end;

      return (not IsFirst);
    end; 

  PRIVATE MACRO Create()
    var ReportLineData_XML:variant;
    var ReportLineDataErr_XML:variant;
    var DealData:CIR_RepAccRepParm; 
    var IsFirst = true;

    SetActiveSheet(SheetName);

    PrintFormatString(N1RepHeaderStr,
                     "N1_OperDate", m_op.rec.Date,
                     "N1_OperCode", m_op.rec.CodeOp
                     );
    CopyAllSheetInTotalBook(SheetName, false, "N1_RepHead", 0, SheetName);
    
    var HasPrevPart = false;

    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    ReportLineDataErr_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineDataErr_XML.SetReportNumber(0);
    CountDeals(ReportLineData_XML, ReportLineDataErr_XML);
    
    // Сначала печатаем обработанные сделки, по каждому действию раздельно
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, MAKEDEAL, MAKEDEALWTHREQUEST, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, CHANGEDEAL, CHANGEDEALWTHREQUEST, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, OBLIGATIONCHANGE, OBLIGATIONCHANGEWTHREQUEST, HasPrevPart)) or HasPrevPart;

    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, BULKREPORT, NULL, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, MAKECONTRACT, MAKECONTRACTWTHREQUEST, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, CLOSECONTRACT, NULL, HasPrevPart)) or HasPrevPart;

    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, RECONCILIATION, NULL, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, FAIRVALUE, NULL,  HasPrevPart)) or HasPrevPart;

    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintProcessedDeals(ReportLineData_XML, 0, NULL, HasPrevPart)) or HasPrevPart;
    
    if ( not HasPrevPart )
        PrintFormatString(N1OprStateMsg, "N1_OprStateMsg", "Нет подходящих сделок");
        CopyAllSheetInTotalBook(SheetName, false, "N1_OprStateMsg", 1, SheetName);
    end;

    PrintFormatString(ResultCountDeals, 
                  "N1_TextNumbDeals", "Обработано сделок",
                  "N1_NumbDeals", NumbDeals,
                  "N1_TextNumbDealsWthErr", " -из них с ошибками",
                  "N1_NumbDealsWthErr", NumbDealsWthErr,
                  "N1_TextNumbDealsWthRequest", " Обработано сделок с ожиданием запроса",
                  "N1_NumbDealsWthRequest", NumbDealsWthRequest,
                  "N1_TextOfThem", " из них:",
                  "N1_TextNumbDealsWthRequestMsg", " -c подготовкой сообщения",
                  "N1_NumbDealsWthRequestMsg", NumbDealsWthRequestMsg);

    CopyAllSheetInTotalBook(SheetName, false, "N1_ResultCountDeals", 1, SheetName);
    
    HasPrevPart = false;
    
    if( m_PrintMode == DL_OUTREPORT_EXCEL )
        m_ObjTemplateXLS.SetSheetColor(XlColorIndex_RED);
    end;
    // Затем ошибки формирования, тоже раздельно по действиям
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, MAKEDEAL, MAKEDEALWTHREQUEST, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, CHANGEDEAL, CHANGEDEALWTHREQUEST, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, OBLIGATIONCHANGE, OBLIGATIONCHANGEWTHREQUEST, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, BULKREPORT, NULL, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, MAKECONTRACT, MAKECONTRACTWTHREQUEST, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, CLOSECONTRACT, NULL, HasPrevPart)) or HasPrevPart;
    
    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, FAIRVALUE, NULL, HasPrevPart)) or HasPrevPart;

    ReportLineData_XML = IR_GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    HasPrevPart = (PrintErrors(ReportLineData_XML, 0, NULL, HasPrevPart)) or HasPrevPart;
    
    if( m_IsExistsErr == false )
      PrintFormatString(N1OprStateMsg,"N1_OprStateMsg", "Операция завершена успешно");
      CopyAllSheetInTotalBook(SheetName, false, "N1_OprStateMsg", 1, SheetName);
    end;
    
    PrintFormatString(NFooter,
                     "N1_ExecutorPost", "Составил ( " + m_Executer.Post + " ):",
                     "N1_ExecutorName", string( m_Executer.Name ),
                     "N1_ExecuteDate:l",  m_op.rec.Date:f
                     );
    CopyAllSheetInTotalBook( SheetName, false, "N1_Footer", 1, SheetName );
  END;

  m_PrintMode = Mode;
  m_op = ir_op;
    m_ID=id;
    
  initDL_CReportTemplate( NULL, "Report_RepAcc.xls");
END;

private MACRO PrintRepAccByXML(op, Mode, id)
  record IrOp("ir_op");
  var recop = TRecHandler("ir_op");
  
  SetBuff(IrOp, op);
    if (id)
    copy(recop, Op);
    else
  copy(recop, IrOp);
    end;
    
  IR_RepAcc_Report(recop, Mode, id).Run();
  return true;

END;

MACRO PrintRepAccByXMLToExcel( op, id )
  return PrintRepAccByXML(op, DL_OUTREPORT_EXCEL);
END;

MACRO PrintRepAccByXMLToSTD( op, id )
    return PrintRepAccByXML(op, DL_OUTREPORT_STD, id);
END;

// Печать отчета по откату оперции
macro PrintRollBackReport(op)
  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*файл вывода для отчета*/
  record IrOp("ir_op");

  SetBuff(IrOp, op);
  
  ReportFileName = GetTxtFileName( "repacc_" + IrOp.ID );
  if( not Open( ReportOutFile, ReportFileName ) )
     errcode = status(errtext);
     RunError( "Ошибка при создании файла|"+ReportFileName+"|(" + errcode + ") " + errtext );
  end;
  SetOutput( ReportFileName );

  var sql =  " select t_warning from DSCREPLOG_TMP group by t_warning order by t_warning ";

  var cmd = RSDCommand(sql);
  cmd.execute();

  var DataSet = TRsbDataSet(cmd);
  var i = 1, IsFirstUse = true;;

  while( DataSet.MoveNext() )
     if(IsFirstUse == true )
        println(" Протокол отката операции");
        println("┌──────────┬──────────────────────────────────────────────────────────────┐");
        IsFirstUse = false;
     else
        println("├──────────┼──────────────────────────────────────────────────────────────┤");
     end;

     [│##########│##############################################################│]
     (i:r, DataSet.Warning:w);
     i = i + 1;

  end;

  if( IsFirstUse == false )
     println("└──────────┴──────────────────────────────────────────────────────────────┘");
  end;

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );

  return true;
end;


private MACRO ErrorFromCnvpack( cnv)
  var Cmd, Query, DataSet, err = 0;
  Query = " select t_Error, t_ErrMsg " +
          " from dcnvpack_dbt " +
          " where t_ExecID =  "  + string(cnv.ExecID) + 
          " group by t_Error, t_ErrMsg" ;
 
  Cmd = RSDCommand( Query );      
  
  Cmd.Execute();
  DataSet = TRsbDataSet(Cmd);

  while( DataSet.MoveNext() )
    if( DataSet.Error != 0 ) 
     
      RepErrArr[RepErrArr.size] = CIR_RepAccRepErr("", "", "", "", IIF(DataSet.ErrMsg, DataSet.ErrMsg, ""), "", "", 0);   // добавил "" 7-ым параметром, 0 - 8-м
      err = err + 1;
    end; 
  end;
  return err;
END;

//выборка данных для конвейера
macro GetRepAccObjectQuery( ir_op, forceReconTempl )
  var CountDay;
  if(ir_op.rec.Sign_DealTransact == SET_CHAR)     // для операций из под сделки не учитываем количество дней
    CountDay = 0;
  else
    CountDay = ir_op.rec.Date_Select;
  end;

  var query = " SELECT 0 as t_ObjectType, gracc_rep.t_ID as t_ObjectID, td.t_Code as t_DealNumber "
            + "   FROM dv_irdeal td, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc_rep, ddl_repozdeal_dbt rd "
            + "  WHERE grdeal.t_DocKind = td.t_DocKind "
            + "    AND grdeal.t_DocID   = td.t_DocID "
            + "    AND rd.t_DocKind = td.t_DocKind "
            + "    AND rd.t_DocKind in (" + DL_SECURITYDOC + ", " + DL_DVNDEAL + ", " + DL_DVDEALT3 + ", " + DL_DVFXDEAL + ")"
            + "    AND rd.t_DocID   = td.t_DocID "
            + "    AND rd.t_Reporting = chr(88) "
            + "    AND gracc_rep.t_GrDealID = grdeal.t_ID "
            + "    AND gracc_rep.t_AccNum = " + DLGR_ACCKIND_REPOSITORY
            + "    AND ((grdeal.t_PlanDate  <= " + GetSQLDate(date(ir_op.rec.Date)) + " - " + CountDay +" AND grdeal.t_TemplNum in (" + DLGR_TEMPL_MAKEDEAL + "," + DLGR_TEMPL_CHANGEMSG + "))"
            + "      OR (grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date)) + " AND grdeal.t_TemplNum in (" + DLGR_TEMPL_MAKEDEALWTHREQUEST + "," + DLGR_TEMPL_CHANGEMSGWTHREQUEST + ","+DLGR_TEMPL_RECONCILIATION+")))"
            + "    AND grdeal.t_TemplNum in ("+DLGR_TEMPL_MAKEDEAL+","+DLGR_TEMPL_MAKEDEALWTHREQUEST+","+DLGR_TEMPL_CHANGEMSG+","+DLGR_TEMPL_CHANGEMSGWTHREQUEST+","+DLGR_TEMPL_CHANGESTATRQ+","+DLGR_TEMPL_RECONCILIATION+")";
            
  if ( ValType(forceReconTempl) == V_INTEGER )
    query = query + " AND grdeal.t_TemplNum = " + forceReconTempl;
  else
    query = query + " AND gracc_rep.t_State = " + DLGRACC_STATE_PLAN;
  end;
            
  if(ir_op.rec.Sign_DealTransact == SET_CHAR)
    if(ir_op.rec.DealID)
       query = query + " AND rd.t_DocID = " + ir_op.rec.DealID ;
    end;
  
    if(ir_op.rec.Dockind_Op)
       query = query + " AND rd.t_DocKind = " + ir_op.rec.Dockind_Op ;
    end;
  end;

  if( ir_op.rec.Form_Contract == SET_CHAR )

     // условие по коду сообщения
     if( ir_op.rec.MsgCode_Form != "" )
        query = query + " AND rd.t_messagecode = '" + ir_op.rec.MsgCode_Form + "' ";
     end;

  else
     query = query + " AND grdeal.t_TemplNum not in ("+DLGR_TEMPL_MAKEDEAL+","+DLGR_TEMPL_MAKEDEALWTHREQUEST+","+DLGR_TEMPL_CHANGEMSG+","+DLGR_TEMPL_CHANGEMSGWTHREQUEST+","+DLGR_TEMPL_CHANGESTATRQ+")";
  end;

  return query;
end;

//выборка данных для конвейера
macro GetRepAccObjectQuerySvod( ir_op, DealDate, PayDate1, PayDate2, Netting, GenAgrID )

  // Пока только для сделок БОЦБ

  var query = " SELECT 0 as t_ObjectType, gracc_rep.t_ID as t_ObjectID, td.t_DealCode as t_DealNumber, td.t_DealDate, prq1.t_PlanDate as t_PayDate1, prq2.t_PlanDate as t_PayDate2, prq2.t_Netting, td.t_GenAgrID, td.t_DealID as t_DealID,td.t_BOfficeKind as t_Kind "
            + "   FROM ddl_tick_dbt td, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc_rep, ddl_repozdeal_dbt rd, ddlrq_dbt prq1, ddlrq_dbt prq2 "
            + "  WHERE grdeal.t_DocKind = td.t_BOfficeKind "
            + "    AND grdeal.t_DocID   = td.t_DealID "
            + "    AND td.t_BOfficeKind = " + DL_SECURITYDOC
            + "    AND rd.t_DocKind     = grdeal.t_DocKind "
            + "    AND rd.t_DocID       = grdeal.t_DocID "
            + "    AND gracc_rep.t_GrDealID = grdeal.t_ID "
            + "    AND gracc_rep.t_AccNum = " + DLGR_ACCKIND_REPOSITORY
            + "    AND gracc_rep.t_State = " + DLGRACC_STATE_PLAN
            + "    AND grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date))
            + "    AND prq2.t_DocKind  = td.t_BOfficeKind "
            + "    AND prq2.t_DocID    = td.t_DealID "
            + "    AND prq2.t_Type     = " + DLRQ_TYPE_PAYMENT
            + "    AND prq2.t_DealPart = 2 "
            + "    AND prq2.t_PlanDate = prq2.t_FactDate "
            + "    AND prq1.t_DocKind  = td.t_BOfficeKind "
            + "    AND prq1.t_DocID    = td.t_DealID "
            + "    AND prq1.t_Type     = " + DLRQ_TYPE_PAYMENT
            + "    AND prq1.t_DealPart = 1 "
            + "    AND not exists( select rq.* "
            + "                      from ddlrq_dbt rq "
            + "                     where rq.t_DocKind = td.t_BOfficeKind "
            + "                       and rq.t_DocID   = td.t_DealID "
            + "                       and (rq.t_state = " + DLRQ_STATE_PLAN + " or rq.t_state = " + DLRQ_STATE_OVERDUE + " or rq.t_state = " + DLRQ_STATE_DELAYED + ") "
            + "                  )"
            
            + "    AND not Exists ( SELECT grdeal1.t_ID "
            + "                       FROM ddlgrdeal_dbt grdeal1, ddlgracc_dbt gracc1 "
            + "                      WHERE grdeal1.t_DocKind = td.t_BOfficeKind "
            + "                        AND grdeal1.t_DocID = td.t_DealID "
            + "                        AND gracc1.t_GrDealID = grdeal1.t_ID "
            + "                        AND gracc1.t_AccNum not in ( " + DLGR_ACCKIND_REPOSITORY + " ) "
            + "                        AND gracc1.t_State in ( " + DLGRACC_STATE_PLAN + " ) ) "
            
            + "    AND grdeal.t_TemplNum = " + DLGR_TEMPL_BULKREPORT;

  if( ir_op.rec.BulkReport == SET_CHAR )

     // условие по коду сообщения
     if( ir_op.rec.MsgCode_Bulk != "" )
        query = query + " AND rd.t_messagecode = '" + ir_op.rec.MsgCode_Bulk + "' ";
     end;

  else
     query = query + " AND grdeal.t_TemplNum <> " + DLGR_TEMPL_BULKREPORT;
  end;

  query = " select * from"  
        + "          (select q1.t_ObjectType, q1.t_ObjectID, q1.t_DealNumber, q1.t_DealDate, q1.t_PayDate1, q1.t_PayDate2, q1.t_Netting, q1.t_GenAgrID,q1.t_DealID,q1.t_Kind, "
        + "                  DENSE_RANK() OVER(ORDER BY q1.t_DealDate, q1.t_PayDate1, q1.t_PayDate2, q1.t_Netting, q1.t_GenAgrID) as t_GroupNumber "
        + "             from ("+query+") q1) q"
        + "  where q.t_GroupNumber > 0 ";


  if( ValType(DealDate) != V_UNDEF )
    query = query + " and q.t_DealDate = " + GetSQLDate(DealDate);
  end;

  if( ValType(PayDate1) != V_UNDEF )
    query = query + " and q.t_PayDate1 = " + GetSQLDate(PayDate1);
  end;

  if( ValType(PayDate2) != V_UNDEF )
    query = query + " and q.t_PayDate2 = " + GetSQLDate(PayDate2);
  end;

  if( ValType(Netting) != V_UNDEF )
    query = query + " and q.t_Netting = " + IIF(Netting == SET_CHAR, "chr(88)", "chr(0)");
  end;

  if( ValType(GenAgrID) != V_UNDEF )
    query = query + " and q.t_GenAgrID = " + GenAgrID;
  end;

  return query;
end;

macro GetRepAccObjectQuerySvod093( ir_op, DealID, DealKind, PartyID, side1, side2, DateTO, RepContr, forceReconTempl )

  var CountDay = 0;
  if(ir_op.rec.Date_Select93 > 0)
      CountDay = ir_op.rec.Date_Select93;
  end;
  var query = " SELECT Distinct 0 as t_ObjectType, "
            + "        gracc_rep.t_ID as t_ObjectID, "
            + "        td.t_Code as t_DealNumber, "
            + "        td.t_Contractor as t_PartyID, "
            + "        genagr.t_side1, "
            + "        genagr.t_side2, "
//            + "        genagr.t_Reporter_Contr as RepContr, "
            + "        rd.t_Reporter_Contr as RepContr, "
            + "        td.t_DocID as t_DealID, "
            + "        td.t_DocKind as t_Kind, "
            + "        grdeal.t_plandate AS t_DateTO,"
            + "        (CASE "
            + "            WHEN grdeal.t_TemplNum IN "
            + "                    (51, 53, 55, 57, 59, 61) "
            + "            THEN "
            + "               " + CountDay
            + "            WHEN grdeal.t_TemplNum IN "
            + "                    (52, 54, 56, 58, 60, 62) "
            + "            THEN "
            + "               0 "
            + "         END) "
            + "           AS t_DateMod "
            + "   FROM dv_irdeal td, "
            + "        ddlgrdeal_dbt grdeal, "
            + "        ddlgracc_dbt gracc_rep, "
            + "        ddl_repozdeal_dbt rd, "
            /*+ "        ddlrq_dbt prq1, "*/
            + "        ddl_genagr_dbt genagr "
            + "  WHERE     grdeal.t_DocKind = td.t_DocKind "
            + "        AND grdeal.t_DocID   = td.t_DocID "
            + "        AND rd.t_DocKind     = grdeal.t_DocKind "
            + "        AND rd.t_DocID       = grdeal.t_DocID "
            + "        AND rd.t_Reporting = chr(88) "
            + "        AND gracc_rep.t_GrDealID = grdeal.t_ID "
            + "        AND gracc_rep.t_AccNum = " + DLGR_ACCKIND_REPOSITORY
            + "        AND grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date))
          /*+ "        AND prq1.t_DocKind  = td.t_DocKind "
            + "        AND prq1.t_DocID    = td.t_DocID "
            + "        AND prq1.t_Type IN (" + DLRQ_TYPE_PAYMENT +","+ DLRQ_TYPE_DELIVERY +")"
            + "        AND prq1.t_DealPart = 2 "*/
            + "        AND GenAgr.t_GenAgrID(+) = td.t_GenAgrID"
            + "        AND grdeal.t_TemplNum between 51 and 62 "; // по 093 сообщениям
            
  if ( ValType(forceReconTempl) == V_INTEGER )
    query = query + " AND grdeal.t_TemplNum = " + forceReconTempl;
  else
    query = query + " AND gracc_rep.t_State = " + DLGRACC_STATE_PLAN;
    
  end;
  
  if( ir_op.rec.Change_Obligation == UNSET_CHAR )   
    //если не установлен признак сообщения по изменению состояния обязательств (093)
    query = query + " AND grdeal.t_TemplNum NOT between 51 and 62 " ;
  end;

  if(DealID)
    query = query +  " AND td.t_DocID = "+ DealID ;
    if(DealKind)
       query = query +  " AND td.t_DocKIND = "+ DealKind ;
    end;
  else
  query = " select * from "  
        + "          (select q1.t_ObjectType, q1.t_ObjectID, q1.t_DealNumber, q1.t_PartyID, q1.t_side1, q1.t_side2, q1.RepContr, q1.t_DateTO, q1.t_DealID, q1.t_Kind, "
        + "                  DENSE_RANK() OVER(ORDER BY q1.t_PartyID, q1.t_side1, q1.t_side2, q1.RepContr, q1.t_DateTO) as t_GroupNumber "
        + "             from ("+query+") q1 WHERE q1.t_DateTO <= " + GetSQLDate(date(ir_op.rec.Date)) + " - q1.t_DateMod ) q"
        + "  where q.t_GroupNumber > 0 ";

    if( ValType(PartyID) != V_UNDEF )
      query = query + " and q.t_PartyID = " + PartyID;
    end;
  
    if( ValType(side1) != V_UNDEF )
      query = query + " and q.t_side1 = " + side1;
    end;
  
    if( ValType(side2) != V_UNDEF )
      query = query + " and q.t_side2 = " + side2;
    end;

    if( ValType(DateTO) != V_UNDEF )
      query = query + " and q.t_DateTO = " + GetSQLDate(DateTO);
    end;

    if( ValType(RepContr) != V_UNDEF )
      query = query + " and q.RepContr = " + RepContr;
    end;
  
  end;

  return query;
end;

macro GetRepAccObjectQueryGA( ir_op, forceReconTempl )
    var CountDay;
    if(ir_op.rec.Sign_DealTransact == SET_CHAR)     // для операций из под сделки не учитываем количество дней
        CountDay = 0;
    else
        CountDay = ir_op.rec.Date_Select_GA;
    end;
    
    var query = " SELECT Distinct 0 AS t_ObjectType, gracc.t_ID AS t_ObjectID, genagr.t_Code AS t_DealNumber, genagr.t_PartyID, genagr.t_Side1, genagr.t_Side2, genagr.t_GenAgrID as t_DealID, genagr.t_DocKind AS t_Kind "
               +"   FROM ddl_genagr_dbt genagr, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
               +"  WHERE grdeal.t_DocKind = genagr.t_DocKind "
               +"    AND grdeal.t_DocKind  = " + DL_GENAGRDVDOC
               +"    AND grdeal.t_DocID   = genagr.t_GenAgrID "
               +"    AND genagr.t_Reporting = chr(88) "
               +"    AND gracc.t_GrDealID = grdeal.t_ID "
               +"    AND gracc.t_AccNum = " + DLGR_ACCKIND_REPOSITORY
               +"    AND ((grdeal.t_PlanDate  <= " + GetSQLDate(date(ir_op.rec.Date)) + " - " + CountDay +" AND grdeal.t_TemplNum in (" + DLGR_TEMPL_MAKECONTRACT + ", " + DLGR_TEMPL_CLOSECONTR + ", " + DLGR_TEMPL_MAKECONTRACT_CORRECTION  + ", " + DLGR_TEMPL_CHANGEMSG +  "))"
               +"      OR (grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date)) + " AND grdeal.t_TemplNum in (" + DLGR_TEMPL_MAKECONTRACTWTHREQUEST + ", " + DLGR_TEMPL_CHANGEMSGWTHREQUEST + ")))"
               + "   AND grdeal.t_TemplNum IN ("+ DLGR_TEMPL_MAKECONTRACT +", "+ DLGR_TEMPL_MAKECONTRACTWTHREQUEST +", "+ DLGR_TEMPL_CLOSECONTR + ", " + DLGR_TEMPL_MAKECONTRACT_CORRECTION + ", " + DLGR_TEMPL_CHANGEMSG + ", " + DLGR_TEMPL_CHANGEMSGWTHREQUEST + ") "
               ;     //  еще будут сообщения /-по изменению условий-/ по пролонгации;
               
    if ( ValType(forceReconTempl) == V_INTEGER )
        query = query + " AND grdeal.t_TemplNum = " + forceReconTempl;
    else
        query = query + " AND gracc.t_State = " + DLGRACC_STATE_PLAN;
    end;
               
    if(ir_op.rec.Sign_DealTransact == SET_CHAR)
    
      if(ir_op.rec.DealID)
         query = query + " AND GENAGR.T_GENAGRID = " + ir_op.rec.DealID ;
      end;
    
      if(ir_op.rec.Dockind_Op)
         query = query + " AND genagr.t_DocKind= " + ir_op.rec.Dockind_Op ;
      end;
    end;    
               
    if ( ir_op.rec.Generate_GA == UNSET_CHAR )
        query = query + " AND grdeal.t_TemplNum NOT IN ("+ DLGR_TEMPL_MAKECONTRACT + ", " + 
                                                           DLGR_TEMPL_MAKECONTRACTWTHREQUEST + ", " + 
                                                           DLGR_TEMPL_CLOSECONTR + ", " + 
                                                           DLGR_TEMPL_MAKECONTRACT_CORRECTION + ", " +
                                                           DLGR_TEMPL_CHANGEMSG + ", " + 
                                                           DLGR_TEMPL_CHANGEMSGWTHREQUEST + ") ";
        
        // исключаем, которые не выбраны
        //if( ir_op.rec.First_GA != SET_CHAR )
        //    query = query + " AND grdeal.t_TemplNum not in ("+DLGR_TEMPL_MAKECONTRACT+","+DLGR_TEMPL_MAKECONTRACTWTHREQUEST+")";
        //end;
        /*if( ir_op.rec.Change_GA != SET_CHAR )
            query = query + " AND grdeal.t_TemplNum not in ("+DLGR_TEMPL_CHANGEMSG+","+DLGR_TEMPL_CHANGEMSGWTHREQUEST+")";
        end;*/
        //if( ir_op.rec.StopGenerate_GA != SET_CHAR )
        //    query = query + " AND grdeal.t_TemplNum <> " + DLGR_TEMPL_CLOSECONTR;
        //end;
    end;
    
    return query;
end;

macro GetRepAccObjectQueryRecon( ir_op )
    
    var query = " SELECT 0 as t_ObjectType, gracc_rep.t_ID as t_ObjectID, td.t_DocKind as t_DocKind, td.t_DocID as t_DocID, td.t_Code as t_DealNumber "
              + "   FROM dv_irdeal td, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc_rep, ddl_repozdeal_dbt rd "
              + "  WHERE grdeal.t_DocKind = td.t_DocKind "
              + "    AND grdeal.t_DocID   = td.t_DocID "
              + "    AND rd.t_DocKind = td.t_DocKind "
              + "    AND rd.t_DocID   = td.t_DocID "
              + "    AND rd.t_Reporting = chr(88) "
              + "    AND gracc_rep.t_GrDealID = grdeal.t_ID "
              + "    AND gracc_rep.t_AccNum = " + DLGR_ACCKIND_REPOSITORY
              + "    AND gracc_rep.t_State = " + DLGRACC_STATE_PLAN
              + "    AND grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date))
              + "    AND grdeal.t_TemplNum = " + DLGR_TEMPL_RECONCILIATION
              + "    AND gracc_rep.t_GrDealID IN ( "
              +         "SELECT gdc.t_GrDealID FROM ddlgrdoc_dbt gdc, dir_generalinf_dbt gf "
              +          "WHERE gdc.t_DocKind = " + REPOS_RECONCILIATION
              +            " AND gdc.t_DocID = gf.t_InternalMessageID "
              +            "AND gf.t_RStatus = 9) ";
    if ( ir_op.rec.ReconDeals == UNSET_CHAR )
        query = query + " AND 1 <> 1 ";
    end;
    if(ir_op.rec.Sign_DealTransact == SET_CHAR)
        if(ir_op.rec.DealID)
           query = query + " AND rd.t_DocID = " + ir_op.rec.DealID ;
        end;
      
        if(ir_op.rec.Dockind_Op)
           query = query + " AND rd.t_DocKind = " + ir_op.rec.Dockind_Op ;
        end;
    end;
            
query = query + " UNION ALL ";
            
query = query + " SELECT Distinct 0 AS t_ObjectType, gracc.t_ID AS t_ObjectID, genagr.t_DocKind as t_DocKind, genagr.t_GenAgrID as t_DocID, genagr.t_Code AS t_DealNumber "
              + "   FROM ddl_genagr_dbt genagr, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
              + "  WHERE grdeal.t_DocKind = genagr.t_DocKind "
              + "    AND grdeal.t_DocID   = genagr.t_GenAgrID "
              + "    AND genagr.t_Reporting = chr(88) "
              + "    AND gracc.t_GrDealID = grdeal.t_ID "
              + "    AND gracc.t_AccNum = " + DLGR_ACCKIND_REPOSITORY
              + "    AND gracc.t_State = " + DLGRACC_STATE_PLAN
              + "    AND grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date))
              + "    AND grdeal.t_TemplNum = " + DLGR_TEMPL_RECONCILIATION;
    if ( ir_op.rec.ReconGenAgr == UNSET_CHAR )
        query = query + " AND 1 <> 1 ";
    end;
    if(ir_op.rec.Sign_DealTransact == SET_CHAR)
        if(ir_op.rec.DealID)
           query = query + " AND genagr.t_GenAgrID = " + ir_op.rec.DealID ;
        end;
      
        if(ir_op.rec.Dockind_Op)
           query = query + " AND genagr.t_DocKind = " + ir_op.rec.Dockind_Op ;
        end;
    end;
              
    if ( ir_op.rec.Reconciliation == UNSET_CHAR )
        query = query + " AND grdeal.t_TemplNum <> " + DLGR_TEMPL_RECONCILIATION;
    end;
    
    return query;
end;

macro GetLastDayInMonth( CurDate:Date )
    var day, mon, year;

    DateSplit(CurDate,day,mon,year);
    if( mon == 12 )
      return Date(1,1,year+1) - 1;
    else
      return Date(1,mon+1,year) - 1;
    end;
end;

macro GetLastWorkDayInMonth( CurDate:Date )
   var LastWorkDate;

   LastWorkDate = GetLastDayInMonth(CurDate);
   if( not IsWorkDay(LastWorkDate))
     LastWorkDate = GetDateAfterWorkDays(LastWorkDate,-1);
   end;
   return LastWorkDate;
end;

macro GetRepAccObjectQueryCM094( ir_op, GenAgrID:Integer, DateTO:date, PartyID:integer)
    var CountDay = 0;
    var planDate:Date;
        
    if(ir_op.rec.Date_Select_FR > 0)
      CountDay = ir_op.rec.Date_Select_FR;
    end;

    var query = " SELECT 0 as t_ObjectType, "
            + "          gracc_rep.t_ID as t_ObjectID, "
            + "          td.t_DocID as t_DealID, "
            + "          td.t_DocKind as t_Kind, "
            + "          grdeal.t_plandate AS t_DateTO,"
          //  + "          td.t_GenAgrID, "
            + "          case when  td.t_DocID = 144353 then 143 else td.t_GenAgrID end  t_genagrid, "
            + "          td.T_CONTRACTOR "
            + "     FROM dv_irdeal td, "
            + "          ddlgrdeal_dbt grdeal, "
            + "          ddlgracc_dbt gracc_rep, "
            + "          ddl_repozdeal_dbt rd, "
            + "          ddl_genagr_dbt genagr "
            + "    WHERE grdeal.t_DocKind = td.t_DocKind "
            + "      AND grdeal.t_DocID   = td.t_DocID "
            + "      AND rd.t_DocKind     = grdeal.t_DocKind "
            + "      AND rd.t_DocID       = grdeal.t_DocID "
            + "      AND rd.t_Reporting = chr(88) "
            + "      AND gracc_rep.t_GrDealID = grdeal.t_ID "
            + "      AND gracc_rep.t_AccNum = " + DLGR_ACCKIND_REPOSITORY
            + "      AND gracc_rep.t_State = " + DLGRACC_STATE_PLAN
            + "      AND TRUNC(grdeal.t_plandate, 'Month' ) = TRUNC(" + GetSQLDate(date(ir_op.rec.Date - CountDay)) + ", 'Month') "
            + "      AND GenAgr.t_GenAgrID(+) = td.t_GenAgrID"
            + "      AND grdeal.t_TemplNum = " + DLGR_TEMPL_REVALUATION_FAIRVALUE
            + "      AND exists(select fr.t_id from ddvnfrval_dbt fr, doproper_dbt opr, doprstep_dbt oprstep "
            + "                  where fr.t_dockind = opr.t_DocKind "
            + "                    and fr.t_dealid = TO_NUMBER(opr.t_documentid) "
            + "                    and oprstep.t_id_operation = gracc_rep.t_id_operation "
            + "                    and oprstep.t_id_step = gracc_rep.t_id_step "
            + "                    and oprstep.t_ID_Operation = opr.t_ID_Operation "
            + "                    and fr.t_date =  (select case when (oprstep.t_servdockind = 0 and oprstep.t_servdocid = 0) "
            + "                                             then (oprstep.t_Plan_Date ) "
            + "                                             else (select dl_com.t_commdate "
            + "                                                     from DDL_COMM_DBT dl_com "
            + "                                                    where oprstep.t_servdockind = dl_com.t_dockind "
            + "                                                      and oprstep.t_servdocid = dl_com.t_Documentid) end "
            + "                                        from dual)) ";
    if( ir_op.rec.RevaluationFairVal == UNSET_CHAR )    
      //если не установлен признак сообщения по изменению состояния обязательств (093)
      query = query + " AND grdeal.t_TemplNum != 75 " ;
    end;

    if(ir_op.rec.Setting_Date_Select_FR == IR_SENDING_BILL_MESSAGESFR_EVENT_DATE)//1-при каждой переоценке
      query = " select * from "  
            //+ "          (select q1.t_ObjectType, q1.t_ObjectID, q1.t_GenAgrID, q1.t_DateTO, q1.t_DealID, q1.t_Kind, "
            //+ "                  DENSE_RANK() OVER(ORDER BY q1.t_dateto, q1.t_GenAgrID, case q1.t_GenAgrID when -1 then q1.T_CONTRACTOR end) as t_GroupNumber "
            + "          (select q1.t_ObjectType, q1.t_ObjectID, q1.t_GenAgrID, q1.t_DateTO, q1.t_DealID, q1.t_Kind, q1.T_CONTRACTOR, "
            + "                  DENSE_RANK() OVER(ORDER BY q1.t_dateto, q1.T_CONTRACTOR) as t_GroupNumber "
            + "             from ("+query+") q1 WHERE q1.t_DateTO <= " + GetSQLDate(ir_op.rec.Date - CountDay) + " ) q"
            + "  where q.t_GroupNumber > 0 ";
    else//(messageSendingMode == IR_SENDING_BILL_MESSAGESFR_LAST_DAT_MONTH)//2-по окончании месяца
      query = " select * from "
//            + "          (select q1.t_ObjectType, q1.t_ObjectID, q1.t_GenAgrID, q1.t_DateTO, q1.t_DealID, q1.t_Kind, "
//            + "                  DENSE_RANK() OVER(ORDER BY q1.t_GenAgrID, case q1.t_GenAgrID when -1 then q1.T_CONTRACTOR end) as t_GroupNumber "
            + "          (select q1.t_ObjectType, q1.t_ObjectID, q1.t_GenAgrID, q1.t_DateTO, q1.t_DealID, q1.t_Kind, q1.T_CONTRACTOR, "
            + "                  DENSE_RANK() OVER(ORDER BY q1.T_CONTRACTOR) as t_GroupNumber "
            + "             from ("+query+") q1 WHERE q1.t_DateTO <= " + GetSQLDate(ir_op.rec.Date - CountDay) + " ) q"
            + "  where q.t_GroupNumber > 0 ";
    end;

    if( ValType(GenAgrID) == V_INTEGER )
      query = query + " AND q.t_GenAgrID = " + GenAgrID;
    end;    
    if( ValType(PartyID) == V_INTEGER )
      query = query + " AND q.T_CONTRACTOR = " + PartyID;
    end;
    if( ValType(DateTO) == V_DATE )
      query = query + " AND q.t_DateTO = " + GetSQLDate(DateTO);
    end;
  return query;
end;

macro GetRepAccObjectQueryCSA( ir_op, CSAPaymentID)
    var _CSAPaymentID = SQL_ConvTypeInteger(CSAPaymentID);
    var CountDay = 0, planDate;
    var query;
    if(ir_op.rec.Date_Select_MP > 0)
        CountDay = ir_op.rec.Date_Select_MP;
    end;
    
    if((ValType(_CSAPaymentID) == V_INTEGER) and (_CSAPaymentID > 0))
        query = " SELECT 0 AS t_ObjectType, "
               +"        gracc.t_ID AS t_ObjectID, "
               +"        csa.t_Code AS t_DealNumber, "
               +"        csa.t_CSAID AS t_DocID, "
               +"        csa.t_GENAGRID AS t_CSAGenAgrID, "
               +"      "+DV_CSA+" AS t_DocKind "
               +"   FROM ddvcsa_dbt csa, "
               +"        ddlgrdeal_dbt grdeal,"
               +"        ddlgracc_dbt gracc, "
               +"        doprstep_dbt step "
               +"  WHERE     grdeal.t_DocKind = "+DV_CSA
               +"        AND grdeal.t_DocID = csa.t_CSAID "
               +"        AND csa.t_ReposRep = chr(88) "
               +"        AND gracc.t_GrDealID = grdeal.t_ID "
               +"        AND gracc.t_AccNum = "+DLGR_ACCKIND_REPOSITORY
               +"        AND gracc.t_State = "+DLGRACC_STATE_PLAN
               +"        AND grdeal.t_TemplNum = "+DLGR_TEMPL_CSA_MARGIN_PAYMENT
               +"        AND step.t_ID_Operation = gracc.t_ID_Operation "
               +"        AND step.t_ID_Step = gracc.t_ID_Step"
               + "       AND csa.t_CSAID = " + _CSAPaymentID;
        query = query + " AND grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date) + CountDay);
    else
        query = " SELECT csa.t_CSAID AS t_DocID, "
               +"        csa.t_GENAGRID AS t_CSAGenAgrID, "
               +"      "+DV_CSA+" AS t_DocKind "
               +"   FROM ddvcsa_dbt csa, "
               +"        ddlgrdeal_dbt grdeal,"
               +"        ddlgracc_dbt gracc "
               +"  WHERE     grdeal.t_DocKind = "+DV_CSA
               +"        AND grdeal.t_DocID = csa.t_CSAID "
               +"        AND csa.t_ReposRep = chr(88) "
               +"        AND gracc.t_GrDealID = grdeal.t_ID "
               +"        AND gracc.t_AccNum = "+DLGR_ACCKIND_REPOSITORY
               +"        AND gracc.t_State = "+DLGRACC_STATE_PLAN
               +"        AND grdeal.t_TemplNum = "+DLGR_TEMPL_CSA_MARGIN_PAYMENT;
        if ( ir_op.rec.MarginPayment == UNSET_CHAR )
            query = query + " AND grdeal.t_TemplNum <> " + DLGR_TEMPL_CSA_MARGIN_PAYMENT;
        end;

        query = query + " AND grdeal.t_PlanDate <= " + GetSQLDate(date(ir_op.rec.Date) + CountDay);
        query = query + " GROUP BY csa.t_CSAID, csa.t_GENAGRID ";
    end;    

    return query;
end;

macro ПроверитьОперациюРУзаТекущуюДату( ir_op )
  var query, DataSet;
  var errStr = "";

  query = "select t_DealNumber, t_ObjectType "
        + "  from ("+GetRepAccObjectQuery(ir_op)+") "
        + " group by t_DealNumber, t_ObjectType ";
  DataSet = TRsbDataSet(query);
  while( DataSet.moveNext() )
    errStr = "По сделке "+DataSet.DealNumber+" остались необработанные строки графика за дату " + string(date(ir_op.rec.Date):f);
    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr("", "", DataSet.DealNumber, "", errStr, "");
  end;
end;

macro ПроверитьОперациюРУСводзаТекущуюДату( ir_op )
  var query, DataSet;
  var errStr = "";

  query = "select t_DealNumber, t_ObjectType "
        + "  from ("+GetRepAccObjectQuerySvod(ir_op)+") "
        + " group by t_DealNumber, t_ObjectType ";
  DataSet = TRsbDataSet(query);
  while( DataSet.moveNext() )
    errStr = "По сделке "+DataSet.DealNumber+" остались необработанные строки графика за дату " + string(date(ir_op.rec.Date):f);
    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr("", "", DataSet.DealNumber, "", errStr, "");
  end;
end;

macro GetRepAccObjectQueryDeal( docid,dockind )
    var query;
    query="SELECT  0   AS t_ObjectType, ac.t_ID as t_ObjectID, "+docid+" as t_DealNumber"
    +"  FROM ddlgrdeal_dbt deal, ddlgracc_dbt ac"
    +" WHERE EXISTS"
    +"          (SELECT AtCor.t_Object"
    +"             FROM dobjatcor_dbt AtCor"
    +"            WHERE     AtCor.t_ObjectType = "+dockind
    +"                  AND AtCor.t_Object = LPAD ("+docid+", 34, '0')"
    +"                  AND AtCor.t_GroupID = 38         /*Репортинг в репозитарии*/"
    +"                  AND AtCor.t_AttrID = 1                                /*да*/"
    +"                                        )"
    +"       AND NOT EXISTS"
    +"              (SELECT AtCor.t_Object"
    +"                 FROM dobjatcor_dbt AtCor"
    +"                WHERE     AtCor.t_ObjectType = "+dockind
    +"                      AND AtCor.t_Object = LPAD ("+docid+", 34, '0')"
    +"                      AND AtCor.t_GroupID = 43      /*запрос на согласование*/"
    +"                      AND AtCor.t_AttrID = 1                            /*да*/"
    +"                                            )"
    +"       AND EXISTS"
    +"              (SELECT DR.T_ID"
    +"                 FROM ddlgrdeal_dbt dr"
    +"                WHERE     DR.T_DOCID = "+docid
    +"                      AND DR.T_DOCKIND = "+dockind
    +"                      AND DR.T_TEMPLNUM BETWEEN 46 AND 49)"
    +"       AND DEAL.T_DOCID = "+docid
    +"       AND DEAL.T_DOCKIND = "+dockind
    +"       AND AC.T_GRDEALID = DEAL.T_ID"
    +"       And AC.T_ACCNUM=5";
    return query;
    
end;


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//ЗАПУСК КОНВЕЙЕРА

//класс с данными для конвейера
class CnvDataIROP( _ID )
  var ID = _ID;
end;

//запуск конвейера
private macro __StartCnvRepAcc( ir_op:TBFile, forceReconTempl )
  var rslObj = CnvDataIROP(ir_op.rec.ID);
  var UseConveyer = false;
  var err = 0;
  var ConvID;
  var OperID = 21; //Операция для конвейра - Пакетная операция формирования репозитарного учета
    
  ConvID = IR_REPACC_SRS;
  UseConveyer = DL_SecurUseConveyer(ConvID, OperID);
  if( UseConveyer )
    var cnv = RsbConveyerExec(ConvID);

    cnv.AddParamsForConveyer(ConvID, rslObj, 0);
    cnv.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
    cnv.showPanelMonitoring(1);
    cnv.Run();

    if( ErrorFromCnvpack(cnv) > 0 )
      err = 1;
    end;
  else
    err = ExecMacroFile("ir_repacc.mac", "ExecuteRepAcc", 0, 0, ConvID, 0, 0, rslObj);
  end;
  if( err == 0 )
     ConvID = IR_REPACC_SVODSRS;
     UseConveyer = DL_SecurUseConveyer(ConvID, OperID);
     if( UseConveyer )
       var cnv2 = RsbConveyerExec(ConvID);
   
       cnv2.AddParamsForConveyer(ConvID, rslObj, 0);
       cnv2.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
       cnv2.showPanelMonitoring(1);
       cnv2.Run();
   
       if( ErrorFromCnvpack(cnv2) > 0 )
         err = 1;
       end;
     else
       err = ExecMacroFile("ir_repacc.mac", "ExecuteRepAcc", 0, 0, ConvID, 0, 0, rslObj);
     end;
  end;

  if( err == 0 )
     ConvID = IR_REPACC_SVODSRS093; // вообще говоря таких конвейеров нет - Да, необходима доработка для поддержки конвейера
     /*UseConveyer = DL_SecurUseConveyer(ConvID, OperID);
     if( UseConveyer )
       var cnv3 = RsbConveyerExec(ConvID);
   
       cnv3.AddParamsForConveyer(ConvID, rslObj, 0);
       cnv3.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
       cnv3.showPanelMonitoring(1);
       cnv3.Run();
   
       if( ErrorFromCnvpack(cnv3) > 0 )
         err = 1;
       end;
     else*/
       err = ExecMacroFile("ir_repacc.mac", "ExecuteRepAcc", 0, 0, ConvID, 0, 0, rslObj);
     //end;
  end;
  
  if ( err == 0 )
    ConvID = IR_REPACC_SRS_GA; // вообще говоря таких конвейеров нет - Да, необходима доработка для поддержки конвейера
    /*UseConveyer = DL_SecurUseConveyer(ConvID, OperID);
    if ( UseConveyer )
      var cnv4 = RsbConveyerExec(ConvID);
        
      cnv4.AddParamsForConveyer(ConvID, rslObj, 0);
      cnv4.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
      cnv4.showPanelMonitoring(1);
      cnv4.Run();
        
      if ( ErrorFromCnvpack(cnv4) > 0 )
        err = 1;
      end;
    else*/
      err = ExecMacroFile("ir_repacc.mac", "ExecuteRepAcc", 0, 0, ConvID, 0, 0, rslObj);
    //end;
  end;
  
  if ( err == 0 )   // сверку лучше поставить перед первичными скорее всего
    ConvID = IR_REPACC_SRS094; // вообще говоря таких конвейеров нет - Да, необходима доработка для поддержки конвейера
    /*UseConveyer = DL_SecurUseConveyer(ConvID, OperID);
    if ( UseConveyer )
      var cnv6 = RsbConveyerExec(ConvID);
        
      cnv6.AddParamsForConveyer(ConvID, rslObj, 0);
      cnv6.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
      cnv6.showPanelMonitoring(1);
      cnv6.Run();
        
      if ( ErrorFromCnvpack(cnv6) > 0 )
        err = 1;
      end;
    else*/
      err = ExecMacroFile("ir_repacc.mac", "ExecuteRepAcc", 0, 0, ConvID, 0, 0, rslObj);
    //end;
  end;

  if ( err == 0 )   // сверку лучше поставить перед первичными скорее всего
    ConvID = IR_REPACC_SRS092; // вообще говоря таких конвейеров нет - Да, необходима доработка для поддержки конвейера
    /*UseConveyer = DL_SecurUseConveyer(ConvID, OperID);
    if ( UseConveyer )
      var cnv7 = RsbConveyerExec(ConvID);
        
      cnv7.AddParamsForConveyer(ConvID, rslObj, 0);
      cnv7.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
      cnv7.showPanelMonitoring(1);
      cnv7.Run();
        
      if ( ErrorFromCnvpack(cnv7) > 0 )
        err = 1;
      end;
    else*/
      err = ExecMacroFile("ir_repacc.mac", "ExecuteRepAcc", 0, 0, ConvID, 0, 0, rslObj);
    //end;
  end;

  if ( err == 0 )   // сверку лучше поставить перед первичными скорее всего
    ConvID = IR_REPACC_RECON; // вообще говоря таких конвейеров нет - Да, необходима доработка для поддержки конвейера
    /*UseConveyer = DL_SecurUseConveyer(ConvID, OperID);
    if ( UseConveyer )
      var cnv5 = RsbConveyerExec(ConvID);
        
      cnv5.AddParamsForConveyer(ConvID, rslObj, 0);
      cnv5.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
      cnv5.showPanelMonitoring(1);
      cnv5.Run();
        
      if ( ErrorFromCnvpack(cnv5) > 0 )
        err = 1;
      end;
    else*/
      err = ExecMacroFile("ir_recon.mac", "ExecReconciliation", rslObj);
    //end;
  end;

  if( err == 0 )
     ПроверитьОперациюРУзаТекущуюДату(ir_op);
     ПроверитьОперациюРУСводзаТекущуюДату(ir_op);
  end;

  return err;

  OnError(er)
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;
  RepErrArr[RepErrArr.size] = CIR_RepAccRepErr("", "", "", "", er.module+ " "+er.line+" "+er.message, "", "", 0);   // добавил "" 7-ым параметром, 0 - 8-м);
  return 1;
end;

macro StartCnvRepAcc( ID )
  var stat = 0;
  var ir_op = TBFile("ir_op.dbt", "W");
  
  ir_op.rec.ID = ID;
  if( not ir_op.GetEQ() )
    msgbox("Ошибка поиска операции");
    return 1;
  end;   
    
    RepErrArr.size = 0; //массив ошибок
    stat = __StartCnvRepAcc(ir_op);
    
  ir_op.rec.Status = DL_COMM_CLOSED;
  if(RepErrArr.size > 0)
  // если в ошибках только пробелы, то операция завершилась без ошибки
    for(var i, RepErrArr)
      if( (i.MsgCode != " ") or (i.ErrStr != " ") or (i.Field != " ") )
        ir_op.rec.Status = DL_COMM_CLOSED_ERROR;
        break;
      end;
    end;      
  end;
  ir_op.Update();
    
    SaveRepAccErrForReport_XML(RepErrArr, ir_op.rec.ID, ir_op.rec.DocKind);
    
    return stat;
end;

macro StartRepAcc( Kind, ID, IsPrint, MsgID )
    var op_id=0;
    var ir_op = TBFile("ir_op.dbt", "W");
    var code=0;
    var query, DataSet,cmd;
    var NotPrint = 0;  /// изначально печатаем
    if(IsPrint == 0)
      NotPrint = 1;
    end;
    
    query =  "  SELECT distinct t.*"
            +"    FROM dir_generalinf_dbt t,"
            +"         ddlgrdeal_dbt irgrdeal,"
            +"         ddlgrdoc_dbt irgrdoc,"
            +"         dir_typesmessage_dbt TypeMsg"
            +"   WHERE     TypeMsg.t_MessageCode(+) = t.t_MessageType"
            +"         AND irgrdoc.t_GrDealID = irgrdeal.t_ID"
            +"         AND irgrdoc.t_ServDocID <> 0"
            +"         AND irgrdeal.t_DocKind = ?"
            +"         AND irgrdeal.t_DocID = ?"
            +"         AND t.t_InternalMessageID = irgrdoc.t_DocID";
            
    if ( ValType(MsgID) != V_UNDEF )
        query = query + " AND t.t_InternalMessageID = ?";
    end;
            /*+"                (CASE"
            +"                    WHEN irgrdoc.t_DocKind = 4853"
            +"                    THEN"
            +"                       irgrdoc.t_DocID"
            +"                    WHEN irgrdoc.t_DocKind = 4857"
            +"                    THEN"
            +"                       (SELECT cm083.t_InternalMessageID"
            +"                          FROM dir_cm083_dbt cm083"
            +"                         WHERE cm083.t_ID = irgrdoc.t_DocID)"
            +"                    ELSE"
            +"                       -1"
            +"                 END)";*/
    cmd = RSDCommand(query);       
    cmd.addParam( "", RSDBP_IN, Kind );
    cmd.addParam( "", RSDBP_IN, ID );
    if ( ValType(MsgID) != V_UNDEF )
        cmd.addParam( "", RSDBP_IN, MsgID );
    end;
    cmd.execute();
    DataSet = TRsbDataSet(cmd);
        
    while( DataSet.moveNext() )
        if(DataSet.Rstatus!=2)
            return 0;
        end;
    end;
 
  RepErrArr.size = 0; //массив ошибок
    ExecMacroFile("ir_repacc.mac", "UpdateRepAccData", Kind, ID, @code,@op_id, MsgID);
        
    if (op_id > 0)
      ir_op.rec.ID = op_id;
    else
      return 1;
    end;
    if( not ir_op.GetEQ() )
        msgbox("Ошибка поиска операции");
        return 1;
    end;  
      ir_op.rec.Status = DL_COMM_CLOSED;
    if(RepErrArr.size > 0)
    // если в ошибках только пустые строки, то операция завершилась без ошибки
      for(var i, RepErrArr)
   //     if( (i._MsgCode != " ") or (i._ErrStr != " ") or (i._Field != " ") )
          if( (i.MsgCode != " ") or (i.ErrStr != " ") or (i.Field != " ") )
      ir_op.rec.Status = DL_COMM_CLOSED_ERROR;
          break;
        end;
      end;      
    end;
    ir_op.Update();
    SaveRepAccErrForReport_XML(RepErrArr, ir_op.rec.ID, ir_op.rec.DocKind);
    if(Not NotPrint)
      PrintRepAccByXMLToSTD(ir_op, code);
    end;
    return 0;
end;
