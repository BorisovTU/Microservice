//import RSD, Globals;
import "dv_grfun.mac", "dv_categ.mac";
var rs_m, cmd_m;
var sql_k,cmd_k, rs_k;
var sql_1,cmd_1, rs_1;
var sql_2,cmd_2, rs_2;
var sql_3,cmd_3, rs_3;
var sql_4,cmd_4, rs_4;
var ins_open_gr;
var ins_close_gr;
var ins_fair_gr;
var exec_flag;

var FD;
var ДатаИсполненияШага;
var ndeal = TRecHandler("dvndeal.dbt");
var GA    = TRecHandler("dl_genagr.dbt");
var FrVal = TRecHandler("dvnfrval");
var cmd_main, cmd_nDeal, cmd_GA , cmd_OpStep, sql_OpStep;
var rs_main,  rs_nDeal,  rs_GA,   rs_OpStep;
var ndealid ;
var gaid ;
var id_operation; 
var res_month;
const DocKind_Deal = 199;

CONST  DLGR_TEMPL_OPENDEAL = 46; //Заключение сделки
CONST  DLGR_TEMPL_OPENDEALREQUEST = 48; //Заключение сделки с ожиданием запроса
//CONST  DLGR_TEMPL_MAKEDEAL_CORRECTION  = 72; //Заключение сделки (корр. сообщ.)

CONST  DLGR_TEMPL_FAIRVALUE = 75; //Сообщение о Переоценке СС

//CONST  DLGR_TEMPL_CLOSECONTR = 51; //Закрытие договора
CONST  DLGR_TEMPL_CLOSECONTRREQUEST = 52; //Закрытие договора с ож. запроса

const fileSS = "2020-07-31 Ежемесячный в ОД 2.xlsx";
const datefrval = "31072020";


var pr_sql, pr_cmd;

 pr_sql = String( "begin \n"
                 ,"update ddl_repozdeal_dbt set t_contract_ir = 'DS0011315986' where t_dockind = 199 and t_code = 'SWP:54175';   \n"
                 ,"update ddl_repozdeal_dbt set t_contract_ir = 'DS0011328300' where t_dockind = 199 and t_code = 'SWP:54222';   \n"
                 ,"update ddl_repozdeal_dbt set t_contract_ir = 'DS0010227322' where t_dockind = 199 and t_code = 'SWP:50680';   \n"
                 ,"update ddl_repozdeal_dbt set t_contract_ir = 'DA0011352958' where t_dockind = 199 and t_code = 'FWD:4990';   \n"
                 ,"update ddl_repozdeal_dbt set t_contract_ir = 'DA0011328298' where t_dockind = 199 and t_code = 'FWD:4987';   \n"
                 ,"update ddl_repozdeal_dbt set t_contract_ir = 'DA0011315996' where t_dockind = 199 and t_code = 'FWD:4984';   \n"
                 ,"update ddlgracc_dbt gracc set gracc.t_state = 2, GRACC.T_FACTDATE = (select gr1.T_PLANDATE from ddlgrdeal_dbt gr1 where gr1.t_id = GRACC.T_GRDEALID)   \n"
                 ," WHERE GRACC.T_GRDEALID IN  (SELECT gr.t_id FROM ddlgrdeal_dbt gr   \n"
                 ,"                               WHERE gr.T_DOCKIND = 199   \n"
                 ,"                                AND gr.t_templnum = 75   \n"
                 ,"                                AND GR.T_DOCID = 211245)   \n"
                 ,"   AND gracc.t_accnum = 5   \n"
                 ,"   AND t_state = 1;   \n"
                 ,"commit;   \n"
                 ,"end;   \n"
                );
   pr_cmd = RSDCommand(pr_sql);
//   pr_cmd.execute();


 pr_sql = "declare "+
              "  p_filename varchar2(2000); "+
              "  begin                        "+
              "  p_filename := '2020-07-31 Ежемесячный в ОД 2.xlsx'; "+
              "   update  "+
              "    ddlgracc_dbt gracc set gracc.t_state = 2, GRACC.T_FACTDATE = (select gr1.T_PLANDATE from ddlgrdeal_dbt gr1 where gr1.t_id = GRACC.T_GRDEALID) "+
              "          WHERE GRACC.T_GRDEALID IN  "+
              "            (SELECT gr.t_id            "+
              "               FROM ddlgrdeal_dbt gr    "+
              "              WHERE     gr.T_DOCKIND = 199"+
              "                    AND gr.t_templnum = 75  "+
              "                    AND GR.T_DOCID NOT IN (select DVNFR.T_DEALID from DDVNLOADFRVAL_DBT dvnfr  where dvnfr.T_FILENAME = p_filename))"+
              "         AND gracc.t_accnum = 5                                                                                                       "+
              "         AND t_state = 1;                                                                                                               "+
              "         commit;"+
              "  end;            ";
pr_cmd = RSDCommand(pr_sql);

pr_cmd.execute();

cmd_m ="select DVNFR.T_DEALID from DDVNLOADFRVAL_DBT dvnfr  where dvnfr.T_FILENAME = '2020-07-31 Ежемесячный в ОД 2.xlsx' and not exists (select 1 from  ddlgracc_dbt gracc " +
"where GRACC.T_GRDEALID IN " +
"          (SELECT gr.t_id " +
"             FROM ddlgrdeal_dbt gr " +
"            WHERE     gr.T_DOCKIND = 199 " +
"                  AND gr.t_templnum = 75 and  GR.T_DOCID  = DVNFR.T_DEALID) " +
"           AND gracc.t_accnum = 5 " +
"       AND t_state = 1) " ;
cmd_m = RSDCommand(cmd_m);
cmd_m.addparam("",rsdbp_in, fileSS);
rs_m = RSDRecordset(cmd_m);
while (rs_m.movenext())
    var sql_t1 = " SELECT dvn.*, "+
"       (SELECT MAX (DFI.T_PAYDATE) "+
"          FROM ddvnfi_dbt dfi                 "+
"         WHERE dfi.t_dealid = dvn.t_id)       "+
"          AS t_expirydate                       "+
"  FROM ddvndeal_dbt dvn                           "+
" WHERE dvn.t_id =  " + rs_m.value("t_dealid");
var    cmd_t1 = RSDCommand(sql_t1);

var    rs_t1 = RSDRecordset(cmd_t1);
if(rs_t1.movenext())
       if (rs_t1.value("t_marketkind") == 0 )
              println("Внебиржевая сделка"); 
       elif (rs_t1.value("t_marketkind") == 1 )
              println("Биржевая сделка на фондовом рынке"); 
       elif (rs_t1.value("t_marketkind") == 2) 
              println("Биржевая сделка на валютном рынке"); 
       end;
       println("Дата закрытия:" + rs_t1.value("t_expirydate"));
end;

    print("Сделка id:" + rs_m.value("t_dealid")+ " ") ;
    
    cmd_k = null; rs_k = null;
    sql_k = "SELECT DISTINCT t_kind,T_MARKETKIND, OPRK.T_NAME " +
    "  FROM ddvndeal_dbt dvn, doprkoper_dbt oprk " +
    " WHERE t_id IN (SELECT DISTINCT t_dealid p_dialid " +
    "                  FROM DDVNLOADFRVAL_DBT " +
    "                 WHERE t_datefrval = TO_DATE ('"+datefrval+"', 'ddmmyyyy')) " +
    "       AND dvn.t_kind = OPRK.T_KIND_OPERATION " +
    "       and dvn.t_id = ? " ;
    cmd_k = RSDCommand(sql_k);
    cmd_k.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    rs_k = RSDRecordset(cmd_k);
    if (rs_k.movenext())
//       println("   " + rs_k.value("t_kind")+":"+rs_k.value("t_name"));
    end;
//1. заключение договора
    print("Ищем график 'Заключение договора':         ");
    sql_1 =  "SELECT gr.t_templnum, T.T_NAME " +
    "  FROM ddlgrdeal_dbt gr, ddlgrtempl_dbt t " +
    " WHERE     gr.t_templnum = t.t_num " +
    "       AND gr.t_dockind = 199 " +
    "       AND gr.t_docid = ? " +
    "       AND gr.t_templnum IN (?, ?, ?) " ;
    cmd_1 = RSDCommand(sql_1);
    cmd_1.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    cmd_1.AddParam("",rsdbp_in, DLGR_TEMPL_OPENDEAL);
    cmd_1.AddParam("",rsdbp_in, DLGR_TEMPL_OPENDEALREQUEST);
    cmd_1.AddParam("",rsdbp_in, DLGR_TEMPL_MAKEDEAL_CORRECTION);
    rs_1 = RSDRecordset(cmd_1);
    if(rs_1.movenext())
      println("Найдено:" + rs_1.value("t_templnum")+"."+rs_1.value("t_name")); 
      ins_open_gr = false;
    else
//      println("                                                                          !!!Необходима вставка графика!!!"); 
      ins_open_gr = true;
    end;

//2.
    print("Ищем график  ' Закрытие договора':         ");
    sql_2 =  "SELECT gr.t_templnum, T.T_NAME " +
    "  FROM ddlgrdeal_dbt gr, ddlgrtempl_dbt t " +
    " WHERE     gr.t_templnum = t.t_num " +
    "       AND gr.t_dockind = 199 " +
    "       AND gr.t_docid = ? " +
    "       AND gr.t_templnum IN (?, ?) " ;
    cmd_2 = RSDCommand(sql_2);
    cmd_2.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    cmd_2.AddParam("",rsdbp_in, DLGR_TEMPL_CLOSECONTR);
    cmd_2.AddParam("",rsdbp_in, DLGR_TEMPL_CLOSECONTRREQUEST);
    rs_2 = RSDRecordset(cmd_2);
    if(rs_2.movenext())
      println("Найдено:" + rs_2.value("t_templnum")+"."+rs_2.value("t_name")); 
      ins_close_gr = false;
    else
 //     println("                                                                          !!!Необходима вставка графика!!!"); 
      ins_close_gr = true;
    end;

//3.
    print("Ищем график   '  Сообщение СМ094':         ");
    sql_3 =  "SELECT gr.t_templnum, T.T_NAME " +
    "  FROM ddlgrdeal_dbt gr, ddlgrtempl_dbt t " +
    " WHERE     gr.t_templnum = t.t_num " +
    "       AND gr.t_dockind = 199 " +
    "       AND gr.t_docid = ? " +
    "       AND gr.t_templnum IN (?) " ;
    cmd_3 = RSDCommand(sql_3);
    cmd_3.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
    cmd_3.AddParam("",rsdbp_in, DLGR_TEMPL_FAIRVALUE);
    rs_3 = RSDRecordset(cmd_3);
    if(rs_3.movenext())
      println("Найдено:" + rs_3.value("t_templnum")+"."+rs_3.value("t_name")); 
      ins_fair_gr = false;
    else
 //     println("                                                                          !!!Необходима вставка графика!!!"); 
      ins_fair_gr = true;
    end;


 //4.Вставка графиков  
    if(ins_close_gr or ins_fair_gr )

       cmd_nDeal  = DL_RSDCommand("Select * from ddvndeal_dbt where t_id = ?");
       cmd_nDeal.AddParam(-1);
       cmd_GA     = DL_RSDCommand("Select * from ddl_genagr_dbt where t_genagrid = ?");
       cmd_GA.AddParam(-1);
       sql_OpStep ="SELECT TRUNC (os.t_plan_date, 'MON') res_date, os.\* " +
        "    FROM doprstep_dbt os " +
        "   WHERE os.t_id_operation = ? " +
        "         AND ( (os.t_kind_operation = 12690 " +
        "                AND ( (os.t_blockid = 20000151 AND os.t_number_step = 60) " +
        "                     OR (os.t_blockid = 20000148 AND os.t_number_step = 35))) " +
        "              OR (os.t_kind_operation = 12695 " +
        "                  AND ( (os.t_blockid = 20000173 AND os.t_number_step = 60) " +
        "                       OR (os.t_blockid = 20000170 AND os.t_number_step = 25))) " +
        "              OR (os.t_kind_operation = 22710 " +
        "                  AND ( (os.t_blockid = 20000629 AND os.t_number_step = 60) " +
        "                       OR (os.t_blockid = 20000627 AND os.t_number_step = 35))) " +
        "              OR (os.t_kind_operation = 22720 " +
        "                  AND ( (os.t_blockid = 20000649 AND os.t_number_step = 60) " +
        "                       OR (os.t_blockid = 20000647 AND os.t_number_step = 35))) " +
        "              OR (os.t_kind_operation = 22695 " +
        "                  AND (os.t_blockid = 20000610 AND os.t_number_step = 60)) " +
        "              OR (os.t_kind_operation = 12715 " +
        "                  AND (os.t_blockid = 40000024 AND os.t_number_step = 60))" +
        "              OR (os.t_kind_operation = 12720 " +
        "                  AND (os.t_blockid = 20000212 AND os.t_number_step = 60))) and OS.T_FACT_DATE != to_date('01010001', 'ddmmyyyy') " +

        "ORDER BY os.t_plan_date " ;

       cmd_OpStep = dl_RSDCommand(sql_OpStep);
       cmd_OpStep.AddParam(-1);

//       println("Вставка отсутствующих графиков:");
       sql_4 =  "SELECT dvn.t_id, dvn.t_genagrid, oo.t_id_operation  " +
       "  FROM ddvndeal_dbt dvn, doproper_dbt oo " +
       " WHERE LPAD (dvn.T_ID, 34, 0) = oo.t_documentid " +
       "     and OO.T_DOCKIND = 199  " +
       "     AND dvn.t_id = ?         " ;
       cmd_4 = RSDCommand(sql_4);
       cmd_4.AddParam("",rsdbp_in, rs_m.value("t_dealid"));
       rs_4 = RSDRecordset(cmd_4);
       
       if (rs_4.movenext())
          ndealid = rs_4.value("t_id");
          gaid = rs_4.value("t_genagrid");
          id_operation = rs_4.value("t_id_operation"); 
         
         
           cmd_nDeal.m_params.value(0) = ndealid;
           rs_nDeal = cmd_nDeal.execute();
           if(rs_nDeal.moveNext())
             rs_nDeal.GetRecord().CopyTo( nDeal.rec );
           end;

           cmd_GA.m_params.value(0) = gaid;
           rs_GA = cmd_GA.execute();
           if(rs_GA.moveNext())
            rs_GA.GetRecord().CopyTo( GA.rec );
           end;
         if(ins_close_gr)
//            println("  - Вставка открытия/закрытия договора");
            SetAllGrDealDV(nDeal,GA);
            InsertAllGrDealDV(); 
            println("  - Ok!"); 
         end;
     //     SetAllGrDealDV(nDeal,GA);
     //     InsertAllGrDealDV(); 


          if(ins_fair_gr)
 //           println("  - Вставка CM094");  

            FD = DVFirstDocNDeal(DocKind_Deal, ndeal);
            cmd_OpStep.m_params.value(0) = id_operation;
            rs_OpStep = cmd_OpStep.execute();
            res_month = null;
            while(rs_OpStep.movenext())
             ДатаИсполненияШага = date(rs_OpStep.Fact_Date);//ndeal.rec.Date;
             
           //  if(res_month != rs_OpStep.Res_Date)   
              if( InsertGrDealFairValueRevaluation(FD, ДатаИсполненияШага, DocKind_Deal) != 0 )
               MsgBox("Ошибка вставки строки графика \"Переоценка справедливой стоимости\"");
              return 1;
              end;
          //   res_month = rs_OpStep.Res_Date;
           //  end;
                
            end;//rs_OpStep  
 //            println("  - Ok!")         
          end;
       end;
    end;
    
//1.
println("OK_________________________________________________________");
end;
