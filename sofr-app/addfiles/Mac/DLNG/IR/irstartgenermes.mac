/*                           
$Name:        irstartgenermes.mac
$Module:      Репозитарий
$Description: запуск, выполнение генерации сообщений
*/

//запуск на выполнение сервисной операции генерации сообщений
//формирование протокола сервисной операции генерации сообщений
import BankInter, XmlRpcInter, "dllog_xml.mac", "DlReport_h.mac", "dldlngfun.mac";

//класс с данными для строки протокола
class CIR_GenerMesRepParm( _DealCode:string,
                         _MsgCode:string,
                         _Status:string )
  var DealCode  = _DealCode;  //Код сделки
  var MsgCode   = _MsgCode;   //Код сообщения
  var Status    = _Status;    //Статус
end;

//класс с данными для списка ошибок в протоколе
class CIR_GenerMesRepErr( _DealCode:string, _MsgCode:string, _ErrStr:string )
 var DealCode  = _DealCode;
 var MsgCode   = _MsgCode;
 var ErrStr    = _ErrStr;
end;
private var RepErrArr = TArray(); //массив ошибок


CLASS (DL_LOG_FROM_XML) GENERMES_LOG_FROM_XML(pDocKind:integer, pID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var DealData:CIR_GenerMesRepParm;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALCODE", V_STRING, DealData.DealCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MSGCODE", V_STRING, DealData.MsgCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "STATUS", V_STRING, DealData.Status) == false)
        end;

        return DealData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pID, pType, pOnlyLastReport);

END;

/*лог ошибок*/
PRIVATE CLASS (DL_LOG_FROM_XML) IR_ERROR_LOG_FROM_XML(pDocKind:integer, pID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var ErrorData:CIR_GenerMesRepErr;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALCODE", V_STRING, ErrorData.DealCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MSGCODE", V_STRING, ErrorData.MsgCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ERRSTR", V_STRING, ErrorData.ErrStr) == false)
        end;
        
        return ErrorData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pID, pType, pOnlyLastReport);

END;

/*лог ошибок СО*/
CLASS (DL_LOG_DATA_XML) IR_GENERMES_ERROR_LOG_DATA_XML(pDocKind:integer, pID:integer, pDataParms:TArray, pType:integer, pVersion:integer)

  PRIVATE MACRO СоздатьУзелОшибок(i)
     var УзелОшибок = null;

     if( m_Version == 1 )
        УзелОшибок = CreateElement("Property",
                                   "DealCode",  m_DataParms[i].DealCode,
                                   "MsgCode",   m_DataParms[i].MsgCode,
                                   "ErrStr",    m_DataParms[i].ErrStr
                                  );
     else
        УзелОшибок = CreateElement("Property");
     end;
     
     return УзелОшибок;
  END;

  initDL_LOG_DATA_XML(pDocKind, pID, pDataParms, pType, pVersion);
END;


PRIVATE MACRO GetLogDataXML( DocKind:integer, ID:integer, Type:integer, OnlyLastReport:bool )
  var xml_obj = null;

  if( Type == LOG_TYPE_DATA )
     xml_obj = GENERMES_LOG_FROM_XML(DocKind, ID, Type, OnlyLastReport);
  elif(Type == LOG_TYPE_ERROR )
     xml_obj = IR_ERROR_LOG_FROM_XML(DocKind, ID, Type, OnlyLastReport);
  end;

  return xml_obj;
END;

private macro SaveGenerMesErrForReport_XML( RepErrArr, ID:integer, DocKind:integer, Oper )

  var RepXML = "";

  if (not Oper)
    Oper = {Oper};
  end;

  if( RepErrArr.Size > 0 )
     RepXML = IR_GENERMES_ERROR_LOG_DATA_XML(DocKind, ID, RepErrArr, LOG_TYPE_ERROR).GetDataXML();
  end;

  if( RepXML != "" )
     var Header = DL_LOG_HEADER_XML(DocKind).GetHeaderXML();

     DL_InsertHeaderLog(ID, DocKind, Oper, Header);
     DL_InsertLogXMLData(ID, DocKind, LOG_TYPE_ERROR, Oper, RepXML);
  end;

end;

private var N1RepHeaderStr = "           ПРОТОКОЛ ВЫПОЛНЕНИЯ ОПЕРАЦИИ ГЕНЕРАЦИИ СООБЩЕНИЙ\n" +
                             "  Дата операции: ##########  Код: #########";

/*private var N1TableHeader = "Обработанные сообщения\n" +
                            "┌──────────┬───────────────┬──────────────────────────────────────────────────────────────┐\n"+
                            "│  Сделка  │ Код сообщения │ Статус                                                       │\n"+
                            "├──────────┼───────────────┼──────────────────────────────────────────────────────────────┤";*/

private var N1TableHeader = "Обработанные сообщения\n" +
                            "┌─────────────────┬───────────────┬──────────────────────────────────────────────────────────────┐\n"+
                            "│  Вид сообщения  │ Код сообщения │ Статус                                                       │\n"+
                            "├─────────────────┼───────────────┼──────────────────────────────────────────────────────────────┤";


private var N2TableHeader = "Ошибки подготовки\n" +
                            "┌──────────┬───────────────┬──────────────────────────────────────────────────────────────┐\n"+
                            "│  Сделка  │ Код сообщения │ Сообщение                                                    │\n"+
                            "├──────────┼───────────────┼──────────────────────────────────────────────────────────────┤";

private var N1OprStateMsg = "\n#";

private var NFooter = "\n###############################################################\n"+
                      "######################################################################                 ################\n"+
                      "────────────────────────────────────────────────────────────────────── ───────────────   дата\n"+
                      "                                 ФИО                                      подпись";

PRIVATE CLASS (DL_CReportTemplate) IR_GenerMes_Report( ir_op, Mode )
  PRIVATE VAR m_PrintMode;
  PRIVATE VAR m_op = TRecHandler("ir_op");
  PRIVATE VAR m_IsExists = false;
  PRIVATE var m_Executer = DepoExecuter( {oper} );

  PRIVATE MACRO PrintMode():INTEGER
     return m_PrintMode;
  END;
  
  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO Create()
    var ReportLineData_XML:variant;
    var DealData:CIR_GenerMesRepParm;
    var SheetName = "Протокол";    
    var IsFirst = true;

    SetActiveSheet(SheetName);

    PrintFormatString(N1RepHeaderStr,
                     "N1_OperDate", m_op.rec.Date,
                     "N1_OperCode", m_op.rec.CodeOp
                     );
    CopyAllSheetInTotalBook(SheetName, false, "N1_RepHead", 0, SheetName);
                                               
    // успешными СРС
    ReportLineData_XML = GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);

    while( ReportLineData_XML.Next )
       m_IsExists = true;

       if( IsFirst )
          CopyAllSheetInTotalBook(SheetName, false, "N1_TableHeader", 1, SheetName);
          RegisterTable( "N1_MainTable", N1TableHeader,
                         "N1_DealType",
                         "N1_MessageID",
                         "N1_Status"
                       );
          IsFirst = false
       end;

       DealData = ReportLineData_XML.GetReportLineData();

       PrintTableLine( "N1_DealType",  "Сообщение "+DealData.MsgCode,  null,
                       "N1_MessageID",   DealData.DealCode,   null,
                       "N1_Status",    DealData.Status,    null
                     );
    end;

    if( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;

    var IsExistsErr = false;
    var ErrData:CIR_GenerMesRepErr;
    var stat = 0;

    // Ошибки
    ReportLineData_XML = GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    
    stat = ReportLineData_XML.Next();
    if( (stat) or (m_IsExists == false) )
      IsExistsErr = true;

      if( m_PrintMode == DL_OUTREPORT_EXCEL )
         m_ObjTemplateXLS.SetSheetColor(XlColorIndex_RED);
      end;

      if( not stat )
        PrintFormatString(N1OprStateMsg,"N1_OprStateMsg", "Нет подходящих сообщений");
        CopyAllSheetInTotalBook(SheetName, false, "N1_OprStateMsg", 1, SheetName);
      else
        CopyAllSheetInTotalBook(SheetName, false, "N2_TableHeader", 1, SheetName);
        RegisterTable( "N2_MainTable", N2TableHeader,
                       "N2_DealCode",
                       "N2_MsgCode",
                       "N2_ErrStr"
                  );

        while( stat )
          ErrData = ReportLineData_XML.GetReportLineData();

          PrintTableLine( "N2_DealCode", ErrData.DealCode, null,
                          "N2_MsgCode",  ErrData.MsgCode,  null,
                          "N2_ErrStr",   ErrData.ErrStr,   null
                        );

          stat = ReportLineData_XML.Next();
        end;

        EndTable();
        CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
      end;
    end; 

    if( IsExistsErr == false )
      PrintFormatString(N1OprStateMsg,"N1_OprStateMsg", "Операция завершена успешно");
      CopyAllSheetInTotalBook(SheetName, false, "N1_OprStateMsg", 1, SheetName);
    end;

    PrintFormatString(NFooter,
                     "N1_ExecutorPost", "Составил ( " + m_Executer.Post + " ):",
                     "N1_ExecutorName", string( m_Executer.Name ),
                     "N1_ExecuteDate:l",  m_op.rec.Date:f
                     );
    CopyAllSheetInTotalBook( SheetName, false, "N1_Footer", 1, SheetName );
  END;

  m_PrintMode = Mode;
  m_op = ir_op;

  initDL_CReportTemplate( NULL, "Report_GenerMes.xls");
END;

private MACRO PrintGenerMesByXML(op, Mode)
  record IrOp("ir_op");
  var recop = TRecHandler("ir_op");
  
  SetBuff(IrOp, op);

  copy(recop, IrOp);

  IR_GenerMes_Report(recop, Mode).Run();
  return true;

END;

MACRO PrintGenerMesByXMLToExcel( op )
  return PrintGenerMesByXML(op, DL_OUTREPORT_EXCEL);
END;

MACRO PrintGenerMesByXMLToSTD( op )
  return PrintGenerMesByXML(op, DL_OUTREPORT_STD);
END;

// Печать отчета по откату оперции
macro PrintRollBackReport(op)
  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*файл вывода для отчета*/
  record IrOp("ir_op");

  SetBuff(IrOp, op);
  
  ReportFileName = GetTxtFileName( "genermes_" + IrOp.ID );
  if( not Open( ReportOutFile, ReportFileName ) )
     errcode = status(errtext);
     RunError( "Ошибка при создании файла|"+ReportFileName+"|(" + errcode + ") " + errtext );
  end;
  SetOutput( ReportFileName );

  var sql =  " select t_warning from DSCREPLOG_TMP group by t_warning order by t_warning ";

  var cmd = RSDCommand(sql);
  cmd.execute();

  var DataSet = TRsbDataSet(cmd);
  var i = 1, IsFirstUse = true;;

  while( DataSet.MoveNext() )
     if(IsFirstUse == true )
        println(" Протокол отката операции");
        println("┌──────────┬──────────────────────────────────────────────────────────────┐");
        IsFirstUse = false;
     else
        println("├──────────┼──────────────────────────────────────────────────────────────┤");
     end;

     [│##########│##############################################################│]
     (i:r, DataSet.Warning:w);
     i = i + 1;

  end;

  if( IsFirstUse == false )
     println("└──────────┴──────────────────────────────────────────────────────────────┘");
  end;

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );

  return true;
end;


private MACRO ErrorFromCnvpack( cnv)
  var Cmd, Query, DataSet, err = 0;
  Query = " select t_Error, t_ErrMsg " +
          " from dcnvpack_dbt " +
          " where t_ExecID =  "  + string(cnv.ExecID) + 
          " group by t_Error, t_ErrMsg" ;
 
  Cmd = RSDCommand( Query );      
  
  Cmd.Execute();
  DataSet = TRsbDataSet(Cmd);

  while( DataSet.MoveNext() )
    if( DataSet.Error != 0 ) 
     
      RepErrArr[RepErrArr.size] = CIR_GenerMesRepErr("", "", IIF(DataSet.ErrMsg, DataSet.ErrMsg, ""));
      err = err + 1;
    end; 
  end;
  return err;
END;

//выборка данных для конвейера
macro GetGenerMesObjectQuery( ir_op )
  var query;

  query = "SELECT 0 as t_ObjectType, generalinf.t_InternalMessageID as t_ObjectID, grdeal.t_ID, "
        + "       (case when rd.t_DocKind = 4812 then ga.t_Code else td.t_Code end) as t_DealNumber "
        + "  FROM dir_generalinf_dbt generalinf, ddlgrdoc_dbt irgrdoc, ddlgrdeal_dbt grdeal, dv_irdeal td, ddl_repozdeal_dbt rd, ddl_genagr_dbt ga "
        + " WHERE irgrdoc.t_DocKind = " + REPOS_GENERALINF
        + "   AND irgrdoc.t_DocID   = generalinf.t_InternalMessageID "
        + "   AND grdeal.t_ID       = irgrdoc.t_GrDealID "
        + "   AND rd.t_DocKind      = grdeal.t_DocKind "
        + "   AND rd.t_DocID        = grdeal.t_DocID "
        + "   AND rd.t_DocKind      = td.t_DocKind(+) "
        + "   AND rd.t_DocID        = td.t_DocID(+) "
        + "   AND ga.t_DocKind(+)   = rd.t_DocKind "
        + "   AND ga.t_GenAgrID(+)  = rd.t_DocID "
        + "   AND (generalinf.t_RStatus = 1 OR generalinf.t_RStatus = 4) " /*Подготовлено или Ошибка генерации*/
/*
        + "   AND Exists ( SELECT AtCor.t_Object "
        + "                  FROM dobjatcor_dbt AtCor "
        + "                 WHERE AtCor.t_ObjectType        = CASE WHEN grdeal.t_DocKind = " + DL_SECURITYDOC + " THEN " + OBJTYPE_SECDEAL + " ELSE " + OBJTYPE_OUTOPER_DV + " END "
        + "                   AND AtCor.t_Object            = LPAD(grdeal.t_DocID, 34, '0') "
        + "                   AND AtCor.t_GroupID           = 38 " /*Репортинг в репозитарии*/
        + "                   AND AtCor.t_AttrID            = 1 " /*да*/
        + "                   AND AtCor.t_ValidFromDate     <= " + GetSQLDate(date(ir_op.rec.Date))
        + "                   AND (AtCor.t_ValidToDate = TO_DATE('01.01.0001','DD.MM.YYYY') OR AtCor.t_ValidToDate > " + GetSQLDate(date(ir_op.rec.Date)) + " ) "
        + "              ) "
*/
         ;

  if(ir_op.rec.DealID >0 )   //если генерируем из под сообщения, тогда берем его ID
     query = query + " AND generalinf.t_InternalMessageID = " + ir_op.rec.DealID ;
  else
     query = query + "   AND generalinf.t_PrDate = " + GetSQLDate(date(ir_op.rec.Date));

  end;

  /*var CountFlag = 0;
  // Отбор сообщений-анкет
  if( ir_op.rec.Form_Contract == SET_CHAR )

     // условие по коду сообщения
     if( ir_op.rec.MsgCode_Form != "" ) // по типу сообщения
        query = query + " AND ((generalinf.t_messagetype = '" + ir_op.rec.MsgCode_Form + "' ";
     else
        query = query + " AND ((generalinf.t_messagetype in ('CM022','CM023','CM041','CM042','CM044','CM045','CM046','CM048') ";
     end;

     //query = query + " AND generalinf.t_IsCorrection = " + IIF(ir_op.rec.Corrective_Contract == SET_CHAR, "chr(88)", "chr(0)");
     if( ir_op.rec.Corrective_Contract != SET_CHAR ) // Корректируещие. Пока сделаем так, что галочка "добаляет" корректирующие
        query = query + " AND generalinf.t_IsCorrection = chr(0) ";
     end;

     if( ir_op.rec.First_Contract != SET_CHAR ) // Первичные
        query = query + " AND generalinf.t_Amendment <> chr(0) ";
     end;

     if( ir_op.rec.Change_Contract != SET_CHAR ) // По изменению условий
        query = query + " AND generalinf.t_Amendment <> chr(88) ";
     end;

        query = query + " ) ";

     if( (ir_op.rec.BulkReport == UNSET_CHAR) and (ir_op.rec.Change_Obligation == UNSET_CHAR) )
        query = query + " ) ";
     end;

     CountFlag = CountFlag + 1;
  end;
  // Отбор сообщений по ген. соглашениям
  if (ir_op.rec.Generate_GA == SET_CHAR )
    
    if ( ir_op.rec.First_GA == SET_CHAR )
        if ( CountFlag == 0 )
            query = query + " AND ( (generalinf.t_messagetype = 'CM010' AND generalinf.t_Amendment = chr(0) ) ";
        end;
    end;
    
  end;
  // Отбор сводных сообщений
  if( ir_op.rec.BulkReport == SET_CHAR )

     if( ir_op.rec.MsgCode_Bulk != "" ) // По типу сообщения
        if(CountFlag == 0)
          query = query + " AND (generalinf.t_messagetype = '" + ir_op.rec.MsgCode_Bulk + "' ";
        else
          query = query + " OR generalinf.t_messagetype = '" + ir_op.rec.MsgCode_Bulk + "' ";
        end;
     else
        if(CountFlag == 0)
          query = query + " AND (generalinf.t_messagetype in ('CM083') ";
        else
          query = query + " OR generalinf.t_messagetype in ('CM083') ";
        end;

     end;
     if( (ir_op.rec.Change_Obligation == UNSET_CHAR) )
       query = query + " ) ";
     end;
     CountFlag = CountFlag + 1;
  end;
  // Отбор сообщений по изменению состояния обязательств
  if( ir_op.rec.Change_Obligation == SET_CHAR )

     if( ir_op.rec.MsgCode_Obligation != "" ) // По типу сообщения
        if(CountFlag == 0)
          query = query + " AND (generalinf.t_messagetype = '" + ir_op.rec.MsgCode_Obligation + "' ";
        else
          query = query + " OR generalinf.t_messagetype = '" + ir_op.rec.MsgCode_Obligation + "' ";
        end;
     end;
     query = query + " ) ";
//     query = query + " AND 1 <> 1 ";
  end;
  // Отбор сообщений по результатам сверки
  if ( false )
  
  end;*/
  
  var noGroupSelected = true;
  // Условия отбора сообщений
  query = query + " AND ( ";

  // Сообщения-анкеты
  if ( ir_op.rec.Form_Contract == SET_CHAR )
    if ( not noGroupSelected )
      query = query + " OR ";
    end;
    query = query + " ( ";

    if ( ir_op.rec.MsgCode_Form != "" )
      query = query + " generalinf.t_MessageType = '" + ir_op.rec.MsgCode_Form + "'";
    else
      query = query + " generalinf.t_MessageType in ('CM021', 'CM022', 'CM023', 'CM032', 'CM041', 'CM042', 'CM043', 'CM044', 'CM045', 'CM046', 'CM047', 'CM048', 'CM051','CM053') ";
    end;

    if   ( (ir_op.rec.First_Contract == UNSET_CHAR) and (ir_op.rec.Change_Contract == UNSET_CHAR) )
      query = query + " AND 1 <> 1 ";
    elif ( (ir_op.rec.First_Contract == SET_CHAR) and (ir_op.rec.Change_Contract == UNSET_CHAR) )
      query = query + " AND generalinf.t_Amendment <> chr(88) ";
    elif ( (ir_op.rec.First_Contract == UNSET_CHAR) and (ir_op.rec.Change_Contract == SET_CHAR) )
      query = query + " AND generalinf.t_Amendment <> chr(0) ";
    else
      query = query + " AND 1 = 1 ";
    end;
    
    query = query + " ) ";
    noGroupSelected = false;
  end;
  // Сообщения по ГС
  if ( ir_op.rec.Generate_GA == SET_CHAR )
    if ( not noGroupSelected )
      query = query + " OR ";
    end;
    query = query + " ( generalinf.t_MessageType in ('CM010', 'CM011') ";
    
    if   ( (ir_op.rec.First_GA == UNSET_CHAR) and (ir_op.rec.Change_GA == UNSET_CHAR) )
      query = query + " AND generalinf.t_MessageType <> 'CM010' ";
    elif ( (ir_op.rec.First_GA == SET_CHAR) and (ir_op.rec.Change_GA == UNSET_CHAR) )
      query = query + " AND generalinf.t_Amendment <> chr(88) ";
    elif ( (ir_op.rec.First_GA == UNSET_CHAR) and (ir_op.rec.Change_GA == SET_CHAR) )
      query = query + " AND generalinf.t_Amendment <> chr(0) ";
    else
      query = query + " AND 1 = 1 ";
    end;
    
    if ( ir_op.rec.StopGenerate_GA == UNSET_CHAR )
      query = query + " AND generalinf.t_MessageType <> 'CM011' ";
    end;
    
    query = query + " ) ";
    noGroupSelected = false;
  end;
  // Сводные сообщения
  if ( ir_op.rec.BulkReport == SET_CHAR )
    if ( not noGroupSelected )
      query = query + " OR ";
    end;
    query = query + " ( generalinf.t_Bulk = chr(88) ";
    
    if ( ir_op.rec.MsgCode_Bulk != "" )
      query = query + " AND generalinf.t_MessageType = '" + ir_op.rec.MsgCode_Bulk + "'";
    else
      query = query + " AND generalinf.t_MessageType in ('CM083') ";
    end;
    
    query = query + " ) ";
    noGroupSelected = false;
  end;
  // Сообщения по изменению обязательств
  if ( ir_op.rec.Change_Obligation == SET_CHAR )
    if ( not noGroupSelected )
      query = query + " OR ";
    end;
    query = query + " ( ";
    
    if ( ir_op.rec.MsgCode_Obligation != "" )
      query = query + " generalinf.t_MessageType = '" + ir_op.rec.MsgCode_Obligation + "'";
    else
      query = query + " generalinf.t_MessageType in ('CM093') ";
    end;
    
    query = query + " ) ";
    noGroupSelected = false;
  end;

  if ( ir_op.rec.Exec_Obligation == SET_CHAR )
    if ( not noGroupSelected )
      query = query + " OR ";
    end;
    query = query + " ( ";
    
    if ( ir_op.rec.MsgCode_ExecObligation != "" )
      query = query + " generalinf.t_MessageType = '" + ir_op.rec.MsgCode_ExecObligation + "'";
    else
      query = query + " generalinf.t_MessageType in ('CM092', 'CM094') ";
    end;
    
    query = query + " ) ";
    noGroupSelected = false;
  end;

  // Сообщения по итогам сверки
  /*if ( ir_op.rec.Reconciliation == SET_CHAR )
    if ( not noGroupSelected )
      query = query + " OR ";
    end;
    query = query + " ( ";
    
    query = query + " ) ";
    noGroupSelected = false;
  end;*/

  if ( noGroupSelected )
    query = query + " 1 <> 1  ";
  end;

  query = query + " ) ";

  return query;
end;

macro ПроверитьОперациюГСзаТекущуюДату(ir_op)
  var query, DataSet;
  var errStr = "";
  
  query = "select t_DealNumber, t_ObjectType "
        + "  from ("+GetGenerMesObjectQuery(ir_op)+") "
        + " group by t_DealNumber, t_ObjectType ";
  DataSet = TRsbDataSet(query);
  while( DataSet.moveNext() )
    errStr = "По сделке "+DataSet.DealNumber+" остались необработанные СРС за дату " + string(date(ir_op.rec.Date):f);
    RepErrArr[RepErrArr.size] = CIR_GenerMesRepErr(DataSet.DealNumber, "", errStr);
  end;
end;

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//ЗАПУСК КОНВЕЙЕРА

//класс с данными для конвейера
class CnvDataIROP( _ID ,_Oper)
  var ID = _ID;
  var Oper = IIF(_Oper,_Oper,{Oper});
end;

//запуск конвейера
private macro __StartCnvGenerMes( ir_op:TBFile, Oper )
  var rslObj = CnvDataIROP(ir_op.rec.ID, Oper);
  //var UseConveyer = DL_SecurUseConveyer();
  var err = 0;

  /*if( UseConveyer )
    var ConvID = ; //Вид конвейера генерации сообщений
    var OperID = ; //Операция для конвейра - Пакетная операция формирования генерации сообщений
    var cnv = RsbConveyerExec(ConvID);

    cnv.AddParamsForConveyer(ConvID, rslObj, 0);
    cnv.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
    cnv.showPanelMonitoring(1);
    cnv.Run();

    if( ErrorFromCnvpack(cnv) > 0 )
      err = 1;
    end;
  else*/
    err = ExecMacroFile("ir_genermes.mac", "ExecuteGenerMes", 0, 0, 0, 0, 0, rslObj);
  //end;

  if( err == 0 )
     ПроверитьОперациюГСзаТекущуюДату(ir_op);
  end;

  return err;

  OnError(er)
  
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  RepErrArr[RepErrArr.size] = CIR_GenerMesRepErr("", "", er.module+ " "+er.line+" "+er.message);

  return 1;
end;

macro StartCnvGenerMes( ID, Oper )
  var stat = 0;
  var ir_op = TBFile("ir_op.dbt");

  ir_op.rec.ID = ID;
  if( not ir_op.GetEQ() )
    msgbox("Ошибка поиска операции");
    return 1;
  end;   

  RepErrArr.size = 0; //массив ошибок

  stat = __StartCnvGenerMes(ir_op, Oper);

  SaveGenerMesErrForReport_XML(RepErrArr, ir_op.rec.ID, ir_op.rec.DocKind, Oper);

  return stat;
end;
