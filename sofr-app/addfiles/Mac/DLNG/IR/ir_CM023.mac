/*
    $Name: ir_CM023.mac
    $Module:   Репозитарий
    $Description:  Анкета договора валютного опциона 
*/

import "ir_CMBase.mac";

class (CMBase) CM023 ( _isRecon, _conveyerID, _ir_op : object)
  InitCMBase();

  m_isRecon     = _isRecon;
  m_conveyerID  = _conveyerID;
  m_ir_op       = _ir_op;
  m_MessageID   = REPOS_CM023;

  macro addCMAll(ir_generalinf     ,
                 TradeRepository   ,
                 Party1            ,
                 Party2            ,
                 UTIGeneratingParty,
                 Sender            ,
                 cm                ,
                 GrDealID          ,
                 TemplNum          ,
                 DealParmForReport )
    addGenInf(ir_generalinf, TemplNum, DealParmForReport);
    addRepAccGrDoc(GrDealID);
    addcmGrDoc(GrDealID);
    addParty(TradeRepository, Party1, Party2, UTIGeneratingParty, Sender);
    addCM(cm);
  end;

  macro insertAll
    var err = 0;
    err = insertGeneralinf;
    if (not err)
      err = insertParty;
    end;
    if (not err)
      err = insertDlgrdocCache;
    end;
    if (not err)
      err = insertCM;
    end;
    return err;
  end;

  macro ЗаполнениеCM (cm : @TrecHandler, 
                      DataSet, 
                      GenAgr,
                      FD)
    if( (FD.IsBuy() and (GenAgr.Side1 == 1)) or
        (FD.IsSale() and (GenAgr.Side1 != 1))
        )
        cm.rec.BuyerID  = IR_PARTY_KIND_PARTY1;
        cm.rec.Buyer= "Party1";
        cm.rec.SellerID = IR_PARTY_KIND_PARTY2;
    cm.rec.Seller   = "Party2";
    else
        cm.rec.BuyerID  = IR_PARTY_KIND_PARTY2;
        cm.rec.Buyer= "Party2";
        cm.rec.SellerID = IR_PARTY_KIND_PARTY1;
        cm.rec.Seller   = "Party1";
    end;
    
    cm.rec.PremiumPayerPartyID= cm.rec.BuyerID;
    cm.rec.PremiumPayerParty  = cm.rec.Buyer;
    cm.rec.PremiumReceiverPartyID = cm.rec.SellerID;
    cm.rec.PremiumReceiverParty   = cm.rec.Seller;
    cm.rec.OptExerID  = FD.Deal.rec.OptionStyle; // FI_DVSTYLE совпадает с OBJTYPE_OPTIONSTYPE
    cm.rec.OptExer= DL_GetValueName(OBJTYPE_OPTIONSTYPE, cm.rec.OptExerID);
    
    if( cm.rec.OptExer == "A" )
      cm.rec.OpenDate = FD.ДатаНачала();
      cm.rec.ExpiryDate = FD.ДатаИстеченияСрокаДействия();
    elif( cm.rec.OptExer == "E" )
    cm.rec.ExpiryDate = FD.ДатаИсполнения();
    end;
    
    if( (FD.BuyCallOrSalePut() and (GenAgr.Side1 == 1)) or
        ((not FD.BuyCallOrSalePut()) and (GenAgr.Side1 != 1))
        )
        cm.rec.PutCurrAmount  = FD.nFI_().rec.Cost;
        cm.rec.PutCurrID  = FD.ВалютаЦены();
        cm.rec.CallCurrAmount = FD.nFI_().rec.Amount;
        cm.rec.CallCurrID = FD.BaseFI().rec.FIID;
    cm.rec.StrikeBasis= "PutCurrencyPerCallCurrency";
    else
        cm.rec.PutCurrAmount  = FD.nFI_().rec.Amount;
        cm.rec.PutCurrID  = FD.BaseFI().rec.FIID;
        cm.rec.CallCurrAmount = FD.nFI_().rec.Cost;
        cm.rec.CallCurrID = FD.ВалютаЦены();
        cm.rec.StrikeBasis= "CallCurrencyPerPutCurrency";
    end;
    
    cm.rec.PutCurr   = GetFICode(cm.rec.PutCurrID, null, FICK_ISOSTRING);
    cm.rec.CallCurr  = GetFICode(cm.rec.CallCurrID, null, FICK_ISOSTRING);
    cm.rec.SoldAs= FD.OptionType();

/*DAN костыль переопределяющий стиль опциона*/
//if(cm.rec.SoldAs == "Call")
//   cm.rec.StrikeBasis= "PutCurrencyPerCallCurrency";
//elif(cm.rec.SoldAs == "Put")
//   cm.rec.StrikeBasis= "CallCurrencyPerPutCurrency";
//end;

    cm.rec.OptRate   = FD.nFI_().rec.Price;
    cm.rec.PremiumCurrencyID = FD.Deal.rec.BonusFIID;
    cm.rec.PremiumCurrency   = GetFICode(cm.rec.PremiumCurrencyID, null, FICK_ISOSTRING);
    cm.rec.PremiumAmount = FD.Deal.rec.Bonus;
    cm.rec.SettlCurrencyID   = FD.ВалютаРасчётов();
    cm.rec.SettlCurrency = GetFICode(cm.rec.SettlCurrencyID, null, FICK_ISOSTRING);
    return 0;
  end;
end;