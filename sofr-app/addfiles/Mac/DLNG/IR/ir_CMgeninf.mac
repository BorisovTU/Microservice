/*
    $Name: ir_CMgeninf.mac
    $Module:   Репозитарий
    $Description: Создание сообщения. Заполнение generalinf
*/

import "ir_CMfunctions.mac";

macro ОшибкаГенерации(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, isRecon, DealParmForReport)
    var stat=0;
    var err=false;
    if((error=="Ошибка при генерации кода СРС") and
        (field==""))
        err=true;
    end;
    if(first or err)
        var objType;
        if   ( (ValType(isRecon) != V_UNDEF) and isRecon )objType = OBJTYPE_GENERALINF_CM001;
        elif ( ir_generalinf.rec.MessageType == "CM010" ) objType = OBJTYPE_GENERALINF_CM010;
        elif ( ir_generalinf.rec.MessageType == "CM011" ) objType = OBJTYPE_GENERALINF_CM011;
        elif ( ir_generalinf.rec.MessageType == "CM021" ) objType = OBJTYPE_GENERALINF_CM021;
        elif ( ir_generalinf.rec.MessageType == "CM022" ) objType = OBJTYPE_GENERALINF_CM022;
        elif ( ir_generalinf.rec.MessageType == "CM023" ) objType = OBJTYPE_GENERALINF_CM023;
        elif ( ir_generalinf.rec.MessageType == "CM032" ) objType = OBJTYPE_GENERALINF_CM032;
        elif ( ir_generalinf.rec.MessageType == "CM041" ) objType = OBJTYPE_GENERALINF_CM041;
        elif ( ir_generalinf.rec.MessageType == "CM042" ) objType = OBJTYPE_GENERALINF_CM042;
        elif ( ir_generalinf.rec.MessageType == "CM043" ) objType = OBJTYPE_GENERALINF_CM043;
        elif ( ir_generalinf.rec.MessageType == "CM044" ) objType = OBJTYPE_GENERALINF_CM044;
        elif ( ir_generalinf.rec.MessageType == "CM045" ) objType = OBJTYPE_GENERALINF_CM045;
        elif ( ir_generalinf.rec.MessageType == "CM046" ) objType = OBJTYPE_GENERALINF_CM046;
        elif ( ir_generalinf.rec.MessageType == "CM047" ) objType = OBJTYPE_GENERALINF_CM047;
        elif ( ir_generalinf.rec.MessageType == "CM048" ) objType = OBJTYPE_GENERALINF_CM048;
        elif ( ir_generalinf.rec.MessageType == "CM051" ) objType = OBJTYPE_GENERALINF_CM051;
        elif ( ir_generalinf.rec.MessageType == "CM053" ) objType = OBJTYPE_GENERALINF_CM053;
        elif ( ir_generalinf.rec.MessageType == "CM083" ) objType = OBJTYPE_GENERALINF_CM083;
        elif ( ir_generalinf.rec.MessageType == "CM093" ) objType = OBJTYPE_GENERALINF_CM093;
        elif ( ir_generalinf.rec.MessageType == "CM092" ) objType = OBJTYPE_GENERALINF_CM092;
        elif ( ir_generalinf.rec.MessageType == "CM094" ) 
            if( ir_generalinf.rec.MessageID == "")
                objType = OBJTYPE_GENERALINF_CM094;
            else
                return stat;
            end;
        end;

        var uniqMesID = false; 
        if(ir_generalinf.rec.InternalMessageID != 0)    // коррект, заменяющ и т.п. генерировать код не нужно
            if(err or (first and (ir_generalinf.rec.RStatus != 2)))          // если НЕ переподготовка
                ir_generalinf.rec.InternalMessageID = 0;
                ir_generalinf.rec.MessageID = ir_generalinf.rec.MessageID + "-K";
            end;
            for(var i, 0, 1000) // пытаемся сгенерить уникальный MessageID, но не более 1000 раз
                // проверка: если уже есть сообщение с таким MessageID, то добавим после K цифровой индекс 1-2-3 и т.д.
                var queryCmd = RsdRecordset("SELECT T_MessageID FROM dir_generalinf_dbt WHERE T_InternalMessageID <> "+ ir_generalinf.rec.InternalMessageID +" AND t_MessageID = '"+ ir_generalinf.rec.MessageID + "'");
                if(queryCmd.MoveNext())     
                    var pos = Index(queryCmd.value(0), "-K") + 2;
                    var msgIndex = SubStr(queryCmd.value(0), pos);
                    if(msgIndex == "")
                        ir_generalinf.rec.MessageID = ir_generalinf.rec.MessageID + "1";
                    else
                        ir_generalinf.rec.MessageID = substr(ir_generalinf.rec.MessageID, 1, pos-1) + String(Int(msgIndex) + 1);
                    end;
        else
                    uniqMesID = true;
                    break;    // уникальный код - на выход
            end;
            end;  // for
        else
            for(var j, 0, 1000) // пытаемся сгенерить уникальный MessageID, но не более 1000 раз
                if( DL_GenRefByTypeDoc(objType, ir_generalinf.rec.MessageID) )  // генерируем уникальный для типа сообщения код 
            if(objType == OBJTYPE_GENERALINF_CM001)
                ir_generalinf.rec.MessageID = "CM001" + "-" + ir_generalinf.rec.MessageID;    // заменяем тип сообщения на CM001
            else
            ir_generalinf.rec.MessageID = ir_generalinf.rec.MessageType + "-" + ir_generalinf.rec.MessageID;    // получаем номер сообщения из типа сообщения и уникального кода
        end;
                    var queryCmd2 = RsdRecordset("SELECT T_MessageID FROM dir_generalinf_dbt WHERE t_MessageID = '"+ ir_generalinf.rec.MessageID + "'");
                    if(not queryCmd2.MoveNext())
                        uniqMesID = true;
                        break;    // уникальный код - на выход
                    end;
                end;
            end;  // for
        end;

        if(not uniqMesID)
          ir_generalinf.rec.MessageID = "";
          RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Ошибка при генерации кода СРС", "", GetReportAction(DataSet.TemplNum));
          stat = 1;
    end;
    end;
    return stat;
end;

macro ОшибкаSendBy(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false;
    if((error=="Для участника \"Информирующее лицо\" не задан репозитарный идент. код") and
        (field=="SendBy"))
        err=true;
    end;
    if(first or err)
        if(err or (first and (ir_generalinf.rec.RStatus != 2)))          // если НЕ переподготовка
            ir_generalinf.rec.SendByID = DataSet.REPORTER_BANK;
            ir_generalinf.rec.SendBy = ПолучитьКодСубъекта(ir_generalinf.rec.SendByID, PTCK_RIC);
        end;
        if( ir_generalinf.rec.SendBy == "" )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Информирующее лицо\" не задан репозитарный идент. код", "SendBy", GetReportAction(DataSet.TemplNum), 6);
        else
            var year;
            DateSplit ( {curdate}, NULL, NULL, year);
            if((substr(ir_generalinf.rec.MessageID, 1, 5) != "CM001") and (substr(ir_generalinf.rec.MessageID, 1, 5) != "CM002"))
                ir_generalinf.rec.correlationID = "[" + string(ir_generalinf.rec.SendBy) + "]-[" + year + "]-["+ ir_generalinf.rec.MessageId + "]";
            else
              // Добавить  после реализации CM001 и CM002  - [значение из поля CorrelationID из RM005]
              ir_generalinf.rec.correlationID = "";
              var cmd = RsdRecordset("SELECT DISTINCT gif.T_CorrelationID FROM dir_generalinf_dbt gif, ddlgrdoc_dbt grdoc"
                + " WHERE grdoc.t_grdealid IN (SELECT deal.t_id FROM ddlgrdeal_dbt deal WHERE"
                    + " deal.t_dockind = " + DataSet.DocKind
                    + " AND deal.t_docid = " + DataSet.DocID + ")" 
                + " AND grdoc.t_dockind = " + REPOS_RECONCILIATION
                + " AND gif.t_InternalMessageID = grdoc.t_docid" 
                + " AND gif.t_Rstatus <> 8 AND gif.t_messagetype = 'RM005'");
              if(cmd.MoveNext())
                ir_generalinf.rec.correlationID = cmd.value(0);
              end;

/*DAN защита от пустого CorrelationID--*/
              if (ir_generalinf.rec.correlationID == "")
                ir_generalinf.rec.correlationID="["+string(ir_generalinf.rec.SendBy)+"]-["+year+"]-[";
                if((ir_generalinf.rec.MessageType!="CM001")and (ir_generalinf.rec.MessageType!="CM002"))
                    ir_generalinf.rec.correlationID=ir_generalinf.rec.correlationID+ir_generalinf.rec.MessageId+"]";
                end;
              end;
/*--DAN*/
            end;
        end;
    end;
    return stat;
end;

macro ОшибкаSendTo(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false;
    if((error=="Для участника \"Репозитарий\" не задан репозитарный идент. код") and
        (field=="SendTo"))
        err=true;
    end;
    var RepositaryID=null,RepositaryCodeRIC;
    if(first or err)
        if( RepositaryID == null )
            RepositaryID = DL_GetPartyWithOwn(PTK_REPOSITARY);
            RepositaryCodeRIC = ПолучитьКодСубъекта(RepositaryID, PTCK_RIC);
        end;
        if(err or (first and (ir_generalinf.rec.RStatus != 2)))          // если НЕ переподготовка
            ir_generalinf.rec.SendToID = RepositaryID;
            ir_generalinf.rec.SendTo = RepositaryCodeRIC;
        end;
        if( ir_generalinf.rec.SendTo == "" )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Репозитарий\" не задан репозитарный идент. код", "SendTo", GetReportAction(DataSet.TemplNum), 8);
        end;
    end;
    return stat;
end;

PRIVATE MACRO GenAgrFormCorrelationID( GenAgr )
    var query = "SELECT gf.t_CorrelationID CorrelationID "
               +"  FROM dir_generalinf_dbt gf, ddlgrdoc_dbt gc, ddlgrdeal_dbt gd "
               +" WHERE     gd.t_DocID = ? "
               +"       AND gd.t_DocKind = 4812 "
               +"       AND gc.t_GrDealID = gd.t_ID "
               +"       AND gc.t_DocKind = 4853 "
               +"       AND gf.t_InternalMessageID = gc.t_DocID "
               +"       AND gf.t_RStatus in (1, 3, 4)"; // подготовлено/сгенерировано/ошибка генерации
    
    var cmd = DL_RSDCommand();
    cmd.addParam(GenAgr.GenagrID);
    
    if ( cmd.GetCount(query) > 0 )
        var data = cmd.Execute(query);
        data.MoveNext();
        return data.CorrelationID;
    else
        return "";
    end;
END;

PRIVATE MACRO GetProductType( TypeProduct:integer ):string
    
    var RetVal:string = "";
    
    if( TypeProduct > 0 )
        var Select = " SELECT t_ProductType "
        + "   FROM dir_typeproduct_dbt "
        + "  WHERE t_ID = ? ";
        
        var cmd = DL_RSDCommand(Select);
        cmd.addParam(TypeProduct);
        
        var DataSet = cmd.Execute();
        if( DataSet.MoveNext() )
            RetVal = DataSet.ProductType;
        end;
    end;
    
    return RetVal;
END;

PRIVATE MACRO GetAsOfDate( DocKind:integer, DocID:integer, TemplNum:integer, OpDate:date ):date
    
    var RetVal:date = date(0,0,0);
    
    var Select = " SELECT MAX(t.t_RegistrDate) RegistrDate  "
    + "   FROM dspground_dbt t "
    + "  WHERE t.t_SPGroundID in (SELECT spgrd.t_SPGroundID "
    + " FROM dspgrdoc_dbt spgrd "
    //+ "WHERE spgrd.t_SourceDocKind = ? AND spgrd.t_SourceDocID = ? ) "
    + "WHERE spgrd.t_SourceDocKind in ("+ DL_SECURITYDOC + ", "+ DL_DVNDEAL +", "+ DL_DVFXDEAL +", "+ DL_DVDEALT3 
    +") AND spgrd.t_SourceDocID = ? ) "
    + "AND t.t_Kind = ? "
    + "AND t.t_registrdate <= ? "
    + "ORDER BY t.t_registrdate desc ";
    
    var cmd = DL_RSDCommand(Select);
    
    //cmd.addParam(DocKind);
    cmd.addParam(DocID);
//    cmd.addParam(IIF(TemplNum == DLGR_TEMPL_MAKEDEALMSG, 26/*заменить на что?*/, 26/*DOCKIND_BUYSALEREPORT*/));
    cmd.addParam(512);   // Дополнительное соглашение
    cmd.addParam(OpDate);
    
    var DataSet = cmd.Execute();
    
    if( DataSet.MoveNext() )
        RetVal = SQL_ConvTypeDate(DataSet.RegistrDate);
    end;
    return RetVal;
END;

macro ОшибкаParentCorrelationId(ir_generalinf:@TRecHandler,DataSet,GenAgr,first:bool, error, field, MessageType, DealParmForReport)
    var stat = 0;
    var err = false;
    var strErr = "В анкете ГС не указан код, присвоенный ему репозитарием и нет связанного с ГС сообщения СМ010. "
               + "Подготовка анкеты сделки возможна только после подготовки анкеты ГС СМ010.";
    if((field=="parentCorrelationId")and (error == strErr))
        err=true;
    end;
    if(first or err )
        if( (GenAgr.PGA != SET_CHAR) and
            (DataSet.GenAgrID > 0) and
            (MessageType >= "CM021") and (MessageType <= "CM082") and
            (GenAgr.numrepoz == "")            
          )
            var GAcorrID = ir_generalinf.rec.parentCorrelationId;
            var messageSendingMode = false;
            GetRegistryValue("РЕПОЗИТАРИЙ\\ОБРАБОТКА ВХОДЯЩИХ СООБЩЕНИЙ", V_BOOL, @messageSendingMode, null);
            if(err or (first and (ir_generalinf.rec.RStatus != 2)))          // если НЕ переподготовка
                GAcorrID = GenAgrFormCorrelationID(GenAgr);
            end;
            if ( (GAcorrID == "") and messageSendingMode)
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, MessageType, string(strErr), "parentCorrelationId", GetReportAction(DataSet.TemplNum), 10);
            else
                ir_generalinf.rec.parentCorrelationId = GAcorrID;
            end;
        end;
    end;
    return stat;
end;

macro ОшибкаLinkID(ir_generalinf:@TRecHandler,DataSet,GenAgr,first:bool, error, field, MessageType, DealParmForReport)
    var stat = 0;
    var err = false;
    var strErr = "В анкете ГС не указан код, присвоенный ему репозитарием и нет связанного с ГС сообщения СМ010. "
               + "Подготовка анкеты сделки возможна только после подготовки анкеты ГС СМ010.";
    var strErrCsa = "анкете ГС не указан код, присвоенный  репозитарием";

    if((field == "LinkID") and ((error == strErr) or (error == strErrCsa)))
        err=true;
    end;
    
    if(first or err )
        var repoz = ir_generalinf.rec.LinkID;
        if(err or (first and (ir_generalinf.rec.RStatus != 2)))          // если НЕ переподготовка
            repoz = GenAgr.numrepoz
        end;
        if(MessageType == "CM092")
            if ( repoz == "" )
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, MessageType, string(strErrCsa), "LinkID", GetReportAction(DataSet.TemplNum), 200+11);
                return stat;
            end;
            ir_generalinf.rec.LinkID = repoz;
        end;
    
        if( (GenAgr.PGA != SET_CHAR) and (DataSet.GenagrID > 0) and (ir_generalinf.rec.Bulk != SET_CHAR) and 
            (not GAmsg) and (MessageType != "CM002") and (MessageType != "CM093") and (MessageType != "CM094")) 
            if ( repoz == "" )
                var GAcorrID = GenAgrFormCorrelationID(GenAgr);
                if ( GAcorrID == "" )
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, MessageType, string(strErr), "LinkID", GetReportAction(DataSet.TemplNum), 200+11);
                else
                    ir_generalinf.rec.LinkID = "";
                end;
            else
                ir_generalinf.rec.LinkID = repoz;
            end;
        end;
    end;
    return stat;
end;

macro ОшибкаTradeId_TradeRepository(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false, errCorrect=false, err93=false;
    var FldNumber;
    var queryCmd = RsdRecordset();
    var msgNum = int(substr(ir_generalinf.rec.MessageType, 4));
         
    if((error=="Не задан код договора, присвоенный репозитарием") and
        (field=="TradeId_TradeRepository"))
        err=true;
    elif(((error=="В корректирующем сообщении не задан код первичного отчета, присвоенный репозитарием") or
          (error=="Не найдено исходное сообщение для корректирующего"))
          and (field=="TradeId_TradeRepository"))
      errCorrect=true;
    elif(((error=="Не задан код договора, присвоенный репозитарием") or
          (error=="Не найдена информация о сделке, входящей в сообщение")) and (field=="TradeId"))
        err93=true;
    end;
    if((ir_generalinf.rec.MessageType != "CM093") and (ir_generalinf.rec.MessageType != "CM094"))   // у этих сообщений это поле не проставляется в ошибке
      FldNumber = 200 + 12;
    end;
    if(first or err or errCorrect or err93)     
        ir_generalinf.rec.PartyRefID_TradeRepository = IR_PARTY_KIND_TRADEREPOSITORY;
        ir_generalinf.rec.PartyRef_TradeRepository   = "TradeRepository"; 
        if(not err and not errCorrect and not (first and (ir_generalinf.rec.RStatus != 2))         // если нет ошибок и переподготовка
                  and (ir_generalinf.rec.TradeId_TradeRepository != ""))                           // и значение задано
            return stat;      // уходим
        end;

        // В СМ001   (повторяющиеся блоки сделаны для более простого сопоставления условий с ТЗ)
        if(substr(ir_generalinf.rec.MessageID, 1, 5) == "CM001")  
            ir_generalinf.rec.TradeId_TradeRepository == "";  // зануляем
            // по итогам сверки RM005, относящегося к сообщению-отчета <executionStatus> (CМ093) или <transfersAndExecution> (СМ092) с признаком изменения условий или корректирующего
            if(((ir_generalinf.rec.XMLProduct == "executionStatus") or (ir_generalinf.rec.XMLProduct == "transfersAndExecution")) and ((ir_generalinf.rec.CorrectRegisteredInfo == SET_CHAR) or (ir_generalinf.rec.IsCorrection == SET_CHAR) or (ir_generalinf.rec.Amendment == SET_CHAR)))
                //= значению параметра TradeRepository_ReportID исходного сообщения (по которому выполнялась сверка или произошло изменение условий или корректировка
                queryCmd = RsdRecordset("SELECT T_TradeRepository_ReportID FROM dir_generalinf_dbt WHERE t_MessageID = "+ 
                            "SubStr('"+ ir_generalinf.rec.MessageID +"', 1, instr('"+ ir_generalinf.rec.MessageID + "', '-K')-1)");   // MessageID первичного <- обрезаем '-Knn' у корректирующего
                if(queryCmd.MoveNext())             
                    ir_generalinf.rec.TradeId_TradeRepository = queryCmd.value(0); // читаем T_TradeRepository_ReportID из исходной сделки
                end;
            else
                // значение параметра "Код договора в репозитарии" из исходной сделки
                queryCmd = RsdRecordset("SELECT T_TradeId_TradeRepository FROM dir_generalinf_dbt WHERE t_MessageType = 'RM005' AND T_CorrelationID = '"+ ir_generalinf.rec.CorrelationID+"'");
                if(queryCmd.MoveNext())             
                    ir_generalinf.rec.TradeId_TradeRepository = queryCmd.value(0); // читаем T_TradeRepository_ReportID из исходной сделки
                end;
                if(ir_generalinf.rec.TradeId_TradeRepository == "")
                    ir_generalinf.rec.TradeId_TradeRepository = "NONREF";     // если он не задан, то = NONREF       
                end;
            end;
            // а если в этом поле значение отсутствует, то в протокол выводится сообщение об ошибке
            if(ir_generalinf.rec.TradeId_TradeRepository == "")
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора, присвоенный репозитарием", "TradeId_TradeRepository", GetReportAction(DataSet.TemplNum), FldNumber);
            end;
          /*
            // В СМ002 не заполняется     
        elif(ir_generalinf.rec.MessageType == "CM002")  
            ir_generalinf.rec.TradeId_TradeRepository = "";
          */
            // для несводных СМ021-СМ081, СМ010 
        elif( (ir_generalinf.rec.Bulk != SET_CHAR) and ((msgNum == 10) or (msgNum == 11) or ((msgNum >= 21) and (msgNum <= 81))))    
            if ( (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT) or
                (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT_CORRECTION) or
                (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACTWTHREQUEST) or
                (DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL) or
                (DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL_CORRECTION) or
                (DataSet.TemplNum == DLGR_TEMPL_MAKEDEALWTHREQUEST) or
                (DataSet.TemplNum == DLGR_TEMPL_REVALUATION_FAIRVALUE) or
                (DataSet.TemplNum == DLGR_TEMPL_CSA_MARGIN_PAYMENT) or
                (ir_generalinf.rec.IsCorrection == SET_CHAR)   // или это заменяющее сообщение
              )
                ir_generalinf.rec.TradeId_TradeRepository = "NONREF";
            else
                if ((ir_generalinf.rec.MessageType == "CM011") or (ir_generalinf.rec.MessageType == "CM010"))
                    ir_generalinf.rec.TradeId_TradeRepository = DataSet.DealCode;
                // костыль для сверки, если в репозитарных параметрах не заполнен CONTRACT_IR                    
                /*elif ((DataSet.TemplNum == DLGR_TEMPL_RECONCILIATION) and (DataSet.CONTRACT_IR == ""))  
                    queryCmd = RsdRecordset("SELECT T_TradeId_TradeRepository FROM dir_generalinf_dbt WHERE t_MessageType = 'RM005' AND T_CorrelationID = '"
                                            + ir_generalinf.rec.CorrelationID + "'");
                    if(queryCmd.MoveNext())             
                        ir_generalinf.rec.TradeId_TradeRepository = queryCmd.value(0); // читаем T_TradeRepository_ReportID из входящего сообщения
                    end;*/
                else
                    ir_generalinf.rec.TradeId_TradeRepository = DataSet.CONTRACT_IR;
                end;
            end;
            if(ir_generalinf.rec.TradeId_TradeRepository == "")
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора, присвоенный репозитарием", "TradeId_TradeRepository", GetReportAction(DataSet.TemplNum), FldNumber);
            end;

            // В СМ084, СМ093, СМ092, СМ094 - опечатка в ТЗ 084 вместо 083
        elif((msgNum == 83) or (msgNum == 93) or (msgNum == 92) or (msgNum == 94))
               // в первичных сообщениях = "NONREF"
            if((ir_generalinf.rec.CorrectRegisteredInfo != SET_CHAR) and (ir_generalinf.rec.IsCorrection != SET_CHAR) and (ir_generalinf.rec.Amendment != SET_CHAR))                        
                ir_generalinf.rec.TradeId_TradeRepository = "NONREF";
              // в корректирующих - код сообщения, присвоенный репозитарием, из первичного сообщения (из поля TradeRepository_ReportID), 
            else 
                ir_generalinf.rec.TradeId_TradeRepository == "";  // зануляем
                queryCmd = RsdRecordset("SELECT T_TradeRepository_ReportID FROM dir_generalinf_dbt WHERE T_MessageID = "+ // читаем T_TradeRepository_ReportID первичного
                            "SubStr('"+ ir_generalinf.rec.MessageID +"', 1, instr('"+ ir_generalinf.rec.MessageID + "', '-K')-1)");   // MessageID первичного <- обрезаем '-Knn' у корректирующего
                if(queryCmd.MoveNext())  
                    ir_generalinf.rec.TradeId_TradeRepository = queryCmd.value(0);
                    // а если в этом поле значение отсутствует, то в протокол выводится сообщение об ошибке
                    if(ir_generalinf.rec.TradeId_TradeRepository == "")
                        stat = 1;
                        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "В корректирующем сообщении не задан код первичного отчета, присвоенный репозитарием", "TradeId_TradeRepository", GetReportAction(DataSet.TemplNum), FldNumber);
                    end;
                else
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не найдено исходное сообщение для корректирующего", "TradeId_TradeRepository", GetReportAction(DataSet.TemplNum), FldNumber);
                end;
            end;

        elif(err93 or (ir_generalinf.rec.MessageType == "CM093"))   // была ошибка при подготовке CM093
            var cm093 = TBFile( "ir_cm093", "W", 1 );   // открываем файл на запись с ключом 1 = InternalMessageID
                
            cm093.rec.InternalMessageID = ir_generalinf.rec.InternalMessageID;
            stat = 1;
            if( cm093.GetEQ() )   // находим первую запись в dir_cm093 с нашим InternalMessageID
                while(cm093.rec.InternalMessageID == ir_generalinf.rec.InternalMessageID)   // перебираем все записи с этим InternalMessageID
                    if( cm093.rec.DealID == DataSet.DocID )
                      cm093.rec.TradeIdent = DataSet.CONTRACT_IR;     // если номер сделки изменился, то перезапишем его
                      stat = IIF(cm093.Update(), 0, 1);
                      break;
                    end;
                    cm093.Next();
                end;
            else
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не найдена информация о сделке, входящей в сообщение", "TradeId", GetReportAction(DataSet.TemplNum), FldNumber);
            end;
            if(DataSet.CONTRACT_IR == "") 
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора, присвоенный репозитарием", "TradeId", GetReportAction(DataSet.TemplNum), FldNumber);
            end;
            ir_generalinf.rec.TradeId_TradeRepository = "NONREF";

        else   // сюда не должны попадать
            // для CM015-CM017, CM083 и CM085 в документации ничего нет  
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора, присвоенный репозитарием - значение поля не определено в ТЗ", "TradeId_TradeRepository", GetReportAction(DataSet.TemplNum), FldNumber);
            stat = 1;   
        end;
    end;
    return stat;
end;

// Макрос используется при GenAgr.Side1 == 2 (Контрагент)
macro ОшибкаTradeId_Party1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false;
    var errContr=false;
    var msgNum = int(substr(ir_generalinf.rec.MessageType, 4));
    if((error=="Не задан код договора, присвоенный контрагентом") and
        (field=="TradeId_Party1"))
        err=true;
    elif((error=="Не задан код первичного отчета, присвоенный контрагентом") and
        (field=="ReportId_Party1"))
        errContr=true;
    end;
        // заменяющее для CM092, CM093 и CM094
    if((errContr or (ir_generalinf.rec.IsCorrection == SET_CHAR)) and ((msgNum == 92) or (msgNum == 93) or (msgNum == 94)))        
        if(ir_generalinf.rec.CounterParty_ReportID == "")
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код первичного отчета, присвоенный контрагентом", "ReportId_Party1", GetReportAction(DataSet.TemplNum), 100 + 2);
        else
            ir_generalinf.rec.TradeId_Party1 = ir_generalinf.rec.CounterParty_ReportID;
        end;
    
    elif(first or err)
        if((msgNum == 92) or (msgNum == 93) or (msgNum == 94))
            ir_generalinf.rec.TradeId_Party1 = "NONREF";
            return stat;
        end;
        if( (DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL) or ( DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT) or
              (DataSet.TemplNum == DLGR_TEMPL_MAKEDEALWTHREQUEST) or ( DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACTWTHREQUEST) or
              (DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL_CORRECTION) or (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT_CORRECTION) )
            ir_generalinf.rec.TradeId_Party1 = IIF(GenAgr.NumContr == "", "NONREF", GenAgr.NumContr);
        else
            ir_generalinf.rec.TradeId_Party1 = GenAgr.NumContr;
            if( ir_generalinf.rec.TradeId_Party1 == "" )
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора, присвоенный контрагентом", "TradeId_Party1", GetReportAction(DataSet.TemplNum), 200 + 23);
            end;
        end;
    end;
    return stat;
end;

macro ОшибкаOriginatingID_Party1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false;
    var CSA;

    if((ir_generalinf.rec.MessageType == "CM093") or 
        (ir_generalinf.rec.MessageType == "CM094") or
        (ir_generalinf.rec.MessageType == "CM002"))
        return stat;
    end;

    if(((error=="В ген. соглашении не задан номер CSA, присвоенный контрагентом") or
        (error=="Не задан код договора CSA, присвоенный контрагентом") or
        (error=="Не задан код договора CSA, присвоенный банком")) and
        (field=="OriginatingID_Party1"))
        err=true;
    end;
    if(first or err)
        if ( not GAmsg )
            if(ir_generalinf.rec.MessageType == "CM092")
                CSA = GetCSA(DataSet.DocID);
                if(CSA != null)
                    if( GenAgr.Side1 == 2 )
                        if ( CSA.rec.counterparty_agr_code == "" )
                            if ( CSA.rec.tr_agr_code == "" )
                                ir_generalinf.rec.OriginatingID_Party1 = "NONREF";
                            else
                                stat = 1;
                                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора CSA, присвоенный контрагентом", "OriginatingID_Party1", GetReportAction(DataSet.TemplNum), 200 + 24);
                            end;
                        else
                            ir_generalinf.rec.OriginatingID_Party1 = CSA.rec.counterparty_agr_code;
                        end;
                    else
                        if ( CSA.rec.Bank_agr_code != "" )
                            ir_generalinf.rec.OriginatingID_Party1 = CSA.rec.Bank_agr_code;
                        else
                            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора CSA, присвоенный бакном", "OriginatingID_Party1", GetReportAction(DataSet.TemplNum), 200 + 24);
                        end;
                    end;
                end;
            else
                CSA = getConnectedCSA(GenAgr);
                if(CSA != null)
                    if( GenAgr.Side1 == 2 )
                        if ( CSA.rec.counterparty_agr_code == "" )
                            if ( CSA.rec.tr_agr_code == "" )
                                ir_generalinf.rec.OriginatingID_Party1 = "NONREF";
                            else
                                stat = 1;
                                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "В ген. соглашении не задан номер CSA, присвоенный контрагентом", "OriginatingID_Party1", GetReportAction(DataSet.TemplNum), 200 + 24);
                            end;
                        else
                            ir_generalinf.rec.OriginatingID_Party1 = CSA.rec.counterparty_agr_code;
                        end;
                    else
                        ir_generalinf.rec.OriginatingID_Party1 = CSA.rec.Bank_agr_code;
                    end;
                else
                    ir_generalinf.rec.OriginatingID_Party1 = "";
                end;
            end;
        else
            ir_generalinf.rec.OriginatingID_Party1 = "";
        end;
    end;
    return stat;
end;

macro ОшибкаParty1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false;
    if(((error=="В ген. соглашении не задан номер CSA, присвоенный контрагентом") and
        (field=="OriginatingID_Party1"))or
        ((error=="Не задан код договора, присвоенный контрагентом") and
        (field=="TradeId_Party1"))or
        ((error=="Не задан номер договора, присвоенный Банком") and
        (field=="TradeId_Party1"))or
        ((error=="Не задан код первичного отчета, присвоенный Банком") and
        (field=="TradeId_Party1"))
        )
        err=true;
    end;
    
    if(first or err)
        if( ir_generalinf.rec.Bulk != SET_CHAR )
            if( GenAgr.Side1 == 2 ) // Контрагент
                stat = stat + ОшибкаTradeId_Party1(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
                stat = stat + ОшибкаOriginatingID_Party1(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
            else
                if((ir_generalinf.rec.MessageType == "CM092") or 
                    (ir_generalinf.rec.MessageType == "CM093") or
                    (ir_generalinf.rec.MessageType == "CM094"))//cm094
                    if(ir_generalinf.rec.MessageID != "")
                        ir_generalinf.rec.TradeId_Party1 = ir_generalinf.rec.MessageID;
                    elif( not first and (ir_generalinf.rec.MessageID == ""))
                        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код первичного отчета, присвоенный Банком", "TradeId_Party1", GetReportAction(DataSet.TemplNum), 200 + 23);
                    end;
                else
                    if(DataSet.CONTRACT == "")
                        if(DataSet.CONTRACT_IR == "")
                            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан номер договора, присвоенный Банком", "TradeId_Party1", GetReportAction(DataSet.TemplNum), 200 + 23);
                            stat = stat + 1;
                        else
                            ir_generalinf.rec.TradeId_Party1 = DataSet.CONTRACT_IR; 
                        end;
                    else
                        ir_generalinf.rec.TradeId_Party1 = DataSet.CONTRACT;
                    end;
                end;
                stat = stat + ОшибкаOriginatingID_Party1(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
            end;
        else
            ir_generalinf.rec.TradeId_Party1 = ir_generalinf.rec.MessageID; /*пока так*/
            ir_generalinf.rec.OriginatingID_Party1 = "";
        end;
    end;
    return IIF(stat>0,1,0);
end;

macro ОшибкаOriginatingID_Party2(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false;
    var CSA;

    if((ir_generalinf.rec.MessageType == "CM093") or 
        (ir_generalinf.rec.MessageType == "CM094") or
        (ir_generalinf.rec.MessageType == "CM002"))
        return stat;
    end;

    if(((error=="В ген. соглашении не задан номер CSA, присвоенный контрагентом") or
        (error=="Не задан код договора CSA, присвоенный контрагентом") or
        (error=="Не задан код договора CSA, присвоенный банком")) and
        (field=="OriginatingID_Party2"))
        err=true;
    end;
    if(first or err)
        if ( not GAmsg )
            if(ir_generalinf.rec.MessageType == "CM092")
                CSA = GetCSA(DataSet.DocID);
                if(CSA != null)
                    if( GenAgr.Side2 == 2 )
                        if ( CSA.rec.counterparty_agr_code == "" )
                            if ( CSA.rec.tr_agr_code == "" )
                                ir_generalinf.rec.OriginatingID_Party2 = "NONREF";
                            else
                                stat = 1;
                                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора CSA, присвоенный контрагентом", "OriginatingID_Party2", GetReportAction(DataSet.TemplNum), 200 + 35);
                            end;
                        else
                            ir_generalinf.rec.OriginatingID_Party2 = CSA.rec.counterparty_agr_code;
                        end;
                    else
                        if ( CSA.rec.Bank_agr_code != "" )
                            ir_generalinf.rec.OriginatingID_Party2 = CSA.rec.Bank_agr_code;
                        else
                            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора CSA, присвоенный бакном", "OriginatingID_Party2", GetReportAction(DataSet.TemplNum), 200 + 35);
                        end;
                    end;
                end;
            else
                CSA = getConnectedCSA(GenAgr);
                if(CSA != null)
                    if( GenAgr.Side2 == 2 )
                        if ( CSA.rec.counterparty_agr_code == "" )
                            if ( CSA.rec.tr_agr_code == "" )
                                ir_generalinf.rec.OriginatingID_Party2 = "NONREF";
                            else
                                stat = 1;
                                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "В ген. соглашении не задан номер CSA, присвоенный контрагентом", "OriginatingID_Party2", GetReportAction(DataSet.TemplNum), 200 + 35);
                            end;
                        else
                            ir_generalinf.rec.OriginatingID_Party2 = CSA.rec.counterparty_agr_code;
                        end;
                    else
                        ir_generalinf.rec.OriginatingID_Party2 = CSA.rec.Bank_agr_code;
                    end;
                else
                    ir_generalinf.rec.OriginatingID_Party2 = "";
                end;
            end;
        else
            ir_generalinf.rec.OriginatingID_Party2 = "";
        end;
    end;
    return stat;
end;

macro ОшибкаParty2(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, DealParmForReport)
    var stat=0;
    var err=false;
    var isPrime = (ir_generalinf.rec.CorrectRegisteredInfo!=SET_CHAR) and (ir_generalinf.rec.Amendment!=SET_CHAR) and (ir_generalinf.rec.IsCorrection!=SET_CHAR); // первичное
    if(((error=="Не задан код договора, присвоенный контрагентом") and (field=="TradeId_Party2")) or
        ((error=="Не задан номер договора, присвоенный Банком") and (field=="TradeId_Party2")) or
        ((error=="В ген. соглашении не задан номер CSA, присвоенный контрагентом") and (field=="OriginatingID_Party2")) or 
        ((error=="Не задан код договора, присвоенный контрагентом") and (field=="TradeId_Party2")) or
        ((error=="Не задан код первичного отчета, присвоенный контрагентом") and (field=="ReportId_Party2")))
        err=true;
    end;            

    if(first or err)
        ir_generalinf.rec.TradeId_Party2 = "";  // обнуляем
        if( (ir_generalinf.rec.Bulk == SET_CHAR) and (not (DataSet.rec.GenagrID > 0 ) ) )   // 2. если сводное сообщение и нет ГС, то NONREF, иначе берем как для несводного
            ir_generalinf.rec.TradeId_Party2 = "NONREF";
        elif(ir_generalinf.rec.MessageType != "CM002")    // 1., 4.  не сводные и не CM002
            // 4. В СМ092, СМ093, СМ094
            if((ir_generalinf.rec.MessageType == "CM092") or (ir_generalinf.rec.MessageType == "CM093") or (ir_generalinf.rec.MessageType == "CM094"))  
                if( GenAgr.Side2 == 2 ) // Если "Сторона 2" = "Контрагент"
                    if(isPrime) // первичное
                        ir_generalinf.rec.TradeId_Party2 = "NONREF";
                    else  // не первичное
                        if(ir_generalinf.rec.CounterParty_ReportID == "")
                            stat = 1;
                            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код первичного отчета, присвоенный контрагентом", "ReportId_Party2", GetReportAction(DataSet.TemplNum), 200 + 34);
                        else
                            ir_generalinf.rec.TradeId_Party2 = ir_generalinf.rec.CounterParty_ReportID;
                        end;
                    end;
                else // Если "Сторона 2" = "Наш банк"
                    if(isPrime and (ir_generalinf.rec.MessageType != "CM093")) // первичное
                        var objType = OBJTYPE_GENERALINF_CM094;
                        var newID = 0;
                        if (ir_generalinf.rec.MessageType == "CM092") 
                            objType = OBJTYPE_GENERALINF_CM092;
                        end;
                        if(not DL_GenRefByTypeDoc(objType, newID))  // для CM092/CM094 генерируем уникальный код 
                            stat = 1;
                            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Ошибка при генерации кода СРС", "", GetReportAction(DataSet.TemplNum));
                        else
                            ir_generalinf.rec.TradeId_Party2 = ir_generalinf.rec.MessageType + "-" + newID;    // получаем номер сообщения из типа сообщения и уникального кода
                        end;
                    else      // не первичное
                        ir_generalinf.rec.TradeId_Party2 = SubStr(ir_generalinf.rec.MessageID, 1, Index(ir_generalinf.rec.MessageID, "-K")-1);   // = MessageID первичного => обрезаем '-Knn'
                        if(ir_generalinf.rec.TradeId_Party2 == "")
                            stat = 1;
                            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код первичного отчета, присвоенный Банком", "TradeId_Party2", GetReportAction(DataSet.TemplNum), 200 + 34);
                        end;
                    end;
                end;
            else    // CM001 - CM081
                if( GenAgr.Side2 == 2 ) // Если "Сторона 2" = "Контрагент"            
                    if(DataSet.Contract_Contr != "")
                        ir_generalinf.rec.TradeId_Party2 = DataSet.Contract_Contr;
                    elif(GenAgr.NumContr != "")
                        ir_generalinf.rec.TradeId_Party2 = GenAgr.NumContr;
                    else
                        if((DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL) or (DataSet.TemplNum == DLGR_TEMPL_MAKEDEALWTHREQUEST) or
                                  (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT) or (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACTWTHREQUEST))
                            ir_generalinf.rec.TradeId_Party2 = "NONREF";
                        else
                            stat = 1;
                            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код договора, присвоенный контрагентом", "TradeId_Party2", GetReportAction(DataSet.TemplNum), 200 + 34);
                        end;
                    end;
                else      // Если "Сторона 2" = "Наш банк"
                    if(DataSet.Contract == "")
                          RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан номер договора, присвоенный Банком", "TradeId_Party2", GetReportAction(DataSet.TemplNum), 200 + 34);
                          stat = 1;
                    else                    
                        ir_generalinf.rec.TradeId_Party2 = DataSet.Contract;
                    end;
                end;
            end;
            if(ir_generalinf.rec.Bulk == SET_CHAR)
                ir_generalinf.rec.OriginatingID_Party2 = "";
            else
                stat= stat + ОшибкаOriginatingID_Party2(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
            end;
        end;      // 3. для CM002 не заполняется
    end;
    
    return stat;
end;

macro ОшибкаBrokerID(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, FD, DealParmForReport)
    var stat=0;
    var err=false;
    if(DataSet.TemplNum == DLGR_TEMPL_REVALUATION_FAIRVALUE)
        return stat;
    end;

    if((error=="Не задан LEI код брокера") and
        (field=="BrokerID"))
        err=true;
    end;
    
    if(first or err)
        if( (ir_generalinf.rec.Bulk != SET_CHAR) and (not GAmsg) )
            var BrokerID = -1;
            if( DataSet.DocKind == DL_SECURITYDOC )
                BrokerID = FD.tick.rec.BrokerID;
            elif ( DataSet.DocKind = DL_DVNDEAL )
                BrokerID = FD.Deal.rec.Agent;
            end;
            if( BrokerID > 0 )
                ir_generalinf.rec.BrokerID = ПолучитьКодСубъекта(BrokerID, PTCK_LEI);
                if( ir_generalinf.rec.BrokerID != "" )
                    ir_generalinf.rec.BrokerID = "LEI_" + ir_generalinf.rec.BrokerID;
                else
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан LEI код брокера", "BrokerID", GetReportAction(DataSet.TemplNum), 300 + 0);
                end;
            end;
        else
            ir_generalinf.rec.BrokerID = "";
        end;
    end;
    return stat;
end;

PRIVATE MACRO СвязанныйКлиентКонтрагента( FD )
    var PartyBuf = TRecHandler("party.dbt");
    var ObjectType = 0;
    var ObjectID = 0;
    
    if( FD.Kind == DL_SECURITYDOC )
        ObjectType = OBJTYPE_SECDEAL;
        ObjectID = UniID(FD.tick, ObjectType);
    elif( FD.Kind == DL_DVFXDEAL )
        ObjectType = OBJTYPE_FXOPER_DV;
        ObjectID = UniID(FD.Deal, ObjectType);
    elif( (FD.Kind == DL_DVNDEAL) or (FD.Kind == DL_DVDEALT3) )
        ObjectType = OBJTYPE_OUTOPER_DV;
        ObjectID = UniID(FD.Deal, ObjectType);
    end;
        
    if( ObjectID > 0 )
        var Query = RSDCommand( " Select t_AttrID " +
        "   From dobjlink_dbt " +
        "  Where t_ObjectType = ? " +
        "and t_ObjectID   = ? " +
        "and t_AttrType   = ? " +
        "and t_GroupID= ? " );
        
        Query.addParam( "", RSDBP_IN, ObjectType );
        Query.addParam( "", RSDBP_IN, ObjectID );
        Query.addParam( "", RSDBP_IN, OBJTYPE_PARTY );
        Query.addParam( "", RSDBP_IN, OBJROLE_DEAL_CLIENTCONTR );
        Query.execute();
        
        var DataSet = TRsbDataSet(Query);
        if( DataSet.MoveNext() )
            RestoreFromUniID(DataSet.AttrID, PartyBuf, OBJTYPE_PARTY );
            if( PartyBuf.rec.PartyID > 0 )
                ПолучитьСубъекта(PartyBuf.rec.PartyID, PartyBuf);
            end;
        end;
    end;
    
    return PartyBuf;
END;

PRIVATE MACRO IsOurBankClient(PartyID: INTEGER)
  var Sql, SqlSet;
  var RetVal = false;

  Sql = RSDCommand("SELECT t_partyid FROM dclient_dbt WHERE t_partyid = ?");
  Sql.addParam("", RSDBP_IN, PartyID);
  Sql.execute();
  SqlSet = TRsbDataSet(Sql);
  if( SqlSet.movenext() )
    RetVal = true;
  end;

  return RetVal;
END;

macro ОшибкаNoInf1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, KindDealPartyClient, DealParmForReport)
    var stat=0;
    var err=false;
    if(field=="NoInf1")
        err=true;
    end;
    if(first or err)
        if( GenAgr.Side2 == 2 ) // Контрагент
            if( KindDealPartyClient == -1 ) // Не задан
                ir_generalinf.rec.NoInf1 = SET_CHAR;
            else
                ir_generalinf.rec.NoInf1 = UNSET_CHAR;
            end;
        else
            ir_generalinf.rec.NoInf1 = UNSET_CHAR;
        end;
    end;
    ir_generalinf.rec.NoInf1 = UNSET_CHAR; //DAN    
    return stat;
end;

macro ОшибкаOwnTrade1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, IsPartyClient, KindDealPartyClient,
                      КлиентКонтрагента)
    var stat = 0;
    var err = false;
    if (first or err)        
        if ( GenAgr.Side1 == 2 ) // Контрагент
            if ( KindDealPartyClient == 1 ) // Сделка клиента контрагента = Нет
                ir_GeneralInf.rec.OwnTrade1 = SET_CHAR;
            elif ( KindDealPartyClient == 0 ) // Сделка клиента контрагента = Да
                ir_GeneralInf.rec.OwnTrade1 = UNSET_CHAR;
            else
                ir_GeneralInf.rec.OwnTrade1 = UNSET_CHAR;
            end;
        elif ( GenAgr.Side1 == 1 ) // Банк
            if( IsOurBankClient( SQL_ConvTypeInteger(DataSet.Client) ) == true )
                ir_GeneralInf.rec.OwnTrade1 = UNSET_CHAR;
            else 
                ir_GeneralInf.rec.OwnTrade1 = SET_CHAR;
            end;
        else
            ir_GeneralInf.rec.OwnTrade1 = UNSET_CHAR;
        end;
    end;
    ir_GeneralInf.rec.OwnTrade1 = SET_CHAR; //DAN
    return stat;
end;

macro ОшибкаClientType1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat = 0;
    var err = false;
    if((error == "Не найден клиент") and
        (field == "ClientIdent1ID"))
        err = true;
    end;
    if(first or err)
        ir_generalinf.rec.ClientType1 = GetClientType1(iParty);
    end;
    return stat;
end;

PRIVATE MACRO ПолучитьClientIdentКонтрагент( iParty, DataSet, GenAgr, ir_generalinf, Part:integer, DealParmForReport ):integer
    var stat = 0;
    var ClientIdent:string = "";
    var Field = IIF(Part == 2, "ClientIdent2", "ClientIdent1");
    var FieldNum = IIF(Part == 2, 300 + 38, 300 + 37);

    if( iParty.rec.NotResident == UNSET_CHAR )
        if( iParty.rec.LegalForm == PTLEGF_INST )
            ClientIdent = ПолучитьКодСубъекта(iParty.rec.PartyID, PTCK_LEI);
            if( ClientIdent == "" )
                ClientIdent = ПолучитьКодСубъекта(iParty.rec.PartyID, PTCK_INN);
                if( ClientIdent == "" )
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента контрагента - резидента/юр. лица не заданы ни код LEI, ни ИНН", Field, GetReportAction(DataSet.TemplNum), FieldNum);
                else
                    ClientIdent = "INN_" + ClientIdent;
                end;
            else
                ClientIdent = "LEI_" + ClientIdent;
            end;
        else
            ClientIdent = GetPaperNumber(iParty.rec.PartyID);
            if( ClientIdent == "" )
                ClientIdent = ПолучитьКодСубъекта(iParty.rec.PartyID, PTCK_SNILS);
                if( ClientIdent == "" )
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента контрагента - резидента/физ. лица не заданы ни номер паспорта, ни СНИЛС", Field, GetReportAction(DataSet.TemplNum), FieldNum);
                else
                    ClientIdent = "SNILS_" + ClientIdent;
                end;
            else
                ClientIdent = "PASS_" + ClientIdent;
            end;
        end;
    else
        ClientIdent = ПолучитьКодСубъекта(iParty.rec.PartyID, PTCK_LEI);
        if( ClientIdent == "" )
            ClientIdent = ПолучитьКодСубъекта(iParty.rec.PartyID, PTCK_SWIFT);
            if( ClientIdent == "" )
                ClientIdent = ПолучитьКодСубъекта(iParty.rec.PartyID, PTCK_CONTR);
                if( ClientIdent == "" )
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента контрагента - нерезидента не задан ни один код", Field, GetReportAction(DataSet.TemplNum), FieldNum);
                else
                    ClientIdent = "OWN_" + ClientIdent;
                end;
            else
                ClientIdent = "SWIFT_" + ClientIdent;
            end;
        else
            ClientIdent = "LEI_" + ClientIdent;
        end;
    end;
                
    if( Part == 2 )
        ir_generalinf.rec.ClientIdent2 = ClientIdent;
    else
        ir_generalinf.rec.ClientIdent1 = ClientIdent;
    end;
    
    return stat;
END;

macro ОшибкаClientIdent1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat=0;
    var err=false;
    if((field=="ClientIdent2") or (field=="ClientIdent1"))
        err=true;
    end;
    if(first or err)
        ir_generalinf.rec.ClientIdent1ID = iParty.rec.PartyID;
        if( GenAgr.Side1 == 2 ) // Контрагент
            stat = ПолучитьClientIdentКонтрагент(iParty, DataSet, GenAgr, ir_generalinf, 1, DealParmForReport);
        else
            stat = ПолучитьClientIdentБанк(iParty, DataSet, GenAgr, ir_generalinf, 1, NULL, DealParmForReport);
        end;
    end;
    return stat;
end;

macro ОшибкаClientName1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat=0;
    var err=false;
    if(field=="ClientName1")
        err=true;
    end;
    if(first or err)
        ir_generalinf.rec.ClientName1 = GetClientName(iParty);
        if( ir_generalinf.rec.ClientName1 == "" )
            stat = 1;
            if( iParty.rec.LegalForm == PTLEGF_PERSN )
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента " + IIF(GenAgr.Side1 == 1, "банка", "контрагента") + " физ. лица не заданы Ф.И.О.", "ClientName1", GetReportAction(DataSet.TemplNum), 300 + 35);
            else
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента " + IIF(GenAgr.Side1 == 1, "банка", "контрагента") + " юр. лица не задано сокр. наименование", "ClientName1", GetReportAction(DataSet.TemplNum), 300 + 35);
            end;
        end;
    end;
    return stat;
end;

macro ОшибкаClientCountry1(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat=0;
    var err=false;
    if((ir_generalinf.rec.ClientCountry1 == "") and
        (field=="ClientCountry1"))
        err=true;
    end;
    if(first or err)
        var Country = GetCountry(iParty);
        if( Country != "" )
            ir_generalinf.rec.ClientCountry1 = DL_GetCountryByCodeLat3(Country).CodeLat2;
        end;
        if( ir_generalinf.rec.ClientCountry1 == "" )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента " + IIF(GenAgr.Side1 == 1, "банка", "контрагента") + " не задана страна", "ClientCountry1", GetReportAction(DataSet.TemplNum), 300 + 39);
        end;
    end;
    return stat;
end;

macro ОшибкаNoInf2(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, KindDealPartyClient, DealParmForReport)
    var stat=0;
    var err=false;
    if(field=="NoInf2")
        err=true;
    end;
    if(first or err)
        if( GenAgr.Side2 == 2 ) // Контрагент
            if( KindDealPartyClient == -1 ) // Не задан
                ir_generalinf.rec.NoInf2 = SET_CHAR;
            else
                ir_generalinf.rec.NoInf2 = UNSET_CHAR;
            end;
        else
            ir_generalinf.rec.NoInf2 = UNSET_CHAR;
        end;
    end;
    ir_generalinf.rec.NoInf2 = UNSET_CHAR;//DAN    
    return stat;
end;

macro ОшибкаOwnTrade2(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, IsPartyClient, KindDealPartyClient, КлиентКонтрагента)
    var stat=0;
    var err=false;
    if(first or err)
        if ( GenAgr.Side2 == 2 ) // Контрагент
            if ( KindDealPartyClient == 1 ) // Сделка клиента контрагента = Нет
                ir_GeneralInf.rec.OwnTrade2 = SET_CHAR;
            elif ( KindDealPartyClient == 0 ) // Сделка клиента контрагента = Да
                ir_GeneralInf.rec.OwnTrade2 = UNSET_CHAR;
            else
                ir_GeneralInf.rec.OwnTrade2 = UNSET_CHAR;
                end;
        elif ( GenAgr.Side2 == 1 ) // Банк
            if( IsOurBankClient( SQL_ConvTypeInteger(DataSet.Client) ) == true )
                ir_GeneralInf.rec.OwnTrade2 = UNSET_CHAR;
            else 
                ir_GeneralInf.rec.OwnTrade2 = SET_CHAR;
            end;
        else
            ir_GeneralInf.rec.OwnTrade2 = UNSET_CHAR;
        end;
    end;
    ir_GeneralInf.rec.OwnTrade2 = SET_CHAR;//DAN
    return stat;
end;  

macro ClientType2 (ir_generalinf:@TRecHandler,DataSet, GenAgr,first:bool,iParty)
    if(first)
            if( iParty.rec.LegalForm == PTLEGF_PERSN )
                ir_generalinf.rec.ClientType2 = "P";
            else
                if( ВидСубъекта(iParty.rec.PartyID, PTK_PROFSECURPARTY) or ВидСубъекта(iParty.rec.PartyID, PTK_BANK) or ВидСубъекта(iParty.rec.PartyID, PTK_INSURANCE) or ВидСубъекта(iParty.rec.PartyID, PTK_CURFONDMARKETSPRT) )
                    ir_generalinf.rec.ClientType2 = "F";
                else
                    ir_generalinf.rec.ClientType2 = "L";
                end;
            end;
    end;
end;

macro ОшибкаClientIdent2(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat=0;
    var err=false;
    if((field=="ClientIdent2") or (field=="ClientIdent1"))
        err=true;
    end;
    if(first or err)
        ir_generalinf.rec.ClientIdent2ID = iParty.rec.PartyID;
        if( GenAgr.Side2 == 2 ) // Контрагент
            stat = ПолучитьClientIdentКонтрагент(iParty, DataSet, GenAgr, ir_generalinf, 2, DealParmForReport);
        else
            stat = ПолучитьClientIdentБанк(iParty, DataSet, GenAgr, ir_generalinf, 2, NULL, DealParmForReport);
        end;
    end;
    return stat;
end;

macro ОшибкаClientName2(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat=0;
    var err=false;
    if (field=="ClientName2")
        err=true;
    end;
    if(first or err)
        ir_generalinf.rec.ClientName2 = GetClientName(iParty);
        if( ir_generalinf.rec.ClientName2 == "" )
            stat = 1;
            if( iParty.rec.LegalForm == PTLEGF_PERSN )
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента " + IIF(GenAgr.Side2 == 1, "банка", "контрагента") + " физ. лица не заданы Ф.И.О.", "ClientName2", GetReportAction(DataSet.TemplNum), 300 + 36);
            else
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента " + IIF(GenAgr.Side2 == 1, "банка", "контрагента") + " юр. лица не задано сокр. наименование", "ClientName2", GetReportAction(DataSet.TemplNum), 300 + 36);
            end;
        end;
    end;
    return stat;
end;

macro ОшибкаClientCountry2(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat=0;
    var err=false;
    if(((error=="Для клиента \"банка\" не задана страна")or
        (error=="Для клиента \"контрагента\" не задана страна"))and
        (field=="ClientCountry1"))
        err=true;
    end;
    if(first or err)
        var Country = GetCountry(iParty);
        if( Country != "" )
            ir_generalinf.rec.ClientCountry2 = DL_GetCountryByCodeLat3(Country).CodeLat2;
        end;
        if( ir_generalinf.rec.ClientCountry2 == "" )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для клиента " + IIF(GenAgr.Side2 == 2, "банка", "контрагента") + " не задана страна", "ClientCountry2", GetReportAction(DataSet.TemplNum), 300 + 40);
        end;
    end;
    return stat;
end;

macro ОшибкаClientIdent2ID(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, iParty, DealParmForReport)
    var stat = 0;
    var err = false;
   /* if ((field == "ClientIdent2") or
       ((field == "ClientIdent2") or (field == "ClientIdent1")) or
       (((error == "Для клиента \"банка\" не задана страна") or
       (error == "Для клиента \"контрагента\" не задана страна"))) and
       (field == "ClientCountry1") or
       (field == "ClientName2"))*/
   if (((field == "ClientIdent2") or (field == "ClientIdent1")) 
        or (((error == "Для клиента \"банка\" не задана страна") or (error == "Для клиента \"контрагента\" не задана страна")) and
              (field == "ClientCountry1")) 
        or (field == "ClientName2")
        or ((field == "clientDetails") 
            and ((error == "В сделке, выполненной в интересах клиента, не задан клиент")
               or (error == "В сделке, выполненной в интересах клиента, не задан клиент контрагента")))
      )
        err=true;
    end;
    
    if(first or err)        
        if((ir_generalinf.rec.NoInf2 != SET_CHAR) and (ir_generalinf.rec.OwnTrade2 != SET_CHAR))
            if( iParty.rec.PartyID <= 0 )
                var StrError = "";
              //  if( GenAgr.Side1 == 2 )
               if( GenAgr.Side1 == 1 )   
                    StrError = "В сделке, выполненной в интересах клиента, не задан клиент контрагента";
                    //ir_generalinf.rec.NoInf2 = SET_CHAR;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 33);
                else
                    StrError = "В сделке, выполненной в интересах клиента, не задан клиент";
             //   end;
                stat = stat + 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, StrError, "clientDetails", GetReportAction(DataSet.TemplNum), 300 + 33);
               end; 
// последующие 4 сообщения не будут выведены в отчете, только будут подсвечены поля в форме
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 36);
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 38);
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 40);
            else
                ClientType2(ir_generalinf, DataSet, GenAgr, true, iParty);
            stat = ОшибкаClientIdent2(ir_generalinf, DataSet, GenAgr, true, error, field, iParty, DealParmForReport);
            stat = stat + ОшибкаClientCountry2(ir_generalinf, DataSet, GenAgr, true, error, field, iParty, DealParmForReport);
            stat = stat + ОшибкаClientName2(ir_generalinf, DataSet, GenAgr, true, error, field, iParty, DealParmForReport);
        end;
    end;
    end;
    return stat;
end;

macro ОшибкаMarginTypeCode(ir_generalinf:@TRecHandler, DataSet, GenAgr, first:bool, error, field, FD, DealParmForReport)
    var stat=0;
    var err=false;
    
    if(DataSet.TemplNum == DLGR_TEMPL_REVALUATION_FAIRVALUE)
        return stat;
    end;

    if(((error=="Не задан тип обеспечения по договору") and
        (field=="marginType")) or
        ((error=="Не задана форма обеспечения") and
        (field=="collateralForm")))
        err=true;
    end;
    
    if(first)
        if( ir_generalinf.rec.Bulk != SET_CHAR )
            ir_generalinf.rec.ProductTypeID = DataSet.TYPEPRODUCT;
            ir_generalinf.rec.ProductType = GetProductType(DataSet.TYPEPRODUCT);
            ir_generalinf.rec.ProductCode = DataSet.CodeClassPFI;
            ir_generalinf.rec.ObligationStatus = "";
            ir_generalinf.rec.SpotLegSeyttlDate= date(0,0,0);
            ir_generalinf.rec.ForwardLegSeyttlDate = date(0,0,0);
            ir_generalinf.rec.MarginType   = IIF(GAmsg, 0, DataSet.TYPESECUR);
            ir_generalinf.rec.MarginTypeCode   = DL_GetValueName(4019 /* типы обеспечения */, ir_generalinf.rec.MarginType);
            ir_generalinf.rec.ColaterallForm   = IIF(GAmsg, 0, DataSet.FORMSECUR);
            ir_generalinf.rec.ColaterallFormCode   = DL_GetValueName(4020 /* типы обеспечения */, ir_generalinf.rec.ColaterallForm);
        else
            ir_generalinf.rec.ProductTypeID = 0;
            ir_generalinf.rec.ProductType = "Other";
            ir_generalinf.rec.ProductCode = "UKWN";
            
            if( DataSet.DocKind == DL_SECURITYDOC )
                ir_generalinf.rec.ObligationStatus = IIF(FD.GetRQ(DLRQ_TYPE_PAYMENT, 2).rec.Netting == SET_CHAR, "SO", "T");
                ir_generalinf.rec.SpotLegSeyttlDate= FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FactDate;
                ir_generalinf.rec.ForwardLegSeyttlDate = FD.GetRQ(DLRQ_TYPE_PAYMENT, 2).rec.FactDate;
            else
                ir_generalinf.rec.ObligationStatus = "T";
                ir_generalinf.rec.SpotLegSeyttlDate= FD.nFI_BaseActiv.rec.PayDate;
                ir_generalinf.rec.ForwardLegSeyttlDate = FD.nFI_BAOther.rec.PayDate;
            end;
            
            ir_generalinf.rec.MarginType = 4; // "U"
            ir_generalinf.rec.MarginTypeCode = DL_GetValueName(4019 /* типы обеспечения */, 4, "");
            ir_generalinf.rec.ColaterallForm = 3; // "U"
            ir_generalinf.rec.ColaterallFormCode = DL_GetValueName(4020 /* типы обеспечения */, 3, "");
        end;
    elif (err)
        if( ir_generalinf.rec.Bulk != SET_CHAR )
            ir_generalinf.rec.MarginTypeCode   = DL_GetValueName(4019 /* типы обеспечения */, ir_generalinf.rec.MarginType);
            ir_generalinf.rec.ColaterallFormCode   = DL_GetValueName(4020 /* типы обеспечения */, ir_generalinf.rec.ColaterallForm);
        else
            ir_generalinf.rec.MarginTypeCode = DL_GetValueName(4019 /* типы обеспечения */, 4, "");
            ir_generalinf.rec.ColaterallFormCode = DL_GetValueName(4020 /* типы обеспечения */, 3, "");
        end;
    end;
    
    if(first or err)
        if( (not GAmsg) and (SQL_ConvTypeStr(ir_generalinf.rec.MarginTypeCode) == "") )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан тип обеспечения по договору", "marginType", GetReportAction(DataSet.TemplNum), 200 + 43);
        end;
        
        if( (not GAmsg) and (SQL_ConvTypeStr(ir_generalinf.rec.ColaterallFormCode) == "") )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задана форма обеспечения", "collateralForm", GetReportAction(DataSet.TemplNum), 200 + 45);
        end;
    end;
    
    return stat;
end;

macro ОшибкаTraidID_UTI(ir_generalinf:@TRecHandler, DataSet, GenAgr,first:bool,error,field, DealParmForReport)
    var stat = 0;
    var err = false;
    if( DataSet.TemplNum == DLGR_TEMPL_REVALUATION_FAIRVALUE )
        return stat;
    end;
    if ((field=="TradeId_UTIGeneratingParty") and (error=="Не задан код UTI")and
        (ir_generalinf.rec.TradeId_UTIGeneratingParty =="")    )
        err = true;
    end;
    if (first or err)
        if( (ir_generalinf.rec.Bulk != SET_CHAR) and (ir_generalinf.rec.TradeId_UTIGeneratingParty == ""))
            ir_generalinf.rec.TradeId_UTIGeneratingParty  = DataSet.UTI_CONTRACT;
            if(ir_generalinf.rec.TradeId_UTIGeneratingParty == "")
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код UTI", "TradeId_UTIGeneratingParty", GetReportAction(DataSet.TemplNum), 200 + 42);
            end;
        else
            ir_generalinf.rec.TradeId_UTIGeneratingParty  = "";
        end;
    end;
    return stat;
end;

macro ОшибкаДопСоглашения(ir_generalinf:@TRecHandler, DataSet, GenAgr,first:bool,error,field, ir_op, DealParmForReport)
    var stat = 0;
    var err = false;
    if (((field=="AsOfDate") or (field=="AgreementDate") or (field=="EffectiveDate")) and (error=="Не заданы реквизиты доп. соглашения"))
        err = true;
    end;

    if (first or err)
      if( ir_generalinf.rec.Bulk != SET_CHAR )
        if((DataSet.TemplNum == DLGR_TEMPL_CHANGEMSG) or (DataSet.TemplNum == DLGR_TEMPL_CHANGEMSGWTHREQUEST))
          ir_generalinf.rec.AsOfDate = GetAsOfDate(DataSet.DocKind, DataSet.DocID, DataSet.TemplNum, ir_op.rec.Date);
          ir_generalinf.rec.AgreementDate = ir_generalinf.rec.AsOfDate;
          ir_generalinf.rec.EffectiveDate = DataSet.PlanDate;
          if(ir_generalinf.rec.AsOfDate == date(0,0,0))
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не заданы реквизиты доп. соглашения", "AsOfDate", GetReportAction(DataSet.TemplNum), 200 + 5);
          elif((ir_generalinf.rec.AgreementDate == date(0,0,0)) and (substr(ir_generalinf.rec.MessageID, 1, 5) != "CM001"))
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не заданы реквизиты доп. соглашения", "AgreementDate", GetReportAction(DataSet.TemplNum), 200 + 2);
          elif((ir_generalinf.rec.EffectiveDate == date(0,0,0)) and (substr(ir_generalinf.rec.MessageID, 1, 5) != "CM001"))
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не заданы реквизиты доп. соглашения", "EffectiveDate", GetReportAction(DataSet.TemplNum), 200 + 3);
          end;
        elif(DataSet.TemplNum == DLGR_TEMPL_REVALUATION_FAIRVALUE)
            var SendMessageFRVL;
            if(ir_op.rec.Setting_Date_Select_FR == IR_SENDING_BILL_MESSAGESFR_EVENT_DATE or (ir_op.rec.Setting_Date_Select_FR == IR_SENDING_BILL_MESSAGESFR_LAST_DAT_MONTH_LST_REV)) //1-при каждой переоценке
                ir_generalinf.rec.AsOfDate = DataSet.PlanDate;
            elif(ir_op.rec.Setting_Date_Select_FR == IR_SENDING_BILL_MESSAGESFR_LAST_DAT_MONTH) //2-по окончании месяца
                ir_generalinf.rec.AsOfDate = GetLastWorkDayInMonth(DataSet.PlanDate);
            end;
            ir_generalinf.rec.AgreementDate = date(0,0,0);
            ir_generalinf.rec.EffectiveDate = date(0,0,0);
        elif(DataSet.TemplNum == DLGR_TEMPL_CSA_MARGIN_PAYMENT)
            ir_generalinf.rec.AsOfDate = DataSet.PlanDate;
        elif((DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL_CORRECTION) or (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT_CORRECTION))
            ir_generalinf.rec.AsOfDate = Date();  // Текущая системная дата
            ir_generalinf.rec.AgreementDate = date(0,0,0);
            ir_generalinf.rec.EffectiveDate = date(0,0,0);
        elif(ir_generalinf.rec.MessageType == "CM011")
            ir_generalinf.rec.AsOfDate = DataSet.Date_End;  // Дата закрытия договра
            ir_generalinf.rec.AgreementDate = date(0,0,0);
            ir_generalinf.rec.EffectiveDate = date(0,0,0);
        else
          ir_generalinf.rec.AsOfDate = DataSet.DealDate;  // дата сделки, она же дата договора
          ir_generalinf.rec.AgreementDate = date(0,0,0);
          ir_generalinf.rec.EffectiveDate = date(0,0,0);
        end;
      else
        ir_generalinf.rec.AsOfDate = DataSet.DealDate/*дате сделки*/;
        ir_generalinf.rec.AgreementDate = date(0,0,0);
        ir_generalinf.rec.EffectiveDate = date(0,0,0);
      end;
    end;
    return stat;
end;

macro SetTypeCorrect(ir_generalinf:@TRecHandler, DataSet)
    ir_generalinf.rec.IsCorrection = UNSET_CHAR;
    ir_generalinf.rec.CorrectRegisteredInfo = UNSET_CHAR;
   
    var cmd = DL_RSDCommand();
    var query = " select geninf.t_statuscode, geninf.t_RegistrationDate, geninf.t_RejectDate, geninf.t_CreationDate "
            + " from dir_grdoc_dbt ir_grdoc, dir_generalinf_dbt geninf "
            + " where ir_grdoc.t_ServDocKind = " + REPOS_MESSAGEGENERATION
            + " and ir_grdoc.t_DealKind = " + DataSet.DocKind
            + " and ir_grdoc.t_DealID =  " + DataSet.DocID
            + " and ir_grdoc.t_DocKind = " + REPOS_GENERALINF
            + " and geninf.t_internalmessageid = ir_grdoc.t_DocId ";
    var data = cmd.Execute(query);
    if(data.MoveNext())
        if((data.statuscode != "REGISTERED") and (data.statuscode != "RJCT"))
            ir_generalinf.rec.IsCorrection = SET_CHAR;
        elif(data.statuscode == "REGISTERED")
            ir_generalinf.rec.CorrectRegisteredInfo = SET_CHAR;
        elif(data.statuscode == "RJCT")
            ir_generalinf.rec.IsCorrection = SET_CHAR;
        end;
    end;

    return 0;
end;

MACRO ЗаполнениеGenInf(ir_generalinf : @TRecHandler, DataSet, messageSendingMode, GenAgr, first, error, field, forceTemplate, DealParmForReport, ir_op, FD, 
                       MaxDateTO, KindDealPartyClient, IsPartyClient, firstInGroup, err:@variant)
  var iParty = TRecHandler("party");
  var stat = 0;
  // заменяющее, корректирующее, изменение условий 
  if((DataSet.TemplNum == DLGR_TEMPL_CHANGEMSG) OR (DataSet.TemplNum == DLGR_TEMPL_CHANGEMSGWTHREQUEST) OR 
     (DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL_CORRECTION) OR (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT_CORRECTION))
     // копируем исходное сообщение в новое 
      var getSrcMsgCmd = DL_RSDCommand("SELECT * FROM dir_generalinf_dbt dir WHERE T_MessageType='"+ DataSet.MessageCode +
         "' AND T_DealCode='" + DataSet.DealCode + "'");
      var getSrcMsg = getSrcMsgCmd.Execute();
      if (getSrcMsg.MoveNext())
        getSrcMsg.GetRecord().CopyTo(ir_generalinf.rec);
      end;
  end;
  ir_generalinf.rec.StatusCode  = "";
  ir_generalinf.rec.DealCode    = DataSet.DealCode;
  ir_generalinf.rec.PrDate      = Date();
  ir_generalinf.rec.PrTime      = time();
  ir_generalinf.rec.MessageType = DataSet.messagecode;
  ir_generalinf.rec.XMLProduct  = DataSet.XMLProduct;
  ir_generalinf.rec.XMLType     = DataSet.XMLType;
  ir_generalinf.rec.Bulk        = IIF(DataSet.TemplNum == DLGR_TEMPL_BULKREPORT, SET_CHAR, UNSET_CHAR);
  if( (not (DataSet.TemplNum < DLGR_TEMPL_CLOSECONTR)) AND 
      (not (DataSet.TemplNum > DLGR_TEMPL_NETTINGSUSPWTHREQUEST)) AND
      (not GAmsg) )
    ir_generalinf.rec.MessageType = "CM093";
  end;

  if(DataSet.TemplNum == DLGR_TEMPL_REVALUATION_FAIRVALUE)
    ir_generalinf.rec.MessageType = "CM094";
    if(messageSendingMode)
      if ((DataSet.StatusContract != "REGISTERED") and (DataSet.StatusContract != "AMENDING") and (1!=1))
        stat = stat + 1;
        var ErrorStr = "Подготовка сообщения СМ094 по сделке " + DataSet.DealCode + " не может быть выполнена, т.к. ее состояние в Репозитарии - " + DataSet.StatusContract;
        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, ErrorStr, "", GetReportAction(DataSet.TemplNum));
        err = 1;
        return 1;
      end;
    end;
  end;

  if( ir_generalinf.rec.Bulk != SET_CHAR )
    ir_generalinf.rec.Amendment = IIF((DataSet.TemplNum == DLGR_TEMPL_CHANGEMSG) OR (DataSet.TemplNum == DLGR_TEMPL_CHANGEMSGWTHREQUEST), SET_CHAR, UNSET_CHAR);
  else
    ir_generalinf.rec.Amendment = UNSET_CHAR;
  end;

  if(firstInGroup)
    stat = stat + ОшибкаГенерации(ir_generalinf, DataSet, GenAgr, first, error, field, ValType(forceTemplate) == V_INTEGER, DealParmForReport);
  end;
  stat = stat + ОшибкаSendBy(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  stat = stat + ОшибкаSendTo(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  
  ir_generalinf.rec.CreationDate   = date(0,0,0);
  ir_generalinf.rec.CreationTime   = time(0,0,0);
  ir_generalinf.rec.Version= "4.4";

  if( ir_generalinf.rec.Bulk != SET_CHAR )
    if((DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL_CORRECTION) OR (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT_CORRECTION))
        SetTypeCorrect(ir_generalinf, DataSet);
    end;
  else
    ir_generalinf.rec.IsCorrection = UNSET_CHAR;
  end;

  stat = stat + ОшибкаParentCorrelationId(ir_generalinf,DataSet,GenAgr,first, error, field, ir_generalinf.rec.MessageType, DealParmForReport);
  stat = stat + ОшибкаLinkID(ir_generalinf,DataSet,GenAgr,first, error, field, ir_generalinf.rec.MessageType, DealParmForReport);

  if(ir_generalinf.rec.MessageType == "CM092")
    var CSA = GetCSA(DataSet.DocID);
    ir_generalinf.rec.DealCode = "";
    
    stat = stat + ОшибкаДопСоглашения(ir_generalinf, DataSet, GenAgr, first, error, field, ir_op, DealParmForReport);
    ir_generalinf.rec.PartyRefID_TradeRepository = IR_PARTY_KIND_TRADEREPOSITORY;
    ir_generalinf.rec.PartyRef_TradeRepository   = "TradeRepository";

    stat = stat + ОшибкаTradeId_TradeRepository(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);

    if( CSA.rec.tr_agr_code != "")
      ir_generalinf.rec.OriginID_TradeRepository = CSA.rec.tr_agr_code;
    else
      ir_generalinf.rec.OriginID_TradeRepository = "NONREF";
    end;

    ir_generalinf.rec.PartyRef_OriginID_TradeRep = "TradeRepository";
    ir_generalinf.rec.PartyRef_OriginID_Party1 = "Party1";
    ir_generalinf.rec.PartyRef_OriginID_Party2 = "Party2";
    
    ir_generalinf.rec.PartyRef_IDParty1  = IR_PARTY_KIND_PARTY1;
    ir_generalinf.rec.PartyRef_Party1= "Party1";

    stat = stat + ОшибкаParty1(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);

    ir_generalinf.rec.PartyRef_IDParty2  = IR_PARTY_KIND_PARTY2;
    ir_generalinf.rec.PartyRef_Party2= "Party2";
    stat = stat + ОшибкаParty2(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
    
    ir_generalinf.rec.PartyRef_IDSender = IR_PARTY_KIND_SENDER;
    ir_generalinf.rec.PartyRef_Sender   = "Sender";
    ir_generalinf.rec.ReportingRegime = "RussianFederation";
  
  elif( not ( ir_generalinf.rec.MessageType == "CM093" ) )
    ir_generalinf.rec.PartyRefID_TradeRepository = IR_PARTY_KIND_TRADEREPOSITORY;
    ir_generalinf.rec.PartyRef_TradeRepository   = "TradeRepository";

    if( ir_generalinf.rec.Bulk != SET_CHAR )
      if ( (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT) or
          (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACTWTHREQUEST) or
          (DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL) or
          (DataSet.TemplNum == DLGR_TEMPL_MAKEDEAL_CORRECTION) or 
          (DataSet.TemplNum == DLGR_TEMPL_MAKECONTRACT_CORRECTION) or
          (DataSet.TemplNum == DLGR_TEMPL_MAKEDEALWTHREQUEST) or
          (DataSet.TemplNum == DLGR_TEMPL_REVALUATION_FAIRVALUE)
      )
        ir_generalinf.rec.TradeId_TradeRepository = "NONREF";
      else
        if ((ir_generalinf.rec.MessageType == "CM011") or (ir_generalinf.rec.MessageType == "CM010"))
          ir_generalinf.rec.TradeId_TradeRepository = DataSet.DealCode;
        else
          ir_generalinf.rec.TradeId_TradeRepository = DataSet.CONTRACT_IR;
        end;
      end;
    else
      ir_generalinf.rec.TradeId_TradeRepository = "NONREF";
    end;

    stat = stat + ОшибкаTradeId_TradeRepository(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);

    if(DataSet.TemplNum != DLGR_TEMPL_REVALUATION_FAIRVALUE)
        ir_generalinf.rec.LinkID = GenAgr.NumRepoz;
    end;

    if ( (ir_generalinf.rec.Bulk != SET_CHAR) and (not GAmsg) and (DataSet.TemplNum != DLGR_TEMPL_REVALUATION_FAIRVALUE) )
        var ConnectedCsa = getConnectedCSA(GenAgr);
        if(ConnectedCsa != null)
          if(ConnectedCsa.rec.tr_agr_code == "")
            ir_generalinf.rec.OriginID_TradeRepository = "NONREF";
          else
            ir_generalinf.rec.OriginID_TradeRepository = ConnectedCsa.rec.tr_agr_code;
          end;
        end;
    else
        ir_generalinf.rec.OriginID_TradeRepository = "";
    end;

    ir_generalinf.rec.PartyRef_IDParty1  = IR_PARTY_KIND_PARTY1;
    ir_generalinf.rec.PartyRef_Party1= "Party1";

    stat = stat + ОшибкаParty1(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);

    ir_generalinf.rec.PartyRef_IDParty2  = IR_PARTY_KIND_PARTY2;
    ir_generalinf.rec.PartyRef_Party2= "Party2";

    stat = stat + ОшибкаParty2(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);

    if( (ir_generalinf.rec.Bulk == SET_CHAR) or GAmsg )
        ir_generalinf.rec.OriginatingID_Party2 = "";
    END;

    ir_generalinf.rec.PartyRef_IDSender = IR_PARTY_KIND_SENDER;
    ir_generalinf.rec.PartyRef_Sender   = "Sender";
    
    ir_generalinf.rec.PartyRef_IDUTIGenParty = IR_PARTY_KIND_UTIGENERATINGPARTY;
    
    if( ir_generalinf.rec.Bulk != SET_CHAR and (DataSet.TemplNum != DLGR_TEMPL_REVALUATION_FAIRVALUE) )
      ir_generalinf.rec.PartyRef_UTIGeneratingParty = "UTIGeneratingParty";
    else
      ir_generalinf.rec.PartyRef_UTIGeneratingParty = "";
    end;
    
    ir_generalinf.rec.PartyRef_IDTradeRepository2 = IR_PARTY_KIND_TRADEREPOSITORY;
    ir_generalinf.rec.PartyRef_TradeRepository2   = "TradeRepository";
    ir_generalinf.rec.ReportingRegime = "RussianFederation";
    
    if ( GAmsg )
        ir_generalinf.rec.NonStandardTerms = UNSET_CHAR;
    elif( ir_generalinf.rec.Bulk != SET_CHAR )
        ir_generalinf.rec.NonStandardTerms = IIF(DataSet.GenAgrID > 0, UNSET_CHAR, SET_CHAR);
    else
        ir_generalinf.rec.NonStandardTerms = SET_CHAR;
    end;
    
    if( DataSet.TemplNum != DLGR_TEMPL_REVALUATION_FAIRVALUE )
        ir_generalinf.rec.ExecutionVenueType  = "";
        ir_generalinf.rec.TradeDate   =  DataSet.DealDate;
        ir_generalinf.rec.Included = date(0,0,0);
        ir_generalinf.rec.Excluded = date(0,0,0);
    
        stat = stat + ОшибкаBrokerID(ir_generalinf, DataSet, GenAgr, first, error, field, FD, DealParmForReport);
    
        ir_generalinf.rec.Cleared   = UNSET_CHAR;
        ir_generalinf.rec.IDClearSettlementType = IIF(GAmsg, 0, 1/*OTC*/);
        ir_generalinf.rec.ClearSettlementType   = DL_GetValueName(OBJTYPE_CALCTYPE, ir_generalinf.rec.IDClearSettlementType);
        ir_generalinf.rec.ClearingOrgCode   = "";
        ir_generalinf.rec.ClearedDate   = date(0,0,0);
        ir_generalinf.rec.ClearingDate  = date(0,0,0);
        ir_generalinf.rec.ClearingTime  = time(0,0,0);
        ir_generalinf.rec.CentralCounterparty   = "";
        ir_generalinf.rec.ClearingMember= "";
    
        if( ir_generalinf.rec.Bulk != SET_CHAR )
            ir_generalinf.rec.IDReconType = IIF(GAmsg, 0, DataSet.TYPE_RECONCILIATION);
            ir_generalinf.rec.IDConfMethod   = DataSet.METHOD_WAYTWOWAY;
            if ( DataSet.DocKind == DL_SECURITYDOC )
                ir_generalinf.rec.IDClearSettlMethod = 1/*Р*/;
            elif ( GAmsg )
                ir_generalinf.rec.IDClearSettlMethod = 0;
            else
                ir_generalinf.rec.IDClearSettlMethod = IIF((FD.nFI_().rec.ExecType != 1)/*беспоставочный*/, 2/*С*/, 1/*Р*/);
            end;
        else
            ir_generalinf.rec.IDReconType  = 2; // "GENF"
            ir_generalinf.rec.IDClearSettlMethod = 2; // "С"
            ir_generalinf.rec.IDConfMethod   = 1; // "MXME"
        end;
    
        ir_generalinf.rec.ReconType = DL_GetValueName(OBJTYPE_REVISE_TYPE, ir_generalinf.rec.IDReconType);
        ir_generalinf.rec.ClearSettlMethod  = DL_GetValueName(OBJTYPE_CALCMETHOD, ir_generalinf.rec.IDClearSettlMethod);
        ir_generalinf.rec.ConfMethod= DL_GetValueName(OBJTYPE_METHOD_TWO_WAY, ir_generalinf.rec.IDConfMethod);
    
        if ( (ir_generalinf.rec.IDReconType == 0) and (not GAmsg) and (GenAgr.ContrNotReport != SET_CHAR) )
            stat = stat + 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "В ГС (ПГС) не задан параметр \"Условия согласования параметров сделки (договора)\"", "ReconType", GetReportAction(DataSet.TemplNum), 300 + 10);
        end;
    
        if( (ir_generalinf.rec.Bulk != SET_CHAR) and (not GAmsg) )
            if ( DataSet.DocKind == DL_SECURITYDOC )
                ir_generalinf.rec.AutomaticExecution = FD.tick.rec.AutoClose;
            elif ( GAmsg )
                ir_generalinf.rec.AutomaticExecution = UNSET_CHAR;
            else
                ir_generalinf.rec.AutomaticExecution = FD.Deal.rec.AutoClose;
            end;
            ir_generalinf.rec.AffParties = IIF(DataSet.GenagrID > 0, UNSET_CHAR, GenAgr.SignConnect);
            ir_generalinf.rec.TradeRegType  = DataSet.TYPEDEAL;
            ir_generalinf.rec.TradeRegTypeCode  = DL_GetValueName(4024 /* регул типы сделки */, DataSet.TYPEDEAL);
            ir_generalinf.rec.StartAgreementDate = DataSet.DATE_START;
            ir_generalinf.rec.EndAgreementDate  = DataSet.DATE_END;
            ir_generalinf.rec.SpecificCode  = "ProductRelation";
            ir_generalinf.rec.RelCode   = DL_GetValueName(OBJTYPE_INTERRELATION_CODE, DataSet.RelCodeID);
        else
            ir_generalinf.rec.AutomaticExecution = "";
            ir_generalinf.rec.AffParties = IIF(GAmsg and (ir_generalinf.rec.MessageType == "CM010"), GenAgr.SignConnect, UNSET_CHAR);
            ir_generalinf.rec.TradeRegType  = IIF(GAmsg, 0, 4); // "Repo"
            ir_generalinf.rec.TradeRegTypeCode  = DL_GetValueName(4024 /* регул типы сделки */, ir_generalinf.rec.TradeRegType);
            ir_generalinf.rec.StartAgreementDate = IIF(GAmsg, date(0,0,0), ir_generalinf.rec.TradeDate);
            ir_generalinf.rec.EndAgreementDate  = IIF(GAmsg, date(0,0,0), MaxDateTO);  
            ir_generalinf.rec.SpecificCode  = "";
            ir_generalinf.rec.RelCode   = "";
        end;
    end;

    if( (ir_generalinf.rec.Bulk != SET_CHAR) and (not GAmsg) and (DataSet.TemplNum != DLGR_TEMPL_REVALUATION_FAIRVALUE))
        var КлиентКонтрагента = СвязанныйКлиентКонтрагента(FD);
        if( NOT((DataSet.Method_Reg == 2 /* Двухсторонний */) AND (GenAgr.Side1 == 2)) )
            ir_generalinf.rec.Ref_IDClientParty1 = IR_PARTY_KIND_PARTY1;
            ir_generalinf.rec.Ref_ClientParty1  = "Party1";

            stat = stat + ОшибкаNoInf1(ir_generalinf, DataSet, GenAgr, first, error, field, KindDealPartyClient, DealParmForReport);
        
            if(ir_generalinf.rec.NoInf1 != SET_CHAR)
                stat = stat + ОшибкаOwnTrade1(ir_generalinf, DataSet, GenAgr, first, error, field, IsPartyClient, KindDealPartyClient, КлиентКонтрагента);
            end;

            iParty.Clear();
            
                 if( GenAgr.Side1 == 1 ) // Банк
                ПолучитьСубъекта(SQL_ConvTypeInteger(DataSet.Client), iParty);
            else
                ПолучитьСубъекта(КлиентКонтрагента.rec.PartyID, iParty);
            end;
            if((ir_generalinf.rec.NoInf1 != SET_CHAR) and (ir_generalinf.rec.OwnTrade1 != SET_CHAR))
                if( iParty.rec.PartyID <= 0 )
                    var StrError = "";
                    if( GenAgr.Side1 == 2 )
//StrError = "В сделке, выполненной в интересах клиента, не задан клиент контрагента";
                        //ir_generalinf.rec.NoInf1 = SET_CHAR;
                        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 31);
                        // Ограничение реализации
                        // 25.	При формировании сообщений по тем сделкам с клиентом контрагента, в которых не реализован связанный объект "Клиент контрагента", 
                        // данные о клиенте контрагента в состав сообщения не включаются. Пользователь может вручную добавить эти данные в сформированное сообщение.
                        // поэтому ошибку не ставим
                    else
                        StrError = "В сделке, выполненной в интересах клиента, не задан клиент";
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, StrError, "clientDetails", GetReportAction(DataSet.TemplNum), 300 + 31);
                    stat = stat + 1;
                   end;
 // последующие 4 сообщения не будут выведены в отчете, только будут подсвечены поля в форме
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 35);
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 37);
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 39);
                else
                stat = stat + ОшибкаClientType1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
                stat = stat + ОшибкаClientIdent1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
                stat = stat + ОшибкаClientName1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
                stat = stat + ОшибкаClientCountry1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
            end;
        end;
        end;

        if( NOT((DataSet.Method_Reg == 2 /* Двухсторонний */) AND (GenAgr.Side2 == 2)) )
            ir_generalinf.rec.RefIDClientParty2 = IR_PARTY_KIND_PARTY2;
            ir_generalinf.rec.RefClientParty2   = "Party2";
            
            stat = stat + ОшибкаNoInf2(ir_generalinf, DataSet, GenAgr, first, error, field, KindDealPartyClient, DealParmForReport);
            if(ir_generalinf.rec.NoInf2 != SET_CHAR)
                stat = stat + ОшибкаOwnTrade2(ir_generalinf, DataSet, GenAgr, first, error, field, IsPartyClient, KindDealPartyClient, КлиентКонтрагента);
            end;
            iParty.Clear();
            if( GenAgr.Side2 == 1 ) // Банк
                ПолучитьСубъекта(SQL_ConvTypeInteger(DataSet.Client), iParty);
            else
                ПолучитьСубъекта(КлиентКонтрагента.rec.PartyID, iParty);
            end;

            stat = stat + ОшибкаClientIdent2ID(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
        end;
    end;
    
    if( ir_generalinf.rec.Bulk != SET_CHAR )
        ir_generalinf.rec.DealCode  = DataSet.DealCode;
    else
        ir_generalinf.rec.DealCode  = "";
    end;
    
    stat = stat + ОшибкаMarginTypeCode(ir_generalinf, DataSet, GenAgr, first, error, field, FD, DealParmForReport);
    stat = stat + ОшибкаДопСоглашения(ir_generalinf, DataSet, GenAgr, first, error, field, ir_op, DealParmForReport);
    stat = stat + ОшибкаTraidID_UTI(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  else
    ir_generalinf.rec.PartyRef_TradeRepository3   = "TradeRepository";
    ir_generalinf.rec.TradesChoice = "TradesList";
    ir_generalinf.rec.TradeRepository_ReportID = "NONREF";
    
    ir_generalinf.rec.PartyRefID_TradeRepository = IR_PARTY_KIND_TRADEREPOSITORY;
    ir_generalinf.rec.PartyRef_IDParty1  = IR_PARTY_KIND_PARTY1;
    ir_generalinf.rec.PartyRef_IDParty2  = IR_PARTY_KIND_PARTY2;
    ir_generalinf.rec.PartyRef_IDSender = IR_PARTY_KIND_SENDER;
    ir_generalinf.rec.AsOfDate = AsOfDate093;
  END;
  
  //var msgNum = int(substr(ir_generalinf.rec.MessageType, 4));
  //заполним hedgeinfo
  //пока он применим только для сообщений процентного свопа=СМ032
  if((stat == 0) and (ir_generalinf.rec.MessageType == "CM032") and (DataSet.isPFI == SET_CHAR)) //(((msgNum >= 21) and (msgNum <= 81)) or ((msgNum >= 83) and (msgNum <= 85)))) 
    var hInfo = RsdRecordset("SELECT T_ID FROM ddlhdgrelation_dbt WHERE T_InstrID = "+ DataSet.DocID + " AND T_InstrDocKind = "+ DataSet.DocKind + 
      " AND T_BeginDate <= " + GetSQLDate({curdate}) + " AND (T_EndDate >= " + GetSQLDate({curdate}) + " OR T_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY'))");
    if(hInfo.MoveNext())    
      // if((msgNum >= 21) and (msgNum <= 81))
        ir_generalinf.rec.HedgeInfo = IIF( GenAgr.Side1 == 1, "H1", "H2");
      // elif((msgNum >= 83) and (msgNum <= 85))  
      //   ir_generalinf.rec.HedgeInfo = "H3";
      // end;
    end;
  end;

/*DAN устанавливаем значения для принадлежности сделки и информации о клиенте стороны*/
    ir_generalinf.rec.OwnTrade1 = set_char; 
    ir_generalinf.rec.NoInf1    = unset_char;
    ir_generalinf.rec.OwnTrade2 = set_char; 
    ir_generalinf.rec.NoInf2    = unset_char;
/*DAN*/ 
  
  return stat;
END;

MACRO UpdateRepAccDataGenInf(ir_generalinf : @TrecHandler, DataSet, GenAgr, first, error, field, DealParmForReport,
                             FD, ir_op, IsPartyClient, KindDealPartyClient, iParty)
  var stat = 0;
  stat = stat + ОшибкаГенерации(ir_generalinf, DataSet, GenAgr, first, error, field, NULL, DealParmForReport);
  stat = stat + ОшибкаSendBy(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  stat = stat + ОшибкаSendTo(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  stat = stat + ОшибкаTradeId_TradeRepository(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);  
  stat = stat + ОшибкаParty1(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  stat = stat + ОшибкаParty2(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  stat = stat + ОшибкаMarginTypeCode(ir_generalinf, DataSet, GenAgr, first, error, field, FD, DealParmForReport);
  stat = stat + ОшибкаДопСоглашения(ir_generalinf, DataSet, GenAgr, first, error, field, ir_op, DealParmForReport);
  stat = stat + ОшибкаTraidID_UTI(ir_generalinf, DataSet, GenAgr, first, error, field, DealParmForReport);
  stat = stat + ОшибкаBrokerID(ir_generalinf, DataSet, GenAgr, first, error, field, FD, DealParmForReport);
  stat = stat + ОшибкаParentCorrelationId(ir_generalinf,DataSet,GenAgr,first, error, field, ir_generalinf.rec.MessageType, DealParmForReport);
  stat = stat + ОшибкаLinkID(ir_generalinf,DataSet,GenAgr,first, error, field, ir_generalinf.rec.MessageType, DealParmForReport);

  var КлиентКонтрагента;
  КлиентКонтрагента = СвязанныйКлиентКонтрагента(FD);
  if( ir_generalinf.rec.Bulk != SET_CHAR )
        if( NOT((DataSet.Method_Reg == 2 /* Двухсторонний */) AND (GenAgr.Side1 == 2)) )
            ir_generalinf.rec.Ref_ClientParty1  = "Party1";

            stat = stat + ОшибкаNoInf1(ir_generalinf, DataSet, GenAgr, first, error, field, KindDealPartyClient, DealParmForReport);
            if(ir_generalinf.rec.NoInf1 != SET_CHAR)
                stat = stat + ОшибкаOwnTrade1(ir_generalinf, DataSet, GenAgr, first, error, field, IsPartyClient, KindDealPartyClient, КлиентКонтрагента);
            end;

            iParty.Clear();
            if( GenAgr.Side1 == 1 ) // Банк
                ПолучитьСубъекта(SQL_ConvTypeInteger(DataSet.Client), iParty);
            else
                ПолучитьСубъекта(КлиентКонтрагента.rec.PartyID, iParty);
            end;

            if((ir_generalinf.rec.NoInf1 != SET_CHAR) and  (ir_generalinf.rec.OwnTrade1 != SET_CHAR))
                if( iParty.rec.PartyID <= 0 )
                    var StrError = "";
                    if( GenAgr.Side1 == 2 )
                        //StrError = "В сделке, выполненной в интересах клиента, не задан клиент контрагента";
                        //ir_generalinf.rec.NoInf1 = SET_CHAR;
                        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 31);
                        // Ограничение реализации
                        // 25.	При формировании сообщений по тем сделкам с клиентом контрагента, в которых не реализован связанный объект "Клиент контрагента", 
                        // данные о клиенте контрагента в состав сообщения не включаются. Пользователь может вручную добавить эти данные в сформированное сообщение.
                        // поэтому ошибку не ставим
                    else
                        StrError = "В сделке, выполненной в интересах клиента, не задан клиент";
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, StrError, "clientDetails", GetReportAction(DataSet.TemplNum), 300 + 31);
                        stat = stat + 1;
                    end;
                    // последующие 4 сообщения не будут выведены в отчете, только будут подсвечены поля в форме
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 35);
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 37);
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, " ", " ", " ", GetReportAction(DataSet.TemplNum), 300 + 39);
                else
                stat = stat + ОшибкаClientType1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
                stat = stat + ОшибкаClientIdent1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
                stat = stat + ОшибкаClientName1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
                stat = stat + ОшибкаClientCountry1(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
            end;
        end;
        end;
    if( NOT((DataSet.Method_Reg == 2 /* Двухсторонний */) AND (GenAgr.Side2 == 2)) )
        ir_generalinf.rec.RefIDClientParty2 = IR_PARTY_KIND_PARTY2;
        ir_generalinf.rec.RefClientParty2   = "Party2";
        stat = stat + ОшибкаNoInf2(ir_generalinf, DataSet, GenAgr, first, error, field, KindDealPartyClient, DealParmForReport);
        if(ir_generalinf.rec.NoInf2 != SET_CHAR)
            stat = stat + ОшибкаOwnTrade2(ir_generalinf, DataSet, GenAgr, first, error, field, IsPartyClient, KindDealPartyClient, КлиентКонтрагента);
        end;
        iParty.Clear();
        if( GenAgr.Side2 == 1 ) // Банк
            ПолучитьСубъекта(SQL_ConvTypeInteger(DataSet.Client), iParty);
        else
            ПолучитьСубъекта(КлиентКонтрагента.rec.PartyID, iParty);
        end;
        stat = stat + ОшибкаClientIdent2ID(ir_generalinf, DataSet, GenAgr, first, error, field, iParty, DealParmForReport);
    end;
  end;
  if( stat == 0 )
      ir_generalinf.rec.RStatus = 1;
      ir_generalinf.rec.RStatusName = Bnk_GetNameAlg(ALG_GENINF_RSTATUS, 1);
  else
      ir_generalinf.rec.RStatus = 2;
      ir_generalinf.rec.RStatusName = Bnk_GetNameAlg(ALG_GENINF_RSTATUS, 2);
  end;
  
  stat = stat + ОшибкаMarginTypeCode(ir_generalinf, DataSet, GenAgr, first, error, field, FD, DealParmForReport);
  stat = stat + ОшибкаДопСоглашения(ir_generalinf, DataSet, GenAgr, first, error, field, ir_op, DealParmForReport);
  return stat;
END;
