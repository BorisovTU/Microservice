/*
    $Name: ir_CM083.mac
    $Module:   Репозитарий
    $Description:  Отчет по сделкам репо 
*/

import "ir_CMBase.mac";

class (CMBase) CM083 ( _isRecon, _conveyerID, _ir_op : object)
  InitCMBase();

  m_isRecon     = _isRecon;
  m_conveyerID  = _conveyerID;
  m_ir_op       = _ir_op;
  m_MessageID   = REPOS_CM083;
  var m_CounterParty = TArray(); /*массив субъектов контагентов*/

  macro addCMAll(ir_generalinf     ,
                 TradeRepository   ,
                 Party1            ,
                 Party2            ,
                 UTIGeneratingParty,
                 Sender            ,
                 cm                ,
                 Instruments       ,
                 GrDealID          ,
                 TemplNum          ,
                 DealParmForReport ,
                 CounterParty)
    if (m_GeneralInfArr.size == 0)
      addGenInf(ir_generalinf, TemplNum, DealParmForReport);
      addRepAccGrDoc(GrDealID);
      addParty(TradeRepository, Party1, Party2, UTIGeneratingParty, Sender);
      addcmGrDoc(GrDealID);
    end;

    addCM(cm);
    addInstrument(Instruments);

    arrsize = m_CounterParty.size;
    m_CounterParty[arrsize] = TRecHandler("ir_party.dbt");
    copy(m_CounterParty[arrsize], CounterParty);
  end;

  macro insertAll
    var err = 0;
    var i = 0;
    var ir_generalinfCache = RsbSQLInsert("ir_generalinf.dbt");
    var realIDs = TArray();
    /* Вставляем СРС 083 и обновляем привязки к строке графика */
    ir_generalinfCache.AddRecordArray(m_GeneralInfArr);
    ir_generalinfCache.AddReturning("t_InternalMessageID", V_INTEGER);
    
    if( not ir_generalinfCache.insert() )
        err = 1;
        RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(m_RepDealParmArr[arrsize].DealID, m_RepDealParmArr[arrsize].DealKind,"", "", "Ошибка при сохранении данных сообщения", "", "", 0);   // добавил "" 7-ым параметром
    else
        ir_generalinfCache.GetReturning(realIDs);
        i = 0;
        while( i < m_GeneralInfArr.size ) // на сам деле один раз
            m_GeneralInfArr[i].rec.InternalMessageID = realIDs[i];
            m_RepAccGrDocArr[i].rec.DocID = realIDs[i];
            
            m_PartyArr[i*5].rec.InternalMessageID   = realIDs[i];
            m_PartyArr[i*5+1].rec.InternalMessageID = realIDs[i];
            m_PartyArr[i*5+2].rec.InternalMessageID = realIDs[i];
            m_PartyArr[i*5+3].rec.InternalMessageID = realIDs[i];
            //m_PartyArr[i*5+4].rec.InternalMessageID = realIDs[i];
            
            var l = 0;
            while( l < m_cmArr.size )
                m_cmArr[l].rec.InternalMessageID = realIDs[i];
                l = l + 1;
            end;
            
            l = 0;
            while( l < m_instrumentsArr.size )
                m_instrumentsArr[l].rec.InternalMessageID = realIDs[i];
                l = l + 1;
            end;
            
            l = 0;
            while( l < m_CounterParty.size )
                m_CounterParty[l].rec.InternalMessageID = realIDs[i];
                l = l + 1;
            end;
            
            /* добавить запись в лог о вставке СРС */
            if ( not m_isRecon )
                m_RepDataArr[m_RepDataArr.size] = CIR_RepAccRepParm(
                        m_RepActionArr[i],
                        m_GeneralInfArr[i].rec.DealCode,
                        m_GeneralInfArr[i].rec.MessageType,
                        DL_GetNameAlg(ALG_GENINF_RSTATUS, m_GeneralInfArr[i].rec.RStatus),
                        m_RepDealParmArr[i].DealID, 
                        m_RepDealParmArr[i].DealKind);
            end;
            i = i + 1;
        end;
    end;
    
    if( (not err) )
      err = insertParty;
    end;
    
    if( (not err) and (m_CounterParty.size > 0) )
        /* Вставляем субъектов контрагентов */
        var ir_CounterPartyCache = RsbSQLInsert("ir_party.dbt");
        ir_CounterPartyCache.AddRecordArray(m_CounterParty);
        ir_CounterPartyCache.AddReturning("t_ID", V_INTEGER);
        
        if( not ir_CounterPartyCache.insert() )
            err = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr("", "", "", "", "Ошибка при сохранении данных контрагентов", "", "", 0);   // добавил "" 7-ым параметром
        else
            realIDs.size = 0;
            ir_CounterPartyCache.GetReturning(realIDs);
            i = 0;
            var k = 0;
            while( i < m_cmArr.size )
                m_cmArr[i].rec.InternalPartyID = realIDs[i];
                i = i + 1;
            end;
        end;
    end;

    if( (not err) and (m_instrumentsArr.size > 0) )
        /* Вставляем instruments для cm083 */
        var ir_instrumentsCache  = RsbSQLInsert("ir_instruments.dbt");
        ir_instrumentsCache.AddRecordArray(m_instrumentsArr);
        ir_instrumentsCache.AddReturning("t_id", V_INTEGER);
        
        if( not ir_instrumentsCache.insert() )
            err = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(m_RepDealParmArr.DealID, m_RepDealParmArr.DealKind, "", "", "Ошибка при сохранении данных финансовых инструментов", "", "", 0);   // добавил "" 7-ым параметром
        else
            realIDs.size = 0;
            ir_instrumentsCache.GetReturning(realIDs);
            i = 0;
            while( i < m_cmArr.size )
                m_cmArr[i].rec.InstrumentsID = realIDs[i];
                i = i + 1;
            end;
        end;
    end;
    
    if( (not err) and (m_cmArr.size > 0) )
        /* Вставляем cm083 */
        var ir_cmCache  = RsbSQLInsert("ir_" + m_MessageType + ".dbt");
        ir_cmCache.AddRecordArray(m_cmArr);
        ir_cmCache.AddReturning("t_id", V_INTEGER);
        
        if( not ir_cmCache.insert() )
            err = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(m_RepDealParmArr.DealID, m_RepDealParmArr.DealKind, "", "", "Ошибка при сохранении данных экономических параметров", "", "", 0);   // добавил "" 7-ым параметром
        else
            realIDs.size = 0;
            ir_cmCache.GetReturning(realIDs);
            i = 0;
            var delta =  m_cmGrDocArr.size;
            while( i < delta )
                m_cmGrDocArr[i].rec.DocID = realIDs[i];
                m_cmGrDocArr[i+delta] = TRecHandler("dlgrdoc.dbt");
                m_cmGrDocArr[i+delta].Clear();
                m_cmGrDocArr[i+delta].rec.GrDealID    = m_cmGrDocArr[i].rec.GrDealID;
                m_cmGrDocArr[i+delta].rec.DocKind     = REPOS_GENERALINF;
                m_cmGrDocArr[i+delta].rec.ServDocKind = m_cmGrDocArr[i].rec.ServDocKind;
                m_cmGrDocArr[i+delta].rec.ServDocID   = m_cmGrDocArr[i].rec.ServDocID;
                m_cmGrDocArr[i+delta].rec.DocID       = m_GeneralInfArr[0].rec.InternalMessageID;
                i = i + 1;
            end;
        end;
    end;
    
    err = insertDlgrdocCache;
    
    return err;
  end;

  macro ЗаполнениеCM (cm:@TrecHandler, 
                      DataSet,
                      GenAgr,
                      first,
                      error,
                      field,
                      FD,
                      CounterParty:@TrecHandler,
                      ir_generalinf:@TrecHandler,
                      Instruments:@TrecHandler,
                      i,
                      DealParmForReport)
    var iParty = TRecHandler("party");
    var stat = 0;
    var Country;
    var CP = (i + 1)*1000;
    if (first)
        var CounterpartyN = "";//"Counterparty" + (i + 1);
        var CP_count = 0;
        var CP_find = false;
        if(MesCountry.size > 0)
          while(CP_count < MesCountry.size)
            if(DataSet.Contractor == MesCountry[CP_count].Country)
              CounterpartyN = MesCountry[CP_count].PartyType;
              CP_find = true;
              break;
            end;
            CP_count = CP_count + 1 ;  
          end;

        if(not CP_find)
          CounterpartyN = "Counterparty" + (MesCountry.size + 1);
          MesCountry[MesCountry.size] = CMesCountry(DataSet.Contractor, CounterpartyN);
        end;

        CounterParty.clear();
        //Instruments.clear();
        iParty.Clear();
        CounterParty.rec.PartyKind = IR_PARTY_KIND_COUNTERPARTY;

        end;
        CounterParty.rec.PartyType = CounterpartyN;
        CounterParty.rec.PartyID = DataSet.Contractor;

        CounterParty.rec.ClassificationID = GenAgr.EconomicContr /*DataSet.EconomicContr*/;
        if( CounterParty.rec.ClassificationID <= 0 )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Контрагент\" в ГС (ПГС) не задан параметр \"Вид экономической деятельности\"", "Classification", GetReportAction(DataSet.TemplNum), CP + 4);
        else
            DL_GetObjAttrName(OBJTYPE_PARTY, 80, CounterParty.rec.ClassificationID, null, null, @CounterParty.rec.Classification);
        end;
        
        if( (CounterParty.rec.PartyID > 0) and (ПолучитьСубъекта(CounterParty.rec.PartyID, iParty) == 0) )
            CounterParty.rec.PartyName = iParty.rec.ShortName;
            if( CounterParty.rec.PartyName == "" )
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Контрагент\" не задано краткое наименование участника репозитария", "PartyName", GetReportAction(DataSet.TemplNum), CP + 1);
            end;
            
            CounterParty.rec.PartyID1 = ПолучитьКодСубъекта(CounterParty.rec.PartyID, PTCK_RIC);
            if( CounterParty.rec.PartyID1 == "" )
                if( ВидСубъекта(CounterParty.rec.PartyID, PTK_REPOSPRT) )
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Контрагент\" не задан репозитарный идент. код", "PartyID1", GetReportAction(DataSet.TemplNum), CP + 2);
                else
                    CounterParty.rec.PartyID1 = "NONREF";
                end;
            end;
            
            if( (CounterParty.rec.PartyID > 0) and (ПолучитьСубъекта(CounterParty.rec.PartyID, iParty) == 0) )
                stat = ПолучитьPartyID2Контрагента(CounterParty, iParty, DataSet, GenAgr, ir_generalinf, CP + 3, DealParmForReport);
            end;
            
            if( iParty.rec.LegalForm == PTLEGF_PERSN )
                CounterParty.rec.OrganizationType = "P";
            else
                CounterParty.rec.OrganizationType = "L";
            end;
            
            if( iParty.rec.NotResident == UNSET_CHAR )
                CounterParty.rec.Country = "RU";
            else
                var Adress = TRecHandler("adress.dbt");
                Adress.Clear();
                if( НайтиЮридическийАдресСубъекта(iParty.rec.PartyID, Adress) and (Adress.rec.Country != "") )
                    CounterParty.rec.Country = DL_GetCountryByCodeLat3(Adress.rec.Country).CodeLat2;
                end;
                if( CounterParty.rec.Country == "" )
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Контрагент\" в справочнике не указана страна", "Country", GetReportAction(DataSet.TemplNum), CP + 8);
                end;
            end;
        else
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не найден участник \"CounterParty\"", "PartyID", GetReportAction(DataSet.TemplNum), CP + 2);
        end;

        
        cm.rec.PartyType   = i+1;
        cm.rec.P_TradeID   = DataSet.DealCode;
        cm.rec.DealID      = DataSet.DocID;
        cm.rec.Side= IIF(IsSALE(FD.Group), "Buyer", "Seller");
        cm.rec.Rate= FD.dl_leg.rec.IncomeRate;
        cm.rec.A_Spot  = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.Amount;
        cm.rec.C_Spot  = GetFICode(FD.dl_leg.rec.CFI, null, FICK_ISOSTRING);
        cm.rec.R_TradeID   = "NONREF";
        if(DataSet.UTI_CONTRACT!="")
        cm.rec.U_TradeID   = DataSet.UTI_CONTRACT;
        else
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Не задан код UTI", "u_TradeID", GetReportAction(DataSet.TemplNum), 1000 + 11);
            
        end;    
        cm.rec.PID_TradeID = "REOFF";
        cm.rec.A_Forward   = FD.GetRQ(DLRQ_TYPE_PAYMENT, 2).rec.Amount + FD.GetRQ(DLRQ_TYPE_INCREPO, 2).rec.Amount;
        cm.rec.C_Forward   = GetFICode(FD.GetPayFIID(), null, FICK_ISOSTRING);
        if( FI_IsBond(FD.fininstr) == true )
            cm.rec.Sign_Bonds = SET_CHAR;
            cm.rec.ID_Bond = FD.fininstr.rec.FI_Code;
            cm.rec.N_Bond = GetFaceValue(FD.fininstr.rec.FIID, FD.tick.rec.DealDate) * FD.dl_leg.rec.Principal;
            cm.rec.C_Bond = GetFICode(FD.fininstr.rec.FaceValueFI, null, FICK_ISOSTRING);
        elif( FI_IsShare(FD.fininstr) OR FI_IsInvestmentShare(FD.fininstr) )
            cm.rec.Sign_Equity = SET_CHAR;
            cm.rec.ID_Equity = FD.fininstr.rec.FI_Code;
            cm.rec.N_Equity = FD.dl_leg.rec.Principal;
            if ( FD.dl_leg.rec.RelativePrice == SET_CHAR )
                var CcyRate = GetRateOnDateCrossDbl(FD.tick.rec.DealDate, FD.fininstr.rec.FaceValueFI, FD.dl_leg.rec.CFI, false);
                cm.rec.P_Equity = (FD.fininstr.rec.FaceValue * FD.dl_leg.rec.Price / 100) * CcyRate;
            else
                cm.rec.P_Equity = FD.dl_leg.rec.Price;
            end;
            cm.rec.C_Equity = GetFICode(FD.dl_leg.rec.CFI, null, FICK_ISOSTRING);
        end;
        if( DataSet.Client > 0 )
            cm.rec.ClientDeal = SET_CHAR;
                
            iParty.Clear();
            ПолучитьСубъекта(SQL_ConvTypeInteger(DataSet.Client), iParty);
            
            if( iParty.rec.PartyID > 0 )
                ПолучитьClientIdentБанк(iParty, DataSet, GenAgr, NULL, 1, @cm.rec.I_Client, DealParmForReport);
                cm.rec.T_Client = GetClientType1(iParty);
                cm.rec.N_Client = GetClientName(iParty);

                if( iParty.rec.NotResident == UNSET_CHAR )
                    Country="RUS";
		            else
                    Country = GetCountry(iParty);
                end;

                if( Country != "" )
                    cm.rec.C_Client = DL_GetCountryByCodeLat3(Country).CodeLat2;
                end;
            end;
        end;
        
        Instruments.rec.FIID   = FD.fininstr.rec.FIID;
        Instruments.rec.InstrumentCode = FD.fininstr.rec.FI_Code;
        Instruments.rec.Instrumentname = FD.fininstr.rec.Name;
        
    end;
    if ((error=="Для участника \"Контрагент\" не задано краткое наименование участника репозитария")and(field=="PartyName"))
        ПолучитьСубъекта(CounterParty.rec.PartyID, iParty);
        CounterParty.rec.PartyName = iParty.rec.ShortName;
        if( CounterParty.rec.PartyName == "" )
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Контрагент\" не задано краткое наименование участника репозитария", "PartyName", GetReportAction(DataSet.TemplNum), CP + 1);
        end;
    elif ((error=="Для участника \"Контрагент\" не задан репозитарный идент. код")and(field=="PartyID1"))
        CounterParty.rec.PartyID1 = ПолучитьКодСубъекта(CounterParty.rec.PartyID, PTCK_RIC);
        if( CounterParty.rec.PartyID1 == "" )
            if( ВидСубъекта(CounterParty.rec.PartyID, PTK_REPOSPRT) )
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, "Для участника \"Контрагент\" не задан репозитарный идент. код", "PartyID1", GetReportAction(DataSet.TemplNum), CP + 2);
            else
                CounterParty.rec.PartyID1 = "NONREF";
            end;
        end;
    elif((field=="PartyID2")and
    ((error=="Для участника \"Контрагент\" не задан код LEI")or
    (error=="Для участника \"Контрагент\" юр. лица не заданы ни LEI, ни INN")or
    (error=="Для участника \"Контрагент\" нерезидента не задан ни один код")))
        ПолучитьСубъекта(CounterParty.rec.PartyID, iParty);
        stat = stat + ПолучитьPartyID2Контрагента(CounterParty, iParty, DataSet, GenAgr, ir_generalinf, CP + 3, DealParmForReport);
    end;
    return stat;
  end;
end;