/*
Отчет о состоянии сообщений Репозитария. Запуск отчёта + форма отчета
ir_rep_msgstate_form.mac
*/
import CbForms_h, globals, DlRepForm_h, ir_rep_msgstate;

/*Номера полей в форме отчета*/
const PNFLD_MSGSTATE_DATE  = 0,
      PNFLD_MSGSTATE_CHECK = 1,
      PNFLD_ORDERS_CHECK   = 2;

private const
  H_DATE = 100,
  H_CHECKBOX_STATE = 101,
  H_CHECKBOX_ORDERS = 102;

private macro DL_FldProc_CheckBox_State( pThis:DL_CPanel, Cmd:integer, Key:integer, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):integer
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) and (Key == KEY_SPACE) )
     if(FldRealValue == "X")
        if( pThis.GetFieldValue( PNFLD_MSGSTATE_CHECK ) != "X" )
           return CM_IGNORE;
        else
           FldShowValue = FldRealValue = "";
        end;
     else
        FldShowValue = FldRealValue = "X";
     end;
  end;
  return CM_DEFAULT;
END;

private macro DL_FldProc_CheckBox_Orders( pThis:DL_CPanel, Cmd:integer, Key:integer, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):integer
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) and (Key == KEY_SPACE) )
     if(FldRealValue == "X")
        if( pThis.GetFieldValue( PNFLD_ORDERS_CHECK ) != "X" )
           return CM_IGNORE;
        else
           FldShowValue = FldRealValue = "";
        end;
     else
        FldShowValue = FldRealValue = "X";
     end;
  end;
  return CM_DEFAULT;
END;

class (DL_CPanel) IR_MsgState_Panel ()

  private macro Init ()

    AddFieldProc( 0, PNFLD_MSGSTATE_DATE,  H_DATE,            @DL_FldProc_EndDate,         {curdate} );
    AddFieldProc( 0, PNFLD_MSGSTATE_CHECK, H_CHECKBOX_STATE,  @DL_FldProc_CheckBox_State,  "X"       );
    AddFieldProc( 0, PNFLD_ORDERS_CHECK,   H_CHECKBOX_ORDERS, @DL_FldProc_CheckBox_Orders, "X"       );
    
  End;

  initDL_CPanel("ir_rep.lbr", "SLAU232");
END;

var panel = IR_MsgState_Panel;
if (panel.run);
  Rep_MsgState(panel.GetFieldValue( PNFLD_MSGSTATE_DATE ), panel.GetFieldValue( PNFLD_MSGSTATE_CHECK ), panel.GetFieldValue( PNFLD_ORDERS_CHECK ));
end;

//exit(1);