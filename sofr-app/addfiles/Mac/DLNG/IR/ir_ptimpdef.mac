/*
$Name:             ir_ptimpdef.mac
$Module:           Репозитарий
$Description:      Процедура импорта участников репозитария. Общие параметры и функции
*/
import PTInter, cb_sql;

const PROCSTATUS_None = 0;      // Не определен
const PROCSTATUS_Save = 1;      // Выполнено сохранение данных из файла
const PROCSTATUS_Check = 2;     // Выполнена сверка данных
const PROCSTATUS_Load = 3;      // Выполнена загрузка данных

const RECSTATUS_None = 0;       // Не определен
const RECSTATUS_NotRepo = 1;    // Субъект не является участником репозитария
const RECSTATUS_Check = 2;      // Выполнена сверка данных по участнику
const RECSTATUS_Duplicate = 3;  // Запись с повторяющимся наименованием
const RECSTATUS_Equal = 5;      // Все данные участника совпадают с данными в Справочнике
const RECSTATUS_Inserted = 10;   // Выполнена вставка нового участника репозитария
const RECSTATUS_Updated = 11;    // Выполнено обновление данных по участнику репозитария
const RECSTATUS_RepoUpdated = 12;// Выполнено обновление данных с добавлением признака "участник репозитария"
const RECSTATUS_InsError = 20;   // Ошибка вставки нового участника репозитария
const RECSTATUS_UpdError = 21;   // Ошибка обновление данных по участнику репозитария
const RECSTATUS_RUpdError = 22;  // Ошибка обновления данных с добавлением признака "участник репозитария"

const PARAMSTATUS_None = 0;     // Не определен
const PARAMSTATUS_Ident = 1;    // Параметр, по которому был идентифицирован участник
const PARAMSTATUS_Equal = 2;    // Параметр найден и совпадает с имеющимся в БД значением
const PARAMSTATUS_NotEqual = 3; // Параметр найден и не совпадает
const PARAMSTATUS_NotFound = 4; // Параметр не найден
const PARAMSTATUS_NotDefined = 5;// Параметр не однозначен

const CONST_PERSONRICODE = "RPI";

/* Определение наличия роли для субъекта */
macro IsExistsPTRole( partyid, kind )
    var cmd =  RSDCommand("SELECT 1 FROM dpartyown_dbt WHERE t_partyid = ? AND t_partykind = ?");
    cmd.addParam("", RSDBP_IN, partyid);
    cmd.addParam("", RSDBP_IN, kind);
    cmd.execute();
    var rsd = TRsbDataSet(cmd);
    return rsd.MoveNext();
end; /* IsExistsPTRole */

macro ExtractFIO( FullName, name1, name2, name3 )
    name1 = FullName;
    name2 = "";
    name3 = "";
    var pos = Index( name1, " " );
    if( pos > 0 )
        name2 = substr( name1, pos + 1 );
        name1 = substr( name1, 1, pos - 1 );
        pos = Index( name2, " " );
        if( pos > 0 )
            name3 = substr( name2, pos + 1 );
            name2 = substr( name2, 1, pos - 1 );
        end;
    end;
    setparm( 1, name1 );
    setparm( 2, name2 );
    setparm( 3, name3 );
end; /* ExtractFIO */

macro GetCountRecs( cmdstr, ImpRepId ): integer
    var cmd = RsdCommand("SELECT COUNT(1) t_cnt FROM (" + cmdstr + ")");
    cmd.addParam("", RSDBP_IN, ImpRepId);
    cmd.execute();
    var rsd = TRsbDataSet(cmd);
    if( rsd.MoveNext() )
        return rsd.rec.cnt;
    end;
    return 0;
end; /* GetCountRecs */
