/*
    $Name: ir_CM051.mac
    $Module:   Репозитарий
    $Description:  Анкета договора товарного форварда 
*/

import "ir_CMBase.mac";

class (CMBase) CM051 ( _isRecon, _conveyerID, _ir_op : object)
  InitCMBase();

  m_isRecon     = _isRecon;
  m_conveyerID  = _conveyerID;
  m_ir_op       = _ir_op;
  m_MessageID   = REPOS_CM051;

  macro addCMAll(ir_generalinf     ,
                 TradeRepository   ,
                 Party1            ,
                 Party2            ,
                 UTIGeneratingParty,
                 Sender            ,
                 cm                ,
                 GrDealID          ,
                 TemplNum          ,
                 DealParmForReport )
    addGenInf(ir_generalinf, TemplNum, DealParmForReport);
    addRepAccGrDoc(GrDealID);
    addcmGrDoc(GrDealID);
    addParty(TradeRepository, Party1, Party2, UTIGeneratingParty, Sender);
    addCM(cm);
  end;

  macro insertAll
    var err = 0;
    err = insertGeneralinf;
    if (not err)
      err = insertParty;
    end;
    if (not err)
      err = insertDlgrdocCache;
    end;
    if (not err)
      err = insertCM;
    end;
    return err;
  end;

  macro ЗаполнениеCM (cm : @TrecHandler,
                      DataSet,
                      GenAgr,
                      FD,
                      first,
                      field,
                      DealParmForReport)
    var erFlag:bool = false;
    var bondFaceValue;
    var stat=0;
    var FI = TRecHandler( "fininstr.dbt" );
    var Art = TBFile( "article.dbt" );
    var CommAssets = TBFile( "ir_commodityassets.dbt" );
    var CAUnits = TBFile( "ir_commassetsunits.dbt" );
    if (first)
        if( (FD.IsBuy() and (GenAgr.Side1 == 1)) or
        (FD.IsSale() and (GenAgr.Side1 != 1))
        )
            cm.rec.payerpartyref_fxleg = "Party1";
            cm.rec.payerpartyref_fxlegid = IR_PARTY_KIND_PARTY1;
            cm.rec.receiverpartyref_fxleg = "Party2";
            cm.rec.receiverpartyref_fxlegid = IR_PARTY_KIND_PARTY2;
        else
            cm.rec.payerpartyref_fxleg = "Party2";
            cm.rec.payerpartyref_fxlegid = IR_PARTY_KIND_PARTY2;
            cm.rec.receiverpartyref_fxleg = "Party1";
            cm.rec.receiverpartyref_fxlegid = IR_PARTY_KIND_PARTY1;
        end;
        
        cm.rec.price = FD.nFI_().rec.Price;
        cm.rec.amount = FD.nFI_().rec.Amount * FD.nFI_().rec.Price;

        cm.rec.pricecurrency = GetFICode(FD.ВалютаЦены(), null, FICK_ISOSTRING);
        cm.rec.compricecurrency = GetFICode(FD.ВалютаЦены(), null, FICK_ISOSTRING);
        cm.rec.amountcurrency = GetFICode(FD.ВалютаЦены(), null, FICK_ISOSTRING);

        if(not ПолучитьФинИн( FD.nFI_().rec.FIID, FI))
            cm.rec.commodity = FI.rec.Name;
        end;

        Art.rec.FIID = FD.nFI_().rec.FIID;
        if (Art.GetEQ())
            if (FD.ВидБазовогоАктива() == FIKIND_METAL)
                cm.rec.instrumentid = "Commodity:Metals:Precious";
            else
                CommAssets.rec.ID = Art.rec.RepozCode;
                if (CommAssets.GetEQ())
                    cm.rec.instrumentid = CommAssets.rec.CommodityAssets;
                else
                    stat = 1;
                    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, m_MessageType, "Не задан код для сообщений репозитария у ПИ", "InstrumentId", GetReportAction(DataSet.TemplNum));
                end;
            end;

            CAUnits.rec.ID = Art.rec.RepozMeasureCode;
            if (CAUnits.GetEQ())
                cm.rec.priceunit = CAUnits.rec.CommAssetsUnits;
            else
                stat = 1;
                RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, m_MessageType, "Не задана единица измерения для сообщений репозитария у ПИ", "PricePnit", GetReportAction(DataSet.TemplNum));
            end;
        end;

        cm.rec.comunit = cm.rec.priceunit; 

        cm.rec.paymentdate_fxleg = FD.ДатаОплаты();
        if (cm.rec.paymentdate_fxleg == ZeroDate)
            cm.rec.paymentdate_fxleg = FD.ДатаИсполнения();
        end;
        if ( FD.nFI_().rec.ExecType == 1 )
            cm.rec.extype = "P";
            cm.rec.deliverydate = FD.ДатаПоставки();
            if (cm.rec.deliverydate == ZeroDate)
                cm.rec.deliverydate = FD.ДатаИсполнения();
            end;
            cm.rec.quantityunit = cm.rec.priceunit;
        else
            cm.rec.extype = "F";
            cm.rec.paymentdate = FD.ДатаИсполнения();
        end;

        cm.rec.payerpartyreference = cm.rec.receiverpartyref_fxleg;
        cm.rec.payerpartyreferenceid = cm.rec.receiverpartyref_fxlegid;
        cm.rec.receiverpartyreference = cm.rec.payerpartyref_fxleg;
        cm.rec.receiverpartyreferenceid = cm.rec.payerpartyref_fxlegid;

        cm.rec.quantity = FD.nFI_().rec.Amount;
        cm.rec.conversionfactor = 0.0;
    end;
    return stat;
  end;
end;