/*
    $Name: ir_CM022.mac
    $Module:   Репозитарий
    $Description:  Анкета договора конверсионной сделки 
*/

import "ir_CMBase.mac";

class (CMBase) CM022 ( _isRecon, _conveyerID, _ir_op : object)
  InitCMBase();

  m_isRecon     = _isRecon;
  m_conveyerID  = _conveyerID;
  m_ir_op       = _ir_op;
  m_MessageID   = REPOS_CM022;

  macro addCMAll(ir_generalinf     ,
                 TradeRepository   ,
                 Party1            ,
                 Party2            ,
                 UTIGeneratingParty,
                 Sender            ,
                 cm                ,
                 GrDealID          ,
                 TemplNum          ,
                 DealParmForReport )
    addGenInf(ir_generalinf, TemplNum, DealParmForReport);
    addRepAccGrDoc(GrDealID);
    addcmGrDoc(GrDealID);
    addParty(TradeRepository, Party1, Party2, UTIGeneratingParty, Sender);
    addCM(cm);
  end;

  macro insertAll
    var err = 0;
    err = insertGeneralinf;
    if (not err)
      err = insertParty;
    end;
    if (not err)
      err = insertDlgrdocCache;
    end;
    if (not err)
      err = insertCM;
    end;
    return err;
  end;

  macro ЗаполнениеCM (cm : @TrecHandler,
                      DataSet,
                      GenAgr,
                      FD)
 /* 
    if( (FD.IsBuy() and (GenAgr.Side1 == 1)) or
        (FD.IsSale() and (GenAgr.Side1 != 1))
        )
        cm.rec.ReceiverPartyReference1ID = IR_PARTY_KIND_PARTY1;
        cm.rec.ReceiverPartyReference1   = "Party1";
        cm.rec.PayerPartyReference1ID= IR_PARTY_KIND_PARTY2;
        cm.rec.PayerPartyReference1  = "Party2";
        if ( FD.nFI_().rec.ExecType == 1 )
            cm.rec.AmountCurr1 = FD.nFI_().rec.Cost;
        else
            cm.rec.AmountCurr1 = FD.nFI_().rec.Amount * FD.nFI_().rec.Price;
        end;
        cm.rec.Currency1ID = FD.ВалютаЦены();
        cm.rec.AmountCurr2 = FD.nFI_().rec.Amount;
        cm.rec.Currency2ID = FD.BaseFI().rec.FIID;
        cm.rec.QBasis  = "Currency1PerCurrency2";
        cm.rec.TradeCurr   = "ExchangedCurrency2";
        cm.rec.TradeCurrID = cm.rec.Currency2ID;
    else
        cm.rec.ReceiverPartyReference1ID = IR_PARTY_KIND_PARTY2;
        cm.rec.ReceiverPartyReference1   = "Party2";
        cm.rec.PayerPartyReference1ID= IR_PARTY_KIND_PARTY1;
        cm.rec.PayerPartyReference1  = "Party1";
        cm.rec.AmountCurr1 = FD.nFI_().rec.Amount;
        cm.rec.Currency1ID = FD.BaseFI().rec.FIID;
        if ( FD.nFI_().rec.ExecType == 1 )
            cm.rec.AmountCurr2 = FD.nFI_().rec.Cost;
        else
            cm.rec.AmountCurr2 = FD.nFI_().rec.Amount * FD.nFI_().rec.Price;
        end;
        cm.rec.Currency2ID = FD.ВалютаЦены();
        cm.rec.QBasis  = "Currency2PerCurrency1";
        cm.rec.TradeCurr   = "ExchangedCurrency1";
        cm.rec.TradeCurrID = cm.rec.Currency1ID;
    end;
*/

    if( (FD.IsBuy() and (GenAgr.Side1 == 1)) or
        (FD.IsSale() and (GenAgr.Side1 != 1))
        )
        cm.rec.ReceiverPartyReference1ID = IR_PARTY_KIND_PARTY2;
        cm.rec.ReceiverPartyReference1   = "Party2";
        cm.rec.PayerPartyReference1ID= IR_PARTY_KIND_PARTY1;
        cm.rec.PayerPartyReference1  = "Party1";
//       cm.rec.ReceiverPartyReference1ID = IR_PARTY_KIND_PARTY1;
//        cm.rec.ReceiverPartyReference1   = "Party1";
//        cm.rec.PayerPartyReference1ID= IR_PARTY_KIND_PARTY2;
//        cm.rec.PayerPartyReference1  = "Party2";

        if ( FD.nFI_().rec.ExecType == 1 )
            cm.rec.AmountCurr1 = FD.nFI_().rec.Cost;
        else
            cm.rec.AmountCurr1 = FD.nFI_().rec.Amount * FD.nFI_().rec.Price;
        end;
        cm.rec.Currency1ID = FD.ВалютаЦены();
        cm.rec.AmountCurr2 = FD.nFI_().rec.Amount;
        cm.rec.Currency2ID = FD.BaseFI().rec.FIID;
        cm.rec.QBasis  = "Currency1PerCurrency2";
        cm.rec.TradeCurr   = "ExchangedCurrency2";
        cm.rec.TradeCurrID = cm.rec.Currency2ID;

    else
//        cm.rec.ReceiverPartyReference1ID = IR_PARTY_KIND_PARTY1;
//        cm.rec.ReceiverPartyReference1   = "Party1";
        cm.rec.ReceiverPartyReference1ID = IR_PARTY_KIND_PARTY2;
        cm.rec.ReceiverPartyReference1   = "Party2";

//        cm.rec.PayerPartyReference1ID= IR_PARTY_KIND_PARTY2;
//        cm.rec.PayerPartyReference1  = "Party2";
        cm.rec.PayerPartyReference1ID= IR_PARTY_KIND_PARTY1;
        cm.rec.PayerPartyReference1  = "Party1";

        cm.rec.AmountCurr1 = FD.nFI_().rec.Amount;
        cm.rec.Currency1ID = FD.BaseFI().rec.FIID;
        if ( FD.nFI_().rec.ExecType == 1 )
            cm.rec.AmountCurr2 = FD.nFI_().rec.Cost;
        else
            cm.rec.AmountCurr2 = FD.nFI_().rec.Amount * FD.nFI_().rec.Price;
        end;
        cm.rec.Currency2ID = FD.ВалютаЦены();
        cm.rec.QBasis  = "Currency2PerCurrency1";
        cm.rec.TradeCurr   = "ExchangedCurrency1";
        cm.rec.TradeCurrID = cm.rec.Currency1ID;
    end;


    
    cm.rec.PayerPartyReference2ID= cm.rec.ReceiverPartyReference1ID;
    cm.rec.PayerPartyReference2  = cm.rec.ReceiverPartyReference1;
    cm.rec.ReceiverPartyReference2ID = cm.rec.PayerPartyReference1ID;
    cm.rec.ReceiverPartyReference2   = cm.rec.PayerPartyReference1;
    cm.rec.Currency1 = GetFICode(cm.rec.Currency1ID, null, FICK_ISOSTRING);
    cm.rec.Currency2 = GetFICode(cm.rec.Currency2ID, null, FICK_ISOSTRING);
    cm.rec.ValDate   = max(FD.ДатаПоставки(), FD.ДатаОплаты());
    if ( cm.rec.ValDate == date(0, 0, 0) )
        cm.rec.ValDate = FD.ДатаИсполнения();
    end;
    cm.rec.QuotedCurrency1ID = cm.rec.Currency1ID;
    cm.rec.QuotedCurrency1   = cm.rec.Currency1;
    cm.rec.QuotedCurrency2ID = cm.rec.Currency2ID;
    cm.rec.QuotedCurrency2   = cm.rec.Currency2;
    cm.rec.Rate  = FD.nFI_().rec.Price;
    cm.rec.SettlCurrID   = FD.ВалютаРасчётов();
    cm.rec.SettlCurr = GetFICode(cm.rec.SettlCurrID, null, FICK_ISOSTRING);

    return 0;
  end;
end;