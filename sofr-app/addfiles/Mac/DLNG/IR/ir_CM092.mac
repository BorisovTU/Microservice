/*
    $Name: ir_CM092.mac
    $Module:   Репозитарий
    $Description:  Отчет о расчете справедливой (оценочной) стоимости 
*/

import "ir_CMBase.mac";

PRIVATE MACRO DAN_GetLastDayInMonth( _Date:Date )
   var LastDate, month, year;

   DateSplit(_Date, 0, month, year);

   month = month + 1;
   if( month > 12 )
      month = 1;
      year = year + 1;
   end;

   return Date(1,month,year) - 1;
end;


class (CMBase) CM092 ( _isRecon, _conveyerID, _ir_op : object)
  InitCMBase();

  var m_CounterParty = TArray(); /*массив субъектов контагентов*/
  var m_isInsert     = false;
  m_isRecon     = _isRecon;
  m_conveyerID  = _conveyerID;
  m_ir_op       = _ir_op;
  m_MessageID   = REPOS_CM092;

  macro addCMAll(ir_generalinf:TRecHandler,
                 TradeRepository:TRecHandler,
                 Party1:TRecHandler,
                 Party2:TRecHandler,
                 Sender:TRecHandler,
                 cm:TRecHandler,
                 GrDealID:integer, 
                 TemplNum:integer,
                 DealParmForReport:variant)
    arrsize = m_GeneralInfArr.size;
    if( ((m_ir_op.rec.Setting_Date_Select_MP == IR_SENDING_BILL_MESSAGESMP_LAST_DAT_MONTH) and (arrsize == 0)) or 
        (m_ir_op.rec.Setting_Date_Select_MP == IR_SENDING_BILL_MESSAGESMP_EVENT_DATE) )
    m_GeneralInfArr[arrsize] = TRecHandler("ir_generalinf.dbt");
    copy(m_GeneralInfArr[arrsize], ir_generalinf);
    m_RepActionArr[arrsize] = GetReportAction( TemplNum );
  
    addRepAccGrDoc(GrDealID);

    arrsize = m_PartyArr.size;
    m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        TradeRepository.rec.PartyType = "TradeRepository";
    copy(m_PartyArr[arrsize], TradeRepository);
    
    arrsize = m_PartyArr.size;
    m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        Party1.rec.PartyType= "Party1";
    copy(m_PartyArr[arrsize], Party1);
    
    arrsize = m_PartyArr.size;
    m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        Party2.rec.PartyType= "Party2";
    copy(m_PartyArr[arrsize], Party2);
    
    arrsize = m_PartyArr.size;
    m_PartyArr[arrsize] = TRecHandler("ir_party.dbt");
        Sender.rec.PartyType= "Sender";
    copy(m_PartyArr[arrsize], Sender);
    else
        if (ir_generalinf.rec.RStatus == 2) //На случай если по текущему последующему ошибка, то поправим статус в сводном
          if (m_GeneralInfArr.size > 0)
            m_GeneralInfArr[0].rec.RStatus = ir_generalinf.rec.RStatus;
            m_GeneralInfArr[0].rec.RStatusName = ir_generalinf.rec.RStatusName;
          end;
        end;
    end;
    
    arrsize = m_cmArr.size;
    m_cmArr[arrsize] = TRecHandler("ir_cm092.dbt");
    copy(m_cmArr[arrsize], cm);
    
    m_cmGrDocArr[arrsize] = TRecHandler("dlgrdoc.dbt");
    m_cmGrDocArr[arrsize].Clear();
    m_cmGrDocArr[arrsize].rec.GrDealID= GrDealID;
    m_cmGrDocArr[arrsize].rec.DocKind = REPOS_CM092;
    m_cmGrDocArr[arrsize].rec.ServDocKind = m_ir_op.rec.DocKind;
    m_cmGrDocArr[arrsize].rec.ServDocID   = m_ir_op.rec.ID;
    
    m_RepDealParmArr[arrsize] = DealParmForReport;
  end;

  macro insertAll
    var ir_generalinfCache092 = RsbSQLInsert("ir_generalinf.dbt");
    var ir_cm092Cache = RsbSQLInsert("ir_cm092.dbt");
    var m_ReconMsgID = 0;
    var realIDs = TArray();
    var err = 0;
    var i = 0;

    if(m_isInsert)
      return err;      
    end;
    /* Вставляем СРС 092 и обновляем привязки к строке графика */
    ir_generalinfCache092.AddRecordArray(m_GeneralInfArr);
    ir_generalinfCache092.AddReturning("t_InternalMessageID", V_INTEGER);
    
    if( not ir_generalinfCache092.insert() )
        err = 1;
    RepErrArr[RepErrArr.size] = CIR_RepAccRepErr("", "", "Ошибка при сохранении данных сообщения", "", 0);
    else
        ir_generalinfCache092.GetReturning(realIDs);
        i = 0;
        while( i < m_GeneralInfArr.size )
            m_GeneralInfArr[i].rec.InternalMessageID = realIDs[i];
            m_RepAccGrDocArr[i].rec.DocID = realIDs[i];
            
            m_PartyArr[i*4].rec.InternalMessageID   = realIDs[i];
            m_PartyArr[i*4+1].rec.InternalMessageID = realIDs[i];
            m_PartyArr[i*4+2].rec.InternalMessageID = realIDs[i];
            m_PartyArr[i*4+3].rec.InternalMessageID = realIDs[i];
            
            var l_092 = 0;
            while( l_092 < m_cmArr.size )
                m_cmArr[l_092].rec.InternalMessageID = realIDs[i];
                l_092 = l_092 + 1;
            end;
            
            m_ReconMsgID = realIDs[i];
            
            /* добавить запись в лог о вставке СРС */
            if ( not m_isRecon )
                m_RepDataArr[m_RepDataArr.size] = CIR_RepAccRepParm(
                        m_RepActionArr[i],
                        m_GeneralInfArr[i].rec.DealCode,
                        m_GeneralInfArr[i].rec.MessageType,
                        DL_GetNameAlg(ALG_GENINF_RSTATUS, m_GeneralInfArr[i].rec.RStatus),
                        m_RepDealParmArr[arrsize].DealID, 
                        SQL_ConvTypeInteger(m_RepDealParmArr[arrsize].DealKind));
            end;
            i = i + 1;
        end;
    end;

    if( (not err) and (m_cmArr.size > 0) )
        /* Вставляем cm092 */
        ir_cm092Cache.AddRecordArray(m_cmArr);
        ir_cm092Cache.AddReturning("t_id", V_INTEGER);
        
        if( not ir_cm092Cache.insert() )
            err = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr("", "", "Ошибка при сохранении данных экономических параметров", "", 0);
        else
            realIDs.size = 0;
            ir_cm092Cache.GetReturning(realIDs);
            i = 0;
            var delta092 =  m_cmGrDocArr.size;
            while( i < delta092 )
                m_cmGrDocArr[i].rec.DocID = realIDs[i];
                m_cmGrDocArr[i+delta092] = TRecHandler("dlgrdoc.dbt");
                m_cmGrDocArr[i+delta092].Clear();
                m_cmGrDocArr[i+delta092].rec.GrDealID    = m_cmGrDocArr[i].rec.GrDealID;
                m_cmGrDocArr[i+delta092].rec.DocKind     = REPOS_GENERALINF;
                m_cmGrDocArr[i+delta092].rec.ServDocKind = m_cmGrDocArr[i].rec.ServDocKind;
                m_cmGrDocArr[i+delta092].rec.ServDocID   = m_cmGrDocArr[i].rec.ServDocID;
                m_cmGrDocArr[i+delta092].rec.DocID       = m_GeneralInfArr[0].rec.InternalMessageID;

                i = i + 1;
            end;
        end;
    end;

    // Вставляем субъектов
    err = insertParty;

    // Вставляем привязки
    err = insertDlgrdocCache;

    if(not err)
      m_isInsert = true;
    end;

    return err;
  end;

  macro ЗаполнениеCM (m_cm092:@TrecHandler,
                      DataSet, 
                      GenAgr,
                      first,
                      error,
                      field,
                      FD,
                      ir_generalinf:@TrecHandler,
                      i,
                      DealParmForReport)
    var stat = 0;
    var query, cmd, data;
    var CSA = GetCSA(DataSet.DocID);
    var BankAmount = $0, PartyAmount = $0, rateFirst, rateSecond;
    var accBuf = TRecHandler("account.dbt");
    var minusRest = $0, plusRest = $0;
    
    if(CSA.rec.PayMsgSender == 2)
        ir_generalinf.rec.reportParty = "All";
        m_cm092.rec.reportpartyid = 3;
        m_cm092.rec.reportparty = "All";
    elif(GenAgr.Side1 == 1)
        ir_generalinf.rec.reportParty = "Party1";
        m_cm092.rec.reportpartyid = 1;
        m_cm092.rec.reportparty = "Party1";
    else
        ir_generalinf.rec.reportParty = "Party2";  
        m_cm092.rec.reportpartyid = 2;
        m_cm092.rec.reportparty = "Party2";
    end;

    query = " select csapaym.*  ";
    query = query + " from DDVCSAPM_DBT csapaym, DOPRSTEP_DBT oprstep, DDLGRACC_DBT gracc ";
    query = query + " where gracc.t_grdealid =  " + DataSet.GrDealID;
    query = query + " and gracc.t_accnum =  " + DLGR_ACCKIND_REPOSITORY;
    query = query + " and gracc.t_state =  " + DLGRACC_STATE_PLAN;
    query = query + " and oprstep.t_id_operation = gracc.t_id_operation ";
    query = query + " and oprstep.t_id_step = gracc.t_id_step ";
    query = query + " and csapaym.t_pmid = oprstep.t_servdocid ";
    cmd = DL_RSDCommand();
    data = cmd.Execute(query);

    if(data.MoveNext())
        m_cm092.rec.ValuationDate = data.date;
/*DAN*/// m_cm092.rec.ValuationDate = DAN_GetLastDayInMonth(date(DataSet.PlanDate));
        m_cm092.rec.TransOrRefId_CSAmount = 0; //вторая очередь
        m_cm092.rec.TransOrRef_CSAmount = ""; //вторая очередь
        m_cm092.rec.TransEeRefId_CSAmount = 0; //вторая очередь
        m_cm092.rec.TransEeRef_CSAmount = ""; //вторая очередь
        m_cm092.rec.CSAmount =  0;  //вторая очередь
        m_cm092.rec.CSAmountCurrencyId =  -1;  //вторая очередь
        m_cm092.rec.CSAmountCurrency =  "";  //вторая очередь

        //316/315
        if (FD.IsExistAccount("-МС", null, true, null, accBuf, null, SQL_ConvTypeDate(data.date), data.SumPayCur))
            minusRest = abs(DL_GetRestAccount( accBuf.rec, SQL_ConvTypeDate(data.date)));
        end;

        //323/222
        if (FD.IsExistAccount("+МС", null, true, null, accBuf, null, SQL_ConvTypeDate(data.date), data.SumPayCur))
            plusRest = abs(DL_GetRestAccount(accBuf.rec, SQL_ConvTypeDate(data.date)));
        end;
        
        if(CSA.rec.BankRecipient == SET_CHAR)
            m_cm092.rec.CSBalance = minusRest - plusRest;
        elif(CSA.rec.PartyRecipient == SET_CHAR)
            m_cm092.rec.CSBalance = plusRest - minusRest;
        end;
 
  

    
        m_cm092.rec.CSBalanceCurrencyId = data.SumPayCur;
        m_cm092.rec.CSBalanceCurrency = GetFICode(data.SumPayCur, null, FICK_ISOSTRING);
        
        if(((CSA.rec.BankRecipient == SET_CHAR) and (GenAgr.Side1 == 1)) or
           ((CSA.rec.PartyRecipient == SET_CHAR) and (GenAgr.Side2 == 1)) )
                m_cm092.rec.TransOrRefId_CSBalance = 2;
                m_cm092.rec.TransOrRef_CSBalance = "Party2";
                m_cm092.rec.TransEeRefId_CSBalance = 1;
                m_cm092.rec.TransEeRef_CSBalance = "Party1";
            else
                m_cm092.rec.TransOrRefId_CSBalance = 1;
                m_cm092.rec.TransOrRef_CSBalance = "Party1";
                m_cm092.rec.TransEeRefId_CSBalance = 2;
                m_cm092.rec.TransEeRef_CSBalance = "Party2";
            end;

        DV_SmartConvertSumDbl(rateSecond, 1, data.date, CSA.rec.MoveMinPayCurr, CSA.rec.BankMinPayCurr, false);
        if(rateSecond == 0)
            stat = 1;
            RepErrArr[RepErrArr.size] = CIR_RepAccRepErr(DealParmForReport.DealID, DealParmForReport.DealKind, DataSet.DealCode, ir_generalinf.rec.MessageType, GetCurrencyConvertErrorMsg(CSA.rec.MoveMinPayCurr, CSA.rec.BankMinPayCurr, data.date), "IndepAmount", GetReportAction(DataSet.DealCode));
        end;
        BankAmount = CSA.rec.FirstBankMarginSum;
        PartyAmount = round(CSA.rec.FirstPartyMarginSum * rateSecond, 2);
/*        
        if((BankAmount - PartyAmount) > 0)
            if(GenAgr.Side1 == 1) //наш банк
                m_cm092.rec.TransOrRefId_IndepAmount = 2;
                m_cm092.rec.TransOrRef_IndepAmount = "Party2";
                m_cm092.rec.TransEeRefId_IndepAmount = 1;
                m_cm092.rec.transeetef_IndepAmount = "Party1";
            else
                m_cm092.rec.TransOrRefId_IndepAmount = 1;
                m_cm092.rec.TransOrRef_IndepAmount = "Party1";
                m_cm092.rec.TransEeRefId_IndepAmount = 2;
                m_cm092.rec.transeetef_IndepAmount = "Party2";
            end;
        else
            if(GenAgr.Side1 == 1) //наш банк
                m_cm092.rec.TransOrRefId_IndepAmount = 1;
                m_cm092.rec.TransOrRef_IndepAmount = "Party1";
                m_cm092.rec.TransEeRefId_IndepAmount = 2;
                m_cm092.rec.transeetef_IndepAmount = "Party2";
            else
                m_cm092.rec.TransOrRefId_IndepAmount = 2;
                m_cm092.rec.TransOrRef_IndepAmount = "Party2";
                m_cm092.rec.TransEeRefId_IndepAmount = 1;
                m_cm092.rec.transeetef_IndepAmount = "Party1";
            end;
        end;
*/


        if(((CSA.rec.BankRecipient == SET_CHAR) and (GenAgr.Side1 == 1)) or
           ((CSA.rec.PartyRecipient == SET_CHAR) and (GenAgr.Side2 == 1)) )
                m_cm092.rec.TransOrRefId_IndepAmount = 2;
                m_cm092.rec.TransOrRef_IndepAmount = "Party2";
                m_cm092.rec.TransEeRefId_IndepAmount = 1;
                m_cm092.rec.transeetef_IndepAmount = "Party1";
         else
                m_cm092.rec.TransOrRefId_IndepAmount = 1;
                m_cm092.rec.TransOrRef_IndepAmount = "Party1";
                m_cm092.rec.TransEeRefId_IndepAmount = 2;
                m_cm092.rec.transeetef_IndepAmount = "Party2";
         end;
       
        m_cm092.rec.IndepAmount = abs(BankAmount - PartyAmount);
        m_cm092.rec.IndepAmountCurrencyId = CSA.rec.BankMinPayCurr;
        m_cm092.rec.IndepAmountCurrency = GetFICode(CSA.rec.BankMinPayCurr, null, FICK_ISOSTRING);

        m_cm092.rec.TransOrRefId_CSObligations = m_cm092.rec.TransOrRefId_CSBalance;
        m_cm092.rec.TransOrRef_CSObligations = m_cm092.rec.TransOrRef_CSBalance;
        m_cm092.rec.TransEeRefId_CSObligations = m_cm092.rec.TransEeRefId_CSBalance;
        m_cm092.rec.TransEeRef_CSObligations = m_cm092.rec.TransEeRef_CSBalance;

        if(((data.Direction == 1) and (CSA.rec.PartyRecipient == SET_CHAR)) or 
           ((data.Direction == 0) and (CSA.rec.BankRecipient == SET_CHAR)))
            m_cm092.rec.CSObligations = data.SumPay;
        else
            m_cm092.rec.CSObligations = -data.SumPay;
        end;
        
        m_cm092.rec.CSObligationsCurrencyId = data.SumPayCur;
        m_cm092.rec.CSObligationsCurrecny = GetFICode(data.SumPayCur, null, FICK_ISOSTRING);
        m_cm092.rec.DealID = CSA.rec.csaid;
        m_cm092.rec.BofficeKind = DV_CSA;
    end;
    
    return stat;
  end;
end;