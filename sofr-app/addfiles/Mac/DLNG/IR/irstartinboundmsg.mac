/*                           
$Name:        irstartinboundmsg.mac
$Module:      ê•ØÆß®‚†‡®©
$Description: ØÆ´„Á•≠®• ¢ÂÆ§ÔÈ®Â ·ÆÆ°È•≠®©
*/
import BankInter, XmlRpcInter, "dllog_xml.mac", "DlReport_h.mac", "dldlngfun.mac";


//™´†·· · §†≠≠Î¨® §´Ô ·‚‡Æ™® Ø‡Æ‚Æ™Æ´†
class CIR_InRepParm( _MesType:string, _MesCodeIN:string, _MesCodeOUT:string, _CodeUTI:string, _MesProduct:string, _CauseErr:string )
 var MesType    = _MesType;      //Ç®§ ¢ÂÆ§ÔÈ•£Æ ·ÆÆ°È•≠®Ô	
 var MesCodeIN  = _MesCodeIN;    //äÆ§ ¢ÂÆ§ÔÈ•£Æ ·ÆÆ°È•≠®Ô
 var MesCodeOUT = _MesCodeOUT;   //äÆ§ ®·ÂÆ§Ô-È•£Æ ·ÆÆ°È•≠®Ô
 var CodeUTI    = _CodeUTI;      //UTI ·§•´™®
 var MesProduct = _MesProduct;   //è‡Æ§„™‚ ¢ XML 
 var CauseErr   = _CauseErr;     //è‡®Á®≠† ÆË®°™®
end;

private var RepErrArr = TArray(); //¨†··®¢ ÆË®°Æ™


CLASS (DL_LOG_FROM_XML) LOADIN_LOG_FROM_XML(pDocKind:integer, pID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var DealData:CIR_InRepParm;
     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESTYPE",    V_STRING, DealData.MesType) == false)              
        end;                                                                                                          
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESCODEIN",  V_STRING, DealData.MesCodeIN) == false)            
        end;                                                                                                          
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESCODEOUT", V_STRING, DealData.MesCodeOUT) == false)           
        end;                                                                                                          
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODEUTI",    V_STRING, DealData.CodeUTI) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESPRODUCT", V_STRING, DealData.MesProduct) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CAUSEERR",   V_STRING, DealData.CauseErr) == false)
        end;

        return DealData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pID, pType, pOnlyLastReport);

END;
 
PRIVATE CLASS (DL_LOG_FROM_XML) PROCIN_LOG_FROM_XML(pDocKind:integer, pID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var DealData:CIR_InRepParm;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESTYPE",    V_STRING, DealData.MesType) == false)              
        end;                                                                                                          
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESCODEIN",  V_STRING, DealData.MesCodeIN) == false)            
        end;                                                                                                          
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESCODEOUT", V_STRING, DealData.MesCodeOUT) == false)           
        end;                                                                                                          
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODEUTI",    V_STRING, DealData.CodeUTI) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MESPRODUCT", V_STRING, DealData.MesProduct) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CAUSEERR",   V_STRING, DealData.CauseErr) == false)
        end;
        
        return DealData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pID, pType, pOnlyLastReport);

END;


MACRO GetLogDataXML( DocKind:integer, ID:integer, Type:integer, OnlyLastReport:bool )
  var xml_obj = null;

  if( Type == LOG_TYPE_DATA )
     xml_obj = LOADIN_LOG_FROM_XML(DocKind, ID, Type, OnlyLastReport);
  elif(Type == LOG_TYPE_DATA_PROC )
     xml_obj = PROCIN_LOG_FROM_XML(DocKind, ID, Type, OnlyLastReport);
  end;

  return xml_obj;
END;


private var N1RepHeaderStr = "           èêéíéäéã ÇõèéãçÖçàü éèÖêÄñàà éÅêÄÅéíäà ÇïéÑüôàï ëééÅôÖçàâ \n" +
                             "  Ñ†‚† ÆØ•‡†Ê®®: ##########  äÆ§: #########";

private var N1TableHeader = "è‡Æ‚Æ™Æ´ ß†£‡„ß™® ·ÆÆ°È•≠®©\n" +
                            "⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥ Ç®§ ¢ÂÆ- ≥ äÆ§ ¢ÂÆ§ÔÈ•£Æ ≥ äÆ§ ®·ÂÆ§ÔÈ•£Æ ≥                ≥                 ≥                             ≥\n"+
                            "≥  §ÔÈ•£Æ  ≥   ·ÆÆ°È•≠®Ô   ≥   ·ÆÆ°È•≠®Ô    ≥   UTI ·§•´™®   ≥ è‡Æ§„™‚ ¢ XML   ≥        ê•ß„´Ï‚†‚            ≥\n"+
                            "≥ ·ÆÆ°È•≠®Ô≥               ≥                ≥                ≥                 ≥                             ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N2TableHeader = "è‡Æ‚Æ™Æ´ Æ°‡†°Æ‚™® ·ÆÆ°È•≠®©\n" +
                            "⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥ Ç®§ ¢ÂÆ- ≥ äÆ§ ¢ÂÆ§ÔÈ•£Æ ≥ äÆ§ ®·ÂÆ§ÔÈ•£Æ ≥                ≥                 ≥                             ≥\n"+
                            "≥  §ÔÈ•£Æ  ≥   ·ÆÆ°È•≠®Ô   ≥   ·ÆÆ°È•≠®Ô    ≥   UTI ·§•´™®   ≥ è‡Æ§„™‚ ¢ XML   ≥        è‡®Á®≠† ÆË®°™®       ≥\n"+
                            "≥ ·ÆÆ°È•≠®Ô≥               ≥                ≥                ≥                 ≥                             ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N1OprStateMsg = "\n#";
private var N1Count       = "\n          Ç·•£Æ ¢ÂÆ§ÔÈ®Â ·ÆÆ°È•≠®©:  #####"+
                            "\n                ß†£‡„¶•≠≠Æ „·Ø•Ë≠Æ:  #####"+
                            "\n              ß†£‡„¶•≠Æ · ÆË®°™†¨®:  #####";
private var N2Count       = "\n        Ç·•£Æ Æ°‡†°Æ‚†≠Æ ·ÆÆ°È•≠®©:  #####"+
                            "\n                Æ°‡†°Æ‚†≠Æ „·Ø•Ë≠Æ:  #####"+
                            "\n             Æ°‡†°Æ‚†≠Æ · ÆË®°™†¨®:  #####";
private var N1NotExist    = "\n        ç• ≠†©§•≠Î Æ°Í•™‚Î §´Ô ¢ÎØÆ´≠•≠®Ô ÆØ•‡†Ê®®";


private var NFooter = "\n###############################################################\n"+
                      "######################################################################                 ################\n"+
                      "ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ   §†‚†\n"+
                      "                                 îàé                                      ØÆ§Ø®·Ï";

PRIVATE CLASS (DL_CReportTemplate) IR_RepIn_Report( ir_op, Mode, id )
  PRIVATE VAR m_PrintMode;
  PRIVATE VAR m_op = TRecHandler("ir_op");
  PRIVATE VAR m_IsExists = false;
  PRIVATE VAR m_IsExistsErr = false;
  PRIVATE var m_Executer = DepoExecuter( {oper} );
  PRIVATE var m_ID;
  private var SheetName = "è‡Æ‚Æ™Æ´";   

  PRIVATE MACRO PrintMode():INTEGER
     return m_PrintMode;
  END;
  
  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

//////////////////////////////////////////////////////

  PRIVATE MACRO Create()
    var ReportLineData_XML:variant;
    var LoadData:CIR_InRepParm;
    var ProcData:CIR_InRepParm;
    var SheetName = "è‡Æ‚Æ™Æ´";    
    var IsFirst = true;
    var LCount, LCountOK, LCountErr, PCount, PCountOK, PCountErr;
    LCount = LCountOK = LCountErr = PCount = PCountOK = PCountErr = 0;

    SetActiveSheet(SheetName);

    PrintFormatString(N1RepHeaderStr,
                     "N1_OperDate", m_op.rec.Date,
                     "N1_OperCode", m_op.rec.CodeOp
                     );
    CopyAllSheetInTotalBook(SheetName, false, "N1_RepHead", 0, SheetName);
                                               
    // ß†£‡„ß™† ëêë
    ReportLineData_XML = GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA, false);
    ReportLineData_XML.SetReportNumber(0);

    while( ReportLineData_XML.Next )
       m_IsExists = true;

       if( IsFirst )
          CopyAllSheetInTotalBook(SheetName, false, "N1_TableHeader", 1, SheetName);
          RegisterTable( "N1_MainTable", N1TableHeader,
                         "N1_MesType",
                         "N1_MesCodeIN",
                         "N1_MesCodeOUT",
                         "N1_CodeUTI",
                         "N1_MesProduct",
                         "N1_CauseErr"
                       );
          IsFirst = false
       end;
       LoadData = ReportLineData_XML.GetReportLineData();

       if((ValType(LoadData.CauseErr) == V_UNDEF) or (LoadData.CauseErr == "") or (substr(LoadData.CauseErr, 1, 7) == "ëÆß§†≠Æ"))
         LCountOK = LCountOK + 1;
       else
         LCountErr = LCountErr + 1;
       end;
       LCount = LCount + 1;

      var MesID = index(LoadData.CauseErr, "àÑ =");
      if((LoadData.MesType == "RM005") AND (MesID > 0))
        MesID = int(substr(LoadData.CauseErr, MesID + 5));  
        var cmd = RSDCommand("SELECT T_Rstatus FROM dir_generalinf_dbt WHERE T_InternalMessageID = ?");       
        cmd.addParam( "", RSDBP_IN, MesID );
        cmd.execute();
        var DataSet = TRsbDataSet(cmd);
        if( DataSet.moveNext())
          if( DataSet.Rstatus == 8)    // °„§•¨ §Æ°†¢´Ô‚Ï ‚•™·‚ ÆË®°™® ‚Æ´Ï™Æ §´Ô ·ÆÆ°È•≠®© ¢ ·‚†‚„·• "éË®°™† Æ°‡†°Æ‚™®"
            var ReportLineDataProc:variant;
            ReportLineDataProc = GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA_PROC, false);
            ReportLineDataProc.SetReportNumber(0);
            while( ReportLineDataProc.Next )
              ProcData = ReportLineDataProc.GetReportLineData();
              if( ProcData.MesCodeIN == LoadData.MesCodeIN)
                LoadData.CauseErr = LoadData.CauseErr + " " + ProcData.CauseErr;//substr(ProcData.CauseErr, index(ProcData.CauseErr, "ç•Æ°ÂÆ§®¨Æ"));
                LCountOK = LCountOK - 1;
                LCountErr = LCountErr + 1;
                break;
              end;
            end;
          end;
        else
          LoadData.CauseErr = LoadData.CauseErr + " " + "ëêë " + MesID + " „§†´•≠Æ";
        end;        
      end;

       PrintTableLine( "N1_MesType",    LoadData.MesType,     null,
                       "N1_MesCodeIN",  LoadData.MesCodeIN,   null,
                       "N1_MesCodeOUT", LoadData.MesCodeOUT,  null,
                       "N1_CodeUTI",    LoadData.CodeUTI,     null,      
                       "N1_MesProduct", LoadData.MesProduct,  null,   
                       "N1_CauseErr",   LoadData.CauseErr,    null  
                     );
    end;
    var Header = DL_LOG_HEADER_XML(m_op.rec.DocKind).GetHeaderXML();
    if( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);

       PrintFormatString(N1Count,"N1_Count", LCount,"N1_CountOK", LCountOK,"N1_CountErr", LCountErr );
       CopyAllSheetInTotalBook(SheetName, false, "N1_LoadCount", 0, SheetName);
    end;

    var IsExistsProc = false;
    var IsFirstProc  = true;
    var stat = 0;
    // Æ°‡†°Æ‚™† 
    ReportLineData_XML = GetLogDataXML(m_op.rec.DocKind, m_op.rec.ID, LOG_TYPE_DATA_PROC, false);
    ReportLineData_XML.SetReportNumber(0);
    
//    stat = ReportLineData_XML.Next();
    while( ReportLineData_XML.Next )

      IsExistsProc = true;
      if(IsFirstProc)
        CopyAllSheetInTotalBook(SheetName, false, "N2_TableHeader", 1, SheetName);
        RegisterTable( "N2_MainTable", N2TableHeader,
                       "N2_MesType",
                       "N2_MesCodeIN",
                       "N2_MesCodeOUT",
                       "N2_CodeUTI",
                       "N2_MesProduct",
                       "N2_CauseErr"
                  );
          IsFirstProc = false;
        end;
      
        ProcData = ReportLineData_XML.GetReportLineData();
      
        PrintTableLine("N2_MesType",    ProcData.MesType,     null,
                       "N2_MesCodeIN",  ProcData.MesCodeIN,   null,
                       "N2_MesCodeOUT", ProcData.MesCodeOUT,  null,
                       "N2_CodeUTI",    ProcData.CodeUTI,     null,      
                       "N2_MesProduct", ProcData.MesProduct,  null,   
                       "N2_CauseErr",   ProcData.CauseErr,    null  
                     );                               	
        if((ProcData.CauseErr == "") OR (ValType(ProcData.CauseErr) == V_UNDEF))
          PCountOK = PCountOK + 1 ;
        else
          PCountErr = PCountErr + 1 ;
        end;
        PCount = PCount + 1 ;

      end;

   if(IsExistsProc)
      EndTable();
      CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
      PrintFormatString(N2Count,"N2_Count", PCount,"N2_CountOK", PCountOK,"N2_CountErr", PCountErr );
      CopyAllSheetInTotalBook(SheetName, false, "N2_ProcCount", 0, SheetName);
    end;

    if( (not m_IsExists) and (not IsExistsProc) )
      PrintFormatString(N1NotExist);
      CopyAllSheetInTotalBook(SheetName, false, "N1_NotExist", 0, SheetName);

    end;

    PrintFormatString(NFooter,
                     "N1_ExecutorPost", "ëÆ·‚†¢®´ ( " + m_Executer.Post + " ):",
                     "N1_ExecutorName", string( m_Executer.Name ),
                     "N1_ExecuteDate:l",  m_op.rec.Date:f
                     );
    CopyAllSheetInTotalBook( SheetName, false, "N1_Footer", 1, SheetName );
  END;

  m_PrintMode = Mode;
  m_op = ir_op;
  initDL_CReportTemplate( NULL, "Report_RepIn.xls");
END;

private MACRO PrintRepInByXML(op, Mode, id)
  record IrOp("ir_op");
  var recop = TRecHandler("ir_op");
  
  SetBuff(IrOp, op);
    if (id)
    copy(recop, Op);
    else
  copy(recop, IrOp);
    end;
    
  IR_RepIn_Report(recop, Mode, id).Run();
  return true;

END;

MACRO PrintRepInByXMLToExcel( op, id )
  return PrintRepInByXML(op, DL_OUTREPORT_EXCEL);
END;

MACRO PrintRepInByXMLToSTD( op, id )
    return PrintRepInByXML(op, DL_OUTREPORT_STD, id);
END;

macro StartGetIncomingMes( ID )
  var stat = 0;
  var ir_op = TBFile("ir_op.dbt");

  ir_op.rec.ID = ID;
  if( not ir_op.GetEQ() )
    msgbox("éË®°™† ØÆ®·™† ÆØ•‡†Ê®®");
    return 1;
  end;   

  stat = ExecMacroFile("ir_inboundmsg.mac", "ExecuteGetIncomingMes", ir_op);


  return stat;
end;
