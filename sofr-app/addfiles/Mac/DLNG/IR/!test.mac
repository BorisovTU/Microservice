import "dv_grfun.mac", "dv_categ.mac";
var frdate;
const DocKind_Deal = 199;
var stat = GetDate(frdate, "Введите дату отчета");
var  sql = String( 
               "select t2.*   \n"
              ,"  from DDVNLOADFRVAL_DBT t2 left join (select ? as frdate from dual)  p on 1=1   \n"
              ," where t2.t_datefrval =   \n"
              ,"       (select max(t.t_datefrval)   \n"
              ,"          from DDVNLOADFRVAL_DBT t   \n"
              ,"         where trunc(t.t_datefrval,'MM') = trunc(p.frdate,'MM'))   \n"
              ,"   and not exists   \n"
              ," (select 1   \n"
              ,"          from ddlgrdeal_dbt t3   \n"
              ,"         where t3.t_dockind = 199   \n"
              ,"           and t3.t_templnum = 75   \n"
              ,"           and t3.t_plandate = p.frdate   \n"
              ,"           and t3.t_dockind = 199   \n"
              ,"           and t3.t_docid = t2.t_dealid);   \n"
             );
var cmd = RSDCommand(sql);
cmd.addparam("p_date", rsdbp_in,frdate );
var rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
//runscroll(rs);

while (rs.movenext)
  var FD = DVFirstDocNDeal(DL_DVNDEAL, rs.value("t_dealid"));
  InsertGrDealFairValueRevaluation(FD, frdate, DL_DVNDEAL);
end;
