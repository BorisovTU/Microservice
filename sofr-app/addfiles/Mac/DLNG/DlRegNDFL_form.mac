/*
$Name:        DlRegNDFL_form.mac
$Module:      Ценные бумаги
$Description: Форма "Регистр НДФЛ"
*/
import "DlRepForm_h.mac", "globals.mac";

/*Номера полей в форме отчета*/
const PNFLD_REGNDFL_ENDDATE           = 0,
      PNFLD_REGNDFL_INVESTORCODE      = 1,
      PNFLD_REGNDFL_INVESTORNAME      = 2,
      PNFLD_REGNDFL_START_FROM_NUMBER = 3,
      PNFLD_REGNDFL_NUMBER            = 4,
      PNFLD_REGNDFL_PRINTMETHOD       = 5;

CONST PNFLD_NUMBER = 100;

private macro Default(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER,
                      FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
end;

private macro FldProc_StartNumber(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER,
                      FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  if( Cmd == DLG_INIT )                                                                 
     FldShowValue = FldRealValue;                                                                                                
  else  
  FldRealValue = FldShowValue;
  end;                             

  return CM_DEFAULT;
end;

macro FldProc_PrintMethod(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER,
                          FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  FldRealValue = DL_OUTREPORT_EXCEL;
  FldShowValue = "Excel";
  return CM_DEFAULT;
end;

private macro FldProc_CheckBox( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER  
                                                            
  if( Cmd == DLG_INIT )                                                                                                        
     if( FldRealValue == null ) /*инициализация по умолчанию*/                                                                 
        FldRealValue = "";                                                                                                     
     end;                                                                                                                      
     FldShowValue = FldRealValue;                                                                                              
  elif( Cmd == DLG_CHANGEVALUE )                                                                                               
     FldRealValue = FldShowValue;                                                                                              
  elif( Cmd == DLG_KEY )                                                                                                       
     if( Key == KEY_SPACE )                                                                                                    
        if( FldRealValue != "X" )                                                                                              
           FldShowValue = FldRealValue = "X";                                                                                  
        else                                                                                                                   
           FldShowValue = FldRealValue = "";                                                                                   
        end;                                                                                                                   
     end;                                                            
  end;                                                               
 
  if( FldRealValue == "" ) 
     DisableFields(pThis.Data(), PNFLD_REGNDFL_NUMBER );
  else
     EnableFields(pThis.Data(), PNFLD_REGNDFL_NUMBER );
  end;
                                                                                                                       
  return CM_DEFAULT;                                                                                                           
end;                                                                                                                           

class (DL_CPanel) RegNDFL_Panel()

  private macro Init()
    var Year, BegDate, RepDate, StartNum = 1;

    DateSplit({curdate}, null, null, Year);

    RepDate = date(31, 12, Year-1);
                                                                        
    AddFieldProc(0, PNFLD_REGNDFL_ENDDATE, DL_PNFLD_ENDDATE,
                 @DL_FldProc_EndDate, RepDate);
    AddFieldProc(0, PNFLD_REGNDFL_INVESTORCODE, DL_PNFLD_CLIENT_SDD_CODE,
                 @DL_FldProc_Client_SDD_Code);
    AddFieldProc(0, PNFLD_REGNDFL_INVESTORNAME, DL_PNFLD_CLIENT_SDD_NAME,
                 @Default);
    AddFieldProc(0, PNFLD_REGNDFL_START_FROM_NUMBER, DL_PNFLD_CHECKBOX,
                 @FldProc_CheckBox);
    AddFieldProc(0, PNFLD_REGNDFL_NUMBER, PNFLD_NUMBER,
                 @FldProc_StartNumber, StartNum);
    AddFieldProc(0, PNFLD_REGNDFL_PRINTMETHOD, DL_PNFLD_PRINTMETHOD, 
                 @FldProc_PrintMethod, DL_OUTREPORT_EXCEL);

    DisableFields(Data(), PNFLD_REGNDFL_PRINTMETHOD);
  end;

  private macro Check():BOOL   
    return true;
  end;

  initDL_CPanel("sp_rep.lbr", "REGNDFL"); 
end;
