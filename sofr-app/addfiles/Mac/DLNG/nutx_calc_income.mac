/*
    $Name:        nutx_calc_income.mac
    $Module:      Ÿ¤à® Securities
    $Description: Žâç¥â "®àãç¥­¨ï ª«¨¥­â  ­  ¯¥à¥¢®¤ ¤/á ¬¥¦¤ã á¥ªâ®à ¬¨ – ¡¨à¦¨" (Ž¡é¨© ¤«ï Ž – ¨ ˆ)
*/
IMPORT "nutx_calc_income_Form.mac","DLReport_h.mac";
IMPORT SecInter;
PRIVATE VAR TableHeader =
" áç¥â ¤®å®¤ , ¯®«ãç¥­­®£® ­¥à¥§¨¤¥­â ¬¨ ®â ®¯¥à æ¨© á æ¥­­ë¬¨ ¡ã¬ £ ¬¨ §  ¯¥à¨®¤ á ########## ¯® ########## \n"+
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"
"³                                                                                                                   ³                      ³         ³                                                                                                                                                                                                                    ³                ³         ³         ³                ³                      ³                      ³\n"+
"³                                                                                                                   ³                      ³         ÃÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ´                ³         ³         ³                ³                      ³                      ³\n"+
"³                                                                                                                   ³                      ³  ‚ «îâ  ³            ³            ³          ³                 ³                 ³                 ³                 ³            ³” ªâ¨ç¥áª ï³„ â  ¯®£ è¥­¨ï³      ‘ã¬¬       ³   Š„ ­  ¤ âã   ³     ‘ã¬¬        ³  ‘à®ª   ³ ¥§ã«ìâ â ®â   ³ áç¥â­ ï³ Šãàá ­  ³    ¥§ã«ìâ â   ³                      ³                      ³\n"+
"³                                               ¨¬¥­®¢ ­¨¥ –                                                      ³       ’¨¯ –         ³ ¯« â¥¦  ³    „ â     ³            ³   –¥­    ³   Š„ ­  ¤ âã   ³ ‘ã¬¬  ¯®«ãç¥­­ëå³                 ³                 ³    „ â     ³    æ¥­    ³ªã¯®­  ¨ (¨«¨)³    ªã¯®­  ¨«¨   ³    ®¡à â­®©     ³   ã¯« ç¥­­ëå    ³¤¥©áâ¢¨ï ³    á¤¥«ª¨,     ³% áâ ¢ª  ³   ¤ âã  ³   ®â á¤¥«ª¨,   ³    ®¬¥à á¤¥«ª¨      ³    ®¬¥à á¤¥«ª¨      ³\n"+
"³                                                                                                                   ³                      ³         ³  ¯à®¤ ¦¨   ³   Š®«-¢®   ³à¥ «¨§ æ¨¨³     ¯à®¤ ¦¨     ³ ¤¥­¥¦­ëå áà¥¤áâ¢³   Š®¬. ¡¨à¦¨    ³   Š®¬. ¡à®ª¥à   ³  ¯à®¤ ¦¨   ³  ®¡à â­®© ³  ç áâ¨ç­®£®  ³    ç áâ¨ç­®£®   ³    ¯®ªã¯ª¨      ³    ¤¥­¥¦­ëå     ³¤®£®¢®à ,³    ¢ «îâ       ³         ³  ¢ë¢®¤  ³     àã¡«¨      ³    ¯¥à¢®© ç áâ¨      ³    ¢â®à®© ç áâ¨      ³\n"+
"³                                                                                                                   ³                      ³         ³ (I ç áâì)  ³            ³ (I ç áâì)³    (I ç áâì)    ³                 ³                 ³                 ³ (II ç áâì) ³  ¯®ªã¯ª¨  ³  ¯®£ è¥­¨ï   ³    ¯®£ è¥­¨ï    ³   (II ç áâì)    ³    áà¥¤áâ¢      ³  ¤­¥©   ³                ³         ³         ³                ³                      ³                      ³\n"+
"³                                                                                                                   ³                      ³         ³            ³            ³          ³                 ³                 ³                 ³                 ³            ³ (II ç áâì)³   ­®¬¨­ «    ³   ¯®«ãç¥­­®£®   ³                 ³                 ³         ³                ³         ³         ³                ³                      ³                      ³\n"+
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n"+
"³                                                    1                                                              ³          2           ³    3    ³      4     ³      5     ³    6     ³        7        ³        8        ³        9        ³       10        ³     11     ³    12     ³     13       ³       14        ³       15        ³       16        ³   17    ³       18       ³   19    ³   20    ³       21       ³         22           ³         23           ³\n"+
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n";


MACRO COD_VAl(FIID)
    var result;
    var query  = RSDCommand("select RSB_SECUR.GetDealFICcy("+string(FIID)+")CurPay from DUAL");
    query.execute();
    var DataSet = TRsbDataSet(query);
    if( DataSet.MoveNext() )
        result=DataSet.CurPay;
    end;
    return result;
    
END;

// ¡®à ¤ ­­ëå ¤«ï § ¯®«­¥­¨ï å¥¤¥à  ­  ¢á¥å âà¥å áâà ­¨æ å ®âç¥â 
PRIVATE MACRO GenHeadCont(id,account:@string,contract:@string,client:@string,Contracts)
    var query,cmd,DataSet;
    var pt="";
    account="";
    contract="";
    client="";
    Contracts.size=0;
    query =  "SELECT pt1.t_ShortName,"
            +"       pt1.t_PartyID,"
            +"       pt1.T_NUMBER,"
            +"       pt1.t_id,"
            +"       pt2.T_ACCOUNT"
            +"  FROM (SELECT prt.t_ShortName,"
            +"               prt.t_PartyID,"
            +"               CONTR.T_NUMBER,"
            +"               contr.t_id"
            +"          FROM dparty_dbt prt, dsfcontr_dbt contr"
            +"         WHERE prt.t_PartyID = "+string(id)+" AND CONTR.T_PARTYID = prt.t_PartyID) pt1"
            +"       FULL OUTER JOIN"
            +"       (SELECT AC.T_ACCOUNT, CONTR1.T_ID"
            +"          FROM daccount_dbt ac, dsfcontr_dbt contr1"
            +"         WHERE     AC.T_ACCOUNT LIKE ('306%' || CONTR1.T_ACCCODE)"
            +"               AND ac.t_client = CONTR1.T_PARTYID"
            +"               AND CONTR1.T_PARTYID = "+string(id)+") pt2"
            +"          ON pt1.t_id = pt2.t_id";
    cmd = DL_RSDCommand(query);
    DataSet = cmd.Execute();
    var number,oldnumber;
    while(DataSet.MoveNext())
        number=DataSet.T_NUMBER;
        if(client=="")
            client=DataSet.t_ShortName;
        end;
        account=account+IIF(DataSet.account,pt+DataSet.account,"");
        if(number!=oldnumber)
            contract=contract+IIF(DataSet.T_NUMBER,pt+DataSet.T_NUMBER,"");
            Contracts[Contracts.size()]=DataSet.t_id;
        end;
        oldnumber=number;
        pt=", ";
    end;

    
END;


//„ ­­ë¥ ¤«ï â ¡«¨æë ‹
PRIVATE MACRO GenTableRL(id,begD,endD,®¡«¨£ æ¨¨: bool)
    var Data ;
    if (®¡«¨£ æ¨¨)// ¤«ï ®¡«¨£ æ¨© (®è¨¡®ª ­¥ ¤®«¦­® ¡ëâì)
        data="SELECT DISTINCT tick.t_pfi,"
            +"                tick.t_dealcode DealSell,"
            +"                rsb_rep_fi.get_finame (tick.t_pfi) SecName,"
            +"                AVR.T_DEFINITION SecType,"
            +"                LEG.T_PRINCIPAL Qnty,"
            +"                LEG.t_cfi cfi,"
            +"                RSB_SECUR.GetDealFICcy (LEG.t_cfi) CurPay,"
            +"                TICK.T_DEALDATE Dsell,"
            +"                RSB_FIINSTR.CONVSUM (1,0,"
            +"                                     LEG.t_cfi,"
            +"                                     TICK.T_DEALDATE,"
            +"                                     2)"
            +"                   CourseOut,"
            +"                leg.t_nkd NKDSell"
            +"  FROM davrkinds_dbt avr,"
            +"       dfininstr_dbt fi,"
            +"       ddl_tick_dbt tick,"
            +"       ddl_leg_dbt leg"
            +" WHERE     TICK.T_CLIENTID = "+string(id)    
            +"       AND TICK.T_DEALDATE BETWEEN TO_DATE ('"+string(begD)+"', 'dd.mm.yyyy')"
            +"                               AND TO_DATE ('"+string(endD)+"', 'dd.mm.yyyy')"
            +"       AND AVR.T_AVOIRKIND = FI.T_AVOIRKIND"
            +"       AND rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND) = 17"
            +"       AND fi.t_fiid = tick.t_pfi"
            +"       AND LEG.T_DEALID = tick.t_dealid"
            +"       AND RSB_SECUR.IsBuy (RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0"
            +"       and RSB_SECUR.DealIsRepo(tick.t_DealID) = 0";
    else //„«ï  ªæ¨© ¨§ â ¡«¨æë á¢ï§¥© nutxlnk (¢ § ¯à®á¥ ¢®§¬®¦­ë ®è¨¡ª¨)
        data="SELECT DISTINCT"  
            +"       LNK.T_FIID,"
            +"       rsb_rep_fi.get_finame (LNK.T_FIID) SecName,"
            +"       AVR.T_DEFINITION SecType,"
            +"       LOTB.T_DEALCODE DealBuy,"
            +"       DECODE (LOTS.T_TYPE, 1, LOTS.T_DEALCODE, LOTS.T_REALID) DealSell,"
            +"       LNK.T_AMOUNT Qnty,"
            +"       LEGS.t_cfi cfi,"
            +"       RSB_SECUR.GetDealFICcy (LEGS.t_cfi) CurPay,"
            +"       RSB_FIINSTR.CONVSUM (1,0,LEGS.t_cfi,TICKS.T_DEALDATE,2)  CourseOut,"
            +"       legB.t_nkd NKDBuy,"
            +"       LEGB.T_PRICE PriceBuy,"
            +"       TICKB.T_DEALDATE Dbuy,"
            +"       LEGB.T_COST MainBuy,"
            +"       RSB_BRKREP.GETBROKERCOMISSSUM (TICKB.T_BOFFICEKIND, tickb.t_dealid, 1)"
            +"          ComBrokBuy,"
            +"       RSB_BRKREP.GETMARKETCOMISSSUM (TICKB.T_BOFFICEKIND,"
            +"                                      tickb.t_dealid,1,  TICKb.T_MARKETID)ComExchBuy,"
            +"       LEGS.T_PRICE PriceSell,"
            +"       TICKS.T_DEALDATE Dsell,"
            +"       LEGS.T_COST MainSell,"
            +"       legs.t_nkd NKDSell,"
            +"       RSB_BRKREP.GETBROKERCOMISSSUM (TICKS.T_BOFFICEKIND, tickS.t_dealid, 1)"
            +"          ComBrokSell,"
            +"       RSB_BRKREP.GETMARKETCOMISSSUM (TICKS.T_BOFFICEKIND,tickS.t_dealid,"
            +"                                      1,TICKS.T_MARKETID) ComExchSell"
            +"  FROM dnutxlnk_dbt lnk,"
            +"       davrkinds_dbt avr,"
            +"       dfininstr_dbt fi,"
            +"       dnutxlot_dbt lotB,"
            +"       dnutxlot_dbt lotS,"
            +"       ddl_tick_dbt tickS,"
            +"       ddl_leg_dbt legS,"
            +"       ddl_tick_dbt tickB,"
            +"       ddl_leg_dbt legB"
            +" WHERE LNK.T_CLIENT="+string(id)    
            +"       AND LNK.T_DATE BETWEEN TO_DATE ('"+string(begD)+"', 'dd.mm.yyyy')"
            +"                          AND TO_DATE ('"+string(endD)+"', 'dd.mm.yyyy')"
            +"       AND AVR.T_AVOIRKIND ="
            +"              rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND)"
            +"       AND rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND) IN (16, 20)"
            +"       AND fi.t_fiid = LNK.T_FIID"
            +"       AND LNK.T_BUYID = LOTB.T_ID"
            +"       AND LNK.T_SALEID = LOTS.T_ID"
            +"       AND LEGS.T_DEALID = LOTS.T_DOCID"
            +"       AND LEGS.T_DEALID = tickS.t_dealid"
            +"       AND LEGB.T_DEALID = LOTB.T_DOCID"
            +"       AND LEGB.T_DEALID = tickB.t_dealid"
            +"       AND LNK.T_TYPE IN (1,2,3,4,5,11,13)"
            +"       AND NOT EXISTS"
            +"              (SELECT 1 FROM DUAL WHERE lnk.t_type IN (11, 13) AND LOTB.T_TYPE > 1)"
            +"and RSI_NUTX.GETNUTAXGROUP(LNK.T_FIID, LNK.T_DATE)in (4,5)"
    end;
    return Data;
END;  

//„ ­­ë¥ ¤«ï â ¡«¨æë ‚Š
PRIVATE MACRO GenTableBK(id,begD,endD)
    var Data  =  "SELECT tick.t_dealcode,"
                +"       rsb_rep_fi.get_finame (tick.t_pfi) SecName,"
                +"       AVR.T_DEFINITION SecType,"
                +"       LEG.T_PRINCIPAL Qnty,"
                +"       LEG.t_cfi cfi,"
                +"       RSB_SECUR.GetDealFICcy (LEG.t_cfi) CurPay,"
                +"       TICK.T_DEALDATE Doper,"
                +"       LEG.T_TOTALCOST SumExp,"
                +"       RSB_FIINSTR.CONVSUM (1,0,LEG.t_cfi,TICK.T_DEALDATE,2) CourseOut"
                +"  FROM DDL_TICK_DBT tick,"
                +"       dfininstr_dbt fi,"
                +"       davrkinds_dbt avr,"
                +"       ddl_leg_dbt leg"
                +" WHERE     TICK.T_CLIENTID = "+string(id)
                +"       AND TICK.T_BOFFICEKIND = 117"
                +"       AND FI.T_FIID = TICK.T_PFI"
                +"       AND RSB_SECUR.IsTaxResident (FI.T_ISSUER,"
                +"                                    TO_DATE ('"+string(endD)+"', 'dd.mm.yyyy')) = 1"
                +"       AND TICK.T_DEALDATE BETWEEN TO_DATE ('"+string(begD)+"', 'dd.mm.yyyy')"
                +"                               AND TO_DATE ('"+string(endD)+"', 'dd.mm.yyyy')"
                +"       AND AVR.T_AVOIRKIND ="
                +"              DECODE (rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND),"
                +"                      17, FI.T_AVOIRKIND,"
                +"                      rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND))"
                +"       AND AVR.T_FI_KIND = 2"
                +"       AND LEG.T_DEALID = TICK.T_DEALID"
                +" UNION ALL "
                +" select tick.t_dealcode, "
                +"       rsb_rep_fi.get_finame (tick.t_pfi) SecName, "
                +"       AVR.T_DEFINITION SecType, "
                +"       LEG.T_PRINCIPAL Qnty, "
                +"       LEG.t_cfi cfi, "
                +"       RSB_SECUR.GetDealFICcy (LEG.t_cfi) CurPay, "
                +"       TICK.T_DEALDATE Doper, "
                +"       LEG.T_TOTALCOST SumExp, "
                +"       RSB_FIINSTR.CONVSUM (1, 0, LEG.t_cfi, TICK.T_DEALDATE, 2) CourseOut "
                +"        "
                +"  from DDL_TICK_DBT tick, dnutxobj_dbt nptx, dfininstr_dbt fi, davrkinds_dbt avr, ddl_leg_dbt leg "
                +"   "
                +" where  "
                +"    tick.t_dealid = nptx.t_analitic1  "
                +" and nptx.t_date >= TO_DATE('"+string(begD)+"', 'DD-MM-YYYY') "
                +" and nptx.t_date <= TO_DATE('"+string(endD)+"', 'DD-MM-YYYY') "
                +" and nptx.t_client = " + string(id)
                +" AND FI.T_FIID = TICK.T_PFI "
                +" AND TICK.T_DEALDATE BETWEEN TO_DATE ('"+string(begD)+"', 'dd.mm.yyyy')     "
                +"                        AND TO_DATE ('"+string(endD)+"', 'dd.mm.yyyy')        "
                +" AND AVR.T_AVOIRKIND = DECODE (rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND), "
                +"                              17, "
                +"                              FI.T_AVOIRKIND, "
                +"                              rsb_fiinstr.FI_AvrKindsGetRoot (2,FI.T_AVOIRKIND))        "
                +" AND AVR.T_FI_KIND = 2        "
                +" AND LEG.T_DEALID = TICK.T_DEALID";
    return Data;
END;    

//„ ­­ë¥ ¤«ï â ¡«¨æë –
PRIVATE MACRO GenTableCB(id,begD,endD)
    var Data  =  "SELECT k1.*,"
                +"       k1.TaxBaseRub / k2.TaxBaseRub TaxRate,"
                +"       k1.TaxBaseRub / k2.TaxBaseRub * k1.TaxBaseRub TaxRub"
                +"  FROM (SELECT KIND.T_CODE IncomeCode,"
                +"               KIND.T_NAME CodeType,"
                +"               RSB_SECUR.GetDealFICcy (obj.t_cur) Cur,"
                +"               OBJ.T_SUM TaxBaseCur,"
                +"               OBJ.T_SUM0 TaxBaseRub,"
                +"               RSB_FIINSTR.CONVSUM (1,obj.t_cur,0,'"+string({curdate})+"',2) CourseOut,"
                +"               obj.t_level,"
                +"               OBJ.T_ANALITIC1"
                +"          FROM dnutxobj_dbt obj, dnutxkind_dbt kind"
                +"         WHERE     obj.t_level = 4"
                +"               AND obj.t_client = "+string(id)
                +"               AND KIND.T_ELEMENT = OBJ.T_KIND"
                +"               AND OBJ.T_DATE BETWEEN TO_DATE ('"+string(begD)+"', 'dd.mm.yyyy')"
                +"                                  AND TO_DATE ('"+string(endD)+"', 'dd.mm.yyyy')) k1,"
                +"       (SELECT OBJ.T_SUM0 TaxBaseRub, OBJ.T_ANALITIC1"
                +"          FROM dnutxobj_dbt obj"
                +"         WHERE     obj.t_level = 6"
                +"               AND obj.t_client = "+string(id)
                +"               AND OBJ.T_DATE BETWEEN TO_DATE ('"+string(begD)+"', 'dd.mm.yyyy')"
                +"                                  AND TO_DATE ('"+string(endD)+"', 'dd.mm.yyyy')) k2"
                +" WHERE k1.T_ANALITIC1 = k2.T_ANALITIC1";
    
    

    
    return Data;
END;    

//„ ­­ë¥ ¤«ï â ¡«¨æ  ¨ Ž
PRIVATE MACRO GenTablePROR(id,conracts,OP,begD,endD)
    var contr=conracts[0],i=1;
        
    while(i<conracts.size())
        contr=contr+","+conracts[i];
        i=i+1;
    end;
    var repo;
    if(OP==1)
        repo  =  "AND RSB_SECUR.get_OperationType (TICK.t_BofficeKind, TICK.t_DealType) ='RBS'"
                +"       AND LEG.T_INCOMERATE > 0";
    else
        repo  =  "AND RSB_SECUR.get_OperationType (TICK.t_BofficeKind, TICK.t_DealType) ='RSB'"
                +"       AND LEG.T_INCOMERATE < 0";        
    end;    
    
    
    var Data="SELECT DISTINCT"
            +"       tick.t_dealcode,"
            +"       rsb_rep_fi.get_finame (tick.t_pfi) SecName,"
            +"       AVR.T_DEFINITION SecType,"
            +"       LEG.T_PRINCIPAL Qnty,                               "
            +"       LEG.t_cfi   cfi,"
            +"       RSB_SECUR.GetDealFICcy(LEG.t_cfi)   CurPay,                                "
            +"       (SELECT GA2.T_FACTDATE"
            +"          FROM ddlgrdeal_dbt gd2, ddlgracc_dbt ga2"
            +"         WHERE     gd2.T_DOCID = TICK.T_DEALID"
            +"               AND gd2.T_TEMPLNUM = 31                        "
            +"               AND ga2.T_GRDEALID = GD2.T_ID"
            +"               AND ga2.T_ACCNUM = 1)"
            +"          Date2,"
            +"       (SELECT GA1.T_FACTDATE"
            +"          FROM ddlgrdeal_dbt gd1, ddlgracc_dbt ga1"
            +"         WHERE     gd1.T_DOCID = TICK.T_DEALID"
            +"               AND gd1.T_TEMPLNUM = 15                       "
            +"               AND ga1.T_GRDEALID = GD1.T_ID"
            +"               AND ga1.T_ACCNUM = 1)"
            +"          Date1,"
            +"       LEG1.T_NKD NKD1,"
            +"       LEG1.T_TOTALCOST SumCur1,"
            +"       LEG2.T_NKD NKD2,"
            +"       LEG2.T_TOTALCOST SumCur2,"
            +"       RSB_BRKREP.GETPRICE(TICK.T_DEALID, 1) Price1,"
            +"       RSB_BRKREP.GETPRICE(TICK.T_DEALID, 2) Price2,"
            +"       LEG.T_INCOMERATE Rate,"
            +"       (SELECT SUM (RQ.T_AMOUNT)"
            +"       FROM ddlrq_dbt rq"
            +"       WHERE     rq.t_docid = tick.t_dealid"
            +"       AND rq.t_dockind = TICK.T_BOFFICEKIND"
            +"       AND rq.t_type IN (4, 5))SumExp,"
            +"       (SELECT MAX (RQ.T_FACTDATE)"
            +"       FROM ddlrq_dbt rq"
            +"       WHERE     rq.t_docid = tick.t_dealid"
            +"       AND rq.t_dockind = TICK.T_BOFFICEKIND"
            +"       AND rq.t_type IN (4, 5))  Dexp,"
            +"       RSB_BRKREP.GETBROKERCOMISSSUM(TICK.T_BOFFICEKIND, tick.t_dealid, 1) ComBrok,"
            +"       RSB_BRKREP.GETMARKETCOMISSSUM(TICK.T_BOFFICEKIND, tick.t_dealid, 1, TICK.T_MARKETID) ComExch"
            //+"       --RSB_BRKREP.GETBROKERCOMISSSUM(TICK.T_BOFFICEKIND ,TICK.T_DEALID, P_PART IN NUMBER)"
            +"  FROM ddl_tick_dbt tick,"
            +"       ddl_leg_dbt leg,"
            +"       ddl_leg_dbt leg1,"
            +"       ddl_leg_dbt leg2,"
            +"       dsfcontr_dbt sfc,"
            +"       dfininstr_dbt fi,"
            +"       davrkinds_dbt avr,"
            +"       dfininstr_dbt FIN"
            +" WHERE     TICK.T_CLIENTCONTRID  in("+contr+")"+repo
            //+"       AND RSB_SECUR.get_OperationType (TICK.t_BofficeKind, TICK.t_DealType) ="
            //+"              'RBS'"
            +"       AND LEG.T_DEALID = TICK.T_DEALID"
            //+"       AND LEG.T_INCOMERATE > 0"
            +"       AND EXISTS"
            +"              (SELECT 1"
            +"                 FROM ddlgrdeal_dbt gd, ddlgracc_dbt ga"
            +"                WHERE     gd.T_DOCID = TICK.T_DEALID"
            +"                      AND gd.T_TEMPLNUM = 31                 "
            +"                      AND ga.T_GRDEALID = GD.T_ID"
            +"                      AND ga.T_ACCNUM = 1                              "
            +"                      AND GA.T_FACTDATE BETWEEN TO_DATE ('"+string(begD)+"',"
            +"                                                         'dd.mm.yyyy')"
            +"                                            AND TO_DATE ('"+string(endD)+"',"
            +"                                                         'dd.mm.yyyy'))"
            +"       AND sfc.t_ServKind IN (1)"
            +"       AND SFC.T_PARTYID = "+string(id)
            +"       AND FI.T_FIID = tick.t_pfi"
            +"       AND AVR.T_AVOIRKIND ="
            +"              DECODE (rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND),"
            +"                      17, FI.T_AVOIRKIND,"
            +"                      rsb_fiinstr.FI_AvrKindsGetRoot (2, FI.T_AVOIRKIND))"
            +"       AND AVR.T_FI_KIND = 2"
            +"       AND LEG1.T_LEGKIND = 0"
            +"       AND LEG2.T_LEGKIND = 2"
            +"       AND LEG1.T_DEALID = LEG2.T_DEALID"
            +"       AND LEG1.T_DEALID = LEG.T_DEALID"
            +"       AND FIN.T_FIID=LEG.T_CFI"
            +"       ORDER BY cfi";
           
    return Data;
END;

//Š« áá ¤«ï ª®àà¥ªâ­®£® ¢ë¢®¤  ¤ ­­ëå ¢ ®âç¥â
PRIVATE CLASS ReportData(RepDat:object)
    VAR m_Report = RepDat;
    
    macro SecName():string
        return m_Report.SecName;
    end;
    
    macro SecType():string
        return m_Report.SecType;
    end;
    
    macro CurPay():string
        return m_Report.CurPay;
    end;
    
    macro Qnty()
        return m_Report.Qnty;
    end;
    
    macro Price1()
        return m_Report.Price1;
    end;
    
    macro NKD1()
        return m_Report.NKD1;
    end;
    
    macro SumCur1()
        return m_Report.SumCur1;
    end;
    
    macro ComExch()
        return m_Report.ComExch;
    end;
    
    macro ComBrok()
        return m_Report.ComBrok;
    end;
    
    macro Date2():Date
        return m_Report.Date2;
    end;
    
    macro Date1():Date
        return m_Report.Date1;
    end;
    
    macro Price2()
        return m_Report.Price2;
    end;
    
    macro Dexp():Date
        return iif(m_Report.Dexp!=null,m_Report.Dexp,null);
    end;
    
    macro SumExp()
        return iif(m_Report.SumExp,m_Report.SumExp,0);
    end;
    
    macro NKD2()
        return m_Report.NKD2;
    end;
    
    macro SumCur2()
        return m_Report.SumCur2;
    end;
    
    macro Period()
        var result=Date2()-Date1();
        return iif(result,result,1);
    end;
    
    macro FRcur(PR)
        var FRcur;
        if(PR)
            FRcur=SumCur1()-SumCur2()-SumExp()-
            ComExch()-ComBrok();
        else
            FRcur=SumCur2()+SumExp()-SumCur1()-
            SumExp()-ComBrok();
        end;
    
        return FRcur;
    end;
    
    macro FRcurBK()
          return SumExp();
    end;
    
    macro Rate()
        return m_Report.Rate;
    end;
    
    macro CourseOut()
        var cmd=DL_RSDCommand("select  RSB_FIINSTR.CONVSUM (1,0,"+m_Report.cfi+
                              ",'"+string(Date2())+"',2) CourseOut from dual ");
        var dataset=cmd.Execute();
        dataset.movenext();
        return dataset.CourseOut;
    end;
    
    macro CourseOutBK()
        return m_Report.CourseOut;
    end;
    
    macro FRrub(PR)
        return CourseOut()*FRcur(PR);
    end;
    
    macro FRrubBK()
        return CourseOutBK()*FRcurBK();
    end;
    
    macro Deal()
        return m_Report.dealcode;
    end;
    
    macro Doper(): Date
        return m_Report.Doper;
    end;
    
    macro PriceBuy()
        return m_Report.PriceBuy;
    end;
    
    macro MainBuy()
        return m_Report.MainBuy;
    end;
    
    macro NKDBuy()
        return m_Report.NKDBuy;
    end;
    
    macro ComExchBuy()
        return m_Report.ComExchBuy;
    end;
    
    macro ComBrokBuy()
        return m_Report.ComBrokBuy;
    end;
    
    macro Dsell(): Date
        return m_Report.Dsell;
    end;
    
    macro PriceSell()
        return m_Report.PriceSell;
    end;
    
    macro MainSell()
        return m_Report.MainSell;
    end;
    
    macro NKDSell()
        return m_Report.NKDSell;
    end;
    
    macro ComExchSell()
        return m_Report.ComExchSell;
    end;
    
    macro ComBrokSell()
        return m_Report.ComBrokSell;
    end;
    
    macro FRrubRL()
        return m_Report.NKDSell*m_Report.CourseOut;
    end;
    
    macro DealBuy()
        return m_Report.DealBuy;
    end;
    
    macro DealSell()
        return m_Report.DealSell;
    end;


END;
   
//Š« áá £¥­¥à æ¨¨ ®âç¥â    
PRIVATE CLASS (DL_CReportTemplate) CALC_INC_Report(Form,DataSet)
    
    var m_CurrSheetName = "";
    var flag=true;
    var mForm,mDataSet;
    var account="",contract="",client="";
    var contracts=TArray();
    var RD;
    PRIVATE MACRO GetDataFromFormFields()
        RepFormData.BegDate        =   mForm.GetFieldValue(PNFLD_CALCINC_BegDate);
        RepFormData.EndDate        =   mForm.GetFieldValue(PNFLD_CALCINC_EndDate);
        RepFormData.ClientCode     =   mForm.GetFieldValue(PNFLD_CALCINC_ClientCode);
        RepFormData.ClientName     =   mForm.GetFieldValue(PNFLD_CALCINC_ClientName);
        RepFormData.IsExportToExel =   mForm.GetFieldValue(PNFLD_CALCINC_IsExportToExel);
    END;
    
    
    PRIVATE MACRO PrintMode():INTEGER
        if( RepFormData.IsExportToExel == SET_CHAR )
        return DL_OUTREPORT_EXCEL;
        else
            return DL_OUTREPORT_STD;
        end;
    END;
    
    PRIVATE MACRO BeginReport()
        GetDataFromFormFields();
        Dl_CallInsertStat(PrintMode());
        CreateTotalBook();
        //CReport_Show(1,"123");
        //UseNewSheetInTotalBook();
    END;
    
    PRIVATE MACRO EndReport()
        SaveTotalBook();
    END;
    
    
    PRIVATE MACRO Sheet1()
        m_CurrSheetName = "N18";
        SetActiveSheet( m_CurrSheetName );
        UseNewSheetInTotalBook();
        var f4,f6,f7,f8,f9,f10,f11,f13,f14,f15,f16,f17,f19;
        
             
        PRIVATE MACRO PrintHeader1()
            PrintFormatString(  TableHeader,
                                "H1_Dbeg" ,string(RepFormData.BegDate) ,
                                "H1_Dend",string(RepFormData.EndDate) ,
                                "H1_ClientName",string(client),
                                "H1_AgreementAll",string(contract),
                                "H1_AccountAll",string(account));
            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N1_RepHead", 0, m_CurrSheetName);
            
            RegisterTable(  "N1_MainTable", TableHeader,
                            "N1_SecName1",
                            "N1_SecType1",
                            "N1_CurPay1",
                            "N1_Qnty1",
                            "N1_Dbuy1",
                            "N1_PriceBuy",
                            "N1_MainBuy",
                            "N1_NKDBuy1",
                            "N1_MainBuy",
                            "N1_NKDBuy1",
                            "N1_ComExchBuy",
                            "N1_ComBrokBuy",
                            "N1_Dsell",
                            "N1_PriceSell",
                            "N1_MainSell",
                            "N1_NKDSell",
                            "N1_ComExchSell",
                            "N1_ComBrokSell",
                            "N1_FRcur",
                            "N1_CourseOut1",
                            "N1_FRrub",
                            "N1_DealBuy1",
                            "N1_DealSell1");

        END;
        PRIVATE MACRO PrintHeader2()
            PrintFormatString(  TableHeader);
            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N2_RepHead", 1, m_CurrSheetName);
            
            RegisterTable(  "N2_MainTable", TableHeader,
                            "N2_SecName",
                            "N2_SecType2",
                            "N2_CurPay2",
                            "N2_Qnty2",
                            "N2_Dbuy2",
                            "N2_NKDBuy2",
                            "N2_Doper",
                            "N2_SumExp",
                            "N2_FRcur",
                            "N2_CourseOut2",
                            "N2_FRrub",
                            "N2_DealBuy2",
                            "N2_OperCoup2" );

        END;
        PRIVATE MACRO PrintHeader3()
            PrintFormatString(  TableHeader);
            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N3_RepHead", 1, m_CurrSheetName);
            
            RegisterTable(  "N3_MainTable", TableHeader,
                            "N3_IncomeCode",
                            "N3_CodeType3",
                            "N3_Cur",
                            "N3_TaxBaseCur",
                            "N3_CourseOut3",
                            "N3_TaxBaseRub",
                            "N3_TaxRate",
                            "N3_TaxRub");
        END;
        PRIVATE MACRO PrintTOTAL1(A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11)
            PrintFormatString(TableHeader,
                                "N1_F4",    A1,  
                                "N1_F7",    A2, 
                                "N1_F8",    A3, 
                                "N1_F9",    A4, 
                                "N1_F10",   A5, 
                                "N1_F13",   A6, 
                                "N1_F14",   A7, 
                                "N1_F15",   A8, 
                                "N1_F16",   A9, 
                                "N1_F17",   A10,
                                "N1_F19",   A11);    


            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N1_TOTAL", 0, m_CurrSheetName);
        END;
        PRIVATE MACRO PrintTOTAL2(A1,A2,A3,A4,A5)
            PrintFormatString(TableHeader,
                                "N2_F4",    A1,  
                                "N2_F6",    A2, 
                                "N2_F8",    A3, 
                                "N2_F9",    A4, 
                                "N2_F11",   A5);    


            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N2_TOTAL", 0, m_CurrSheetName);
        END;      
        PRIVATE MACRO PrintTOTAL3(A1)
            PrintFormatString(TableHeader,
                                "N3_F8",    A1);    


            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N3_TOTAL", 0, m_CurrSheetName);
        END;    
        PRIVATE MACRO PrintLineTable1(A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18,A19,A20,A21,A22,A23)

            PrintTableLine( "N1_SecName1",      A1,     null,
                            "N1_SecType1",      A2,     null,
                            "N1_CurPay1",       A3,     null,
                            "N1_Qnty1",         A4,     null,
                            "N1_Dbuy1",         A5,     null,
                            "N1_PriceBuy",      A6,     null,
                            "N1_MainBuy",       A7,     null,
                            "N1_NKDBuy1",       A8,     null,
                            "N1_MainBuy",       A9,     null,
                            "N1_NKDBuy1",       A10,    null,
                            "N1_ComExchBuy",    A11,    null,
                            "N1_ComBrokBuy",    A12,    null,
                            "N1_Dsell",         A13,    null,
                            "N1_PriceSell",     A14,    null,
                            "N1_MainSell",      A15,    null,
                            "N1_NKDSell",       A16,    null,
                            "N1_ComExchSell",   A17,    null,
                            "N1_ComBrokSell",   A18,    null,
                            "N1_FRcur",         A19,    null,
                            "N1_CourseOut1",    A20,    null,
                            "N1_FRrub",         A21,    null,
                            "N1_DealBuy1",      A22,    null,
                            "N1_DealSell1",     A23,    null);
        END; 
        PRIVATE MACRO PrintLineTable2(A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13)

            PrintTableLine( "N2_SecName",       A1,     null,
                            "N2_SecType2",      A2,     null,
                            "N2_CurPay2",       A3,     null,
                            "N2_Qnty2",         A4,     null,
                            "N2_Dbuy2",         A5,     null,
                            "N2_NKDBuy2",       A6,     null,
                            "N2_Doper",         A7,     null,
                            "N2_SumExp",        A8,     null,
                            "N2_FRcur",         A9,     null,
                            "N2_CourseOut2",    A10,    null,
                            "N2_FRrub",         A11,    null,
                            "N2_DealBuy2",      A12,    null,
                            "N2_OperCoup2",     A13,    null);

        END;    
        PRIVATE MACRO PrintLineTable3(A1,A2,A3,A4,A5,A6,A7,A8)
            PrintTableLine( "N3_IncomeCode",        A1,     null,
                            "N3_CodeType3",         A2,     null,
                            "N3_Cur",               A3,     null,
                            "N3_TaxBaseCur",        A4,     null,
                            "N3_CourseOut3",        A5,     null,
                            "N3_TaxBaseRub",        A6,     null,
                            "N3_TaxRate",           A7,     null,
                            "N3_TaxRub",            A8,     null);
 
            //EndTable();
            //CopyAllSheetInTotalBook(m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName);
        END;
        
        var query, cmd, DS;
        
        PrintHeader1();
        query=GenTableRL(mDataSet.PartyID,
                        RepFormData.BegDate,
                        RepFormData.EndDate,
                        true);
        cmd=DL_RSDCommand(query);
        DS=cmd.Execute();
        f4=0;f6=0;f7=0;f8=0;f9=0;f10=0;f11=0;f13=0;f14=0;f15=0;f16=0;f17=0;f19=0;
        while(DS.movenext())
            RD=ReportData(ds);
            PrintLineTable1(RD.SecName(),
                            RD.SecType(),
                            RD.CurPay(),
                            RD.Qnty(),
                            NULL,
                            NULL,//PriceBuy,
                            NULL,//ds.MainBuy,
                            NULL,//ds.NKDBuy,
                            NULL,//ds.ComExchBuy,
                            NULL,//ds.ComBrokBuy,
                            RD.Dsell(),
                            NULL,//ds.PriceSell,
                            NULL,//ds.MainSell,
                            RD.NKDSell(),
                            NULL,//ds.ComExchSell,
                            NULL,//ds.ComBrokSell,
                            RD.NKDSell(),
                            RD.CourseOutBK(),
                            RD.FRrubRL(),//ds.NKDSell*ds.CourseOut,
                            NULL,//ds.DealBuy,
                            RD.DealSell()
            );
            f4  =   f4  +   ds.Qnty;
            f7  =   f7  +   0;
            f8  =   f8  +   0;
            f9  =   f9  +   0;
            f10 =   f10 +   0;
            f13 =   f13 +   0;
            f14 =   f14 +   ds.NKDSell;
            f15 =   f15 +   0;
            f16 =   f16 +   0;
            f17 =   f17 +   ds.NKDSell;
            f19 =   f19 +   ds.NKDSell*ds.CourseOut;
        end;
        query=GenTableRL(mDataSet.PartyID,
                        RepFormData.BegDate,
                        RepFormData.EndDate,
                        false);
        cmd=DL_RSDCommand(query);
        DS=cmd.Execute();
        
        while(DS.movenext())
            RD=ReportData(ds);
            PrintLineTable1(RD.SecName(),
                            RD.SecType(),
                            RD.CurPay(),
                            RD.Qnty(),
                            NULL,
                            RD.PriceBuy(),
                            RD.MainBuy(),
                            RD.NKDBuy(),
                            RD.ComExchBuy(),
                            RD.ComBrokBuy(),
                            RD.Dsell(),
                            RD.PriceSell(),
                            RD.MainSell(),
                            RD.NKDSell(),
                            RD.ComExchSell(),
                            RD.ComBrokSell(),
                            RD.NKDSell(),
                            RD.CourseOutBK(),
                            RD.FRrubRL(),
                            RD.DealBuy(),
                            RD.DealSell()
            );
            f4  =   f4  +   ds.Qnty;
            f7  =   f7  +   ds.MainBuy;
            f8  =   f8  +   ds.NKDBuy;
            f9  =   f9  +   ds.ComExchBuy;
            f10 =   f10 +   ds.ComBrokBuy;
            f13 =   f13 +   ds.MainSell;
            f14 =   f14 +   ds.NKDSell;
            f15 =   f15 +   ds.ComExchSell;
            f16 =   f16 +   ds.ComBrokSell;
            f17 =   f17 +   ds.NKDSell;
            f19 =   f19 +   ds.NKDSell*ds.CourseOut;
        end;
        EndTable();
        CopyAllSheetInTotalBook(m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName);
        PrintTOTAL1(f4,f7,f8,f9,f10,f13,f14,f15,f16,f17,f19);
        PrintHeader2();
        query=GenTableBK(mDataSet.PartyID,
                        RepFormData.BegDate,
                        RepFormData.EndDate);
        cmd=DL_RSDCommand(query);
        DS=cmd.Execute();
        f4=0;f6=0;f8=0;f9=0;f11=0;
        while(DS.movenext())
            RD=ReportData(ds);
            PrintLineTable2(RD.SecName(),
                            RD.SecType(),
                            RD.CurPay(),
                            RD.Qnty(),
                            NULL,
                            NULL,
                            RD.Doper(),
                            RD.SumExp(),
                            RD.FRcurBK(),
                            RD.CourseOutBK(),
                            RD.FRrubBK(),
                            NULL,
                            RD.Deal()
            );
            f4  =   f4  +   RD.Qnty();
            f8  =   f8  +   RD.SumExp();
            f9  =   f9  +   RD.FRcurBK();
            f11 =   f11 +   RD.FRrubBK();
            
        end;
        EndTable();
        CopyAllSheetInTotalBook(m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName);
        
        PrintTOTAL2(f4,f6,f8,f9,f11);
        PrintHeader3();

        query=GenTableCB(mDataSet.PartyID,
                        RepFormData.BegDate,
                        RepFormData.EndDate);
        cmd=DL_RSDCommand(query);
        DS=cmd.Execute();
     
        var  itog=0;
        while(DS.movenext())
            PrintLineTable3(DS.IncomeCode,
                            DS.CodeType,
                            DS.Cur,
                            DS.TaxBaseCur,
                            DS.CourseOut,
                            DS.TaxBaseRub,
                            DS.TaxRate,
                            DS.TaxRub  
            );
            itog=itog+DS.TaxRub;
        end;
        EndTable();
        CopyAllSheetInTotalBook(m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName);
        PrintTOTAL3(itog);
    END;
    
    PRIVATE MACRO Sheet2()
        m_CurrSheetName = "N18_1";
        SetActiveSheet( m_CurrSheetName );
        UseNewSheetInTotalBook();
        var ValArray=tArray;
        var CurValArray=Tarray;
        CurValArray.size()=11;
        var CurVal=-1,LastVal=-1;
        MACRO PrintHeader()
            PrintFormatString(  TableHeader,
                                "H2_Dbeg" ,string(RepFormData.BegDate) ,
                                "H2_Dend",string(RepFormData.EndDate) ,
                                "H2_ClientName",string(client),
                                "H2_AgreementAll",string(contract),
                                "H2_AccountAll",string(account));
            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N4_RepHead", 0, m_CurrSheetName);
            
            RegisterTable( "N4_MainTable", TableHeader,
                           "N4_SecName",
                           "N4_SecType",
                           "N4_CurPay",
                           "N4_Date1",
                           "N4_Qnty",
                           "N4_Price1",
                           "N4_NKD1",
                           "N4_SumCur1",
                           "N4_ComExch",
                           "N4_ComBrok",
                           "N4_Date2",
                           "N4_Price2",
                           "N4_Dexp",
                           "N4_SumExp",
                           "N4_NKD2",
                           "N4_SumCur2",
                           "N4_Period",
                           "N4_FRcur",
                           "N4_Rate",
                           "N4_CourseOut",
                           "N4_FRrub",
                           "N4_Deal0",
                           "N4_Deal"
                           );
        END;
        
        PRIVATE MACRO PrintTOTAL(A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18,A19,A20,A21)
            PrintFormatString(TableHeader,
                                "N4_F5",    A1,  
                                "N4_F7",    A2, 
                                "N4_F8",    A3, 
                                "N4_F9",    A4, 
                                "N4_F10",   A5, 
                                "N4_F14",   A6, 
                                "N4_F15",   A7, 
                                "N4_F16",   A8, 
                                "N4_F18",   A9, 
                                "N4_F21",   A10/*,
                                "N4_Cur",   A11,
                                "N4_FV5",   A12,
                                "N4_FV7",   A13,
                                "N4_FV8",   A14,
                                "N4_FV9",   A15,
                                "N4_FV10",  A16,
                                "N4_FV14",  A17,
                                "N4_FV15",  A18,
                                "N4_FV16",  A19,
                                "N4_FV18",  A20,
                                "N4_FV21",  A21*/);    


            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N4_TOTAL", 0, m_CurrSheetName);
        END;
        PRIVATE MACRO PrintLineTable(A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18,A19,A20,A21,A22,A23)
 
            PrintTableLine( "N4_SecName",    A1,     null,
                            "N4_SecType",    A2,     null,
                            "N4_CurPay",     A3,     null,
                            "N4_Date1",      A4,     null,
                            "N4_Qnty",       A5,     null,
                            "N4_Price1",     A6,     null,
                            "N4_NKD1",       A7,     null,
                            "N4_SumCur1",    A8,     null,
                            "N4_ComExch",    A9,     null,
                            "N4_ComBrok",    A10,    null,
                            "N4_Date2",      A11,    null,
                            "N4_Price2",     A12,    null,
                            "N4_Dexp",       A13,    null,
                            "N4_SumExp",     A14,    null,
                            "N4_NKD2",       A15,    null,
                            "N4_SumCur2",    A16,    null,
                            "N4_Period",     A17,    null,
                            "N4_FRcur",      A18,    null,
                            "N4_Rate",       A19,    null,
                            "N4_CourseOut",  A20,    null,
                            "N4_FRrub",      A21,    null,
                            "N4_Deal0",      A22,    null,
                            "N4_Deal",       A23,    null);

        END; 
        
        PRIVATE MACRO PrintTOTALVAL()
            var i=0;
            while(i<ValArray.size())
             PrintFormatString(TableHeader,
                                "N4_Cur",     COD_VAl(ValArray[i][0]),     
                                "N4_FV5",     ValArray[i][1],
                                "N4_FV7",     ValArray[i][2],
                                "N4_FV8",     ValArray[i][3],
                                "N4_FV9",     ValArray[i][4],
                                "N4_FV10",    ValArray[i][5],
                                "N4_FV14",    ValArray[i][6],
                                "N4_FV15",    ValArray[i][7],
                                "N4_FV16",    ValArray[i][8],
                                "N4_FV18",    ValArray[i][9],
                                "N4_FV21",    ValArray[i][10] );
                                CopyAllSheetInTotalBook(m_CurrSheetName, false, "N4_TOTAL_VAL", 0, m_CurrSheetName);
                i=i+1;
            end;
        END;
        
        PrintHeader();
        var query=GenTablePROR(mDataSet.PartyID,contracts,2,
                                RepFormData.BegDate,
                                RepFormData.EndDate);
        var cmd=DL_RSDCommand(query);
        var DS=cmd.Execute();
        var f5=0,f7=0,f8=0,f9=0,f10=0,f14=0,f15=0,f16=0,f18=0,f21=0;
        ValArray.size()=0;
        while(ds.movenext())
            CurVal=ds.cfi;
            if(CurVal!=LastVal)
                LastVal=CurVal;
                var i=1;
                while(i<11)
                    CurValArray[i]=0;
                    i=i+1;
                end;
                CurValArray[0]  = CurVal;
                ValArray[ValArray.size()]=CurValArray;
            end;
            var RD=ReportData(ds);
            PrintLineTable( RD.SecName(),
                            RD.SecType(),
                            RD.CurPay(),
                            RD.Date1(),
                            RD.Qnty(),
                            RD.Price1(),
                            RD.NKD1(),
                            RD.SumCur1(),
                            RD.ComExch(),
                            RD.ComBrok(),
                            RD.Date2(),
                            RD.Price2(),
                            RD.Dexp(),
                            RD.SumExp(),
                            RD.NKD2(),
                            RD.SumCur2(),
                            RD.Period(),
                            RD.FRcur(1),
                            RD.Rate(),
                            RD.CourseOut(),
                            RD.FRrub(1),
                            RD.Deal(),
                            RD.Deal()  );
            f5  =   f5  +   RD.Qnty();
            f7  =   f7  +   RD.NKD1();
            f8  =   f8  +   RD.SumCur1();
            f9  =   f9  +   RD.ComExch();
            f10 =   f10 +   RD.ComBrok();
            f14 =   f14 +   RD.SumExp();
            f15 =   f15 +   RD.NKD2();
            f16 =   f16 +   RD.SumCur2();
            f18 =   f18 +   RD.FRcur(1);
            f21 =   f21 +   RD.FRrub(1);
            CurValArray[1]  =CurValArray[1]   +  RD.Qnty();
            CurValArray[2]  =CurValArray[2]   +  RD.NKD1();
            CurValArray[3]  =CurValArray[3]   +  RD.SumCur1();
            CurValArray[4]  =CurValArray[4]   +  RD.ComExch();
            CurValArray[5]  =CurValArray[5]   +  RD.ComBrok();
            CurValArray[6]  =CurValArray[6]   +  RD.SumExp();
            CurValArray[7]  =CurValArray[7]   +  RD.NKD2();
            CurValArray[8]  =CurValArray[8]   +  RD.SumCur2();
            CurValArray[9]  =CurValArray[9]   +  RD.FRcur(1);
            CurValArray[10] =CurValArray[10]  +  RD.FRrub(1);                
        end;
        EndTable();
        CopyAllSheetInTotalBook(m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName);
        PrintTOTAL(f5,f7,f8,f9,f10,f14,f15,f16,f18,f21);
        PrintTOTALVAL();
    
    END;
    
    PRIVATE MACRO Sheet3()
        m_CurrSheetName = "N18_2";
        SetActiveSheet( m_CurrSheetName );
        UseNewSheetInTotalBook();
        var ValArray=tArray;
        var CurValArray=Tarray;
        CurValArray.size()=11;
        var CurVal=-1,LastVal=-1;
        MACRO PrintHeader()
            PrintFormatString(  TableHeader,/***********/
                                "H3_Dbeg" ,string(RepFormData.BegDate) ,
                                "H3_Dend",string(RepFormData.EndDate) ,
                                "H3_ClientName",string(client),
                                "H3_AgreementAll",string(contract),
                                "H3_AccountAll",string(account));
            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N5_RepHead", 0, m_CurrSheetName);
            
            RegisterTable( "N5_MainTable", TableHeader,
                           "N5_SecName",
                           "N5_SecType",
                           "N5_CurPay",
                           "N5_Date1",
                           "N5_Qnty",
                           "N5_Price1",
                           "N5_NKD1",
                           "N5_SumCur1",
                           "N5_ComExch",
                           "N5_ComBrok",
                           "N5_Date2",
                           "N5_Price2",
                           "N5_Dexp",
                           "N5_SumExp",
                           "N5_NKD2",
                           "N5_SumCur2",
                           "N5_Period",
                           "N5_FRcur",
                           "N5_Rate",
                           "N5_CourseOut",
                           "N5_FRrub",
                           "N5_Deal0",
                           "N5_Deal"
                           );
        END;
        
        PRIVATE MACRO PrintTOTAL(A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18,A19,A20,A21)
            PrintFormatString(TableHeader,
                                "N5_F5",    A1,  
                                "N5_F7",    A2, 
                                "N5_F8",    A3, 
                                "N5_F9",    A4, 
                                "N5_F10",   A5, 
                                "N5_F14",   A6, 
                                "N5_F15",   A7, 
                                "N5_F16",   A8, 
                                "N5_F18",   A9, 
                                "N5_F21",   A10/*,
                                "N5_Cur",   A11,
                                "N5_FV5",   A12,
                                "N5_FV7",   A13,
                                "N5_FV8",   A14,
                                "N5_FV9",   A15,
                                "N5_FV10",  A16,
                                "N5_FV14",  A17,
                                "N5_FV15",  A18,
                                "N5_FV16",  A19,
                                "N5_FV18",  A20,
                                "N5_FV21",  A21*/);  
                                
                                
            CopyAllSheetInTotalBook(m_CurrSheetName, false, "N5_TOTAL", 0, m_CurrSheetName);
        END;
        
        PRIVATE MACRO PrintLineTable(A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18,A19,A20,A21,A22,A23)
            PrintTableLine( "N5_SecName",    A1,     null,
                            "N5_SecType",    A2,     null,
                            "N5_CurPay",     A3,     null,
                            "N5_Date1",      A4,     null,
                            "N5_Qnty",       A5,     null,
                            "N5_Price1",     A6,     null,
                            "N5_NKD1",       A7,     null,
                            "N5_SumCur1",    A8,     null,
                            "N5_ComExch",    A9,     null,
                            "N5_ComBrok",    A10,    null,
                            "N5_Date2",      A11,    null,
                            "N5_Price2",     A12,    null,
                            "N5_Dexp",       A13,    null,
                            "N5_SumExp",     A14,    null,
                            "N5_NKD2",       A15,    null,
                            "N5_SumCur2",    A16,    null,
                            "N5_Period",     A17,    null,
                            "N5_FRcur",      A18,    null,
                            "N5_Rate",       A19,    null,
                            "N5_CourseOut",  A20,    null,
                            "N5_FRrub",      A21,    null,
                            "N5_Deal0",      A22,    null,
                            "N5_Deal",       A23,    null);
        END; 
        
        PRIVATE MACRO PrintTOTALVAL()
            var i=0;
            while(i<ValArray.size())
             PrintFormatString(TableHeader,
                                "N5_Cur",     COD_VAl(ValArray[i][0]),     
                                "N5_FV5",     ValArray[i][1],
                                "N5_FV7",     ValArray[i][2],
                                "N5_FV8",     ValArray[i][3],
                                "N5_FV9",     ValArray[i][4],
                                "N5_FV10",    ValArray[i][5],
                                "N5_FV14",    ValArray[i][6],
                                "N5_FV15",    ValArray[i][7],
                                "N5_FV16",    ValArray[i][8],
                                "N5_FV18",    ValArray[i][9],
                                "N5_FV21",    ValArray[i][10] );
                                CopyAllSheetInTotalBook(m_CurrSheetName, false, "N5_TOTAL_VAL", 0, m_CurrSheetName);
                i=i+1;
            end;
        END;

        PrintHeader();
        var query=GenTablePROR(mDataSet.PartyID,contracts,1,
                                RepFormData.BegDate,
                                RepFormData.EndDate);
        var cmd=DL_RSDCommand(query);
        var DS=cmd.Execute();
        var f5=0,f7=0,f8=0,f9=0,f10=0,f14=0,f15=0,f16=0,f18=0,f21=0;
        ValArray.size()=0;
        while(ds.movenext())
            CurVal=ds.cfi;
            if(CurVal!=LastVal)
                LastVal=CurVal;
                var i=1;
                while(i<11)
                    CurValArray[i]=0;
                    i=i+1;
                end;
                CurValArray[0]  = CurVal;
                ValArray[ValArray.size()]=CurValArray;
            end;
            RD=ReportData(ds);
            PrintLineTable( RD.SecName(),
                            RD.SecType(),
                            RD.CurPay(),
                            RD.Date1(),
                            RD.Qnty(),
                            RD.Price1(),
                            RD.NKD1(),
                            RD.SumCur1(),
                            RD.ComExch(),
                            RD.ComBrok(),
                            RD.Date2(),
                            RD.Price2(),
                            RD.Dexp(),
                            RD.SumExp(),
                            RD.NKD2(),
                            RD.SumCur2(),
                            RD.Period(),
                            RD.FRcur(0),
                            RD.Rate(),
                            RD.CourseOut(),
                            RD.FRrub(0),
                            RD.Deal(),
                            RD.Deal());
            f5  =   f5  +   RD.Qnty();
            f7  =   f7  +   RD.NKD1();
            f8  =   f8  +   RD.SumCur1();
            f9  =   f9  +   RD.ComExch();
            f10 =   f10 +   RD.ComBrok();
            f14 =   f14 +   RD.SumExp();
            f15 =   f15 +   RD.NKD2();
            f16 =   f16 +   RD.SumCur2();
            f18 =   f18 +   RD.FRcur(0);
            f21 =   f21 +   RD.FRrub(0);
            CurValArray[1]  =CurValArray[1]   +  RD.Qnty();
            CurValArray[2]  =CurValArray[2]   +  RD.NKD1();
            CurValArray[3]  =CurValArray[3]   +  RD.SumCur1();
            CurValArray[4]  =CurValArray[4]   +  RD.ComExch();
            CurValArray[5]  =CurValArray[5]   +  RD.ComBrok();
            CurValArray[6]  =CurValArray[6]   +  RD.SumExp();
            CurValArray[7]  =CurValArray[7]   +  RD.NKD2();
            CurValArray[8]  =CurValArray[8]   +  RD.SumCur2();
            CurValArray[9]  =CurValArray[9]   +  RD.FRcur(0);
            CurValArray[10] =CurValArray[10]  +  RD.FRrub(0);
        end;
        EndTable();
        CopyAllSheetInTotalBook(m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName);
        PrintTOTAL(f5,f7,f8,f9,f10,f14,f15,f16,f18,f21);
        PrintTOTALVAL();
                    
    END;    
   
  
    PRIVATE MACRO Create()
       // var account="",contract="",client="";
       GetDataFromFormFields();
        GenHeadCont(mDataSet.PartyID,@account,@contract,@client,@contracts);

        Sheet1();

        var q = "select 1 from dclient_dbt clt where clt.t_ServiceKind IN (1, 15) and clt.t_PartyID = ? and clt.t_Branch = 0";
        var cmd = DL_RSDCommand(q);
        cmd.AddParam(mDataSet.PartyID);
        var ds = cmd.Execute();

        if (ds.movenext())
            Sheet2();
            Sheet3();
        end;
    END;
    
    mForm=Form;
    mDataSet=DataSet;
    initDL_CReportTemplate(NULL, "Report_Calc_Inc.xls");
    
END;

MACRO MakeReport()
    var clientID=0,clientCode="";
    var Num=0;
    var pan=CALC_INC_Panel();
    var stat=pan.Run();
    if(stat)
        pan.GetFieldValue(PNFLD_CALCINC_ClientCode,@ClientCode,@clientID);
        if(clientID<0)

            var Query=   "SELECT DISTINCT prt.t_ShortName, prt.t_PartyID"
                        +"  FROM dclient_dbt clt, dparty_dbt prt"
                        +" WHERE ((clt.t_ServiceKind IN (" + PTSK_STOCKDL + ")"
                        +"       AND prt.t_PartyID = clt.t_PartyID"
                        +"       AND clt.t_Branch = 0) or ("
                        +"exists(select 1 from dnutxobj_dbt nptx where nptx.t_client = prt.t_PartyID and nptx.t_date >= TO_DATE('"+ RepFormData.BegDate +"', 'DD-MM-YYYY') and nptx.t_date <= TO_DATE('"+ RepFormData.EndDate +"', 'DD-MM-YYYY'))))"
                        +"       AND prt.t_LegalForm = "+ legal_form_jur 
                        +"       AND RSB_SECUR.IsTaxResident (prt.t_PartyID,"
                        +"                                    TO_DATE ('"+RepFormData.EndDate+"', 'DD-MM-YYYY')) = 0"
                        +"       AND EXISTS"
                        +"              (SELECT 1"
                        +"                 FROM dsfcontr_dbt contr"
                        +"                WHERE CONTR.T_PARTYID = prt.t_PartyID)";
            
        else
            Query=  "SELECT  prt.t_ShortName, prt.t_PartyID"+
                    " FROM  dparty_dbt prt"+
                    " WHERE   prt.t_PartyID = "+string(clientID);
        end;  

         var SqlNRec  = RSDCommand("select count(*) NRec from ("+Query+")");
        var cmd = DL_RSDCommand(Query);
        var DataSet = cmd.Execute();
         SqlNRec.execute();
         var DataSetNRec = TRsbDataSet(SqlNRec);
        if( DataSetNRec.MoveNext() )
           var NRec = int(DataSetNRec.NRec);
         end;
        InitProgress( NRec, "Žâç¥â:  áç¥â ¤®å®¤®¢ îà¨¤¨ç¥áª¨å «¨æ ­¥à¥§¨¤¥­â®¢", " áç¥â ¤®å®¤®¢ ž‹");
        while(DataSet.MoveNext())
            CALC_INC_Report(pan, DataSet).Run();
            UseProgress( Num = Num + 1 );
        end;
        RemProgress();  
    end;
    
END;

MakeReport();

exit(1);
