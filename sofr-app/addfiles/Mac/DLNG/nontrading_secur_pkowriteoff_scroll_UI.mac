/*
    nontrading_secur_pkowriteoff_scroll_UI.mac
    Интерфейс Буферной таблицы выводов ценных бумаг (Списание ЦБ ПКО)
    Author : Emil Mustafaev
*/

import rsd;
import "diasoft_createPKO_funcobj.mac";
import "lim_utils.mac";
import "SecurPKOWriteOffPanel.mac";

private class hot_keys
    // const ENTER   = 13;
    // const CTRL_R  = 18;
    // const F2      = 316;
    // const F3      = 317;
    const F5      = 319;
    // const F8      = 322;
    // const F9      = 323;
end;

private class ColumnsDescriptor()
   //Упаковщик описания колонки в массив фиксированного формата (формат ячейки задаётся здесь же. Каждая колонка имеет 6 слотов)
    private macro AddColumn (arrCol,ind, fieldName, head, width, rdonly, ty, dp)
        arrCol.value (ind * 6)     = fieldName;
        arrCol.value (ind * 6 + 1) = head;
        arrCol.value (ind * 6 + 2) = width;
        arrCol.value (ind * 6 + 3 ) = rdonly;   // fldType
        arrCol.value (ind * 6 + 4 ) = dp;//   decPoint
        arrCol.value (ind * 6 + 5 ) = 0;   // reserv
    end; 

    var columnsArr = tArray;
    AddColumn (columnsArr, 0, "id",  "ИД операции",   10 ,  0,0);
    AddColumn (columnsArr, 1, "dealid", "ИД сделки списания",   15 ,  0,0);
    AddColumn (columnsArr, 2, "dealcode", "Внешний код операции",   15 ,  0,0);
    AddColumn (columnsArr, 3, "clientid", "Идентификатор клиента",   10 ,  0,0);
    AddColumn (columnsArr, 4, "t_shortname", "Клиент",   12 ,  0,0);
    AddColumn (columnsArr, 5, "t_number",  "Договор БО",   12 ,  0,0);
    AddColumn (columnsArr, 6, "clientcode",  "Код клиента для площадки",   12 ,  0,0);
    AddColumn (columnsArr, 7, "market",  "Площадка по договору",   12 ,  0,0);
    AddColumn (columnsArr, 8, "t_fi_code",  "ЦБ",   12 ,  0,0);
    AddColumn (columnsArr, 9, "qnty",  "Количество ц/б",   12 ,  0,0);
    AddColumn (columnsArr, 10, "startwriteoffdate",  "Дата начала действия поручения",   12 ,  0,0);
    AddColumn (columnsArr, 11, "expirationdate",  "Срок исполнения поручения",   12 ,  0,0);
    AddColumn (columnsArr, 12, "islimitcorrected_interface_vers",  "Лимит скорректирован",   12 ,  0,0);
    AddColumn (columnsArr, 13, "limitcorrectiontimestamp",  "Дата корректировки лимита",   12 ,  0,0);
    AddColumn (columnsArr, 14, "iscanceled_interface_vers",  "Признак отказа в проведении операции",   12 ,  0,0);
    AddColumn (columnsArr, 15, "cancelationtimestamp",  "Дата отметки об отказе",   12 ,  0,0);
    AddColumn (columnsArr, 16, "t_dealstatus_interface_vers",  "Статус операции",   12 ,  0,0);
    AddColumn (columnsArr, 17, "guid",  "GUID",   12 ,  0,0);
    AddColumn (columnsArr, 18, "pkostatus_interface_vers",  "Статус ПКО(Диасофт)",   12 ,  0,0);
    AddColumn (columnsArr, 19, "clienttype_interface_vers",  "Клиент ВТБ",   12 ,  0,0);
    AddColumn (columnsArr, 20, "t_legalform_interface_vers",  "Форма субъекта",   12 ,  0,0);

    macro GetArrayColumns()
        return columnsArr;
    end;

end;


//Метод обёртка вокруг стандартного RunScroll- который и формирует табличное окно
macro scrollSomeTable (sql)
    var columnsDesc,columnNums,procKeyHandl,title,hint;
    getParm(1, columnsDesc);
    getParm(2, columnNums);

    if ((columnNums==null) and (columnsDesc!=null))
        columnNums = columnsDesc.size/6;
    end;
    getParm(3, procKeyHandl);
    getParm(4, title);
    getParm(5, hint);

    return RunScroll(
    RSDRecordSet(RSDCommand(sql), /*RSDVAL_CLIENT*/ null, RSDVAl_STATIC),
    columnNums,
    columnsDesc,
    "Картотека вызовов",
    procKeyHandl,
    title,
    hint);
end;

//Обработчик клавиш в таблице
macro KeyHandler(rs, cmd, id, key)
    if (cmd == DLG_KEY)
        if (key == hot_keys.F5)  //f5
            var panel = SecurPKOWriteOffPanel();

            if (panel.Run == 0)
                return -1;
            end;

            var colObj = ColumnsDescriptor();
            var columnsArr = colObj.GetArrayColumns();

            // значения введённые в диалоговом окне
            var fromDate = "\'" + panel.GetFromDate() + "\'" + ", 'DD.MM.YYYY'";
            var byDate = "\'" + panel.GetByDate() + "\'"+ ", 'DD.MM.YYYY'";
            var isDealStatus0 = panel.DealStatusIs0();
            var isDealStatus10 = panel.DealStatusIs10();
            var isDealStatus20 = panel.DealStatusIs20();

            var sql = "  select pko.id, pko.dealid, pko.dealcode, pko.clientid, pty.t_shortname, sfc.t_number, pko.clientcode, pko.market, fntr.t_fi_code,  "
                      +  "  pko.qnty, pko.startwriteoffdate, pko.expirationdate, case when pko.islimitcorrected = chr(88) then 'Да' else 'Нет' end as islimitcorrected_interface_vers,  "
                      +  "  pko.limitcorrectiontimestamp, case when pko.iscanceled = chr(88) then 'Отказ' else '' end as iscanceled_interface_vers, pko.cancelationtimestamp,  "
                      +  "  case when tick.t_dealstatus = 0 then 'Отложена'  "
                      +  "  when tick.t_dealstatus = 10 then 'Открыта'  "
                      +  "  when tick.t_dealstatus = 20 then 'Закрыта' else 'Не создана' end as t_dealstatus_interface_vers, pko.guid, case when pko.pkostatus = 1 then 'Отправлено в ОД'  "
                      +  "  when pko.pkostatus = 2 then 'Ожидает ответа ОД'  "
                      +  "  when pko.pkostatus = 3 then 'Блокировано'  "
                      +  "  when pko.pkostatus = 4 then 'Ожидает исполнения НРД'  "
                      +  "  when pko.pkostatus = 5 then 'Поручение отказано'  "
                      +  "  when pko.pkostatus = 6 then 'Отмена поручения'  "
                      +  "  when pko.pkostatus = 7 then 'Поручение исполнено' end as pkostatus_interface_vers,  "
                      +  "  case when pko.clienttype = 1 then 'X'  "
                      +  "  when pko.clienttype = 2 then '' end as clienttype_interface_vers,  "
                      +  "  case when pty.t_legalform = 1 then 'ЮЛ'  "
                      +  "  when pty.t_legalform = 2 then 'ФЛ' end as t_legalform_interface_vers  "
                      +  "  from pko_writeoff pko  "
                      +  "  left join dparty_dbt pty on pty.t_partyid = pko.clientid  "
                      +  "  left join dsfcontr_dbt sfc on sfc.t_id = pko.idcontract  "
                      +  "  left join dfininstr_dbt fntr on fntr.t_fiid = pko.securityid  "
                      +  "  left join ddl_tick_dbt tick on tick.t_dealid = pko.dealid where pko.operationtimeora >= to_date(" + fromDate + ") and pko.operationtimeora <= to_date(" + byDate + ")  " 
                      +  "  and tick.t_dealstatus " ; 

            if((isDealStatus0) and (isDealStatus10) and (isDealStatus20))
                sql = sql + "in (0 ,10, 20) order by pko.operationtime desc; ";

            elif((isDealStatus0) and (isDealStatus10))
                sql = sql + "in (0 ,10) order by pko.operationtime desc; ";

            elif((isDealStatus0) and (isDealStatus20))
                sql = sql + "in (0 ,20) order by pko.operationtime desc; ";

            elif((isDealStatus10) and (isDealStatus20))
                sql = sql + "in (10 ,20) order by pko.operationtime desc; ";

            elif(isDealStatus0)
                sql = sql + " = 0 order by pko.operationtime desc; ";

            elif(isDealStatus10)
                sql = sql + " = 10 order by pko.operationtime desc; ";

            elif(isDealStatus20)
                sql = sql + " = 20 order by pko.operationtime desc; ";                

            //на случай если не прожали ни один статус    
            else
                sql = sql + "in (0 ,10, 20) order by pko.operationtime desc; ";
            end;          
  
            while (scrollSomeTable (sql, columnsArr, null, "KeyHandler", "Буфер неторговых поручений по ЦБ", "Esc - Выход | ~F5~ - Задать фильтр по дате"))

            end;
        end;
     end;   
end;

macro scrollPkoWriteOff()

    var colObj = ColumnsDescriptor();
    var columnsArr = colObj.GetArrayColumns();

    var sql = "  select pko.id, pko.dealid, pko.dealcode, pko.clientid, pty.t_shortname, sfc.t_number, pko.clientcode, pko.market, fntr.t_fi_code,  "
              + "  pko.qnty, pko.startwriteoffdate, pko.expirationdate, case when pko.islimitcorrected = chr(88) then 'Да' else 'Нет' end as islimitcorrected_interface_vers,  "
              + "  pko.limitcorrectiontimestamp, case when pko.iscanceled = chr(88) then 'Отказ' else '' end as iscanceled_interface_vers, pko.cancelationtimestamp,  "
              + "  case when tick.t_dealstatus = 0 then 'Отложена'  "
              + "  when tick.t_dealstatus = 10 then 'Открыта'  "
              + "  when tick.t_dealstatus = 20 then 'Закрыта' else 'Не создана' end as t_dealstatus_interface_vers, pko.guid, case when pko.pkostatus = 1 then 'Отправлено в ОД'  "
              + "  when pko.pkostatus = 2 then 'Ожидает ответа ОД'  "
              + "  when pko.pkostatus = 3 then 'Блокировано'  "
              + "  when pko.pkostatus = 4 then 'Ожидает исполнения НРД'  "
              + "  when pko.pkostatus = 5 then 'Поручение отказано'  "
              + "  when pko.pkostatus = 6 then 'Отмена поручения'  "
              + "  when pko.pkostatus = 7 then 'Поручение исполнено' end as pkostatus_interface_vers,  "
              + "  case when pko.clienttype = 1 then 'X' "
              + "  when pko.clienttype = 2 then '' end as clienttype_interface_vers,  "
              + "  case when pty.t_legalform = 1 then 'ЮЛ'  "
              + "  when pty.t_legalform = 2 then 'ФЛ' end as t_legalform_interface_vers  "                                                                  
              + "  from pko_writeoff pko  "
              + "  left join dparty_dbt pty on pty.t_partyid = pko.clientid  "
              + "  left join dsfcontr_dbt sfc on sfc.t_id = pko.idcontract  "
              + "  left join dfininstr_dbt fntr on fntr.t_fiid = pko.securityid  "
              + "  left join ddl_tick_dbt tick on tick.t_dealid = pko.dealid order by pko.operationtime desc  " ;

    while (scrollSomeTable (sql,columnsArr,null,"KeyHandler", "Буфер неторговых поручений по ЦБ", "Esc - Выход | ~F5~ - Задать фильтр по дате"))

    end;
end;

scrollPkoWriteOff();
exit(1);