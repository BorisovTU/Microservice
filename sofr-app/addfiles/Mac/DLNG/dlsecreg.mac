/*
 $Name:		dlsecreg.mac
 $Module:	Ценные бумаги
 $Description:   Отчет " Регистр внутреннего учета ценных бумаг"
*/
IMPORT FIInter,"DLReport_h.mac", "dlmisc.mac";
IMPORT "dlsecreg_form.mac";
IMPORT "Dldlngfun.mac";

PRIVATE CONST BANKACC   = 0,
              CLIENTACC = 1;

private var Rep;

PRIVATE VAR  m_Form = DL_AccountsReg_Panel();

PRIVATE VAR RKIND = TArray();
RKIND[BANKACC] = "Счета учета ценных бумаг";
RKIND[CLIENTACC] = "Счета расчетов с клиентами по ценным бумагам";
////////////////////////////////////////////////////////////////////////////////////////////////////
  
  PRIVATE MACRO UpdateFormFields():INTEGER
    DlSAccRepFormData.DepartmentID              = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_DEPARTMENT );
    DlSAccRepFormData.BeginDate                 = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_BEGINDATE );
    DlSAccRepFormData.EndDate                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_FINISHDATE );
    DlSAccRepFormData.IsSeparatelyDate          = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_SEPARATELY_DATE );
    DlSAccRepFormData.IsUseBO                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_MODULE_BO );
    DlSAccRepFormData.IsUseVA                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_MODULE_VA );
    
    DlSAccRepFormData.IsSAccounts_Report        = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_SECUR_ACCOUNTS_REP );
    DlSAccRepFormData.SubjectID                 = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_SUBJECT );

    DlSAccRepFormData.IsForm1                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ISFORM_1);     
    DlSAccRepFormData.FormSub1                  = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_FORMSUB_1);     
    DlSAccRepFormData.IsVid1                    = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ISVID_1);     
    DlSAccRepFormData.VidSub1                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_VIDSUB_1);     
    DlSAccRepFormData.Noresident1               = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_NORESIDENT_1);     

    DlSAccRepFormData.AccountingPlace           = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ACCOUNTING_PLACE );
    DlSAccRepFormData.Issuer_1                  = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ISSUER_1 );
    DlSAccRepFormData.SecurKind_1               = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_SECUR_KIND_1 );
    DlSAccRepFormData.SecurIssue                = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_SECUR_ISSUE );
    DlSAccRepFormData.IsCL_SAccounts_Report     = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_CL_S_ACOOUNTS_REP );
    DlSAccRepFormData.ClientID                  = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_CLIENT );

    DlSAccRepFormData.IsForm2                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ISFORM_2);     
    DlSAccRepFormData.FormSub2                  = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_FORMSUB_2);     
    DlSAccRepFormData.IsVid2                    = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ISVID_2);     
    DlSAccRepFormData.VidSub2                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_VIDSUB_2);     
    DlSAccRepFormData.Noresident2               = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_NORESIDENT_2);     

    DlSAccRepFormData.ContractID                = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_CONTRACT );
    DlSAccRepFormData.Issuer_2                  = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ISSUER_2 );
    DlSAccRepFormData.SecurKind_2               = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_SECUR_KIND_2 );
    DlSAccRepFormData.SecurCode                 = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_SECUR_CODE );
    DlSAccRepFormData.IsUseOpostrofs            = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_WITH_APOSTROFS );
    DlSAccRepFormData.IsExportToExel            = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_TO_EXEL );
  END;

PRIVATE VAR TableHeader1 =
"┌──────────────┬────────────────────┬────────────────────┬─────────────────┬─────────────────┬─────────────────┬─────────────────┬────────────────┐\n" +
"│ Наименование │        Вид         │         №          │      Вид        │       №         │  Вход. остаток, │    Кол-во ц/б   │ Исх. остаток   │\n" +
"│  расчетной   │  сделки(операции)  │  сделки(операции)  │ подтверждающего │ подтверждающего │       шт.       │                 │      шт.       │\n" +
"│   операции   │       с ц/б        │       с ц/б        │    документа    │    документа    │                 │                 │                │\n" +
"│              │                    │                    │                 │                 │                 │                 │                │\n" +
"├──────────────┼────────────────────┼────────────────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼────────────────┤";


PRIVATE VAR TableHeader2 =
"┌──────────────┬────────────────────┬────────────────────┬─────────────────┬─────────────────┬─────────────────┬─────────────────┬────────────────┬─────────────────┬──────────────┐\n" +
"│ Наименование │       Вид          │         №          │       Вид       │        №        │Входящий остаток │Вход. остаток    │   Кол-во ц/б   │Исх. остаток     │ Исх. остаток │\n" +
"│  расчетной   │  сделки(операции)  │  сделки(операции)  │ подтверждающего │ подтверждающего │  ц/б, шт.       │по обязательствам│                │по обязательствам│ ц/б, шт.     │\n" +       
"│   операции   │      с ц/б         │       с ц/б        │    документа    │    документа    │                 │клиента          │                │клиента          │              │\n" +
"│              │                    │                    │                 │                 │                 │перед банком     │                │перед банком     │              │\n" +
"│              │                    │                    │                 │                 │                 │                 │                │                 │              │\n" +
"│              │                    │                    │                 │                 │                 │                 │                │                 │              │\n" +
"├──────────────┼────────────────────┼────────────────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼────────────────┼─────────────────┼──────────────┤";
  
PRIVATE CLASS (DL_CReportTemplate) Dl_SecReg_Report
  private var m_SheetName;
  private var m_Prefix, m_TempSheetName;
  private var t_RepDep = "Филиал #\n\n"+
        "Регистр внутреннего учета ценных бумаг\n"+
        "#\n";
  private var t_RepPer = "Отчетный период #\n";
  private var t_RepAcc = "Счет внутреннего учета: #\n";
  private var t_RepClient = "Клиент # / Договор № # от #\n";
  private var t_RepAvr = "Ценная бумага:	#		Код ц/б:	#\n"+				
"Эмитент:	#	Вид:	# #	#\n";
  private var t_RepClient2 = "Счет внутреннего учета: # Клиент #\n" +
  "Ценные бумаги клиента по договору № # от #\n";
  private var t_RepAccNum = "Лицевой счет: # #\n";

  private var IsFirstPrint = true;
  var IsNeedAddSheet;
  private var m_RegisterTable = false;

  var RepKind;

  /*MACRO CopyAllSheetInTotalBook(SheetName:string,//Имя закладки,по умолчанию имя закладки из шаблона
                                  _FlagSheet:bool,// true - на новую закладку, на существующую
                                  _CopyPos:string,//Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                  _PastePos:variant, // сколько строчек отступить (int) или куда на новом листе копировать, например, "A1"
                                  _PasteSheetName:variant, // Имя закладки, в которую копировать
                                  _NotUseActivation:bool) : bool //Не использовать активацию закладки в шаблоне (нужно при размножении вкладок в новой общей книге)
  end;*/
  
  MACRO EndReportTab()
     if(m_RegisterTable)
       EndTable();
       CopyAllSheetInTotalBook( m_TempSheetName, false, GetTableRange(), 0, m_SheetName );
       m_RegisterTable = false;
     end;
  END;

  /*macro AddNewSheet()
    //EndReportTab();
    UseNewSheetInTotalBook();
  end;*/

  PRIVATE MACRO PrintMode():INTEGER
     if(DlSAccRepFormData.IsExportToExel)
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
    CreateTotalBook();
  END;

  MACRO PrintRepFooter()
     EndReportTab();
     AddStandardFooter( m_Prefix );
     CopyAllSheetInTotalBook( m_TempSheetName, false, m_Prefix+"Foot", 1, m_SheetName );
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  macro SetPrefix(p_prefix:String)
    m_Prefix = p_prefix;
  end;

  macro PrintHead0( DepID, DepartmentName, IsClientAccount, IsNotEmiss:bool )
    m_TempSheetName = "Отчёт"+IIF(RepKind==CLIENTACC,"_Кл","");
    EndReportTab();
    if((IsNotEmiss != null) and (IsNotEmiss == true))
        m_SheetName = "Отчёт_НЭ"+IIF(RepKind==CLIENTACC,"_Кл","")+" (" + string(DepID) + " " + string(DepartmentName) + ")";
    else
        m_SheetName = "Отчёт"+IIF(RepKind==CLIENTACC,"_Кл","")+" (" + string(DepID) + " " + string(DepartmentName) + ")";
    end;
    UseNewSheetInTotalBook();
    PrintFormatString( t_RepDep , m_Prefix+"H1_1", DepartmentName,
                                        m_Prefix+"H1_3", RKIND[RepKind]);
    CopyAllSheetInTotalBook( m_TempSheetName, false, m_Prefix+"HEAD0", 0, m_SheetName );
  end;

  macro PrintHead0_2( BeginDate, EndDate )
   EndReportTab();
   if( BeginDate == EndDate  )
     PrintFormatString("Отчетный период #" , m_Prefix+"H1_2", string(Date(BeginDate):f));
   else
     PrintFormatString("Отчетный период #" , m_Prefix+"H1_2", " с "+string(Date(BeginDate):f) + " по " + string(Date(EndDate):f));
   end;
   CopyAllSheetInTotalBook( m_TempSheetName, false, m_Prefix+"HEAD1", 1, m_SheetName );
  end;

  macro PrintHead1_11() 
     EndReportTab();
     var Name = " Ценные бумаги банка ";
       PrintFormatString( t_RepAcc , m_Prefix+"H2_0", Name);
       CopyAllSheetInTotalBook( m_TempSheetName, false, m_Prefix+"HEAD2", 1, m_SheetName );
  end;

  macro PrintHead1_12( ShortName, Number, DateConc ) 
   EndReportTab();
   var Name = " Ценные бумаги клиентов ";
     PrintFormatString(t_RepAcc , m_Prefix+"H2_0", Name);
     CopyAllSheetInTotalBook( m_TempSheetName, false, m_Prefix+"HEAD2", 1, m_SheetName );
     PrintFormatString(t_RepClient, m_Prefix+"H2_5", String(ShortName),
                                            m_Prefix+"H2_6", String(Number),
                                            m_Prefix+"H2_7", String(Date(DateConc):f));
     CopyAllSheetInTotalBook(m_TempSheetName, false, m_Prefix+"HEAD4", 1, m_SheetName);
  end;

  macro PrintHead1_2( ShortName, Number, DateConc ) 
   EndReportTab();
   var Name = "Расчеты с клиентами по ценным бумагам" ;
     PrintFormatString( t_RepClient2, m_Prefix+"H2_0", Name,
                                             m_Prefix+"H2_1", String(ShortName),
                                             m_Prefix+"H2_3", String(Number),
                                             m_Prefix+"H2_4", String(Date(DateConc):f));
     CopyAllSheetInTotalBook(m_TempSheetName, false, m_Prefix+"HEAD2", 1, m_SheetName);
  end;

  macro PrintHead2( IsClientAccount, IsNotEmiss:bool )
   EndReportTab();
   var Name;
   if((IsNotEmiss != null) and (IsNotEmiss == true))
     Name = "Неэмиссионные ценные бумаги";
   else
     if( IsClientAccount == 0 )
       Name = "Эмиссионные ценные бумаги, инвестиционные паи и депозитарные расписки";
     else
       Name = "Эмиссионные ценные бумаги";
     end;
   end;
   PrintFormatString( Name , m_Prefix+"HEAD3", Name );
   CopyAllSheetInTotalBook(m_TempSheetName, false, m_Prefix+"HEAD3", 1, m_SheetName);
  end;

  macro PrintHead3( AvrName, FI_Code, ShortName, FI_KindName, Issue, Series, Tranche, IsNotEmiss:bool )
   EndReportTab();
   var H3_3, H3_4;
   if((IsNotEmiss != null) and (IsnotEmiss == true))
    H3_3 = "Серия " + String(Issue);
    H3_4 = "Номер " + String(Series);
   else
    H3_3 = "Выпуск " + String(Issue);
    H3_4 = "Серия/транш " + String(Series) + "/" + String(Tranche);
   end;
   PrintFormatString(t_RepAvr , m_Prefix+"H3_6", String(AvrName),
                                        m_Prefix+"H3_7", String(FI_Code),
                                        m_Prefix+"H3_1", String(ShortName),
                                        m_Prefix+"H3_2", String(FI_KindName),
                                        m_Prefix+"H3_3", H3_3,
                                        m_Prefix+"H3_4", H3_4);
    CopyAllSheetInTotalBook(m_TempSheetName, false, m_Prefix+"HEAD5", 1, m_SheetName);
  end;

  macro PrintHead4( Account, AccountName )
   EndReportTab();
   
   PrintFormatString(t_RepAccNum , m_Prefix+"H4_1", Account,
                                         m_Prefix+"H4_2", AccountName);
   CopyAllSheetInTotalBook(m_TempSheetName, false, m_Prefix+"HEAD6", 1, m_SheetName);

   if(m_Prefix == "N1_")
     RegisterTable( "N1_MainTable", TableHeader1,
                         "N1_A1",
                         "N1_A2",
                         "N1_A3",
                         "N1_A4",
                         "N1_A5",
                         "N1_A6",
                         "N1_A7",
                         "N1_A8"
                  );
    else
      RegisterTable( "N2_MainTable", TableHeader2,
                         "N2_A1",
                         "N2_A2",
                         "N2_A3",
                         "N2_A4",
                         "N2_A5",
                         "N2_A6",
                         "N2_A7",
                         "N2_A8",
                         "N2_A9",
                         "N2_A10"
                   );
    end;

    m_RegisterTable = true;
  end;

  macro PrintLineDate1( DDate:date )

   if( DlSAccRepFormData.IsSeparatelyDate != "X" )
     PrintTableLine("N1_А1", string(DDate:f), NULL);
   end;

 end;

macro PrintLineDate2( DDate:date )

   if( DlSAccRepFormData.IsSeparatelyDate != "X" )
     PrintTableLine("N2_А1", string(DDate:f), NULL);
 end;

end;

macro PrintLine1( A1, A2, A3, A4, A5, A6, A7, A8, IsNotEmiss:bool )
  var Precision = 0;
   if( ( (IsNotEmiss == null) or (IsNotEmiss == false) ) and (IsHaveFractPart(A6) OR IsHaveFractPart(A7) OR IsHaveFractPart(A8)) )
      Precision = 6;
   end;

   
    PrintTableLine("N1_A1", A1, NULL,
                   "N1_A2", IIF(A2, A2, " "), NULL,
                   "N1_A3", A3, NULL,
                   "N1_A4", IIF((( A5 ) and (A5 !="Undefined")), A4, " "), NULL,
                   "N1_A5", IIF((( A5 ) and (A5 !="Undefined")), A5, " "), NULL,
                   "N1_A6", IIF(A6, money(A6), int(0)), Precision,
                   "N1_A7", IIF(A7, money(A7), int(0)), Precision,
                   "N1_A8", money(A8), Precision);
end;

macro PrintLine2( A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, IsNotEmiss:bool )
  var Precision = 0;

   if( ( (IsNotEmiss == null) or (IsNotEmiss == false) ) and (IsHaveFractPart(A6) OR IsHaveFractPart(A7) OR IsHaveFractPart(A8) OR
       IsHaveFractPart(A9) OR IsHaveFractPart(A10)) )
      Precision = 6;
   end;
    PrintTableLine("N2_A1", A1, NULL,
                   "N2_A2", IIF(A2, A2, " "), NULL,
                   "N2_A3", A3, NULL,
                   "N2_A4", IIF((( A5 ) and (A5 !="Undefined")), A4, " "), NULL,
                   "N2_A5", IIF((( A5 ) and (A5 !="Undefined")), A5, " "), NULL,
                   "N2_A6", IIF(A6, money(A6), int(0)), Precision,
                   "N2_A7", IIF(A7, money(A7), int(0)), Precision,
                   "N2_A8", money(A8), Precision,
                   "N2_A9", IIF(A9, money(A9), int(0)), Precision,
                   "N2_A10", IIF(A10, money(A10), int(0)), Precision);
end;

  macro Create()
    if (DlSAccRepFormData.IsUseBO == "X" )
     ExecMacroFile("scavrreg.mac", "MakeReport", DlSAccRepFormData, @this );
    end;
    if (DlSAccRepFormData.IsUseVA == "X" )
       ExecMacroFile("vasecacreg.mac", "MakeReport", DlSAccRepFormData, @this );  
    end;

    if( (DlSAccRepFormData.IsSAccounts_Report != "X") and ( DlSAccRepFormData.IsCL_SAccounts_Report != "X" ) )
      MsgBox( "Не выбраны параметры формирования отчета по счетам.");
    end;
  end;

  macro PrintErrorMessage(msg:string)
    MsgBox( msg );
  end;

    initDL_CReportTemplate( null, "Report_DLSecReg.xls", true, null, null, true );
END;

macro MakeReports()

  var stat = 0;
  VAR ReportFileName, TblName = "scavrreg", errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода для отчета*/
  
  stat = m_Form.Run();

  // Проверяем можем ли мы делать отчет по предоставленным данным
  if (not stat)
   return 1;
  end;

  UpdateFormFields();
  Dl_CallInsertStat( IIF( DlSAccRepFormData.IsExportToExel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
  Dl_SecReg_Report().Run();

  return 0;
end;

while( not MakeReports() ) 
end;
exit(1);
