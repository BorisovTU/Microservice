/*
$Name:             ws_md_tradeclient.mac
$Module:           Монитор дилера
$Description:      WEB. Монитор дилера. Макрос классов и сервисов скроллингов и панелей клиентов монитора дилера
*/

import FIInter;
import BankInter;
import CTInter;
import "cb_sql.mac";
import "ws_common.mac";
import "secinter.mac";
import "ws_namealg.mac";
import "ws_typeac.mac";
import "ws_datafilter.mac";
import "ws_person.mac";
import "ws_file.mac";
import "ws_fiunilist.mac";
import "spserv.mac";
import "ws_md.mac";
import "ws_md_clientgroup.mac";
import "ws_md_rates.mac";

// Класс CMdClientList Клиенты. 
class CMdClientList
  var PartyID:Integer;         // Идентификатор клиента
  var ClientName:String;       // Наименование клиента
  var Group;                   // TWebClientGroup Группа клиента
  var PFI;                     // TWsFinInstr базовая валюта
  var CFI;                     // TWsFinInstr валюта
  var CurPair:String;          // валютная пара
  var CurPairID:Integer;       // id валютной пары 
  var PAmount11:Money;         // сумма нижней границы 1 диапазона
  var PAmount12:Money;         // сумма верхней границы 1 диапазона
  var Spred1:Money;            // спред 1 диапазона
  var PAmount21:Money;         // сумма нижней границы 2 диапазона
  var PAmount22:Money;         // сумма верхней границы 2 диапазона
  var Spred2:Money;            // спред 2 диапазона
  var PAmount31:Money;         // сумма нижней границы 3 диапазона
  var PAmount32:Money;         // сумма верхней границы 3 диапазона
  var Spred3:Money;            // спред 3 диапазона
  var DealStatus;//:TWsNameAlg // Флаг разрешения следующей сделки. 0 - разрешено, 1 - запрещено
  var Oper:Integer;            // id пользователя
  var DealType;//:TWsNameAlg   // Тип формирования конверсионной сделки для клиента. 0-по согласованию, 1-автоматический вариант
  var Delta_b:Double;          // маржа по покупке
  var Delta_s:Double;          // маржа по продаже
  var GrantEdit;               // Разрешение на редактирование (пользователь находится в группе редактирования)
end;

class CMdClientListExt
   var ClientList;           // TArray Клиенты
   var GrantEdit;            // Разрешение на редактирование (пользователь находится в группе редактирования)
end;

private macro GetSQLClientCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "", ListClientId = "";
  var i = 0;

  if( ( ValType( value ) != V_UNDEF ) and ( value.Size > 0 ))
    while(i < value.Size) 
      if(ListClientId != "") 
        ListClientId = ListClientId + String(","); 
      end;
      ListClientId = ListClientId + String(value[i].PartyId);
      i=i+1;
    end;
    strSQLCond = " vcln.T_PARTYID IN(" + ListClientId + ") ";
  end;
 
  return strSQLCond;
end;

private macro GetSQLGroupCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "", ListGroup = "";
  var i = 0;
  if( ( ValType( value ) != V_UNDEF ) and ( value.Size > 0 ))
    while(i < value.Size) 
      if(ListGroup != "") 
        ListGroup = ListGroup + String(" OR "); 
      end;
      ListGroup = ListGroup + String(" ( vcln.T_GROUPID = ", value[i].GroupId, " AND vcln.T_ATTRID = ", value[i].AttrId, " ) ");
      i=i+1;
    end;
    strSQLCond = " (" + ListGroup + ") ";
  end;
 
  return strSQLCond;
end;

private macro GetSQLCurPairCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "", ListCurPairId = "";
  var i = 0;

  if( ( ValType( value ) != V_UNDEF ) and ( value.Size > 0 ))
    while(i < value.Size) 
      if(ListCurPairId != "") 
        ListCurPairId = ListCurPairId + String(","); 
      end;
      ListCurPairId = ListCurPairId + String(value[i].ID);
      i=i+1;
    end;
    strSQLCond = " crpr.T_ID IN(" + ListCurPairId + ") ";
  end;
 
  return strSQLCond;
end;

private macro GetSQLDealTypeCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "", ListDealType = "";
  var i = 0;

  if( ( ValType( value ) != V_UNDEF ) and ( value.Size > 0 ))
    while(i < value.Size) 
      if(ListDealType != "") 
        ListDealType = ListDealType + String(","); 
      end;
      ListDealType = ListDealType + String(value[i]);
      i=i+1;
    end;
    strSQLCond = " vcln.T_DEALTYPE IN(" + ListDealType + ") ";
  end;
 
  return strSQLCond;
end;


private macro GetClientListAddWhereCondition(
  FilterItems//:TArray of FilterCondItem
):String

  var fp = FilterParser( FilterItems );

  fp.AddUserFieldCondition( 0, @GetSQLClientCondition );      // Клиент
  fp.AddUserFieldCondition( 1, @GetSQLGroupCondition );       // Группа
  fp.AddUserFieldCondition( 2, @GetSQLCurPairCondition );     // Валютная пара
  fp.AddUserFieldCondition( 3, @GetSQLDealTypeCondition );    // Группа

  return fp.GetFullSQLCondition();
end;

// Возвращает список клиентов
macro MdGetClientList(kind_client:Integer, PageNum : integer, PageSize : integer, FilterItems)
  var ClientList : CMdClientList;
  var result = TArray();
  var stat:integer = -1;
  var strAddWhere:string = "";
  var CurLimit = MdGetCurLimit(); // Валюта задания диапазонов

  if( PageNum == null )
     RunError("Не задан обязательный параметр функции: номер страницы ");
  end;

  if( PageSize == null )
     RunError("Не задан обязательный параметр функции: размер страницы ");
  end;

  var query = "SELECT vcln.*, RSB_SECUR.GetDealClientShortName(vcln.T_PARTYID) t_ClientName, crpr.T_ID t_CurPairId " +
              "FROM V_RKCLIENT vcln, DPARTY_DBT prt, DRKCURPAIR_DBT crpr " +
              "WHERE vcln.T_PARTYID = prt.T_PARTYID AND crpr.T_PFI = vcln.T_PFI AND crpr.T_CFI = vcln.T_CFI AND prt.T_LEGALFORM = " + string(kind_client);

  strAddWhere = GetClientListAddWhereCondition( FilterItems );

  if( strAddWhere != "" )
    query = query + " AND " + strAddWhere;
  end;

  query = SQL_WrapSelect(query, PageNum, PageSize);

  var ds = TRsbDataSet(query);

  while( ds.MoveNext() )
    ClientList             = CMdClientList();
    ClientList.PartyID     = ds.PartyID;
    ClientList.ClientName  = ds.ClientName;
    ClientList.Group       = WebCore_CreateTWebClientGroupFromBD(ds.GroupID, ds.AttrID);
    ClientList.PFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PFI), CODE_Ccy);
    ClientList.CFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.CFI), CODE_Ccy);
    ClientList.CurPair     = IIF(ClientList.PFI != null, ClientList.PFI.CodeWidget, "") + "/" + IIF(ClientList.CFI != null, ClientList.CFI.CodeWidget, "");
    ClientList.CurPairId   = ds.CurPairId;
    ClientList.PAmount11   = ds.Pamount11;
    ClientList.PAmount12   = ds.Pamount12;
    ClientList.Spred1      = ds.Spred1;
    ClientList.PAmount21   = ds.Pamount21;
    ClientList.PAmount22   = ds.Pamount22;
    ClientList.Spred2      = ds.Spred2;
    ClientList.PAmount31   = ds.Pamount31;
    ClientList.PAmount32   = ds.Pamount32;
    ClientList.Spred3      = ds.Spred3;
    ClientList.DealStatus  = CreateNameAlgFromAppServ(3553, SQL_ConvTypeInteger(ds.DealStatus));
    ClientList.Oper        = ds.Oper;
    ClientList.DealType    = CreateNameAlgFromAppServ(3592, SQL_ConvTypeInteger(ds.DealType));
    ClientList.Delta_b     = ds.Delta_b;
    ClientList.Delta_s     = ds.Delta_s;

    // Значения диапазонов задаются в валюте задания диапазонов.
    // При отображении в панелях диапазонов  для остальных валютных пар значения в валюте задания диапазонов
    // пересчитываются по кросс/курсу базовой валюты валютной пары к валюте задания диапазонов.
    // Для расчета кросс/курса используются основные курсы валют.
    if( (SP_GetFIID(ClientList.PFI) != ALLFININSTR) and (ClientList.PFI.Fiid != CurLimit) and (CurLimit != ALLFININSTR) )
          SmartConvertSumDbl(ClientList.PAmount11, ClientList.PAmount11, {curdate}, ClientList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(ClientList.PAmount12, ClientList.PAmount12, {curdate}, ClientList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(ClientList.PAmount21, ClientList.PAmount21, {curdate}, ClientList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(ClientList.PAmount22, ClientList.PAmount22, {curdate}, ClientList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(ClientList.PAmount31, ClientList.PAmount31, {curdate}, ClientList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(ClientList.PAmount32, ClientList.PAmount32, {curdate}, ClientList.PFI.Fiid, CurLimit, false);
    end;

    result.value(result.Size) = ClientList;
  end;

  var resultExt = CMdClientListExt();
  resultExt.ClientList = result;
  resultExt.GrantEdit = MdExistsUserInEditGroup();

  return resultExt;
OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

// Инициализировать панель данных клиентов
macro MdInitClientPanel(kind_client:Integer, partyID:integer, curPairId:integer)
  var ClientList = CMdClientList();
  var result = TArray();
  var stat:integer = -1;
  var CurLimit = MdGetCurLimit(); // Валюта задания диапазонов

   InitError();

   if( (partyID == null) or (partyID < 1) )
      RunError("Не задан обязательный параметр функции: Идентификатор клиента");
   end;
   if( (curPairId == null) or (curPairId < 1) )
      RunError("Не задан обязательный параметр функции: Идентификатор валютной пары");
   end;
   
  var query = "SELECT vcln.*, RSB_SECUR.GetDealClientShortName(vcln.T_PARTYID) t_ClientName, crpr.T_ID t_CurPairId " +
              "FROM V_RKCLIENT vcln, DPARTY_DBT prt, DRKCURPAIR_DBT crpr " +
              "WHERE vcln.T_PARTYID = prt.T_PARTYID AND crpr.T_PFI = vcln.T_PFI AND crpr.T_CFI = vcln.T_CFI AND prt.T_LEGALFORM = " + string(kind_client) +
              "  AND prt.T_PARTYID = " + partyID +
              "  AND crpr.T_ID = " + curPairId;

  var ds = TRsbDataSet(query);

  if( ds.MoveNext() )
    ClientList.PartyID     = ds.PartyID;
    ClientList.ClientName  = ds.ClientName;
    ClientList.Group       = WebCore_CreateTWebClientGroupFromBD(ds.GroupID, ds.AttrID);
    ClientList.PFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PFI), CODE_Ccy);
    ClientList.CFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.CFI), CODE_Ccy);
    ClientList.CurPair     = IIF(ClientList.PFI != null, ClientList.PFI.CodeWidget, "") + "/" + IIF(ClientList.CFI != null, ClientList.CFI.CodeWidget, "");
    ClientList.CurPairId   = ds.CurPairId;
    ClientList.PAmount11   = ds.Pamount11;
    ClientList.PAmount12   = ds.Pamount12;
    ClientList.Spred1      = ds.Spred1;
    ClientList.PAmount21   = ds.Pamount21;
    ClientList.PAmount22   = ds.Pamount22;
    ClientList.Spred2      = ds.Spred2;
    ClientList.PAmount31   = ds.Pamount31;
    ClientList.PAmount32   = ds.Pamount32;
    ClientList.Spred3      = ds.Spred3;
    ClientList.DealStatus  = CreateNameAlgFromAppServ(3553, SQL_ConvTypeInteger(ds.DealStatus));
    ClientList.Oper        = ds.Oper;
    ClientList.DealType    = CreateNameAlgFromAppServ(3592, SQL_ConvTypeInteger(ds.DealType));
    ClientList.Delta_b     = ds.Delta_b;
    ClientList.Delta_s     = ds.Delta_s;
    ClientList.GrantEdit   = MdExistsUserInEditGroup();

    if( (SP_GetFIID(ClientList.PFI) != ALLFININSTR) and (ClientList.PFI.Fiid != CurLimit) and (CurLimit != ALLFININSTR) )
       SmartConvertSumDbl(ClientList.PAmount11, ClientList.PAmount11, {curdate}, ClientList.PFI.Fiid, CurLimit);
       SmartConvertSumDbl(ClientList.PAmount12, ClientList.PAmount12, {curdate}, ClientList.PFI.Fiid, CurLimit);
       SmartConvertSumDbl(ClientList.PAmount21, ClientList.PAmount21, {curdate}, ClientList.PFI.Fiid, CurLimit);
       SmartConvertSumDbl(ClientList.PAmount22, ClientList.PAmount22, {curdate}, ClientList.PFI.Fiid, CurLimit);
       SmartConvertSumDbl(ClientList.PAmount31, ClientList.PAmount31, {curdate}, ClientList.PFI.Fiid, CurLimit);
       SmartConvertSumDbl(ClientList.PAmount32, ClientList.PAmount32, {curdate}, ClientList.PFI.Fiid, CurLimit);
    end;
  else
    ClientList.CurPairId = -1;
  end;
  
  return ClientList;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

// Возвращает количество клиентов в списке
macro MdGetCountClientList(kind_client:Integer, FilterItems)
  var result = 0;
  var stat:integer = -1;
  var strAddWhere:string = "";

  var query = "select count(1) CNT from V_RKCLIENT vcln, DPARTY_DBT prt, DRKCURPAIR_DBT crpr WHERE vcln.T_PARTYID = prt.T_PARTYID AND crpr.T_PFI = vcln.T_PFI AND crpr.T_CFI = vcln.T_CFI AND prt.T_LEGALFORM = " + string(kind_client);

  strAddWhere = GetClientListAddWhereCondition( FilterItems );
  if( strAddWhere != "" )
    query = query + " AND " + strAddWhere;
  end;

  var ds = TRsbDataSet(query);

  if( ds.MoveNext() )
    result = Int(ds.cnt);
  end;

  return result;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

// Возвращает список групп клиентов
macro MdGetGroupList(kind_client:Integer, PageNum : integer, PageSize : integer, FilterItems)
  var GroupList : CMdClientList;
  var result = TArray();
  var stat:integer = -1;
  var strAddWhere:string = "";
  var CurLimit = MdGetCurLimit(); // Валюта задания диапазонов
  var GroupID = 0;

  if( PageNum == null )
     RunError("Не задан обязательный параметр функции: номер страницы ");
  end;

  if( PageSize == null )
     RunError("Не задан обязательный параметр функции: размер страницы ");
  end;

  if(kind_client == 1)
    GroupID = группа_ЮЛ;
  elif(kind_client == 2)
    GroupID = группа_ФЛ;
  end;

  var query = "SELECT vcln.*, crpr.T_ID t_CurPairId " +
              "FROM V_RKGROUP vcln, DRKCURPAIR_DBT crpr " +
              "WHERE crpr.T_PFI = vcln.T_PFI AND crpr.T_CFI = vcln.T_CFI AND vcln.T_GROUPID = " + string(GroupID);

  strAddWhere = GetClientListAddWhereCondition( FilterItems );

  if( strAddWhere != "" )
    query = query + " AND " + strAddWhere;
  end;

  query = SQL_WrapSelect(query, PageNum, PageSize);

  var ds = TRsbDataSet(query);

  while( ds.MoveNext() )
    GroupList              = CMdClientList();
    GroupList.Group       = WebCore_CreateTWebClientGroupFromBD(ds.GroupID, ds.AttrID);
    GroupList.PFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PFI), CODE_Ccy);
    GroupList.CFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.CFI), CODE_Ccy);
    GroupList.CurPair     = IIF(GroupList.PFI != null, GroupList.PFI.CodeWidget, "") + "/" + IIF(GroupList.CFI != null, GroupList.CFI.CodeWidget, "");
    GroupList.CurPairId   = ds.CurPairId;
    GroupList.PAmount11   = ds.Pamount11;
    GroupList.PAmount12   = ds.Pamount12;
    GroupList.Spred1      = ds.Spred1;
    GroupList.PAmount21   = ds.Pamount21;
    GroupList.PAmount22   = ds.Pamount22;
    GroupList.Spred2      = ds.Spred2;
    GroupList.PAmount31   = ds.Pamount31;
    GroupList.PAmount32   = ds.Pamount32;
    GroupList.Spred3      = ds.Spred3;
    GroupList.Delta_b     = ds.Delta_b;
    GroupList.Delta_s     = ds.Delta_s;

    // Значения диапазонов задаются в валюте задания диапазонов.
    // При отображении в панелях диапазонов  для остальных валютных пар значения в валюте задания диапазонов
    // пересчитываются по кросс/курсу базовой валюты валютной пары к валюте задания диапазонов.
    // Для расчета кросс/курса используются основные курсы валют.
    if( (SP_GetFIID(GroupList.PFI) != ALLFININSTR) and (GroupList.PFI.Fiid != CurLimit) and (CurLimit != ALLFININSTR) )
          SmartConvertSumDbl(GroupList.PAmount11, GroupList.PAmount11, {curdate}, GroupList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(GroupList.PAmount12, GroupList.PAmount12, {curdate}, GroupList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(GroupList.PAmount21, GroupList.PAmount21, {curdate}, GroupList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(GroupList.PAmount22, GroupList.PAmount22, {curdate}, GroupList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(GroupList.PAmount31, GroupList.PAmount31, {curdate}, GroupList.PFI.Fiid, CurLimit, false);
          SmartConvertSumDbl(GroupList.PAmount32, GroupList.PAmount32, {curdate}, GroupList.PFI.Fiid, CurLimit, false);
    end;

    result.value(result.Size) = GroupList;
  end;
  return result;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

// Инициализировать панель данных группы клиентов
macro MdInitGroupPanel(kind_client:Integer, group, curPairId:integer)
  var GroupList = CMdClientList();
  var result = TArray();
  var stat:integer = -1;
  var CurLimit = MdGetCurLimit(); // Валюта задания диапазонов
  var GroupID = 0;

   InitError();

   if( (group == null) or (group.GroupID == null) or (group.GroupID < 1) )
      RunError("Не задан обязательный параметр функции: Идентификатор группы");
   end;
   if( (curPairId == null) or (curPairId < 1) )
      RunError("Не задан обязательный параметр функции: Идентификатор валютной пары");
   end;

  if(kind_client == 1)
    GroupID = группа_ЮЛ;
  elif(kind_client == 2)
    GroupID = группа_ФЛ;
  end;

  var query = "SELECT vcln.*, crpr.T_ID t_CurPairId " +
              "FROM V_RKGROUP vcln, DRKCURPAIR_DBT crpr " +
              "WHERE crpr.T_PFI = vcln.T_PFI AND crpr.T_CFI = vcln.T_CFI AND vcln.T_GROUPID = " + string(GroupID) +
              "  AND vcln.T_GROUPID = " + group.GroupID +
              "  AND vcln.T_ATTRID = " + group.AttrID +
              "  AND crpr.T_ID = " + curPairId;

  var ds = TRsbDataSet(query);

  if( ds.MoveNext() )
    GroupList.Group       = WebCore_CreateTWebClientGroupFromBD(ds.GroupID, ds.AttrID);
    GroupList.PFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PFI), CODE_Ccy);
    GroupList.CFI         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.CFI), CODE_Ccy);
    GroupList.CurPair     = IIF(GroupList.PFI != null, GroupList.PFI.CodeWidget, "") + "/" + IIF(GroupList.CFI != null, GroupList.CFI.CodeWidget, "");
    GroupList.CurPairId   = ds.CurPairId;
    GroupList.PAmount11   = ds.Pamount11;
    GroupList.PAmount12   = ds.Pamount12;
    GroupList.Spred1      = ds.Spred1;
    GroupList.PAmount21   = ds.Pamount21;
    GroupList.PAmount22   = ds.Pamount22;
    GroupList.Spred2      = ds.Spred2;
    GroupList.PAmount31   = ds.Pamount31;
    GroupList.PAmount32   = ds.Pamount32;
    GroupList.Spred3      = ds.Spred3;
    GroupList.Delta_b     = ds.Delta_b;
    GroupList.Delta_s     = ds.Delta_s;
    GroupList.GrantEdit   = MdExistsUserInEditGroup();

    if( (SP_GetFIID(GroupList.PFI) != ALLFININSTR) and (GroupList.PFI.Fiid != CurLimit) and (CurLimit != ALLFININSTR) )
      SmartConvertSumDbl(GroupList.PAmount11, GroupList.PAmount11, {curdate}, GroupList.PFI.Fiid, CurLimit);
      SmartConvertSumDbl(GroupList.PAmount12, GroupList.PAmount12, {curdate}, GroupList.PFI.Fiid, CurLimit);
      SmartConvertSumDbl(GroupList.PAmount21, GroupList.PAmount21, {curdate}, GroupList.PFI.Fiid, CurLimit);
      SmartConvertSumDbl(GroupList.PAmount22, GroupList.PAmount22, {curdate}, GroupList.PFI.Fiid, CurLimit);
      SmartConvertSumDbl(GroupList.PAmount31, GroupList.PAmount31, {curdate}, GroupList.PFI.Fiid, CurLimit);
      SmartConvertSumDbl(GroupList.PAmount32, GroupList.PAmount32, {curdate}, GroupList.PFI.Fiid, CurLimit);
    end;
  else
    GroupList.CurPairId = -1;
  end;
  
  return GroupList;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

// Возвращает количество групп клиентов в списке
macro MdGetCountGroupList(kind_client:Integer, FilterItems)
  var result = 0;
  var stat:integer = -1;
  var strAddWhere:string = "";
  var GroupID = 0;

  if(kind_client == 1)
    GroupID = группа_ЮЛ;
  elif(kind_client == 2)
    GroupID = группа_ФЛ;
  end;

  var query = "select count(1) CNT from V_RKGROUP vcln, DRKCURPAIR_DBT crpr WHERE crpr.T_PFI = vcln.T_PFI AND crpr.T_CFI = vcln.T_CFI AND vcln.T_GROUPID = " + string(GroupID);

  strAddWhere = GetClientListAddWhereCondition( FilterItems );
  if( strAddWhere != "" )
    query = query + " AND " + strAddWhere;
  end;

  var ds = TRsbDataSet(query);

  if( ds.MoveNext() )
    result = Int(ds.cnt);
  end;

  return result;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

// Группа у клиента
macro GetGroupClient(PartyID:Integer)
  var cmd, rs;
  var obj : TWebClientGroup;

  obj = TWebClientGroup;
  obj.GroupID = -1;
  obj.AttrID = -1;

  var query = "SELECT T.T_GROUPID, T.T_ATTRID " + 
              "FROM DOBJATCOR_DBT T " + 
              "WHERE T.T_OBJECTTYPE = 3 AND T.T_GROUPID IN (?,?) AND T.T_VALIDTODATE = TO_DATE('31.12.9999','dd.mm.yyyy' ) " + 
              "  AND T.T_GENERAL = CHR(88) AND T.T_OBJECT = ? ";

  cmd = RsdCommand(query);
  cmd.addParam( "", RSDBP_IN, группа_ЮЛ);
  cmd.addParam( "", RSDBP_IN, группа_ФЛ);
  cmd.addParam( "", RSDBP_IN, String(PartyID:10:o));

  rs = RsdRecordset(cmd);

  if(rs.movenext)

    obj.GroupID    = SQL_ConvType(rs.value("t_GroupID"));
    obj.AttrID     = SQL_ConvType(rs.value("t_AttrID"));

  end;

  return obj;
end;

//Сохраняет запись для валютной пары клиента из списка
macro MdSetClientList( Buf /* :CMdClientList Буфер записи */):WebServiceResponse
  var stat:integer = 0;
  var sql, query, ds, query_g, ds_g;
  var GroupID = -1;
  var AttrID = -1;
  var GroupClient;
  var ErrMsg = "";

  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();

  InitError();  

  if(IsStopTrade() )   
    sql = RSDCommand("UPDATE DRKCLIENT_DBT SET T_DEALTYPE = ? WHERE T_PARTYID = ? AND T_CURPAIRID = ?");
    sql.addParam( "", RSDBP_IN, SP_GetNameAlgNumberAlg(Buf.DealType) );
    sql.addParam( "", RSDBP_IN, Buf.PartyID );
    sql.addParam( "", RSDBP_IN, Buf.CurPairID );
    sql.execute();

    sql = RSDCommand("UPDATE DRKCLIENT_DBT SET T_GROUPID = ?, T_ATTRID = ? WHERE T_PARTYID = ?");
    if(ValType( Buf.Group ) != V_UNDEF)
      GroupID = Buf.Group.GroupID;
      AttrID  = Buf.Group.AttrID; 
    end; 
    sql.addParam( "", RSDBP_IN, GroupID );
    sql.addParam( "", RSDBP_IN, AttrID );
    sql.addParam( "", RSDBP_IN, Buf.PartyID );
    sql.execute();

    GroupClient = GetGroupClient(Buf.PartyID);

    var CategClient = RsbObjCategories (3, String(Buf.PartyID:10:o));

    if((GroupClient.GroupID > 0) and (GroupClient.AttrID > 0))
      if(ValType( Buf.Group ) != V_UNDEF)
        if((Buf.Group.GroupID != GroupClient.GroupID) OR (Buf.Group.AttrID != GroupClient.AttrID))
          CategClient.ConnectAttr(Buf.Group.GroupID,String(Buf.Group.AttrID),null,null,{curdate});
        end;
      else
        CategClient.DisconnectAttr(GroupClient.GroupID,GroupClient.AttrID);
      end; 
    else
      if(ValType( Buf.Group ) != V_UNDEF)
        CategClient.ConnectAttr(Buf.Group.GroupID,String(Buf.Group.AttrID),null,null,{curdate});
      end;
    end;  
    CategClient.Save(null);

    sql = RSDCommand("UPDATE DRKPARAMS_DBT SET T_SPRED1 = ?, T_SPRED2 = ?, T_SPRED3 = ?, T_MARGINBUY = ?, T_MARGINSALE = ? WHERE T_DOCKIND = RSI_MD.mdIndividualRange AND T_DOCID = ? AND T_CURPAIRID = ?");
    sql.addParam( "", RSDBP_IN, Buf.Spred1 );
    sql.addParam( "", RSDBP_IN, Buf.Spred2 );
    sql.addParam( "", RSDBP_IN, Buf.Spred3 );
    sql.addParam( "", RSDBP_IN, Buf.Delta_b );
    sql.addParam( "", RSDBP_IN, Buf.Delta_S );
    sql.addParam( "", RSDBP_IN, Buf.PartyID );
    sql.addParam( "", RSDBP_IN, Buf.CurPairID );
    sql.execute();

    GroupClient = GetGroupClient(Buf.PartyID);
    query = "select T_ID from DRKCURPAIR_DBT";
    ds = TRsbDataSet(query);
    while( ds.MoveNext() )
      if((GroupClient.GroupID > 0) and (GroupClient.AttrID > 0))
        query_g = "select T_ID from DRKPARAMS_DBT WHERE T_DOCKIND = RSI_MD.mdGroupRange AND T_DOCID = " + String(GroupClient.AttrID) + " AND T_GROUPID = " + String(GroupClient.GroupID) + " AND T_CURPAIRID = " + ds.ID;
        ds_g = TRsbDataSet(query_g);
        if(NOT ds_g.MoveNext())
          sql = RSDCommand("INSERT INTO DRKPARAMS_DBT (T_DOCKIND, T_GROUPID, T_DOCID, T_CURPAIRID, T_SPRED1, T_SPRED2, T_SPRED3, T_MARGINBUY, T_MARGINSALE, T_MARGINCOVERBUY, T_MARGINCOVERSALE, " + 
                           " T_MARGINTOMBUY, T_MARGINTOMSALE, T_MARGINSPOTBUY, T_MARGINSPOTSALE  ) VALUES (RSI_MD.mdGroupRange, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )");
          sql.addParam( "", RSDBP_IN, GroupClient.GroupID );
          sql.addParam( "", RSDBP_IN, GroupClient.AttrID );
          sql.addParam( "", RSDBP_IN, ds.ID );
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.execute();
        end;
      end;
    end;
  else 
    stat = 1;
    ErrMsg = string(IS_STOP_TRADE_ERR_MSG);
  end;  

  if( stat != 0 )
    if( ErrMsg != "" )
       ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, ErrMsg );
    else
       stat = -1;
       ErrMsg = GetErrMsg();
       if( ErrMsg != "" )
          ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, ErrMsg );
       else
          ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, "Ошибка транзакции сохранения" );
       end;
    end;
  end;

  return ResponseBuilder.Result;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

//Сохраняет запись для валютной пары группы клиента из списка
macro MdSetGroupList( Buf /* :CMdClientList Буфер записи */):WebServiceResponse
  var stat:integer = 0;
  var sql, query, ds;
  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();
  var ErrMsg = "";

  InitError();

  if(IsStopTrade() )   
    sql = RSDCommand("UPDATE DRKPARAMS_DBT SET T_SPRED1 = ?, T_SPRED2 = ?, T_SPRED3 = ?, T_MARGINBUY = ?, T_MARGINSALE = ? WHERE T_DOCKIND = RSI_MD.mdGroupRange AND T_GROUPID = ? AND T_DOCID = ? AND T_CURPAIRID = ?");
    sql.addParam( "", RSDBP_IN, Buf.Spred1 );
    sql.addParam( "", RSDBP_IN, Buf.Spred2 );
    sql.addParam( "", RSDBP_IN, Buf.Spred3 );
    sql.addParam( "", RSDBP_IN, Buf.Delta_b );
    sql.addParam( "", RSDBP_IN, Buf.Delta_S );
    sql.addParam( "", RSDBP_IN, Buf.Group.GroupID );
    sql.addParam( "", RSDBP_IN, Buf.Group.AttrID );
    sql.addParam( "", RSDBP_IN, Buf.CurPairID );
    sql.execute();
  else 
    stat = 1;
    ErrMsg = string(IS_STOP_TRADE_ERR_MSG);
  end;  

  if( stat != 0 )
    if( ErrMsg != "" )
       ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, ErrMsg );
    else
       stat = -1;
       ErrMsg = GetErrMsg();
       if( ErrMsg != "" )
          ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, ErrMsg );
       else
          ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, "Ошибка транзакции сохранения" );
       end;
    end;
  end;

  return ResponseBuilder.Result;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

//Добавляет клиента
macro MdAddClientList( PartyID:Integer):WebServiceResponse
  var stat:integer = -1;
  var sql, query, query_g, ds, ds_g;
  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();
  var GroupClient:TWebClientGroup;

  InitError();

  query = "select T_ID, RSB_SECUR.GetDealClientShortName(T_PARTYID) t_ClientName from DRKCLIENT_DBT WHERE T_PARTYID = " + PartyID;

  ds = TRsbDataSet(query);
  if(NOT ds.MoveNext())
    GroupClient = GetGroupClient(PartyID);

    query = "select T_ID from DRKCURPAIR_DBT";
    ds = TRsbDataSet(query);
  while( ds.MoveNext() )
      sql = RSDCommand("INSERT INTO DRKCLIENT_DBT (T_PARTYID, T_GROUPID, T_ATTRID, T_CURPAIRID, T_DEALSTATUS, T_OPER, T_DEALTYPE) VALUES (?, ?, ?, ?, ?, ?, ?)");
    sql.addParam( "", RSDBP_IN, PartyID );
    sql.addParam( "", RSDBP_IN, GroupClient.GroupID );
    sql.addParam( "", RSDBP_IN, GroupClient.AttrID );
    sql.addParam( "", RSDBP_IN, ds.ID );
    sql.addParam( "", RSDBP_IN, 0 );
    sql.addParam( "", RSDBP_IN, {oper});
    sql.addParam( "", RSDBP_IN, 1);
    sql.execute();

      sql = RSDCommand("INSERT INTO DRKPARAMS_DBT (T_DOCKIND, T_GROUPID, T_DOCID, T_CURPAIRID, T_SPRED1, T_SPRED2, T_SPRED3, T_MARGINBUY, T_MARGINSALE, T_MARGINCOVERBUY, T_MARGINCOVERSALE,  "+ 
                       " T_MARGINTOMBUY, T_MARGINTOMSALE, T_MARGINSPOTBUY, T_MARGINSPOTSALE ) VALUES (RSI_MD.mdIndividualRange, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
      sql.addParam( "", RSDBP_IN, -1);
    sql.addParam( "", RSDBP_IN, PartyID );
    sql.addParam( "", RSDBP_IN, ds.ID );
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.addParam( "", RSDBP_IN, 0);
    sql.execute();

      if((GroupClient.GroupID > 0) and (GroupClient.AttrID > 0))
        query_g = "select T_ID from DRKPARAMS_DBT WHERE T_DOCKIND = RSI_MD.mdGroupRange AND T_DOCID = " + String(GroupClient.AttrID) + " AND T_GROUPID = " + String(GroupClient.GroupID) + " AND T_CURPAIRID = " + ds.ID;
        ds_g = TRsbDataSet(query_g);
        if(NOT ds_g.MoveNext())
          sql = RSDCommand("INSERT INTO DRKPARAMS_DBT (T_DOCKIND, T_GROUPID, T_DOCID, T_CURPAIRID, T_SPRED1, T_SPRED2, T_SPRED3, T_MARGINBUY, T_MARGINSALE, T_MARGINCOVERBUY, T_MARGINCOVERSALE, "+ 
                           " T_MARGINTOMBUY, T_MARGINTOMSALE, T_MARGINSPOTBUY, T_MARGINSPOTSALE ) VALUES (RSI_MD.mdGroupRange, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
          sql.addParam( "", RSDBP_IN, GroupClient.GroupID );
          sql.addParam( "", RSDBP_IN, GroupClient.AttrID );
          sql.addParam( "", RSDBP_IN, ds.ID );
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.addParam( "", RSDBP_IN, 0);
          sql.execute();
        end;
      end;
    end;
  else
     stat = 1;
     ResponseBuilder.AddErrorEx(stat, MessageSeverity.RuntimeError, "Клиент " + ds.ClientName + " уже добавлен в список!");
  end;

  return ResponseBuilder.Result;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;

//Удаляет клиента
macro MdDelClientList( PartyID:Integer):WebServiceResponse
  var stat:integer = -1;
  var sql, query, ds;
  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();
  var GroupClient:TWebClientGroup;

  InitError();

  sql = RSDCommand("DELETE FROM DRKPARAMS_DBT WHERE T_DOCID = ?");
  sql.addParam( "", RSDBP_IN, PartyID );
  sql.execute();

  sql = RSDCommand("DELETE FROM DRKCLIENT_DBT WHERE T_PARTYID = ?");
  sql.addParam( "", RSDBP_IN, PartyID );
  sql.execute();

  return ResponseBuilder.Result;

OnError( err )
  WSRunError( "ws_md_tradeclient.mac", err, stat );
end;
