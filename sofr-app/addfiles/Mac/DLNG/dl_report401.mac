/*
$Name:         dl_report401.mac
$Module:       БО ЦБ, ФИССиКО, УВ, СВ
$Description:  Выборка данных для Ф401
*/
import  dlquery, dpstdrep;

private const BO_VA   = "N";  //Учтенные векселя

// Подразделы отчета
const PART_ALL     = 0; // все
const PART_ONE     = 1; // Активы
const PART_TWO     = 2; // Пассивы

// Подразделы отчета
const PART_3_1    = 1;
const PART_3_2    = 2; 

/*строки раздела 3.1*/
private const RUB_BANK    = 0,
              RUB_OTHER   = 1,
              USD_BANK    = 2,
              USD_OTHER   = 3,
              EUR_BANK    = 4,
              EUR_OTHER   = 5,
              JPY_BANK    = 6,
              JPY_OTHER   = 7,
              CNY_BANK    = 8,
              CNY_OTHER   = 9,
              OTHER_BANK  = 10,
              OTHER_OTHER = 11;

/*строки раздела 3.2*/
private const RUB_BANK_REQ    = 0,
              RUB_BANK_COM    = 1,
              RUB_OTHER_REQ   = 2,
              RUB_OTHER_COM   = 3,
              USD_BANK_REQ    = 4,
              USD_BANK_COM    = 5,
              USD_OTHER_REQ   = 6,
              USD_OTHER_COM   = 7,
              EUR_BANK_REQ    = 8,
              EUR_BANK_COM    = 9,
              EUR_OTHER_REQ   = 10,
              EUR_OTHER_COM   = 11,
              JPY_BANK_REQ    = 12,
              JPY_BANK_COM    = 13,
              JPY_OTHER_REQ   = 14,
              JPY_OTHER_COM   = 15,
              CNY_BANK_REQ    = 16,
              CNY_BANK_COM    = 17,
              CNY_OTHER_REQ   = 18,
              CNY_OTHER_COM   = 19,
              OTHER_BANK_REQ  = 20,
              OTHER_BANK_COM  = 21,
              OTHER_OTHER_REQ = 22,
              OTHER_OTHER_COM = 23;

/* ********************** */
/*         Фильтр         */
/* ********************** */
private class TFilter
  var Departments:string = string({OperDprt}), // Список филиалов по которым выбираются ц/б
      BegDate:date       = {curdate},          // Дата начала отчетного периода
      EndDate:date       = {curdate},          // Дата окончания отчетного периода
      RepPart:integer    = 0;                  // Подраздел отчета
end;

/* Полезные функции */
class C_401Tools()
  const OUR_COUNTRY_CODE_LAT       = "RUS",  //Код нашей страны, латиница
        INTERNATIONAL_COUNTRY_CODE = "998",  //Код для международных организаций
        UNKNOWN_COUNTRY_CODE       = "999";  //Код страны неизвестен
  const UNKNOW_INN_RES_PHYS = "000000000000",
        UNKNOW_INN_RES_YUR  = "0000000000",
        UNKNOW_INN_NOTRES_PHYS = "00000",
        UNKNOW_INN_NOTRES_YUR  = "000";

  macro GetSQLStr(str:String)
    var sqlstr = "";

    if((ValType(str) == V_UNDEF) or (str == ""))
      sqlstr = "CHR(1)";
    else
      sqlstr = "'"+StrSubst(str, "'", "''")+"'";
    end;

    return sqlstr;
  end;

end;

private class C_3_1()
  var C_4:numeric      = $0.0,
      C_5:numeric      = $0.0,
      C_6:numeric      = $0.0,
      C_7:numeric      = $0.0,
      C_8:numeric      = $0.0,
      C_9:numeric      = $0.0,
      C_10:numeric     = $0.0,
      C_11:numeric     = $0.0,
      C_12:numeric     = $0.0,
      C_13:numeric     = $0.0,
      C_14:numeric     = $0.0,
      C_15:numeric     = $0.0;
end;

private class (TArray) TData_3_1

  /* Очистить массив. */
  macro ClearArray
     this.Size = 0;

     var i = RUB_BANK;
     while( i <= OTHER_OTHER )
        this.(Size) = C_3_1();
        i = i + 1;
     end;
  end;

  private macro GetNum( Data )
     var v_Num = OTHER_OTHER;
     if( Data.CCY == "RUB" )
       if( Data.IsBank == "X" )
          v_Num = RUB_BANK;
       else
          v_Num = RUB_OTHER;
       end;
     elif(Data.CCY == "USD" )
       if( Data.IsBank == "X" )
          v_Num = USD_BANK;
       else
          v_Num = USD_OTHER;
       end;
     elif(Data.CCY == "EUR" )
       if( Data.IsBank == "X" )
          v_Num = EUR_BANK;
       else
          v_Num = EUR_OTHER;
       end;
     elif(Data.CCY == "JPY" )
       if( Data.IsBank == "X" )
          v_Num = JPY_BANK;
       else
          v_Num = JPY_OTHER;
       end;
     elif(Data.CCY == "CNY" )
       if( Data.IsBank == "X" )
          v_Num = CNY_BANK;
       else
          v_Num = CNY_OTHER;
       end;
     else
       if( Data.IsBank == "X" )
          v_Num = OTHER_BANK;
       else
          v_Num = OTHER_OTHER;
       end;
     end;
     return v_Num;
  end;

  macro Add( Data )
     var Num = GetNum( Data );

     this.(Num).C_4   = Data.C_4;
     this.(Num).C_5   = Data.C_5;
     this.(Num).C_6   = Data.C_6;
     this.(Num).C_7   = Data.C_7;
     this.(Num).C_8   = Data.C_8;
     this.(Num).C_9   = Data.C_9;
     this.(Num).C_10  = Data.C_10; 
     this.(Num).C_11  = Data.C_11; 
     this.(Num).C_12  = Data.C_12; 
     this.(Num).C_13  = Data.C_13; 
     this.(Num).C_14  = Data.C_14; 
     this.(Num).C_15  = Data.C_15; 

  end;

  ClearArray;
end;

private class C_3_2()
  var C_5:numeric      = $0.0,
      C_6:numeric      = $0.0,
      C_7:numeric      = $0.0,
      C_8:numeric      = $0.0,
      C_9:numeric      = $0.0,
      C_10:numeric     = $0.0,
      C_11:numeric     = $0.0,
      C_12:numeric     = $0.0,
      C_13:numeric     = $0.0,
      C_14:numeric     = $0.0;
end;

private class (TArray) TData_3_2

  /* Очистить массив. */
  macro ClearArray
     this.Size = 0;

     var i = RUB_BANK_REQ;
     while( i <= OTHER_OTHER_COM )
        this.(Size) = C_3_2();
        i = i + 1;
     end;
  end;

  private macro GetNum( Data )
     var v_Num = OTHER_OTHER;
     if( Data.CCY == "RUB" )
       if( Data.IsBank == "X" )
          if( Data.IsReq == "X" )
             v_Num = RUB_BANK_REQ;
          else
             v_Num = RUB_BANK_COM;
          end;
       else
          if( Data.IsReq == "X" )
             v_Num = RUB_OTHER_REQ;
          else
             v_Num = RUB_OTHER_COM;
          end;
       end;
     elif(Data.CCY == "USD" )
       if( Data.IsBank == "X" )
          if( Data.IsReq == "X" )
             v_Num = USD_BANK_REQ;
          else
             v_Num = USD_BANK_COM;
          end;
       else
          if( Data.IsReq == "X" )
             v_Num = USD_OTHER_REQ;
          else
             v_Num = USD_OTHER_COM;
          end;
       end;
     elif(Data.CCY == "EUR" )
       if( Data.IsBank == "X" )
          if( Data.IsReq == "X" )
             v_Num = EUR_BANK_REQ;
          else
             v_Num = EUR_BANK_COM;
          end;
       else
          if( Data.IsReq == "X" )
             v_Num = EUR_OTHER_REQ;
          else
             v_Num = EUR_OTHER_COM;
          end;
       end;
     elif(Data.CCY == "JPY" )
       if( Data.IsBank == "X" )
          if( Data.IsReq == "X" )
             v_Num = JPY_BANK_REQ;
          else
             v_Num = JPY_BANK_COM;
          end;
       else
          if( Data.IsReq == "X" )
             v_Num = JPY_OTHER_REQ;
          else
             v_Num = JPY_OTHER_COM;
          end;
       end;
     elif(Data.CCY == "CNY" )
       if( Data.IsBank == "X" )
          if( Data.IsReq == "X" )
             v_Num = CNY_BANK_REQ;
          else
             v_Num = CNY_BANK_COM;
          end;
       else
          if( Data.IsReq == "X" )
             v_Num = CNY_OTHER_REQ;
          else
             v_Num = CNY_OTHER_COM;
          end;
       end;
     else
       if( Data.IsBank == "X" )
          if( Data.IsReq == "X" )
             v_Num = OTHER_BANK_REQ;
          else
             v_Num = OTHER_BANK_COM;
          end;
       else
          if( Data.IsReq == "X" )
             v_Num = OTHER_OTHER_REQ;
          else
             v_Num = OTHER_OTHER_COM;
          end;
       end;
     end;
     return v_Num;
  end;

  macro Add( Data )
     var Num = GetNum( Data );

     this.(Num).C_5   = Data.C_5;
     this.(Num).C_6   = Data.C_6;
     this.(Num).C_7   = Data.C_7;
     this.(Num).C_8   = Data.C_8;
     this.(Num).C_9   = Data.C_9;
     this.(Num).C_10  = Data.C_10; 
     this.(Num).C_11  = Data.C_11; 
     this.(Num).C_12  = Data.C_12; 
     this.(Num).C_13  = Data.C_13; 
     this.(Num).C_14  = Data.C_14; 

  end;

  ClearArray;
end;

/* ********************************************** */
/* Класс сбора данных  (раздел 1,2) */
/* ********************************************** */
private class С_401_1_2(flt_)
  private var fltr = flt_;

  private macro СформироватьКодНерезидента(ConrtID, BegDate, Code:@variant, CodeSym3:@variant, Txt1:@variant) 
    var query = RsdCommand("begin\n rsb_401rep.GetNotResidentCode(?,?,?,?,?);\n end; ");

    query.addParam("ConrtID",         RSDBP_IN,  ConrtID );
    query.addParam("OnDate",          RSDBP_IN,  BegDate );
    query.addParam("CodeNotResident", RSDBP_OUT, V_STRING );
    query.addParam("sym3",            RSDBP_OUT, V_STRING );
    query.addParam("txt1",            RSDBP_OUT, V_STRING );

    query.execute();

    Code     =  query.value(2);
    CodeSym3 =  query.value(3);
    Txt1     =  query.value(4);
  end;      

  Macro InsertData( ConrtID:integer, BegDate:date, EndDate:date , NumPeriod:integer, Period:integer, Part:integer);
    var query, cmd;
    var BegDateSQL = GetSQLDate(BegDate);
    var EndDateSQL = GetSQLDate(EndDate);
    var CodeNer = "", CodeNerSym3 = "", Txt1 = "";
    var sql, exec;
    СформироватьКодНерезидента(ConrtID, BegDate, @CodeNer, @CodeNerSym3, @Txt1) ; // на начало периода
    

    if( (CodeNer != "") and (CodeNerSym3 != ""))
    
    
      // п.4.4.1./4.4.4
      sql = " DECLARE "
          + " BEGIN "
          + "    rsb_401rep.CreateDealData(?, ?, ?, ?, ?, ?, ?, ?); "
          + " END; ";
      
      exec = RSDCommand(sql);
    
      exec.addParam( "", RSDBP_IN, ConrtID );
      exec.addParam( "", RSDBP_IN, Part );
      exec.addParam( "", RSDBP_IN, BegDate );
      exec.addParam( "", RSDBP_IN, EndDate );
      exec.addParam( "", RSDBP_IN, CodeNer );
      exec.addParam( "", RSDBP_IN, NumPeriod );
      exec.addParam( "", RSDBP_IN, CodeNerSym3 );
      exec.addParam( "", RSDBP_IN, Txt1 );
      exec.execute();

        ///тут остальные вставки по периоду для нерезидента

      if(Part == PART_ONE)

      elif(Part == PART_TWO)
/*
        sql = " DECLARE "
            + " BEGIN "
            + "    rsb_401rep.CreateOwnBondDealData(?, ?, ?, ?, ?, ?); "
            + " END; ";
        
        exec = RSDCommand(sql);
      
        exec.addParam( "", RSDBP_IN, ConrtID );
        exec.addParam( "", RSDBP_IN, Part );
        exec.addParam( "", RSDBP_IN, BegDate );
        exec.addParam( "", RSDBP_IN, EndDate );
        exec.addParam( "", RSDBP_IN, CodeNer );
        exec.addParam( "", RSDBP_IN, NumPeriod );
        exec.execute();
*/
      end; 
    end;


  End;          

  private macro ПолучитьНачалоПериодовЗапрос()
    var query = 
           "   WITH datas "
           +"     AS (  SELECT DISTINCT "
           +"                  attrib.t_validFromDate begdate, party_wv.t_objectId ID "
           +"             FROM (SELECT TO_CHAR (party.t_partyID, 'fm0000000000') t_objectId "
           +"                     FROM dparty_dbt party "
           +"                    WHERE     PARTY.T_NOTRESIDENT = CHR (88) "
           +"                          AND PARTY.t_partyID = ?) party_wv "
           +"                  LEFT JOIN "
           +"                  (SELECT obj.t_object, obj.t_validFromDate, obj.t_validToDate "
           +"                     FROM dobjattr_dbt attr, dobjatcor_dbt obj "
           +"                    WHERE     attr.t_AttrID = obj.t_AttrID "
           +"                          AND obj.t_objecttype = 3 "
           +"                          AND obj.t_groupID IN (86, 87) "
           +"                          AND attr.t_objecttype = 3 "
           +"                          AND attr.t_groupID IN (86, 87)) attrib "
           +"                    ON attrib.t_object = party_wv.t_objectId "
           +"         ORDER BY attrib.t_validFromDate) "
           +" SELECT datas.begdate, COUNT (1) OVER (PARTITION BY ID ORDER BY ID) Num "
           +" , NVL (LEAD (datas.begdate -1 ,1) over (ORDER BY datas.begdate), ?)  AS Enddate "
           +"  FROM datas "
           +"  Where datas.begdate between ? and ? "
           +"  Order by datas.begdate "
           ;
    return query;

  end;
  /*Подготовить данные*/
  macro PrepareData()
    var query, cmd;
    var queryContr, cmdContr, DataSetContr;
    var queryDate, cmdDate, DataSetDate;
    var BegDateSQL = GetSQLDate(fltr.BegDate);
    var EndDateSQL = GetSQLDate(fltr.EndDate);


    Var Contr  = -1;    // нерезидент
    Var Period = 0;     // период (всего)
    Var NumPeriod = 0;  // номер подпериода
    Var IsPeriod  = 0;  // признак того, что для субъекта есть подпериоды 
    Var IsFirst = true;
    var ДатыПериода = TArray();

// отбор нерезидентов
    queryContr = "  SELECT party.t_PartyID PartyID "
                +"    FROM dparty_dbt party "
                +"   WHERE PARTY.T_NOTRESIDENT = chr(88) "
                +"          AND (   EXISTS "
                +"                    (SELECT 1 "
                +"                    FROM ddl_tick_dbt tick "
                +"                   WHERE     tick.t_PartyID = party.t_PartyID "
                +"                         AND tick.t_BOfficeKind IN "
                +"                               ( " + DL_SECURITYDOC + "," + DL_RETIREMENT +","+ DL_AVRWRT+","+ DL_VEKSELACCOUNTED+","+ DL_SECUROWN+","+ DL_AVRWRTOWN +","+ DL_RETIREMENT_OWN +")) "
                +"            OR EXISTS "
                +"                  (SELECT 1 "
                +"                    FROM ddl_order_dbt ord "
                +"                    WHERE     ord.T_CONTRACTOR = party.t_PartyID "
                +"                          AND ord.T_CONTRACTKIND IN ("+DL_ORDER_VSSALE+", "+DL_ORDER_VSEMIS+")) "
                +"            OR EXISTS "
                +"                 (SELECT 1 "
                +"                    FROM dfininstr_dbt fin "
                +"                   WHERE fin.t_Issuer = party.t_PartyID)) "
                +"   UNION "
                +"   SELECT party.t_PartyID PartyID "
                +"     FROM dparty_dbt party "
                +"    WHERE PARTY.T_NOTRESIDENT = CHR (88) "
                +"          AND EXISTS "
                +"                 (SELECT 1 "
                +"                    FROM dobjlink_dbt lnk "
                +"                   WHERE     t_AttrType = "+ OBJTYPE_PARTY
                +"                         AND LPAD (party.t_PartyID, 10, '0') = lnk.t_AttrID "
                +"                         AND t_ObjectType = " + OBJTYPE_ACCOUNT
                +"                         AND REGEXP_LIKE (SUBSTR (t_ObjectID, 10), '5020(3|4)')) "
                ;  

    cmdContr = DL_RSDCommand(queryContr);

   DataSetContr = cmdContr.Execute();
   while( DataSetContr.moveNext())
     Contr = DataSetContr.PartyID;
     IsFirst = true;
     NumPeriod = 1;
     Period    = 0;
     ДатыПериода.size = 0;
     queryDate = ПолучитьНачалоПериодовЗапрос();

     cmdDate = DL_RSDCommand(queryDate);
     cmdDate.AddParam(Contr);
     cmdDate.AddParam(fltr.EndDate);
     cmdDate.AddParam(fltr.BegDate);
     cmdDate.AddParam(fltr.EndDate);
     DataSetDate = cmdDate.Execute();

     While( DataSetDate.moveNext())  // если есть периоды , значит код менялся
         IsPeriod = 1;        //есть подпериоды
         if( (DataSetDate.begdate > fltr.BegDate) and (IsFirst) ) // если начальный подпериод больше начала ОП, тогда добавим подпериод
           IsFirst = false;
           InsertData(Contr, date(fltr.begdate), date(DataSetDate.BegDate) -1 , NumPeriod, DataSetDate.Num + Period, fltr.RepPart);
           NumPeriod = NumPeriod + 1;
           Period = Period + 1;
         end;
         InsertData(Contr, date(DataSetDate.begdate), IIF(NumPeriod == Period, date(fltr.EndDate), date(DataSetDate.EndDate)), NumPeriod, DataSetDate.Num + Period, fltr.RepPart);

         IsFirst = false;
         NumPeriod = NumPeriod + 1;

     end;   

     If(not IsPeriod) // значит берем один период: с начала ОП до Конца ОП
         InsertData(Contr, date(fltr.begdate), date(fltr.EndDate), 1, 1, fltr.RepPart);

     end;  // периоды

   end; // субъект

  end;

  /* Запрос для SELECT'а */
  macro GetQuerySelect()
    var query = "   SELECT T_CODENOTRESIDENT, "                    
              + "          T_CODECY,"
              + "          T_STRNUMBER, "                         
              + "          SUM (T_RESTBEGIN) T_RESTBEGIN, "        
              + "          SUM (T_CHANGESOPER) T_CHANGESOPER, "    
              + "          SUM (T_CHANGESOVER) T_CHANGESOVER, "    
              + "          SUM (T_CHANGESOTHER) T_CHANGESOTHER, "  
              + "          SUM (T_RESTEND) T_RESTEND, "            
              + "          SUM (T_PRCSUM)  T_PRCSUM , "
              + "          T_ACCOUNT, "                
              + "          T_CODESYM3, "
              + "          T_TXT1 "             
              + "    FROM D401SECUR_TMP "                          
              + "GROUP BY ROLLUP (( T_CODENOTRESIDENT, T_CODECY, T_STRNUMBER),(T_CODESYM3,T_TXT1,T_ACCOUNT)) "
              + "HAVING GROUPING_ID(T_CODENOTRESIDENT, T_CODECY, T_STRNUMBER) = 0 "
              + "ORDER BY T_CODENOTRESIDENT, T_CODECY, T_STRNUMBER "
              ;
    return query;
  end;
end;


/* ********************************************** */
/* Класс сбора данных для раздела 3.1 */
/* ********************************************** */
private class C_401_3_1(flt_)
  private var fltr = flt_;
  private var Arr = TData_3_1();
  private var i = RUB_BANK;

  /*Подготовить данные*/
  macro PrepareData()
     var Data_3_1:C_3_1;
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"ФИССиКО\" для раздела 3.1", "Подготовка данных по сделкам модуля \"ФИССиКО\" для раздела 3.1");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_401rep.DV_CreateData_3_1(?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, fltr.Departments);
      exec.AddParam( "", RSDBP_IN, fltr.BegDate);
      exec.AddParam( "", RSDBP_IN, fltr.EndDate);
      exec.execute();

      RemProgress();
  end;

  /*Получить данные*/
  macro GetData()
    var Query = "  select T.T_CURR_CCY_T6 T_CCY, T.T_ISBANK, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',0,T.T_REST_DBEG_USD)),0) c_4, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',0,T.T_REST_DEXEC_USD)),0) c_5, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',0,T.T_DIFF_USD)),0) c_6, "
               +"         0 c_7, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',0,T.T_REST_DEND_USD)),0) c_8, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',T.T_REST_DBEG_USD,0)),0) c_9, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',T.T_REST_DEXEC_USD,0)),0) c_10, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',T.T_DIFF_USD,0)),0) c_11, "
               +"         0 c_12, "
               +"         nvl(sum(decode(T.T_SYM1,'3А.1',T.T_REST_DEND_USD,0)),0) c_13, "
               +"         nvl(sum(T.T_MARGIN_IN_USD),0) c_14, "                         
               +"         nvl(sum(T.T_MARGIN_OUT_USD),0) c_15 "
               +"    from ddvrep401_tmp t "
               +"   where T.T_TXT2 = 1 "
               +"  group by T.T_CURR_CCY_T6, T.T_ISBANK ";
                                                      
    var DataRec = TRsbDataSet(Query);
    while(DataRec.MoveNext())
       Arr.Add(DataRec);
    end;
  end;

  macro GetNext()
    if( ((i + 1) < RUB_BANK) or ((i + 1) > OTHER_OTHER) )
       return false;
    end;
    i = i + 1;
    return true;
  end;

  macro КодВалюты()
     if( (i ==RUB_BANK ) or
         (i ==RUB_OTHER)
       )
        return "RUB";
     elif( (i ==USD_BANK ) or
         (i ==USD_OTHER)
       )
        return "USD";
     elif( (i ==EUR_BANK ) or
         (i ==  EUR_OTHER)
       )
        return "EUR";
     elif( (i ==JPY_BANK ) or
         (i ==  JPY_OTHER)
       )
        return "JPY";
     elif( (i ==CNY_BANK ) or
         (i ==  CNY_OTHER)
       )
        return "CNY";
     end;

     return "Other";
  end;

  macro Резидент()
     if( (i ==RUB_BANK) or
         (i ==USD_BANK) or   
         (i ==EUR_BANK) or   
         (i ==JPY_BANK) or   
         (i ==CNY_BANK) or    
         (i ==OTHER_BANK) 
       )
        return "Кредитные организации";
     end;
     return "Прочие";
  end;

  macro C_4()
    return Arr[i].c_4;
  end;

  macro C_5()
    return Arr[i].c_5;
  end;

  macro C_6()
    return Arr[i].c_6;
  end;

  macro C_7()
    return Arr[i].c_7;
  end;

  macro C_8()
    return Arr[i].c_8;
  end;

  macro C_9()
    return Arr[i].c_9;
  end;

  macro C_10()
    return Arr[i].c_10;
  end;

  macro C_11()
    return Arr[i].c_11;
  end;

  macro C_12()
    return Arr[i].c_12;
  end;

  macro C_13()
    return Arr[i].c_13;
  end;

  macro C_14()
    return Arr[i].c_14;
  end;

  macro C_15()
    return Arr[i].c_15;
  end;

end;

/* ********************************************** */
/* Класс сбора данных для раздела 3.2 */
/* ********************************************** */
private class C_401_3_2(flt_)
  private var fltr = flt_;
  private var Arr = TData_3_2();
  private var i = RUB_BANK_REQ;

  /*Подготовить данные*/
  macro PrepareData()
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"ФИССиКО\" для раздела 3.2", "Подготовка данных по сделкам модуля \"ФИССиКО\" для раздела 3.2");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_401rep.DV_CreateData_3_2(?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, fltr.Departments);
      exec.AddParam( "", RSDBP_IN, fltr.BegDate);
      exec.AddParam( "", RSDBP_IN, fltr.EndDate);
      exec.execute();

      RemProgress();
  end;

  /*Получить данные*/
  macro GetData()
    var Query = " SELECT T_CCY, "
              + "        T_ISBANK, "
              + "        T_IsReq, "
              + "        SUM (c_5) c_5, "
              + "        SUM (c_6) c_6, "
              + "        SUM (c_7) c_7, "
              + "        SUM (c_8) c_8, "
              + "        SUM (c_9) c_9, "
              + "        SUM (c_10) c_10, "
              + "        SUM (c_11) c_11, "
              + "        SUM (c_12) c_12, "
              + "        SUM (c_13) c_13, "
              + "        SUM (c_14) c_14 "
              + "   FROM (SELECT T.T_CURR_CCY_T6 T_CCY, "
              + "                T.T_ISBANK, "
              + "                CASE "
              + "                   WHEN T.T_SYM1 = '3А2.1' OR T.T_SYM1 = '3А2.2' THEN 'X' "
              + "                   ELSE CHR(0) "
              + "                END "
              + "                   T_IsReq, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, 0, T.T_REST_DBEG_USD) c_5, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, 0, T.T_REST_DEXEC_USD) c_6, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, 0, T.T_DIFF_USD) c_7, "       
              + "                0 c_8, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, 0, T.T_REST_DEND_USD) c_9, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, T.T_REST_DBEG_USD, 0) c_10, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, T.T_REST_DEXEC_USD, 0) c_11, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, T.T_DIFF_USD, 0) c_12, "      
              + "                0 c_13, "
              + "                DECODE (T.T_DVKIND, 7/*RSB_Derivatives.DV_FORWARD_FX*/, T.T_REST_DEND_USD, 0) c_14 "
              + "           FROM ddvrep401_tmp t "
              + "          WHERE T.T_TXT2 = 2) "
              + " GROUP BY T_CCY, T_ISBANK, t_isreq";
    var DataRec = TRsbDataSet(Query);
    while(DataRec.MoveNext())
       Arr.Add(DataRec);
    end;
  end;

  macro GetNext()
    if( ((i + 1) < RUB_BANK_REQ) or ((i + 1) > OTHER_OTHER_COM) )
       return false;
    end;
    i = i + 1;
    return true;
  end;

  macro КодВалюты()
     if( (i ==RUB_BANK_REQ ) or
         (i ==RUB_BANK_COM ) or   
         (i ==RUB_OTHER_REQ) or    
         (i ==RUB_OTHER_COM)
       )
        return "RUB";
     elif( (i ==USD_BANK_REQ ) or
         (i ==USD_BANK_COM ) or   
         (i ==USD_OTHER_REQ) or    
         (i ==USD_OTHER_COM)
       )
        return "USD";
     elif( (i ==EUR_BANK_REQ ) or
         (i ==  EUR_BANK_COM ) or   
         (i ==  EUR_OTHER_REQ) or    
         (i ==  EUR_OTHER_COM)
       )
        return "EUR";
     elif( (i ==JPY_BANK_REQ ) or
         (i ==  JPY_BANK_COM ) or   
         (i ==  JPY_OTHER_REQ) or    
         (i ==  JPY_OTHER_COM)
       )
        return "JPY";
     elif( (i ==CNY_BANK_REQ ) or
         (i ==  CNY_BANK_COM ) or   
         (i ==  CNY_OTHER_REQ) or    
         (i ==  CNY_OTHER_COM)
       )
        return "CNY";
     end;

     return "Other";
  end;

  macro Резидент()
     if( (i ==RUB_BANK_REQ) or
         (i ==RUB_BANK_COM) or   
         (i ==USD_BANK_REQ) or    
         (i ==USD_BANK_COM) or   
         (i ==EUR_BANK_REQ) or    
         (i ==EUR_BANK_COM) or   
         (i ==JPY_BANK_REQ) or    
         (i ==JPY_BANK_COM) or   
         (i ==CNY_BANK_REQ) or    
         (i ==CNY_BANK_COM) or   
         (i ==OTHER_BANK_REQ) or  
         (i ==OTHER_BANK_COM) 
       )
        return "Кредитные организации";
     end;
     return "Прочие";
  end;

  macro ТО()
     if( (i ==RUB_BANK_REQ) or
         (i ==RUB_OTHER_REQ) or   
         (i ==USD_BANK_REQ) or    
         (i ==USD_OTHER_REQ) or   
         (i ==EUR_BANK_REQ) or    
         (i ==EUR_OTHER_REQ) or   
         (i ==JPY_BANK_REQ) or    
         (i ==JPY_OTHER_REQ) or   
         (i ==CNY_BANK_REQ) or    
         (i ==CNY_OTHER_REQ) or   
         (i ==OTHER_BANK_REQ) or  
         (i ==OTHER_OTHER_REQ) 
       )
        return "Требования";
     end;
     return "Обязательства";
  end;
 
  macro C_5()
    return Arr[i].c_5;
  end;

  macro C_6()
    return Arr[i].c_6;
  end;

  macro C_7()
    return Arr[i].c_7;
  end;

  macro C_8()
    return Arr[i].c_8;
  end;

  macro C_9()
    return Arr[i].c_9;
  end;

  macro C_10()
    return Arr[i].c_10;
  end;

  macro C_11()
    return Arr[i].c_11;
  end;

  macro C_12()
    return Arr[i].c_12;
  end;

  macro C_13()
    return Arr[i].c_13;
  end;

  macro C_14()
    return Arr[i].c_14;
  end;

end;

/* ********************************************** */
/* Клас данных по 401 форме (1,2 раздел)            */
/* ********************************************** */
class C_401_Secur
  var КодНерезидента:string                = "",         // Код нерезидента
      КодВалюты:string                     = "",         // Код валюты, буквенный
      НомерСтроки:string                   = "",         // Номер строки 
      ОстатокНачало:numeric                = $0.0,       // Остаток на начало отчетного периода
      ИзменениеАктивовОперация:numeric     = $0.0,       // Изменение активов в результате операций
      ИзменениеАктивовПереоценкка:numeric  = $0.0,       // Изменение активов в результате переоценки (гр.5 - гр.1 -гр.2 - гр.4)
      ПрочиеИзменения:numeric              = $0.0,       // Прочие изменения активов
      ОстатокКонец:numeric                 = $0.0,       // Остаток на конец  отчетного периода
      НачисленныеПроценты:numeric          = $0.0,       // Начисленные проценты и  объявленные дивиденды в отчетном периоде
      RepData                              = TArray();   // массив данных (расшифровки)

  private var flt = TFilter;
  private var objData = null;
  private var DataRec = null;

  private class C_401_data (
                            CodeNotResident,
                            CodeSym3,
                            Account,      
                            Txt1,      
                            CodeCy,         
                            StrNumber,      
                            RestBegin,      
                            ChangesOper,    
                            ChangesOver,    
                            ChangesOther,   
                            RestEnd,        
                            PrcSum         )

   var КодНерезидента            =  CodeNotResident, // Код нерезидента                                                     
    КодНерезидента_Sym3          =  CodeSym3,        // Код нерезидента Sym3                                                          
    Счет                         =  Account,         // Счет                                                        
    ДопИнфо                      =  Txt1,            // Дополнительная информация                                  
    КодВалюты                    =  CodeCy,          // Код валюты                                                          
    НомерСтроки                  =  StrNumber,       // Номер строки                                                        
    ОстатокНачало                =  RestBegin,       // Остаток на начало отчетного периода                                  
    ИзменениеАктивовОперация     =  ChangesOper,     // Изменение активов в результате операций                              
    ИзменениеАктивовПереоценкка  =  ChangesOver,     // Изменение активов в результате переоценки (гр.5 - гр.1 -гр.2 - гр.4) 
    ПрочиеИзменения              =  ChangesOther,    // Прочие изменения активов                                            
    ОстатокКонец                 =  RestEnd,         // Остаток на конец  отчетного периода                                  
    НачисленныеПроценты          =  PrcSum,          // Начисленные проценты и  объявленные дивиденды в отчетном периоде     

  end;


  private macro SetValues()

    КодНерезидента               =  DataRec.CodeNotResident; // Код нерезидента                                                     
    КодВалюты                    =  DataRec.CodeCy;          // Код валюты                                                          
    НомерСтроки                  =  DataRec.StrNumber;       // Номер строки                                                        
    ОстатокНачало                =  DataRec.RestBegin;       // Остаток на начало отчетного периода                                  
    ИзменениеАктивовОперация     =  DataRec.ChangesOper;     // Изменение активов в результате операций                              
    ИзменениеАктивовПереоценкка  =  DataRec.ChangesOver;     // Изменение активов в результате переоценки (гр.5 - гр.1 -гр.2 - гр.4) 
    ПрочиеИзменения              =  DataRec.ChangesOther;    // Прочие изменения активов                                            
    ОстатокКонец                 =  DataRec.RestEnd;         // Остаток на конец  отчетного периода                                  
    НачисленныеПроценты          =  DataRec.PrcSum;          // Начисленные проценты и  объявленные дивиденды в отчетном периоде     
  end;

  private macro PrepareData()
    SQL_Truncate("d401secur_tmp");

    if ( (PART_ONE == flt.RepPart) OR (PART_TWO == flt.RepPart))      // если первый или второй раздел
      objData = С_401_1_2(flt);
    end;

    if (null != objData)
      objData.PrepareData();
    end;
  end;

  // Установить фильтр
  macro SetFilter(_Departments:TArray, _BegDate:date, _EndDate:date, _RepPart:integer)
    if (ValType(_Departments) != V_UNDEF)
      flt.Departments = "";
      for(var dep, _Departments)
        if (flt.Departments != "")
          flt.Departments = flt.Departments + ",";
        end;
        flt.Departments = string(flt.Departments) + string(dep);
      end;
    end;
    if (ValType(_BegDate) != V_UNDEF)
      flt.BegDate = _BegDate;
    end;
    if (ValType(_EndDate) != V_UNDEF)
      flt.EndDate = _EndDate;
    end;
    if (ValType(_RepPart) != V_UNDEF)
      flt.RepPart = _RepPart;
    end;
  end;

  // Формирование выборки и получение первой записи
  macro GetFirst():bool
    var stat = 0;
    PrepareData();

    DataRec = TRsbDataSet(objData.GetQuerySelect());
//    stat = DataRec.moveNext();
    RepData.size = 0;
    While( ( (stat = DataRec.moveNext()) AND stat ) AND (DataRec.T_Account != null) AND ( ValType(DataRec.T_Account) != V_UNDEF))
      RepData[RepData.size] = C_401_data(
                                         DataRec.CodeNotResident, 
                                         DataRec.CodeSym3,          
                                         DataRec.Account,       
                                         DataRec.Txt1,       
                                         DataRec.CodeCy,          
                                         DataRec.StrNumber,       
                                         DataRec.RestBegin,       
                                         DataRec.ChangesOper,     
                                         DataRec.ChangesOver,     
                                         DataRec.ChangesOther,    
                                         DataRec.RestEnd,         
                                         DataRec.PrcSum);
    end;

    if(stat)
      SetValues();
    end;

    return stat;
  end;
  // Получение следующей записи
  macro GetNext():bool
    var stat = 0;
    RepData.size = 0;
//    stat = DataRec.moveNext();

    While( ( (stat = DataRec.moveNext()) AND stat ) AND (DataRec.T_Account != null) AND ( ValType(DataRec.T_Account) != V_UNDEF))
      RepData[RepData.size] = C_401_data(
                                         DataRec.CodeNotResident, 
                                         DataRec.CodeSym3,          
                                         DataRec.Account,       
                                         DataRec.Txt1,       
                                         DataRec.CodeCy,          
                                         DataRec.StrNumber,       
                                         DataRec.RestBegin,       
                                         DataRec.ChangesOper,     
                                         DataRec.ChangesOver,     
                                         DataRec.ChangesOther,    
                                         DataRec.RestEnd,         
                                         DataRec.PrcSum);
    end;
    
    if(stat)
      SetValues();
    end;

    return stat;
  end;
end;

/* ********************************************** */
/* Клас данных по 401 форме (3 раздел)            */
/* ********************************************** */
class C_401deriv
  var КодВалюты:string = "",
      Резидент:string  = "",
      ТО:string        = "",
      C_4:numeric      = $0.0,
      C_5:numeric      = $0.0,
      C_6:numeric      = $0.0,
      C_7:numeric      = $0.0,
      C_8:numeric      = $0.0,
      C_9:numeric      = $0.0,
      C_10:numeric     = $0.0,
      C_11:numeric     = $0.0,
      C_12:numeric     = $0.0,
      C_13:numeric     = $0.0,
      C_14:numeric     = $0.0,
      C_15:numeric     = $0.0,
      RepData          = TArray();   // массив данных (расшифровки)

  private class C_401_Data ( p_Sym1,
                             p_Sym2,
                             p_Sym3,
                             p_Sym4,
                             p_Val1,
                             p_Val2,
                             p_Val3,
                             p_Val4,
                             p_Val5,
                             p_Val6,
                             p_Val7,
                             p_Val8,
                             p_Val9,
                             p_Val10,
                             p_Val11,
                             p_Val12,
                             p_Txt1,
                             p_Txt2,
                             p_Txt3,
                             p_Txt4,
                             p_Txt5
                           )        
   var Sym1  = p_Sym1,             
       Sym2  = p_Sym2,             
       Sym3  = p_Sym3,             
       Sym4  = p_Sym4,             
       Val1  = p_Val1,             
       Val2  = p_Val2,             
       Val3  = p_Val3,             
       Val4  = p_Val4,             
       Val5  = p_Val5,             
       Val6  = p_Val6,             
       Val7  = p_Val7,             
       Val8  = p_Val8,             
       Val9  = p_Val9,             
       Val10 = p_Val10,            
       Val11 = p_Val11,            
       Val12 = p_Val12,
       Txt1  = p_Txt1,
       Txt2  = p_Txt2,
       Txt3  = p_Txt3,
       Txt4  = p_Txt4,
       Txt5  = p_Txt5;
  end;                           

  var Протокол:TArray = TArray(); // Протокол пока не реализован!!!, будет позже!!!

  private var flt = TFilter;
  private var objData = null;

  private macro SetValues()
    if (PART_3_1 == flt.RepPart)
       КодВалюты = objData.КодВалюты;
       Резидент  = objData.Резидент;
       C_4       = objData.C_4;
       C_5       = objData.C_5;
       C_6       = objData.C_6;
       C_7       = objData.C_7;
       C_8       = objData.C_8;
       C_9       = objData.C_9;
       C_10      = objData.C_10;
       C_11      = objData.C_11;
       C_12      = objData.C_12;
       C_13      = objData.C_13;
       C_14      = objData.C_14;
       C_15      = objData.C_15;
    elif (PART_3_2 == flt.RepPart)
       КодВалюты = objData.КодВалюты;
       Резидент  = objData.Резидент;
       ТО        = objData.ТО;
       C_5       = objData.C_5; 
       C_6       = objData.C_6; 
       C_7       = objData.C_7; 
       C_8       = objData.C_8; 
       C_9       = objData.C_9; 
       C_10      = objData.C_10;
       C_11      = objData.C_11;
       C_12      = objData.C_12;
       C_13      = objData.C_13;
       C_14      = objData.C_14;
    end;
  end;

  private macro PrepareData()
    if (PART_3_1 == flt.RepPart)
      objData = C_401_3_1(flt);
    elif (PART_3_2 == flt.RepPart)
      objData = C_401_3_2(flt);
    end;

    if (null != objData)
      objData.PrepareData();
    end;
  end;

  // Установить фильтр
  //_RepPart = 1(для раздела 3.1) или 2(для раздела 3.2)
  macro SetFilter(_Departments:TArray, _BegDate:date, _EndDate:date, _RepPart:integer)
    if (ValType(_Departments) != V_UNDEF)
      flt.Departments = "";
      for(var dep, _Departments)
        if (flt.Departments != "")
          flt.Departments = flt.Departments + ",";
        end;
        flt.Departments = string(flt.Departments) + string(dep);
      end;
      flt.Departments = ","+flt.Departments+",";
    end;
    if (ValType(_BegDate) != V_UNDEF)
      flt.BegDate = _BegDate;
    end;
    if (ValType(_EndDate) != V_UNDEF)
      flt.EndDate = _EndDate;
    end;
    if (ValType(_RepPart) != V_UNDEF)
      flt.RepPart = _RepPart;
    end;
  end;

  /*Получить данные расшифровки*/
  macro GetRepData()
    RepData.size = 0;

    var cmd = DL_RSDCommand();

    var Query = " SELECT nvl(T.T_SYM1,chr(1)) T_SYM1, "
              + "        nvl(T.T_ACC_SYM2,chr(1)) t_SYM2, "
              + "        nvl(t.T_CODESYM3,chr(1)) t_SYM3, "
              + "        nvl(T.T_CURR_FI_CODE,chr(1)) t_SYM4, "
              + "        nvl(T.T_REST_DBEG_USD,0) t_Val1, "
              + "        nvl(T.T_REST_DEXEC_USD,0) t_Val2, "
              + "        nvl(T.T_DIFF_USD,0) t_Val3, "
              + "        nvl(T.T_BONUS_USD,0) t_Val4, "
              + "        nvl(T.T_REST_DEND_USD,0) t_Val5, "
              + "        nvl(T.T_MARGIN_IN_USD,0) t_Val6, "
              + "        nvl(T.T_MARGIN_OUT_USD,0) t_Val7, "
              + "        0 t_Val8, "
              + "        0 t_Val9, "
              + "        0 t_Val10, "
              + "        0 t_Val11, "
              + "        0 t_Val12, "
              + "        nvl(T.T_TXT1,chr(1)) T_TXT1, "
              + "        T.T_TXT2, "
              + "        chr(1) t_txt3, "
              + "        nvl(T.T_ACC_TXT4,chr(1)) t_TXT4, " 
              + "        case when T.T_CLIENTCONTR > 0 then null else T.T_DEALDATE end t_txt5 "
              + "   from DDVREP401_TMP T "
              + "  where T.T_TXT2 = ? "
              + "    and T.T_CURR_CCY_T6 = ? ";

    cmd.AddParam(flt.RepPart);
    cmd.AddParam(КодВалюты);

    if( Резидент=="Прочие" )
       Query = Query
              + "    and T.T_ISBANK != 'X' ";
    else
       Query = Query
              + "    and T.T_ISBANK = 'X' ";
    end;

    if( PART_3_2 == flt.RepPart )

       if( ТО=="Требования" )
          Query = Query
              + "    and T.T_SYM1 in('3А2.1','3А2.2') ";
       else
          Query = Query
              + "    and T.T_SYM1 in('3П2.1','3П2.2') ";
       end;
    end;

    Query = Query
              + " order by T.T_SYM1";

    var DataRec = cmd.execute(Query);

    while(DataRec.MoveNext())
       RepData[RepData.size] = C_401_Data(DataRec.Sym1, 
                                          DataRec.Sym2, 
                                          DataRec.Sym3, 
                                          DataRec.Sym4, 
                                          DataRec.Val1, 
                                          DataRec.Val2, 
                                          DataRec.Val3, 
                                          DataRec.Val4, 
                                          DataRec.Val5, 
                                          DataRec.Val6, 
                                          DataRec.Val7, 
                                          DataRec.Val8, 
                                          DataRec.Val9, 
                                          DataRec.Val10,
                                          DataRec.Val11,
                                          DataRec.Val12,
                                          DataRec.Txt1,
                                          int(DataRec.Txt2),
                                          DataRec.Txt3,
                                          DataRec.Txt4,
                                          DataRec.Txt5
                                         );       
    end;                                         
  end;

  // Формирование выборки и получение первой записи
  macro GetFirst():bool
    var stat = true;
    PrepareData();

    objData.GetData();

    if(stat==true)
      SetValues();
      GetRepData();
    end;

    return stat;
  end;
  // Получение следующей записи
  macro GetNext():bool
    var stat = true;
    stat = objData.GetNext();
    if(stat==true)
      SetValues();
      GetRepData();
    end;

    return stat;
  end;
end;

/*
//пример для 3 раздела
var deps = TArray();
deps[deps.size] = {OperDprt};
var obj = C_401deriv();
obj.SetFilter(deps,date(1,1,2019),date(13,5,2019),1);/*раздел 3.1*/
var v_continue = obj.GetFirst();
while(v_continue)
[│ ########### │ ########## │ ############## │ ################## │ ########## │ ########### │ ########### │ #################### │ ############## │ ################# │ ################# │ ################### │ ################# │ ################### ]
(obj.КодВалюты,
obj.Резидент:w, 
obj.C_4,      
obj.C_5,      
obj.C_6,      
obj.C_7,      
obj.C_8,      
obj.C_9,      
obj.C_10,     
obj.C_11,     
obj.C_12,     
obj.C_13,
obj.C_14,
obj.C_15);
v_continue = obj.GetNext();
end;

obj.SetFilter(deps,date(1,1,2019),date(13,5,2019),2);/*раздел 3.2*/
v_continue = obj.GetFirst();
while(v_continue)
[│ ########### │ ########## │ ############## │ ################## │ ########## │ ########### │ ########### │ #################### │ ############## │ ################# │ ################# │ ################# │ ################# ]
(obj.КодВалюты,
obj.Резидент:w, 
obj.ТО,      
obj.C_5,      
obj.C_6,      
obj.C_7,      
obj.C_8,      
obj.C_9,      
obj.C_10,     
obj.C_11,     
obj.C_12,     
obj.C_13,     
obj.C_14);     
v_continue = obj.GetNext();
end;
*/