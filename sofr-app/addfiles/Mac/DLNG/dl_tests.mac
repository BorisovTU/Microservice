/**
 @file 		dl_tests.mac
 @brief 	Авто-тесты
*/
IMPORT RSD;


/**
   DEF-62480, код участника торгов, код позиции и торговый счет получаем из параметров расчета лимитов 
*/
private macro GetLimitPrm( p_SfContrID: INTEGER, p_LimitDate: DATE, p_FirmID:@STRING, p_Tag:@STRING, p_TrdAcc:@STRING )

    var sql, cmd;
   
    sql =  "DECLARE "
         + "BEGIN "
         + "    RSHB_RSI_SCLIMIT.GetLimitPrm(:SfContrID, :LimitDate, :FirmID, :Tag, :TrdAcc); "
         + "END; "
    ;
      
    cmd = RSDCommand(sql);
    cmd.addParam("SfContrID", RSDBP_IN, p_SfContrID);
    cmd.addParam("LimitDate", RSDBP_IN, p_LimitDate);
    cmd.addParam("FirmID", RSDBP_OUT, V_STRING);
    cmd.addParam("Tag", RSDBP_OUT, V_STRING);
    cmd.addParam("TrdAcc", RSDBP_OUT, V_STRING);
    cmd.execute();

    p_FirmID = cmd.value("FirmID");
    p_Tag = cmd.value("Tag");
    p_TrdAcc = cmd.value("TrdAcc");
end; // GetLimitPrm()


/** 
  @brief 		Тест для DEF-65032
                        Проверяет правильность значения TAG для суб-договора не-ЕДП

  @return 		0, если тест прошел успешно, 1, если не успешно
*/
MACRO NonEdpTagIsRTOD
  // Arrange
  var 
     stat: integer = 1
     , x_SfContrID: INTEGER = 101187		// суб-договор для не-ЕДП
     , x_FirmID:STRING
     , x_LimitDate: DATE = date(27,4,2024)
     , x_Tag:STRING
     , x_TrdAcc:STRING
     , x_WantTag:STRING = "RTOD"
  ;

  // Act
  GetLimitPrm( x_SfContrID, x_LimitDate, @x_FirmID, @x_Tag, @x_TrdAcc);

  // Assign
  if(x_Tag == x_WantTag) 
     stat = 0;
  end;

  return stat;
ONERROR(err)
  return 1;
END;


/** 
  @brief 		Тест для DEF-65032
                        Проверяет правильность значения TAG для суб-договора ЕДП

  @return 		0, если тест прошел успешно, 1, если не успешно
*/
MACRO EdpTagIsEQTV
  // Arrange
  var 
     stat: integer = 1
     , x_SfContrID: INTEGER = 565994           // суб-договор для ЕДП
     , x_FirmID:STRING
     , x_LimitDate: DATE = date(27,4,2024)
     , x_Tag:STRING
     , x_TrdAcc:STRING
     , x_WantTag:STRING = "EQTV"
  ;

  // Act
  GetLimitPrm( x_SfContrID, x_LimitDate, @x_FirmID, @x_Tag, @x_TrdAcc);

  // Assign
  if(x_Tag == x_WantTag) 
     stat = 0;
  end;

  return stat;
ONERROR(err)
  return 1;
END;
