/*
$Name:             dlclordcj_form.mac
$Module:           Ядро Securities
$Description:      Отчет "Журнал регистрации поручений клиента" (ФКЦБ) - форма ввода данных  Общий для БО, ПИ и УВ
*/
import "DlRepForm_h.mac", "dlmisc.mac";

CONST
      PNFLD_DLCLORDCJ_ClientCode            = 0,
      PNFLD_DLCLORDCJ_ClientName            = 1,
      PNFLD_DLCLORDCJ_ISFORM                = 2,  /*                      */
      PNFLD_DLCLORDCJ_FORMSUB               = 3,  /* Форма субъекта       */
      PNFLD_DLCLORDCJ_ISVID                 = 4,  /*                      */
      PNFLD_DLCLORDCJ_VIDSUB                = 5,  /* Вид субъекта         */
      PNFLD_DLCLORDCJ_NORESIDENT            = 6,  /* Флаг резидентности   */
      PNFLD_DLCLORDCJ_IsBO                  = 7,
      PNFLD_DLCLORDCJ_IsDV                  = 8,
      PNFLD_DLCLORDCJ_IsVA                  = 9,
      PNFLD_DLCLORDCJ_IsCM                  = 10,
      PNFLD_DLCLORDCJ_Contr                 = 11,
      PNFLD_DLCLORDCJ_ORDER_Deal            = 12,
      PNFLD_DLCLORDCJ_ORDER_CH_PLACEEXEC    = 13,
      PNFLD_DLCLORDCJ_ORDER_PLACEEXEC       = 14,
      PNFLD_DLCLORDCJ_ORDER_CH_SOURCEFIKIND = 15,
      PNFLD_DLCLORDCJ_ORDER_SOURCEFIKIND    = 16,
      PNFLD_DLCLORDCJ_ORDER_CH_PFIKIND      = 17,
      PNFLD_DLCLORDCJ_ORDER_PFIKIND         = 18,
      PNFLD_DLCLORDCJ_ORDER_Val             = 19,
      PNFLD_DLCLORDCJ_ORDER_Sec             = 20,
      PNFLD_DLCLORDCJ_BegDate               = 21,
      PNFLD_DLCLORDCJ_EndDate               = 22,
      PNFLD_DLCLORDCJ_IsExportToExel        = 23;

CLASS DLCLORDCJFormData()
  VAR 
  ClientID,
  IsForm,
  FormSub,
  IsVid,
  VidSub,
  Noresident,
  IsBO,    
  IsDV,
  IsVA,  
  IsCM,
  Contr,  
  OrderDeal,
  ChPlaceExec,
  PlaceExec,
  ChSourceFIKind,
  SourceFIkind,
  ChPFIKind,
  PFIKind,
  OrderVal,
  OrderSec,    
  BegDate,    
  EndDate,     
  IsExportToExel,
  FirstInit                      // DEF-67273, если форма используется в цикле, нужно отличать случай первой инициализации
  ;       

  // Значение по умолчанию

  ClientID   = -1;
  IsForm     = 0;
  FormSub    = 0;
  IsVid      = 0;
  VidSub     = 0;
  Noresident = "";
  if (GetIdentProgram()==158) // KS 06.02.2020 Для ФИССиКО особые параметры запуска по умолчанию
    IsBO       = "";
    IsDV       = "";
    IsVA       = "";
    IsCM       = "X";
  else
    IsBO       = "X";
    IsDV       = "X";
    IsVA       = "X";
    IsCM       = "X";
  end;
  if( VA_NeedInnerAcc() == false )
     IsVA = "";
  end; 
  OrderDeal      = "X";
  ChPlaceExec    = "";
  PlaceExec      = 0;
  ChSourceFIKind = "";
  SourceFIkind   = 0;
  ChPFIKind      = "";
  PFIKind        = 0;
  OrderVal       = "X";
  OrderSec       = "X";
  Contr          = -1;
  BegDate        = {curdate};
  EndDate        = {curdate};
  IsExportToExel = "X";
  FirstInit      = true;                // DEF-67273, флаг первой инициализации установлен
END;

VAR RepFormData = DLCLORDCJFormData();

PRIVATE CONST /* Обработчики для нестандарных контролов */
      H_CLIENT         = 101, 
      H_CLIENT_NAME    = 102,
      H_ISBO           = 103,
      H_ISDV           = 104,
      H_ISVA           = 105,
      H_ISCM           = 106,
      H_CONTR          = 107,
      H_DEAL           = 108,
      H_CHPLACEEXEC    = 109,
      H_PLACEEXEC      = 110,
      H_CHSOURCEFIKIND = 111,
      H_SOURCEFIKIND   = 112,
      H_CHPFIKIND      = 113,
      H_PFIKIND        = 114,
      H_ISFORM         = 115,
      H_FORMSUB        = 116,
      H_ISVID          = 117,
      H_VIDSUB         = 118; 

PRIVATE MACRO DL_FldProc_FormSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(FldRealValue == 0)
    FldShowValue = "";
  end;
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))
     DL_ListNA( 3400, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), NULL );
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_VidSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT )
  if(FldRealValue == 0)
    FldShowValue = "";
  end;
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))

    return DL_ComboBox( "select t_Name2, t_PartyKind from dptkind_dbt ",
                        "t_Name2", "t_PartyKind", 
                        @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY()
                      );

  end; 
END;

PRIVATE MACRO DL_FldProc_IsFormVid( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT, pos:INTEGER):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
    if ( FldRealValue == 0)
        FldShowValue = "=";
        FldRealValue = "1";
        EnableFields( pThis.Data(), pos );

    elif(FldRealValue == 1)
        FldShowValue = "!";
        FldRealValue = "2";
    else
        FldShowValue = "";
        FldRealValue = "0";
        DisableFields( pThis.Data(), pos );
    end;
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_IsFormVid1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_DLCLORDCJ_FORMSUB);
	   if (FldRealValue==0)
			pThis.SetLinkedValue( H_FORMSUB, 0 );
	   end;
  end;
END;

PRIVATE MACRO DL_FldProc_IsFormVid2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_DLCLORDCJ_VIDSUB);
	 if (FldRealValue==0)
			pThis.SetLinkedValue( H_VIDSUB, 0 );
	   end;
  end;
END;

/*ищем код субъекта*/
PRIVATE MACRO GetPartCode( PartyID:integer )
  var sqlPartcode, PartCode;

  sqlPartcode = RSDCommand("select t_Code from dpartcode_dbt " +
                           " where t_PartyID = ? " +
                           "   and t_CodeKind = 1");

  sqlPartcode.addParam("", RSDBP_IN, PartyID);
  sqlPartcode.execute();

  PartCode = TRsbDataSet(sqlPartcode);
  if( PartCode.MoveNext() )
     return PartCode.Code;
  end;

  return "";
END;

/*является ли клиетом заданного вида обслуживания*/
PRIVATE MACRO IsClServKind( PartyID:integer, ServiceKind:integer )
  var sqlClient, ClientRNum;

  if( PartyID == -1 )
     return true;
  end;

  sqlClient = RSDCommand("select count(1) RNum from dclient_dbt " +
                         " where t_PartyID = ? " +
                         "   and t_ServiceKind = ? " +
                         "   and t_Department = " +string({OperDprt})+
                         "   and t_Branch = 0" );

  sqlClient.addParam("", RSDBP_IN, PartyID);
  sqlClient.addParam("", RSDBP_IN, ServiceKind);
  sqlClient.execute();

  ClientRNum = TRsbDataSet(sqlClient);
  if( ClientRNum.MoveNext() )
     if( ClientRNum.RNum > 0 )
        return true;
     end;
  end;

  return false;
END;

/*является ли договором заданного вида обслуживания*/
PRIVATE MACRO IsContrServKind( SfContrID:integer, ServiceKind:integer )
  var sqlSfcontr, Sfcontr;

  if( SfContrID == -1 )
     return true;
  end;

  sqlSfcontr = RSDCommand("select count(1) RNum from dsfcontr_dbt " +
                          " where t_ID = ? " +
                          "   and t_ServKind = ?");

  sqlSfcontr.addParam("", RSDBP_IN, SfContrID);
  sqlSfcontr.addParam("", RSDBP_IN, ServiceKind);
  sqlSfcontr.execute();

  Sfcontr = TRsbDataSet(sqlSfcontr);
  if( Sfcontr.MoveNext() )
     if( Sfcontr.RNum > 0 )
        return true;
     end;
  end;

  return false;
END;

/*выставим виды обслуживания для клиентов*/
PRIVATE MACRO SetServKind( pThis:DL_CPanel, PartyID:integer )
  if( PartyID > 0 )
     if( IsClServKind( PartyID, PTSK_STOCKDL ) )
        pThis.SetLinkedValue( H_ISBO, "X" );
     else
        pThis.SetLinkedValue( H_ISBO, null );
     end;

     if( IsClServKind( PartyID, PTSK_DV ) )
        pThis.SetLinkedValue( H_ISDV, "X" );
     else
        pThis.SetLinkedValue( H_ISDV, null );
     end;

     if( VA_NeedInnerAcc() and IsClServKind(PartyID, PTSK_VEKSACC) )
        pThis.SetLinkedValue( H_ISVA, "X" );
     else
        pThis.SetLinkedValue( H_ISVA, null );
     end;

     if( IsClServKind( PartyID, PTSK_CM) )
        pThis.SetLinkedValue( H_ISCM, "X" );
     else
        pThis.SetLinkedValue( H_ISCM, null );
     end;
  else/*ВСЕ*/
     pThis.SetLinkedValue( H_ISBO, "X" );
     pThis.SetLinkedValue( H_ISDV, "X" );
     if( VA_NeedInnerAcc() )
        pThis.SetLinkedValue( H_ISVA, "X" ); 
     end;
     pThis.SetLinkedValue( H_ISCM, "X" );
  end;
END;

PRIVATE MACRO DLUSR_FldProc_Client( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var ClientName = "";
  var ServKind = TArray();

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( H_CLIENT_NAME, "");
     else
        var Party = TRecHandler("party.dbt");
        if( not ПолучитьСубъекта(FldRealValue, Party) )
           FldShowValue = GetPartCode(FldRealValue);
           pThis.SetLinkedValue(H_CLIENT_NAME, Party.rec.ShortName);
           // DEF-67273 флаги для видов обслуживания выставляются автоматом только при первой инициализации
           if(RepFormData.FirstInit)  
              SetServKind( pThis, FldRealValue );
           end;
        end;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     pThis.SetLinkedValue( H_CLIENT_NAME, "" );
     pThis.SetLinkedValue( H_CONTR, null );
     SetServKind( pThis, FldRealValue );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )

     pThis.SetLinkedValue( H_CONTR, null );

     if( pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsBO ) == "X" )
        ServKind[ServKind.Size] = PTSK_STOCKDL;
     end;
             
     if( pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsDV ) == "X" )
        ServKind[ServKind.Size] = PTSK_DV;
     end;

     if( pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsVA ) == "X" )
        ServKind[ServKind.Size] = PTSK_VEKSACC;
     end;

     if( pThis.GetFieldValue(PNFLD_DLCLORDCJ_IsCM) == "X" )
        ServKind[ServKind.Size] = PTSK_CM;
     end;

     if(DL_ListClientByServKind( @ClientName, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), ServKind, false, {OperDprt} ))
        pThis.SetLinkedValue( H_CLIENT_NAME, ClientName );
        //SetServKind( pThis, FldRealValue );
     end;
  end;

  return CM_DEFAULT;
END;

/*Переключатель*/
PRIVATE MACRO DLUSR_FldProc_BO( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
     if(FldRealValue == "X") // Golovkin типа радиобатн
         pThis.SetLinkedValue( H_ISDV, "" );
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     if( IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_STOCKDL ) )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
           if( IsContrServKind(pThis.GetFieldValue( PNFLD_DLCLORDCJ_Contr ), PTSK_STOCKDL) )
              pThis.SetLinkedValue( H_CONTR, null );
           end;
           if( not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsDV ) == "X") and 
                        IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_DV )) and 
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsVA ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_VEKSACC )) and 
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsCM ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_CM )))
              pThis.SetLinkedValue( H_CLIENT_NAME, "");
              pThis.SetLinkedValue( H_CLIENT, -1);
           end;
        end;
     end;                      
  end;
  return CM_DEFAULT;
END;

/*Переключатель*/
PRIVATE MACRO DLUSR_FldProc_DV( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
     if(FldRealValue == "X") // Golovkin типа радиобатн
         pThis.SetLinkedValue( H_ISBO, "" );
     end;     
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     if( IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_DV ) )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
           if( IsContrServKind(pThis.GetFieldValue( PNFLD_DLCLORDCJ_Contr ), PTSK_DV) )
              pThis.SetLinkedValue( H_CONTR, null );
           end;
           if( not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsBO ) == "X") and 
                        IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_STOCKDL )) and 
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsVA ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_VEKSACC )) and 
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsCM ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_CM )))
              pThis.SetLinkedValue( H_CLIENT_NAME, "");
              pThis.SetLinkedValue( H_CLIENT, -1);
           end;
        end;
     end;
  end;
  return CM_DEFAULT;
END;

/*Переключатель*/
PRIVATE MACRO DLUSR_FldProc_CM( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     if( IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_CM ) )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
           if( IsContrServKind(pThis.GetFieldValue( PNFLD_DLCLORDCJ_Contr ), PTSK_CM) )
              pThis.SetLinkedValue( H_CONTR, null );
           end;
           if( not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsBO ) == "X") and 
                        IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_STOCKDL )) and 
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsVA ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_VEKSACC )) and 
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsDV ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_DV )) )
              pThis.SetLinkedValue( H_CLIENT_NAME, "");
              pThis.SetLinkedValue( H_CLIENT, -1);
           end;
        end;
     end;
  end;
  return CM_DEFAULT;
END;

/*Переключатель*/
PRIVATE MACRO DLUSR_FldProc_VA( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     if( IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_VEKSACC ) )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
           if( IsContrServKind(pThis.GetFieldValue( PNFLD_DLCLORDCJ_Contr ), PTSK_VEKSACC) )
              pThis.SetLinkedValue( H_CONTR, null );
           end;
           if( not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsDV ) == "X") and 
                        IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_DV )) and 
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsBO ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_STOCKDL )) and
              not ((pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsCM ) == "X") and 
                       IsClServKind( pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ), PTSK_CM )) )
              pThis.SetLinkedValue( H_CLIENT_NAME, "");
              pThis.SetLinkedValue( H_CLIENT, -1);
           end;
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_NumContr( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var ClientID =  -1;
  var ServKind = TArray();

  ClientID = pThis.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode );
  
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )                           
        FldShowValue = STR_ALLVALUE;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) AND (ClientID > 0) )

     if( pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsBO ) == "X" )
        ServKind[ServKind.Size] = PTSK_STOCKDL;
     end;
     if( pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsDV ) == "X" )
        ServKind[ServKind.Size] = PTSK_DV;
     end;
     if( pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsVA ) == "X" )
        ServKind[ServKind.Size] = PTSK_VEKSACC;
     end;
     if( pThis.GetFieldValue( PNFLD_DLCLORDCJ_IsCM ) == "X" )
        ServKind[ServKind.Size] = PTSK_CM;
     end;
     DL_ListSfContrByServKind( @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), ClientID, ServKind ); 
  end;
  return CM_DEFAULT;
END;

MACRO DLUSR_FldProc_CheckBoxDeal( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "X";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";

           EnableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_CH_PLACEEXEC);
           EnableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_CH_SOURCEFIKIND);
           EnableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_CH_PFIKIND);
        else
           FldShowValue = FldRealValue = "";

           pThis.SetLinkedValue(H_CHPLACEEXEC,    "");
           pThis.SetLinkedValue(H_PLACEEXEC,      null);
           pThis.SetLinkedValue(H_CHSOURCEFIKIND, "");
           pThis.SetLinkedValue(H_SOURCEFIKIND,   null);
           pThis.SetLinkedValue(H_CHPFIKIND,      "");
           pThis.SetLinkedValue(H_PFIKIND,        null);

           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_CH_PLACEEXEC);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_PLACEEXEC);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_CH_SOURCEFIKIND);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_SOURCEFIKIND);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_CH_PFIKIND);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_PFIKIND);
        end;
     end;
  end;

  return CM_DEFAULT;
END;

MACRO DLUSR_FldProc_CheckBoxPlaceExec( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";

           EnableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_PLACEEXEC);
        else
           FldShowValue = FldRealValue = "";

           pThis.SetLinkedValue(H_PLACEEXEC, null);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_PLACEEXEC);
        end;
     end;
  end;

  return CM_DEFAULT;
END;

MACRO DLUSR_FldProc_CheckBoxSourceFIkind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";

           EnableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_SOURCEFIKIND);
        else
           FldShowValue = FldRealValue = "";

           pThis.SetLinkedValue(H_SOURCEFIKIND, null);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_SOURCEFIKIND);
        end;
     end;
  end;

  return CM_DEFAULT;
END;

MACRO DLUSR_FldProc_CheckBoxPFIKind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";

           EnableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_PFIKIND);
        else
           FldShowValue = FldRealValue = "";

           pThis.SetLinkedValue(H_PFIKIND, null);
           DisableFields(pThis.Data(), PNFLD_DLCLORDCJ_ORDER_PFIKIND);
        end;
     end;
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_PlaceExec( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = 0;
        FldShowValue = "";
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     DL_ListNA(ALG_DLCLORDCJ_PLACEEXEC, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), NULL);
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_SourceFIkind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = 0;
        FldShowValue = "";
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     DL_ListNA(ALG_DLCLORDCJ_SOURCEFIKIND, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), NULL);
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_PFIKind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = 0;
        FldShowValue = "";
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
      if (pThis.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_PLACEEXEC )==1);
          DL_ListNA(ALG_DLCLORDCJ_PFIKIND, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), " and T_INUMBERALG in (1,2) ");
      elif (pThis.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_PLACEEXEC )==2);
          DL_ListNA(ALG_DLCLORDCJ_PFIKIND, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), " and T_INUMBERALG in (2,3) ");
      else
     DL_ListNA(ALG_DLCLORDCJ_PFIKIND, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), NULL);
  end;
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;

PRIVATE macro DLUSR_FldProc_CheckBoxOrdVal(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = "";
  end;

  return CM_DEFAULT;
end;


CLASS (DL_CPanel) DL_ClOrdRegRep_Panel()

  PRIVATE MACRO Init()
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ClientCode,            H_CLIENT,           @DLUSR_FldProc_Client,               RepFormData.ClientID);         
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ClientName,            H_CLIENT_NAME,      @Default,                            "");
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ISFORM,                H_ISFORM,           @DL_FldProc_IsFormVid1,              RepFormData.IsForm);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_FORMSUB,               H_FORMSUB,          @DL_FldProc_FormSub,                 RepFormData.FormSub, 36, 10);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ISVID,                 H_ISVID,            @DL_FldProc_IsFormVid2,              RepFormData.IsVid);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_VIDSUB,                H_VIDSUB,           @DL_FldProc_VidSub,                  RepFormData.VidSub, 36, 11);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_NORESIDENT,            DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,                RepFormData.Noresident);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_IsBO,                  H_ISBO,             @DLUSR_FldProc_BO,                   RepFormData.IsBO);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_IsDV,                  H_ISDV,             @DLUSR_FldProc_DV,                   RepFormData.IsDV);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_IsVA,                  H_ISVA,             @DLUSR_FldProc_VA,                   RepFormData.IsVA);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_IsCM,                  H_ISCM,             @DLUSR_FldProc_CM,                   RepFormData.IsCM);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_Contr,                 H_CONTR,            @DLUSR_FldProc_NumContr,             RepFormData.Contr);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_Deal,            H_DEAL,             @DLUSR_FldProc_CheckBoxDeal,         RepFormData.OrderDeal);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_CH_PLACEEXEC,    H_CHPLACEEXEC,      @DLUSR_FldProc_CheckBoxPlaceExec,    RepFormData.ChPlaceExec);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_PLACEEXEC,       H_PLACEEXEC,        @DLUSR_FldProc_PlaceExec,            RepFormData.PlaceExec, 46, 20);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_CH_SOURCEFIKIND, H_CHSOURCEFIKIND,   @DLUSR_FldProc_CheckBoxSourceFIkind, RepFormData.ChSourceFIKind);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_SOURCEFIKIND,    H_SOURCEFIKIND,     @DLUSR_FldProc_SourceFIkind,         RepFormData.SourceFIkind, 46, 21);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_CH_PFIKIND,      H_CHPFIKIND,        @DLUSR_FldProc_CheckBoxPFIKind,      RepFormData.ChPFIKind);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_PFIKIND,         H_PFIKIND,          @DLUSR_FldProc_PFIKind,              RepFormData.PFIKind, 46, 22);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_Val,             DL_PNFLD_CHECKBOX,  @DLUSR_FldProc_CheckBoxOrdVal,       RepFormData.OrderVal);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_ORDER_Sec,             DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,                RepFormData.OrderSec);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_BegDate,               DL_PNFLD_BEGINDATE, @DL_FldProc_BeginDate,               RepFormData.BegDate);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_EndDate,               DL_PNFLD_ENDDATE,   @DL_FldProc_EndDate,                 RepFormData.EndDate);
     AddFieldProc( 0, PNFLD_DLCLORDCJ_IsExportToExel,        DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,                RepFormData.IsExportToExel);

     if( VA_NeedInnerAcc() == false )
        DisableFields(this.Data(), PNFLD_DLCLORDCJ_IsVA);
     end;
     if( GetFieldValue(PNFLD_DLCLORDCJ_ORDER_CH_PLACEEXEC) == "" )
        DisableFields(this.Data(), PNFLD_DLCLORDCJ_ORDER_PLACEEXEC);
     end;
     if( GetFieldValue(PNFLD_DLCLORDCJ_ORDER_CH_SOURCEFIKIND) == "" )
        DisableFields(this.Data(), PNFLD_DLCLORDCJ_ORDER_SOURCEFIKIND);
     end;
     if( GetFieldValue(PNFLD_DLCLORDCJ_ORDER_CH_PFIKIND) == "" )
        DisableFields(this.Data(), PNFLD_DLCLORDCJ_ORDER_PFIKIND);
     end;
     DisableFields(this.Data(), PNFLD_DLCLORDCJ_FORMSUB);
     DisableFields(this.Data(), PNFLD_DLCLORDCJ_VIDSUB);

     DisableFields(this.Data(), PNFLD_DLCLORDCJ_ORDER_Val);
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;
  
  initDL_CPanel( "dlrep.lbr", "CLORDREG" ); 
END;
