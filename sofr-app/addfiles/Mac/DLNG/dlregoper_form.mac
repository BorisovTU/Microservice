/*                           
$Name:             dlregoper_form.mac
$Module:           Ценные бумаги
$Description:      реализация формы " Субрегистр иных операций"
 PROGRAMMED BY:    Свириденка A.И.
 CREATION DATE:    17.04.07
*/

import "DlRepForm_h.mac", "dlmisc.mac";

// Номера полей в форме отчета
CONST
      PNFLD_REGOPER_MODULE_BO           = 0,    // A3 
      PNFLD_REGOPER_MODULE_VA           = 1,    // A4

      PNFLD_REGOPER_BEGINDATE           = 2,    // A5 дата начала
      PNFLD_REGOPER_FINISHDATE          = 3,    // A6 
      PNFLD_REGOPER_SPLIT_BY_DATES      = 4,    // A32 Отдельно на каждую дату периода
      PNFLD_REGOPER_SECUR_KIND          = 5,    // A7 Вид ц/б
      PNFLD_REGOPER_ISSUER              = 6,    // A8 Эмитент
      PNFLD_REGOPER_ISSUER_NAME         = 7,    // A9 
      PNFLD_REGOPER_SECUR_CODE          = 8,    // A10 Код ц/б
      PNFLD_REGOPER_SECUR_CODE_NAME     = 9,    // A11 
      PNFLD_REGOPER_OPER_TYPE           = 10,    // A12 тип операции
      PNFLD_REGOPER_CLIENT              = 11,   // A13 клиент
      PNFLD_REGOPER_CLIENT_NAME         = 12,   // A14

      PNFLD_REGOPER_ISFORM              = 13,       /*                      */
      PNFLD_REGOPER_FORMSUB             = 14,       /* Форма субъекта       */
      PNFLD_REGOPER_ISVID               = 15,       /*                      */
      PNFLD_REGOPER_VIDSUB              = 16,       /* Вид субъекта         */
      PNFLD_REGOPER_NORESIDENT          = 17,       /* Флаг резидентности   */

      PNFLD_REGOPER_DEALTYPE_CLOSED     = 18,   // A15 радио - отбор по завершенным сделкам
      PNFLD_REGOPER_DEALTYPE_OPENED     = 19,   // A16 радио - открытые
      PNFLD_REGOPER_DEALTYPE_ALL        = 20,   // A17 радин - все сделки
      PNFLD_REGOPER_OPER_KIND           = 21,   // A18 вид операции
      PNFLD_REGOPER_DEPO                = 22,   // A19 депозитарий
      PNFLD_REGOPER_DEPO_NAME           = 23,   // A20 
 
      PNFLD_REGOPER_ON_ORCB             = 24,   // A21 на ОРЦБ
      PNFLD_REGOPER_EXCGANGE            = 25,   // A22 биржа
      PNFLD_REGOPER_EXCGANGE_NAME       = 26,   // A23
      PNFLD_REGOPER_NOT_ON_ORCB         = 27,   // A24 не на ОРЦБ
      PNFLD_REGOPER_THROUGH_BROKER      = 28,   // A25 через брокера
      PNFLD_REGOPER_BROKER              = 29,   // A26 Брокер
      PNFLD_REGOPER_BROKER_NAME         = 30,   // A27
      
      PNFLD_REGOPER_WITH_APOSTROFS      = 31,   // A28 с апострофами
      PNFLD_REGOPER_TO_EXEL             = 32,   // A29 выгрузить в EXEL
      PNFLD_REGOPER_DEPARTMENT          = 33,   // A30 филиал
      PNFLD_REGOPER_DEPARTMENT_NAME     = 34;   // A31 


///////////////////////////////////////////////////////////////////////////////////////////
// Класс данных отражающий поля формы
      
      
CLASS DlRegOperFormData()
  VAR 
  IsUseBO,
  IsUseVA,
  BeginDate,
  EndDate,
  SplitByDates,
  SecurKind,
  Issuer,
  SecurCode,
  OperType,
  ClientID,
  IsForm,
  FormSub,
  IsVid,
  VidSub,
  Noresident,
  OperStatus, // -1 - All 0 - Closed 1 Opend
  isOperClosed, 
  isOperOpened,
  isOperAll,
  OperKind,
  DepoID,
  isOnORBC,
  Exchange,
  isNotOnORBC,
  isThroughBroker,
  BrokerID,
  
  IsUseOpostrofs,
  IsExportToExel,
  DepartmentID,
  lastParam;
  

  // Значение по умолчанию

  BeginDate = {curdate};
  EndDate = {curdate};
  SplitByDates = "";

  SecurKind = "";
  Issuer = "";
  SecurCode = "";
  OperType = -1;
  ClientID = "";

  IsForm     =   0;
  FormSub    =   0;
  IsVid      =   0;
  VidSub     =   0;
  Noresident =  "";

  isOperClosed = "X";
  isOperOpened = "";
  isOperAll    = "";
  
  OperKind = "";
  DepoID = "";
  isOnORBC = "X";
  Exchange = "";
  isNotOnORBC = "";
  isThroughBroker = "";
  BrokerID = "";

  IsUseOpostrofs = "X";
  IsExportToExel = "X";
  DepartmentID = -1;

  IsUseBO = "X";
  IsUseVA = "X";
  if(VA_NeedInnerAcc() == false)
    IsUseVA = "";
  end;
  
END;
    
VAR DlRegOperData = DlRegOperFormData();     

PRIVATE CONST /* Обработчики для нестандарных контролов */

      H_SECUR_KIND            = 101, // Вид Ц/Б(листалка)
      H_ISSUER                = 102, // Эмитент(листалка)
      H_ISSUER_NAME           = 103, // 
      H_SECUR_CODE            = 104, // Код Ц/Б(листалка)
      H_SECUR_CODE_NAME       = 105, // 
      H_OPER_TYPE             = 106, // Тип операции
      H_CLIENT                = 107, // Клиент (листалка)
      H_CLIENT_NAME           = 108, // Клиент (листалка)
      H_RADIO_CLOSED          = 109, // Фуникция радио кнопки
      H_RADIO_OPENED          = 110, // Фуникция радио кнопки
      H_RADIO_ALL             = 111, // Фуникция радио кнопки
      H_OPER_KIND             = 112, // Вид операции
      H_DEPO                  = 113, // Депозиатрий
      H_DEPO_NAME             = 114, // 
      H_EXCHANGE              = 115, // Биржа(листалка)
      H_EXCHANGE_NAME         = 116, // Имя Биржи (связанное поле)
      H_BROKER                = 117, // Брокер(листалка)
      H_BROKER_NAME           = 118, // Имя Брокера (связанное поле)
      H_DEPARTMENT            = 119, // Обработчик кода департамента(листалка)
      H_DEPARTMENT_NAME       = 120, // имя департамента(связанное поле)
      H_MODULE_BO             = 121, // чекбокс модуля "БО ц/б"
      H_MODULE_VA             = 122, // чекбокс модуля "Учтенные векселя"
      H_ISFORM                = 123,
      H_FORMSUB               = 124,
      H_ISVID                 = 125,
      H_VIDSUB                = 126, 
      ;
      
PRIVATE CONST SelCodeKind = 1; // Общий параметр для листалок Бирж,Субьектов,Брокеров,Клиентов     

private const DEALTYPE_ALL    = -1, /* Все сделки */
              DEALTYPE_OWN    = 1,  /* собственные сделки */
              DEALTYPE_BROKER = 0,  /* брокерские сделки */
              DEALTYPE_DU     = 2;  /* доверительное управление*/
              
private const OPER_TYPE_ALL           =-1, /* Все сделки           */
              OPER_TYPE_POGASHENIE    = 0, /* Погашение            */
              OPER_TYPE_KONVERTACIYA  = 1, /* Конвертация          */
              OPER_TYPE_PAI           = 2, /* Полечение паев       */
              OPER_TYPE_MENA          = 3, /* Мена                 */
              OPER_TYPE_ZALOG         = 4, /* Передача ц/б в залог */
              OPER_GLOBAL             = 5, /* глобальная операция*/
              OPER_NOMCHANG           = 6; /* изменение номинала*/
              

///////////////////////////////////////////////////////////////////////////////////////////
 MACRO Sum(S1:INTEGER, S2:INTEGER)
  return S1+S2;
 END;

///////////////////////////////////////////////////////////////////////////////////////////
// Ползовательские контролы
//////////////////////////////////////////////////////////////////////////////////////////////////////////
PRIVATE MACRO DL_FldProc_FormSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))
     DL_ListNA( 3400, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), NULL );
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_VidSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT )
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))

    return DL_ComboBox( "select t_Name2, t_PartyKind from dptkind_dbt ",
                        "t_Name2", "t_PartyKind", 
                        @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY()
                      );

  end; 
END;

PRIVATE MACRO DL_FldProc_IsFormVid( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT, pos:INTEGER):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
    if ( FldRealValue == 0)
        FldShowValue = "=";
        FldRealValue = "1";
        EnableFields( pThis.Data(), pos );

    elif(FldRealValue == 1)
        FldShowValue = "!";
        FldRealValue = "2";
    else
        FldShowValue = "";
        FldRealValue = "0";
        DisableFields( pThis.Data(), pos );
    end;
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_IsFormVid1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_REGOPER_FORMSUB);
  end;
END;

PRIVATE MACRO DL_FldProc_IsFormVid2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_REGOPER_VIDSUB);
  end;
END;


PRIVATE MACRO DLUSR_FldProc_Department( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
file   Department( dp_dep );

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = {OperDprt};
     end;
     if( FldRealValue < 0 )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( H_DEPARTMENT_NAME, STR_ALLVALUE);
     else
        // Установка значения по умолчанию не работает 
        ClearRecord( Department );

        Department.Code = FldRealValue;
        GetGE(Department);
        FldShowValue = Department.Name;
        pThis.SetLinkedValue( H_DEPARTMENT_NAME, DL_GetDepartmentNameByCode(FldRealValue));
     end;
  end;
  
  if( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     return pThis.SetLinkedValue( H_DEPARTMENT_NAME, STR_ALLVALUE );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) // Вызов листалки и заполнение FldShowValue и FldRealValue
     if( ListDepartment( Department ) )
        FldRealValue = Department.Code;
        FldShowValue = Department.Name;
        pThis.SetLinkedValue( H_DEPARTMENT_NAME, DL_GetDepartmentNameByCode(FldRealValue)); 
     end;
  end;
  return CM_DEFAULT;
END;



//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_Issuer( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
      // Установка значений по умолчанию не реализована 
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) // Вызов листалки и заполнение FldShowValue и FldRealValue
     Party = TRecHandler("party.dbt");
     if( ListPT( Party, SelCodeKind, "", PTLIST_ISSUER, PTCK_CONTR) == true ) 
        FldRealValue = Party.rec.PartyID;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
          pThis.SetLinkedValue( H_ISSUER_NAME, Party.rec.shortname); 
        end;
     end;
  end;
  return CM_DEFAULT;
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_Client( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
        //pThis.SetLinkedValue( H_CLIENT_NAME, "");
     else
      // Установка значений по умолчанию не реализована 
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     //pThis.SetLinkedValue( H_CLIENT_NAME, "" );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     Party = TRecHandler("party.dbt");
     if( ListPT( Party, SelCodeKind, "", PTLIST_ALLCLIENT, PTCK_ALL) == true )
        FldRealValue = Party.rec.PartyID;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
          pThis.SetLinkedValue( H_CLIENT_NAME, Party.rec.shortname); 
        end;
     end;
  end;
  return CM_DEFAULT;
END;




//////////////////////////////////////////////////////////////////////////////////////////////////////////
PRIVATE MACRO DL_ListAvoiriss(AvrKind:INTEGER, WhereCondition:STRING, AdditionalFromTable:STRING, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):BOOL
  VAR Fininstr = TRecHandler( "fininstr.dbt" );

  if( ListAvoiriss( AvrKind, Fininstr, null, null, WhereCondition, AdditionalFromTable ) )
     FldRealValue = Fininstr.rec.FIID;
     FldShowValue = Fininstr.rec.FI_Code;
     return true;
  end;
  return false;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_AvrKind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var MenuValues   = TArray,
      ReturnValues = TArray,
      isOK, Choice, Query,AvrKindsDataSet;
      
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
      // Установка значений по умолчанию не реализована
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
    Query =" SELECT T_NAME,T_AVOIRKIND FROM Davrkinds_DBT "
           " WHERE T_FI_KIND = 2 "; // FIKIND_AVOIRISS 
    AvrKindsDataSet = TRSBDataSet(Query);
    isOK = AvrKindsDataSet.MoveNext();
    while( isOK )              
       MenuValues[MenuValues.Size]     = AvrKindsDataSet.rec.Name; 
       ReturnValues[ReturnValues.Size] = AvrKindsDataSet.rec.AVOIRKIND;
       isOK = AvrKindsDataSet.MoveNext();
    end;   
    Choice = menu( MenuValues, null, "Вид ЦБ", pThis.CurrentFldX(), pThis.CurrentFldY() );
    if( Choice >= 0 )
       FldShowValue = MenuValues[Choice]; 
       FldRealValue = ReturnValues[Choice];
    end;
         
  end;

  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_Exchange( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( H_EXCHANGE_NAME, "");
     else
      // Установка значений по умолчанию не реализована 
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     pThis.SetLinkedValue( H_EXCHANGE_NAME, "" );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) AND
        ( pThis.GetFieldValue( PNFLD_REGOPER_ON_ORCB ) == "X" ) )
     Party = TRecHandler("party.dbt");
     if( ListPT( Party, SelCodeKind, "", PTLIST_MARKETPLASE, PTCK_CONTR) == true )
        FldRealValue = Party.rec.PartyID;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
        end;
        pThis.SetLinkedValue( H_EXCHANGE_NAME, Party.rec.ShortName); 
     end;
  end;
  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_Broker( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );
  var ClientID = -1;
  ClientID = pThis.GetFieldValue( PNFLD_REGOPER_CLIENT );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( H_BROKER_NAME, "");
     else
      // Установка значений по умолчанию не реализована
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     pThis.SetLinkedValue( H_BROKER_NAME, "" );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) AND
        ( pThis.GetFieldValue( PNFLD_REGOPER_THROUGH_BROKER ) == "X" ) )
     Party = TRecHandler("party.dbt");
     if (ClientID == 0)
       return CM_DEFAULT;
     end;
     if( ListPT( Party, ClientID, "", 31, PTCK_CONTR) == true ) //31 - PTLIST_BROKER
        FldRealValue = Party.rec.PartyID;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
        end;
        pThis.SetLinkedValue( H_BROKER_NAME, Party.rec.ShortName); 
     end;
  end;
  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

/*Код Ц/Б*/
MACRO DLUSR_FldProc_AvrCode( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  
  VAR RetVal = CM_DEFAULT;
  VAR Fininstr, Avoiriss, AvrKind, AddTable = "", WhereCond = "1=1", AvrAttrID, IssuerID,AvrName;
  var fi = TRecHandler( "fininstr.dbt" );
  var period_end_date = pThis.GetFieldValue( PNFLD_REGOPER_FINISHDATE );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;

     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
        FldShowValue = ПолучитьКодФинИн(FldRealValue);
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     pThis.SetLinkedValue( H_SECUR_CODE_NAME, ""); 
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     AvrKind = pThis.GetFieldValue( PNFLD_REGOPER_SECUR_KIND );
     if (AvrKind==-1)
        AvrKind=0;
     end;
     
     IssuerID = pThis.GetFieldValue( PNFLD_REGOPER_ISSUER );
     if( (IssuerID != NULL) AND (IssuerID > 0) )
        WhereCond = WhereCond + " AND RSI_RSB_FIInstr.FI_GetIssuerOnDate( t.T_FIID, " + GetSQLDate(period_end_date) + "  ) = " + IssuerID;
     end;

     DL_ListAvoiriss( AvrKind, WhereCond, AddTable, @FldShowValue, @FldRealValue );
     if( ПолучитьФинИн( FldRealValue, fi ) == 0 )
       pThis.SetLinkedValue( H_SECUR_CODE_NAME, fi.rec.name); 
     end;
  else
    RetVal = DL_FldProc_AvrCode( pThis, Cmd, Key, @FldShowValue, @FldRealValue );
  end;

  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO RadioСlosed( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
     if (FldShowValue == "X")
       pThis.SetLinkedValue( H_RADIO_OPENED, "");
       pThis.SetLinkedValue( H_RADIO_ALL, "");
     end;
     if (FldRealValue != FldShowValue)
      FldShowValue = FldRealValue;
     end;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO RadioOpened( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
     if (FldShowValue == "X")
       pThis.SetLinkedValue( H_RADIO_CLOSED, "");
       pThis.SetLinkedValue( H_RADIO_ALL, "");
     end;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO RadioAll( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
     if (FldShowValue == "X")
       pThis.SetLinkedValue( H_RADIO_CLOSED, "");
       pThis.SetLinkedValue( H_RADIO_OPENED, "");
     end;
      
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        end;
     end;
  end;
  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_OperType( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var MenuValues   = TArray,
      ReturnValues = TArray,
      isOK, Choice, Query,AvrKindsDataSet;
      
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
      // Установка значений по умолчанию не реализована
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = DEALTYPE_ALL;
     FldShowValue = STR_ALLVALUE;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     MenuValues[0]    = "Брокерские"; 
     ReturnValues[0]  = DEALTYPE_BROKER;
     MenuValues[1]    = "Собсвенные"; 
     ReturnValues[1]  = DEALTYPE_OWN;
     MenuValues[2]    = "Управление ц/б"; 
     ReturnValues[2]  = DEALTYPE_DU;
    
    Choice = menu( MenuValues, null, "Тип операции", 24, 11);
    if( Choice >= 0 )
       FldShowValue = MenuValues[Choice]; 
       FldRealValue = ReturnValues[Choice];
    end;
         
  end;

  return CM_DEFAULT;
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_OperKind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var MenuValues   = TArray,
      ReturnValues = TArray,
      isOK, Choice, Query,AvrKindsDataSet,
      X:INTEGER,Y:INTEGER;
  
  DlRegOperData.IsUseBO = pThis.GetFieldValue( PNFLD_REGOPER_MODULE_BO );
  DlRegOperData.IsUseVA = pThis.GetFieldValue( PNFLD_REGOPER_MODULE_VA );
  
      
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
     else
      // Значение по умолчанию не реализовано
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = OPER_TYPE_ALL;
     FldShowValue = STR_ALLVALUE;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/


  if ( (pThis.GetFieldValue( PNFLD_REGOPER_OPER_TYPE ) == DEALTYPE_BROKER ) OR  
         (pThis.GetFieldValue( PNFLD_REGOPER_OPER_TYPE ) == DEALTYPE_DU ) ) // Брокераская или Управление ц/б
     MenuValues[0]    = "Погашение"; 
     ReturnValues[0]  = OPER_TYPE_POGASHENIE;
  elif ( (DlRegOperData.IsUseBO == "X") AND (DlRegOperData.IsUseVA != "X") )
     MenuValues[0]    = "Погашение"; 
     ReturnValues[0]  = OPER_TYPE_POGASHENIE;
     MenuValues[1]    = "Конвертация"; 
     ReturnValues[1]  = OPER_TYPE_KONVERTACIYA;
     MenuValues[2]    = "Получение паев"; 
     ReturnValues[2]  = OPER_TYPE_PAI;
     MenuValues[3]    = "Глобальная операция"; 
     ReturnValues[3]  = OPER_GLOBAL;
     MenuValues[4]    = "Изменение номинала"; 
     ReturnValues[4]  = OPER_NOMCHANG;
  elif ( (DlRegOperData.IsUseBO != "X") AND (DlRegOperData.IsUseVA == "X") )
     MenuValues[0]    = "Погашение"; 
     ReturnValues[0]  = OPER_TYPE_POGASHENIE;
     MenuValues[1]    = "Мена"; 
     ReturnValues[1]  = OPER_TYPE_MENA;
     MenuValues[2]    = "Передача ц/б в залог"; 
     ReturnValues[2]  = OPER_TYPE_ZALOG;
  elif ( (DlRegOperData.IsUseBO == "X") AND (DlRegOperData.IsUseVA == "X") )
     MenuValues[0]    = "Погашение"; 
     ReturnValues[0]  = OPER_TYPE_POGASHENIE;
     MenuValues[1]    = "Конвертация"; 
     ReturnValues[1]  = OPER_TYPE_KONVERTACIYA;
     MenuValues[2]    = "Получение паев"; 
     ReturnValues[2]  = OPER_TYPE_PAI;
     MenuValues[3]    = "Глобальная операция"; 
     ReturnValues[3]  = OPER_GLOBAL;
     MenuValues[4]    = "Изменение номинала"; 
     ReturnValues[4]  = OPER_NOMCHANG;
     MenuValues[5]    = "Мена"; 
     ReturnValues[5]  = OPER_TYPE_MENA;
     MenuValues[6]    = "Передача ц/б в залог"; 
     ReturnValues[6]  = OPER_TYPE_ZALOG;

  end;

    X = pThis.CurrentFldX();
    Y = pThis.CurrentFldY();
    
    Choice = menu( MenuValues, null, "Вид операции", 26, 17);
    if( Choice >= 0 )
       FldShowValue = MenuValues[Choice]; 
       FldRealValue = ReturnValues[Choice];
    end;
         
  end;

  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_Depo( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );
  var ClientID = -1;
  ClientID = pThis.GetFieldValue( PNFLD_REGOPER_CLIENT );
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( H_BROKER_NAME, "");
     else
      // Установка значений по умолчанию не реализована 
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     pThis.SetLinkedValue( H_BROKER_NAME, "" );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     Party = TRecHandler("party.dbt");
     if (ClientID == 0)
       return CM_DEFAULT;
     end;
     if( ListPT( Party, ClientID, "", 5, PTCK_ALL) == true ) //5 - PTLIST_DEPOSITORY
        FldRealValue = Party.rec.PartyID;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
        end;
        pThis.SetLinkedValue( H_DEPO_NAME, Party.rec.ShortName); 
     end;
  end;
  return CM_DEFAULT;
END;



//////////////////////////////////////////////////////////////////////////////////////////////////////////


PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
        FldShowValue = FldRealValue;
/* elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = 0;
     FldShowValue = STR_ALLVALUE;
*/       
  end; 
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////


PRIVATE MACRO DLUSR_FldProc_MODULE_BO( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
        end;
     end;
  end;

  DlRegOperData.IsUseVA = pThis.GetFieldValue( PNFLD_REGOPER_MODULE_VA );

  if ( (FldRealValue != "X") AND (DlRegOperData.IsUseVA == "X"))
     DisableFields( pThis.Data(), PNFLD_REGOPER_ON_ORCB );
     DisableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE );
     DisableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE_NAME );
     DisableFields( pThis.Data(), PNFLD_REGOPER_NOT_ON_ORCB );
     DisableFields( pThis.Data(), PNFLD_REGOPER_THROUGH_BROKER );
     DisableFields( pThis.Data(), PNFLD_REGOPER_BROKER );
     DisableFields( pThis.Data(), PNFLD_REGOPER_BROKER_NAME );
  else
     EnableFields( pThis.Data(), PNFLD_REGOPER_ON_ORCB );
     EnableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE );
     EnableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE_NAME );
     EnableFields( pThis.Data(), PNFLD_REGOPER_NOT_ON_ORCB );
     EnableFields( pThis.Data(), PNFLD_REGOPER_THROUGH_BROKER );
     EnableFields( pThis.Data(), PNFLD_REGOPER_BROKER );
     EnableFields( pThis.Data(), PNFLD_REGOPER_BROKER_NAME );
  end;

  return CM_DEFAULT;
END;

//////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO DLUSR_FldProc_MODULE_VA( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
        end;
     end;
  end;

  DlRegOperData.IsUseBO = pThis.GetFieldValue( PNFLD_REGOPER_MODULE_BO );

  if ( (FldRealValue == "X") AND (DlRegOperData.IsUseBO != "X"))
     DisableFields( pThis.Data(), PNFLD_REGOPER_ON_ORCB );
     DisableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE );
     DisableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE_NAME );
     DisableFields( pThis.Data(), PNFLD_REGOPER_NOT_ON_ORCB );
     DisableFields( pThis.Data(), PNFLD_REGOPER_THROUGH_BROKER );
     DisableFields( pThis.Data(), PNFLD_REGOPER_BROKER );
     DisableFields( pThis.Data(), PNFLD_REGOPER_BROKER_NAME );
  else
     EnableFields( pThis.Data(), PNFLD_REGOPER_ON_ORCB );
     EnableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE );
     EnableFields( pThis.Data(), PNFLD_REGOPER_EXCGANGE_NAME );
     EnableFields( pThis.Data(), PNFLD_REGOPER_NOT_ON_ORCB );
     EnableFields( pThis.Data(), PNFLD_REGOPER_THROUGH_BROKER );
     EnableFields( pThis.Data(), PNFLD_REGOPER_BROKER );
     EnableFields( pThis.Data(), PNFLD_REGOPER_BROKER_NAME );
  end;

  return CM_DEFAULT;
END;

///////////////////////////////////////////////////////////////////////////////////////////
// Инициализация


CLASS (DL_CPanel) DL_AccountsReg_Panel()

  PRIVATE MACRO Init()
     AddFieldProc( 0, PNFLD_REGOPER_MODULE_BO,            H_MODULE_BO,        @DLUSR_FldProc_MODULE_BO, DlRegOperData.IsUseBO );
     AddFieldProc( 0, PNFLD_REGOPER_MODULE_VA,            H_MODULE_VA,        @DLUSR_FldProc_MODULE_VA, DlRegOperData.IsUseVA );
     AddFieldProc( 0, PNFLD_REGOPER_BEGINDATE,            DL_PNFLD_BEGINDATE, @DL_FldProc_BeginDate,  DlRegOperData.BeginDate );
     AddFieldProc( 0, PNFLD_REGOPER_FINISHDATE,           DL_PNFLD_ENDDATE,   @DL_FldProc_EndDate,    DlRegOperData.EndDate );
     AddFieldProc( 0, PNFLD_REGOPER_SPLIT_BY_DATES,       DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,   DlRegOperData.SplitByDates );
     
     AddFieldProc( 0, PNFLD_REGOPER_SECUR_KIND,           DL_PNFLD_AVRKIND,         @DL_FldProc_AvrKind );
     AddFieldProc( 0, PNFLD_REGOPER_ISSUER,               DL_PNFLD_AVRISSUER,       @DL_FldProc_AvrIssuer);         
     AddFieldProc( 0, PNFLD_REGOPER_ISSUER_NAME,          DL_PNFLD_AVRISSUERNAME,   @Default, "");         

     AddFieldProc( 0, PNFLD_REGOPER_SECUR_CODE,           DL_PNFLD_AVRCODE, @DLUSR_FldProc_AvrCode );
     AddFieldProc( 0, PNFLD_REGOPER_SECUR_CODE_NAME,      DL_PNFLD_AVRNAME, @DL_FldProc_AvrName );

     AddFieldProc( 0, PNFLD_REGOPER_OPER_TYPE,            H_OPER_TYPE,      @DLUSR_FldProc_OperType);         
     AddFieldProc( 0, PNFLD_REGOPER_CLIENT,               H_CLIENT,         @DLUSR_FldProc_Client);         
     AddFieldProc( 0, PNFLD_REGOPER_CLIENT_NAME,          H_CLIENT_NAME,    @Default, "");         

     AddFieldProc( 0, PNFLD_REGOPER_ISFORM,               H_ISFORM,         @DL_FldProc_IsFormVid1,     DlRegOperData.IsForm);
     AddFieldProc( 0, PNFLD_REGOPER_FORMSUB,              H_FORMSUB,        @DL_FldProc_FormSub,        DlRegOperData.FormSub, 31, 13);
     AddFieldProc( 0, PNFLD_REGOPER_ISVID,                H_ISVID,          @DL_FldProc_IsFormVid2,     DlRegOperData.IsVid);
     AddFieldProc( 0, PNFLD_REGOPER_VIDSUB,               H_VIDSUB,         @DL_FldProc_VidSub,         DlRegOperData.VidSub , 31, 14);
     AddFieldProc( 0, PNFLD_REGOPER_NORESIDENT,           DL_PNFLD_CHECKBOX,@DL_FldProc_CheckBox,       DlRegOperData.Noresident);
     
     AddFieldProc( 0, PNFLD_REGOPER_DEALTYPE_CLOSED,      H_RADIO_CLOSED,  @RadioСlosed, DlRegOperData.isOperClosed);
     AddFieldProc( 0, PNFLD_REGOPER_DEALTYPE_OPENED,      H_RADIO_OPENED,  @RadioOpened, DlRegOperData.isOperOpened);
     AddFieldProc( 0, PNFLD_REGOPER_DEALTYPE_ALL,         H_RADIO_ALL,     @RadioAll,    DlRegOperData.isOperAll);
     
     AddFieldProc( 0, PNFLD_REGOPER_OPER_KIND,            H_OPER_KIND,     @DLUSR_FldProc_OperKind);
     AddFieldProc( 0, PNFLD_REGOPER_DEPO,                 H_DEPO,          @DLUSR_FldProc_Depo);
     AddFieldProc( 0, PNFLD_REGOPER_DEPO_NAME,            H_DEPO_NAME,     @Default, "");
     
     AddFieldProc( 0, PNFLD_REGOPER_ON_ORCB,              DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,   DlRegOperData.isOnORBC );
     AddFieldProc( 0, PNFLD_REGOPER_EXCGANGE,             H_EXCHANGE,          @DLUSR_FldProc_Exchange);
     AddFieldProc( 0, PNFLD_REGOPER_EXCGANGE_NAME,        H_EXCHANGE_NAME,     @Default, "");
     AddFieldProc( 0, PNFLD_REGOPER_NOT_ON_ORCB,          DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,   DlRegOperData.isNotOnORBC );
     AddFieldProc( 0, PNFLD_REGOPER_THROUGH_BROKER,       DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,   DlRegOperData.isThroughBroker );
     AddFieldProc( 0, PNFLD_REGOPER_BROKER,               H_BROKER,            @DLUSR_FldProc_Broker);
     AddFieldProc( 0, PNFLD_REGOPER_BROKER_NAME,          H_BROKER_NAME,       @Default, "");


     AddFieldProc( 0, PNFLD_REGOPER_WITH_APOSTROFS,       DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,   DlRegOperData.IsUseOpostrofs );
     AddFieldProc( 0, PNFLD_REGOPER_TO_EXEL,              DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,   DlRegOperData.IsExportToExel );
     AddFieldProc( 0, PNFLD_REGOPER_DEPARTMENT,           H_DEPARTMENT,       @DLUSR_FldProc_Department);
     AddFieldProc( 0, PNFLD_REGOPER_DEPARTMENT_NAME,      H_DEPARTMENT_NAME,  @Default, "");

     if(VA_NeedInnerAcc() == false)
       DisableFields( This.Data(), PNFLD_REGOPER_MODULE_VA ); 
     end;
     DisableFields( This.Data(), PNFLD_REGOPER_FORMSUB ); 
     DisableFields( This.Data(), PNFLD_REGOPER_VIDSUB ); 

  END;

///////////////////////////////////////////////////////////////////////////////////////////

  PRIVATE MACRO Check():BOOL
     return true;
  END;
  
///////////////////////////////////////////////////////////////////////////////////////////

  initDL_CPanel( "dlrep.lbr", "SREGOPER" ); 
END;
