/*
$Name:        dlsecacts.mac
$Module:      Ядро Securities
$Description: ОТЧЕТ: "АКТЫ СВЕРКИ Ц/Б"(бо)
*/
IMPORT FIInter,"DLReport_h.mac";
IMPORT "dlmisc.mac";
IMPORT "dlsecact_form.mac";


PRIVATE VAR  m_Form = DL_ActAvr_Panel();

PRIVATE MACRO UpdateFormFields():INTEGER
    DlSActsRepFormData.DepartmentID              = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_DEPARTMENT );
    DlSActsRepFormData.BeginDate                 = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_BEGINDATE );
    DlSActsRepFormData.EndDate                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_FINISHDATE );
    DlSActsRepFormData.IsUseBO                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_MODULE_BO );
    DlSActsRepFormData.IsUseVA                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_MODULE_VA );
    
    DlSActsRepFormData.WithNoChanging            = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_WITH_NOCHANGING );
    DlSActsRepFormData.ForEveryDate              = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_FOR_EVERY_DATE );

    DlSActsRepFormData.AccountBank               = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ACCOUNT_BANK );
    DlSActsRepFormData.AccountClient             = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ACCOUNT_CLIENT );
    DlSActsRepFormData.ClientCode                = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_CLIENT_CODE );
    DlSActsRepFormData.NumContr                  = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_NUM_CONTR );
    DlSActsRepFormData.AvrKind                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_AVRKIND );
    DlSActsRepFormData.IssuerCode                = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_ISSIUER_CODE );
    DlSActsRepFormData.AvrCode                   = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_AVRCODE );
    DlSActsRepFormData.IsUseApp                  = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_WITH_APOSTROFS );
    //DlSActsRepFormData.IsExportToExel            = m_Form.GetFieldValue( PNFLD_INACCSECUR_REG_TO_EXEL );
END;
  
PRIVATE MACRO GetAuditMsg(panel:DL_ActAvr_Panel):String
	UpdateFormFields();
	var msg:string = "";
	var beginDate:date = DlSActsRepFormData.BeginDate;
	var endDate:date = DlSActsRepFormData.EndDate;
    var deals1:string = "";
    var deals2:string = "";

    deals1 = IIF(DlSActsRepFormData.IsUseBO == "X",
                 "Модуля \"Бэк-офис ценных бумаг\"\n",
                 "");

    deals2 = IIF(DlSActsRepFormData.IsUseVA == "X",
                 "Модуля \"Учтенные векселя\"\n",
                 "");

    msg = 
    "Отчет:              Акт сверки наличия ценных бумаг\n\n" +
    "Отчетный период:          с " + beginDate + " по " + endDate + "\n" +
    "По сделкам:\n"  +
    deals1 + deals2 +
    "\n----------------------------------------\n";

    return msg;
END;
  
PRIVATE MACRO PrintJournal(IsExistsDepData: bool)
     var REPKIND_SECUR = 1;
     var query = " insert into DDL_JOURNAL_DBT " +
                 "   (T_DATE, T_TIME, T_REPDATE, T_OPER, T_REPKIND, T_RESULT ) " +
                 " VALUES " +
                 "   ( ?,?,?,?,?,? ) ";
     var sqlQuery = RSDCommand(query); 
     sqlQuery.addParam("", RSDBP_IN, DATE());//программная дата проведения сверки 
     sqlQuery.addParam("", RSDBP_IN, Time());//программное время проведения сверки
     sqlQuery.addParam("", RSDBP_IN, DlSActsRepFormData.EndDate);//конец отчетного периода
     sqlQuery.addParam("", RSDBP_IN, {oper});//операционист
     sqlQuery.addParam("", RSDBP_IN, REPKIND_SECUR);
     sqlQuery.addParam("", RSDBP_IN, IIF(IsExistsDepData, 1 , 0) );
     sqlQuery.execute();
END;

macro MakeReports()

  var stat = 0;
  
  stat = m_Form.Run();
  
  // ╧ЁютхЁ хь ьюцхь ыш ь√ фхырЄ№ юЄўхЄ яю яЁхфюёЄртыхээ√ь фрээ√ь
  if (not stat)
     return 1;
  end;

  UpdateFormFields();
 
  AuditLog(REPORT_START, GetAuditMsg(m_Form));
 
   Dl_CallInsertStat( IIF( DlSActsRepFormData.IsExportToExel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );

  var reportName = "";
  var IsExistData = false;

  if (DlSActsRepFormData.IsUseBO == "X" )
     reportName = reportName + ExecMacroFile("sec_acts.mac", "MakeReport", DlSActsRepFormData, @IsExistData ) + "\n                    ";
  end;

  if (DlSActsRepFormData.IsUseVA == "X" )
     reportName = reportName + ExecMacroFile("vaactsec.mac", "MakeReport", DlSActsRepFormData, @IsExistData );
  end;
  
  PrintJournal(IsExistData);
  
  AuditLog(REPORT_FINISH, GetAuditMsg(m_Form), reportName);
  
  return 0;
end;

while( not MakeReports())
end;
exit(1);
