/* Операции погашения купона/ ЧП */
/* Шаг актуализации счетов          */

import "sp_catac.mac", "sp_car.mac";

macro ExecuteStep( doc , ticket )
  record  deal(dl_tick);
  var     FD, FIRoles = TArray;  
  var     dat, ContrCateg;   

  SetBuff( deal, ticket );
  FD = SPFirstDoc( deal );

  dat = FD.tick.rec.DealDate;

  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_CREATE, dat, FD ) )
     msgbox("Ошибка при создании лота.");
     return 1;
  end;     

  if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_PLANE ) )
     msgbox("Ошибка при изменении статуса сделки");
     return 1;
  end;

  ContrCateg = СчетСписанияСредствЗаПогашение(FD);
  if( (ContrCateg != "Корсчет") AND (ContrCateg != "") )
     if( not FD.OpenAccount( ContrCateg, null, null, null, null, dat) )
        return 1;
     end;
  end;
 
  if( not IsClientDeal(deal) ) /*свои бумаги*/
     if( not FD.OpenAccount( "Реализация, ц/б", null, null, null, null, dat ) )
        return 1;
     end;
  end;  

  return 0;
end;

