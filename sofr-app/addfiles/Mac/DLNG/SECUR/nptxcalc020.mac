/* 
$Name:        nptxcalc020.mac
$Module:      Ценные бумаги
$Description: Операция расчета НОБ для НДФЛ  для НДФЛ. "Расчет связей"
*/
IMPORT InsCarryDoc, DealsInter, "secinter.mac";

PRIVATE VAR Oper = TRecHandler( "nptxop.dbt" );

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

PRIVATE MACRO RunAction()

  VAR OperationStatus;

/**************************** Сурен. 10.02.2019. Местами "по всем бумагам" в dnptxop_dbt ошибочно обозначается значением 0 ***/
if (Oper.rec.FIID == 0) Oper.rec.FIID = -1;
end;
/********************************************************************************************************************/


  if( DL_NPTX_CreateLots(Oper.rec.OperDate,
                         Oper.rec.CLIENT,
                         Oper.rec.IIS,
                         Oper.rec.FIID,
                         Oper.rec.BEGRECALCDATE,
                         Oper.rec.Recalc,
                         Oper.rec.Contract
                        ) != 0 
    )
     return 1;
  end;

  return 0;
END;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR Stat = 0;

  Oper.SetRecordAddr( FDoc );

  stat = DL_NPTX_PutMsg( "Расчет связей", 40 );
        
  if( not stat )
     stat = RunAction();
     DL_NPTX_SaveOperLog( Oper.rec.ID, 20 );
  end;

  return stat;
END;
