/*
 $Name: nptxcrnset009.mac
 $Module: Ценные бумаги
 $Description: Соглашение об урегулировании претензий. Шаг "Запрос СНОБ"
 */
import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(nptxop, ID_Operation, ID_Step)
  var AmountSNOB = $0;
  var err = 0, ErrStr = "";

  err = STB_ExecuteGetAmountSNOBOnStep(nptxop.rec.DocKind, nptxop.rec.ID, nptxop.rec.Client, nptxop.rec.OperDate, ID_Operation, ID_Step, @ErrStr, IIF(nptxop.rec.IIS == SET_CHAR, true, false), @AmountSNOB);
  if(ErrStr)
    Error(ErrStr);
  end;

  if(not err)
    if(nptxop.rec.CalcNDFL == SET_CHAR)
      if( not InsertOprStatus(46481, 2)) //Расчет НДФЛ
        return Error( "Ошибка при установке статуса вида \"Расчет НДФЛ\" операции" );        
      end;
    else
      if( not InsertOprStatus(46481, 4)) //Формирование проводок
        return Error( "Ошибка при установке статуса вида \"Формирование проводок\" операции" );        
      end;
    end;
  end;

  return err;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  var nptxop = TRecHandler("nptxop.dbt");
  var err = 0;

  SetBuff( nptxop, FDoc );

  err = RunAction(nptxop, ID_Operation, ID_Step);

  DL_NPTX_SaveOperLog(nptxop.rec.ID, 9);

  return err;
end;