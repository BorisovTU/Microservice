/*
$Name: nptxhold015.mac
$Module: Ценные бумаги
$Description: Запрос СНОБ для операции удержания НДФЛ
*/

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxcalcfun.mac", "nptxstbfun.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;


macro ExecuteStep( kind_oper, FDoc, DocKind, ID_Operation, ID_Step )
  record nptxop("nptxop");
  var ErrStr = "";
  var err = 0;
  var НОБ_опер = $0;
  
  SetBuff( nptxop, FDoc );

  //Проверить необходимость запроса СНОБ
  CalcNOBoper(nptxop, @НОБ_опер);

  if(DL_InsertNPTXVAL(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_Oper, date(0,0,0), time(0), НОБ_опер, 0) != 0)
    return Error( "Ошибка при сохранении значения СНОБ" );
  end;

  if(НОБ_опер != 0)
    err = STB_ExecuteGetAmountSNOBOnStep(nptxop.DocKind, nptxop.ID, nptxop.Client, nptxop.OperDate, ID_Operation, ID_Step, @ErrStr, IIF(nptxop.IIS == SET_CHAR, true, false), NULL, IIF(НОБ_опер < 0, true, false));
    if(ErrStr)
      Error(ErrStr);
    end;
  end;

  if(not err)
    if( not InsertOprStatus(46081, 10)) //Расчет сумм
      return Error( "Ошибка при установке статуса вида \"Расчет сумм\" операции" );        
    end;
  end;

  return err;
end;

