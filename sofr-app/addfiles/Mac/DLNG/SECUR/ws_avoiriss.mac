/*
$Name:             ws_avoiriss.mac
$Module:           АРНУ 
$Description:      WEB. АРНУ. Макрос сервисов скроллинга и панели ценной бумаги
*/
/*
  Shalygo S. M.
  04.10.2012
*/
import FIInter;
import "secinter.mac";
import "dldlngfun.mac";
import "spserv.mac";
import "ws_firate.mac";
import "ws_codevalues.mac";
import "fi.mac";
import "ws_avrkinds.mac";
import "ws_partylist.mac";
import "ws_llvalues.mac";
import "ws_fiunilist.mac";
import "ws_namealg.mac";
import "ws_common.mac";
import "ws_validation.mac";
import "ws_datafilter.mac";
import "ws_orderbygen.mac";
import "fiwarnts.mac";
import "ws_txfilistcond.mac";

// OBJCODE_INTERNAL
const CODE_FI_Code        = 1;
const CODE_ISO_Number     = 2;
const CODE_Ccy            = 3;
const CODE_LSIN           = 4;
const CODE_ISIN           = 5;
const CODE_CodeInAccount  = 6;
const CODE_MICEX          = 11;
const CODE_PTC            = 12;
const CODE_PTCC           = 13;
const CODE_NADC           = 14;
const CODE_DCLC           = 15;
const CODE_F404           = 16;
const CODE_CFI            = 18;

CONST MAX_INNER_SYSTEM_CODEKIND = 10;

/* Виды выплат (купоны, ч/погашения, дивиденды) */
const PayKind_Coupon           = 1;
const PayKind_PartialDischarge = 2;
const PayKind_Dividend         = 3;

// класс CTxAvoirIssList для заполнения скроллинга "Список ценных бумаг"
class CTxAvoirIssList
  var CodeName:String;      // Код ФИ
  var Name:String;          // Наименование
  var FIID:Integer;         // ID инструмента
  var AvoirKind:Integer;    // Вид
  var AvoirKindName:String; // Название вида
  var TaxGroup:Integer;     // Группа НУ
  var LSIN:String;          // № Гос.рег.
  var ISIN:String;          // ISIN
  var Issuer:Integer;       // Эмитент
  var IssuerName:String;    // Эмитент
  var Definition:String;    // Описание
  var IsAdditional:Bool;    // Дополнительный
  var RootAvrKinds:Integer; // Корневой подвид ц/б
  var IsCouponFI:Bool;      // Купонная бумага, в т.ч. ДР
  var IsClosed:Bool;        // Признак закрытой ц/б
  var IsSys:Bool;           // Признак системной ц/б
  var CodeCFI:String;       // Наименование кода CFI ФИ
  var ISONum:String;
end;

// класс CTxAvoirIss для заполнения вкладки "Анкета ЦБ" / "Анкета ДР"
class CTxAvoirIss
  var FIID:Integer;                         // ID ц/б
  var AvoirKind:Integer;                    // Вид ц/б
  var AvoirKindObj:CTxAvrKinds;             // Вид ц/б
  var AvoirSubKind:Integer;                 // Подвид ц/б
  var AvoirSubKindObj:CTxAvrKinds;          // Подвид ц/б
  var FI_Code:String;                       // Код ц/б
  var CodeInAccount:String;                 // Код в номере счета
  var Name:String;                          // Наименование
  var LSIN:String;                          // № гос.рег.
  var ISIN:String;                          // ISIN
  var Issuer;//:TWsPartyEx                  // Эмитент
  var OwnerAgent;//:TWsPartyEx              // Представитель владельцев облигаций
  var TaxGroup:TWsLlvalues;                 // ГНУ
  var TaxGroupList:TArray;                  // ГНУ
  var FaceValue:Money;                      // Номинал
  var FaceValueFI;//:TWsFinInstr            // Валюта номинала
  var CurrentFaceValue:Money;               // Текущий номинал
  var FV_Point:Integer;                     // Точность
  var Scale:Integer;                        // Масштаб
  var IncomeType;//:TWsNameAlg              // Вид дохода
  var IncomeRate:Double;                    // Ставка дохода
  var IncomeVolume:Money;                   // Доход
  var NKDBase_Kind;//:TWsNameAlg            // Вид базиса при расчете КД
  var NKDRoundOne:Bool;                     // Округление НКД по одному купону
  var NKDRoundPaym:Bool;                    // Округление НКД по платежу
  var Certificated:Bool;                    // Документарная
  var Non_Certificated:Bool;                // Бездокументарная
  var Issue:String;                         // Выпуск
  var Tranche:String;                       // Транш
  var Qty:Money;                            // Объем
  var Series:String;                        // Серия
  var IsQuoted:Bool;                        // Котируемая
  var IsVoting:Bool;                        // Голосующая
  var IsGeneralized:Bool;                   // Выпуск является обобщенным
  var GeneralizedFIID;//:TWsFinInstr        // Обобщенный выпуск
  var IsSys:Bool;                           // Системный
  var IsAdditional:Bool;                    // Дополнительный
  var MainFIID;//:TWsFinInstr               // Основной выпуск
  var Issued:Date;                          // Дата выпуска
  var InCirculationDate:Date;               // Дата ввода в обращение
  var DrawingDate:Date;                     // Дата погашения
  var ExpiryDate:Date;                      // Дата закрытия
  var BegPlacementDate:Date;                // Дата начала размещения
  var EndPlacementDate:Date;                // Дата окончания размещения
  var ListDate:Date;                        // Дата составления перечня
  var ServiceState;//:TWsNameAlg            // Статус депозитарного обслуживания
  var ServiceStateDate:Date;                // Дата установки статуса
  var ServiceStateOper:Integer;             // Номер операциониста, установившего статус
  var ServiceNameStateOper:String;          // Имя операциониста, установившего статус
  var DepartmentName:String;                // Филиал
  var ServiceStartDate:Date;                // Дата приема на обслуживание
  var ServiceStartOper:Integer;             // Номер операциониста, принявшего бумагу
  var ServiceNameStartOper:String;          // Имя операциониста, принявшего бумагу
  var Definition:String;                    // Комментарий
  var FinInstrVersion:Integer;              // Версия изменений финансового инструмента
  var AvoirIssVersion:Integer;              // Версия изменений ценной бумаги
  var IsMainAvr:Bool;                       // Есть дочернии выпуски
  var IsIndividual:Bool;                    // Индивидуальная
  var IsEmissive:Bool;                      // Эмиссионная
  var IsCoupon:Bool;                        // Купонная
  var HasCoupon:Bool;                       // Имеет ли ценная бумага купоны
  var HasPartialDischarge:Bool;             // Имеет ли ценная бумага частичные погашения
  var NumBaseFI:Double;                     // Количество ц/б в ДР
  var IsClosed:Bool;                        // Признак закрытой ц/б
  var IsIndexNominal:Bool;                  // Признак цб с индексируемым номиналом

  // поля для депозитарной расписки
  var ParentFI;//:TWsFinInstr               // ц/б
  var ParentFILSIN:String;                  // № гос.рег.
  var ParentFIISIN:String;                  // ISIN
  var ParentFIIssuer;//:TWsPartyEx          // Эмитент
  var ParentFIIssuerNRCountry;//:TWsCountry // страна
  var ChangedProperty:String;               // Имя измененного поля

  macro Construct()
     FIID = ALLFININSTR;
     IsGeneralized = false;
     TaxGroupList = TArray();
  end;

  this.Construct();
end;

// класс CTxAvoirPay для заполнения вкладок "Купоны", "Ч/погашения", "Дивиденды"
class CTxAvoirPay
  var FIID:Integer;             // Идентификатор ценной бумаги
  var IsPartial:Bool;           // Признак частичного погашения
  var Number:String;            // Номер (купона, ч/погашения, получения)
  var DrawingDate:Date;         // Дата погашения/Дата погашения/Максимальный срок выплаты эмитентом
  var IncomeVolume:Money;       // Сумма купона/погашения/получения
  var IncomeFI;//:TWsFinInstr   // Валюта дохода
  var IsClosed:Bool;            // Погашено/Выполнено/Получены
  var Name:String;              // Наименование купона
  var FirstDate:Date;           // Дата начала начисления купонного дохода
  var ListDate:Date;            // Дата составления перечня владельцев
  var IncomePoint:Integer;      // Точность округления
  var IncomeScale:Integer;      // Масштаб
  var NonRelativeIncome:Bool;   // Доход задается в абсолютной форме/Сумма погашения
  var RelativeIncome:Bool;      // Доход задается в %/Погашаемый % номинала
  var IncomeRate:Double;        // %
  var AllPartialPercent:Double; // Общая сумма %
  var Definition:String;        // Комментарий
  var Action:Integer;           // Вид действия
  var ID:Integer;               // ID записи
  var Version:Integer;          // Версия записи
  var ChangedProperty:String;   // Имя измененного поля
  var PayPeriod:String;         // Период выплата

  macro Construct()
     ID = 0;
     Number = "";
  end;

  this.Construct();
end;

// класс CTxAvoirFlWarn для заполнения вкладки "Плавающие купоны"
class CTxAvoirFlWarn
  var FIID:Integer;           // Идентификатор ценной бумаги
  var IncomeCode:String;      // Код вида дохода
  var ChargeDate:Date;        // Дата начисления
  var FactDate:Date;          // Дата получения
  var IncomeVolume:Money;     // Сумма
  var IncomeFI;//:TWsFinInstr // Валюта дохода
  var Action:Integer;         // Вид действия
  var ID:Integer;
  var Version:Integer;
  var Definition:String;      // Комментарий
end;

// класс CTxAvoirValHist для заполнения вкладок "Номинал/Выпуск"
class CTxAvoirValHist
  var FIID:Integer;        // Идентификатор ценной бумаги
  var BegDate:Date;        // Дата начала действия значения
  var EndDate:Date;        // Дата окончания действия значения
  var Value:Money;         // Значение номинала/объема выпуска
  var Issuer;//:TWsPartyEx // Эмитент
  var Active:Bool;         // Действующее значение
  var Action:Integer;      // Вид действия
  var ValKind:Integer;
  var ID:Integer;
  var Version:Integer;
  var Edit:bool;
end;

// класс CTxFundRulesPeriod для заполнения атрибута CTxAvrInvst.Periods
class CTxFundRulesPeriod
  var PeriodStart:Date; // Начало периода
  var PeriodEnd:Date;   // Окончание периода
end;

// класс CTxAvrInvst для заполнения вкладок пая / Ипотечного сертификата участия
class CTxAvrInvst
  // Анкета пая
  var FIID:Integer;                   // ID ц/б
  var AvoirKind:Integer;              // Вид ц/б  
  var FI_Code:String;                 // Код ц/б
  var CodeInAccount:String;           // Код в номере счета
  var FI_Name:String;                 // Наименование
  var LSIN:String;                    // № гос.рег.
  var ISIN:String;                    // ISIN
  var Issuer;//:TWsPartyEx            // Эмитент
  var TaxGroup:TWsLlvalues;           // ГНУ
  var TaxGroupList:TArray;            // ГНУ
  var IsQuoted:Bool;                  // Котируемая
  var HasIncome:Bool;                 // Получение доходов
  var IncomeFI;//:TWsFinInstr         // Валюта дохода
  var IsVoting:Bool;                  // Голосующая
  var SumPrecision:Integer;           // Знаков после запятой в количестве ц/б

  // Описание фонда
  var Name:String;                    // Наименование фонда
  var Type:Integer;                   // Тип фонда
  var IT_Interval:Bool;               // Тип фонда: интервальный
  var IT_Open:Bool;                   // Тип фонда: открытый
  var IT_Closed:Bool;                 // Тип фонда: закрытый
  var IT_Market:Bool;                 // Тип фонда: биржевой
  var Category:TWsLlvalues;           // Категория фонда
  var CategoryList:TArray;            // Категория фонда
  var Depositary;//:TWsPartyEx        // Спец. депозитарий
  var Registrar;//:TWsPartyEx         // Регистратор
  var Auditor;//:TWsPartyEx           // Аудитор
  var Estimator;//:TWsPartyEx         // Оценщик
  var Agent1;//:TWsPartyEx            // Агент 1
  var Agent2;//:TWsPartyEx            // Агент 2
  var RulesRegXid:String;             // Номер регистрации правил
  var Issued:Date;                    // Дата выпуска
  var RulesRegAgency;//:TWsPartyEx    // Орган регистрации правил
  var RulesChangeXid:String;          // Номер изменения правил
  var RulesChangeDate:Date;           // Дата изменения правил
  var RulesChangeAgency;//:TWsPartyEx // Орган регистрации изменения правил
  var RadioButEndDate:Bool;           // Срок действия договора: дата окончания
  var ContractEnd:Date;               // Дата окончания договора
  var RadioButDuration:Bool;          // Срок действия договора: срок действия
  var ContractDuration:Integer;       // Срок договора
  var DurationType;//:TWsNameAlg      // Единица срока договора

  // Правила фонда
  var FormPeriodStart:Date;           // Начало периода формирования
  var FormPeriodEnd:Date;             // Окончание периода формирования
  var MinValue:Money;                 // Минимальная стоимость имущества
  var MinValueFIID;//:TWsFinInstr     // Валюта минимальной стоимости
  var FormValue:Money;                // Стоимость пая при формировании
  var FormValueFIID;//:TWsFinInstr    // Валюта стоимости пая при формировании
  var FormDate:Date;                  // Дата формирования
  var Qty:Money;                      // Общее количество инвестиционных паев
  var RadioButAnyDay:Bool;            // Прием заявок: в любой рабочий день
  var RadioButPeriod:Bool;            // Прием заявок: в определенные сроки
  var Periods:TArray = TArray();      // Массив объектов CTxFundRulesPeriod из 5 периодов
  var CountPeriod:Integer;            // Количество используемых периодов
  var RadioButDate:Bool;              // Прием заявок: погашение за дату
  var DrawingDate:Date;               // Дата погашения
  var ExpiryDate:Date;                // Дата закрытия

  // Вознаграждения
  var IssuerIncome:String;            // Вознаграждение управляющей компании
  var DepositaryIncome:String;        // Вознаграждение спецдепозитарию
  var RegistrarIncome:String;         // Вознаграждение регистратору
  var AuditorIncome:String;           // Вознаграждение аудитору
  var EstimatoIncome:String;          // Вознаграждение оценщику
  var MaxOutlay:String;               // Максимальный размер доходов
  var Definition:String;              // Комментарий

  var FinInstrVersion:Integer;
  var AvoirIssVersion:Integer;
  var InvstVersion:Integer;
  var AccountEndDate:Date;
  var IsClosed:Bool;                  // Признак закрытого пая
  var IsSys:Bool;                     // Признак системного инструмента   

  var ChangedProperty:String;         // Имя измененного поля
end;

class CTxAvoirPanel
  var FIID:Integer;                             // Идентификатор финансового инструмента
  var AvoirKind:Integer;                        // Вид ценной бумаги
  var FI_Code:String;                           // Код финансового инструмента
  var Name:String;                              // Имя финансового инструмента
  var RootAvrKinds:Integer;                     // Корневой вид ценной бумаги
  var IsCouponFI:bool;                          // Признак купонной ц/б (включая ДР)
  var AvoirIss;//:CTxAvoirIss                   // Параметры анкеты ц/б
  var AvrInvst;//:CTxAvrInvst                   // Параметры анкеты пая
  var Coupons;//:TArray of CTxAvoirPay          // Массив купонов
  var FloatCoupons;//:TArray of CTxAvoirFlWarn  // Массив плавающих купонов
  var PDischarges;//:TArray of CTxAvoirPay      // Массив ч/погашений
  var Dividends;//:TArray of CTxAvoirPay        // Массив получений дивидендов
  var Codes;//:TArray of TWSCodeValue           // Массив кодов ц/б
  var Rates;//:TArray of TWsFIRateDef           // Массив курсов ц/б
  var FaceValues;//:TArray of CTxAvoirValHist   // Массив истории изменения номинала
  var Qtys;//:TArray of CTxAvoirValHist         // Массив истории изменения объема выпуска
  var Issuers;//:TArray of CTxAvoirValHist      // Массив истории изменения эмитента
  var UserIsAdmin:Bool;                         // Признак пользователь - администартор
  var FVLastID:integer;                         // Последний ID добавленной записи в историю изменения номинала
  var AddVFByChangeFaceValue:bool;              // Добавлялась ли запись в историю изменения номинала при смене номинала в анкете
end;

class CTxFICodeReference
  var FI_Code:String;
  var CodeInAccount:String;
  var AvoirCodeRefID:Integer;
  var AvoirAccountCodeRefID:Integer;
end;

// Класс с параметрами, для обновления связанных анкет для выпуска, купонов или ЧП
class CTxLinkedFormUpdateParams
  var Fiid : Integer;  // Идентификатор ФИ ценной бумаги
  var Number : String; // Номер купона
  var Kind : Integer;  // Вид анкеты

  var IsAskQuestion : Bool;     // спросить пользователя об обновлении связанной анкеты ?
  var Message : String;

  var NewListDate : Date;       // обновленная дата для выпуска, купона или ЧП

  var IsLastPDischarges : Bool; // использовать последнюю дату частичных погашений (ЧП) ?
  var LastListDate : Date;      // последняя дата из ЧП
end;

// Параметры фильтрации ФИ для листалки цб, вызываемой из виджета FIUniListWidget
class CTxFIFltrPrm
  var FinInstrFltrParm; //:TWsFinInstrFltrParm // Параметры фильтра
  var Param; // Дополнительные параметры
end;

macro TxAvoirIssRunError( Err:Variant, Stat:Integer )
  WSRunError( "ws_avoiriss.mac", Err, Stat );
end;

private macro GetSQLCodeFICondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType(value[0].CodeKind) == V_INTEGER ) )
    strSQLCond = " fi.t_Fiid ";

    if( ( condition == FilterCondition_Equal)
     or ( condition == FilterCondition_Include)
     or ( condition == FilterCondition_StartWith) )
      strSQLCond = strSQLCond + " IN (";
    else
      strSQLCond = strSQLCond + " NOT IN (";
    end;

    strSQLCond = strSQLCond +
      " SELECT "
        + " fin_.t_FIID "
    + " FROM "
        + " dfininstr_dbt fin_ "
       + " ,davoiriss_dbt avoir_ "
       + " ,dobjcode_dbt objcode_ "
    + " WHERE "
        + " avoir_.t_FIID = fin_.t_FIID "
    + " AND objcode_.t_ObjectID(+) = fin_.t_FIID "
    + " AND objcode_.t_ObjectType(+) = " + String( OBJTYPE_FININSTR ) + " "
    + " AND objcode_.t_CodeKind(+) = " + String( value[0].CodeKind ) + " ";

    if( ( condition == FilterCondition_Equal )
     or ( condition == FilterCondition_Include )
     or ( condition == FilterCondition_StartWith ) )
       if( ValType(value[0].Name) == V_STRING )
          if( ( value[0].CodeKind == CODE_FI_Code ) or ( value[0].CodeKind == 0 ) )
             strSQLCond = strSQLCond + " AND fin_.t_FI_Code ";
          elif( value[0].CodeKind == CODE_ISO_Number )
            strSQLCond = strSQLCond + " AND fin_.t_ISO_Number ";
          elif( value[0].CodeKind == CODE_Ccy )
            strSQLCond = strSQLCond + " AND fin_.t_Ccy ";
          elif( value[0].CodeKind == CODE_CodeInAccount )
            strSQLCond = strSQLCond + " AND fin_.t_CodeInAccount ";
          elif( value[0].CodeKind == CODE_LSIN )
            strSQLCond = strSQLCond + " AND avoir_.t_LSIN ";
          elif( value[0].CodeKind == CODE_ISIN )
            strSQLCond = strSQLCond + " AND avoir_.t_ISIN ";
          elif( value[0].CodeKind > MAX_INNER_SYSTEM_CODEKIND )
            strSQLCond = strSQLCond + " AND objcode_.t_Code ";
          end;

          if( condition == FilterCondition_Equal )
             strSQLCond = strSQLCond + " LIKE '" + StrSubst( StrSubst( value[0].Name, "?", "_" ), "*", "%" ) + "' ";
          elif( condition == FilterCondition_Include )
             strSQLCond = strSQLCond + " LIKE '%" + value[0].Name + "%' ";
          elif( condition == FilterCondition_StartWith )
             strSQLCond = strSQLCond + " LIKE '" + value[0].Name + "%' ";
          end;
       else
          strSQLCond = strSQLCond + " AND objcode_.t_code = '' ";
       end;
    end;
    strSQLCond = strSQLCond + ")";
  else
    strSQLCond = " 1 = 1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLAvoirKindCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond : String = GetSQLAvoirKindConditionEx( "avrkind", "t_AvoirKind", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " RSB_FIInstr.FI_AvrKindsEQ( " + String( FIKIND_AVOIRISS ) + ", 0, avrkind.t_AvoirKind ) = 1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLFaceValueFICondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond : String = GetSQLFIConditionEx( "fi", "t_FaceValueFI", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " fi.t_FaceValueFI = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLMainFICondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond : String = GetSQLFIConditionEx( "fi", "t_MainFIID", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " fi.t_MainFIID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLGeneralizedFICondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond : String = GetSQLFIConditionEx( "fi", "t_GeneralizedFIID", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " fi.t_GeneralizedFIID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIssueCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLPartyConditionEx( "party", "t_PartyID", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " party.t_PartyID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLGNUCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLLlValuesConditionEx( "avoir", "t_TaxGroup", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " avoir.t_TaxGroup = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLCertificatedCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( value[0] == true ) )
    strSQLCond = " = 1 ";
  else
    strSQLCond = " = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIsQuotedCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( value[0] == true ) )
    strSQLCond = " RSB_FIInstr.FI_IsQuoted( fi.t_FIID, RsbSessionData.curdate ) > 0 ";
  else
    strSQLCond = " RSB_FIInstr.FI_IsQuoted( fi.t_FIID, RsbSessionData.curdate ) = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIsSecurEmissiveCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( value[0] == true ) )
    strSQLCond = " RSB_FIInstr.FI_IsSecurEmissive( fi.t_FIID ) > 0 ";
  else
    strSQLCond = " RSB_FIInstr.FI_IsSecurEmissive( fi.t_FIID ) = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIsQualifiedCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( value[0] == true ) )
    strSQLCond = " RSB_FIInstr.FI_IsQualified( fi.t_FIID, RsbSessionData.curdate ) = 0 ";
  else
    strSQLCond = " RSB_FIInstr.FI_IsQualified( fi.t_FIID, RsbSessionData.curdate ) > 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIsClosedCondition(
  condition:Integer
 ,value//:TArray of <type>
 ,type:Integer
):String
  var strSQLCond:String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( value[0] == true ) )
    if( CheckTaxDepositoryMode() )
      strSQLCond = " fi.t_IsClosed = CHR( 88 ) ";
    else
      strSQLCond = " avoir.t_SPIsClosed = CHR( 88 ) ";

    end;
  else
    if( CheckTaxDepositoryMode() )
      strSQLCond = " fi.t_IsClosed = CHR( 0 ) ";
    else
      strSQLCond = " avoir.t_SPIsClosed = CHR( 0 ) ";
    end;
  end;

  return strSQLCond;
end;

private macro GetTxAvoirIssAddWhereCondition(
  FilterItems//:TArray of FilterCondItem
):String

  var fp = FilterParser( FilterItems );

  fp.AddUserFieldCondition( 0, @GetSQLCodeFICondition ); // Код финансового инструмента
  fp.AddFieldCondition( 1, "fi", "t_name" ); // Наименование
  fp.AddUserFieldCondition( 2, @GetSQLAvoirKindCondition ); // Вид ценной бумаги
  fp.AddUserFieldCondition( 3, @GetSQLIssueCondition ); // Эмитент
  fp.AddFieldCondition( 4, "avoir", "t_LSIN" ); // Номер государственной регистрации
  fp.AddFieldCondition( 5, "avoir", "t_ISIN" ); // ISIN
  fp.AddFieldCondition( 6, "fi", "t_Issued" ); // Дата регистрации выпуска
  fp.AddFieldCondition( 7, "avoir", "t_InCirculationDate" ); // Дата ввода в обращение
  fp.AddFieldCondition( 8, "fi", "t_DrawingDate" ); // Дата погашения
  fp.AddFieldCondition( 9, "avoir", "t_BegPlacementDate" ); // Дата начала размещения
  fp.AddFieldCondition( 10, "avoir", "t_EndPlacementDate" ); // Дата окончания размещения
  fp.AddFieldCondition( 11, "fi", "t_FaceValue" ); // Номинальная стоимость
  fp.AddUserFieldCondition( 12, @GetSQLFaceValueFICondition ); // Валюта номинала
  fp.AddUserFieldCondition( 13, @GetSQLGNUCondition ); // Группа налогового учета
  fp.AddFieldCondition( 14, "fi", "t_Settlement_Code", null, @GetSQLCertificatedCondition ); // Документарная
  fp.AddUserFieldCondition( 15, @GetSQLIsQuotedCondition ); // Котируемая
  fp.AddUserFieldCondition( 16, @GetSQLIsSecurEmissiveCondition ); // Эмиссионная
  fp.AddFieldCondition( 17, "fi", "t_IsAdditional" ); // Является дополнительным выпуском
  fp.AddUserFieldCondition( 18, @GetSQLMainFICondition ); // Основной выпуск
  fp.AddFieldCondition( 19, "fi", "t_IsGeneralized" ); // Является обобщенным выпуском
  fp.AddUserFieldCondition( 20, @GetSQLGeneralizedFICondition ); // Обобщенный выпуск
  fp.AddUserFieldCondition( 21, @GetSQLIsQualifiedCondition ); // Неквалифицированная ценная бумага
  fp.AddUserFieldCondition( 22, @GetSQLIsClosedCondition ); // Является закрытой
  fp.AddFieldCondition( 23, "fi", "t_FIID" ); // ID инструмента
  fp.AddFieldCondition( 24, "fi", "t_Definition" ); // Описание

  //fp.GetFullSQLConditionDebug( "ws_txavoiriss_filter_debug" );

  return fp.GetFullSQLCondition();
end;

private macro getAddWhereByFinInPrm(
  fltrParm //: TWsFinInstrFltrParm
):String

  var queryWhere:string = " 1=1 ";
  var i:integer = 0;

  if( fltrParm != null )
     if( (fltrParm.FIKinds != null) and (fltrParm.FIKinds.size > 0) )
        queryWhere = queryWhere + " AND fi.t_fi_kind IN ( ";
        i = 0;
        while( i < fltrParm.FIKinds.size )
           if( i != 0 )
              queryWhere = queryWhere + ",";
           end;
           queryWhere = queryWhere + string(fltrParm.FIKinds[i]);
           i = i + 1;
        end;
        queryWhere = queryWhere + " ) ";
     end;

     if( fltrParm.AvoirKinds != null )
        if( (fltrParm.IncSubAvKinds == null) OR (fltrParm.IncSubAvKinds == false) )
           queryWhere = queryWhere + " AND fi.t_avoirkind IN ( ";
           i = 0;
           while( i < fltrParm.AvoirKinds.size )
              if(i != 0 )
                 queryWhere = queryWhere + ",";
              end;
              queryWhere = queryWhere + string(fltrParm.AvoirKinds[i]);
              i = i + 1;
           end;
           queryWhere = queryWhere + " ) ";
        else
           i = 0;
           queryWhere = queryWhere + " AND ( ";
           while( i < fltrParm.AvoirKinds.size )
              if( i != 0 )
                 queryWhere = queryWhere + " OR ";
              end;
              queryWhere = queryWhere + " RSB_FIInstr.FI_AvrKindsEQ ("+ FIKIND_AVOIRISS +", ";
              queryWhere = queryWhere + string(fltrParm.AvoirKinds[i]);
              queryWhere = queryWhere + ", fi.t_avoirkind) > 0 ";
              i = i + 1;
           end;
           queryWhere = queryWhere + " ) ";
        end;
     end;

     if(fltrParm.TaxGroups != null)
        if((fltrParm.NotInTaxGrp == null) OR (fltrParm.NotInTaxGrp == false))
           queryWhere = queryWhere + " AND avoir.t_TaxGroup IN ( ";
        else
           queryWhere = queryWhere + " AND avoir.t_TaxGroup NOT IN ( ";
        end;
        i = 0;
        while(i < fltrParm.TaxGroups.size)
           if(i != 0 )
              queryWhere = queryWhere + ",";
           end;
           queryWhere = queryWhere + string(fltrParm.TaxGroups[i]);
           i = i + 1;
        end;
        queryWhere = queryWhere + " ) ";
     end;

     if(fltrParm.IsClosed == false)
        queryWhere = queryWhere + " AND fi.T_ISCLOSED != 'X' ";
     end;
  end;

  return queryWhere;
end;

private macro getAddWhereByFIFltrPrm(
  fltrParm //: CTxFIFltrPrm
):String

  var queryWhere:string = " 1=1 ";

  if( fltrParm != null )
     queryWhere = getAddWhereByFinInPrm( fltrParm.FinInstrFltrParm ) + " AND " + TxGetAddWhere( fltrParm.Param );
  end;

  return queryWhere;
end;

// получить общее количество записей скроллинга "Список ценных бумаг"
macro TxGetAvoirIssCount(
  FilterItems//:TArray of FilterCondItem // Массив элементов фильтра скроллинга
 ,FIFltrPrm //: CTxFIFltrPrm // Параметры фильтра (задается, если сервис используется в качестве источника данных для листалки виджета FIUniListWidget)
):Integer

  var result:integer = 0;
  var stat:integer = -1;

  var query =
     " SELECT COUNT(fi.t_FIID) C "
     + " FROM davoiriss_dbt avoir, "
          + " dfininstr_dbt fi, "
          + " dparty_dbt party, "
          + " davrkinds_dbt avrkind "
    + " WHERE fi.t_FIID = avoir.t_FIID "
      + " AND party.t_PartyID(+) = fi.t_Issuer "
      + " AND avrkind.t_FI_Kind(+) = fi.t_FI_Kind "
      + " AND avrkind.t_AvoirKind(+) = fi.t_AvoirKind ";

  query = query + " AND " + GetTxAvoirIssAddWhereCondition(FilterItems) + " AND " + getAddWhereByFIFltrPrm(FIFltrPrm);

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if( ds.MoveNext() )
     result = SQL_ConvTypeInteger(ds.C);
  end;

  return result;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

// отбор данных для скроллинга "Список ценных бумаг"
macro TxGetAvoirIssList(
  CodeKind:integer // Вид кода
 ,PageNum:integer // Номер страницы
 ,PageSize:integer // Размер страницы
 ,FilterItems //: TArray of FilterConditionItem  // Значения фильтрации
 ,OrderItems //: TArray of OrderItem  // Параметры сортировки
 ,FIFltrPrm //: CTxFIFltrPrm // Параметры фильтра (задается, если сервис используется в качестве источника данных для листалки виджета FIUniListWidget)
)
  var result = TArray();
  var stat:integer = -1;
  var TxAvoirIssList;

  if( PageNum == null )
    RunError( "Не задан обязательный параметр функции: номер страницы " );
  end;

  if( PageSize == null )
    RunError( "Не задан обязательный параметр функции: размер страницы " );
  end;

  if( CodeKind == null )
    RunError( "Не задан обязательный параметр функции: вид кода " );
  end;

  var query =
    " SELECT "
      + " fi.t_FIID "
     + " ,fi.t_Name "
     + " ,fi.t_Definition "
     + " ,fi.t_IsAdditional "
     + " ,fi.t_IsSys " 
     + " ,fi.t_iso_number AS isonum "
     + " ,avoir.t_TaxGroup "
     + " ,avoir.t_LSIN "
     + " ,avoir.t_ISIN "
     + " ,avrkind.t_Name t_AvoirKindName "
     + " ,avrkind.t_AvoirKind "
     + " ,party.t_PartyID t_Issuer "
     + " ,party.t_ShortName t_IssuerName "
     + " ,RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind ) t_RootAvrKinds "
     + " ,NVL (objcode2.t_Code, CHR (0)) AS t_CodeCFI ";

  if( ( CodeKind == CODE_FI_Code ) or ( CodeKind == 0 ) )
    query = query +
       " ,fi.t_FI_Code ";
  elif( CodeKind == CODE_ISO_Number )
    query = query +
       " ,fi.t_ISO_Number ";
  elif( CodeKind == CODE_Ccy )
    query = query +
       " ,fi.t_Ccy ";
  elif( CodeKind == CODE_CodeInAccount )
    query = query +
       " ,fi.t_CodeInAccount ";
  elif( CodeKind == CODE_LSIN )
    query = query +
       " ,avoir.t_LSIN ";
  elif( CodeKind == CODE_ISIN )
    query = query +
       " ,avoir.t_ISIN ";
  elif( CodeKind > MAX_INNER_SYSTEM_CODEKIND )
    query = query +
       " ,(SELECT NVL (objcode.t_Code, CHR (0)) " +
       "   FROM  dobjcode_dbt objcode " +
       "   WHERE objcode.t_ObjectType(+) = " + String( OBJTYPE_FININSTR ) + " " +
       "     AND objcode.t_CodeKind(+) = " + String( CodeKind ) + " " +
       "     AND objcode.t_ObjectID(+) = fi.t_FIID " +
       "     AND objcode.t_AutoKey(+) = RSB_FIInstr.FI_GetObjCodeOnDate(fi.t_FIID, " +
                                                                     String( OBJTYPE_FININSTR ) + " , " +
                                                                     String( CodeKind ) + " ,  " +
                                                                     " RsbSessionData.curdate "  +
                                                                  " ) ) AS ";
  end;
  query = query + " t_CodeName ";

  if( CheckTaxDepositoryMode() )
    query = query +
       " ,fi.t_IsClosed ";
  else
    query = query +
       " ,avoir.t_SPIsClosed t_IsClosed ";
  end;

  query = query +
      " FROM "
        + " dfininstr_dbt fi "
       + " ,davoiriss_dbt avoir "
       + " ,davrkinds_dbt avrkind "
       + " ,dparty_dbt party "
       + " ,dobjcode_dbt objcode2 " 
    + " WHERE "
        + " avoir.t_FIID = fi.t_FIID "
    + " AND avrkind.t_FI_Kind(+) = fi.t_FI_Kind "
    + " AND avrkind.t_AvoirKind(+) = fi.t_AvoirKind "
    + " AND party.t_PartyID(+) = fi.t_Issuer "
    + " AND objcode2.t_ObjectType(+) = " + String( OBJTYPE_FININSTR ) + " "
    + " AND objcode2.t_CodeKind(+) = " + String( FICK_CFIC ) /*CodeCFI*/ + " "
    + " AND objcode2.t_ObjectID(+) = fi.t_FIID "
    + " AND objcode2.t_AutoKey(+) = RSB_FIInstr.FI_GetObjCodeOnDate(fi.t_FIID, " 
    +                                                               String( OBJTYPE_FININSTR ) + " , " 
    +                                                               String( FICK_CFIC ) /*CodeCFI*/ + " ,  "
    +                                                               " RsbSessionData.curdate " 
    +                                                            " ) ";

  query = query + " AND " + GetTxAvoirIssAddWhereCondition(FilterItems) + " AND " + getAddWhereByFIFltrPrm(FIFltrPrm);

  query = query + " ORDER BY " + SP_GetSortStr( OrderItems, " t_IsClosed, avrkind.t_AvoirKind, t_CodeName " );

  query = SQL_WrapSelect( query, PageNum, PageSize );

  var ds = TRsbDataSet( query );

  while( ds.MoveNext() )
     TxAvoirIssList = CTxAvoirIssList();

     TxAvoirIssList.CodeName      = SQL_ConvTypeStr( ds.CodeName );
     TxAvoirIssList.Name          = SQL_ConvTypeStr( ds.Name );
     TxAvoirIssList.FIID          = SQL_ConvTypeInteger( ds.FIID );
     TxAvoirIssList.AvoirKind     = SQL_ConvTypeStr( ds.AvoirKind );
     TxAvoirIssList.AvoirKindName = SQL_ConvTypeStr( ds.AvoirKindName );
     TxAvoirIssList.TaxGroup      = SQL_ConvTypeInteger(ds.TaxGroup );
     TxAvoirIssList.LSIN          = SQL_ConvTypeStr( ds.LSIN );
     TxAvoirIssList.ISIN          = SQL_ConvTypeStr( ds.ISIN );
     TxAvoirIssList.Issuer        = SQL_ConvTypeInteger(ds.Issuer );
     TxAvoirIssList.IssuerName    = SQL_ConvTypeStr( ds.IssuerName );
     TxAvoirIssList.Definition    = SQL_ConvTypeStr( ds.Definition );
     TxAvoirIssList.IsAdditional  = ( SQL_ConvTypeStr( ds.IsAdditional ) == SET_CHR );
     TxAvoirIssList.RootAvrKinds  = SQL_ConvTypeInteger( ds.RootAvrKinds );
     TxAvoirIssList.IsCouponFI    = FI_IsCouponFI(ds.FIID);
     TxAvoirIssList.IsClosed      = ( SQL_ConvTypeInteger( ds.IsClosed ) == SET_CHR );
     TxAvoirIssList.CodeCFI       = SQL_ConvTypeStr( ds.CodeCFI );
     TxAvoirIssList.IsSys         = ( SQL_ConvTypeStr( ds.IsSys ) == SET_CHR );
     TxAvoirIssList.ISONum        = SQL_ConvTypeStr( ds.ISONum );

     result[result.Size] = TxAvoirIssList;
  end;

  return result;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

private macro ClearParentFIFields(
  AvoirIss//:CTxAvoirIss
)
    AvoirIss.ParentFIISIN = "";
    AvoirIss.ParentFILSIN = "";
    AvoirIss.ParentFIIssuer = null;
    AvoirIss.ParentFIIssuerNRCountry = null;
end;

// Установить данные для депозитарной распики по Fiid ц/б
private macro PumpDepoRecParentFIIssuer(
  AvoirIss//:CTxAvoirIss
)
  var Stat:Integer = -1;

  if( SP_GetFIID(AvoirIss.ParentFI) > ALLFININSTR )
    var query = RSDCommand(
      " SELECT "
      + " fi.t_Issuer, "
      + " fi.t_FI_Code, "
      + " fi.t_Name, "
      + " pt.t_NRCountry, "
      + " avr.t_ISIN, "
      + " avr.t_LSIN "
    + " FROM "
      + " DFININSTR_DBT fi, "
      + " DPARTY_DBT pt, "
      + " DAVOIRISS_DBT avr "
    + " WHERE "
      + " fi.t_FIID = ? "
      + " AND pt.T_PartyID(+) = fi.t_Issuer "
      + " AND avr.t_FIID = fi.t_FIID " );

    query.NullConversion = true;
    query.addParam( "", RSDBP_IN, AvoirIss.ParentFI.Fiid );
    query.execute();

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

    if( ds.MoveNext() )
       AvoirIss.ParentFILSIN = SQL_ConvTypeStr(ds.LSIN);
       AvoirIss.ParentFIISIN = SQL_ConvTypeStr(ds.ISIN);
       AvoirIss.ParentFIIssuer = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Issuer));
       AvoirIss.ParentFIIssuerNRCountry = CreateCountryFromAppServ(SQL_ConvTypeStr(ds.NRCountry));
    else
      ClearParentFIFields( AvoirIss );
    end;
  else
    ClearParentFIFields( AvoirIss );
  end;

OnError( Err )
  TxAvoirIssRunError( Err, Stat );
end;

macro TxGetAvoirIss( FIID:integer ):CTxAvoirIss
  var stat:integer = -1;
  var query:String = "";
  var TxAvoirIss = CTxAvoirIss();

  InitError();

  if( (FIID == null) or (FIID <= 0) )
     RunError("Не задан обязательный параметр функции: ID финансового инструмента");
  end;

  query =
    " SELECT "
    + " fi.t_FI_Code "
   + " ,fi.t_Name "
   + " ,fi.t_Definition "
   + " ,fi.t_CodeInAccount "
   + " ,fi.t_Issuer "
   + " ,fi.t_Issued "
   + " ,fi.t_Settlement_Code "
   + " ,fi.t_FaceValueFI "
   + " ,fi.t_FaceValue "
   + " ,fi.t_DrawingDate "
   + " ,fi.t_ExpiryDate "
   + " ,fi.t_Scale "
   + " ,fi.t_Point "
   + " ,fi.t_IsSys "
   + " ,fi.t_IsAdditional "
   + " ,fi.t_MainFIID "
   + " ,fi.t_IsGeneralized "
   + " ,fi.t_GeneralizedFIID "
   + " ,fi.t_Version FinInstrVersion "
   + " ,avoir.t_ISIN "
   + " ,avoir.t_LSIN "
   + " ,avoir.t_Qty "
   + " ,avoir.t_IncomeRate "
   + " ,avoir.t_IncomeVolume "
   + " ,avoir.t_NKDRound_Kind "
   + " ,avoir.t_NKDBase_Kind "
   + " ,avoir.t_InCirculationDate "
   + " ,avoir.t_Issue "
   + " ,avoir.t_Series "
   + " ,avoir.t_IsVoting "
   + " ,avoir.t_Tranche "
   + " ,avoir.t_IncomeType "
   + " ,avoir.t_TaxGroup "
   + " ,avoir.t_ListDate "
   + " ,avoir.t_BegPlacementDate "
   + " ,avoir.t_EndPlacementDate "
   + " ,avoir.t_NumBaseFI "
   + " ,avoir.t_Version AvoirIssVersion "
   + " ,avoir.t_OwnerAgent "
   + " ,avoir.T_INDEXNOM "    
   + " ,avrkind.t_AvoirKind "
   + " ,avrkind.t_IsEmissive "
   + " ,avrkind.t_IsIndividual "
   + " ,avrkind.t_Root "
   + " ,avoirsrv.t_ServiceStartOper "
   + " ,avoirsrv.t_ServiceStartDate "
   + " ,avoirsrv.t_ServiceState "
   + " ,avoirsrv.t_ServiceStateDate "
   + " ,avoirsrv.t_ServiceStateOper "
   + " ,( "
    + " SELECT "
      + " person.t_Name "
    + " FROM "
      + " dperson_dbt person "
    + " WHERE "
      + " person.t_oper = avoirsrv.t_ServiceStateOper "
   + " ) ServiceNameStateOper "
   + " ,( "
    + " SELECT "
      + " dep.t_Name "
    + " FROM "
      + " ddp_dep_dbt dep "
    + " WHERE "
      + " dep.t_Code = avoirsrv.t_Department "
   + " ) DepartmentName "
   + " ,( "
    + " SELECT "
      + " person.t_Name "
    + " FROM "
      + " dperson_dbt person "
    + " WHERE "
      + " person.t_oper = avoirsrv.t_ServiceStartOper "
   + " ) ServiceNameStartOper "
   + " ,RSI_RSB_FIINSTR.FI_IsMainAvr( fi.t_FIID ) IsMainAvr "
   + " ,RSI_RSB_FIINSTR.FI_IsCouponAvoiriss( fi.t_FIID ) IsCoupon "
   + " ,RSI_RSB_FIINSTR.FI_HasCouponSQL( fi.t_FIID ) HasCoupon "
   + " ,RSI_RSB_FIINSTR.FI_HasPartialDischargeSQL( fi.t_FIID ) HasPartialDischarge "
   + " ,fi.T_PARENTFI ";

  if( CheckTaxDepositoryMode() )
    query = query +
     " ,avoir.t_SPIsClosed IsClosed ";
  else
    query = query +
     " ,fi.t_IsClosed ";
  end;

  query = query +
   " FROM "
   + " dfininstr_dbt fi "
  + " ,davoiriss_dbt avoir "
  + " ,davrkinds_dbt avrkind "
  + " ,davoirsrv_dbt avoirsrv "
 + " WHERE "
     + " fi.t_FIID = " + String( FIID ) + " "
 + " AND avoir.t_FIID = fi.t_FIID "
 + " AND avrkind.t_FI_Kind = fi.t_FI_Kind "
 + " AND avrkind.t_AvoirKind = fi.t_AvoirKind "
 + " AND avoirsrv.t_FIID(+) = fi.t_FIID "
 + " AND avoirsrv.t_Department(+) = " + String( {OperDprt} ) + " ";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if( ds.MoveNext() )

     var AvrKind = TArray();
     AvrKind.value(AvrKind.Size) = SQL_ConvTypeInteger(ds.Root);
     if( SQL_ConvTypeInteger(ds.Root) != SQL_ConvTypeInteger(ds.AvoirKind) )
        AvrKind.value(AvrKind.Size) = SQL_ConvTypeInteger(ds.AvoirKind);
     end;
     var AvrKindObj = TxGetAvrKindsListById(AvrKind);
     if( SQL_ConvTypeInteger(ds.Root) != SQL_ConvTypeInteger(ds.AvoirKind) )
        if( SQL_ConvTypeInteger(ds.Root) == AvrKindObj[0].AvoirKind )
           TxAvoirIss.AvoirKindObj    = AvrKindObj[0];
           TxAvoirIss.AvoirSubKindObj = AvrKindObj[1];
        else
           TxAvoirIss.AvoirKindObj    = AvrKindObj[1];
           TxAvoirIss.AvoirSubKindObj = AvrKindObj[0];
        end;
     else
        TxAvoirIss.AvoirKindObj      = AvrKindObj[0];
        TxAvoirIss.AvoirSubKindObj   = AvrKindObj[0];
     end;

     TxAvoirIss.FIID                 = FIID;
     TxAvoirIss.AvoirKind            = SQL_ConvTypeInteger(ds.Root);
     TxAvoirIss.AvoirSubKind         = SQL_ConvTypeInteger(ds.AvoirKind);
     TxAvoirIss.FI_Code              = SQL_ConvTypeStr(ds.FI_Code);
     if( TxAvoirIss.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT )
       TxAvoirIss.ParentFI = GetTWsFinInstrByID(ds.ParentFI);
       PumpDepoRecParentFIIssuer( TxAvoirIss );
     end;     
     TxAvoirIss.CodeInAccount        = SQL_ConvTypeStr(ds.CodeInAccount);
     TxAvoirIss.Name                 = SQL_ConvTypeStr(ds.Name);
     TxAvoirIss.LSIN                 = SQL_ConvTypeStr(ds.LSIN);
     TxAvoirIss.ISIN                 = SQL_ConvTypeStr(ds.ISIN);
     TxAvoirIss.Issuer               = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Issuer));
     TxAvoirIss.OwnerAgent           = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.OwnerAgent));
     TxAvoirIss.TaxGroup             = CreateLLValueFromAppServ(2903, SQL_ConvTypeInteger(ds.TaxGroup));
     TxAvoirIss.TaxGroupList         = GetListLlvalues(2903);
     TxAvoirIss.FaceValue            = SQL_ConvTypeSum(ds.FaceValue);
     TxAvoirIss.FaceValueFI          = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.FaceValueFI));
     TxAvoirIss.CurrentFaceValue     = FIGetCurrentFaceValue(TxAvoirIss.FaceValue, TxAvoirIss.AvoirSubKind, FIID, SQL_ConvTypeInteger(ds.Point), (SQL_ConvTypeStr(ds.IndexNom) == SET_CHR));
     TxAvoirIss.FV_Point             = SQL_ConvTypeInteger(ds.Point) + DEFAULT_FACEVALUE_POINT;
     TxAvoirIss.Scale                = SQL_ConvTypeInteger(ds.Scale);
     TxAvoirIss.IncomeType           = CreateNameAlgFromAppServ(3445, SQL_ConvTypeInteger(ds.IncomeType));
     TxAvoirIss.IncomeRate           = SQL_ConvTypeSum(ds.IncomeRate);
     TxAvoirIss.IncomeVolume         = SQL_ConvTypeSum(ds.IncomeVolume);
     TxAvoirIss.NKDBase_Kind         = CreateNameAlgFromAppServ(3108, SQL_ConvTypeInteger(ds.NKDBase_Kind));
     TxAvoirIss.NKDRoundOne          = (SQL_ConvTypeInteger(ds.NKDRound_Kind) == AVOIRISSNKDROUND_COUPON);
     TxAvoirIss.NKDRoundPaym         = (SQL_ConvTypeInteger(ds.NKDRound_Kind) == AVOIRISSNKDROUND_SUM);
     TxAvoirIss.Certificated         = (SQL_ConvTypeInteger(ds.Settlement_Code) == 1);
     TxAvoirIss.Non_Certificated     = (SQL_ConvTypeInteger(ds.Settlement_Code) == 0);
     TxAvoirIss.Issue                = SQL_ConvTypeStr(ds.Issue);
     TxAvoirIss.Tranche              = SQL_ConvTypeStr(ds.Tranche);
     TxAvoirIss.Qty                  = SQL_ConvTypeSum(ds.Qty);
     TxAvoirIss.Series               = SQL_ConvTypeStr(ds.Series);
     TxAvoirIss.IsQuoted             = FI_IsQuoted(FIID);
     TxAvoirIss.IsVoting             = (SQL_ConvTypeStr(ds.IsVoting) == SET_CHR);
     TxAvoirIss.IsGeneralized        = (SQL_ConvTypeStr(ds.IsGeneralized) == SET_CHR);
     TxAvoirIss.GeneralizedFIID      = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.GeneralizedFIID));
     TxAvoirIss.IsSys                = (SQL_ConvTypeStr(ds.IsSys) == SET_CHR);
     TxAvoirIss.IsAdditional         = (SQL_ConvTypeStr(ds.IsAdditional) == SET_CHR);
     TxAvoirIss.MainFIID             = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.MainFIID));
     TxAvoirIss.Issued               = SQL_ConvTypeDate(ds.Issued);
     TxAvoirIss.InCirculationDate    = SQL_ConvTypeDate(ds.InCirculationDate);
     TxAvoirIss.DrawingDate          = SQL_ConvTypeDate(ds.DrawingDate);
     TxAvoirIss.ExpiryDate           = SQL_ConvTypeDate(ds.ExpiryDate);
     TxAvoirIss.BegPlacementDate     = SQL_ConvTypeDate(ds.BegPlacementDate);
     TxAvoirIss.EndPlacementDate     = SQL_ConvTypeDate(ds.EndPlacementDate);
     TxAvoirIss.ListDate             = SQL_ConvTypeDate(ds.ListDate);
     TxAvoirIss.ServiceState         = CreateNameAlgFromAppServ(3217, SQL_ConvTypeInteger(ds.ServiceState));
     TxAvoirIss.ServiceStateDate     = SQL_ConvTypeDate(ds.ServiceStateDate);
     TxAvoirIss.ServiceStateOper     = SQL_ConvTypeInteger(ds.ServiceStateOper);
     TxAvoirIss.ServiceNameStateOper = SQL_ConvTypeStr(ds.ServiceNameStateOper);
     TxAvoirIss.DepartmentName       = SQL_ConvTypeStr(ds.DepartmentName);
     TxAvoirIss.ServiceStartDate     = SQL_ConvTypeDate(ds.ServiceStartDate);
     TxAvoirIss.ServiceStartOper     = SQL_ConvTypeInteger(ds.ServiceStartOper);
     TxAvoirIss.ServiceNameStartOper = SQL_ConvTypeStr(ds.ServiceNameStartOper);
     TxAvoirIss.Definition           = SQL_ConvTypeStr(ds.Definition);
     TxAvoirIss.FinInstrVersion      = SQL_ConvTypeInteger(ds.FinInstrVersion);
     TxAvoirIss.AvoirIssVersion      = SQL_ConvTypeInteger(ds.AvoirIssVersion);
     TxAvoirIss.IsMainAvr            = (SQL_ConvTypeInteger(ds.IsMainAvr) > 0);
     TxAvoirIss.IsIndividual         = (SQL_ConvTypeStr(ds.IsIndividual) == SET_CHR);
     TxAvoirIss.IsEmissive           = (SQL_ConvTypeStr(ds.IsEmissive) == SET_CHR);
     TxAvoirIss.IsCoupon             = (SQL_ConvTypeInteger(ds.IsCoupon) > 0);
     TxAvoirIss.HasCoupon            = (SQL_ConvTypeInteger(ds.HasCoupon) > 0);
     TxAvoirIss.HasPartialDischarge  = (SQL_ConvTypeInteger(ds.HasPartialDischarge) > 0);
     TxAvoirIss.NumBaseFI            = Double(ds.NumBaseFI);
     TxAvoirIss.IsClosed             = (SQL_ConvTypeStr(ds.IsClosed) == SET_CHR);
     TxAvoirIss.IsIndexNominal       = (SQL_ConvTypeStr(ds.IndexNom) == SET_CHR);
  else
     RunError("Не найден финансовый инструмент с FIID = " + string(FIID));
  end;

  return TxAvoirIss;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

// Получение параметров заданных ценных бумаг
macro TxGetAvoirIssListByFIID(
  FiidList//:TArray of Integer
)
  InitError();

  var result = TArray();
  var stat:integer = -1;
  var i:integer = 0;

  while( i < FiidList.size )
     result[i] = TxGetAvoirIss(FiidList[i]);
     i = i + 1;
  end;

  return result;
OnError( err )
  TxAvoirIssRunError(err, stat);
end;

private macro SetFinInstr_ByCTxAvoirIss( FinInstrRec, AvoirIss )
  FinInstrRec.FI_Kind         = FIKIND_AVOIRISS;
  FinInstrRec.AvoirKind       = IIF(AvoirIss.AvoirSubKind > FIKIND_ALLAVOIRISS, AvoirIss.AvoirSubKind, AvoirIss.AvoirKind);
  FinInstrRec.FI_Code         = AvoirIss.FI_Code;
  FinInstrRec.CodeInAccount   = AvoirIss.CodeInAccount;
  FinInstrRec.Name            = AvoirIss.Name;
  FinInstrRec.Issuer          = SP_GetPartyID(AvoirIss.Issuer);
  FinInstrRec.FaceValue       = AvoirIss.FaceValue;
  FinInstrRec.FaceValueFI     = SP_GetFIID(AvoirIss.FaceValueFI);
  FinInstrRec.Point           = (AvoirIss.FV_Point - DEFAULT_FACEVALUE_POINT);
  FinInstrRec.Scale           = AvoirIss.Scale;
  FinInstrRec.Settlement_Code = IIF(AvoirIss.Certificated, 1, 0);
  FinInstrRec.GeneralizedFIID = SP_GetFIID(AvoirIss.GeneralizedFIID);
  FinInstrRec.MainFIID        = SP_GetFIID(AvoirIss.MainFIID);
  FinInstrRec.Issued          = WS_ConvTypeDate(AvoirIss.Issued);
  FinInstrRec.DrawingDate     = WS_ConvTypeDate(AvoirIss.DrawingDate);
  FinInstrRec.ExpiryDate      = WS_ConvTypeDate(AvoirIss.ExpiryDate);
  FinInstrRec.Definition      = AvoirIss.Definition;
  FinInstrRec.FIID            = AvoirIss.FIID;
  FinInstrRec.IsGeneralized   = IIF(AvoirIss.IsGeneralized, "X", "");
  FinInstrRec.IsSys           = IIF(AvoirIss.IsSys, "X", "");
  FinInstrRec.IsAdditional    = IIF(AvoirIss.IsAdditional, "X", "");
  FinInstrRec.Version         = AvoirIss.FinInstrVersion;
  if( AvoirIss.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT )
    FinInstrRec.ParentFI      = SP_GetFIID(AvoirIss.ParentFI);
  end;
end;

private macro SetAvoirIss_ByCTxAvoirIss( AvoirIssRec, AvoirIss )
  AvoirIssRec.LSIN              = AvoirIss.LSIN;
  AvoirIssRec.ISIN              = AvoirIss.ISIN;
  if( (AvoirIss.TaxGroup != NULL) and (AvoirIss.TaxGroup.Element != NULL) )
     AvoirIssRec.TaxGroup = AvoirIss.TaxGroup.Element;
  else
     AvoirIssRec.TaxGroup = 0;
  end;
  AvoirIssRec.IncomeType        = SP_GetNameAlgNumberAlg(AvoirIss.IncomeType);
  AvoirIssRec.IncomeRate        = AvoirIss.IncomeRate;
  AvoirIssRec.IncomeVolume      = AvoirIss.IncomeVolume;
  AvoirIssRec.NKDBase_Kind      = SP_GetNameAlgNumberAlg(AvoirIss.NKDBase_Kind);
  AvoirIssRec.NKDRound_Kind     = IIF(AvoirIss.NKDRoundOne, AVOIRISSNKDROUND_COUPON, AVOIRISSNKDROUND_SUM);
  AvoirIssRec.Issue             = AvoirIss.Issue;
  AvoirIssRec.Tranche           = AvoirIss.Tranche;
  AvoirIssRec.Qty               = AvoirIss.Qty;
  AvoirIssRec.Series            = AvoirIss.Series;
  AvoirIssRec.IsVoting          = IIF(AvoirIss.IsVoting, "X", "");
  AvoirIssRec.InCirculationDate = WS_ConvTypeDate(AvoirIss.InCirculationDate);
  AvoirIssRec.BegPlacementDate  = WS_ConvTypeDate(AvoirIss.BegPlacementDate);
  AvoirIssRec.EndPlacementDate  = WS_ConvTypeDate(AvoirIss.EndPlacementDate);
  AvoirIssRec.ListDate          = WS_ConvTypeDate(AvoirIss.ListDate);
  AvoirIssRec.Version           = AvoirIss.AvoirIssVersion;
  AvoirIssRec.OwnerAgent        = SP_GetPartyID(AvoirIss.OwnerAgent);
  if( AvoirIss.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT )
    AvoirIssRec.NumBaseFI       = AvoirIss.NumBaseFI;
  end;
  AvoirIssRec.IndexNom          = IIF(AvoirIss.IsIndexNominal, "X", "");
end;

private macro SetFinInstr_ByCTxAvrInvst( FinInstrRec, AvrInvst )
  FinInstrRec.GeneralizedFIID = ALLFININSTR;
  FinInstrRec.MainFIID        = ALLFININSTR;
  FinInstrRec.FI_Kind       = FIKIND_AVOIRISS;
  FinInstrRec.AvoirKind     = AvrInvst.AvoirKind;
  FinInstrRec.FIID          = AvrInvst.FIID;
  FinInstrRec.FI_Code       = AvrInvst.FI_Code;
  FinInstrRec.CodeInAccount = AvrInvst.CodeInAccount;
  FinInstrRec.Name          = AvrInvst.FI_Name;
  FinInstrRec.Issuer        = SP_GetPartyID(AvrInvst.Issuer);
  FinInstrRec.SumPrecision  = AvrInvst.SumPrecision;
  FinInstrRec.Issued        = AvrInvst.Issued;
  FinInstrRec.DrawingDate   = AvrInvst.DrawingDate;
  FinInstrRec.ExpiryDate    = AvrInvst.ExpiryDate;
  FinInstrRec.Definition    = AvrInvst.Definition;
  FinInstrRec.FaceValueFI   = SP_GetFIID(AvrInvst.IncomeFI);
  FinInstrRec.Version       = AvrInvst.FinInstrVersion;
end;

private macro SetAvoirIss_ByCTxAvrInvst( AvoirIssRec, AvrInvst )
  AvoirIssRec.LSIN              = AvrInvst.LSIN;
  AvoirIssRec.ISIN              = AvrInvst.ISIN;
  if( (AvrInvst.TaxGroup != NULL) and (AvrInvst.TaxGroup.Element != NULL) )
     AvoirIssRec.TaxGroup = AvrInvst.TaxGroup.Element;
  else
     AvoirIssRec.TaxGroup = 0;
  end;
  AvoirIssRec.IsVoting          = IIF(AvrInvst.IsVoting, "X", "");
  AvoirIssRec.Qty               = AvrInvst.Qty;
  AvoirIssRec.Version           = AvrInvst.AvoirIssVersion;
end;

private macro SetAvrInvst_ByCTxAvrInvst( AvrInvstRec, AvrInvst )
  AvrInvstRec.HasIncome           = IIF(AvrInvst.HasIncome, "X", "");
  AvrInvstRec.Name                = AvrInvst.Name;
  if(AvrInvst.AvoirKind == AVOIRISSKIND_HYPOTHECARY_CERT)
    AvrInvstRec.Type= -1;
  else
    if(AvrInvst.IT_Interval)
       AvrInvstRec.Type = ARVINVST_FOND_INTERVAL;
    elif(AvrInvst.IT_Open)
       AvrInvstRec.Type = ARVINVST_FOND_OPENED;
    elif(AvrInvst.IT_Closed)
       AvrInvstRec.Type = ARVINVST_FOND_CLOSED;
    elif(AvrInvst.IT_Market)
       AvrInvstRec.Type = ARVINVST_FOND_MARKET;
    end;
  end;
  if( (AvrInvst.Category != NULL) and (AvrInvst.Category.Element != NULL) )
     AvrInvstRec.Category = AvrInvst.Category.Element;
  else
     AvrInvstRec.Category = 0;
  end;
  AvrInvstRec.Depositary           = SP_GetPartyID(AvrInvst.Depositary);
  AvrInvstRec.Registrar            = SP_GetPartyID(AvrInvst.Registrar);
  AvrInvstRec.Auditor              = SP_GetPartyID(AvrInvst.Auditor);
  AvrInvstRec.Estimator            = SP_GetPartyID(AvrInvst.Estimator);
  AvrInvstRec.Agent1               = SP_GetPartyID(AvrInvst.Agent1);
  AvrInvstRec.Agent2               = SP_GetPartyID(AvrInvst.Agent2);
  AvrInvstRec.RulesRegXid          = AvrInvst.RulesRegXid;
  AvrInvstRec.RulesRegAgency       = SP_GetPartyID(AvrInvst.RulesRegAgency);
  AvrInvstRec.RulesChangeXid       = AvrInvst.RulesChangeXid;
  AvrInvstRec.RulesChangeDate      = AvrInvst.RulesChangeDate;
  AvrInvstRec.RulesChangeAgency    = SP_GetPartyID(AvrInvst.RulesChangeAgency);
  AvrInvstRec.ContractDuration     = AvrInvst.ContractDuration;
  AvrInvstRec.ContractEnd          = AvrInvst.ContractEnd;
  AvrInvstRec.ContractDurationUnit = SP_GetNameAlgNumberAlg(AvrInvst.DurationType);
  AvrInvstRec.FormPeriodStart      = AvrInvst.FormPeriodStart;
  AvrInvstRec.FormPeriodEnd        = AvrInvst.FormPeriodEnd;
  AvrInvstRec.MinValue             = AvrInvst.MinValue;
  AvrInvstRec.MinValueFIID         = SP_GetFIID(AvrInvst.MinValueFIID);
  AvrInvstRec.FormValue            = AvrInvst.FormValue;
  AvrInvstRec.FormValueFIID        = SP_GetFIID(AvrInvst.FormValueFIID);
  AvrInvstRec.FormDate             = AvrInvst.FormDate;
  AvrInvstRec.PeriodStart1         = AvrInvst.Periods[0].PeriodStart;
  AvrInvstRec.PeriodEnd1           = AvrInvst.Periods[0].PeriodEnd;
  AvrInvstRec.PeriodStart2         = AvrInvst.Periods[1].PeriodStart;
  AvrInvstRec.PeriodEnd2           = AvrInvst.Periods[1].PeriodEnd;
  AvrInvstRec.PeriodStart3         = AvrInvst.Periods[2].PeriodStart;
  AvrInvstRec.PeriodEnd3           = AvrInvst.Periods[2].PeriodEnd;
  AvrInvstRec.PeriodStart4         = AvrInvst.Periods[3].PeriodStart;
  AvrInvstRec.PeriodEnd4           = AvrInvst.Periods[3].PeriodEnd;
  AvrInvstRec.PeriodStart5         = AvrInvst.Periods[4].PeriodStart;
  AvrInvstRec.PeriodEnd5           = AvrInvst.Periods[4].PeriodEnd;
  AvrInvstRec.IssuerIncome         = AvrInvst.IssuerIncome;
  AvrInvstRec.DepositaryIncome     = AvrInvst.DepositaryIncome;
  AvrInvstRec.RegistrarIncome      = AvrInvst.RegistrarIncome;
  AvrInvstRec.AuditorIncome        = AvrInvst.AuditorIncome;
  AvrInvstRec.EstimatoIncome       = AvrInvst.EstimatoIncome;
  AvrInvstRec.MaxOutlay            = AvrInvst.MaxOutlay;
  AvrInvstRec.Version              = AvrInvst.InvstVersion;
end;

private macro SetAvoirPay( FiWarntsRec, AvoirPay )
  FiWarntsRec.FIID           = AvoirPay.FIID;
  FiWarntsRec.IsPartial      = IIF(AvoirPay.IsPartial, "X", "");
  FiWarntsRec.Number         = AvoirPay.Number;
  FiWarntsRec.DrawingDate    = WS_ConvTypeDate(AvoirPay.DrawingDate);
  FiWarntsRec.IncomeFI       = SP_GetFIID(AvoirPay.IncomeFI);
  FiWarntsRec.SPIsClosed     = IIF(AvoirPay.IsClosed, "X", "");
  FiWarntsRec.Name           = AvoirPay.Name;
  FiWarntsRec.FirstDate      = WS_ConvTypeDate(AvoirPay.FirstDate);
  FiWarntsRec.ListDate       = WS_ConvTypeDate(AvoirPay.ListDate);
  FiWarntsRec.IncomePoint    = AvoirPay.IncomePoint;
  FiWarntsRec.IncomeScale    = AvoirPay.IncomeScale;
  FiWarntsRec.RelativeIncome = IIF(AvoirPay.RelativeIncome, "X", "");
  FiWarntsRec.Definition     = AvoirPay.Definition;
  FiWarntsRec.PayPeriod      = AvoirPay.PayPeriod;

  if( FiWarntsRec.IsPartial )
     FiWarntsRec.IncomeVolume = string(AvoirPay.IncomeVolume);
     FiWarntsRec.IncomeRate   = AvoirPay.IncomeRate;
  else
     if( AvoirPay.RelativeIncome )
        FiWarntsRec.IncomeVolume = "0";
        FiWarntsRec.IncomeRate   = AvoirPay.IncomeRate;
     else
        FiWarntsRec.IncomeVolume = string(AvoirPay.IncomeVolume);
        FiWarntsRec.IncomeRate   = 0;
     end;
  end;
end;

private macro SetAvoirFloatCoupon( FiWarntsRec, AvoirPay )
  FiWarntsRec.FIID           = AvoirPay.FIID;
  FiWarntsRec.IncomeCode     = AvoirPay.IncomeCode;
  FiWarntsRec.ChargeDate     = WS_ConvTypeDate(AvoirPay.ChargeDate);
  FiWarntsRec.FactDate       = WS_ConvTypeDate(AvoirPay.FactDate);
  FiWarntsRec.IncomeVolume   = string(AvoirPay.IncomeVolume);
  FiWarntsRec.IncomeFI       = SP_GetFIID(AvoirPay.IncomeFI);
  FiWarntsRec.Definition   = AvoirPay.Definition;
end;

private macro SetFiVlHist( FiVlHistRec, VlHist, IsEditBegDate:bool )
  FiVlHistRec.FIID    = VlHist.FIID;
  FiVlHistRec.EndDate = IIF(IsEditBegDate, VlHist.BegDate, VlHist.EndDate);
  FiVlHistRec.ValKind = VlHist.ValKind;
  FiVlHistRec.Value   = VlHist.Value;
end;

// Определение ГНУ (группа налогового учета) по данным анкеты ц/б
macro GetDefaultNalogGroup( AvoirIss,  // CTxAvoirIss(Параметры анкеты ц/б)
                            AvrInvst   // CTxAvrInvst(Параметры анкеты пая)
                          ):TWsLlvalues
  var stat:integer = -1;

  var FinInstrRec = Tbfile("fininstr", "R", 0);
  var AvoirIssRec = Tbfile("avoiriss", "R", 0);
  var AvrInvstRec = Tbfile("avrinvst", "R", 0);

  FinInstrRec.Clear();
  AvoirIssRec.Clear();
  AvrInvstRec.Clear();

  if( (AvoirIss == NULL) and (AvrInvst != NULL) )
     SetFinInstr_ByCTxAvrInvst(FinInstrRec.rec, AvrInvst);
     SetAvoirIss_ByCTxAvrInvst(AvoirIssRec.rec, AvrInvst);
     SetAvrInvst_ByCTxAvrInvst(AvrInvstRec.rec, AvrInvst)
  elif( AvoirIss != NULL )
     SetFinInstr_ByCTxAvoirIss(FinInstrRec.rec, AvoirIss);
     SetAvoirIss_ByCTxAvoirIss(AvoirIssRec.rec, AvoirIss);
  end;

  return CreateLLValueFromAppServ(2903, ОпределитьГНУ(FinInstrRec, AvoirIssRec, AvrInvstRec));

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

macro TxInitAvoirIss( AvoirKind:integer, SourceFIID:integer ):CTxAvoirIss
  var stat:integer = -1;
  var TxAvoirIss = CTxAvoirIss();

  InitError();

  if( ( ValType(SourceFIID) == V_INTEGER) and (SourceFIID > FIKIND_ALLAVOIRISS) )
    TxAvoirIss = TxGetAvoirIss( SourceFIID );

    TxAvoirIss.FIID                 = ALLFININSTR;
    TxAvoirIss.FI_Code              = "";
    TxAvoirIss.CodeInAccount        = "";
    TxAvoirIss.ISIN                 = "";
    TxAvoirIss.Issue                = "";
    TxAvoirIss.Tranche              = "";
    TxAvoirIss.Qty                  = 0;
    TxAvoirIss.Series               = "";
    TxAvoirIss.Issued               = ZeroDate;
    TxAvoirIss.InCirculationDate    = ZeroDate;
    TxAvoirIss.DrawingDate          = ZeroDate;
    TxAvoirIss.ExpiryDate           = ZeroDate;
    TxAvoirIss.BegPlacementDate     = ZeroDate;
    TxAvoirIss.EndPlacementDate     = ZeroDate;
    TxAvoirIss.ListDate             = ZeroDate;
    TxAvoirIss.ServiceState         = null;
    TxAvoirIss.ServiceStateDate     = ZeroDate;
    TxAvoirIss.ServiceStateOper     = 0;
    TxAvoirIss.ServiceNameStateOper = "";
    TxAvoirIss.DepartmentName       = "";
    TxAvoirIss.ServiceStartDate     = ZeroDate;
    TxAvoirIss.ServiceStartOper     = 0;
    TxAvoirIss.ServiceNameStartOper = "";
    TxAvoirIss.Definition           = "";
    TxAvoirIss.FinInstrVersion      = 0;
    TxAvoirIss.AvoirIssVersion      = 0;
    TxAvoirIss.IsMainAvr            = false;
    TxAvoirIss.IsIndividual         = TxAvoirIss.AvoirSubKindObj.IsIndividual;
    TxAvoirIss.IsEmissive           = TxAvoirIss.AvoirSubKindObj.IsEmissive;

    TxAvoirIss.IsAdditional         = ( not TxAvoirIss.IsAdditional );
    if( TxAvoirIss.IsAdditional )
       TxAvoirIss.MainFIID          = GetTWsFinInstrByID(SourceFIID);
    end;
  else
    if( (AvoirKind == null) or (AvoirKind <= FIKIND_ALLAVOIRISS) )
       RunError("Не задан обязательный параметр функции: вид ценной бумаги");
    end;

    var AvrKind = TArray();
    AvrKind.value(0) = AvoirKind;

    var AvrKindObj = TxGetAvrKindsListById(AvrKind);
    TxAvoirIss.AvoirSubKindObj = AvrKindObj[0];

    if( AvoirKind != TxAvoirIss.AvoirSubKindObj.RootAvrKinds )
       AvrKind.value(0) = TxAvoirIss.AvoirSubKindObj.RootAvrKinds;
       AvrKindObj = TxGetAvrKindsListById(AvrKind);
    end;
    TxAvoirIss.AvoirKindObj = AvrKindObj[0];

    TxAvoirIss.FIID                 = ALLFININSTR;
    TxAvoirIss.AvoirKind            = TxAvoirIss.AvoirKindObj.AvoirKind;
    TxAvoirIss.AvoirSubKind         = TxAvoirIss.AvoirSubKindObj.AvoirKind;
    TxAvoirIss.FI_Code              = "";
    TxAvoirIss.CodeInAccount        = "";
    TxAvoirIss.Name                 = "";
    TxAvoirIss.LSIN                 = "";
    TxAvoirIss.ISIN                 = "";
    TxAvoirIss.Issuer               = null;
    TxAvoirIss.OwnerAgent           = null;
    TxAvoirIss.FaceValue            = 0;
    TxAvoirIss.FaceValueFI          = null;
    TxAvoirIss.CurrentFaceValue     = 0;
    if( TxAvoirIss.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT )
       TxAvoirIss.FV_Point = 0;
    else
       TxAvoirIss.FV_Point = DEFAULT_FACEVALUE_POINT;
    end;
    TxAvoirIss.Scale                = 1;
    TxAvoirIss.IncomeType           = null;
    TxAvoirIss.IncomeRate           = 0;
    TxAvoirIss.IncomeVolume         = 0;
    TxAvoirIss.NKDBase_Kind         = CreateNameAlgFromAppServ(3108, 0);
    TxAvoirIss.NKDRoundOne          = true;
    TxAvoirIss.NKDRoundPaym         = false;
    TxAvoirIss.Certificated         = false;
    TxAvoirIss.Non_Certificated     = true;
    TxAvoirIss.Issue                = "";
    TxAvoirIss.Tranche              = "";
    TxAvoirIss.Qty                  = 0;
    TxAvoirIss.Series               = "";
    TxAvoirIss.IsQuoted             = true;
    TxAvoirIss.IsVoting             = false;
    TxAvoirIss.IsGeneralized        = false;
    TxAvoirIss.GeneralizedFIID      = null;
    TxAvoirIss.IsSys                = false;
    TxAvoirIss.IsAdditional         = false;
    TxAvoirIss.MainFIID             = null;
    TxAvoirIss.Issued               = ZeroDate;
    TxAvoirIss.InCirculationDate    = ZeroDate;
    TxAvoirIss.DrawingDate          = ZeroDate;
    TxAvoirIss.ExpiryDate           = ZeroDate;
    TxAvoirIss.BegPlacementDate     = ZeroDate;
    TxAvoirIss.EndPlacementDate     = ZeroDate;
    TxAvoirIss.ListDate             = ZeroDate;
    TxAvoirIss.ServiceState         = null;
    TxAvoirIss.ServiceStateDate     = ZeroDate;
    TxAvoirIss.ServiceStateOper     = 0;
    TxAvoirIss.ServiceNameStateOper = "";
    TxAvoirIss.DepartmentName       = "";
    TxAvoirIss.ServiceStartDate     = ZeroDate;
    TxAvoirIss.ServiceStartOper     = 0;
    TxAvoirIss.ServiceNameStartOper = "";
    TxAvoirIss.Definition           = "";
    TxAvoirIss.FinInstrVersion      = 0;
    TxAvoirIss.AvoirIssVersion      = 0;
    TxAvoirIss.IsMainAvr            = false;
    TxAvoirIss.IsIndividual         = TxAvoirIss.AvoirSubKindObj.IsIndividual;
    TxAvoirIss.IsEmissive           = TxAvoirIss.AvoirSubKindObj.IsEmissive;
    TxAvoirIss.IsIndexNominal       = false;
    TxAvoirIss.NumBaseFI            = 0.0;
    TxAvoirIss.TaxGroupList         = GetListLlvalues(2903);
    TxAvoirIss.TaxGroup             = GetDefaultNalogGroup(TxAvoirIss, NULL);
  end;

  return TxAvoirIss;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

// отбор данных для заполнения вкладок "Купоны", "Ч/погашения", "Дивиденды"
macro TxGetAvoirPayList(
  fiid:Integer // Идентификатор финансового инструмента
 ,payKind:Integer // Вид выплаты (купоны, ч/погашения, дивиденды)
 ,avoirIss//:CTxAvoirIss // Параметры анкеты ц/б
)//:TArray of CTxAvoirPay

  var stat:Integer = -1;
  var sqlQuery:String = "";
  var dataSet = null;
  var avoirPayList = TArray();
  var avoirPay = null;

  InitError();

  if( ( fiid == null ) or ( fiid <= ALLFININSTR ) )
    RunError("Не задан обязательный параметр функции: Идентификатор финансового инструмента");
  end;

  if( ( payKind == null ) or ( payKind <= 0 ) )
    RunError("Не задан обязательный параметр функции: Вид выплаты");
  end;

  if( ( avoirIss == null ) or ( avoirIss.FIID <= ALLFININSTR ) )
    avoirIss = TxGetAvoirIss( fiid );
  end;

  if( ( ( payKind == PayKind_Dividend )
    and ( FI_IsAvrKindShare( avoirIss.AvoirKind ) ) )

   or ( ( payKind == PayKind_Coupon )
     or ( payKind == PayKind_PartialDischarge ) )
    and ( FI_IsAvrKindBond( avoirIss.AvoirKind ) or FI_IsCouponFI(fiid)  ) )

    sqlQuery =
      " SELECT "
        + " warnts.* "
    + " FROM "
        + " dfiwarnts_dbt warnts "
    + " WHERE "
        + " warnts.t_FIID = " + string( fiid ) + " "
    + " AND warnts.t_IsPartial = " + IIF( ( ( payKind == PayKind_Coupon ) or ( payKind == PayKind_Dividend ) ), " CHR( 0 ) ", " CHR( 88 ) " )
    + " ORDER BY "
        + " warnts.t_DrawingDate ";

    dataSet = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );

    while( dataSet.MoveNext() )
      avoirPay = CTxAvoirPay();

      avoirPay.FIID               = SQL_ConvTypeInteger( dataSet.FIID );
      avoirPay.IsPartial          = ( SQL_ConvTypeStr( dataSet.IsPartial ) == SET_CHR );
      avoirPay.Number             = SQL_ConvTypeStr( dataSet.Number );
      avoirPay.DrawingDate        = SQL_ConvTypeDate( dataSet.DrawingDate );
      avoirPay.IncomeVolume       = SQL_ConvTypeSum( dataSet.IncomeVolume );
      avoirPay.IncomeFI           = GetTWsFinInstrByID( SQL_ConvTypeInteger( dataSet.IncomeFI ) );
      avoirPay.IsClosed           = ( SQL_ConvTypeStr( dataSet.SPIsClosed ) == SET_CHR );
      avoirPay.Name               = SQL_ConvTypeStr( dataSet.Name );
      avoirPay.FirstDate          = SQL_ConvTypeDate( dataSet.FirstDate );
      avoirPay.ListDate           = SQL_ConvTypeDate( dataSet.ListDate );
      avoirPay.IncomePoint        = SQL_ConvTypeInteger( dataSet.IncomePoint );
      avoirPay.IncomeScale        = SQL_ConvTypeInteger( dataSet.IncomeScale );
      avoirPay.NonRelativeIncome  = ( SQL_ConvTypeStr( dataSet.RelativeIncome ) != SET_CHR );
      avoirPay.RelativeIncome     = ( SQL_ConvTypeStr( dataSet.RelativeIncome ) == SET_CHR );
      avoirPay.IncomeRate         = SQL_ConvTypeSum( dataSet.IncomeRate );
      avoirPay.AllPartialPercent  = 0.0;
      avoirPay.Definition         = SQL_ConvTypeStr( dataSet.Definition );
      avoirPay.Action             = OperationKind_Undefine;
      avoirPay.ID                 = SQL_ConvTypeInteger( dataSet.ID );
      avoirPay.Version            = SQL_ConvTypeInteger( dataSet.Version );
      avoirPay.PayPeriod          = SQL_ConvTypeStr( dataSet.PayPeriod ); 

      if( payKind == PayKind_Coupon )
        FI_CouponPumpIncomeRateVolume( avoirPay.ID, avoirPay.IncomeVolume, avoirPay.IncomeRate );
      elif( payKind == PayKind_PartialDischarge )
        FI_PartialPumpIncomeRateVolume( fiid, avoirIss.FaceValue, avoirPay.ID, avoirPay.IncomeVolume, avoirPay.IncomeRate, avoirPay.AllPartialPercent );
      end;

      avoirPayList[avoirPayList.Size] = avoirPay;
    end;
  end;

  return avoirPayList;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

// отбор данных для заполнения вкладок "Плавающие купоны"
macro TxGetAvoirFloatCouponList(
  FIID:Integer // ID финансового инструмента
)//:TArray of TxAvoirFlWarn

  var result = TArray();
  var stat:integer = -1;
  var TxAvoirFlWarn, query;

  if( (FIID == null) or (FIID <= 0) )
     RunError("Не задан обязательный параметр функции: ID финансового инструмента");
  end;

  query = " SELECT * " +
          " FROM dfiflwarn_dbt " +
          " WHERE t_FIID = " + string(FIID) +
          " ORDER BY t_ChargeDate";

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while( ds.MoveNext() )
     TxAvoirFlWarn = CTxAvoirFlWarn();

     TxAvoirFlWarn.FIID         = SQL_ConvTypeInteger(ds.FIID);
     TxAvoirFlWarn.IncomeCode   = SQL_ConvTypeStr(ds.IncomeCode);
     TxAvoirFlWarn.ChargeDate   = SQL_ConvTypeDate(ds.ChargeDate);
     TxAvoirFlWarn.FactDate     = SQL_ConvTypeDate(ds.FactDate);
     TxAvoirFlWarn.IncomeVolume = SQL_ConvTypeSum(ds.IncomeVolume);;
     TxAvoirFlWarn.IncomeFI     = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.IncomeFI));
     TxAvoirFlWarn.ID           = SQL_ConvTypeInteger(ds.AutoKey);
     TxAvoirFlWarn.Version      = SQL_ConvTypeInteger(ds.Version);
     TxAvoirFlWarn.Definition   = SQL_ConvTypeStr(ds.Definition);

     result[result.Size] = TxAvoirFlWarn;
  end;

  return result;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

// отбор данных для заполнения вкладок "Номинал/Выпуск"
macro TxGetAvoirValHist(
  fiid:Integer        // ID финансового инструмента
 ,histKind:Integer    // Вид истории (номинала/выпуска)
 ,isIndexNominal:bool // Признак цб с индексируемым номиналом
)//:TArray of CTxAvoirValHist

  var stat:Integer = -1;
  var sqlQuery:String = "";
  var dataSet = null;
  var avoirValHistList = TArray();
  var avoirValHist = null;

  InitError();

  if( ( fiid == null ) or ( fiid <= ALLFININSTR ) )
    RunError( "Не задан обязательный параметр функции: ID финансового инструмента" );
  end;

  if( ( histKind == null )
   or ( histKind != FI_CHANGE_NOMINAL )
  and ( histKind != FI_CHANGE_VOLUME )
  and ( histKind != FI_CHANGE_ISSUER ) )
    RunError( "Не задан обязательный параметр функции: вид истории" );
  end;

  sqlQuery = " SELECT * FROM ";

  if( histKind == FI_CHANGE_NOMINAL )
    sqlQuery = sqlQuery + " dv_fi_facevalue_hist ";
  elif( histKind == FI_CHANGE_VOLUME )
    sqlQuery = sqlQuery + " dv_fi_qty_hist ";
  elif( FI_CHANGE_ISSUER )
    sqlQuery = sqlQuery + " dv_fi_issuer_hist ";  
  end;

  sqlQuery = sqlQuery + " WHERE t_FIID = " + String(fiid);

  if( (histKind == FI_CHANGE_NOMINAL) and isIndexNominal )
     sqlQuery = sqlQuery + " ORDER BY t_BegDate DESC ";
  else
     sqlQuery = sqlQuery + " ORDER BY t_EndDate DESC ";
  end;

  dataSet = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );

  while( dataSet.MoveNext() )
    avoirValHist = CTxAvoirValHist();

    avoirValHist.FIID = SQL_ConvTypeInteger( dataSet.FIID );
    avoirValHist.BegDate = SQL_ConvTypeDate( dataSet.BegDate );
    avoirValHist.EndDate = SQL_ConvTypeDate( dataSet.EndDate );
    avoirValHist.Edit    = ( SQL_ConvTypeStr( dataSet.Active ) == SET_CHR ); /*для всех кроме номинала*/

    if( histKind == FI_CHANGE_NOMINAL )
      avoirValHist.Value   = SQL_ConvTypeSum( dataSet.t_FaceValue );
      avoirValHist.ValKind = FI_CHANGE_NOMINAL;
      avoirValHist.Edit    = ( SQL_ConvTypeStr( dataSet.Edit ) == SET_CHR ); /*для номинала свое поле*/
    elif( histKind == FI_CHANGE_VOLUME )
      avoirValHist.Value   = SQL_ConvTypeSum( dataSet.t_Qty );
      avoirValHist.ValKind = FI_CHANGE_VOLUME;
    elif( histKind == FI_CHANGE_ISSUER )
      avoirValHist.Issuer  = GetTWsPartyExByID( SQL_ConvTypeInteger( dataSet.t_Issuer ) );
      avoirValHist.ValKind = FI_CHANGE_ISSUER;
    end;

    avoirValHist.Active = ( SQL_ConvTypeStr( dataSet.Active ) == SET_CHR );
    avoirValHist.Action = OperationKind_Undefine;
    avoirValHist.ID = SQL_ConvTypeInteger( dataSet.ID );
    avoirValHist.Version = SQL_ConvTypeInteger( dataSet.Version );

    avoirValHistList[avoirValHistList.Size] = avoirValHist;
  end;

  return avoirValHistList;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

private macro RulesPeriod( PeriodStart:date, PeriodEnd:date ):CTxFundRulesPeriod
   var TxFundRulesPeriod = CTxFundRulesPeriod();
   TxFundRulesPeriod.PeriodStart = PeriodStart;
   TxFundRulesPeriod.PeriodEnd = PeriodEnd;
   return TxFundRulesPeriod;
end;

// отбор данных для заполнения вкладок пая
macro TxGetAvrInvst(
  fiid:Integer // Идентификатор ценной бумаги
):CTxAvrInvst

  var stat:integer = -1;
  var query:String = "";
  var ds = null;
  var TxAvrInvst = CTxAvrInvst();

  InitError();

  if( ( fiid == null ) or ( fiid <= ALLFININSTR ) )
    RunError( "Не задан обязательный параметр функции: ID финансового инструмента" );
  end;

  query =
    " SELECT "
      + " fi.t_FIID "
     + " ,fi.t_AvoirKind "
     + " ,fi.t_FI_Code "
     + " ,fi.t_Name FI_Name "
     + " ,fi.t_Definition "
     + " ,fi.t_CodeInAccount "
     + " ,fi.t_Issuer "
     + " ,fi.t_Issued "
     + " ,fi.t_FaceValueFI IncomeFI "
     + " ,fi.t_DrawingDate "
     + " ,fi.t_ExpiryDate "
     + " ,fi.t_SumPrecision "
     + " ,fi.t_Version FinInstrVersion "
     + " ,fi.t_IsSys IsSys "
     + " ,avoir.t_ISIN "
     + " ,avoir.t_LSIN "
     + " ,avoir.t_Qty "
     + " ,avoir.t_IsVoting "
     + " ,avoir.t_TaxGroup "
     + " ,avoir.t_Version AvoirIssVersion "
     + " ,invst.t_HasIncome "
     + " ,invst.t_Type "
     + " ,invst.t_Category "
     + " ,invst.t_Depositary "
     + " ,invst.t_Registrar "
     + " ,invst.t_Auditor "
     + " ,invst.t_Estimator "
     + " ,invst.t_Agent1 "
     + " ,invst.t_Agent2 "
     + " ,invst.t_RulesRegXid "
     + " ,invst.t_RulesRegAgency "
     + " ,invst.t_RulesChangeXid "
     + " ,invst.t_RulesChangeDate "
     + " ,invst.t_RulesChangeAgency "
     + " ,invst.t_ContractEnd "
     + " ,invst.t_ContractDuration "
     + " ,invst.t_ContractDurationUnit "
     + " ,invst.t_FormPeriodStart "
     + " ,invst.t_FormPeriodEnd "
     + " ,invst.t_MinValue "
     + " ,invst.t_MinValueFIID "
     + " ,invst.t_FormValue "
     + " ,invst.t_FormValueFIID "
     + " ,invst.t_FormDate "
     + " ,invst.t_PeriodStart1 "
     + " ,invst.t_PeriodEnd1 "
     + " ,invst.t_PeriodStart2 "
     + " ,invst.t_PeriodEnd2 "
     + " ,invst.t_PeriodStart3 "
     + " ,invst.t_PeriodEnd3 "
     + " ,invst.t_PeriodStart4 "
     + " ,invst.t_PeriodEnd4 "
     + " ,invst.t_PeriodStart5 "
     + " ,invst.t_PeriodEnd5 "
     + " ,invst.t_IssuerIncome "
     + " ,invst.t_DepositaryIncome "
     + " ,invst.t_RegistrarIncome "
     + " ,invst.t_AuditorIncome "
     + " ,invst.t_EstimatoIncome "
     + " ,invst.t_MaxOutlay "
     + " ,invst.t_Name "
     + " ,invst.t_Version InvstVersion "
     + " ,RSB_FIInstr.FI_IsQuoted( fi.t_FIID, RsbSessionData.curdate ) IsQuoted ";

  if( CheckTaxDepositoryMode() )
    query = query +
       " ,avoir.t_SPIsClosed IsClosed ";
  else
    query = query +
       " ,fi.t_IsClosed ";
  end;

  query = query +
    " FROM "
      + " dfininstr_dbt fi "
     + " ,davoiriss_dbt avoir "
     + " ,davrinvst_dbt invst "
  + " WHERE "
      + " fi.t_FIID = " + String( fiid ) + " "
  + " AND avoir.t_FIID = fi.t_FIID "
  + " AND invst.t_FIID = fi.t_FIID ";

  ds = TRsbDataSet( query, RSDVAL_CLIENT, RSDVAL_STATIC );

  if( ds.MoveNext() )
     TxAvrInvst.FIID              = SQL_ConvTypeInteger( ds.FIID );
     TxAvrInvst.AvoirKind         = SQL_ConvTypeInteger( ds.AvoirKind);
     TxAvrInvst.FI_Code           = SQL_ConvTypeStr( ds.FI_Code );
     TxAvrInvst.CodeInAccount     = SQL_ConvTypeStr( ds.CodeInAccount );
     TxAvrInvst.FI_Name           = SQL_ConvTypeStr( ds.FI_Name );
     TxAvrInvst.LSIN              = SQL_ConvTypeStr( ds.LSIN );
     TxAvrInvst.ISIN              = SQL_ConvTypeStr( ds.ISIN );
     TxAvrInvst.Issuer            = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.Issuer ) );
     TxAvrInvst.TaxGroup          = CreateLLValueFromAppServ( 2903, SQL_ConvTypeInteger( ds.TaxGroup ) );
     TxAvrInvst.TaxGroupList      = GetListLlvalues( 2903 );
     TxAvrInvst.IsQuoted          = ( SQL_ConvTypeInteger( ds.IsQuoted ) > 0 );
     TxAvrInvst.HasIncome         = ( SQL_ConvTypeStr( ds.HasIncome ) == SET_CHR );
     TxAvrInvst.IncomeFI          = GetTWsFinInstrByID( SQL_ConvTypeInteger( ds.IncomeFI ) );
     TxAvrInvst.IsVoting          = ( SQL_ConvTypeStr( ds.IsVoting ) == SET_CHR );
     TxAvrInvst.SumPrecision      = SQL_ConvTypeInteger( ds.SumPrecision );
     TxAvrInvst.Name              = SQL_ConvTypeStr( ds.Name );
     TxAvrInvst.Type              = SQL_ConvTypeInteger( ds.Type );
     TxAvrInvst.IT_Interval       = ( TxAvrInvst.Type == ARVINVST_FOND_INTERVAL );
     TxAvrInvst.IT_Open           = ( TxAvrInvst.Type == ARVINVST_FOND_OPENED );
     TxAvrInvst.IT_Closed         = ( TxAvrInvst.Type == ARVINVST_FOND_CLOSED );
     TxAvrInvst.IT_Market         = ( TxAvrInvst.Type == ARVINVST_FOND_MARKET );
     TxAvrInvst.Category          = CreateLLValueFromAppServ( 3520, SQL_ConvTypeInteger( ds.Category ) );
     TxAvrInvst.CategoryList      = GetListLlvalues( 3520 );
     TxAvrInvst.Depositary        = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.Depositary ) );
     TxAvrInvst.Registrar         = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.Registrar ) );
     TxAvrInvst.Auditor           = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.Auditor ) );
     TxAvrInvst.Estimator         = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.Estimator ) );
     TxAvrInvst.Agent1            = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.Agent1 ) );
     TxAvrInvst.Agent2            = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.Agent2 ) );
     TxAvrInvst.RulesRegXid       = SQL_ConvTypeStr( ds.RulesRegXid );
     TxAvrInvst.Issued            = SQL_ConvTypeDate( ds.Issued );
     TxAvrInvst.RulesRegAgency    = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.RulesRegAgency ) );
     TxAvrInvst.RulesChangeXid    = SQL_ConvTypeStr( ds.RulesChangeXid );
     TxAvrInvst.RulesChangeDate   = SQL_ConvTypeDate( ds.RulesChangeDate );
     TxAvrInvst.RulesChangeAgency = GetTWsPartyExByID( SQL_ConvTypeInteger( ds.RulesChangeAgency ) );
     TxAvrInvst.RadioButEndDate   = ( SQL_ConvTypeInteger( ds.ContractDuration ) == 0 );
     TxAvrInvst.ContractEnd       = SQL_ConvTypeDate( ds.ContractEnd );
     TxAvrInvst.RadioButDuration  = ( not TxAvrInvst.RadioButEndDate );
     TxAvrInvst.ContractDuration  = SQL_ConvTypeInteger( ds.ContractDuration );
     TxAvrInvst.DurationType      = CreateNameAlgFromAppServ( 3432, SQL_ConvTypeInteger( ds.ContractDurationUnit ) );
     TxAvrInvst.FormPeriodStart   = SQL_ConvTypeDate( ds.FormPeriodStart );
     TxAvrInvst.FormPeriodEnd     = SQL_ConvTypeDate( ds.FormPeriodEnd );
     TxAvrInvst.MinValue          = SQL_ConvTypeSum( ds.MinValue );
     TxAvrInvst.MinValueFIID      = GetTWsFinInstrByID( SQL_ConvTypeInteger( ds.MinValueFIID ) );
     TxAvrInvst.FormValue         = SQL_ConvTypeSum( ds.FormValue );
     TxAvrInvst.FormValueFIID     = GetTWsFinInstrByID( SQL_ConvTypeInteger( ds.FormValueFIID ) );
     TxAvrInvst.FormDate          = SQL_ConvTypeDate( ds.FormDate );
     TxAvrInvst.Qty               = SQL_ConvTypeSum( ds.Qty );
     TxAvrInvst.RadioButAnyDay    = ( TxAvrInvst.Type == ARVINVST_FOND_OPENED );
     TxAvrInvst.RadioButPeriod    = ( ( TxAvrInvst.Type == ARVINVST_FOND_INTERVAL ) or ( TxAvrInvst.Type == ARVINVST_FOND_MARKET ) );
     TxAvrInvst.RadioButDate      = ( TxAvrInvst.Type == ARVINVST_FOND_CLOSED );
     TxAvrInvst.DrawingDate       = SQL_ConvTypeDate( ds.DrawingDate );
     TxAvrInvst.ExpiryDate        = SQL_ConvTypeDate( ds.ExpiryDate );
     TxAvrInvst.Periods[TxAvrInvst.Periods.Size] = RulesPeriod( SQL_ConvTypeDate( ds.PeriodStart1 ), SQL_ConvTypeDate( ds.PeriodEnd1 ) );
     TxAvrInvst.Periods[TxAvrInvst.Periods.Size] = RulesPeriod( SQL_ConvTypeDate( ds.PeriodStart2 ), SQL_ConvTypeDate( ds.PeriodEnd2 ) );
     TxAvrInvst.Periods[TxAvrInvst.Periods.Size] = RulesPeriod( SQL_ConvTypeDate( ds.PeriodStart3 ), SQL_ConvTypeDate( ds.PeriodEnd3 ) );
     TxAvrInvst.Periods[TxAvrInvst.Periods.Size] = RulesPeriod( SQL_ConvTypeDate( ds.PeriodStart4 ), SQL_ConvTypeDate( ds.PeriodEnd4 ) );
     TxAvrInvst.Periods[TxAvrInvst.Periods.Size] = RulesPeriod( SQL_ConvTypeDate( ds.PeriodStart5 ), SQL_ConvTypeDate( ds.PeriodEnd5 ) );
     TxAvrInvst.IssuerIncome      = SQL_ConvTypeStr( ds.IssuerIncome );
     TxAvrInvst.DepositaryIncome  = SQL_ConvTypeStr( ds.DepositaryIncome );
     TxAvrInvst.RegistrarIncome   = SQL_ConvTypeStr( ds.RegistrarIncome );
     TxAvrInvst.AuditorIncome     = SQL_ConvTypeStr( ds.AuditorIncome );
     TxAvrInvst.EstimatoIncome    = SQL_ConvTypeStr( ds.EstimatoIncome );
     TxAvrInvst.MaxOutlay         = SQL_ConvTypeStr( ds.MaxOutlay );
     TxAvrInvst.Definition        = SQL_ConvTypeStr( ds.Definition );
     TxAvrInvst.FinInstrVersion   = SQL_ConvTypeInteger( ds.FinInstrVersion );
     TxAvrInvst.AvoirIssVersion   = SQL_ConvTypeInteger( ds.AvoirIssVersion );
     TxAvrInvst.InvstVersion      = SQL_ConvTypeInteger( ds.InvstVersion );
     TxAvrInvst.IsClosed          = ( SQL_ConvTypeStr( ds.IsClosed ) == SET_CHR );
     TxAvrInvst.IsSys             = ( SQL_ConvTypeStr( ds.IsSys ) == SET_CHR );            
  else
     RunError( "Не найден финансовый инструмент с FIID = " + String( fiid ) );
  end;

  return TxAvrInvst;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

// инициализация вкладок пая
macro TxInitAvrInvst(AvoirKind):CTxAvrInvst
  var stat:integer = -1;
  var TxAvrInvst = CTxAvrInvst();

  InitError();

  if( (AvoirKind == null) or (AvoirKind <= FIKIND_ALLAVOIRISS) )
     RunError("Не задан обязательный параметр функции: вид ценной бумаги");
  end;

  TxAvrInvst.FIID              = -1;
  TxAvrInvst.AvoirKind         = AvoirKind;
  TxAvrInvst.FI_Code           = "";
  TxAvrInvst.CodeInAccount     = "";
  TxAvrInvst.FI_Name           = "";
  TxAvrInvst.LSIN              = "";
  TxAvrInvst.ISIN              = "";
  TxAvrInvst.Issuer            = null;
  TxAvrInvst.IsQuoted          = IIF (AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE, true, false);
  TxAvrInvst.HasIncome         = false;
  TxAvrInvst.IncomeFI          = null;
  TxAvrInvst.IsVoting          = false;
  TxAvrInvst.SumPrecision      = 5;
  TxAvrInvst.Name              = "";
  TxAvrInvst.Type              = IIF (AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE, ARVINVST_FOND_INTERVAL, -1);
  TxAvrInvst.IT_Interval       = IIF(TxAvrInvst.Type == ARVINVST_FOND_INTERVAL, true, false);
  TxAvrInvst.IT_Open           = IIF(TxAvrInvst.Type == ARVINVST_FOND_OPENED, true, false);
  TxAvrInvst.IT_Closed         = IIF(TxAvrInvst.Type == ARVINVST_FOND_CLOSED, true, false);
  TxAvrInvst.IT_Market         = IIF(TxAvrInvst.Type == ARVINVST_FOND_MARKET, true, false);
  TxAvrInvst.Category          = null;
  TxAvrInvst.CategoryList      = GetListLlvalues(3520);
  TxAvrInvst.Depositary        = null;
  TxAvrInvst.Registrar         = null;
  TxAvrInvst.Auditor           = null;
  TxAvrInvst.Estimator         = null;
  TxAvrInvst.Agent1            = null;
  TxAvrInvst.Agent2            = null;
  TxAvrInvst.RulesRegXid       = "";
  TxAvrInvst.Issued            = ZeroDate;
  TxAvrInvst.RulesRegAgency    = null;
  TxAvrInvst.RulesChangeXid    = "";
  TxAvrInvst.RulesChangeDate   = ZeroDate;
  TxAvrInvst.RulesChangeAgency = null;
  TxAvrInvst.RadioButEndDate   = true;
  TxAvrInvst.ContractEnd       = ZeroDate;
  TxAvrInvst.RadioButDuration  = (not TxAvrInvst.RadioButEndDate);
  TxAvrInvst.ContractDuration  = 0;
  TxAvrInvst.DurationType      = CreateNameAlgFromAppServ(3432, 0);
  TxAvrInvst.FormPeriodStart   = ZeroDate;
  TxAvrInvst.FormPeriodEnd     = ZeroDate;
  TxAvrInvst.MinValue          = 0;
  TxAvrInvst.MinValueFIID      = GetTWsFinInstrByID(NATCUR);
  TxAvrInvst.FormValue         = 0;
  TxAvrInvst.FormValueFIID     = GetTWsFinInstrByID(NATCUR);
  TxAvrInvst.FormDate          = ZeroDate;
  TxAvrInvst.Qty               = 0;
  TxAvrInvst.RadioButAnyDay    = IIF(TxAvrInvst.Type == ARVINVST_FOND_OPENED, true, false);
  TxAvrInvst.RadioButPeriod    = IIF(((TxAvrInvst.Type == ARVINVST_FOND_INTERVAL) or (TxAvrInvst.Type == ARVINVST_FOND_MARKET)), true, false);
  TxAvrInvst.RadioButDate      = IIF(TxAvrInvst.Type == ARVINVST_FOND_CLOSED, true, false);
  TxAvrInvst.DrawingDate       = ZeroDate;
  TxAvrInvst.ExpiryDate        = ZeroDate;
  TxAvrInvst.Periods.value(TxAvrInvst.Periods.Size) = RulesPeriod(ZeroDate, ZeroDate);
  TxAvrInvst.Periods.value(TxAvrInvst.Periods.Size) = RulesPeriod(ZeroDate, ZeroDate);
  TxAvrInvst.Periods.value(TxAvrInvst.Periods.Size) = RulesPeriod(ZeroDate, ZeroDate);
  TxAvrInvst.Periods.value(TxAvrInvst.Periods.Size) = RulesPeriod(ZeroDate, ZeroDate);
  TxAvrInvst.Periods.value(TxAvrInvst.Periods.Size) = RulesPeriod(ZeroDate, ZeroDate);
  TxAvrInvst.IssuerIncome      = "";
  TxAvrInvst.DepositaryIncome  = "";
  TxAvrInvst.RegistrarIncome   = "";
  TxAvrInvst.AuditorIncome     = "";
  TxAvrInvst.EstimatoIncome    = "";
  TxAvrInvst.MaxOutlay         = "";
  TxAvrInvst.Definition        = "";
  TxAvrInvst.FinInstrVersion   = 0;
  TxAvrInvst.AvoirIssVersion   = 0;
  TxAvrInvst.InvstVersion      = 0;
  TxAvrInvst.TaxGroupList      = GetListLlvalues(2903);
  TxAvrInvst.TaxGroup          = GetDefaultNalogGroup(NULL, TxAvrInvst);

  return TxAvrInvst;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

macro TxInitAvoirPanel(
  AvoirKind:Integer
 ,SourceFIID:Integer
):CTxAvoirPanel

  var Stat:Integer = 0;
  var AvoirPanel = CTxAvoirPanel();
  var AvrKinds = null;
  var FinInstr = TRecHandler( "fininstr" );

  if( ( ( AvoirKind == null ) or ( AvoirKind <= FIKIND_ALLAVOIRISS ) )
  and ( ( SourceFIID == null ) or ( SourceFIID <= ALLFININSTR ) ) )
    if( ( AvoirKind == null ) and ( AvoirKind <= FIKIND_ALLAVOIRISS ) )
      RunError( "Не задан обязательный параметр функции: Вид ценной бумаги" );
    else
      RunError( "Не задан обязательный параметр функции: Идентификатор базовой ценной бумаги" );
    end;
  end;

  AvoirPanel.FIID = ALLFININSTR;
  AvoirPanel.FI_Code = "";
  AvoirPanel.Name = "";

  if( ( AvoirKind != null ) and ( AvoirKind > FIKIND_ALLAVOIRISS ) )
    AvrKinds = TxGetAvrKindsById( AvoirKind );
    AvoirPanel.AvoirKind = AvoirKind;
    AvoirPanel.RootAvrKinds = AvrKinds.RootAvrKinds;

    if( (AvoirPanel.RootAvrKinds == AVOIRISSKIND_INVESTMENT_SHARE) or (AvoirPanel.RootAvrKinds == AVOIRISSKIND_HYPOTHECARY_CERT) )
      AvoirPanel.AvrInvst = TxInitAvrInvst( AvoirKind );
    else
      AvoirPanel.AvoirIss = TxInitAvoirIss( AvoirKind );
    end;
  else
    if( ПолучитьФинИн( SourceFIID, FinInstr ) != 0 )
      RunError( "Не найден финансовый инструмент с заданным идентификатором " + String( SourceFIID ) );
    end;

    AvrKinds = TxGetAvrKindsById( FinInstr.rec.AvoirKind );
    AvoirPanel.AvoirKind = FinInstr.rec.AvoirKind;
    AvoirPanel.RootAvrKinds = AvrKinds.RootAvrKinds;

    AvoirPanel.IsCouponFI = FI_IsCouponFI( AvoirPanel.FIID) ;

    if( AvoirPanel.RootAvrKinds != AVOIRISSKIND_SHARE )
      RunError( "Создание выпуска на основе существующего возможно только для акций" );
    else
      AvoirPanel.AvoirIss = TxInitAvoirIss( FIKIND_ALLAVOIRISS, SourceFIID );
    end;
  end;

  AvoirPanel.UserIsAdmin = ( {cTypePerson} == TP_ADM );
  AvoirPanel.FVLastID    = -1;
  AvoirPanel.AddVFByChangeFaceValue = false;

  return AvoirPanel;

OnError( Err )
  TxAvoirIssRunError( Err, Stat );
end;

macro TxGetAvoirPanel(
  FIID:Integer // Идентификатор ценной бумаги
):CTxAvoirPanel

  var Stat:Integer = 0;
  var AvoirPanel = CTxAvoirPanel();
  var FinInstr = TRecHandler( "fininstr" );
  var AvrKinds = null;

  if( ( FIID == null ) or ( FIID <= ALLFININSTR ) )
    RunError( "Не задан обязательный параметр функции: Идентификатор финансового инструмента" );
  end;

  if( ПолучитьФинИн( FIID, FinInstr ) != 0 )
//    RunError( "Не найден финансовый инструмент с заданным идентификатором " + String( FIID ) );
    AvoirPanel.FIID = -1;
  else
    AvoirPanel.FIID = FIID;
  end;

  if( AvoirPanel.FIID > ALLFININSTR )
    AvoirPanel.FI_Code = FinInstr.rec.FI_Code;
    AvoirPanel.Name = FinInstr.rec.Name;

    AvrKinds = TxGetAvrKindsById( FinInstr.rec.AvoirKind );
    AvoirPanel.AvoirKind = FinInstr.rec.AvoirKind;
    AvoirPanel.RootAvrKinds = AvrKinds.RootAvrKinds;

    AvoirPanel.IsCouponFI = FI_IsCouponFI( AvoirPanel.FIID);

    if( (AvoirPanel.RootAvrKinds == AVOIRISSKIND_INVESTMENT_SHARE) or (AvoirPanel.RootAvrKinds == AVOIRISSKIND_HYPOTHECARY_CERT) )
      AvoirPanel.AvrInvst = TxGetAvrInvst( AvoirPanel.FIID );
    else
      AvoirPanel.AvoirIss = TxGetAvoirIss( AvoirPanel.FIID );

      if( ( AvoirPanel.RootAvrKinds == AVOIRISSKIND_SHARE )
            or ( (AvoirPanel.RootAvrKinds == AVOIRISSKIND_DEPOSITORY_RECEIPT) and (not FI_IsCouponFI(SP_GetFIID(AvoirPanel.AvoirIss.ParentFI))) ) )
        AvoirPanel.Dividends = TxGetAvoirPayList( AvoirPanel.FIID, PayKind_Dividend, AvoirPanel.AvoirIss );
      elif( AvoirPanel.RootAvrKinds == AVOIRISSKIND_BOND )
        AvoirPanel.Coupons = TxGetAvoirPayList( AvoirPanel.FIID, PayKind_Coupon, AvoirPanel.AvoirIss );
        AvoirPanel.FloatCoupons = TxGetAvoirFloatCouponList( AvoirPanel.FIID );
        AvoirPanel.PDischarges = TxGetAvoirPayList( AvoirPanel.FIID, PayKind_PartialDischarge, AvoirPanel.AvoirIss );
        AvoirPanel.Issuers = TxGetAvoirValHist( AvoirPanel.FIID, FI_CHANGE_ISSUER, AvoirPanel.AvoirIss.IsIndexNominal );
      elif( (AvoirPanel.RootAvrKinds == AVOIRISSKIND_DEPOSITORY_RECEIPT) and ( FI_IsCouponFI(SP_GetFIID(AvoirPanel.AvoirIss.ParentFI))) )
        AvoirPanel.Coupons = TxGetAvoirPayList( AvoirPanel.FIID, PayKind_Coupon, AvoirPanel.AvoirIss );
        AvoirPanel.PDischarges = TxGetAvoirPayList( AvoirPanel.FIID, PayKind_PartialDischarge, AvoirPanel.AvoirIss );
      end;

      AvoirPanel.FaceValues = TxGetAvoirValHist( AvoirPanel.FIID, FI_CHANGE_NOMINAL, AvoirPanel.AvoirIss.IsIndexNominal );
      AvoirPanel.Qtys = TxGetAvoirValHist( AvoirPanel.FIID, FI_CHANGE_VOLUME, AvoirPanel.AvoirIss.IsIndexNominal );
    end;

    AvoirPanel.Codes = null;
    AvoirPanel.Rates = null;

    AvoirPanel.UserIsAdmin = ( {cTypePerson} == TP_ADM );
  end;

  AvoirPanel.FVLastID = -1;
  AvoirPanel.AddVFByChangeFaceValue = false;

  return AvoirPanel;

OnError( Err )
  TxAvoirIssRunError( Err, Stat );
end;

private macro УстановитьКатегорию( FIID:integer, ObjGroup:integer, AttrID:integer, CatDate:date, ErrorMsg:@string )
  var stat:integer = 0;

  if( ( not DisconnectObjAttr(OBJTYPE_AVOIRISS, L_Z(FIID, 10), ObjGroup) ) OR
      ( not ConnectObjAttr(stat, OBJTYPE_AVOIRISS, L_Z(FIID, 10), ObjGroup, AttrID, null, null, CatDate) ) OR
      ( stat != 0 )
    )
     ErrorMsg = "Ошибка при установке категории <" + ИмяКатегории(OBJTYPE_AVOIRISS, ObjGroup) + ">." + GetErrMsg();
  end;

  return stat;
end;

private macro SaveFinInstrAndAvoirIss( FinInstrBuff:Tbfile, AvoirIssBuff:Tbfile, AvrInvstBuff, IsQuoted, ErrorMsg:@string, FIID:@integer ):integer

  var stat = 0;
  var sql, query, ds;
  var IsPay:bool = false;
  var FinInstrRec = Tbfile("fininstr", "W", 0);
  var AvoirIssRec = Tbfile("avoiriss", "W", 0);
  var AvrInvstRec = Tbfile("avrinvst", "W", 0);

  FinInstrRec.Clear();
  AvoirIssRec.Clear();
  AvrInvstRec.Clear();

  if( AvrInvstBuff != null )
     IsPay = true;
  end;

  query = RSDCommand(" SELECT t_FIID " +
                     "   FROM dfininstr_dbt " +
                     "  WHERE t_FI_Code = ? " +
                     "    AND t_FIID  <> ? " );
  query.NullConversion = true;
  query.addParam( "", RSDBP_IN, FinInstrBuff.rec.FI_Code );
  query.addParam( "", RSDBP_IN, FinInstrBuff.rec.FIID );
  query.execute();
  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  if( ds.MoveNext() )
     stat = 1402;
     ErrorMsg = "Дублирование ключа: уже есть финансовый инструмент с кодом " + string(FinInstrBuff.rec.FI_Code);
  end;

  if( FinInstrBuff.rec.FIID > 0 )

     FinInstrRec.rec.FIID = FinInstrBuff.rec.FIID;
     if( (not FinInstrRec.GetEQ()) or (FinInstrRec.rec.Version != FinInstrBuff.rec.Version) )
        stat = 70;
        ErrorMsg = "Конфликт таблицы dfininstr_dbt. Документ изменен другим операционистом";
     end;

     if( stat == 0 )
        if( SP_CmpRec(FinInstrRec, FinInstrBuff) == false )
           Copy(FinInstrRec, FinInstrBuff);
           if( not FinInstrRec.update() )
              stat = 1; // ???
              ErrorMsg = "Ошибка обновления записи таблицы dfininstr_dbt";
           end;
        end;
     end;

     if( stat == 0 )
        AvoirIssRec.rec.FIID = AvoirIssBuff.rec.FIID;
        if( (not AvoirIssRec.GetEQ()) or (AvoirIssRec.rec.Version != AvoirIssBuff.rec.Version) )
           stat = 70;
           ErrorMsg = "Конфликт таблицы davoiriss_dbt. Документ изменен другим операционистом";
        end;
     end;

     if( stat == 0 )
        if( SP_CmpRec(AvoirIssRec, AvoirIssBuff) == false )
           Copy(AvoirIssRec, AvoirIssBuff);
           if( not AvoirIssRec.update() )
              stat = 1; // ???
              ErrorMsg = "Ошибка обновления записи таблицы davoiriss_dbt";
           end;
        end;
     end;

     if( IsPay == true )
        if( stat == 0 )
           AvrInvstRec.rec.FIID = AvrInvstBuff.rec.FIID;
           if( (not AvrInvstRec.GetEQ()) or (AvrInvstRec.rec.Version != AvrInvstBuff.rec.Version) )
              stat = 70;
              ErrorMsg = "Конфликт таблицы davrinvst_dbt. Документ изменен другим операционистом";
           end;
        end;

        if( stat == 0 )
           if( SP_CmpRec(AvrInvstRec, AvrInvstBuff) == false )
              Copy(AvrInvstRec, AvrInvstBuff);
              if( not AvrInvstRec.update() )
                 stat = 1; // ???
                 ErrorMsg = "Ошибка обновления записи таблицы davrinvst_dbt";
              end;
           end;
        end;
     end;

     if( stat == 0 )
        stat = УстановитьКатегорию(FinInstrBuff.rec.FIID, OBJGROUP_QUOTED, IIF(IsQuoted, OBJATTR_QUOTED_YES, OBJATTR_QUOTED_NOT), FinInstrBuff.rec.Issued, @ErrorMsg);
     end;
  else
     var NewFIID:integer = ALLFININSTR;

     if( FI_GetNewFIID(NewFIID) == 0 )
        FIID = NewFIID;

        Copy(FinInstrRec, FinInstrBuff);
        FinInstrRec.rec.FIID = NewFIID;
        if( not FinInstrRec.insert() )
           stat = 1; // ???
           ErrorMsg = "Ошибка вставки новой записи в таблицу dfininstr_dbt";
        end;

        if( stat == 0 )
           Copy(AvoirIssRec, AvoirIssBuff);
           AvoirIssRec.rec.FIID = NewFIID;
           if( not AvoirIssRec.insert() )
              stat = 1; // ???
              ErrorMsg = "Ошибка вставки новой записи в таблицу davoiriss_dbt";
           end;
        end;

        if( IsPay == true )
           if( stat == 0 )
              Copy(AvrInvstRec, AvrInvstBuff);
              AvrInvstRec.rec.FIID = NewFIID;
              if( not AvrInvstRec.insert() )
                 stat = 1; // ???
                 ErrorMsg = "Ошибка вставки новой записи в таблицу davrinvst_dbt";
              end;
           end;
        end;

        if( stat == 0 )
           stat = УстановитьКатегорию(NewFIID, OBJGROUP_QUOTED, IIF(IsQuoted, OBJATTR_QUOTED_YES, OBJATTR_QUOTED_NOT), {curdate}, @ErrorMsg);
        end;

        if( stat == 0 )
           var Issuer = TRecHandler( "party.dbt" );
           if( ПолучитьСубъекта(FinInstrRec.rec.Issuer, Issuer) == 0 )
              stat = УстановитьКатегорию(NewFIID, OBJGROUP_ACCESSORYQI, IIF(Issuer.rec.NotResident == SET_CHAR, OBJATTR_ACCESSORYQI_ONLY, OBJATTR_ACCESSORYQI_ALL), {curdate}, @ErrorMsg);
           end;
        end;
     else
        stat = 1; // ???
        ErrorMsg = "Ошибка при получении нового FIID";
     end;
  end;

  return stat;
end;

private macro SaveAvoirIss(
  AvoirIss//:CTxAvoirIss
 ,AvrInvst//:CTxAvrInvst
 ,ErrorMsg:@string
 ,FIID:@integer
):integer

  var stat = 0;
  var Avoir, IsPay:bool = false;
  var FinInstrOldRec = Tbfile("fininstr", "R", 0);
  var AvoirIssOldRec = Tbfile("avoiriss", "R", 0);
  var AvrInvstOldRec = Tbfile("avrinvst", "R", 0);

  FinInstrOldRec.Clear();
  AvoirIssOldRec.Clear();
  AvrInvstOldRec.Clear();

  if( AvoirIss != null )
     Avoir = AvoirIss;
  elif( AvrInvst != null )
     Avoir = AvrInvst;
     IsPay = true;
  else
     return 0;
  end;

  if( Avoir.FIID > 0 )
     FinInstrOldRec.rec.FIID = Avoir.FIID;
     if( not FinInstrOldRec.GetEQ() )
        stat = 1;
        ErrorMsg = "Не найдена запись таблицы dfininstr_dbt с FIID=" + string(Avoir.FIID);
     end;

     if( stat == 0 )
        AvoirIssOldRec.rec.FIID = Avoir.FIID;
        if( not AvoirIssOldRec.GetEQ() )
           stat = 1;
           ErrorMsg = "Не найдена запись таблицы davoiriss_dbt с FIID=" + string(Avoir.FIID);
        end;
     end;

     if( (stat == 0) and (IsPay == true) )
        AvrInvstOldRec.rec.FIID = Avoir.FIID;
        if( not AvrInvstOldRec.GetEQ() )
           stat = 1;
           ErrorMsg = "Не найдена запись таблицы davrinvst_dbt с FIID=" + string(Avoir.FIID);
        end;
     end;
  end;

  if( stat == 0 )
     if( IsPay == true )
        SetFinInstr_ByCTxAvrInvst(FinInstrOldRec.rec, Avoir);
        SetAvoirIss_ByCTxAvrInvst(AvoirIssOldRec.rec, Avoir);
        SetAvrInvst_ByCTxAvrInvst(AvrInvstOldRec.rec, Avoir)
     else
        SetFinInstr_ByCTxAvoirIss(FinInstrOldRec.rec, Avoir);
        SetAvoirIss_ByCTxAvoirIss(AvoirIssOldRec.rec, Avoir);
     end;
     stat = SaveFinInstrAndAvoirIss( FinInstrOldRec, AvoirIssOldRec, IIF(IsPay, AvrInvstOldRec, null), Avoir.IsQuoted, @ErrorMsg, @FIID );
  end;

  return stat;
end;

private macro SaveAvoirPay( AvoirPay, ErrorMsg:@string ):integer

  var stat:integer = 0;
  var FiWarntsRec = Tbfile("fiwarnts", "W", 3);
  var FiWarntsOldRec = Tbfile("fiwarnts", "W", 3);
  var size:integer = AvoirPay.size();
  var i:integer = 0;
  var Warnts;

  if( size > 0 )
     // Удаляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        Warnts = AvoirPay(i);

        if( Warnts.Action == OperationKind_Delete )
           FiWarntsRec.Clear();
           FiWarntsRec.rec.ID = Warnts.ID;
           if( not FiWarntsRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы dfiwarnts_dbt с ID=" + string(Warnts.ID);
           elif( FiWarntsRec.rec.Version != Warnts.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы dfiwarnts_dbt. Документ изменен другим операционистом";
           else
              if( not FiWarntsRec.delete() )
                 stat = 1; // ???
                 ErrorMsg = "Ошибка удаления записи таблицы dfiwarnts_dbt";
              end;
           end;
        end;

        i = i + 1;
     end;

     // Редактируем записи
     i = 0;
     while((i < size) AND (stat == 0))
        Warnts = AvoirPay(i);

        if( (Warnts.Action == OperationKind_Update) and (Warnts.ID > 0) )
           FiWarntsOldRec.Clear();
           FiWarntsOldRec.rec.ID = Warnts.ID;
           if( not FiWarntsOldRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы dfiwarnts_dbt с ID=" + string(Warnts.ID);
           elif( FiWarntsOldRec.rec.Version != Warnts.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы dfiwarnts_dbt. Документ изменен другим операционистом";
           end;

           if( stat == 0 )
              Copy(FiWarntsRec, FiWarntsOldRec);
              if( not FiWarntsRec.GetEQ() )
                 stat = 1;
                 ErrorMsg = "Не найдена запись таблицы dfiwarnts_dbt с ID=" + string(Warnts.ID);
              end;
           end;

           if( stat == 0 )
              SetAvoirPay(FiWarntsRec.rec, Warnts);

              if( SP_CmpRec(FiWarntsRec, FiWarntsOldRec) == false )
                 if( not FiWarntsRec.update() )
                    stat = 1; // ???
                    ErrorMsg = "Ошибка обновления записи таблицы dfiwarnts_dbt";
                 end;
              end;
           end;
        end;

        i = i + 1;
     end;

     // Вставляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        Warnts = AvoirPay(i);

        if( Warnts.Action == OperationKind_Insert )
           FiWarntsRec.Clear();
           SetAvoirPay(FiWarntsRec.rec, Warnts);
           if( not FiWarntsRec.insert() )
              stat = 1; // ???
              ErrorMsg = "Ошибка вставки новой записи в таблицу dfiwarnts_dbt";
           end;
        end;

        i = i + 1;
     end;
  end;

  return stat;
end;

private macro SaveAvoirFloatCoupon( AvoirPay, ErrorMsg:@string ):integer

  var stat:integer = 0;
  var FiWarntsRec = Tbfile("fiflwarn", "W", 0);
  var FiWarntsOldRec = Tbfile("fiflwarn", "W", 0);
  var size:integer = AvoirPay.size();
  var i:integer = 0;
  var Warnts;

  if( size > 0 )
     // Удаляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        Warnts = AvoirPay(i);

        if( Warnts.Action == OperationKind_Delete )
           FiWarntsRec.Clear();
           FiWarntsRec.rec.AutoKey = Warnts.ID;
           if( not FiWarntsRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы dfiflwarn_dbt с ID=" + string(Warnts.ID);
           elif( FiWarntsRec.rec.Version != Warnts.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы dfiflwarn_dbt. Документ изменен другим операционистом";
           else
              if( not FiWarntsRec.delete() )
                 stat = 1; // ???
                 ErrorMsg = "Ошибка удаления записи таблицы dfiflwarn_dbt";
              end;
           end;
        end;

        i = i + 1;
     end;

     // Редактируем записи
     i = 0;
     while((i < size) AND (stat == 0))
        Warnts = AvoirPay(i);

        if( (Warnts.Action == OperationKind_Update) and (Warnts.ID > 0) )
           FiWarntsOldRec.Clear();
           FiWarntsOldRec.rec.AutoKey = Warnts.ID;
           if( not FiWarntsOldRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы dfiflwarn_dbt с ID=" + string(Warnts.ID);
           elif( FiWarntsOldRec.rec.Version != Warnts.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы dfiflwarn_dbt. Документ изменен другим операционистом";
           end;

           if( stat == 0 )
              Copy(FiWarntsRec, FiWarntsOldRec);
              if( not FiWarntsRec.GetEQ() )
                 stat = 1;
                 ErrorMsg = "Не найдена запись таблицы dfiflwarn_dbt с ID=" + string(Warnts.ID);
              end;
           end;

           if( stat == 0 )
              SetAvoirFloatCoupon(FiWarntsRec.rec, Warnts);

              if( SP_CmpRec(FiWarntsRec, FiWarntsOldRec) == false )
                 if( not FiWarntsRec.update() )
                    stat = 1; // ???
                    ErrorMsg = "Ошибка обновления записи таблицы dfiflwarn_dbt";
                 end;
              end;
           end;
        end;

        i = i + 1;
     end;

     // Вставляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        Warnts = AvoirPay(i);

        if( Warnts.Action == OperationKind_Insert )
           FiWarntsRec.Clear();
           SetAvoirFloatCoupon(FiWarntsRec.rec, Warnts);
           if( not FiWarntsRec.insert() )
              stat = 1; // ???
              ErrorMsg = "Ошибка вставки новой записи в таблицу dfiflwarn_dbt";
           end;
        end;

        i = i + 1;
     end;
  end;

  return stat;
end;

private macro SaveFiVlHist( FiVlHist, ErrorMsg:@string, IsEditBegDate:bool ):integer

  var stat:integer = 0;
  var FiVlHistRec = Tbfile("fivlhist", "W", 1);
  var FiVlHistOldRec = Tbfile("fivlhist", "W", 1);
  var size:integer = FiVlHist.size();
  var i:integer = 0;
  var VlHist;

  if( size > 0 )
     // Удаляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        VlHist = FiVlHist(i);

        if( VlHist.Action == OperationKind_Delete )
           FiVlHistRec.Clear();
           FiVlHistRec.rec.ID = VlHist.ID;
           if( not FiVlHistRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы dfivlhist_dbt с ID=" + string(VlHist.ID);
           elif( FiVlHistRec.rec.Version != VlHist.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы dfivlhist_dbt. Документ изменен другим операционистом";
           else
              if( not FiVlHistRec.delete() )
                 stat = 1; // ???
                 ErrorMsg = "Ошибка удаления записи таблицы dfivlhist_dbt";
              end;
           end;
        end;

        i = i + 1;
     end;

     // Редактируем записи
     i = 0;
     while((i < size) AND (stat == 0))
        VlHist = FiVlHist(i);

        if( (VlHist.Action == OperationKind_Update) and (VlHist.ID > 0) )
           FiVlHistOldRec.Clear();
           FiVlHistOldRec.rec.ID = VlHist.ID;
           if( not FiVlHistOldRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы dfivlhist_dbt с ID=" + string(VlHist.ID);
           elif( FiVlHistOldRec.rec.Version != VlHist.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы dfivlhist_dbt. Документ изменен другим операционистом";
           end;

           if( stat == 0 )
              Copy(FiVlHistRec, FiVlHistOldRec);
              if( not FiVlHistRec.GetEQ() )
                 stat = 1;
                 ErrorMsg = "Не найдена запись таблицы dfivlhist_dbt с ID=" + string(VlHist.ID);
              end;
           end;

           if( stat == 0 )
              SetFiVlHist(FiVlHistRec.rec, VlHist, IsEditBegDate);

              if( SP_CmpRec(FiVlHistRec, FiVlHistOldRec) == false )
                 if( not FiVlHistRec.update() )
                    stat = 1; // ???
                    ErrorMsg = "Ошибка обновления записи таблицы dfivlhist_dbt";
                 end;
              end;
           end;
        end;

        i = i + 1;
     end;

     // Вставляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        VlHist = FiVlHist(i);

        if( VlHist.Action == OperationKind_Insert )
           FiVlHistRec.Clear();
           SetFiVlHist(FiVlHistRec.rec, VlHist, IsEditBegDate);
           if( not FiVlHistRec.insert() )
              stat = 1; // ???
              ErrorMsg = "Ошибка вставки новой записи в таблицу dfivlhist_dbt";
           end;
        end;

        i = i + 1;
     end;
  end;

  return stat;
end;

macro TxRecalcAvoirPayIncome(
  fiid:Integer // Идентификатор финансового иснтрумента
 ,payKind:Integer // Вид платежа
 ,avoirPayList//:TArray of CTxAvoirPay // Список купонов/чп
 ,avoirIss//:CTxAvoirIss // Параметры анкеты ц/б
):WebServiceResponse //:TArray of CTxAvoirPay

  var stat:Integer = 0;
  var errMsg:String = "";
  var errObj:RsBankMsg;
  var transactionStarted:Bool = false;
  var avoirPay = null;
  var avoirPayCount:Integer = 0;
  var newAvoirPayList = TArray();
  var newAvoirPay = null;
  var newAvoirPayCount:Integer = 0;
  var responseBuilder = SP_WebResponseBuilder();  

  InitError();

  if( ( avoirPayList != null) and ( avoirPayList.Size > 0 ) )

    avoirPayList = TArray( avoirPayList );

    RslDefCon.BeginTrans();
    transactionStarted = true;

    stat = SaveAvoirPay( avoirPayList, @errMsg );

    if( stat != 0 )
      if( errMsg == "" )
        errMsg = GetErrMsg();

        if( errMsg == "" )
          errMsg = "Ошибка пересчета";
        end;
      end;
      responseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, errMsg );
    else
      newAvoirPayList = TxGetAvoirPayList( fiid, payKind, avoirIss );

      errObj = AL_GetErrorInfo(false);

      if( errObj.stat != 0 )
        errMsg = errObj.Message;

        if( errMsg == "" )
          errMsg = "Ошибка пересчета";
        end;
        responseBuilder.AddErrorEx( errObj.stat, MessageSeverity.RuntimeError, errMsg );
      else
        newAvoirPayCount = 0;
        while( newAvoirPayCount < newAvoirPayList.Size )
          newAvoirPay = newAvoirPayList[newAvoirPayCount];
  
          avoirPayCount = 0;
          while( avoirPayCount < avoirPayList.Size )
            avoirPay = avoirPayList[avoirPayCount];
  
            if( avoirPay.Action != OperationKind_Delete )
              // by DFIWARNTS_DBT_IDX0
              if( ( avoirPay.IsPartial == newAvoirPay.IsPartial )
              and ( avoirPay.FIID == newAvoirPay.FIID )
              and ( avoirPay.Number == newAvoirPay.Number ) )
                avoirPay.IncomeVolume = newAvoirPay.IncomeVolume;
                avoirPay.IncomeRate = newAvoirPay.IncomeRate;
                avoirPay.AllPartialPercent = newAvoirPay.AllPartialPercent;
  
                break;
              end;
            end;
  
            avoirPayCount = avoirPayCount + 1;
          end;
  
          newAvoirPayCount = newAvoirPayCount + 1;
        end;
      end;
    end;

    transactionStarted = false;
    RslDefCon.RollbackTrans();
  end;

  responseBuilder.SetUserObject( avoirPayList );

  return responseBuilder.Result();

OnError( err )
  if( transactionStarted )
    RslDefCon.RollbackTrans();
  end;

  TxAvoirIssRunError( err, stat );
end;

private macro SaveFiVlHist_Iss( FiVlHist, ErrorMsg:@string ):integer
  var stat:integer = 0;
  var i:integer = 0;
  var size:integer = FiVlHist.size();
  var VlHist;

  if( size > 0 )
    // Удаляем записи
    i = 0;
    while((i < size) AND (stat == 0))
      VlHist = FiVlHist(i);

      if( VlHist.Action == OperationKind_Delete )
        stat = Web_DELETE_FIVLHIST_ISS( VlHist.Fiid, VlHist.Active );

        if( stat == 21347 )
          ErrorMsg = "Ошибка удаления записи из истории изменения эмитента. Невозможно удалить запись из середины истории.";
        end;
      end;

      i = i + 1;
  end;
end;

return stat;
end;

macro TxSaveAvoirIss(
  avoirPanel //: CTxAvoirPanel // Данные панели ценной бумаги
):WebServiceResponse

  var stat:Integer = 0;
  var messageStr:String = "";
  var responseBuilder = SP_WebResponseBuilder();
  var fiid:Integer = ALLFININSTR;
  var transactionStarted:Bool = false;

  InitError();

  if( avoirPanel == null )
    RunError( "Не задан обязательный параметр функции: Параметры панели ценной бумаги" );
  end;

  fiid = avoirPanel.FIID;

  avoirPanel.Coupons = TArray( avoirPanel.Coupons );
  avoirPanel.FloatCoupons = TArray( avoirPanel.FloatCoupons );
  avoirPanel.PDischarges = TArray( avoirPanel.PDischarges );
  avoirPanel.Dividends = TArray( avoirPanel.Dividends );
  avoirPanel.Codes = TArray( avoirPanel.Codes );
  avoirPanel.Rates = TArray( avoirPanel.Rates );
  avoirPanel.FaceValues = TArray( avoirPanel.FaceValues );
  avoirPanel.Qtys = TArray( avoirPanel.Qtys );

  RslDefCon.BeginTrans();
  transactionStarted = true;

  // сохранение анкеты
  if( ( stat == 0 ) and ( ( avoirPanel.AvoirIss != null ) or ( avoirPanel.AvrInvst != null ) ) )
    stat = SaveAvoirIss( avoirPanel.AvoirIss, avoirPanel.AvrInvst, @messageStr, @fiid );
  end;

  // сохранение купонов
  if( ( stat == 0 ) and ( avoirPanel.Coupons != null ) )
    stat = SaveAvoirPay( avoirPanel.Coupons, @messageStr );
  end;

  // сохранение плавающих купонов
  if( ( stat == 0 ) and ( avoirPanel.FloatCoupons != null ) )
    stat = SaveAvoirFloatCoupon( avoirPanel.FloatCoupons, @messageStr );
  end;

  // сохранение ч/погашений
  if( ( stat == 0) and ( avoirPanel.PDischarges != null ) )
    stat = SaveAvoirPay( avoirPanel.PDischarges, @messageStr );
  end;

  // сохранение дивидендов
  if( ( stat == 0 ) and ( avoirPanel.Dividends != null ) )
    stat = SaveAvoirPay( avoirPanel.Dividends, @messageStr );
  end;

  // сохранение кодов
  if( ( stat == 0 ) and ( avoirPanel.Codes != null ) )
    stat = CB_SaveListCodeValuesWOTrn( OBJTYPE_FININSTR, fiid, avoirPanel.Codes, @messageStr );
  end;

  // сохранение курсов
  if( ( stat == 0 ) and ( avoirPanel.Rates != null) )
    stat = FI_SaveRateValueList( avoirPanel.Rates, @messageStr );
  end;

  // сохранение истории изменения номинала
  if( ( stat == 0 ) and (avoirPanel.FaceValues != null) )
    var IsEditBegDate = false;
    if( avoirPanel.AvoirIss != null )
       IsEditBegDate = avoirPanel.AvoirIss.IsIndexNominal;
    end; 
    stat = SaveFiVlHist( avoirPanel.FaceValues, @messageStr, IsEditBegDate);
  end;

  // сохранение истории изменения объема выпуска
  if( ( stat == 0 ) and ( avoirPanel.Qtys != null ) )
    stat = SaveFiVlHist( avoirPanel.Qtys, @messageStr, false );
  end;

  // сохранение истории изменения эмитента
  if( ( stat == 0 ) and ( avoirPanel.Issuers != null ) )
    stat = SaveFiVlHist_Iss( avoirPanel.Issuers, @messageStr );
  end;

  if( stat != 0 )
    if( messageStr == "" )
      stat = -1;
      messageStr = GetErrMsg();
      if( messageStr == "" )
        messageStr = "Ошибка транзакции сохранения цб";
      end;
    end;
    responseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, messageStr );
    RslDefCon.RollbackTrans();
  else
    transactionStarted = false;
    RslDefCon.CommitTrans();
  end;

  responseBuilder.SetUserObject( fiid );

  return responseBuilder.Result();

OnError( err );
  if( transactionStarted )
     RslDefCon.RollbackTrans();
  end;

  TxAvoirIssRunError( err, stat );
end;

macro TxDeleteAvoirIss(
  FIID:integer // ID ФИ
):WebServiceResponse

  var ResponseBuilder : WebResponseBuilder = WebResponseBuilder();
  var stat = 0;
  var errMsg = "";

  InitError();

  if( not ( ( ValType( FIID ) == V_INTEGER ) and ( FIID > ALLFININSTR ) ) )
    RunError( "Не задан обязательный параметр функции: ID финансового инструмента" );
  end;

  ResponseBuilder.SetUserObject( TxGetAvoirIss( FIID ) );

  stat = FI_DeleteAvoiriss(FIID);

  if( stat != 0 )
    errMsg = GetErrMsg();

    if( errMsg != "" );
      ResponseBuilder.AddErrorEx( stat, MessageSeverity.RunTimeError, errMsg );
    else
      ResponseBuilder.AddErrorEx( stat, MessageSeverity.RunTimeError, "Ошибка транзакции удаления цб" );
    end;
  end;

  return ResponseBuilder.Result;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

macro TxCloseAvoirIss(
  FIID:integer // ID ФИ
):WebServiceResponse

  var ResponseBuilder : WebResponseBuilder = WebResponseBuilder();
  var stat = 0;
  var errMsg = "";
  var fininstr = TRecHandler( "fininstr" );

  InitError();

  if( not ( ( ValType( FIID ) == V_INTEGER ) and ( FIID > ALLFININSTR ) ) )
    RunError( "Не задан обязательный параметр функции: ID финансового инструмента" );
  end;

  stat = ПолучитьФинИн( FIID, fininstr );
  if( stat == 0 )
    stat = FI_CloseAvoirIss( fininstr );
  end;

  if( stat != 0 )
    errMsg = GetErrMsg();

    if( errMsg != "" );
      ResponseBuilder.AddErrorEx( stat, MessageSeverity.RunTimeError, errMsg );
    else
      ResponseBuilder.AddErrorEx( stat, MessageSeverity.RunTimeError, "Ошибка транзакции закрытия цб" );
    end;
  end;

  ResponseBuilder.SetUserObject( TxGetAvoirIss( FIID ) );

  return ResponseBuilder.Result;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

macro TxGenerateFICodeReference(
  AvoirIss//:CTxAvoirIss
):CTxFICodeReference

  record FinInstrRec(fininstr);
  record AvoirIssRec(avoiriss);
  var fiCodeReference = CTxFICodeReference();
  var stat:integer = -1;

  if( AvoirIss == null )
     RunError("Не задан обязательный параметр функции: финансовый инструмент");
  end;

  SetFinInstr_ByCTxAvoirIss(FinInstrRec, AvoirIss);
  SetAvoirIss_ByCTxAvoirIss(AvoirIssRec, AvoirIss);

  stat = FI_AvoirGenerateCode( FinInstrRec, AvoirIssRec,
                               fiCodeReference.FI_Code,
                               fiCodeReference.CodeInAccount,
                               fiCodeReference.AvoirCodeRefID,
                               fiCodeReference.AvoirAccountCodeRefID
                             );

  if( stat )
     RunError("Ошибка генерации кода ценной бумаги");
  end;

  return fiCodeReference;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

macro TxRestoreFICodeReference(
  fiCodeReference//:CTxFICodeReference
):integer

  var stat:integer = -1;

  if( fiCodeReference == null )
     RunError("Не задан обязательный параметр функции");
  end;

  stat = FI_RestoreCodeReference( fiCodeReference.FI_Code,
                                  fiCodeReference.CodeInAccount,
                                  fiCodeReference.AvoirCodeRefID,
                                  fiCodeReference.AvoirAccountCodeRefID
                                );

  return IIF(stat == -1, 0, stat);

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

macro TxCheckFloatCoupon(
  floatCouponList//:TArray of CTxAvoirFlWarn // Список плавающих купонов
 ,floatCoupon//:CTxAvoirFlWarn // Текущая запись
 ,avoirIss//:CTxAvoirIss
):WebServiceResponse

  var stat:integer = -1;
  var responseBuilder = WebResponseBuilder();
  var floatCouponCount:Integer = 0;

  InitError();

  responseBuilder.SetUserObject( floatCoupon );

  if( WS_ConvTypeDate(floatCoupon.ChargeDate) == ZeroDate )
    // Введите дату
    responseBuilder.AddError( 18051 );
  end;

  if( floatCoupon.IncomeVolume == 0.0 )
    // Введите сумму
    responseBuilder.AddError( 18031 );
  end;

  if( WS_ConvTypeDate(floatCoupon.ChargeDate) != ZeroDate )
    if( WS_ConvTypeDate(floatCoupon.ChargeDate) < WS_ConvTypeDate(avoirIss.Issued) )
      // Дата начисления дохода не должна быть меньше даты выпуска ц/б 
      responseBuilder.AddError( 37115 );
    end;

    if( WS_ConvTypeDate(floatCoupon.ChargeDate) > WS_ConvTypeDate(avoirIss.DrawingDate) )
      // Дата начисления дохода не должна превышать дату погашения ц/б 
      responseBuilder.AddError( 37116 );
    end;
  end;

  if( WS_ConvTypeDate(floatCoupon.FactDate) != ZeroDate )
    if( WS_ConvTypeDate(floatCoupon.FactDate) < WS_ConvTypeDate(avoirIss.Issued) )
      // Дата фактического получения дохода не может быть меньше даты выпуска ц/б 
      responseBuilder.AddError( 37117 );
    end;
  end;

  return responseBuilder.Result();

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

private macro CheckForBaseOfCouponPeriod(
  avoirPayList//:TArray of CTxAvoirPay // Список купонов
 ,avoirPay//:CTxAvoirPay // Текущая запись
):bool

  var sameBase:Bool = true;
  var avoirPayCount:integer = 0;

  if( avoirPayList != null )
    avoirPayCount = 0;

    while( ( avoirPayCount < avoirPayList.Size ) and sameBase )
      if( ( avoirPayList[avoirPayCount].Action != OperationKind_Delete )
      and ( avoirPayList[avoirPayCount].ID != avoirPay.ID ) )
        if( avoirPayList[avoirPayCount].RelativeIncome != avoirPay.RelativeIncome )
          sameBase = false;
        end;

        if( ( avoirPayList[avoirPayCount].RelativeIncome )
        and ( avoirPay.RelativeIncome )
        and ( avoirPayList[avoirPayCount].IncomeRate != avoirPay.IncomeRate ) )
          sameBase = false;
        end;
      end;

      avoirPayCount = avoirPayCount + 1;
    end;
  end;
end;

private macro CheckCoupon(
  responseBuilder:WebResponseBuilder
 ,fiid:Integer
 ,avoirPayList//:TArray of CTxAvoirPay // Список получений дивидендов
 ,avoirPay//:CTxAvoirPay // Текущая запись
 ,avoirIss//:CTxAvoirIss
)
  var stat:Integer = -1;
  var avoirPayCount:Integer = 0;

  InitError();

  if( not CheckTaxDepositoryMode() )
    if( avoirPay.Number == "" )
      // Введите номер купона
      responseBuilder.AddError( 37038 );
    elif( not StrIsNumber( avoirPay.Number ) )
      // Номер купона должен включать только числовые символы
      responseBuilder.AddError( 37039 );
    end;

    if( WS_ConvTypeDate(avoirPay.DrawingDate) == ZeroDate )
      // Введите дату погашения
      responseBuilder.AddError( 1404 );
    else
      if( WS_ConvTypeDate(avoirPay.DrawingDate) > WS_ConvTypeDate(avoirIss.DrawingDate) )
        // Дата погашения должна быть меньше даты погашения ценной бумаги
        responseBuilder.AddError( 37040 );
      end;

      if( WS_ConvTypeDate(avoirPay.DrawingDate) < WS_ConvTypeDate(avoirIss.Issued) )
        // Дата погашения должна быть больше даты выпуска ценной бумаги
        responseBuilder.AddError( 37041 );
      end;

      if( WS_ConvTypeDate(avoirPay.FirstDate) == ZeroDate )
        // Введите дату начала действия
        responseBuilder.AddError( 1410 );
      else
        if( WS_ConvTypeDate(avoirPay.FirstDate) > WS_ConvTypeDate(avoirPay.DrawingDate) )
          // Дата начала действия должна быть меньше даты погашения
          responseBuilder.AddError( 37042 );
        end;

        if( WS_ConvTypeDate(avoirPay.FirstDate) < WS_ConvTypeDate(avoirIss.Issued) )
          // Дата начала действия должна быть больше даты выпуска ценной бумаги
          responseBuilder.AddError( 37043 );
        end;

        if( WS_ConvTypeDate(avoirPay.FirstDate) == WS_ConvTypeDate(avoirIss.Issued) )
          // Дата начала действия равна дате выпуска.
          // Первый купонный период должен начинаться со следующего за датой выпуска дня
          responseBuilder.AddError( 37044 );
        end;
      end;

      if( ( WS_ConvTypeDate(avoirPay.ListDate) != ZeroDate )
      and ( WS_ConvTypeDate(avoirPay.ListDate) > WS_ConvTypeDate(avoirPay.DrawingDate) ) )
        // Дата составления перечня не может быть больше даты погашения
        responseBuilder.AddError( 37045 );
      end;
    end;

    if( avoirPayList != null )
      avoirPayCount = 0;

      while( avoirPayCount < avoirPayList.Size )
        if( ( avoirPayList[avoirPayCount].Action != OperationKind_Delete )
        and ( avoirPayList[avoirPayCount].ID != avoirPay.ID ) )
          if( avoirPay.Number == avoirPayList[avoirPayCount].Number )
            // Уже есть купон с таким номером
            responseBuilder.AddError( 1405 );
          end;

          if( WS_ConvTypeDate(avoirPay.DrawingDate) == WS_ConvTypeDate(avoirPayList[avoirPayCount].DrawingDate) )
            // Уже есть купон на эту дату погашения
            responseBuilder.AddError( 1403 );
          end;

          if( ( WS_ConvTypeDate(avoirPay.FirstDate) <= WS_ConvTypeDate(avoirPayList[avoirPayCount].DrawingDate) )
            and ( WS_ConvTypeDate(avoirPay.FirstDate) > WS_ConvTypeDate(avoirPayList[avoirPayCount].FirstDate) ) )
            // Дата ввода купона попадает в предыдущий купонный период
            responseBuilder.AddError( 8720 );
          end;

          if( ( WS_ConvTypeDate(avoirPay.DrawingDate) >= WS_ConvTypeDate(avoirPayList[avoirPayCount].FirstDate) )
            and ( WS_ConvTypeDate(avoirPay.FirstDate) < WS_ConvTypeDate(avoirPayList[avoirPayCount].FirstDate) ) )
            // Дата погашения купона попадает в следующий купонный период
            responseBuilder.AddError( 31805 );
          end;
        end;

        avoirPayCount = avoirPayCount + 1;
      end;
    end;

    if( ( SP_GetNameAlgNumberAlg( avoirIss.NKDBase_Kind ) == AVOIRISSNKDBASE_Coup_Cal )
    and ( not CheckForBaseOfCouponPeriod( avoirPayList, avoirPay ) ) )
      // Расчет суммы НКД при выбранной базе расчета \"в году по купонным периодам,
      // в месяце по календарю\" будет некорректным: доход по купону должен быть
      // задан в виде суммы, или для всех купонов должна быть задана одинаковая процентная ставка
      responseBuilder.AddWarning( 37046 );
    end;
  end;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

private macro CheckPartialDischarge(
  responseBuilder:WebResponseBuilder
 ,fiid:Integer
 ,avoirPayList//:TArray of CTxAvoirPay // Список получений дивидендов
 ,avoirPay//:CTxAvoirPay // Текущая запись
 ,avoirIss//:CTxAvoirIss
)
  var stat:Integer = -1;
  var avoirPayCount:Integer = 0;
  var incomeRateSum:Double = 0.0;

  InitError();

  if( not CheckTaxDepositoryMode() )
    if( avoirPay.Number == "" )
      // Введите номер частичного погашения
      responseBuilder.AddError( 37047 );
    elif( not StrIsNumber( avoirPay.Number ) )
      // Номер частичного погашения должен включать только числовые символы
      responseBuilder.AddError( 37048 );
    end;

    if( WS_ConvTypeDate(avoirPay.DrawingDate) == ZeroDate )
      // Введите дату погашения
      responseBuilder.AddError( 1404 );
    else
      if( WS_ConvTypeDate(avoirPay.DrawingDate) > WS_ConvTypeDate(avoirIss.DrawingDate) )
        // Дата погашения должна быть меньше даты погашения ценной бумаги
        responseBuilder.AddError( 37040 );
      end;
      if( WS_ConvTypeDate(avoirPay.DrawingDate) < WS_ConvTypeDate(avoirIss.Issued) )
        // Дата погашения должна быть больше даты выпуска ценной бумаги
        responseBuilder.AddError( 37041 );
      end;
    end;

    if( ( WS_ConvTypeDate(avoirPay.ListDate) != ZeroDate )
    and ( WS_ConvTypeDate(avoirPay.ListDate) > WS_ConvTypeDate(avoirPay.DrawingDate) ) )
      // Дата составления перечня не может быть больше даты погашения
      responseBuilder.AddError( 37045 );
    end;

    if( avoirPay.IncomeRate > 100 )
      // Погашаемый % номинала не должен превышать 100%
      responseBuilder.AddError( 37094 );
    end;

    if( avoirPayList != null )
      avoirPayCount = 0;
      incomeRateSum = 0.0;

      while( avoirPayCount < avoirPayList.Size )
        if( avoirPayList[avoirPayCount].Action != OperationKind_Delete )
          if( avoirPayList[avoirPayCount].ID != avoirPay.ID )
            if( avoirPay.Number == avoirPayList[avoirPayCount].Number )
              // Уже есть частичное погашение с таким номером
              responseBuilder.AddError( 1467 );
            end;

            if( WS_ConvTypeDate(avoirPay.DrawingDate) == WS_ConvTypeDate(avoirPayList[avoirPayCount].DrawingDate) )
              // Уже есть частичное погашение на эту дату
              responseBuilder.AddError( 1466 );
            end;
          end;

          incomeRateSum = incomeRateSum + avoirPayList[avoirPayCount].IncomeRate;
        end;

        avoirPayCount = avoirPayCount + 1;
      end;

      if( incomeRateSum > 100 )
        // Сумма процентов по всем частичным погашениям одного выпуска не должна превышать 100%
        responseBuilder.AddError( 37049 );
      end;
    end;
  end;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

private macro CheckDividend(
  responseBuilder:WebResponseBuilder
 ,avoirPayList//:TArray of CTxAvoirPay // Список получений дивидендов
 ,avoirPay//:CTxAvoirPay // Текущая запись
)
  var stat:Integer = -1;
  var avoirPayCount:Integer = 0;

  InitError();

  if( avoirPay != null )
    if( avoirPay.Number == "" )
      // Введите номер получения
      responseBuilder.AddError( 37037 );
    elif( WS_ConvTypeDate(avoirPay.DrawingDate) == ZeroDate )
      // Введите максимальный срок выплаты эмитентом
      responseBuilder.AddError( 37084 );
    elif( WS_ConvTypeDate(avoirPay.ListDate) == ZeroDate )
      // Введите дату составления перечня владельцев
      responseBuilder.AddError( 8186 );
    end;
  end;

  if( avoirPayList != null )
    avoirPayCount = 0;

    while( avoirPayCount < avoirPayList.Size )
      if( ( avoirPayList[avoirPayCount].Action != OperationKind_Delete )
      and ( avoirPayList[avoirPayCount].ID != avoirPay.ID ) )
        if( avoirPay.Number == avoirPayList[avoirPayCount].Number )
          // Уже есть получение дивидендов с таким номером
          responseBuilder.AddError( 1954 );
        end;

        if( WS_ConvTypeDate(avoirPay.DrawingDate) == WS_ConvTypeDate(avoirPayList[avoirPayCount].DrawingDate) )
          // Уже есть получение дивидендов с таким сроком выплаты
          responseBuilder.AddError( 1955 );
        end;
      end;

      avoirPayCount = avoirPayCount + 1;
    end;
  end;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

private macro GetBeginDate(avoirIss, avoirPay, avoirPayList, isInit)

  if( isInit )
    avoirPay.FirstDate = ZeroDate;
  else
    avoirPay.FirstDate = WS_ConvTypeDate(avoirIss.Issued);
  end;

  if( avoirPayList.size > 1 )
    var i:Integer = avoirPayList.size - 1;
    while( i >= 0 )
      if( (avoirPayList[i].ID != avoirPay.ID)
      and (avoirPayList[i].Action != OperationKind_Delete)
      and (WS_ConvTypeDate(avoirPayList[i].DrawingDate) <= WS_ConvTypeDate(avoirIss.DrawingDate)) )
        avoirPay.FirstDate = WS_ConvTypeDate(avoirPayList[i].DrawingDate) + 1;
        break;
      end;

      i = i - 1;
    end;
  end;
  
end;

macro TxInitAvoirPay(
  payKind:Integer
 ,avoirPayList//:TArray of CTxAvoirPay
 ,avoirPay//:CTxAvoirPay
 ,avoirIss//:CTxAvoirIss
):WebServiceResponse

  var stat:Integer = -1;
  var responseBuilder = WebResponseBuilder();
  var avoirPayCount:Integer = 0;
  var incomeRateSum:Double = 0.0;

  InitError();

  responseBuilder.SetUserObject( avoirPay );

  avoirPayList = TArray( avoirPayList );

  avoirPay.FIID = avoirIss.FIID;

  avoirPay.Number = "";
  avoirPay.Definition = "";
  /*avoirPay.FirstDate = */GetBeginDate(avoirIss, avoirPay, avoirPayList, true);
  avoirPay.DrawingDate = ZeroDate;
  avoirPay.ListDate = ZeroDate;
  avoirPay.IncomeRate = 0.0;
  avoirPay.IncomeVolume = $0;
  if (PayKind == PayKind_PartialDischarge)
    avoirPay.IsPartial = true;
    avoirPay.IncomePoint = 4;
    avoirPay.NonRelativeIncome = false;
    while( avoirPayCount < avoirPayList.Size )
      if( avoirPayList[avoirPayCount].Action != OperationKind_Delete )
          incomeRateSum = incomeRateSum + avoirPayList[avoirPayCount].IncomeRate;
      end;
      avoirPayCount = avoirPayCount + 1;
    end;    
      avoirPay.AllPartialPercent = incomeRateSum;
  else
    avoirPay.IsPartial = false;
    avoirPay.IncomePoint = 2;
    avoirPay.NonRelativeIncome = IIF(AvoirIss.IsIndexNominal == true, false, true);
  end;

  avoirPay.RelativeIncome = not avoirPay.NonRelativeIncome;
  avoirPay.IncomeScale = 1;
  avoirPay.IncomeFI = GetTWsFinInstrByID( SP_GetFIID( AvoirIss.FaceValueFI ) );

  return responseBuilder.Result();

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

macro TxCheckAvoirPay(
  fiid:Integer
 ,payKind:Integer
 ,avoirPayList//:TArray of CTxAvoirPay
 ,avoirPay//:CTxAvoirPay
 ,avoirIss//:CTxAvoirIss
):WebServiceResponse

  var stat:Integer = -1;
  var responseBuilder = WebResponseBuilder();
  var avoirPayCount:Integer = 0;

  InitError();

  responseBuilder.SetUserObject( avoirPay );

  avoirPayList = TArray( avoirPayList );

  if( ( payKind == PayKind_Coupon )
   or ( payKind == PayKind_PartialDischarge ) )
    if( ( avoirPay.ChangedProperty == "NonRelativeIncome" )
     or ( avoirPay.ChangedProperty == "RelativeIncome" )
     or ( avoirPay.ChangedProperty == "IncomeVolume" )
     or ( avoirPay.ChangedProperty == "IncomeFI" )
     or ( avoirPay.ChangedProperty == "IncomeRate" )
     or ( avoirPay.ChangedProperty == "IncomePoint" )
     or ( avoirPay.ChangedProperty == "AllPartialPercent" )
     or ( avoirPay.ChangedProperty == "DrawingDate" )
     or ( avoirPay.ChangedProperty == "FirstDate" ) )

      avoirPayCount = 0;
      while( avoirPayCount < avoirPayList.Size )
        if( avoirPayList[avoirPayCount].Action != OperationKind_Delete )

          // by DFIWARNTS_DBT_IDX0
          if( ( avoirPay.IsPartial == avoirPayList[avoirPayCount].IsPartial )
          and ( avoirPay.FIID == avoirPayList[avoirPayCount].FIID )
          and ( avoirPay.Number == avoirPayList[avoirPayCount].Number ) )
            if( avoirPayList[avoirPayCount].Action == OperationKind_NotInsert )
              avoirPayList[avoirPayCount].Action = OperationKind_Insert;
            elif( avoirPayList[avoirPayCount].Action != OperationKind_Insert )
              avoirPayList[avoirPayCount].Action = OperationKind_Update;
            end;

            break;
          end;
        end;

        avoirPayCount = avoirPayCount + 1;
      end;

      var recalcReponse = TxRecalcAvoirPayIncome( fiid, payKind, avoirPayList, avoirIss );

      if( recalcReponse.ErrorMessages.Size == 0 )

        avoirPayList = recalcReponse.UserObject;
      avoirPayCount = 0;

      while( avoirPayCount < avoirPayList.Size )
        if( avoirPayList[avoirPayCount].Action != OperationKind_Delete )
          // by DFIWARNTS_DBT_IDX0
          if( ( avoirPay.IsPartial == avoirPayList[avoirPayCount].IsPartial )
          and ( avoirPay.FIID == avoirPayList[avoirPayCount].FIID )
          and ( avoirPay.Number == avoirPayList[avoirPayCount].Number ) )
            avoirPay.IncomeVolume = avoirPayList[avoirPayCount].IncomeVolume;
            avoirPay.IncomeRate = avoirPayList[avoirPayCount].IncomeRate;
            avoirPay.AllPartialPercent = avoirPayList[avoirPayCount].AllPartialPercent;

            break;
          end;
        end;
        avoirPayCount = avoirPayCount + 1;
      end;

      else
        var currentErrMsg = 0;
        while( currentErrMsg < recalcReponse.ErrorMessages.Size)
          responseBuilder.AddMessage(recalcReponse.ErrorMessages[currentErrMsg]);
          currentErrMsg = currentErrMsg + 1;
        end; 
      end;
    end;

    if( payKind == PayKind_Coupon )
      if( avoirPay.ChangedProperty == "DrawingDate" )
        if( (WS_ConvTypeDate(avoirPay.DrawingDate) != ZeroDate) and (WS_ConvTypeDate(avoirPay.FirstDate) == ZeroDate) )
          GetBeginDate(avoirIss, avoirPay, avoirPayList);
        end;
      end;
    end;
  end;

  if( payKind == PayKind_Coupon )
    CheckCoupon( responseBuilder, fiid, avoirPayList, avoirPay, avoirIss );
  elif( payKind == PayKind_PartialDischarge )
    CheckPartialDischarge( responseBuilder, fiid, avoirPayList, avoirPay, avoirIss );
  elif( payKind == PayKind_Dividend )
    CheckDividend( responseBuilder, avoirPayList, avoirPay );
  end;

  return responseBuilder.Result();

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

// Обновить связанную анкету купона
private macro UpdateCouponLinkedForm(
  partialDischargeList//:TArray of CTxAvoirPay
 ,coupon//:CTxAvoirPay
 ,linkedFormUpdateParams//:CTxLinkedFormUpdateParams
)
   var stat:Integer = -1;

   var fininstr = TRecHandler("fininstr");
   var avoiriss = TRecHandler("avoiriss");

   ПолучитьФинИн(coupon.FIID, fininstr);

   if( coupon.DrawingDate != fininstr.rec.DrawingDate )
      var i:Integer = 0;
      var exist:Bool = false;
      if( (partialDischargeList != null) and (partialDischargeList.size() > 0) )
         while( i < partialDischargeList.size() )
            if( (partialDischargeList(i).IsPartial == true)
            and (partialDischargeList(i).DrawingDate == coupon.DrawingDate)
            and (partialDischargeList(i).Fiid == coupon.FIID) )
               exist = true;
               break;
            end;
            i = i + 1;
         end;
      end;

      if( exist )
         if( ПогашениеКупона(coupon.FIID,coupon.Number,partialDischargeList(i).Number) == true )
            linkedFormUpdateParams.Message = "Погашение купона выполняется одновременно с частичным погашением.|"+
                                              "В анкету частичного погашения из анкеты купона будет скопирована|"+
                                              " дата составления перечня";
         else
            linkedFormUpdateParams.IsAskQuestion = true;
            linkedFormUpdateParams.Message = "Подставить в анкету частичного погашения за дату " + coupon.DrawingDate +
                                              " дату составления перечня владельцев из анкеты купона?";
         end;
         linkedFormUpdateParams.Number = partialDischargeList(i).Number;
         linkedFormUpdateParams.Kind = PairPARTLY;
      end;

   else
      if( ПогашениеВыпуска(coupon.FIID,coupon.Number) == true )
         linkedFormUpdateParams.Message = "Погашение купона выполняется одновременно с погашением выпуска.|"+
                                           "В анкету погашения выпуска из анкеты купона будет скопирована|"+
                                           " дата составления перечня владельцев";
      else
         linkedFormUpdateParams.IsAskQuestion = true;
         linkedFormUpdateParams.Message = "Подставить в анкету выпуска дату составления перечня из анкеты купона?";

         if( not ПолучитьФинИн(coupon.FIID, null, avoiriss))
            linkedFormUpdateParams.Number = "";
            linkedFormUpdateParams.Kind = PairAVOIR;
         end;
      end;
   end;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

// Обновить связанную анкету частичных погашений
private macro UpdatePartialDischargeLinkedForm(
  avoirPayList//:TArray of CTxAvoirPay
 ,avoirPay//:CTxAvoirPay
 ,linkedFormUpdateParams//:CTxLinkedFormUpdateParams
 ,isLastPartialDischarge:Bool
)
  var stat:Integer = -1;
  var exist:Bool = false;
  var avoirPayCount:Integer = 0;

  if( avoirPayList != null )
    avoirPayCount = 0;

    while( avoirPayCount < avoirPayList.Size )
      if( ( not avoirPayList[avoirPayCount].IsPartial )
      and ( avoirPayList[avoirPayCount].DrawingDate == avoirPay.DrawingDate )
      and ( avoirPayList[avoirPayCount].FIID == avoirPay.FIID ) )
        exist = true;
        break;
      end;

      avoirPayCount = avoirPayCount + 1;
    end;
  end;

  if( not isLastPartialDischarge )
    if( exist )
      if( ПогашениеКупона( avoirPay.FIID, avoirPayList[avoirPayCount].Number, avoirPay.Number ) )
        linkedFormUpdateParams.Message = "Частичное погашение выполняется одновременно с погашением купона. "+
                                         "В анкету купона из анкеты частичного погашения "+
                                         " будет скопирована дата составления перечня владельцев";
      else
        linkedFormUpdateParams.IsAskQuestion = true;
        linkedFormUpdateParams.Message = "Подставить в анкету купона за дату " + avoirPay.DrawingDate +
                                         " дату составления перечня владельцев из анкеты частичного погашения?";
      end;

      linkedFormUpdateParams.Number = avoirPayList[avoirPayCount].Number;
      linkedFormUpdateParams.Kind = PairCOUPON;
    end;
  else
    if( exist )
      if( ПогашениеВыпуска( avoirPay.FIID, avoirPayList[avoirPayCount].Number, avoirPay.Number ) )
        linkedFormUpdateParams.Message = "Погашение выпуска выполняется одновременно с погашением купона.|"+
                                         "В анкету купона из анкеты последнего частичного погашения|"+
                                         " будет скопирована дата составления перечня владельцев";
        linkedFormUpdateParams.IsLastPDischarges = true;
      else
        linkedFormUpdateParams.IsAskQuestion = true;
        linkedFormUpdateParams.Message = "Подставить в анкету купона за дату " + avoirPay.DrawingDate +
                                         " дату составления перечня владельцев из анкеты частичного погашения?";
      end;

      linkedFormUpdateParams.Number = avoirPayList[avoirPayCount].Number;
      linkedFormUpdateParams.Kind = PairCOUPON;
    end;
  end;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

macro TxUpdateAvoirPayLinkedForm(
  payKind:Integer
 ,avoirPayList//:TArray of CTxAvoirPay
 ,avoirPay//:CTxAvoirPay
 ,isLastPartialDischarge:Bool
):WebServiceResponse

  var stat:integer = -1;
  var responseBuilder = WebResponseBuilder();
  var linkedFormUpdateParams = CTxLinkedFormUpdateParams();

  InitError();

  responseBuilder.SetUserObject( linkedFormUpdateParams );

  linkedFormUpdateParams.FIID = avoirPay.FIID;
  linkedFormUpdateParams.NewListDate = avoirPay.ListDate;

  if( payKind == PayKind_Coupon )
    UpdateCouponLinkedForm( avoirPayList, avoirPay, linkedFormUpdateParams );
  elif( payKind == PayKind_PartialDischarge )
    UpdatePartialDischargeLinkedForm( avoirPayList, avoirPay, linkedFormUpdateParams, isLastPartialDischarge );
  end;

  return responseBuilder.Result();

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

// Обновить связанную анкету выпуска
macro TxUpdateAvoirIssLinkedForm(
  avoirIss//:CTxAvoirIss
 ,avoirPayList//:TArray of CTxAvoirPay
):WebServiceResponse

  var stat:integer = -1;
  var responseBuilder = WebResponseBuilder();
  var linkedFormUpdateParams = CTxLinkedFormUpdateParams();
  var exist:Bool = false;
  var avoirPay = null;
  var avoirPayCount:Integer = 0;

  InitError();

  responseBuilder.SetUserObject( linkedFormUpdateParams );

  linkedFormUpdateParams.FIID = avoirIss.FIID;
  linkedFormUpdateParams.NewListDate = avoirIss.ListDate;

  if( avoirPayList != null )
    avoirPayCount = 0;
    while( ( avoirPayCount < avoirPayList.Size )
       and ( not exist ) )

      if( ( avoirPayList[avoirPayCount].Action != OperationKind_Delete )
      and ( not avoirPayList[avoirPayCount].IsPartial )
      and ( avoirPayList[avoirPayCount].DrawingDate == avoirIss.DrawingDate )
      and ( avoirPayList[avoirPayCount].FIID == avoirIss.FIID ) )
        avoirPay = avoirPayList[avoirPayCount];
        exist = true;
      end;

      avoirPayCount = avoirPayCount + 1;
    end;
  end;

  if( exist )
    if( ПогашениеВыпуска( avoirIss.FIID, avoirPay.Number ) )
      linkedFormUpdateParams.Message = "Погашение выпуска выполняется одновременно с погашением купона.|"+
                                       "В анкету купона из анкеты выпуска|"+
                                       " будет скопирована дата составления перечня владельцев";
    else
      linkedFormUpdateParams.IsAskQuestion = true;
      linkedFormUpdateParams.Message = "Подставить в анкету купона за дату " + avoirIss.DrawingDate +
                                       " дату составления перечня владельцев из анкеты выпуска?";
    end;

    linkedFormUpdateParams.Number = avoirPay.Number;
    linkedFormUpdateParams.Kind = PairCOUPON;
  end;

  return responseBuilder.Result();

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

macro TxCheckValHist(
  avoirValHistList//:TArray of CTxAvoirValHist  // Список истории изменения номинала/объёма
 ,avoirValHist//:CTxAvoirValHist                // Текущая запись
 ,avoirIss //:CtxAvoirIss 
):WebServiceResponse

  var stat:Integer = -1;
  var errMsg:String = "";
  var responseBuilder = SP_WebResponseBuilder();
  var lastAllowedDate:Date = ZeroDate;
  var avoirValHistCount:Integer = 0;

  var IsIndexNominal = false;

  if( ( avoirValHistList == null )
   or ( avoirValHistList.Size == 0 ) )
    RunError( "Не задан обязательный параметр функции: Список истории изменения номинала/объёма" );
  end;

  if( avoirValHist == null )
    RunError( "Не задан обязательный параметр функции: Текущая запись" );
  end;

  if(avoirIss == null)
    RunError( "Не задан обязательный параметр функции: Анкета ц/б" );
  else
    IsIndexNominal = avoirIss.IsIndexNominal;
  end;

  var Dat = date(IIF(IsIndexNominal, avoirValHist.BegDate, avoirValHist.EndDate));

  if( (not IsIndexNominal) and (Dat >= {curdate}) )
    // Введенная дата должна быть меньше текущей опердаты
    responseBuilder.AddError( 1965 );
  end;

  if( not IsIndexNominal )
    stat = FI_GetLastAllowedDate( avoirIss.FIID, lastAllowedDate );
    if( stat != 0 )
      errMsg = GetErrMsg();
      if( errMsg == "" )
        errMsg = "Ошибка получения данных депозитарного обслуживания";
      end;
      RunError( errMsg );
    else
      if( SQL_ConvTypeDate(lastAllowedDate) > date(avoirValHist.EndDate) )

        // Ценная бумага в этот период состоит на обслуживании в депозитарии
        responseBuilder.AddError( 1969 );
      end;
    end;
  end;

  var MinDate:date = date(31,12,9999);
  avoirValHistCount = 0;
  while( avoirValHistCount < avoirValHistList.Size )

    if( ( avoirValHistList[avoirValHistCount].Action != OperationKind_Delete ) and
        ( avoirValHistList[avoirValHistCount].ID != avoirValHist.ID ) and
        ( avoirValHistList[avoirValHistCount].Fiid != avoirValHist.Fiid ) and
        ( avoirValHistList[avoirValHistCount].ValKind != avoirValHist.ValKind )
      )
       var ChDat = date(IIF(IsIndexNominal, avoirValHistList[avoirValHistCount].BegDate, avoirValHistList[avoirValHistCount].EndDate));
       if( ChDat == Dat )
         // Введенная дата не должна совпадать с уже введенными значениями
         responseBuilder.AddError( 1966 );
       end;

       MinDate = min(MinDate, avoirValHistList[avoirValHistCount].BegDate);
    end;
    avoirValHistCount = avoirValHistCount + 1;
  end;

  if( MinDate != date(31,12,9999) )
     if( IsIndexNominal and (Dat <= MinDate) )
        responseBuilder.AddError(1986); // Дата начала действия должна быть больше даты начала действия первой записи
     elif( (not IsIndexNominal) and (Dat < MinDate) )
        responseBuilder.AddError(1985); // Дата окончания действия должна быть больше или равна дате начала действия первой записи
     end;
  end;

  responseBuilder.SetUserObject( avoirValHist );

  return responseBuilder.Result();

OnError( err )
  TxAvoirIssRunError( err, stat );
end;

private macro CheckPay(
  SaveAvoirIss//:CTxAvoirIss  // Сохраненные параметры анкеты ц/б
 ,AvoirIss//:CTxAvoirIss      // Параметры анкеты ц/б
):Bool
  return ((SaveAvoirIss.LSIN          != AvoirIss.LSIN) or
          (SaveAvoirIss.ISIN          != AvoirIss.ISIN) or
          (SaveAvoirIss.FI_Code       != AvoirIss.FI_Code) or
          (SaveAvoirIss.CodeInAccount != AvoirIss.CodeInAccount));
end;

private macro CheckNotPay(
  SaveAvoirIss//:CTxAvoirIss  // Сохраненные параметры анкеты ц/б
 ,AvoirIss//:CTxAvoirIss      // Параметры анкеты ц/б
):Bool
  return ((SaveAvoirIss.Series      != AvoirIss.Series) or
          (SaveAvoirIss.Issue       != AvoirIss.Issue) or
          (SaveAvoirIss.LSIN        != AvoirIss.LSIN) or
          (SaveAvoirIss.ISIN        != AvoirIss.ISIN) or
          (SaveAvoirIss.Tranche     != AvoirIss.Tranche) or
          (SP_GetFIID(SaveAvoirIss.FaceValueFI) != SP_GetFIID(AvoirIss.FaceValueFI)) or
          (SaveAvoirIss.FaceValue   != AvoirIss.FaceValue) or
          (SaveAvoirIss.DrawingDate != AvoirIss.DrawingDate) or
          (SaveAvoirIss.Issued      != AvoirIss.Issued));
end;

private macro CheckCertifExists( FIID:integer ):bool
  var exist:bool = false;

  if( FIID > 0 )
     var query = RSDCommand( " SELECT count(1) InvCardCount FROM dinvcard_dbt ic, dv_ficert_dbt vficert WHERE vficert.t_FiCertID = ic.t_FiCertID AND vficert.t_FIID = ? " );
     query.NullConversion = true;
     query.addParam( "", RSDBP_IN, FIID );
     query.execute();

     var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
     if( ds.MoveNext() )
        exist = (SQL_ConvTypeInteger(ds.InvCardCount) > 0);
     end;

     if( exist == false )
        query = RSDCommand( " SELECT count(1) InvListCount FROM dinvlist_dbt il, dinvcard_dbt ic, dv_ficert_dbt vficert WHERE ic.t_InvCardID = il.t_InvCardID AND vficert.t_FiCertID = ic.t_FiCertID AND vficert.t_FIID = ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, FIID );
        query.execute();

        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           exist = (SQL_ConvTypeInteger(ds.InvListCount) > 0);
        end;
     end;
  end;

  return exist;
end;

private macro AfterChangeAvoirissKind(
  AvoirKind:Integer
  ,AvoirIss // CTxAvoirIss(Параметры анкеты ц/б)
)
  var stat:integer = -1;
  
  if( (not FI_IsAvrKindInvestmentShare( AvoirKind ))
  and (not FI_IsAvrKindHypothecaryCert( AvoirKind )))
     AvoirIss.TaxGroup = GetDefaultNalogGroup(AvoirIss, null);
  end;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

// При вставке записи истории из панели анкеты, если существует запись за более позднюю дату, система выдает сообщение об ошибке
private macro FI_ExistHistoryLater( ValHistList, EndDate:date ):integer

  var RetVal:integer = 0;
  var ValHistCount:integer = 0;
  while( ValHistCount < ValHistList.Size )
     if( (ValHistList[ValHistCount].Action != OperationKind_Delete) and
         (ValHistList[ValHistCount].EndDate > EndDate)
       )
        RetVal = 1964; // В истории существует запись за более позднюю дату
     end;
     ValHistCount = ValHistCount + 1;
  end;

  return RetVal;
end;

macro TxCheckAvoirIss(
  AvoirPanel //:CTxAvoirPanel  // Данные панели ценной бумаги
):WebServiceResponse

  var stat:integer = -1;
  var ResponseBuilder = SP_WebResponseBuilder();
  var query, ds;
  var SaveAvoirIss = CTxAvoirIss();
  var MainFI = TRecHandler( "fininstr.dbt" );
  var MainAvr = TRecHandler( "avoiriss.dbt" );
  var ErrMsg = "";

  // Найдем старый буфер
  if( AvoirPanel.AvoirIss.FIID > 0 )
     SaveAvoirIss = TxGetAvoirIss(AvoirPanel.AvoirIss.FIID);
  end;

  if( AvoirPanel.AvoirIss.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT )
     // Для формы депозитарной расписки при изменении базовой ц/б, нужно обновить связанные поля
     if( AvoirPanel.AvoirIss.ChangedProperty == "ParentFI" )
       PumpDepoRecParentFIIssuer( AvoirPanel.AvoirIss );
     elif( AvoirPanel.AvoirIss.ChangedProperty == "AvoirSubKind" )
       AfterChangeAvoirissKind( AvoirPanel.AvoirIss.AvoirKind, AvoirPanel.AvoirIss );
     end;
  else
     if( AvoirPanel.AvoirIss.ChangedProperty == "Issued" )
        if( (AvoirPanel.AvoirIss.Issued != null)
        and (AvoirPanel.AvoirIss.Issued != ZeroDate)
        and ((AvoirPanel.AvoirIss.InCirculationDate == null)
        or (AvoirPanel.AvoirIss.InCirculationDate == ZeroDate))
        )
          AvoirPanel.AvoirIss.InCirculationDate = AvoirPanel.AvoirIss.Issued;
        end;
     elif(AvoirPanel.AvoirIss.ChangedProperty == "IsIndexNominal" )
        if(AvoirPanel.AvoirIss.IsIndexNominal)
          AvoirPanel.AvoirIss.NKDBase_Kind = CreateNameAlgFromAppServ(3108, 4);
          AvoirPanel.AvoirIss.FaceValue = $0.0;
          AvoirPanel.AvoirIss.FaceValueFI = null;
        end;
     elif(AvoirPanel.AvoirIss.ChangedProperty == "FaceValue" )
        if( (AvoirPanel.AvoirIss.FIID > 0) and (not AvoirPanel.AvoirIss.IsIndexNominal) )
           // !!! Иначе не работает добавление элементов
           AvoirPanel.FaceValues = TArray(AvoirPanel.FaceValues);

           var ValHistCount:integer = 0;
           if( AvoirPanel.AddVFByChangeFaceValue )
              while( ValHistCount < AvoirPanel.FaceValues.Size )
                 if( (AvoirPanel.FaceValues[ValHistCount].Action != OperationKind_Delete) and
                     (AvoirPanel.FaceValues[ValHistCount].Active == true)
                   )
                    AvoirPanel.FaceValues[ValHistCount].Value = AvoirPanel.AvoirIss.FaceValue;
                    break;
                 end;
                 ValHistCount = ValHistCount + 1;
              end;
           else
              var err = FI_ExistHistoryLater(AvoirPanel.FaceValues, ({curdate} - 1));
              if( err == 0 )
                 var Find:bool = false;
                 while( ValHistCount < AvoirPanel.FaceValues.Size )
                    if( (AvoirPanel.FaceValues[ValHistCount].Action != OperationKind_Delete) and
                        (AvoirPanel.FaceValues[ValHistCount].EndDate == ({curdate} - 1))
                      )
                       AvoirPanel.FaceValues[ValHistCount].Value = SaveAvoirIss.FaceValue;
                       Find = true;
                       break;
                    end;
                    ValHistCount = ValHistCount + 1;
                 end;

                 ValHistCount = 0;

                 if( not Find )
                    var avoirValHist = CTxAvoirValHist();

                    avoirValHist.FIID    = AvoirPanel.AvoirIss.FIID;
                    avoirValHist.BegDate = ZeroDate;
                    while( ValHistCount < AvoirPanel.FaceValues.Size )
                       if( (AvoirPanel.FaceValues[ValHistCount].Action != OperationKind_Delete) and
                           (AvoirPanel.FaceValues[ValHistCount].Active == true)
                         )
                          avoirValHist.BegDate = AvoirPanel.FaceValues[ValHistCount].BegDate;
                          AvoirPanel.FaceValues[ValHistCount].BegDate = {curdate};
                          AvoirPanel.FaceValues[ValHistCount].Value   = AvoirPanel.AvoirIss.FaceValue;
                          break;
                       end;
                       ValHistCount = ValHistCount + 1;
                    end;
                    avoirValHist.EndDate = ({curdate} - 1);
                    avoirValHist.Value   = SaveAvoirIss.FaceValue;
                    avoirValHist.ValKind = FI_CHANGE_NOMINAL;
                    avoirValHist.Edit    = true;
                    avoirValHist.Active  = false;
                    avoirValHist.Action  = OperationKind_Insert;
                    avoirValHist.ID      = AvoirPanel.FVLastID;
                    AvoirPanel.FVLastID  = AvoirPanel.FVLastID - 1;
                    avoirValHist.Version = 0;
                  
                    AvoirPanel.FaceValues[AvoirPanel.FaceValues.Size] = avoirValHist;
                  
                    AvoirPanel.AddVFByChangeFaceValue = true;
                 else
                    while( ValHistCount < AvoirPanel.FaceValues.Size )
                       if( (AvoirPanel.FaceValues[ValHistCount].Action != OperationKind_Delete) and
                           (AvoirPanel.FaceValues[ValHistCount].Active == true)
                         )
                          AvoirPanel.FaceValues[ValHistCount].Value = AvoirPanel.AvoirIss.FaceValue;
                          break;
                       end;
                       ValHistCount = ValHistCount + 1;
                    end;
                 end;
              else
                 ResponseBuilder.AddError(err);
              end;
           end;
        end;
     end;
  end;

  if( not CheckTaxDepositoryMode() )

     // CheckAvrDates

     if( not ResponseBuilder.HasErrors() )
        if( (WS_ConvTypeDate(AvoirPanel.AvoirIss.InCirculationDate) != ZeroDate) and (WS_ConvTypeDate(AvoirPanel.AvoirIss.InCirculationDate) < WS_ConvTypeDate(AvoirPanel.AvoirIss.Issued)) )
           // Дата ввода в обращение не должна быть меньше даты выпуска
           ResponseBuilder.AddError( 1455 );
        end;
    
        if( (WS_ConvTypeDate(AvoirPanel.AvoirIss.EndPlacementDate) == ZeroDate) and (WS_ConvTypeDate(AvoirPanel.AvoirIss.EndPlacementDate) < WS_ConvTypeDate(AvoirPanel.AvoirIss.BegPlacementDate)) )
           // Дата окончания размещения должна быть не меньше даты начала размещения
           ResponseBuilder.AddError( 1970 );
        end;
     end;

     if( not ResponseBuilder.HasErrors() )
        if( (WS_ConvTypeDate(AvoirPanel.AvoirIss.DrawingDate) != ZeroDate) and ((WS_ConvTypeDate(AvoirPanel.AvoirIss.DrawingDate) < WS_ConvTypeDate(AvoirPanel.AvoirIss.InCirculationDate)) or (WS_ConvTypeDate(AvoirPanel.AvoirIss.DrawingDate) < WS_ConvTypeDate(AvoirPanel.AvoirIss.Issued))) )
           // Дата погашения не должна быть меньше даты ввода в обращение или выпуска
           ResponseBuilder.AddError( 1456 );
        end;
    
        if( (WS_ConvTypeDate(AvoirPanel.AvoirIss.ExpiryDate) != ZeroDate) and (WS_ConvTypeDate(AvoirPanel.AvoirIss.ExpiryDate) < WS_ConvTypeDate(AvoirPanel.AvoirIss.Issued)) )
           // Дата закрытия не должна быть меньше даты выпуска
           ResponseBuilder.AddError( 1457 );
        end;
     end;

     if( not ResponseBuilder.HasErrors() )
        if( (AvoirPanel.AvoirIss.IsAdditional == true) and (SP_GetFIID(AvoirPanel.AvoirIss.MainFIID) > 0) )
           if( ПолучитьФинИн(SP_GetFIID(AvoirPanel.AvoirIss.MainFIID), MainFI) == 0 )
              if( (WS_ConvTypeDate(AvoirPanel.AvoirIss.Issued) != ZeroDate) and (WS_ConvTypeDate(AvoirPanel.AvoirIss.Issued) < MainFI.rec.Issued) )
                 // Дата выпуска должна быть больше даты основного выпуска
                 ResponseBuilder.AddError( 1934 );
              end;
           end;
        elif( AvoirPanel.AvoirIss.IsAdditional == false )
           if( AvoirPanel.AvoirIss.FIID > 0 )
              query = RSDCommand(" SELECT NVL(MIN(t_Issued), TO_DATE('31.12.9999', 'DD.MM.YYYY')) Issued " +
                                 "   FROM dfininstr_dbt " +
                                 "  WHERE t_MainFIID = ? " );
              query.NullConversion = true;
              query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.FIID );
              query.execute();
              ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
              if( ds.MoveNext() and (SQL_ConvTypeDate(ds.Issued) < WS_ConvTypeDate(AvoirPanel.AvoirIss.Issued)) )
                 // Дата выпуска должна быть меньше наименьшей даты дополнительного выпуска
                 ResponseBuilder.AddError( 1935 );
              end;
           //elif( если создается основной выпуск по дополнительному ) такого ещё нет...
           end;
        end;
     end;

     if( ( AvoirPanel.AvoirIss.FIID > ALLFININSTR ) and ( FI_IsAvrKindBond( AvoirPanel.AvoirIss.AvoirKind ) or FI_IsCouponFI(AvoirPanel.AvoirIss.FIID) ) )
        var size:integer = AvoirPanel.Coupons.Size;
        var i:integer = 0;
        var Warnts;
        if( size > 0 )
           i = 0;
           while( i < size )
              Warnts = AvoirPanel.Coupons[i];

              if( Warnts.Action != OperationKind_Delete )
                 if( WS_ConvTypeDate(AvoirPanel.AvoirIss.Issued) > Warnts.DrawingDate )
                    // Дата погашения одного из купонов меньше даты выпуска
                    ResponseBuilder.AddError( 37051 );
                    break;
                 end;

                 if( (AvoirPanel.AvoirIss.AvoirKind == AVOIRISSKIND_SHARE) or (AvoirPanel.AvoirIss.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT) )
                    if( WS_ConvTypeDate(AvoirPanel.AvoirIss.DrawingDate) < Warnts.DrawingDate )
                       // Дата погашения одного из купонов больше даты погашения
                       ResponseBuilder.AddError( 37052 );
                       break;
                    end;
                 end;
              end;

              i = i + 1;
           end;
        end;
     end;

     // Проверки дат приема на обслуживание и установки статуса обслуживания (только для депозитария)
     // В текущей реализации не предусмотренны

     // MacroCheckListFactDate

     if( not ResponseBuilder.HasErrors() )
        if( (AvoirPanel.AvoirIss.ListDate != null) and (AvoirPanel.AvoirIss.ListDate != ZeroDate) and (AvoirPanel.AvoirIss.ListDate > AvoirPanel.AvoirIss.DrawingDate) )
           // Дата составления перечня не может быть больше даты погашения
           ResponseBuilder.AddError( 37053 );
        end;
     end;
  end;

  // CheckIssueRate

  if( not ResponseBuilder.HasErrors() )
     // лишняя?
     if( (AvoirPanel.AvoirIss.IncomeRate != 0) and (AvoirPanel.AvoirIss.IncomeVolume != 0) )
        // Ставка не должна одновременно быть в % от номинала и в абсолютных величинах
        ResponseBuilder.AddError( 37054 );
     end;
  end;

  // CheckFI_ISIN_LSIN

  if( not ResponseBuilder.HasErrors() )
     if( AvoirPanel.AvoirIss.ISIN != "" )
        query = RSDCommand( " SELECT fi.t_FI_Code, avoir.t_ISIN " +
                            " FROM davoiriss_dbt avoir,  dfininstr_dbt fi " +
                            " WHERE fi.t_FIID = avoir.t_FIID " +
                            "    AND avoir.t_ISIN  = ? " +
                            "    AND avoir.t_FIID != ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.ISIN );
        query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.FIID );
        query.execute();
        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           // Уже есть финансовый инструмент с таким кодом ISIN
           ResponseBuilder.AddErrorEx( 31836, MessageSeverity.ValidationError, GetErrorMsg( 31836 ) + ". Код ц/б " + SQL_ConvTypeStr( ds.FI_Code ) );
        end;
     end;

     if( AvoirPanel.AvoirIss.LSIN != "" )
        query = RSDCommand( " SELECT fi.t_FI_Code, avoir.t_LSIN " +
                            " FROM davoiriss_dbt avoir,  dfininstr_dbt fi " +
                            " WHERE fi.t_FIID = avoir.t_FIID " +
                            "   AND avoir.t_LSIN  = ? " +
                            "    AND avoir.t_FIID != ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.LSIN );
        query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.FIID );
        query.execute();
        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           // Уже есть финансовый инструмент с таким номером госрегистрации
           ResponseBuilder.AddErrorEx( 31837, MessageSeverity.ValidationError, GetErrorMsg( 31837 ) + ". Код ц/б " + SQL_ConvTypeStr( ds.FI_Code ) );
        end;
     end;
  end;

  // CheckUniqueValues

  if( not ResponseBuilder.HasErrors() )
     var IsEmissive:bool = (not FI_IsAvrKindNotEmissive(AvoirPanel.AvoirIss.AvoirSubKind));
     var IsPay:bool = ( (AvoirPanel.AvoirIss.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE) or (AvoirPanel.AvoirIss.AvoirKind == AVOIRISSKIND_HYPOTHECARY_CERT) );

     if( ((IsPay == true) and (CheckPay(SaveAvoirIss, AvoirPanel.AvoirIss))) or ((IsPay == false) and (CheckNotPay(SaveAvoirIss, AvoirPanel.AvoirIss))) )

        // Проверки для паёв не реализуем, т.к. сейчас их нет

        query = RSDCommand( " SELECT fi.t_FI_Code, avoir.t_LSIN, avoir.t_ISIN, fi.t_FaceValue, fi.t_FaceValueFI, avoir.t_Issue, avoir.t_Tranche, avoir.t_Series, fi.t_DrawingDate " +
                            "   FROM davoiriss_dbt avoir, dfininstr_dbt fi " +
                            "  WHERE fi.t_FIID       = avoir.t_FIID " +
                            "    AND fi.t_IsClosed   = chr(0) " +
                            "    AND fi.t_Issuer     = ? " +
                            "    AND fi.t_FI_Kind    = ? " +
                            "    AND fi.t_AvoirKind  = ? " +
                            "    AND fi.t_FIID      != ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, SP_GetPartyID(AvoirPanel.AvoirIss.Issuer));
        query.addParam( "", RSDBP_IN, FIKIND_AVOIRISS );
        query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.AvoirSubKind );
        query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.FIID );
        query.execute();
        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        while( ds.MoveNext() )
           if( IsEmissive or IsPay or (SQL_ConvTypeDate(ds.DrawingDate) == WS_ConvTypeDate(AvoirPanel.AvoirIss.DrawingDate)) )
              if( IsPay )
              elif( (AvoirPanel.AvoirIss.Series == SQL_ConvTypeStr(ds.Series)) and (AvoirPanel.AvoirIss.Issue == SQL_ConvTypeStr(ds.Issue)) and (AvoirPanel.AvoirIss.Tranche == SQL_ConvTypeStr(ds.Tranche)) )
                 if( IsEmissive or ((SQL_ConvTypeInteger(ds.FaceValueFI) == SP_GetFIID(AvoirPanel.AvoirIss.FaceValueFI)) and (SQL_ConvTypeSum(ds.FaceValue) == AvoirPanel.AvoirIss.FaceValue)) )
                    if( IsEmissive )
                       if( (AvoirPanel.AvoirIss.LSIN == "") and (AvoirPanel.AvoirIss.ISIN == "") )
                          if( (SQL_ConvTypeStr(ds.LSIN) == "") and (SQL_ConvTypeStr(ds.ISIN) == "") )
                             // Уже есть анкета эмиссионной ц/б с такими ключевыми параметрами
                             //ResponseBuilder.AddError( 1936 );
                          else
                             if( SQL_ConvTypeStr(ds.LSIN) != "" )
                                // Уже есть анкета эмиссионной ц/б %s с такими ключевыми параметрами и заданным номером гос. регистрации
                                // TODO Убрать когда починят CreateErrMsg();
                                ErrMsg = "Уже есть анкета эмиссионной ц/б " + SQL_ConvTypeStr(ds.FI_Code) + " с такими ключевыми параметрами и заданным номером гос. регистрации";
                                ResponseBuilder.AddErrorEx( 37055, MessageSeverity.Warning, ErrMsg );
                             elif( SQL_ConvTypeStr(ds.ISIN) != "" )
                                // Уже есть анкета эмиссионной ц/б %s с такими ключевыми параметрами и заданным номером ISIN
                                ErrMsg = "Уже есть анкета эмиссионной ц/б " + SQL_ConvTypeStr(ds.FI_Code) + " с такими ключевыми параметрами и заданным номером ISIN";
                                ResponseBuilder.AddErrorEx( 37056, MessageSeverity.Warning, ErrMsg );
                             end;
                          end;
                       elif( (AvoirPanel.AvoirIss.LSIN != "") and (AvoirPanel.AvoirIss.LSIN == SQL_ConvTypeStr(ds.LSIN)) )
                          // Уже есть анкета эмиссионной ц/б с такими ключевыми параметрами
                          ResponseBuilder.AddError( 1936 );
                       elif( (AvoirPanel.AvoirIss.LSIN == "") and (AvoirPanel.AvoirIss.ISIN != "") and (AvoirPanel.AvoirIss.ISIN == SQL_ConvTypeStr(ds.ISIN)) )
                          // Уже есть анкета эмиссионной ц/б с такими ключевыми параметрами
                          ResponseBuilder.AddError( 1936 );
                       elif( (AvoirPanel.AvoirIss.LSIN != "") and (SQL_ConvTypeStr(ds.LSIN) == "") and (AvoirPanel.AvoirIss.AvoirKind != AVOIRISSKIND_BASKET) )
                          // Уже есть анкета эмиссионной ц/б %s с такими ключевыми параметрами и не заданным номером ISIN
                          ErrMsg = "Уже есть анкета эмиссионной ц/б " + SQL_ConvTypeStr(ds.FI_Code) + " с такими ключевыми параметрами и не заданным номером ISIN";
                          ResponseBuilder.AddErrorEx( 37058, MessageSeverity.Warning, ErrMsg );
                       elif( (AvoirPanel.AvoirIss.LSIN == "") and (AvoirPanel.AvoirIss.ISIN != "") and (SQL_ConvTypeStr(ds.ISIN) == "") and (AvoirPanel.AvoirIss.AvoirKind != AVOIRISSKIND_BASKET) )
                          // Уже есть анкета эмиссионной ц/б %s с такими ключевыми параметрами и не заданным номером гос. регистрации
                          ErrMsg = "Уже есть анкета эмиссионной ц/б " + SQL_ConvTypeStr(ds.FI_Code) + " с такими ключевыми параметрами и не заданным номером гос. регистрации";
                          ResponseBuilder.AddErrorEx( 37057, MessageSeverity.Warning, ErrMsg );
                       end;
                    else
                        // Уже есть анкета неэмиссионной ц/б с такими ключевыми параметрами
                        ResponseBuilder.AddError( 1931 );
                    end;
                 end;
              end;
           end;
        end;
     end;
  end;

  // Проверка на уникальность кода ФИ

  query = RSDCommand( " SELECT fi.t_FI_CODE " +
                      "   FROM dfininstr_dbt fi " +
                      "  WHERE fi.t_FI_CODE  = ? " +
                      "    AND fi.t_FIID != ? " );
  query.NullConversion = true;
  query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.FI_Code );
  query.addParam( "", RSDBP_IN, AvoirPanel.AvoirIss.FIID );
  query.execute();
  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  if( ds.MoveNext() )
     // Уже есть финансовый инструмент с таким кодом финансового инструмента
     ResponseBuilder.AddError( 37090 );
  end;

  // CheckNotEmissiveFaceValue

  if( not ResponseBuilder.HasErrors() )
     if( FI_IsAvrKindNotEmissive(AvoirPanel.AvoirIss.AvoirSubKind) and (AvoirPanel.AvoirIss.FIID > 0) and CheckCertifExists(AvoirPanel.AvoirIss.FIID) )
        if( ((AvoirPanel.AvoirIss.FaceValue != SaveAvoirIss.FaceValue) and (AvoirPanel.AvoirIss.FaceValue != 0)) or
            ((SP_GetFIID(AvoirPanel.AvoirIss.FaceValueFI) != SP_GetFIID(SaveAvoirIss.FaceValueFI)) and (SP_GetFIID(AvoirPanel.AvoirIss.FaceValueFI) != ALLFININSTR)) )
           // По выпуску присутствуют ИК. Валюту номинала и номинал можно только стереть
           ResponseBuilder.AddError( 1474 );
        end;
     end;
  end;

  // CheckMainAvoiriss

  if( not ResponseBuilder.HasErrors() )
     if( SP_GetFIID(AvoirPanel.AvoirIss.MainFIID) > 0 )
        if( ПолучитьФинИн(SP_GetFIID(AvoirPanel.AvoirIss.MainFIID), MainFI, MainAvr) == 0 )
           if( ( (MainAvr.rec.IncomeRate   == 0) and
                 (MainAvr.rec.IncomeVolume != 0) and
                 (AvoirPanel.AvoirIss.IncomeRate      != 0) and
                 (AvoirPanel.AvoirIss.IncomeVolume    == 0)
               ) or
               ( (MainAvr.rec.IncomeRate   != 0) and
                 (MainAvr.rec.IncomeVolume == 0) and
                 (AvoirPanel.AvoirIss.IncomeRate      == 0) and
                 (AvoirPanel.AvoirIss.IncomeVolume    != 0)
               ) )
              // Не совпадает параметр \"способ задания ставки (%/абс. величина)\" у дополнительного и основного выпуска
              ResponseBuilder.AddError( 37059 );
           elif( (MainAvr.rec.IncomeRate   != AvoirPanel.AvoirIss.IncomeRate) or
                 (MainAvr.rec.IncomeVolume != AvoirPanel.AvoirIss.IncomeVolume) )
              // Не совпадает параметр \"ставка дохода/доход\" у дополнительного и основного выпуска
              ResponseBuilder.AddError( 37060 );
           elif( MainAvr.rec.NKDBase_Kind != SP_GetNameAlgNumberAlg(AvoirPanel.AvoirIss.NKDBase_Kind) )
              // Не совпадает параметр \"базис НКД\" у дополнительного и основного выпуска
              ResponseBuilder.AddError( 37061 );
           elif( MainAvr.rec.NKDRound_Kind != IIF(AvoirPanel.AvoirIss.NKDRoundOne, AVOIRISSNKDROUND_COUPON, AVOIRISSNKDROUND_SUM) )
              // Не совпадает параметр \"округление НКД\" у дополнительного и основного выпуска
              ResponseBuilder.AddError( 37062 );
           elif( MainFI.rec.Point != (AvoirPanel.AvoirIss.FV_Point - DEFAULT_FACEVALUE_POINT) )
              // Не совпадает параметр \"округление номинала\" у дополнительного и основного выпуска
              ResponseBuilder.AddError( 37063 );
           elif( MainFI.rec.Scale != AvoirPanel.AvoirIss.Scale )
              // Не совпадает параметр \"масштаб номинала\" у дополнительного и основного выпуска
              ResponseBuilder.AddError( 37064 );
           elif( MainFI.rec.Settlement_Code != IIF(AvoirPanel.AvoirIss.Certificated, 1, 0) )
              // Не совпадает параметр \"форма выпуска\" у дополнительного и основного выпуска
              ResponseBuilder.AddWarning( 37065 );
           elif( FI_IsQuoted(MainAvr.rec.FIID) != AvoirPanel.AvoirIss.IsQuoted )
              // Не совпадает параметр \"котируемость\" у дополнительного и основного выпуска
              ResponseBuilder.AddWarning( 37066 );
           end;
        else
           // Не найден финансовый инструмент
           ResponseBuilder.AddError( 37067 );
        end;
     end;
  end;

  // FI_CheckIndoorStorage

  if( not ResponseBuilder.HasErrors() )
     if( AvoirPanel.AvoirIss.Non_Certificated and (FI_CheckIndoorStorage(AvoirPanel.AvoirIss.FIID, AvoirPanel.AvoirIss.AvoirSubKind) != 0) )
        // Нельзя устанавливать форму выпуска \"Бездокументарная\" для ц/б,
        // так как для неё имеются л/с или платежи по закрытому хранению
        ResponseBuilder.AddError( 15010 );
     end;
  end;

  if( AvoirPanel.AvoirIss.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT )
    // Для формы депозитарной расписки 
    if( (AvoirPanel.AvoirIss.FaceValueFI == null) or (AvoirPanel.AvoirIss.FaceValueFI.Name == null) )
      ResponseBuilder.AddError( 37121 );  //Укажите валюту выплаты доходов. Если данной валюты нет, укажите в поле валюту страны эмитента
    end;
  end;

  // ПроверитьФинансовыйИнструмент

  if( not ResponseBuilder.HasErrors() )
     if( (AvoirPanel.AvoirIss.FIID > 0)
     and (FI_IsAvrKindNotEmissive(AvoirPanel.AvoirIss.AvoirSubKind) == false)
     and (SP_GetFIID(AvoirPanel.AvoirIss.FaceValueFI) != SP_GetFIID(SaveAvoirIss.FaceValueFI)) )
        if( SP_IsAnyWrtSum(AvoirPanel.AvoirIss.FIID, false) )
           // Данный выпуск учитывается в БО ЦБ, валюта номинала не может быть изменена
           ResponseBuilder.AddError( 37069 );
        end;

        if( SP_IsAnyDelayedDeal(AvoirPanel.AvoirIss.FIID, false) )
           // С данным выпуском в БО ЦБ есть введенные сделки, по которым еще не выполнялись учетные действия. Данные сделки необходимо удалить и ввести новые после изменения валюты номинала ц/б", false);
           ResponseBuilder.AddError( 37070 );
        end;

        if( SP_IsAnyReadyDeal(AvoirPanel.AvoirIss.FIID) )
           // С данным выпуском в БО ЦБ есть сделки на внебалансе. Данные сделки необходимо откатить и ввести новые после изменения валюты номинала ц/б", false);
           ResponseBuilder.AddError( 37071 );
        end;

        if( SP_IsAnyWrtSum(AvoirPanel.AvoirIss.FIID, true) )
           // Данный выпуск учитывается в ДУ, валюта номинала не может быть изменена", false);
           ResponseBuilder.AddError( 37072 );
        end;

        if( SP_IsAnyDelayedDeal(AvoirPanel.AvoirIss.FIID, true) )
           // С данным выпуском есть введенные сделки ДУ, по которым еще не выполнялись учетные действия. Данные сделки необходимо удалить и ввести новые после изменения валюты номинала ц/б", false);
           ResponseBuilder.AddError( 37073 );
        end;

        if( SP_IsAnyReadyDeal(AvoirPanel.AvoirIss.FIID, true) )
           // С данным выпуском есть срочные сделки ДУ на внебалансе. Данные сделки необходимо откатить и ввести новые после изменения валюты номинала ц/б", false);
           ResponseBuilder.AddError( 37074 );
        end;

        if( SP_IsExistAvoirSrv(AvoirPanel.AvoirIss.FIID) )
           // Валюта номинала ц/б не может быть изменена, так как выпуск находится на обслуживании в депозитарии
           ResponseBuilder.AddError( 37075 );
        end;
     end;
  end;

  ResponseBuilder.SetUserObject(AvoirPanel);

  return ResponseBuilder.Result;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

private macro IsCorrectPeriod( 
  period1Code:Integer
 ,period1:Date
 ,period2Code:Integer
 ,period2:Date
 ,commonPeriod:Bool
 ,ResponseBuilder
)
  var stat:Bool = (((period1 != null) and (period1 != ZeroDate)) and ((period2 != null) and (period2 != ZeroDate)));
  var errMsg1:String = "Дата и месяц окончания периода должны быть не меньше даты и месяца начала периода";
  var errMsg2:String = "Дата и месяц начала следующего периода должны быть не меньше даты и месяца окончания предыдущего периода";
  var errMsg3:String = "Введите корректное значение";
  
  if( stat )
    if( period1 > period2 )
      stat = false;
    end;

    if( not stat )
      if( commonPeriod )
        ResponseBuilder.AddErrorEx( period2Code, MessageSeverity.ValidationError, errMsg1 );
      else
        ResponseBuilder.AddErrorEx( period2Code, MessageSeverity.ValidationError, errMsg2 );
      end;
    end;
  else
    if( (period1 == null) or (period1 == ZeroDate) )
      ResponseBuilder.AddErrorEx( period1Code, MessageSeverity.ValidationError, errMsg3 );
    else
      ResponseBuilder.AddErrorEx( period2Code, MessageSeverity.ValidationError, errMsg3 );
    end;
  end;

  return stat;
end;

private macro IsCorrectPeriods( 
  AvoirIss
 ,ResponseBuilder
) 
  if( AvoirIss.CountPeriod > 0 )
    var stat:Bool = IsCorrectPeriod(1, AvoirIss.Periods[0].PeriodStart, 1, AvoirIss.Periods[0].PeriodEnd, true, ResponseBuilder);

    if( stat and (AvoirIss.CountPeriod > 1) )
      stat = IsCorrectPeriod(2, AvoirIss.Periods[1].PeriodStart, 2, AvoirIss.Periods[1].PeriodEnd, true, ResponseBuilder);
      if( stat )
        stat = IsCorrectPeriod(1, AvoirIss.Periods[0].PeriodEnd, 2, AvoirIss.Periods[1].PeriodStart, false, ResponseBuilder);
      end;

      if( stat and (AvoirIss.CountPeriod > 2) )
        stat = IsCorrectPeriod(3, AvoirIss.Periods[2].PeriodStart, 3, AvoirIss.Periods[2].PeriodEnd, true, ResponseBuilder);
        if (stat)
          stat = IsCorrectPeriod(2, AvoirIss.Periods[1].PeriodEnd, 3, AvoirIss.Periods[2].PeriodStart, false, ResponseBuilder);
        end;

        if( stat and (AvoirIss.CountPeriod > 3) )
          stat = IsCorrectPeriod(4, AvoirIss.Periods[3].PeriodStart, 4, AvoirIss.Periods[3].PeriodEnd, true, ResponseBuilder);
          if (stat)
            stat = IsCorrectPeriod(3, AvoirIss.Periods[2].PeriodEnd, 4, AvoirIss.Periods[3].PeriodStart, false, ResponseBuilder);
          end;

          if( stat and (AvoirIss.CountPeriod > 4) )
            stat = IsCorrectPeriod(5, AvoirIss.Periods[4].PeriodStart, 5, AvoirIss.Periods[4].PeriodEnd, true, ResponseBuilder);
            if (stat)
              stat = IsCorrectPeriod(4, AvoirIss.Periods[3].PeriodEnd, 5, AvoirIss.Periods[4].PeriodStart, false, ResponseBuilder);
            end;
          end;
        end;
      end;
    end;
  end;
  
end;

macro TxCheckAvrInvst(
  AvoirIss//:CTxAvrInvst  // Параметры анкеты пая
):WebServiceResponse

  var stat:integer = -1;
  var ResponseBuilder:SP_WebResponseBuilder = SP_WebResponseBuilder();
  var query, ds;
  var SaveAvoirIss = CTxAvrInvst();
  var MainFI = TRecHandler( "fininstr.dbt" );
  var MainAvr = TRecHandler( "avoiriss.dbt" );
  var ErrMsg = "";

  ResponseBuilder.SetUserObject(AvoirIss);

  // CheckUniqueValues
  // FI_ISIN_LSIN FI_CODE FI_CODEINACCOUNT

  if( not ResponseBuilder.HasErrors() )
     if( AvoirIss.ISIN != "" )
        query = RSDCommand( " SELECT avoir.t_ISIN " +
                            "   FROM davoiriss_dbt avoir " +
                            "  WHERE avoir.t_ISIN  = ? " +
                            "    AND avoir.t_FIID != ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, AvoirIss.ISIN );
        query.addParam( "", RSDBP_IN, AvoirIss.FIID );
        query.execute();
        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           // Уже есть финансовый инструмент с таким кодом ISIN
           ResponseBuilder.AddError( 31836 );
        end;
     end;

     if( AvoirIss.LSIN != "" )
        query = RSDCommand( " SELECT avoir.t_LSIN " +
                            "   FROM davoiriss_dbt avoir " +
                            "  WHERE avoir.t_LSIN  = ? " +
                            "    AND avoir.t_FIID != ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, AvoirIss.LSIN );
        query.addParam( "", RSDBP_IN, AvoirIss.FIID );
        query.execute();
        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           // Уже есть финансовый инструмент с таким номером госрегистрации
           ResponseBuilder.AddError( 31837 );
        end;
     end;

     if( AvoirIss.FI_Code != "" )
        query = RSDCommand( " SELECT fi.t_FI_CODE " +
                            "   FROM dfininstr_dbt fi " +
                            "  WHERE fi.t_FI_CODE  = ? " +
                            "    AND fi.t_FIID != ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, AvoirIss.FI_Code );
        query.addParam( "", RSDBP_IN, AvoirIss.FIID );
        query.execute();
        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           // Уже есть финансовый инструмент с таким кодом финансового инструмента
           ResponseBuilder.AddError( 37090 );
        end;
     end;

     if( AvoirIss.CodeInAccount != "" )
        query = RSDCommand( " SELECT fi.t_CODEINACCOUNT " +
                            "   FROM dfininstr_dbt fi " +
                            "  WHERE fi.t_CODEINACCOUNT  = ? "
                            "    AND fi.t_FIID != ? " );
        query.NullConversion = true;
        query.addParam( "", RSDBP_IN, AvoirIss.CodeInAccount );
        query.addParam( "", RSDBP_IN, AvoirIss.FIID );
        query.execute();
        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           // Уже есть финансовый инструмент с таким кодом в счете
           ResponseBuilder.AddError( 37091 );
        end;
     end;

     if( (AvoirIss.RadioButDuration == true) and (AvoirIss.Issued == ZeroDate) )
        //"Необходимо ввести значение даты регистрации фонда"
        ResponseBuilder.AddError( 37114 );
     end;

     // Проверка дат пая 

     if(( AvoirIss.FormPeriodStart != ZeroDate ) and ( AvoirIss.FormPeriodEnd != ZeroDate ) and ( AvoirIss.FormPeriodEnd < AvoirIss.FormPeriodStart ))
       // Окончание срока формирования фонда должно быть не меньше начала срока формирования фонда 
         ResponseBuilder.AddError( 37118 );
     end;

     if(( AvoirIss.FormPeriodStart != ZeroDate ) and ( AvoirIss.FormPeriodEnd != ZeroDate ) and ( AvoirIss.FormDate != ZeroDate ) and 
        (NOT (( AvoirIss.FormPeriodStart <=  AvoirIss.FormDate ) and ( AvoirIss.FormDate <= AvoirIss.FormPeriodEnd ))))
       // Дата формирования фонда должна входить в срок формирования фонда
         ResponseBuilder.AddError( 37119 );
     end;

     if(( AvoirIss.FormDate != ZeroDate ) and ( AvoirIss.ExpiryDate != ZeroDate ) and ( AvoirIss.ExpiryDate < AvoirIss.FormDate ))
       // Дата прекращения фонда должна быть не меньше даты формирования фонда
         ResponseBuilder.AddError( 37120 );
     end;

     var ChangedProperty:String = AvoirIss.ChangedProperty;
     if( (ChangedProperty != null)
     and ((ChangedProperty == "CountPeriod")
     or (ChangedProperty == "PeriodStart1")
     or (ChangedProperty == "PeriodEnd1")
     or (ChangedProperty == "PeriodStart2")
     or (ChangedProperty == "PeriodEnd2")
     or (ChangedProperty == "PeriodStart3")
     or (ChangedProperty == "PeriodEnd3")
     or (ChangedProperty == "PeriodStart4")
     or (ChangedProperty == "PeriodEnd4")
     or (ChangedProperty == "PeriodStart5")
     or (ChangedProperty == "PeriodEnd5"))
     )
       IsCorrectPeriods(AvoirIss, ResponseBuilder);
     end;
  end;

  return ResponseBuilder.Result;

OnError( err )
  TxAvoirIssRunError(err, stat);
end;


macro ExistLinkGeneral(
  FIID:Integer
):Bool
  var exist:Bool = false;

  if( FIID > 0 )
    var query = RSDCommand( " SELECT count(1) t_LinkCount FROM dfininstr_dbt WHERE t_GeneralizedFIID = ?" );
    query.NullConversion = true;
    query.addParam( "", RSDBP_IN, FIID );
    query.execute();

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    if( ds.MoveNext() )
      exist = ds.LinkCount > 0;
    end;
  end;

  return exist;
end;

macro ExistLinkAccount(
  FIID:Integer
):Bool
  var exist:Bool = false;

  if( FIID > 0 )
    var query = RSDCommand( " SELECT count(1) t_LinkCount FROM daccount_dbt WHERE t_Code_Currency = ? AND t_chapter = 5 " );
    query.NullConversion = true;
    query.addParam( "", RSDBP_IN, FIID );
    query.execute();

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    if( ds.MoveNext() )
      exist = ds.LinkCount > 0;
    end;
  end;

  return exist;
end;

macro ExistPartialRepayment(
  FIID:Integer
):Bool
  var exist:Bool = false;

  if( FIID > 0 )
    var query = RSDCommand( " SELECT NVL(min(t_DrawingDate), TO_DATE( '01.01.0001', 'DD.MM.YYYY' )) MinDate FROM dfiwarnts_dbt WHERE t_FIID = ? AND t_IsPartial = 'X' " );
    query.NullConversion = true;
    query.addParam( "", RSDBP_IN, FIID );
    query.execute();

    var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
    if( ds.MoveNext() )
      if( ( ds.MinDate != ZeroDate ) and ( ds.MinDate <= {curdate} ) )
        exist = true;
      end;
    end;
  end;

  return exist;
end;

// Рассчитать дату окончания действия договора инвестиционного пая
macro Tx_FI_CalcAVRINVSTEndDate( Calc:bool, Start:date, Duration:integer, Term:integer ):date
  var stat:integer = -1;

  return FI_CalcAVRINVSTEndDate(Calc, Start, Duration, Term);

OnError( err )
  TxAvoirIssRunError(err, stat);
end;

macro TxGetAvoirPayByNumber( FIID:Integer,
                             PayKind:Integer,
                             Number:String,
                             RecNumber:Integer,
                             IsFind:Bool
                           )
  var stat:Integer = -1;
  var Result = TArray();
  var RetVal;

  InitError();

  if( ValType( FIID ) == V_UNDEF )
     RunError( "Не задан обязательный параметр функции: идентификатор ценной бумаги" );
  end;

  if( ValType( PayKind ) == V_UNDEF )
     RunError( "Не задан обязательный параметр функции: вид выплаты" );
  end;

  var Query = " SELECT warnts.* " +
              "   FROM dfiwarnts_dbt warnts " +
              "  WHERE warnts.t_FIID = " + string(FIID) +
              "    AND warnts.t_IsPartial = " + IIF(((PayKind == PayKind_Coupon) or (PayKind == PayKind_Dividend)), "chr(0)", "chr(88)");

  if( (ValType(Number) == V_STRING) and ((Number != "") or (IsFind == true)) )
     if( (ValType(IsFind) == V_BOOL) and (IsFind == true) )
        Query = Query + " AND warnts.t_Number = '" + Number + "' ";
     else
        Query = Query + " AND warnts.t_Number LIKE '%" + Number + "%' ";
     end;
  end;

  if( (ValType(RecNumber) == V_INTEGER) and (RecNumber > 0) )
     Query = Query + " AND ROWNUM < " + String( RecNumber + 1 ) + " ";
  end;

  Query = Query + " ORDER BY warnts.t_DrawingDate ";

  var ds = TRsbDataSet( Query );
  while( ds.MoveNext() )
     var TxAvoirPay = CTxAvoirPay();

     TxAvoirPay.FIID              = SQL_ConvTypeInteger(ds.FIID);
     TxAvoirPay.IsPartial         = IIF(SQL_ConvTypeStr(ds.IsPartial) == "X", true, false);
     TxAvoirPay.Number            = SQL_ConvTypeStr(ds.Number);
     TxAvoirPay.DrawingDate       = SQL_ConvTypeDate(ds.DrawingDate);
     TxAvoirPay.IncomeVolume      = SQL_ConvTypeSum(ds.IncomeVolume);
     TxAvoirPay.IncomeFI          = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.IncomeFI));
     TxAvoirPay.IsClosed          = IIF(SQL_ConvTypeStr(ds.SPIsClosed) == "X", true, false);
     TxAvoirPay.Name              = SQL_ConvTypeStr(ds.Name);
     TxAvoirPay.FirstDate         = SQL_ConvTypeDate(ds.FirstDate);
     TxAvoirPay.ListDate          = SQL_ConvTypeDate(ds.ListDate);
     TxAvoirPay.IncomePoint       = SQL_ConvTypeInteger(ds.IncomePoint);
     TxAvoirPay.IncomeScale       = SQL_ConvTypeInteger(ds.IncomeScale);
     TxAvoirPay.NonRelativeIncome = IIF(SQL_ConvTypeStr(ds.RelativeIncome) == "X", false, true);
     TxAvoirPay.RelativeIncome    = IIF(SQL_ConvTypeStr(ds.RelativeIncome) == "X", true, false);
     TxAvoirPay.IncomeRate        = SQL_ConvTypeSum(ds.IncomeRate);
     TxAvoirPay.AllPartialPercent = 0;
     TxAvoirPay.Definition        = SQL_ConvTypeStr(ds.Definition);
     TxAvoirPay.Action            = 0;
     TxAvoirPay.ID                = SQL_ConvTypeInteger(ds.ID);
     TxAvoirPay.Version           = SQL_ConvTypeInteger(ds.Version);

     if( PayKind == PayKind_Coupon )
        FI_CouponPumpIncomeRateVolume(TxAvoirPay.ID, TxAvoirPay.IncomeVolume, TxAvoirPay.IncomeRate);
     elif( PayKind == PayKind_PartialDischarge )
        var AvoirIss = TxGetAvoirIss(FIID);
        FI_PartialPumpIncomeRateVolume(FIID, AvoirIss.FaceValue, TxAvoirPay.ID, TxAvoirPay.IncomeVolume, TxAvoirPay.IncomeRate, TxAvoirPay.AllPartialPercent);
     end;

     Result[Result.Size] = TxAvoirPay;
  end;

  if( (ValType(IsFind) == V_BOOL) and (IsFind == true) )
     if( Result.size() <= 0 )
        //if( PayKind == PayKind_Coupon )
        //   RunError("Не найден купон c номером '" + Number + "'" );
        //else
        //   RunError("Не найдено ЧП c номером '" + Number + "'" );
        //end;
        RetVal = CTxAvoirPay();
     else
        RetVal = Result[0];
     end;
  else
     RetVal = Result;
  end;

  return RetVal;

OnError( err )
  TxAvoirIssRunError( err, stat );
end;
