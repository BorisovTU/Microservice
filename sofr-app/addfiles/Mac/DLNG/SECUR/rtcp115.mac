/*
$Name:        rtcp115.mac
$Module:      Ценные бумаги
$Description: Операции погашения купона/ЧП. Шаг "Поступление средств от платежного агента"
*/
import InsCarryDoc, "sp_car.mac", "sp_cars.mac", "spserv.mac", "sp_catac.mac", "sp_voop.mac";

macro ExecuteStep( doc , ticket )
  record deal(dl_tick);
  var    FD, dat;

  SetBuff( deal, ticket );
  FD = SPFirstDoc( deal );

  if( ( IsBROKER(FD.Group) ) OR (FD.tick.rec.Flag1 == SET_CHAR) )
     MsgBox("Погашение должно быть не на ОРЦБ, не через брокера");
     return 1;
  end;

  if(FD.tick.rec.CarryWrt == UNSET_CHAR)
    MsgBox("В погашении должен быть установлен признак \"Проводка зачисления средств\"");
    return 1;
  end;

  if( FD.ExistRQMoney(DLRQ_TYPE_PAYMENT) )
     if( ТОСквитовано(FD.GetRQ(DLRQ_TYPE_PAYMENT)) )
        MsgBox("ТО по оплате сквитовано. Вставка шага невозможна");
        return 1;
     end;
  end;

  dat = FD.dl_leg.rec.Maturity;

  if( FD.ExistRQMoney(DLRQ_TYPE_PAYMENT) )
     if( not GetDate( dat,"Введите дату получения средств") ) 
        return 1;
     end;

     if( УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_PAYMENT), DLRQ_STATE_EXEC, dat) != 0 )
        return 1;
     end;
  end;

  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYMENT, DLGR_ACCKIND_BACKOFFICE, dat, DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;

  if( not OprReplanStepPlanDates( FD.GetKindDate(DATE_DEALEEND), dat ) )
     msgbox("Ошибка при попытке переинициализировать дату завершения сделки." );         
     return 1;
  end;

  return 0;
end;
