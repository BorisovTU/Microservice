/*
$Name:        nptxchecknobndfl020.mac
$Module:      Ценные бумаги
$Description: Шаг "Сверка" операции сверки НОБ/НДФЛ
*/

import "nptxsnobverfun.mac";

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

private macro ThisExistFile( _FileName_:string ) : bool
  var FindFileName:string = _FileName_;

  // Если запуск производится в 3-х звенке, то нужно при поиске к имени файла добавлять "$"
  if(index(FindFileName, "$") == 1)
     return ExecExp( "GetFileInfo((FindFileName))" );
  else
     return ExistFile(FindFileName);
  end;
end;

PRIVATE MACRO InsertClient( ClientID )
  var queryInsert = "INSERT INTO DNPTXCHECKCL_TMP ( t_ClientID ) " +
                    "                      VALUES ( ? ) ";

  var cmdInsert = DL_RSDCommand(queryInsert);
      cmdInsert.AddParam(ClientID);
      cmdInsert.ExecuteCMD();
END;

PRIVATE MACRO LoadClientsFromFile(LoadFile)
  var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
  var rc = jvm.callStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");
  var row, firstCol, secondCol, ActiveBook, fileNameLoad, extName, dirName, sheet, excel;
  var Path_AppServ = "";
  var ClientsArr = TArray();

  if((not isStandAlone()) and (index(LoadFile, "$") == 0))
    LoadFile = "$"+LoadFile;
  end;
  
  dirName = splitfile(LoadFile, fileNameLoad, extName);
  fileNameLoad = fileNameLoad + extName;

  if (ThisExistFile(LoadFile))
    if (not isStandAlone()) 
       Path_AppServ = "..\\txtfile\\" + fileNameLoad;
       if (not copyfile("$" + LoadFile, Path_AppServ) )
          msgbox("Ошибка при передаче файла на сервер приложений");
       end;
    end; 
    ActiveBook = rc.openWorkbook("..\\txtfile\\" + fileNameLoad );
    if (not ActiveBook )
       ActiveBook.close();
       ActiveBook = null;
       rc = null;
       MsgBox("Ошибка открытия файла \""  + LoadFile + "\"");
       EndAction(1);
       return 1;
     end;

     ActiveBook.setActiveSheet(0);
     row = 1;

     InitProgress(-1, "Загрузка клиентов из файла", "Загрузка клиентов из файла");
     while (valtype(ActiveBook.getCellValue("A" + row)) != V_UNDEF)
        var PartyID = trim(string(ActiveBook.getCellValue("A" + row)));

        if((PartyID == "") or (PartyID == NULL) or (PartyID == "Undefined"))
          break;
        end;

        PartyID = int(StrSubSt(PartyID," ",""));

        ClientsArr[ClientsArr.size] = PartyID;

        UseProgress(row = row + 1); 
     end;
     RemProgress();

     ActiveBook.close();
     ActiveBook = null;
     rc = null;
     
     if (not isStandAlone()) 
        if (not RemoveFile (Path_AppServ))
           MsgBox("Ошибка удаления с сервера приложений файла " + Path_AppServ);
        end;
     end;
  else
     MsgBox("Файла " + LoadFile + " Не существует");
     return;
  end;
  
  var i = 0;
  while(i < ClientsArr.Size)
    InsertClient( ClientsArr[i] );
    i = i + 1;
  end;
  
OnError(er)
  MsgBox(er.Message);

  if(ActiveBook)
    ActiveBook.Close();
    ActiveBook = null;
  end;

  rc = null;
END;

MACRO ExecuteStep(doc, FDoc, DocKind, ID_Operation, ID_Step)
  var snobver = TRecHandler("nptxsnobver.dbt");
  var err = 0;

  snobver.SetRecordAddr( FDoc );

  SQL_Execute("TRUNCATE TABLE DNPTXCHECK_NDR_SKR_TMP");
  SQL_Execute("TRUNCATE TABLE DNPTXCHECKCL_TMP");

  if(snobver.rec.ByClientsList == SET_CHAR)
    var choice = 1;
    var isTerm = false;
    var filePath = "";
    if (not isStandalone())
      choice = DL_Menu(makeArray("Терминал","Сервер"),"Где ищем файл?");
    end;
    if (choice < 0)
      return Error( "Дальнейшее выполнение операции невозможно, необходимо задать путь к файлу" );
    end;
    if (choice == 0)
      isTerm = true;
    end;
    if (not SelectFile ( FilePath, "*.*", "Выберите файл", 0, isTerm ))
      return Error( "Дальнейшее выполнение операции невозможно, необходимо задать путь к файлу" );
    end;

    LoadClientsFromFile((IIF(isTerm, "$", "") + filePath));
  elif(snobver.rec.ByClient == SET_CHAR)
    InsertClient( snobver.rec.ClientID );
  end;
  
  var query, cmd;
  
  query= " insert into  DNPTXCHECK_NDR_SKR_TMP ( "
  + "  T_ID, T_CLIENTID, T_OPERATION_ID, "
  + "  T_INCOME, T_EXPENSE, T_NOB_NDR, "
  + "  T_NOB_SKR, T_NOB13, T_NOB30, "
  + "  T_NOB15, T_NOB18, T_NOB20, "
  + "  T_NOB22, T_CHECK_NOB, T_NDFL_NDR, "
  + "  T_NDFL_SKR, T_NDFL_13, T_NDFL_30, "
  + "  T_NDFL_15, T_NDFL_18, T_NDFL_20, "
  + "  T_NDFL_22, T_CHECK_NDFL, T_CHECK_STG ) "
  + "WITH objkinds AS (SELECT * "
  + "                   FROM dnptxkind_dbt "
  + "                  WHERE t_Level >= 5), "
  + "    plusgkinds AS (SELECT * "
  + "                     FROM dnptxkind_dbt "
  + "                    WHERE t_Code LIKE 'PlusG%'), "
  + "    minusgkinds AS (SELECT * "
  + "                      FROM dnptxkind_dbt "
  + "                     WHERE t_Code LIKE 'MinusG%'), "
  + "    paidkinds AS (SELECT * "
  + "                    FROM dnptxkind_dbt "
  + "                   WHERE t_Level = 8 "
  + "                     AND t_Code LIKE 'Paid%' "
  + "                     AND INSTR (t_Code, '_15_1') = 0 "
  + "                     AND INSTR (t_Code, '_15_2') = 0 "
  + "                     AND INSTR (t_Code, '_15_9') = 0), "
  + "    repperiod AS (SELECT ? AS BegDate, ? AS EndDate FROM DUAL), "
  + "    allclients AS (SELECT pt.t_PartyID "
  + "                     FROM dparty_dbt pt "
  + "                     WHERE     pt.t_LegalForm = 2 "
  + IIF(((snobver.rec.ByClient == SET_CHAR) or (snobver.rec.ByClientsList == SET_CHAR)), " AND pt.t_PartyID in (select t_ClientID from DNPTXCHECKCL_TMP) ", " ")
  + "                           AND (   EXISTS "
  + "                                      (SELECT /*+index(obj dnptxobj_dbt_idxa)*/ 1 "
  + "                                         FROM objkinds knd, repperiod rp, dnptxobj_dbt obj "
  + "                                        WHERE     obj.t_Client = pt.t_PartyID "
  + "                                              AND obj.t_Date BETWEEN rp.BegDate AND rp.EndDate "
  + "                                              AND obj.t_Kind = knd.t_Element "
  + "                                              AND (obj.T_TECHNICAL = CHR (0) OR obj.T_TECHNICAL IS NULL) "
  + "                                              AND (obj.T_FROMOUTSYST = CHR (0) OR obj.T_FROMOUTSYST IS NULL)) "
  + "                                OR EXISTS "
  + "                                      (SELECT 1 "
  + "                                         FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                                        WHERE     tb.t_ClientID = pt.t_PartyID "
  + "                                              AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                              AND tb.t_StorState = 1 "
  + "                                              AND tb.t_ConfirmState = 1))) "
  + "   SELECT /*+ PARALLEL(4)  enable_parallel_dml */  0, "
  + "          q1.t_PartyID, "
  + "          ?, "
  + "          q1.Income, "
  + "          q1.Expense, "
  + "          q1.nob_ndr, "
  + "          q1.nob_skr, "
  + "          q1.nob_13, "
  + "          q1.nob_30, "
  + "          q1.nob_15, "
  + "          q1.nob_18, "
  + "          q1.nob_20, "
  + "          q1.nob_22, "
  + "          q1.check_nob, "
  + "          q1.ndfl_ndr, "
  + "          q1.ndfl_skr, "
  + "          q1.ndfl_13, "
  + "          q1.ndfl_30, "
  + "          q1.ndfl_15, "
  + "          q1.ndfl_18, "
  + "          q1.ndfl_20, "
  + "          q1.ndfl_22, "
  + "          q1.check_ndfl, "
  + "          (CASE WHEN q1.check_nob <> 0 OR q1.check_ndfl <> 0 THEN "
  + "                 (CASE WHEN EXISTS "
  + "                             (SELECT 1 "
  + "                                FROM repperiod rp, DNPTXSNOBVERTB_DBT snobvertb, DNPTXTOTALBASE_DBT stb "
  + "                               WHERE     snobvertb.t_ClientID = q1.t_PartyID "
  + "                                     AND stb.t_TBID = snobvertb.t_Event_ID "
  + "                                     AND stb.t_ClientID = q1.t_PartyID "
  + "                                     AND stb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate)"
  + "                         THEN CASE WHEN EXISTS "
  + "                             (SELECT 1 "
  + "                                FROM repperiod rp, DNPTXSNOBVERTB_DBT snobvertb, DNPTXTOTALBASE_DBT stb "
  + "                               WHERE     snobvertb.t_ClientID = q1.t_PartyID "
  + "                                     AND snobvertb.T_CHECKED != 'X' "
  + "                                     AND stb.t_TBID = snobvertb.t_Event_ID "
  + "                                     AND stb.t_ClientID = q1.t_PartyID "
  + "                                     AND stb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND RSI_NPTO.IsLastOperVerForEventID(snobvertb.t_Event_ID, snobvertb.t_batchid) = 1) THEN 'расхождения' ELSE CHR(1) END "
  + "                       ELSE 'не найдено' "
  + "                  END) "
  + "              ELSE "
  + "                CHR (1) "
  + "           END) AS check_stg "
  + "     FROM (SELECT q.t_PartyID, "
  + "                  q.Income, "
  + "                  q.Expense, "
  + "                  (q.Income - q.Expense) AS nob_ndr, "
  + "                  q.nob_skr, "
  + "                  q.nob_13, "
  + "                  q.nob_30, "
  + "                  q.nob_15, "
  + "                  q.nob_18, "
  + "                  q.nob_20, "
  + "                  q.nob_22, "
  + "                  ( (q.Income - q.Expense) - q.nob_skr) AS check_nob, "
  + "                  q.ndfl_ndr, "
  + "                  q.ndfl_skr, "
  + "                  q.ndfl_13, "
  + "                  q.ndfl_30, "
  + "                  q.ndfl_15, "
  + "                  q.ndfl_18, "
  + "                  q.ndfl_20, "
  + "                  q.ndfl_22, "
  + "                  (q.ndfl_ndr - q.ndfl_skr) AS check_ndfl "
  + "             FROM (SELECT cl.t_PartyID, "
  + "                          NVL( "
  + "                             (SELECT /*+index(obj_plus dnptxobj_dbt_idxa)*/ "
  + "                                    SUM (obj_plus.t_Sum0) "
  + "                                FROM plusgkinds knd, repperiod rp, dnptxobj_dbt obj_plus "
  + "                               WHERE     obj_plus.t_Client = cl.t_PartyID "
  + "                                     AND obj_plus.t_Date BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND obj_plus.t_Kind = knd.t_Element "
  + "                                     AND (obj_plus.T_TECHNICAL = CHR (0) OR obj_plus.T_TECHNICAL IS NULL) "
  + "                                     AND (obj_plus.T_FROMOUTSYST = CHR (0) OR obj_plus.T_FROMOUTSYST IS NULL) "
  + "                                     AND 1 = (CASE WHEN obj_plus.t_Kind = 600  /*RSI_NPTXC.TXOBJ_PLUSG_1010*/ "
  + "                                                    AND obj_plus.t_Sum0 = NVL( "
  + "                                                               (SELECT /*+ index(obj1 dnptxobj_dbt_idxa)*/ "
  + "                                                                      SUM (obj1.t_Sum0) "
  + "                                                                  FROM dnptxobj_dbt obj1 "
  + "                                                                 WHERE     obj1.t_Client = obj_plus.t_Client "
  + "                                                                       AND obj1.t_Date = obj_plus.t_Date "
  + "                                                                       AND obj1.t_Kind IN (601, 602, 606) "
  + "                                                                       AND obj1.t_AnaliticKind6 = obj_plus.t_AnaliticKind6 "
  + "                                                                       AND obj1.t_Analitic6 = obj_plus.t_Analitic6 "
  + "                                                                       AND obj1.t_OutSystCode = obj_plus.t_OutSystCode "
  + "                                                                       AND obj1.t_OutObjID = obj_plus.t_OutObjID "
  + "                                                                       AND (obj1.t_Technical = CHR (0) OR obj1.t_Technical IS NULL) "
  + "                                                                       AND (obj1.t_FromOutSyst = CHR (0) OR obj1.t_FromOutSyst IS NULL)), "
  + "                                                               0) THEN 0 "
  + "                                                ELSE 1 "
  + "                                             END) "
  + "                                     AND 1 =(CASE WHEN obj_plus.t_Kind = 605 /*RSI_NPTXC.TXOBJ_PLUSG_1011_IIS*/ "
  + "                                                   AND obj_plus.t_Sum0 = NVL( "
  + "                                                               (SELECT /*+ index(obj1 dnptxobj_dbt_idxa)*/ "
  + "                                                                      SUM (obj1.t_Sum0) "
  + "                                                                  FROM dnptxobj_dbt obj1 "
  + "                                                                 WHERE     obj1.t_Client = obj_plus.t_Client "
  + "                                                                       AND obj1.t_Date = obj_plus.t_Date "
  + "                                                                       AND obj1.t_Kind IN (603, 604, 607) "
  + "                                                                       AND obj1.t_AnaliticKind6 = obj_plus.t_AnaliticKind6 "
  + "                                                                       AND obj1.t_Analitic6 = obj_plus.t_Analitic6 "
  + "                                                                       AND obj1.t_OutSystCode = obj_plus.t_OutSystCode "
  + "                                                                       AND obj1.t_OutObjID = obj_plus.t_OutObjID "
  + "                                                                       AND (obj1.t_Technical = CHR (0) OR obj1.t_Technical IS NULL) "
  + "                                                                       AND (obj1.t_FromOutSyst = CHR (0) OR obj1.t_FromOutSyst IS NULL)), "
  + "                                                               0) THEN 0 "
  + "                                                ELSE 1 "
  + "                                             END)), 0) AS Income, "
  + "                          NVL ( "
  + "                             (SELECT /*+index(obj_minus dnptxobj_dbt_idxa)*/ "
  + "                                    SUM (obj_minus.t_Sum0) "
  + "                                FROM minusgkinds knd, repperiod rp, dnptxobj_dbt obj_minus "
  + "                               WHERE     obj_minus.t_Client = cl.t_PartyID "
  + "                                     AND obj_minus.t_Date BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND obj_minus.t_Kind = knd.t_Element "
  + "                                     AND (obj_minus.T_TECHNICAL = CHR (0) OR obj_minus.T_TECHNICAL IS NULL) "
  + "                                     AND (obj_minus.T_FROMOUTSYST = CHR (0) OR obj_minus.T_FROMOUTSYST IS NULL)), 0) AS Expense, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_TaxBaseCurrPay) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE tb.t_ClientID = cl.t_PartyID AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate AND tb.t_StorState = 1), 0) AS nob_skr, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_TaxBaseCurrPay) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 13), 0) AS nob_13, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_TaxBaseCurrPay) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 30), 0) AS nob_30, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_TaxBaseCurrPay) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 15), 0) AS nob_15, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_TaxBaseCurrPay) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 18), 0) AS nob_18, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_TaxBaseCurrPay) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 20), 0) AS nob_20, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_TaxBaseCurrPay) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 22), 0) AS nob_22, "
  + "                          NVL ( "
  + "                             (SELECT /*+index(obj_paid dnptxobj_dbt_idxa)*/ "
  + "                                    SUM (obj_paid.t_Sum0) "
  + "                                FROM paidkinds knd, repperiod rp, dnptxobj_dbt obj_paid "
  + "                               WHERE     obj_paid.t_Client = cl.t_PartyID "
  + "                                     AND obj_paid.t_Date BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND obj_paid.t_Kind = knd.t_Element "
  + "                                     AND (obj_paid.T_TECHNICAL = CHR (0) OR obj_paid.T_TECHNICAL IS NULL) "
  + "                                     AND (obj_paid.T_FROMOUTSYST = CHR (0) OR obj_paid.T_FROMOUTSYST IS NULL)), 0) AS ndfl_ndr, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_HoldPITax) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE tb.t_ClientID = cl.t_PartyID AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate AND tb.t_StorState = 1), 0) AS ndfl_skr, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_HoldPITax) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 13), 0) AS ndfl_13, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_HoldPITax) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 30), 0) AS ndfl_30, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_HoldPITax) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 15), 0) AS ndfl_15, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_HoldPITax) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 18), 0) AS ndfl_18, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_HoldPITax) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 20), 0) AS ndfl_20, "
  + "                          NVL ( "
  + "                             (SELECT SUM (tb.t_HoldPITax) "
  + "                                FROM repperiod rp, DNPTXTOTALBASE_DBT tb "
  + "                               WHERE     tb.t_ClientID = cl.t_PartyID "
  + "                                     AND tb.t_IncDate BETWEEN rp.BegDate AND rp.EndDate "
  + "                                     AND tb.t_StorState = 1 "
  + "                                     AND tb.t_RateHoldPITax = 22), 0) AS ndfl_22 "
  + "                     FROM allclients cl) q) q1 ";


  cmd = RSDCommand(query);
  cmd.AddParam("", RSDBP_IN, snobver.rec.begindate);
  cmd.AddParam("", RSDBP_IN, snobver.rec.enddate);
  cmd.AddParam("", RSDBP_IN, snobver.rec.ID);
  cmd.execute();

  DL_NPTX_InsertCheckNDFL(snobver.rec.ID);

  return err;
END;