/*
$Name:        nptxcalc110.mac
$Module:      Ценные бумаги
$Description: Операция расчета НОБ для НДФЛ. Шаг "Расчет НДР 9 уровня"
*/

/* Операция расчета НОБ для НДФЛ
   Шаг "Расчет НДР 9 уровня"*/
IMPORT "secinter.mac", "nptxcalcfun.mac";

PRIVATE VAR Oper = TRecHandler( "nptxop.dbt" );

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

PRIVATE MACRO RunAction()
  VAR stat = 0, S:money, pBegDate, pEndDate;
  Var pClient, Query, QueryCond, pIIS, DataSet, C2, Messige;

// Определение дат:
   var Year;
   DateSplit(Oper.rec.OperDate, null, null, Year);
   pBegDate = date(1, 1, Year);
   pEndDate = Oper.rec.OperDate;
  
pClient  = Oper.rec.Client;
pIIS = IIF((Oper.rec.IIS == SET_CHAR), 1, 0);

//----- НАЧАЛО--------------
// ----- Start(1)  <TaxFR_OTC>  - Доходы / расходы от купли - продажи ценных бумаг и ч/п, в т.ч.*/

   S = $0.00;
  QueryCond   = "select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_OUT) + 
                "                      THEN -N.t_Sum0 " +
                "                      ELSE  N.t_Sum0 END " +
                                ") " +
                "              ), 0 " +
                "           ) C2 " +
                "  from dnptxobj_dbt N " +
                " where N.t_Client = ? " +
                " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                "   and N.t_Kind IN (" + string(TXOBJ_PLUS_SEC) + ", " + string(TXOBJ_MINUS_SEC) + ")" +
                "   and N.t_Date >= ? " +
                "   and N.t_Date <= ? " +
                "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                "   and N.t_Analitic5 <> " + string(TXGROUP_90) +      
                "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                "   and N.t_Analitic4 IN (" + string(NPTX_FI_CIRCULATE) + ", " + string(NPTX_FI_NOCIRCULATE) + ", " + string(NPTX_FI_LOSTCIRCULATE) + ")" +
                "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010);
                
  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pIIS );  //нет   0  1   
  Query.addParam( pBegDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();

  if( (stat == 0) and DataSet.MoveNext() )
     S = DataSet.C2;
  end;
 stat = DL_NPTX_PutMsg("  ", 50 );
 stat = DL_NPTX_PutMsg("Расчет НОБ за период с" + pBegDate + " - " + pEndDate + ": ", 50 );
 stat = DL_NPTX_PutMsg("  ", 50 );
 stat = DL_NPTX_PutMsg( string("Доходы / расходы от купли - продажи ценных бумаг и ч/п, в т.ч. ":l:80) + string(S:r:15), 50 );
//--------------  Finish (1) --------------

// ---- Start(2)  <TaxFR_market>       обращающихся 
  S = 0;
  QueryCond   = "select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_OUT) + 
                "                      THEN -N.t_Sum0 " +
                "                      ELSE  N.t_Sum0 END " +
                                ") " +
                "              ), 0 " +
                "           ) C2 " +
                "  from dnptxobj_dbt N " +
                " where N.t_Client = ? " +
                " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                "   and N.t_Kind IN (" + string(TXOBJ_PLUS_SEC) + ", " + string(TXOBJ_MINUS_SEC) + ")" +
                "   and N.t_Date >= ? " +
                "   and N.t_Date <= ? " +
                "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                "   and N.t_Analitic5 <> " + string(TXGROUP_90) +      
                "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                "   and N.t_Analitic4 =" + string(NPTX_FI_CIRCULATE) + 
                "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010);
                
  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pIIS );  //нет   0  1   
  Query.addParam( pBegDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();

  if( (stat == 0) and DataSet.MoveNext() )
     S = DataSet.C2;
  end;

  stat = DL_NPTX_PutMsg(string("        обращающихся   ":l:80) + string(S:r:15), 50 );
//--------------  Finish (2) --------------

// ---- Start(3)  <TaxFR_OTC>          не обращающихся    
  S = 0;
  QueryCond   = "select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_OUT) + 
                "                      THEN -N.t_Sum0 " +
                "                      ELSE  N.t_Sum0 END " +
                                ") " +
                "              ), 0 " +
                "           ) C2 " +
                "  from dnptxobj_dbt N " +
                " where N.t_Client = ? " +
                " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                "   and N.t_Kind IN (" + string(TXOBJ_PLUS_SEC) + ", " + string(TXOBJ_MINUS_SEC) + ")" +
                "   and N.t_Date >= ? " +
                "   and N.t_Date <= ? " +
                "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                "   and N.t_Analitic5 <> " + string(TXGROUP_90) +      
                "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                "   and N.t_Analitic4 IN (" + string(NPTX_FI_NOCIRCULATE) + ", " + string(NPTX_FI_LOSTCIRCULATE) + ")" +
                "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010);
                
  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pIIS );  //нет   0  1   
  Query.addParam( pBegDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();

  if( (stat == 0) and DataSet.MoveNext() )
     S = DataSet.C2;
  end;

  stat = DL_NPTX_PutMsg(string( "         не обращающихся   ":l:80) + string(S:r:15), 50 );
//--------------  Finish (3) --------------

// ---- Start(4)----- <TaxFR_Open>            Доходы / расходы по коротким позициям в РЕПО
  S = 0;
  QueryCond   = "select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_OUT) + 
                "                      THEN -N.t_Sum0 " +
                "                      ELSE  N.t_Sum0 END " +
                                ") " +
                "              ), 0 " +
                "           ) C2 " +
                "  from dnptxobj_dbt N " +
                " where N.t_Client = ? " +
                " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                "   and N.t_Kind IN (" + string(TXOBJ_PLUS_SEC_SHORT) + ", " + string(TXOBJ_MINUS_SEC_SHORT) + ")" +
                "   and N.t_Date >= ? " +
                "   and N.t_Date <= ? " ;
/*                "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010); // а если нет ? т.е. ПУСТО*/
                
  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pIIS );
  Query.addParam( pBegDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();

  if( (stat == 0) and DataSet.MoveNext() )
     S = DataSet.C2;
  end;

  stat = DL_NPTX_PutMsg( string("Доходы / расходы по коротким позициям в РЕПО ":l:80) + string(S:r:15), 50 );
//--------------  Finish (4) --------------

// ---- Start(5)----- <RepoTaxRub>     Доходы / расходы по сделкам РЕПО
  S = 0;

  PRIVATE MACRO StrMaxFactDate2()
     return
     " (NVL( (SELECT max(dlrq.t_FactDate) " +
     "  FROM ddlrq_dbt dlrq " + 
     "  WHERE dlrq.t_DocKind    = tick.t_BOfficeKind " +
     "      AND dlrq.t_DocID = tick.t_DealID " +
     "      AND dlrq.t_Type    IN (" + DLRQ_TYPE_DELIVERY + "," + DLRQ_TYPE_PAYMENT + ") " +
     "      AND dlrq.t_DealPart    = " + LEG_KIND_DL_TICK_BACK + 
     "      AND dlrq.t_State = " + DLRQ_STATE_EXEC +
     "      AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
     "      ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
     " ) ";
  END;

  QueryCond   = "select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_OUT) + 
                "                      THEN -N.t_Sum0 " +
                "                      ELSE  N.t_Sum0 END " +
                                ") " +
                "              ), 0 " +
                "           ) C2 " +
                "  from dnptxobj_dbt N " +
                " where N.t_Client = ? " +
                " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                "     and N.t_Kind IN (" + string(TXOBJ_PROCREPOTAX)/* + ", " + string(TXOBJ_COM)*/ + ")" +
                "   and N.t_Date >= ? " +
                "   and N.t_Date <= ? ";
                
  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pIIS );
  Query.addParam( pBegDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();

  if( (stat == 0) and DataSet.MoveNext() )
     S = DataSet.C2;
  end;

  var AddWhereCond = " (select count(1) "+
                     "    from dnptxobj_dbt obj_1 "+
                     "   where obj_1.t_AnaliticKind1 = obj.t_AnaliticKind1 "+
                     "     and obj_1.t_Analitic1 = obj.t_Analitic1 "+
                     "     and obj_1.t_Date >= "+GetSQLDate(pBegDate)+
                     "     and obj_1.t_Date <= "+GetSQLDate(pEndDate)+
                     "     and obj_1.t_Client = obj.t_Client "+
                     "     and Exists(select 1 " +
                     "                  from ddl_tick_dbt Tick, doprkoper_dbt Opr " +
                     "                 where Tick.t_DealID = obj_1.t_Analitic1 " + 
                     "                   and Tick.t_BOfficeKind = " + DL_SECURITYDOC +
                     "                   and Opr.t_Kind_Operation = Tick.t_DealType " + 
                     "                   and Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(Opr.t_SysTypes)) = 1 "
                     "                   and ("+StrMaxFactDate2()+" between "+GetSQLDate(pBegDate)+" and "+GetSQLDate(pEndDate)+") " +
                     "               ) " +
                     " ) > 0 ";
  /*здесь дату НДР вида TXOBJ_COM не проверяем, т.к. по процентам НДР формируется в дату второй части, а комиссия чаще всего в дату первой*/
  S = S - GetRubSumByClient(pClient, string(TXOBJ_COM), null, null, TXOBJ_DIR_OUT, pIIS, null, AddWhereCond);


  stat = DL_NPTX_PutMsg( string("Доходы / расходы по сделкам РЕПО ":l:80) + string(S:r:15), 50 );
//--------------  Finish (5) --------------

// ---- Start(6)----- <DerivTaxRub>    Доходы / расходы по сделкам с ПИ
  S = 0;
  QueryCond   = "select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_OUT) + 
                "                      THEN -N.t_Sum0 " +
                "                      ELSE  N.t_Sum0 END " +
                                ") " +
                "              ), 0 " +
                "           ) C2 " +
                "  from dnptxobj_dbt N " +
                " where N.t_Client = ? " +
                " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                "   and N.t_Kind IN (" + string(TXOBJ_PLUS_SEC) + ", " + string(TXOBJ_MINUS_SEC) + ")" +
                "   and N.t_Date >= ? " +
                "   and N.t_Date <= ? " +
                "   and N.t_Analitic5 IN (" + string(TXGROUP_80) + ", " + string(TXGROUP_90) + ")" +
                "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010);

  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pIIS );
  Query.addParam( pBegDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();

  if( (stat == 0) and DataSet.MoveNext() )
     S = DataSet.C2;
  end;

  stat = DL_NPTX_PutMsg( string("Доходы / расходы по сделкам с ПИ ":l:80) + string(S:r:15), 50 );
//--------------  Finish (6) --------------

// ---- Start(7)-----  <BaseMaterial>  Материальная выгода по покупкам
S = 0;

  QueryCond   = "select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_OUT) + 
                "                      THEN -N.t_Sum0 " +
                "                      ELSE  N.t_Sum0 END " +
                                ") " +
                "              ), 0 " +
                "           ) C2 " +
                "  from dnptxobj_dbt N " +
                " where N.t_Client = ? " +
                " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                "   and N.t_Kind = " + string(TXOBJ_BASEMATERIAL) +
                "   and N.t_Date >= ? " +
                "   and N.t_Date <= ? ";
                

  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pIIS );
  Query.addParam( pBegDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();

  if( (stat == 0) and DataSet.MoveNext() )
     S = DataSet.C2;
  end;

  stat = DL_NPTX_PutMsg( string("Материальная выгода по покупкам ":l:80) + string(S:r:15), 50 );
//--------------  Finish (7) --------------

// ---- Start(8)-----  <TaxBase>               Налоговая база по операциям с ценными бумагами и производными инструментами 


    stat = DL_NPTX_PutMsg( string("Налоговая база по операциям с ценными бумагами и ":l:80) , 50 );
    stat = DL_NPTX_PutMsg( string("производными инструментами ":l:80) + string(Oper.rec.TaxBase:r:15), 50 );
//--------------  Finish (8) --------------

// ---- Start(9)-----  <TaxRateGeneral>        Налоговая ставка - %    Rs
var Rg, Rs, Rp=0.0, RR : Integer, RRP:integer;
  if( DL_GetPartyResident(pClient) == NPTXPARTY_RESIDENT ) //резидент
     Rg = 0.13;
     Rs = 0.09;
     if(pEndDate >= date(1,1,2021))
       Rp = 0.15;
     end;
  else
     Rg = 0.30;
     Rs = 0.15;
  end;
  RR=Rg*100;
  RRP=Rp*100;

    stat = DL_NPTX_PutMsg( string("Налоговая ставка - %":l:80)+string(RR:r:14) +"%" , 50 ); // ?? 13%

    if(pEndDate >= date(1,1,2021))
      stat = DL_NPTX_PutMsg( string("Повышенная ставка - %":l:80)+string(RRP:r:14) +"%" , 50 ); // ?? 15%
    end;
//--------------  Finish (9) --------------

// ---- Start(10)-----  <TaxDueNow1>           Сумма налога, подлежащая перечислению в бюджет налоговым агентом, руб. 
var  Bg=0, Bm=0, Bs=0, Bp = $0, Pg=0, Pm=0, Ps=0, Pp = $0, TaxDueYear, TaxPaid, TaxDueNow1, TaxDueGeneral, TaxDue_15;
var Bg1=$0, Bg2=$0, Bg3=$0, Bg4=$0, Bg5=$0, Bg6=$0, Bg7=$0, Bg8=$0, Bg9=$0;
var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";                     
  var AddWhereFromOut = " obj.t_FromOutSyst = 'X'";

  if((pEndDate >= date(1,1,2021)) and (DL_GetPartyResident(pClient) == NPTXPARTY_RESIDENT))
    if(pIIS == 1)
       Bg5 = GetRubSumByClient(pClient, string(TXOBJ_BASEG5), pBegDate, pEndDate, null, pIIS);
       Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_IIS), pBegDate, pEndDate, null, pIIS);

       Pg = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, NULL/*pEndDate*/, DL_HOLDNDFL, null, pIIS) + //созданные в операциях удержания НДФЛ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, DL_WRTMONEY, null, pIIS) + //созданные в операциях списания денежных средств
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, DL_RETIREMENT_OWN,null, pIIS) + //созданные в операциях погашения ОЭБ
            /*плюс операции в ПС <Векселя банка>*/
            GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                    string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                    string(DL_VSINTERCHANGE) );      //зачет взаимных требований


       Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate, 0 /*только пользовательские*/,null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), NULL, NULL, DL_HOLDNDFL, NULL, pIIS) + //созданные в операциях удержания НДФЛ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate, DL_RETIREMENT_OWN,null, pIIS) + //созданные в операциях погашения ОЭБ
            /*плюс операции в ПС <Векселя банка>*/
            GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                    string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                    string(DL_VSINTERCHANGE) );      //зачет взаимных требований


       Pp = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, NULL /*pEndDate*/, DL_HOLDNDFL, null, pIIS) + //созданные в операциях удержания НДФЛ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, DL_WRTMONEY, null, pIIS) + //созданные в операциях списания денежных средств
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, DL_RETIREMENT_OWN,null, pIIS) + //созданные в операциях погашения ОЭБ
            /*плюс операции в ПС <Векселя банка>*/
            GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                       string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                       string(DL_VSINTERCHANGE) );      //зачет взаимных требований

    else
       Bg1 = GetRubSumByClient(pClient, string(TXOBJ_BASEG1), pBegDate, pEndDate, null, pIIS);
       Bg2 = GetRubSumByClient(pClient, string(TXOBJ_BASEG2), pBegDate, pEndDate, null, pIIS);
       Bg3 = GetRubSumByClient(pClient, string(TXOBJ_BASEG3), pBegDate, pEndDate, null, pIIS);
       Bg4 = GetRubSumByClient(pClient, string(TXOBJ_BASEG4), pBegDate, pEndDate, null, pIIS);
       Bg6 = GetRubSumByClient(pClient, string(TXOBJ_BASEG6), pBegDate, pEndDate, null, pIIS);
       Bg7 = GetRubSumByClient(pClient, string(TXOBJ_BASEG7), pBegDate, pEndDate, null, pIIS);
       Bg8 = GetRubSumByClient(pClient, string(TXOBJ_BASEG8), pBegDate, pEndDate, null, pIIS);
       Bg9 = GetRubSumByClient(pClient, string(TXOBJ_BASEG9), pBegDate, pEndDate, null, pIIS);

       Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL), pBegDate, pEndDate, null, pIIS);

       Pg = GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL, pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) + //Пользовательские любые
            GetRubSumByClientOperDocKind(pClient, TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS, AddWhereNotOut) + //Пользовательские НЕ внешние
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, date(1, 1, Year), NULL /*pEndDate*/, DL_HOLDNDFL, NULL, pIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, date(1, 1, Year), pEndDate, DL_WRTMONEY, NULL, pIIS) + //созданные в операциях списания денежных средств с T_PREVDATE такой же, как и текушей операции
            GetRubSumByClientFromDepo(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, pBegDate, pEndDate)+ //созданные в операции "Расчет и начисление дохода" в депозитарии
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, pBegDate, pEndDate, DL_RETIREMENT_OWN,null, pIIS) + //созданные в операциях погашения ОЭБ
            /*плюс операции в ПС <Векселя банка>*/
            GetRubSumByClientFromVeksel(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, pBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                                                                                                       string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                                                                                                       string(DL_VSINTERCHANGE) );      //зачет взаимных требований

      
       Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), pBegDate, pEndDate, 0 /*только пользовательские*/,null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), NULL, NULL, DL_HOLDNDFL, NULL, pIIS) + //созданные в операциях удержания НДФЛ
            GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDSPECIAL), pBegDate, pEndDate) + //созданные в операции "Расчет и начисление дохода" в депозитарии
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), pBegDate, pEndDate, DL_RETIREMENT_OWN,null, pIIS) + //созданные в операциях погашения ОЭБ
            /*плюс операции в ПС <Векселя банка>*/
            GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), pBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                                     string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                                     string(DL_VSINTERCHANGE) );      //зачет взаимных требований


       Pp = GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, pBegDate, pEndDate, DL_CALCNDFL,null, pIIS, AddWhereNotOut) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS, AddWhereNotOut) +
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, date(1, 1, Year), NULL /*pEndDate*/, DL_HOLDNDFL, NULL, pIIS, AddWhereNotOut) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, date(1, 1, Year), pEndDate, DL_WRTMONEY, NULL, pIIS, AddWhereNotOut) + //созданные в операциях списания денежных средств с T_PREVDATE такой же, как и текушей операции
            GetRubSumByClientFromDepo(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0, pBegDate, pEndDate) +//созданные в операции "Расчет и начисление дохода" в депозитарии
            GetRubSumByClient(pClient, string(TXOBJ_PAIDGENERAL_15), pBegDate, pEndDate, null, pIIS, null, AddWhereFromOut) + 
            GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, pBegDate, pEndDate, DL_RETIREMENT_OWN,null, pIIS) + //созданные в операциях погашения ОЭБ
            /*плюс операции в ПС <Векселя банка>*/
            GetRubSumByClientFromVeksel(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, pBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                                                       string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                                                       string(DL_VSINTERCHANGE) );      //зачет взаимных требований
    end;

    Bg =   Min(Bg1, NPTX_LIMINCOME_MAX15)
         + Min(Bg2, NPTX_LIMINCOME_MAX15)
         + Min(Bg3, NPTX_LIMINCOME_MAX15)
         + Min(Bg4, NPTX_LIMINCOME_MAX15)
         + Min(Bg5, NPTX_LIMINCOME_MAX15)
         + Min(Bg6, NPTX_LIMINCOME_MAX15)
         + Min(Bg7, NPTX_LIMINCOME_MAX15)
         + Min(Bg8, NPTX_LIMINCOME_MAX15)
         + Min(Bg9, NPTX_LIMINCOME_MAX15);

    Bp =   Max(Bg1-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg2-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg3-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg4-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg5-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg6-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg7-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg8-NPTX_LIMINCOME_MAX15, $0)
         + Max(Bg9-NPTX_LIMINCOME_MAX15, $0);
  else

    if(pIIS == 1)
       Bg = GetRubSumByClient(pClient, string(TXOBJ_BASEGENERAL_IIS), pBegDate, pEndDate, null, pIIS);
       Bm = GetRubSumByClient(pClient, string(TXOBJ_BASEMATERIAL_IIS), pBegDate, pEndDate, null, pIIS);
       Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_IIS), pBegDate, pEndDate, null, pIIS);


       Pg = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDGENERAL_IIS), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии

       Pm = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL_IIS), pBegDate, pEndDate, DL_CALCNDFL, null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL_IIS), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL_IIS), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS)+  //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDMATERIAL_IIS), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии    

       Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate, 0 /*только пользовательские*/,null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS)+ //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDSPECIAL_IIS), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии

       Pp = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии

    else
       Bg = GetRubSumByClient(pClient, string(TXOBJ_BASEGENERAL), pBegDate, pEndDate, null, pIIS);
       Bm = GetRubSumByClient(pClient, string(TXOBJ_BASEMATERIAL), pBegDate, pEndDate, null, pIIS);
       Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL), pBegDate, pEndDate, null, pIIS);

       Pg = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDGENERAL), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии
      
       Pm = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL), pBegDate, pEndDate, DL_CALCNDFL, null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS)+  //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDMATERIAL), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии    
      
       Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL), pBegDate, pEndDate, 0 /*только пользовательские*/,null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS)+ //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDSPECIAL), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии

       Pp = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15), pBegDate, pEndDate, DL_CALCNDFL,null, pIIS) + //созданные в операциях расчета НОБ
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15), pBegDate, pEndDate, 0 /*только пользовательские*/, null, pIIS) +
            GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15), pBegDate, pEndDate, DL_HOLDNDFL, pBegDate, pIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текущей операции
            IIF( (pIIS==1), 0, GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDGENERAL_15), pBegDate, pEndDate) ); //созданные в операции "Расчет и начисление дохода" в депозитарии
    end;
  end;

  TaxDueYear = Bs * Rs + ( Bg + Bm ) * Rg + Bp * Rp;
  TaxPaid    = Pg + Pm + Ps + Pp; 

  if(pEndDate >= date(1,1,2021))
    TaxDueGeneral = Bg * Rg;
    TaxDue_15     = Bp * Rp;

    stat = DL_NPTX_PutMsg( string("Сумма налога, рассчитанная по основной ставке, руб":l:80)+ string(TaxDueGeneral:r:15) , 50 );
    stat = DL_NPTX_PutMsg( string("Сумма налога, рассчитанная по повышенной ставке, руб":l:80)+ string(TaxDue_15:r:15) , 50 );
  end;

  //  TaxDueNow1 = TaxDueYear - TaxPaid;
  TaxDueNow1 = round(TaxDueYear,0);

  stat = DL_NPTX_PutMsg( string("Сумма налога, подлежащая перечислению в бюджет налоговым агентом, руб":l:80)+ string(TaxDueNow1:r:15) , 50 ); 
  stat = DL_NPTX_PutMsg( string("(без учета вывода денежных средств).":l:80) , 50 ); 
//--------------  Finish (10) --------------

//---------------------------------Список сделок--------------------
  stat = DL_NPTX_PutMsg( string("") , 50 ); 
  stat = DL_NPTX_PutMsg( string("Список сделок, участвовавших в расчете НОБ за дату операции:":l:80) , 50 ); 
  stat = DL_NPTX_PutMsg( string("") , 50 ); 

  stat = DL_NPTX_PutMsg( string("┌─────────────────────┬────────────┬─────────────────────────────┬───────────────────┐") , 50 ); 
  stat = DL_NPTX_PutMsg( string("│       Код ФИ        │    Вид     │   Номер сделки / операции   │  Дата заключения  │") , 50 ); 
  stat = DL_NPTX_PutMsg( string("│                     │  операции  │                             │                   │") , 50 ); 
  stat = DL_NPTX_PutMsg( string("│                     │            │                             │                   │") , 50 ); 
  stat = DL_NPTX_PutMsg( string("├─────────────────────┼────────────┼─────────────────────────────┼───────────────────┤") , 50 ); 
  stat = DL_NPTX_PutMsg( string("│          1          │     2      │              3              │         4         │") , 50 ); 
  stat = DL_NPTX_PutMsg( string("├─────────────────────┼────────────┼─────────────────────────────┼───────────────────┤") , 50 ); 



// (!) Запрос для списка сделок
  QueryCond   = "SELECT F_Instr.t_FI_CODE SecCode,"  
              + "  CASE WHEN Lot.t_Kind =" + string(NPTXLOTS_BUY)  
              + "                      THEN 'B' " 
              + "       WHEN Lot.t_Kind = " + string(NPTXLOTS_SALE)  
              + "                      THEN 'S' " 
              + "       WHEN Lot.t_Kind IN (" + string(NPTXLOTS_REPO) + ","+ string(NPTXLOTS_LOANPUT) + ")"
              + "                      THEN 'RR' " 
              + "       WHEN Lot.t_Kind IN (" + string(NPTXLOTS_BACKREPO) + ","+ string(NPTXLOTS_LOANGET) + ")"
              + "                      THEN 'DR' " 
              + "                      ELSE '--' "
              + "  END  TypeDeal, " 
              + " Lot.t_DealCode CodeDeal,"
              + " Lot.t_DealDate DZ "
//-------
              + " FROM DNPTXLOT_DBT Lot, DFININSTR_DBT F_Instr" 
              + " WHERE Lot.t_Client = ? " 
              + "  AND Exists( select 1 "
              + "                  from  DNPTXLNK_DBT Link_ex WHERE "
              + "                             (Lot.t_Kind =" + string(NPTXLOTS_BUY) + "  and  Link_ex.T_TYPE=" +string(NPTXLNK_CLPOS)   + "and  Lot.t_ID = Link_ex.t_BuyID and   ?  =  Link_ex.T_DATE)" 
              + "                      OR     (Lot.t_Kind =" + string(NPTXLOTS_SALE) + " and  Link_ex.T_TYPE=" +string(NPTXLNK_DELIVER )+ "and  Lot.t_ID = Link_ex.t_SaleID and  ?  =  Link_ex.T_DATE)" 
              + "                      OR     (Lot.t_Kind IN (" + string(NPTXLOTS_REPO)     + ","+ string(NPTXLOTS_LOANPUT) + ")"    + "and     Lot.t_ID = Link_ex.t_BuyID and   ?  =   Lot.T_BUYDATE)"
              + "                      OR     (Lot.t_Kind IN (" + string(NPTXLOTS_BACKREPO) + ","+ string(NPTXLOTS_LOANGET) + ")"    + "and     Lot.t_ID = Link_ex.t_SaleID and  ?  =   Lot.T_SALEDATE)"
              + "            )"
              + "  AND Lot.t_FIID = F_Instr.t_FIID " ;

  Query = DL_RSDCommand(QueryCond);
  Query.addParam( pClient );
  Query.addParam( pEndDate );
  Query.addParam( pEndDate );
  Query.addParam( pEndDate );
  Query.addParam( pEndDate );

  DataSet = Query.execute();


 while (DataSet.MoveNext())
   stat =   DL_NPTX_PutMsg("│"+ string(DataSet.SecCode:c:21)+"│"+string(DataSet.TypeDeal:c:12)+"│"+string(DataSet.CodeDeal:c:29)+"│"+string(date(DataSet.DZ):c:19:f)+"│" , 50 );
 end;

 stat = DL_NPTX_PutMsg( string("└─────────────────────┴────────────┴─────────────────────────────┴───────────────────┘") , 50 ); 

//----------------------------------------FINISH--------------------
//------------------------------------------------------------------

  return stat;
END;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR Stat = 0;

  Oper.SetRecordAddr( FDoc );

  ClearGTT_DNPTXOBJ_TMP();
  stat = DL_NPTX_PutMsg( "Расчет НДР 9 уровня", 40 );
  if( not stat )
    if(not stat)
      stat = CreateMaterialTaxObjects9(Oper, ID_Step);
    end;

     if(  (Oper.rec.FlagTax) )/*флаг расширенного протокола*/
        stat = RunAction();
     end;


    if(not stat)
      stat = DL_NPTX_StartInsertTaxObject(Oper.rec.ID, ID_Step);
    end;

    DL_NPTX_SaveOperLog( Oper.rec.ID, 110 );
  end;

  return stat;
END;
