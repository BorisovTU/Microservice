/*
$Name:        spdpextr.mac
$Module:      Депозитарий
$Description: Отчет "Выписка об операциях по счету депо"
*/

import deposerv, SFInter, FIInter, CurrInter, cb_sql, opr_depo;
import RsbDataSet;

/* Глава синтетического учета */
private const CHAPT5 = 5;

private const SP_DEPOPER_ADMOPER = 825;
private const OBJTYPE_DEPODOC = 115;
private const ALG_VS_TYPE = 3505; //Виды векселей: Простой/переводной

private const SIDEBALANCE_ACTIVE  = 1, /* Активные счета Депо */
              SIDEBALANCE_PASSIVE = 2; /* Пассивные счета Депо */

PRIVATE CONST POI_MODE = FALSE;

private var depoacnt;

// Параметры выпуска отчета
private var LogOprID,
            dprt_num,
            beg_date,
            end_date,
            owner_id,
            acc_kind,
            depo_acc,
            depo_part,
            correspond_acc,
            correspond_part,
            SecurQual,
            issuer_id,
            avoir_kind,
            avoir_FIID,
            InvCardID,
            Partitions,
            printAcntRest,
            ToExcel,
            RepFormatKind,
            showPawn, 
            mortgagee,
            use_ap;
             
             
const DEPO_ACC_ALL = 0;
const DEPO_ACC_ACTIV = 1;
const DEPO_ACC_PASSIV = 2;

private var HeadTable = "┌───────────────────────────┬──────────────┬─────────────────┬───────────────────────┬────────────────────────────┬─────────────────────────────┬─────────────────────────────┬──────────────┬───────────────────────────────────┐\n"+
                        "│ Номер и дата поручения по │ Тип операции │ Дата исполнения │ Идентификационный код │ Наименование ценной бумаги │ Корреспондирующий л/с депо, │ Наименование корреспондента/│  Количество, │     Дополнительные параметры      │\n"+
                        "│          журналу          │              │     операции    │  выпуска ценных бумаг │                            │       раздел счета депо     │ Место хранения              │      шт.     │                                   │\n"+
                        "├───────────────────────────┼──────────────┼─────────────────┼───────────────────────┼────────────────────────────┼─────────────────────────────┼─────────────────────────────┼──────────────┼───────────────────────────────────┤\n"+
                        "│             1             │       2      │        3        │           4           │              5             │              6              │              7              │      8       │                 9                 │\n"+
                        "├───────────────────────────┼──────────────┼─────────────────┼───────────────────────┼────────────────────────────┼─────────────────────────────┼─────────────────────────────┼──────────────┼───────────────────────────────────┤";

private var HeadRestTable = "┌───────────────────────────┬───────────────────────┬──────────────────────────────┬────────────────────┬──────────────┐\n"+
                            "│   Финансовый инструмент   │ Описание инструмента  │Г.р./Серия и номер сертификата│       Номинал      │  Количество, │\n"+
                            "│                           │                       │                              │                    │      шт.     │\n"+
                            "├───────────────────────────┼───────────────────────┼──────────────────────────────┼────────────────────┼──────────────┤\n"+
                            "│             1             │           2           │               3              │          4         │       5      │\n"+
                            "├───────────────────────────┼───────────────────────┼──────────────────────────────┼────────────────────┼──────────────┤";

private var tablewidth = Index(HeadTable, "\n");

private class RestData(_Ccy, _Nominal, _Rest)
  var Ccy         = _Ccy;
  var Nominal   = _Nominal;  
  var Rest        = _Rest;       

end;

private class CollectData
  var m_Arr = TArray();
  var m_pos = -1;

  macro Clear()
    m_Arr.size = 0;
    m_pos = -1;
  end;

  private macro find(Ccy)
    var i = 0;

    while(i < m_Arr.size)
      if(m_Arr[i].Ccy == Ccy)
        return i;
      end;
      i = i + 1;
    end;

   return -1; 
  end;

  macro Add(Ccy, Nominal, Rest)
    var i = find(Ccy);

    if(i != -1)
      m_Arr[i].Nominal = m_Arr[i].Nominal + Nominal;
      m_Arr[i].Rest    = m_Arr[i].Rest + Rest;
    else
      m_Arr[m_Arr.size] = RestData(Ccy, Nominal, Rest);
    end;
  end;

  macro Next()
    m_pos = m_pos + 1;
    if(m_pos < m_Arr.size)
      return 1;
    end;

    return 0;
  end;

  macro Ccy()
    if(m_pos != -1)
      return m_Arr[m_pos].Ccy;
    end;
    return "";
  end;

  macro Nominal()
    if(m_pos != -1)
      return m_Arr[m_pos].Nominal;
    end;
    return $0;
  end;

  macro Rest()
    if(m_pos != -1)
      return m_Arr[m_pos].Rest;
    end;
    return $0;
  end;

  Clear();

end;


private macro GetLLVALUES( List, Elem )
  file llvalues("llvalues");

  ClearRecord(llvalues);
  llvalues.List    = List;
  llvalues.Element = Elem;
  if( GetEQ(llvalues) )
    return llvalues.Name;
  end;

  return "-";
end;

PRIVATE MACRO AddLeadNull(NumberStr, TotalLen)
  var str = NumberStr;
  var len = strlen(str);
  var i = 0;

  if(len < TotalLen)
    i = len;
    while(i < TotalLen)
      str = "0" + str;
      i = i + 1;
    end;
  end;

  return str;
END;



private macro ПолучитьТипСчета(Type)
  var query, DataSet;
  var Select;

  query =   " select dpac.t_Name Name " +
            " from ddepoac_dbt dpac " +
            " where dpac.t_ID = ? /*1*/";

  Select = RSDCommand( query );

  Select.AddParam("TypeID",   RSDBP_IN, Type );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  if(DataSet.moveNext())
    return DataSet.Name;
  end;

  return "";
end;


macro GetDepoPartInfo(DepoID, Code:@variant, BriefCode:@variant, Synt:@variant, Blncname:@variant)
  var query, DataSet;
  var Select;
  var Name = "";

  query = " select dpac.t_Name Name, dpac.t_Code Code, dpac.t_BriefCode BriefCode, dpac.t_Synt Synt, blnc.t_Name_Part BlncName" +
          " from ddepoacnt_dbt dpac, dbalance_dbt blnc "
          " where dpac.t_AutoKey = ? /*1*/ " +
          " AND blnc.t_Chapter = " + CHAPT5 +
          " AND blnc.t_INumPlan = 0 " +
          " AND blnc.t_Balance = dpac.t_Synt";

  Select = RSDCommand( query );

  Select.AddParam("DepoID",   RSDBP_IN, DepoID );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  if(DataSet.moveNext())
    Name = string(DataSet.Name);
    Code = string(DataSet.Code); 
    BriefCode = string(DataSet.BriefCode);
    Synt = string(DataSet.Synt);
    Blncname = string(DataSet.BlncName);
  else
    MsgBox("Ошибка поиска данных для раздела счета депо с Autokey = ", DepoID);
  end;

  return Name;
end;


private macro DefineRepParams(end_date)
  var query, DataSet;
  var Select;
  var Name, Code, BriefCode, Synt, Blncname;
  var p = "";
  var cIssuer = NULL;

  if( SecurQual == SECURQUAL_QUAL)
    p = p + "квалифицированные ценные бумаги";
  elif(SecurQual == SECURQUAL_NOQUAL)
    p = p + "неквалифицированные ценные бумаги";
  else
    p = p + "все учтенные ценные бумаги";
  end;

  if(showPawn)
    p = p + ", ценные бумаги в залоге";
  end;

  if(depo_part)
    Name = GetDepoPartInfo(depo_part, @Code, @BriefCode, @Synt, @Blncname);
    p = p + ", по разделу " + Name + " " + Code + " (короткий " + BriefCode + ")";
  else
    if(Partitions)
      p = p + ", по всем разделам";
    end;
  end;

  if(issuer_id != UnknownParty)
    cIssuer = CDPParty(issuer_id, end_date);
    if( cIssuer == NULL )
      msgbox("Не найден эмитент с ID = ", issuer_id);
    else
      p = p + ", по эмитенту " + cIssuer.ShortName();
    end;
  end;

  if(avoir_kind)
    query = " select avrk.t_Name Name " +
            " from davrkinds_dbt avrk " +
            " where avrk.t_FI_Kind = " + FIKIND_AVOIRISS +
            "   AND avrk.t_AvoirKind = ? /*1*/";

    Select = RSDCommand( query );

    Select.AddParam("AvoirKind",   RSDBP_IN, avoir_kind );  /*1*/

    Select.Execute();

    DataSet = TRsbDataSet(Select);
    if(DataSet.moveNext())
      p = p + ", по виду ц/б " + string(DataSet.Name);
    else
      msgbox("Не найден вид ценной бумаги с ID = ", avoir_kind);
    end;
  end;

  if(avoir_FIID != ALLFININSTR)
    p = p + ", по выпуску ц/б " + ПолучитьИмяФинИн(avoir_FIID);
  end;

  if(InvCardID != 0)
    var ic = TBFile("invcard.dbt");
    ic.Clear();
    ic.rec.InvCardID = InvCardID;
    if(ic.GetEQ())
      p = p + ", по ИК №" + ic.rec.Number;
    end;
  end;

  if(correspond_acc)
    Name = GetDepoPartInfo(correspond_acc, @Code, @BriefCode, @Synt, @Blncname);
    p = p + ", по корреспондирующему " + Name + " " + Code + " (короткий " + BriefCode + ")";
  end;

  if(correspond_part)
    Name = GetDepoPartInfo(correspond_part, @Code, @BriefCode, @Synt, @Blncname);
    p = p + ", по разделу " + Name + " " + Code + " (короткий " + BriefCode + ")";
  end;

  if( mortgagee > 0)
    var party  = TBFile("party");
    party.rec.partyID = mortgagee;
    if (party.GetEQ())
      p = p + ", залогодержатель: " + party.rec.ShortName;
    end;
  end;

  return p;
end;


private macro GetCorrAccInfo(ValueDate, FaceAcc, FIID, CorrPartDeponentName:@variant, CorrPartKind:@variant)
  var query, DataSet;
  var Select;
  var CorrPartCode = "";
  var cOwner;

  CorrPartDeponentName = "";

  query = " select dpac.t_Code Code, dpac.t_BriefCode BriefCode, dpac.t_Kind Kind, dpac.t_Owner Owner " +
          " from daccount_dbt acc, ddepoacnt_dbt dpac " +
          " where acc.t_Account = ? /*1*/ " +
          " AND acc.t_Code_Currency = ? /*2*/ " +
          " AND acc.t_Chapter = " + CHAPT5 +
          " AND dpac.t_AutoKey = acc.t_DepoAcc ";

  Select = RSDCommand( query );

  Select.AddParam("Account",   RSDBP_IN, FaceAcc );  /*1*/
  Select.AddParam("CodeCurrency",   RSDBP_IN, FIID );  /*2*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  if(DataSet.moveNext())
    CorrPartCode = string(FaceAcc) + "; " + string(DataSet.Code) + " короткий(" + string(DataSet.BriefCode) + ")";
    CorrPartKind = string(DataSet.Kind);
    cOwner = CDPParty(DataSet.Owner, ValueDate);
    CorrPartDeponentName = cOwner.ShortName();
  end;

  return CorrPartCode;
end;


private macro GetDealNumber(query, DocumentID)
  var DataSet;
  var Select;

  Select = RSDCommand( query );

  Select.AddParam("DocumentID",   RSDBP_IN, DocumentID );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);

  if(DataSet.moveNext())
    return string(DataSet.DealNum);
  end;

  return "";
end;

private macro GetNameMort(DepoPart)
  var query, DataSet;
  var Select;
  Var Name = "";
  query = "  Select pt.t_ShortName Name from dparty_dbt pt where pt.t_PartyID = ( SELECT acap.t_ApartyId "                                                                                                                           
          "  FROM ddepoatvl_dbt atvl, ddpacap_dbt acap, ddpacapau_dbt acapau "                                                                                        
          "  WHERE     atvl.t_IsType = CHR (0) "                                                                                                                     
          "  AND atvl.t_AttrNum = 15 "                                                                                                                             
          "  AND TO_CHAR (acap.t_APartyGround) = atvl.t_Value "                                                                                                     
          "  AND atvl.t_ID = ? "                                                                                                                   
          "  AND acap.t_role = 4 "                                                                                                                                 
          "  AND acapau.t_APID = acap.t_APID "                                                                                                                      
          "  and acapau.t_AUNodeID IN (select ac.t_AutoKey from ddepoacnt_dbt ac start with ac.t_AutoKey = atvl.t_ID connect by ac.t_AutoKey = prior ac.t_Superior) "
          "  and rownum = 1 )";
  Select = RSDCommand( query );

  Select.AddParam("DepoPart",   RSDBP_IN, DepoPart );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  if(DataSet.moveNext())
    Name = DataSet.Name;
  end;
  return Name;

end;
private macro GetAdditionalInfo(SourceDocKind, SourceDocID, IsGlobal, AddDocs:@variant)
  var query, DataSet;
  var Select;
  var query2, DataSet2;
  var Select2;
  var DealNumber = "";

  // Получим перечень документов-приложений к поручению
  AddDocs = "";

  query = " select llv.t_Name, spgr.t_AltXld, spgr.t_SignedDate " +
          " from dspgrdoc_dbt grd, dspground_dbt spgr, dllvalues_dbt llv " +
          " where grd.t_SourceDocKind = ? /*1*/ " +
          "   AND grd.t_SourceDocID = ? /*2*/ " +
          "   AND spgr.t_SPGroundID = grd.t_SPGroundID " +
          "   AND spgr.t_Direction != " + EXITING +
          "   AND llv.t_List = " + OBJTYPE_KINDDOC +
          "   AND llv.t_Element = spgr.t_Kind ";


  Select = RSDCommand( query );

  Select.AddParam("SourceDocKind",   RSDBP_IN, SourceDocKind );  /*1*/
  Select.AddParam("SourceDocID",   RSDBP_IN, SourceDocID );  /*2*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  while(DataSet.moveNext())
    AddDocs = AddDocs + string(DataSet.Name) + " №" + IIF(string(DataSet.AltXld)=="", "б/н", string(DataSet.AltXld)) + " от " + date(DataSet.SignedDate) + "; ";
  end;

  // Получим номер сделки, если поручение импортировано из другого БО
  if( NOT IsGlobal )
    query2 = " select pm.t_DocKind DocKind, pm.t_DocumentID DocID, drpr.t_DocumentKind GrDocKind, drpr.t_DocumentID GrDocID " +
             " from dspdrprop_dbt drpr, dpmpaym_dbt pm " +
             " where drpr.t_DraftID = ? /*1*/ " +
             "   AND pm.t_PaymentID = drpr.t_PaymentID ";


    Select2 = RSDCommand( query2 );

    Select2.AddParam("DraftID",   RSDBP_IN, SourceDocID );  /*1*/

    Select2.Execute();

    DataSet2 = TRsbDataSet(Select2);
    if(DataSet2.moveNext())
      if( DataSet2.DocKind == DL_SETTLEMENT)
        DealNumber = GetDealNumber(" select 'сделка ЦБ-'||comm.t_CommCode DealNum from ddl_comm_dbt comm where comm.t_DocumentID = ? ", DataSet2.DocID)
      elif(DataSet2.DocKind == TS_SETTLEMENT)
        DealNumber = GetDealNumber(" select 'сделка ДУ-'||comm.t_CommCode DealNum from ddl_comm_dbt comm where comm.t_DocumentID = ? ", DataSet2.DocID)
      elif((DataSet2.DocKind == DL_SECURITYDOC) OR 
           (DataSet2.DocKind == DL_RETIREMENT) OR 
           (DataSet2.DocKind == DL_AVRWRT) OR  
           (DataSet2.DocKind == DL_CONVAVR) )
        DealNumber = GetDealNumber(" select 'сделка ЦБ-'||tick.t_DealCode DealNum from ddl_tick_dbt tick where tick.t_DealID = ? ", DataSet2.DocID)
      elif(DataSet2.DocKind == DL_NTGDOC)
        DealNumber = GetDealNumber(" select 'сделка ЦБ-'||nett.t_DealNumber DealNum from ddl_nett_dbt nett where nett.t_NettingID = ? ", DataSet2.DocID)
      elif((DataSet2.DocKind == DL_VATRREPAY) OR 
           (DataSet2.DocKind == DL_VATRUST) OR 
           (DataSet2.DocKind == DL_TRUSTDOC) OR  
           (DataSet2.DocKind == DL_TRUSTAVRWRT) OR  
           (DataSet2.DocKind == DL_TRUSTRETIREMENT) )
        DealNumber = GetDealNumber(" select 'сделка ДУ-'||tick.t_DealCode DealNum from ddl_tick_dbt tick where tick.t_DealID = ? ", DataSet2.DocID)
      elif((DataSet2.DocKind == DL_VAREPAY) OR 
           (DataSet2.DocKind == DL_VEKSELACCOUNTED) OR 
           (DataSet2.DocKind == DL_VAPAWN) OR  
           (DataSet2.DocKind == DL_VAENWR) )
        DealNumber = GetDealNumber(" select 'сделка УВ-'||tick.t_DealCode DealNum from ddl_tick_dbt tick where tick.t_DealID = ? ", DataSet2.DocID)
      elif((DataSet2.DocKind == DL_VEKSELDRAWORDER) OR 
           (DataSet2.DocKind == DL_VEKSELPAWNORDER) OR 
           (DataSet2.DocKind == DL_VSBARTERORDER) OR  
           (DataSet2.DocKind == DL_VSSALE) OR  
           (DataSet2.DocKind == DL_VSSTORAGEORDER) )
        DealNumber = GetDealNumber(" select 'сделка ВБ-'||tick.t_DealCode DealNum from ddl_tick_dbt tick where tick.t_DealID = ? ", DataSet2.DocID)
      end;
    else
      if((DataSet2.GrDocKind == DL_VEKSELORDER) OR
         (DataSet2.GrDocKind == DL_VEKSELDRAWORDER) OR 
         (DataSet2.GrDocKind == DL_VEKSELPAWNORDER) OR
         (DataSet2.GrDocKind == DL_VSBARTERORDER) OR
         (DataSet2.GrDocKind == DL_VSSALE) OR
         (DataSet2.GrDocKind == DL_VSSTORAGEORDER))
         DealNumber = GetDealNumber(" select 'сделка ВБ-'||ord.t_OrderNumber DealNum from ddl_order_dbt ord where ord.t_ContractID = ? ", DataSet2.GrDocID)
      end;
    end;
  end;

  return DealNumber;
end;


private macro DefineOperationType( IsBaseAccDebet, IsBaseAccCredit, KindBaseAcc, KindCorrAcc )

  if((NOT IsBaseAccDebet) AND (NOT IsBaseAccCredit)) // Перемещение в отпете по пассивному счету
    return "Перемещение";
  elif((KindBaseAcc == SIDEBALANCE_ACTIVE) AND (KindCorrAcc == SIDEBALANCE_ACTIVE)) // А-А
    return "Перемещение";
  elif((KindBaseAcc == SIDEBALANCE_PASSIVE) AND (KindCorrAcc == SIDEBALANCE_PASSIVE)) // П-П
    return "Перевод";
  elif(((KindBaseAcc == SIDEBALANCE_ACTIVE) AND (IsBaseAccDebet)) OR
       ((KindBaseAcc == SIDEBALANCE_PASSIVE) AND (NOT IsBaseAccDebet)) ) // А-П
    return "Зачисление";
  else
    return "Списание";
  end;

end;


private macro IsIndoorStorage(AccTrnID, PaymentID:@variant)
  var query, DataSet;
  var Select;
  var IndoorStorage = false;

  query = " select pmpaym.t_PaymentID PaymentID, pmpaym.t_IndoorStorage IndoorStorage " +
          " from dpmpaym_dbt pmpaym, dpmdocs_dbt pmdocs, dacctrn_dbt acctrn " +
          " where acctrn.t_AccTrnID = ? /*1*/ " +
          "   AND pmdocs.t_AccTrnID = acctrn.t_AccTrnID " +
          "   AND pmpaym.t_PaymentID = pmdocs.t_PaymentID ";

  Select = RSDCommand( query );

  Select.AddParam("", RSDBP_IN, AccTrnID );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  if(DataSet.moveNext())
    if(DataSet.IndoorStorage == 1)
      IndoorStorage = true;
    end;
    PaymentID = DataSet.PaymentID;
  end;

  return IndoorStorage;
end;


// Класс подготовки данных для отправки сообщения в RS-Payments
private class DP_ExtrOprMessage(AutoKey)
  private var WillWork = false; // Можно ли работать с сообщением?
  private var Receiver;
  private var extr_head = TBFile("dpaccrep.tmp", "W");
  private var extr_opr = TBFile("dpaccreptrans.tmp", "W");
  private var PartitionsSet = TArray();


  private macro ClearTmpFiles()
    SQL_Execute("DELETE FROM DDPACCREP_TMP", "", false );
    SQL_Execute("DELETE FROM DDPACCREPPART_TMP", "", false );
    SQL_Execute("DELETE FROM DDPACCREPFI_TMP", "", false );
    SQL_Execute("DELETE FROM DDPACCREPTRANS_TMP", "", false );
  end;


  private macro EnableSend(SendInstruction) // Должна вызываться первой, только если отчет выпускается из ИО, по одному счету депо, в попытке решить будет ли отсылаться сообщение
    var Transport;

    if((NOT GetTransport(Transport)) AND (Transport == DPTRANSP_PAYMENTS)) // Если включена работа с RS-Payments
      if(depo_acc > 0 ) // По одному счету депо
        if(NOT FindDpMessageByDraft(extr_head.rec.DraftID, RSPMDK_INFOPER)) // Если сообщение по поручению еще не сформировано
          if(SendInstruction == SET_CHAR) // Если в ИО установлен признак отправки
            WillWork = true;

            ClearTmpFiles();
          end;
        end;
      end;
    end;
  end;


  macro FillFromLogOpr(lo, acnt)
    EnableSend(lo.rec.SendInstruction);
    if(WillWork)
      // extr_head.rec.PrepDate заполняется в С после установки статуса "Закрыта"
      extr_head.rec.StatDate = beg_date;
      extr_head.rec.EndStatDate = end_date;
      extr_head.rec.ReportPeriod = "ADHO";
      extr_head.rec.ReportSize = "DELT";
      extr_head.rec.SafeDepo = acnt.rec.BriefCode;
      if(Partitions)
        extr_head.rec.ExtCons = "Y";
      else
        extr_head.rec.ExtCons = "N";
      end;
      // extr_head.rec.ExtActi заполняется по итогам формирования данных выписки
    end;
  end;


  macro FillFromExGround(spgr)
    if(WillWork)
      Receiver = spgr.rec.Party;

      extr_head.rec.ReceiverBIC = ПолучитьКодСубъекта(spgr.rec.Party, PTCK_SWIFT);
      extr_head.rec.NumRep = spgr.rec.Xld;
    end;
  end;


  private macro GetDraftParms(DraftID, PaymSign:@variant, SettDate:@variant, DealAmount:@variant)
    var query, DataSet;
    var Select;

    query = " SELECT DECODE(t_IsDVP, CHR(0), 'APMT', 'FREE') t_PaymSign, t_SettlementDate, t_DealAmount " +
            " FROM dspdraft_dbt " +
            " WHERE t_AutoKey = ? ";

    Select = DL_RSDCommand( query );

    Select.AddParam(DraftID);  /*1*/

    DataSet = Select.Execute();

    if(DataSet.moveNext())
      PaymSign = DataSet.PaymSign;
      SettDate = DataSet.SettlementDate;
      DealAmount = DataSet.DealAmount;
    end;
  end;


  macro InsertPart(BriefCode)
    if(WillWork)
      PartitionsSet[PartitionsSet.Size] = BriefCode;
    end;
  end;


  macro InsertOpr(DataSet, depoacnt)
    var stat = true;

    if(WillWork)

      extr_opr.Clear();
      extr_opr.rec.DraftID = extr_head.rec.DraftID;
    
      if(Partitions)
        GetDepoPartInfo(DataSet.DepoPart, NULL, @extr_opr.rec.SafeDepoPart);
      else
        extr_opr.rec.SafeDepoPart = extr_head.rec.SafeDepo;
      end;

      extr_opr.rec.FIID         = DataSet.FIID;
      extr_opr.rec.TransID      = DataSet.SourceDocID;
      if(DataSet.PayerAcntRoot == depoacnt.rec.AutoKey)
        extr_opr.rec.DealType = "DELI";
      else
        extr_opr.rec.DealType = "RECE";
      end;

      GetDraftParms(DataSet.SourceDocID, @extr_opr.rec.PaymSign, @extr_opr.rec.SettDate, @extr_opr.rec.PstaSumm);

      extr_opr.rec.EsetDate     = DataSet.ValueDate;
      extr_opr.rec.EsetTime     = time(0,0,0);
      extr_opr.rec.PstaQuant    = DataSet.Amount;
      extr_opr.rec.KindOper     = "SETT";
      extr_opr.rec.SettTime     = time(0,0,0);

      stat = extr_opr.Insert();

      if(not stat)
        msgbox("Ошибка при вставке данных об операции!");
      end;
    end;

    return stat;
  end;


  private macro GetExtActi()
    var query, DataSet;
    var Select;
    var ExtActi = "N";

    query = " SELECT DECODE((SELECT COUNT(1) FROM DDPACCREPPART_TMP part WHERE part.t_DraftID = ?), 0, 'N', 'Y') t_ExtActi " +
            " FROM DUAL ";

    Select = DL_RSDCommand( query );
    Select.AddParam(extr_head.rec.DraftID); /*1*/
    DataSet = Select.Execute();

    if(DataSet.moveNext())
      ExtActi = string(DataSet.ExtActi);
    end;

    return ExtActi;
  end;


  macro Insert()
    var stat = true;
    var query;
    var i;

    if(WillWork)
      // На основе операций собираем список ФИ
      query = " INSERT INTO DDPACCREPFI_TMP (T_DRAFTID, " +
                                           " T_SAFEDEPOPART, " +
                                           " T_FIID, " +
                                           " T_ISSUENAME, " +
                                           " T_ISIN, " +
                                           " T_LSIN, " +
                                           " T_ISSUEOTHRCODEKIND, " +
                                           " T_ISSUEOTHRCODE, " +
                                           " T_ISSUENOMINAL, " +
                                           " T_ISSUENOMCURRENCY) " +
              " SELECT distinct " + extr_head.rec.DraftID + ", "
                     " opr.t_SafeDepoPart, " +
                     " opr.t_FIID, " +
                     " fi.t_Name t_IssueName, " +
                     " avr.t_ISIN t_ISIN, " +
                     " avr.t_LSIN t_LSIN, " +
                     " CASE " +
                       " WHEN rsi_rsbparty.PT_GetPartyCode (" + Receiver + ", 1) = 'НРД' " +
                       " THEN  " +
                          " 'NSD' " +
                        " ELSE " +
                           " CHR (1) " +
                     " END t_IssueOthrCodeKind, " +
                     " CASE " +
                       "  WHEN rsi_rsbparty.PT_GetPartyCode (" + Receiver + ", 1) = 'НРД' " +
                        " THEN " +
                          " NVL((SELECT oc.t_Code " +
                               " FROM DOBJCODE_DBT oc " +
                               " WHERE oc.t_ObjectType = 9 " +
                                 " AND oc.t_CodeKind = 14 " +
                                 " AND oc.t_ObjectID = fi.t_FIID), CHR(1)) " +
                        " ELSE " +
                          " CHR (1) " +
                     " END t_IssueOthrCode, " +
                     " rsi_rsb_fiinstr.FI_GetNominalOnDate (fi.t_FIID, " + GetSQLDate(extr_head.rec.StatDate) + ", 1) t_IssueNominal, " +
                     " (SELECT fvc.t_Ccy FROM dfininstr_dbt fvc WHERE fvc.t_FIID = fi.t_FaceValueFI) t_IssueNomCurrency " +
              " FROM DDPACCREPTRANS_TMP opr, dfininstr_dbt fi,  DAVOIRISS_DBT avr" +
              " WHERE opr.t_DraftID = " + extr_head.rec.DraftID +
                " AND fi.t_FIID = opr.t_FIID " +
                " AND avr.t_FIID = fi.t_FIID ";

      SQL_Execute(query, "", false );

      // Формируем запись о счете или разделах
      query = " INSERT INTO DDPACCREPPART_TMP (T_DRAFTID, T_SAFEDEPOPART, T_PARTACTI) " +
              " SELECT DISTINCT opr.t_DraftID, " +
                              " opr.t_SafeDepoPart, " + 
                              " 'Y' t_PartActi " +
              " FROM DDPACCREPTRANS_TMP opr " +
              " WHERE opr.t_DraftID = " + extr_head.rec.DraftID;

      SQL_Execute(query, "", false );

      // Добавим записи о разделах, по которым операций не нашлось
      i = 0;
      while(i < PartitionsSet.Size)
        query = " INSERT INTO DDPACCREPPART_TMP (T_DRAFTID, T_SAFEDEPOPART, T_PARTACTI) " +
                " SELECT " + extr_head.rec.DraftID + ", '" + PartitionsSet[i] + "', 'N'" +
                " FROM DUAL " +
                " WHERE NOT EXISTS ( SELECT 1 " + 
                                   " FROM DDPACCREPPART_TMP " +
                                   " WHERE T_DRAFTID = " + extr_head.rec.DraftID + " AND T_SAFEDEPOPART = '" + PartitionsSet[i] + "')";

        SQL_Execute(query, "", false );

        i = i + 1;
      end;


      // Дозаполним заголовок выписки - если есть хотя бы одна запись о счете/разделе, значит выписка не пустая
      extr_head.rec.ExtActi = GetExtActi();

      if(extr_head.rec.ExtActi == "N")
        extr_head.rec.ExtCons = "N";
      end;

      // Вставим сам заголовок выписки
      stat = extr_head.Insert();

      if(not stat)
        msgbox("Ошибка при формировании данных сообщения!");
      end;
    end;

    return stat;
  end;


  extr_head.Clear();
  extr_head.rec.DraftID = AutoKey;
end;


PRIVATE VAR RepParmStr =
"Отправитель отчета        ##################################################\n"+
"Получатель отчета         ##################################################\n"+
"Основание выдачи отчета   ##################################################\n"+
"\n"+
"Счет депо                 ##################################################\n"+
"Наименование счета        ##################################################\n"+
"Депонент                  ##################################################\n"+
"Тип счета                 ##################################################\n"+
"\n"+
"Фильтр формирования выписки  #\n\n";

PRIVATE VAR AcntPartDocGroundStr = "###################################################################\n";
PRIVATE VAR AcntDocGroundStr = "#######################################################################################\n\n";
PRIVATE VAR AcntPartStr = "######################################################################################################################################################\n";
PRIVATE VAR MsgNotMoveFIStr  = "###################################################################\n\n";
PRIVATE VAR AcntRestInfoStr = "######################################################################################################################################\n\n";


PRIVATE CLASS (DL_CReportTemplate) DP_SpdpextrRep
  private var depoacnt, DataSet;
  PRIVATE VAR m_RepFormatKindName = "";
  var NeedBreak = false;
  private var ExtrMessage = DP_ExtrOprMessage(LogOprID);

  PRIVATE MACRO PrintMode():INTEGER
     if(ToExcel)
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
    Dl_CallInsertStat(PrintMode()); 
    CreateTotalBook();     
    SetActiveSheet( "Выписка" );
  END;

  PRIVATE MACRO EndReport()
     if(not NeedBreak)
       SaveTotalBook();
       if(POI_MODE)
         SetIsShowAppl(true);
       end;

     else
       m_ObjTemplateXLS.SheetDelete(1);
     end;
  END;

  MACRO CReport_DataExist()
    return not NeedBreak;
  END;

  
  PRIVATE MACRO WriteTableLine() //печать проводки
    var CorrPartKind, CorrPartDeponentName, CorrCode, CorrName, OperationType, Delim;
    var DealNumber, AddDocs, Amount = 0;
    var FICode, FIName;
    var query, DataSetF;
    var Select;
    var DataSetCount;
    var SelectCount;
    var PaymentID;
    var firsttime;
    var move_num;
    
    if(DataSet.PayerAcntRoot)
      CorrCode = GetCorrAccInfo(DataSet.ValueDate, string(DataSet.ReceiverCorrespond_Acc), DataSet.FIID, @CorrPartDeponentName, @CorrPartKind);
      CorrName = CorrPartDeponentName;
    elif(DataSet.ReceiverAcntRoot)
      CorrCode = GetCorrAccInfo(DataSet.ValueDate, string(DataSet.PayerCorrespond_Acc), DataSet.FIID, @CorrPartDeponentName, @CorrPartKind);
      CorrName = CorrPartDeponentName;
    else // В отчете по пассивному счету его нет ни до Дт ни по Кт - это перемещение, нужна информация о старом и новом МХ
      CorrCode = "Старое МХ: " + GetCorrAccInfo(DataSet.ValueDate, string(DataSet.PayerCorrespond_Acc), DataSet.FIID, @CorrPartDeponentName, @CorrPartKind);
      CorrName = "Старое МХ: " + CorrPartDeponentName;
      if(ToExcel)
        Delim = "; ";
      else
        Delim = ";\n";
      end;
      CorrCode = CorrCode + Delim + "Новое МХ: " + GetCorrAccInfo(DataSet.ValueDate, string(DataSet.ReceiverCorrespond_Acc), DataSet.FIID, @CorrPartDeponentName, @CorrPartKind);
      CorrName = CorrName + Delim + "Новое МХ: " + CorrPartDeponentName;
    end;

    OperationType = DefineOperationType(DataSet.PayerAcntRoot == depoacnt.rec.AutoKey, DataSet.ReceiverAcntRoot == depoacnt.rec.AutoKey, depoacnt.Kind, CorrPartKind);

    if(DataSet.PayerAcntRoot == depoacnt.rec.AutoKey) // Списание
      if(depoacnt.Kind == SIDEBALANCE_ACTIVE)
        Amount = DataSet.Amount;
      else
        Amount = -DataSet.Amount;
      end;
    else
      if(depoacnt.Kind == SIDEBALANCE_PASSIVE) // Зачисление или Перемещение в отчете по пассивным
        Amount = DataSet.Amount;
      else
        Amount = -DataSet.Amount;
      end;
    end;

    DealNumber = GetAdditionalInfo(DataSet.SourceDocKind, DataSet.SourceDocID, DataSet.IsGlobal, @AddDocs);
    
    // Если это Инв. Операция по закрытому хранению, то нужно вывести опись сертификатов
    if((NOT DataSet.IsGlobal) AND (DataSet.AccTrnID) AND (IsIndoorStorage(DataSet.AccTrnID, @PaymentID)))
      query = " select vficert.t_Series Series, LTRIM(vficert.t_Number, ' ') Num,  " +
              "        (CASE WHEN RSB_FIInstr.FI_AvrKindsEQ( fi.t_FI_Kind, " + AVOIRISSKIND_MORTGAGE + ", fi.t_AvoirKind) > 0 THEN 1 ELSE 0 END) IsMortgage, " +
              "        (CASE WHEN RSB_FIInstr.FI_AvrKindsEQ( fi.t_FI_Kind, " + AVOIRISSKIND_MORTGAGE + ", fi.t_AvoirKind) > 0 THEN " + 
              "             (select NVL(llv.t_Name, '') || ' №' || DECODE(mort.t_GroundAltXld, chr(1), '', mort.t_GroundAltXld) || ' от ' || DECODE(TO_CHAR(mort.t_GroundSignedDate,'DD.MM.YYYY'), '01.01.0001', '00.00.0000', TO_CHAR(mort.t_GroundSignedDate,'DD.MM.YYYY') ) || ' ' || DECODE(mort.t_GroundIssuePlace, chr(1), '', mort.t_GroundIssuePlace) " +
              "              from dmortgage_dbt mort, dllvalues_dbt llv " +
              "              where mort.t_MortgageID = vficert.t_CertID " +
              "                AND llv.t_List(+) = " + OBJTYPE_KINDDOC +
              "                AND llv.t_Element(+) = mort.t_GroundKind ) END ) Obligation,  " +
              "        fi.t_Name FIName, NVL(party.t_ShortName, CHR(1)) IssuerName, vficert.t_Copies " +
              " from dinvlist_dbt il, dinvcard_dbt ic, dfininstr_dbt fi, " +
              "      dv_ficert_dbt vficert left join dparty_dbt party on party.t_PartyID = vficert.t_Issuer " +
              " where il.t_PaymentID = ? /*1*/ " +
              " AND ic.t_InvCardID = il.t_InvCardID "
              " AND vficert.t_FiCertID = ic.t_FiCertID "
              " AND fi.t_FIID = vficert.t_FIID " +
              " ORDER BY party.t_ShortName, fi.t_Name ";
      
      Select = RSDCommand( query );
      Select.AddParam("PaymentID", RSDBP_IN, PaymentID );  /*1*/
      Select.Execute();
      DataSetF = TRsbDataSet(Select);

      SelectCount = RSDCommand( "SELECT COUNT(1) nRecs FROM (" + query + ")" );
      SelectCount.AddParam("PaymentID", RSDBP_IN, PaymentID );  /*1*/
      SelectCount.Execute();
      DataSetCount = TRsbDataSet(SelectCount);
      DataSetCount.moveNext();
      move_num = DataSetCount.nRecs;

      firsttime = true;
      while(DataSetF.moveNext())
        if(DataSetF.IsMortgage)
          FICode = String(DataSetF.Obligation);
        else
          FICode = String(DataSetF.Series) + " " + String(DataSetF.Num);
        end;

        FIName = String(DataSetF.FIName);
        if(DataSetF.IssuerName != "") 
          FIName = FIName + ", " + String(DataSetF.IssuerName);
        end;

        if(firsttime)
          if(move_num > 1) // Строк описи больше одной - выведем отдельно строку с операцией и первый сертификат
            merge("N1_A4", "N1_A5");
            PrintTableLine( "N1_A1",  "№" + string(DataSet.XLD) + " от " + date(DataSet.RegistrDate),                                    null,
                            "N1_A2",  OperationType,   null,
                            "N1_A3",  date(DataSet.ValueDate),                                                                           null,
                            "N1_A4",  "По описи сертификатов:",                                                                          null,
                            "N1_A6",  CorrCode,     null,
                            "N1_A7",  CorrName,                                                                              null,
                            "N1_A8",  ЧислоCЗаданнойТочностью(Amount, DP_GetPrecision(Amount, DataSet.SumPrecision)),                    null,
                            "N1_A9",  string(AddDocs + DealNumber),                                                                      null
                          );
            PrintTableLine( "N1_A1",  "",     null,
                            "N1_A2",  "",     null,
                            "N1_A3",  "",     null,
                            "N1_A4",  FICode, null,
                            "N1_A5",  FIName, null,
                            "N1_A6",  "",     null,
                            "N1_A7",  "",     null,
                            "N1_A8",  ЧислоCЗаданнойТочностью(DataSetF.Copies, DP_GetPrecision(DataSetF.Copies, DataSet.SumPrecision)),  null,
                            "N1_A9",  "",     null
                          );
          else // Строка описи одна - выведем ее прямо с сертификатом
            PrintTableLine( "N1_A1",  "№" + string(DataSet.XLD) + " от " + date(DataSet.RegistrDate),                                    null,
                            "N1_A2",  OperationType,   null,
                            "N1_A3",  date(DataSet.ValueDate),                                                                           null,
                            "N1_A4",  FICode,                                                                                            null,
                            "N1_A5",  FIName,                                                                                            null,
                            "N1_A6",  CorrCode,     null,
                            "N1_A7",  CorrName,                                                                              null,
                            "N1_A8",  ЧислоCЗаданнойТочностью(Amount, DP_GetPrecision(Amount, DataSet.SumPrecision)),                    null,
                            "N1_A9",  string(AddDocs + DealNumber),                                                                      null
                          );
          end;

          firsttime = false;
        else // выводим очередной сертификат
          PrintTableLine( "N1_A1",  "",     null,
                          "N1_A2",  "",     null,
                          "N1_A3",  "",     null,
                          "N1_A4",  FICode, null,
                          "N1_A5",  FIName, null,
                          "N1_A6",  "",     null,
                          "N1_A7",  "",     null,
                          "N1_A8",  ЧислоCЗаданнойТочностью(DataSetF.Copies, DP_GetPrecision(DataSetF.Copies, DataSet.SumPrecision)),  null,
                          "N1_A9",  "",     null
                        );
        end;
      end;
    else // Просто печатаем строку
      PrintTableLine( "N1_A1",  "№" + string(DataSet.XLD) + " от " + date(DataSet.RegistrDate),                                    null,
                      "N1_A2",  OperationType,   null,
                      "N1_A3",  date(DataSet.ValueDate),                                                                           null,
                      "N1_A4",  string(DataSet.ILSIN),                                                                             null,
                      "N1_A5",  string(DataSet.Fin_Name) + IIF(DataSet.isQualified, "", " (НКЦБ)"),                                null,
                      "N1_A6",  CorrCode,     null,
                      "N1_A7",  CorrName,                                                                              null,
                      "N1_A8",  ЧислоCЗаданнойТочностью(Amount, DP_GetPrecision(Amount, DataSet.SumPrecision)),                    null,
                      "N1_A9",  string(AddDocs + DealNumber),                                                                      null
                    );

      if(NOT DataSet.IsGlobal)
        ExtrMessage.InsertOpr(DataSet, depoacnt);
      end;
    end;
  END;

  PRIVATE MACRO GetAccDocInfo(AccCode)
    var query, DataSet;
    var Select;
    var AccDocInfo = "";

    query = " select sub.t_Name DocName, sf.t_Number DocNumber , sf.t_DateBegin DocDate " +
            " from dsfcontr_dbt sf, dservksub_dbt sub " +
            " where sf.t_ObjectType = " + SF_DEPOACC +
            " AND sf.t_ServKind = " + PTSK_DEPOS +
            " AND sf.t_Object = '" + AccCode + "' " +
            " AND sub.t_ServiceKind = sf.t_ServKind " +
            " AND sub.t_ServiceKindSub = sf.t_ServKindSub";

    Select = RSDCommand( query );

    Select.Execute();

    DataSet = TRsbDataSet(Select);
    if(DataSet.moveNext())
      AccDocInfo = ", " + string(DataSet.DocName) + " №" + string(DataSet.DocNumber) + " от " + Date(DataSet.DocDate) ;
    end;

    return AccDocInfo;
  END;
  
  PRIVATE MACRO RepHeader(code, beg_date, end_date, DepoCount)
     var grXld = "", Reciever = "-", grDoc = "-";
     var logopr = TBFile("splogopr");
     var ground = TBFile("spground");
     var cReceiver, cOwner;
     m_RepFormatKindName = "Выписка";

     if(RepFormatKind > 0)
       m_RepFormatKindName = DL_GetNameAlg( ALG_REPFORMATKIND, RepFormatKind );
     end;


     if( depo_acc <= 0 )
       DP_StdHeaderLO_Ex( null, null, m_RepFormatKindName+" об операциях по счету ДЕПО", LogOprID, DepoCount+1, true, beg_date, end_date, tablewidth, null, null, this, "N1_" );
     else
       DP_StdHeaderLO_Ex( null, null, m_RepFormatKindName+" об операциях по счету ДЕПО", LogOprID, 0, false, beg_date, end_date, tablewidth, null, null, this, "N1_" );
     end;


     /* № и дата очета */
     if (LogOprID != 0)
       logopr.rec.AutoKey = LogOprID;
       if (logopr.GetEQ() )
         ExtrMessage.FillFromLogOpr(logopr, depoacnt);

         ground.rec.SPgroundID = logopr.rec.Draft;
         if (ground.GetEQ())
           grDoc = GetLLVALUES(OBJTYPE_KINDDOC, ground.rec.Kind) + " вх№ " + ground.rec.Xld + " от " + string(ground.rec.RegistrDate:f);
         end;
       end;
       /* получатель */
       ground.KeyNum = 6;
       ground.rec.SourceDocKind = 830;
       ground.rec.SourceDocID = LogOprID;
       ground.rec.Direction = EXITING;
       ground.rec.Division = SelfDivision;
       if (ground.GetEQ())
         ExtrMessage.FillFromExGround(ground);
 
         Reciever = ground.rec.PartyName;
         if(Reciever == "")
           cReceiver = CDPParty( ground.rec.Party, ground.rec.RegistrDate );
           Reciever = cReceiver.Name();
         end;
       else
         Reciever = "-";
       end;

       if(Reciever == "")
         Reciever = "-";
       end;
     end;

     cOwner = CDPParty( depoacnt.rec.Owner, end_date );

     PrintFormatString( RepParmStr,
                    "N1_RepSender", GetPartyName( {OurBank}, true ),
                    "N1_RepReceiver", Reciever,
                    "N1_RepGround", GrDoc,
                    "N1_AcntCode", depoacnt.rec.Code + " (короткий " + depoacnt.rec.BriefCode + ")" + GetAccDocInfo(depoacnt.rec.Code),
                    "N1_AcntName", depoacnt.rec.name,
                    "N1_AcntOwner", cOwner.Name(),
                    "N1_AcntType", ПолучитьТипСчета(depoacnt.rec.Type),
                    "N1_RepFilter", DefineRepParams(end_date)
                  ); 

     CopyAllSheetInTotalBook( NULL, false, "N1_Head", 0 );

  END;

  private macro WriteDepoPartOneDoc(DataSet, IsFirst:@variant, DepoPart)
    var StrDocInfo;

    while(DataSet.moveNext())
      if(IsFirst)
        PrintFormatString( AcntPartDocGroundStr, "N1_AcntPartDocGroundStr", "Раздел открыт на основании следующих документов:"); 
        CopyAllSheetInTotalBook( NULL, false, "N1_AcntPartDocGroundStr", 0 );

        IsFirst = false;
      end;

      var mort = "";
      Var Kind = DataSet.Kind;
      // DOCKIND_STOR_CONTR DOCKIND_PAWN_CONTR               DOCKIND_CREDIT_CONTR
   
      if( (Kind == 105) OR (Kind == 107) OR (Kind == 111) OR (Kind == 113))
         mort = " Залогодержатель: ";
         mort = mort + GetNameMort(DepoPart)
      end;
      StrDocInfo = "       " + string(DataSet.Name) + " №" + IIF(string(DataSet.AltXld)=="", "б/н", string(DataSet.AltXld)) + " от " + DL_DateToStr(date(DataSet.SignedDate)) + mort;
      PrintFormatString( AcntDocGroundStr, "N1_AcntDocGround", StrDocInfo); 
      CopyAllSheetInTotalBook( NULL, false, "N1_AcntDocGround", 0 );
    end;
  end;


  private macro WriteDepoPartDocs(DepoPart)
    var query, DataSet;
    var Select;
    var query2, DataSet2;
    var Select2;
    var IsFirst;

    // Сначала выводим документы из характеристик
    query = " SELECT llv.t_Name Name, spgr.t_AltXld AltXld, spgr.t_SignedDate SignedDate, spgr.t_Kind Kind " + 
            " FROM dspground_dbt spgr, dllvalues_dbt llv " + 
            " WHERE spgr.t_spgroundid IN ( SELECT TO_NUMBER (atvl.t_value) " + 
            "                              FROM ddepoatvl_dbt atvl " + 
            "                              WHERE atvl.t_istype = CHR (0) " + 
            "                                AND atvl.t_id = ? /*1*/ " + 
            "                                AND atvl.t_list = " + OBJTYPE_DEPODOC + ") " + 
            "   AND llv.t_List = " + OBJTYPE_KINDDOC +
            "   AND llv.t_Element = spgr.t_Kind";

    Select = RSDCommand( query );

    Select.AddParam("DepoPart",   RSDBP_IN, DepoPart );  /*1*/

    Select.Execute();

    DataSet = TRsbDataSet(Select);
    IsFirst = true;

    WriteDepoPartOneDoc(DataSet, @IsFirst, DepoPart);

    // Теперь из документов-приложений АО открытия раздела
    query2 = " SELECT llv.t_Name Name, spgr.t_AltXld AltXld, spgr.t_SignedDate SignedDate, spgr.t_Kind Kind " + 
            " FROM dspground_dbt spgr, dllvalues_dbt llv " + 
            " WHERE spgr.t_spgroundid IN ( SELECT spgrd.t_spgroundid " + 
            "                              FROM ddepoadmo_dbt adm, dspgrdoc_dbt spgrd " + 
            "                              WHERE adm.t_item = " + SPDP_DEPO_PARTITION +
            "                                AND adm.t_partyid = ? /*1*/ " + 
            "                                AND adm.t_depoacc = ? /*2*/ " + 
            "                                AND adm.t_depopart = ? /*3*/ " + 
            "                                AND adm.t_fiid = " + ALLFININSTR +
            "                                AND adm.t_account = CHR (1) " + 
            "                                AND adm.t_operkind = " + SPAO_CON_REGISTERING +
            "                                AND spgrd.t_sourcedockind = " + SP_DEPOPER_ADMOPER +
            "                                AND spgrd.t_sourcedocid = adm.t_admoprid ) " + 
            "   AND spgr.t_Direction != " + EXITING +
            "   AND llv.t_List = " + OBJTYPE_KINDDOC +
            "   AND llv.t_Element = spgr.t_Kind";

    Select2 = RSDCommand( query2 );

    Select2.AddParam("Owner",   RSDBP_IN, depoacnt.rec.Owner );  /*1*/
    Select2.AddParam("DepoAcc",   RSDBP_IN, depoacnt.rec.Root );  /*2*/
    Select2.AddParam("DepoPart",   RSDBP_IN, DepoPart );  /*3*/

    Select2.Execute();

    DataSet2 = TRsbDataSet(Select2);
    WriteDepoPartOneDoc(DataSet2, @IsFirst,DepoPart);

  end;


  private macro WriteDepoPartInfo(DepoPart)
    var StrPartition;
    var Name, Code, BriefCode, Synt, Blncname;

    Name = GetDepoPartInfo(DepoPart, @Code, @BriefCode, @Synt, @Blncname);

    StrPartition = "Раздел: " + Name + " " + Code + " (короткий " + BriefCode + "), синтетический счет " + 
                            Synt + " \"" + BlncName + "\"";

    PrintFormatString( AcntPartStr, "N1_AcntPart", StrPartition); 
    CopyAllSheetInTotalBook( NULL, false, "N1_AcntPartBlock", 0 );

    WriteDepoPartDocs(DepoPart);

    ExtrMessage.InsertPart(BriefCode);
  end;

  PRIVATE MACRO PrintReport( beg_date, end_date, DepoCount )
     var cmd, query, q, q_empty, q_is_indoor, q_is_corr_active, q_is_corr_passive;
     var SpraftDocKinds = string(SP_DEPOPER_BOOKORDER, ",", SP_DEPOPER_TRANSFERORDER, ",", SP_DEPOPER_ENROLMENT, ",", SP_DEPOPER_RECORDER, ",", SP_DEPOPER_WITHDRORDER);
     var GlobopDocKinds = string(DP_DEPOPER_CONVERT, ",", DP_DEPOPER_REPAY, ",", DP_DEPOPER_BONEMISS);
     var counted = 0, i = 0, stat;
     var PrevAccTrnID;

     counted = 0;

     RepHeader(depoacnt.rec.Code, beg_date, end_date, DepoCount);

     cmd = DL_RSDCommand();

     q =   " SELECT acc.t_depoacc DepoPart, spgr.t_Xld Xld, spgr.t_RegistrDate RegistrDate, acctrn.t_Date_Carry ValueDate, fin.t_FIID FIID, "
         + "        fin.t_Name Fin_Name, fin.t_SumPrecision SumPrecision, acctrn.t_Sum_Payer Amount, "
         + "        (CASE WHEN avr.t_lsin != chr(1) THEN avr.t_lsin ELSE DECODE(avr.t_isin, chr(1), fin.t_FI_Code, avr.t_isin) END ) ILSIN, "
         + "        (CASE WHEN acctrn.t_Account_Payer = acc.t_Account THEN acc.t_deporoot ELSE 0 END ) PayerAcntRoot, "
         + "        (CASE WHEN acctrn.t_Account_Payer = acc.t_Account THEN acctrn.t_account_receiver ELSE acctrn.t_account_payer END ) ReceiverCorrespond_Acc, "
         + "        (CASE WHEN acctrn.t_Account_Receiver = acc.t_Account THEN acc.t_deporoot ELSE 0 END ) ReceiverAcntRoot, "
         + "        (CASE WHEN acctrn.t_Account_Receiver = acc.t_Account THEN acctrn.t_account_payer ELSE acctrn.t_account_receiver END ) PayerCorrespond_Acc, "
         + "        oproper.t_dockind SourceDocKind, "
         + "        oproper.t_documentid SourceDocID, "
         + "        RSB_FIInstr.FI_IsQualified(fin.t_FIID, ? /*1*/) as isQualified, "
         + "        (CASE WHEN oproper.t_DocKind IN ("+SpraftDocKinds+") THEN 0 ELSE 1 END) IsGlobal, "
         + "        acctrn.t_AccTrnID AccTrnID "
         + "   FROM dacctrn_dbt acctrn, doprdocs_dbt oprdocs, doproper_dbt oproper, dspground_dbt spgr, dfininstr_dbt fin, davoiriss_dbt avr, ";

     cmd.AddParam(end_date); /*1*/

     if(InvCardID)
       q = q + " dinvchng_dbt invchange, ";
     end;

     if(depo_part)
       q = q + "        ( select acc1.t_accountid, acc1.t_account, acc1.t_Code_Currency, acc1.t_deporoot, acc1.t_depoacc from daccount_dbt acc1 where acc1.t_depoacc = ? /*2*/) acc ";
       cmd.AddParam(depo_part); /*2*/
     else
       q = q + "        ( select acc1.t_accountid, acc1.t_account, acc1.t_Code_Currency, acc1.t_deporoot, acc1.t_depoacc from daccount_dbt acc1 where acc1.t_deporoot = ? /*2*/) acc ";
       cmd.AddParam(depoacnt.rec.AutoKey); /*2*/
     end;

     q = q + "  WHERE ( (   acctrn.t_Account_Payer    = acc.t_Account "
         + "             OR acctrn.t_Account_Receiver = acc.t_Account ) ";

     // Если отчет выпускается по пассивным счетам, то в него включаются перемещения бумаг, принадлежащих ему
     if(depoacnt.Kind == SIDEBALANCE_PASSIVE)
       q = q + "        OR ( " 
                       + "   (   (acctrn.t_AccTrnID) IN "
                       + "     ( select pmd.t_AccTrnID "
                       + "         from daccvanl_dbt accvanl, daccsubdc_dbt subdc, daccsub_dbt accsub1, daccsub_dbt accsub2, dpmdocs_dbt pmd "
                       + "        where accvanl.t_AnaliticsID = " + 2
                       + "          and accvanl.t_Chapter = " + CHAPT5
                       + "          and accvanl.t_FIID = acc.t_Code_Currency "
                       + "          and accvanl.t_Account = acc.t_Account "
                       + "          and subdc.t_AccAnaliticsID = accvanl.t_AccAnaliticsID "
                       + "          and accsub1.t_AccAnaliticsID = subdc.t_AccAnaliticsID "
                       + "          and accsub1.t_SubAccountID = subdc.t_SubAccountPayerID "
                       + "          and accsub1.t_SpecialType = 0 "
                       + "          and accsub2.t_AccAnaliticsID = subdc.t_AccAnaliticsID "
                       + "          and accsub2.t_SubAccountID = subdc.t_SubAccountReceiverID "
                       + "          and accsub2.t_SpecialType = 0 "
                       + "          and pmd.t_PaymentID = subdc.t_PaymentID )  ) "
                       + " OR  (   (acctrn.t_AccTrnID) IN "
                       + "   ( select pmd.t_AccTrnID "
                       + "       from dinvchng_dbt cch, dinvcard_dbt ic, dv_ficert_dbt vficert, dpmdocs_dbt pmd, doproper_dbt opr, dspdraft_dbt draft, dspdrmove_dbt move "
                       + "      where vficert.t_FIID = acc.t_Code_Currency "
                       + "        and ic.t_Department = ? /*2b*/ "
                       + "        and ic.t_FiCertID = vficert.t_FiCertID "
                       + "        and cch.t_InvCardID = ic.t_InvCardID "
                       + "        and (cch.t_LAccountID = acc.t_AccountID "
                       + "          or cch.t_HAccountID = acc.t_AccountID) "
                       + "        and rsb_depo.IsMovingInvChng(cch.t_InvChngID) > 0"
                       + "        and opr.t_ID_Operation = cch.t_ID_Operation "
                       + "        and draft.t_Kind = opr.t_DocKind "
                       + "        and TO_CHAR(draft.t_AutoKey) = opr.t_DocumentID "
                       + "        and move.t_DraftID = draft.t_AutoKey"
                       + "        and pmd.t_PaymentID = move.t_PaymentID ) ) ) ";

       cmd.AddParam(depoacnt.rec.Department); /*2b*/
     end;

     q = q + "        ) "
         + "    AND acctrn.t_Chapter = " + CHAPT5
         + "    AND acctrn.t_FIID_Payer = acc.t_Code_Currency "
         + "    AND acctrn.t_date_carry >= ? /*3*/ "
         + "    AND acctrn.t_date_carry <= ? /*4*/ " 
         + "    AND acctrn.t_Department = ? /*5*/  "
         + "    AND acctrn.t_State = 1 "/*фактическая проводка*/
         + "    AND oprdocs.t_AccTrnID = acctrn.t_AccTrnID "
         + "    AND oprdocs.t_DocKind = 1 "
         + "    AND oproper.t_ID_Operation = oprdocs.t_ID_Operation " 
         + "    AND spgr.t_SPgroundID = ( CASE WHEN oproper.t_DocKind IN ("+SpraftDocKinds+") THEN (SELECT draft.t_SPgroundID FROM dspdraft_dbt draft WHERE draft.t_AutoKey = oproper.t_DocumentID) "
         + "                                   WHEN oproper.t_DocKind IN ("+GlobopDocKinds+") THEN (SELECT sp.t_SPgroundID FROM dspground_dbt sp WHERE sp.t_SourceDocKind = oproper.t_DocKind AND sp.t_SourceDocID = oproper.t_DocumentID) "
         + "                              END ) "
         + "    and fin.t_FIID = acctrn.t_FIID_Payer "
         + "    and avr.t_FIID = fin.t_FIID ";
  
     cmd.AddParam(beg_date); /*3*/
     cmd.AddParam(end_date); /*4*/
     cmd.AddParam(dprt_num); /*5*/

     if( SecurQual == SECURQUAL_QUAL)
       q = q + " and RSB_FIInstr.FI_IsQualified(fin.t_FIID, ? /*6*/) <> 0";
       cmd.AddParam(end_date); /*6*/
     elif(SecurQual == SECURQUAL_NOQUAL)
       q = q + " and RSB_FIInstr.FI_IsQualified(fin.t_FIID, ? /*6*/) = 0";
       cmd.AddParam(end_date); /*6*/
     end;

     if(InvCardID)
       q = q + " and invchange.t_ID_Operation = oprdocs.t_ID_Operation "
             + " and invchange.t_ID_Step = oprdocs.t_ID_Step "
             + " and invchange.t_InvCardID = ? /*7*/ ";
       cmd.AddParam(InvCardID); /*7*/
     end;


     if(correspond_acc)
       q_is_indoor = " EXISTS (SELECT 1 "
                   + "         FROM dpmdocs_dbt pmd, dpmpaym_dbt pm "
                   + "         WHERE pmd.t_AccTrnID = acctrn.t_AccTrnID "
                   + "           AND pm.t_PaymentID = pmd.t_paymentID "
                   + "           AND pm.t_IndoorStorage = 1 ) "; // Поручение по ЗХ

       q_is_corr_active = " EXISTS ( SELECT 1 "                 
                        + "          FROM daccount_dbt acc2, daccsub_dbt accsub, daccsubdc_dbt accsubdc, dpmdocs_dbt pmd "
                        + "          WHERE pmd.t_AccTrnID = acctrn.t_AccTrnID "
                        + "            AND pmd.t_PaymentID = accsubdc.t_PaymentID ";
       if(correspond_part)
         q_is_corr_active = q_is_corr_active + " AND acc2.t_DepoAcc = ? /*8*/ ";
       else
         q_is_corr_active = q_is_corr_active + " AND acc2.t_DepoRoot = ? /*8*/ ";
       end;
       q_is_corr_active = q_is_corr_active + "            AND acc2.t_CHAPTER = " + CHAPT5
                        + "            AND acc2.t_Code_Currency = acctrn.t_FIID_Payer "
                        + "            AND acc2.t_Account = accsub.t_SubAccountCode "
                        + "            AND accsub.t_AccAnaliticsID = accsubdc.t_AccAnaliticsID "
                        + "            AND (accsub.t_SubAccountID = accsubdc.t_SubAccountPayerID "
                        + "              OR accsub.t_SubAccountID = accsubdc.t_SubAccountReceiverID ) ) "; // Отбор по субсчетам, если корресп. счет активный

       q_is_corr_passive = " EXISTS ( SELECT 1 "
                         + "          FROM daccount_dbt acc2, daccvanl_dbt accvanl, daccsubdc_dbt accsubdc2, dpmdocs_dbt pmd "
                         + "          WHERE pmd.t_AccTrnID = acctrn.t_AccTrnID "
                         + "            AND pmd.t_PaymentID = accsubdc2.t_PaymentID ";
       if(correspond_part)
         q_is_corr_passive = q_is_corr_passive + " AND acc2.t_DepoAcc = ? /*8*/ ";
       else
         q_is_corr_passive = q_is_corr_passive + " AND acc2.t_DepoRoot = ? /*8*/ ";
       end;
       q_is_corr_passive = q_is_corr_passive + "            AND acc2.t_CHAPTER = " + CHAPT5
                         + "            AND acc2.t_Code_Currency = acctrn.t_FIID_Payer "
                         + "            AND acc2.t_Account = accvanl.t_Account "
                         + "            AND accvanl.t_Chapter = " + CHAPT5
                         + "            AND accvanl.t_FIID = acctrn.t_FIID_Payer "
                         + "            AND accvanl.t_AccAnaliticsID = accsubdc2.t_AccAnaliticsID ) "; // Отбор по субсчетам, если корресп. счет пассивный

       q = q + " AND ( ( NOT " + q_is_indoor + " AND ";

       if(depoacnt.Kind == SIDEBALANCE_PASSIVE) // Базовый счет пассивный - корреспондирующий - активный
         q = q + q_is_corr_active + " ) ";
       else
         q = q + q_is_corr_passive + " ) ";
       end;

       if(correspond_part)
         cmd.AddParam(correspond_part); /*8*/
       else
         cmd.AddParam(correspond_acc); /*8*/
       end;

       q = q + " OR ( " + q_is_indoor
             + " AND EXISTS( SELECT 1 "
             + "             FROM daccount_dbt acc3, dinvchng_dbt cchange2 "
             + "             WHERE cchange2.t_ID_Operation = oprdocs.t_ID_Operation "
             + "               AND cchange2.t_ID_Step = oprdocs.t_ID_Step ";
       if(correspond_part)
         q = q + " AND acc3.t_DepoAcc = ? /*9*/ ";
         cmd.AddParam(correspond_part); /*9*/
       else
         q = q + " AND acc3.t_DepoRoot = ? /*9*/ ";
       end;
       
       q = q + "               AND acc3.t_CHAPTER = 5 "
             + "               AND acc3.t_Code_Currency = acctrn.t_FIID_Payer "
             + "               AND (acc3.t_AccountID = cchange2.t_HAccountID "
             + "                OR acc3.t_AccountID = cchange2.t_LAccountID ) ) ) ) ";

     end;

     if(issuer_id != UnknownParty)
       q = q + " AND fin.t_Issuer = ? /*10*/ ";
       cmd.AddParam(issuer_id); /*10*/
     end;

     if(avoir_kind)
       q = q + " AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", ? /*12*/, fin.t_AvoirKind) > 0 ";
       cmd.AddParam(avoir_kind); /*12*/
     end;

     if(avoir_FIID != ALLFININSTR)
       q = q + " AND fin.t_FIID = ? /*13*/ ";
       cmd.AddParam(avoir_FIID); /*13*/
     end;

    if( showPawn )
      if( mortgagee > 0)
        q = q + " and acc.t_depoacc IN "
              +" (SELECT atvl.t_ID "
              +"  FROM ddepoatvl_dbt atvl, ddpacap_dbt acap,ddpacapau_dbt acapau "
              +"  WHERE     atvl.t_IsType = CHR (0) "
              +"    AND atvl.t_AttrNum = 15 "
              +"    AND TO_CHAR (acap.t_APartyGround) = atvl.t_Value "
              +"    AND acap.t_ApartyId =  " + mortgagee
              +"    AND acap.t_role = 4 "
              +"    AND acapau.t_APID = acap.t_APID "
              +"    and acapau.t_AUNodeID IN (select ac.t_AutoKey from ddepoacnt_dbt ac start with ac.t_AutoKey = atvl.t_ID connect by ac.t_AutoKey = prior ac.t_Superior))";
      else
        q = q + "AND acc.t_depoacc IN "
              +" (SELECT atvl.t_ID  "
              +"          FROM ddepoatvl_dbt atvl "
              +"         WHERE atvl.t_IsType = CHR (0) AND atvl.t_AttrNum = 15)" ;
      end;    
    end;

     
     if(Partitions)
       q_empty = "SELECT dpacnt.t_AutoKey DepoPart, "
               + "        chr(1) Xld, "
               + "       TO_DATE('01.01.0001', 'DD.MM.YYYY') RegistrDate, "
               + "       TO_DATE('01.01.0001', 'DD.MM.YYYY') ValueDate, "
               + "       -1 FIID, "
               + "       chr(1) FinName, "
               + "       "+AVOIRISS_SUM_PRECISION+", "
               + "       0.0 Amount, "
               + "       chr(1) ILSIN, "
               + "       0 PayerAcntRoot, "
               + "       chr(1) ReceiverCorrespond_Acc, "
               + "       0 ReceiverAcntRoot, "
               + "       chr(1) PayerCorrespond_Acc, "
               + "       0 SourceDocKind, "
               + "       chr(1) SourceDocID, "
               + "       0 isQualified, "
               + "       0 IsGlobal, "
               + "       0 AccTrnID "
               + "FROM ddepoacnt_dbt dpacnt ";
       if(depo_part)
         q_empty = q_empty + "WHERE dpacnt.t_AutoKey = ? /*14*/ ";
         cmd.AddParam(depo_part); /*14*/
       else
         q_empty = q_empty + "WHERE dpacnt.t_Root = ? /*14*/ ";
         cmd.AddParam(depoacnt.rec.AutoKey); /*14*/
       end;
               
       if( showPawn )
         if( mortgagee > 0)
           q_empty = q_empty + " and dpacnt.t_AutoKey IN "
                 +" (SELECT atvl.t_ID "
                 +"  FROM ddepoatvl_dbt atvl, ddpacap_dbt acap,ddpacapau_dbt acapau "
                 +"  WHERE     atvl.t_IsType = CHR (0) "
                 +"    AND atvl.t_AttrNum = 15 "
                 +"    AND TO_CHAR (acap.t_APartyGround) = atvl.t_Value "
                 +"    AND acap.t_ApartyId =  " + mortgagee
                 +"    AND acap.t_role = 4 "
                 +"    AND acapau.t_APID = acap.t_APID "
                 +"    and acapau.t_AUNodeID IN (select ac.t_AutoKey from ddepoacnt_dbt ac start with ac.t_AutoKey = atvl.t_ID connect by ac.t_AutoKey = prior ac.t_Superior))";
         else
           q_empty = q_empty + "AND dpacnt.t_AutoKey IN "
                 +" (SELECT atvl.t_ID  "
                 +"          FROM ddepoatvl_dbt atvl "
                 +"         WHERE atvl.t_IsType = CHR (0) AND atvl.t_AttrNum = 15)" ;
         end;    
       end;

       q_empty = q_empty + "AND NOT EXISTS (SELECT 1 FROM ddepoac_dbt dpac WHERE dpac.t_Parent = dpacnt.t_Type) ";

       q = "SELECT * FROM ( " + q + " UNION ALL " + q_empty + " ) sel order by sel.DepoPart, sel.ValueDate, sel.AccTrnID";
     else
       q = q + " order by acctrn.t_Date_Carry, acctrn.t_AccTrnID";
     end;

     DataSet = cmd.Execute(q);

     stat = DataSet.MoveNext();
     
     while(stat)
       if(DataSet.AccTrnID)
         if(not PrevAccTrnID)
           CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader", 1 );

           RegisterTable( "N1_MainTable", HeadTable,
                          "N1_A1",          
                          "N1_A2",               
                          "N1_A3",                
                          "N1_A4",        
                          "N1_A5",        
                          "N1_A6",
                          "N1_A7",
                          "N1_A8",
                          "N1_A9"         
                       );
         end;
         WriteTableLine();
       else // В режиме с разделами - новый раздел
         WriteDepoPartInfo(DataSet.DepoPart)
       end;

       counted = counted + 1;
       PrevAccTrnID = DataSet.AccTrnID;

       stat = DataSet.MoveNext();

       if((PrevAccTrnID) and ((not stat) or (not DataSet.AccTrnID)))
         EndTable();
         CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
       end;

       if(((stat) AND (NOT PrevAccTrnID) AND (NOT DataSet.AccTrnID)) OR
          ((NOT stat) AND (NOT PrevAccTrnID)) )
         CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader", 1 );

         RegisterTable( "N1_MainTable", HeadTable,
                        "N1_A1",          
                        "N1_A2",               
                        "N1_A3",                
                        "N1_A4",        
                        "N1_A5",        
                        "N1_A6",
                        "N1_A7",
                        "N1_A8",
                        "N1_A9"         
                     );
         merge("N1_A1", "N1_A9");
         PrintTableLine( "N1_A1", "В указанный период не было движения ценных бумаг по разделу.", null);
         EndTable();
         CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
       end; 
     end;
     
     if ( counted == 0)
       PrintFormatString( MsgNotMoveFIStr, "N1_MsgNotMoveFI", "В указанный период не было движения ценных бумаг."); 
       CopyAllSheetInTotalBook( NULL, false, "N1_MsgNotMoveFI", 0 );
     end;

     //печатаем остатки
     if(printAcntRest == true)
       var isRegTable = false;
       var FinDescriptStr = "", FinNumber = "";
       var Rest = 0.0, SumPrecision = 0;
       var cntsymb, FI_Number, FinName;

       query =   "with acc as (select * "
               + "               from daccount_dbt "
               + "              where t_DepoRoot = ? " /*1*/
               + "             ) ";

       //1. Сначала по открытому хранению
       cmd = DL_RSDCommand();
       q = query + ", "    
           + " f as (select cast(SUM(ABS(rsb_account.restac( acc.t_Account, acc.t_Code_Currency, ? , acc.t_Chapter, null ))) as number(32,12)) as Rest, fin.t_FIID "
           + "         from acc, dfininstr_dbt fin "
           + "        where fin.t_FIID = acc.t_Code_Currency "
           + "          and instr(acc.t_Type_Account, 'I') = 0 "
           + "        group by fin.t_FIID) "
           + " select f.Rest, fin.t_SumPrecision, fin.t_Name as FIName, curr.t_Ccy, fin.t_IsAdditional, fin.t_DrawingDate, "
           + "        rsb_fiinstr.FI_GetNominalOnDate( fin.t_FIID, ? ) as Nominal, "
           + "        RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_FI_Kind, fin.t_AvoirKind) as RootAvoirKind, "
           + "        pt.t_Name as PartyName, avrk.t_Name as AvrkName, avr.t_Issue, avr.t_Tranche, "
           + "        avr.t_LSIN, avr.t_ISIN, fin.t_FI_Code, "
           + "        (select count(1) from dfiwarnts_dbt fw where fw.t_FIID = fin.t_FIID and t_IsPartial = 'X') as CntPartial, "
           + "        RSB_FIInstr.FI_IsQualified(fin.t_FIID, ?) as IsQualified "
           + "   from f, dfininstr_dbt fin, davrkinds_dbt avrk, dparty_dbt pt, dfininstr_dbt curr, davoiriss_dbt avr "
           + "  where fin.t_FIID = f.t_FIID "
           + "    and pt.t_PartyID = RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) "
           + "    and avrk.t_FI_Kind = fin.t_FI_Kind "
           + "    and avrk.t_AvoirKind = fin.t_AvoirKind "
           + "    and curr.t_FIID = fin.t_FaceValueFI "
           + "    and avr.t_FIID = fin.t_FIID ";

       cmd.AddParam(depoacnt.rec.AutoKey); /*1 from query*/
       cmd.AddParam(end_date);
       cmd.AddParam(end_date);
       cmd.AddParam(end_date);
       cmd.AddParam(end_date);
       
       if( SecurQual == SECURQUAL_QUAL)
         q = q + " and RSB_FIInstr.FI_IsQualified(fin.t_FIID, ?) <> 0";
         cmd.AddParam(end_date); 
       elif(SecurQual == SECURQUAL_NOQUAL)
         q = q + " and RSB_FIInstr.FI_IsQualified(fin.t_FIID, ?) = 0";
         cmd.AddParam(end_date); 
       end;

       if(issuer_id != UnknownParty)
         q = q + " AND fin.t_Issuer = ? ";
         cmd.AddParam(issuer_id); 
       end;

       if(avoir_kind)
         q = q + " AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", ?, fin.t_AvoirKind) > 0 ";
         cmd.AddParam(avoir_kind);        
       end;

       if(avoir_FIID != ALLFININSTR)
         q = q + " AND fin.t_FIID = ?  ";
         cmd.AddParam(avoir_FIID); 
       end;

       DataSet = cmd.Execute(q);
       stat = DataSet.moveNext();
       if(stat)
         PrintFormatString(AcntRestInfoStr, "N1_AcntRestInfo", "Остатки на конец дня "+string(end_date:f)+" по счету "+depoacnt.rec.Code + " (короткий " + depoacnt.rec.BriefCode + ")" + GetAccDocInfo(depoacnt.rec.Code));
         CopyAllSheetInTotalBook( NULL, false, "N1_AcntRestInfo", 1 );

         CopyAllSheetInTotalBook( NULL, false, "N1_RestTableHeader", 1 );

         RegisterTable( "N1_RestTable", HeadRestTable,
                        "N1_T1",
                        "N1_T2",
                        "N1_T3",
                        "N1_T4",
                        "N1_T5"
                      );
         isRegTable = true;

         while(stat)
           FinDescriptStr = DataSet.AvrkName + " ";
           FinDescriptStr = FinDescriptStr + DataSet.PartyName + " ";

           if(DataSet.RootAvoirKind == AVOIRISSKIND_SHARE)
             FinDescriptStr = FinDescriptStr + DataSet.Issue + " ";
             if(DataSet.IsAdditional == SET_CHAR)
               FinDescriptStr = FinDescriptStr + " дополнительный выпуск ";
             else
               FinDescriptStr = FinDescriptStr + " объединённый выпуск ";
             end;
           end;

           if(DataSet.RootAvoirKind == AVOIRISSKIND_BOND)
             if(DataSet.Tranche != "")
               FinDescriptStr = FinDescriptStr + DataSet.Tranche + " транша ";
             end;

             FinDescriptStr = FinDescriptStr + "погашение " + string(date(DataSet.DrawingDate):f);

             if(DataSet.CntPartial > 0)
               FinDescriptStr = FinDescriptStr + "с амортизацией долга ";
             end;
           end;

           FinNumber  = DataSet.LSIN;
           if(FinNumber  == "")
             FinNumber  = DataSet.ISIN;
           end;
           if(FinNumber  == "")
             FinNumber  = DataSet.FI_Code;
           end;

           if(not DataSet.IsQualified)
             FinNumber  = FinNumber  + " (НКЦБ)";
           end;

           Rest = double(DataSet.Rest);
           SumPrecision = DataSet.SumPrecision;
           if(Rest == int(Rest))
             Rest = int(Rest);
             SumPrecision = 0;
           end;

           PrintTableLine( "N1_T1:w",  DataSet.FIName,  null,
                           "N1_T2:w",  FinDescriptStr,          null,
                           "N1_T3:w",  FinNumber ,         null,
                           "N1_T4:r",  money(DataSet.Nominal) + " " + string(DataSet.Ccy),  null,
                           "N1_T5:r",  Rest,   SumPrecision
                         );

           stat = DataSet.moveNext();
         end;
       end;

       //2. Теперь по закрытому хранению
       cmd = DL_RSDCommand();
       q = query    
           + " select fin.t_SumPrecision, fin.t_Name as FIName, curr.t_Ccy, fin.t_IsSys, "
           + "        vficert.t_FaceValue as Nominal, "
           + "        RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_FI_Kind, fin.t_AvoirKind) as RootAvoirKind, "
           + "        NVL(pt.t_ShortName, CHR(1)) as PartyShortName, avrk.t_Name as AvrkName,   "
           + "        trim(vficert.t_Number) as NumberFirst, "
           + "        trim(vficert.t_Number) as NumberLast, "
           + "        1 as Copies, "
           + "        vficert.t_Series, vficert.t_FIID, vficert.t_Issuer, "
           + "        NVL((SELECT alg.t_SzNameAlg "
           + "               FROM dnamealg_dbt alg, dvsbanner_dbt bnr "
           + "              WHERE bnr.t_BCID = vficert.t_CertID "
           + "                AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", "+AVOIRISSKIND_BILL+", vficert.t_AvoirKind) > 0 "
           + "                AND alg.t_iTypeAlg = "+ALG_VS_TYPE
           + "                AND alg.t_iNumberAlg = bnr.t_IssueKind), CHR(1)) as IssueKindName, "
           + "        RSB_FIInstr.FI_IsQualified(fin.t_FIID, ?) as IsQualified "
           + "   from acc, dfininstr_dbt fin, davrkinds_dbt avrk, dfininstr_dbt curr, davoiriss_dbt avr, dinvcard_dbt ic, "
           + "        dv_ficert_dbt vficert left join dparty_dbt pt on pt.t_PartyID = vficert.t_Issuer "
           + "  where instr(acc.t_Type_Account, 'I') <> 0 "
           + "    and fin.t_FIID = acc.t_Code_Currency "
           + "    and vficert.t_FIID = fin.t_FIID"
           + "    and ic.t_FiCertID = vficert.t_FiCertID "
           + "    and rsb_depo.icstatus(ic.t_InvCardID, ?) = " + INVCARD_STATUS_INCUSTODY  
           + "    and ( acc.t_AccountID = rsb_depo.icaccountid(ic.t_InvCardID, 0, ?) OR acc.t_AccountID = rsb_depo.icaccountid(ic.t_InvCardID, 1, ?)) "
           + "    and avrk.t_FI_Kind = fin.t_FI_Kind "
           + "    and avrk.t_AvoirKind = fin.t_AvoirKind "
           + "    and curr.t_FIID = vficert.t_FaceValueFI "
           + "    and avr.t_FIID = fin.t_FIID ";

       cmd.AddParam(depoacnt.rec.AutoKey); /*1 from query*/
       cmd.AddParam(end_date);
       cmd.AddParam(end_date);
       cmd.AddParam(end_date);
       cmd.AddParam(end_date);

       if( SecurQual == SECURQUAL_QUAL)
         q = q + " and RSB_FIInstr.FI_IsQualified(fin.t_FIID, ?) <> 0";
         cmd.AddParam(end_date); 
       elif(SecurQual == SECURQUAL_NOQUAL)
         q = q + " and RSB_FIInstr.FI_IsQualified(fin.t_FIID, ?) = 0";
         cmd.AddParam(end_date); 
       end;

       if(issuer_id != UnknownParty)
         q = q + " AND vficert.t_Issuer = ? ";
         cmd.AddParam(issuer_id); 
       end;

       if(avoir_kind)
         q = q + " AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", ?, fin.t_AvoirKind) > 0 ";
         cmd.AddParam(avoir_kind);        
       end;

       if(avoir_FIID != ALLFININSTR)
         q = q + " AND fin.t_FIID = ? ";
         cmd.AddParam(avoir_FIID); 
       end;

       if(InvCardID)
         q = q + " and ic.t_InvCardID = ? ";
         cmd.AddParam(InvCardID); 
       end;

       q = q + "  order by vficert.t_FIID, vficert.t_Issuer, IssueKindName, curr.t_FIID, vficert.t_Series, NumberFirst";

       DataSet = cmd.Execute(q);
       stat = DataSet.moveNext();
       if(stat)
         if(isRegTable == false)
           PrintFormatString(AcntRestInfoStr, "N1_AcntRestInfo", "Остатки на конец дня "+string(end_date:f)+" по счету "+depoacnt.rec.Code + " (короткий " + depoacnt.rec.BriefCode + ")" + GetAccDocInfo(depoacnt.rec.Code));
           CopyAllSheetInTotalBook( NULL, false, "N1_AcntRestInfo", 1 );

           CopyAllSheetInTotalBook( NULL, false, "N1_RestTableHeader", 1 );

           RegisterTable( "N1_RestTable", HeadRestTable,
                          "N1_T1",
                          "N1_T2",
                          "N1_T3",
                          "N1_T4",
                          "N1_T5"
                        );
           isRegTable = true;
         end;

         var LastPrintFinName = "", LastPrintFinDescriptStr = "";
         var prevFIID = DataSet.FIID, prevIssuer = DataSet.Issuer;
         var AllData = CollectData();

         while(stat)

           prevFIID = DataSet.FIID;
           prevIssuer = DataSet.Issuer;

           cntsymb = strlen(DataSet.NumberFirst);
           FI_Number = DataSet.NumberFirst;
           
           FinName = DataSet.FIName;
           if(DataSet.IsSys == SET_CHAR)
             FinName = FinName + " " + DataSet.PartyShortName;
           end;

           FinDescriptStr = DataSet.AvrkName + " ";
           if(DataSet.RootAvoirKind == AVOIRISSKIND_BILL)
             FinDescriptStr = FinDescriptStr + DataSet.IssueKindName + " ";
           end;
           FinDescriptStr = FinDescriptStr + DataSet.PartyShortName; 

           if(LastPrintFinName != FinName)
             LastPrintFinName = FinName;
           else
             FinName = "";
           end;

           if(LastPrintFinDescriptStr != FinDescriptStr)
             LastPrintFinDescriptStr = FinDescriptStr;
           else
             FinDescriptStr = "";
           end;

           i = 1;
           while(i <= DataSet.Copies)
            
             FinNumber  = DataSet.Series + " " + FI_Number; 
             if(not DataSet.IsQualified)
               FinNumber  = FinNumber  + " (НКЦБ)";
             end;

             AllData.Add(DataSet.Ccy, money(DataSet.Nominal), 1);

             PrintTableLine( "N1_T1:w",  FinName,         null,
                             "N1_T2:w",  FinDescriptStr,          null,
                             "N1_T3:w",  FinNumber ,         null,
                             "N1_T4:r",  money(DataSet.Nominal) + " " + string(DataSet.Ccy),  null,
                             "N1_T5:r",  1,   null
                           );

             FI_Number = AddLeadNull(ЧислоCЗаданнойТочностью(numeric(FI_Number)+1, 0, ""), cntsymb);
             FinName = "";
             FinDescriptStr  = "";

             i = i + 1;
           end;

           stat = DataSet.moveNext();
           if((not stat) or (prevFIID != DataSet.FIID) or (prevIssuer != DataSet.Issuer))
             FinNumber  = "ИТОГО по инструменту";
             while(AllData.Next())       
               PrintTableLine( "N1_T1",    "",         null,
                               "N1_T2",    "",          null,
                               "N1_T3:w",  FinNumber ,         null,
                               "N1_T4:r",  money(AllData.Nominal) + " " + string(AllData.Ccy),  null,
                               "N1_T5:r",  AllData.Rest,   null
                             );
               FinNumber  = "";
             end;

             AllData.Clear();
           end;
         end;
       end;


       if(isRegTable)
         EndTable();
         CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
       end;
     end;

     ExtrMessage.Insert();

     DP_StdAuthPerson_Ex(null, null, this, "N1_");
     DP_StdDeposInfo_Ex(null, null, 0, this, "N1_");
     DP_StdExecReport_Ex(null, null, NULL, NULL, 0, this, "N1_");

     OnError(err)
       msgbox(cmd.GetErrorString(err));
  END;


  MACRO CreateRep()
    var sQuery = "";
    var records = 0, i = 0;
    var Progress = CProgressBar;
    var countedDAcc = 0;

    sQuery  = " select t_AutoKey, t_Owner, t_Code, t_BriefCode, t_Name, t_Type, t_Root, t_Kind, t_Department from ddepoacnt_dbt where";
    
    sQuery = sQuery + "       t_Superior = 0  and t_Department = " + dprt_num
             + " and t_OpenDate <= " + GetSQLDate(end_date)
             + " and t_Kind     != " + bad_sub_acc;

    if( owner_id != -1 )
       sQuery = sQuery + " and t_Owner = " + owner_id;
    end;
    
    if( depo_acc != 0 )
       sQuery = sQuery + " and t_AutoKey = " + depo_acc; 
    end;

    if( showPawn )
      if( mortgagee > 0)

        sQuery = sQuery + " and t_AutoKey IN "
              +" (SELECT DISTINCT cacnt.t_root "
              +"  FROM ddepoacnt_dbt cacnt "
              +"  WHERE cACNT.T_AUTOKEY IN "
              +" (SELECT atvl.t_ID "
              +"  FROM ddepoatvl_dbt atvl, ddpacap_dbt acap,ddpacapau_dbt acapau "
              +"  WHERE     atvl.t_IsType = CHR (0) "
              +"    AND atvl.t_AttrNum = 15 "
              +"    AND TO_CHAR (acap.t_APartyGround) = atvl.t_Value "
              +"    AND acap.t_ApartyId =  " + mortgagee
              +"    AND acap.t_role = 4 "
              +"    AND acapau.t_APID = acap.t_APID "
//              +"    AND (acap.t_ToDate >= " + GetSQLDate(RepDate) + " or acap.t_ToDate = " + GetSQLDate(date(0,0,0)) + ") "
              +"    and acapau.t_AUNodeID IN (select ac.t_AutoKey from ddepoacnt_dbt ac start with ac.t_AutoKey = atvl.t_ID connect by ac.t_AutoKey = prior ac.t_Superior)))";

      else
        sQuery = sQuery + "AND T_AUTOKEY IN "
              +" (SELECT DISTINCT cacnt.t_root "
              +"  FROM ddepoacnt_dbt cacnt "
              +"  WHERE cACNT.T_AUTOKEY IN "
              +"       (SELECT atvl.t_ID  "
              +"          FROM ddepoatvl_dbt atvl "
              +"         WHERE atvl.t_IsType = CHR (0) AND atvl.t_AttrNum = 15))" ;
      end;    

    end;

    if( acc_kind == DEPO_ACC_ACTIV )
       sQuery = sQuery + " and t_Kind = "+DEPO_ACC_ACTIV;
    elif( acc_kind == DEPO_ACC_PASSIV )
       sQuery = sQuery + " and t_Kind = "+DEPO_ACC_PASSIV;
    end;
    
    depoacnt = TRsbDataSet( sQuery, RSDVAL_CLIENT, RSDVAL_STATIC);
    depoacnt.MoveLast();
    records = depoacnt.GetRecCount();
    Close(depoacnt);
    //изначально отбираем все подходщие счета, т.е. головы
    depoacnt = TRsbDataSet( sQuery );
   
    if(records > 0 )
       Progress.Init(records, "Поиск счетов для отчета", "Просмотр счетов ДЕПО");
       while ( depoacnt.MoveNext() )
          i = i + 1;
          PrintReport(  beg_date, end_date, countedDAcc );
          countedDAcc = countedDAcc + 1;
          i = Progress.Use();
       end;
       Progress.Remove();
    end;

    return countedDAcc;
  END;

  MACRO CreateEmptyRep()
     DP_StdHeaderLO_Ex( null, null, "Выписка об операциях по счету ДЕПО", LogOprID, 0, false, beg_date, end_date, tablewidth, null, null, this, "N1_" );

     PrintFormatString( MsgNotMoveFIStr, "N1_MsgNotMoveFI", "Нет данных, удовлетворяющих параметрам отчета"); 
     CopyAllSheetInTotalBook( NULL, false, "N1_MsgNotMoveFI", 0 );

     DP_StdAuthPerson_Ex(null, null, this, "N1_");
     DP_StdDeposInfo_Ex(null, null, 0, this, "N1_");
     DP_StdExecReport_Ex(null, null, NULL, NULL, 0, this, "N1_");
  END;

  PRIVATE MACRO Create()
    return DP_StdReportControl( LogOprID, this.CreateRep(), null, 0, ToExcel, null, null, this, "N1_" );
  END;
  

  initDL_CReportTemplate( NULL, "spdpextr.xls", null, null, null, POI_MODE );

END;


macro depo_extract( 
                   _LogOprID, 
                   _dprt_num,
                   _RepFormatKind,
                   _beg_date,
                   _end_date,
                   _owner_id,
                   _acc_kind,
                   _depo_acc,
                   _depo_part,
                   _correspond_acc,
                   _correspond_part,
                   _showPawn,
                   _mortgagee,
                   _SecurQual,
                   _issuer_id,
                   _avoir_kind,
                   _avoir_FIID,
                   _InvCardID,
                   _Partitions,
                   _printAcntRest,
                   _ToExcel,
                   _use_ap
                  )
   LogOprID        = _LogOprID; 
   dprt_num        = _dprt_num; 
   beg_date        = _beg_date; 
   end_date        = _end_date; 
   owner_id        = _owner_id;
   acc_kind        = _acc_kind; 
   depo_acc        = _depo_acc; 
   depo_part       = _depo_part;
   correspond_acc  = _correspond_acc;
   correspond_part = _correspond_part;
   SecurQual       = _SecurQual;
   issuer_id       = _issuer_id;
   avoir_kind      = _avoir_kind;
   avoir_FIID      = _avoir_FIID;
   InvCardID       = _InvCardID;
   Partitions      = _Partitions;
   printAcntRest   = _printAcntRest;
   ToExcel         = _ToExcel;
   use_ap          = _use_ap;
   RepFormatKind   = _RepFormatKind;
   showPawn        = _showPawn;
   mortgagee       = _mortgagee;
      
   var stat = 0;
   var RepObj = DP_SpdpextrRep();
   
   RepObj.Run();
   stat = RepObj.NeedBreak;
   if(stat == 1)
     return stat;
   else
     return 0;
   end;
end;

OnError
     
     DepoSubAcc_FindClose;
     DepoAcc_FindClose;
     RunError;
end;
