/*                           
$Name:             sc_depoacc.mac
$Module:           Ценные бумаги
$Description:      Выполнение сервисной операции депозитарного учета
*/
import "scstartdepo.mac", "dpdrutl.mac", "qracctools.mac", "dlconst.mac";

PRIVATE FILE DocOffTMP( "docoffdp.tmp" ) key 0 write;
PRIVATE FILE DocOffTMPAcc( "docoffdp.tmp" ) key 1 write;
PRIVATE FILE DocOffTMPState( "docoffdp.tmp" ) key 2 write;
PRIVATE FILE DocOffTMPFind( "docoffdp.tmp" ) key 2;

private var RepErrArr = TArray(); //массив ошибок
private var FD;
private var FormPD;

/*Настройка в регистре*/
PRIVATE CONST DEPO_TRANSIT_ACCOUNT = "DEPO\\ENROLOPRTRANSACC";
PRIVATE CONST ENROLOPRTRANSBLOCK = "DEPO\\ENROLOPRTRANSBLOCK";

/*виды значений параметра депозитарного учета Consolidate -
  формировать поручение посделочно, сводное поручение, если формировать, то сколько, или вообще не формировать*/
PRIVATE CONST DEPSET_METHODFORMDRAFT_BYDEAL   = 0, /* Посделочно */
              DEPSET_METHODFORMDRAFT_ONECONS  = 1, /* Одно */
              DEPSET_METHODFORMDRAFT_TWOCONS  = 2, /* Два */
              DEPSET_METHODFORMDRAFT_ONECONS_CLIR = 3, /* Одно в разрезе клиринговых сессий */
              DEPSET_METHODFORMDRAFT_TWOCONS_CLIR = 4, /* Два в разрезе клиринговых сессий */
              DEPSET_METHODFORMDRAFT_NOTFORM  = 5; /* Не формировать*/  

/*Виды сводных депозитарных операций (docoffdp.Kind)*/
PRIVATE CONST DEPO_KIND_SUMMARY    = 0, /*сводная*/
              DEPO_KIND_TRANS_CLNT = 1, /*Транзитная по клиентским*/
              DEPO_KIND_TRANS_OWN  = 2; /*Транзитная по собственным*/

/*Типы сводных депозитарных операций (docoffdp.Type)*/
PRIVATE CONST DEPO_TYPE_IN  = 0, /*Зачисление*/
              DEPO_TYPE_OUT = 1; /*Списание*/

private class SpGroundType( pType:integer, pSpGround:integer )
  var Type     = pType,
      SpGround = pSpGround;
end;

private class SpGroundFIID( pFIID:integer, pSpGround:integer )
  var FIID     = pFIID,
      SpGround = pSpGround;
end;

private class SpGroundFIIDType( pFIID:integer, pSpGround:integer, pType:integer )
  var FIID     = pFIID,
      SpGround = pSpGround,
      Type     = pType;
end;

private class DL_FormationPD()

  var v_Consolidate:integer        = DEPSET_METHODFORMDRAFT_BYDEAL;
  var v_ClientConsolidate:integer  = DEPSET_METHODFORMDRAFT_BYDEAL;
  var v_MethodFormPD:integer       = DL_METHODFORMPD_EVERY;
  var v_ClientMethodFormPD:integer = DL_METHODFORMPD_EVERY;
  var v_Client:integer = -1;
  var v_IsPartyClient:bool = false;
  var v_SpGround:integer = -1;
  var v_SpGroundType = TArray();
  var v_SpGroundFIID = TArray();
  var v_SpGroundFIIDType = TArray();
  var v_CurrType = -1;

  private macro CurrConsolidate():integer
     return IIF(v_IsPartyClient, DEPSET_METHODFORMDRAFT_BYDEAL, IIF(v_Client == -1, v_Consolidate, v_ClientConsolidate));
  end;

  private macro CurrMethodFormPD():integer
     return IIF(v_IsPartyClient, v_MethodFormPD, IIF(v_Client == -1, v_MethodFormPD, v_ClientMethodFormPD));
  end;

  private macro AddSpGroundType( Type:integer, SpGround:integer )
     var Ex:bool = false;
     var i:integer = 0;
     while( i < v_SpGroundType.Size )
        if( v_SpGroundType[i].Type == Type )
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     if( not Ex )
        v_SpGroundType[v_SpGroundType.Size] = SpGroundType(Type, SpGround);
     end;
  end;

  private macro GetSpGroundType( Type:integer ):integer
     var RetVal:integer = -1;
     var i:integer = 0;
     while( i < v_SpGroundType.Size )
        if( v_SpGroundType[i].Type == Type )
           RetVal = v_SpGroundType[i].SpGround;
           break;
        end;
        i = i + 1;
     end;
     return RetVal;
  end;

  private macro AddSpGroundFIID( FIID:integer, SpGround:integer )
     var Ex:bool = false;
     var i:integer = 0;
     while( i < v_SpGroundFIID.Size )
        if( v_SpGroundFIID[i].FIID == FIID )
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     if( not Ex )
        v_SpGroundFIID[v_SpGroundFIID.Size] = SpGroundFIID(FIID, SpGround);
     end;
  end;

  private macro GetSpGroundFIID( FIID:integer ):integer
     var RetVal:integer = -1;
     var i:integer = 0;
     while( i < v_SpGroundFIID.Size )
        if( v_SpGroundFIID[i].FIID == FIID )
           RetVal = v_SpGroundFIID[i].SpGround;
           break;
        end;
        i = i + 1;
     end;
     return RetVal;
  end;

  private macro AddSpGroundFIIDType( FIID:integer, SpGround:integer, Type:integer )
     var Ex:bool = false;
     var i:integer = 0;
     while( i < v_SpGroundFIIDType.Size )
        if( (v_SpGroundFIIDType[i].FIID == FIID) and (v_SpGroundFIIDType[i].Type == Type) )
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     if( not Ex )
        v_SpGroundFIIDType[v_SpGroundFIIDType.Size] = SpGroundFIIDType(FIID, SpGround, Type);
     end;
  end;

  private macro GetSpGroundFIIDType( FIID:integer, Type:integer ):integer
     var RetVal:integer = -1;
     var i:integer = 0;
     while( i < v_SpGroundFIIDType.Size )
        if( (v_SpGroundFIIDType[i].FIID == FIID) and (v_SpGroundFIIDType[i].Type == Type) )
           RetVal = v_SpGroundFIIDType[i].SpGround;
           break;
        end;
        i = i + 1;
     end;
     return RetVal;
  end;

  macro УстановитьТекущийТип(Type:integer)
    v_CurrType = Type;
  end;

  macro СохранитьПДИзПоручения( SPgroundID, FIID )
     if( SpGroundID > 0 )
        if( CurrMethodFormPD() == DL_METHODFORMPD_FIID )
           AddSpGroundFIID(FIID, SpGroundID);
        elif( CurrMethodFormPD() == DL_METHODFORMPD_FIID_CE )
           if( (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS) OR (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) )
              AddSpGroundFIID(FIID, SpGroundID);
           else
              AddSpGroundFIIDType(FIID, SpGroundID, v_CurrType);
           end;
        elif( CurrMethodFormPD() == DL_METHODFORMPD_SUMM )
           v_SpGround = SpGroundID;
        elif( CurrMethodFormPD() == DL_METHODFORMPD_SUMM_CE )
           if( (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS) OR (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) )
              v_SpGround = SpGroundID;
           else
              AddSpGroundType(v_CurrType, SpGroundID);
           end;
        end;
     end;
  end;

  macro ПолучитьИдентификаторПД( FIID:integer ):integer
     var RetVal:integer = -1;

     if( CurrMethodFormPD() == DL_METHODFORMPD_EVERY )
        RetVal = -1;
     elif( CurrMethodFormPD() == DL_METHODFORMPD_FIID )
        RetVal = GetSpGroundFIID(FIID);
     elif( CurrMethodFormPD() == DL_METHODFORMPD_FIID_CE )
        if( (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS) OR (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) )
           RetVal = GetSpGroundFIID(FIID);
        else
           RetVal = GetSpGroundFIIDType(FIID, v_CurrType);
        end;
     elif( CurrMethodFormPD() == DL_METHODFORMPD_SUMM )
        RetVal = v_SpGround;
     elif( CurrMethodFormPD() == DL_METHODFORMPD_SUMM_CE )
        if( (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS) OR (CurrConsolidate() == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) )
           RetVal = v_SpGround;
        else
           RetVal = GetSpGroundType(v_CurrType);
        end;
     end;

     return RetVal;
  end;

  macro SetConsolidateAndMethodFormPD( Consolidate:integer, ClientConsolidate:integer, MethodFormPD:integer, ClientMethodFormPD:integer )
     v_Consolidate        = Consolidate;
     v_ClientConsolidate  = ClientConsolidate;
     v_MethodFormPD       = MethodFormPD;
     v_ClientMethodFormPD = ClientMethodFormPD;
  end;

  macro SetClient( Client:integer, IsPartyClient:bool )
     v_Client        = Client;
     v_IsPartyClient = IsPartyClient;
  end;

  macro Clear()
     v_SpGround = -1;
     v_SpGroundType.Size = 0;
     v_SpGroundFIID.Size = 0;
     v_SpGroundFIIDType.Size = 0;
  end;
end;

macro Depo_msgbox()
  var i = 0, StrErr = "", str = "";

  while(getparm(i,str))
    StrErr = StrErr + string(str);
    str = "";
    i = i + 1;
  end;

  i = 0;
  var StrErrHasAdded = false;
  if(FD != NULL)
    if(StrUpr( GenClassName( FD )) == StrUpr("SPFirstDocDLCOMM"))
      while( i < RepErrArr.size )
        if ( (RepErrArr[i].DealCode == FD.comm.rec.CommCode) and (RepErrArr[i].DealType == FD.GetOperationKindName()) )
          RepErrArr[i].ErrStr = RepErrArr[i].ErrStr + " \n";
          RepErrArr[i].ErrStr = RepErrArr[i].ErrStr + StrErr;
          StrErrHasAdded = true;
        end;
        i = i + 1;
      end;

      if(not StrErrHasAdded)
        RepErrArr[RepErrArr.size] = CSC_DepoRepErr(FD.comm.rec.CommCode, FD.GetOperationKindName(), StrErr);
      end;
    else
      while( i < RepErrArr.size )
        if ( (RepErrArr[i].DealCode == FD.tick.rec.DealCode) and (RepErrArr[i].DealType == FD.GetDealTypeName()) )
          RepErrArr[i].ErrStr = RepErrArr[i].ErrStr + " \n";
          RepErrArr[i].ErrStr = RepErrArr[i].ErrStr + StrErr;
          StrErrHasAdded = true;
        end;
        i = i + 1;
      end;

      if(not StrErrHasAdded)
        RepErrArr[RepErrArr.size] = CSC_DepoRepErr(FD.tick.rec.DealCode, FD.GetDealTypeName(), StrErr);
      end;
    end;
  else
    RepErrArr[RepErrArr.size] = CSC_DepoRepErr("", "", StrErr);
  end;
end;

/*печать отчета по данным xml*/
/*MACRO PrintDepoByXMLToSTD1(comm)
  var ReportLineData_XML:variant;
  var IsExistsCarry = false, IsExistsErr = false;
  var HeadPrinted = false;
  var ErrData:CSC_DepoRepErr;
  var Executer = DepoExecuter( {oper} );
  record DlComm("dl_comm");
  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*файл вывода для отчета*/
  var stat = 0;
  var query, cmd, DataSet;
  var PrevDepSetID = -1, PrevClientID = 0, ChangeClientType = true;
  var is_back, Group ;
  var cntobj = 0;

  SetBuff(DlComm, comm);
  
  ReportFileName = GetTxtFileName( "depo_" + DlComm.CommCode );
  if( not Open( ReportOutFile, ReportFileName ) )
     errcode = status(errtext);
     RunError( "Ошибка при создании файла|"+ReportFileName+"|(" + errcode + ") " + errtext );
  end;
  SetOutput( ReportFileName );

  println("                                    ПРОТОКОЛ ВЫПОЛНЕНИЯ ОПЕРАЦИИ ДЕПОЗИТАРНОГО УЧЕТА");
  println("                                           Дата операции: " + string(dlcomm.CommDate:f)+ " Код: " + dlcomm.CommCode);
  println();

  cmd = DL_RSDCommand();

  query =   " select td.t_DepSetID, td.t_ClientID, td.t_DealCode, "
          + "        kopr.t_Name OprName, grtempl.t_Name TemplName, spgr.t_Xld, dpkopr.t_Name DepoOprName, pm.t_Amount, "
          + "        NVL(depset.t_Code, CHR(1)) DepSetCode, NVL(depset.t_Market, -1) MarketID, "
          + "        (case when grdoc.t_SourceType = "+DLGR_SOURCETYPE_DEPOSUMMARY+" THEN CHR(88) ELSE CHR(0) END) IsSummary"
          + "   from ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal, doprkoper_dbt kopr, ddlgrtempl_dbt grtempl, "
          + "        dspdraft_dbt spdraft, dspground_dbt spgr, doprkoper_dbt dpkopr, dpmpaym_dbt pm, "
          + "        dv_sctotaldeals td "
          + "         left join ddldepset_dbt depset on depset.t_DepSetID = td.t_DepSetID "
          + "  where grdoc.t_ServDocKind = ? "
          + "    and grdoc.t_ServDocID = ? "
          + "    and grdoc.t_DocKind = " + DL_DEPODRAFT
          + "    and grdeal.t_ID = grdoc.t_GrDealID "
          + "    and td.t_DocKind = grdeal.t_DocKind "
          + "    and td.t_DocID = grdeal.t_DocID "
          + "    and kopr.t_Kind_Operation = td.t_Kind_Operation "
          + "    and grtempl.t_Num = grdeal.t_TemplNum "
          + "    and spdraft.t_AutoKey = grdoc.t_DocID "
          + "    and spgr.t_SPgroundID = spdraft.t_SPgroundID "
          + "    and dpkopr.t_Kind_Operation = spdraft.t_Kind_Operation "
          + "    and pm.t_DocKind = spdraft.t_Kind "
          + "    and pm.t_DocumentID = spdraft.t_AutoKey "
          + "    and pm.t_Purpose = " + BAi
          + "  order by td.t_DepSetID DESC, td.t_ClientID ASC, grdoc.t_ID ASC";



  cmd.AddParam(DlComm.DocKind);
  cmd.AddParam(DlComm.DocumentID);
  
  DataSet = cmd.Execute(query);
  stat = DataSet.MoveNext();
  while(stat)
    if(PrevDepSetID != DataSet.DepSetID)
      ChangeClientType = true;
      println("Схема расчетов " + DataSet.DepSetCode + " " + ПолучитьКодСубъекта(int(DataSet.MarketID), PTCK_CONTR));
    elif((PrevClientID == -1) and (DataSet.ClientID != PrevClientID))
      ChangeClientType = true;
    end;

    if(ChangeClientType == true)
      if(DataSet.ClientID == -1) 
        println("       Собственные сделки");
      else
        println("       Клиентские сделки");
      end;
                 
      println( "┌──────────┬──────────────────────────────┬────────────────────┬────────────────┬──────────────────┬──────────────────┬─────────┐" );
      println( "│  Номер   │         Тип сделки           │      Действие      │ Номер исх.     │  Тип поручения   │   Кол-во ц/б     │Сводное  │" );
      println( "│  сделки  │                              │                    │ документа      │                  │                  │         │" );
      println( "├──────────┼──────────────────────────────┼────────────────────┼────────────────┼──────────────────┼──────────────────┼─────────┤" );

      ChangeClientType = false;
    end;

               [│##########│##############################│####################│################│##################│##################│#########│]
               (DataSet.DealCode,
                DataSet.OprName:w,
                DataSet.TemplName:w,
                DataSet.Xld,  
                DataSet.DepoOprName:w,
                DataSet.Amount,
                DataSet.IsSummary
               );

    PrevDepSetID = DataSet.DepSetID;
    PrevClientID = DataSet.ClientID; 

    stat = DataSet.MoveNext();
    if((not stat) or ((PrevDepSetID != DataSet.DepSetID) or ((PrevClientID == -1) and (DataSet.ClientID != PrevClientID))))
      println( "└──────────┴──────────────────────────────┴────────────────────┴────────────────┴──────────────────┴──────────────────┴─────────┘" );
    else
      println( "├──────────┼──────────────────────────────┼────────────────────┼────────────────┼──────────────────┼──────────────────┼─────────┤" );
    end;
  end;

  ////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Таблица ошибок
  cmd = DL_RSDCommand("select 1 from ddlgrdoc_dbt where t_ServDocKind = ? and t_ServDocID = ?");
  cmd.AddParam(DlComm.DocKind);
  cmd.AddParam(DlComm.DocumentID);
  cntobj = cmd.GetCount();

  ReportLineData_XML = GetLogDataXML(DlComm.DocKind, DlComm.DocumentID, LOG_TYPE_ERROR, false);
  ReportLineData_XML.SetReportNumber(0);
  
  stat = ReportLineData_XML.Next();
  if((stat) or (cntobj == 0))

    println("");
    println("┌────────────┬──────────────────────────┬──────────────────────────────────────────────────────────────┐");
    println("│Номер сделки│Тип сделки                │Примечание                                                    │");
    println("├────────────┼──────────────────────────┼──────────────────────────────────────────────────────────────┤");

    HeadPrinted = true;

    if(not stat)
      if(cntobj > 0)
        println("Операция завершена успешно");
        println("");
      else
            [│############│##########################│##############################################################│]
            ("", "", "Нет подходящих сделок");
      end;
    else
      while(stat)
        ErrData = ReportLineData_XML.GetReportLineData();
            [│############│##########################│##############################################################│]
            (ErrData.DealCode, ErrData.DealType:w, ErrData.ErrStr:w);


        IsExistsErr = true;
        stat = ReportLineData_XML.Next();
      end;
    end;

    println("└────────────┴──────────────────────────┴──────────────────────────────────────────────────────────────┘");
    println("");
  else
    println("Операция завершена успешно");
    println("");
  end; 

  /////////////////////////////////////////////////////////////////////////////////////////////////////////
  println("Составил ( " + Executer.Post + " ):");
  println(string( Executer.Name:30 ) + "                 " + String( {curdate}:f ));
  println("────────────────────────────── ───────────────   дата");
  println("          ФИО                      подпись");

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );

  return true;
END;*/


CLASS TDraftTrnData(_IsSummary, _CurrType)
  var m_GroundPrmArr  = TArray();
  var m_IsSummary     = _IsSummary;
  var m_Draft         = NULL;
  var m_ParentGround  = NULL;
  var m_InitSpgroundID = 0;
  var m_CurrType      = _CurrType;

  macro Clear()
    m_GroundPrmArr.size = 0;
  end;

  macro SetDepoDraftParm(DraftParm, rq)
    m_Draft = RsbDpInsertDeferDraft();

    var err = m_Draft.SetDraftParm(DraftParm, rq);

    if(err)
      msgbox(m_Draft.GetErrStr());
    else
      m_InitSpgroundID = DraftParm.SpGroundID;
    end;

    return err;
  end;

  macro SetGroundPrmDeal(Parm)
    m_ParentGround = RsbDpInsertGroundDocument();
    
    var err = m_ParentGround.SetGroundParm(Parm);
    if(err)
      msgbox(m_ParentGround.GetErrStr());
    end;

    return err;
  end;

  macro SetSPgroundID(SPgroundID)
    m_Draft.SetSPgroundID(SPgroundID);
  end;

  macro AddGroundPrmArr(Parm)
    var i = m_GroundPrmArr.size;

    m_GroundPrmArr[i] = RsbDpInsertGroundDocument();
    var err = m_GroundPrmArr[i].SetGroundParm(Parm);
    if(err)
      msgbox(m_GroundPrmArr[i].GetErrStr());
    end;

    return err;
  end;

  //методы обработки
  macro Insert()
    var err = 0;
    var ErrStr = "";
    var SPgroundID = 0;
    var DraftID = 0, Kind = 0;
    
    if(m_ParentGround != NULL)
      err = m_ParentGround.Insert();
      if(err)
        msgbox(m_Draft.GetErrStr());
      else
        m_Draft.ParentSPgroundID = m_ParentGround.GetSPgroundID();
      end;
    end;

    if(not err)
      if(m_Draft.GetSPgroundID() == 0)
        FormPD.УстановитьТекущийТип(m_CurrType);
        SPgroundID = FormPD.ПолучитьИдентификаторПД(m_Draft.GetFIID());
        if(SPgroundID > 0)
          m_Draft.SetSPgroundID(SPgroundID);
        end;
      end;
      
      err = m_Draft.Insert();
      if(err)
        msgbox(m_Draft.GetErrStr());
      else 
        DraftID = m_Draft.GetDraftID();
        Kind    = m_Draft.GetKind();
      end;
    end;
     
    if((not err) and (m_GroundPrmArr.size > 0))
      var i = 0;
      

      while((i < m_GroundPrmArr.size) and (not err))
        m_GroundPrmArr[i].SetPrimaryDoc(Kind, DraftID);
        
        err = m_GroundPrmArr[i].Insert();
        if(err)
          msgbox(m_Draft.GetErrStr());
        end;

        i = i + 1;
      end;
    end;  

    if(not err)
      if(m_InitSpgroundID <= 0 )                           
        FormPD.СохранитьПДИзПоручения(m_Draft.GetSPgroundID(), m_Draft.GetFIID());
      end;                                                         
    end;
    
    return err;
  end;

  //Остальные методы
  macro IsSummary()
    return m_IsSummary;
  end;

  macro DraftID()
    return m_Draft.GetDraftID();
  end;

  macro SPgroundID()
    return m_Draft.GetSPgroundID();
  end;

  macro ParentSPgroundID()
    return m_Draft.ParentSPgroundID;
  end;

  macro FIID()
    return m_Draft.GetFIID();
  end;

  Clear();
  
END;

private class QuasiGroundData(_DealCode, _DealType)
  var DealType        = _DealType;
  var DealCode        = _DealCode;
end;

/*Класс для обработки проводок квазидепозитарного учета*/
class QuasiAccDataTrn(dl_comm:object, _execID, _conveyerID, _packetID)
  private var m_GrDealArr = TArray();    //массив обработанных строк графика
  private var m_GrDealTrnArr = TArray(); //массив проводок по графику
  private var m_GrDocArr = TArray();
  private var m_GroundArr = TArray(); /*массив оснований для проводок*/
  private var m_ServDocKind, m_ServDocID;
  private var m_dlgrdocCache = RsbSQLInsert("dlgrdoc.dbt");

  private var arrErrCode = TArray();
  private var arrErrMessage = TArray();
  private var accTrn = RsbAccTransactionData();
  private var m_dlgrdoc = TRecHandler("dlgrdoc.dbt");
  
  private var m_size;
  
  private var m_execID; 
  private var m_conveyerID;
  private var m_packetID;
  private var m_dl_comm;

  macro Clear()
    m_GrDealArr.size = 0;    
    m_GrDealTrnArr.size = 0;
    m_size=0;
  end;

  macro AddGrDoc(GrDealID, DocID, DocKind)
    var sz = m_GrDocArr.size;
	m_GrDocArr[sz] = TRecHandler("dlgrdoc.dbt");
	m_GrDocArr[sz].rec.ID = 0;
    m_GrDocArr[sz].rec.GrDealID = GrDealID;
    m_GrDocArr[sz].rec.DocID = 0;
    m_GrDocArr[sz].rec.DocKind = 1;
    m_GrDocArr[sz].rec.ServDocKind = DocKind;
    m_GrDocArr[sz].rec.ServDocID = DocId;
    m_GrDocArr[sz].rec.GrpID = 0;
    m_GrDocArr[sz].rec.SourceType = 0;

  end;
  
  macro AddGrDeal(GrDealID, DocKind, DocID, FIID)
    var sz = m_GrDealArr.size;
    m_GrDealArr[sz] = TRecHandler("dlgrdeal.dbt");
    m_GrDealArr[sz].rec.ID      = GrDealID;
    m_GrDealArr[sz].rec.DocKind = DocKind;
    m_GrDealArr[sz].rec.DocID   = DocID;
    m_GrDealArr[sz].rec.FIID    = FIID;
  end;

  macro AddAccTransactionData(Parm, Ground)
    m_GrDealTrnArr[m_GrDealTrnArr.size] = Parm;
    m_GroundArr[m_GroundArr.size] = Ground;
  end;

  macro Insert()
    var accTrnBatch = RsbBatchAccTrn;
    var resExecute = false;
    var ExecStr = "";
    var i=0, cntErr = 0;
    var err = 0;
    var cmd;

    while (i < m_GrDealTrnArr.size) //формируем проводки для пакетного исполнения
      accTrnBatch.AddAccTransaction( m_GrDealTrnArr[i], NULL, 0, 0 );
      i=i+1;
    end;

    resExecute = accTrnBatch.Execute(ACCTRN_EXEC_MODE_ONE_PACK); //исполняем проводки

    i = 0;                                                      
    var nCarry = accTrnBatch.GetResult( arrErrCode, arrErrMessage );

    while(i < nCarry)
      accTrn = accTrnBatch.GetAccTransaction(i);

      if( arrErrCode[i] == 0 )
	  
        m_GrDocArr[i].rec.DocID = accTrn.AccTrnID; //Для выполненной проводки устанавливаем 
		m_dlgrdocCache.AddRecord( m_GrDocArr[i] );

      else
        if( arrErrCode[i] != ACCTRN_PACKAGE_ERROR_NUMBER )
          RepErrArr[RepErrArr.size] = CSC_DepoRepErr(m_GroundArr[i].DealCode, m_GroundArr[i].DealType, "Ошибка №"+arrErrCode[i]+". Ошибка при выполнении проводки \""+accTrn.Ground+"\". " + arrErrMessage[i]);		  
          err = 1;
        end;		
      end;
      i = i + 1;
    end;    
		
    // выведем реальные ошибки
    if( not resExecute )
      i = 0;
      arrErrCode.size = 0;
      arrErrMessage.size = 0;
      cntErr = accTrnBatch.GetAddError(arrErrCode, arrErrMessage);
      while( i < cntErr )
        if( arrErrCode[i] != 0 )
           RepErrArr[RepErrArr.size] = CSC_DepoRepErr("", "", "Ошибка №"+arrErrCode[i]+". Ошибка при выполнении проводки. " + arrErrMessage[i]);
           err = 1;
        end;
        i = i + 1;
      end;
    end;

    i = 0;
    while((i < m_GrDealArr.size) and (not err))

      ExecStr = ExecStr + " RSI_DLGR.RSI_UpdateGrDealAccByID("+m_GrDealArr[i].rec.ID+","+DLGR_ACCKIND_CUSTODY+","+DLGRACC_STATE_FACTEXEC+");"; //формируем общий SQL-запрос для всех строк графика

        //Документ для строки графика - информация о том, что данная строка обрабатывалась в этой операции (не важно, сформировалось поручение или нет)
      m_dlgrdoc.Clear();
      m_dlgrdoc.rec.ID = 0;
      m_dlgrdoc.rec.GrDealID    = m_GrDealArr[i].rec.ID;
      m_dlgrdoc.rec.DocKind     = 0;     
      m_dlgrdoc.rec.DocID       = 0;        
      m_dlgrdoc.rec.ServDocKind = m_ServDocKind; 
      m_dlgrdoc.rec.ServDocID   = m_ServDocID;
      m_dlgrdoc.rec.GrpID = 0;
      m_dlgrdoc.rec.SourceType = 0;

      m_dlgrdocCache.AddRecord(m_dlgrdoc);
      i = i + 1;
    end;    	

    if((not err) and ( not m_dlgrdocCache.insert() ))
      err = 1;
    end;

    if(not err)
      if( ExecStr != "" )
         cmd = RSDCommand( "DECLARE BEGIN "+ ExecStr + " END; " ); //если что-то обрабатывалось исполняем общий SQL-запрос для всех строк графика
         cmd.execute();
      end;
    end;

    return err;
  end;

  Clear();
  m_ServDocKind = dl_comm.rec.DocKind;
  m_ServDocID   = dl_comm.rec.DocumentID;
  m_execID = _execID; 
  m_conveyerID =_conveyerID; 
  m_packetID = _packetID;
  m_dl_comm = dl_comm;

END;

/*класс для связи строк графика с поручением депо*/
CLASS TLnkGrDealToDraft(ServDocKind:integer, ServDocID:integer, IsTrans:bool)
  private var m_GrDealArr = TArray();
  private var m_spgrdocArr = TArray();
  private var m_spdrprop = TRecHandler("spdrprop.dbt");
  private var m_spdrpropCache;
  private var m_dlgrdoc = TRecHandler("dlgrdoc.dbt");
  private var m_dlgrdocCache;
  private var m_ServDocKind, m_ServDocID;
  private var m_DraftTrnDataArr = TArray();
  private var m_currDraftIndex = -1;
  private var m_UseOnceSpgr = false;
  private var m_CurrType = -1;
  private var m_IsTrans = false;

  macro Clear()
    m_GrDealArr.size = 0;
    m_spgrdocArr.size = 0;
    m_spdrpropCache = RsbSQLInsert("spdrprop.dbt");
    m_dlgrdocCache = RsbSQLInsert("dlgrdoc.dbt");
    var i = 0;
    while(i < m_DraftTrnDataArr.size)
      m_DraftTrnDataArr[i].Clear();
      i = i + 1;
    end;  
    m_DraftTrnDataArr.size = 0;
    m_currDraftIndex = 0;
    m_UseOnceSpgr = false;
    m_CurrType = -1;

    SQL_Execute("DELETE FROM DSPGROUND_TMP", "", false );
    SQL_Execute("DELETE FROM DSPGRDOC_TMP", "", false );
  end;

  macro UseOnceSpgr(need:bool)
    m_UseOnceSpgr = need;
  end;

  macro SetCurrType(type:integer)
    m_CurrType = type;
  end;

  macro StartNewDraft(IsSummary)
    m_currDraftIndex = m_DraftTrnDataArr.size;
    m_DraftTrnDataArr[m_currDraftIndex] = TDraftTrnData(IsSummary, m_CurrType);
  end;

  macro SetDepoDraftParm(DraftParm, rq)
    return m_DraftTrnDataArr[m_currDraftIndex].SetDepoDraftParm(DraftParm, rq);
  end;

  macro SetGroundPrmDeal(Parm)
    return m_DraftTrnDataArr[m_currDraftIndex].SetGroundPrmDeal(Parm);
  end;

  macro AddGroundPrmArr(Parm)
    return m_DraftTrnDataArr[m_currDraftIndex].AddGroundPrmArr(Parm);
  end;

  macro AddGrDeal(GrDealID, DocKind, DocID, FIID)
    var sz = m_GrDealArr.size;

    m_GrDealArr[sz] = TRecHandler("dlgrdeal.dbt");

    m_GrDealArr[sz].rec.ID      = GrDealID;
    m_GrDealArr[sz].rec.DocKind = DocKind;
    m_GrDealArr[sz].rec.DocID   = DocID;
    m_GrDealArr[sz].rec.FIID    = FIID;
  end;

  macro LinkDraft(DraftID, SPgroundID, IsSummary, FIID)
    var i = 0, j = 0, find = false;
    var err = 0;
    var sz = 0;

    while((i < m_GrDealArr.size) and (not err))
      
      if(m_GrDealArr[i].rec.FIID == FIID)

        //Связка поручения со строкой графика
        if(SPgroundID > 0)
          m_spdrprop.Clear();
          m_spdrprop.rec.PaymentID    = m_GrDealArr[i].rec.ID;  
          m_spdrprop.rec.DraftID      = DraftID;         
          m_spdrprop.rec.DocumentID   = m_GrDealArr[i].rec.ID;  
          m_spdrprop.rec.DocumentKind = DL_DLGRDEAL;
          m_spdrprop.rec.IsMain       = SET_CHAR;

          m_spdrpropCache.AddRecord(m_spdrprop);
        end;

        //Документ для строки графика - информация о сформированном поручении депо
        m_dlgrdoc.Clear();
        m_dlgrdoc.rec.GrDealID    = m_GrDealArr[i].rec.ID;   
        m_dlgrdoc.rec.DocKind     = DL_DEPODRAFT;     
        m_dlgrdoc.rec.DocID       = DraftID;        
        m_dlgrdoc.rec.ServDocKind = m_ServDocKind; 
        m_dlgrdoc.rec.ServDocID   = m_ServDocID;
        if(IsSummary)
          m_dlgrdoc.rec.SourceType = DLGR_SOURCETYPE_DEPOSUMMARY;
        end;

        m_dlgrdocCache.AddRecord(m_dlgrdoc); 

        if(SPgroundID > 0)
           var cmd = RsdCommand( " DECLARE BEGIN ? := rsb_depo.AddSPGRDOCTmpBySpgrID( ?, ?, ?); END; " );

           cmd.addParam( "", RSDBP_IN,  err );
           cmd.addParam( "", RSDBP_IN,  SPgroundID );
           cmd.addParam( "", RSDBP_IN,  m_GrDealArr[i].rec.DocKind );
           cmd.addParam( "", RSDBP_IN,  m_GrDealArr[i].rec.DocID );


           SQL_Execute( cmd );
        end; 
      end;

      i = i + 1;
    end;

    return err;
  end;

  macro Insert()
    var err = 0, ExecStr = "", cmd;
    var SPgroundID = 0;
    var i = 0;
    
    if(m_DraftTrnDataArr.size > 0)

      while((not err) and (i < m_DraftTrnDataArr.size))
        
        if((i > 0) and (SPgroundID > 0))
          m_DraftTrnDataArr[i].SetSPgroundID(SPgroundID);
        end;

        err = m_DraftTrnDataArr[i].Insert();
        if(not err)
          err = LinkDraft(m_DraftTrnDataArr[i].DraftID(), m_DraftTrnDataArr[i].ParentSPgroundID(), m_DraftTrnDataArr[i].IsSummary(), m_DraftTrnDataArr[i].FIID());
          if((not err) and (m_UseOnceSpgr == true) and (SPgroundID == 0))
            SPgroundID = m_DraftTrnDataArr[i].SPgroundID();
          end;
        end;

        i = i + 1;
      end;

    end; 

    if((not err) and (m_IsTrans == false)) //по транзитным не обновляем строки графика, т.к. их обновили раньше
      i = 0;
      while((i < m_GrDealArr.size) and (not err))

        ExecStr = ExecStr + " RSI_DLGR.RSI_UpdateGrDealAccByID("+m_GrDealArr[i].rec.ID+","+DLGR_ACCKIND_CUSTODY+","+DLGRACC_STATE_FACTEXEC+");";

        //Документ для строки графика - информация о том, что данная строка обрабатывалась в этой операции (не важно, сформировалось поручение или нет)
        m_dlgrdoc.Clear();
        m_dlgrdoc.rec.GrDealID    = m_GrDealArr[i].rec.ID;   
        m_dlgrdoc.rec.DocKind     = 0;     
        m_dlgrdoc.rec.DocID       = 0;        
        m_dlgrdoc.rec.ServDocKind = m_ServDocKind; 
        m_dlgrdoc.rec.ServDocID   = m_ServDocID;

        m_dlgrdocCache.AddRecord(m_dlgrdoc);

        i = i + 1;
      end;
  
    if(not err)
      if( ExecStr != "" )
         cmd = RSDCommand( "DECLARE BEGIN "+ ExecStr + " END; " );
         cmd.execute();
      end;
    end;
    end;

    if(not err)

      cmd = RsdCommand( " DECLARE BEGIN ? := rsb_depo.SyncSPGRDOCtmp(?, ?); END; " );

      cmd.addParam( "", RSDBP_IN,  err );
      cmd.addParam( "", RSDBP_IN,  0 );
      cmd.addParam( "", RSDBP_IN,  0 );

      SQL_Execute( cmd );
    end; 

    if((not err) and ((not m_spdrpropCache.insert()) or (not m_dlgrdocCache.insert())))
      err = 1;
    end;

    return err;
  end;

  Clear();
  m_ServDocKind = ServDocKind;
  m_ServDocID   = ServDocID;
  m_IsTrans     = IsTrans;

END;

PRIVATE VAR GrDealForLnk = NULL;

PRIVATE MACRO ДобавитьДепозитарнуюОперацию( FIID:INTEGER, Account:STRING, 
                                            Kind:INTEGER, Type:INTEGER, 
                                            Summa:MONEY, Deponent:INTEGER,
                                            State:INTEGER )
  ClearRecord( DocOffTMPAcc );
  DocOffTMPAcc.FIID     = FIID;
  DocOffTMPAcc.Account  = Account;
  DocOffTMPAcc.Kind     = Kind;
  DocOffTMPAcc.Type     = Type;
  DocOffTMPAcc.Deponent = Deponent;
  DocOffTMPAcc.State    = State;
  DocOffTMPAcc.Blocked  = 0;
  DocOffTMPAcc.DocOffID = 0;

  if( GetEQ( DocOffTMPAcc ) )                        
     DocOffTMPAcc.Summa = DocOffTMPAcc.Summa + Summa;
     Update( DocOffTMPAcc, null, true );
  else
     DocOffTMPAcc.Summa = Summa;
     Insert( DocOffTMPAcc, null, true );
  end;

  return 0;
END;

PRIVATE MACRO GetNextDocOffTMPState( State:INTEGER )
  ClearRecord( DocOffTMPState );
  DocOffTMPState.State = State;
  return (GetGE(DocOffTMPState) AND (DocOffTMPState.State == State) );
END;

PRIVATE MACRO DeleteDocOffTMPByID( Id:INTEGER )
  ClearRecord( DocOffTMP );
  DocOffTMP.Id = Id;
  if( GetEQ( DocOffTMP ) )
     Delete( DocOffTMP );
  end;
END;

PRIVATE MACRO UpdateDocOffTMPByID( DocOff:VARIANT )
  ClearRecord( DocOffTMP );
  DocOffTMP.Id = DocOff.Id;
  if( GetEQ( DocOffTMP ) )
     copy( DocOffTMP, DocOff );
     update( DocOffTMP, null, true );
  end;
END;

PRIVATE MACRO FindDocOffTMPAcc( Kind:INTEGER, Type:INTEGER, FIID:INTEGER, Account:STRING, Blocked:INTEGER, State:INTEGER )
  var cmd, DataSet;

  KeyNum(DocOffTMPAcc, 0);

  cmd = DL_RSDCommand(   " select t_ID from ddocoffdp_tmp "
                       + "  where t_FIID = ? " 
                       + "    and t_Account = ? "
                       + "    and t_Kind = ? " 
                       + "    and t_Type = ? "
                       + "    and t_Blocked = ? "
                       + "    and t_State = ? " 
           );
  cmd.addParam(FIID );
  cmd.addParam(Account );
  cmd.addParam(Kind );
  cmd.addParam(Type );
  cmd.addParam(Blocked );
  cmd.addParam(State );
  cmd.execute();
  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    ClearRecord( DocOffTMPAcc );
    DocOffTMPAcc.ID = DataSet.ID;
    if(GetEQ(DocOffTMPAcc))
      KeyNum(DocOffTMPAcc, 1);
         return DocOffTMPAcc;
      end;
   end;

  KeyNum(DocOffTMPAcc, 1);

  return null;
END;

PRIVATE MACRO СформироватьСальдовуюОперациюДЕПО( A:VARIANT, B:VARIANT )
  if( A.Summa == B.Summa )
     DeleteDocOffTMPByID( A.Id );
     DeleteDocOffTMPByID( B.Id );
  elif( A.Summa > B.Summa )
     A.Summa = A.Summa - B.Summa;
     A.State = STATE_EXECUTE; 
     UpdateDocOffTMPByID( A );
     DeleteDocOffTMPByID( B.Id );
  else /*B.Summa > A.Summa*/
     B.Summa = B.Summa - A.Summa;
     B.State = STATE_EXECUTE; 
     UpdateDocOffTMPByID( B );
     DeleteDocOffTMPByID( A.Id );
  end;
END; 

PRIVATE MACRO СверткаПротивоположныхОперацийДЕПО(Kind)
  var RecA, Type, NumCarry = 0, i = 0;

  InitProgress( -1, "Свертка противоположных операций ДЕПО", "Формирование поручений ДЕПО" );

  /*Изменяем ключевую последовательность (State), поэтому всегда GetGE*/
  while( GetNextDocOffTMPState( STATE_COMPARE ) )
    if( DocOffTMPState.Type == DEPO_TYPE_IN )
       Type = DEPO_TYPE_OUT;
    else
       Type = DEPO_TYPE_IN;
    end;

    RecA = FindDocOffTMPAcc( Kind, Type,
                             DocOffTMPState.FIID, DocOffTMPState.Account, DocOffTMPState.Blocked,
                             STATE_COMPARE
                           );

    if( RecA != NULL )
       СформироватьСальдовуюОперациюДЕПО( RecA, DocOffTMPState );
    else
       DocOffTMPState.State = STATE_EXECUTE; 
       UpdateDocOffTMPByID( DocOffTMPState );
    end;

    UseProgress( i = i + 1);
  end;

  RemProgress();
  return 0;
END;

PRIVATE MACRO ПоручениеПоНаполнениюТранзитногоСчетаДЕПО( DepSet, IsClient:BOOL )
   var Continue_cicle, Kind, i =0;
   var Consolidate = iif( IsClient, DepSet.rec.ClientConsolidate, DepSet.rec.Consolidate );
   var SetState = iif((Consolidate == DEPSET_METHODFORMDRAFT_ONECONS) OR (Consolidate == DEPSET_METHODFORMDRAFT_ONECONS_CLIR), STATE_COMPARE, STATE_EXECUTE);

   InitProgress( -1, "Поручения по наполнению транзитного счета ДЕПО", "Формирование сводных поручений" );

   ClearRecord( DocOffTMPFind );
   DocOffTMPFind.State = STATE_EXECUTE;

   Continue_cicle = GetGE(DocOffTMPFind);

   while( Continue_cicle AND
          (DocOffTMPFind.State == STATE_EXECUTE)
        )
      if( DocOffTMPFind.Kind == DEPO_KIND_SUMMARY )
         if( DocOffTMPFind.Deponent == {OurBank} )
            Kind = DEPO_KIND_TRANS_OWN;
         else
            Kind = DEPO_KIND_TRANS_CLNT;
         end;

         ДобавитьДепозитарнуюОперацию( DocOffTMPFind.FIID, "", 
                                       Kind, DocOffTMPFind.Type, 
                                       DocOffTMPFind.Summa, -1,
                                       SetState, DocOffTMPFind.Blocked, 
                                       DocOffTMPFind.DocOffID );

         if( Consolidate == DEPSET_METHODFORMDRAFT_BYDEAL ) /*Посделочно*/
           DeleteDocOffTMPByID( DocOffTMPFind.Id );
         end;
      end;
      Continue_cicle = Next( DocOffTMPFind );
      useprogress( i = i + 1 );
   end;

   if( (Consolidate == DEPSET_METHODFORMDRAFT_ONECONS) OR (Consolidate == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) ) /*одно св. поручение*/
     СверткаПротивоположныхОперацийДЕПО(iif(IsClient, DEPO_KIND_TRANS_CLNT, DEPO_KIND_TRANS_OWN));
   end;

   RemProgress();
   return 0;
END;

MACRO GetSubjByDocOff( DocOffTMP_DEPO:VARIANT, MarketID:INTEGER, Payer:@variant, Receiver:@variant )
   var Error = 0;

   if( DocOffTMP_DEPO.Blocked == 0 ) /*Нет блокировки*/
      if( DocOffTMP_DEPO.Type == DEPO_TYPE_IN ) /*зачисление*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = MarketID; 
            Receiver = DocOffTMP_DEPO.Deponent;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         end;
      else /*списание*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = DocOffTMP_DEPO.Deponent; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         end;
      end;
   else /*Блокировка*/
      if( DocOffTMP_DEPO.Type == DEPO_TYPE_IN )/*зачисление*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = MarketID; 
            Receiver = DocOffTMP_DEPO.Deponent;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         end;
      else /*списание*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = DocOffTMP_DEPO.Deponent; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         end;
      end;
   end;

   return Error;
END;

PRIVATE MACRO СчетНашегоБанка()
   var depoacnt = TBFile( "depoacnt", "R" ),
       DepoAccID, ErrCode, Account = "";
   
   GetRegistryValue( DEPO_TRANSIT_ACCOUNT, V_INTEGER, DepoAccID, ErrCode );
   if( ErrCode != 0 )
      MsgBox( "Ошибка при чтении настройки \"" + DEPO_TRANSIT_ACCOUNT + "\".");
   else
      if( DepoAccID <= 0 )
         MsgBox( "Не задано значение настройки \"" + DEPO_TRANSIT_ACCOUNT + "\".");
      else
         depoacnt.Clear();
         depoacnt.rec.AutoKey = DepoAccID;
         if( depoacnt.GetEQ() )
            Account = depoacnt.rec.BriefCode;
         else
            MsgBox( "Не найден счет ДЕПО, заданный в настройке \"" + DEPO_TRANSIT_ACCOUNT + "\"." );
         end;
      end;
   end;

   return Account;
END;

/* Импортировать из БОЦБ сводное поручение в депозитарий.
   Вызывается при выполнении св. проводок ДЕПО в операции Расчеты на ОРЦБ.
   Параметры :
      DocOff        - 
      MarketID      - биржа
      MarketOfficeID- сектор биржи*/
MACRO InsertDepoDraftSummary( DocOff, dl_comm, DepSet, IsClient, Lnk )

   var  Kind_Oper, MarketCode, DealType, OperDate, /*pm_obj,*/ FCorschem, ErrCode, DepoBlock = -1,
        IsClientPayment, CorrID=-1, CorrAcc="", OurCorrID=-1, OurCorrAcc="", InOurBalance=UNSET_CHAR;
   VAR  MarketID       = DepSet.rec.Market;//, 
        //MarketOfficeID = comm.PartyOfficeID;
   var  Payer=-1, Receiver=-1, PayerBankID=-1, ReceiverBankID=-1, PayerAccount="", ReceiverAccount="";
   var  sa = TRecHandler("settacc");
   var  rq = TRecHandler("dlrq");
   var  corschem = TBFile( "corschem", "R", 4 );

   GetSubjByDocOff( DocOff, MarketID, @Payer, @Receiver);
   sa.Clear();
   rq.Clear();

   if( DocOff.Type == DEPO_TYPE_IN ) /*зачисление*/
      DealType      = DEAL_TYPE_BUY;
      Kind_Oper     = SP_DEPOPER_ENROLMENT; /* "Зачислении безналичных ц/б" */

      if(SP_GetPartySETTACC(Payer, 0, DocOff.FIID, FIKIND_AVOIRISS, 0, sa) == 0)
        PayerAccount = sa.rec.Account;
        PayerBankID  = sa.rec.BankID;
      end;
   else 
      DealType      = DEAL_TYPE_SALE;
      Kind_Oper     = SP_DEPOPER_TRANSFERORDER; /* Поручение на междепозитарный перевод*/

      if(SP_GetPartySETTACC(Receiver, 0, DocOff.FIID, FIKIND_AVOIRISS, 0, sa) == 0)
        ReceiverAccount = sa.rec.Account;
        ReceiverBankID  = sa.rec.BankID;
      end; 
   end;

   if(sa.rec.SettAccID)
     OurCorrID = sa.rec.BankCorrID;
     if (sa.rec.BankCorrID != {OurBank})
        CorrAcc      = sa.rec.CorrAcc;
        CorrID       = sa.rec.BankCorrID;
        if(sa.rec.CorrAcc != "")
          KeyNum(corschem, 4);
          ClearRecord(corschem);
          corschem.rec.CorrID     = sa.rec.BankCorrID;
          corschem.rec.CorAccount = sa.rec.CorrAcc;
          if( getEQ(corschem) )
             OurCorrAcc = corschem.rec.Account;
             OurCorrId  = corschem.rec.CorrID;
             InOurBalance  = SET_CHAR;
          end;
        end;
      else
        OurCorrAcc = sa.rec.CorrAcc;
      end;
   end;

   if( DocOff.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
      if( (Payer == MarketID) /*Отправитель == биржа*/ and 
          (Receiver != {OurBank}) and
          (Receiver == DocOff.Deponent ) and (DocOff.Account != "")
        )
          ReceiverAccount = DocOff.Account;
      elif( (Receiver == MarketID) /*Получатель == биржа*/ and 
            (Payer != {OurBank}) and
            (Payer == DocOff.Deponent ) and (DocOff.Account != "")
          )
          PayerAccount = DocOff.Account;
      end;
   end; 

   if((Payer == {OurBank}) AND ((DocOff.Kind == DEPO_KIND_TRANS_OWN) OR (DocOff.Kind == DEPO_KIND_TRANS_CLNT)))
     PayerAccount = СчетНашегоБанка();
   elif((Receiver == {OurBank}) AND ((DocOff.Kind == DEPO_KIND_TRANS_OWN) OR (DocOff.Kind == DEPO_KIND_TRANS_CLNT)))
     ReceiverAccount = СчетНашегоБанка();
   end;

   if( ReceiverBankID <= 0 )
      ReceiverBankID = {OurBank};
   end;
   if( PayerBankID <= 0 )
      PayerBankID = {OurBank};
   end;

   OperDate   = dl_comm.rec.CommDate;
   MarketCode = ПолучитьКодГруппыБиржи( MarketID );
   if( (DocOff.Kind == DEPO_KIND_TRANS_CLNT) OR
       ((DocOff.Kind == DEPO_KIND_SUMMARY) and ((Payer != {OurBank}) and (Payer != MarketID)) OR ((Receiver != {OurBank}) and (Receiver != MarketID)))
     )
      IsClientPayment = true;
   else
      IsClientPayment = false;
   end;

   if(IsClientPayment)
     if(DepSet.rec.DPCorrNodeCln)
       if(GetCorrNodeInfo(DepSet.rec.DPCorrNodeCln, @OurCorrAcc, @OurCorrId, @DepoBlock))
         InOurBalance = SET_CHAR;
       else
         return 1;
       end;
     end;
   else
     if(DepSet.rec.DPCorrNodeOur)
       if(GetCorrNodeInfo(DepSet.rec.DPCorrNodeOur, @OurCorrAcc, @OurCorrId, @DepoBlock))
         InOurBalance = SET_CHAR;
       else
         return 1;
       end;
     end;
   end;

   ClearRecord(DepoDraftParm);

   Lnk.SetCurrType(DocOff.Type);

   DepoDraftParm.Kind         = Kind_Oper;
   DepoDraftParm.SignedDate   = OperDate;
   DepoDraftParm.RegisterDate = OperDate;
   DepoDraftParm.RegisterTime = Time();
   DepoDraftParm.DwPartyID    = Payer;  

   DepoDraftParm.DwAccCode   = PayerAccount;
   DepoDraftParm.DwCustodyID = PayerBankID;
   
   if( DealType == DEAL_TYPE_BUY ) /* покупка - распоряжение на зачисление */ 
      DepoDraftParm.DwCustodyAgentID = CorrID;
      DepoDraftParm.DwCorAcc         = CorrAcc;
      DepoDraftParm.DwOurCustAgentID = OurCorrID;
      DepoDraftParm.DwOurCorAcc      = OurCorrAcc;
      if(DepoBlock != -1)
        DepoDraftParm.Unblock = DepoBlock;
      end;
      DepoDraftParm.BnAccPurp = OBJTYPE_DEPOKINDTYPE_DEPONENT; 
   else
      DepoDraftParm.DwAccPurp = OBJTYPE_DEPOKINDTYPE_DEPONENT; 

      DepoDraftParm.BnCustodyAgentID = CorrID;
      DepoDraftParm.BnCorAcc         = CorrAcc;

      if( OurCorrAcc != "" )
         if( InOurBalance == SET_CHAR )
            DepoDraftParm.BnOurCorAcc = OurCorrAcc;
            if(DepoBlock != -1)
              DepoDraftParm.Block = DepoBlock;
            end;
         else
            FCorschem = TBFile( "corschem", "R", 4 );
            FCorschem.Clear();
            FCorschem.rec.CorrID     = CorrID;
            FCorschem.rec.CorAccount = OurCorrAcc;
            if( FCorschem.GetEQ() )
               DepoDraftParm.BnOurCorAcc = FCorschem.rec.Account;
               if(DepoBlock != -1)
                 DepoDraftParm.Block = DepoBlock;
               end;
            end;
         end;
      end;
   end;

   DepoDraftParm.BnPartyID   = Receiver;
   DepoDraftParm.BnAccCode   = ReceiverAccount;
   DepoDraftParm.BnCustodyID = ReceiverBankID;
   DepoDraftParm.Amount      = DocOff.Summa;
   DepoDraftParm.ValueDate   = OperDate;

   DepoDraftParm.DealKind = 395;//DOC_SUMMARY; /* Сводное поручение */
   DepoDraftParm.Agreed   = dl_comm.rec.CommDate;
   DepoDraftParm.DealXid  = dl_comm.rec.CommCode;

   DepoDraftParm.DealParty = {OurBank};

   DepoDraftParm.Product     = 1; /* Купля - продажа */
   DepoDraftParm.Oper        = {oper};
   DepoDraftParm.PaymentID   = 0;
   //DepoDraftParm.Initiator   = -1; /* инициатор */
   DepoDraftParm.Initiator  = GetDepoInitiator(DepoDraftParm, DepSet.rec.InitiatorKind, DocOff.Deponent);
   DepoDraftParm.GeneralizedFIID = DocOff.FIID;
   DepoDraftFillFIID_2( DocOff.FIID );

   if( (DocOff.Kind == DEPO_KIND_TRANS_OWN) OR 
       (DocOff.Kind == DEPO_KIND_TRANS_CLNT) )
      DepoDraftParm.FromTransitAccount = UNSET_CHAR;
      GetRegistryValue( ENROLOPRTRANSBLOCK, V_INTEGER, DepoBlock, ErrCode );
      if( ErrCode != 0 )
         MsgBox( "Ошибка при чтении настройки \"" + ENROLOPRTRANSBLOCK + "\".");
         return false;
      end;

      if( DealType == DEAL_TYPE_BUY )
         DepoDraftParm.Block = DepoBlock; /*Блокировка по счету получателя*/
      else
         DepoDraftParm.Unblock = DepoBlock; /*Блокировка по счету отправителя*/
      end;
   elif( DocOff.Kind == DEPO_KIND_SUMMARY)
      DepoDraftParm.FromTransitAccount = IIF(IsClient, DepSet.rec.OverTransAccCln, DepSet.rec.OverTransAcc);

      if( DealType == DEAL_TYPE_BUY )
         if( DocOff.Type == DEPO_TYPE_IN )
            DepoDraftParm.Block = OBJTYPE_DEPOACC_BLOCK_INMARKETS; /*Блокировка по счету получателя - на торгах*/
         else
            DepoDraftParm.Block = OBJTYPE_DEPOACC_BLOCK_REPO; /*Блокировка по счету получателя - РЕПО*/
         end;
      else
         if( DocOff.Type == DEPO_TYPE_IN )
            DepoDraftParm.Unblock = OBJTYPE_DEPOACC_BLOCK_INMARKETS; /*Блокировка по счету отправителя на торгах*/
         else
            DepoDraftParm.Unblock = OBJTYPE_DEPOACC_BLOCK_REPO; /*Блокировка по счету получателя - РЕПО*/
         end;
      end;
   end;

   DepoDraftParm.SettlementDate = dl_comm.rec.CommDate;
   DepoDraftParm.LateDeliveryDate = dl_comm.rec.CommDate;

   if((DocOff.Deponent > 0) and (DocOff.Deponent != {OurBank}))
     DepoDraftParm.DeponentDoc = DocOff.Deponent;
   end;
   
   var RetVal = InsertDraftParm(DepoDraftParm, rq, null, 0, 0, dl_comm, Lnk, true );

   return RetVal;
END;

PRIVATE MACRO СформироватьПорученияДЕПО( dl_comm, DepSet, IsClient, Lnk )
  
  var DocOff = TRecHandler( "docoffdp.tmp" );
  var i = 0, cmd, DataSet, Error = 0;

  cmd = DL_RSDCommand(  "select * from ddocoffdp_tmp where t_State = ? ORDER BY t_type " );
  cmd.AddParam( STATE_EXECUTE );

  var NumRec = cmd.GetCount();
  
  InitProgress( NumRec, "Формирование сводных поручений ДЕПО", "Формирование сводных поручений" );
  
  if( NumRec > 0 )

    DataSet = cmd.Execute();

    while( DataSet.moveNext() )
       DataSet.GetRecord().CopyTo( DocOff.rec );
        if( InsertDepoDraftSummary( DocOff.rec, dl_comm, DepSet, IsClient, Lnk ) == false)
          Error = 1;
       end;

       useprogress( i = i + 1 );
    end;
  end;

  if( not Error )
    RslDefCon.BeginTrans();

    Error = Lnk.Insert();

    if( Error )
      RslDefCon.RollbackTrans();
      msgbox("Ошибка при формировании сводного поручения");
    else
      RslDefCon.CommitTrans();
    end;
  end;

  Lnk.Clear();
  FormPD.Clear();

  RemProgress();
  
  return Error;
END;

/*Формирование поручений по части клиента-контрагента*/
PRIVATE MACRO ПорученияДляКлиентаКонтрагента( FD, avr_DlRq, DepSet, dl_comm, OperDate, GrDealFIID, SpGroundID:integer, UseTransAcc )
  var err = 0;
  record tick(dl_tick);

  copy(tick, FD.tick );

  if( IsOUTEXCHANGE( FD.Group ) ) /*Внебиржевая сделка*/

     /*(сделка с клиентом-контрагентом и настройка "вид поручений с клиентом-контрагентом" == "Списание + зачисление" и счет контрагента -в нашем банке)*/
     if( СделкаСКлиентомКонтрагентом(tick) AND (DL_KINDDEPODRAFTCLIENTCONTR == DL_KINDDEPODRAFTCLIENTCONTR_WRTENRL) AND (ДепозитарийКонтрагентаТО(avr_dlrq) == {OurBank})
       )
      if((avr_dlrq.rec.Kind == DLRQ_KIND_REQUEST) )
        if(InsertDraft_3_Out(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
          err = 1;
        end;
      end;
      if( (not err) and (avr_dlrq.rec.Kind == DLRQ_KIND_COMMIT) AND ( DL_KINDDEPODRAFTCLIENTCONTR == DL_KINDDEPODRAFTCLIENTCONTR_WRTENRL ) )
        if(InsertDraft_3_In(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
          err = 1;
        end;
      end;
     end;
  end;

  return err;
END;

/*Формирование поручений по части клиента (в т.ч. и НашегоБанка)*/
PRIVATE MACRO ПорученияДляКлиента( FD, avr_DlRq, DepSet, dl_comm, OperDate, GrDealFIID, SpGroundID:integer, UseTransAcc )
  var err = 0;
  var NeedDraft = true;
  record sf(sfcontr);
  record tick(dl_tick);

  copy(tick, FD.tick );

  if(IsClientDeal(tick))
    ClearRecord(sf);
    sf.ID = tick.ClientContrID;
    if(trim(readNoteForObject( OBJTYPE_SFCONTR, UniID( sf, OBJTYPE_SFCONTR), NOTEKIND_SFCONTR_ISOUTCUSTODY)) != "")
      NeedDraft = false;
    end;
  end;

  if((tick.BOfficeKind == DL_AVRWRTOWN) or (tick.BOfficeKind == DL_SECUROWN) or (tick.BOfficeKind == DL_RETIREMENT_OWN))
  
      if(NeedDraft == true)

        if( IsOUTEXCHANGE( FD.Group ) ) /*Внебиржевая сделка*/
          if(InsertDraft_2(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, 0, UNSET_CHAR/*UseTransAcc*/) == false)
            err = 1;
          end;
        else
           /*биржевые сделки, погашения*/
           if(InsertDraft_1(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, 0, UNSET_CHAR/*UseTransAcc*/) == false)
             err = 1;
           end;
        end;
      end;
  else
    if( IsOUTEXCHANGE( FD.Group ) ) /*Внебиржевая сделка*/
    
       /*Разблокирование счета при отказе от 2 части Репо*/
       //if( IsReject )
       //   err = InsertDraft_Reject( FD.tick.rec, avr_DlRq, avr_DlRq.rec.PlanDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group );

       /*счет владельца - в нашем банке и счет контрагента - не в нашем банке*/
       if( КлиентПоСделкеВНашемБанке( tick.ClientID, avr_DlRq.rec.DocKind, avr_DlRq.rec.DocID, avr_DlRq.rec.FIID, avr_DlRq.rec.Type ) AND 
             (ДепозитарийКонтрагентаТО(avr_dlrq) != {OurBank}) AND
             (NeedDraft == true)
           )
          if(InsertDraft_1(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
            err = 1;
          end;
       /*Внебиржевая клиентская сделка и счет клиента и контрагента - в нашем банке  */
       elif( ((IsClientDeal(tick) AND КлиентПоСделкеВНашемБанке( tick.ClientID, avr_DlRq.rec.DocKind, avr_DlRq.rec.DocID, avr_DlRq.rec.FIID, avr_DlRq.rec.Type )) OR
               (not IsClientDeal(tick))) AND
             (ДепозитарийКонтрагентаТО(avr_dlrq) == {OurBank}) AND
             ((СделкаСКлиентомКонтрагентом(tick) == false) OR
              ((СделкаСКлиентомКонтрагентом(tick)) AND (DL_KINDDEPODRAFTCLIENTCONTR == DL_KINDDEPODRAFTCLIENTCONTR_TRANSFER))
             ) AND
             (NeedDraft == true)
           )
          if(InsertDraft_2(tick, avr_DlRq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
            err = 1;
          end;

       /*Внебиржевая сделка банка и счет контрагента -в нашем банке */
       /*или (клиентская сделка с клиентом-контрагентом и настройка "вид поручений с клиентом-контрагентом" == "Списание + зачисление" и счет контрагента -в нашем банке)*/
       elif( ((not IsClientDeal(tick)) AND (ДепозитарийКонтрагентаТО(avr_dlrq) == {OurBank})) OR
             ((IsClientDeal(tick)) AND (СделкаСКлиентомКонтрагентом(tick) AND (DL_KINDDEPODRAFTCLIENTCONTR == DL_KINDDEPODRAFTCLIENTCONTR_WRTENRL) AND (ДепозитарийКонтрагентаТО(avr_dlrq) == {OurBank})))
           )
          if((avr_dlrq.rec.Kind != DLRQ_KIND_REQUEST) AND (NeedDraft == true))
            if(InsertDraft_3_Out(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
              err = 1;
            end;
          end;
          if( (not err) and ((avr_dlrq.rec.Kind != DLRQ_KIND_COMMIT) AND (NeedDraft == true)) AND ( DL_KINDDEPODRAFTCLIENTCONTR == DL_KINDDEPODRAFTCLIENTCONTR_WRTENRL ) )
             if(InsertDraft_3_In(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
               err = 1;
             end;
          end;

       /*Внебиржевые клиентские сделки и счет клиента - в не нашем банке и счет контрагента -в нашем банке*/
       elif( IsClientDeal(tick) AND
             (КлиентПоСделкеВНашемБанке( tick.ClientID, avr_DlRq.rec.DocKind, avr_DlRq.rec.DocID, avr_DlRq.rec.FIID, avr_DlRq.rec.Type ) == false) AND
             (ДепозитарийКонтрагентаТО(avr_dlrq) == {OurBank}) AND
             (NeedDraft == true)
           )
          if(InsertDraft_4(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
            err = 1;
          end;

       end;
    else
       /*биржевые и брокерские сделки, погашения, займ*/
       if(NeedDraft == true)
         if(InsertDraft_1(tick, avr_dlrq, DepSet, OperDate, FD.IsBack, FD.dl_leg.rec, FD.BuySale, FD.Group, NULL, dl_comm, GrDealForLnk, GrDealFIID, SpGroundID, UseTransAcc) == false)
           err = 1;
         end;
       end;
    end;
  end;

  return err;
END;

/*сформировать поручение по каждому подходящему ТО сделки сделке*/
PRIVATE MACRO СформироватьПорученияДЕПОПоСтрокеГрафика( FD, DepSet, dl_comm, GrDealID, TemplNum, OperDate, RQID, GrDealFIID, AddTransAcc )
  var query, cmd, DataSet;
  var RqType, DealPart;
  var rq = TRecHandler("dlrq");
  var err = 0;
  var Type, UseTransAcc;
   
  cmd = DL_RSDCommand();

  query =   " select rq.* "
          + "   from ddlrq_dbt rq, ddlgrdeal_dbt grdeal "
          + "  where grdeal.t_ID = ? "
          + "    and rq.t_DocKind = grdeal.t_DocKind "
          + "    and rq.t_DocID = grdeal.t_DocID "
          + "    and rq.t_SubKind = " + DLRQ_SUBKIND_AVOIRISS;

  cmd.AddParam(GrDealID);

  if( RQID == 0 )
    DealPart = 1;
    if( (TemplNum == DLGR_TEMPL_DEPODRAFT2) OR (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR2) )
      DealPart = 2;
    end;

    RqType = DLRQ_TYPE_DELIVERY;

    query = query + " and rq.t_Type = ? "
                  + " and rq.t_DealPart = ? ";

    cmd.AddParam(RqType);
    cmd.AddParam(DealPart);
  else
    query = query + " and rq.t_ID = ? ";
    cmd.AddParam(RQID);
  end;

  DataSet = cmd.Execute(query);

  while((not err) and DataSet.moveNext())
    DataSet.GetRecord().CopyTo( rq.rec );

    
    if( FD.BuySale == DEAL_TYPE_SALE )
       if( (TemplNum == DLGR_TEMPL_DEPODRAFT) OR (TemplNum == DLGR_TEMPL_DEPODRAFT2) OR (TemplNum == DLGR_TEMPL_COMPDELIVERY) )
          Type = DEPO_TYPE_OUT;
       elif( (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR) OR (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR2) OR (TemplNum == DLGR_TEMPL_COMPDELIVERYCONTR) )
          Type = DEPO_TYPE_IN;
       end;
    else
       if( (TemplNum == DLGR_TEMPL_DEPODRAFT) OR (TemplNum == DLGR_TEMPL_DEPODRAFT2) OR (TemplNum == DLGR_TEMPL_COMPDELIVERY) )
          Type = DEPO_TYPE_IN;
       elif( (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR) OR (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR2) OR (TemplNum == DLGR_TEMPL_COMPDELIVERYCONTR) )
          Type = DEPO_TYPE_OUT;
       end;
    end;


    GrDealForLnk.SetCurrType(Type);

    if( (TemplNum == DLGR_TEMPL_DEPODRAFT) OR (TemplNum == DLGR_TEMPL_DEPODRAFT2) OR (TemplNum == DLGR_TEMPL_COMPDELIVERY) )
       UseTransAcc = IIF(FD.tick.rec.ClientID != -1, DepSet.rec.OverTransAccCln, DepSet.rec.OverTransAcc);
       
       err = ПорученияДляКлиента(FD, rq, DepSet, dl_comm, OperDate, GrDealFIID, 0, UseTransAcc);

       if((not err) and (AddTransAcc == SET_CHAR)) /*Поручение по наполнению транзитного счета*/
           ДобавитьДепозитарнуюОперацию( rq.rec.FIID,
                                         "",
                                         IIF(FD.tick.rec.ClientID != -1, DEPO_KIND_TRANS_CLNT, DEPO_KIND_TRANS_OWN),
                                         Type,
                                         rq.rec.Amount,
                                         IIF(FD.tick.rec.ClientID != -1, FD.tick.rec.ClientID, {OurBank}),
                                         STATE_COMPARE
                                       );
       end;

    elif( (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR) OR (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR2) OR (TemplNum == DLGR_TEMPL_COMPDELIVERYCONTR) )
       UseTransAcc = DepSet.rec.OverTransAccCln;
       
       err = ПорученияДляКлиентаКонтрагента(FD, rq, DepSet, dl_comm, OperDate, GrDealFIID, 0, UseTransAcc);
       
       if((not err) and (AddTransAcc == SET_CHAR)) /*Поручение по наполнению транзитного счета*/
           ДобавитьДепозитарнуюОперацию( rq.rec.FIID,
                                         "",
                                         DEPO_KIND_TRANS_CLNT,
                                         Type,
                                         rq.rec.Amount,
                                         rq.rec.Party,
                                         STATE_COMPARE
                                       );
       end;
    end;
  end;

  return err;
END;

/*сформировать поручение по каждому подходящему ТО неттинга*/
PRIVATE MACRO СформироватьПорученияДЕПОПоСтрокеГрафикаДляНеттинга(dl_comm, DepSet, GrDealID, TemplNum, OperDate, RQID, GrDealFIID)
  var query, cmd, DataSet;
  var RqType, DealPart, DealType;
  var rq = TRecHandler("dlrq");
  var ntg = TBFile("dl_nett");
  record dl_nett("dl_nett");
  record dl_leg("dl_leg");
  var err = 0;
  
  cmd = DL_RSDCommand();

  query =   " select rq.* "
          + "   from ddlrq_dbt rq, ddlgrdeal_dbt grdeal "
          + "  where grdeal.t_ID = ? "
          + "    and rq.t_DocKind = grdeal.t_DocKind "
          + "    and rq.t_DocID = grdeal.t_DocID "
          + "    and rq.t_SubKind = " + DLRQ_SUBKIND_AVOIRISS;


  cmd.AddParam(GrDealID);

  if(RQID == 0)
    DealPart = 1;
    if((TemplNum == DLGR_TEMPL_DEPODRAFT2) OR (TemplNum == DLGR_TEMPL_DEPODRAFTCONTR2))
      DealPart = 2;
    end;

    RqType = DLRQ_TYPE_DELIVERY;

    query = query + " and rq.t_Type = ? "
                  + " and rq.t_DealPart = ? ";

    cmd.AddParam(RqType);
    cmd.AddParam(DealPart);
  else
    query = query + " and rq.t_ID = ? ";
    cmd.AddParam(RQID);
  end;

  DataSet = cmd.Execute(query);

  while((not err) and DataSet.moveNext())
    DataSet.GetRecord().CopyTo( rq.rec );
    if(rq.rec.Kind == DLRQ_KIND_REQUEST)
      DealType = DEAL_TYPE_BUY;
    else
      DealType = DEAL_TYPE_SALE;
    end;

    ntg.Clear();
    ntg.rec.NettingID = rq.rec.DocID;
    if(ntg.GetEQ())
      copy( dl_nett, ntg );
      if(InsertDraft_1( dl_nett, rq, DepSet, OperDate, false, dl_leg, DealType, 0, NULL, dl_comm, GrDealForLnk, GrDealFIID ) == false)
        err = 1;
      end;
    end;
  end;

  return err;
END;

private macro GetAcntByNSDCode(NSD_AcntCode:string, NSD_PartCode:string, RecordAcnt)
  var cmd, query, DataSet;

  query =   "select part.* "
          + "  from ddepoacnt_dbt part, ddepoacnt_dbt root "
          + " where part.t_Kind = 2 " //пассивный  
          + "   and part.t_Department = ? "
          + "   and root.t_AutoKey = part.t_Root "
          + "   and RTRIM(rsb_struct.getString(rsi_rsb_kernel.GetNote(112, TO_CHAR(root.t_AutoKey), 2, ?)), CHR(0)) = ? "
          + "   and RTRIM(rsb_struct.getString(rsi_rsb_kernel.GetNote(122, TO_CHAR(part.t_AutoKey), 2, ?)), CHR(0)) = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam({OperDprt});
  cmd.AddParam(date({curdate}));
  cmd.AddParam(NSD_AcntCode);
  cmd.AddParam(date({curdate}));
  cmd.AddParam(NSD_PartCode);
  
  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    DataSet.GetRecord().CopyTo( RecordAcnt.rec );
  end;
end;

private macro GetAcntFromRegistry(AcntID:@variant, Block:@variant)
  var err = 0;
  
  AcntID = 0; Block = 0;

  GetRegistryValue("DEPO\\NSD\\NSD_OWN_ACC", V_INTEGER, AcntID, err);
  if(err)
     msgbox("Ошибка при получении значения настройки DEPO\\NSD\\NSD_OWN_ACC" );
  elif(AcntID == 0)
    msgbox("Не задано значение настройки DEPO\\NSD\\NSD_OWN_ACC" );
    err = 1;
  end;

  if(not err)
    GetRegistryValue("DEPO\\NSD\\NSD_OWN_BLOCK", V_INTEGER, Block, err);
    if(err)
      msgbox("Ошибка при получении значения настройки DEPO\\NSD\\NSD_OWN_BLOCK" );
    elif(Block == 0)
      msgbox("Не задано значение настройки DEPO\\NSD\\NSD_OWN_BLOCK" );
      err = 1;
    end;
  end;
  return err;
end;

/*сформировать поручения по строке графика операции передача имущества в пул/возврат из пула*/
PRIVATE MACRO СформироватьПорученияДЕПОПоСтрокеГрафикаДляПула(dl_comm, GrDealID, TemplNum, OperDate, GrDealFIID, RQID, FD)
  var cmd, query, DataSet;
  var rq = TRecHandler("dlrq.dbt");
  var OldDepSet  = TBFile( "dldepset.dbt", "R", 0 );
  var NewDepSet  = TBFile( "dldepset.dbt", "R", 0 );
  var io_comm = TRecHandler("dl_comm.dbt");
  var BriefCode, OwnerID, Block, OldRootID, NewRootID, AcntID;
  record comm(dl_comm);
  var err = 0;
   
  query =   " select comm.* "
          + "   from ddl_comm_dbt comm, ddlgrdeal_dbt grdeal "
          + "  where grdeal.t_ID = ? "
          + "    and grdeal.t_DocKind = " + DL_SCINOUTPOOL
          + "    and comm.t_DocKind = grdeal.t_DocKind "
          + "    and comm.t_DocumentID = grdeal.t_DocID ";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(GrDealID);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    DataSet.GetRecord().CopyTo( io_comm.rec );
  else
    msgbox("Не найдена операция передачи имущества в пул/возврата из пула");
    return 1;
  end;
  
  OldDepSet.Clear();
  OldDepSet.rec.DepSetID = io_comm.rec.DepSetID;
  if( not OldDepSet.GetEQ() )
    msgbox("Не найдена исходная схема депозитарного учета по операции передачи имущества в пул/возврата из пула");
    return 1;
  end;

  NewDepSet.Clear();
  NewDepSet.rec.DepSetID = io_comm.rec.DepSetID_2;
  if( not NewDepSet.GetEQ() )
    msgbox("Не найдена новая схема депозитарного учета по операции передачи имущества в пул/возврата из пула");
    return 1;
  end;

  if(io_comm.rec.ClientID != -1)
    
    //сначала формируем списание
    ClearRecord(DepoDraftParm);
    DepoDraftParm.Kind         = SP_DEPOPER_BOOKORDER;
    DepoDraftParm.SignedDate   = OperDate;
    DepoDraftParm.RegisterDate = OperDate;
    DepoDraftParm.RegisterTime = Time();
    DepoDraftParm.DocKind      = 396; //DOCKIND_NSD_REPORT - Отчёт НРД;
    DepoDraftParm.AltXid       = io_comm.rec.NumberNRD;

    if(OldDepSet.rec.DPCorrNodeOur)
      if(GetCorrNodeInfo(OldDepSet.rec.DPCorrNodeCln, @BriefCode, @OwnerID, @Block, @OldRootID))
        DepoDraftParm.BnPartyID   = OwnerID;
        DepoDraftParm.BnAccCode   = BriefCode;
        DepoDraftParm.Block       = Block;
        DepoDraftParm.BnCustodyID = {OurBank};
      else
        return 1;
      end;
    else
      msgbox("В параметрах исходной схемы депозитарного учёта не заполнено поле \"Корсчёт/раздел для клиентских сделок\"");
      return 1;
    end;

    DepoDraftParm.DwPartyID   = io_comm.rec.ClientID;
    DepoDraftParm.DwAccCode   = "";
    //DepoDraftParm.UnBlock     = Block;
    DepoDraftParm.DwCustodyID = {OurBank};

    DepoDraftParm.Amount      = io_comm.rec.Hidden_Sum;
    DepoDraftParm.ValueDate   = OperDate;

    DepoDraftParm.Product     = 1; /* Купля - продажа */
    DepoDraftParm.Oper        = {oper};
    DepoDraftParm.PaymentID   = 0;
    DepoDraftParm.Initiator   = -1;
    DepoDraftParm.GeneralizedFIID = io_comm.rec.FIID;
    DepoDraftFillFIID_2( io_comm.rec.FIID );

    DepoDraftParm.SettlementDate = dl_comm.rec.CommDate;
    DepoDraftParm.LateDeliveryDate = dl_comm.rec.CommDate;

    DepoDraftParm.UserLog = SPGRUSERLOG_CLIENT;

    rq.Clear(); //просто пустое ТО
    
    rq.rec.FIID  = io_comm.rec.FIID;
    rq.rec.Party = io_comm.rec.ClientID;
    
    if(InsertDraftParm(DepoDraftParm, rq, null, io_comm.rec.DocKind, io_comm.rec.DocumentID, dl_comm, GrDealForLnk, false ) == false)
      return 1;
    end;

    //Теперь формируем зачисление
    ClearRecord(DepoDraftParm);
    DepoDraftParm.Kind         = SP_DEPOPER_BOOKORDER;
    DepoDraftParm.SignedDate   = OperDate;
    DepoDraftParm.RegisterDate = OperDate;
    DepoDraftParm.RegisterTime = Time();
    DepoDraftParm.DocKind      = 396; //DOCKIND_NSD_REPORT - Отчёт НРД;
    DepoDraftParm.AltXid       = io_comm.rec.NumberNRD;

    if(NewDepSet.rec.DPCorrNodeOur)
      if(GetCorrNodeInfo(NewDepSet.rec.DPCorrNodeCln, @BriefCode, @OwnerID, @Block, @NewRootID))
        DepoDraftParm.DwPartyID   = OwnerID;
        DepoDraftParm.DwAccCode   = BriefCode;
        DepoDraftParm.UnBlock     = Block;
        DepoDraftParm.DwCustodyID = {OurBank};
      else
        return 1;
      end;
    else
      msgbox("В параметрах исходной схемы депозитарного учёта не заполнено поле \"Корсчёт/раздел для клиентских сделок\"");
      return 1;
    end;

    DepoDraftParm.BnPartyID   = io_comm.rec.ClientID;
    DepoDraftParm.BnAccCode   = "";
    //DepoDraftParm.Block     = Block;
    DepoDraftParm.BnCustodyID = {OurBank};

    DepoDraftParm.Amount      = io_comm.rec.Hidden_Sum;
    DepoDraftParm.ValueDate   = OperDate;

    DepoDraftParm.Product     = 1; /* Купля - продажа */
    DepoDraftParm.Oper        = {oper};
    DepoDraftParm.PaymentID   = 0;
    DepoDraftParm.Initiator   = -1;
    DepoDraftParm.GeneralizedFIID = io_comm.rec.FIID;
    DepoDraftFillFIID_2( io_comm.rec.FIID );

    DepoDraftParm.SettlementDate = dl_comm.rec.CommDate;
    DepoDraftParm.LateDeliveryDate = dl_comm.rec.CommDate;

    DepoDraftParm.UserLog = SPGRUSERLOG_CLIENT;

    rq.Clear(); //просто пустое ТО
    
    rq.rec.FIID  = io_comm.rec.FIID;
    rq.rec.Party = io_comm.rec.ClientID;
    
    if(InsertDraftParm(DepoDraftParm, rq, null, io_comm.rec.DocKind, io_comm.rec.DocumentID, dl_comm, GrDealForLnk, false ) == false)
      return 1;
    end;

  else
    //Сначала формируем перемещение
    ClearRecord(DepoDraftParm);
    
    DepoDraftParm.Kind         = SP_DEPOPER_BOOKORDER;
    DepoDraftParm.SignedDate   = OperDate;
    DepoDraftParm.RegisterDate = OperDate;
    DepoDraftParm.RegisterTime = Time();
    DepoDraftParm.DocKind      = 396; //DOCKIND_NSD_REPORT - Отчёт НРД;
    DepoDraftParm.AltXid       = io_comm.rec.NumberNRD;

    if(OldDepSet.rec.DPCorrNodeOur)
      if(GetCorrNodeInfo(OldDepSet.rec.DPCorrNodeOur, @BriefCode, @OwnerID, @Block, @OldRootID))
        DepoDraftParm.BnPartyID   = OwnerID;
        DepoDraftParm.BnAccCode   = BriefCode;
        DepoDraftParm.Block       = Block;
        DepoDraftParm.BnCustodyID = {OurBank};
      else
        return 1;
      end;
    else
      msgbox("В параметрах исходной схемы депозитарного учёта не заполнено поле \"Корсчёт/раздел для собственных сделок\"");
      return 1;
    end;


    if(NewDepSet.rec.DPCorrNodeOur)
      if(GetCorrNodeInfo(NewDepSet.rec.DPCorrNodeOur, @BriefCode, @OwnerID, @Block, @NewRootID))
        DepoDraftParm.DwPartyID   = OwnerID;
        DepoDraftParm.DwAccCode   = BriefCode;
        DepoDraftParm.UnBlock     = Block;
        DepoDraftParm.DwCustodyID = {OurBank};
      else
        return 1;
      end;
    else
      msgbox("В параметрах новой схемы депозитарного учёта не заполнено поле \"Корсчёт/раздел для собственных сделок\"");
      return 1;
    end;            
    
    DepoDraftParm.Amount      = io_comm.rec.Hidden_Sum;
    DepoDraftParm.ValueDate   = OperDate;

    DepoDraftParm.Product     = 1; /* Купля - продажа */
    DepoDraftParm.Oper        = {oper};
    DepoDraftParm.PaymentID   = 0;
    DepoDraftParm.Initiator  = {OurBank};
    DepoDraftParm.GeneralizedFIID = io_comm.rec.FIID;
    DepoDraftFillFIID_2( io_comm.rec.FIID );

    DepoDraftParm.SettlementDate = dl_comm.rec.CommDate;
    DepoDraftParm.LateDeliveryDate = dl_comm.rec.CommDate;

    DepoDraftParm.UserLog = SPGRUSERLOG_OURENTER;

    rq.Clear(); //просто пустое ТО
    
    rq.rec.FIID = io_comm.rec.FIID;
    
    if(InsertDraftParm(DepoDraftParm, rq, null, io_comm.rec.DocKind, io_comm.rec.DocumentID, dl_comm, GrDealForLnk, false ) == false)
      return 1;
    end;

    
    //теперь формируем поручение на перевод, если необходимо
    var OldRootCodeNRD = readNoteForObject( 112/*Счёт депо*/, string(OldRootID), 2);
    var OldPartCodeNRD = readNoteForObject( 122/*Счёт депо*/, string(OldDepSet.rec.DPCorrNodeOur), 2);

    var NewRootCodeNRD = readNoteForObject( 112/*Счёт депо*/, string(NewRootID), 2);
    var NewPartCodeNRD = readNoteForObject( 122/*Счёт депо*/, string(NewDepSet.rec.DPCorrNodeOur), 2);

    var OldPassiveAcnt = TRecHandler("depoacnt.dbt");
    var NewPassiveAcnt = TRecHandler("depoacnt.dbt");

    OldPassiveAcnt.Clear();
    NewPassiveAcnt.Clear();

    if((OldRootCodeNRD != "") and (OldPartCodeNRD != ""))
      GetAcntByNSDCode(OldRootCodeNRD, OldPartCodeNRD, OldPassiveAcnt);
    end;
    if((NewRootCodeNRD != "") and (NewPartCodeNRD != ""))
      GetAcntByNSDCode(NewRootCodeNRD, NewPartCodeNRD, NewPassiveAcnt);
    end;

    if((OldPassiveAcnt.rec.AutoKey == 0) and (NewPassiveAcnt.rec.AutoKey == 0))
      //перевод не требуется
      return 0;
    end;  

    ClearRecord(DepoDraftParm);
    
    DepoDraftParm.Kind         = SP_DEPOPER_BOOKORDER;
    DepoDraftParm.SignedDate   = OperDate;
    DepoDraftParm.DocKind      = 396; //DOCKIND_NSD_REPORT - Отчёт НРД;
    DepoDraftParm.RegisterDate = OperDate;
    DepoDraftParm.AltXid       = io_comm.rec.NumberNRD;

    if(OldPassiveAcnt.rec.AutoKey > 0)
      if(GetCorrNodeInfo(OldPassiveAcnt.rec.AutoKey, @BriefCode, @OwnerID, @Block))
        DepoDraftParm.DwPartyID   = OwnerID;
        DepoDraftParm.DwAccCode   = BriefCode;
        DepoDraftParm.UnBlock     = Block;
        DepoDraftParm.DwCustodyID = {OurBank};
      else
        return 1;
      end;
    else
      if((GetAcntFromRegistry(@AcntID, @Block)==0) and (GetCorrNodeInfo(AcntID, @BriefCode, @OwnerID, @Block)))
        DepoDraftParm.DwPartyID   = OwnerID;
        DepoDraftParm.DwAccCode   = BriefCode;
        DepoDraftParm.UnBlock     = Block;
        DepoDraftParm.DwCustodyID = {OurBank};
      else
        return 1;
      end;
    end;

    if(NewPassiveAcnt.rec.AutoKey > 0)
      if(GetCorrNodeInfo(NewPassiveAcnt.rec.AutoKey, @BriefCode, @OwnerID, @Block))
        DepoDraftParm.BnPartyID   = OwnerID;
        DepoDraftParm.BnAccCode   = BriefCode;
        DepoDraftParm.Block       = Block;
        DepoDraftParm.BnCustodyID = {OurBank};
      else
        return 1;
      end;
    else
      if((GetAcntFromRegistry(@AcntID, @Block)==0) and (GetCorrNodeInfo(AcntID, @BriefCode, @OwnerID, @Block)))
        DepoDraftParm.BnPartyID   = OwnerID;
        DepoDraftParm.BnAccCode   = BriefCode;
        DepoDraftParm.Block       = Block;
        DepoDraftParm.BnCustodyID = {OurBank};
      else
        return 1;
      end;
    end;

    if(DepoDraftParm.DwAccCode == DepoDraftParm.BnAccCode)
      //перевод не требуется
      return 0;
    end; 

    DepoDraftParm.Amount      = io_comm.rec.Hidden_Sum;
    DepoDraftParm.ValueDate   = OperDate;

    DepoDraftParm.Product     = 1; /* Купля - продажа */
    DepoDraftParm.Oper        = {oper};
    DepoDraftParm.PaymentID   = 0;
    DepoDraftParm.Initiator  = {OurBank};
    DepoDraftParm.GeneralizedFIID = io_comm.rec.FIID;
    DepoDraftFillFIID_2( io_comm.rec.FIID );

    DepoDraftParm.SettlementDate = dl_comm.rec.CommDate;
    DepoDraftParm.LateDeliveryDate = dl_comm.rec.CommDate;

    DepoDraftParm.UserLog = SPGRUSERLOG_OURENTER;

    rq.Clear(); //просто пустое ТО
    if(InsertDraftParm(DepoDraftParm, rq, null, io_comm.rec.DocKind, io_comm.rec.DocumentID, dl_comm, GrDealForLnk, false ) == false)
      return 1;
    end;
  end;

  return err;
END;

private macro LinkAllGrDealDraft(GrDealID, FIID)
  var sql, DataSet, DraftID = 0;
  var cnt = 0;

  sql = DL_RSDCommand("Select t_DraftID " +
                      "  From dspdrprop_dbt Prop " +
                      " Where Prop.t_PaymentID = ? " +
                      "   And Prop.t_DocumentID = ? " +
                      "   And Prop.t_DocumentKind = ? " +
                      "   And Prop.t_PaymentID = Prop.t_DocumentID " 
                     );
                           
  sql.addParam( GrDealID );
  sql.addParam( GrDealID );
  sql.addParam( DL_DLGRDEAL );
  DataSet = sql.execute();

  while(DataSet.MoveNext())
    GrDealForLnk.LinkDraft(int(DataSet.DraftID), 0, false, FIID);
    cnt = cnt + 1;
  end;

  return cnt;
end;


private macro GetDepoDraft(GrDealID)
  var sql, DataSet, DraftID = 0;

  sql = DL_RSDCommand("Select t_DraftID " +
                      "  From dspdrprop_dbt Prop " +
                      " Where Prop.t_PaymentID = ? " +
                      "   And Prop.t_DocumentID = ? " +
                      "   And Prop.t_DocumentKind = ? " +
                      "   And Prop.t_PaymentID = Prop.t_DocumentID " 
                     );
                           
  sql.addParam( GrDealID );
  sql.addParam( GrDealID );
  sql.addParam( DL_DLGRDEAL );
  DataSet = sql.execute();

  if (DataSet.MoveNext())
     DraftID = DataSet.DraftID;
  end;

  return DraftID;
end;

private macro SplitExpDepoCode(_ExpDepoCode:STRING, _DepoAccCode:@STRING, _DepoPartCode:@STRING)
  var ind;
  ind = Index(_ExpDepoCode, "/");
  if ( ind == 0)
    _DepoAccCode=_ExpDepoCode;
    _DepoPartCode="";
  else
    _DepoAccCode=SubStr(_ExpDepoCode, 1, ind-1);
    _DepoPartCode=SubStr(_ExpDepoCode, ind+1);
  end;
end;

private macro DepSetSubstitution(depsetid:@variant, FOundDepsetId:@variant, FoundDepositary:@variant, ExtDepoCodeOur:@variant)
  var _cmd, _rs;
  _cmd =  RSDCommand("select * from  ddldepset_dbt where t_code = 'MS'");
  _rs = Rsdrecordset(_cmd, rsdval_client, rsdval_static);
  if (_rs.movenext)
     depsetid = _rs.value("T_DEPSETID");
     FoundDepositary = _rs.value("T_DEPOSITARY");
     FOundDepsetId =  _rs.value("T_DEPSETID");
     ExtDepoCodeOur =  _rs.value("T_EXTDEPOCODEOUR");
  end;
end;


macro FindPoolOperation(_DocKind, _DocID, buff:TRecHandler)

  var sql, query, DataSet;
  var err=0;
   

  query= "SELECT DEPSET.T_EXTDEPOCODEOUR FROM DDL_COMM_DBT IOCOMM, DDLGRDEAL_DBT, DDLDEPSET_DBT DEPSET WHERE "+
             "IOCOMM.T_DOCKIND = ? "+
         "AND IOCOMM.T_DOCUMENTID = ? "+
         "AND DEPSET.T_DEPSETID = IOCOMM.T_DEPSETID ";
		 
  sql = DL_RsdCommand(query);
  sql.AddParam(_DocKind);
  sql.AddParam(_DocID);  
  DataSet = sql.Execute();
  
  if( DataSet.MoveNext() )
    DataSet.GetRecord().CopyTo(buff.rec);
  else 
    err=1;
  end;
  
  return err;
END;

private macro FindQDARegistry(_Depositary:INTEGER, _DepoAccCode:STRING, _DepoPartCode:STRING, FIID:INTEGER, buff:TRecHandler, pDate:DATE)
  var sql, query, DataSet;
  var err=0;
  var RestN = 0, ErrStrN;
  var ScQrAccN = TRecHandler("scqracc.dbt");
  buff.Clear();
  var vDate = {CurDate};
  if (valType(pDate) != v_Undef)
    vDate = pDate;
  end; 
  query= "SELECT * FROM DSCQRACC_DBT QrAcc WHERE " +
         "     QrAcc.T_STORAGEID = ?    " +
         " AND QrAcc.T_DEPOACCCODE = ?  " +
         " AND QrAcc.T_DEPOPARTCODE like ('%" + _DepoPartCode + "%') " +
         " AND QrAcc.T_FIID = ? ";          
		 
  sql = DL_RsdCommand(query);
  sql.AddParam(_Depositary);
  sql.AddParam(_DepoAccCode);
//  sql.AddParam(_DepoPartCode);
  sql.AddParam(FIID);
  DataSet = sql.Execute();

  if( DataSet.MoveNext() )
    DataSet.GetRecord().CopyTo(buff.rec);
  else 
      ScQrAccN.Clear();
      ScQrAccN.rec.StorageId = _Depositary;
      ScQrAccN.rec.Fiid = Fiid;
      ScQrAccN.rec.DepoAccCode = _DepoAccCode;
      ScQrAccN.rec.DepoPartCode = _DepoPartCode; 
      err = СоздатьЗаписьВРегистреКДУ(ScQrAccN, vDate, RestN, @ErrStrN);
     
     DataSet = sql.Execute();
     if( DataSet.MoveNext() )
      DataSet.GetRecord().CopyTo(buff.rec);
     else
    err=1;
  end;

  end;
  return err;
end;

private macro GetQuasiDepoData(quasiaccdata:variant, _taskID, _execID, _conveyerID, _operationID, _packetID, dl_comm, Department, ClientID, Session, MarketSchemeID, FIID)

  var query, cmd, DataSet;
  var DepoAccCode:STRING;
  var DepoPartCode:STRING;  
  var cnt;
  var stat, err=0;
  var QrRec = TRecHandler("scqracc.dbt");

  cmd = DL_RSDCommand();
  
  if((_conveyerID) and (_packetID))
    query =  "with cnvdoc as (select * from dcnvdoc_dbt where t_ExecID = ? and t_ConvTypeID = ? and t_PackID = ?)";
    cmd.AddParam(_execID);
    cmd.AddParam(_conveyerID);
    cmd.AddParam(_packetID);
  else
    query =  "with cnvdoc as ("+GetDepoAccObjectQuery(dl_comm, Department, ClientID, Session, MarketSchemeID, FIID)+")";
  end;

  query = query + " ,grdealrec as (select grdeal.T_DOCID as t_dealid, grdeal.t_fiid, grdeal.t_plandate from ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, cnvdoc where "
                + " cnvdoc.t_ObjectID = gracc.T_ID and gracc.T_GRDEALID = grdeal.T_ID) ";

  query = query
          + " select /*+ ORDERED */  td.t_DocID, td.t_DocKind, td.t_DepSetID, td.t_ClientID, td.t_IsPartyClient, td.t_PartyID, td.t_DealCode, "
                  + "grdeal.t_TemplNum, grdeal.t_ID as GrDealID, grdeal.t_PlanDate, grdeal.t_FIID, "
                  + "NVL(rq.t_ID, 0) as RQID, NVL(rq.t_DealPart, 0) as DealPart, NVL(rq.t_FIID, -1) as RqFIID, NVL(rq.t_Type, 0) as RqType, NVL(rq.t_Num, 0) as RqNum, "
                  + "NVL(rq.t_Amount, 0) as RqAmount, "
                  + "NVL(depset.t_depsetId, -1) as FoundDepsetID, "
                  + "NVL(depset.t_depositary, -1) as FoundDepositary, "
                  + "NVL(depset.t_extdepocodeour, CHR(1) ) as extdepocodeour, "
                  + "iocomm.t_depsetid as ioDepsetID, iocomm.t_depsetid_2 as ioDepsetID_2, iocomm.t_hidden_sum as IoHiddenSum, "
                  + "iodepset.t_depositary as ioDepositary, iodepset2.t_depositary as io2Depositary, "
                  + "NVL(iodepset.t_extdepocodeour, CHR(1) ) as t_ioextdepocodeour, NVL(iodepset2.t_extdepocodeour, CHR(1) ) as t_ioextdepocodeour_2, "
                  + "NVL(wrtacc.t_account, CHR(1) ) as wrtqracc, NVL(enrlacc.t_account, CHR(1) ) as enrlqracc, "
                  + "wrtacc.t_chapter as wrtchapter, enrlacc.t_chapter as enrlchapter, "
                  + "wrtacc.t_code_currency as WrtCodeCurrency, enrlacc.t_code_currency as EnrlCodeCurrency, "
		          + "koper.t_name as DealType, "
          + "        (case when td.t_DocKind != " + DL_SECURITYDOC + " THEN -1 ELSE (select NVL(leg.t_Session, -1) "
          + "                                                                          from ddl_leg_dbt leg "
          + "                                                                         where leg.t_DealID  = td.t_DocID "
          + "                                                                           and leg.t_LegKind = (case when grdeal.t_TemplNum in(" + DLGR_TEMPL_DEPODRAFT2 + "," + DLGR_TEMPL_DEPODRAFTCONTR2 + ") THEN " + LEG_KIND_DL_TICK_BACK + " ELSE " + LEG_KIND_DL_TICK + " END) "
          + "                                                                           and leg.t_LegID   = 0 "
          + "                                                                           and rownum = 1 "
          + "                                                                       ) END) as t_Session, "
		  
	          + "RSB_SECUR.IsBUY(RSB_SECUR.get_OperationGroup(koper.t_SysTypes)) IsDealBuy, "
                  + "RSB_SECUR.IsSale(RSB_SECUR.get_OperationGroup(koper.t_SysTypes)) IsDealSale, "
                  + "RSB_SECUR.IsAvrWrtIn(RSB_SECUR.get_OperationGroup(koper.t_SysTypes)) IsDealWrtIn,  "
                  + "RSB_SECUR.IsAvrWrtOut(RSB_SECUR.get_OperationGroup(koper.t_SysTypes)) IsDealWrtOut,  "
                  + "RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(koper.t_SysTypes)) IsDealRepo  "
		  
          + "from   cnvdoc, "+GetTotalDealQueryWithFilter("", null, null, "grdealrec", "grdealrec.t_dealid")+" td, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal, ddlrq_dbt rq, ddldepset_dbt depset, "
                  + "doprkoper_dbt koper,  "
                  + "ddl_comm_dbt iocomm, ddldepset_dbt iodepset, ddldepset_dbt iodepset2,  "
                  + "dscqracc_dbt wrtscqracc, dscqracc_dbt enrlscqracc,  "
                  + "daccount_dbt wrtacc, daccount_dbt enrlacc  "
            + "where   "
	      +     "gracc.t_ID         = cnvdoc.t_ObjectID "
              + "and grdeal.t_ID        = gracc.t_GrDealID  "
              + "and td.t_DocID         = grdeal.t_DocID  "
              + "and td.t_DocKind       = grdeal.t_DocKind "			 
              
              + "and td.t_Kind_Operation = koper.t_Kind_Operation " 
               
              + "and iocomm.t_DocKind(+)    = grdeal.t_Dockind " 
              + "and iocomm.t_DocumentID(+) = grdeal.t_DocID "
              + "and iodepset.t_DepsetId(+) = iocomm.t_depsetid " 
              + "and iodepset2.t_DepsetId(+) = iocomm.t_depsetid_2 "
              
              + "and wrtscqracc.t_qrid(+) =   iocomm.t_depsetid "                                          
              + "and enrlscqracc.t_qrid(+) =  iocomm.t_depsetid_2 "
              + "and wrtacc.t_accountid(+) =   wrtscqracc.t_accountid "
              + "and enrlacc.t_accountid(+) =  enrlscqracc.t_accountid "
                        
              + "and depset.t_DepSetID(+) =  td.t_DepSetID "
              + "and rq.t_DocKind(+)    = grdeal.t_DocKind " 
              + "and rq.t_DocID(+)      = grdeal.t_DocID " 
              + "and rq.t_ID(+)         = RSI_DLRQ.RSI_GetRQByGrDeal( grdeal.t_ID )";

    cnt = cmd.GetCount(query);
  
  if (cnt > 0)
    InitProgress( cnt, "Операция квазидепозитарного учета", "Идет выполнение" );

    query = query + " order by td.t_DepSetID DESC, grdeal.t_PlanDate ASC, grdeal.t_ID ASC ";
    
    DataSet = cmd.Execute(query);
    stat = DataSet.moveNext();

    var QrAcc = TRecHandler("account.dbt");
    var CorrAcc = TRecHandler("account.dbt");
    var trn;
    var num =0;
	
    while(stat)	  
      err = 0;
    if(DataSet.ClientID == -1) //Собственная сделка
	  
        quasiaccdata.AddGrDeal(DataSet.GrDealID, DataSet.DocKind, DataSet.DocID, DataSet.FIID);
	DepoAccCode = "";
        DepoPartCode = "";
		
        if(DataSet.DocKind == DL_SCINOUTPOOL) //возврат
          if ( DataSet.ioExtDepoCodeOur == "") 
            err = 1;
            RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "В параметрах исходной схемы депозитарного учёта не заполнено поле \"Корсчёт/раздел для собственных сделок\"");
          end;
		
          if (not err)
            SplitExpDepoCode(DataSet.ioExtDepoCodeOur, @DepoAccCode, @DepoPartCode);		  
            if ( FindQDARegistry(DataSet.ioDepositary, DepoAccCode, DepoPartCode, iif(DataSEt.DocKind == 4619, DataSet.FIID,DataSet.RqFIID), QrRec) )
              err = 1;
              RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "Не найдена запись в регистре КДУ");
            end;
          end;
		  
          if (not err)
            НайтиОткрытьСчетаКДУ(QrRec.rec.QrId, DataSet.PlanDate, QrAcc, CorrAcc);

            trn = RsbAccTransactionData();						
            trn.Chapter = QrAcc.rec.Chapter;
            trn.Date_Carry = DataSet.PlanDate;
            trn.Numb_Document = DataSet.DealCode;
            trn.ResultCarry =	0;
            trn.Ground = "Списание ц/б в операции передачи имущества в пул/возврат из пула №"+DataSet.DealCode;
            trn.Department = {OperDprt};
            trn.Oper = {oper};
            trn.FIIDPayer	= DataSet.FIID;//QrAcc.rec.CodeCurrency;
            trn.FIIDReceiver = DataSet.FIID;// CorrAcc.rec.CodeCurrency;
            trn.SumPayer = DataSet.IoHiddenSum;
            trn.SumReceiver = DataSet.IoHiddenSum;
            trn.AccountPayer = CorrAcc.rec.Account;
            trn.AccountReceiver = QrAcc.rec.Account;
            trn.Shifr_Oper = 18;
					  
            quasiaccdata.AddAccTransactionData(trn, QuasiGroundData(DataSet.DealCode, DataSet.DealType));
            quasiaccdata.AddGrDoc(DataSet.GrDealID, dl_comm.rec.DocumentID , dl_comm.rec.DocKind );
          end;

          if ( DataSet.ioExtDepoCodeOur_2 == "")
            err = 1;
            RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "В параметрах новой схемы депозитарного учёта не заполнено поле \"Корсчёт/раздел для собственных сделок\"");
          end;

          DepoAccCode = "";
          DepoPartCode = "";

          if (not err)
            SplitExpDepoCode(DataSet.ioExtDepoCodeOur_2, @DepoAccCode, @DepoPartCode);		  
            if ( FindQDARegistry(DataSet.io2Depositary, DepoAccCode, DepoPartCode, DataSet.FIID/*DataSet.RqFIID*/, QrRec) )
              err = 1;
              RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "Не найдена запись в регистре КДУ");
            end;
          end;
		  
          if (not err)		  
            НайтиОткрытьСчетаКДУ(QrRec.rec.QrId, DataSet.PlanDate, QrAcc, CorrAcc);
   
            trn = RsbAccTransactionData();
            trn.Chapter = QrAcc.rec.Chapter;
            trn.Date_Carry = DataSet.PlanDate;
            trn.Numb_Document = DataSet.DealCode;
            trn.ResultCarry =	0;
            trn.Ground = "Зачисление ц/б в операции передачи имущества в пул/возврат из пула №"+DataSet.DealCode;
            trn.Department = {OperDprt};
            trn.Oper = {oper};
            trn.FIIDPayer	= DataSet.FIID;//QrAcc.rec.CodeCurrency;
            trn.FIIDReceiver = DataSet.FIID;//CorrAcc.rec.CodeCurrency;
            trn.SumPayer = DataSet.IoHiddenSum;
            trn.SumReceiver = DataSet.IoHiddenSum;
            trn.AccountPayer = QrAcc.rec.Account;
            trn.AccountReceiver = CorrAcc.rec.Account;
            trn.Shifr_Oper = 18;		  
		  
            quasiaccdata.AddAccTransactionData(trn, QuasiGroundData(DataSet.DealCode, DataSet.DealType));
            quasiaccdata.AddGrDoc(DataSet.GrDealID, dl_comm.rec.DocumentID , dl_comm.rec.DocKind );
          end;

        elif(DataSet.DocKind == DL_RESTTRANS) //если операция перевода остатков КДУ       
		
          trn = RsbAccTransactionData();		
          trn.Chapter = Dataset.WrtChapter;
          trn.Date_Carry = DataSet.PlanDate;
          trn.Numb_Document = DataSet.DealCode;
          trn.ResultCarry =	0;
          trn.Ground = "Перевод ц/б в операции №"+DataSet.DealCode;
          trn.Department = {OperDprt};
          trn.Oper = {oper};
          trn.FIIDPayer	= DataSet.WrtCodeCurrency;
          trn.FIIDReceiver = DataSet.EnrlCodeCurrency;
          trn.SumPayer = DataSet.IoHiddenSum;
          trn.SumReceiver = DataSet.IoHiddenSum;
          trn.AccountPayer = DataSet.EnrlQrAcc;
          trn.AccountReceiver = DataSet.WrtQrAcc;
          trn.Shifr_Oper = 18;	
		  
          quasiaccdata.AddAccTransactionData(trn, QuasiGroundData(DataSet.DealCode, DataSet.DealType));
          quasiaccdata.AddGrDoc(DataSet.GrDealID, dl_comm.rec.DocumentID , dl_comm.rec.DocKind );
		  
      else
        var PayerAcc, ReceiverAcc, Ground;
        var Rq = TRecHandler("dlrq.dbt");
  	  
        ПолучитьТО(DataSet.RqId, Rq);
		  
/*DAN костыль для собственных зачислений не КСУ*/
        if ((DataSet.DocKind == 127) and (DataSet.DepSetID == 0))
          DepSetSubstitution(@dataset.depsetid, @dataset.FOundDepsetId, @dataset.FoundDepositary, @dataset.ExtDepoCodeOur);
        end;

        if ( DataSet.DepSetID > 0 )		
          if (DataSet.FOundDepsetId == -1)
            err = 1;
            RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "Не найдена схема депозитарного учета с идентификатором "+ DataSet.DepSetID);
          end;

          if ( (not err) and (DataSet.ExtDepoCodeOur == "") ) 
            err = 1;
            RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "В параметрах исходной схемы депозитарного учёта не заполнено поле \"Корсчёт/раздел для собственных сделок\"");
          end;

          if ( not err)
            DepoAccCode="";
            DepoPartCode="";	  
            SplitExpDepoCode(DataSet.ExtDepoCodeOur, @DepoAccCode, @DepoPartCode);
			
            if ( FindQDARegistry(DataSet.FoundDepositary, DepoAccCode, DepoPartCode, iif(dataset.dockind == 127, DataSet.FIID, DataSet.RqFIID )/*DataSet.RqFIID*/, QrRec, DataSet.PlanDate) )
              err = 1;			  			       
              RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "Не найдена запись в регистре КДУ");
            end;
          end;
		
          if (not err)
            НайтиОткрытьСчетаКДУ(QrRec.rec.QrId, DataSet.PlanDate, QrAcc, CorrAcc);
          end;
		  
        elif ( DataSet.DepSetID == 0 )		    					    		
		  
          if ( ( ПолучитьСтрокуРегистраКДУпоТО(Rq, QrRec) ) or ( QrRec.rec.QrID==0 ) )
            err = 1;
            RepErrArr[RepErrArr.size] = CSC_DepoRepErr(DataSet.DealCode, DataSet.DealType, "Не найдена запись в регистре КДУ");
          end;			
			
          if (not err)
            НайтиОткрытьСчетаКДУ(QrRec.rec.QrID, DataSet.PlanDate, QrAcc, CorrAcc);
          end;
			
        end;

        if (not err)
          if(DataSet.IsDealBuy == 1) //Покупка
            if((DataSet.DealType == "!Покупка СЭБ биржевая") )
              PayerAcc    = CorrAcc;
              ReceiverAcc = QrAcc;
              Ground = "Зачисление ц/б при выкупе по оферте СЭБ, сделка  №";	  
	    else
	      PayerAcc    = QrAcc;
              ReceiverAcc = CorrAcc;
              Ground = "Зачисление ц/б по сделке покупки №";
	    end;

          end;
 
          if(DataSet.IsDealSale == 1) //Продажа
            if((DataSet.DealType == "!Продажа СЭБ биржевая") )
		PayerAcc = QrAcc;
                ReceiverAcc = CorrAcc;
                Ground = "Зачисление ц/б при первоначальном размещении СЭБ, сделка  №";	  
	    else
                PayerAcc = CorrAcc;
                ReceiverAcc = QrAcc;
                Ground = "Списание ц/б по сделке продаже №";	  
	    end;

          end;
/*DAN*/
		    var  SumWRTIoOut = $0; 
 /*DAN*/
          if(DataSet.IsDealWrtIn == 1) //Зачисление
            PayerAcc = QrAcc;
            ReceiverAcc = CorrAcc;
            Ground = "Зачисление ц/б в операции зачисления №";
          end;
		  
          if(DataSet.IsDealWrtOut == 1) //Списание
            PayerAcc = CorrAcc;
            ReceiverAcc = QrAcc;
            Ground = "Списание ц/б в операции списания №";
          end;
          if ((DataSet.IsDealWrtIn == 1) or (DataSet.IsDealWrtOut == 1))
             var dl_sql = "Select t_principal from ddl_leg_dbt where t_dealid = ?";
             var dl_cmd = dl_RSDCommand(dl_sql);
                 dl_cmd.AddParam(dataset.docid);  
             var dl_rs = dl_cmd.execute();
             if(dl_rs.movenext())
                SumWRTIoOut = dl_rs.principal;
             end;   
          end;
		  
          if( (DataSet.IsDealRepo == 1) and (DataSet.IsDealBuy == 1) ) //Обратное РЕПО
            if( Rq.rec.DealPart == 1 )
              PayerAcc = QrAcc;
              ReceiverAcc = CorrAcc;
              if ( Rq.rec.Type == DLRQ_TYPE_DELIVERY )
                Ground = "Зачисление ц/б по 1ч ОРЕПО №";
              end;
              if ( Rq.rec.Type == DLRQ_TYPE_COMPDELIVERY )
                Ground = "Увеличение ц/б в обеспечении по ОРЕПО №";
              end;			  
            end;

            if( Rq.rec.DealPart == 2 )
              PayerAcc = CorrAcc;
              ReceiverAcc = QrAcc;
              if ( Rq.rec.Type == DLRQ_TYPE_DELIVERY )
                Ground = "Списание ц/б по 2ч ОРЕПО №";
              end;
              if ( Rq.rec.Type == DLRQ_TYPE_COMPDELIVERY )
                Ground = "Уменьшение ц/б в обеспечении по ОРЕПО №";
              end;
            end;
          end;
		  
          if( (DataSet.IsDealRepo == 1) and (DataSet.IsDealBuy != 1) ) //Прямое РЕПО
            if( Rq.rec.DealPart == 1 )
              PayerAcc = CorrAcc;
              ReceiverAcc = QrAcc;
              if ( Rq.rec.Type == DLRQ_TYPE_DELIVERY )
                Ground = "Списание ц/б по 1ч ПРЕПО №";
              end;
              if ( Rq.rec.Type == DLRQ_TYPE_COMPDELIVERY )
                Ground = "Увеличение ц/б в обеспечении по ПРЕПО №";
              end;			  
            end;

            if( Rq.rec.DealPart == 2 )
              PayerAcc = QrAcc;
              ReceiverAcc = CorrAcc;
              if ( Rq.rec.Type == DLRQ_TYPE_DELIVERY )
                Ground = "Зачисление ц/б по 2ч ПРЕПО №";
              end;
              if ( Rq.rec.Type == DLRQ_TYPE_COMPDELIVERY )
                Ground = "Уменьшение ц/б в обеспечении по ПРЕПО №";
              end;			  
            end;		  
          end;
		  
          if(DataSet.DocKind == DL_NTGSEC) //Неттинг
            if( Rq.rec.Type == DLRQ_TYPE_DELIVERY )
              if ( Rq.Kind== DLRQ_KIND_REQUEST )
                PayerAcc = CorrAcc;
                ReceiverAcc = QrAcc;
                Ground = "Списание ц/б в операции неттинга №";
              end;

              if ( Rq.rec.Kind== DLRQ_KIND_COMMIT )
                PayerAcc = QrAcc;
                ReceiverAcc = CorrAcc;
                Ground = "Зачисление ц/б в операции неттинга №";
              end;
            end;
          end;
		  
          Ground = Ground + DataSet.DealCode;
			
          trn = RsbAccTransactionData();	
          trn.Chapter = PayerAcc.rec.Chapter;
          trn.Date_Carry = DataSet.PlanDate;
          trn.Numb_Document = DataSet.DealCode;
          trn.ResultCarry = 0;
          trn.Ground = Ground;
          trn.Department = {OperDprt};
          trn.Oper = {oper};
          trn.FIIDPayer = PayerAcc.rec.Code_Currency;
          trn.FIIDReceiver = ReceiverAcc.rec.Code_Currency;
          trn.SumPayer = iif(((DataSet.IsDealWrtIn == 1) or (DataSet.IsDealWrtOut == 1)), SumWRTIoOut, DataSet.RqAmount);
          trn.SumReceiver = iif(((DataSet.IsDealWrtIn == 1) or (DataSet.IsDealWrtOut == 1)), SumWRTIoOut, DataSet.RqAmount);
          trn.AccountPayer = PayerAcc.rec.Account;
          trn.AccountReceiver = ReceiverAcc.rec.Account;
          trn.Shifr_Oper = 18;
		  
          quasiaccdata.AddAccTransactionData(trn, QuasiGroundData(DataSet.DealCode, DataSet.DealType));
          quasiaccdata.AddGrDoc(DataSet.GrDealID, dl_comm.rec.DocumentID , dl_comm.rec.DocKind );
        end;

      end;

      else //Клиентская сделка
	    quasiaccdata.AddGrDeal(DataSet.GrDealID, DataSet.DocKind, DataSet.DocID, DataSet.FIID);
      end;
	  stat = DataSet.moveNext();
	  UseProgress(num = num + 1);
    end;
  end;

  RemProgress();
  return 0;  
END;



private macro _ExecuteQuasiDepoAcc(_taskID, _execID, _conveyerID, _operationID, _packetID, dl_comm, Department, ClientID, Session, MarketSchemeID, FIID)
var inaccdata = NULL;

  var err = 0;
  var quasiaccdata;

  quasiaccdata = QuasiAccDataTrn(dl_comm, _execID, _conveyerID, _packetID);


  err = GetQuasiDepoData(@quasiaccdata, _taskID, _execID, _conveyerID, _operationID, _packetID, dl_comm, Department, ClientID, Session, MarketSchemeID, FIID);

  
  if( (not err) and (ValType(quasiaccdata) != V_UNDEF))
     /*Начать транзакцию*/
     RslDefCon.BeginTrans();
     /*вставить все необходимые данные*/
     if( quasiaccdata.insert() != 0 )
       RslDefCon.RollbackTrans(); /*Откатить транзакцию*/
       err = 1;
     else
       RslDefCon.CommitTrans(); /*Завершить транзакцию*/
       err = 0;
     end;
  end;
  
  return err;

OnError(er)

  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  RepErrArr[RepErrArr.size] = CSC_DepoRepErr("", "", er.module+ " "+er.line+" "+er.message);
  SaveDepoErrForReport_XML(RepErrArr, dl_comm.rec.DocumentID, dl_comm.rec.DocKind);

  return 1;   
END;

private macro _ExecuteDepoAcc(_taskID, _execID, _conveyerID, _operationID, _packetID, dl_comm, Department, ClientID, Session, MarketSchemeID, FIID)
  var query, cmd, DataSet;
  var DepSet  = TBFile( "dldepset.dbt", "R", 0 );
  var cnt = 1;
  var PrevDepSetID = -1, PrevClientID = 0, prevClientContrID = -1, PrevSession = -2, PrevDocKind = 0;
  var Consolidate = DEPSET_METHODFORMDRAFT_BYDEAL;
  var ClientConsolidate = DEPSET_METHODFORMDRAFT_BYDEAL;
  var MethodFormPD = DL_METHODFORMPD_EVERY;
  var ClientMethodFormPD = DL_METHODFORMPD_EVERY;
  var CurrConsolidate = DEPSET_METHODFORMDRAFT_BYDEAL, AddTransAcc = UNSET_CHAR, AddTransAccCln = UNSET_CHAR, CurrAddTransAcc, MarketID;
  var stat = 0, err = 0;
  var DealPart = 0, IsContrGr = false, BuySale;
  var Type, Account, State, Owner, AccountDeponent;
  var needDraft = true;
  record sf(sfcontr);
  var avr_dlrq = TRecHandler("dlrq");
  var num = 0;
  var GrDealForLnkTransAcc = NULL;
  var CntDealDraft = 0;

  FormPD = DL_FormationPD();
  GrDealForLnk = TLnkGrDealToDraft(dl_comm.rec.DocKind, dl_comm.rec.DocumentID, false);

  GrDealForLnkTransAcc = TLnkGrDealToDraft(dl_comm.rec.DocKind, dl_comm.rec.DocumentID, true);
  
  cmd = DL_RSDCommand();

  if((_conveyerID) and (_packetID))
    query =  "with cnvdoc as (select * from dcnvdoc_dbt where t_ExecID = ? and t_ConvTypeID = ? and t_PackID = ?)";
    cmd.AddParam(_execID);
    cmd.AddParam(_conveyerID);
    cmd.AddParam(_packetID);
  else
    query =  "with cnvdoc as ("+GetDepoAccObjectQuery(dl_comm, Department, ClientID, Session, MarketSchemeID, FIID)+")";
  end;

  query = query
          + " select td.t_DocID, td.t_DocKind, td.t_DepSetID, td.t_ClientID, td.t_IsPartyClient, td.t_PartyID, "
          + "        grdeal.t_TemplNum, grdeal.t_ID as GrDealID, grdeal.t_PlanDate, grdeal.t_FIID, "
          + "        NVL(rq.t_ID, 0) as RQID, NVL(rq.t_DealPart, 0) as DealPart, NVL(rq.t_FIID, -1) as RqFIID, NVL(rq.t_Type, 0) as RqType, NVL(rq.t_Num, 0) as RqNum, "
          + "        (case when td.t_DocKind != " + DL_SECURITYDOC + " THEN -1 ELSE (select NVL(leg.t_Session, -1) "
          + "                                                                          from ddl_leg_dbt leg "
          + "                                                                         where leg.t_DealID  = td.t_DocID "
          + "                                                                           and leg.t_LegKind = (case when grdeal.t_TemplNum in(" + DLGR_TEMPL_DEPODRAFT2 + "," + DLGR_TEMPL_DEPODRAFTCONTR2 + ") THEN " + LEG_KIND_DL_TICK_BACK + " ELSE " + LEG_KIND_DL_TICK + " END) "
          + "                                                                           and leg.t_LegID   = 0 "
          + "                                                                           and rownum = 1 "
          + "                                                                       ) END) as t_Session "
          + "   from cnvdoc, dv_sctotaldeals td, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal, ddlrq_dbt rq "
          + "  where gracc.t_ID      = cnvdoc.t_ObjectID "
          + "    and grdeal.t_ID     = gracc.t_GrDealID "
          + "    and td.t_DocID      = grdeal.t_DocID "
          + "    and td.t_DocKind    = grdeal.t_DocKind "
          + "    and rq.t_DocKind(+) = grdeal.t_DocKind "
          + "    and rq.t_DocID(+)   = grdeal.t_DocID "
          + "    and rq.t_ID(+)      = RSI_DLRQ.RSI_GetRQByGrDeal( grdeal.t_ID ) ";

  if(not ((_conveyerID) and (_packetID)))        
    cnt = cmd.GetCount(query);
  end;

  if(cnt > 0)

    InitProgress( cnt, "Операция депозитарного учета", "Идет выполнение" );

    query = query + " order by td.t_DepSetID DESC, grdeal.t_PlanDate ASC, grdeal.t_ID ASC ";
    
    DataSet = cmd.Execute(query);
    stat = DataSet.moveNext();
    
    while(stat)
      
      FD = NULL;

      DealPart = int(DataSet.DealPart);

      if(DataSet.DocKind == DL_NTGSEC) //неттинг
        Consolidate = DEPSET_METHODFORMDRAFT_BYDEAL;
        ClientConsolidate = DEPSET_METHODFORMDRAFT_BYDEAL;
        MethodFormPD = DL_METHODFORMPD_EVERY;
        ClientMethodFormPD = DL_METHODFORMPD_EVERY;

        AddTransAcc = UNSET_CHAR;
        AddTransAccCln = UNSET_CHAR;
        MarketID    = -1;

        if(DealPart == 0)
          DealPart = 1;
        end;

        GrDealForLnk.AddGrDeal(DataSet.GrDealID, DataSet.DocKind, DataSet.DocID, DataSet.FIID);

        /*формируем поручения сразу*/

        if(LinkAllGrDealDraft(DataSet.GrDealID, DataSet.FIID) == 0)
          err = СформироватьПорученияДЕПОПоСтрокеГрафикаДляНеттинга(dl_comm, DepSet, DataSet.GrDealID, DataSet.TemplNum, date(DataSet.PlanDate), int(DataSet.RQID), int(DataSet.FIID));
        end;

        if(not err)
          RslDefCon.BeginTrans();
          err = GrDealForLnk.Insert();

          if(err)
            RslDefCon.RollbackTrans(); /*Откатить транзакцию*/
            msgbox("Ошибка при формировании поручения депо");
          else
            RslDefCon.CommitTrans(); /*Завершить транзакцию*/
          end;
        end;

        GrDealForLnk.Clear();

      elif(DataSet.DocKind == DL_SCINOUTPOOL)

        Consolidate = DEPSET_METHODFORMDRAFT_BYDEAL;
        ClientConsolidate = DEPSET_METHODFORMDRAFT_BYDEAL;
        MethodFormPD = DL_METHODFORMPD_EVERY;
        ClientMethodFormPD = DL_METHODFORMPD_EVERY;

        CurrConsolidate = DEPSET_METHODFORMDRAFT_BYDEAL;

        AddTransAcc = UNSET_CHAR;
        AddTransAccCln = UNSET_CHAR;
        MarketID    = -1;

        if(DealPart == 0)
          DealPart = 1;
        end;

        FD = SPFirstDocDLCOMM(DataSet.DocKind, DataSet.DocID);

        GrDealForLnk.AddGrDeal(DataSet.GrDealID, DataSet.DocKind, DataSet.DocID, DataSet.FIID);

        /*формируем поручения сразу*/
        GrDealForLnk.UseOnceSpgr(true);
        if(LinkAllGrDealDraft(DataSet.GrDealID, DataSet.FIID) == 0)
          err = СформироватьПорученияДЕПОПоСтрокеГрафикаДляПула(dl_comm, DataSet.GrDealID, DataSet.TemplNum, date(DataSet.PlanDate), int(DataSet.FIID), int(DataSet.RQID), FD);
        end;

        if(not err)
          RslDefCon.BeginTrans();

          err = GrDealForLnk.Insert();
          if(err)
            RslDefCon.RollbackTrans(); /*Откатить транзакцию*/
            msgbox("Ошибка при формировании поручения депо");
          else
            RslDefCon.CommitTrans(); /*Завершить транзакцию*/
          end;
        end;

        GrDealForLnk.Clear();

      elif((DataSet.DocKind == DL_AVRWRTOWN) or (DataSet.DocKind == DL_SECUROWN) or (DataSet.DocKind == DL_RETIREMENT_OWN))

        FD = SPFirstDoc(LEG_KIND_DL_TICK, DataSet.DocID);

        GrDealForLnk.AddGrDeal(DataSet.GrDealID, DataSet.DocKind, DataSet.DocID, DataSet.FIID);

        /*формируем поручения сразу*/

        if(LinkAllGrDealDraft(DataSet.GrDealID, DataSet.FIID) == 0)
          err = СформироватьПорученияДЕПОПоСтрокеГрафика(FD, DepSet, dl_comm, DataSet.GrDealID, DataSet.TemplNum, date(DataSet.PlanDate), int(DataSet.RQID), int(DataSet.FIID), CurrAddTransAcc);
        end;

        if(not err)
          RslDefCon.BeginTrans();

          err = GrDealForLnk.Insert();
          if(err)
            RslDefCon.RollbackTrans(); /*Откатить транзакцию*/
            msgbox("Ошибка при формировании поручения депо");
          else
            RslDefCon.CommitTrans(); /*Завершить транзакцию*/
          end;
        end;

        GrDealForLnk.Clear();

      else /*сделки*/
        if( DealPart == 0 )
           DealPart = 1;
           if( (DataSet.TemplNum == DLGR_TEMPL_DEPODRAFT2) OR (DataSet.TemplNum == DLGR_TEMPL_DEPODRAFTCONTR2) )
              DealPart = 2;
           end;
        end;

        IsContrGr = false;
        if( (DataSet.TemplNum == DLGR_TEMPL_DEPODRAFTCONTR) OR (DataSet.TemplNum == DLGR_TEMPL_DEPODRAFTCONTR2) )
           IsContrGr = true;
        end;
        
        FD = SPFirstDoc(IIF(DealPart == 2, LEG_KIND_DL_TICK_BACK, LEG_KIND_DL_TICK), DataSet.DocID);

        /*если сменилась схема с биржей, схема ДУ, клиент, 
          то очищем данные (поручения по предыдущей комбинации уже должны были сформироваться)*/
        if( (PrevDepSetID != DataSet.DepSetID) OR (((CurrConsolidate == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) OR (CurrConsolidate == DEPSET_METHODFORMDRAFT_TWOCONS_CLIR)) AND (PrevSession != DataSet.Session)))
          err = 0;
          GrDealForLnk.Clear();
          GrDealForLnkTransAcc.Clear();
          FormPD.Clear();

          if( (not Open( DocOffTMP ) ) OR /*Global temporary space table*/
              (not Open( DocOffTMPAcc ) ) OR /*Global temporary space table*/
              (not Open( DocOffTMPState ) ) OR /*Global temporary space table*/
              (not Clone( DocOffTMP ))
            )
             MsgBox( "Ошибка при создании временного файла");
             err = 1;
             break;
          end;
        end;
        
        /*если изменилась схема ДУ, то загрузим новую*/
        if( PrevDepSetID != DataSet.DepSetID )
           Consolidate        = DEPSET_METHODFORMDRAFT_BYDEAL;
           ClientConsolidate  = DEPSET_METHODFORMDRAFT_BYDEAL;
           MethodFormPD       = DL_METHODFORMPD_EVERY;
           ClientMethodFormPD = DL_METHODFORMPD_EVERY;

           AddTransAcc       = UNSET_CHAR;
           AddTransAccCln    = UNSET_CHAR;
           MarketID          = -1;

           var ExDepSet = false;
           DepSet.Clear();
           if( DataSet.DepSetID > 0 )
              DepSet.rec.DepSetID = DataSet.DepSetID;
              if( DepSet.GetEQ() )
                 ExDepSet = true;
              end;
           else
              if( ПолучитьПараметрыДУ(DepSet, -1, -1) )
                 ExDepSet = true;
              end;
           end;

           if( ExDepSet )
              Consolidate        = DepSet.rec.Consolidate;
              ClientConsolidate  = DepSet.rec.ClientConsolidate;
              MethodFormPD       = DepSet.rec.MethodFormPD;
              ClientMethodFormPD = DepSet.rec.ClientMethodFormPD;
              AddTransAcc        = DepSet.rec.AddTransAcc;
              AddTransAccCln     = DepSet.rec.AddTransAccCln;
              MarketID           = DepSet.rec.Market;
           end;

           FormPD.SetConsolidateAndMethodFormPD(Consolidate, ClientConsolidate, MethodFormPD, ClientMethodFormPD);
        end;

        /*определить необходимость формирвоания сводного поручения по текущей строке графика*/
        if( PrevDepSetID != DataSet.DepSetID )
           CurrConsolidate = DEPSET_METHODFORMDRAFT_BYDEAL;
           CurrAddTransAcc = UNSET_CHAR;
           if( (DataSet.ClientID == -1) AND (DataSet.IsPartyClient == UNSET_CHAR) )
              CurrConsolidate = Consolidate;
              CurrAddTransAcc = AddTransAcc;
           elif( (DataSet.ClientID != -1) AND (IsContrGr == false) )
              CurrConsolidate = ClientConsolidate;
              CurrAddTransAcc = AddTransAccCln;
           end;

           FormPD.SetClient(IIF(DataSet.IsPartyClient == SET_CHAR, DataSet.PartyID, DataSet.ClientID), DataSet.IsPartyClient == SET_CHAR);
        end;

        
        if( ((CurrConsolidate == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) OR (CurrConsolidate == DEPSET_METHODFORMDRAFT_TWOCONS_CLIR)) and (DataSet.Session != 1) and (DataSet.Session != 2) )
           // такие пропускаем
        else
           GrDealForLnk.AddGrDeal(DataSet.GrDealID, FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, DataSet.FIID);

           /*если необходимо формировать сводное, то добавляем данные во временный файл*/
           if( CurrConsolidate and (CurrConsolidate != DEPSET_METHODFORMDRAFT_NOTFORM) )

              if( FD.BuySale == DEAL_TYPE_SALE )
                 Type    = DEPO_TYPE_OUT;
                 Account = FD.pm_avoir.rec.PayerAccount;
              else
                 Type    = DEPO_TYPE_IN;
                 Account = FD.pm_avoir.rec.ReceiverAccount;
              end;

              if( Account )
                 AccountDeponent = TBFile( "depoacnt", "R", 2 );
                 AccountDeponent.Clear();
                 AccountDeponent.rec.BriefCode  = Account;
                 AccountDeponent.rec.Department = {OperDprt}; /*филиала пока нет в параметрах св. проводок*/
                 if( AccountDeponent.GetEQ() )
                    Owner = AccountDeponent.rec.Owner;
                 else
                    Owner = DataSet.ClientID;
                    if(Owner == -1)
                      Owner = {OurBank};
                    end;
                 end;
              else
                 Owner = DataSet.ClientID;
                 if(Owner == -1)
                   Owner = {OurBank};
                 end;
              end;

              if( (CurrConsolidate == DEPSET_METHODFORMDRAFT_ONECONS) OR (CurrConsolidate == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) ) /*одно св. поручение*/
                 State = STATE_COMPARE;
              else
                 State = STATE_EXECUTE;
              end;

              /* примечание "Ценные бумаги учитываются во внешнем депозитарии" по договору */
              if( prevClientContrID != FD.tick.rec.ClientContrID )
                 needDraft = true; /* по умолчанию true*/
                 if( FD.tick.rec.ClientContrID != -1 )
                    ClearRecord(sf);
                    sf.ID = FD.tick.rec.ClientContrID;
                    if( trim(readNoteForObject( OBJTYPE_SFCONTR, UniID( sf, OBJTYPE_SFCONTR), NOTEKIND_SFCONTR_ISOUTCUSTODY)) != "" )
                       needDraft = false;
                    end;
                 end;
                 prevClientContrID = FD.tick.rec.ClientContrID;
              end;

              /*откладываем для сводных поручений*/
              if( needDraft )
                 if( int(DataSet.RqType) > 0 )
                    copy(avr_dlrq, FD.GetRQ(int(DataSet.RqType), DealPart, int(DataSet.FIID), NULL, NULL, int(DataSet.RqNum)));
                 else
                    copy(avr_dlrq, FD.GetRQ(DLRQ_TYPE_DELIVERY));
                 end;

                 if( avr_dlrq.rec.Amount > 0 )
                   ДобавитьДепозитарнуюОперацию( avr_dlrq.rec.FIID,
                                                 Account,
                                                 DEPO_KIND_SUMMARY,
                                                 Type,
                                                 avr_dlrq.rec.Amount,
                                                 Owner,
                                                 State
                                               );
                 end;
              end;
           elif(CurrConsolidate != DEPSET_METHODFORMDRAFT_NOTFORM)
              /*формируем поручения сразу*/

              if(CurrAddTransAcc == SET_CHAR)
                GrDealForLnkTransAcc.AddGrDeal(DataSet.GrDealID, FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, DataSet.FIID);
              end;

              if( int(DataSet.RqType) > 0 )
                 copy(avr_dlrq, FD.GetRQ(int(DataSet.RqType), DealPart, int(DataSet.FIID), NULL, NULL, int(DataSet.RqNum)));
              else
                 copy(avr_dlrq, FD.GetRQ(DLRQ_TYPE_DELIVERY));
              end;

              CntDealDraft = LinkAllGrDealDraft(DataSet.GrDealID, DataSet.FIID);

              if( (CntDealDraft == 0) and (avr_dlrq.rec.Amount > 0) )
                if( not IsClientDeal(FD.tick.rec) )
                   if( КлиентПоСделкеВНашемБанке(FD.tick.rec.ClientID, avr_dlrq.rec.DocKind, avr_dlrq.rec.DocID, avr_dlrq.rec.FIID, avr_dlrq.rec.Type) == false)
                      MsgBox("Депозитарием банка в ТО по ц/б должен быть наш банк.");
                      err = 1;
                   end;
                end;
              end;
              
              if(not err)

                if( (CntDealDraft == 0) and (avr_dlrq.rec.Amount > 0) )
                  err = СформироватьПорученияДЕПОПоСтрокеГрафика(FD, DepSet, dl_comm, DataSet.GrDealID, DataSet.TemplNum, date(DataSet.PlanDate), int(DataSet.RQID), int(DataSet.FIID), CurrAddTransAcc);
                end;
                
                if(not err)
                  RslDefCon.BeginTrans();

                  err = GrDealForLnk.Insert();

                  if( err )
                    RslDefCon.RollbackTrans(); /*Откатить транзакцию*/
                  else
                    RslDefCon.CommitTrans(); /*Завершить транзакцию*/
                  end;
                end;
                if( err )
                  MsgBox("Ошибка при формировании поручения депо");
                end;
              end;

              GrDealForLnk.Clear();
           end;
        end;
      end;

      PrevDepSetID       = DataSet.DepSetID;
      PrevClientID       = DataSet.ClientID;
      PrevSession        = DataSet.Session;
      PrevDocKind        = DataSet.DocKind;

      if(not err)
        stat = DataSet.moveNext();
      
        /*если закончились записи, или из сделующих схемы расчетов с биржей, схемы ДУ, клиента или клир. сессия (при формировании в разрезе сессий)
          что-то не соответствует предыдущим, то формируем сводные поручения по предыдущим данным*/
        if( (not stat) or ((PrevDocKind != DataSet.DocKind) and (DataSet.DocKind == DL_SCINOUTPOOL)) or (PrevDepSetID != DataSet.DepSetID) or
            (((CurrConsolidate == DEPSET_METHODFORMDRAFT_ONECONS_CLIR) OR (CurrConsolidate == DEPSET_METHODFORMDRAFT_TWOCONS_CLIR)) AND (PrevSession != DataSet.Session))
          )
           //if( CurrConsolidate )
             if( (err == 0) AND
                 ((CurrConsolidate == DEPSET_METHODFORMDRAFT_ONECONS) OR (CurrConsolidate == DEPSET_METHODFORMDRAFT_ONECONS_CLIR)) /*одно св. поручение*/
               )
                err = СверткаПротивоположныхОперацийДЕПО(DEPO_KIND_SUMMARY);
             end;

             if( (err == 0) AND
                 (CurrAddTransAcc == SET_CHAR) /*Поручение по наполнению транзитного счета*/
               )
                err = ПоручениеПоНаполнениюТранзитногоСчетаДЕПО(DepSet, IIF(PrevClientID == -1, false, true));

                if((not err) and (CurrConsolidate == DEPSET_METHODFORMDRAFT_BYDEAL) )
                  err = СверткаПротивоположныхОперацийДЕПО(DEPO_KIND_TRANS_CLNT);
                  if(not err)
                    err = СверткаПротивоположныхОперацийДЕПО(DEPO_KIND_TRANS_OWN);
                  end;
                end;
             end;

             if( err == 0 )
                if((CurrConsolidate == DEPSET_METHODFORMDRAFT_BYDEAL) and (CurrAddTransAcc == SET_CHAR))
                  err = СформироватьПорученияДЕПО(dl_comm, DepSet, IIF(PrevClientID == -1, false, true), GrDealForLnkTransAcc);
                else
                  err = СформироватьПорученияДЕПО(dl_comm, DepSet, IIF(PrevClientID == -1, false, true), GrDealForLnk);
                end;
             end;
           //end;
        end;
      else
        stat = 0;
      end;

      UseProgress(num = num + 1);
    end;
  end;

  RemProgress();
  
  return err;

OnError(er)

  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  RepErrArr[RepErrArr.size] = CSC_DepoRepErr("", "", er.module+ " "+er.line+" "+er.message);
  SaveDepoErrForReport_XML(RepErrArr, dl_comm.rec.DocumentID, dl_comm.rec.DocKind);

  return 1;   
end;

macro ExecuteQuasiDepoAcc(_taskID, _execID, _conveyerID, _operationID, _packetID, _Params)
  var dl_comm = TBFile("dl_comm.dbt");
  var err = 0;
  
  RepErrArr.size = 0;
  ReplaceMacro( "msgbox", "QuasiDepo_msgbox" );
  
  if (_Params.DocumentID > 0)
  
    dl_comm.rec.DocumentID = _Params.DocumentID;
	if ( dl_comm.GetEQ )
	
      if( (_conveyerID) and (_packetID) )
	    err = _ExecuteQuasiDepoAcc( _taskID, _execID, _conveyerID, _operationID, _packetID, dl_comm);
	  else
        var query = "select distinct q.t_Department, q.t_ClientID, q.t_Session, q.t_MarketSchemeID, q.t_FIID from ("+GetDepoAccObjectQuery(dl_comm)+") q order by q.t_Department, q.t_ClientID, q.t_Session, q.t_MarketSchemeID, q.t_FIID";
        var cmd = DL_RSDCommand(query);
        var cnt = cmd.GetCount();
		
		if ( cnt>0 )
		  InitProgress( cnt, "Идёт выполнение операции...", "Квазидепозитарный учет" );		  
          var DataSet = cmd.Execute();
          var i = 0;
		  
          while((not err) and (DataSet.moveNext()))
            err = _ExecuteQuasiDepoAcc(0, 0, 0, 0, 0, dl_comm, DataSet.Department, DataSet.ClientID, DataSet.Session, DataSet.MarketSchemeID, DataSet.FIID);
            UseProgress(i = i + 1);
          end;		  		  
		  
		  RemProgress();
	    end;
	  end;
    end;
  end;  
  
  ReplaceMacro( "msgbox", NULL );

  SaveDepoErrForReport_XML(RepErrArr, dl_comm.rec.DocumentID, dl_comm.rec.DocKind );
  
  if((_conveyerID) and (_packetID))
    /*не зависимо от того, делали что-то или нет - ставим исходящий статус обрабатываемой пачке*/
    var exec = RSDCommand(  " UPDATE dcnvpack_dbt "
                          + " SET t_State = t_State + 1, t_Error = ? "
                          + " WHERE t_ExecID = ? "
                          + "   AND t_ConvTypeID = ? "
                          + "   AND t_PackID = ? ");

    exec.addParam( "", RSDBP_IN, IIF(err != 0, 1, 0) );
    exec.addParam( "", RSDBP_IN, _execID );
    exec.addParam( "", RSDBP_IN, _conveyerID );
    exec.addParam( "", RSDBP_IN, _packetID );
    exec.execute();
  end;   
  
END;

macro ExecuteDepoAcc(_taskID, _execID, _conveyerID, _operationID, _packetID, _Params)
  var dl_comm = TBFile("dl_comm.dbt");
  var err = 0;

  RepErrArr.size = 0;
  ReplaceMacro( "msgbox", "Depo_msgbox" );
  
  if(_Params.DocumentID > 0)
    
    dl_comm.rec.DocumentID = _Params.DocumentID;
    if(dl_comm.GetEQ())

      DP_OpenFilesDeferDraft();

      if((_conveyerID) and (_packetID))
        err = _ExecuteDepoAcc(_taskID, _execID, _conveyerID, _operationID, _packetID, dl_comm);
      else
        var query = "select distinct q.t_Department, q.t_ClientID, q.t_Session, q.t_MarketSchemeID, q.t_FIID from ("+GetDepoAccObjectQuery(dl_comm)+") q order by q.t_Department, q.t_ClientID, q.t_Session, q.t_MarketSchemeID, q.t_FIID";
        var cmd = DL_RSDCommand(query);
        var cnt = cmd.GetCount();
        
        if(cnt > 0)
          InitProgress( cnt, "Идет выполнение операции...", "Формирование поручений депо" );
          
          var DataSet = cmd.Execute();
          var i = 0;
          while((not err) and (DataSet.moveNext()))

            err = _ExecuteDepoAcc(0, 0, 0, 0, 0, dl_comm, DataSet.Department, DataSet.ClientID, DataSet.Session, DataSet.MarketSchemeID, DataSet.FIID);

            UseProgress(i = i + 1);
          end;

          RemProgress();
        end;
      end; 

      DP_CloseFilesDeferDraft();
    end;
    
  end;
  
  ReplaceMacro( "msgbox", NULL );

  SaveDepoErrForReport_XML(RepErrArr, dl_comm.rec.DocumentID, dl_comm.rec.DocKind );
  
  if((_conveyerID) and (_packetID))
    /*не зависимо от того, делали что-то или нет - ставим исходящий статус обрабатываемой пачке*/
    var exec = RSDCommand(  " UPDATE dcnvpack_dbt "
                          + " SET t_State = t_State + 1 "
                          + " WHERE t_ExecID = ? "
                          + "   AND t_ConvTypeID = ? "
                          + "   AND t_PackID = ? ");

    exec.addParam( "", RSDBP_IN, _execID );
    exec.addParam( "", RSDBP_IN, _conveyerID );
    exec.addParam( "", RSDBP_IN, _packetID );
    exec.execute();
  end; 

  return err;
end;