/* Операции погашения купона/ ЧП */
/* Шаг настройки операции           */
import "secinter.mac", "sp_car.mac", "sp_voop.mac", "spRetire.mac";

macro executeParamStep( kind_oper, BOf_kind, adr, ID_Operation, ID_Step )

  record  deal( dl_tick );
  file    fiw( fiwarnts );
  var     Group, FD, TaxDepositoryMode;
  
  SetBuff( deal, adr ); 
  FD = SPFirstDoc( deal, null, true );

  Group = SP_GetOperationGroup (deal); 
  TaxDepositoryMode = CheckTaxDepositoryMode();

  if( TaxDepositoryMode == false ) /*если не включен режим хранилища данных для налогового учета*/
     if( РазрешеноВыполнятьПогашение( FD ) == false )
        return 1;
     end;
  end;

  ClearRecord( fiw );
  if( IsRET_PARTLY(Group) )
     fiw.IsPartial = SET_CHAR;
  end;
  fiw.FIID      = FD.dl_leg.rec.PFI;
  fiw.Number    = deal.Number_Partly;

  if( GetEQ(fiw) AND ( ((TaxDepositoryMode == false) and (fiw.SPIsClosed == SET_CHAR)) or
                       ((TaxDepositoryMode == true)  and (fiw.IsClosed == SET_CHAR)) ) )
    if( fiw.IsPartial == SET_CHAR )
       MsgBox ("Частичное погашение уже выполнено.");
    else
       MsgBox ("Купон уже погашен.");
    end;
    return 1;
  end;

  DefineOprDate( FD.GetKindDate(DATE_DEALDATE),        FD.DateArray[DATE_DEALDATE]   );
  DefineOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), FD.DateArray[DATE_DEALSETAVOIRISS] );
  DefineOprDate( FD.GetKindDate(DATE_DEALPAY),         FD.DateArray[DATE_DEALPAY]  );
  DefineOprDate( FD.GetKindDate(DATE_DEALEEND),        FD.DateArray[DATE_DEALEEND]        );

  if( ИнициализироватьОперациюПогашения( FD ) != 0 )
     return 1;
  end;

  return 0;
end;

