/*
$Name:        sp_ownacc.mac
$Module:      Ценные бумаги - ОЭБ
$Description: Общие функции для проводок в операциях ОЭБ
*/
IMPORT "sp_caracc.mac", "spservsql.mac";


MACRO БУ_ПроводкиУчетаПоставкиРазмещенияОЭБ( FD, dat, GrDealID:integer )
  var Sum = $0, SumNat = $0;
  var Ground = "", CatDebet = "", SumDebet = $0, FIIDDebet = -1, CatCredit = "", SumCredit = $0, FIIDCredit = -1;
  var Scc = $0, Sпдс = $0, NK = $0;
  var query, cmd, DataSet;

    if(FD.dl_leg.rec.NKD > 0)
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         "+Биржа", "Обяз%, ОЭБ",         /* КатегДеб , КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         FD.NKD(),                       /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         "Отражение полученного купонного дохода, " + GetFinName(FD.fininstr.rec),
                                         null,
                                         null,
                                         null,
                                         FD.GetPayFIID(), FD.FaceFIID() 
                                       )
        )
      return 1;
    end;
  end;
  
  if( FD.dl_leg.rec.CFI != FD.FaceFIID() )
     if( not SmartConvertSum( Sпдс, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, FD.FaceFIID(), true))
        return 1;
     end;
  else
     Sпдс = FD.dl_leg.rec.TotalCost;
  end;

  NK = FD.FaceValue() * FD.dl_leg.rec.Principal;

  if(Sпдс <= NK)
    Sum = Sпдс; 
    Ground = "Отражение номинальной стоимости размещенных ц/б, " + GetFinName(FD.fininstr.rec);
  else
    Sum = NK; 
    Ground = "Отражение суммы привлеченных средств по размещенным ц/б, " + GetFinName(FD.fininstr.rec);
  end;

  if(Sum > 0)
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         "+Биржа", "Размещ. ОЭБ",        /* КатегДеб , КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         Sum,                            /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         Ground,
                                         null,
                                         null,
                                         null,
                                         FD.GetPayFIID(), FD.FaceFIID() 
                                       )
        )
      return 1;
    end;
  end;

  if(Sпдс > NK)
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         "+Биржа", "Премия, ОЭБ",        /* КатегДеб , КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         (Sпдс - NK),                    /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         "Отражение размещения по цене выше номинальной стоимости, " + GetFinName(FD.fininstr.rec),
                                         null,
                                         null,
                                         FIROLE_BA,
                                         FD.GetPayFIID(), FD.FaceFIID() 
                                       )
        )
      return 1;
    end;
  end;

  if(FD.tick.rec.Placement == UNSET_CHAR) //Просто продажа, не размещение
    
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         "ВнебалСчетКорресп", "Выкуп, ОЭБ", /* КатегДеб , КатегКредит*/
                                         dat,                               /* Дата */
                                         3,                                 /* Глава */
                                         FD.FaceFIID(),                     /* Валюта */
                                         NK,                                /* Сумма  */
                                         INPCARRY,                          /* Result_Carry */
                                         " 1",                              /* Kind_Oper */
                                         "",                                /* Numb_Document */
                                         "Списание номинальной стоимости с внебалансового учета, " + GetFinName(FD.fininstr.rec),
                                         null,
                                         null,
                                         null,
                                         NATCUR, FD.FaceFIID() 
                                       )
      )
      return 1;
    end;
  end;

  //Корректировка стоимости ОЭБ
  Sum = FD.pmwrtsum.rec.CorrIntToEIR;
  /*
  if(Sum != $0)

    if(FD.FaceFIID() != NATCUR)
      if( not SmartConvertSum( SumNat, abs(Sum), dat, FD.FaceFIID(), NATCUR, true))
        return 1;
      end;
    else
      SumNat = abs(Sum);
    end;

    if(Sum > 0)
      CatDebet   = "+Корр, ОЭБ";
      SumDebet   = SumNat;
      FIIDDebet  = NATCUR;

      CatCredit  = "+Эмиссия, ОЭБ";
      SumCredit  = SumNat;
      FIIDCredit = NATCUR;

      Ground     = "Отражение положительной разницы, " + GetFinName(FD.fininstr.rec); 
    else
      CatDebet   = "-Эмиссия, ОЭБ";
      SumDebet   = SumNat;
      FIIDDebet  = NATCUR;

      CatCredit = "-Корр, ОЭБ";
      SumCredit  = SumNat;          
      FIIDCredit = NATCUR;

      Ground     = "Отражение отрицательной разницы, " + GetFinName(FD.fininstr.rec);
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
          CatDebet, CatCredit,   /* AccDeb , AccCred*/
          dat,                   /* Дата */
          1,                     /* Глава */
          FIIDDebet,             /* Валюта */
          SumDebet,              /* Сумма */
          INPCARRY,              /* Result_Carry */
          " 1",                  /* Kind_Oper */
          FD.tick.rec.DealCode,  /* Numb_Document */
          Ground                /* Ground */
         ))
       return 1;
    end;

  end;
  */ 

  return 0; 
END;

MACRO БУ_ПроводкиУчетаПоставкиВыкупаОЭБ( FD, dat, GrDealID:integer )
  var Sum = $0, SumCorr = 0, TotalSum = $0, NK = $0;
  var Ground = "";
  var cmd, DataSet, query;
  record СчетРазмещ( account );
  var S = $0;
  var DiscountAdd = $0;


  query =   " select NVL(SUM(t_DiscountIncomeAdd), 0) as SumDiscountAdd "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);
  
  DataSet = cmd.Execute();
  
  if(DataSet.moveNext())
    DiscountAdd = DataSet.SumDiscountAdd;
  end;
  
  if(FD.FaceFIID() == FD.dl_leg.rec.CFI)
    S = FD.dl_leg.rec.TotalCost;
  else
    if( not SmartConvertSum( S, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, FD.FaceFIID(), true))
      return 1;
    end;
  end;
 
  NK = FD.FaceValue() * FD.dl_leg.rec.Principal;

  if(S <= NK) //Выкуп ц/б по номинальной стоимости или ниже

    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         "Размещ. ОЭБ", "+Биржа",        /* КатегДеб, КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         S - DiscountAdd,                /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         "Списание стоимости выкупленных ц/б с баланса,  " + GetFinName(FD.fininstr.rec) ,
                                         null,
                                         null,
                                         null,
                                         FD.FaceFIID(), FD.GetPayFIID() 
                                       )
        )
      return 1;
    end;


    Sum = NK - S; 
    if(Sum != $0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "Размещ. ОЭБ", "+Эмиссия, ОЭБ", /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           Sum,                            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Отражение дохода, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           null,
                                           FD.FaceFIID(), NATCUR 
                                         )
          )
        return 1;
      end;
    end;

  else
////////////////////////////////////////////////////////////////////////////////
///*
    if (not FD.IsExistAccount("Размещ. ОЭБ", null, true, null, СчетРазмещ, null, dat ))
       msgbox("Не найден счет по категории \"Размещ. ОЭБ\"");
       return 1; /*Счета нет, списывать нечего*/
    end;

    var RSD1 = DL_RSDCommand();

    var query1 = "select RSB_PMWRTOFF.WRTGetAmountOwn( ?, ?, ?, ?, ? ) Amount from dual ";
    RSD1.AddParam(-1);
    RSD1.AddParam(FD.avoiriss.rec.fiid);
    RSD1.AddParam(dat);
    RSD1.AddParam(1);
    RSD1.AddParam(0);

    var DataSet1 = RSD1.Execute(query1);

    if(DataSet1.moveNext())
      Sum = (ABS(GetRestAccount(СчетРазмещ, dat)) / DataSet1.Amount) * FD.dl_leg.rec.Principal;
    else 
      return 1;
    end;



    if(not БУ_ПроводкаПоКатегориямУчета(FD, 
                                        "Размещ. ОЭБ", "+Биржа",        /* КатегДеб, КатегКредит*/
                                        dat,                            /* Дата */
                                        1,                              /* Глава */
                                        FD.FaceFIID(),                  /* Валюта */
                                     NK  /* Sum*/,                            /* Сумма  */
                                        INPCARRY,                       /* Result_Carry */
                                        " 1",                           /* Kind_Oper */
                                        "",                             /* Numb_Document */
                                        "Списание стоимости выкупленных ц/б с баланса, " + GetFinName(FD.fininstr.rec) + " по сделке " + FD.tick.rec.dealcode + " от " + string(FD.tick.rec.dealdate) ,
                                        null,
                                        null,
                                        null,
                                        FD.FaceFIID(), FD.GetPayFIID() 
                                       )
        )
      return 1;
    end;
//*/
////////////////////////////////////////////////////////////////////////////////
    
    Sum = S - NK;
    if(FD.FaceFIID() != NATCUR)
      if( not SmartConvertSum( Sum, Sum, dat, FD.FaceFIID(), NATCUR, true))
        return 1;
      end;
    end;

    if(Sum != $0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                        "Обяз%, ОЭБ" /*  "-Эмиссия, ОЭБ"*/, "+Биржа",      /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           Sum,                            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                         //  "Отражение расхода по выпущенным ц/б, " + GetFinName(FD.fininstr.rec),
			                     "Списание купона при досрочном выкупе собственных облигации " + GetFinName(FD.fininstr.rec) + " " + FD.dl_leg.rec.principal + " шт",
                                           null,
                                           null,
                                           null,
                                           NATCUR, FD.GetPayFIID() 
                                         )
          )
        return 1;
      end;
    end;
  end;


  query =   " select NVL(SUM(t_InterestIncomeAdd), 0) as SumInterestAdd, "
          + "        NVL(SUM(t_DiscountIncomeAdd), 0) as SumDiscountAdd, "
          + "        NVL(SUM(t_BonusAdd), 0) as SumBonusAdd, "
          + "        NVL(SUM(t_WrtOutlayAdd), 0) as SumOutlayAdd, "
          + "        NVL(SUM(t_WrtVatOutlayAdd), 0) as SumVatOutlayAdd, "
          + "        NVL(SUM(t_AccountedDefDiffAdd), 0) as SumDefDiffAdd, "
          + "        NVL(SUM(t_CostBuy), 0) as SumCostBuy "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);
  
  DataSet = cmd.Execute();
  
  if(DataSet.moveNext())

    //Доначисление ПКД
    if(DataSet.SumInterestAdd != 0)

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "%Расход, ОЭБ", "Обяз%, ОЭБ",   /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumInterestAdd,         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Доначисление ПКД облигация  ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, FD.FaceFIID() 
                                         )
          )
        return 1;
      end;
    end;

    //Доначисление суммы дисконта по выкупаемым ц/б
    if(DataSet.SumDiscountAdd != 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "%Расход, ОЭБ", "Дисконт, ОЭБ", /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumDiscountAdd,         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Доначисление суммы дисконта по выкупаемым ц/б, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           FIROLE_BA,
                                           NATCUR, FD.FaceFIID() 
                                         )
          )
        return 1;
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "Дисконт, ОЭБ", "+Биржа",       /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumDiscountAdd,         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание дисконта выкупленных ц/б с баланса",
                                           null,
                                           FIROLE_BA,
                                           null,
                                           FD.FaceFIID(), FD.GetPayFIID() 
                                         )
          )
        return 1;
      end;
    end;

    //Списание премии по выкупаемым ОЭБ на доходы
    if(DataSet.SumBonusAdd != 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "Премия, ОЭБ", "+Премия, ОЭБ",  /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumBonusAdd,            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание премии по выкупаемым ОЭБ на доходы, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           FIROLE_BA,
                                           null,
                                           FD.FaceFIID(), NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание затрат по выкупаемым ОЭБ на расходы
    if(DataSet.SumOutlayAdd != 0)
      
      Sum = DataSet.SumOutlayAdd;
      if(FD.FaceFIID() != NATCUR)
        if( not SmartConvertSum( Sum, Sum, dat, FD.FaceFIID(), NATCUR, true))
          return 1;
        end;
      end;
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Маржа, проч.", "ЗпоСд, ОЭБ",  /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           Sum,                            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание затрат по выкупаемым ОЭБ на расходы, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание НДС затрат по выкупаемым ОЭБ на расходы !!!
    if(DataSet.SumVatOutlayAdd != 0)
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Маржа, проч.", "ЗпоСд, ОЭБ",  /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           DataSet.SumVatOutlayAdd,        /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание НДС затрат по выкупаемым ОЭБ на расходы, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание отсроченной разницы по выкупленным ОЭБ
    if(DataSet.SumDefDiffAdd != 0)
      
      if(DataSet.SumDefDiffAdd > 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-Эмиссия, ОЭБ", "+КоррАС, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             DataSet.SumDefDiffAdd,           /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Положительная отсроченная разница, " + GetFinName(FD.fininstr.rec),
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
      else
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-КоррАС, ОЭБ", "+Эмиссия, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             abs(DataSet.SumDefDiffAdd),      /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Отрицательная отсроченная разница, " + GetFinName(FD.fininstr.rec),
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
      end;
    end;
  end;

  //Списание корректировок выкупленным ОЭБ
  
  query =   " select NVL(sum(t_CorrIntToEIRChange), 0) as SumCorr "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? "
          + "    and t_CorrIntToEIRChange < 0";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    SumCorr = abs(DataSet.SumCorr);
/*
    if(SumCorr > 0)
       if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            "-Корр, ОЭБ", "+Эмиссия, ОЭБ",   /* КатегДеб, КатегКредит*/
                                            dat,                             /* Дата */
                                            1,                               /* Глава */
                                            NATCUR,                          /* Валюта */
                                            SumCorr,                         /* Сумма  */
                                            INPCARRY,                        /* Result_Carry */
                                            " 1",                            /* Kind_Oper */
                                            "",                              /* Numb_Document */
                                            "Списание корректировок выкупленным ОЭБ, " + GetFinName(FD.fininstr.rec),
                                            null,
                                            null,
                                            null,
                                            NATCUR, NATCUR  
                                          )
           )
         return 1;
       end;
    end;
  */
  end;

  query =   " select NVL(sum(t_CorrIntToEIRChange), 0) as SumCorr "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? "
          + "    and t_CorrIntToEIRChange > 0";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);

  DataSet = cmd.Execute();
  
  if(DataSet.moveNext())
    SumCorr = abs(DataSet.SumCorr);
/*
    if(SumCorr > 0)
       if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            "-Эмиссия, ОЭБ", "+Корр, ОЭБ",   /* КатегДеб, КатегКредит*/
                                            dat,                             /* Дата */
                                            1,                               /* Глава */
                                            NATCUR,                          /* Валюта */
                                            SumCorr,                         /* Сумма  */
                                            INPCARRY,                        /* Result_Carry */
                                            " 1",                            /* Kind_Oper */
                                            "",                              /* Numb_Document */
                                            "Списание корректировок выкупленным ОЭБ, " + GetFinName(FD.fininstr.rec),
                                            null,
                                            null,
                                            null,
                                            NATCUR, NATCUR  
                                          )
              )
         return 1;
       end;
    end;
  */
  end;

  
  if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                       "Выкуп, ОЭБ", "ВнебалСчетКорресп", /* КатегДеб, КатегКредит*/
                                       dat,                               /* Дата */
                                       3,                                 /* Глава */
                                       FD.FaceFIID(),                     /* Валюта */
                                       NK,                                /* Сумма  */
                                       INPCARRY,                          /* Result_Carry */
                                       " 1",                              /* Kind_Oper */
                                       "",                                /* Numb_Document */
                                      // "Отражение выкупленных облигаций во внебалансовом учете, " + GetFinName(FD.fininstr.rec),
                                       "Выкупленные до срока погашения собственные облигации  " + GetFinName(FD.fininstr.rec),
                                       null,
                                       null,
                                       FIROLE_CORACC_ACTIVE,
                                       FD.FaceFIID(), NATCUR  
                                     )
      )
    return 1;
  end;

  return 0; 
END;


/* Проводки постановки сделки на внебаланс (для операций покупки/продажи)*/
MACRO БУ_ПоставитьНаВнебалансОЭБ( FD, dat, GrDealID )
  var DealType;
  var Sum = $0, SumNat = $0;
  var AccFIID = -1, AccCat = "";

  FD.SetCurPFI(FD.CurPFI());
  DealType = FD.ВидСрочностиСделки();

  if( (DealType != СделкаПрочая) and (DealType != СделкаНеРанееТретьегоДня))
     msgbox( "Шаг должен выполняться только для сделок не ранее третьего дня или прочих сделок" );
     return 1;
  end;

  if( FD.dl_leg.rec.CFI != NATCUR )
     if( not SmartConvertSum( SumNat, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, NATCUR, true))
        return 1;
     end;
  else
     SumNat = FD.dl_leg.rec.TotalCost;
  end;


//1.Постановка требований

  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.GetPayFIID(); /*валюта расчетов*/
  else 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  end; 

  if( AccFIID != FD.dl_leg.rec.CFI )
     if( not SmartConvertSum( Sum, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, AccFIID, true))
        return 1;
     end;
  else
     Sum = FD.dl_leg.rec.TotalCost;
  end;

  if( DealType == СделкаПрочая )
     AccCat = "+Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "+Форвард, дрейф"; 
  end;

  if(Sum > 0)
    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           AccCat, "СчКорреспГлаваГ", /* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           AccFIID,               /* Валюта */
           Sum,                   /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           "Постановка требований на внебалансовый учет",   /* Ground */
           0, FIROLE_FIREQ, FIROLE_CORACC_ACTIVE, 
           AccFIID, null,
           NATCUR, SumNat         /*сумма в валюте второго счета*/
          ))
        return 1;
    end;
  end;

//2. Постановка обязательств

  Sum = $0;
  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  else 
    AccFIID = FD.GetPayFIID(); /*валюта расчетов*/
  end; 

  if( AccFIID != FD.dl_leg.rec.CFI )
     if( not SmartConvertSum( Sum, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, AccFIID, true))
        return 1;
     end;
  else
     Sum = FD.dl_leg.rec.TotalCost;
  end;

  if( DealType == СделкаПрочая )
     AccCat = "-Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "-Форвард, дрейф"; 
  end;
  
  if(Sum > 0)
    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "СчКорреспГлаваГ", AccCat, /* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           NATCUR,                /* Валюта */
           SumNat,                /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           "Постановка обязательств на внебалансовый учет",   /* Ground */
           0, FIROLE_CORACC_ACTIVE, FIROLE_FICOM, 
           null, AccFIID,
           AccFIID, Sum
                        
          ))
        return 1;
    end;
  end;

  return 0;
END;

//Проводки снятия сделки с внебаланса
MACRO БУ_СнятьСВнебалансаОЭБ( FD, dat, GrDealID )
  var DealType;
  var Sum = $0, SumNat = $0;
  var AccFIID = -1, AccCat = "";
  record СчетУчета( account );

  FD.SetCurPFI(FD.CurPFI());
  DealType = FD.ВидСрочностиСделки();

  if( (DealType != СделкаПрочая) and (DealType != СделкаНеРанееТретьегоДня))
     msgbox( "Шаг должен выполняться только для сделок не ранее третьего дня или прочих сделок" );
     return 1;
  end;

//1.Списание требований

  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.GetPayFIID(); /*валюта расчетов*/
  else 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  end; 

  if( DealType == СделкаПрочая )
     AccCat = "+Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "+Форвард, дрейф"; 
  end;

  if( not FD.IsExistAccount( AccCat, null, true, FIROLE_FIREQ, СчетУчета, null, dat ))
     return 0; /*Счета нет, списывать нечего*/
  end;

  Sum  = ABS( GetRestAccount( СчетУчета, dat ) );

  if(Sum > 0)
    if( AccFIID != NATCUR )
       if( not SmartConvertSum( SumNat, Sum, dat, AccFIID, NATCUR, true))
          return 1;
       end;
    else
       SumNat = Sum;
    end;

    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "СчКорреспГлаваГ", СчетУчета, /* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           NATCUR,                /* Валюта */
           SumNat,                /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           "Списание требований с внебалансового учета", /* Ground */
           0, FIROLE_CORACC_ACTIVE, FIROLE_FIREQ,
           null, AccFIID,
           AccFIID, Sum           /*сумма в валюте второго счета*/
          ))
        return 1;
    end;
  end;

//2. Списание обязательств

  Sum = $0;
  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  else 
    FD.GetPayFIID(); /*валюта расчетов*/
  end; 

  if( DealType == СделкаПрочая )
     AccCat = "-Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "-Форвард, дрейф"; 
  end;

  if( not FD.IsExistAccount( AccCat, null, true, FIROLE_FICOM, СчетУчета, null, dat ))
     return 0; /*Счета нет, списывать нечего*/
  end;

  Sum  = ABS( GetRestAccount( СчетУчета, dat ) );
  
  if(Sum > 0)

    if( AccFIID != NATCUR )
       if( not SmartConvertSum( SumNat, Sum, dat, AccFIID, NATCUR, true))
          return 1;
       end;
    else
       SumNat = Sum;
    end;

    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           AccCat, "СчКорреспГлаваГ", /* AccDeb , AccCred*/
           dat,                       /* Дата */
           4,                         /* Глава */
           AccFIID,                   /* Валюта */
           Sum,                       /* Сумма */
           INPCARRY,                  /* Result_Carry */
           " 1",                      /* Kind_Oper */
           FD.tick.rec.DealCode,      /* Numb_Document */
           "Списание обязательств с внебалансового учета",   /* Ground */
           0, FIROLE_FICOM, FIROLE_CORACC_ACTIVE, 
           AccFIID, NATCUR,
           NATCUR, SumNat
          ))
        return 1;
    end;
  end;

  return 0;
END;

//Проводки оплаты комиссий при размещении/продаже
MACRO БУ_ОплатаКомиссийПриРазмещенииОЭБ( FD, dat, GrDealID )
  var query, cmd, DataSet;
  var Sum = $0, SumPF = $0;

  //В первой очереди реализации все комиссии считаются существенными
  query =   " SELECT SUM(ROUND(Rsb_FIInstr.ConvSum(dlcomis.t_Sum, comis.t_FIID_Comm, ?, ?), 2)) as SumComiss "
          + "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis "
          + "  WHERE dlcomis.t_DocKind = ? "
          + "    AND dlcomis.t_DocID   = ? "
          + "    AND dlcomis.t_FeeType   = comis.t_FeeType "
          + "    AND dlcomis.t_ComNumber = comis.t_Number "
          + "    AND dlcomis.t_Immaterial <> CHR(88) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(NATCUR);
  cmd.AddParam(dat);
  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    Sum = money(DataSet.SumComiss);
  end;

  if(Sum > 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "ЗпоСд, ОЭБ", "РасРасх, ОЭБ", /* AccDeb , AccCred*/
           dat,                       /* Дата */
           1,                         /* Глава */
           NATCUR,                    /* Валюта */
           Sum,                       /* Сумма */
           INPCARRY,                  /* Result_Carry */
           " 1",                      /* Kind_Oper */
           FD.tick.rec.DealCode,      /* Numb_Document */
           "Отражение обязательств по оплате затрат по сделке, " + GetFinName(FD.fininstr.rec)   /* Ground */
          ))
        return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "Затраты, ОЭБ", "ЗпоСд, ОЭБ", /* AccDeb , AccCred*/
           dat,                       /* Дата */
           1,                         /* Глава */
           NATCUR,                    /* Валюта */
           Sum,                       /* Сумма */
           INPCARRY,                  /* Result_Carry */
           " 1",                      /* Kind_Oper */
           FD.tick.rec.DealCode,      /* Numb_Document */
           "Отнесение на расходы затрат по сделке, " + GetFinName(FD.fininstr.rec)   /* Ground */
          ))
        return 1;
    end;

    if(FD.GetPayFIID() != FD.FaceFIID())
      if( not SmartConvertSum( SumPF, Sum, dat, NATCUR, FD.GetPayFIID(), true))
        return 1;
      end;
    else
      SumPF = Sum;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "РасРасх, ОЭБ", "+Биржа",  /* AccDeb , AccCred*/
           dat,                       /* Дата */
           1,                         /* Глава */
           NATCUR,                    /* Валюта */
           Sum,                       /* Сумма */
           INPCARRY,                  /* Result_Carry */
           " 1",                      /* Kind_Oper */
           FD.tick.rec.DealCode,      /* Numb_Document */
           "Отражение исполнения обязательств по оплате затрат по сделке, " + GetFinName(FD.fininstr.rec),   /* Ground */
           0, NULL, NULL, 
           NULL, FD.GetPayFIID(),
           FD.GetPayFIID(), SumPF
          ))
        return 1;
    end;
  end;

  return 0;
END;

//Проводки оплаты комиссий при выкупе
MACRO БУ_ОплатаКомиссийПриВыкупеОЭБ( FD, dat, GrDealID )
  var query, cmd, DataSet;
  var Sum = $0, SumPF = $0, SumNDS = $0;
  var Curr = -1;

  query =   " SELECT dlcomis.t_Sum as SumComiss, "
          + "        dlcomis.t_NDS as SumNDS, "
          + "        comis.t_FIID_Comm"
          + "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis "
          + "  WHERE dlcomis.t_DocKind = ? "
          + "    AND dlcomis.t_DocID   = ? "
          + "    AND dlcomis.t_FeeType   = comis.t_FeeType "
          + "    AND dlcomis.t_ComNumber = comis.t_Number "
          + "    AND dlcomis.t_Immaterial <> CHR(88) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    Sum    = money(DataSet.SumComiss-DataSet.SumNDS);
    SumNDS = money(DataSet.SumNDS);
    Curr   = DataSet.FIID_Comm;

    if(Sum > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Затраты, ОЭБ", "+Биржа",  /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             Sum,                       /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
//             "Признание расходов в виде комиссии за размещение ц/б. "  + GetFinName(FD.fininstr.rec),   /* Ground */
               "комиссия торговой системы по сделке выкупа  собственные облигации "  + GetFinName(FD.fininstr.rec),   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;
    end;

    if(SumNDS > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "+НДС", "+Биржа",          /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             SumNDS,                    /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отражение НДС уплаченного",   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;
    end;
    
  end;

  return 0;
END;


//Перенос на счета к исполнению при погашении купона
macro БУ_ПереносНаСчетаКИсполнениюКупонОЭБ( FD, dat, GrDealID )
  var cmd, query, DataSet;
  var InterestAdd = $0;
  var CatAcc = "";
  var fiw = TRecHandler("fiwarnts.dbt");
  var Sum = $0;

 var BondName, BondRegN;
 var sqlFI = "select fi.t_definition, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " +fd.tick.rec.pfi;
 var cmdFI = DL_RSDCommand();
 var dsFI = cmdFI.Execute(sqlFI);
 if(dsFI.moveNext())
  BondName = dsFi.value("t_definition"); 
  BondRegN = dsFi.value("t_LSIN");
 end;
 


  record СчетОЭБпрц( account );
   
  if(FD.tick.rec.Number_Coupon == "")
    msgbox("Не задан номер купона");
    return 1;
  end;

  if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
    msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
    return 1;
  end;

  query =   " SELECT NVL(SUM(ROUND(A.T_INTERESTINCOME,2) - ROUND(B.T_INTERESTINCOME,2)), 0) InterestAdd "
          + "   FROM V_SCWRTHISTEX A, DPMWRTBC_DBT B "
          + "  WHERE A.T_ID_OPERATION = ? "
          + "    AND A.T_ID_STEP = -1 "
          + "    AND A.T_ACTION = " + PM_WRTSUM_UPDTMODE_INCPDD
          + "    AND A.T_PARTY = -1 "
          + "    AND A.T_CONTRACT = 0 "
          + "    AND A.T_FIID = ? "
          + "    AND B.T_SUMID = A.T_SUMID "
          + "    AND B.T_INSTANCE  = A.T_INSTANCE - 1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ПроводкиБУ.GetServDocID());
  cmd.AddParam(ПроводкиБУ.GetCurrAvrFIID());

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    InterestAdd  = DataSet.InterestAdd;
  end;

  if( FD.IsExistAccount("Обяз%, ОЭБ", null, true, null, СчетОЭБпрц, null, dat))
    Sum = GetRestAccount(СчетОЭБпрц, dat);
  end;

  if(InterestAdd != 0)

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "%Расход, ОЭБ", "Обяз%, ОЭБ", /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             InterestAdd,                  /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Доначисление ПКД, облигация  " + BondName + ", госрег " + BondRegN  ,           /* Ground */
             null,
             null,
             null,
             NATCUR, FD.FaceFIID()
            ))
          return 1;
    end;

    Sum = Sum + InterestAdd;
  end;


  CatAcc = "ОЭБ%, к погашению";
  if(fiw.rec.DrawingDate == FD.fininstr().rec.DrawingDate)
    CatAcc = "ОЭБ%, к исполнению";
  end;

  if(not БУ_ПроводкаПоКатегориямУчета( FD, 
         "Обяз%, ОЭБ", CatAcc,             /* Деб , КатегКредит*/
         dat,                              /* Дата */
         1,                                /* Глава */
         FD.FaceFIID(),                    /* Валюта */
         $0,                               /* Сумма дебет*/
         INPCARRY,                         /* Result_Carry */
         " 1",                             /* Kind_Oper */
         FD.tick.rec.DealCode,             /* Numb_Document */
         "Перенос на счет к исполнению при погаш. купона №" + FD.tick.rec.Number_Coupon + " , обл. "+ BondName + ", госрег " + BondRegN ,   /* Ground */
         GETRESTACC_DEBET 
        ))
      return 1;
  end;

  if(FD.dl_leg.rec.NKD)
  /*  
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "ОЭБ, к погашению", "ВнебалСчетКорресп", /* AccDeb , AccCred*/
             dat,                          /* Дата */
             3,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             FD.dl_leg.rec.NKD,            /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Предъявление для погашения купона по облигации", /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end; */
  end;

  return 0;
end;

//Проводки учёта погашения купона
macro БУ_ПроводкиУчетаПогашенияКупонаОЭБ( FD, dat, GrDealID )
  var rq_payinc = NULL;
  var CatAcc = "";
  var fiw = TRecHandler("fiwarnts.dbt");
  var sum = $0, sumTax = $0, sumTaxFLR = $0, sumTaxFLN = $0;
  var OurBankIsTaxAgent = UNSET_CHAR;
  var query, cmd, DataSet;
  var SumTaxPF = $0;
   


var BondName, BondRegN;
 var sqlFI = "select fi.t_definition, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " +fd.tick.rec.pfi;
 var cmdFI = DL_RSDCommand();
 var dsFI = cmdFI.Execute(sqlFI);
 if(dsFI.moveNext())
  BondName = dsFi.value("t_definition"); 
  BondRegN = dsFi.value("t_LSIN");
 end;

  if(FD.ExistRqPayIncome())
    rq_payinc = FD.GetRQ(DLRQ_TYPE_PAYINCOME);
  end;

  if(rq_payinc == NULL)
    msgbox("Не найдено ТО по выплате дохода");
    return 1;
  end;

  if(FD.tick.rec.Number_Coupon == "")
    msgbox("Не задан номер купона");
    return 1;
  end;

  if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
    msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
    return 1;
  end;

  if(ДатаЯвляетсяПереходящейПогашОЭБ(FD.dl_leg.rec.Maturity) == true)

    query =  " select NVL(SUM(t_InterestIncomeAdd), 0) as SumInterestAdd "
           + "   from dpmwrtlnk_dbt "
           + "  where t_SaleID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(FD.pmwrtsum.rec.SumID);
    
    DataSet = cmd.Execute();
    
    if(DataSet.moveNext())

      //Доначисление ПКД
      if(DataSet.SumInterestAdd != 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "%Расход, ОЭБ", "ОЭБ%, к погашению", /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumInterestAdd,         /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Доначисление ПКД",
                                             null,
                                             null,
                                             null,
                                             NATCUR, FD.FaceFIID() 
                                           )
            )
          return 1;
        end;
      end;
    end;
  end;

  CatAcc = "ОЭБ%, к погашению";

  sum = rq_payinc.rec.Amount; //Уже за вычетом налогов
  if(rq_payinc.rec.FIID != FD.dl_leg.rec.PayFIID)
    if( not SmartConvertSum( sum, sum, dat, rq_payinc.rec.FIID, FD.dl_leg.rec.PayFIID, true))
      return 1;
    end;
  end;

  sumTax = 0;
  if(FD.ExistsRQ(DLRQ_TYPE_TAX_ULN))
    sumTax = FD.GetRQ(DLRQ_TYPE_TAX_ULN).rec.Amount;
  end;

  if(sumTax)

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "-Бюджетб ф.налоги, ULN",  /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTax,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Налог на доходы иностранных организаций (20%) при погашении купона по облигации " + BondName,           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;
  sumTax = 0; sumTaxFLR = $0; sumTaxFLN = $0;
  if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLN))
    sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLN).rec.Amount;
    sumTaxFLN = round(FD.GetRQ(DLRQ_TYPE_TAX_FLN).rec.Amount, 0);
    sumTaxFLN = round(sumTaxFLN, 0);

  end;

  if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLR))
    sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLR).rec.Amount;
    sumTaxFLR = round(FD.GetRQ(DLRQ_TYPE_TAX_FLR).rec.Amount, 0);
    sumTaxFLR = round(sumTaxFLR, 0);

  end;
 
  if(sumTax)
   if(sumTaxFLN)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "НДФЛ к перечислению, FLN",/* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTaxFLN,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "налог на доходы физ лиц (30%) при выплате купонного дохода по обл " +  BondName,           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
   end;

   if(sumTaxFLR)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "НДФЛ к перечислению, FLR",/* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTaxFLR,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "налог на доходы физ лиц при выплате купонного дохода по обл " +  BondName,           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
   end;
  end;

  if(sum)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "ДС в КО",            /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.dl_leg.rec.PayFIID,        /* Валюта */
             sum,                          /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Исполнение обязательств Банка по выплате купона №" + FD.tick.rec.Number_Coupon 
            +" по облигации " + BondName ,/* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), FD.dl_leg.rec.PayFIID
            ))
          return 1;
    end;
  end;


  //if(FD.dl_leg.rec.Maturity < FD.dl_leg.rec.MoveDate)
 /* if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "ВнебалСчетКорресп", "ОЭБ, к погашению", /* AccDeb , AccCred*/
               dat,                          /* Дата */
               3,                            /* Глава */
               NATCUR,                       /* Валюта */
               $0,                           /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Списание предъявленного купона по облигации с внебаланса", /* Ground */
               GETRESTACC_CREDIT,
               null,
               null,
               NATCUR, FD.FaceFIID()
              ))
            return 1;
    end;  */
  //end;

  return 0;
end;


//Проводки оплаты комиссий при погашении купона
MACRO БУ_ОплатаКомиссийПриПогашенииОЭБ( FD, dat, GrDealID )
  var query, cmd, DataSet;
  var Sum = $0, SumNat = $0, SumPF = $0, SumNDS = $0, SumNDSnat = $0;
  var Curr = -1;

  query =   " SELECT dlcomis.t_Sum as SumComiss, "
          + "        dlcomis.t_NDS as SumNDS, "
          + "        comis.t_FIID_Comm, dlcomis.t_ID"
          + "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis "
          + "  WHERE dlcomis.t_DocKind = ? "
          + "    AND dlcomis.t_DocID   = ? "
          + "    AND dlcomis.t_FeeType   = comis.t_FeeType "
          + "    AND dlcomis.t_ComNumber = comis.t_Number "
          + "    AND dlcomis.t_Immaterial <> CHR(88) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    Sum    = money(DataSet.SumComiss-DataSet.SumNDS);
    SumNDS = money(DataSet.SumNDS);
    Curr   = DataSet.FIID_Comm;

    if(Curr != NATCUR)
      if( not SmartConvertSum(Sumnat, Sum, dat, Curr, NATCUR, true))
        return 1;
      end;

      if(SumNDS > 0)
        if( not SmartConvertSum(SumNDSnat, SumNDS, dat, Curr, NATCUR, true))
          return 1;
        end;
      end;
    else
      SumNat    = Sum;     
      SumNDSnat = SumNDS;  
    end;

    if(Sum > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-КВ, ц/б", "-Расчеты",    /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             Sum,                       /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Признание расходов в виде комиссии за услуги платежному агенту",   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;
    end;

    if(SumNDS > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "+НДС", "-Расчеты",        /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             SumNDS,                    /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отражение НДС уплаченного",   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;

      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Налог", "+НДС",          /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             NATCUR,                    /* Валюта */
             SumNDSnat,                 /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отнесение НДС уплаченного на расходы",   /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
      end;
    end;
  end;

  return 0;
END;

//Проводки переноса на счета к исполнению при погашении выпуска
macro БУ_ПереносНаСчетаКИсполнениюПогашениеОЭБ(FD, dat, GrDealID)
  var cmd, query, DataSet;
  var InterestAdd = $0, DiscountAdd = $0, BonusAdd = $0, OutlayAdd = $0, VatOutlayAdd = $0, DefDiffAdd = $0, CorrIntToEIRAdd = $0;
  var ComissAdd = $0, NDSAdd = $0;
  var CatAcc = "";
  var fiw = TRecHandler("fiwarnts.dbt");
  var RestD = $0, RestB = $0;
  record СчетДисконт( account );
  record СчетПремия( account );
  var SumComisRub, SumNDSRub;

  if((FD.tick.rec.Number_Coupon != "") and (ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false))
    msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
    return 1;
  end;

  if(FD.tick.rec.Flag3 == SET_CHAR) //при досрочном погашении ничего не делаем
    return 0;
  end;

  query =   " SELECT NVL(SUM(ROUND(A.T_INTERESTINCOME,2) - ROUND(B.T_INTERESTINCOME,2)), 0) InterestAdd, "
          + "        NVL(SUM(ROUND(A.T_DISCOUNTINCOME,2) - ROUND(B.T_DISCOUNTINCOME,2)), 0) DiscountAdd, "
          + "        NVL(SUM(ROUND(A.T_BONUS,2) - ROUND(B.T_BONUS,2)), 0) BonusAdd, "
          + "        NVL(SUM(ROUND(A.T_WRTOUTLAY,2) - ROUND(B.T_WRTOUTLAY,2)), 0) OutlayAdd, "
          + "        NVL(SUM(ROUND(A.T_WRTVATOUTLAY,2) - ROUND(B.T_WRTVATOUTLAY,2)), 0) VatOutlayAdd, "
          + "        NVL(SUM(ROUND(A.T_ACCOUNTEDDEFDIFF,2) - ROUND(B.T_ACCOUNTEDDEFDIFF,2)), 0) DefDiffAdd, "
          + "        NVL(SUM(ROUND(A.T_CORRINTTOEIR,2) - ROUND(B.T_CORRINTTOEIR,2)), 0) CorrIntToEIRAdd "
          + "   FROM V_SCWRTHISTEX A, DPMWRTBC_DBT B "
          + "  WHERE A.T_ID_OPERATION = ? "
          + "    AND A.T_ID_STEP = -1 "
          + "    AND A.T_ACTION = " + PM_WRTSUM_UPDTMODE_INCPDD
          + "    AND A.T_PARTY = -1 "
          + "    AND A.T_CONTRACT = 0 "
          + "    AND A.T_FIID = ? "
          + "    AND B.T_SUMID = A.T_SUMID "
          + "    AND B.T_INSTANCE  = A.T_INSTANCE - 1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ПроводкиБУ.GetServDocID());
  cmd.AddParam(ПроводкиБУ.GetCurrAvrFIID());

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    InterestAdd     = DataSet.InterestAdd;
    DiscountAdd     = DataSet.DiscountAdd;
    BonusAdd        = DataSet.BonusAdd;
    OutlayAdd       = DataSet.OutlayAdd;
    VatOutlayAdd    = DataSet.VatOutlayAdd;
    DefDiffAdd      = DataSet.DefDiffAdd;
    CorrIntToEIRAdd = DataSet.CorrIntToEIRAdd;
  end;

  if(InterestAdd != 0)

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "%Расход, ОЭБ", "Обяз%, ОЭБ", /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             InterestAdd,                  /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Доначисление ПКД",           /* Ground */
             null,
             null,
             null,
             NATCUR, FD.FaceFIID()
            ))
          return 1;
    end;
  end;

  if(not БУ_ПроводкаПоКатегориямУчета( FD, 
         "Обяз%, ОЭБ", "ОЭБ%, к исполнению", /* Деб , КатегКредит*/
         dat,                              /* Дата */
         1,                                /* Глава */
         FD.FaceFIID(),                    /* Валюта */
         $0,                               /* Сумма дебет*/
         INPCARRY,                         /* Result_Carry */
         " 1",                             /* Kind_Oper */
         FD.tick.rec.DealCode,             /* Numb_Document */
         "Перенос на счет к исполнению",   /* Ground */
         GETRESTACC_DEBET 
        ))
      return 1;
  end; 

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
          "Размещ. ОЭБ", "ОЭБ, к исполнению", /* AccDeb , AccCred*/
          dat,                          /* Дата */
          1,                            /* Глава */
          FD.FaceFIID(),                /* Валюта */
          $0,                           /* Сумма */
          INPCARRY,                     /* Result_Carry */
          " 1",                         /* Kind_Oper */
          FD.tick.rec.DealCode,         /* Numb_Document */
          "Перенос остатка",            /* Ground */
          GETRESTACC_DEBET,
          null,
          null,
          NATCUR, FD.FaceFIID()
         ))
       return 1;
  end;


  if(DiscountAdd != 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "%Расход, ОЭБ", "Дисконт, ОЭБ", /* AccDeb , AccCred*/
             dat,                            /* Дата */
             1,                              /* Глава */
             FD.FaceFIID(),                  /* Валюта */
             DiscountAdd,                    /* Сумма */
             INPCARRY,                       /* Result_Carry */
             " 1",                           /* Kind_Oper */
             FD.tick.rec.DealCode,           /* Numb_Document */
             "Доначисление дисконта",        /* Ground */
             null,
             null,
             FIROLE_BA,
             NATCUR, FD.FaceFIID()
            ))
          return 1;
    end;
  end;

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "Дисконт, ОЭБ", "ОЭБ, к исполнению", /* AccDeb , AccCred*/
           dat,                          /* Дата */
           1,                            /* Глава */
           FD.FaceFIID(),                /* Валюта */
           $0,                           /* Сумма */
           INPCARRY,                     /* Result_Carry */
           " 1",                         /* Kind_Oper */
           FD.tick.rec.DealCode,         /* Numb_Document */
           "Перенос остатка дисконта",   /* Ground */
           GETRESTACC_DEBET,
           FIROLE_BA,
           null,
           FD.FaceFIID(), FD.FaceFIID()
          ))
        return 1;
  end;

  if(BonusAdd != 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Премия, ОЭБ", "+Премия, ОЭБ",    /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             FD.FaceFIID(),                    /* Валюта */
             BonusAdd,                         /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Списание части премии в доходы", /* Ground */
             null,
             FIROLE_BA,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "Премия, ОЭБ", "ОЭБ, к исполнению", /* AccDeb , AccCred*/
           dat,                          /* Дата */
           1,                            /* Глава */
           FD.FaceFIID(),                /* Валюта */
           $0,                           /* Сумма */
           INPCARRY,                     /* Result_Carry */
           " 1",                         /* Kind_Oper */
           FD.tick.rec.DealCode,         /* Numb_Document */
           "Перенос остатка премии",     /* Ground */
           GETRESTACC_DEBET,
           FIROLE_BA,
           null,
           FD.FaceFIID(), FD.FaceFIID()
          ))
        return 1;
  end;


  if(DefDiffAdd != 0)
    if(DefDiffAdd > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-Эмиссия, ОЭБ", "+КоррАС, ОЭБ",    /* AccDeb , AccCred*/
               dat,                              /* Дата */
               1,                                /* Глава */
               NATCUR,                           /* Валюта */
               DefDiffAdd,                       /* Сумма */
               INPCARRY,                         /* Result_Carry */
               " 1",                             /* Kind_Oper */
               FD.tick.rec.DealCode,             /* Numb_Document */
               "Положительная отсроченная разница", /* Ground */
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
    else
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-КоррАС, ОЭБ", "+Эмиссия, ОЭБ",   /* AccDeb , AccCred*/
               dat,                              /* Дата */
               1,                                /* Глава */
               NATCUR,                           /* Валюта */
               abs(DefDiffAdd),                  /* Сумма */
               INPCARRY,                         /* Result_Carry */
               " 1",                             /* Kind_Oper */
               FD.tick.rec.DealCode,             /* Numb_Document */
               "Отрицательная отсроченная разница", /* Ground */
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
    end;
  end;

  if(CorrIntToEIRAdd != 0)
    if(CorrIntToEIRAdd > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-КоррАС, ОЭБ", "-Корр, ОЭБ",    /* AccDeb , AccCred*/
               dat,                              /* Дата */
               1,                                /* Глава */
               NATCUR,                           /* Валюта */
               CorrIntToEIRAdd,                       /* Сумма */
               INPCARRY,                         /* Result_Carry */
               " 1",                             /* Kind_Oper */
               FD.tick.rec.DealCode,             /* Numb_Document */
               "Корректировка до амортизированной стоимости, увеличивающая стоимость ц/б", /* Ground */
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
    else
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "+Корр, ОЭБ", "+КоррАС, ОЭБ",   /* AccDeb , AccCred*/
               dat,                              /* Дата */
               1,                                /* Глава */
               NATCUR,                           /* Валюта */
               abs(CorrIntToEIRAdd),             /* Сумма */
               INPCARRY,                         /* Result_Carry */
               " 1",                             /* Kind_Oper */
               FD.tick.rec.DealCode,             /* Numb_Document */
               "Корректировка до амортизированной стоимости, уменьшающая стоимость ц/б", /* Ground */
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
    end;
  end;


  ПолучитьСуммуЗатратПоЦБ(FD.CurPFI(), @SumComisRub, @SumNDSRub);

  if(SumComisRub > 0)
    ComissAdd = SumComisRub;
    NDSAdd    = SumNDSRub;
    
    // Определим сумму ранее списанных затрат по ц/б
    cmd = DL_RSDCommand(  " SELECT T_SUM, T_NDS "
                        + "   FROM DDLSUM_DBT "
                        + "  WHERE T_DOCKIND = ? "
                        + "    AND T_DOCID = ? "
                        + "    AND T_KIND = ? "
                        + "    AND T_DATE <= ? "
                        + " ORDER BY T_DATE DESC, T_DLSUMID DESC"
                       );
    cmd.AddParam(DLDOC_ISSUE);
    cmd.AddParam(FD.CurPFI());
    cmd.AddParam(DLSUM_KIND_OWNAVR_OUTLAY);
    cmd.AddParam(dat);
    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      ComissAdd = ComissAdd - DataSet.Sum;
      NDSAdd    = NDSAdd - DataSet.NDS;
    end;
  end;

  ComissAdd = ComissAdd + OutlayAdd;
  NDSAdd    = NDSAdd + VatOutlayAdd;

  if(ComissAdd > 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Затраты, ОЭБ", "ЗпоСд, ОЭБ",     /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             NATCUR,                           /* Валюта */
             ComissAdd,                        /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Списание затрат при погашении выпуска", /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
    end;
  end;

  if(NDSAdd > 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "+НДС", "ЗпоСд, ОЭБ",             /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             NATCUR,                           /* Валюта */
             NDSAdd,                           /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Списание НДС затрат при погашении выпуска", /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Налог", "+НДС",                 /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             NATCUR,                           /* Валюта */
             NDSAdd,                           /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Отнесение на расходы НДС затрат при погашении выпуска", /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
    end;
  end;

  if( not БУ_СохранитьСуммуКомиссии(DLDOC_ISSUE, FD.CurPFI(), DLSUM_KIND_OWNAVR_OUTLAY, dat, SumComisRub, SumNDSRub, NATCUR ) )
     msgbox("Ошибка при сохранении суммы комисси по ц/б");
     return 1;
  end;

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "ОЭБ, к погашению", "ВнебалСчетКорресп", /* AccDeb , AccCred*/
           dat,                              /* Дата */
           3,                                /* Глава */
           FD.FaceFIID(),                    /* Валюта */
           FD.dl_leg.rec.Cost,               /* Сумма */
           INPCARRY,                         /* Result_Carry */
           " 1",                             /* Kind_Oper */
           FD.tick.rec.DealCode,             /* Numb_Document */
           "Предъявление облигаций для погашения", /* Ground */
           null,
           null,
           null,
           FD.FaceFIID(), NATCUR
          ))
        return 1;
  end;
  

  return 0;
end;

//Проводки учёта погашения ц/б
macro БУ_ПроводкиУчетаПогашенияОЭБ( FD, dat, GrDealID )
  var fiw = TRecHandler("fiwarnts.dbt");
  record СчетКорр( account );
  var SumComisRub, SumNDSRub;
  var rq_payinc = NULL, rq_paym = NULL;
  var query, cmd, DataSet;
  var OurBankIsTaxAgent = UNSET_CHAR;
  var CatAcc = "";
  var sum = $0, sumTax = $0, sumTaxFLR = $0, sumTaxFLN = $0;
  var ComissAdd = $0, NDSAdd = $0;

  //если задан купон, то погашение купона
  if(FD.tick.rec.Number_Coupon != "") 
    if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
      msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
      return 1;
    end;

    if(FD.ExistRqPayIncome())
      rq_payinc = FD.GetRQ(DLRQ_TYPE_PAYINCOME);
    end;

    if(rq_payinc == NULL)
      msgbox("Не найдено ТО по выплате дохода");
      return 1;
    end;

    if(FD.avrserv() != NULL)
      OurBankIsTaxAgent = FD.avrserv().rec.TaxAgent; 
    end;
    


    query =  " select NVL(SUM(t_InterestIncomeAdd), 0) as SumInterestAdd, "
           + "        NVL(SUM(t_DiscountIncomeAdd), 0) as SumDiscountAdd, "
           + "        NVL(SUM(t_BonusAdd), 0) as SumBonusAdd "
           + "   from dpmwrtlnk_dbt "
           + "  where t_SaleID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(FD.pmwrtsum.rec.SumID);
    
    DataSet = cmd.Execute();
    
    if(DataSet.moveNext())

      //Доначисление ПКД
      if(DataSet.SumInterestAdd != 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "%Расход, ОЭБ", "Обяз%, ОЭБ",   /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumInterestAdd,         /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Доначисление ПКД",
                                             null,
                                             null,
                                             null,
                                             NATCUR, FD.FaceFIID() 
                                           )
            )
          return 1;
        end;
      end;

      if(DataSet.SumDiscountAdd != 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "%Расход, ОЭБ", "Дисконт, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumDiscountAdd,         /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Доначисление дисконта",
                                             null,
                                             null,
                                             null,
                                             NATCUR, FD.FaceFIID() 
                                           )
            )
          return 1;
        end;
      end;

      if(DataSet.SumBonusAdd != 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "Премия, ОЭБ", "+Премия, ОЭБ",  /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumBonusAdd,            /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Списание части премии в доходы",
                                             null,
                                             FIROLE_BA,
                                             null,
                                             FD.FaceFIID(), NATCUR  
                                           )
            )
          return 1;
        end;
      end;
    end;


    if(FD.tick.rec.Flag3 == SET_CHAR) //Погашение досрочное
      CatAcc = "Обяз%, ОЭБ";
    else
      CatAcc = "ОЭБ%, к исполнению";
    end;

    sum = rq_payinc.rec.Amount;
    if(sum)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               CatAcc, "ДС в КО",            /* AccDeb , AccCred*/
               dat,                          /* Дата */
               1,                            /* Глава */
               FD.dl_leg.rec.PayFIID,        /* Валюта */
               sum,                          /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Погашение купона.",           /* Ground */
               null,
               null,
               null,
               FD.FaceFIID(), FD.dl_leg.rec.PayFIID
              ))
            return 1;
      end;
    end;

    if(OurBankIsTaxAgent == SET_CHAR) //Наш Банк является налоговым агентом по выпуску

      sumTax = 0;
      if(FD.ExistsRQ(DLRQ_TYPE_TAX_ULN))
        sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_ULN).rec.Amount;
      end;

      if(sumTax)
        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                 CatAcc, "-Бюджетб ф.налоги, ULN",  /* AccDeb , AccCred*/
                 dat,                          /* Дата */
                 1,                            /* Глава */
                 NATCUR,                       /* Валюта */
                 sumTax,                       /* Сумма */
                 INPCARRY,                     /* Result_Carry */
                 " 1",                         /* Kind_Oper */
                 FD.tick.rec.DealCode,         /* Numb_Document */
                 "Удержание налога",           /* Ground */
                 null,
                 null,
                 null,
                 FD.FaceFIID(), NATCUR
                ))
              return 1;
        end;
      end;

      sumTax = 0; sumTaxFLR = $0; sumTaxFLN = $0;
      if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLN))
        sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLN).rec.Amount;
	sumTaxFLN = FD.GetRQ(DLRQ_TYPE_TAX_FLN).rec.Amount;
	sumTaxFLN = round(sumTaxFLN, 0);
      end;

      if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLR))
        sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLR).rec.Amount;
	sumTaxFLR = FD.GetRQ(DLRQ_TYPE_TAX_FLR).rec.Amount;
	sumTaxFLR = round(sumTaxFLR, 0);
      end;
      if(sumTax)
       if(sumTaxFLN)
        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                 CatAcc, "НДФЛ к перечислению, FLN",/* AccDeb , AccCred*/
                 dat,                          /* Дата */
                 1,                            /* Глава */
                 NATCUR,                       /* Валюта */
                 sumTaxFLN,                       /* Сумма */
                 INPCARRY,                     /* Result_Carry */
                 " 1",                         /* Kind_Oper */
                 FD.tick.rec.DealCode,         /* Numb_Document */
                 "Удержание налога, FLN",           /* Ground */
                 null,
                 null,
                 null,
                 FD.FaceFIID(), NATCUR
                ))
              return 1;
        end;
       end;

       if(sumTaxFLR)
        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                 CatAcc, "НДФЛ к перечислению, FLR",/* AccDeb , AccCred*/
                 dat,                          /* Дата */
                 1,                            /* Глава */
                 NATCUR,                       /* Валюта */
                 sumTaxFLR,                       /* Сумма */
                 INPCARRY,                     /* Result_Carry */
                 " 1",                         /* Kind_Oper */
                 FD.tick.rec.DealCode,         /* Numb_Document */
                 "Удержание налога, FLR",           /* Ground */
                 null,
                 null,
                 null,
                 FD.FaceFIID(), NATCUR
                ))
              return 1;
        end;
       end;
      end;
    end;

  end;


  if(FD.tick().rec.Flag3 == SET_CHAR) //Погашение досрочное


    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Дисконт, ОЭБ", "ДС в КО",    /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             $0,                           /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Перенос остатка дисконта",   /* Ground */
             GETRESTACC_DEBET,
             FIROLE_BA,
             null,
             FD.FaceFIID(), FD.dl_leg.rec.PayFIID
            ))
          return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Размещ. ОЭБ", "ДС в КО",    /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             $0,                           /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Перенос остатка размещения", /* Ground */
             GETRESTACC_DEBET,
             null,
             null,
             FD.FaceFIID(), FD.dl_leg.rec.PayFIID
            ))
          return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Премия, ОЭБ", "+Премия, ОЭБ",    /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             $0,                           /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Списание премии",            /* Ground */
             GETRESTACC_DEBET,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;

  else //Погашение не досрочное

    sum = FD.dl_leg.rec.Principal * FD.FaceValue();

    if(sum)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                 "ВнебалСчетКорресп", "ОЭБ, к погашению", /* AccDeb , AccCred*/
                 dat,                          /* Дата */
                 3,                            /* Глава */
                 FD.FaceFIID(),                /* Валюта */
                 sum,                          /* Сумма */
                 INPCARRY,                     /* Result_Carry */
                 " 1",                         /* Kind_Oper */
                 FD.tick.rec.DealCode,         /* Numb_Document */
                 "Списание погашенных облигаций с внебалансового учета", /* Ground */
                 null,
                 null,
                 null,
                 NATCUR, FD.FaceFIID()
                ))
              return 1;
      end;
    end;

    sum = FD.dl_leg.rec.ReceiptAmount * FD.FaceValue();
    if(sum)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "ВнебалСчетКорресп", "Выкуп, ОЭБ", /* КатегДеб , КатегКредит*/
                                           dat,                               /* Дата */
                                           3,                                 /* Глава */
                                           FD.FaceFIID(),                     /* Валюта */
                                           sum,                               /* Сумма  */
                                           INPCARRY,                          /* Result_Carry */
                                           " 1",                              /* Kind_Oper */
                                           "",                                /* Numb_Document */
                                           "Списание ранее выкупленных облигаций с внебалансового учета",
                                           null,
                                           null,
                                           null,
                                           NATCUR, FD.FaceFIID() 
                                         )
        )
        return 1;
      end;
    end;
  end;


  if( FD.IsExistAccount("-Корр, ОЭБ", null, true, null, СчетКорр, null, dat))

    Sum = ABS(GetRestAccount(СчетКорр, dat));

    if(Sum != $0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           СчетКорр, "+Эмиссия, ОЭБ",       /* КатегДеб, КатегКредит*/
                                           dat,                             /* Дата */
                                           1,                               /* Глава */
                                           NATCUR,                          /* Валюта */
                                           Sum,                             /* Сумма  */
                                           INPCARRY,                        /* Result_Carry */
                                           " 1",                            /* Kind_Oper */
                                           "",                              /* Numb_Document */
                                           "Списание корректировок по погашенным ОЭБ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("+Корр, ОЭБ", null, true, null, СчетКорр, null, dat))

    Sum = ABS(GetRestAccount(СчетКорр, dat));

    if(Sum != $0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Эмиссия, ОЭБ", СчетКорр,       /* КатегДеб, КатегКредит*/
                                           dat,                             /* Дата */
                                           1,                               /* Глава */
                                           NATCUR,                          /* Валюта */
                                           Sum,                             /* Сумма  */
                                           INPCARRY,                        /* Result_Carry */
                                           " 1",                            /* Kind_Oper */
                                           "",                              /* Numb_Document */
                                           "Списание корректировок по погашенным ОЭБ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;
  end;


  query =   " select NVL(SUM(t_WrtOutlayAdd), 0) as SumOutlayAdd, "
          + "        NVL(SUM(t_WrtVatOutlayAdd), 0) as SumVatOutlayAdd, "
          + "        NVL(SUM(t_AccountedDefDiffAdd), 0) as SumDefDiffAdd "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);
  
  DataSet = cmd.Execute();
  
  if(DataSet.moveNext())

    ПолучитьСуммуЗатратПоЦБ(FD.CurPFI(), @SumComisRub, @SumNDSRub);

    if(SumComisRub > 0)
      ComissAdd = SumComisRub;
      NDSAdd    = SumNDSRub;
      
      // Определим сумму ранее списанных затрат по ц/б
      cmd = DL_RSDCommand(  " SELECT T_SUM, T_NDS "
                          + "   FROM DDLSUM_DBT "
                          + "  WHERE T_DOCKIND = ? "
                          + "    AND T_DOCID = ? "
                          + "    AND T_KIND = ? "
                          + "    AND T_DATE <= ? "
                          + " ORDER BY T_DATE DESC, T_DLSUMID DESC"
                         );
      cmd.AddParam(DLDOC_ISSUE);
      cmd.AddParam(FD.CurPFI());
      cmd.AddParam(DLSUM_KIND_OWNAVR_OUTLAY);
      cmd.AddParam(dat);
      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        ComissAdd = ComissAdd - DataSet.Sum;
        NDSAdd    = NDSAdd - DataSet.NDS;
      end;
    end;

    ComissAdd = ComissAdd + DataSet.SumOutlayAdd;
    NDSAdd    = NDSAdd + DataSet.SumVatOutlayAdd;


    //Списание затрат по погашаемым ОЭБ на расходы
    if(ComissAdd != 0)
      
      Sum = ComissAdd;
      if(FD.FaceFIID() != NATCUR)
        if( not SmartConvertSum( Sum, Sum, dat, FD.FaceFIID(), NATCUR, true))
          return 1;
        end;
      end;
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           IIF(FD.tick.rec.Flag3 == SET_CHAR, "-Маржа, проч.", "Затраты, ОЭБ"), "ЗпоСд, ОЭБ",  /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           Sum,                            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание затрат по погашаемым ОЭБ на расходы",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание НДС затрат по погашаемым ОЭБ на расходы !!!
    if(NDSAdd != 0)
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "+НДС", "ЗпоСд, ОЭБ",           /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           NDSAdd,                         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание НДС затрат по погашаемым ОЭБ на расходы",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Налог", "+НДС",               /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           DataSet.SumVatOutlayAdd,        /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Перечисление НДС по погашаемым ОЭБ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание отсроченной разницы по выкупленным ОЭБ
    if(DataSet.SumDefDiffAdd != 0)
      
      if(DataSet.SumDefDiffAdd > 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-Эмиссия, ОЭБ", "+КоррАС, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             DataSet.SumDefDiffAdd,           /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Положительная отсроченная разница",
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
      else
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-КоррАС, ОЭБ", "+Эмиссия, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             abs(DataSet.SumDefDiffAdd),      /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Отрицательная отсроченная разница",
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
      end;
    end;
  end;
  
  return 0;
end;
