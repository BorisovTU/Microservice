/*
$Name: nptxwrt072.mac
$Module: Ценные бумаги
$Description: Передача записи в хранилище для операций списания/зачисления денежных средств
*/

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac";

private macro Error( err, ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  if(err)
    MsgBox( ErrStr );
  end;
  return err;
end;

macro ExecuteStep( kind_oper, FDoc, DocKind, ID_Operation, ID_Step )
  record nptxop("nptxop");
  var NeedLoopStep = false;
  var ErrStr = "";
  var err = 0;

  SetBuff( nptxop, FDoc );
  
  err = STB_ExecuteSendToStorOnStep(nptxop.DocKind, nptxop.ID, ID_Operation, ID_Step, @NeedLoopStep, @ErrStr);

  if(ErrStr != "")
    err = Error(err, ErrStr);
  end;

  if(not err)
    err = DL_NPTX_SaveTbMes();

    if(not err)
      if((NeedLoopStep == true))
        if( not InsertOprStatus(460710, 1)) //Расчет сумм налога и вывода СНОБ = Выполнить
          return Error( "Ошибка при установке статуса вида \"Расчет сумм налога и вывода СНОБ\" операции" );        
        end;
        if( not InsertOprStatus(46073, 3)) //Выполнение проводок = Отложить
          return Error( "Ошибка при установке статуса вида \"Расчет сумм налога и вывода СНОБ\" операции" );        
        end;
      else
        if( not InsertOprStatus(460711, 2)) //Формирование и передача записи в хран. = Завершить
          return Error( "Ошибка при установке статуса вида \"Расчет сумм налога и вывода СНОБ\" операции" );        
        end;
        if( not InsertOprStatus(46073, 1)) //Выполнение проводок = Открыт
          return Error( "Ошибка при установке статуса вида \"Расчет сумм налога и вывода СНОБ\" операции" );        
        end;
      end;
    end;
  end;

  return err;
end;

/* Макрос постобработки */
MACRO PostStep (CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,          /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

  record nptxop("nptxop");
  var ErrStr = "";
  var err = 0;

  SetBuff( nptxop, FDoc );

  if(CommitOrRollback == 2)
    err = STB_RollbackSendToStorOnStep(nptxop.DocKind, nptxop.ID, ID_Operation, ID_Step, @ErrStr);
    if(ErrStr != "")
      msgbox(ErrStr);
    end;
  end;

  return err;
END;

