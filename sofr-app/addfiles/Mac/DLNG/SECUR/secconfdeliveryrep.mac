import OprInter, PaymInter, DealsInter, "dlquery.mac", globals, "sp_car2.mac";

macro CreateExecConfirmDeliveryLog()
  var query, cmd, DataSet;
  var prevDealID = 0;
  var stat = 0;
  
  query =   " select tk.t_DealID, tk.t_DealCode, spgr.t_Xld, rq.t_Amount as TkAmount, pm.t_BaseAmount as DpAmount, draft.t_Date DpDate, "
          + "        tkopr.t_Name as TkOprName, dpopr.t_Name as DpOprName, fin.t_Name as FI_Name "
          + "   from doprdistaff_tmp oprtemp, ddl_tick_dbt tk, ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc, dspdraft_dbt draft, dspground_dbt spgr, "
          + "        doprkoper_dbt tkopr, doprkoper_dbt dpopr, dfininstr_dbt fin, ddlrq_dbt rq, dpmpaym_dbt pm "
          + "  where oprtemp.t_ErrorStatus = 0 "
          + "    and oprtemp.t_IsCompleted = 'X' "
          + "    and tk.t_BOfficeKind = oprtemp.t_DocKind "
          + "    and tk.t_DealID = TO_NUMBER(oprtemp.t_DocumentID) "
          + "    and grdeal.t_DocKind = tk.t_BOfficeKind "
          + "    and grdeal.t_DocID = tk.t_DealID "
          + "    and grdeal.t_PlanDate = ? "
          + "    and grdoc.t_GrDealID = grdeal.t_ID "
          + "    and grdoc.t_DocKind = " + DL_DEPODRAFT
          + "    and draft.t_AutoKey = grdoc.t_DocID "
          + "    and spgr.t_SPgroundID = draft.t_SPgroundID "
          + "    and fin.t_FIID = grdeal.t_FIID "
          + "    and tkopr.t_Kind_Operation = tk.t_DealType "
          + "    and dpopr.t_Kind_Operation = draft.t_Kind_Operation "
          + "    and rq.t_DocKind = tk.t_BOfficeKind "
          + "    and rq.t_DocID = tk.t_DealID "
          + "    and rq.t_Type = " + DLRQ_TYPE_DELIVERY
          + "    and rq.t_FIID = fin.t_FIID "
          + "    and pm.t_DocKind = draft.t_Kind "
          + "    and pm.t_DocumentID = draft.t_AutoKey "
          + "    and pm.t_Purpose = " +BAi
          + "  order by tk.t_DealCode, spgr.t_Xld ";

  cmd = DL_RSDCommand(query);
  
  cmd.AddParam({curdate});

  if(cmd.GetCount() > 0)

    println("                                     ▐░▌▓▌┼▌▀ ▐░▌┌┘░┼┬ ▐▌▒▓─┌┼┬ ▐▌ ┌█┘│┬░├┘┌⌡▄ ▒└┘▀┼─▄");
    println("                                             ┌Ю╔╛О ╞Ю╝╒╔Ю╙╗: "+string({curdate}:f)+" "+string(time()));

    println("здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддбддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©" );
    println("Ё                           ▒╓╔╚╙═                          Ё                           ▐╝ЮЦГ╔╜╗О                           Ё" );
    println("цддддддддддбддддддддддддддддддддддбддддддддддддбддддддддддддедддддддддддддбддддддддддддддддддбддддддддддддддддддбддддддддддд╢" );
    println("Ё  █╝╛╔Ю   Ё        ▓╗╞           Ё   ┌К╞ЦА╙   Ё ┼╝╚╗Г╔АБ╒╝ Ё   ┌Е. Э     Ё       ▓╗╞        Ё   ┼╝╚╗Г╔АБ╒╝     Ё ┬А╞╝╚╜╔╜╝ Ё" );
    println("цддддддддддеддддддддддддддддддддддеддддддддддддеддддддддддддедддддддддддддеддддддддддддддддддеддддддддддддддддддеддддддддддд╢" );

    DataSet = cmd.Execute();
    stat = DataSet.moveNext();
    while(stat)

            [Ё##########Ё######################Ё############Ё############Ё#############Ё##################Ё##################Ё###########Ё]
            (IIF(prevDealID != DataSet.DealID, DataSet.DealCode, ""):c,
             IIF(prevDealID != DataSet.DealID, DataSet.TkOprName, ""):w,
             IIF(prevDealID != DataSet.DealID, DataSet.FI_Name, ""):w,
             IIF(prevDealID != DataSet.DealID, DataSet.TkAmount, ""),
             DataSet.Xld:c,
             DataSet.DpOprName:w,
             DataSet.DpAmount,
             date(DataSet.DpDate):f
            );


      prevDealID = DataSet.DealID;

      stat = DataSet.moveNext();
      if(stat)
        println("цддддддддддеддддддддддддддддддддддеддддддддддддеддддддддддддедддддддддддддеддддддддддддддддддеддддддддддддддддддеддддддддддд╢" );
      else
        println("юддддддддддаддддддддддддддддддддддаддддддддддддаддддддддддддадддддддддддддаддддддддддддддддддаддддддддддддддддддеддддддддддды" );
      end;

    end;
  else
    println("█╔ ╜═╘╓╔╜╝ ╞╝╓Е╝╓ОИ╗Е А╓╔╚╝╙");
  end;
end;