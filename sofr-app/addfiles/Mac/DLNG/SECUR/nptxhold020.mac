/*
$Name:        nptxhold020.mac
$Module:      Ценные бумаги
$Description: Операция удержания НДФЛ. Шаг "Расчет сумм"
*/
IMPORT InsCarryDoc, DealsInter, "secinter.mac", "nptxcalcfun.mac", "nptxreqfun.mac";

PRIVATE VAR Oper = TRecHandler( "nptxop.dbt" );

private macro ВозвратПереплатыВТечениеГода()
   var ErrCode, Mode;

   GetRegistryValue( "COMMON\\НДФЛ\\ВОЗВРАТ ПЕРЕПЛАТ В ТЕЧЕНИЕ ГОДА", V_BOOL, Mode, ErrCode );

   return Mode and (ErrCode == 0);
end;

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

PRIVATE MACRO Msg( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 20 );
  return 0;
END;

PRIVATE MACRO IsChildOp()
  var query, cmd, DataSet;

  query =   " select 1 "
          + "   from doproper_dbt op "
          + "  where op.t_DocKind = ? "
          + "    and op.t_DocumentID = LPAD(?, 34, '0') "
          + "    and op.t_Parent_ID_Operation > 0 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(Oper.rec.DocKind);
  cmd.AddParam(Oper.rec.ID);

  if(cmd.GetCount() > 0)
    return true;
  end;

  return false;
END;

private macro ExistSavedVal(ID_Operation:integer, ValKind:integer)
  var query, cmd, DataSet;

  query =   " select 1 "
          + "   from dnptxval_dbt v "
          + "  where v.t_ID_Operation = ? "
          + "    and v.t_Kind = ? " 
          + "    and ROWNUM = 1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ID_Operation);
  cmd.AddParam(ValKind);

  if(cmd.GetCount() > 0)
    return true;
  end;

  return false;
end;

private macro GetNptxopDateTime(nptxop, currIncDate:@date, currIncTime:@time)
  var query, cmd, DataSet;

  currIncDate = nptxop.rec.OperDate;
  currIncTime = nptxop.rec.Time;

  if(currIncTime == time(0))
    query =   " select op.t_Syst_Time "
            + "   from doproper_dbt op "
            + "  where op.t_DocKind = ? "
            + "    and op.t_DocumentID = LPAD(?, 34, '0') ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(nptxop.rec.DocKind);
    cmd.AddParam(nptxop.rec.ID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      currIncTime = time(DataSet.Syst_Time);
    end;
  end;
end;

private class TBCCBalanceData(_BCCPITax, _TaxBaseKind, _IsDepo, _Balance)
  var BCCPITax    = _BCCPITax;   
  var TaxBaseKind = _TaxBaseKind;
  var Balance     = _Balance;
  var IsDepo      = _IsDepo;
end;

private class TDeltaBalanceCollect(needAccTrn)
  var m_DeltaBalanceArr = TArray();
  var m_needAccTrn = needAccTrn;
  var m_SumAccTrn = $0;

  macro find(_BCCPITax, _TaxBaseKind, _IsDepo)
    var i = 0;

    while(i < m_DeltaBalanceArr.size)
      if((m_DeltaBalanceArr[i].BCCPITax == _BCCPITax) and (m_DeltaBalanceArr[i].TaxBaseKind == _TaxBaseKind) and (m_DeltaBalanceArr[i].IsDepo == _IsDepo))
        return i;
      end;
      i = i + 1;
    end;

    return -1; 
  end;

  private macro Add(_BCCPITax, _TaxBaseKind, _Balance, _IsDepo, _inAccTrn)
    var i = find(_BCCPITax, _TaxBaseKind, _IsDepo);

    if(i != -1)
      m_DeltaBalanceArr[i].Balance = m_DeltaBalanceArr[i].Balance + _Balance;
    else
      m_DeltaBalanceArr[m_DeltaBalanceArr.size] = TBCCBalanceData(_BCCPITax, _TaxBaseKind, _IsDepo, _Balance);
    end;

    if((_BCCPITax == NPTXKBK_15) and (_inAccTrn))
      m_SumAccTrn = m_SumAccTrn + _Balance;
    end;   
  end;

  macro AddAll(_BCCPITax, _TaxBaseKind, _IsDepo, _Balance, _BCCPITax2, _TaxBaseKind2, _IsDepo2, _Balance2)
    var inAccTrn = false;
    if((m_needAccTrn) and (_BCCPITax != _BCCPITax2) and ((_BCCPITax == NPTXKBK_15) or (_BCCPITax2 == NPTXKBK_15)))
      inAccTrn = true;
    end;
    
    Add(_BCCPITax, _TaxBaseKind, _Balance, _IsDepo, inAccTrn);
    Add(_BCCPITax2, _TaxBaseKind2, _Balance2, _IsDepo2, inAccTrn);
  end;
end;

private macro ClearZeroBalance(BalanceArr:@TArray)
  var arr = TArray();
  var i = 0;

  while(i < BalanceArr.size)
    if(BalanceArr[i].Balance != 0)
      arr[arr.size] = BalanceArr[i];
    end;

    i = i + 1;
  end;

  BalanceArr = TArray(arr);
end;

//Аналогично операции зачета, но только по массивам и без протокола
PRIVATE MACRO ВыполнитьЗачетНалогов(CalcParams:@TCalcPaidParams, NeedSendToStor:@bool, ID_Operation, ID_Step)
  var BalancePlusArr  = TArray();
  var BalanceMinusArr = TArray();
  var SumBalancePlus = $0;
  var SumBalanceMinus = $0;
  var FD = DLFirstDocNPTXOP(Oper);
  var TaxObj = TInsertTaxObject();
  var AnaliticKind2 = 0, Analitic2 = -1;
  var AnaliticKind6 = 0, Analitic6 = -1;
  var DeltaBalance = NULL;
  var SumOffset = $0;
  var DeltaS = $0;
  var ErrStr = "";
  var i = 0;
  var err = 0;
  var ObjKind = 0, ObjKind2 = 0;
  var OutSystCode = "";
  var Rate = 0;
  var Sum = 0;
  var TxArr = TArray();
  var TaxPeriod = 0;
  var IncDate = date(0,0,0), IncTime = time(0);

  NeedSendToStor = false;

  datesplit(Oper.rec.PrevDate, null, null, TaxPeriod);

  macro AddValueToBalArr(BCCPITax, TaxBaseKind, IsDepo, Balance)
    if(Balance > 0)
      BalancePlusArr[BalancePlusArr.size] = TBCCBalanceData(BCCPITax, TaxBaseKind, IsDepo, Balance);
      SumBalancePlus = SumBalancePlus + Balance;
    elif(Balance < 0)
      BalanceMinusArr[BalanceMinusArr.size] = TBCCBalanceData(BCCPITax, TaxBaseKind, IsDepo, Balance);
      SumBalanceMinus = SumBalanceMinus + abs(Balance);
    end;
  end;

  macro CorrValueByDeltaBal(BCCPITax, TaxBaseKind, IsDepo, Val:@money)
    var j = -1;
    if(DeltaBalance.m_DeltaBalanceArr.size > 0)
      j = DeltaBalance.find(BCCPITax, TaxBaseKind, IsDepo);
      if(j >= 0)
        Val = Val - DeltaBalance.m_DeltaBalanceArr[j].Balance;
      end;
    end;
  end;

  AddValueToBalArr(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_IIS,  false, CalcParams.SOFR_Dg_0201_IIS);
  AddValueToBalArr(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_BROK, false, CalcParams.SOFR_Dg_0201    );
  AddValueToBalArr(NPTXKBK_PROC, NPTXTOTALBASE_TAXBASEKIND_IIS,  true,  CalcParams.DEPO_Dg_0207_IIS);
  AddValueToBalArr(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_IIS,  true,  CalcParams.DEPO_Dg_0201_IIS);  
  AddValueToBalArr(NPTXKBK_PROC, NPTXTOTALBASE_TAXBASEKIND_BROK, true,  CalcParams.DEPO_Dg_0207    );
  AddValueToBalArr(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_BROK, true,  CalcParams.DEPO_Dg_0201    );
  AddValueToBalArr(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_IIS,  false, CalcParams.SOFR_Dp_0208_IIS);
  AddValueToBalArr(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_BROK, false, CalcParams.SOFR_Dp_0208    );
  AddValueToBalArr(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_IIS,  true,  CalcParams.DEPO_Dp_0208_IIS);
  AddValueToBalArr(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_BROK, true,  CalcParams.DEPO_Dp_0208    );

  SumOffset = min(SumBalancePlus, SumBalanceMinus);

  if(SumOffset == 0)
    return 0;
  end;

  GetNptxopDateTime(Oper, @IncDate, @IncTime);


  var accMain = TRecHandler("account.dbt");
  var acc15   = TRecHandler("account.dbt");
  var CatCode = "";
  var IsClientResident = STB_IsResidentStatus(STB_GetClientTaxPayerStatus(Oper.rec.Client));
  var ClientShortName = ПолучитьКороткоеИмяСубъекта(Oper.rec.Client);
  var needAccTrn = true;
  

  CatCode = "НДФЛ к перечислению, FLR";
  if(IsClientResident == false)
    CatCode = "НДФЛ к перечислению, FLN";
  end;
  if( not FD.OpenAccount(CatCode, null, false, null, accMain, Oper.rec.OperDate, NATCUR) )
     return Error( "Ошибка при определении счета по категории <"+CatCode+">." );
  end;

  CatCode = "НДФЛ к перечислению 15%";
  if( not FD.OpenAccount(CatCode, null, false, null, acc15, Oper.rec.OperDate, NATCUR) )
     return Error( "Ошибка при определении счета по категории <"+CatCode+">." );
  end;

  if(accMain.rec.Account == acc15.rec.Account)
    needAccTrn = false;
  end;

  DeltaBalance = TDeltaBalanceCollect(needAccTrn);

  while(SumOffset != 0)
    if((BalancePlusArr.size == 0) or (BalanceMinusArr.size == 0))
      break;
    end;

    //Работаем всегда только с первыми элементами массивов, так как далее мы уменьшаем в них баланс, а затем элементы с нулевым балансом вычищаем
    DeltaS = min(abs(BalancePlusArr[0].Balance), abs(BalanceMinusArr[0].Balance));

    BalancePlusArr[0].Balance = BalancePlusArr[0].Balance - DeltaS;
    BalanceMinusArr[0].Balance = BalanceMinusArr[0].Balance + DeltaS;
    DeltaBalance.addAll(BalancePlusArr[0].BCCPITax, BalancePlusArr[0].TaxBaseKind, BalancePlusArr[0].IsDepo, DeltaS, BalanceMinusArr[0].BCCPITax, BalanceMinusArr[0].TaxBaseKind, BalanceMinusArr[0].IsDepo, -DeltaS);

    SumOffset = SumOffset - DeltaS;

    ClearZeroBalance(@BalancePlusArr);
    ClearZeroBalance(@BalanceMinusArr);
  end;

  if(DeltaBalance.m_DeltaBalanceArr.size > 0)
    var SCorr = $0;

    if(DeltaBalance.m_SumAccTrn != 0) 
      var DtAccountNum = "", CtAccountNum = "";
      
      SCorr = DeltaBalance.m_SumAccTrn;

      if(0 != ВыполнитьПроводкуЗачетаНДФЛ(FD, 
                                          Oper.rec.Code, 
                                          Oper.rec.Client, 
                                          Oper.rec.OperDate, 
                                          IIF(SCorr > 0, SCorr, $0), 
                                          IIF(SCorr < 0, SCorr, $0), 
                                          @DtAccountNum, 
                                          @CtAccountNum, 
                                          @ErrStr
                                         ))
        return Error(ErrStr);
      end;
    end;

    i = 0;
    while((not err) and (i < DeltaBalance.m_DeltaBalanceArr.size))

      //Формируем объект НДР
      ObjKind  = 0;
      ObjKind2 = 0;

      OutSystCode = "";

      if(DeltaBalance.m_DeltaBalanceArr[i].IsDepo)
        OutSystCode = "ДЕПО";
      end;

      AnaliticKind2 = TXOBJ_KIND2040;

      if((DeltaBalance.m_DeltaBalanceArr[i].BCCPITax == NPTXKBK_MAIN) or (DeltaBalance.m_DeltaBalanceArr[i].BCCPITax == NPTXKBK_PROC)) //КБК по основной ставке
        if(DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
          ObjKind = TXOBJ_PAIDGENERAL;
        elif(DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
          ObjKind = TXOBJ_PAIDGENERAL_IIS;
        end;

        Rate = int(NPTXGENTAXRATE_RESIDENT*100);
        if(IsClientResident == false)
          Rate = int(NPTXGENTAXRATE_NOTRESIDENT*100);
        end;

        Analitic2 = 201;
        if(DeltaBalance.m_DeltaBalanceArr[i].BCCPITax == NPTXKBK_PROC)
          Analitic2 = 207;
        end;

      elif(DeltaBalance.m_DeltaBalanceArr[i].BCCPITax == NPTXKBK_15) //КБК по повышенной ставке
        if(DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
          ObjKind = TXOBJ_PAIDGENERAL_15;
          ObjKind2 = TXOBJ_PAIDGENERAL_15_2;
        elif(DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
          ObjKind = TXOBJ_PAIDGENERAL_15_IIS;
        end;

        Rate = int(NPTXGENTAXRATE_RESIDENT_15*100);

        Analitic2 = 208;
      end;

      AnaliticKind6 = 0; 
      Analitic6 = -1;

      //if((DeltaBalance.m_DeltaBalanceArr[i].IsDepo == false) and (DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind != NPTXTOTALBASE_TAXBASEKIND_ONB))
      //  AnaliticKind6 = TXOBJ_KIND6020;
      //  Analitic6 = GetPtContrIDForNDR(Oper.rec.Client, date(Oper.rec.OperDate), IIF(DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS, 1, 0));
      //end;

      Sum = DeltaBalance.m_DeltaBalanceArr[i].Balance;

      if(ObjKind)
        TaxObj.Add( 1                             
                   ,Oper.rec.OperDate  // Дата НДР
                   ,Oper.rec.Client    // Клиент
                   ,TXOBJ_DIR_OUT      // Направление
                   ,8                  // Уровень
                   ,""                 // Признак "Пользовательский"
                   ,ObjKind            // Вид НДР
                   ,Sum                // Сумма дохода/расхода
                   ,NATCUR             // Валюта дохода/расхода
                   ,0                  // Вид аналитики 1
                   ,-1                 // Аналитика 1
                   ,AnaliticKind2      // Вид аналитики 2
                   ,Analitic2          // Аналитика 2
                   ,0                  // Вид аналитики 3
                   ,-1                 // Аналитика 3
                   ,0                  // Вид аналитики 4
                   ,-1                 // Аналитика 4
                   ,0                  // Вид аналитики 5
                   ,-1                 // Аналитика 5
                   ,AnaliticKind6      // Вид аналитики 6
                   ,Analitic6          // Аналитика 6
                   ,"Объект, созданный при зачете удержанного НДФЛ в операции удержания при окончании года" // Комментарий
                   ,Oper.rec.ID        // ID операции
                   ,ID_Step            // ID шага операции
                   ,1                  // Признак вызова не из операции расчета НОБ
                   ,UNSET_CHAR         // Технический
                   ,UNSET_CHAR         // Признак внешней системы
                   ,OutSystCode        // Код внешней системы
                   ,""                 // ID во внешней системе
                  );

      end;

      if(ObjKind2)
        TaxObj.Add( 1
                   ,Oper.rec.OperDate    // Дата НДР
                   ,Oper.rec.Client      // Клиент
                   ,TXOBJ_DIR_OUT        // Направление
                   ,8                    // Уровень
                   ,""                   // Признак "Пользовательский"
                   ,ObjKind2             // Вид НДР
                   ,Sum                  // Сумма дохода/расхода
                   ,NATCUR               // Валюта дохода/расхода
                   ,0                    // Вид аналитики 1
                   ,-1                   // Аналитика 1
                   ,AnaliticKind2        // Вид аналитики 2
                   ,Analitic2            // Аналитика 2
                   ,0                    // Вид аналитики 3
                   ,-1                   // Аналитика 3
                   ,0                    // Вид аналитики 4
                   ,-1                   // Аналитика 4
                   ,0                    // Вид аналитики 5
                   ,-1                   // Аналитика 5
                   ,AnaliticKind6        // Вид аналитики 6
                   ,Analitic6            // Аналитика 6
                   ,"Объект, созданный при зачете удержанного НДФЛ в операции удержания при окончании года"  // Комментарий
                   ,Oper.rec.ID          // ID операции
                   ,ID_Step              // ID шага операции
                   ,1                    // Признак вызова не из операции расчета НОБ
                   ,UNSET_CHAR           // Технический
                   ,UNSET_CHAR           // Признак внешней системы
                   ,OutSystCode          // Код внешней системы
                   ,""                   // ID во внешней системе
                  );

      end;


      //Для событий СНОБ
      TxArr.size = 0;
      TxArr[TxArr.size] = STB_TaxRateParm(Rate, $0, Sum, DeltaBalance.m_DeltaBalanceArr[i].BCCPITax);

      needSendToStor = true;

      err = STB_ExecuteCreateSTBOnStep(TxArr,
                                       $0, 
                                       Oper.rec.DocKind, 
                                       Oper.rec.ID, 
                                       Oper.rec.Client, 
                                       Oper.rec.OperDate, 
                                       IIF(DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS, true, false), 
                                       TaxPeriod, 
                                       ID_Operation, 
                                       ID_Step, 
                                       @ErrStr,
                                       IncDate,
                                       IncTime,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       DeltaBalance.m_DeltaBalanceArr[i].TaxBaseKind,
                                       IIF(DeltaBalance.m_DeltaBalanceArr[i].IsDepo, "Диасофт. ", "")+"Урегулирование НДФЛ между КБК",
                                       3 /*Зачет переплаты*/
                                       );


      if(ErrStr)
        Error(ErrStr);
      end;

      i = i + 1;
    end;

    if(not err)
      TaxObj.Save();

      err = DL_NPTX_StartInsertTaxObject(Oper.rec.ID, ID_Step);
    end;

    if(not err)
      CorrValueByDeltaBal(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_IIS,  false, @CalcParams.SOFR_Dg_0201_IIS);
      CorrValueByDeltaBal(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_BROK, false, @CalcParams.SOFR_Dg_0201    );
      CorrValueByDeltaBal(NPTXKBK_PROC, NPTXTOTALBASE_TAXBASEKIND_IIS,  true,  @CalcParams.DEPO_Dg_0207_IIS);
      CorrValueByDeltaBal(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_IIS,  true,  @CalcParams.DEPO_Dg_0201_IIS);  
      CorrValueByDeltaBal(NPTXKBK_PROC, NPTXTOTALBASE_TAXBASEKIND_BROK, true,  @CalcParams.DEPO_Dg_0207    );
      CorrValueByDeltaBal(NPTXKBK_MAIN, NPTXTOTALBASE_TAXBASEKIND_BROK, true,  @CalcParams.DEPO_Dg_0201    );
      CorrValueByDeltaBal(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_IIS,  false, @CalcParams.SOFR_Dp_0208_IIS);
      CorrValueByDeltaBal(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_BROK, false, @CalcParams.SOFR_Dp_0208    );
      CorrValueByDeltaBal(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_IIS,  true,  @CalcParams.DEPO_Dp_0208_IIS);
      CorrValueByDeltaBal(NPTXKBK_15,   NPTXTOTALBASE_TAXBASEKIND_BROK, true,  @CalcParams.DEPO_Dp_0208    );
    end;

  end;

  return err;
END;


PRIVATE MACRO ОпределитьСуммуУдерж(Oper, CalcParams, TaxePayment:@MONEY, taxe:@MONEY, taxe15:@MONEY, ArrHoldSTB:@TArray)
  var query, cmd, DataSet;
  var MaxTaxe = $0;
  var PriorNDFLobj = CPriorNDFL();
  var YearTax = 0; 
  var EndDate;
  var TaxToPay = 0;

  DateSplit(Oper.rec.PrevDate, NULL, NULL, YearTax);

  EndDate = date(31,12,YearTax);
  
  ArrHoldSTB.size = 0;
  
  taxe   = $0;
  taxe15 = $0;

  macro SortByPrior(left:Variant, right:Variant, data:Variant)
    return IIF( PriorNDFLobj.getPriorForObj(left.Ставка, left.ВидНБ, left.SpecialTag, IIF(left.Symbol == "Д", 2, 1), left.КБК ) < 
                PriorNDFLobj.getPriorForObj(right.Ставка, right.ВидНБ, right.SpecialTag, IIF(right.Symbol == "Д", 2, 1), right.КБК ),
                -1, 
                (IIF(PriorNDFLobj.getPriorForObj(left.Ставка, left.ВидНБ, left.SpecialTag, IIF(left.Symbol == "Д", 2, 1), left.КБК) > 
                     PriorNDFLobj.getPriorForObj(right.Ставка, right.ВидНБ, right.SpecialTag, IIF(right.Symbol == "Д", 2, 1), right.КБК), 1, 0))
              );
  end;
  
  
  query =   " with acc as (select DISTINCT sa.t_Account, sa.t_Chapter, sa.t_FIID as t_Currency, (CASE WHEN mp.t_MarketID > 0 THEN 0 ELSE 1 END) as IsOutMarket, dlc.t_DlContrID"
          + "                from dsettacc_dbt sa, dmcaccdoc_dbt accdoc, dsfcontr_dbt sf, ddlcontrmp_dbt mp, ddlcontr_dbt dlc "
          + "               where sa.t_PartyID = ? "
          + "                 and sa.t_FIKind = " + FIKIND_CURRENCY
          + "                 and sa.t_FIID = " + NATCUR
          + "                 and sa.t_Account LIKE '306%' "
          + "                 and accdoc.t_Account = sa.t_Account "
          + "                 and accdoc.t_Chapter = sa.t_Chapter "
          + "                 and accdoc.t_Currency = sa.t_FIID "
          + "                 and accdoc.t_Owner = sa.t_PartyID "
          + "                 and sf.t_ID = accdoc.t_ClientContrID "
          + "                 and mp.t_SfContrID = sf.t_ID "
          + "                 and dlc.t_DlContrID = mp.t_DlContrID "
          + "                 and dlc.t_IIS = CHR(0) "
          + "             ) "
          + " select q.* "
          + "   from (select q1.*, GREATEST(LEAST(q1.AccRest, q1.PlanAccRest), 0) as CalcAccRest "
          + "           from (select acc.*, rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null) as AccRest, "
          + "                        rsb_brkrep_rshb.GetPlanRestAcc(acc.t_DlContrID, acc.t_Account, acc.t_Chapter, acc.t_Currency, ?) as PlanAccRest "
          + "                 from acc "
          + "                ) q1 "
          + "        ) q "
          + "  where q.CalcAccRest <> 0 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(Oper.rec.Client);
  cmd.AddParam(Oper.rec.OperDate);
  cmd.AddParam(Oper.rec.OperDate);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    MaxTaxe = MaxTaxe + Round(money(DataSet.CalcAccRest),0,2);
  end;

  if(MaxTaxe == 0)
    Msg("На счетах клиента нулевые остатки");
  end;
  
  var  i = 0;
  
  while(i < CalcParams.size)
  
    if(CalcParams[i].TaxHoldBrokDEPO > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    CalcParams[i].TaxHoldBrokDEPO, 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "Д",  //Symbol Временно используется для признака события по ДЕПО/СОФР, при создании записей в nptxhold031.mac затрется 
                                                    "БРОК"
                                                    );
    end;
  
    if(CalcParams[i].TaxHoldBrokSOFR > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    CalcParams[i].TaxHoldBrokSOFR, 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "С",  //Symbol Временно используется для признака события по ДЕПО/СОФР, при создании записей в nptxhold031.mac затрется 
                                                    "БРОК"
                                                    );
    end;
  
    if(CalcParams[i].TaxHoldMaterial > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    CalcParams[i].TaxHoldMaterial, 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "С", //Symbol Временно используется для признака события по ДЕПО/СОФР, при создании записей в nptxhold031.mac затрется 
                                                    "МАТ"
                                                    );
    end;
    
    if(CalcParams[i].TaxHoldBILL > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    CalcParams[i].TaxHoldBILL, 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "С",   //Symbol Временно используется для признака события по ДЕПО/СОФР, при создании записей в nptxhold031.mac затрется 
                                                    "ВЕКС" 
                                                    );
    end;
  
    if(CalcParams[i].TaxHoldONB > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    CalcParams[i].TaxHoldONB, 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_ONB, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "С", //Symbol Временно используется для признака события по ДЕПО/СОФР, при создании записей в nptxhold031.mac затрется 
                                                    ""   
                                                    );
    end;

    i = i + 1;
  end;
  
  ArrHoldSTB.sort(@SortByPrior);

  i = 0;
  
  while(i < ArrHoldSTB.size)
    if( min(ArrHoldSTB[i].Налог, MaxTaxe) > 0)
      ArrHoldSTB[i].Налог = min(ArrHoldSTB[i].Налог, MaxTaxe);
      MaxTaxe = MaxTaxe - ArrHoldSTB[i].Налог;
    else
      ArrHoldSTB.size = i;
      BREAK;
    end;

    i = i + 1;
  end;
  
  i = 0;
  
  while(i < ArrHoldSTB.size)
    if((ArrHoldSTB[i].Ставка == int(NPTXGENTAXRATE_RESIDENT*100)) or (ArrHoldSTB[i].Ставка == int(NPTXGENTAXRATE_NOTRESIDENT*100)))
      taxe = taxe + ArrHoldSTB[i].Налог;
    elif(ArrHoldSTB[i].Ставка == int(NPTXGENTAXRATE_RESIDENT_15*100))
      taxe15 = taxe15 + ArrHoldSTB[i].Налог;
    end;
    
    TaxePayment = TaxePayment + ArrHoldSTB[i].Налог;

    i = i + 1;
  end;
END;

PRIVATE MACRO ОпределитьСуммуВозврат(CalcParams, pIIS, TaxePayment:@MONEY, taxe:@MONEY, taxe15:@MONEY, ArrHoldSTB:@TArray)
 
  var  i = 0;
  
  ArrHoldSTB.size = 0;
  
  while(i < CalcParams.size)
  
    if(abs(CalcParams[i].TaxHoldBrokDEPO) > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    abs(CalcParams[i].TaxHoldBrokDEPO), 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "", 
                                                    "БРОК" 
                                                    );
    end;
  
    if(abs(CalcParams[i].TaxHoldBrokSOFR) > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    abs(CalcParams[i].TaxHoldBrokSOFR), 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "", 
                                                    "БРОК" 
                                                    );
    end;
  
    if(abs(CalcParams[i].TaxHoldMaterial) > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    abs(CalcParams[i].TaxHoldMaterial), 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "",   
                                                    "МАТ" 
                                                    );
    end;
    
    if(abs(CalcParams[i].TaxHoldBILL) > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    abs(CalcParams[i].TaxHoldBILL), 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_BROK, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "",   
                                                    "ВЕКС" 
                                                    );
    end;
  
    if(abs(CalcParams[i].TaxHoldONB) > 0)
      ArrHoldSTB[ArrHoldSTB.size] = STB_TaxRateParm(CalcParams[i].Rate, 
                                                    $0, 
                                                    abs(CalcParams[i].TaxHoldONB), 
                                                    CalcParams[i].CodeKBK, 
                                                    NPTXTOTALBASE_TAXBASEKIND_ONB, 
                                                    NULL, //ИИС
                                                    NULL,
                                                    NULL, 
                                                    $0,   //TaxCalc
                                                    NULL, 
                                                    "",   
                                                    "" 
                                                    );
    end;

    i = i + 1;
  end;

  i = 0;

  while(i < ArrHoldSTB.size)
    if((ArrHoldSTB[i].Ставка == int(NPTXGENTAXRATE_RESIDENT*100)) or (ArrHoldSTB[i].Ставка == int(NPTXGENTAXRATE_NOTRESIDENT*100)))
      taxe = taxe + ArrHoldSTB[i].Налог;
    elif(ArrHoldSTB[i].Ставка == int(NPTXGENTAXRATE_RESIDENT_15*100))
      taxe15 = taxe15 + ArrHoldSTB[i].Налог;
    end;
    
    TaxePayment = TaxePayment + ArrHoldSTB[i].Налог;

    i = i + 1;
  end;

  if( not InsertOprStatus(46081, 16)) //Передача в Хранилище и форм. завления
    return Error( "Ошибка при установке статуса вида \"Передача в Хранилище и форм. завления\" операции" );        
  end;
END;

private macro UseCorrForAddKBK()
  DL_NPTX_PutMsg("X", 205);
end;

PRIVATE MACRO RunAction(ID_Operation, ID_Step)
  VAR NewOper = TRecHandler( "nptxop.dbt" );
  var stat = 0;
  var EndDate = date(0,0,0), CalcDate = date(0,0,0);
  var Year = 0;
  var TO = $0, SO = $0, SZ = $0;
  var Bg, Bm, Bs, Bo, Bd, Bp;
  var Dg = $0, Dm = $0, Ds = $0, Dp = $0, Po = $0;
  var taxe = $0, taxe15 = $0;
  var TaxToPay = $0;
  var НОБ_осн = $0, НОБ_повыш = $0;
  var ByKBK = false, DgKBK1 = $0, DgKBK2 = $0, taxeKBK1 = $0, taxeKBK2 = $0;
  var Rg, Rs, Rp;
  var CalcParams = TCalcPaidParams();
  var НОБ_опер = $0;
  var SOFR_taxe0201_IIS = $0;
  var DEPO_taxe0201_IIS = $0;
  var DEPO_taxe0207_IIS = $0;
  var SOFR_taxe0201     = $0;
  var DEPO_taxe0201     = $0;
  var DEPO_taxe0207     = $0;
  var SOFR_taxe0208_IIS = $0;
  var DEPO_taxe0208_IIS = $0;
  var SOFR_taxe0208     = $0;
  var DEPO_taxe0208     = $0;
  var MaxTaxe           = $0;
  var BreakFlag         = false;
  var CorrTxArr  = TArray();
  var TaxHoldArr = TArray();
  var AccTaxQuery, AccTaxSelect, AccTaxDS;
  var prev_taxe = $0, prev_taxe15 = $0;
  var НОБ_30 = $0, НОБ_13 = $0, НОБ_15 = $0;
  var TaxRateParmMain = NULL, TaxRateParm15 = NULL;
  var MaxTaxeNat;
  var YearTax = 0;
  var ArrHoldPrm = TArray();
  var ArrHoldSTB = TArray();
  var TaxePayment = $0; 
  var SpecialTag = "";
  var TaxRateParmAddArr = TArray();


  DateSplit(Oper.rec.PrevDate, NULL, NULL, Year);
  EndDate = date(31,12,Year);

  DateSplit(EndDate, NULL, NULL, YearTax);

  var TaxTeriodToLucre = CheckTaxTeriodToLucre(YearTax);

  if(Oper.rec.OperDate < EndDate)
    EndDate = Oper.rec.OperDate;
  end;
  
  CalcDate = DL_GetCalcPeriodDate(NPTXCALC_CALCNDFL, Oper.rec.Client, Oper.rec.IIS);
  if(EndDate < CalcDate)
    CalcDate = EndDate;
  end;

  Copy( NewOper, Oper );

  var IsClientResident = STB_IsResidentStatus(STB_GetClientTaxPayerStatus(Oper.rec.Client));
  ПолучитьСтавкиНалога(Oper.rec.Client, IsClientResident, EndDate, @Rg, @Rp, @Rs);


  if((Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY) or (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_CLOSE)) //"Вывод д/с" или "Закрытие договора"
    if(NewOper.rec.TOut == $0)
      NewOper.rec.TOut = GetOutCurrencySum(Oper.rec.Client, IIF(Oper.rec.IIS == SET_CHAR, 1, 0), Oper.rec.OperDate, Oper.rec.OperDate, true, Oper.rec.OperDate);
    end;

    TO = NewOper.rec.TOut;
  end;

  if((Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY) or (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_OUTAVOIR))
    SO = NewOper.rec.OutSum = GetOutCurrencySum(Oper.rec.Client, IIF(Oper.rec.IIS == SET_CHAR, 1, 0), Oper.rec.PrevDate, EndDate, false, Oper.rec.OperDate);

    if( Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_OUTAVOIR )
       SZ = NewOper.rec.OutCost = GetOutAvoirissSum(Oper.rec.Client, IIF(Oper.rec.IIS == SET_CHAR, 1, 0), Oper.rec.PrevDate, EndDate, @TO);
       NewOper.rec.TOut = TO;
    else
       SZ = NewOper.rec.OutCost = GetOutAvoirissSum(Oper.rec.Client, IIF(Oper.rec.IIS == SET_CHAR, 1, 0), Oper.rec.PrevDate, EndDate);
    end;

    if(CalcDate < EndDate)
      CheckSaleOperations(Oper.rec.Client, CalcDate+1, EndDate);
    end; 
  end;
 
  if(Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY)
    AccTaxQuery = "select t_Chapter, t_Code_Currency, t_Account from daccount_dbt where t_Account = ?";
    AccTaxSelect = DL_RSDCommand(AccTaxQuery);
    AccTaxSelect.AddParam(Oper.rec.Account);
    AccTaxDS = AccTaxSelect.execute();
    if (not AccTaxDS.MoveNext() ) 
      MsgBox("Не удалось найти счет '" + Oper.rec.Account + "'" );
      return 1;
    end;
    MaxTaxe = DL_GetRestAccount(AccTaxDS, Oper.rec.OperDate );

    if(MaxTaxe < 0) 
       MaxTaxe = 0;
    end;

    MaxTaxe = Round(MaxTaxe,0,2);
  
    MaxTaxeNat = min(TO, MaxTaxe);

    TaxHoldArr.size = 0;

    if(ExistSavedVal(ID_Operation, NPTXVAL_KIND_TB_Oper))
      НОБ_опер = STB_GetSavedNptxval(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_TB_Oper);
      SpecialTag = GetSpecialTagByOper(Oper, STB_GetTaxBaseKindByDocKind(Oper.rec.DocKind, IIF(Oper.rec.IIS == SET_CHAR, true, false)));
    else
      CalcNOBoper(Oper, @НОБ_опер, NULL, NULL, @SpecialTag);
    end;

    NewOper.rec.TaxBase = НОБ_опер;

    var AmountSNOB = STB_GetSavedNptxval(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_STB);
        
    CalcHoldTaxByRanges(Oper.rec.Client,
                            YearTax,
                            STB_GetTaxBaseKindByDocKind(Oper.rec.DocKind, IIF(Oper.rec.IIS == SET_CHAR, true, false)),
                            НОБ_опер,
                            AmountSNOB,
                            EndDate,
                            SpecialTag
                           );

    var queryR = " select * from dnptxtaxbaseranges_tmp order by t_range asc ";
    var cmdR = DL_RSDCommand(queryR);
    var DataSetR = cmdR.Execute();
    while(DataSetR.moveNext())
      if(int(DataSetR.TaxRate) == int(100*NPTXGENTAXRATE_RESIDENT_15))
        taxe15 = taxe15 + money(DataSetR.TaxHold);
        НОБ_15 = НОБ_15 + money(DataSetR.BaseSum);

        if((DataSetR.KBK == NPTXKBK_INCR_208) or (DataSetR.KBK == NPTXKBK_INCR_218)) //208 был в 2024-м году, его тут тоже надо учитывать, если операция за 2024
          TaxRateParm15 = STB_TaxRateParm(int(DataSetR.TaxRate),
                                          money(DataSetR.BaseSum), 
                                          money(DataSetR.TaxHold),
                                          DataSetR.KBK, 
                                          DataSetR.TaxBaseType, 
                                          IIF(Oper.rec.IIS == SET_CHAR, true, false), 
                                          NULL, 
                                          0, 
                                          money(DataSetR.TaxCalc),
                                          NULL,
                                          NULL,
                                          DataSetR.SpecialTag
                                          );
        else
          TaxRateParmAddArr[TaxRateParmAddArr.size] =   STB_TaxRateParm(int(DataSetR.TaxRate),
                                                                        money(DataSetR.BaseSum), 
                                                                        money(DataSetR.TaxHold),
                                                                        DataSetR.KBK, 
                                                                        DataSetR.TaxBaseType, 
                                                                        IIF(Oper.rec.IIS == SET_CHAR, true, false), 
                                                                        NULL, 
                                                                        0, 
                                                                        money(DataSetR.TaxCalc),
                                                                        NULL,
                                                                        NULL,
                                                                        DataSetR.SpecialTag
                                                                        );
        end;
      else
        taxe = money(DataSetR.TaxHold);
        if(int(DataSetR.TaxRate) == int(100*NPTXGENTAXRATE_NOTRESIDENT)) 
          НОБ_30 = money(DataSetR.BaseSum);
        else
          НОБ_13 = money(DataSetR.BaseSum);
        end;

        TaxRateParmMain = STB_TaxRateParm(int(DataSetR.TaxRate),
                                          money(DataSetR.BaseSum), 
                                          money(DataSetR.TaxHold),
                                          DataSetR.KBK, 
                                          DataSetR.TaxBaseType, 
                                          IIF(Oper.rec.IIS == SET_CHAR, true, false), 
                                          NULL, 
                                          0, 
                                          money(DataSetR.TaxCalc),
                                          NULL,
                                          NULL,
                                          DataSetR.SpecialTag
                                          );
      end;
    end;

    Dg = taxe;
    Dp = taxe15;
    Ds = $0;
      
    if((НОБ_опер <= 0) )
      taxe = 0;
      taxe15 = 0;

      if((TaxRateParmMain != NULL) and (TaxRateParmMain.Налог != 0))
        TaxRateParmMain.Налог = 0;
        TaxRateParmMain.TaxCalc = 0;
        TaxHoldArr[TaxHoldArr.size] = TaxRateParmMain;
      end;

      if((TaxRateParm15 != NULL) and (TaxRateParm15.Налог != 0))
        TaxRateParm15.Налог = 0;
        TaxRateParm15.TaxCalc = 0;
        TaxHoldArr[TaxHoldArr.size] = TaxRateParm15;
      end;
    else
      if(TaxRateParmMain != NULL)
        TaxHoldArr[TaxHoldArr.size] = TaxRateParmMain;
      end;

      if(TaxRateParm15 != NULL)
        TaxHoldArr[TaxHoldArr.size] = TaxRateParm15;
      end;
    end;

    var i = 0;
    while(i < TaxHoldArr.size)
      if(TaxHoldArr[i].Ставка == int(100*NPTXGENTAXRATE_RESIDENT_15))
        TaxHoldArr[i].Налог = taxe15;
      else
        TaxHoldArr[i].Налог = taxe;
      end;

      i = i + 1;
    end;

    prev_taxe   = taxe; 
    prev_taxe15 = taxe15;

    STB_ExecuteCorrOnStepPRGS(Oper.rec.Client, YearTax, IIF(Oper.rec.IIS == SET_CHAR, true, false), @TaxHoldArr, Oper.rec.DocKind, Oper.rec.ID, EndDate, TO, TO, @CorrTxArr, Oper.rec.CloseContr, false, @TaxToPay );

    taxe = 0;
    taxe15 = 0;

    i = 0;
    while(i < TaxHoldArr.size)
      if(TaxHoldArr[i].Ставка == int(100*NPTXGENTAXRATE_RESIDENT_15))
        taxe15 = TaxHoldArr[i].Налог;
      else
        taxe = TaxHoldArr[i].Налог;
      end;

      i = i + 1;
    end;

    NewOper.rec.TaxToPay = TaxToPay;
    NewOper.rec.TaxSum = taxe15 + taxe; //TaxToPayNow


    if(TO < (taxe + taxe15))
      taxe = round(min(max(taxe, 0), TO*NPTXGENTAXRATE_RESIDENT_15), 0);
      taxe15 = round(min(taxe15, round(TO*NPTXGENTAXRATE_RESIDENT_15, 0) - taxe), 0);
    else
      taxe   = MIN(MAX(taxe, $0), MaxTaxe);
      taxe15 = MIN(MAX(taxe15, $0), MaxTaxe - taxe);
    end;

    NewOper.rec.Tax = taxe15 + taxe; // TaxPayment 
    NewOper.rec.TaxDp = taxe15;

    //Временное решение. Если отсутствуют корректировки, то кладем туда 224 КБК.
    //Т.е. у нас либо 224 КБК, либо корректировки
    if((Dg == taxe) and (Dp == taxe15) and (CorrTxArr.size == 0) and (TaxRateParmAddArr.size > 0))//DEF-108625
      i = 0;
      UseCorrForAddKBK();//Признак дополнительных КБК в корректировках
      while(i < TaxRateParmAddArr.size)
        taxe15 = taxe15 - TaxRateParmAddArr[i].Налог;
        НОБ_15 = НОБ_15 - TaxRateParmAddArr[i].НОБ;
        CorrTxArr[CorrTxArr.size] = TaxRateParmAddArr[i];
        i = i + 1;
      end;
    end;

    if(CorrTxArr.size > 0)
      STB_SaveTxArrInMsg(CorrTxArr);
    end;

    taxe = IIF(taxe < prev_taxe, taxe, prev_taxe); 
    taxe15 = IIF(taxe15 < prev_taxe15, taxe15, prev_taxe15);
    
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_TB_30, date(0,0,0), time(0), НОБ_30, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_TB_13, date(0,0,0), time(0), НОБ_13, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_TB_15, date(0,0,0), time(0), НОБ_15, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  elif((Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR) and (YearTax >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981()))
    TaxeCalcFunction(Oper.rec.Client, YearTax, NULL, ID_Step, ID_Operation, Oper, @ArrHoldPrm);

    var step =  ПроверитьНеобходимостьЗачетаПереплаты(ArrHoldPrm);

    if(Oper.rec.IIS == UNSET_CHAR) // Для ИИС не рассчитываем
      if(step == 3)//Определяем сумму НДФЛ к удержанию
        ОпределитьСуммуУдерж(Oper, ArrHoldPrm, @TaxePayment, @taxe, @taxe15, @ArrHoldSTB);
      elif(step == 2)//Определяем сумму НДФЛ к возврату
        ОпределитьСуммуВозврат(ArrHoldPrm, Oper.rec.IIS, @TaxePayment, @taxe, @taxe15, @ArrHoldSTB)
      else
        return Error("Не удалось выполнить зачет");
      end;
    end;

    NewOper.rec.Tax   = TaxePayment;
    NewOper.rec.TaxDp = taxe15;

    if(ArrHoldSTB.size > 0)
      STB_SaveHoldArrInMsg(ArrHoldSTB);
    end;

  elif((Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_LUCRE) and (TaxTeriodToLucre == true))
    DateSplit(EndDate, NULL, NULL, YearTax);

    TaxHoldArr.size = 0;

    TaxeCalcFunction(Oper.rec.Client, YearTax, NULL, ID_Step, ID_Operation, Oper, @ArrHoldPrm);

    ОпределитьСуммуУдерж(Oper, ArrHoldPrm, @TaxePayment, @taxe, @taxe15, @ArrHoldSTB);

    i = 0;
    NewOper.rec.TaxToPay = $0;
    NewOper.rec.TaxBase  = $0;
    while(i < ArrHoldSTB.size)
      NewOper.rec.TaxToPay = NewOper.rec.TaxToPay + ArrHoldSTB[i].Налог;

      ArrHoldSTB[i].Symbol = "";

      if(ArrHoldSTB[i].Ставка == int(NPTXGENTAXRATE_RESIDENT_15*100)) 
        //Здесь сохраним только по 15% в разрезе КБК. Общая 15% и основна сохранятся ниже в коде
        if(DL_InsertNPTXVAL(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_TAXE_15, date(0,0,0), time(0), ArrHoldSTB[i].Налог, 0, NPTXGENTAXRATE_RESIDENT_15*100, ArrHoldSTB[i].КБК) != 0)
          return Error( "Ошибка при сохранении значения СНОБ" );
        end;
      end;

      i = i + 1;
    end;

    NewOper.rec.TaxSum  = NewOper.rec.TaxToPay; //TaxToPayNow

    NewOper.rec.TaxBase = GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEMATERIAL), Oper.rec.PrevDate, EndDate, null, Oper.rec.IIS, null, " obj.t_FromOutSyst <> 'X'");

    NewOper.rec.Tax = taxe15 + taxe; // TaxPayment 
    NewOper.rec.TaxDp = taxe15;

    if(ArrHoldSTB.size > 0)
      STB_SaveHoldArrInMsg(ArrHoldSTB);
    end;

  else
    CalcPaidSum(Oper.rec.Client, Oper.rec.Contract, Oper.rec.DocKind, Oper.rec.Subkind_Operation, Oper.rec.PrevDate, EndDate, SO, SZ, TO, @Bg, @Bm, @Bs, @Dm, @Ds, @Dg, Oper.rec.IIS, @Po, @Bd, @Bp, @Dp,  null, null, null, null, null, @Rg, @Rs, @Rp, @ByKBK, @DgKBK1, @DgKBK2, @CalcParams);
  end;
  
  //Сохраним значения Ds, Dg, Dp, т.к. они могут понадобиться при обработке заявления на возврат
  if(Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_TAXREF) //НЕ возврат налога
    if(DL_InsertDL_VALUE(Oper.rec.DocKind, Oper.rec.ID, DL_VALUE_KIND_NPTXHOLD_PREV_DS, Oper.rec.OperDate, Ds, NATCUR, 0) != 0)
      return Error( "Ошибка при сохранении значения Ds" );
    end;
    if(DL_InsertDL_VALUE(Oper.rec.DocKind, Oper.rec.ID, DL_VALUE_KIND_NPTXHOLD_PREV_DG, Oper.rec.OperDate, Dg, NATCUR, 0) != 0)
      return Error( "Ошибка при сохранении значения Dg" );
    end;
    if(DL_InsertDL_VALUE(Oper.rec.DocKind, Oper.rec.ID, DL_VALUE_KIND_NPTXHOLD_PREV_DP, Oper.rec.OperDate, Dp, NATCUR, 0) != 0)
      return Error( "Ошибка при сохранении значения Dp" );
    end;
  end;
  
  if(Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_OUTAVOIR)
     NewOper.rec.TaxToPay = Po;
  elif(Oper.rec.SubKind_Operation == DL_TXHOLD_OPTYPE_PREHOLD)

     var Count;
     if(Oper.rec.IIS != SET_CHAR)
        DL_GetNPTXOBJSum(NULL, NULL, NULL, string(TXOBJ_DUETAX), oper.rec.PrevDate, EndDate, NULL, NULL, @NewOper.rec.TaxToPay, @Count, Oper.rec.Client, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, NULL);
     else
        var NPTXWRTQuery = "select nptxwrt.* " +
                           "from dnptxop_dbt nptxwrt " +
                           "where nptxwrt.t_DocKind = " + DL_WRTMONEY +
                           "   and nptxwrt.t_Status = " + DL_TXOP_Close +
                           "   and nptxwrt.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_OUTMONEY +
                           "   and nptxwrt.t_Client = ?" +
                           "   and npto.CheckContrIIS(nptxwrt.t_Contract) = 1" +
                           "   and nptxwrt.t_OperDate <= ? " +
                           "order by nptxwrt.t_OperDate desc";

        var NPTXWRTSelect = DL_RSDCommand(NPTXWRTQuery);
        NPTXWRTSelect.AddParam(Oper.rec.Client);
        NPTXWRTSelect.AddParam(EndDate);
        var NPTXWRTDS = NPTXWRTSelect.Execute();

        if(not NPTXWRTDS.MoveNext() or ((NPTXWRTDS.CloseContr == SET_CHAR) and (NPTXWRTDS.IIS == SET_CHAR)))
           NewOper.rec.TaxToPay = GetRubSumByClientFromDepo(Oper.rec.Client, string(TXOBJ_DUETAX), date(1, 1, Year), EndDate);
        elif((NPTXWRTDS.CloseContr == SET_CHAR) and (NPTXWRTDS.IIS != SET_CHAR))
           var DueTaxStartDate = GetFirstDateIIS(Oper.rec.Client);
           DL_GetNPTXOBJSum(NULL, NULL, NULL, string(TXOBJ_DUETAX), DATE(DueTaxStartDate), EndDate, NULL, NULL, @NewOper.rec.TaxToPay, @Count, Oper.rec.Client, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, NULL);
        end;
     end;
  elif((Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_OUTMONEY) and ((Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_LUCRE) or (TaxTeriodToLucre == false)))
     NewOper.rec.TaxToPay = max(Ds + Dg, 0) + max(Dp, 0);
  end;

  if(NewOper.rec.SubKind_Operation == DL_TXHOLD_OPTYPE_PREHOLD)
    NewOper.rec.TaxBase = $0;
  elif(((Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_LUCRE) or (TaxTeriodToLucre == false)) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_OUTMONEY) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_ENDYEAR))
    NewOper.rec.TaxBase = Bg + Bm + Bs + Bd + Bp;
    NewOper.rec.TaxDp = Dp;
  end;

  if((Oper.rec.Subkind_Operation  == DL_TXHOLD_OPTYPE_OUTAVOIR) and (TO < NewOper.rec.TaxToPay))
    NewOper.rec.TaxSum = round(TO * Rg, 0);
  elif((Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_OUTMONEY) and ((Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_LUCRE) or (TaxTeriodToLucre == false)))
    NewOper.rec.TaxSum = NewOper.rec.TaxToPay;
    if(Oper.rec.SubKind_Operation == DL_TXHOLD_OPTYPE_TAXREF)
      if(NewOper.rec.TaxSum < 0)
         NewOper.rec.TaxSum = -NewOper.rec.TaxSum;
      end;
    end;
  end;

  /*Если настройка ВОЗВРАТ ПЕРЕПЛАТЫ В ТЕЧЕНИЕ ГОДА = нет  И   <TypeOper>= "вывод ц/б" или <вывод д/с> И <TaxToPayNow> < 0, то <TaxPayment> = 0.*/
  if (   (    (not ВозвратПереплатыВТечениеГода())
          and (   (Oper.rec.Subkind_Operation  == DL_TXHOLD_OPTYPE_OUTAVOIR)
               or ((Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_PREHOLD) and (EndDate != date(31, 12, Year))))
          and (NewOper.rec.TaxSum < $0))
  )
     NewOper.rec.Tax = $0;
  elif(((Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_LUCRE) or (TaxTeriodToLucre == false)) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_TAXREF) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_ENDYEAR) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_OUTMONEY) and (Oper.rec.Method == DL_TYPEGETNALOG_BROKER_ACC)) //Если <TypeOper> != "возврат налога" или "окончание года" И <Way> = "брокерский счет"
     AccTaxQuery = "select t_Chapter, t_Code_Currency, t_Account from daccount_dbt where t_Account = ?";
     AccTaxSelect = DL_RSDCommand(AccTaxQuery);
     AccTaxSelect.AddParam(Oper.rec.Account);
     AccTaxDS = AccTaxSelect.execute();
     if (not AccTaxDS.MoveNext() ) 
       MsgBox("Не удалось найти счет '" + Oper.rec.Account + "'" );
       return 1;
     end;
     MaxTaxe = DL_GetRestAccount(AccTaxDS, Oper.rec.OperDate );

     if(MaxTaxe < 0)  //красное сальдо
        MaxTaxe = 0;
     end;

     MaxTaxe = Round(MaxTaxe,0,2);

     var TaxToPayNow = NewOper.rec.TaxSum;
     
     if((ByKBK == true) and (TaxToPayNow > 0) and (Dg > 0))
       taxeKBK1 = min(min(max(Ds+DgKBK1, 0), MaxTaxe), TaxToPayNow);
       taxeKBK2 = min(min(max(Ds+DgKBK2, 0), MaxTaxe), TaxToPayNow);

       var s_taxe = min(min(max(Ds+Dg, 0), MaxTaxe), TaxToPayNow);

       taxeKBK1 = min(taxeKBK1, s_taxe);
       taxeKBK2 = s_taxe - taxeKBK1;

       taxe     = taxeKBK1 + taxeKBK2;
     else 
       taxe   = min(min(max(Ds+Dg, 0), MaxTaxe), TaxToPayNow);
     end;

     taxe15 = min(min(max(Dp, 0), MaxTaxe-taxe), TaxToPayNow-taxe);

     NewOper.rec.Tax = taxe + taxe15;
     NewOper.rec.TaxDp = taxe15;

  elif((Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR) and (YearTax < НП_ВВОДА_ДОРАБОТОК_BOSS_2981())) //Окончание года
     var isPlus = false, isMinus = false;
     var needSendToStor = false;
     
     if(ВыполнитьЗачетНалогов(CalcParams, @needSendToStor, ID_Operation, ID_Step) != 0)
       return Error("Ошибка при выполнении зачета ДЕПО");
     end;

     //Проверим, что не осталось разнонаправленных значений после зачета
     isPlus  = IIF(CalcParams.SOFR_Dg_0201_IIS > 0, true, isPlus);
     isMinus = IIF(CalcParams.SOFR_Dg_0201_IIS < 0, true, isMinus);
     isPlus  = IIF(CalcParams.SOFR_Dg_0201     > 0, true, isPlus);   
     isMinus = IIF(CalcParams.SOFR_Dg_0201     < 0, true, isMinus);
     isPlus  = IIF(CalcParams.DEPO_Dg_0207_IIS > 0, true, isPlus);   
     isMinus = IIF(CalcParams.DEPO_Dg_0207_IIS < 0, true, isMinus);
     isPlus  = IIF(CalcParams.DEPO_Dg_0201_IIS > 0, true, isPlus);   
     isMinus = IIF(CalcParams.DEPO_Dg_0201_IIS < 0, true, isMinus);
     isPlus  = IIF(CalcParams.DEPO_Dg_0207     > 0, true, isPlus);   
     isMinus = IIF(CalcParams.DEPO_Dg_0207     < 0, true, isMinus);
     isPlus  = IIF(CalcParams.DEPO_Dg_0201     > 0, true, isPlus);   
     isMinus = IIF(CalcParams.DEPO_Dg_0201     < 0, true, isMinus);
     isPlus  = IIF(CalcParams.SOFR_Dp_0208_IIS > 0, true, isPlus);   
     isMinus = IIF(CalcParams.SOFR_Dp_0208_IIS < 0, true, isMinus);
     isPlus  = IIF(CalcParams.SOFR_Dp_0208     > 0, true, isPlus);   
     isMinus = IIF(CalcParams.SOFR_Dp_0208     < 0, true, isMinus);
     isPlus  = IIF(CalcParams.DEPO_Dp_0208_IIS > 0, true, isPlus);   
     isMinus = IIF(CalcParams.DEPO_Dp_0208_IIS < 0, true, isMinus);
     isPlus  = IIF(CalcParams.DEPO_Dp_0208     > 0, true, isPlus);   
     isMinus = IIF(CalcParams.DEPO_Dp_0208     < 0, true, isMinus);

     TaxToPay = CalcParams.DEPO_Dg_0201 + CalcParams.DEPO_Dg_0207 + CalcParams.DEPO_Dp_0208 + CalcParams.SOFR_Dg_0201 + 
                CalcParams.SOFR_Dp_0208 + CalcParams.DEPO_Dg_0201_IIS + CalcParams.DEPO_Dg_0207_IIS + 
                CalcParams.DEPO_Dp_0208_IIS + CalcParams.SOFR_Dg_0201_IIS + CalcParams.SOFR_Dp_0208_IIS;
     NewOper.rec.TaxToPay = TaxToPay;
     NewOper.rec.TaxSum = NewOper.rec.TaxToPay;

     if((isPlus == true) and (isMinus == true))
       return Error("Некорректно выполнен зачет");
     elif(isPlus == true)
       var query, cmd, DataSet;
       //Определяем сумму НДФЛ к удержанию

       //2.1.   Определяем сумму доступного остатка на счетах клиента
       query =   " with acc as (select DISTINCT sa.t_Account, sa.t_Chapter, sa.t_FIID as t_Currency, (CASE WHEN mp.t_MarketID > 0 THEN 0 ELSE 1 END) as IsOutMarket, dlc.t_DlContrID"
               + "                from dsettacc_dbt sa, dmcaccdoc_dbt accdoc, dsfcontr_dbt sf, ddlcontrmp_dbt mp, ddlcontr_dbt dlc "
               + "               where sa.t_PartyID = ? "
               + "                 and sa.t_FIKind = " + FIKIND_CURRENCY
               + "                 and sa.t_FIID = " + NATCUR
               + "                 and sa.t_Account LIKE '306%' "
               + "                 and accdoc.t_Account = sa.t_Account "
               + "                 and accdoc.t_Chapter = sa.t_Chapter "
               + "                 and accdoc.t_Currency = sa.t_FIID "
               + "                 and accdoc.t_Owner = sa.t_PartyID "
               + "                 and sf.t_ID = accdoc.t_ClientContrID "
               + "                 and mp.t_SfContrID = sf.t_ID "
               + "                 and dlc.t_DlContrID = mp.t_DlContrID "
               + "                 and dlc.t_IIS = CHR(0) "
               + "             ) "
               + " select q.* "
               + "   from (select q1.*, GREATEST(LEAST(q1.AccRest, q1.PlanAccRest), 0) as CalcAccRest "
               + "           from (select acc.*, rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null) as AccRest, "
               + "                        rsb_brkrep_rshb.GetPlanRestAcc(acc.t_DlContrID, acc.t_Account, acc.t_Chapter, acc.t_Currency, ?) as PlanAccRest "
               + "                 from acc "
               + "                ) q1 "
               + "        ) q "
               + "  where q.CalcAccRest <> 0 ";

       cmd = DL_RSDCommand(query);

       cmd.AddParam(Oper.rec.Client);
       cmd.AddParam(Oper.rec.OperDate);
       cmd.AddParam(Oper.rec.OperDate);

       DataSet = cmd.Execute();
       while(DataSet.moveNext())
         MaxTaxe = MaxTaxe + Round(money(DataSet.CalcAccRest),0,2);
       end;

       if(MaxTaxe == 0)
         Msg("На счетах клиента нулевые остатки");
       end;

       SOFR_taxe0201_IIS = min(CalcParams.SOFR_Dg_0201_IIS, MaxTaxe); MaxTaxe = MaxTaxe - SOFR_taxe0201_IIS;
       DEPO_taxe0201_IIS = min(CalcParams.DEPO_Dg_0201_IIS, MaxTaxe); MaxTaxe = MaxTaxe - DEPO_taxe0201_IIS;
       DEPO_taxe0207_IIS = min(CalcParams.DEPO_Dg_0207_IIS, MaxTaxe); MaxTaxe = MaxTaxe - DEPO_taxe0207_IIS;
       SOFR_taxe0201     = min(CalcParams.SOFR_Dg_0201,     MaxTaxe); MaxTaxe = MaxTaxe - SOFR_taxe0201;    
       DEPO_taxe0201     = min(CalcParams.DEPO_Dg_0201,     MaxTaxe); MaxTaxe = MaxTaxe - DEPO_taxe0201;    
       DEPO_taxe0207     = min(CalcParams.DEPO_Dg_0207,     MaxTaxe); MaxTaxe = MaxTaxe - DEPO_taxe0207;    
       SOFR_taxe0208_IIS = min(CalcParams.SOFR_Dp_0208_IIS, MaxTaxe); MaxTaxe = MaxTaxe - SOFR_taxe0208_IIS;
       DEPO_taxe0208_IIS = min(CalcParams.DEPO_Dp_0208_IIS, MaxTaxe); MaxTaxe = MaxTaxe - DEPO_taxe0208_IIS;
       SOFR_taxe0208     = min(CalcParams.SOFR_Dp_0208,     MaxTaxe); MaxTaxe = MaxTaxe - SOFR_taxe0208;    
       DEPO_taxe0208     = min(CalcParams.DEPO_Dp_0208,     MaxTaxe); MaxTaxe = MaxTaxe - DEPO_taxe0208;    

       taxe   = SOFR_taxe0201 + DEPO_taxe0201 + DEPO_taxe0207 + SOFR_taxe0201_IIS + DEPO_taxe0201_IIS + DEPO_taxe0207_IIS;
       taxe15 = SOFR_taxe0208 + DEPO_taxe0208 + SOFR_taxe0208_IIS + DEPO_taxe0208_IIS;

       NewOper.rec.Tax   = taxe + taxe15;
       NewOper.rec.TaxDp = taxe15;

       if(needSendToStor)
         if( not InsertOprStatus(46081, 15)) //Передача в Хранилище событий зачета ДЕПО
           return Error( "Ошибка при установке статуса вида \"Передача в Хранилище событий зачета ДЕПО\" операции" );        
         end;
       end;

     elif(isMinus == true)
       SOFR_taxe0201     = CalcParams.SOFR_Dg_0201;
       SOFR_taxe0208     = CalcParams.SOFR_Dp_0208;
       DEPO_taxe0201     = CalcParams.DEPO_Dg_0201;
       DEPO_taxe0207     = CalcParams.DEPO_Dg_0207;
       DEPO_taxe0208     = CalcParams.DEPO_Dp_0208;
       SOFR_taxe0201_IIS = CalcParams.SOFR_Dg_0201_IIS;
       SOFR_taxe0208_IIS = CalcParams.SOFR_Dp_0208_IIS; 
       DEPO_taxe0201_IIS = CalcParams.DEPO_Dg_0201_IIS;
       DEPO_taxe0207_IIS = CalcParams.DEPO_Dg_0207_IIS;
       DEPO_taxe0208_IIS = CalcParams.DEPO_Dp_0208_IIS;

       taxe   = abs(SOFR_taxe0201 + DEPO_taxe0201 + DEPO_taxe0207 + SOFR_taxe0201_IIS + DEPO_taxe0201_IIS + DEPO_taxe0207_IIS);
       taxe15 = abs(SOFR_taxe0208 + DEPO_taxe0208 + SOFR_taxe0208_IIS + DEPO_taxe0208_IIS);

       NewOper.rec.Tax   = taxe + taxe15;
       NewOper.rec.TaxDp = taxe15;

       if(needSendToStor)
         if( not InsertOprStatus(46081, 16)) //Передача в Хранилище и форм. завления
           return Error( "Ошибка при установке статуса вида \"Передача в Хранилище и форм. завления\" операции" );        
         end;
       else
         if( not InsertOprStatus(46081, 14)) //Создание заявления на возврат
           return Error( "Ошибка при установке статуса вида \"Создание заявления на возврат\" операции" );        
         end;
       end;
     end;

  elif(Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF) //возврат налога
     
     CalcTaxPaymentToRefund(NewOper, @taxe, @taxe15, @TaxToPay, @BreakFlag);
     
     if(BreakFlag == true)
       if( not InsertOprStatus(46081, 5)) //Закрытие
         return Error( "Ошибка при установке статуса вида \"Закрытие\" операции" );        
       end;
     end;

     NewOper.rec.TaxToPay = TaxToPay;
     NewOper.rec.TaxSum = NewOper.rec.TaxToPay;

     NewOper.rec.Tax   = taxe + taxe15;
     NewOper.rec.TaxDp = taxe15;
  elif(((Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_LUCRE) or (TaxTeriodToLucre == false)) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_OUTMONEY) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_ENDYEAR)) // DL_TYPEGETNALOG_OTHER_ACC  /* "Со стороннего счета"*/
     NewOper.rec.Tax = NewOper.rec.TaxSum;
  end;

  if(taxe != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_TAXE, date(0,0,0), time(0), taxe, 0, Rg*100) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;

  if(taxe15 != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_TAXE_15, date(0,0,0), time(0), taxe15, 0, NPTXGENTAXRATE_RESIDENT_15*100) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;

  if(taxeKBK1 != 0)
    if(DL_InsertDL_VALUE(Oper.rec.DocKind, Oper.rec.ID, 1001, Oper.rec.OperDate, taxeKBK1, NATCUR, 0) != 0)
      return Error( "Ошибка при сохранении значения taxeKBK1" );
    end;
  end;

  if(taxeKBK2 != 0)
    if(DL_InsertDL_VALUE(Oper.rec.DocKind, Oper.rec.ID, 1002, Oper.rec.OperDate, taxeKBK2, NATCUR, 0) != 0)
      return Error( "Ошибка при сохранении значения taxeKBK2" );
    end;
  end;

  if(SOFR_taxe0201 != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_SOFR_TAXE0201, date(0,0,0), time(0), SOFR_taxe0201, 0, Rg*100, NPTXKBK_MAIN) != 0)    
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(SOFR_taxe0208 != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_SOFR_TAXE0208, date(0,0,0), time(0), SOFR_taxe0208, 0, NPTXGENTAXRATE_RESIDENT_15*100, NPTXKBK_INCR_208) != 0)    
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(DEPO_taxe0201 != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_DEPO_TAXE0201, date(0,0,0), time(0), DEPO_taxe0201, 0, Rg*100, NPTXKBK_MAIN) != 0)    
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(DEPO_taxe0207 != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_DEPO_TAXE0207, date(0,0,0), time(0), DEPO_taxe0207, 0, Rg*100, NPTXKBK_PROC) != 0)    
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(DEPO_taxe0208 != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_DEPO_TAXE0208, date(0,0,0), time(0), DEPO_taxe0208, 0, NPTXGENTAXRATE_RESIDENT_15*100, NPTXKBK_INCR_208) != 0)    
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(SOFR_taxe0201_IIS != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_SOFR_TAXE0201_IIS, date(0,0,0), time(0), SOFR_taxe0201_IIS, 0, Rg*100, NPTXKBK_MAIN) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(SOFR_taxe0208_IIS != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_SOFR_TAXE0208_IIS, date(0,0,0), time(0), SOFR_taxe0208_IIS, 0, NPTXGENTAXRATE_RESIDENT_15*100, NPTXKBK_INCR_208) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(DEPO_taxe0201_IIS != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_DEPO_TAXE0201_IIS, date(0,0,0), time(0), DEPO_taxe0201_IIS, 0, Rg*100, NPTXKBK_MAIN) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(DEPO_taxe0207_IIS != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_DEPO_TAXE0207_IIS, date(0,0,0), time(0), DEPO_taxe0207_IIS, 0, Rg*100, NPTXKBK_PROC) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;
  if(DEPO_taxe0208_IIS != 0)
    if(DL_InsertNPTXVAL(NewOper.rec.DocKind, NewOper.rec.ID, NPTXVAL_KIND_DEPO_TAXE0208_IIS, date(0,0,0), time(0), DEPO_taxe0208_IIS, 0, NPTXGENTAXRATE_RESIDENT_15*100, NPTXKBK_INCR_208) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;
  end;

  if( DL_NPTX_UpdateSumm( NewOper ) != 0 )
    return Error( "Ошибка при обновлении суммы НОБ в dnptxop_dbt" );
  end;

  return stat;
END;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR Stat = 0;

  Oper.SetRecordAddr( FDoc );

  stat = DL_NPTX_PutMsg( "Расчет сумм" );
        
  if( not stat )
     stat = RunAction(ID_Operation, ID_Step);
     DL_NPTX_SaveOperLog( Oper.rec.ID, 20 );
  end;

  return stat;
END;