/* Операция РЕПО без признания ц/б (не ОРЦБ)
   Формирование поручения по 2 ч     */

import InsCarryDoc, "insdpdr.mac", "sp_car2.mac";

macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);
  var    FD, dat, NeedInsertDepoDraft = false, err = 0;
  var avoir_rq = TRecHandler("dlrq.dbt");

  SetBuff( deal, FDoc ); 

  FD = SPFirstDoc( deal, true );

  if( FD.IsOldDeal() )
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D2, SP_OPERSTATUS_SECURDEALS_D2_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 2 ч> операции" );
        return 1;
     end;

     return 0;
  end;

  if( bAND( FD.dl_leg.rec.BitMask, DL_LEG_ANOTHER_DEPOSITARY ) )
     return 0; /*на лоте признак "учет в другом депозитарии", ничего не делаем*/
  end; 

  avoir_rq = FD.GetRQ(DLRQ_TYPE_DELIVERY);

  if(avoir_rq.rec.Netting != SET_CHAR)
    NeedInsertDepoDraft = НужноПредФормПоручДЕПО(FD, err);
    if (err > 0)
       return 1;
    end;

    if (not NeedInsertDepoDraft)
       MsgBox("Не требуется предварительное формирование поручения");
       return 1;
    end;

    if( FD.БылОтказОтИсполнения() == false ) /*не было отказа от сделки\2ч*/   

       GetOprDate( FD.GetKindDate(DATE_DEALINSDEPODRAFT), dat );  

       if( not ВыполнитьФормированиеПорученийДепо( deal, FD.GetRQ(DLRQ_TYPE_DELIVERY), dat, false, true ) ) /* вставляем отложенное поручение депо */
          return 1;
       end;
    end; 
  end;

  return 0;
end;
