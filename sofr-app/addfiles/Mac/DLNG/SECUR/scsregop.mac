/*
$Name:             scsregop.mac
$Module:           АРНУ 
$Description:      Отчет "Субрегистр иных операций" (ФКЦБ)
*/


/*******************************************************************************
 FILE         :   scsregop.mac

 DESCRIPTION  :   Отчет "Субрегистр иных операций" (ФКЦБ)

 PROGRAMMED BY:   Азарцов В.В.

 CREATION DATE:   //AV 25.06.04
*******************************************************************************/
import SecInter, DealsInter, "spserv.mac", "sp_class.mac", "SpRepFun.mac", "DLReport_h.mac", "dlquery.mac";

private const SUBKIND_DRIVE_CB = 3; /*подвид доверительное управление*/
var ReportRun = false;

private const DEALSTATUS_ALL    = -1, /* Все сделки */
              DEALSTATUS_CLOSED = 20,  /* Закрытые */
              DEALSTATUS_OPENED = 10;  /* Открытые */

private const DOCKIND_CONTR_FIRST  = 22,  /* договор по первой части*/
              DOCKIND_CONTR_SECOND = 23,  /* договор по второй части*/
              DOCKIND_MARKETREP    = 25,  /* отчет проф. участнику */
              DOCKIND_BUYSALEREP   = 26,  /* договор купли продажи */
              DOCKIND_COMMANDREP   = 27;  /* распорядительная записка */

private const DEALTYPE_OWN    = 0,  /* собственные сделки */
              DEALTYPE_BROKER = 1,  /* брокерские сделки */
              DEALTYPE_DU     = 2;  /* доверительное управление*/

private const STR_BOND_ALL        = -1, /* погашение и конвертация */ 
              SC_OPER_RETIRE      = 0, /* погашение */
              SC_OPER_CONVERT     = 1, /* конвертация */
              SC_OPER_INVESTSHARE = 2, /* получение паев*/
              SC_OPER_GLOBAL      = 5, /* глобальная операция*/
              SC_OPER_NOMCHANG    = 6; /* изменение номинала*/

private const OPKIND_KDRAIN    = "KDRA1", 
              OPKIND_KDRAOUT   = "KDRA0", 
              OPKIND_KADRIN    = "KADR1", 
              OPKIND_KADROUT   = "KADR0", 
              OPKIND_GOKIN     = "GOK1", 
              OPKIND_GOKOUT    = "GOK0", 
              OPKIND_GOUIN     = "GOU1", 
              OPKIND_GOUOUT    = "GOU0",
              OPKIND_IN        = "IN"; 

private var ReportTMP = TBFile("scdljr.tmp", "W", 0);

private record r_sfcontr(sfcontr);
private record rParty(party);
private record rCurPaymFI(fininstr);
private record NominalFI(fininstr);
private file   sfcontr(sfcontr) ;
private record rFininstr("fininstr");
private record rdl_leg("dl_leg");
private record ravoiriss("avoiriss");

/* Структура с исходными данными */
class SourceData(
      _DprtID:integer, 
      _AvrTypeID: integer, 
      _EmiID: integer,
      _AvrID: integer, 
      _DealType: integer,  
      _ClientID: integer, 

      _IsFormID:integer,
      _FormSubID:integer,
      _IsVidID:integer,
      _VidSubID:integer,
      _NoResident:bool, 

      _DepositaryID:integer,
      _OperType,
      _DealMarket:bool,
      _MarketID:integer, 
      _DealNotMarket:bool, 
      _DealBroker:bool,
      _BrokerID:integer, 
      _dateMin: date,  
      _dateMax: date,
      _SplitByDates,
      _OperStatus:integer, 
      _apostrSum: bool, 
      _toExcel
   )

   var 
      PrintHead,
      IsFirstHead    =  true,
      PrintTableHead =  false,
      DprtID         =  _DprtID,
      AvrTypeID      =  _AvrTypeID,
      EmiID          =  _EmiID,
      AvrID          =  _AvrID,
      DealType       =  _DealType,
      ClientID       =  _ClientID,
 
      IsForm         =  _IsFormID,
      FormSub        =  _FormSubID,
      IsVid          =  _IsVidID,
      VidSub         =  _VidSubID,
      NoResident       =  _NoResident,

      DepositaryID   =  _DepositaryID,
      OperType       =  _OperType,
      DealMarket     =  _DealMarket,
      MarketID       =  _MarketID,
      DealNotMarket  =  _DealNotMarket,
      DealBroker     =  _DealBroker,
      BrokerID       =  _BrokerID,
      dateMin        =  _dateMin,
      dateMax        =  _dateMax,
      SplitByDates   =  _SplitByDates,
      OperStatus     =  _OperStatus,
      apostrSum      =  _apostrSum,
      toExcel        =  _toExcel;
end;

var reportCaption = 
                "                           СУБРЕГИСТР внутреннего учета\n"  +
                "                          иных операций с эмиссионными ценными бумагами\n" +
                "                          #";

var TableHead = "┌──────────┬──────────┬────────────────┬─────────────┬─────────────┬──────────────┬─────────┬─────────┬────────────────────────────────┬────────────┬───────────────────┬─────────┬─────────┬─────────┬────────────────────────────────────────────────────────────────────┐\n"+
                "│          │          │                │             │             │              │    №    │    №    │           Подтверждающий       │            │                   │         │ Дата    │         │                    Ценные бумаги                                   │\n"+
                "│№ операции│  Дата    │Краткое описание│  Посредник  │ Депозитарий │ Наименование │ договора│поручения│              документ          │   Кол-во   │   Сумма операции  │  Валюта │перехода/│  Дата   │                                                                    │\n"+
                "│          │ операции │    операции    │             │             │    клиента   │         │         ├───────────┬─────────┬──────────┤            │                   │ операции│ограниче-│ платежа ├────────────┬───────┬────────────┬────────┬──────────┬──────────────┤\n"+
                "│          │          │                │             │             │              │         │         │   Вид,    │    №    │   Дата   │    ц/б     │                   │         │ния прав │         │  Эмитент   │Вид ц/б│   Код ц/б  │ Выпуск │ Серия, № │   Цена ц/б   │\n"+
                "│          │          │                │             │             │              │         │         │    №      │         │          │            │                   │         │на ц/б   │         │            │       │            │        │ Транш    │              │\n"+
                "├──────────┼──────────┼────────────────┼─────────────┼─────────────┼──────────────┼─────────┼─────────┼───────────┼─────────┼──────────┼────────────┼───────────────────┼─────────┼─────────┼─────────┼────────────┼───────┼────────────┼────────┼──────────┼──────────┬───┤";

private class (DL_CReportTemplate) ScsRegop (_Data)
   var Data = _Data;

   private macro PrintMode():INTEGER
      if(Data.toExcel)
         return DL_OUTREPORT_EXCEL;
      else
         return DL_OUTREPORT_STD;
      end;
   end;

   private macro Register_Table()
      RegisterTable(
         "N1_TableLine", TableHead,
         "N1_A1",    "N1_A2",    "N1_A3",    "N1_A4",    "N1_A5",
         "N1_A6",    "N1_A7",    "N1_A8",    "N1_A9",    "N1_A10",
         "N1_A11",   "N1_A12",   "N1_A13",   "N1_A14",   "N1_A15",
         "N1_A16",   "N1_A17",   "N1_A18",   "N1_A19",   "N1_A20",
         "N1_A21",   "N1_A22",   "N1_A23"
      );
   end;

   private macro BeginReport()
      CreateTotalBook();
      SetActiveSheet("Субрегистр иных операций");
   end;

   private macro EndCopyTable()
      EndTable();
      CopyAllSheetInTotalBook(NULL, false, GetTableRange(), 0);
   end;

   private macro EndReport()
      SaveTotalBook();
   end;

   macro DigitIsApp(digit)
      if( not Data.toExcel )
         if(Data.apostrSum == true)
            return string(digit:a);
         else
            return string(digit);
         end;
      else
         return digit;
      end;
   end;

   macro PrintLine (
            DealCode:String,
            DealDate:variant,
            DealKindName:string,
            PartyShortName1:string,
            ContrShortName:string,
            ClientShortName:string,
            DocNumber:string,
            SfContrNumber:string,
            IssShortName:string,
            AvrKind:string, 
            AvrCode:string,
            Issue:string,
            AvrSeries:string,
            Amount:double,
            AmountPrecision:integer,
            SumInNom:money,
            SumCCY:variant,
            ReportKind:string,
            ReportNum:string,
            ReportDate:variant,
            OwnDate:variant,
            PayDate:variant,
            Nom:money,
            NomCur:string
         )
      var MyNom         = "";   //Временная переменная для Nom      / по запросу
      var MySumInNom    = "";   //Временная переменная для SumInNom / #173383    
      var MyOwnDate = SQL_ConvTypeDate(OwnDate), MyPayDate = SQL_ConvTypeDate(PayDate); 
        
      if(money(Nom) == money(0))       
        NomCur = "";
      else
        MyNom = DigitIsApp(Nom);
      end;

      if(money(SumInNom) == money(0))
        MySumInNom = "";
      else
        MySumInNom = DigitIsApp(SumInNom);
      end;                                          
                      
      if( MyOwnDate == ZeroDate )
         MyOwnDate = "";
      end;

      if( MyPayDate == ZeroDate )
         MyPayDate = "";
      end;

      if(NOT IsHaveFractPart(Amount) )
         AmountPrecision = 0;
      end;

      PrintTableLine(
         "N1_A1",    DealCode,                     null,
         "N1_A2",    DealDate,                     null,
         "N1_A3",    DealKindName,                 null,
         "N1_A4",    PartyShortName1,              null,
         "N1_A5",    ContrShortName,               null,
         "N1_A6",    ClientShortName,              null,
         "N1_A7",    SfContrNumber,                null,
         "N1_A8",    DocNumber,                    null,
         "N1_A9",    ReportKind,                   null,
         "N1_A10",   ReportNum,                    null,
         "N1_A11",   ReportDate,                   null,
         "N1_A12",   Amount,                       AmountPrecision,
         "N1_A13",   MySumInNom,                   null,
         "N1_A14",   SumCCY,                       null,
         "N1_A15",   MyOwnDate,                    null,
         "N1_A16",   MyPayDate,                    null,
         "N1_A17",   IssShortName,                 null,
         "N1_A18",   AvrKind,                      null,
         "N1_A19",   AvrCode,                      null,
         "N1_A20",   Issue,                        null,
         "N1_A21",   AvrSeries,                    null,
         "N1_A22",   MyNom,                        null,
         "N1_A23",   NomCur,                       null
      );                                      
   end;

   macro PrintHead(Data)
      file Dprt(dp_dep);
      var  DprtName = ""; 

      /*Название филиала*/
      if(Data.DprtID != 0)
         Dprt.Code = Data.DprtID;
         if(GetEQ(Dprt))  DprtName = Dprt.name;
         else
            msgBox ("Не найдено имя филиала с кодом ", Data.DprtID);
         end;

         PrintFormatString(
            "",
            "N1_Dep", "Филиал: "+Dprt.name
         );

      end;

      ReportRun = true;
      Data.PrintHead = true;
   end;
   
   macro PrintTitle (Title)
      if(Data.toExcel)
         Merge("N1_A1", "N1_A23");
      end;
      PrintTableLine("N1_A1", Title, null);
   end;
   
   macro PrintTableHead(Data, repDate)
      var H = TArray; /*Подкачиваемые поля (имена и названия), одинаковые для всех
                       сделок. Определяются при печати шапки отчета. */

      /*Вид ЦБ*/
      if(Data.AvrTypeID != -1)
         H[0] = AvoirKindName(Data.AvrTypeID);
      else 
         H[0] = "";
      end;

      /*эмитент*/
      if((Data.EmiID != -1) AND (not ПолучитьСубъекта(Data.EmiID, rParty)))
         H[1] = rParty.ShortName;
      else
         H[1] = "";
      end;

      /*Код ЦБ*/
      if((Data.AvrID != -1) AND (not ПолучитьФинИн(Data.AvrID, rFininstr)))
         H[2] = rFininstr.FI_Code;
      else
         H[2] = "";
      end;

      /*Клиент*/
      if((Data.ClientID != -1) AND (not ПолучитьСубъекта(Data.ClientID, rParty)))
         H[3] = rParty.ShortName;
      else
         H[3] = "";
      end;

      if( Data.OperStatus != DEALSTATUS_ALL )
         if( Data.OperStatus == DEALSTATUS_OPENED )
            H[4] = "Незавершенные операции";
         else
            H[4] = "Завершенные операции";
         end;
      else
         H[4] = "";
      end;

      var TableCaption =
         "#\n" +
         "#\n" +
         "#\n" +
         "#\n" +
         "#\n";

      var DateShow;
      
      PrintHead(Data);

      if(Data.SplitByDates)
         DateShow = "за период " + DateToStr(repDate);
      else
         DateShow = "за период с " + Data.dateMin + " по " + Data.dateMax;
      end;

      PrintFormatString(
         reportCaption,
         "N1_H_Period", DateShow
      );
      
      var padd;
      if(Data.IsFirstHead)
         padd=0;
         Data.IsFirstHead = false;
      else
         padd=2;
      end;
      
      CopyAllSheetInTotalBook(NULL, false, "N1_Caption", padd);

      PrintFormatString(
         NULL,
         "N1_FI_Kind",  "Вид ц/б:" + H[0],
         "N1_Emitent",  "Эмитент:" + H[1],
         "N1_FI",       "Ценная бумага:" + H[2],
         "N1_Client",   "Клиент:" + H[3],
         "N1_OpKind",   H[4]
     );
     
     CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader", 1 );
     
     Register_Table();
     
     Data.PrintTableHead = true;
     
   end;

   private macro ГО_Списание(Kind)
      return ((Kind==OPKIND_GOKOUT)or(Kind==OPKIND_GOUOUT));
   end;

   private macro ГО_Зачисление(Kind)
      return ((Kind==OPKIND_GOKIN)or(Kind==OPKIND_GOUIN));
   end;

   private macro Конвертация_Списание(Kind)
      return ((Kind==OPKIND_KDRAOUT)or(Kind==OPKIND_KADROUT));
   end;

   private macro Конвертация_Зачисление(Kind)
      return ((Kind==OPKIND_KDRAIN)or(Kind==OPKIND_KADRIN));
   end;

   private macro ИзменениеНомин(Kind)
      return (Kind==OPKIND_IN);
   end;

   private macro GetNameMainStr(Kind)

      if( (Kind == OPKIND_KDRAIN) or (Kind == OPKIND_KDRAOUT) )
         return "Конверт. деп. расписок в акции";
      elif( (Kind == OPKIND_KADROUT) or (Kind == OPKIND_KADRIN) )
         return "Конверт. акций в деп. расписки";
      elif( (Kind == OPKIND_GOKIN) or (Kind == OPKIND_GOKOUT) )
         return "\"Конвертация\" (глобальная операция)";
      elif( (Kind == OPKIND_GOUIN) or (Kind == OPKIND_GOUOUT) )
         return "\"Объединение выпусков\" (глобальная операция)";
      elif( Kind == OPKIND_IN )
         return "\"Дробление ц/б\" (операция изменения номинала)";
      end;

      return Kind;
   end;

   private macro GetNameAddStr(Kind)
      if( (Kind == OPKIND_KDRAIN) or (Kind == OPKIND_KADRIN) or (Kind == OPKIND_GOKIN) or (Kind == OPKIND_GOUIN) )
         return "зачисление";
      elif( (Kind == OPKIND_KDRAOUT) or (Kind == OPKIND_KADROUT) or (Kind == OPKIND_GOKOUT) or (Kind == OPKIND_GOUOUT) )
         return "списание";
      end;
      return "";
   end;

   macro PrintDeals(Title, Data, KindRecord, toDate)
      var Continue_cicle, PartyShortName1, Transh = "", Issue = "", IsFirstPrint = true, prevDealCode = "", prevDealKind = "";
      var Amount, Query, cmd, cmdData, Series = "", PriceAvr = "", AmountPrecision = 0;
      file _fininstr (fininstr) key 1;
      var ReportKind = "", DocNum = "", DocDate = "";
      var DataSet, Select, cnt = 0, i = 0;
                                               
      Query = "select * from dscdljr_tmp "+
              " where t_KindRecord = ? ";

      if( toDate != NULL )
         Query = Query + " and t_DealDate = " + GetSQLDate(toDate);
      end;

      Query = Query +
              " order by t_DealDate, t_DealCode, t_DealKindName ";

      cmd = RsdCommand( Query );

      cmd.addParam("",  RSDBP_IN, KindRecord );

      cmd.execute();
    
      cmdData = TRsbDataSet(cmd);

      while( cmdData.MoveNext() )

         ReportKind = ""; 
         DocNum = ""; 
         DocDate = "";
         cnt = 0;

         i = 0;

         if( IsFirstPrint )
            if(Not Data.PrintTableHead)
               PrintTableHead(Data, toDate);
            end;
            PrintTitle(Title);
            IsFirstPrint = false;
         end;

         _fininstr.fi_code = cmdData.avrcode;
         if(GetEQ(_fininstr))
            if(FI_IsInvestmentShare(_fininstr))
               if(money(cmdData.Amount) == money(0))
                  Amount = "";
                  AmountPrecision = 0;
               else
                  Amount = MoneyToDouble(cmdData.Amount);        
                  AmountPrecision = _fininstr.SumPrecision;
               end;
            else
               Amount = MoneyToDouble(cmdData.Amount);
               AmountPrecision = _fininstr.SumPrecision;
            end;
         else
            Amount = MoneyToDouble(cmdData.Amount);
            AmountPrecision = 0;
         end;
         
         PartyShortName1 = Trim(cmdData.PartyShortName);
         PriceAvr = cmdData.BrokerShortName; /*в BrokerShortName мы засунули цену*/

         if( ГО_Списание(cmdData.DealKindName) or ГО_Зачисление(cmdData.DealKindName) or
             ИзменениеНомин(cmdData.DealKindName)
           )
           query =   " select spground.t_Xld, spground.t_RegistrDate, llv.t_Name as KindName "
                   + "   from dspground_dbt spground, dspgrdoc_dbt spgrdoc, dllvalues_dbt llv, ddl_comm_dbt comm "
                   + "  where comm.t_DocumentID = ? "
                   + "    and spgrdoc.t_SourceDocKind = comm.t_DocKind "  
                   + "    and spgrdoc.t_SourceDocID   = comm.t_DocumentID "
                   + "    and spground.t_SPgroundID   = spgrdoc.t_SPGroundID "
                   + "    and llv.t_List = " + OBJTYPE_KINDDOC
                   + "    and llv.t_Element = spground.t_Kind "
                   + "  order by spground.t_Kind asc";

           Select = DL_RSDCommand(query);
           Select.AddParam(cmdData.DealID);

           cnt = Select.GetCount();

         else
           query =   " select spground.t_Xld, spground.t_RegistrDate, llv.t_Name as KindName "
                   + "   from dspground_dbt spground, dspgrdoc_dbt spgrdoc, dllvalues_dbt llv, ddl_tick_dbt tick "
                   + "  where tick.t_DealID = ? "
                   + "    and spgrdoc.t_SourceDocKind = tick.t_BOfficeKind "  
                   + "    and spgrdoc.t_SourceDocID   = tick.t_DealID "
                   + "    and spground.t_SPgroundID   = spgrdoc.t_SPGroundID "
                   + "    and llv.t_List = " + OBJTYPE_KINDDOC
                   + "    and llv.t_Element = spground.t_Kind "
                   + "  order by spground.t_Kind asc";

           Select = DL_RSDCommand(query);
           Select.AddParam(cmdData.DealID);

           cnt = Select.GetCount(); 
         end;

         if(cnt > 0)
           DataSet = Select.Execute();
           if(DataSet.moveNext())
             ReportKind = string(DataSet.KindName);
             DocDate = string(date(DataSet.RegistrDate):f);
             DocNum = DataSet.Xld;
           end;
         end;



         if( ГО_Списание(cmdData.DealKindName) or ГО_Зачисление(cmdData.DealKindName) or
             Конвертация_Списание(cmdData.DealKindName) or Конвертация_Зачисление(cmdData.DealKindName)
           )
            /*печать основной строки*/
            if( prevDealCode != cmdData.DealCode )

               if( ГО_Списание(cmdData.DealKindName) or ГО_Зачисление(cmdData.DealKindName) )
                  PrintLine (
                     cmdData.DealCode,                       // DealCode:String,       
                     SQL_ConvTypeDate(cmdData.DealDate),     // DealDate:date,         
                     GetNameMainStr(cmdData.DealKindName),   // DealKindName:string,   
                     "",                                     // PartyShortName1:string,
                     "",                                     // ContrShortName:string, 
                     "",                                     // ClientShortName:string,
                     cmdData.DocNumber,                      // DocNumber:string,      
                     "",                                     // SfContrNumber:string,  
                     "",                                     // IssShortName:string,   
                     "",                                     // AvrKind:string,        
                     "",                                     // AvrCode:string,        
                     "",                                     // Issue:string,          
                     "",                                     // AvrSeries:string,      
                     "",                                     // Amount:variant,        
                     "",                                     // AmountPrecision:integer,
                     "",                                     // SumInNom:money,        
                     "",                                     // SumCCY,                
                     ReportKind,                             // ReportKind:string,
                     DocNum,                                 // ReportNum:string,
                     DocDate,                                // ReportDate:date,
                     "",                                     // OwnDate:date,          
                     "",                                     // PayDate:date,          
                     "",                                     // Nom:money,             
                     ""                                      // NomCur:string          
                  );
               else
                  PrintLine (
                     cmdData.DealCode,                       // DealCode:String,       
                     SQL_ConvTypeDate(cmdData.DealDate),     // DealDate:string,       
                     GetNameMainStr(cmdData.DealKindName),   // DealKindName:string,   
                     "",                                     // PartyShortName1:string,
                     "",                                     // ContrShortName:string, 
                     cmdData.ClientShortName,                // ClientShortName:string,
                     cmdData.DocNumber,                      // DocNumber:string,      
                     cmdData.SfContrNumber,                  // SfContrNumber:string,  
                     "",                                     // IssShortName:string,   
                     "",                                     // AvrKind:string,        
                     "",                                     // AvrCode:string,        
                     "",                                     // Issue:string,          
                     "",                                     // AvrSeries:string,      
                     "",                                     // Amount:variant,        
                     "",                                     // AmountPrecision:integer, 
                     "",                                     // SumInNom:money,        
                     "",                                     // SumCCY,                
                     ReportKind,                             // ReportKind:string,
                     DocNum,                                 // ReportNum:string,
                     DocDate,                                // ReportDate:string,
                     "",                                     // OwnDate:Date,          
                     "",                                     // PayDate:Date,          
                     "",                                     // Nom:money,             
                     ""                                      // NomCur:string          
                  );
               end;

               if(cnt > 1)
                 i = 2;
                 while(DataSet.moveNext())
                   ReportKind = string(DataSet.KindName);
                   DocDate = string(date(DataSet.RegistrDate):f);
                   DocNum = DataSet.Xld;

                   if( ГО_Списание(cmdData.DealKindName) or ГО_Зачисление(cmdData.DealKindName) )
                     PrintLine (
                        "",                                     // DealCode:String,       
                        "",                                     // DealDate:date,         
                        "",                                     // DealKindName:string,   
                        "",                                     // PartyShortName1:string,
                        "",                                     // ContrShortName:string, 
                        "",                                     // ClientShortName:string,
                        "",                                     // DocNumber:string,      
                        "",                                     // SfContrNumber:string,  
                        "",                                     // IssShortName:string,   
                        "",                                     // AvrKind:string,        
                        "",                                     // AvrCode:string,        
                        "",                                     // Issue:string,          
                        "",                                     // AvrSeries:string,      
                        "",                                     // Amount:variant,        
                        "",                                     // AmountPrecision:integer,
                        "",                                     // SumInNom:money,        
                        "",                                     // SumCCY,                
                        ReportKind,                             // ReportKind:string,     
                        DocNum,                                 // ReportNum:string,      
                        DocDate,                                // ReportDate:date,       
                        "",                                     // OwnDate:date,          
                        "",                                     // PayDate:date,          
                        "",                                     // Nom:money,             
                        ""                                      // NomCur:string          
                     );
                  else
                     PrintLine (
                        "",                                     // DealCode:String,       
                        "",                                     // DealDate:string,       
                        "",                                     // DealKindName:string,   
                        "",                                     // PartyShortName1:string,
                        "",                                     // ContrShortName:string, 
                        "",                                     // ClientShortName:string,
                        "",                                     // DocNumber:string,      
                        "",                                     // SfContrNumber:string,  
                        "",                                     // IssShortName:string,   
                        "",                                     // AvrKind:string,        
                        "",                                     // AvrCode:string,        
                        "",                                     // Issue:string,          
                        "",                                     // AvrSeries:string,      
                        "",                                     // Amount:variant,        
                        "",                                     // AmountPrecision:integer, 
                        "",                                     // SumInNom:money,        
                        "",                                     // SumCCY,                
                        ReportKind,                             // ReportKind:string,
                        DocNum,                                 // ReportNum:string,
                        DocDate,                                // ReportDate:string,
                        "",                                     // OwnDate:Date,          
                        "",                                     // PayDate:Date,          
                        "",                                     // Nom:money,             
                        ""                                      // NomCur:string          
                     );
                  end;

                   i = i + 1;
                 end;
               end;

               prevDealKind = "";
            end;

            /*печать дополнительной строки*/
            PrintLine (                                                                                                               
               "",                                                                            
               "",                                                                            
               IIF(prevDealKind!=cmdData.DealKindName,GetNameAddStr(cmdData.DealKindName),""),
               "",                                                                            
               "",                                                                            
               IIF(ГО_Списание(cmdData.DealKindName) or ГО_Зачисление(cmdData.DealKindName),cmdData.ClientShortName,""),                                                       
               "",                                                                            
               "",                                                                            
               cmdData.IssShortName,                                                          
               cmdData.AvrKind,                                                               
               cmdData.AvrCode,                                                               
               Issue,                                                                         
               cmdData.AvrSeries,                                                             
               Amount,                                                                        
               AmountPrecision,                                                                            
               "",                                                                            
               "",                                                                            
               "",                                                                            
               "",                                                                            
               "",                                                                            
               SQL_ConvTypeDate(cmdData.PayDate),/*дата зачисления\списания*/                                   
               "",                                                                            
               "",                                                                            
               ""
            );
         else
            PrintLine (
               cmdData.DealCode,                         // DealCode:String,       
               SQL_ConvTypeDate(cmdData.DealDate),       // DealDate:string,       
               GetNameMainStr(cmdData.DealKindName),     // DealKindName:string,   
               cmdData.PartyShortName,                   // PartyShortName1:string,
               cmdData.ContrShortName,                   // ContrShortName:string, 
               cmdData.ClientShortName,                  // ClientShortName:string,
               cmdData.DocNumber,                        // DocNumber:string,      
               cmdData.SfContrNumber,                    // SfContrNumber:string,  
               cmdData.IssShortName,                     // IssShortName:string,   
               cmdData.AvrKind,                          // AvrKind:string,        
               cmdData.AvrCode,                          // AvrCode:string,        
               Issue,                                    // Issue:string,          
               cmdData.AvrSeries,                        // AvrSeries:string,      
               Amount,                                   // Amount:variant,        
               AmountPrecision,                          // AmountPrecision:integer  
               money(cmdData.SumInNom),                  // SumInNom:money,        
               cmdData.PayCCY,                           // SumCCY,                
               ReportKind,                               // ReportKind:string,
               DocNum,                                   // ReportNum:string,
               DocDate,                                  // ReportDate:string,
               SQL_ConvTypeDate(cmdData.PayDate),        // OwnDate:Date,          
               SQL_ConvTypeDate(cmdData.PayFactDate),    // PayDate:Date,          
               IIF((PriceAvr!=null)and(PriceAvr!="")and(PriceAvr>$0),PriceAvr,""),     // Nom:money,             
               IIF((PriceAvr!=null)and(PriceAvr!="")and(PriceAvr>$0),cmdData.PayCCY,"")// NomCur:string          
            );

            if(cnt > 1)
              i = 2;
              while(DataSet.moveNext())
                ReportKind = string(DataSet.KindName);
                DocDate = string(date(DataSet.RegistrDate):f);
                DocNum = DataSet.Xld;

                PrintLine (
                   "",             // DealCode:String,       
                   "",             // DealDate:string,       
                   "",             // DealKindName:string,   
                   "",             // PartyShortName1:string,
                   "",             // ContrShortName:string, 
                   "",             // ClientShortName:string,
                   "",             // DocNumber:string,      
                   "",             // SfContrNumber:string,  
                   "",             // IssShortName:string,   
                   "",             // AvrKind:string,        
                   "",             // AvrCode:string,        
                   "",             // Issue:string,          
                   "",             // AvrSeries:string,      
                   "",             // Amount:variant,        
                   "",             // AmountPrecision:integer  
                   "",             // SumInNom:money,        
                   "",             // SumCCY,                
                   ReportKind,     // ReportKind:string,     
                   DocNum,         // ReportNum:string,      
                   DocDate,        // ReportDate:string,     
                   "",             // OwnDate:Date,          
                   "",             // PayDate:Date,          
                   "",             // Nom:money,             
                   ""              // NomCur:string          
                );

                i = i + 1;
              end;
            end;

         end;
         
         prevDealCode = cmdData.DealCode;
         prevDealKind = cmdData.DealKindName;

      end;

   end;

   macro ЗаполнитьСделку(Data, FD, KindRecord, TotalCost1)
      var DocNum = "", DocDate = date(0,0,0), Group;
      var errcode, errtext, Summa, FD2;

      ClearRecord(ReportTMP);
      ReportTMP.rec.KindRecord = KindRecord;

      ReportTMP.rec.DealID = FD.tick.rec.DealID;

      /*Номер сделки*/
      ReportTMP.rec.DealCode = FD.tick.rec.DealCode;
      /*Дата заключения*/
      ReportTMP.rec.DealDate =  FD.tick.rec.DealDate;
      /*Время заключения (без секунд)*/
      ReportTMP.rec.DealTime =  FD.tick.rec.DealTime;

      if(FD.tick.rec.BOfficeKind == DL_CONVAVR)
       ReportTMP.rec.PartyShortName = "";
      else /*погашения*/
       /*на ОРЦБ*/
       if(FD.СделкаОРЦБ())   
         ReportTMP.rec.PartyShortName = ПолучитьКороткоеИмяСубъекта(FD.tick.rec.MarketID);

       /* через брокера*/
      elif((FD.tick.rec.Flag4 == SET_CHAR) OR 
             ((FD.tick.rec.BrokerID > -1) AND (ВидСубъекта(FD.tick.rec.BrokerID, PTK_BROKER) == true)) 
          )

         ReportTMP.rec.PartyShortName = ПолучитьКороткоеИмяСубъекта(FD.tick.rec.BrokerID);

       elif(FD.tick.rec.PartyID > -1)  /* */

         ReportTMP.rec.PartyShortName = ПолучитьКороткоеИмяСубъекта(FD.tick.rec.PartyID);
       
       else
         ReportTMP.rec.PartyShortName = "";
       end;
      end;
      /*
      В зависимости от вида операции - "Погашение облигации" или "Погашение купона" или "Пога-шение облигаций частичное" .
      Для операций "Погашение операций" и "Погашение облигаций частичное" справа добавляется текст "и купонов", 
      если в операции указан номер купона.
      */
      /*вид операции*/

      if(IsCONVERT_SHARE(FD.Group))
        if(FD.IsBack) 
           ReportTMP.rec.DealKindName = OPKIND_KADRIN; 
        else
           ReportTMP.rec.DealKindName = OPKIND_KADROUT; 
        end;

      elif(IsCONVERT_RECEIPT(FD.Group))
        if(FD.IsBack) 
           ReportTMP.rec.DealKindName = OPKIND_KDRAIN; 
        else
           ReportTMP.rec.DealKindName = OPKIND_KDRAOUT; 
        end;

      elif(IsRET_ISSUE(FD.Group)) 

        ReportTMP.rec.DealKindName = "Погашение облигации";

      elif(IsRET_PARTLY(FD.Group))   

        ReportTMP.rec.DealKindName = "Погашение облигации частичное";

      elif(rFininstr.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE)

        ReportTMP.rec.DealKindName = "Получение паев при выдаче";

      else /*IsRET_COUPON(FD.Group) */

        ReportTMP.rec.DealKindName = "Погашение купона";

     end;

     if((IsRET_ISSUE(FD.Group) OR IsRET_PARTLY(FD.Group)) AND (FD.tick.rec.Number_Coupon != ""))
        ReportTMP.rec.DealKindName = ReportTMP.rec.DealKindName + " и купонов";
     end;

     /*Дату списания\зачисления записываем в paydate*/
     if( IsCONVERT_SHARE(FD.Group) OR IsCONVERT_RECEIPT(FD.Group) )
        if( FD.pm_avoir.rec.ValueDate != ZeroDate )
           ReportTMP.rec.PayDate = FD.pm_avoir.rec.ValueDate;
        else/*значит зачисления еще не было */
           return;
        end;
     end;

     /* A3.1 - Депозитарий */
     if(FD.tick.rec.BOfficeKind == DL_CONVAVR)
        ReportTMP.rec.ContrShortName = "";
     else
        ReportTMP.rec.ContrShortName = "";
        ReportTMP.rec.ContrShortName = ПолучитьКороткоеИмяСубъекта(FD.dl_leg.rec.Registrar);
     end;

     /* A4 - Клиент*/
     if(FD.tick.rec.ClientID > 0)
        ReportTMP.rec.ClientShortName = ПолучитьКороткоеИмяСубъекта(FD.tick.rec.ClientID);
     end;

     /*Номер поручения*/
     if(FD.tick.rec.ClientID < 0)
       ReportTMP.rec.DocNumber = "";
     else
       ПолучитьДокументПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, DOCKIND_ORD_CLIENTOP, ReportTMP.rec.DocNumber)
     end;

     /*Договор с клиентом*/
     if(FD.tick.rec.ClientID > 0)
        /*Номер договора*/
        ClearRecord(sfcontr);
        sfcontr.Id = FD.tick.rec.ClientContrID;
        if(GetEQ(sfcontr))  
           ReportTMP.rec.SfContrNumber = sfcontr.Number;
        else 
           ReportTMP.rec.SfContrNumber = "";
        end;
     else 
        ReportTMP.rec.SfContrNumber = "";
     end;
     /*эмитент*/
     ReportTMP.rec.IssShortName = ПолучитьКороткоеИмяСубъекта( FI_GetIssuerOnDate(FD.fininstr, Data.dateMax) );

     /*Вид ЦБ*/
     AvoirKindName(FD.fininstr.rec.AvoirKind, ReportTMP.rec.AvrKind);

     /*Код ЦБ*/
     ReportTMP.rec.AvrCode = FD.fininstr.rec.FI_Code;

     /*Серия*/
     ReportTMP.rec.AvrSeries = FD.avoiriss.rec.Series;

     /*Выпуск\Транш*/ 
     ReportTMP.rec.AvrIssue = FD.avoiriss.rec.Issue;

     /*Кол-во ЦБ*/
     ReportTMP.rec.Amount = FD.dl_leg.rec.Principal;
     
      /*теперь в поле SumInNom будем записывать сумму сделки в валюте цены сделки*/
      if (FD.tick.rec.BOfficeKind == DL_CONVAVR)
        if (IsClientDeal(FD.tick.rec))
         if (not FD.IsBack)
           if (WRT_GetSaleFinResult (FD.pmwrtsum.rec.SumID, FD.pmwrtsum.rec.Portfolio, 0,
                                      Summa, null, null, null, null, null, null, null, null, null, null,
                                      null, null, null, null, null, null, null) == false)
              return;
           end;
         else
           FD2 = SpFirstDoc(FD.Tick, false);
           if (WRT_GetSaleFinResult (FD2.pmwrtsum.rec.SumID, FD2.pmwrtsum.rec.Portfolio, 0,
                                      Summa, null, null, null, null, null, null, null, null, null, null,
                                      null, null, null, null, null, null, null) == false)
              return;
           end;
         end;
         ReportTMP.rec.SumInNom = Summa;
        else
           ReportTMP.rec.SumInNom = FD.dl_leg.rec.TotalCost;
        end;
      elif(FD.tick.rec.BOfficeKind == DL_INVESTSHARE)
          /*сумма платежа*/
         if(FD.ExistRqMoney())
            ReportTMP.rec.SumInNom = FD.pm_money.rec.Amount;
         else
            ReportTMP.rec.SumInNom = "";
         end;
      else
        ReportTMP.rec.SumInNom = FD.dl_leg.rec.TotalCost;
      end;

     /*Валюта расчета*/
     if(FD.ExistRqMoney())
        if(FD.pm_money == NULL)
           ReportTMP.rec.PayCCY = "";
        elif(not ПолучитьФинИн(FD.pm_money.rec.PayFIID, rCurPaymFI))
           ReportTMP.rec.PayCCY = rCurPaymFI.Ccy;
        else 
           ReportTMP.rec.PayCCY = "";
        end;
     else 
        ReportTMP.rec.PayCCY = "";
     end;

     /*Цена ЦБ - запишем в BrokerShortName т.к. оно всё равно не используется, а для цены поля нет*/
     if( ( IsRET_ISSUE(FD.Group) or IsRET_PARTLY(FD.Group) ) and ( FD.dl_leg.rec.Principal != 0 )  )
        ReportTMP.rec.BrokerShortName = string(FD.dl_leg.rec.TotalCost / FD.dl_leg.rec.Principal);
     elif( (IsRET_COUPON(FD.Group) ) and ( FD.dl_leg.rec.Principal != 0 ) )
        ReportTMP.rec.BrokerShortName = string(FD.dl_leg.rec.NKD / FD.dl_leg.rec.Principal);
     elif(FD.tick.rec.BOfficeKind == DL_INVESTSHARE)
        /*получение паев: цена одного пая*/
        ReportTMP.rec.BrokerShortName = FD.dl_leg.rec.Price;
        /*Дата перехода/ограничения прав на ц/б - получение паев: дата поставки ц/б*/
        /*Дата платежа - Получение паев: дата оплаты PayFactDate*/
        if( FD.ExistRqAvoir() )
          ReportTMP.rec.PayDate = FD.pm_avoir.rec.ValueDate;
        else
          ReportTMP.rec.PayDate = "";
        end;
        if(FD.ExistRqMoney())
           ReportTMP.rec.PayFactDate = FD.pm_money.rec.ValueDate;
        else 
           ReportTMP.rec.PayFactDate = "";
        end;
     end;

     ReportTMP.rec.ReportKind = ReportTMP.rec.ReportNum = ReportTMP.rec.ReportDate = "";

     if(not Insert(ReportTMP))
        errcode = status(errtext);
        RunError("Ошибка при вставке данных во временный файл (" + errcode + ") " + errtext);
     end;
   end;

   macro CheckDeal(Data, Deal, OperType)
      record dl_leg(dl_leg);
      var Group = GetOperationGroup(Deal.DealType);
      var PartyR = TRecHandler("party.dbt");
      var cli = -1;

      if((OperType == SC_OPER_RETIRE) AND (Deal.BofficeKind != DL_RETIREMENT))
        return false;
      end;

      if((OperType == SC_OPER_CONVERT) AND (Deal.BofficeKind != DL_CONVAVR))
        return false;
      end;

      if((OperType == SC_OPER_INVESTSHARE) AND (Deal.BofficeKind != DL_INVESTSHARE))
        return false;
      end;

      if((OperType == STR_BOND_ALL) AND 
         (not((Deal.BofficeKind == DL_RETIREMENT) OR (Deal.BofficeKind == DL_CONVAVR) OR (Deal.BofficeKind == DL_INVESTSHARE))))
        return false;
      end;

      if((Data.OperStatus != DEALSTATUS_ALL) AND (Deal.DealStatus != Data.OperStatus))
        return false;
      end;

      /*Сделка должна быть не отложена */
      if((Deal.DealStatus != DL_CLOSED) AND (Deal.DealStatus != DL_READIED))
        return false;
      end;

      if((Data.DprtID != -1) AND (Deal.Department != Data.DprtID))
        return false;
      end;

      if((Data.ClientID != -1) AND (Deal.ClientID != Data.ClientID))
        return false;
      end;

      if((Data.MarketID != -1) AND (Deal.MarketID != Data.MarketID))
        return false;
      end;

      if((Data.BrokerID != -1) AND (Deal.BrokerID != Data.BrokerID)) 
        return false;
      end;

      if(FindDL_LEG(LEG_KIND_DL_TICK, Deal.DealID, 0, dl_leg) == 0)
         if((Data.DepositaryID != -1) AND (dl_leg.Registrar != Data.DepositaryID)) 
           return false;
         end;

         if(ПолучитьФинИн(dl_leg.PFI ,rFininstr) != 0)
            return false;
         end;

         if((Data.AvrID != -1) AND (Data.AvrID != rFininstr.FIID))
           return false;
         end;

         if((Data.EmiID != -1) AND (Data.EmiID != rFininstr.Issuer)) 
           return false;
         end;

         if((Data.AvrTypeID != -1) AND (Data.AvrTypeID != rFininstr.AvoirKind))
           return false;
         end;
      end;

      if(
         ( (OperType == SC_OPER_RETIRE) OR           
          ((OperType == -1) and ( IsRET_ISSUE(Group) or IsRET_PARTLY(Group) or IsRET_COUPON(Group) ) )
         )  /*Если не задан вид операции, то проверить галки для только для операций погашения*/
        AND
        (NOT
          (
            ((Data.DealMarket == true) AND (Deal.Flag1 == SET_CHAR))
            OR
            ((Data.DealNotMarket == true) AND (Deal.Flag1 != SET_CHAR))
            OR
            ((Data.DealBroker == true) AND ((Deal.Flag4 == SET_CHAR/*признак "Брокер"*/) OR ((Deal.BrokerID > -1) AND (ВидСубъекта(Deal.BrokerID, PTK_BROKER) == true))))
          )
        )
      )
        return false;
      end;

      if(Data.DealType != -1)  /*Указан тип сделки*/
        if(Deal.ClientID > 0) 
           if((Data.DealType != SC_DEAL_BROKER) and (Data.DealType != SC_DEAL_CB))
              return false;
           else
              if(ПолучитьДоговорПоСделке(Deal, r_sfcontr, false))
                 if(((Data.DealType == SC_DEAL_BROKER) AND (r_sfcontr.servkindsub == SUBKIND_DRIVE_CB)) OR
                     ((Data.DealType == SC_DEAL_CB)     AND (r_sfcontr.servkindsub != SUBKIND_DRIVE_CB))
                  )
                    return false;
                 end;
              end;
           end;
        else
           if(Data.DealType != SC_DEAL_OWN)
              return false;
           end;
        end;
      end;

      if (Deal.IsPartyClient == SET_CHAR)
        cli = Deal.PartyID;
      else
        cli = Deal.ClientID;
      end;

      if (cli == -1) 
        cli = {OurBank};
      end;

      if (ПолучитьСубъекта(cli, PartyR))
        msgBox("1115 " + cli);
        return false;
      end;

      if (Data.NoResident != "")
        if (PartyR.rec.NotResident != Data.NoResident)
          return false;
        end;
      end;

      if (Data.IsForm == 1)
        if (PartyR.rec.LegalForm != Data.FormSub)
          return  false;
        end;
      end;

      if (Data.IsForm == 2)
        if (PartyR.rec.LegalForm == Data.FormSub)
          return  false;
        end;
      end;

      if (Data.IsVid == 1)
        if (not ВидСубъекта(cli, Data.VidSub))
          return  false;
        end;
      end;

      if (Data.IsVid == 2)
        if (ВидСубъекта(cli, Data.VidSub))
          return  false;
        end;
      end;

      return true;
   end;

   macro DealInReport(Data, FD, OperType, TotalCost1)

      if(FD.tick.rec.ClientID < 0) /*собственная сделка*/
         ЗаполнитьСделку(Data, FD, DEALTYPE_OWN, OperType);
      else
         if(r_sfcontr.servkindsub != SUBKIND_DRIVE_CB)
            ЗаполнитьСделку(Data, FD, DEALTYPE_BROKER, OperType, TotalCost1);
         else
            ЗаполнитьСделку(Data, FD, DEALTYPE_DU, OperType, TotalCost1);
         end;
      end;
   end;

   macro GetDocForGOIN(GORec, GODocKind, DocKind, DocNum, DocDate)
       
     var kind = "", Num = "", _Date = Date(0,0,0);

     if(ПолучитьДокументПоСделке(GODocKind, GORec.DocumentID, DOCKIND_MARKETREP, Num, _Date))
        kind = "отчет";
     else
        /*Ищем распорядительную записку*/
        if(ПолучитьДокументПоСделке(GODocKind, GORec.DocumentID, DOCKIND_COMMANDREP, Num, _Date))
          kind = "Расп.зап";
        end;
     end;

     Setparm(1, kind);
     Setparm(2, Num);
     Setparm(3, _Date);
   end; 

   macro ЗаполнитьГОИН(Data, GORec, KindRecord, DocKind)
      var DocNum = "", DocDate = date(0,0,0), Group, Order1 = "";
      var errcode, errtext, Summa, FD2;
      var spgr = TRecHandler( "spground.dbt" );

      ClearRecord(ReportTMP);
      ReportTMP.rec.KindRecord = KindRecord;

      ReportTMP.rec.DealID = GORec.DocumentID;

      /*Номер сделки*/
      ReportTMP.rec.DealCode = GORec.COMMCODE;

      /*вид операции*/
      if( DocKind == DL_ISSUE_UNION )
         if( GORec.OperSubKind == 1 )
            if( GORec.FIID == GORec.OutFIID )
               ReportTMP.rec.DealKindName = OPKIND_GOKOUT;
            else
               ReportTMP.rec.DealKindName = OPKIND_GOKIN;
            end;
         elif( GORec.OperSubKind == 4 )
            if( GORec.FIID == GORec.OutFIID )
               ReportTMP.rec.DealKindName = OPKIND_GOUOUT;
            else
               ReportTMP.rec.DealKindName = OPKIND_GOUIN;
            end;
         end;
      elif( DocKind == DL_CHGAVRNOM )
         ReportTMP.rec.DealKindName = OPKIND_IN;
      end;

      /*Дата заключения*/
      ReportTMP.rec.DealDate = SQL_ConvTypeDate(GORec.CommDATE);

      /*Дату списания\зачисления записываем в paydate*/
      if( DocKind ==  DL_ISSUE_UNION )
         ReportTMP.rec.PayDate = SQL_ConvTypeDate(GORec.InOutDATE);
      end;
      /* A4 - Клиент*/
      if(GORec.ClientID > 0)
         ReportTMP.rec.ClientShortName = ПолучитьКороткоеИмяСубъекта(GORec.ClientID);
      end;

      if(ПолучитьФинИн(GORec.FIID,rFininstr,ravoiriss) != 0)
         return false;
      end;
     
      /*эмитент*/
      ReportTMP.rec.IssShortName = ПолучитьКороткоеИмяСубъекта(rFininstr.Issuer);
     
      /*Вид ЦБ*/
      AvoirKindName(rFininstr.AvoirKind, ReportTMP.rec.AvrKind);
     
      /*Код ЦБ*/
      ReportTMP.rec.AvrCode = rFininstr.FI_Code;
     
      /*Серия*/
      ReportTMP.rec.AvrSeries = ravoiriss.Series;
     
      /*Выпуск\Транш*/ 
      ReportTMP.rec.AvrIssue = ravoiriss.Issue;
     
      /*Кол-во ЦБ*/
      ReportTMP.rec.Amount = GORec.AMOUNT;
     
      ReportTMP.rec.ReportKind = ReportTMP.rec.ReportNum = ReportTMP.rec.ReportDate = "";

     
      if(not Insert(ReportTMP))
         errcode = status(errtext);
         RunError("Ошибка при вставке данных во временный файл (" + errcode + ") " + errtext);
      end;
   end;

   /*операции ГО*/
   macro INGOOpInReport(Data, GORec, DocKind)
      if(GORec.ClientID < 0) /*собственная сделка*/
         ЗаполнитьГОИН(Data, GORec, DEALTYPE_OWN, DocKind);
      else                                                              
         ЗаполнитьГОИН(Data, GORec, DEALTYPE_BROKER, DocKind);
      end;
   end;

   macro CollectGO(Data,begDate:date,endDate:date)
      var cmd, DataSet, Num = 0, NumAll = 0, Nrec, NData, Query;        

      Query = " select v.T_FIID FIID, v.t_ChangeDate InOutDate, sum(v.t_Amount) Amount, v.t_Party ClientID, comm.T_DOCUMENTID, " + 
              "        comm.T_COMMCODE, comm.T_OperSubKind, comm.t_CommDate, comm.T_FIID OutFIID, comm.T_Ground "+
              "  from v_scwrthistex v  " +

              "   left outer join dparty_dbt Pty " +
              "     on  Pty.T_PARTYID =  case when v.t_Party  = -1 then " + {OurBank} +"   else v.t_Party end "+
              " , dfininstr_dbt fin, doproper_dbt opr, ddl_comm_dbt comm " +
              " where comm.T_DocKind = ? " +
              "   and (((v.T_ACTION = 421  or v.T_ACTION = 422) and V.T_STATE != 1) or "+
              "        ((v.T_KIND = 120 and v.T_ACTION = 10) or (v.T_KIND = 130 and v.T_ACTION = 422) and V.T_STATE = 1)) " + 
              "   and comm.t_CommDate between ? and ? " +
              "   and v.T_Department = ? ";

      if( Data.OperStatus == DEALSTATUS_ALL )
         query = query +
                 "   and comm.T_COMMSTATUS >= "+string(DL_COMM_READIED);
      elif( Data.OperStatus == DEALSTATUS_OPENED )
         query = query +
                 "   and comm.T_COMMSTATUS = "+string(DL_COMM_READIED);
      else
         query = query +
                 "   and comm.T_COMMSTATUS = "+string(DL_COMM_CLOSED);
      end;

      Query =  Query +
              "   and opr.T_ID_OPERATION = v.T_ID_OPERATION " +
              "   and ltrim(opr.T_DocumentID) = comm.T_DOCUMENTID " +
              "   and opr.T_DocKind = comm.T_DocKind " +
              "   and v.T_FIID = case when ? != -1 then ? else v.T_FIID end "+
              "   and fin.t_FIID = v.T_FIID "+
              "   and fin.t_Issuer = case when ? != -1 then ? else fin.t_Issuer end "+
              "   and RSB_FIInstr.FI_AvrKindsEQ(2, " + IIF(Data.AvrTypeID==-1,"fin.t_AvoirKind",string(Data.AvrTypeID)) +" , fin.t_AvoirKind) = 1 ";

      if( (Data.ClientID > 0) and (Data.ClientID == {OurBank}) )
         query = query +
              "   and v.t_Party = -1 ";
      elif( Data.ClientID > 0 )
         query = query +
              "   and v.t_Party = ? ";
      end;

      if( (Data.IsForm > 0) and (Data.FormSub != 0) )
        if(Data.IsForm == 1)
          Query = Query + "    and ( Pty.T_LEGALFORM = ? )" ;
        end;
        if(Data.IsForm == 2)            	
          Query = Query + "    and ( Pty.T_LEGALFORM != ? )";
        end;
      end;

      if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
        if(Data.IsVid == 1)
          Query = Query + "   and   (EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID))" ;
        end;
        if(Data.IsVid == 2)            	
          Query = Query + "    and   (NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID))  " ;
        end;
      end;

      if(Data.NoResident)
        Query = Query + " and ( Pty.T_NOTRESIDENT = 'X')";
      end;

      Query = Query +
              " group by comm.T_DOCUMENTID, comm.T_COMMCODE, comm.T_OperSubKind, comm.t_CommDate, v.t_ChangeDate, "+
              "       v.T_FIID, v.t_Party, v.T_ACTION, comm.T_Ground, comm.T_FIID";
              
      Nrec = RsdCommand( "select count(1) Nrec from ("+Query+")" );

      NRec.addParam("",  RSDBP_IN, DL_ISSUE_UNION );
      NRec.addParam("",  RSDBP_IN, begDate );
      NRec.addParam("",  RSDBP_IN, endDate );
      NRec.addParam("",  RSDBP_IN, Data.DprtID );
      NRec.addParam("",  RSDBP_IN, Data.AvrID );
      NRec.addParam("",  RSDBP_IN, Data.AvrID );
      NRec.addParam("",  RSDBP_IN, Data.EmiID );
      NRec.addParam("",  RSDBP_IN, Data.EmiID );
      if( (Data.ClientID > 0) and (Data.ClientID != {OurBank}) )
         NRec.addParam("",  RSDBP_IN, Data.ClientID );
      end;
      if( (Data.IsForm > 0) and (Data.FormSub != 0) )
        NRec.addParam("",  RSDBP_IN, Data.FormSub );
      end;

      NRec.execute();
    
      NData = TRsbDataSet(NRec);

      if( NData.MoveNext() )
         NumAll = int(NData.Nrec);
      end;

      if( NumAll > 0 )
         cmd = RsdCommand( Query );

         cmd.addParam("",  RSDBP_IN, DL_ISSUE_UNION );
         cmd.addParam("",  RSDBP_IN, begDate );
         cmd.addParam("",  RSDBP_IN, endDate );
         cmd.addParam("",  RSDBP_IN, Data.DprtID );
         cmd.addParam("",  RSDBP_IN, Data.AvrID );
         cmd.addParam("",  RSDBP_IN, Data.AvrID );
         cmd.addParam("",  RSDBP_IN, Data.EmiID );
         cmd.addParam("",  RSDBP_IN, Data.EmiID );
        
         if( (Data.ClientID > 0) and (Data.ClientID != {OurBank}) )
            cmd.addParam("",  RSDBP_IN, Data.ClientID );
         end;

         if( (Data.IsForm > 0) and (Data.FormSub != 0) )
           cmd.addParam("",  RSDBP_IN, Data.FormSub );
         end;
        
         DataSet = TRsbDataSet(cmd);
        
         InitProgress(NumAll, "Отчет \"Субрегистр иных операций\"", "Просмотр операций ГО");
         while( DataSet.MoveNext() )
            INGOOpInReport(Data, DataSet,DL_ISSUE_UNION);
            UseProgress(Num = Num + 1);
         end;
         RemProgress;
      end;
   end;                                                           

   macro CollectIN(Data,begDate:date,endDate:date)
      var cmd, DataSet, Num = 0, NumAll = 0, Nrec, NData, query;
      
      query = " select v.T_FIID, sum(abs(v.t_Amount-b.t_Amount)) Amount, comm.T_COMMCODE, comm.T_OperSubKind, "+
              "        v.t_Party ClientID, comm.t_CommDate, comm.t_DOCUMENTID, comm.T_Ground " +           
              "  from v_scwrthistex v "+

              "   left outer join dparty_dbt Pty " +
              "     on  Pty.T_PARTYID =  case when v.t_Party  = -1 then " + {OurBank} +"   else v.t_Party end "+

              " , dpmwrtbc_dbt b, ddl_comm_dbt comm, doproper_dbt opr, dfininstr_dbt fin " +
              " where comm.T_DocKind = ? ";

      if( Data.OperStatus == DEALSTATUS_ALL )
         query = query +
                 "   and comm.T_COMMSTATUS >= "+string(DL_COMM_READIED);
      elif( Data.OperStatus == DEALSTATUS_OPENED )
         query = query +
                 "   and comm.T_COMMSTATUS = "+string(DL_COMM_READIED);
      else
         query = query +
                 "   and comm.T_COMMSTATUS = "+string(DL_COMM_CLOSED);
      end;

      query = query +
              "   and opr.T_ID_OPERATION = v.T_ID_OPERATION " +
              "   and ltrim(opr.T_DocumentID) = comm.T_DOCUMENTID " +
              "   and opr.T_DocKind = comm.T_DocKind " +
              "   and v.T_SumID = b.T_SumID " +
              "   and b.T_Instance =  v.T_Instance - 1 " +
              "   and comm.t_CommDate between ? and ? " +
              "   and v.T_Department = ? " +
              "   and v.T_FIID = case when ? != -1 then ? else v.T_FIID end "+
              "   and fin.t_FIID = v.T_FIID "+
              "   and fin.t_Issuer = case when ? != -1 then ? else fin.t_Issuer end "+
              "   and RSB_FIInstr.FI_AvrKindsEQ(2, " + IIF(Data.AvrTypeID==-1,"fin.t_AvoirKind",string(Data.AvrTypeID)) + ", fin.t_AvoirKind) = 1 ";
              
      if( (Data.ClientID > 0) and (Data.ClientID == {OurBank}) )
         query = query +
              "   and v.t_Party = -1 ";
      elif( Data.ClientID > 0 )
         query = query +
              "   and v.t_Party = ? ";
      end;

      if( (Data.IsForm > 0) and (Data.FormSub != 0) )
        if(Data.IsForm == 1)
          Query = Query + "    and  Pty.T_LEGALFORM = ? " ;
        end;
        if(Data.IsForm == 2)            	
          Query = Query + "    and  Pty.T_LEGALFORM != ? ";
        end;
      end;

      if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
        if(Data.IsVid == 1)
          query = query + "   and   (EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID))";
        end;
        if(Data.IsVid == 2)            	
          query = query + "    and   (NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID))" ;
        end;
      end;

      if(Data.NoResident)
        query = query + " and (Pty.T_NOTRESIDENT = 'X')";
      end;

    
      query = query +
              " group by comm.t_CommDate, comm.t_DOCUMENTID, comm.T_COMMCODE, comm.T_OperSubKind, v.T_FIID, v.t_Party, comm.T_Ground ";

      Nrec = RsdCommand( "select count(1) Nrec from ("+Query+")" );

      NRec.addParam( "", RSDBP_IN, DL_CHGAVRNOM );
      NRec.addParam("",  RSDBP_IN, begDate );
      NRec.addParam("",  RSDBP_IN, endDate );
      NRec.addParam("",  RSDBP_IN, Data.DprtID );
      NRec.addParam("",  RSDBP_IN, Data.AvrID );
      NRec.addParam("",  RSDBP_IN, Data.AvrID );
      NRec.addParam("",  RSDBP_IN, Data.EmiID );
      NRec.addParam("",  RSDBP_IN, Data.EmiID );

      if( (Data.ClientID > 0) and (Data.ClientID != {OurBank}) )
         NRec.addParam("",  RSDBP_IN, Data.ClientID );
      end;

      if( (Data.IsForm > 0) and (Data.FormSub != 0) )
         NRec.addParam("",  RSDBP_IN, Data.FormSub );
      end;


      NRec.execute();
    
      NData = TRsbDataSet(NRec);

      if( NData.MoveNext() )
         NumAll = int(NData.Nrec);
      end;

      if( NumAll > 0 )
         cmd = RsdCommand( Query );
        
         cmd.addParam( "", RSDBP_IN, DL_CHGAVRNOM );
         cmd.addParam("",  RSDBP_IN, begDate );
         cmd.addParam("",  RSDBP_IN, endDate );
         cmd.addParam("",  RSDBP_IN, Data.DprtID );
         cmd.addParam("",  RSDBP_IN, Data.AvrID );
         cmd.addParam("",  RSDBP_IN, Data.AvrID );
         cmd.addParam("",  RSDBP_IN, Data.EmiID );
         cmd.addParam("",  RSDBP_IN, Data.EmiID );
        
         if( (Data.ClientID > 0) and (Data.ClientID != {OurBank}) )
            cmd.addParam("",  RSDBP_IN, Data.ClientID );
         end;

        if( (Data.IsForm > 0) and (Data.FormSub != 0) )

            cmd.addParam("",  RSDBP_IN, Data.FormSub );
        end;
        
         cmd.execute();
        
         DataSet = TRsbDataSet(cmd);
        
         InitProgress(NumAll, "Отчет \"Субрегистр иных операций\"", "Просмотр операций ИН");
         while( DataSet.MoveNext() )
            INGOOpInReport(Data, DataSet,DL_CHGAVRNOM);
            UseProgress(Num = Num + 1);
         end;
         RemProgress;
      end;

   end;

   /*По конкретному филиалу*/
   macro ExecuteReportByDepartment(Data, OperType, cDate)
      file  FDeals(dl_tick) key 8; /* DealDate, DealTime */
      var   FD, continue_cicle, Num = 0, NumAll = 0, TotalCost1;
      var begDate, endDate;
      
      Clone(ReportTMP);

      Data.PrintHead = false;

      NumAll = NRecords(FDeals);
      InitProgress(NumAll, "Отчет \"Субрегистр иных операций\"", "Просмотр сделок");

      clearrecord(FDeals);
      if( ValType(cDate) == V_UNDEF )
         begDate = Data.dateMin;
         endDate = Data.dateMax;
      else
         begDate = cDate;
         endDate = cDate;
      end;
      
      FDeals.DealDate = begDate;
      
      if( (OperType != SC_OPER_GLOBAL) and (OperType != SC_OPER_NOMCHANG) )
         continue_cicle = GetGE(FDeals);
         while(continue_cicle AND (FDeals.DealDate <= endDate)) 
       
           if(CheckDeal(Data, FDeals, OperType))
       
              FD = SPFirstDoc(FDeals);
              DealInReport(Data, FD, OperType);
       
              if(FD.ExistBack == true)
                 FD = SPFirstDoc(FDeals, true);
                 DealInReport(Data, FD, OperType, TotalCost1);
              end;
       
           end;
       
           continue_cicle = Next(FDeals);
           UseProgress(Num = Num + 1);
         end;
      end;

      UseProgress(NumAll);

      if( (OperType == SC_OPER_GLOBAL) or (OperType == -1) )
         CollectGO(Data,begDate,endDate);
      end;

      if( (OperType == SC_OPER_NOMCHANG) or (OperType == -1) )
         CollectIN(Data,begDate,endDate);
      end;

      Message("Печать отчета по собственным сделкам");
      PrintDeals("Собственные сделки", Data, DEALTYPE_OWN, cDate); 
      Message("Печать отчета по брокерским сделкам", cDate);
      PrintDeals("Брокерские сделки", Data, DEALTYPE_BROKER, cDate); 
      Message("Печать отчета по сделкам доверительного управления", cDate);
      PrintDeals("Доверительное управление", Data, DEALTYPE_DU, cDate); 
      
      RemProgress;
   end;

   /*По всем филиалам*/
   macro ExecuteReportByAllDepartment(Data, OperType, cDate)
      var  Continue_cicle, Num = 0;
      file Department(dp_dep);

      InitProgress(NRecords(Department), "Отчет \"Субрегистр иных операций\"", 
                    "Просмотр сделок для филиалов");

      ClearRecord(Department);
      Department.Code = 0;
      Continue_cicle = GetGE(Department);
      while(Continue_cicle)
         if(Department.Code != {OperDprt}) /*Свой уже распечатан (первый при запуске)*/
            Data.DprtID = Department.Code;
            ExecuteReportByDepartment(Data, OperType, cDate);
         end;
         Continue_cicle = Next(Department);
         Num = Num + 1;
         UseProgress(Num);
      end;
      RemProgress;
   end;
   
   private macro Create()
      var noData = "В указанный период операций, соответствующих параметрам отчета, не совершалось.";
      
      var cDate = Data.dateMin;
      
      var oldDprtID = Data.DprtID;
      
      ClearGlobalTmp("dscdljr_tmp");

      Message("Выполнение отчета \"Субрегистр иных операций\" ...");

      if(Data.SplitByDates)
         while(cDate <= Data.dateMax)
            //PrintTableHead(Data, cDate);
            Data.PrintTableHead = false;
            if(Data.DprtID == -1) /* Не задан филиал, то сначала для себя, затем по всем 
                                  оставшимся филиалам */
              Data.DprtID = {OperDprt};
              ExecuteReportByDepartment(Data, Data.OperType, cDate);
              ExecuteReportByAllDepartment(Data, Data.OperType, cDate);
            else 
              ExecuteReportByDepartment(Data, Data.OperType, cDate);
            end;

            if(Data.PrintTableHead)
               EndCopyTable();
            end;
            
            Data.DprtID = oldDprtID;
            cDate = cDate + 1;
         end;
      else
         Data.PrintTableHead = false;
         if(Data.DprtID == -1) /* Не задан филиал, то сначала для себя, затем по всем 
                               оставшимся филиалам */
           Data.DprtID = {OperDprt};
           ExecuteReportByDepartment(Data, Data.OperType);
           ExecuteReportByAllDepartment(Data, Data.OperType);
         else 
           ExecuteReportByDepartment(Data, Data.OperType);
         end;

         if(Data.PrintTableHead)
            EndCopyTable();
         end;
      end;

      if(ReportRun)
         AddStandardFooter("N1_");
         CopyAllSheetInTotalBook(NULL, false, "N1_Footer", 1);
      else
         PrintFormatString(
            noData,
            "N1_NoData", noData
         );
         CopyAllSheetInTotalBook(NULL, false, "N1_NoData", 1);
      end;
   end;

   initDL_CReportTemplate(NULL, "Report_scsregop.xls");

end;

macro SubRegistrReport(DprtID:integer,
                     AvrTypeID: integer,
                     EmiID: integer,
                     AvrID: integer,
                     DealType: integer,
                     ClientID: integer,
                     IsFormID:integer,
                     FormSubID:integer,
                     IsVidID:integer,
                     VidSubID:integer,
                     NoResident:bool, 
                     DepositaryID: integer,
                     OperType: integer,
                     DealMarket:bool,
                     MarketID:integer,
                     DealNotMarket:bool,
                     DealBroker:bool,
                     BrokerID:integer,
                     dateMin: date,
                     dateMax: date,
                     SplitByDates:bool,
                     OperStatus:integer,
                     apostrSum: bool,
                     toExcel:bool)

   var errcode, errtext, TmpFName = GetWorkFileName("scdljr");
   var Data = SourceData(
         DprtID,
         AvrTypeID,
         EmiID,
         AvrID,
         DealType,
         ClientID,
         IsFormID,
         FormSubID,
         IsVidID,
         VidSubID,
         NoResident, 

         DepositaryID,
         OperType,
         DealMarket,
         MarketID,
         DealNotMarket,
         DealBroker,
         BrokerID,
         dateMin,
         dateMax,
         SplitByDates,
         OperStatus,
         apostrSum,
         toExcel
      );
   
   ScsRegop(Data).Run();

end;
