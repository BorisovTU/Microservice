/*
$Name:        nptxnkdreqdias_funcobj.mac
$Module:      Ценные бумаги
$Description: Выполнить обработку запросов УНКД по клиенту из Диасофта
*/
import "nptxnkdreqdiasrun.mac", "funcobj.mac";


macro ExecNKDReqDias_Funcobj(param0, param1, param2)
  var err = 0;
  var ErrStr = "";
  var ReturnObj = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
  var OldDialogFlag = SetDialogFlag(0);
  var query, cmd, DataSet;
  var reqDias_f = TBFile("nptxnkdreqdias.dbt");
  var N = ПериодОбработкиУНКД();

  query =   " select t_ID "
          + "   from dnptxnkdreqdias_dbt "
          + "  where t_PartyID = ? "
          + "    and (t_requestdate + (t_requesttime - trunc(t_requesttime))) >= TO_DATE(TO_CHAR(SYSDATE-?/(24*60), 'DD.MM.YYYY:HH24:MI:SS'), 'DD.MM.YYYY:HH24:MI:SS') "
          + "    and ( t_Status IN (" + NPTXNKDREQDIAS_STATUS_NEW + ", " + NPTXNKDREQDIAS_STATUS_WAITCONFIRM + ", " + NPTXNKDREQDIAS_STATUS_PROCESSING_ERROR + ")"
          + "          or (t_Status = "+NPTXNKDREQDIAS_STATUS_VALIDATION_ERROR+" and t_GUIDResp = CHR(1)) "
          + "        ) "
          + " order by t_RequestDate ASC, t_RequestTime ASC, t_ID ASC ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(param1);
  cmd.AddParam(N);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    reqDias_f.Clear();
    reqDias_f.rec.ID = int(DataSet.ID);

    if(not reqDias_f.GetEQ())
      msgbox("Не найдена запись с ID = " + DataSet.ID);
      return 1;
    else
      if((reqDias_f.rec.Status != NPTXNKDREQDIAS_STATUS_NEW) and (reqDias_f.rec.Status != NPTXNKDREQDIAS_STATUS_WAITCONFIRM) and (reqDias_f.rec.Status != NPTXNKDREQDIAS_STATUS_PROCESSING_ERROR) and
         (not ((reqDias_f.rec.Status == NPTXNKDREQDIAS_STATUS_VALIDATION_ERROR) AND (reqDias_f.rec.GUIDResp == ""))))
        continue;
      end;
    end;

    ExecNKDReqDias(reqDias_f.rec.ID, true);
  end;


  if((err != 0 ) OR (ErrStr != ""))
    ReturnObj.state = FUNCOBJ_RESULT_ERROR;
    ReturnObj.errorText = ErrStr;
    ReturnObj.errorCode = err;
  end;

  SetDialogFlag(OldDialogFlag);

  return ReturnObj;
end;

