/* Операция продажи ц/б     
   Вставка депозитарного поручения */

import InsCarryDoc, "sp_car.mac", "insdpdr.mac", "sp_car2.mac";

macro ExecuteStep( Doc, ticket, DocKind, OperationID )

  record deal(dl_tick);
  var    FD, dat, KindDate, NeedInsertDepoDraft = false, err = 0;

  SetBuff( deal, ticket );
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( not FD.CheckCliring( true ) ) 
     return 1;
  end;

  if( bAND( FD.dl_leg.rec.BitMask, DL_LEG_ANOTHER_DEPOSITARY ) )
     return 0; /*на лоте признак "учет в другом депозитарии", ничего не делаем*/
  end; 

  NeedInsertDepoDraft = НужноПредФормПоручДЕПО(FD, err);
  if (err > 0)
     return 1;
  end;

  if (not NeedInsertDepoDraft)
     MsgBox("Не требуется предварительное формирование поручения");
     return 1;
  end;

  if( FD.БылОтказОтИсполнения() == false ) /*не было отказа от сделки\2ч*/   
     if( FD.IsBack )
        KindDate = DATE_DEALINSDEPODRAFT_2;
     else 
        KindDate = DATE_DEALINSDEPODRAFT;
     end;

     GetOprDate( KindDate, dat );


//     if( not ВыполнитьФормированиеПорученийДепо( deal, FD.GetRQ(DLRQ_TYPE_DELIVERY), dat, false, true ) ) /* вставляем отложенное поручение депо */
//        return 1;
//     end;
  end; 

  /* Ф1 = "Завершить" */
  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D1, SP_OPERSTATUS_SECURDEALS_D1_FINISH) ) 
     msgbox( "Ошибка при установке статуса <Формирование поручения по 1 ч> операции" );
     return 1;
  end;

  return 0;
end;

