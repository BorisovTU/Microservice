/*
$Name:        update_pmgr_DEF-30316.mac
$Module:      ФИСС и КО
$Description: Скрипт исправления сумм промежуточных процентных платежей по сделкам IRS\CIRS рынка СПФИ
*/ 

import "dldlngfun.mac";
   
var query =  "SELECT pmgr.t_ID, pmgr.t_DealID, pmgr.t_PayDate, pmgr.t_PaymentSum, pmgr.t_Side, pmgr.t_FloatRateValue, "+
             "       acc.t_Account pmgr_account, rsb_account.restall(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ? ) accrest "+
             "  FROM ddvnpmgr_dbt pmgr, ddvndeal_dbt deal, daccount_dbt acc "+
             " WHERE pmgr.t_DealID = deal.t_ID AND deal.t_State = 1 AND pmgr.t_FloatRateValue <> 0 "+
             "   AND pmgr.t_PayDate >= ? and ((pmgr.t_LiabilityAccount = ACC.T_ACCOUNT and pmgr.t_Side = 1) or (pmgr.t_DemandAccount = ACC.T_ACCOUNT and pmgr.t_Side = 2)) "+
             "   AND  rsb_account.restall(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?) <> 0 "+
             "   AND  round(abs(rsb_account.restall(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?)), 2) <> pmgr.t_PaymentSum";

var cmd = Dl_RSDCommand(query);
cmd.addParam({curdate});
cmd.addParam({curdate});
cmd.addParam({curdate});
cmd.addParam({curdate});
[                 Исправление сумм промежуточных процентных платежей по сделкам IRS\CIRS рынка СПФИ
Дата выполнения: ##########
Время выполнения: ######## 
]({curdate},  time());
var Num = cmd.GetCount;
if(Num > 0)
  [
  ┌──────────┬──────────┬─────────────────────┬─────────────┬────────────────────┬────────────────────┬─────────────────────┬────────────────────┐
  │ № сделки │  Дата    │   Старое значение   │ Направление │ Значение плавающей │   Лицевой счёт     │    Сумма остатка    │   Новое значение   │
  │          │ платежа  │    суммы платежа    │   платежа   │       ставки       │                    │                     │   суммы платежа    │
  ├──────────┼──────────┼─────────────────────┼─────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┤
  ];
  InitProgress( Num, "Исправление сумм промежуточных процентных платежей", "Обработка..." );
  var ds = cmd.execute();
  var i = 0;
  while(ds.movenext())
    [│##########│##########│#####################│#############│####################│####################│#####################│####################│
    ]( ds.DealID,
      date(ds.PayDate),
      ds.PaymentSum,
      IIF(ds.Side == 1, "обязательство", "требование"),
      ds.FloatRateValue,
      ds.pmgr_account,
      ds.accrest,
      abs(ds.accrest)
     );
     UseProgress(i);
     i = i + 1;
  end;
  [└──────────┴──────────┴─────────────────────┴─────────────┴────────────────────┴────────────────────┴─────────────────────┴────────────────────┘
  ];
  var query_upd = " MERGE INTO ddvnpmgr_dbt pmgr_dem "+
                  " USING ( "+ query+" ) subq "+
                  " ON ( pmgr_dem.t_id = subq.t_id ) "+
                  " WHEN MATCHED THEN UPDATE SET "+ 
                  " pmgr_dem.t_LiabilitySum = DECODE (subq.t_Side, 1,  abs(subq.accrest), 2, 0 ), "+
                  " pmgr_dem.t_DemandSum    = DECODE (subq.t_Side, 1, 0 , 2, abs(subq.accrest) ), "+
                  " pmgr_dem.t_PaymentSum   = abs(subq.accrest) ";

  var cmd_upd = RSDCommand(query_upd);
  cmd_upd.addParam("", RSDBP_IN,{curdate});
  cmd_upd.addParam("", RSDBP_IN,{curdate});
  cmd_upd.addParam("", RSDBP_IN,{curdate});
  cmd_upd.addParam("", RSDBP_IN,{curdate});
  cmd_upd.execute();
else
  [Не найдено подходящих платежей для корректировки]
end;