/*******************************************************************************
 DESCRIPTION  :   Обновление 2027->2028 (302-П)
                  Процедура удаления сделок
 PROGRAMMED BY:   Иванов А.И.
 CREATION DATE:   26 November 2007 
*******************************************************************************/
import BankInter, "DlRepForm_h.mac", "globals.mac", "cb_sql.mac", "secinter.mac", "spserv.mac", "conv_tax_c.mac";
import DealsInter, OprInter, SecInter, RsbDataSet, "spserv.mac", "sp_class.mac", "sprepfun.mac";

PRIVATE MACRO FormError( StrErr:STRING, err, command:RSDCommand ):STRING
  VAR i = 0;
  StrErr = "!!! " + StrErr + "\nСтрока: " + string(err.line) + "  " + err.message + "\n";
  if( command != NULL )
     while( i < command.connection.environment.ErrorCount )
         StrErr = StrErr + command.connection.environment.Error(i).Descr + "\n";
         i = i + 1;
     end;
  end;
  return StrErr;
OnError
  return StrErr;
end;

PRIVATE VAR FormData;
/*Номера полей в форме */
CONST PNFLD_DELDEAL_DATE         = 0,
      PNFLD_DELDEAL_FLAG_1       = 1,
      PNFLD_DELDEAL_FLAG_11      = 2,
      PNFLD_DELDEAL_FLAG_12      = 3,
      PNFLD_DELDEAL_FLAG_13      = 4,
      PNFLD_DELDEAL_FLAG_2       = 5,
      PNFLD_DELDEAL_FLAG_21      = 6,
      PNFLD_DELDEAL_FLAG_3       = 7,
      PNFLD_DELDEAL_FLAG_31      = 8,
      PNFLD_DELDEAL_FLAG_32      = 9,
      PNFLD_DELDEAL_FLAG_4       = 10,
      PNFLD_DELDEAL_FLAG_5       = 11,
      PNFLD_DELDEAL_FLAG_51      = 12,
      PNFLD_DELDEAL_FLAG_52      = 13,
      PNFLD_DELDEAL_FLAG_6       = 14,
      PNFLD_DELDEAL_FLAG_7       = 15,
      PNFLD_DELDEAL_FLAG_REPORT  = 16;

PRIVATE MACRO FldProc_Flag1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR RetVal = DL_FldProc_CheckBox( pThis, Cmd, Key, @FldShowValue, @FldRealValue );

  if( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
     if( FldRealValue == "X" ) 
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_11 );
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_12 );
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_13 );
     else 
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_11 );
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_12 );
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_13 );
        pThis.Data.rec.Flag11 = "";
        pThis.Data.rec.Flag12 = "";
        pThis.Data.rec.Flag13 = "";
     end;
  end;
  return RetVal;
END;

PRIVATE MACRO FldProc_Flag2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR RetVal = DL_FldProc_CheckBox( pThis, Cmd, Key, @FldShowValue, @FldRealValue );

  if( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
     if( FldRealValue == "X" ) 
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_21 );
     else 
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_21 );
        pThis.Data.rec.Flag21 = "";
     end;
  end;
  return RetVal;
END;

PRIVATE MACRO FldProc_Flag3( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR RetVal = DL_FldProc_CheckBox( pThis, Cmd, Key, @FldShowValue, @FldRealValue );

  if( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
     if( FldRealValue == "X" ) 
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_31 );
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_32 );
     else 
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_31 );
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_32 );
        pThis.Data.rec.Flag31 = "";
        pThis.Data.rec.Flag32 = "";
     end;
  end;
  return RetVal;
END;

PRIVATE MACRO FldProc_Flag5( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR RetVal = DL_FldProc_CheckBox( pThis, Cmd, Key, @FldShowValue, @FldRealValue );

  if( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
     if( FldRealValue == "X" ) 
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_51 );
        EnableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_52 );
     else 
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_51 );
        DisableFields( pThis.Data(), PNFLD_DELDEAL_FLAG_52 );
        pThis.Data.rec.Flag51 = "";
        pThis.Data.rec.Flag52 = "";
     end;
  end;
  return RetVal;
END;


PRIVATE CLASS (DL_CPanel) SP_DeleteDeals_Form()

  PRIVATE MACRO Init()
     AddFieldProc( 0, PNFLD_DELDEAL_DATE,        DL_PNFLD_BEGINDATE, @DL_FldProc_BeginDate, GetDateAfterWorkDays( DATE(1,1,2008), 0 ) );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_1,      DL_PNFLD_CHECKBOX,  @FldProc_Flag1,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_11,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_12,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_13,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_2,      DL_PNFLD_CHECKBOX,  @FldProc_Flag2,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_21,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_3,      DL_PNFLD_CHECKBOX,  @FldProc_Flag3,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_31,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_32,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_4,      DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_5,      DL_PNFLD_CHECKBOX,  @FldProc_Flag5,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_51,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_52,     DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_6,      DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_7,      DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
     AddFieldProc( 0, PNFLD_DELDEAL_FLAG_REPORT, DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox,  "X" );
  END;

  PRIVATE MACRO Check():BOOL

     return true;
  END;

  initDL_CPanel( "sp_conv.lbr", "pdeldeal" ); 
END;

PRIVATE CLASS SP_DeleteDeals

   MACRO BeginReport()

[
                 Процедура выгрузки данных   
Дата: ##########   
Удалять сделки и операции погашения: #  
   - Оставлять открытые покупки/продажи:    #  
   - Оставлять открытые Репо и ОП:          #  
   - Оставлять закрытые сделки по лотам НУ: #  
Удалять сервисные операции: #  
   -  Оставлять локальные перемещения по непроданным лотам: #  
Удалять шаги и операции: #   
   - Оставлять по открытым покупкам/продажам: #  
   - Оставлять по открытым Репо и ОП:         #   
Удалять связи и историю лотов: #   
Удалять проводки: #   
   - По удаляемым операциям: #  
   - По закрытым операциям:  #   
Удалять закрытые выпуски ц/б: #   
Удалить счета по удаляемым КУ и шаблонам: #  
](           
  FormData.OperDate,  
  IIF( FormData.Flag1  == "X", "Да", "Нет"),  
  IIF( FormData.Flag11  == "X", "Да", "Нет"),  
  IIF( FormData.Flag12  == "X", "Да", "Нет"),  
  IIF( FormData.Flag13  == "X", "Да", "Нет"),  
  IIF( FormData.Flag2 == "X", "Да", "Нет"),  
  IIF( FormData.Flag21 == "X", "Да", "Нет"),  
  IIF( FormData.Flag3  == "X", "Да", "Нет"),  
  IIF( FormData.Flag31 == "X", "Да", "Нет"),
  IIF( FormData.Flag32 == "X", "Да", "Нет"),
  IIF( FormData.Flag4  == "X", "Да", "Нет"),  
  IIF( FormData.Flag5  == "X", "Да", "Нет"),  
  IIF( FormData.Flag51  == "X", "Да", "Нет"),  
  IIF( FormData.Flag52  == "X", "Да", "Нет"),  
  IIF( FormData.Flag6  == "X", "Да", "Нет"),  
  IIF( FormData.Flag7  == "X", "Да", "Нет")
);

     if( FormData.CreateReport == "X" )
[┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
 │                                       Отчет о выполнении                                                        │];
     end;
  END;

  PRIVATE MACRO PrintMessage( Mes:STRING, NoShowTime:BOOL, ShowDate:BOOL )

     if( (NoShowTime == NULL) OR (NoShowTime == false) )
        Mes = string(Time()) + "  " + Mes;
     end;

     if( (ShowDate != NULL) AND (ShowDate == true) )
        Mes = string(Date()) + " " + Mes;
     end;

     if( FormData.CreateReport == "X" )
[├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
 │################################################################################################################ │
]( Mes:w);
     end;
  END;

  MACRO EndReport()
     if( FormData.CreateReport == "X" )
[└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘];
     end;
  END;

  PRIVATE MACRO DeleteRecords( Table:STRING, Alias:STRING, WhereKeep:STRING )
    var RS, cmd, 
        TmpTable = trim(Table)+"_del_tmp";

    PrintMessage( "  Удаление из " + Table );     
    InitProgress( -1, "Удаление из " + Table, "Удаление из " + Table );

    cmd = RSDCommand("declare "+
                     "  e_no_fmt     exception; "+
                     "  pragma exception_init (e_no_fmt, -20002); "+
                     "  e_no_trigger exception; "+
                     "  pragma exception_init (e_no_trigger, -4080); "+
                     " begin "+
                     "  rsb_ainc.disable_trigger('"+Table+"'); "+
                     " exception "+
                     "  when e_no_trigger then "+
                     "    null; "+
                     "  when e_no_fmt then "+
                     "    null; "+
                     " end;");
    cmd.Execute();

    cmd = RSDCommand("DECLARE "+
                     "    E_OBJECT_NOT_EXISTS EXCEPTION; "+
                     "    PRAGMA EXCEPTION_INIT( E_OBJECT_NOT_EXISTS, -942); "+
                     "BEGIN "+
                     "    EXECUTE IMMEDIATE 'DROP TABLE "+TmpTable+"'; "+
                     "EXCEPTION  "+
                     "    WHEN E_OBJECT_NOT_EXISTS THEN NULL; "+
                     "END; ");
    cmd.Execute();

    cmd = RSDCommand("DECLARE \n"
                  +  " v_err EXCEPTION; \n"
                  +  " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
                  + " BEGIN EXECUTE IMMEDIATE 'CREATE TABLE "+TmpTable+" AS (SELECT * FROM "+ Table + "  "+ IIF(Alias==null,"",Alias)+" Where " + WhereKeep + " )';"
                  + " EXCEPTION WHEN v_err THEN NULL; \n"
                  + " END; \n");
    cmd.Execute();

    cmd = RSDCommand("TRUNCATE TABLE "+Table );
    cmd.Execute();

    cmd = RSDCommand(" Insert into "+ Table +" SELECT * FROM "+TmpTable);
    cmd.Execute();

    cmd = RSDCommand("declare "+
                     "  e_no_fmt     exception; "+
                     "  pragma exception_init (e_no_fmt, -20002); "+
                     "  e_no_trigger exception; "+
                     "  pragma exception_init (e_no_trigger, -4080); "+
                     " begin "+
                     "   rsb_ainc.enable_trigger('"+Table+"'); "+
                     " exception "+
                     "  when e_no_trigger then "+
                     "    null; "+
                     "  when e_no_fmt then "+
                     "    null; "+
                     " end;");
    cmd.Execute();

    RemProgress();

  OnError(err);
    RemProgress();
    PrintMessage( FormError(Table, err, cmd) );
  END;

/*----------------------------------------------------------------------------------------------------------------------------------*/
  PRIVATE MACRO DeleteExistSfBasObj()
    var cmd = RSDCommand(" delete from dsfbasobj_dbt sf " + 
                         "       where     sf.t_BaseObjectType in (101,117,127) " +
                         "             and not exists (select t_DealID from ddl_tick_dbt where t_DealCode = sf.t_BaseObjectID AND t_BofficeKind = sf.t_BaseObjectType) ");
     cmd.Execute();
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteProxyByDeal()
    var cmd = RSDCommand(" delete from ddl_proxy_dbt proxy " + 
                         "       where proxy.t_DocKind      = ? AND "+
                         "             NOT EXISTS (SELECT t_ID "+
                         "                            from ddl_leg_dbt leg"+
                         "                           where     leg.t_ID = proxy.t_ContractID "+
                         "                                 AND (leg.t_LegKind = ? OR leg.t_LegKind = ?) "+
                         "                         ) " );
     cmd.addParam( "", RSDBP_IN, DL_SECURLEG );
     cmd.addParam( "", RSDBP_IN, LEG_KIND_DL_TICK );
     cmd.addParam( "", RSDBP_IN, LEG_KIND_DL_TICK_BACK );

     Message( "Удаление из ddl_proxy_dbt" );
     cmd.Execute();
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteDLLEG()
/*
    var DS,cmd;
     cmd = RSDCommand(" delete from ddl_leg_dbt leg " + 
                      "       where (    leg.t_LegKind = ?  " +
                      "               OR leg.t_LegKind = ?) " +
                      "             and NOT EXISTS (SELECT t_DealID from ddl_tick_dbt WHERE t_bofficeKind in (101,117,127) AND t_DealID = leg.t_DealID) ");
     cmd.addParam( "", RSDBP_IN, LEG_KIND_DL_TICK );
     cmd.addParam( "", RSDBP_IN, LEG_KIND_DL_TICK_BACK );
     Message( "Удаление из ddl_leg_dbt" );
     cmd.Execute();
*/
     DeleteRecords( "ddl_leg_dbt", "leg",
                    " (   leg.t_LegKind != " + string(LEG_KIND_DL_TICK) +
                    " AND leg.t_LegKind != " + string(LEG_KIND_DL_TICK_BACK) + ") " +
                    " OR EXISTS (SELECT t_DealID from ddl_tick_dbt WHERE t_bofficeKind in (101,117,127) AND t_DealID = leg.t_DealID)");
     DeleteProxyByDeal();

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;
  
  PRIVATE MACRO DeleteWRTSUM()
/*
    var cmd = RSDCommand(" delete from dpmwrtsum_dbt pws " + 
                         "   where     pws.t_Amount = 0  " + 
                         "          and t_DealID > 0 " + 
                         "          and NOT EXISTS (SELECT t_DealID from ddl_tick_dbt WHERE t_bofficeKind in (101,117,127) AND t_DealID = pws.t_DealID) ");
     cmd.Execute();
     Message( "Удаление из dpmwrtsum_dbt" );
*/
     DeleteRecords( "dpmwrtsum_dbt", "pws",
                         "      pws.t_Amount != 0  " + 
                         "  OR pws.t_DealID <= 0 " + 
                         "  OR EXISTS (SELECT t_DealID from ddl_tick_dbt WHERE t_bofficeKind in (101,117,127) AND t_DealID = pws.t_DealID) ");
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteWRTBC()
    /*удалить все WRTBC по удаленным лотам*/
/*
    var cmd = RSDCommand(" delete from dpmwrtbc_dbt pwbc " + 
                    "       where NOT EXISTS (SELECT t_DocKind "+
                    "                           from dpmwrtsum_dbt "+
                    "                          where     t_DocID   = pwbc.t_DocID" +
                    "                                and t_DocKind = pwbc.t_DocKind" +
                    "                                and t_PartNum = pwbc.t_PartNum"+
                    "                                and t_Buy_Sale = pwbc.t_Buy_Sale) ");

     cmd.Execute();
     Message( "Удаление из dpmwrtbc_dbt" );
*/
     DeleteRecords( "dpmwrtbc_dbt", " pwbc ",
                    " EXISTS (SELECT t_DocKind "+
                    "              from dpmwrtsum_dbt "+
                    "             where     t_DocID   = pwbc.t_DocID" +
                    "                   and t_DocKind = pwbc.t_DocKind" +
                    "                   and t_PartNum = pwbc.t_PartNum"+
                    "                   and t_Buy_Sale = pwbc.t_Buy_Sale) ");
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteWRTLNK()
     /*Удалить все линки, по удаленным лотам продажи*/
/*
     var cmd = RSDCommand(" delete from dpmwrtlnk_dbt pwlnk " + 
                      "       where NOT EXISTS (SELECT t_DocKind "+
                      "                           from dpmwrtsum_dbt "+
                      "                          where      t_DocID   = pwlnk.t_DocIDSale " +
                      "                                 and t_DocKind = pwlnk.t_DocKindSale " +
                      "                                 and t_Buy_Sale in (1,2,3) " +
                      "                                 and t_PartNum = pwlnk.t_PartNumSale "+
                      "                        ) OR"
                      "             NOT EXISTS (SELECT t_DocKind "+
                      "                           from dpmwrtsum_dbt "+
                      "                          where      t_DocID   = pwlnk.t_DocIDBuy " +
                      "                                 and t_Buy_Sale = 0 " +
                      "                                 and t_DocKind = pwlnk.t_DocKindBuy " +
                      "                                 and t_PartNum = pwlnk.t_PartNumBuy) ");

     cmd.Execute();
     Message( "Удаление из dpmwrtlnk_dbt" );
*/
     DeleteRecords( "dpmwrtlnk_dbt", "pwlnk",
                      " EXISTS (SELECT t_DocKind "+
                      "              from dpmwrtsum_dbt "+
                      "             where      t_DocID   = pwlnk.t_DocIDSale " +
                      "                    and t_DocKind = pwlnk.t_DocKindSale " +
                      "                    and t_Buy_Sale in (1,2,3) " +
                      "                    and t_PartNum = pwlnk.t_PartNumSale "+
                      "           ) AND "+
                      " EXISTS (SELECT t_DocKind "+
                      "              from dpmwrtsum_dbt "+
                      "             where      t_DocID   = pwlnk.t_DocIDBuy " +
                      "                    and t_Buy_Sale = 0 " +
                      "                    and t_DocKind = pwlnk.t_DocKindBuy " +
                      "                    and t_PartNum = pwlnk.t_PartNumBuy) ");

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  /*если pmwrtsum.Amount > 0 а сделку убили*/
  PRIVATE MACRO UpdateDealLink()
    var cmd = RSDCommand(" update dpmwrtsum_dbt wrtsum set wrtsum.t_DealID = 0 " + 
                    "       where NOT EXISTS (SELECT t_DealID "+
                    "                           from ddl_tick_dbt tick "+
                    "                          where tick.t_DealID   = wrtsum.t_DealID)" );
     cmd.Execute();
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;
  
  PRIVATE MACRO DeletePMDOCS()
/*
    var cmd = RSDCommand(" delete from dpmdocs_dbt docs " + 
                         "       where NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = docs.t_PaymentID )");
     Message( "Удаление из dpmdocs_dbt" );
     cmd.Execute();
*/
    DeleteRecords( "dpmdocs_dbt", "docs", "EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = docs.t_PaymentID )");

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteDOCSIGN()
/*
    var cmd = RSDCommand(" delete from dsgnamark_dbt dsgn"+
                         "       where dsgn.t_dockind= ? and NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = dsgn.t_docid )");

     cmd.addParam( "", RSDBP_IN, DLDOC_PAYMENT );
     Message( "Удаление из dsgnamark_dbt" );
     cmd.Execute();
*/
    DeleteRecords( "dsgnamark_dbt", "dsgn", "dsgn.t_dockind != "+string(DLDOC_PAYMENT)+" OR EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = dsgn.t_docid)");

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeletePMHIST()
/*
    var cmd = RSDCommand(" delete from dpmhist_dbt hist " + 
                         "       where NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = hist.t_PaymentID )");
     Message( "Удаление из dpmhist_dbt" );
     cmd.Execute();
*/
    DeleteRecords( "dpmhist_dbt", "hist", " EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = hist.t_PaymentID )");

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeletePaymProps()
/*
     VAR cmd;
     cmd = RSDCommand("delete from dpmprop_dbt prop"+
                      "       where NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = prop.t_PaymentID )");
     Message( "Удаление из dpmprop_dbt" );
     cmd.Execute();
*/
      DeleteRecords( "dpmprop_dbt", "prop", "EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = prop.t_PaymentID )");
/*
     cmd = RSDCommand("delete from dpmrmprop_dbt prop"+
                      "       where NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = prop.t_PaymentID )");
     Message( "Удаление из dpmrmprop_dbt" );
     cmd.Execute();
*/
      DeleteRecords( "dpmrmprop_dbt", "prop", "EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = prop.t_PaymentID )");

  END;

  PRIVATE MACRO DeletePM_PAYM()
/*
    var cmd = RSDCommand("delete from dpmpaym_dbt pm"
                      "      where     pm.t_DocKind    in (101,117,127) " +
                      "            and NOT EXISTS (select t_DealID from ddl_tick_dbt tick where tick.t_BofficeKind = pm.t_DocKind AND tick.t_DealID = pm.t_DocumentID )");
    Message( "Удаление из dpmpaym_dbt" );
    cmd.Execute();
*/
    DeleteRecords( "dpmpaym_dbt", "pm", 
                      "    pm.t_DocKind    not in (101,117,127) " +
                      "OR EXISTS (select t_DealID from ddl_tick_dbt tick where tick.t_BofficeKind = pm.t_DocKind AND tick.t_DealID = pm.t_DocumentID )");

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteNOTETEXT()
    var cmd;

    Message( "Удаление из dnotetext_dbt" );
    cmd = RSDCommand(" delete from dnotetext_dbt note " + 
                         "       where     note.t_ObjectType = 501/*OBJTYPE_PAYMENT*/ " +
                         "       and NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = note.t_DocumentID )");
    cmd.Execute();

    cmd = RSDCommand(" delete from dnotetext_dbt note " + 
                         "       where     note.t_ObjectType in (101,117,127) " +
                         "       and NOT EXISTS (select t_DealID from ddl_tick_dbt deal where deal.t_BOfficeKind = note.t_ObjectType AND deal.t_DealID = note.t_DocumentID )");
    cmd.Execute();

    cmd = RSDCommand(" delete from dnotetext_dbt note " + 
                         "       where     note.t_ObjectType = 12/*OBJTYPE_AVOIRISS*/ " +
                         "       and NOT EXISTS (select t_FIID from dfininstr_dbt fi where fi.t_FIID = note.t_DocumentID )");
    cmd.Execute();
/*
    DeleteRecords( "dnotetext_dbt", "note", 
                   "     note.t_ObjectType = 501/*OBJTYPE_PAYMENT*/ " +
                   " and NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = note.t_DocumentID )");

    DeleteRecords( "dnotetext_dbt", "note", 
                   "     note.t_ObjectType in (101,117,127) " +
                   " and NOT EXISTS (select t_DealID from ddl_tick_dbt deal where deal.t_BOfficeKind = note.t_ObjectType AND deal.t_DealID = note.t_DocumentID )");

    DeleteRecords( "dnotetext_dbt", "note", 
                   "     note.t_ObjectType = 12/*OBJTYPE_AVOIRISS*/ " +
                   " and NOT EXISTS (select t_FIID from dfininstr_dbt fi where fi.t_FIID = note.t_DocumentID )");
*/
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteAttribute()
    VAR cmd;

    Message( "Удаление из dobjatcor_dbt" );
    cmd = RSDCommand(" delete from dobjatcor_dbt objatcor " + 
                         "       where     objatcor.t_ObjectType = 501/*OBJTYPE_PAYMENT*/ " +
                         "       and NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = objatcor.t_Object )");
    cmd.Execute();

    cmd = RSDCommand(" delete from dobjatcor_dbt objatcor " + 
                         "       where     objatcor.t_ObjectType in (101,117,127) " +
                         "       and NOT EXISTS (select t_DealID from ddl_tick_dbt deal where deal.t_BOfficeKind = objatcor.t_ObjectType AND deal.t_DealID = objatcor.t_Object )");
    cmd.Execute();

    cmd = RSDCommand(" delete from dobjatcor_dbt objatcor " + 
                         "       where     objatcor.t_ObjectType = 12/*OBJTYPE_AVOIRISS*/ " +
                         "       and NOT EXISTS (select t_FIID from dfininstr_dbt fi where fi.t_FIID = objatcor.t_Object )");
    cmd.Execute();
/*
    DeleteRecords( "dobjatcor_dbt", "objatcor", 
                         "     objatcor.t_ObjectType = 501/*OBJTYPE_PAYMENT*/ " +
                         " and NOT EXISTS (select t_PaymentID from dpmpaym_dbt pm where pm.t_PaymentID = objatcor.t_Object )");

    DeleteRecords( "dobjatcor_dbt", "objatcor", 
                         "     objatcor.t_ObjectType in (101,117,127) " +
                         " and NOT EXISTS (select t_DealID from ddl_tick_dbt deal where deal.t_BOfficeKind = objatcor.t_ObjectType AND deal.t_DealID = objatcor.t_Object )");
    DeleteRecords( "dobjatcor_dbt", "objatcor", 
                         "     objatcor.t_ObjectType = 12/*OBJTYPE_AVOIRISS*/ " +
                         " and NOT EXISTS (select t_FIID from dfininstr_dbt fi where fi.t_FIID = objatcor.t_Object )");
*/
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteSPGRDOC()
    var cmd;
/*
    var cmd = RSDCommand(" delete from dspgrdoc_dbt spgr " + 
                         "       where     spgr.t_SourceDocKind in (101,117,127) " +
                         "             and NOT EXISTS (SELECT t_DealID from ddl_tick_dbt WHERE t_bofficeKind = spgr.t_SourceDocKind AND t_DealID = spgr.t_SourceDocID) ");
    Message( "Удаление из dspgrdoc_dbt" );
    cmd.Execute();
*/
    cmd = RSDCommand(" update dspground_dbt spgr " + 
                     "    set spgr.t_references = spgr.t_references - (SELECT count(1) from dspgrdoc_dbt grd WHERE spgr.T_SPGROUNDID = grd.T_SPGROUNDID AND grd.t_SourceDocKind in (101,117,127) AND NOT EXISTS (SELECT t_DealID from ddl_tick_dbt WHERE t_bofficeKind = grd.t_SourceDocKind AND t_DealID = grd.t_SourceDocID))"
                    );
    cmd.Execute();

    DeleteRecords( "dspgrdoc_dbt", "spgr",
                   "     spgr.t_SourceDocKind not in (101,117,127) " +
                   " OR EXISTS (SELECT t_DealID from ddl_tick_dbt WHERE t_bofficeKind = spgr.t_SourceDocKind AND t_DealID = spgr.t_SourceDocID) ");

    Message( "Удаление из dspground_dbt" );
    cmd = RSDCommand(" delete from dspground_dbt spgr " + 
                     "  where     spgr.t_SourceDocKind in (101,117,127) " +
                     "        and (SELECT count(1) FROM scdropoper_buf WHERE t_type = 0 and spgr.t_SourceDocID = t_ObjectID) > 0");
    cmd.Execute();

    cmd = RSDCommand(" delete from dspground_dbt spgr " + 
                     "  where spgr.t_SourceDocKind <= 0 AND t_References <= 0");
    cmd.Execute();

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteDeal( tick, ObjectID, OGroup )
    var cmd;

    if( tick.rec.DealStatus == 10 )
       if( (FormData.Flag12 == "X") and 
           ( (IsREPO(OGroup) == true) OR
             (IsBACKSALE(OGroup) == true)
           )
         ) 
          return;
       end;

       if( (FormData.Flag11 == "X") and 
           ( ( (IsBUY(OGroup) == true) or
               (IsSALE(OGroup) == true) ) and
             (IsREPO(OGroup) != true) and
             (IsBACKSALE(OGroup) != true)
           ) OR
           (tick.rec.BofficeKind == DL_INVESTSHARE) /*получения паев*/
         ) 
          return;
       end;
    end;

    if( (FormData.Flag13 == "X") and 
        ChechExistsTaxLots( "sclotintax_buf", tick.rec.DealID )
      )
       return;
    end;

    cmd = RSDCommand(" Insert into scdropoper_buf(t_Type, t_ObjectID, t_CheckAmount) VALUES( ?, ?, ? )");
    cmd.addParam( "", RSDBP_IN, 0 );
    cmd.addParam( "", RSDBP_IN, tick.rec.DealID );
    if( (tick.rec.DealStatus == 20) AND (IsREPO(OGroup) OR IsBACKSALE(OGroup) OR IsBUY(OGroup) OR IsAVRWRTIN(OGroup)) )
       cmd.addParam( "", RSDBP_IN, 1 );
    else
       cmd.addParam( "", RSDBP_IN, 0 );
    end;
    cmd.Execute();
    PrintMessage( "Удалена сделка с кодом \""+tick.rec.DealCode+"\"", true );     

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteOPRSTEP()
/*
    var cmd = RSDCommand(" delete from doprstep_dbt " + 
                         "       where t_ID_Operation in (select t_ObjectID from scdropoper_buf where t_Type = 1) ");
     Message( "Удаление из doprstep_dbt" );
     cmd.Execute();
*/
    DeleteRecords( "doprstep_dbt", null, 
                   "t_ID_Operation IN ((SELECT t_id_operation from doproper_dbt) MINUS (SELECT t_objectid FROM scdropoper_buf WHERE t_type = 1))" );

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DropDeal()
     VAR cmd;

     Message( "Удаление из ddl_tick_dbt" );

     cmd = RSDCommand(" delete from scdropoper_buf buf " + 
                         "       where buf.t_Type = 0 AND buf.t_CheckAmount = 1 AND "+
                      " NVL( (select SUM(ws.t_Amount) from dpmwrtsum_dbt ws where ws.t_DealID = buf.t_ObjectID and ws.t_Buy_Sale = 0 ),0) > 0 ");
     cmd.Execute();
/*
     cmd = RSDCommand(" delete from ddl_tick_dbt " + 
                         "       where t_DealID in (select t_ObjectID from scdropoper_buf where t_Type = 0) ");
     cmd.Execute();
*/
     DeleteRecords( "ddl_tick_dbt", null, "t_DealID in ((select t_DealId from ddl_tick_dbt) minus (select t_ObjectID from scdropoper_buf where t_Type = 0))" );

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteOPROPER()
/*
     VAR cmd = RSDCommand(" delete from doproper_dbt " + 
                         "       where t_ID_Operation in (select t_ObjectID from scdropoper_buf where t_Type = 1) ");
     Message( "Удаление из doproper_dbt" );
     cmd.Execute();
*/
    DeleteRecords( "doproper_dbt", null, "t_ID_Operation IN ((SELECT t_id_operation from doproper_dbt) MINUS (SELECT t_objectid FROM scdropoper_buf WHERE t_type = 1))" );

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteOPRDATES()
/*
    var cmd = RSDCommand(" delete from doprdates_dbt " + 
                         "       where t_ID_Operation in (select t_ObjectID from scdropoper_buf where t_Type = 1) ");
     Message( "Удаление из doprdates_dbt" );
     cmd.Execute();
*/
//     DeleteRecords( "doprdates_dbt", null, "t_ID_Operation not in (select t_ObjectID from scdropoper_buf where t_Type = 1)" );
     DeleteRecords( "doprdates_dbt", null, "t_ID_Operation IN ((SELECT t_id_operation from doproper_dbt) MINUS (SELECT t_objectid FROM scdropoper_buf WHERE t_type = 1))" );
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteOPRCURST()
/*
    var cmd = RSDCommand(" delete from doprcurst_dbt " + 
                         "       where t_ID_Operation in (select t_ObjectID from scdropoper_buf where t_Type = 1) ");
     Message( "Удаление из doprcurst_dbt" );
     cmd.Execute();
*/
     DeleteRecords( "doprcurst_dbt", null, "t_ID_Operation IN ((SELECT t_id_operation from doproper_dbt) MINUS (SELECT t_objectid FROM scdropoper_buf WHERE t_type = 1))" );
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteOPRDOCS()
/*
    var cmd = RSDCommand(" delete from doprdocs_dbt " + 
                         "       where t_ID_Operation in (select t_ObjectID from scdropoper_buf where t_Type = 1) ");
     Message( "Удаление из doprdocs_dbt" );
     cmd.Execute();
*/
     DeleteRecords( "doprdocs_dbt", null, "t_ID_Operation IN ((SELECT t_id_operation from doproper_dbt) MINUS (SELECT t_objectid FROM scdropoper_buf WHERE t_type = 1))" );
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteOPRSFCOM()
/*
    var cmd = RSDCommand(" delete from doprsfcom_dbt " + 
                         "       where t_ID_Operation in (select t_ObjectID from scdropoper_buf where t_Type = 1) ");
     Message( "Удаление из doprsfcom_dbt" );
     cmd.Execute();
*/
     DeleteRecords( "doprsfcom_dbt", null, "t_ID_Operation IN ((SELECT t_id_operation from doproper_dbt) MINUS (SELECT t_objectid FROM scdropoper_buf WHERE t_type = 1))" );
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteOPRSTHIST()
/*
    var cmd = RSDCommand(" delete from doprsthist_dbt " + 
                         "       where t_ID_Operation in (select t_ObjectID from scdropoper_buf where t_Type = 1) ");
     Message( "Удаление из doprsthist_dbt" );
     cmd.Execute();
*/
     DeleteRecords( "doprsthist_dbt", null, "t_ID_Operation IN ((SELECT t_id_operation from doproper_dbt) MINUS (SELECT t_objectid FROM scdropoper_buf WHERE t_type = 1))" );

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO DeleteCARRY()
    var DS, cmdDel;
/*
     Message( "Удаление проводок" );
     cmdDel = RSDCommand(" delete from darhdoc_dbt " + 
                         "  where LTRIM(TO_CHAR(t_iApplicationKind,'00000')||TO_CHAR(t_ApplicationKey)) in ( select t_DocumentID " +
                         "                                                                                     from doprdocs_dbt " +
                         "                                                                                    where t_ID_Operation = ? " );
     cmdDel.addParam( "", RSDBP_IN, ID_Operation );

     cmdDel.Execute();

     cmdDel = RSDCommand(" delete from darhdoc$_dbt " + 
                         "  where LTRIM(TO_CHAR(t_iApplicationKind,'00000')||TO_CHAR(t_ApplicationKey)) in ( select t_DocumentID " +
                         "                                                                                     from doprdocs_dbt " +
                         "                                                                                    where t_ID_Operation = ? " );
     cmdDel.addParam( "", RSDBP_IN, ID_Operation );

     cmdDel.Execute();
     PrintMessage( "Удалены проводки операции для сделки с кодом \""+tick.rec.DealCode+"\"" );     
*/
    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;


  PRIVATE MACRO DeleteOperation( tick, OGroup, ID_Operation )
     var cmd;
     if( tick.rec.DealStatus == 10 )     

        /* Оставлять по открытым Репо и ОП.*/
        if( (FormData.Flag32 == "X") and 
            ( (IsREPO(OGroup) == true) OR
              (IsBACKSALE(OGroup) == true)
            )
          ) 
           return;
        end;

        /* Оставлять по открытым покупкам/продажам*/
        if( (FormData.Flag31 == "X") and 
           ( ( (IsBUY(OGroup) == true) or
               (IsSALE(OGroup) == true) ) and
             (IsREPO(OGroup) != true) and
             (IsBACKSALE(OGroup) != true)
           ) OR
           (tick.rec.BofficeKind == DL_INVESTSHARE) /*получения паев*/
          ) 
           return;
        end;

     end;

     cmd = RSDCommand(" Insert into scdropoper_buf(t_Type, t_ObjectID, t_CheckAmount) VALUES( ?, ?, ? )");
     cmd.addParam( "", RSDBP_IN, 1 );
     cmd.addParam( "", RSDBP_IN, ID_Operation );
     cmd.addParam( "", RSDBP_IN, 0 );
     cmd.Execute();

     PrintMessage( "Удалена операция для сделки с кодом \""+tick.rec.DealCode+"\"", true );     

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO ExistsServOpLink( DocKind:INTEGER, DocumentID:INTEGER ):BOOL

     VAR RS, 
         cmd = RSDCommand(" select count(1) NumLink from doprstep_dbt " + 
                          "       where     t_ServDocKind = ? " + 
                          "             and t_ServDocID   = ? ");
     cmd.addParam( "", RSDBP_IN, DocKind );
     cmd.addParam( "", RSDBP_IN, DocumentID );
     cmd.Execute();
     RS = TRsbDataSet( cmd );
     if( RS.movenext() AND (RS.NumLink > 0) )
       return true;
     end;

     if( DocKind == DL_MOVINGDOC )
        cmd = RSDCommand(" select count(1) NumLink from dpmwrtsum_dbt " + 
                          "       where     t_DocKind = ? " + 
                          "             and t_DocID   = ? ");
        cmd.addParam( "", RSDBP_IN, DocKind );
        cmd.addParam( "", RSDBP_IN, DocumentID );
        cmd.Execute();
        RS = TRsbDataSet( cmd );
        if( RS.movenext() AND (RS.NumLink > 0) )
          return true;
        end;
     end;

     return false;
  END;

  PRIVATE MACRO DeleteServOperation( DocKind:INTEGER, DocumentID:INTEGER, CommCode:STRING )
    var DS, cmd;

     if( ExistsServOpLink( DocKind, DocumentID ) == true )
        return;
     end;

     cmd = RSDCommand(" delete from doprdocs_dbt " + 
                      "       where     t_ServDocKind = ? " + 
                      "             and t_ServDocID   = ? ");
     cmd.addParam( "", RSDBP_IN, DocKind );
     cmd.addParam( "", RSDBP_IN, DocumentID );
     cmd.Execute();

     cmd = RSDCommand(" delete from ddl_comm_dbt " + 
                      "       where t_DocumentID = ? ");
     cmd.addParam( "", RSDBP_IN, DocumentID );
     cmd.Execute();

     PrintMessage( "Удалена сервисная операция с кодом \""+CommCode+"\" и DocKind = "+DocKind, true );
    
    OnError(err);
  END;

  PRIVATE MACRO DeleteCloseFI( FIID, FI_Code )
    var DS, cmd;

       cmd = RSDCommand(" delete from dfininstr_dbt where t_FIID = ? ");
       cmd.addParam( "", RSDBP_IN, FIID );
       cmd.Execute();

       PrintMessage( "Удален закрытый финансовый инструмент с кодом \""+FI_Code+"\"", true );

    OnError(err);
    PrintMessage( "Строка: " + err.line + " | " + err.message );
  END;

  PRIVATE MACRO CreateScdropoper()
    VAR sql;
    sql = "DECLARE \n"
        +  " v_err EXCEPTION; \n"
        +  " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
        + "BEGIN EXECUTE IMMEDIATE 'CREATE TABLE scdropoper_buf" 
        + " ( T_Type NUMBER(5), T_ObjectID NUMBER(10), t_CheckAmount NUMBER(5)) ';\n " /* ИД нового лота */
        + "EXCEPTION WHEN v_err THEN NULL; \n"
        + "END; \n";
    SQL_Execute(sql,"Создание временной таблицы", false);

    sql = "DECLARE \n"
        +  " v_err EXCEPTION; \n"
        +  " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
        + "BEGIN\n"             
        +  " EXECUTE IMMEDIATE 'CREATE INDEX scdropoper_buf_IDX1 ON scdropoper_buf"
        + " (t_Type, t_CheckAmount)';\n"
        + "EXCEPTION WHEN v_err THEN NULL; \n"
        + "END; \n";
    SQL_Execute(sql,"Создание индексов временной таблицы", false);

    sql = "DECLARE \n"
        +  " v_err EXCEPTION; \n"
        +  " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
        + "BEGIN\n"             
        +  " EXECUTE IMMEDIATE 'CREATE INDEX scdropoper_buf_IDX0 ON scdropoper_buf"
        + " (t_Type, T_ObjectID)';\n"
        + "EXCEPTION WHEN v_err THEN NULL; \n"
        + "END;\n";
    SQL_Execute(sql,"Создание индексов временной таблицы", false);

    SQL_Execute("TRUNCATE TABLE scdropoper_buf", "Очистка временной таблицы", false);
  end;

  PRIVATE MACRO DropSclotintax()
     VAR cmd;
     if( FormData.Flag13 == "X") 
        cmd = RSDCommand( "DROP TABLE sclotintax_buf" );
        cmd.execute();
     end;
  OnError(err);
  end;

  PRIVATE MACRO DropScdropoper()
      VAR cmd;
      if( FormData.Flag3 == "X" ) 
        cmd = RSDCommand( "DROP TABLE scdropoper_buf" );
        cmd.execute();
      end;
  OnError(err);
  end;

  private macro DropConstrain( Table, Constr )
    VAR cmd = RSDCommand("declare "+
                     "  e_no_constr exception; "+
                     "  pragma exception_init (e_no_constr, -2443); "+
                     " begin "+
                     "   execute immediate 'alter table "+Table+" DROP CONSTRAINT "+Constr+"'; "+
                     " exception when e_no_constr then null; "+
                     " end;");
    cmd.Execute();
  end;
/*----------------------------------------------------------------------------------------------------------------------------------*/
  MACRO Create()
     var Sql = " select tick.t_DealID, tick.t_BofficeKind, tick.t_DealStatus, tick.t_DealType, tick.t_DealCode, NVL((select t_ID_Operation from doproper_dbt opr where opr.t_DocKind = tick.t_BOfficeKind AND opr.t_DocumentID = LPad(tick.t_DealID, 34, '0')),0) ID_Operation " +
               "   from ddl_tick_dbt tick" +
               "  where tick.t_BofficeKind in (101,117,127) ";

     var cmd, i = 0, DS, ObjectID, OGroup, SqlFI,
         tick = TRecHandler( "dl_tick.dbt" );

      PrintMessage( "Начало работы процедуры удаления сделок", false, true );     

      SQL_Execute(
                   "DECLARE \n"
                   + " v_err EXCEPTION; \n"
                   + " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
                   + " BEGIN\n"             
                   + " EXECUTE IMMEDIATE 'CREATE INDEX dpmwrtsum_dbt_fd_IDX1 ON dpmwrtsum_dbt"
                   + " (t_DealID, t_Buy_Sale)';\n"
                   + " EXCEPTION WHEN v_err THEN NULL; \n"
                   + " END; \n"
                   ,"Создание индекса dpmwrtsum_dbt", false
                 );

      SQL_Execute(
                   "DECLARE \n"
                   + " v_err EXCEPTION; \n"
                   + " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
                   + " BEGIN\n"             
                   + " EXECUTE IMMEDIATE 'CREATE INDEX dpmwrtbc_dbt_fd_IDX1 ON dpmwrtbc_dbt"
                   + " (t_DocID, t_DocKind, t_PartNum, t_Buy_Sale)';\n"
                   + " EXCEPTION WHEN v_err THEN NULL; \n"
                   + " END; \n"
                   ,"Создание индекса dpmwrtbc_dbt", false
                 );

      if( FormData.Flag13 == "X") 
         InitProgress( -1, "Определение сделок, участвующих в НУ", "Определение сделок, участвующих в НУ" );
         FillTmpTable( "sclotintax_buf" );
         RemProgress();
      end;

      if( FormData.Flag3 == "X" ) 
         CreateScdropoper();
      end;

      PrintMessage( "Формирование выборки сделок для удаления" );     
      InitProgress( SQL_GetNRecs( Sql ), "Формирование выборки сделок для удаления", "Формирование выборки сделок для удаления" );

      DS = TRsbDataSet( Sql );
      while( DS.MoveNext() )

        tick.Clear();
        tick.rec.DealID      = DS.rec.DealID;
        tick.rec.BofficeKind = DS.rec.BofficeKind;
        tick.rec.DealStatus  = DS.rec.DealStatus;
        tick.rec.DealType    = DS.rec.DealType;
        tick.rec.DealCode    = DS.rec.DealCode;

        ObjectID = UniID(tick, tick.rec.BOfficeKind);
        OGroup = SP_GetOperationGroup( tick.rec );

        if( FormData.Flag1 == "X" ) 
           DeleteDeal( tick, ObjectID, OGroup );
        end;

        if( FormData.Flag3 == "X" ) 
           DeleteOperation( tick, OGroup, DS.ID_Operation );
        end;

        i=i+1;
        UseProgress(i);
      end;
      RemProgress();

      if( (FormData.Flag6 == "X") AND (FormData.Flag2 == "X") )
         i = 0;
         PrintMessage( "Удаление операций по закрытым выпускам ц/б" );     

         SqlFI = "  select t_FIID, t_FI_Code "
               "   from dfininstr_dbt " +
               "  where t_IsClosed = chr(88) and t_FI_Kind = 2 ";

         InitProgress( SQL_GetNRecs( SqlFI ), "Удаление операций по закрытым выпускам ц/б", "Удаление операций по закрытым выпускам ц/б" );
         DS = TRsbDataSet( SqlFI );
         while( DS.MoveNext() )
            cmd = RSDCommand(" Insert into scdropoper_buf(t_Type, t_ObjectID, t_CheckAmount) VALUES( ?, (SELECT t_ID_Operation from doproper_dbt where t_DocKind = ? AND t_DocumentID = ?), ? )");
            cmd.addParam( "", RSDBP_IN, 1 );
            cmd.addParam( "", RSDBP_IN, DLDOC_ISSUE );
            cmd.addParam( "", RSDBP_IN, L_Z( DS.rec.FIID, 34 ) );
            cmd.addParam( "", RSDBP_IN, 0 );
            cmd.Execute();

            UseProgress(i=i+1);
         end;

         RemProgress();
      end;

/*
MsgBoxEx( "Необходимо собрать статистику по таблице \"scdropoper_buf\", затем продолжить выполнение.",
          MB_YES, MB_YES, 
          "Сбор статистики", "Сбор статистики" );
*/
      InitProgress( -1, "Сбор статистики для \"scdropoper_buf\"", "Сбор статистики для \"scdropoper_buf\"" );
      cmd = RSDCommand( "BEGIN dbms_stats.gather_table_stats( OwnName       => USER,TabName       => 'scdropoper_buf',Degree        => 4,Cascade       => TRUE,No_Invalidate => FALSE ); END;");
      cmd.execute();
      RemProgress();

      PrintMessage( "Удаление сделок" );     
      InitProgress( -1, "Удаление сделок", "Удаление сделок" );
         DropDeal();
      RemProgress();
      i = 0;
      PrintMessage( "Удаление операций" );     
      InitProgress( 8, "Удаление операций ", "Удаление операций " );

      DropConstrain( "dOPRDATES_dbt", "XFK1_OPRDATES_OPROPER" );
      DropConstrain( "dOPRDOCS_dbt",  "XFK1_OPRDOCS_OPRSTEP" );
      DropConstrain( "dOPRDOCS_dbt",  "XFK2_OPRDOCS_OPROPER" );
      DropConstrain( "dOPRSTEP_dbt",  "XFK3_OPRSTEP_OPROPER" );
      DropConstrain( "DPMREPSES_DBT", "XFK_PMREPSES_PMPAYM" );

      if( FormData.Flag3 == "X" ) 
         if( FormData.Flag5 == "X" )
  //          DeleteCARRY();
         end;
         UseProgress( i = i + 1 );

         DeleteOPRDATES( );
         UseProgress( i = i + 1 );

         DeleteOPRCURST();
         UseProgress( i = i + 1 );

         DeleteOPRDOCS( );
         UseProgress( i = i + 1 );

         DeleteOPRSFCOM();
         UseProgress( i = i + 1 );

         DeleteOPRSTHIST();
         UseProgress( i = i + 1 );

         DeleteOPRSTEP();
         UseProgress( i = i + 1 );

         DeleteOPROPER();
         UseProgress( i = i + 1 );
      end;

      RemProgress();
      i = 0;
      PrintMessage( "Удаление данных по сделкам" );     
      InitProgress( 12, "Удаление данных по сделкам", "Удаление данных по сделкам" );
      DeleteSPGRDOC();

      UseProgress( i = i + 1 );
      DeleteExistSfBasObj();
      UseProgress( i = i + 1 );
      DeleteDLLEG();
      UseProgress( i = i + 1 );
      if( FormData.Flag4 == "X" )
         DeleteWRTSUM();
         UseProgress( i = i + 1 );
         DeleteWRTBC();
         UseProgress( i = i + 1 );
         DeleteWRTLNK();
         UseProgress( i = i + 1 );
         UpdateDealLink();
         PrintMessage( "Удалены лоты и связи сделок" );     
      else 
         UseProgress( i = i + 3 );
      end;
      UseProgress( i = i + 1 );

      DeletePM_PAYM();
      UseProgress( i = i + 1 );
      DeletePMDOCS();
      UseProgress( i = i + 1 );
      DeleteDOCSIGN();
      UseProgress( i = i + 1 );
      DeletePMHIST();
      UseProgress( i = i + 1 );
      DeletePaymProps();
      UseProgress( i = i + 1 );
      RemProgress();

      if( FormData.Flag7 == "X"  )
/*         cmd = RSDCommand( "truncate table dmcaccdoc_dbt" );*/
         DeleteRecords( "dmcaccdoc_dbt", "accdoc", 
                        "  t_DocKind in (0/*LEG_KIND_DL_TICK*/, 2/*LEG_KIND_DL_TICK_BACK*/,101,117,127) AND EXISTS (select t_DealID from ddl_tick_dbt deal where deal.t_DealID = accdoc.t_DocID )"
                      );
         cmd.execute();
      end;

      if( FormData.Flag2 == "X"  )
         Sql = "  select t_DocumentID, t_CommCode, t_DocKind "
               "   from ddl_comm_dbt " +
               "  where t_DocKind in ( "+DL_OVERVALUE+","+DL_MOVINGDOC+","+104/*DL_COMMDOC*/+","+DL_FINALTRUSTDOC+","+DL_RESERVEDOC+","+DL_SETTLEMENT+","+DL_FINALTRADEDAY+","+DL_OVERVALUE_RD+" ) " +
               "  order by t_DocKind ";
         i = 0;
         PrintMessage( "Удаление сервисных операций" );     
         InitProgress( SQL_GetNRecs( Sql ), "Удаление сервисных операций", "Удаление сервисных операций" );
         DS = TRsbDataSet( Sql );
         while( DS.MoveNext() )

            DeleteServOperation( DS.rec.DocKind, DS.rec.DocumentID, DS.rec.CommCode );
            UseProgress(i=i+1);
         end;
         RemProgress();
      end;

      if( FormData.Flag6 == "X"  )
         i = 0;
         PrintMessage( "Удаление закрытых выпусков" );     
         SqlFI = "  select fi.t_FIID, fi.t_FI_Code " +
               "   from dfininstr_dbt fi " +
               "  where fi.t_IsClosed = chr(88) and fi.t_FI_Kind = 2 AND (SELECT count(1) from dpmwrtsum_dbt ws where ws.t_FIID = fi.t_FIID) = 0 AND (SELECT count(1) from ddl_comm_dbt cm where fi.t_FIID = cm.t_FIID) = 0";

         InitProgress( SQL_GetNRecs( SqlFI ), "Удаление закрытых выпусков", "Удаление закрытых выпусков" );
         DS = TRsbDataSet( SqlFI );
         while( DS.MoveNext() )

            DeleteCloseFI( DS.rec.FIID, DS.rec.FI_Code );
            UseProgress(i=i+1);
         end;

         cmd = RSDCommand(" delete from davoiriss_dbt avr" + 
                          "    where NOT EXISTS (select fi.t_FIID from dfininstr_dbt fi where fi.t_FIID = avr.t_FIID )");
         cmd.Execute();

         RemProgress();
      end;
      InitProgress( -1, "Удаление категорий и примечаний объектов", "Удаление категорий и примечаний объектов" );
      PrintMessage( "Удаление примечаний объектов" );     
      DeleteNOTETEXT();
      PrintMessage( "Удаление категорий объектов" );     
      DeleteAttribute();
      RemProgress();

      DropSclotintax();
      DropScdropoper();
      PrintMessage( "Процедура удаления сделок завершена", false, true );     
  END;

END;

VAR Rep,
    RepForm = SP_DeleteDeals_Form();

if( RepForm.Run() )
  FormData = RepForm.Data().rec;
  Rep = SP_DeleteDeals();
  Rep.BeginReport();
  Rep.Create();
  Rep.EndReport();
end;
