/*
$Name:        reprecalcclient_DEF-42364.mac
$Module:      Ценные бумаги
$Description: Клиенты, по которым изменилась НОБ
*/
import secinter, sp_categ, nptxfun;

private macro PrintClientList()
  var query, cmd, DataSet, cnt = 0, i = 0;

  query =   " select q.*, pt.t_Name, "
          + "        (select obj.t_code from dobjcode_dbt obj where obj.t_objecttype = 3 and obj.t_codekind = 1 and obj.t_objectid = pt.t_partyid and obj.t_state = 0) as ClientCode "
          + "   from (select t_Client, t_Year, SUM(NewNOB) as SumNewNOB, SUM(OldNOB) SumOldNOB"
          + "           from (select op.t_Client, EXTRACT(YEAR FROM op.t_EndRecalcDate) as t_Year, "
          + "                        (select NVL(SUM(obj.t_Sum0),0) from dnptxobdc_dbt odc, dnptxobj_dbt obj where odc.t_DocID = op.t_ID and obj.t_ObjID = odc.t_ObjID and obj.t_Kind = "+TXOBJ_BASEG2+") as NewNOB, "
          + "                        (select NVL(SUM(obj.t_Sum0),0) from dnptxobjbc_dbt obj where obj.t_DocID = op.t_ID and obj.t_Kind = "+TXOBJ_BASEG2+") as OldNOB "
          + "                   from dnptxop_dbt op "
          + "                  where op.t_DocKind = 4605 "
          + "                    and op.t_Code LIKE '42364_rec_%' "
          + "                ) "
          + "          group by t_Client, t_Year "
          + "        ) q, dparty_dbt pt "
          + "  where pt.t_PartyID = q.t_Client "
          + "    and q.SumNewNOB != q.SumOldNOB "
          + " order by q.t_Client, t_Year ";

  cmd = DL_RSDCommand(query);

  cnt = cmd.GetCount();

  if(cnt > 0)

    DataSet = cmd.Execute();

    println("Клиенты, по которым имененилась НОБ в результате пересчета");

    println("");
    println("┌─────────────────┬────────────────────────────────────────────┬──────────────┬──────────────┐");
    println("│       Код       │                     ФИО                    │   Изменение  │   Налоговый  │");
    println("│     клиента     │                                            │      НОБ     │      год     │");
    println("├─────────────────┼────────────────────────────────────────────┼──────────────┼──────────────┤");

    i = 0;
    while(DataSet.moveNext())
       [│#################│############################################│##############│##############│]
       (string(DataSet.ClientCode):c,   
        string(DataSet.Name):l:w,   
        money(DataSet.SumNewNOB-DataSet.SumOldNOB):c,
        string(int(DataSet.Year)):c
       );

       i = i + 1;

       if(i < cnt)
         println("├─────────────────┼────────────────────────────────────────────┼──────────────┼──────────────┤");
       end;
    end;

         println("└─────────────────┴────────────────────────────────────────────┴──────────────┴──────────────┘");

  else
    println("Клиентов с изменением НОБ не найдено");
  end;

end;


PrintClientList();
