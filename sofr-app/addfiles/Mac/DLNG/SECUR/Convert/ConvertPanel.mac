/*
$Name: ConvertPanel.mac
$Module: УВ/СВ
$Description: Макрос панели редактирования параметров векселя
$Created: 14.12.2018
*/
import "DLRepForm_h.mac", "globals.mac";

 /*Номера полей в форме отчета*/
const PNFLD_ACMETHOD    = 0,
      PNFLD_EIR = 1,
      PNFLD_TEST_YES = 2,
      PNFLD_TEST_NO = 3,
      PNFLD_TEST_UNDEF = 4,
      PNFLD_SOURCEDATA_YES = 5,
      PNFLD_SOURCEDATA_NO = 6,
      PNFLD_NONMARKETCORRECT = 7,
      PNFLD_CURRENCY = 8;

  PRIVATE CONST
  DL_PNFLD_CHECKBOX1 = 104,
  DL_PNFLD_CHECKBOX2 = 105,
  DL_PNFLD_CHECKBOX3 = 106,
  DL_PNFLD_CHECKBOX4 = 107,
  DL_PNFLD_CHECKBOX5 = 108,
  UNDEF_CHAR = "?",
  BNR_SET_CHAR = SET_CHAR,
  BNR_UNSET_CHAR = "/",
  BNR_UNDEF_CHAR = UNDEF_CHAR,
  VSINCOMETYPE_NONMARKETCORRECT = 150;

private macro IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else
      return value_false;
   end;
end;

private macro ВставитьСтатусОбОплате(_bnr)
  var vsbnrbck = TBFile("vsbnrbck.dbt","W");
  var query = "select * "
      +"  from dvsbnrbck_dbt "
      +" where t_newabcstatus = " + VSBANNER_STATUS_FORMED
      +"   and t_oldabcstatus != " + VSBANNER_STATUS_PAYED
      +"   and t_BCID = " + _bnr.rec.BCID;
  var cmd = DL_RSDCommand(query);
  var DataSet = cmd.Execute();
  while (DataSet.moveNext())
    vsbnrbck.rec.ID = DataSet.ID;
    if (not vsbnrbck.GetEQ())
      return false;
    end;
    vsbnrbck.rec.oldabcstatus = VSBANNER_STATUS_PAYED;
    if (not vsbnrbck.Update())
      return false;
    end;
    vsbnrbck.Clear();
    DataSet.GetRecord().CopyTo(vsbnrbck.rec);
    vsbnrbck.rec.Id = 0;
    vsbnrbck.rec.newabcstatus = VSBANNER_STATUS_PAYED;
    if (not vsbnrbck.Insert())
      return false;
    end;
  end;
  return true;
end;

PRIVATE MACRO VA_GetLastAccountedEnrolmentID(BCID)
  var Enrolment_ID = 0;
  var query, DataSet;
  var RSD = DL_RSDCommand();

  query = "select rsb_bill.GetVABnrLastAccountedEnrolID(?) as ID from dual ";
  RSD.AddParam(BCID); /*1*/

  DataSet = RSD.Execute(query);

  if(DataSet.moveNext())
    Enrolment_ID = DataSet.ID;
  end;

  return int(Enrolment_ID);
END;

PRIVATE MACRO VS_GetLastAccountedEnrolmentID(BCID)
  var Enrolment_ID = 0;
  var query, DataSet;
  var RSD = DL_RSDCommand();

  query = "select rsb_bill.GetVSBnrLastPayedEnrolID(?) as ID from dual ";
  RSD.AddParam(BCID); /*1*/

  DataSet = RSD.Execute(query);

  if(DataSet.moveNext())
    Enrolment_ID = DataSet.ID;
  end;

  return int(Enrolment_ID);
END;

MACRO GetRecordNonMarketCorrect(BCID)
  var cmd, DataSet, query;
  var income = TBfile("vsincome.dbt", "W");

  query =  " SELECT t_AutoKey as AutoKey "
        +  " FROM dvsincome_dbt income"
        +  " WHERE income.t_BCID = ?"
        +  " AND income.T_ENROLMENT_ID = (select case when bnr.t_BackOffice = 'N' then rsb_bill.GetVABnrLastAccountedEnrolID(bnr.t_BCID)"
        +                                       "when bnr.t_BackOffice = 'Y' then rsb_bill.GetVSBnrLastPayedEnrolID(bnr.t_BCID)"
        +                                       "else 0 END AS MYENROLMENT_ID from dvsbanner_dbt bnr where bnr.T_BCID = ?)"
        +  " AND income.T_INCOMETYPE = ?";
  cmd = DL_RSDCommand(query);
  cmd.AddParam(BCID);
  cmd.AddParam(BCID);
  cmd.AddParam(VSINCOMETYPE_NONMARKETCORRECT);
  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    income.rec.AutoKey = DataSet.AutoKey;
    if(income.getEQ())
      return income;
    end;
    return null;
  end;

  return null;
END;

MACRO GetSumNonMarketCorrect(BCID)
  var cmd, DataSet, query, Sum = $0;

  query =  " SELECT income.t_Perc as Sum "
        +  " FROM dvsincome_dbt income"
        +  " WHERE income.t_BCID = ?"
        +  " AND income.T_ENROLMENT_ID = (select case when bnr.t_BackOffice = 'N' then rsb_bill.GetVABnrLastAccountedEnrolID(bnr.t_BCID)"
        +                                       "when bnr.t_BackOffice = 'Y' then rsb_bill.GetVSBnrLastPayedEnrolID(bnr.t_BCID)"
        +                                       "else 0 END AS MYENROLMENT_ID from dvsbanner_dbt bnr where bnr.T_BCID = ?)"
        +  " AND income.T_INCOMETYPE = ?";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(BCID);
  cmd.AddParam(VSINCOMETYPE_NONMARKETCORRECT);
  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    Sum = DataSet.Sum;
  end;

  return Sum;
END;

MACRO DL_FldProc_ACMethod( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR BeginDate, EndDate, Month, Year;

  if( Cmd == DLG_INIT ) // Установка значения в поле
    if( FldRealValue == null ) // инициализация по умолчанию
      FldRealValue = pThis.EditBanner.ACMETHOD;
    end;
    FldShowValue = DL_GetNameAlg( 7507, FldRealValue );

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    DL_ListNA( 7507, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
    pThis.EditBanner.ACMETHOD = FldRealValue;
  end;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_NonMarketCorrect( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR BeginDate, EndDate, Month, Year;

  if( Cmd == DLG_INIT ) // Установка значения в поле
    FldShowValue = FldRealValue = pThis.EditBanner.NonMarketCorrect;
  elif( Cmd == DLG_KEY )
    pThis.EditBanner.NonMarketCorrect = FldRealValue = FldShowValue;  
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DL_FldProc_CheckBoxTest1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
           pThis.EditBanner.Test = BNR_SET_CHAR;
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX2, "" );
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX3, "" );
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DL_FldProc_CheckBoxTest2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
           pThis.EditBanner.Test = BNR_UNSET_CHAR;
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX1, "" );
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX3, "" );
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DL_FldProc_CheckBoxTest3( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
           pThis.EditBanner.Test = BNR_UNDEF_CHAR;
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX1, "" );
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX2, "" );
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DL_FldProc_CheckBoxData1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           pThis.EditBanner.SourceData = SET_CHAR;
           FldShowValue = FldRealValue = "X";
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX5, "" );
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DL_FldProc_CheckBoxData2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           pThis.EditBanner.SourceData = UNSET_CHAR;
           FldShowValue = FldRealValue = "X";
           pThis.SetLinkedValue( DL_PNFLD_CHECKBOX4, "" );
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DL_FldProc_EIR( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue = Pthis.EditBanner.EIR;
  elif(Cmd == DLG_CHANGEVALUE)
    Pthis.EditBanner.EIR = FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

Private class BannerInfo(_BCID, _ACMethod, _EIR, _Test, _SourceData, _NonMarketCorrect, _Currency)
  var BCID, ACMETHOD, EIR, TEST, SourceData, NonMarketCorrect, Currency;

  BCID             = _BCID;
  ACmethod         = _ACMethod;
  EIR              = _EIR;
  Test             = _Test;
  SourceData       = _SourceData;
  NonMarketCorrect = _NonMarketCorrect;
  Currency         = _Currency;
end;

class (DL_CPanel) ConvertPanel(bnr, leg, income)
  var IsMessageBoxNO = false;
  var EditBanner;
  var Test;
  private macro construct(bnr, leg, income)
    var incomeSum = 0, incomeCurrency = NATCUR;
    if(income != null)
      incomeSum = income.rec.Perc;
      incomeCurrency = income.rec.Currency;
    end;
    EditBanner = BannerInfo(bnr.rec.BCID, leg.rec.PrincipalDiff, leg.rec.IncomeRate, leg.rec.RelativePrice, leg.rec.PayRegTax, incomeSum, incomeCurrency);
  end; 

  private macro Init()
    AddFieldProc(0, PNFLD_ACMETHOD,         DL_USERFIELD,        @DL_FldProc_ACMethod, null, 37, 3);
    AddFieldProc(0, PNFLD_EIR,              DL_USERFIELD,        @DL_FldProc_EIR);
    AddFieldProc(0, PNFLD_TEST_YES,         DL_PNFLD_CHECKBOX1,  @DL_FldProc_CheckBoxTest1,     IIF(EditBanner.Test == BNR_SET_CHAR, "X", ""));
    AddFieldProc(0, PNFLD_TEST_NO,          DL_PNFLD_CHECKBOX2,  @DL_FldProc_CheckBoxTest2,     IIF(EditBanner.Test == BNR_UNSET_CHAR, "X", ""));
    AddFieldProc(0, PNFLD_TEST_UNDEF,       DL_PNFLD_CHECKBOX3,  @DL_FldProc_CheckBoxTest3,     IIF(EditBanner.Test == BNR_UNDEF_CHAR, "X", ""));
    AddFieldProc(0, PNFLD_SOURCEDATA_YES,   DL_PNFLD_CHECKBOX4,  @DL_FldProc_CheckBoxData1,     IIF(EditBanner.SourceData == SET_CHAR, "X", ""));
    AddFieldProc(0, PNFLD_SOURCEDATA_NO,    DL_PNFLD_CHECKBOX5,  @DL_FldProc_CheckBoxData2,     IIF(EditBanner.SourceData == UNSET_CHAR, "X", ""));
    AddFieldProc(0, PNFLD_NONMARKETCORRECT, DL_USERFIELD,        @DL_FldProc_NonMarketCorrect );
    AddFieldProc(0, PNFLD_CURRENCY,         DL_PNFLD_FI,         @DL_FldProc_FI,                EditBanner.Currency);
  end;
  
  private macro Check():BOOL
    if( EditBanner.Test == UNSET_CHAR)
      msgbox("Незадан тест на рыночность");
      return false;
    end;

    if((EditBanner.EIR < 0) OR (EditBanner.EIR > 100) )
      msgbox("ЭПС < 0");
      return false;
    end;
  end;

  initDL_CPanel( "cnvrtbnr.lbr", "CVPNVAM9" );
  construct(bnr, leg, income);
end;


macro RunConvertPanel(_bnr, _leg)
  var bnr = TBfile("vsbanner.dbt", "W"), leg = TBfile("dl_leg.dbt", "W"), income = null, stat = 0, ConertPn;
  bnr.rec.BCID = _bnr.rec.BCID;
  bnr.GetEQ();
  leg.KeyNum = 1;
  leg.rec.Id = _leg.rec.Id;
  leg.GetEQ();
  
  income = GetRecordNonMarketCorrect(bnr.rec.BCID);

  ConertPn = ConvertPanel(bnr, leg, income);
  stat = ConertPn.Run();
  if(stat AND (bnr.rec.BackOffice == "Y"))
    if( not ВставитьСтатусОбОплате(bnr))
      msgbox("Ошибка вставки записи об оплате");
      stat = false;
    end;
  end;

  if(stat)
    leg.rec.PrincipalDiff  = ConertPn.EditBanner.ACmethod;
    leg.rec.IncomeRate     = ConertPn.EditBanner.EIR;
    leg.rec.RelativePrice  = ConertPn.EditBanner.Test;
    leg.rec.PayRegTax      = ConertPn.EditBanner.SourceData;

    if(not leg.Update() )
	    msgbox("Ошибка обновления записи dl_leg.dbt!");
      return 1;
	  end;
    
    if(income == NULL)
      income = TBfile("vsincome.dbt", "W");
      income.rec.BCID         = bnr.rec.BCID; // ID векселя/сертификата
      income.rec.Perc         = ConertPn.EditBanner.NonMarketCorrect;          
      income.rec.Disc         = $0;           
      income.rec.Currency     = ConertPn.GetFieldValue(PNFLD_CURRENCY);  // Валюта
      income.rec.StartDate    = {curdate};
      income.rec.EndDate      = {curdate};                                            
      income.rec.OperDate     = {curdate};      
      income.rec.Quality      = UNSET_CHAR;
      if(bnr.rec.BackOffice == "N")
        income.rec.Enrolment_ID = VA_GetLastAccountedEnrolmentID(bnr.rec.BCID); 
      elif(bnr.rec.BackOffice == "Y")
        income.rec.Enrolment_ID = VS_GetLastAccountedEnrolmentID(bnr.rec.BCID); 
      end;    
      income.rec.AccPerc      = ConertPn.EditBanner.NonMarketCorrect;
      income.rec.AccDisc      = $0;        
      income.rec.AccCurrency  = ConertPn.GetFieldValue(PNFLD_CURRENCY);;  
      income.rec.IncomeType   = VSINCOMETYPE_NONMARKETCORRECT;
      income.rec.Bonus        = $0;
      income.rec.AccBonus     = $0;
      income.rec.EPRPerc      = $0;
      income.rec.AccEPRPerc   = $0;
      income.rec.Amortiz      = $0;
      income.rec.AccAmortiz   = $0;
      income.rec.Expens       = $0;
      income.rec.AccExpens    = $0;
      income.rec.DefDif       = $0;
      income.rec.AccDefDif    = $0;
      if(not income.Insert() )
	      msgbox("Ошибка обновления записи vsincome.dbt!");
        return 1;
	    end;
    else 
      income.rec.Perc         = ConertPn.EditBanner.NonMarketCorrect;          
      income.rec.Currency     = ConertPn.GetFieldValue(PNFLD_CURRENCY);  // Валюта
      income.rec.AccPerc      = ConertPn.EditBanner.NonMarketCorrect;
      income.rec.AccCurrency  = ConertPn.GetFieldValue(PNFLD_CURRENCY);;  
      if(not income.Update() )
	      msgbox("Ошибка обновления записи vsincome.dbt!");
        return 1;
	    end;
    end;

    
  end;
  return stat;
end;