/* Процедура конвертации данных НУ. Общая часть
   Chernov Anton 05-12-2007
*/

const
  Date302 = date(01,01,2008), /* дата начала действия 302-П */
  Date302SQL = GetSQLDate(Date302),
  ZeroDateSQL = "TO_DATE('01-01-0001','DD-MM-YYYY')";

/* сформировать запрос для выборки лотов */
MACRO FormQuery( sql:@variant )
    /* Незакрытые сделки */
    sql = " SELECT lot.t_amount NewLotAmount, lot.*, 0 sold "
        +   " FROM dsctaxlot_dbt lot "
        +  " WHERE lot.t_type IN (" + TAXLOTS_REPO + ", " + TAXLOTS_BACKREPO + ") "
        +    " AND lot.t_date < " + Date302SQL
        +    " AND (lot.t_date2 >= " + Date302SQL + " OR t_date2 = " + ZeroDateSQL + ") "
        + " UNION ";

    /* Непроданные покупки */
    sql = sql 
        + " SELECT osttax.t_amount - osttax.sold NewLotAmount, osttax.* "
        +   " FROM (SELECT tbuy.*, "
        +                " NVL((SELECT SUM(lnk.t_amount) "
        +                       " FROM dsctaxlnk_dbt lnk, "
        +                            " dsctaxlot_dbt tsell "
        +                      " WHERE lnk.t_buyid = tbuy.t_id "
        +                        " AND tsell.t_id = lnk.t_saleid "
        +                        " AND tsell.t_date < " + Date302SQL
        +                        " AND lnk.t_type in (" + TAXLNK_BS + ", " + TAXLNK_CLPOS + ")), 0) sold "
        +           " FROM dsctaxlot_dbt tbuy "
        +          " WHERE tbuy.t_type = " + TAXLOTS_BUY
        +            " AND tbuy.t_date < " + Date302SQL + ") osttax "
        + " WHERE osttax.t_amount > osttax.sold "
        + " UNION ";

    /* Размещения */
    sql = sql
        + " SELECT ostlot.newamountlot, repo.*, 0 sold "
        +   " FROM (SELECT alllinksdirectrepo.t_saleid, "
        +                " SUM(alllinksdirectrepo.newamountlink) newamountlot "
        +           " FROM ( SELECT pv.t_amount - pv.qlater newamountlink, pv.* " /* отбор закрытых сделок, последних в цепочке продаж */
        +                    " FROM (SELECT ldr.*, "
        +                                 " NVL((SELECT SUM(lpv.t_amount) "
        +                                        " FROM dsctaxlnk_dbt lpv, "
        +                                             " dsctaxlot_dbt tlater "
        +                                       " WHERE lpv.t_type = " + TAXLNK_BREPO
        +                                         " AND lpv.t_saleid = tlater.t_id "
        +                                         " AND lpv.t_buyid = ldr.t_saleid "
        +                                         " AND lpv.t_sourceid = ldr.t_buyid "
        +                                         " AND tlater.t_date < " + Date302SQL + "), 0) qlater "
        +                            " FROM dsctaxlnk_dbt ldr, "
        +                                 " dsctaxlot_dbt trepo, "
        +                                 " dsctaxlot_dbt tbuy "
        +                          "  WHERE ldr.t_type = " + TAXLNK_REPO
        +                             " AND trepo.t_id = ldr.t_saleid "
        +                             " AND tbuy.t_id = ldr.t_buyid "
        +                             " AND tbuy.t_type = " + TAXLOTS_BUY
        +                             " AND trepo.t_date2 < " + Date302SQL
        +                             " AND trepo.t_date2 > " + ZeroDateSQL + ") pv "
        +                   " WHERE pv.t_amount > pv.qlater) alllinksdirectrepo "
        +      " GROUP BY alllinksdirectrepo.t_saleid) ostlot, "
        +        " dsctaxlot_dbt repo "
        +  " WHERE ostlot.t_saleid = repo.t_id "
        +    " AND ostlot.newamountlot > 0 "
        + " UNION ";

    sql = sql /* отбор лотов ОБРАТНОГО закрытого репо - для формирования связи подстановка */
        + " SELECT lnk.newlotamount, repo.*, 0 sold "
        +   " FROM (SELECT SUM(l.t_amount) newlotamount, l.t_buyid "
        +           " FROM dsctaxlnk_dbt l, "
        +                " dsctaxlot_dbt buy, "
        +                " dsctaxlot_dbt sell "
        +          " WHERE l.t_type = " + TAXLNK_REPO
        +            " AND buy.t_id = l.t_buyid "
        +            " AND sell.t_id = l.t_saleid "
        +            " AND buy.t_date2 < " + Date302SQL
        +            " AND buy.t_date2 > " + ZeroDateSQL
        +            " AND (sell.t_date2 >= " + Date302SQL + " OR sell.t_date2 = " + ZeroDateSQL + ") "
        +            " AND buy.t_type IN (" + TAXLOTS_REPO + ", " + TAXLOTS_BACKREPO + ") "
        +            " AND sell.t_type IN (" + TAXLOTS_REPO + ", " + TAXLOTS_BACKREPO + ") "
        +       " GROUP BY l.t_buyid) lnk, "
        +        " dsctaxlot_dbt repo "
        +  " WHERE repo.t_id = lnk.t_buyid "
        +    " AND lnk.newlotamount > 0 "
        + " UNION ";

    /* Открытые короткие позиции */
    sql = sql
        + " SELECT ostlot.newamountlot, sell.*, 0 sold "
        +   " FROM (SELECT SUM(l.newamountlink) newamountlot, l.t_saleid "
        +           " FROM (SELECT poz.t_amount - poz.qclosed newamountlink, poz.* "
        +                   " FROM (SELECT lopen.*, "
        +                                " NVL((SELECT SUM(lcls.t_amount) "
        +                                       " FROM dsctaxlnk_dbt lcls, "
        +                                            " dsctaxlot_dbt tbuy "
        +                                      " WHERE lcls.t_buyid = tbuy.t_id "
        +                                        " AND lcls.t_saleid = lopen.t_saleid "
        +                                        " AND tbuy.t_date < " + Date302SQL
        +                                        " AND lcls.t_type = " + TAXLNK_CLPOS + "), 0) qclosed "
        +                           " FROM dsctaxlnk_dbt lopen, "
        +                                " dsctaxlot_dbt brepo, "
        +                                " dsctaxlot_dbt tsell "
        +                          " WHERE lopen.t_type = " + TAXLNK_OPSPOS
        +                            " AND tsell.t_id = lopen.t_saleid "
        +                            " AND brepo.t_id = lopen.t_buyid "
        +                            " AND tsell.t_date < " + Date302SQL
        +                            " AND (brepo.t_date2 >= " + Date302SQL + " OR brepo.t_date2 = " + ZeroDateSQL + ")) poz "
        +                  " WHERE poz.t_amount > poz.qclosed) l "
        +       " GROUP BY l.t_saleid) ostlot, "
        +        " dsctaxlot_dbt sell "
        +  " WHERE sell.t_id = ostlot.t_saleid "
        +    " AND ostlot.newamountlot > 0 ";
END;

PRIVATE MACRO CreateTmpTable( TmpTable : string )
  var sql;

  sql = "DECLARE \n"
      +  " v_err EXCEPTION; \n"
      +  " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
      + "BEGIN EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE " + TmpTable
      + " ( T_DEALID NUMBER(10) ) ON COMMIT PRESERVE ROWS';\n " /* ИД нового лота */
      + "EXCEPTION WHEN v_err THEN NULL; \n"
      + "END; \n";
  SQL_Execute(sql,"Создание временной таблицы", false);

  sql = "DECLARE \n"
      +  " v_err EXCEPTION; \n"
      +  " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
      + "BEGIN\n"
      +  " EXECUTE IMMEDIATE 'CREATE INDEX " + TmpTable + "_idx0 ON " + TmpTable
      + " (T_DEALID)';\n"
      + "EXCEPTION WHEN v_err THEN NULL; \n"
      + "END; \n";
  SQL_Execute(sql,"Создание индексов временной таблицы", false);

  SQL_Execute("TRUNCATE TABLE " + TmpTable, "Очистка временной таблицы", false);
END;

/* проверить наличие лотов по сделке */
MACRO ChechExistsTaxLots( TmpTable : string, DealID:integer )
  var cmd, sql, rsd;

  sql = " SELECT COUNT(1) iCount "
      + " FROM " + TmpTable 
      + " WHERE t_dealID = ?";

  cmd = RSDCommand( sql );
  cmd.addParam( "", RSDBP_IN, DealID );

  cmd.Execute();

  rsd = TRsbDataSet(cmd);
  if( rsd.MoveNext() and (rsd.iCount > 0) )
    return true;
  end; 
 
  return false;
END;

MACRO FillTmpTable( TmpTable : string )
  var cmd, sql;

  FormQuery(@sql);

  CreateTmpTable( TmpTable );

  sql = " INSERT INTO " + TmpTable
      + " SELECT lots.t_DealID "
      +  " FROM (" + sql + ") lots ";

  cmd = RSDCommand( sql );
  cmd.Execute();
 
  return false;
END;
