import rsd, BankInter, RsbDataSet, FIInter, CTInter, Календарь, globals, OprInter, "sp_class.mac", "sp_carou.mac";

private macro SetError( type, fun, mes )
  var cmd = RSDCommand("BEGIN " +
                       "  IvanovConvert.SCIDMAP.GlobalFun := 'stepacc2.mac'; " +
                       "  IvanovConvert.SCIDMAP.SetError(?,?,?); " +
                       "END;");
   cmd.addParam("", RSDBP_IN, type);
   cmd.addParam("", RSDBP_IN, fun);
   cmd.addParam("", RSDBP_IN, mes);
   cmd.execute();
end;

private macro MsgSet( mes )
  SetError( "INFO", "MsgBox", mes );
end;

private macro GetTrAcc( Chapter, Currency, IsActive )
  var cmd, rsd;

   if( IsActive )
      cmd = RSDCommand("SELECT T_DTACC Acc FROM IvanovConvert.DSCTRACC_TMP WHERE T_CHAPTER = ? AND T_CURRENCY = ?");
   else
      cmd = RSDCommand("SELECT T_KTACC Acc FROM IvanovConvert.DSCTRACC_TMP WHERE T_CHAPTER = ? AND T_CURRENCY = ?");
   end;
   cmd.addParam("", RSDBP_IN, Chapter);
   cmd.addParam("", RSDBP_IN, Currency);
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   if(rsd.MoveNext())
      return rsd.rec.Acc;
   end;            

   return "";
end;

private macro GetAccount( Chapter, FIID, Account, AccBuf )
   file AccR( "account.dbt" );
   file AccC( "account$.dbt" );

   if( Chapter == null ) Chapter = 1; end;
   if( FIID == null ) FIID = 0; end;

   if( FIID )
      ClearRecord( AccC );
      AccC.Chapter       = Chapter;
      AccC.Code_Currency = FIID;
      AccC.Account       = Account;
      if( GetEQ(AccC) )
         Copy( AccBuf, AccC );
         return true;
      end;
   else
      ClearRecord( AccR );
      AccR.Chapter       = Chapter;
      AccR.Code_Currency = FIID;
      AccR.Account       = Account;
      if( GetEQ(AccR) )
         Copy( AccBuf, AccR);
         return true;
      end;
   end;

   return false;
end;


private macro GetRestAccount( accbuf, Dat )
   var Rest = $0;

   OprGetAccountRest( accbuf.Chapter, accbuf.Code_Currency, accbuf.Account, Dat, Rest );

   return Rest;
end;

private macro RunCarry( Department:INTEGER, Chapter:INTEGER, SumPayer:MONEY, SumReceiver:MONEY, 
                        AccountPayer:STRING, AccountReceiver:STRING, FIIDPayer:INTEGER, FIIDReceiver:INTEGER, 
                        Ground:STRING, ObjectCode:STRING, Execute:BOOL, SPOD:BOOL )
  VAR tr, OldDialogFlag, SumTmp, SumFiCode;
  if( ( (AccountPayer == NULL) OR 
        (AccountPayer == "")
      ) OR 
      ( (AccountReceiver == NULL) OR 
        (AccountReceiver == "") 
      )
    )
     return true;
  end;

  if( SumReceiver != NULL ) 
     SumReceiver = Round( ABS(SumReceiver), 2 );
  end; 

  if( SumPayer != NULL ) 
     SumPayer = Round( ABS(SumPayer), 2 );
  end; 

  if( ( (SumReceiver == NULL) OR 
        (SumReceiver == 0)
      ) AND 
      ( (SumPayer == NULL) OR 
        (SumPayer == 0) 
      )
    )
     return true;
  end;

  tr = RsbAccTransaction();

  tr.Chapter         = Chapter;
  tr.Date_Carry      = tr.Date_Document = {CurDate};
  tr.Numb_Document   = ObjectCode;
  tr.ResultCarry     = INPCARRY;
  tr.Department      = Department;
  tr.Ground          = Ground;

  tr.Number_Pack     = 128;

  tr.FIIDPayer       = FIIDPayer;
  tr.FIIDReceiver    = FIIDReceiver;
  tr.SumPayer        = SumPayer;
  tr.SumReceiver     = SumReceiver;
  tr.AccountPayer    = AccountPayer;
  tr.AccountReceiver = AccountReceiver;

  if( SPOD == true )
    tr.TypeDocument  = "З"; /*СПОД*/
  end;

  if( Execute != true )
     tr.Status_After    = ACCTRN_STATUS_POST;     
  end;

  if( (SumPayer == 0) OR (SumPayer == NULL) )
     SumTmp = SumReceiver;
     SumFiCode = ПолучитьКодФинИн(FiidReceiver);
  else
     SumTmp = SumPayer;
     SumFiCode = ПолучитьКодФинИн(FiidPayer);
  end;

  if( not tr.Carry() )
     SetError("ERROR","RunCarry","!!! Ошибка при выполнении проводки \"" + Ground + "\"  "+ AccountPayer + "  " + AccountReceiver + "  " + SumTmp + " (" + SumFiCode + ")\n"+ GetErrMsg() );
     InitError();
     return false;
  end;

  SetError("INFO","RunCarry","Проводка \"" +Ground + "\" "+ AccountPayer + "  " + AccountReceiver + "  " + SumTmp + " (" + SumFiCode + ")" );
  return true;
END;

macro ExecuteCarry()
  var cmd, rsd;
  var count = 0;
  var Acc = TRecHandler("account");
  var Sum = $0;

   cmd = RSDCommand(" SELECT t_account, t_code_currency, t_chapter " +
                    "   FROM daccount$_dbt " +
                    "  WHERE rsi_rsb_account.restac(t_account, " +
                    "                           t_code_currency, " +
                    "                           ?, " +
                    "                           t_chapter, " +
                    "                           t_r0 "
                    "                          ) <> 0 " +
                    "        AND t_chapter IN (1, 3) ");
   cmd.addParam("", RSDBP_IN, {CurDate});
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   InitProgress( -1, "Обработка валютных счетов", "Обработка валютных счетов" );
   while( rsd.MoveNext() )
     Sum = $0;

     if( GetAccount( rsd.rec.Chapter, rsd.rec.Code_Currency, rsd.rec.Account, Acc ) )

        Sum = GetRestAccount( Acc.rec, {CurDate} );

        if( Acc.rec.Kind_Account == "А" )
           if( (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false )) AND
               (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ))
             )
              if( Sum < 0 )
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ), Acc.rec.Account,
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              else
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, Acc.rec.Account, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ),
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              end;
           end;
        elif( Acc.rec.Kind_Account == "П" )
           if( (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false )) AND
               (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ))
             )
              if( Sum > 0 )
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, Acc.rec.Account, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false ),
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              else
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false ), Acc.rec.Account,
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              end;
           end;
        end;

     end;
  
     UseProgress(count=count+1);
   end;
   RemProgress();

   count = 0;

   cmd = RSDCommand(" SELECT t_account, t_code_currency, t_chapter " +
                    "   FROM daccount_dbt " +
                    "  WHERE rsi_rsb_account.resta(t_account, " +
                    "                          ?, " +
                    "                          t_chapter, " +
                    "                          t_r0 "
                    "                         ) <> 0 " +
                    "        AND t_chapter IN (1, 3) ");
   cmd.addParam("", RSDBP_IN, {CurDate});
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   InitProgress( -1, "Обработка рублевух счетов", "Обработка рублевых счетов" );
   while( rsd.MoveNext() )
     Sum = $0;

     if( ( GetAccount( rsd.rec.Chapter, rsd.rec.Code_Currency, rsd.rec.Account, Acc ) ) AND 
         ( StrBrk(Acc.rec.Type_Account, "П") == 0 )
       )
        Sum = GetRestAccount( Acc.rec, {CurDate} );

        if( Acc.rec.Kind_Account == "А" )
           if( (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false )) AND
               (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ))
             )
              if( Sum < 0 )
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ), Acc.rec.Account,
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              else
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, Acc.rec.Account, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ),
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              end;
           end;
        elif( Acc.rec.Kind_Account == "П" )
           if( (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false )) AND
               (Acc.rec.Account != GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, true ))
             )
              if( Sum > 0 )
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, Acc.rec.Account, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false ),
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              else
                 Sum = ABS(Sum);
                 RunCarry( {OperDprt}, Acc.rec.Chapter, Sum, Sum, GetTrAcc( Acc.rec.Chapter, Acc.rec.Code_Currency, false ), Acc.rec.Account,
                           Acc.rec.Code_Currency, Acc.rec.Code_Currency, "Перевод средств на транзитные счета", "", true );
              end;
           end;
        end;

     end;
  
     UseProgress(count=count+1);
   end;
   RemProgress();
end;


macro ExecuteOutBalDeal( FD, dat )
   СнятьСВнебаланса( FD, dat, NULL );
  OnError( RslErrObj )
   SetError("INFO","ExecuteOutBal", RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message);
end;

macro ExecuteOutBal()
  var cmd, rsd;
  var count = 0;
  var Sum = $0;
  var FD, dat = {CurDate};

   cmd = RSDCommand(" SELECT * " +
                    "   FROM ddl_tick_dbt " +
                    "  WHERE t_DealStatus = 10 ");
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   InitProgress( -1, "Снятие сделок с внебаланса", "Снятие сделок с внебаланса" );
   while( rsd.MoveNext() )

     FD = SPFirstDoc( LEG_KIND_DL_TICK, rsd.rec.DealID );

     if( not IsREPO(FD.Group) and 
        (FD.tick.rec.DealDate > Date(1,2,2008)) and
         not IsClientDeal(FD.tick.rec) )
        SetError("INFO","ExecuteOutBal","Снимаем с внебаланса сделку № "+FD.tick.rec.DealCode );
        ExecuteOutBalDeal( FD, dat );
     end;
     UseProgress(count=count+1);
   end;
   RemProgress();

end;

ReplaceMacro ( "msgbox", "MsgSet" );

/*ExecuteOutBal();*/

ExecuteCarry();

ReplaceMacro ( "msgbox", NULL );