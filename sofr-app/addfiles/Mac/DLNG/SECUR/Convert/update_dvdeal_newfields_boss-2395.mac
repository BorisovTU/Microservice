/** 
 @file  update_dvdeal_newfields_boss-2395.mac
 @brief Обновление информации на сделках срочного рынка

 Набор функций, позволяющий в рамках единовременного запуска обновить информацию на сделках срочного рынка

 # tag
 - functional_block:Сервисные операции
 - code_type:one_time

 # changeLog 
 |date       |author         |tasks            |note                            
 |-----------|---------------|-----------------|--------------------------------------------
 |2024.04.18 |Швецов  Я. А.  |BOSS-2395        | Первоначальная реализация

*/

import spserv;

private var TestMode = true; //Тестовый режим (без фиксации действий в БД)
private var gtrec_esists = false;

// Какие именно поля обновляем
private const MODE_GATEID       = 0;
private const MODE_RUR_FIELDS   = 1;
private const MODE_BASE_AMOUNT  = 2;
private const MODE_CALC_COST    = 3;


PRIVATE CLASS TProtocolData(_DealID:integer, _DealCode:string, _Msg:string)
  var DealID       = _DealID;  
  var DealCode     = _DealCode; 
  var Msg          = _Msg; 
END;

PRIVATE CLASS TProtocolDataCosts(_DealID:integer, _DealCode:string, _FIID:integer, _FI_Name:string, _FaceValue:money, _BaseFI_Code:string, _Amount:money, _Client:integer, _Cost_old:money, _PositionCost_old:money, _Cost:money, _PositionCost:money, _BaseFut_Amount:money, _Msg:string)
  var DealID           = _DealID;  
  var DealCode         = _DealCode;
  var FIID             = _FIID;
  var FI_Name          = _FI_Name;
  var FaceValue        = _FaceValue; 
  var BaseFI_Code      = _BaseFI_Code;
  var Amount           = _Amount; 
  var Client           = _Client;
  var Cost_old         = _Cost_old;
  var PositionCost_old = _PositionCost_old; 
  var Cost             = _Cost; 
  var PositionCost     = _PositionCost;
  var BaseFut_Amount   = _BaseFut_Amount; 
  var Msg              = _Msg; 
END;

/**
 @brief Является ли финансовый инструмент артикулом с единицей измерения унции 
 @param[in] FIID ID ФИ
 @return    true - единици измерения = унциям, false - другое
*/
macro IsArticleOzt(FIID:integer):bool
   var sql, cmd, DataSet;

   sql = "  SELECT 1     "+
         "    FROM darticle_dbt fiart      "+
         "   WHERE fiart.t_FIID = ?        "+
         "     AND fiart.t_MeasureCode = ? ";

   cmd = DL_RSDCommand(sql);
   cmd.addParam(FIID);
   cmd.addParam(MEASURE_KIND_OZT);

   DataSet = cmd.execute();

   if( DataSet.MoveNext() )
     return true;
   end;

   return false;
end;

PRIVATE MACRO FindAndSetRecordID(DealID:integer, ExtDealCode:string, ErrStr:@string)
  var query, cmd, DataSet;
  var uquery, ucmd;

  ErrStr = "";

  query =   " select rec.t_RecordID " +
            "   from dgtrecord_dbt rec, dgtcode_dbt code  " +
            "    where code.t_objectkind = 86 /*Биржевая операция с ПИ*/ " +
            "      and rec.t_objectid  = code.t_objectid " +
            "      and code.t_objectcode = TO_CHAR(?) ";

  cmd = DL_RSDCOmmand(query);
  cmd.AddParam(DealID);
  DataSet = cmd.Execute();

  if(not DataSet.moveNext())
    ErrStr = "Не найдена запись в шлюзе";
    return 1;
  else 
    gtrec_esists = true;
  end;

  uquery =   " UPDATE ddvdeal_dbt " +
            "    SET  t_record_id = ? " +
            "  WHERE  t_ID = ? ";

  ucmd = DL_RSDCOmmand(uquery);
  ucmd.AddParam(DataSet.RecordID);
  ucmd.AddParam(DealID);
  ucmd.ExecuteCMD();

  return 0;
OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO FindAndSetRURFields(DealID:integer, Record_ID:integer, Amount:money, ErrStr:@string)
  var query, cmd, DataSet;
  var uquery, ucmd;

  ErrStr = "";

  query =   " select prm.t_doubleval price_rur " +
            "   from dgtrecprm_dbt prm, dgtrecord_dbt rec, dgtcode_dbt code  " +
            "  where rec.t_recordID = ? "+
            "    and code.t_objectkind = 86 /*Биржевая операция с ПИ*/ and rec.t_objectid = code.t_objectid  " +
            "    and prm.t_recordid = rec.t_recordid and prm.t_koprmid = 619 /*PRICE_RUR*/ ";


  cmd = DL_RSDCOmmand(query);
  cmd.AddParam(Record_ID);
  DataSet = cmd.Execute();

  if(not DataSet.moveNext())
    ErrStr = "Не найдена запись в шлюзе";
    return 1;
  end;

  uquery =   " UPDATE ddvdeal_dbt " +
            "    SET  t_Price_RUR = ?, " +
            "         t_PositionCost_RUR = ? " +
            "  WHERE  t_ID = ? ";

  ucmd = DL_RSDCOmmand(uquery);
  ucmd.AddParam(DataSet.Price_RUR);
  ucmd.AddParam(DataSet.Price_RUR * Amount);
  ucmd.AddParam(DealID);
  ucmd.ExecuteCMD();

  return 0;
OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO CalcBaseAmount(DealID:integer, FIID:integer, Amount:money, ErrStr:@string)
  var uquery, ucmd;
  var fin = TRecHandler("fininstr.dbt");
  var FIValue:money = $0.0;
  var ErrCode:integer = 0;
  ErrStr = "";

  if( ПолучитьФинИн( FIID, fin ) != 0 )
    ErrStr = "Не найден в справочнике финансовый инструмент с ID = \'" + FIID + "\'";
    return 1;
  end;
  
  if(IsArticleOzt(fin.rec.FaceValueFI))
    GetRegistryValue( "ПРОИЗВОДНЫЕ ИНСТРУМЕНТЫ\\ТРОЙСКАЯ УНЦИЯ В ГРАММАХ", V_DOUBLE, FIValue, ErrCode );
    if( (ErrCode != 0) or (FIValue == 0) )
      ErrStr = "Ошибка при получении значения настройки \"ПРОИЗВОДНЫЕ ИНСТРУМЕНТЫ\\ТРОЙСКАЯ УНЦИЯ В ГРАММАХ\"";
      return 1;
    end;
  else
    FIValue = fin.rec.FaceValue;
  end;
  uquery =   " UPDATE ddvdeal_dbt " +
            "    SET  t_BaseFut_Amount = ? " +
            "  WHERE  t_ID = ? ";

  ucmd = DL_RSDCOmmand(uquery);
  ucmd.AddParam(FIValue * Amount);
  ucmd.AddParam(DealID);
  ucmd.ExecuteCMD();

  return 0;
OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO CalcCostAndPositionCost(DealID:integer, FaceValue:money, Price:money, Amount:money, ErrStr:@string)
  var uquery, ucmd;
  ErrStr = "";
 
  uquery =   " UPDATE ddvdeal_dbt " +
            "    SET  t_Cost = ?, " +
            "         t_PositionCost   = ?                     "
            "  WHERE  t_ID = ? ";

  ucmd = DL_RSDCOmmand(uquery);
  ucmd.AddParam(Price * FaceValue);
  ucmd.AddParam(Price * FaceValue * Amount);
  ucmd.AddParam(DealID);
  ucmd.ExecuteCMD();

  return 0;
OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO ExecUpdateDVDeal()
  var query, cmd, DataSet;
  var cnt = 0, i = 0;
  var LogArr = TArray(10000);
  var SystDate = Date, SystTime = Time;
  var err = 0, ErrStr = "";
  var err_cnt = 0;
  var gtrec_exists_cnt = 0, gtrec_notexists_cnt = 0;

  //Меню выбора
  var m = TArray();
  m(MODE_GATEID)      = "Заполнение Record_ID из шлюза";
  m(MODE_RUR_FIELDS)  = "Заполнение цены и суммы операции в рублях из шлюза";
  m(MODE_BASE_AMOUNT) = "Заполнение количества базового актива операции в рублях из шлюза";
  m(MODE_CALC_COST)   = "Перерасчёт цены и стоимости по операциям срочного рынка";

  var choice = menu(m);

  if(choice < 0) //Выход из меню
    return 0;
  elif(choice == MODE_GATEID) //Заполнение Record_ID сделок срочного рынка 
    if(GetTRUE(FALSE, "Выполнить с фиксацией действий в БД?\n"
                     +"(НЕТ - процедура выполнится в тестовом режиме без сохранения изменений в базе; ДА - все успешные изменения будут сохранены в базе)\n"
                     +"Первый запуск рекомендуется выполнить в тестовом режиме и проверить, что процедура выполнится без ошибок."))
      TestMode = false;
    end;
  
    query =  "  select deal.t_id, deal.t_extcode "
           + "    from ddvdeal_dbt deal "
           + "   where deal.t_record_id = 0 ";

    cmd = DL_RSDCommand(query);
    cnt = cmd.GetCount();

    if(cnt > 0)
      InitProgress(cnt, "Обработка сделок", "Обработка сделок");
    
      DataSet = cmd.Execute();
      while(DataSet.moveNext())

        err = 0;
        ErrStr = "";
        gtrec_esists = false;

        RslDefCon.BeginTrans();

        err = FindAndSetRecordID(DataSet.ID, DataSet.ExtCode, @ErrStr);
        
        if((TestMode) or (err))
          RslDefCon.RollbackTrans();
        else
          RslDefCon.CommitTrans();
        end;
        
        if(err)
          LogArr[LogArr.size()] = TProtocolData(DataSet.ID, DataSet.ExtCode, ErrStr);
          err_cnt = err_cnt + 1;
          if(gtrec_esists)
            gtrec_exists_cnt = gtrec_exists_cnt + 1;            
          else
            gtrec_notexists_cnt = gtrec_notexists_cnt + 1;
          end;
        else
          gtrec_exists_cnt = gtrec_exists_cnt + 1;
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      InitProgress(LogArr.size(), "Печать протокола", "Печать протокола");
     
               [                                                        Обновление Record_ID по сделкам срочного рынка
               Дата выполнения:  #############
               Время выполнения: #############
               Сделок без Record_ID: #############
               Найдено в шлюзе: ######### Не найдено в шлюзе: ######### Обновлены: ######### Не обновлены: #########
               ]
               (SystDate:f, SystTime, cnt, gtrec_exists_cnt, gtrec_notexists_cnt, cnt - err_cnt, err_cnt);

      println("");
      println("СПИСОК СДЕЛОК, ПО КОТОРЫМ НЕ ОБНОВЛЕНО ПОЛЕ RECORD_ID");
      println("┌─────────────┬──────────────────────────────┐");
      println("│   DealID    │     Внешний код сделки       │");
      println("│             │                              │");
      println("├─────────────┼──────────────────────────────┤");

      i = 0;
      while(i < LogArr.size())
              [│#############│##############################│########################################]
              (string(LogArr[i].DealID):c,     
               string(LogArr[i].DealCode):c,     
               string(LogArr[i].Msg):l:w
              );

        if(i < LogArr.size() - 1)
          println("├─────────────┼──────────────────────────────┤");
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      println("└─────────────┴──────────────────────────────┘");
    else
      msgbox("Не найдены сделки с незаполненным поле Record_ID");
    end;
  elif(choice == MODE_RUR_FIELDS) //Заполнение цены и стоимости по сделке в рублях из шлюза
    if(GetTRUE(FALSE, "Выполнить с фиксацией действий в БД?\n"
                     +"(НЕТ - процедура выполнится в тестовом режиме без сохранения изменений в базе; ДА - все успешные изменения будут сохранены в базе)\n"
                     +"Первый запуск рекомендуется выполнить в тестовом режиме и проверить, что процедура выполнится без ошибок."))
      TestMode = false;
    end;
  
    query =  "  select deal.t_id, deal.t_extcode, deal.t_record_id, deal.t_amount "
           + "    from ddvdeal_dbt deal "
           + "   where deal.t_price_rur = 0 or deal.t_positioncost_rur = 0 ";

    cmd = DL_RSDCommand(query);
    cnt = cmd.GetCount();

    if(cnt > 0)
      InitProgress(cnt, "Обработка сделок", "Обработка сделок");
    
      DataSet = cmd.Execute();
      while(DataSet.moveNext())

        err = 0;
        ErrStr = "";
        if(DataSet.Record_ID == 0)
          ErrStr = "Не установлено значение Record_ID на сделке";
          err = 1;
        else
          RslDefCon.BeginTrans();

          err = FindAndSetRURFields(DataSet.ID, DataSet.Record_ID, DataSet.Amount, @ErrStr);
        
          if((TestMode) or (err))
            RslDefCon.RollbackTrans();
          else
            RslDefCon.CommitTrans();
          end;
        end;
        if(err)
          LogArr[LogArr.size()] = TProtocolData(DataSet.ID, DataSet.ExtCode, ErrStr);
          err_cnt = err_cnt + 1;
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      InitProgress(LogArr.size(), "Печать протокола", "Печать протокола");
     
               [                                                        Обновление Record_ID по сделкам срочного рынка
               Дата выполнения:  #############
               Время выполнения: #############
               Сделок с незаполненными ценой или стоимостью в рублях: #############
               Обновлены: ######### Не обновлены: #########
               ]
               (SystDate:f, SystTime, cnt, cnt - err_cnt, err_cnt);

      println("");
      println("СПИСОК СДЕЛОК, ПО КОТОРЫМ НЕ ОБНОВЛЕНЫ ПОЛЯ PRICE_RUR И POSITIONCOST_RUR");
      println("┌─────────────┬──────────────────────────────┐");
      println("│   DealID    │     Внешний код сделки       │");
      println("│             │                              │");
      println("├─────────────┼──────────────────────────────┤");

      i = 0;
     while(i < LogArr.size())
              [│#############│##############################│########################################]
              (string(LogArr[i].DealID):c,     
               string(LogArr[i].DealCode):c,     
               string(LogArr[i].Msg):l:w
              );

        if(i < LogArr.size() - 1)
          println("├─────────────┼──────────────────────────────┤");
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      println("└─────────────┴──────────────────────────────┘");

    else
      msgbox("Не найдены сделки с незаполненными полями цены и стоимости по операции в рублях");
    end;
  elif(choice == MODE_BASE_AMOUNT) //Заполнение цены и стоимости по сделке в рублях из шлюза
    if(GetTRUE(FALSE, "Выполнить с фиксацией действий в БД?\n"
                     +"(НЕТ - процедура выполнится в тестовом режиме без сохранения изменений в базе; ДА - все успешные изменения будут сохранены в базе)\n"
                     +"Первый запуск рекомендуется выполнить в тестовом режиме и проверить, что процедура выполнится без ошибок."))
      TestMode = false;
    end;
  
    query =  "  select deal.t_id, deal.t_extcode, deal.t_FIID, deal.t_amount "
           + "    from ddvdeal_dbt deal "
           + "   where deal.t_basefut_amount = 0 ";

    cmd = DL_RSDCommand(query);
    cnt = cmd.GetCount();

    if(cnt > 0)
      InitProgress(cnt, "Обработка сделок", "Обработка сделок");
    
      DataSet = cmd.Execute();
      while(DataSet.moveNext())
        err = 0;
        ErrStr = "";
        RslDefCon.BeginTrans();

        err = CalcBaseAmount(DataSet.ID, DataSet.FIID, DataSet.Amount, @ErrStr);
        
        if((TestMode) or (err))
          RslDefCon.RollbackTrans();
        else
          RslDefCon.CommitTrans();
        end;

        if(err)
          LogArr[LogArr.size()] = TProtocolData(DataSet.ID, DataSet.ExtCode, ErrStr);
          err_cnt = err_cnt + 1;
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      InitProgress(LogArr.size(), "Печать протокола", "Печать протокола");
     
               [                                                        Обновление Record_ID по сделкам срочного рынка
               Дата выполнения:  #############
               Время выполнения: #############
               Сделок с незаполненными ценой или стоимостью в рублях: #############
               Обновлены: ######### Не обновлены: #########
               ]
               (SystDate:f, SystTime, cnt, cnt - err_cnt, err_cnt);

      println("");
      println("СПИСОК СДЕЛОК, ПО КОТОРЫМ НЕ ОБНОВЛЕНО ПОЛЕ BASEFUT_AMOUNT");
      println("┌─────────────┬──────────────────────────────┐");
      println("│   DealID    │     Внешний код сделки       │");
      println("│             │                              │");
      println("├─────────────┼──────────────────────────────┤");

      i = 0;
      while(i < LogArr.size())
              [│#############│##############################│########################################]
              (string(LogArr[i].DealID):c,     
               string(LogArr[i].DealCode):c,     
               string(LogArr[i].Msg):l:w
              );

        if(i < LogArr.size() - 1)
          println("├─────────────┼──────────────────────────────┤");
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      println("└─────────────┴──────────────────────────────┘");

    else
      msgbox("Не найдены сделки с незаполненными полями цены и стоимости по операции в рублях");
    end;
  elif(choice == MODE_CALC_COST) //Перерасчёт цены и стоимости по операциям срочного рынка
    if(GetTRUE(FALSE, "Выполнить с фиксацией действий в БД?\n"
                     +"(НЕТ - процедура выполнится в тестовом режиме без сохранения изменений в базе; ДА - все успешные изменения будут сохранены в базе)\n"
                     +"Первый запуск рекомендуется выполнить в тестовом режиме и проверить, что процедура выполнится без ошибок."))
      TestMode = false;
    end;
    query =  "  select deal.t_id, deal.t_extcode, deal.t_FIID, deal.t_amount, deal.t_client, deal.t_cost cost_old, deal.t_basefut_amount,  " +
             "         deal.t_positioncost t_positioncost_old, deal.t_price, fin.t_name, fin.t_facevalue, base_fin.t_fi_code code_base " +
             "    from ddvdeal_dbt deal, dfininstr_dbt fin, dfininstr_dbt base_fin " +
             "   where deal.t_fiid = fin.t_fiid and fin.t_fi_kind = 4 /*ПИ*/ and fin.t_avoirkind = 1/*Фючерс*/ " +
             "     and base_fin.t_fiid = fin.t_facevaluefi and base_fin.t_fi_kind IN (3,7) /*Индекс или артикул*/ " +
             "     and base_fin.t_parentfi > 0 /*Валюта шага цены не рубли или пункты*/ ";

    cmd = DL_RSDCommand(query);
    cnt = cmd.GetCount();

    if(cnt > 0)
      InitProgress(cnt, "Обработка сделок", "Обработка сделок");
    
      DataSet = cmd.Execute();
      while(DataSet.moveNext())
        err = 0;
        ErrStr = "";
        RslDefCon.BeginTrans();

        err = CalcCostAndPositionCost(DataSet.ID, DataSet.FaceValue, DataSet.Price, DataSet.Amount, @ErrStr);
        
        if((TestMode) or (err))
          RslDefCon.RollbackTrans();
        else
          RslDefCon.CommitTrans();
        end;

        LogArr[LogArr.size()] = TProtocolDataCosts(DataSet.ID, DataSet.ExtCode, DataSet.FIID, DataSet.Name, DataSet.Facevalue, DataSet.Code_Base, DataSet.Amount, DataSet.Client, DataSet.Cost_Old, DataSet.PositionCost_Old, DataSet.FaceValue*DataSet.Price, DataSet.FaceValue*DataSet.Price*DataSet.Amount, DataSet.BaseFut_Amount, ErrStr);
        err_cnt = err_cnt + 1;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      InitProgress(LogArr.size(), "Печать протокола", "Печать протокола");
     
               [                                                        Обновление Record_ID по сделкам срочного рынка
               Дата выполнения:  #############
               Время выполнения: #############
               Сделок с незаполненными ценой или стоимостью в рублях: #############
               Обновлены: ######### Не обновлены: #########
               ]
               (SystDate:f, SystTime, cnt, cnt - err_cnt, err_cnt);

      println("");
      println("СПИСОК СДЕЛОК, ПО КОТОРЫМ ВЫПОЛНЕН ПЕРЕРАСЧЁТ ПОЛЕЙ ЦЕНА 2 И СТОИМОСТЬ ПО ОПЕРАЦИИ");
      println("┌─────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┬──────────────────────────────┐");
      println("│   DealID    │     Внешний код сделки       │ ID фин. инструмента по сделке│ Наименование фин. инструмента│      Количество лотов        │     Код базового актива      │Количество контрактов в сделке│  Собственная или клиентская  │      Цена до пересчёта       │    Стоимость до пересчёта    │    Цена после пересчёта      │   Стоимость после пересчёта  │  Количество базового актива  │");
      println("│             │                              │                              │                              │                              │                              │                              │                              │                              │                              │                              │                              │                              │");
      println("├─────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤");

      i = 0;
      while(i < LogArr.size())
              [│#############│##############################│##############################│##############################│##############################│##############################│##############################│##############################│##############################│##############################│##############################│##############################│##############################│########################################]
              (string(LogArr[i].DealID):c,     
               string(LogArr[i].DealCode):c,
               string(LogArr[i].FIID):c,
               string(LogArr[i].FI_Name):c,
               string(LogArr[i].FaceValue):c,
               string(LogArr[i].BaseFI_Code):c,
               string(LogArr[i].Amount):c,
               string(IIF(LogArr[i].Client > 0,"клиентская", "собственная")):c,
               string(LogArr[i].Cost_old):c,
               string(LogArr[i].PositionCost_old):c,
               string(LogArr[i].Cost):c,
               string(LogArr[i].PositionCost):c,
               string(LogArr[i].BaseFut_Amount):c,   
               string(LogArr[i].Msg):l:w
              );

        if(i < LogArr.size() - 1)
          println("├─────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤");
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      println("└─────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┘");

    else
      msgbox("Не найдены сделки с незаполненными полями цены и стоимости по операции в рублях");
    end;            
  end;
OnError(er)
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  msgbox("Ошибка: " + er.Message);
END;

ExecUpdateDVDeal();
