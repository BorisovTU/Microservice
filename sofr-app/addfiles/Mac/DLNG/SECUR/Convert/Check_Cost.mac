 // Макрос проверки необходимости правки стоимости на лотах по запросу 157644.
import "cb_sql.mac";

private macro Check(Обновление)
   var v_Kind, sql, cmd, LS, cmd2, L2, cmd3, cmd4, cmd5, cmd6, LR, NRecs:integer = 0;
   var v_SAmount, v_RAmount, v_Err = 0, v_NCost = -1, v_NBalanceCost = -1, v_NRCost = -1, v_NRBalanceCost = -1, v_OverAmount;
   var v_RCost, v_ROverAmount, v_RBalanceCost, v_Cost, v_BalanceCost, v_NRAction;

   cmd = RSDCommand(" SELECT LS.T_BCID, LS.T_SUMID, LS.T_CHANGEDATE, LS.T_DEALCODE, LS.T_INSTANCE, " +
                    " LS.T_SOURCE, LS.T_AMOUNT, LS.T_COST, LS.T_BALANCECOST, LS.T_KIND, " +
                    " LS.T_NKDAMOUNT, LS.T_INTERESTINCOME, LS.T_DISCOUNTINCOME, " +
                    " llval.t_Name, Fin.t_FaceValueFI, LS.T_ID_OPERATION, LS.T_ID_STEP " +
                    " FROM V_SCWRTHISTEX LS, dllvalues_dbt llval, dfininstr_dbt Fin " +
                    "  where LS.T_ACTION = 480                           " +
                    "    AND LS.T_KIND   in (210, 190)                   " +
                    "    AND LS.T_INSTANCE = 0                           " +
                    "    AND LS.T_PORTFOLIO = llval.t_Element            " +
                    "    AND LS.T_FIID    = Fin.T_FIID                   " +
                    "    AND llval.t_List = 1100                         " +
//                    "    AND LS.T_DEALCODE = '2605'                      " +
                    "  ORDER BY LS.T_SUMID ASC, LS.T_INSTANCE ASC "
                   );

   cmd.execute();
   LS = TRsbDataSet( cmd );

   PrintLn("Протокол сравнения стоимостных параметров лотов");

   while (LS.MoveNext())
      v_Kind = SQL_ConvTypeInteger(LS.T_KIND);

      if (v_Kind == 210)
         PrintLn("\nЛот исполнения КП за " + SQL_ConvTypeDate(LS.T_CHANGEDATE) + 
                 " по ПР " + LS.T_DEALCODE + ". Портфель \"" + LS.t_Name + "\"");
      else
         PrintLn("\nЛот исполнения КП за " + SQL_ConvTypeDate(LS.T_CHANGEDATE) + 
                 " по ОР " + LS.T_DEALCODE + ". Портфель \"" + LS.t_Name + "\"");
      end;

      v_Err = 0;

      cmd2 = RSDCommand(" SELECT LR.T_BCID, LR.T_SUMID, LR.T_INSTANCE, LR.T_SOURCE, LR.T_AMOUNT, " +
                        " LR.T_COST, LR.T_BALANCECOST, LR.T_NKDAMOUNT, LR.T_INTERESTINCOME, " +
                        " LR.T_DISCOUNTINCOME, LR.T_ACTION FROM V_SCWRTHISTEX LR " +
                        "  where LR.T_ACTION in (480,490)                        " +
                        "    AND LR.T_KIND   = " + v_Kind +
                        "    AND LR.T_SUMID  = " + SQL_ConvTypeInteger(LS.T_SOURCE) +
                        "    AND LR.T_ID_OPERATION = " + SQL_ConvTypeInteger(LS.T_ID_OPERATION) +
                        "    AND LR.T_ID_STEP  = " + SQL_ConvTypeInteger(LS.T_ID_STEP)
                       );
      cmd2.execute();
      LR = TRsbDataSet( cmd2 );

      if (not LR.MoveNext())
         PrintLn("Не найдена запись LR. Нарушение согласованности данных.");
         v_Err = v_Err +1;
      end;

      cmd3 = RSDCommand(" SELECT L2.T_BCID, L2.T_SUMID, L2.T_INSTANCE, L2.T_AMOUNT, " +
                        " L2.T_OVERAMOUNT, L2.T_BALANCECOST, L2.T_COST, L2.T_NKDAMOUNT, " +
                        " L2.T_INTERESTINCOME, L2.T_DISCOUNTINCOME, L2.T_PORTFOLIO FROM dpmwrtbc_dbt L2 " +
                        "  where L2.T_SUMID = " + SQL_ConvTypeInteger(LR.T_SUMID) +
                        "    AND L2.T_INSTANCE = " + (SQL_ConvTypeInteger(LR.T_INSTANCE) - 1)
                       );
      cmd3.execute();
      L2 = TRsbDataSet( cmd3 );

      // Если не нашли
      if (not L2.MoveNext())
         PrintLn("Не найдена запись L2. Нарушение согласованности данных.");
         v_Err = v_Err +1;
      end;

      if (v_Err == 0)
         v_NCost = -1;
         v_NBalanceCost = -1;
         v_NRCost = -1;
         v_NRBalanceCost = -1;
         v_NRAction = -1;
         v_SAmount = SQL_ConvTypeSum(LS.T_AMOUNT);
         v_RAmount = SQL_ConvTypeSum(L2.T_AMOUNT) - v_SAmount;

         if ((v_Kind == 210) and (v_RAmount != SQL_ConvTypeSum(LR.T_AMOUNT)))
            PrintLn("Неверное значение количества в лоте остатка T_AMOUNT " + SQL_ConvTypeSum(LR.T_AMOUNT) + 
                    ", должно быть " + v_RAmount);
            v_Err = v_Err +1;
         end;

         if (SQL_ConvTypeInteger(LR.T_ACTION) != 490)
            PrintLn("Неверное значение Вида действия в лоте остатка T_ACTION " + SQL_ConvTypeInteger(LR.T_ACTION) + 
                    ", должно быть 490 (Учет компенсационной поставки)" );
            v_Err = v_Err +1;
            v_NRAction = 490;
         end;

         if ( ( (SQL_ConvTypeInteger(L2.T_PORTFOLIO) == 1) or 
                (SQL_ConvTypeInteger(L2.T_PORTFOLIO) == 2) or
                (SQL_ConvTypeInteger(L2.T_PORTFOLIO) == 5)
              ) and (v_Kind == 210)
            )

            if ((SQL_ConvTypeInteger(LS.t_FaceValueFI) == 0) and (SQL_ConvTypeSum(L2.T_OVERAMOUNT) != 0))
               v_OverAmount = SQL_ConvTypeSum(L2.T_OVERAMOUNT);
            else
               v_OverAmount = SQL_ConvTypeSum(L2.T_BALANCECOST) - SQL_ConvTypeSum(L2.T_COST) - 
                              SQL_ConvTypeSum(L2.T_NKDAMOUNT) - SQL_ConvTypeSum(L2.T_INTERESTINCOME) - 
                              SQL_ConvTypeSum(L2.T_DISCOUNTINCOME);
            end;

            v_RCost = round(SQL_ConvTypeSum(L2.T_COST)* v_RAmount/ SQL_ConvTypeSum(L2.T_AMOUNT));
            v_ROverAmount = round(v_OverAmount * v_RAmount/ SQL_ConvTypeSum(L2.T_AMOUNT));

            v_RBalanceCost = v_RCost + SQL_ConvTypeSum(LR.T_NKDAMOUNT) + 
                             SQL_ConvTypeSum(LR.T_INTERESTINCOME) + SQL_ConvTypeSum(LR.T_DISCOUNTINCOME) + v_ROverAmount;

            v_Cost = SQL_ConvTypeSum(L2.T_COST) - v_RCost;
            v_BalanceCost = v_Cost + SQL_ConvTypeSum(LS.T_NKDAMOUNT) + SQL_ConvTypeSum(LS.T_INTERESTINCOME) + 
                            SQL_ConvTypeSum(LS.T_DISCOUNTINCOME) + v_OverAmount - v_ROverAmount;

            if (SQL_ConvTypeSum(LS.T_COST) != v_Cost)
               PrintLn("Неверное значение Счист T_COST " + SQL_ConvTypeSum(LS.T_COST) + 
                       ", должно быть " + v_Cost);
               v_Err = v_Err +1;
               v_NCost = v_Cost;
            end;

            if (SQL_ConvTypeSum(LS.T_BALANCECOST) != v_BalanceCost)
               PrintLn("Неверное значение Стек T_BALANCECOST " + SQL_ConvTypeSum(LS.T_BALANCECOST) + 
                       ", должно быть " + v_BalanceCost);
               v_Err = v_Err +1;
               v_NBalanceCost = v_BalanceCost;
            end;

            if (SQL_ConvTypeSum(LR.T_COST) != v_RCost)
               PrintLn("Неверное значение Счист в лоте остатка T_COST " + SQL_ConvTypeSum(LR.T_COST) + 
                       ", должно быть " + v_RCost);
               v_Err = v_Err +1;
               v_NRCost = v_RCost;
            end;

            if (SQL_ConvTypeSum(LR.T_BALANCECOST) != v_RBalanceCost)
               PrintLn("Неверное значение Стек в лоте остатка T_BALANCECOST " + SQL_ConvTypeSum(LR.T_BALANCECOST) + 
                       ", должно быть " + v_RBalanceCost);
               v_Err = v_Err +1;
               v_NRBalanceCost = v_RBalanceCost;
            end;
         end;

         if (v_Err == 0)
            PrintLn("Лот ОК");

         else
            if (Обновление)
               // отключаем триггер
               cmd4 = RSDCommand(" ALTER TRIGGER DPMWRTLNK_DBT_TBI DISABLE ");
               cmd4.execute();

               if (v_NCost != -1)
                  if (SQL_ConvTypeInteger(LS.T_BCID) > 0)
                     cmd5 = RSDCommand( "UPDATE DPMWRTBC_DBT " +
                                       "   SET T_COST = ? " +
                                       " WHERE T_BCID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LS.T_BCID) ); 
                     cmd5.execute();
                  else
                     cmd5 = RSDCommand( "UPDATE DPMWRTSUM_DBT " +
                                       "   SET T_COST = ? " +
                                       " WHERE T_SUMID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LS.T_SUMID) ); 
                     cmd5.execute();
                  end;
               end;

               if (v_NBalanceCost != -1)
                  if (SQL_ConvTypeInteger(LS.T_BCID) > 0)
                     cmd5 = RSDCommand( "UPDATE DPMWRTBC_DBT " +
                                       "   SET T_BALANCECOST = ? " +
                                       " WHERE T_BCID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NBalanceCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LS.T_BCID) ); 
                     cmd5.execute();
                  else
                     cmd5 = RSDCommand( "UPDATE DPMWRTSUM_DBT " +
                                       "   SET T_BALANCECOST = ? " +
                                       " WHERE T_SUMID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NBalanceCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LS.T_SUMID) ); 
                     cmd5.execute();
                  end;
               end;

               if (v_NRCost != -1)
                  if (SQL_ConvTypeInteger(LR.T_BCID) > 0)
                     cmd5 = RSDCommand( "UPDATE DPMWRTBC_DBT " +
                                       "   SET T_COST = ? " +
                                       " WHERE T_BCID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NRCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LR.T_BCID) ); 
                     cmd5.execute();
                  else
                     cmd5 = RSDCommand( "UPDATE DPMWRTSUM_DBT " +
                                       "   SET T_COST = ? " +
                                       " WHERE T_SUMID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NRCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LR.T_SUMID) ); 
                     cmd5.execute();
                  end;
               end;

               if (v_NRBalanceCost != -1)
                  if (SQL_ConvTypeInteger(LR.T_BCID) > 0)
                     cmd5 = RSDCommand( "UPDATE DPMWRTBC_DBT " +
                                       "   SET T_BALANCECOST = ? " +
                                       " WHERE T_BCID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NRBalanceCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LR.T_BCID) ); 
                     cmd5.execute();
                  else
                     cmd5 = RSDCommand( "UPDATE DPMWRTSUM_DBT " +
                                       "   SET T_BALANCECOST = ? " +
                                       " WHERE T_SUMID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NRBalanceCost ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LR.T_SUMID) ); 
                     cmd5.execute();
                  end;
               end;

               if (v_NRAction != -1)
                  if (SQL_ConvTypeInteger(LR.T_BCID) > 0)
                     cmd5 = RSDCommand( "UPDATE DPMWRTBC_DBT " +
                                       "   SET T_ACTION = ? " +
                                       " WHERE T_BCID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NRAction ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LR.T_BCID) ); 
                     cmd5.execute();
                  else
                     cmd5 = RSDCommand( "UPDATE DPMWRTSUM_DBT " +
                                       "   SET T_ACTION = ? " +
                                       " WHERE T_SUMID = ? "
                                      );

                     cmd5.addParam( "", RSDBP_IN, v_NRAction ); 
                     cmd5.addParam( "", RSDBP_IN, SQL_ConvTypeInteger(LR.T_SUMID) ); 
                     cmd5.execute();
                  end;
               end;

               if ((SQL_ConvTypeInteger(LS.T_BCID) != 0) and 
                   ((v_NCost != -1) or (v_NBalanceCost != -1))
                  )
                  cmd6 = RsdCommand( RslDefCon, "begin\n RSB_PMWRTOFF.SetCostToHist(?,?,?,?,?);\n end; ");

                  cmd6.addParam("pSumID",       RSDBP_IN,     SQL_ConvTypeInteger(LS.T_SUMID) ); 
                  cmd6.addParam("pInstance",    RSDBP_IN,     SQL_ConvTypeInteger(LS.T_INSTANCE) + 1 ); 
                  cmd6.addParam("pCost",        RSDBP_IN,     v_NCost ); 
                  cmd6.addParam("pBalanceCost", RSDBP_IN,     v_NBalanceCost ); 
                  cmd6.addParam("pAmount",      RSDBP_IN,     v_SAmount ); 
                  cmd6.execute();
               end;

               if ((SQL_ConvTypeInteger(LR.T_BCID) != 0) and 
                   ((v_NRCost != -1) or (v_NRBalanceCost != -1))
                  )
                  cmd6 = RsdCommand( RslDefCon, "begin\n RSB_PMWRTOFF.SetCostToHist(?,?,?,?,?);\n end; ");

                  cmd6.addParam("pSumID",       RSDBP_IN,     SQL_ConvTypeInteger(LR.T_SUMID) ); 
                  cmd6.addParam("pInstance",    RSDBP_IN,     SQL_ConvTypeInteger(LR.T_INSTANCE) + 1 ); 
                  cmd6.addParam("pCost",        RSDBP_IN,     v_NRCost ); 
                  cmd6.addParam("pBalanceCost", RSDBP_IN,     v_NRBalanceCost ); 
                  cmd6.addParam("pAmount",      RSDBP_IN,     v_RAmount ); 
                  cmd6.execute();
               end;

               // включаем триггер
               cmd4 = RSDCommand(" ALTER TRIGGER DPMWRTLNK_DBT_TBI ENABLE ");
               cmd4.execute();

               // выводим сообщения
               sql = " SELECT * FROM dsctxmes_dbt WHERE t_ID > 0 and t_type = 100 order by t_id ";
               cmd6 = TRsbDataSet(sql);
               while(cmd6.MoveNext())
                  println(SQL_ConvTypeStr(cmd6.t_Message));
               end;

               // Чистим лог.
               cmd6 = RsdCommand( RslDefCon, "DELETE FROM dsctxmes_dbt WHERE t_type = 100");
               cmd6.execute();
            end;
         end;
      end;
   end;
end;

//Check(true); // для обновления
Check();
