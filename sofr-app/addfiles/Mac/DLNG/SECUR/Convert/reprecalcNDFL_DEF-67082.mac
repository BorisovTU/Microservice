/*
$Name:        reprecalcNDLF.mac
$Module:      Ценные бумаги
$Description: Изенение НОБ в результате пересчета
*/
import secinter, sp_categ, nptxfun, "sprepfun.mac";

private macro PrintClientList()
  var query, cmd, DataSet, cnt = 0, i = 0;
  var queryCountToDelete, cmdCount, CountDataSet;
  var queryToDelete, cmdDelete, CountToDeleteDataSet;
  var CountToDelete:integer;
  var MesStr = "";
  var sizeH1_1 = 15, sizeH1_2 = 45, sizeH1_3 = 16, sizeH1_4 = 12, sizeH1_5 = 14, sizeH1_6 = 14, sizeH1_7 = 14, sizeH1_8 = 46;
  var sizeHeader = (sizeH1_1+1) + (sizeH1_2+1) + (sizeH1_3+1) + (sizeH1_4+1) + (sizeH1_5+1) + (sizeH1_6+1) + (sizeH1_7+1) + (sizeH1_8+1);

  var Rep = CMakeReport();

  Rep.AddPrintCell("Клиенты, по которым выполнялся пересчет НОБ", sizeHeader, 0, "c:ex_FS(b)", REP_ELEM_STR);
  Rep.AddStr();
  Rep.AddEmptyStr(1, sizeHeader);

  query =   " select op.t_Client, EXTRACT(YEAR FROM op.t_EndRecalcDate) as t_Year, op.t_Code, op.t_Status, pt.t_Name, "
          + "        (select obj.t_code from dobjcode_dbt obj where obj.t_objecttype = 3 and obj.t_codekind = 1 and obj.t_objectid = op.t_Client and obj.t_state = 0) as ClientCode, "
          + "        (select NVL(SUM(obj.t_Sum0),0) from dnptxobdc_dbt odc, dnptxobj_dbt obj where odc.t_DocID = op.t_ID and obj.t_ObjID = odc.t_ObjID and obj.t_Kind = "+TXOBJ_BASEG2+") as NewNOB, "
          + "        (select NVL(SUM(obj.t_Sum0),0) from dnptxobjbc_dbt obj where obj.t_DocID = op.t_ID and obj.t_Kind = "+TXOBJ_BASEG2+") as OldNOB, "
          + "        (select NVL(LISTAGG(TRIM(ms.t_Message), '\n ') WITHIN GROUP (ORDER BY ms.t_ID ASC), CHR(1)) from dnptxmes_dbt ms where ms.t_DocID = op.t_ID and ms.t_Type = 10) as MesStr "
          + "   from dnptxop_dbt op, dparty_dbt pt "
          + "  where op.t_DocKind = 4605 "
          + "    and op.t_Recalc = 'X' "
          + "    and instr(op.t_Code, '67082_') > 0 "
          + "    and pt.t_PartyID = op.t_Client "
          + " order by op.t_Client, EXTRACT(YEAR FROM op.t_EndRecalcDate) ";

  cmd = DL_RSDCommand(query);

  cnt = cmd.GetCount();

  if(cnt > 0)

    DataSet = cmd.Execute();

    Rep.AddPrintCell("Код клиента", sizeH1_1, 0, "l:ex_FS(b)");
    Rep.AddPrintCell("ФИО", sizeH1_2, 0, "l:w:ex_FS(b)");
    Rep.AddPrintCell("Код операции пересчета", sizeH1_3, 0, "l:ex_FS(b)");
    Rep.AddPrintCell("Налоговый период", sizeH1_4, 0, "l:ex_FS(b)");
    Rep.AddPrintCell("НОБ ДО пересчета", sizeH1_5, 0, "l:ex_FS(b)");
    Rep.AddPrintCell("НОБ ПОСЛЕ пересчета", sizeH1_6, 0, "l:ex_FS(b)");
    Rep.AddPrintCell("Изменение НОБ", sizeH1_7, 0, "l:ex_FS(b)");
    Rep.AddPrintCell("Сообщение", sizeH1_8, 0, "l:ex_FS(b)");
    Rep.AddStr();

    i = 0;
    while(DataSet.moveNext())
       MesStr = "";

       if(DataSet.Status != 2)
         MesStr = "Операция не закрыта!";
       end;

       if(MesStr != "")
         MesStr = MesStr + "\n"+ DataSet.MesStr;
       end;

       Rep.AddPrintCell(string(DataSet.ClientCode), sizeH1_1, 0, "с");
       Rep.AddPrintCell(string(DataSet.Name), sizeH1_2, 0, "l:w");
       Rep.AddPrintCell(string(DataSet.Code), sizeH1_3, 0, "с");
       Rep.AddPrintCell(string(int(DataSet.Year)), sizeH1_4, 0, "с");
       Rep.AddPrintCell(money(DataSet.OldNOB), sizeH1_5, 0, "с");
       Rep.AddPrintCell(money(DataSet.NewNOB), sizeH1_6, 0, "с");
       Rep.AddPrintCell(money(DataSet.NewNOB-DataSet.OldNOB), sizeH1_7, 0, "с");
       Rep.AddPrintCell(MesStr, sizeH1_8, 0, "l:w");
       Rep.AddStr();

       i = i + 1;
    end;
    
    Rep.AddStr();
    
    queryCountToDelete = 
        "SELECT COUNT(*) CountToDelete FROM DNPTXOP_DBT                                             "
      + " WHERE T_ID IN                                                                             "
      + "   (SELECT T_ID FROM DNPTXOP_DBT OPER                                                      "
      + "     WHERE T_KIND_OPERATION IN (2035, 2043)                                                "
      + "       AND T_STATUS  = 0                                                                   "
      + "       AND T_OPERDATE < TO_DATE('01.01.2024', 'dd.mm.yyyy')                                "
      + "       AND EXISTS (                                                                        "
      + "             SELECT 1                                                                      "
      + "               FROM DNPTXOP_DBT INER                                                       "
      + "              WHERE INER.T_OPERDATE BETWEEN OPER.T_OPERDATE                                "
      + "                AND TO_DATE('31.12.'||EXTRACT(YEAR FROM OPER.T_OPERDATE), 'dd.mm.yyyy')    "
      + "                AND INER.T_KIND_OPERATION = OPER.T_KIND_OPERATION                          "
      + "                AND INER.T_CLIENT = OPER.T_CLIENT                                          "
      + "                AND INER.T_STATUS = 2)                                                     "
      + "       AND EXISTS(                                                                         "
      + "             SELECT 1                                                                      "
      + "               FROM DNPTXOP_DBT TWTH                                                       "
      + "              WHERE TWTH.T_CLIENT = OPER.T_CLIENT                                          "
      + "                AND TWTH.T_OPERDATE = TO_DATE('31.12.2023', 'dd.mm.yyyy')                  "
      + "                AND TWTH.T_STATUS = 2                                                      "
      + "                AND TWTH.T_CODE LIKE '67082._%' ESCAPE '.' ))                              ";
      
    cmdCount        = DL_RSDCommand(queryCountToDelete);
    CountDataSet    = cmdCount.Execute();
    CountDataSet.moveNext();
    CountToDelete = CountDataSet.CountToDelete;
    
    if (CountToDelete > 0)
        queryToDelete = 
            "DELETE FROM DNPTXOP_DBT                                                                    "
          + " WHERE T_ID IN                                                                             "
          + "   (SELECT T_ID FROM DNPTXOP_DBT OPER                                                      "
          + "     WHERE T_KIND_OPERATION IN (2035, 2043)                                                "
          + "       AND T_STATUS  = 0                                                                   "
          + "       AND T_OPERDATE < TO_DATE('01.01.2024', 'dd.mm.yyyy')                                "
          + "       AND EXISTS (                                                                        "
          + "             SELECT 1                                                                      "
          + "               FROM DNPTXOP_DBT INER                                                       "
          + "              WHERE INER.T_OPERDATE BETWEEN OPER.T_OPERDATE                                "
          + "                AND TO_DATE('31.12.'||EXTRACT(YEAR FROM OPER.T_OPERDATE), 'dd.mm.yyyy')    "
          + "                AND INER.T_KIND_OPERATION = OPER.T_KIND_OPERATION                          "
          + "                AND INER.T_CLIENT = OPER.T_CLIENT                                          "
          + "                AND INER.T_STATUS = 2)                                                     "
          + "       AND EXISTS(                                                                         "
          + "             SELECT 1                                                                      "
          + "               FROM DNPTXOP_DBT TWTH                                                       "
          + "              WHERE TWTH.T_CLIENT = OPER.T_CLIENT                                          "
          + "                AND TWTH.T_OPERDATE = TO_DATE('31.12.2023', 'dd.mm.yyyy')                  "
          + "                AND TWTH.T_STATUS = 2                                                      "
          + "                AND TWTH.T_CODE LIKE '67082._%' ESCAPE '.' ))                              ";
        
        cmdDelete       = RSDCommand(queryToDelete);
        cmdDelete.Execute();
    end;
    
    Rep.AddPrintCell("Удалено записей: " + CountToDelete, sizeHeader, 0, "1", REP_ELEM_STR);

  else
    Rep.AddPrintCell("Клиентов с изменением НОБ не найдено", sizeHeader, 0, "l", REP_ELEM_STR);
    Rep.AddStr();
  end;

  Rep.PrintWinRep();
  Rep.ShowWinRep();

end;

PrintClientList();

end;

