/*
$Name:        BOSS-2435_createSTB.mac
$Module:      –¥­­ë¥ ¡ã¬ £¨
$Description: ‡ £àã§ª  ¢ •à ­¨«¨é¥ ‘ § ¯¨á¥© ¯® ã¤¥à¦ ­¨ï¬/¢®§¢à â ¬ „”‹ §  ¯à®è«ë¥ ­ «®£®¢ë¥ ¯¥à¨®¤ë
*/

import DealsInter, spserv, sp_class, sp_car, "nptxstbfun.mac";

private class TOpDataLog(_OperDate, _Code, _TaxPeriod, _ClientName, _Tax, _ErrStr)
  var OperDate   = _OperDate;
  var Code       = _Code;
  var TaxPeriod  = _TaxPeriod;
  var ClientName = _ClientName;
  var Tax        = _Tax;
  var ErrStr     = _ErrStr;
end;


PRIVATE MACRO GetPartyName( PartyID:INTEGER ) :STRING
    VAR Party_ForGet = TRecHandler( "party.dbt" );
    if( ®«ãç¨âì‘ã¡ê¥ªâ ( PartyID, Party_ForGet ) == 0 )
       return Party_ForGet.rec.Name;
    end;
    return "";
  end;

private macro GetSystDateTime(SystDate:@date, SystTime:@time)
  var cmd = DL_RSDCommand("select sysdate dt from dual");
  var DataSet = cmd.execute();

  DataSet.moveNext();

  DtTmSplit(DataSet.dt, SystDate, SystTime);
end;

private macro GetNptxopDateTime(nptxop, currIncDate:@date, currIncTime:@time)
  var query, cmd, DataSet;

  currIncDate = nptxop.rec.OperDate;
  currIncTime = nptxop.rec.Time;

  if(currIncTime == time(0))
    query =   " select op.t_Syst_Time "
            + "   from doproper_dbt op "
            + "  where op.t_DocKind = ? "
            + "    and op.t_DocumentID = LPAD(?, 34, '0') ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(nptxop.rec.DocKind);
    cmd.AddParam(nptxop.rec.ID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      currIncTime = time(DataSet.Syst_Time);
    end;
  end;
end;

private macro CreateSTBByOp(nptxop, Taxe, Taxe15, ErrStr:@string)
  var cnt = 0, i = 0;
  var TxArr = TArray();
  var err = 0;
  var AmountSNOB = $0, ValDate, ValTime;
  var FindTaxBaseKind = "";
  var currIncDate = date(0,0,0);
  var currIncTime = time(0);
  var Year = 0;
  var query, cmd, DataSet;

  TxArr.size = 0;

  FindTaxBaseKind = IIF(nptxop.rec.IIS == SET_CHAR, NPTXTOTALBASE_TAXBASEKIND_IIS, NPTXTOTALBASE_TAXBASEKIND_BROK);

  if((nptxop.rec.IIS == UNSET_CHAR) and (€’€_‚_…†ˆŒ…_‘() == true))
    FindTaxBaseKind = string(NPTXTOTALBASE_TAXBASEKIND_BROK) + ", " + string(NPTXTOTALBASE_TAXBASEKIND_ONB);
  end;

  if(nptxop.rec.DocKind == DL_HOLDNDFL)

    GetNptxopDateTime(nptxop, @currIncDate, @currIncTime);

    DateSplit(nptxop.rec.PrevDate, null, null, Year);

    AmountSNOB = STB_GetSumTaxBaseCurrPay(nptxop.rec.Client, FindTaxBaseKind, Year, NULL, NULL, currIncDate, currIncTime);

    if(Taxe != 0)
      TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(nptxop.rec.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                          0, 
                                          Taxe);
    end;

    if(Taxe15 != 0)
      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                          0, 
                                          Taxe15);
    end;

    err = STB_ExecuteCreateSTBOnStep(TxArr,
                                     0, 
                                     nptxop.rec.DocKind,                          
                                     nptxop.rec.ID,                               
                                     nptxop.rec.Client,                           
                                     nptxop.rec.OperDate,                         
                                     IIF(nptxop.rec.IIS == SET_CHAR, true, false), 
                                     Year, 
                                     0, 
                                     0, 
                                     @ErrStr,
                                     currIncDate,
                                     currIncTime,
                                     AmountSNOB,
                                     $0,
                                     date(0,0,0),
                                     time(0));

    if(not err)
      query =   " select t_TBID "
              + "   from dnptxtotalbase_dbt "
              + "  where t_ClientID = ? "
              + "    and t_DocKind = ? "
              + "    and t_DocID = ? "
              + "    and t_ConfirmState = " + NPTXTOTALBASE_CONFIRMSTATE_NOTCONFIRMED
              + "    and (t_StorState <> " + NPTXTOTALBASE_STORSTATE_CANCELED + " or t_StorID <> CHR(1)) "
              + "  order by t_TBID ASC ";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(nptxop.rec.Client);
      cmd.AddParam(nptxop.rec.DocKind);
      cmd.AddParam(nptxop.rec.ID);

      DataSet = cmd.Execute();
      while(DataSet.moveNext())
        var _ErrStr = "";

        DL_ResendSTB(DataSet.TBID, _ErrStr);
        if(_ErrStr != "")
          ErrStr = ErrStr + "\n"+_ErrStr;
        end;

        var q = "select t_Message from dnptxtbmes_dbt where t_TBID = ? and t_Message LIKE 'è¨¡ª %' order by t_ID ASC ";
        var sel = DL_RSDCommand(q);

        sel.AddParam(DataSet.TBID);
        var ds = sel.Execute();
        while(ds.moveNext())
          if(ErrStr != "")
            ErrStr = ErrStr + "\n";
          end;

          ErrStr = ErrStr + ds.Message;
        end;

      end;
    end;

  end;

  return err; 

OnError(er)
  ErrStr = "è¨¡ª : " + er.Message;

  return 1;
end;

private macro ExecCreateSTB()
  var query, cmd, DataSet;
  var StartDate = date(0,0,0), EndDate = date();
  var StartSTBDate = GetStartSTBDate();
  var cnt = 0, i = 0;
  var nptxop = TBFile("nptxop.dbt");
  var OpDataLogArr = TArray();
  var err = 0, ErrStr = "";;

  StartDate = StartSTBDate;

  if(€’€_‘_‚…˜ˆŒ_•€ˆ‹ˆ™…Œ_‘() == false)
    msgbox("¥ ¢ª«îç¥­  à ¡®â  á •à ­¨«¨é¥¬ ‘");
    return;
  end;

  query =   " select nptxop.t_ID, "
          + "        Extract(Year from nptxop.t_PrevDate) as TaxPeriod, "
          + "        pt.t_Name as ClientName, "
          + "        NVL((select SUM(obj.t_Sum0) "
          + "               from dnptxobdc_dbt dc, dnptxobj_dbt obj "
          + "              where dc.t_DocID = nptxop.t_ID "
          + "                and obj.t_ObjID = dc.t_ObjID "
          + "                and obj.t_Kind = " + TXOBJ_PAIDGENERAL
          + "            ), 0) as Taxe, "
          + "        NVL((select SUM(obj.t_Sum0) "
          + "               from dnptxobdc_dbt dc, dnptxobj_dbt obj "
          + "              where dc.t_DocID = nptxop.t_ID "
          + "                and obj.t_ObjID = dc.t_ObjID "
          + "                and obj.t_Kind = " + TXOBJ_PAIDGENERAL_15
          + "            ), 0) as Taxe15 " 
          + "   from dnptxop_dbt nptxop, dparty_dbt pt "
          + "  where nptxop.t_DocKind = " + DL_HOLDNDFL
          + "    and nptxop.t_OperDate >= " + GetSQLDate(date(1,1,2023))
          + "    and nptxop.t_PrevDate < " + GetSQLDate(date(1,1,2023))
          + "    and nptxop.t_Status = 2 /*DL_TXOP_Close*/ "
          + "    and nptxop.t_Tax <> 0 "
          + "    and not Exists(select 1 from dnptxtotalbase_dbt tb where tb.t_ClientID = nptxop.t_Client and tb.t_DocKind = nptxop.t_DocKind and tb.t_DocID = nptxop.t_ID) "
          + "    and not Exists(select 1 from dnptxtotalbasebc_dbt tb where tb.t_ClientID = nptxop.t_Client and tb.t_DocKind = nptxop.t_DocKind and tb.t_DocID = nptxop.t_ID) "
          + "    and pt.t_PartyID = nptxop.t_Client "
          + " order by nptxop.t_PrevDate ASC, nptxop.t_OperDate ASC, nptxop.t_ID ASC ";   

  cmd = DL_RSDCommand(query);

  cnt = cmd.GetCount();

  if(cnt > 0)
    InitProgress(cnt, "¡à ¡®âª  ®¯¥à æ¨© ã¤¥à¦ ­¨ï/¢®§¢à â ", "¡à ¡®âª  ®¯¥à æ¨© ã¤¥à¦ ­¨ï/¢®§¢à â ");
    
    i = 0;
    DataSet = cmd.Execute();
    while(DataSet.moveNext())

      nptxop.Clear();
      nptxop.rec.ID = int(DataSet.ID);
      nptxop.GetEQ();

      ErrStr = "";

      if((DataSet.Taxe != 0) or (DataSet.Taxe15 != 0))
        err = CreateSTBByOp(nptxop, money(DataSet.Taxe), money(DataSet.Taxe15), @ErrStr);

        OpDataLogArr[OpDataLogArr.size] = TOpDataLog(nptxop.rec.OperDate, nptxop.rec.Code, DataSet.TaxPeriod, DataSet.ClientName, money(DataSet.Taxe + DataSet.Taxe15), ErrStr);
      end;

      UseProgress(i = i + 1);
    end;

    RemProgress();

    if(OpDataLogArr.size > 0)
      println();
      println("à®â®ª®« § £àã§ª¨ ¢ •à ­¨«¨é¥ ‘ § ¯¨á¥© ¯® ã¤¥à¦ ­¨ï¬/¢®§¢à â ¬ „”‹ §  ¯à®è«ë¥ ­ «®£®¢ë¥ ¯¥à¨®¤ë");
      println("ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿");
      println("³          „ â         ³          Š®¤         ³        «®£®¢ë©      ³     “¤¥à¦ ­­ë©(+)/   ³                      ”ˆ                       ³                         è¨¡ª¨                             ³");
      println("³        ®¯¥à æ¨¨      ³        ®¯¥à æ¨¨      ³        ¯¥à¨®¤        ³ ¢®§¢à é¥­­ë©(-) ­ «®£³                    ª«¨¥­â                      ³                                                            ³");
      println("ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´");

      i = 0;

      while(i < OpDataLogArr.size)
        
              [³######################³######################³######################³######################³################################################³############################################################³]
              (date(OpDataLogArr[i].OperDate):f:c,
               string(OpDataLogArr[i].Code):c,   
               int(OpDataLogArr[i].TaxPeriod):c,
               money(OpDataLogArr[i].Tax):r,
               string(OpDataLogArr[i].ClientName):c:w,   
               string(OpDataLogArr[i].ErrStr):l:w        
              );

        if(i < OpDataLogArr.size() - 1)
      println("ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´");
        end;
        
        i = i + 1;
      end;

      println("ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ");
    else
      println("¥â ¯®¤å®¤ïé¨å ®¯¥à æ¨© ¢®§¢à â ");
    end;

  else
    println("¥â ¯®¤å®¤ïé¨å ®¯¥à æ¨© ¢®§¢à â ");    
  end; 

OnError(er)

  msgbox("è¨¡ª : " + er.Message);
end;

ExecCreateSTB();
