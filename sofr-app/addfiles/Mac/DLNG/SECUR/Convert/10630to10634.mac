/*
$Name:        10630to10634.mac
$Module:      Ценные бумаги
$Description: процедура переноса остатков с 10630 на 10634 счета 
*/
import DealsInter, spserv, sp_class, sp_car, spreserv;

Private var DateTransf = {curdate};

macro cnv_msgbox(StrErr)
  println(StrErr);
end;

PRIVATE MACRO GetCCY(FIID)
  var cmd = DL_RSDCommand("select t_CCY from dfininstr_dbt where t_FIID = ?");
  var ccy = "";

  cmd.AddParam(FIID);

  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    ccy = DataSet.CCY;
  end;

  return ccy;
END;

PRIVATE MACRO GetNameFI(FIID)
  var cmd = DL_RSDCommand("select t_name from dfininstr_dbt where t_FIID = ?");
  var name = "";

  cmd.AddParam(FIID);

  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    name = DataSet.name;
  end;

  return name;
END;

private macro ПерепривязатьСчет(Acc)
  var err = 0;
  var msg = "";
  var Sql = RSDCommand(" UPDATE dmcaccdoc_dbt doc"
                      +"    SET doc.T_catID = "
                      +"           (SELECT cat.t_ID "
                      +"              FROM dmccateg_dbt cat "
                      +"             WHERE cat.t_code = 'Резерв ц/б'), "
                      +"        doc.T_catNum = "
                      +"           (SELECT cat.t_Number "
                      +"              FROM dmccateg_dbt cat "
                      +"             WHERE cat.t_code = 'Резерв ц/б'), "
                      +"        doc.T_TemplNum =  "
                      +"           (SELECT templ.t_number "
                      +"              FROM dmctempl_dbt templ "
                      +"             WHERE     templ.t_balance = '10630' "
                      +"                   AND TEMPL.T_VALUE1 = 4 "
                      +"                   AND templ.t_catID = "
                      +"                          (SELECT cat.t_ID "
                      +"                             FROM dmccateg_dbt cat "
                      +"                            WHERE cat.t_code = 'Резерв ц/б') "
                      +"                   AND NOT templ.t_isclose = 'X'), "
                      +"        doc.T_FIRole = DECODE(doc.T_DocKind, 0, -1, 81) "
                      +"  WHERE doc.t_account = ? " );
  Sql.addParam("", RSDBP_IN, Acc.Account);
  Sql.execute();
  msg = GetErrMsg();
  if(msg != "")
    msgbox(msg);
  end;

  return err;
end;


Private Macro ПеренестиОстатки(FIID)
    var stat = 0;
    var FD, Sост = $0, FIROle, msg = "";
    record Old10630(account);
    record Acc10634(account);
    var res_prc = double( readNoteForObject( OBJTYPE_AVOIRISS, L_Z( FIID, 10 ), 3  ) );         //3-коэф. резерва
    var est_res_prc = double( readNoteForObject( OBJTYPE_AVOIRISS, L_Z( FIID, 10 ), 24  ) );    //24-коэф. оценочного резерва
    if(res_prc==0)     //если не равен 0, значит ничего не переносим, перенос будет вручную

      FD = SPFirstDocFI(DLDOC_ISSUE, FIID, FIID, NULL, {OurBank}, null, null, null);
      //найдем остаток по счету для КУ "Оценочный резерв, СССД_ЦБ"
      if( FD.IsExistAccount( "Оценочный резерв, СССД_ЦБ", null, true, GetFIRoleByPortfolio(KINDPORT_SALE), Old10630, MC_PAIRACCMODE_MANUAL, DateTransf ))
         Sост = ABS(GetRestAccount(Old10630, DateTransf));
      end;
      if(Sост>0)
        if( not FD.OpenAccount("-Кор_Резерв, ЦБ", null, false, FIROLE_BA_PPR, Acc10634, DateTransf) )
           msg = GetErrMsg();
           if(msg != "")
             msgbox(msg);
           end;
           return 1;
        end;

        // переносим остатки с одного счета на другой
        if(not ПроводкаПоКатегориямУчета( FD, 
               Old10630, Acc10634,          /* КатегДеб , КатегКредит*/
               DateTransf,                  /* Дата */
               1,                           /* Глава */
               NATCUR,                      /* Валюта */
               Sост,                        /* Сумма  */
               NULL,                        /* Документ */
               INPCARRY,                    /* Result_Carry */
               " 1",                        /* Kind_Oper */
               "",                          /* Numb_Document */
               "Перенос резерва"
              ) 
          )
/*            msg = GetErrMsg();
            if(msg != "")
              msgbox(msg);
            end;
*/
            msgbox("Ошибка при выполнении проводки \"" + "Перенос резерва" + "\""+  " по Ц/б "+GetNameFI(FIID));
            return 1;
        else
            msgbox("   Выполнена проводка "+Old10630.Account+"<->"+Acc10634.Account+" \"" + "Перенос резерва" + "\" на сумму " + Sост + " " + GetCCY(Old10630.Code_Currency) +  " по Ц/б "+GetNameFI(FIID));

        end;

        ПерепривязатьСчет(Old10630);


      end;

    end;
    return stat;
end;

macro StartExec()

   Var  query, cmd, DataSet, query1, cmd1, query2, cmd2, KindPort, FIID, SumOver, SumOnOvervlNeg, SumOnOvervlPos, FD, err = 0;
   // бумаги, по которым была переоценка   // можно для конкретных
   ReplaceMacro( "msgbox", "cnv_msgbox" );
   query = "  SELECT DISTINCT lot.t_FIID as FIID "
          +"    FROM dpmwrtsum_dbt lot"  
          +"   WHERE lot.T_Amount > 0 "
          +"     AND lot.t_Portfolio = 2 "
          +"     AND lot.t_Estreserve <> 0 "
          +"     AND RSI_RSB_FIInstr.FI_AvrKindsGetRoot( 2, RSI_RSB_FIInstr.FI_AvrKindsGetRootByFIID(Lot.t_Fiid) ) = 17 "
          ;
   cmd = DL_RSDCommand(query);

   DataSet = cmd.Execute();
   while( (DataSet.moveNext())/* and (not err)*/)      // до первой ошибки
     err = ПеренестиОстатки(DataSet.FIID);
   end;
end;
ReplaceMacro("msgbox", "cnv_msgbox");

StartExec() ;

ReplaceMacro("msgbox", NULL );
