import rsd, BankInter, RsbDataSet, FIInter, CTInter, Календарь, globals, OprInter;

private macro SetError( type, fun, mes )
  var cmd = RSDCommand("BEGIN " +
                       "  IvanovConvert.SCIDMAP.GlobalFun := 'stepacc3.mac'; " +
                       "  IvanovConvert.SCIDMAP.SetError(?,?,?); " +
                       "END;");
   cmd.addParam("", RSDBP_IN, type);
   cmd.addParam("", RSDBP_IN, fun);
   cmd.addParam("", RSDBP_IN, mes);
   cmd.execute();
end;

private macro GetAccount( Chapter, Currency, Account, AccBuf )
  var cmd, rsd;

   if( Currency == NATCUR )
      cmd = RSDCommand("SELECT * FROM DACCOUNT_DBT WHERE T_CHAPTER = ? AND T_CODE_CURRENCY = ? AND T_ACCOUNT = ?");
   else
      cmd = RSDCommand("SELECT * FROM DACCOUNT$_DBT WHERE T_CHAPTER = ? AND T_CODE_CURRENCY = ? AND T_ACCOUNT = ?");
   end;
   cmd.addParam("", RSDBP_IN, Chapter);
   cmd.addParam("", RSDBP_IN, Currency);
   cmd.addParam("", RSDBP_IN, Account);
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   if(rsd.MoveNext())

      rsd.GetRecord().CopyTo( AccBuf.rec );

      return true;
   end;

   return false;
end;

private macro GetAccount2( Chapter, Currency, Account, AccBuf )
  var cmd, rsd;

   if( Currency == NATCUR )
      cmd = RSDCommand("SELECT * FROM Ivanov2028_86.DACCOUNT_DBT WHERE T_CHAPTER = ? AND T_CODE_CURRENCY = ? AND T_ACCOUNT = ?");
   else
      cmd = RSDCommand("SELECT * FROM Ivanov2028_86.DACCOUNT$_DBT WHERE T_CHAPTER = ? AND T_CODE_CURRENCY = ? AND T_ACCOUNT = ?");
   end;
   cmd.addParam("", RSDBP_IN, Chapter);
   cmd.addParam("", RSDBP_IN, Currency);
   cmd.addParam("", RSDBP_IN, Account);
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   if(rsd.MoveNext())

      rsd.GetRecord().CopyTo( AccBuf.rec );

      return true;
   end;            

   return false;
end;


private macro GetRestAccount( accbuf, Dat )
   var Rest = $0;

   OprGetAccountRest( accbuf.Chapter, accbuf.Code_Currency, accbuf.Account, Dat, Rest );

   return Rest;
end;

private macro RunCarry( Department:INTEGER, Chapter:INTEGER, SumPayer:MONEY, SumReceiver:MONEY, 
                        AccountPayer:STRING, AccountReceiver:STRING, FIIDPayer:INTEGER, FIIDReceiver:INTEGER, 
                        Ground:STRING, ObjectCode:STRING, Execute:BOOL, SPOD:BOOL )
  VAR tr, OldDialogFlag, SumTmp, SumFiCode;
  if( ( (AccountPayer == NULL) OR 
        (AccountPayer == "")
      ) OR 
      ( (AccountReceiver == NULL) OR 
        (AccountReceiver == "") 
      )
    )
     return true;
  end;

  if( SumReceiver != NULL ) 
     SumReceiver = Round( ABS(SumReceiver), 2 );
  end; 

  if( SumPayer != NULL ) 
     SumPayer = Round( ABS(SumPayer), 2 );
  end; 

  if( ( (SumReceiver == NULL) OR 
        (SumReceiver == 0)
      ) AND 
      ( (SumPayer == NULL) OR 
        (SumPayer == 0) 
      )
    )
     return true;
  end;

  tr = RsbAccTransaction();

  tr.Chapter         = Chapter;
  tr.Date_Carry      = tr.Date_Document = {CurDate};
  tr.Numb_Document   = ObjectCode;
  tr.ResultCarry     = INPCARRY;
  tr.Department      = Department;
  tr.Ground          = Ground;

  tr.Number_Pack     = 128;

  tr.FIIDPayer       = FIIDPayer;
  tr.FIIDReceiver    = FIIDReceiver;
  tr.SumPayer        = SumPayer;
  tr.SumReceiver     = SumReceiver;
  tr.AccountPayer    = AccountPayer;
  tr.AccountReceiver = AccountReceiver;

  if( SPOD == true )
    tr.TypeDocument  = "З"; /*СПОД*/
  end;

  if( Execute != true )
     tr.Status_After    = ACCTRN_STATUS_POST;     
  end;

  if( (SumPayer == 0) OR (SumPayer == NULL) )
     SumTmp = SumReceiver;
     SumFiCode = ПолучитьКодФинИн(FiidReceiver);
  else
     SumTmp = SumPayer;
     SumFiCode = ПолучитьКодФинИн(FiidPayer);
  end;

  if( not tr.Carry() )
     SetError("ERROR","RunCarry","!!! Ошибка при выполнении проводки \"" + Ground + "\"  "+ AccountPayer + "  " + AccountReceiver + "  " + SumTmp + " (" + SumFiCode + ")\n"+ GetErrMsg() );
     InitError();
     return false;
  end;

  SetError("INFO","RunCarry","Проводка \"" +Ground + "\" "+ AccountPayer + "  " + AccountReceiver + "  " + SumTmp + " (" + SumFiCode + ")" );
  return true;
END;


private macro IsExec( OldAcc )
  var cmd = RSDCommand(" UPDATE DSCACCMAP1_TMP " +
                       "    SET T_ISEXEC = CHR(88) "
                       "  WHERE T_OLDACC = ? " );
   cmd.addParam("", RSDBP_IN, OldAcc);
   cmd.execute();
end;

private macro FindScAccMap( OldAcc, IsExec )
  var cmd, rsd;

   if( IsExec )
      cmd = RSDCommand(" SELECT * " +
                       "   FROM DSCACCMAP1_TMP " +
                       "  WHERE T_OLDACC = ? AND" +
                       "        T_ISEXEC = CHR(88)");
   else
      cmd = RSDCommand(" SELECT * " +
                       "   FROM DSCACCMAP1_TMP " +
                       "  WHERE T_OLDACC = ?");
   end;
   cmd.addParam("", RSDBP_IN, OldAcc);
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   if( rsd.MoveNext() )
      return rsd.rec.NewAcc;
   else
      return "";
   end;

   return "";
end;

private macro FindScAccMap2( OldAcc )
  var cmd, rsd;

   cmd = RSDCommand(" SELECT * " +
                    "   FROM DSCACCMAP2_TMP " +
                    "  WHERE T_OLDACC = ?");
   cmd.addParam("", RSDBP_IN, OldAcc);
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   if( rsd.MoveNext() )
      return rsd.rec.NewAcc;
   else
      return "";
   end;

   return "";
end;

private macro GetCatID( CatNum )
  var cmd, rsd;

   cmd = RSDCommand(" SELECT t_ID " +
                    "   FROM DMCCATEG_DBT " +
                    "  WHERE T_NUMBER = ?");
   cmd.addParam("", RSDBP_IN, CatNum);
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   if( rsd.MoveNext() )
      return rsd.rec.ID;
   else
      return 0;
   end;

   return 0;
end;

private macro GetObjMappedID( Table, OldID, IsMandatory )
  var cmd, rsd;

   cmd = RSDCommand(" SELECT SCIDMAP.GetObjMappedID( ?, ?, ? ) NewID" +
                    "   FROM DUAL ");
   cmd.addParam("", RSDBP_IN, Table);
   cmd.addParam("", RSDBP_IN, OldID);
   cmd.addParam("", RSDBP_IN, IsMandatory);
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   if( rsd.MoveNext() )
      return rsd.rec.NewID;
   else
      return 0;
   end;

   return 0;

OnError
   return 0;
end;

macro FindAndOpenMappedAcc( OldAcc, Chapter, FIID, OpenDate, IsPair )
  var cmd, rsd;
  var NewAcc = "", PairAccount = "";
  var Acc = TRecHandler("account");
  var Acc2 = TRecHandler("account");

  if( NewAcc = FindScAccMap( OldAcc, false ) )
     IsExec( OldAcc );
     return NewAcc;
  else
     if( not FindScAccMap2( OldAcc ) )
        SetError( "ERROR", "FindAndOpenMappedAcc", "Не найден счет НБТ, соответствующий " + OldAcc );
        return "";
     end;

     NewAcc = FindScAccMap2( OldAcc, true );

     if( GetAccount( Chapter, GetObjMappedID( 2, FIID, 0 ), NewAcc, Acc ) )
        return NewAcc;
     else
     
        if( not GetAccount2( Chapter, FIID, OldAcc, Acc2 ) )
           SetError( "ERROR", "FindAndOpenMappedAcc", "Не найден счет ИБТ " + OldAcc );
           return "";
        end;

        Copy( Acc, Acc2 );

        if( Acc2.rec.PairAccount )
           PairAccount = FindScAccMap2( Acc2.rec.PairAccount );
        end;

        Acc.rec.Account = NewAcc;
        Acc.rec.PairAccount = PairAccount;
        Acc.rec.Open_Date = OpenDate;
        Acc.rec.Client = GetObjMappedID( 1, Acc2.rec.Client, 1 );
        Acc.rec.Oper = {Oper};
        Acc.rec.Code_Currency = GetObjMappedID( 2, FIID, 0 );
        Acc.rec.D0 = Acc.rec.K0 = Acc.rec.R0 = Acc.rec.PLANREST = $0;

        if( Create_Account( Acc ) )
           SetError( "ERROR", "FindAndOpenMappedAcc", "Невозможно отктрыть счет  " + NewAcc );         
           return "";
        end;

        if( (not IsPair) and (Acc2.rec.PairAccount != "") )
           PairAccount = FindAndOpenMappedAcc( Acc2.rec.PairAccount, Chapter, FIID, OpenDate, true );
        end;
     end;
  end;

  return NewAcc;

end;

macro ExecuteCarry()
  var cmd, rsd;
  var count = 0;
  var mcacc = TBFile("mcaccdoc", "W");
  var paym = TBFile("pmpaym", "W");

   cmd = RSDCommand(" SELECT * " +
                    "   FROM Ivanov2028_86.darhdoc_dbt " +
                    "  WHERE t_Number_Pack = 128 and " +
                    "        t_Result_Carry = " + INPCARRY + 
                    " ORDER BY t_AutoKey");
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   InitProgress( -1, "Обработка рублевух проводок", "Обработка рублевых проводок" );
   while( rsd.MoveNext() )

     RunCarry( {OperDprt}, rsd.rec.Chapter, rsd.rec.Sum, rsd.rec.Sum,
               FindAndOpenMappedAcc( rsd.rec.Account_Receiver, rsd.rec.Chapter, rsd.rec.Code_Currency, rsd.rec.Date_Carry, false ),
               FindAndOpenMappedAcc( rsd.rec.Account_Payer, rsd.rec.Chapter, rsd.rec.Code_Currency, rsd.rec.Date_Carry, false ),
               GetObjMappedID( 2, rsd.rec.Code_Currency, 0 ), GetObjMappedID( 2, rsd.rec.Code_Currency, 0 ), "Перевод средств c транзитных счетов", "", true );
  
     UseProgress(count=count+1);
   end;
   RemProgress();


   cmd = RSDCommand(" SELECT * " +
                    "   FROM Ivanov2028_86.darhdoc$_dbt " +
                    "  WHERE t_Number_Pack = 128 and" +
                    "        t_Result_Carry = " + INPCARRY + 
                    " ORDER BY t_AutoKey");
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   InitProgress( -1, "Обработка валютных проводок", "Обработка валютных проводок" );
   while( rsd.MoveNext() )

     RunCarry( {OperDprt}, rsd.rec.Chapter, rsd.rec.Sum, rsd.rec.Sum,
               FindAndOpenMappedAcc( rsd.rec.Account_Receiver, rsd.rec.Chapter, rsd.rec.Code_Currency, rsd.rec.Date_Carry, false ),
               FindAndOpenMappedAcc( rsd.rec.Account_Payer, rsd.rec.Chapter, rsd.rec.Code_Currency, rsd.rec.Date_Carry, false ),
               GetObjMappedID( 2, rsd.rec.Code_Currency, 0 ), GetObjMappedID( 2, rsd.rec.Code_Currency, 0 ), "Перевод средств c транзитных счетов", "", true );
  
     UseProgress(count=count+1);
   end;
   RemProgress();
/*
   cmd = RSDCommand(" SELECT * " +
                    "   FROM Ivanov2028_86.dmcaccdoc_dbt " +
                    "  WHERE t_DocKind in ( 0, 101, 117, 5, 176 ) AND ( ( t_DisablingDate > ? ) OR ( t_DisablingDate = TO_DATE('01.01.0001','DD.MM.YYYY') ) )");

   cmd.addParam("", RSDBP_IN, {CurDate});
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   count = 0;

   InitProgress( -1, "Обработка категорий учета", "Обработка категорий учета" );
   while( rsd.MoveNext() )

     mcacc.Clear();

     rsd.GetRecord().CopyTo( mcacc.rec );

     mcacc.rec.ID = 0;
     mcacc.rec.Owner = GetObjMappedID( 1, mcacc.rec.Owner, 1 );
     mcacc.rec.Place = GetObjMappedID( 1, mcacc.rec.Place, 1 );
     mcacc.rec.Issuer = GetObjMappedID( 1, mcacc.rec.Issuer, 1 );
     mcacc.rec.Centr = GetObjMappedID( 1, mcacc.rec.Centr, 1 );
     mcacc.rec.MarketPlaceID = GetObjMappedID( 1, mcacc.rec.MarketPlaceID, 1 );
     mcacc.rec.Contractor = GetObjMappedID( 1, mcacc.rec.Contractor, 1 );
     mcacc.rec.CatID = GetCatID( mcacc.rec.CatNum );

     mcacc.rec.FIID = GetObjMappedID( 2, mcacc.rec.FIID, 0 );
     mcacc.rec.FIID2 = GetObjMappedID( 2, mcacc.rec.FIID2, 0 );
     mcacc.rec.Currency = GetObjMappedID( 2, mcacc.rec.Currency, 0 );

     if( (mcacc.rec.DocKind == 101) OR
         (mcacc.rec.DocKind == 117) )
        mcacc.rec.DocID = GetObjMappedID( 5, mcacc.rec.DocID, 0 );
     elif(mcacc.rec.DocKind == 176)
        mcacc.rec.DocID = GetObjMappedID( 6, mcacc.rec.DocID, 0 );
     elif(mcacc.rec.DocKind == 5)
        mcacc.rec.DocID = GetObjMappedID( 2, mcacc.rec.DocID, 0 );
     end;

     mcacc.rec.Account = FindAndOpenMappedAcc( mcacc.rec.Account, rsd.rec.Chapter, rsd.rec.Currency, {CurDate}, false );
     if( mcacc.rec.Account )
        if( not mcacc.Insert() )
           SetError( "ERROR", "ExecuteCarry", "Не могу вставить документ формирования счета по КУ для " + mcacc.rec.Account );
        end;
     end;
   
     UseProgress(count=count+1);
   end;
   RemProgress();


   cmd = RSDCommand(" SELECT t_NewID " +
                    "   FROM DSCIDMAP_TMP " +
                    "  WHERE t_Table = 7");

   cmd.addParam("", RSDBP_IN, {CurDate});
   cmd.execute();

   rsd = TRsbDataSet( cmd ); 

   count = 0;

   InitProgress( -1, "Обработка платежей", "Обработка платежей" );
   while( rsd.MoveNext() )

     paym.Clear();
     paym.rec.PaymentID = rsd.rec.NewID;

     if( paym.GetEQ )
        if( paym.rec.PayerBankID == {OurBank} )
           paym.rec.PayerAccount = FindAndOpenMappedAcc( paym.rec.PayerAccount, paym.rec.Chapter, paym.rec.PayFIID, {CurDate}, false );
        end;

        if( paym.rec.ReceiverBankID == {OurBank} )
           paym.rec.ReceiverAccount = FindAndOpenMappedAcc( paym.rec.ReceiverAccount, paym.rec.Chapter, paym.rec.FIID, {CurDate}, false );
           paym.rec.AccountNDS = FindAndOpenMappedAcc( paym.rec.AccountNDS, paym.rec.Chapter, paym.rec.FIID, {CurDate}, false );
        end;

        paym.rec.FuturePayerAccount = FindAndOpenMappedAcc(paym.rec.FuturePayerAccount, paym.rec.Chapter, paym.rec.PayFIID, {CurDate}, false ); 
        paym.rec.FutureReceiverAccount = FindAndOpenMappedAcc(paym.rec.FutureReceiverAccount, paym.rec.Chapter, paym.rec.FIID, {CurDate}, false );
     
     else
        SetError( "ERROR", "ExecuteCarry", "Не могу найти платеж с ID =  " + paym.rec.PaymentID );
     end;

     UseProgress(count=count+1);
   end;
   RemProgress();
*/
end;

ExecuteCarry();
