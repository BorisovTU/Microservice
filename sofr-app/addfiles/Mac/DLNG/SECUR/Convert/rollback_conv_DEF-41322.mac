/*
$Name:        rollback_conv_DEF-41322.mac
$Module:      Ценные бумаги
$Description: Откат конвертаций НДФЛ
*/

import DealsInter, spserv, sp_class, sp_car;

private var TestMode = false;

PRIVATE CLASS TProtocolData(_DealCode:string, _Msg:string)
  var DealCode = _DealCode;
  var Msg      = _Msg; 
END;

PRIVATE MACRO UpdateTick(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddl_tick_dbt "
                      + "   SET t_PFI = ?, "
                      + "       t_TaxOwnBegDate = ? "
                      + " WHERE t_DealID = ? "
                     );

  upd.AddParam(DataSet.FIID);
  upd.AddParam(DataSet.TaxOwnBegDate);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateLeg(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddl_leg_dbt "
                      + "   SET t_PFI = ?, "
                      + "       t_DeliveringFIID = ?, "
                      + "       t_Principal = ?, "
                      + "       t_Start = ?, "
                      + "       t_Price = ?, "
                      + "       t_Cost = ?, "
                      + "       t_TotalCost = ?, "
                      + "       t_CFI = ? "
                      + " WHERE t_DealID = ? AND t_LegID = 0 AND t_LegKind = 0 "
                     );

  upd.AddParam(DataSet.FIID);
  upd.AddParam(DataSet.FIID);
  upd.AddParam(DataSet.Amount);
  upd.AddParam(DataSet.TaxOwnBegDate);
  upd.AddParam(DataSet.Price);
  upd.AddParam(DataSet.Cost);
  upd.AddParam(DataSet.Cost);
  upd.AddParam(DataSet.CurPrice);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateRQ(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddlrq_dbt "
                      + "   SET t_FIID = ?, "
                      + "       t_Amount = ? "
                      + " WHERE (t_DocKind, t_DocID) IN (SELECT tk.t_BOfficeKind, tk.t_DealID "
                      + "                                  FROM ddl_tick_dbt tk "
                      + "                                 WHERE tk.t_DealID = ?"
                      + "                               ) "
                     );

  upd.AddParam(DataSet.FIID);
  upd.AddParam(DataSet.Amount);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateDLSUM_Outlay(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddlsum_dbt "
                      + "   SET t_Sum = ?, "
                      + "       t_Currency = ? "
                      + " WHERE (t_DocKind, t_DocID, t_Kind) IN (SELECT tk.t_BOfficeKind, tk.t_DealID, 1100 "
                      + "                                          FROM ddl_tick_dbt tk "
                      + "                                         WHERE tk.t_DealID = ?"
                      + "                                       ) "
                     );

  upd.AddParam(IIF(ValType(DataSet.Outlay) == V_UNDEF, 0, DataSet.Outlay));
  upd.AddParam(0);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateDLSUM_Price(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddlsum_dbt "
                      + "   SET t_Sum = ?, "
                      + "       t_Currency = ?, "
                      + "       t_Date = ? "
                      + " WHERE (t_DocKind, t_DocID, t_Kind) IN (SELECT tk.t_BOfficeKind, tk.t_DealID, 1220 "
                      + "                                          FROM ddl_tick_dbt tk "
                      + "                                         WHERE tk.t_DealID = ?"
                      + "                                       ) "
                     );

  upd.AddParam(DataSet.Price);
  upd.AddParam(DataSet.CurPrice);
  upd.AddParam(DataSet.TaxOwnBegDate);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateDLSUM_Cost(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddlsum_dbt "
                      + "   SET t_Sum = ?, "
                      + "       t_Currency = ?, "
                      + "       t_Date = ? "
                      + " WHERE (t_DocKind, t_DocID, t_Kind) IN (SELECT tk.t_BOfficeKind, tk.t_DealID, 1230 "
                      + "                                          FROM ddl_tick_dbt tk "
                      + "                                         WHERE tk.t_DealID = ?"
                      + "                                       ) "
                     );

  upd.AddParam(DataSet.Cost);
  upd.AddParam(DataSet.CurPrice);
  upd.AddParam(DataSet.TaxOwnBegDate);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateDLSUM_NKD(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddlsum_dbt "
                      + "   SET t_Date = ? "
                      + " WHERE (t_DocKind, t_DocID, t_Kind) IN (SELECT tk.t_BOfficeKind, tk.t_DealID, 1240 "
                      + "                                          FROM ddl_tick_dbt tk "
                      + "                                         WHERE tk.t_DealID = ?"
                      + "                                       ) "
                     );

  upd.AddParam(DataSet.TaxOwnBegDate);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateDLSUM_OutlayTX(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddlsum_dbt "
                      + "   SET t_Sum = ?, "
                      + "       t_Currency = ?, "
                      + "       t_Date = ? "
                      + " WHERE (t_DocKind, t_DocID, t_Kind) IN (SELECT tk.t_BOfficeKind, tk.t_DealID, 1250 "
                      + "                                          FROM ddl_tick_dbt tk "
                      + "                                         WHERE tk.t_DealID = ?"
                      + "                                       ) "
                     );

  upd.AddParam(IIF(ValType(DataSet.Outlay) == V_UNDEF, 0, DataSet.Outlay));
  upd.AddParam(0);
  upd.AddParam(DataSet.TaxOwnBegDate);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateGrdeal(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddlgrdeal_dbt "
                      + "   SET t_FIID = ? "
                      + " WHERE (t_DocKind, t_DocID) IN (SELECT tk.t_BOfficeKind, tk.t_DealID "
                      + "                                  FROM ddl_tick_dbt tk "
                      + "                                 WHERE tk.t_DealID = ?"
                      + "                               ) "
                     );

  upd.AddParam(DataSet.FIID);
  upd.AddParam(DataSet.DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateTickDEL(DealID, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE ddl_tick_dbt "
                      + "   SET t_DealCode = t_DealCode||'_DEL' "
                      + " WHERE t_DealID = ? "
                      + "   AND instr(t_DealCode, '_DEL') = 0"
                     );

  upd.AddParam(DealID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

PRIVATE MACRO UpdateConv(DataSet, ErrStr:@string)
  var q, upd;

  ErrStr = "";

  upd = DL_RSDCommand(  "UPDATE u_conv_adr_data_dbt "
                      + "   SET t_Flag1 = 'D' "
                      + " WHERE t_DealID = ? "
                      + "   AND t_ConvID = ? "
                      + "   AND t_Flag1 = CHR(88) "
                     );

  upd.AddParam(DataSet.DealID);
  upd.AddParam(DataSet.ConvID);

  upd.ExecuteCMD();

  return 0;

OnError(er)
  ErrStr = er.Message;
  return 1;
END;

private macro GetSystDateTime(SystDate:@date, SystTime:@time)
  var cmd = DL_RSDCommand("select sysdate dt from dual");
  var DataSet = cmd.execute();

  DataSet.moveNext();

  DtTmSplit(DataSet.dt, SystDate, SystTime);
end;

PRIVATE MACRO ExecuteRollBack()
  var query, cmd, DataSet;
  var LogArr = TArray(150000); 
  var err = 0, ErrStr = "", Msg = "";
  var i = 0;
  var SystDate, SystTime;
  var cnt = 0, err_cnt = 0, full_cnt = 0, part_cnt = 0;

  GetSystDateTime(@SystDate, @SystTime);

  query =   " select d.*, "
          + "        NVL((SELECT d1.t_DealID_New "
          + "               FROM u_conv_adr_data_dbt d1 "
          + "              WHERE d1.t_DealID = d.t_DealID "
          + "                AND d1.t_Flag1 = CHR(88) "
          + "                AND d1.t_DealID_New IS NOT NULL "
          + "            ), 0) as FindNewDealID "
          + "   from u_conv_adr_data_dbt d "
          + "  where d.t_Flag1 = CHR(88) "
          + "    and d.t_DealID_New IS NULL "
          + "  order by d.t_ConvID desc ";

  cmd = DL_RSDCommand(query);

  cnt = cmd.GetCount();
  if(cnt > 0)
    InitProgress(cnt, "Откат конвертаций НДФЛ", "Откат конвертаций НДФЛ");
    
    DataSet = cmd.Execute(query);

    while(DataSet.moveNext())

      err = 0;
      ErrStr = "";
      Msg = "";

      RslDefCon.BeginTrans();

      if(not err)
        err = UpdateTick(DataSet, @ErrStr);
      end;

      if(not err)
        err = UpdateLeg(DataSet, @ErrStr);
      end;

      if(not err)
        err = UpdateRQ(DataSet, @ErrStr);
      end;

      if(not err)
        err = UpdateDLSUM_Outlay(DataSet, @ErrStr);
      end;

      if(not err)
        err = UpdateDLSUM_Price(DataSet, @ErrStr);
      end;
      
      if(not err)
        err = UpdateDLSUM_Cost(DataSet, @ErrStr);
      end;
      
      if(not err)
        err = UpdateDLSUM_NKD(DataSet, @ErrStr);
      end;

      if(not err)
        err = UpdateDLSUM_OutlayTX(DataSet, @ErrStr);
      end;

      if(not err)
        err = UpdateGrdeal(DataSet, @ErrStr);
      end;

      if(not err)
        Msg = "Выполнено обновление связанных данных.\n";
        
        if(DataSet.FindNewDealID > 0)
          err = SP_DelDealWithLinks(int(DataSet.FindNewDealID), false, true);
          if(not err)
            Msg = Msg + "Выполнен откат и удаление операции зачисления c ID = "+int(DataSet.FindNewDealID)+".\n";
          else
            Msg = Msg + "Не удалось откатить и удалить операцию зачисления c ID = "+int(DataSet.FindNewDealID)+". "+GetErrMsg()+"\n";

            err = UpdateTickDEL(int(DataSet.FindNewDealID), @ErrStr);
            if(err)
              Msg = Msg + ErrStr + "\n";
            else
              part_cnt = part_cnt + 1;
              Msg = Msg + "В код операции зачисления с ID = "+int(DataSet.FindNewDealID)+" добавлен постфикс _DEL для ручного отката и удаления.\n";
            end;
          end;
        else
          full_cnt = full_cnt + 1;
        end;
      end;

      if(not err)
        err = UpdateConv(DataSet, @ErrStr);
      end;
      
      if((TestMode == true) or (err))
        if(err)
          err_cnt = err_cnt + 1;
          Msg = Msg + "Ошибка: " + ErrStr;
        end;
        
        RslDefCon.RollbackTrans();
        Msg = Msg + "Фиксация изменений НЕ выполнена."
      else
        RslDefCon.CommitTrans();
        Msg = Msg + "Выполнена фиксация всех изменений."
      end;

      LogArr[LogArr.size] = TProtocolData(DataSet.DealCode, Msg);

      UseProgress(i = i + 1);
    end;

    RemProgress();


    InitProgress(LogArr.size(), "Печать протокола", "Печать протокола");

             [                            Протокол отката операций конвертации НДФЛ
             Дата выполнения:  #############
             Время выполнения: #############
             Обработано:   #############  Из них: полностью #########  частично #########  с ошибкой #########
             ]
             (SystDate:f, SystTime, string(cnt):l, string(full_cnt):l, string(part_cnt):l, string(err_cnt):l);

    println("");
    println("┌──────────────────────┬────────────────────────────────────────────────────────────────────────────────┐");
    println("│     Код сделки       │                                  Сообщения                                     │");
    println("│                      │                                                                                │");
    println("├──────────────────────┼────────────────────────────────────────────────────────────────────────────────┤");

    i = 0;
    while(i < LogArr.size())

            [│######################│################################################################################│]
            (string(LogArr[i].DealCode):c,     
             string(LogArr[i].Msg):l:w
            );

      if(i < LogArr.size() - 1)
    println("├──────────────────────┼────────────────────────────────────────────────────────────────────────────────┤");
      end;

      UseProgress(i = i + 1);
    end;

    RemProgress();

    println("└──────────────────────┴────────────────────────────────────────────────────────────────────────────────┘");

  else
    msgbox("Нет подходящих записей");
  end;


OnError(er)
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  msgbox("Ошибка: " + er.Message);

END;



ExecuteRollBack();
