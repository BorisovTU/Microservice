/*
$Name:        sp_car.mac
$Module:      Ценные бумаги
$Description: Процедуры для проводок в операциях с ценными бумагами
*/
IMPORT "secinter.mac", "spserv.mac", "mc_lib.mac", "dlcarry.inc", "sp_catfn.mac", "sp_catac.mac", "sp_carsf.mac", "sp_voop.mac", "spserv.mac", "dltransf.mac", "sp_carin.mac",
       "spRepFn2.mac", "dl_car.mac", "sp_grfun.mac";
IMPORT "role_model.mac";//ролевая модель


private record СчетУчетаТреб(account);
private record СчетУчетаОбяз(account);
private record СчетУчетаТребНов(account);
private record СчетУчетаОбязНов(account);

CONST MGRDate = date("01.01.2019");


Macro UserGetDealCode(FD)
  If(IsEXCHANGE(FD.Group))
     return FD.tick.rec.dealcodets;
  else
     return FD.tick.rec.dealcode;
  end;
End;
Macro User_GetLsin(fiid)
record avoir("avoiriss");

ПолучитьФинИн(fiid, null, avoir); 
   If(avoir.Lsin != "")
      return avoir.Lsin;
   else
      return avoir.Isin;
   end;
End;


Macro GetFinName(Fin)
       If(fin.definition =="")
          return Fin.Name;
       else
          return fin.definition;
       end;
end;


Macro UserGetKol(Sum, Kind)
  var str1 = string(sum);
  If(kind == 16)
     return sum;
  else
     return Substr(str1, 1, index(str1, ".")-1); 
  end;
End;


  MACRO UserGetPartyShortName( PartyID:INTEGER ) :STRING
    VAR Party_ForGet = TRecHandler( "party.dbt" );
    if( ПолучитьСубъекта( PartyID, Party_ForGet ) == 0 )
       return Party_ForGet.rec.ShortName;
    end;
    return "";
  end;


macro РАБОТА_С_РЕПОЗИТАРИЕМ()
    const RegPath = "COMMON\\WORK_MODE\\IR_WORK_WITH_SECURITIES";
    var workWithRepository = "", err;
    GetRegistryValue( RegPath, V_BOOL, workWithRepository, err );
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    else
        if ( workWithRepository == "X" )
            return true;
        else
            return false;
        end;
    end;
end;

 macro GetDlContrCode(ID, Code, DlDate)
    var  Change = 0;
    var Select, DataSet, Query;
    Query = "select sf.* from dsfcontr_dbt sf, ddlcontrmp_dbt mp, ddlcontr_dbt dl  where "
          + " mp.t_sfcontrid = ? and dl.t_dlcontrid = mp.t_dlcontrid and sf.t_id = dl.t_sfcontrid";
    Select = DL_RSDCommand(Query);
    Select.AddParam(ID);
    DataSet = Select.Execute(Query);
    if(DataSet.MoveNext())
       setparm(1,DataSet.number);
       setparm(2,SQL_ConvTypeDate(DataSet.datebegin));
       return true;
    else   //BIQ-5485 проверим ДО на принадлежность к андеррайтингу
        Query = "select sf.* from dsfcontr_dbt sf where sf.t_id = ? and sf.T_SERVKINDSUB = 10 ";     //рабочий вариант
        Select = DL_RSDCommand(Query);
        Select.AddParam(ID);
        DataSet = Select.Execute(Query);
       if(DataSet.MoveNext())
          setparm(1,DataSet.number);
          setparm(2,SQL_ConvTypeDate(DataSet.datebegin));
          return true;
       end;
    end;  
    return false;
end;

macro  Использовать_Сч60301() : bool
   const path = "SECUR\\ИСПОЛЬЗОВАТЬ СЧ.60301";
   var res = "", err;

   GetRegistryValue( path, V_BOOL, res, err );
   if ( err != 0 )
      MsgBox( "Ошибка при получении значения настройки \"" + path + "\"" );
   else
      if ( res == SET_CHAR ) 
         return true;
      else
         return false;
      end;  
   end;
end;

macro РАБОТА_С_РЕПОЗИТАРИЕМ_ФИССиКО()
    const RegPath = "COMMON\\WORK_MODE\\IR_WORK_WITH_DERIVATIVES";
    var workWithRepository = "", err;
    GetRegistryValue( RegPath, V_BOOL, workWithRepository, err );
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    else
        if ( workWithRepository == "X" )
            return true;
        else
            return false;
        end;
    end;
end;

macro IsCloseContr(DocKind, DealID)
    var SelectClose, QueryClose;
    var cnt = 0;
    var MaxGrDate:date = date(31,12,9999);
    QueryClose = "select * from ddlgrdeal_dbt where t_DocKind = ? and t_DocID = ? and t_TemplNum in(51,52) " ;
    SelectClose = DL_RSDCommand(QueryClose);
    SelectClose.AddParam(DocKind);
    SelectClose.AddParam(DealID);
    cnt = SelectClose.GetCount(QueryClose);     // если не запланировано закрытие договора, то ничего не вставляем
    if( cnt == 0 )
      return 0;
    end;
    return 1;
end;

macro getCloseDate(DocKind, DealID)
    var closeDate = date(31,12,9999);
    var query = " SELECT t_planDate " +
                "   FROM ddlgrdeal_dbt " +
                "  WHERE     t_DocKind = ? " +
                "        AND t_DocID = ? " +
                "        AND t_TemplNum IN (51, 52) ";
    var cmd = DL_RSDCommand(query);
    cmd.AddParam(DocKind);
    cmd.AddParam(DealID);
    var DataSet = cmd.Execute();
    if( DataSet.MoveNext() )
      closeDate = DataSet.planDate;
    end;
    return closeDate;
end;

macro WeheChangeRQ(ID)
    var  Change = 0;
    var Select, DataSet, Query;
    Query = "SELECT * FROM ddlrqbc_dbt"
          + " WHERE  t_RQID = ?"
          + " AND rownum = 1 " ;

    Select = DL_RSDCommand(Query);
    Select.AddParam(ID);
    DataSet = Select.Execute(Query);
    if(DataSet.MoveNext())
      Change = 1; //если есть изменения
    end;
    return Change;
end;

macro GetPlanDateGr(FD, Templnum)     
    var DateExecution = Date(0,0,0);
    var Select, DataSet, Query;
    Query = "SELECT * FROM ddlgrdeal_dbt"
          + " WHERE  t_DocKind = ?"
          + " AND t_DocID = ? "
          + " AND t_Templnum = ? " ;

    Select = DL_RSDCommand(Query);
    Select.AddParam(FD.tick.rec.BofficeKind);
    Select.AddParam(FD.tick.rec.DealID);
    Select.AddParam(Templnum);
    DataSet = Select.Execute(query);

    if(DataSet.MoveNext())
      DateExecution = DataSet.Plandate;
    end;
    return DateExecution;
end;

macro GetMaxDateClose(FD)

  var query = "(SELECT q.datemax "
            +  "  FROM (  SELECT DECODE (rqmax.T_NETTING, "
            +                          "  CHR (88), rqmax.t_factdate, "
            +                          "  rqmax.t_plandate) "
            +                      " AS datemax "
            +              " FROM ddlrq_dbt rqmax "
            +             " WHERE     rqmax.t_DocKind = " + FD.tick.rec.BofficeKind
            +                   " AND rqmax.t_DocID =  "  + FD.tick.rec.DealID
            +                   " AND rqmax.t_dealPart = 2 "
            +                   " AND (   (    rqmax.t_type IN (2, 8) "
            +                            " AND rqmax.t_state <> 2) "
            +                         " OR (    rqmax.t_type IN (2, 8) "
            +                            " AND rqmax.t_state = 2 "
            +                            " AND rqmax.T_NETTING = "
            +                                   " CHR (88))) "
            +                   " AND not EXISTS "
            +                         " (SELECT 1 "
            +                            " FROM ddlgrdeal_dbt grdeal, "
            +                                  " ddlgracc_dbt gracc  "
            +                           " WHERE     grdeal.t_DocKind = rqmax.t_DocKind "
            +                                "  AND grdeal.t_DocID = rqmax.t_DocID  "
            +                                "  AND grdeal.t_TemplNum IN (31, 34) "
            +                                "  AND gracc.t_GrDealID = grdeal.T_ID  "
            +                                "  AND gracc.t_AccNum = 1 " // БОУ
            +                                "  AND gracc.t_State = 2 " //выполнен 
            +                                "  AND Rsb_Secur.SC_GetRQByGrDeal (grdeal.T_ID) = rqmax.t_ID) "
            +          " ORDER BY DECODE (rqmax.T_NETTING, "
            +                           " CHR (88), rqmax.t_factdate, "
            +                           " rqmax.t_plandate) DESC) q "
            +   " WHERE ROWNUM = 1) ";

  return query;

end;

macro НуженБухучет(TemplNum)
  var query, cmd, DataSet;

  query =   " select 1 "
          + "   from ddlgrtemplacc_dbt tacc "
          + "  where tacc.t_TemplNum = ? "
          + "    and tacc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
          + "    and tacc.t_Calc = 'X'";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(TemplNum);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    return true;
  end;

  return false;    
end;

PRIVATE MACRO TS_ExistNOSS( avr:OBJECT, dat:DATE ):BOOL
  VAR NumInList = "", ValidFromDate = DATE(0,0,0);

  return ( (GetMainObjAttr( null, OBJTYPE_AVOIRISS, UniID(avr, OBJTYPE_AVOIRISS), 
                            29/*Возможность надежного определения ТСС для ДУ*/, 
                            null, null, NumInList, dat, ValidFromDate
                          ) == true
           )
           AND (ValidFromDate <= dat)
           AND (NumInList == "1")
         );
END;

MACRO ПолучитьГруппуСписания( Portfolio:INTEGER ):INTEGER
  VAR Group = KINDPORT_UNDEF;

  if( Portfolio == KINDPORT_CLIENT ) // 0.  КП Клиентский портфель  
     Group = KINDPORT_CLIENT; 
  elif( Portfolio == KINDPORT_TRADE ) // 1. ТП Торговый портфель  
     Group = KINDPORT_TRADE; 
  elif( Portfolio == KINDPORT_SALE )  // 2. ППР Ц/б для продажи 
     Group = KINDPORT_SALE; 
  elif( Portfolio == KINDPORT_CONTR ) // 3. ПКУ   Портфель контрольного участия
     Group = KINDPORT_CONTR; 
  elif( Portfolio == KINDPORT_PROMISSORY ) // 4.  ПДО   Просроченные долговые обязательства
     Group = KINDPORT_PROMISSORY; 
  elif( Portfolio == KINDPORT_RETIRE ) // 5.  ПУДП  ДО, удерживаемые до погашения
     Group = KINDPORT_RETIRE; 
  elif( Portfolio == KINDPORT_BACK ) // 6.  ПВО Ц/б, полученные на возвратной основе  (6)
    Group = KINDPORT_BACK; 
  elif( Portfolio == KINDPORT_TRUST ) // 7. ПДУ Портфель ДУ  (7)
    Group = KINDPORT_TRUST; 
  elif( Portfolio == KINDPORT_BASICDEBT ) // 8. +ОД   Основной долг (8)
    Group = KINDPORT_BASICDEBT; 
  elif( Portfolio == KINDPORT_TRADETRUST ) // 9. ТП_ДУ   Торговый портфель в ДУ (8)
    Group = KINDPORT_TRUST; 
  elif( Portfolio == KINDPORT_SALETRUST ) // 10. ППР_ДУ  Ц/б для продажи  в ДУ  (8)
    Group = KINDPORT_TRUST; 
  end;

  return Group;
END;

macro ПолучитьПоследнююСумму( DocKind, DocID, SumKind, _Date, Currency, _FIID )
   return DL_ПолучитьПоследнююСумму(DocKind, DocID, SumKind, _Date, Currency, _FIID);
end;

/*получить сумму вида Kind по сделке Deal
  Сумма ищется НЕ на дату */
MACRO SP_GetSumma( Deal:OBJECT, Kind:INTEGER, CalcDate:DATE, ToFIID:INTEGER, Summa:@MONEY, NDS:@MONEY, FIID:@INTEGER, Immaterial:BOOL ):BOOL
   VAR SumValue = $0, NdsValue = $0, DS, cmd;

   Summa = NDS = $0;

   cmd = RSDCommand("select t_Sum, t_Nds, t_Currency " +
                    " from ddlsum_dbt " +
                    "where     t_DocKind = ? " +
                    "      and t_DocID   = ? " +
                    "      and t_Kind    = ? " +
                    "      and t_Immaterial " + IIF(Immaterial, "=", "<>") + " CHR(88) " 
                   );

   cmd.addParam("", RSDBP_IN, Deal.rec.BofficeKind );
   cmd.addParam("", RSDBP_IN, Deal.rec.DealID );
   cmd.addParam("", RSDBP_IN, Kind );
   cmd.execute();

   DS = TRsbDataSet(cmd);
   while( DS.MoveNext() )

     if( ToFIID != NULL )
        if( not SmartConvertSum( SumValue, DS.Sum, CalcDate, DS.Currency, ToFIID, true))
           return false;
        end;
        if( not SmartConvertSum( NdsValue, DS.NDS, CalcDate, DS.Currency, ToFIID, true))
           return false;
        end;
        FIID = ToFIID;
     else
        SumValue = DS.Sum;
        NdsValue = DS.NDS;
        FIID     = DS.Currency;
     end;

     Summa = Summa + SumValue;
     NDS   = NDS   + NdsValue;
  end;
  return true;
END;

/*получить сумму всех комиссий по сделке Deal*/
MACRO SP_GetComSumByDeal( Deal:OBJECT, CalcDate:DATE, ToFIID:INTEGER, Summa:@MONEY, NDS:@MONEY, FIID:@INTEGER, Immaterial:BOOL ):BOOL
   VAR SumValue = $0, NdsValue = $0, DS, cmd;

   Summa = NDS = $0;

   var SQLStr:string = " select NVL(sum(dlcomis.t_Sum), 0) AllSum, NVL(sum(dlcomis.t_Nds), 0) AllNDS, comis.t_FIID_Comm Currency " +
                    " from ddlcomis_dbt dlcomis, dsfcomiss_dbt comis " +
                    "where     dlcomis.t_DocKind = ? " +
                    "      and dlcomis.t_DocID   = ? " +
                    "      and dlcomis.t_FeeType   = comis.t_FeeType " +
                       "    and dlcomis.t_ComNumber = comis.t_Number  ";

   if( Immaterial )
      SQLStr = SQLStr + " and dlcomis.t_Immaterial = CHR(88) ";
   else
      SQLStr = SQLStr + " and ((dlcomis.t_Immaterial is null) or (dlcomis.t_Immaterial <> CHR(88))) ";
   end;

   SQLStr = SQLStr + " group by comis.t_FIID_Comm ";

   cmd = RSDCommand(SQLStr);

   cmd.addParam("", RSDBP_IN, Deal.rec.BofficeKind );
   cmd.addParam("", RSDBP_IN, Deal.rec.DealID );
   cmd.execute();

   DS = TRsbDataSet(cmd);
   while( DS.MoveNext() )

     if( ToFIID != NULL )
        if( not SmartConvertSum( SumValue, money(DS.AllSum), CalcDate, DS.Currency, ToFIID, true))
           return false;
        end;
        if( not SmartConvertSum( NdsValue, money(DS.AllNDS), CalcDate, DS.Currency, ToFIID, true))
           return false;
        end;
        FIID = ToFIID;
     else
        SumValue = money(DS.AllSum);
        NdsValue = money(DS.AllNDS);
        FIID     = DS.Currency;
        ToFIID   = FIID;
     end;

     Summa = Summa + SumValue;
     NDS   = NDS   + NdsValue;
  end;
  return true;
END;

/* Получить сумму затрат по сделке 
   Deal:OBJECT         - сделка 
   dat:DATE            - дата, на которую получаются затраты 
   ToFIID:INTEGER      - валюта возвращаемых сумм (в какую валюту конвертировать)
   OutlayFIID:@INTEGER - валюта затрат (всех возвращаемых сумм)
   AllOutlay:@MONEY    - вся сумма затрат (существ.)
   AllOutlayNDS:@MONEY - НДС(существ.)
   AllOutlayShort:@MONEY    - вся сумма затрат (несуществ.)
   AllOutlayNDSShort:@MONEY - НДС(несуществ.)

*/
MACRO ПосчитатьСуммуЗатрат( Deal:OBJECT, dat:DATE, ToFIID:INTEGER, OutlayFIID:@INTEGER, AllOutlay:@MONEY, AllOutlayNDS:@MONEY, AllOutlayShort:@MONEY, AllOutlayNDSShort:@MONEY ):BOOL
  VAR CommSum = $0, CommNDS = $0;

  AllOutlay = AllOutlayNDS = AllOutlayShort = AllOutlayNDSShort = $0;

  if( (Deal.rec.BofficeKind == DL_AVRWRT) OR (Deal.rec.BofficeKind == DL_TRUSTAVRWRT) )
     if( not SP_GetSumma( Deal, DLSUM_KIND_OUTLAY, dat, ToFIID, @AllOutlay, NULL, @OutlayFIID ) )
        return false;
     end;
  end;

  //Сумма комиссий по операции (существенные затраты)
  if( not SP_GetComSumByDeal( Deal, dat, ToFIID, @CommSum, @CommNDS, @OutlayFIID ) )
     return false;
  end;
  AllOutlay    = AllOutlay + CommSum;
  AllOutlayNDS = AllOutlayNDS + CommNDS;

  //Сумма комиссий по операции (не существенные затраты)
  if( not SP_GetComSumByDeal( Deal, dat, ToFIID, @CommSum, @CommNDS, @OutlayFIID, true ) )
     return false;
  end;
  AllOutlayShort    = AllOutlayShort + CommSum;
  AllOutlayNDSShort = AllOutlayNDSShort + CommNDS;

  return true; 
END;

/*получить запись вида Kind по сделке Deal
  Сумма ищется НЕ на дату */
MACRO SP_GetDLSumByDocKind( DocKind:INTEGER, DocID:INTEGER, Kind:INTEGER, dl_sum:@OBJECT ):BOOL
   VAR DS, cmd;

   cmd = RSDCommand("select * " +
                    " from ddlsum_dbt " +
                    "where     t_DocKind = ? " +
                    "      and t_DocID   = ? " +
                    "      and t_Kind    = ? " +
                    " Order by t_Date Desc ");

   cmd.addParam("", RSDBP_IN, DocKind );
   cmd.addParam("", RSDBP_IN, DocID );
   cmd.addParam("", RSDBP_IN, Kind );
   cmd.execute();

   DS = TRsbDataSet(cmd);
   if( DS.MoveNext() )
      DS.GetRecord().CopyTo( dl_sum.rec );
      return true;
   end;
   return false;
END;

/*
Получить сумму премии по сделке. В лоте ее пока еще нет, да и почти ничего еще нет в лоте.
*/
MACRO SP_GetBonusSum( FD ):MONEY
   var DealSum = $0, PreOutlaySum = $0, OutlaySum = $0, OutlaySumNDS = $0;
   var LastDate = Date(0,0,0), Bonus0 = $0;
   var DataSet, query, cmd;

   // Дублирование кода :(  А как иначе - этих сумм еще нет на лоте.

   /*Только для облигаций по своим сделкам*/
   if ((not IsClientDeal(FD.tick.rec)) and FI_IsBond(FD.fininstr) )

     query =   " select NVL(SUM(t_BegBonus), 0) as Bonus0 "
             + "   from v_scwrthistex "
             + "  where t_SumID = ? "
             + "    and t_Action = " + PM_WRTSUM_UPDTMODE_CREATE;

     cmd = DL_RSDCommand(query);
     cmd.AddParam(FD.pmwrtsum.rec.SumID);

     DataSet = cmd.Execute();
     if(DataSet.moveNext())
       Bonus0 = DataSet.Bonus0;
     end;

     if (Bonus0 < 0)
        Bonus0 = 0;
     end;
   else
      Bonus0 = 0;
   end;

   return Bonus0;
END;

/* Определяет валюту учёта ВУ при создании лотов */
macro SP_WRTDetermineAccFI( FIID:INTEGER )
   var AccFI =ALLFININSTR, 
       ds, 
       dc = RSDCommand(" select "+
                       " RSB_PMWRTOFF.WRTDetermineAccFI(?) AccFI " +
                       " from dual");
   dc.addParam("", RSDBP_IN, FIID);
   dc.execute();
   ds = TRsbDataSet(dc);
   if( ds.MoveNext() )
      AccFI = int(ds.AccFI); 
   end;
   return AccFI;
end; 

/* процедура изменения/создания лота */
PRIVATE RECORD WrtSum( pmwrtsum );
PRIVATE VAR AgenComm = TBfile("dlsum.dbt");
MACRO ОбновитьЛот( _WrtSum, Mode:INTEGER, ChangeDate:DATE, FD:SPFirst, Parm1:Variant, ForContr ):BOOL
   var stat = FALSE, DealSum = $0, PreOutlaySum = $0, OutlaySum = $0, OutlaySumNDS = $0;
   var PartNum, Query, LastDate = ZeroDate, BegDate = ZeroDate, BegBonusDate = ZeroDate, Bonus = $0, BEGINTERESTDATE = ZeroDate;
   var BEGDISCOUNT = $0, OLDBEGDISCOUNT = $0, NOTCARRYDISCOUNT = $0, DISCOUNTCORR = $0, BEGDISCOUNTDATE = ZeroDate;
   record pmpaym1("pmpaym");

   Copy( WrtSum, _WrtSum );

   if(ValType(ForContr) != V_BOOL)
     ForContr = false;
   end;

   wrtsum.ChangeDate = ChangeDate; /*дата изменения лота*/

   if( Mode == PM_WRTSUM_UPDTMODE_CREATE ) /*создание лота*/

      if( FD.Kind == DL_MOVINGDOC )
         WrtSum.DocKind    = FD.comm.rec.DocKind;
         WrtSum.DocID      = FD.comm.rec.DocumentID;
         WrtSum.PartNum    = 0;
         WrtSum.Party      = -1;
         WrtSum.FIID       = FD.comm.rec.fiid;
         WrtSum.PORTFOLIO  = FD.comm_trans.rec.OutPortofolio1;
         WrtSum.GroupID    = ПолучитьГруппуСписания( FD.comm_trans.rec.OutPortofolio1 );
         WrtSum.Buy_Sale   = PM_WRITEOFF_SUM_SALE;
         WrtSum.Kind       = 80; /* PM_WRTSUM_KIND_MS */
         WrtSum.Date       = ChangeDate;
         WrtSum.Time       = Time(23, 59, 59, 59);
         WrtSum.Department = {OperDprt};
         WrtSum.DealID     = FD.comm.rec.DocumentID;
         WrtSum.DealDate   = FD.comm.rec.commdate;
         WrtSum.DealCode   = FD.comm.rec.commcode;
         WrtSum.State      = PM_WRTSUM_NOTFORM;
         WrtSum.EnterDate  = ChangeDate;
         WrtSum.StateDate  = ChangeDate;
         WrtSum.ChangeDate = ChangeDate;
         WrtSum.Action     = PM_WRTSUM_UPDTMODE_DELIVERY;

         if( FindPayment(null, PurpBase, DLCOMM_SUBPURPOSE_TRADE,  FD.comm.rec.DocKind, FD.comm.rec.DocumentID, true, pmpaym1) )
            msgbox("Не найден платеж");
            return false;
         else
           WrtSum.Amount   = pmpaym1.BaseAmount;
         end;

      else

         WrtSum.Coupon  = FD.tick.rec.Number_Coupon;
         WrtSum.Partly  = FD.tick.rec.Number_Partly;

         if( IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group) )
            WrtSum.DocKind = FD.tick.rec.BofficeKind;
            WrtSum.DocID   = FD.tick.rec.DealID;
            WrtSum.FIID    = FD.dl_leg.rec.PFI;
            WrtSum.Amount  = FD.dl_leg.rec.Principal;
            WrtSum.Buy_Sale= PM_WRITEOFF_SUM_COUPON;
         else
            if( not FD.ExistsRQ(DLRQ_TYPE_DELIVERY) )
               MsgBox( "Ошибка при создании лота. Не задано ТО по ц/б" );
               return false;
            end;
            WrtSum.DocKind = DLDOC_PAYMENT;
            WrtSum.DocID   = FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID;
            WrtSum.FIID    = FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.FIID;
            WrtSum.Amount  = FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.Amount;

            if(ForContr)
              if( IsBUY(FD.Group) )
                 if(FD.IsBack)
                   WrtSum.Buy_Sale = PM_WRITEOFF_SUM_BUY;
                 else
                   WrtSum.Buy_Sale = PM_WRITEOFF_SUM_SALE;
                 end;
              else 
                 if(FD.IsBack)
                   WrtSum.Buy_Sale = PM_WRITEOFF_SUM_SALE;
                 else
                   WrtSum.Buy_Sale = PM_WRITEOFF_SUM_BUY;
                 end;
              end;
            else
              if( SP_RqIsSale( FD.GetRQ(DLRQ_TYPE_DELIVERY), FD.tick ) )
                 WrtSum.Buy_Sale= PM_WRITEOFF_SUM_SALE;
              else
                 if( IsTwoPart(FD.Group) AND IsBUY(FD.Group) )
                    WrtSum.Buy_Sale = PM_WRITEOFF_SUM_BUY_BO;
                 else
                    WrtSum.Buy_Sale = PM_WRITEOFF_SUM_BUY;
                 end;
              end;
            end;
         end;

         /* в сделке ДУ будет ПДУ а в лоте ТП или ППР при этом GroupID буду равны*/
         if( (FD.Kind != DL_TRUSTDOC) AND (FD.Kind != DL_TRUSTRETIREMENT) )
            if( FD.tick.rec.BOfficeKind == DL_TRUSTAVRWRT )
               WrtSum.PORTFOLIO  = FD.tick.rec.PortfolioID;
            elif( IsClientDeal(FD.tick.rec) )
               WrtSum.PORTFOLIO = KINDPORT_CLIENT;
            else
               if( FD.tick.rec.BofficeKind != DL_CONVAVR )
                  WrtSum.PORTFOLIO  = FD.tick.rec.PortfolioID;
               else
                  if (FD.IsBack)
                     WrtSum.PORTFOLIO = FD.tick.rec.PortfolioID_2;
                  else
                     WrtSum.PORTFOLIO = FD.tick.rec.PortfolioID;
                  end;
               end;
            end;

            WrtSum.GroupID    = ПолучитьГруппуСписания( WrtSum.PORTFOLIO );
         else
            WrtSum.PORTFOLIO  = FD.tick.rec.PortfolioID;
            WrtSum.GroupID    = ПолучитьГруппуСписания( WrtSum.PORTFOLIO );
         end;


         if( FD.tick.rec.BofficeKind == DL_CONVAVR )
            if( FD.IsBack == false )
               /* для второй части при поставке*/
               GetOprDate( FD.GetKindDate( DATE_CONVAVR_OUT ), WrtSum.Date );
               WrtSum.Time       = FD.dl_leg.rec.SupplyTime;
            end;
         elif( (FD.Kind == DL_AVRWRT) OR (FD.Kind == DL_TRUSTAVRWRT) )
            WrtSum.Date = ChangeDate;
            WrtSum.Time  = FD.tick.rec.DealTime;
         else
            if( IsTwoPart(FD.Group) and IsEXCHANGE(FD.Group) )
               GetOprDate( FD.GetKindDate(DATE_DEALEXEC), WrtSum.Date );
            //для сделок today это происходит на 1-м шаге, поэтому даты по сделке еще не определены. Всё датой сделки.
            elif( IsTODAY(FD.Group) )
               WrtSum.Date = FD.tick.rec.DealDate;
            else
               GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), WrtSum.Date );
            end;
            WrtSum.Time       = FD.dl_leg.rec.SupplyTime;
         end;

         if(ForContr)
           WrtSum.Party  = FD.tick.rec.PartyID;
           WrtSum.Contract = FD.tick.rec.PartyContrID;
           WrtSum.PartNum = 1;
         elif( IsClientDeal(FD.tick.rec) )
           WrtSum.Party  = FD.tick.rec.ClientID;
           WrtSum.Contract = FD.tick.rec.ClientContrID;
         else
           WrtSum.Party  = -1;
         end;

         if( (FD.tick.rec.BOfficeKind == DL_TRUSTDOC) OR (FD.tick.rec.BOfficeKind == DL_TRUSTAVRWRT) OR
             (FD.tick.rec.BOfficeKind == DL_TRUSTRETIREMENT)
           )
            WrtSum.Contract = FD.tick.rec.ClientContrID;
            WrtSum.Trust = SET_CHAR;
         end;

         WrtSum.Kind     = SP_GetLotKind( FD.Group, FD.IsBack, ForContr );
         WrtSum.Department = FD.tick.rec.Department;
         WrtSum.DealID   = FD.tick.rec.DealID;
         WrtSum.DealDate = FD.tick.rec.DealDate;
         WrtSum.DealCode = FD.tick.rec.DealCode;

         WrtSum.State     = PM_WRTSUM_NOTFORM;
         WrtSum.StateDate = WrtSum.EnterDate = wrtsum.ChangeDate;
         if( Parm1 )
            WrtSum.Parent = Parm1;
         end;

         WrtSum.AccFI     = SP_WRTDetermineAccFI( WrtSum.FIID );
      end;

   elif( (Mode == PM_WRTSUM_UPDTMODE_DELIVERY) OR (Mode == PM_WRTSUM_UPDTMODE_CDELIVERY) ) /*Поставка*/

      /* проверка поля депозитарий */
      if( (FD.tick != null) AND
          ( ( FD.tick.rec.BofficeKind == DL_SECURITYDOC ) OR
            ( FD.tick.rec.BofficeKind == DL_AVRWRT ) OR
            ( FD.tick.rec.BofficeKind == DL_RETIREMENT )
          ) AND ВестиВнутреннийУчет()
        )
          if( FD.tick.rec.BofficeKind == DL_RETIREMENT )
             if( (FD.dl_leg.rec.Registrar <= 0) and (FD.tick.rec.Flag4 != SET_CHAR) ) // в брокерском погашении поле "Депозитарий" не заполняется
                if( IsRET_ISSUE( FD.Group ) )
                   MsgBox( "Не задано поле \"Депозитарий\" в погашении " );
                   return false;
                end;
             end;    
          elif( FD.dl_leg.rec.DepositID <= 0 )
             if( (FD.IsBack == true) AND IsTwoPart(FD.Group) AND IsEXCHANGE(FD.Group) )
                // в биржевых РЕПО депозитарий задается только в первой части
                VAR dl_leg_1 = TrecHandler( "dl_leg.dbt" ); 
                if( FindDL_LEG( LEG_KIND_DL_TICK, FD.tick.rec.DealID, 0, dl_leg_1 ) )
                   MsgBox( "Не найдены условия по первой части сделки" );
                   return false;
                end;

                if( dl_leg_1.rec.DepositID <= 0 )
                   MsgBox( "Не задано поле \"Депозитарий\" в сделке " );
                   return false;
                end;
             else
                MsgBox( "Не задано поле \"Депозитарий\" в сделке " );
                return false;
             end;
          end;
      end;

      if( FD.Kind == DL_MOVINGDOC )

         WrtSum.State = PM_WRTSUM_FORM;

      elif( (WrtSum.Kind != PM_WRTSUM_KIND_RRWAB2) OR IsClientDeal(FD.tick.rec)/*210*/ ) /*поставка для всех сделок кроме прямого репо(собственного), для клиентских все как и для обычных покупок*/

         if( (IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group)) and (FD.Kind == DL_TRUSTRETIREMENT) )
            WrtSum.FIID     = FD.dl_leg.rec.PFI;
            WrtSum.Amount   = FD.dl_leg.rec.Principal;

         elif( (IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group)) and (FD.Kind != DL_TRUSTRETIREMENT) )
            WrtSum.FIID     = FD.dl_leg.rec.PFI;

            WrtSum.Amount = WRTGetWrtAmount( FD.tick.rec.Department,
                                             FD.dl_leg.rec.PFI,
                                             IIF(IsClientDeal(FD.tick.rec), FD.tick.rec.ClientID, -1),
                                             IIF(IsClientDeal(FD.tick.rec), FD.tick.rec.ClientContrID, 0),
                                             -1,
                                             FD.tick.rec.Number_Coupon,
                                             FD.tick.rec.Number_Partly,
                                             FD.tick.rec.DealDate,
                                             IIF(IsClientDeal(FD.tick.rec), FD.dl_leg.rec.Start, null)
                                           );
         else
            if( not FD.ExistsRQ(DLRQ_TYPE_DELIVERY) )
               MsgBox( "Ошибка при выполнении поставки лота. Не задано ТО по ц/б" );
               return false;
            end;

            WrtSum.FIID = FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.FIID;

            if( IsRET_ISSUE(FD.Group) and (FD.Kind == DL_RETIREMENT) )
               if ((FD.tick.rec.Number_Coupon == "") and
                   (FD.tick.rec.Number_Partly == "")
                  )
                  WrtSum.Amount = WRTGetPortfolioAmount( FD.tick.rec.Department,
                                                         FD.dl_leg.rec.PFI,
                                                         IIF(IsClientDeal(FD.tick.rec), FD.tick.rec.ClientID, -1),
                                                         IIF(IsClientDeal(FD.tick.rec), FD.tick.rec.ClientContrID, 0),
                                                         -1,
                                                         -1,
                                                         FD.tick.rec.DealDate,
                                                         true, false, false
                                                       );
                  /*ПВО не учитываем*/
                  if (not IsClientDeal(FD.tick.rec))
                     WrtSum.Amount = WrtSum.Amount - WRTGetPortfolioAmount( FD.tick.rec.Department,
                                                                            FD.dl_leg.rec.PFI,
                                                                            -1,
                                                                            0,
                                                                            KINDPORT_BACK,
                                                                            -1,
                                                                            FD.tick.rec.DealDate,
                                                                            true, false, false
                                                                          );
                  end;
               else // В погашении ц/б задан купон или ЧП
                  WrtSum.Amount = WRTGetWrtAmount( FD.tick.rec.Department,
                                                   FD.dl_leg.rec.PFI,
                                                   IIF(IsClientDeal(FD.tick.rec), FD.tick.rec.ClientID, -1),
                                                   IIF(IsClientDeal(FD.tick.rec), FD.tick.rec.ClientContrID, 0),
                                                   -1,
                                                   FD.tick.rec.Number_Coupon,
                                                   FD.tick.rec.Number_Partly,
                                                   FD.tick.rec.DealDate,
                                                   IIF(IsClientDeal(FD.tick.rec), FD.dl_leg.rec.Start, null)
                                                 );

                  /*ПВО не учитываем*/
                  if (not IsClientDeal(FD.tick.rec))
                     WrtSum.Amount = WrtSum.Amount - WRTGetWrtAmount( FD.tick.rec.Department,
                                                                      FD.dl_leg.rec.PFI,
                                                                      -1,
                                                                      0,
                                                                      KINDPORT_BACK,
                                                                      FD.tick.rec.Number_Coupon,
                                                                      FD.tick.rec.Number_Partly,
                                                                      FD.tick.rec.DealDate,
                                                                      null
                                                                    );
                  end;
               end;

            else
               WrtSum.Amount   = FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.Amount;
            end;
         end;

         WrtSum.Sum      = FD.dl_leg.rec.Cost;
         WrtSum.Currency = FD.dl_leg.rec.CFI;

         if (WrtSum.Partly != "")
            WrtSum.Sum = WrtSum.Sum * WrtSum.Amount / FD.dl_leg.rec.Principal;
         end;

         if( (FD.tick.rec.BofficeKind == DL_CONVAVR) AND (FD.IsBack) )
            GetOprDate( DATE_CONVAVR_IN, WrtSum.Date );
         elif( (FD.tick.rec.BofficeKind == DL_CONVAVR) AND (not FD.IsBack) )
            GetOprDate( DATE_CONVAVR_OUT, WrtSum.Date );
         elif( IsTwoPart(FD.Group) and IsEXCHANGE(FD.Group) )
            GetOprDate( FD.GetKindDate(DATE_DEALEXEC), WrtSum.Date );
            WrtSum.Time       = FD.dl_leg.rec.SupplyTime;
         elif( (FD.Kind != DL_AVRWRT) AND (FD.Kind != DL_TRUSTAVRWRT) )
            GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), WrtSum.Date );
            WrtSum.Time       = FD.dl_leg.rec.SupplyTime;
         end;

         if ((WrtSum.Party == -1) or (WrtSum.Trust == SET_CHAR))
            if( FD.ВедетсяБалансУчетПоСделке() == true )
               DealSum = ПолучитьПоследнююСумму(DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate);
               if (LastDate > wrtsum.ChangeDate)
                  MsgBox( "Дата последней суммы по ТО по поставке для сделки с кодом " + 
                          string(FD.tick.rec.DealCode) + 
                          " должна быть меньше даты операции");      
                  return false;
               end;
            end;

            if (DealSum == $0)
               if( not SmartConvertSum( DealSum, FD.dl_leg.rec.TotalCost, wrtsum.ChangeDate, FD.dl_leg.rec.CFI, FD.FaceFIID(), true))
                  return false;
               end;
            end;
            if( FD.tick.rec.PreOutlay > 0 )
               if( not SmartConvertSum( PreOutlaySum, FD.tick.rec.PreOutlay, wrtsum.ChangeDate, FD.tick.rec.PreOutlayFIID, FD.FaceFIID(), true))
                  return false;
               end;
            end;

            if( (FD.Kind == DL_TRUSTDOC) OR (FD.Kind == DL_TRUSTRETIREMENT) )
               if( IsBUY( FD.Group ) )
                  if( TS_ExistNOSS( FD.Avoiriss, ChangeDate) )
                     WrtSum.Portfolio = KINDPORT_TRADETRUST;
                  else
                     WrtSum.Portfolio = KINDPORT_SALETRUST;
                  end;
               else
                  WrtSum.Portfolio = KINDPORT_TRUST;
               end;

               WrtSum.GroupID    = ПолучитьГруппуСписания( WrtSum.Portfolio );
            end;
                                   
            if( (FD.Kind == DL_AVRWRT) OR (FD.Kind == DL_TRUSTAVRWRT) )
               WrtSum.BalanceCost = DealSum;
               if( IsAVRWRTIN( FD.Group ) )
                 /*найти предварит. затраты по dlsum_dbt*/
                  if( ПосчитатьСуммуЗатрат( FD.tick, wrtsum.ChangeDate, FD.FaceFIID(), NULL, @OutlaySum ) == false )
                     return false;
                  end;
                  WrtSum.Outlay      = OutlaySum + PreOutlaySum; 

                 /*найти переоценку по dlsum_dbt*/
                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_OVERVALUE, @AgenComm ) )
                    OutlaySum = 0;
                 if( abs(AgenComm.rec.Sum) > 0 )/*переводим из рублей в валюту номинала*/
                     if( not SmartConvertSum( OutlaySum, AgenComm.rec.Sum, AgenComm.rec.Date, AgenComm.rec.Currency, FD.FaceFIID(), true))
                           return false;
                        end;
                     end;
                     WrtSum.BalanceCost = WrtSum.BalanceCost + OutlaySum;
                     WrtSum.OverAmount = AgenComm.rec.Sum;/*сумма в рублях - ее и берем*/
                     WrtSum.OverDate   = AgenComm.rec.Date;
                  end;
                 /*найти ПД по dlsum_dbt "Процентный доход"*/
                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_INTERESTINCOME, @AgenComm ) )
                     OutlaySum = 0;
                     if( AgenComm.rec.Sum > 0 )
                        if( not SmartConvertSum( OutlaySum, AgenComm.rec.Sum, wrtsum.ChangeDate, AgenComm.rec.Currency, FD.FaceFIID(), true))
                           return false;
                        end;

                        WrtSum.InterestDate   = WrtSum.Date;
                     end;
                     WrtSum.BalanceCost = WrtSum.BalanceCost + OutlaySum;
                     /*Только для облигаций по своим лотам*/
                     if ( (ID_le_OurBank(WrtSum.Party) OR (WrtSum.Trust == SET_CHAR) ) and FI_IsBond(FD.fininstr) )
                        BEGINTERESTDATE       = AgenComm.rec.Date;
                        WrtSum.InterestIncome = OutlaySum;/*ПД*/
                     end;
                  end;

                 /*найти ДД по dlsum_dbt*/
                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_DISCONTINCOME, @AgenComm ) )
                     OutlaySum = 0;
                     if( not SmartConvertSum( OutlaySum, AgenComm.rec.Sum, wrtsum.ChangeDate, AgenComm.rec.Currency, FD.FaceFIID(), true))
                        return false;
                     end;

                     WrtSum.BalanceCost = WrtSum.BalanceCost + OutlaySum;
                     WrtSum.DiscountIncome = OutlaySum;/*ДД*/
                  end;
                  WrtSum.DiscountDate   = WrtSum.Date;

                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_BEGDISCONTINCOME, @AgenComm ) )
                     BEGDISCOUNT = AgenComm.rec.Sum;
                     BEGDISCOUNTDATE = AgenComm.rec.Date;
                  end;

                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_OLDBEGDISCONTINCOME, @AgenComm ) )
                     OLDBEGDISCOUNT = AgenComm.rec.Sum;
                     BEGDISCOUNTDATE = AgenComm.rec.Date;
                  end;

                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_DISCONTINCOMENOTCARRY, @AgenComm ) )
                     NOTCARRYDISCOUNT = AgenComm.rec.Sum;
                  end;

                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_DISCONTCORR, @AgenComm ) )
                     DISCOUNTCORR = AgenComm.rec.Sum;
                  end;

                  /*найти бонус по dlsum_dbt*/
                  if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_BONUS, @AgenComm ) )
                     OutlaySum = 0;
                     if( not SmartConvertSum( OutlaySum, AgenComm.rec.Sum, wrtsum.ChangeDate, AgenComm.rec.Currency, FD.FaceFIID(), true))
                        return false;
                     end;

                     WrtSum.Bonus = OutlaySum;/*начисленная премия*/
                  end;
                  WrtSum.BonusDate = WrtSum.Date;

                  WrtSum.BalanceCost = WrtSum.BalanceCost + WrtSum.Outlay;
               end;
            else
               if( IsBuy( FD.Group ) AND (not IsTwoPart( FD.Group )) 
                 )
                  if( ПосчитатьСуммуЗатрат( FD.tick, wrtsum.ChangeDate, FD.FaceFIID(), NULL, @OutlaySum, @OutlaySumNDS ) == false )
                     return false;
                  end;
                  WrtSum.Outlay = OutlaySum + PreOutlaySum;
               end;

               if( WrtSum.GroupID == KINDPORT_BACK )
                  WrtSum.BalanceCost = DealSum;
               else
                  WrtSum.BalanceCost = DealSum + OutlaySum + PreOutlaySum;
               end;
            end;
                                                    
            if( FD.tick.rec.BofficeKind == DL_CONVAVR )
               if( not FD.IsBack ) 
                  WrtSum.BalanceCost = DealSum;
                  WrtSum.Cost        = WrtSum.BalanceCost;
               else
                  WrtSum.BalanceCost = FD.pmwrtsum.rec.BalanceCost;
                  WrtSum.Cost        = FD.pmwrtsum.rec.Cost;
                  WrtSum.Outlay      = FD.pmwrtsum.rec.Outlay;

                  /*Только для облигаций по своим лотам*/
                  if ( ID_le_OurBank(WrtSum.Party) and FI_IsBond(FD.fininstr) )
                     WrtSum.BegDiscount = money(WrtSum.Amount * FD.FaceValueOnSetAv()) - WrtSum.Cost;
                     if (WrtSum.BegDiscount < $0)
                        WrtSum.BegDiscount = $0;
                     end;
                  end;
               end;                    

               WrtSum.AccFI          = SP_WRTDetermineAccFI( WrtSum.FIID );
               if( WrtSum.BalanceCost != $0 )
                  if( not SmartConvertSum( WrtSum.AccBalanceCost, WrtSum.BalanceCost, WrtSum.Date, FD.FaceFIID(), WrtSum.AccFI, true))
                     return false;
                  end;
               end;
            else
               WrtSum.NKDAmount   = FD.dl_leg.rec.NKD;
               if (WrtSum.Coupon != "")
                  WrtSum.NKDAmount = СуммаКупона(WrtSum.FIID, WrtSum.Amount, FD.tick.rec.DealDate);
               end;

               if ((WrtSum.Coupon != "") or (WrtSum.Partly != ""))
                  WrtSum.Cost = WrtSum.Sum;
                  WrtSum.BalanceCost = WrtSum.Cost  + WrtSum.NKDAmount;
               else
                  WrtSum.Cost        = WrtSum.BalanceCost - WrtSum.NKDAmount;
                  if( IsAVRWRTIN( FD.Group ))
                     WrtSum.Cost        = WrtSum.Cost - WrtSum.InterestIncome - WrtSum.DiscountIncome - WrtSum.OverAmount;
                  end;
               end;

               if( IsAVRWRTIN( FD.Group ) )
                  /*Только для облигаций по своим лотам*/
                  if ( (ID_le_OurBank(WrtSum.Party) OR (WrtSum.Trust == SET_CHAR) ) and FI_IsBond(FD.fininstr) )
                     /*Дата исходной покупки*/
                     BegDate = FD.dl_leg.rec.START;
                     /*Не отнесенный на доходы ПД*/
                     if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_INTERESTINCOMENOTCARRY, @AgenComm ) )
                        WrtSum.NOTCARRYINTEREST = AgenComm.rec.Sum;
                     end;
                     /*Дата начала начисления ДД*/
                     WrtSum.BEGDISCOUNTDATE = BEGDISCOUNTDATE;  
                     /*Начальный дисконт*/
                     WrtSum.BEGDISCOUNT = BEGDISCOUNT;
                     /*Начальный дисконт до перевода*/
                     WrtSum.OLDBEGDISCOUNT = OLDBEGDISCOUNT;
                     /*Коррекция дисконта*/
                     WrtSum.DISCOUNTCORR = DISCOUNTCORR;
                     /*Не отнесенный на доходы ДД*/
                     WrtSum.NOTCARRYDISCOUNT = NOTCARRYDISCOUNT;
                     /*Дата начала начисления ПД*/
                     WrtSum.BEGINTERESTDATE = BEGINTERESTDATE;

                     if( CheckChargeBonus() )
                        /*Начальная премия*/
                        if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_BEGBONUS, @AgenComm ) )
                           WrtSum.BEGBONUS = AgenComm.rec.Sum;
                           BegBonusDate = AgenComm.rec.Date;
                        end;
                        /*Начальная премия  до перевода*/
                        if( SP_GetDLSumByDocKind(FD.tick.rec.BofficeKind, WrtSum.DealID, DLSUM_KIND_OLDBEGBONUS, @AgenComm ) )
                           WrtSum.OLDBEGBONUS = AgenComm.rec.Sum;
                           BegBonusDate = AgenComm.rec.Date;
                        end;
                        /*если ( T_BEGBONUS  > 0 или  T_OLDBEGBONUS  > 0) дата из DLSUM "Начальная премия"*/
                        WrtSum.BegBonusDate = BegBonusDate;
                     end;

                     /*Дата пересчета дисконта/премии*/
                     WrtSum.RECALCDATE = FD.dl_leg.rec.INTERESTSTART;
                  
                     /*вычитаем сумму бонуса, указанную в панели зачисления*/
                     WrtSum.Cost = WrtSum.Cost - WrtSum.Bonus;
                     WrtSum.BalanceCost = WrtSum.BalanceCost - WrtSum.Bonus;
                  end;
               elif( IsBUY( FD.Group ) )
                  /*Только для облигаций по своим лотам*/
                  if ( (ID_le_OurBank(WrtSum.Party) OR (WrtSum.Trust == SET_CHAR) ) and FI_IsBond(FD.fininstr) )

                     if( BegDate != ZeroDate )
                        WrtSum.BegDiscount = money(WrtSum.Amount * GetFaceValue( FD.fininstr.rec.FIID, BegDate)) - WrtSum.Cost;
                     else
                        WrtSum.BegDiscount = money(WrtSum.Amount * FD.FaceValueOnSetAv()) - WrtSum.Cost;
                     end;

                     if (WrtSum.BegDiscount < $0)
                        WrtSum.BegDiscount = $0;
                     end;

                     if( BEGINTERESTDATE != ZeroDate )
                        WrtSum.BEGINTERESTDATE = BEGINTERESTDATE;
                     else
                        WrtSum.BEGINTERESTDATE = WrtSum.Date;
                     end;

                     if( WrtSum.BEGDISCOUNT > 0 )
                        WrtSum.BEGDISCOUNTDATE = WrtSum.Date;
                     end;

                     if( CheckChargeBonus() )
                        if( BegBonusDate != ZeroDate )
                           Bonus = WrtSum.Cost - money(WrtSum.Amount * GetFaceValue( FD.fininstr.rec.FIID, BegBonusDate));
                        else
                           Bonus = WrtSum.Cost - money(WrtSum.Amount * FD.FaceValueOnSetAv());
                        end;
                        if (Bonus < $0)
                           Bonus = $0;
                        end;
                        WrtSum.BegBonus = Bonus;
                     end;

                     if( (WrtSum.BEGBONUS > 0) AND CheckChargeBonus() )
                        WrtSum.BEGBONUSDATE = WrtSum.Date;
                     end;

                     if (FD.GetMethodWriteOff() == PM_WRITEOFF_AVERAGE)
                        WrtSum.BEGDISCOUNTDATE = WrtSum.Date;
                        WrtSum.BEGBONUSDATE = WrtSum.Date;
                     end;
                  end;
               else
                  WrtSum.BegDiscount = $0;
               end;
            end;

            if( WrtSum.Buy_Sale == PM_WRITEOFF_SUM_BUY )
               if( BegDate != ZeroDate )
                  WrtSum.BEGDATE = BegDate;
               else
                  WrtSum.BEGDATE = WrtSum.Date;
               end;
            end;
         end;
         
         WrtSum.State   = PM_WRTSUM_FORM;

      elif( WrtSum.Kind == PM_WRTSUM_KIND_RRWAB2 /*210*/ ) /*поставка для прямого репо по второй части*/
         if( WrtSum.Portfolio == KINDPORT_BASICDEBT )  /*Лот по ц/б, списанным из ПВО*/
            /*Если на момент поставки по 2 ч ц/б имеет ТСС -ТП, иначе - ППР*/

            if( ExistNOSS( FD.avoiriss, ChangeDate ) )
               WrtSum.Portfolio = KINDPORT_TRADE;
            else
               WrtSum.Portfolio = KINDPORT_SALE;
            end;

            WrtSum.GroupID = ПолучитьГруппуСписания( WrtSum.Portfolio );

            WrtSum.Amount        = WrtSum.AmountBD;
            WrtSum.AmountBD      = $0;
            WrtSum.Sum           = FD.dl_leg.rec.Cost* WrtSum.Amount / FD.dl_leg.rec.Principal;
            WrtSum.Currency      = FD.dl_leg.rec.CFI;

            if ((WrtSum.Party == -1) or (WrtSum.Trust == SET_CHAR))
               WrtSum.BalanceCost   = WrtSum.BalanceCostBD;
               WrtSum.BalanceCostBD = $0;

               WrtSum.Cost          = WrtSum.BalanceCost - WrtSum.NKDAmount;

               /*Только для облигаций по своим лотам*/
               if ( ID_le_OurBank(WrtSum.Party) and FI_IsBond(FD.fininstr) )
                  WrtSum.BegDiscount   = money(WrtSum.Amount * FD.FaceValueOnSetAv()) - WrtSum.Cost;
                  if (WrtSum.BegDiscount < $0)
                     WrtSum.BegDiscount = $0;
                  end;

                  WrtSum.BegBonus   = WrtSum.Cost - money(WrtSum.Amount * FD.FaceValueOnSetAv());
                  if (WrtSum.BegBonus < $0)
                     WrtSum.BegBonus = $0;
                  end;
                  WrtSum.BEGINTERESTDATE = WrtSum.Date;
                  if( WrtSum.BEGDISCOUNT > 0 )
                     WrtSum.BEGDISCOUNTDATE = WrtSum.Date;
                  end;
                  if (FD.GetMethodWriteOff() == PM_WRITEOFF_AVERAGE)
                     WrtSum.BEGDISCOUNTDATE = WrtSum.Date;
                     WrtSum.BEGBONUSDATE = WrtSum.Date;
                  end;
               end;
            end;

            if( IsTwoPart(FD.Group) and IsEXCHANGE(FD.Group) )
               GetOprDate( FD.GetKindDate(DATE_DEALEXEC), WrtSum.Date );
               WrtSum.Time       = FD.dl_leg.rec.SupplyTime;
            else
               GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), WrtSum.Date );
               WrtSum.Time       = FD.dl_leg.rec.SupplyTime;
            end;

            if ((WrtSum.Party == -1) or (WrtSum.Trust == SET_CHAR))
               WrtSum.BEGDATE = WrtSum.Date;
               WrtSum.BEGBONUSDATE = WrtSum.Date;
            end;
         end;
         WrtSum.State         = PM_WRTSUM_FORM;
      end;
   elif( Mode == PM_WRTSUM_UPDTMODE_CHANGEDATE ) /*Изменение сроков исполнения*/
        if( ValType(Parm1) == V_DATE )
           WrtSum.Date = Parm1;
        else
           WrtSum.Date = ChangeDate;           
        end;
   elif( Mode == PM_WRTSUM_UPDTMODE_CHANGETERM ) /*Изменение условий*/

   elif( Mode == PM_WRTSUM_UPDTMODE_CORRECT ) /*Редактирование лота*/

   elif( Mode == PM_WRTSUM_UPDTMODE_REJECTEXEC ) /*Отказ*/
        WrtSum.State = PM_WRTSUM_CANCEL;
        WrtSum.Date  = ChangeDate;

        /*отказ от 2ч обратного РЕПО, где по 1ч есть непроданный остаток.
          Зовем ХП, она сделает все специфическое.
          Parm1 - буфер лота 1ч.
        */
        if ((ValType(Parm1) != V_UNDEF) and IsTwoPart( FD.Group ) and IsBUY( FD.Group ) and (Parm1.Amount > 0))

           if( not SmartConvertSum( Parm1.Cost, Parm1.Sum, Parm1.ChangeDate, Parm1.Currency, FD.FaceFIID(), true))
              return false;
           end;

           /*Только для облигаций по своим лотам*/
           if ( ID_le_OurBank(WrtSum.Party) and FI_IsBond(FD.fininstr) )
              Parm1.BegDiscount = money(Parm1.Amount * 
                                        GetFaceValue( FD.fininstr.rec.FIID, Parm1.ChangeDate )
                                       ) - Parm1.Cost;
              if (Parm1.BegDiscount < $0)
                 Parm1.BegDiscount = $0;
              end;

              Parm1.BegBonus = Parm1.Cost - money(Parm1.Amount * 
                                                  GetFaceValue( FD.fininstr.rec.FIID, Parm1.ChangeDate )
                                                 );
              if (Parm1.BegBonus < $0)
                 Parm1.BegBonus = $0;
              end;
           end;

           if (WRTRejectDeal( FD.pmwrtsum.rec.SumID,
                              Parm1.ChangeDate,
                              Parm1.Portfolio,
                              ПолучитьГруппуСписания(Parm1.Portfolio),

                              Parm1.Amount,
                              Parm1.Sum,
                              Parm1.Currency,
                              Parm1.Cost,
                              Parm1.NKDAmount,
                              Parm1.BegDiscount,
                              Parm1.BegBonus,

                              Parm1.ID_Operation, 
                              Parm1.ID_Step

                            ) == false
              )
              msgbox("Ошибка при добавлении лота по несписанной части РЕПО"); 
              return false;
           end;
        end;


   elif( Mode == PM_WRTSUM_UPDTMODE_PARTIAL ) /*Учет ЧП*/
      WrtSum.ChangeDate    = ChangeDate;

   elif( Mode == PM_WRTSUM_UPDTMODE_COUPON ) /*Учет купона*/
      WrtSum.ChangeDate    = ChangeDate;
      if( WrtSum.Portfolio != KINDPORT_BASICDEBT )  // не из ПВО
        WrtSum.NKDAmount        = $0;
        WrtSum.InterestIncome   = $0;
        WrtSum.NotCarryInterest = $0;
      end;
   elif( Mode == PM_WRTSUM_UPDTMODE_EXPENDITURES ) /*Учет затрат*/
      WrtSum.Outlay      = WrtSum.Outlay      + FD.pmwrtsum.rec.Outlay;
      WrtSum.Cost        = WrtSum.Cost        + FD.pmwrtsum.rec.Cost;
      WrtSum.BalanceCost = WrtSum.BalanceCost + FD.pmwrtsum.rec.BalanceCost;
   elif( Mode == PM_WRTSUM_UPDTMODE_CHGAVRNOM ) /*Изменение номинала выпуска ц/б*/
      WrtSum.Amount = Parm1;
   else 
      MsgBox( "Неверно задан режим обновления для макрофункции \"ОбновитьЛот\"." );
      return false;
   end;
   
   stat = DL_UpdatePmWrtSum( Mode, wrtsum );
   Copy( _WrtSum, wrtsum );
   return stat;
END;

MACRO СохранитьСуммуКомиссии( DocKind:INTEGER, DocID:INTEGER, Kind:INTEGER, CommDate:DATE, Sum:MONEY, NDS:MONEY, Currency:INTEGER, Immaterial:BOOL, pMarket:integer, _FIID:integer ):BOOL
  return DL_СохранитьСуммуКомиссии(DocKind, DocID, Kind, CommDate, Sum, NDS, Currency, Immaterial, pMarket, _FIID);
END;

/*только для периодических комиссий, рассчитываемых по завершении торгового дня*/
PRIVATE VAR dlcomis = TRecHandler( "DLCOMIS" );
MACRO SP_SaveComSumFromFinalDay( DocKind:INTEGER, DocID:INTEGER, CONTRACT:INTEGER, COMNUMBER:INTEGER, CommDate:DATE, Sum:MONEY, NDS:MONEY, INPUTMEDIUM:STRING, ReceiverID:INTEGER, FIID_COMM:INTEGER, ErrMsg:@String ):BOOL
  var rRqAcc  = TRecHandler( "dlrqacc.dbt" );
  var rSA  = TRecHandler( "settacc.dbt" );

  var Immaterial = UNSET_CHAR;

  if( (Sum == 0) AND (NDS == 0) )
     return true;
  end;

  if( ReceiverID <= 0 )
     ErrMsg = "В анкете комиссии с номером \""+COMNUMBER+"\" не задан получатель комиссии. Необходимо указать получателя комиссии.";
     return false;
  end;

  rRqAcc.Clear();
  if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(DocKind, DocID, ReceiverID, DLRQ_SUBKIND_CURRENCY, FIID_COMM, DLRQ_TYPE_COMISS, rRqAcc) != 0) //нет подходящих платежных реквизитов
    rSA.Clear();
    if(SP_GetPartySETTACC(ReceiverID, 0, FIID_COMM, FIKIND_CURRENCY, 0, rSA) == 0)
      //создать новые платежные реквизиты
      rRqAcc.rec.ID               = 0;     
      rRqAcc.rec.DocKind          = DocKind;     
      rRqAcc.rec.DocID            = DocID;     
      rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
      rRqAcc.rec.Type             = DLRQ_TYPE_COMISS;     
      rRqAcc.rec.Party            = ReceiverID;     
      rRqAcc.rec.FIID             = rSA.rec.FIID;                 
      rRqAcc.rec.BankID           = rSA.rec.BankID;               
      rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
      rRqAcc.rec.Account          = rSA.rec.Account;         
      rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
      rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
      rRqAcc.rec.BankName         = rSA.rec.BankName;        
      rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
      rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
      rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
      rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
      rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

      if( DL_InsertDLRQACC(rRqAcc) )
        ErrMsg = GetErrMsg();
        ErrMsg = "Ошибка вставки платежных реквизитов для комиссии с номером \""+COMNUMBER+"\" по сделке с ID = "+string(DocID)+": "+ErrMsg;
        return false;
      end;
    else
      ErrMsg = "Не найдена СПИ по деньгам для субъекта с ID = "+ReceiverID;
      return false;
    end;
  end;

  dlcomis.Clear();
  dlcomis.rec.DOCKIND     = DocKind;
  dlcomis.rec.DOCID       = DocID;
  dlcomis.rec.CONTRACT    = CONTRACT;
  dlcomis.rec.FEETYPE     = SF_FEE_TYPE_PERIOD;
  dlcomis.rec.COMNUMBER   = COMNUMBER;
  dlcomis.rec.SUM         = Sum;
  dlcomis.rec.NDS         = NDS;
  dlcomis.rec.DATE        =
  dlcomis.rec.PLANPAYDATE = 
  dlcomis.rec.FACTPAYDATE = CommDate;
  dlcomis.rec.INPUTMEDIUM = INPUTMEDIUM;

  dlcomis.rec.IMMATERIAL  = Immaterial;
              
  if( not OprInsertDLCOMIS( dlcomis ) )
     ErrMsg = GetErrMsg();
  end;

  return true;
END;

/*Процедура изменения сумм требованя/обязательств
Обозначим сумму возврата дохода (или сумму компенсационного взноса) в ВЦ - SV,
сумму требования/обязательства по оплате 2 части сделки до возврата дохода  - STO2old,
сумму требования/обязательства по оплате 2 части сделки после возврата дохода  - STO2new,
Если STO2old>SV, то STO2new= STO2old-SV
Если STO2old<SV, то STO2new= 0, и сумма требования/обязательства по оплате аванса по 2 части уменьшается на величину (SV- STO2old)
*/
macro ИзменитьСуммыТребОбяз( FD2, SV, SV_Currency, Dat:Date )
   var STO2new = $0, STO2old = $0, LastDate = Date(0,0,0), STO2old_Currency;
   var RQID = FD2.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID;

   STO2old = ПолучитьПоследнююСумму(DLDOC_PAYMENT, RQID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate, STO2old_Currency);

   if( (STO2old == $0) and (FD2.ExistAvance()) )
      RQID = FD2.GetRQ(DLRQ_TYPE_AVANCE).rec.ID;
      STO2old = ПолучитьПоследнююСумму(DLDOC_PAYMENT, RQID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate, STO2old_Currency);
   end;

   if( not SmartConvertSum( SV, SV, Dat, SV_Currency, STO2old_Currency, true) )
      return false;
   end;

   if( STO2old > SV )
      if( not СохранитьСуммуКомиссии( DLDOC_PAYMENT, RQID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate, - SV, $0, STO2old_Currency ) )
         msgbox("Ошибка при сохранении суммы по Т/О по оплате");
         return false;
      end;
   else
      STO2new = SV - STO2old;
      SV_Currency = STO2old_Currency;

      if( FD2.ExistAvance() )
         STO2old = ПолучитьПоследнююСумму(DLDOC_PAYMENT, FD2.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate, STO2old_Currency);

         if( not SmartConvertSum( STO2new, STO2new, Dat, SV_Currency, STO2old_Currency, true) )
            return false;
         end;

         if( STO2old != $0 )
            if( not СохранитьСуммуКомиссии( DLDOC_PAYMENT, FD2.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate, - STO2new, $0, STO2old_Currency ) )
               msgbox("Ошибка при сохранении суммы по Т/О по оплате");
               return false;      
            end; 
         end;
      end;
   end;

   return true;
end;

/*Для Т/О по авансу: сумма аванса в ВЦ (из условий ТО), переведенная в ВР по курсу на дату операции*/
macro СуммаАвансаВР(FD, DateExec)
   return FD.GetRQ(DLRQ_TYPE_AVANCE).rec.Amount;
end;

/*Для Т/О по оплате: сумма сделки с НКД в ВЦ за вычетом аванса или оплаченного задатка в ВЦ (из платежа), 
  переведенная в ВР по курсу на дату операции*/
macro СуммаОплатыВР(FD)
   var Sum;

   Sum = FD.dl_leg.rec.TotalCost;
   if (FD.ExistAvance) 
      Sum = Sum - FD.GetRQ(DLRQ_TYPE_AVANCE).rec.Amount;
   elif((FD.ExistDeposit) and (ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_DEPOSIT) )) )
      Sum = Sum - FD.GetRQ(DLRQ_TYPE_DEPOSIT).rec.Amount;
   end;

   return Sum;
end;

/*Для Т/О по поставке: сумма сделки с НКД в ВЦ (TotalCost), переведенная в ВР по курсу на дату операции. 
  Исключение: если оплата выполнена (переоценка Т/О по поставке в дату фактической оплаты) 
  сумма Т/О по поставке определяется как сумма исполненного аванса/задатка в ВР  + сумма исполненной 
  оплаты в ВР (брать нефикс. суммы из платежей) */
macro СуммаПоставкиВР(FD)
   var Sum;

   if( ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_PAYMENT) ) != true) 
      Sum = FD.dl_leg.rec.TotalCost;
   else
      Sum = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.Amount;
      if (FD.ExistAvance)
         Sum = Sum + FD.GetRQ(DLRQ_TYPE_AVANCE).rec.Amount;
      elif(FD.ExistDeposit)
         Sum = Sum + FD.GetRQ(DLRQ_TYPE_DEPOSIT).rec.Amount;
      end;
   end;

   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках из 1 части при выполнении проводок по переоценке НВПИ*/
/*NoErrForEqDate == true, значит не орать ошибку, если за дату DateExec нашли ТО*/
macro ПолучитьУчтеннуюСуммуТОвВР(FD, dat, RQID, DateExec, _str_err, _NoErrForEqDate:bool, _LastDate )
   var Sum = $0, LastDate = Date(0,0,0), str_err = "", S = $0, str_pm_name = "", NoErrForEqDate = false;

   if ((FD.ExistAvance()) and (RQID == FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID))
      S = СуммаАвансаВР(FD);
      str_pm_name = "авансу";
   elif (RQID == FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID)
      S = СуммаОплатыВР(FD);
      str_pm_name = "оплате";
   elif (RQID == FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID)
      S = СуммаПоставкиВР(FD);
      str_pm_name = "поставке";
   else
      str_err = "Неверное ТО по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(4, str_err);
      SetParm(6, LastDate);
      return $0;
   end;

   if( _NoErrForEqDate != null )
      NoErrForEqDate = _NoErrForEqDate;
   end;

   Sum = ПолучитьПоследнююСумму(DLDOC_PAYMENT, RQID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate);

   if( (NoErrForEqDate == true) and (LastDate == dat) )
      SetParm(4, "");
      SetParm(6, LastDate);
      return Sum;
   end;

   if (LastDate >= dat)
      str_err = "Дата последней суммы по ТО по " + str_pm_name + " для сделки с кодом " + 
                 string(FD.tick.rec.DealCode) + 
                 " должна быть меньше даты операции";      

      SetParm(4, str_err);
      SetParm(6, LastDate);
      return $0;
   end;

   if (Sum == $0)
      if( not SmartConvertSum( Sum, S, DateExec, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
         str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());

         SetParm(4, str_err);
         SetParm(6, LastDate);
         return $0;
      end;
   end;
   
   SetParm(4, "");
   SetParm(6, LastDate);
   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках из 1 части при выполнении проводок по переоценке НВПИ*/
macro ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, RQID, _str_err)
   var Sum = $0, str_err = "", str_pm_name = "";

   if ((FD.ExistAvance()) and (RQID == FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID))
      Sum = СуммаАвансаВР(FD);
      str_pm_name = "авансу";
   elif (RQID == FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID)
      Sum = СуммаОплатыВР(FD);
      str_pm_name = "оплате";
   elif (RQID == FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID)
      Sum = СуммаПоставкиВР(FD);
      str_pm_name = "поставке";
   else
      str_err = "Неверное ТО по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(3, str_err);
      return $0;
   end;

   if( not SmartConvertSum( Sum, Sum, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
      str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());
      SetParm(3, str_err);
      return $0;
   end;

   if( not СохранитьСуммуКомиссии( DLDOC_PAYMENT, RQID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, 
                                   dat, Sum, $0, FD.GetPayFIID() ) )
      str_err = "Ошибка при сохранении суммы по Т/О по " + str_pm_name;
      SetParm(3, str_err);
      return $0;
   end; 

   SetParm(3, "");
   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках РЕПО при выполнении проводок по переоценке НВПИ*/
macro ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD, dat, rq, CalcDate, _str_err)
   var Sum = $0, LastDate = Date(0,0,0), str_err = "", S = $0, str_pm_name = "";

   S = rq.rec.Amount;
   if ((FD.ExistAvance()) and (rq.rec.ID == FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID))
      str_pm_name = "авансу";
   elif (rq.rec.ID == FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID)
      str_pm_name = "оплате";
   else
      str_err = "Неверное ТО по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(4, str_err);
      return $0;
   end;

   if(FD.IsBack)
      str_err = str_err + "2ч ";
   end;

   Sum = ПолучитьПоследнююСумму(DLDOC_PAYMENT, rq.rec.ID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, LastDate);

   if (LastDate >= dat)
      str_err = "Дата последней суммы по ТО по " + str_pm_name + " для сделки с кодом " + 
                 string(FD.tick.rec.DealCode) + 
                 " должна быть меньше даты операции";      

      SetParm(4, str_err);
      return $0;
   end;

   if (Sum == $0)
      if( not SmartConvertSum( Sum, S, CalcDate, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
         str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());

         SetParm(4, str_err);
         return $0;
      end;
   end;
   
   SetParm(4, "");
   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках РЕПО при выполнении проводок по переоценке НВПИ*/
macro ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD, dat, rq, _str_err)
   var Sum = $0, str_err = "", str_pm_name = "";

   Sum = rq.rec.Amount;
   if ((FD.ExistAvance()) and (rq.rec.ID == FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID))
      str_pm_name = "авансу";
   elif (rq.rec.ID == FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID)
      str_pm_name = "оплате";
   else
      str_err = "Неверное ТО по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(3, str_err);
      return $0;
   end;

   if(FD.IsBack)
      str_err = str_err + "2ч ";
   end;

   if( not SmartConvertSum( Sum, Sum, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
      str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());
      SetParm(3, str_err);
      return $0;
   end;

   if( not СохранитьСуммуКомиссии( DLDOC_PAYMENT, rq.rec.ID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, 
                                   dat, Sum, $0, FD.GetPayFIID() ) )
      str_err = "Ошибка при сохранении суммы по Т/О по " + str_pm_name;
      SetParm(3, str_err);
      return $0;
   end; 

   SetParm(3, "");
   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках РЕПО при выполнении проводок по переоценке НВПИ*/
macro ПолучитьУчтеннуюСуммуПроцентовПоРЕПО(FD, dat, Kind, _str_err)
   var Sum = $0, LastDate = Date(0,0,0), str_err = "";

   Sum = ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, Kind, LastDate);

   if (LastDate >= dat)
      str_err = "Дата последней суммы процентов (вид суммы " + string(Kind) + ") по сделке с кодом " + 
                 string(FD.tick.rec.DealCode) + 
                 " должна быть меньше даты операции";      

      SetParm(3, str_err);
      return $0;
   end;
   
   SetParm(3, "");
   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках РЕПО при выполнении проводок по переоценке НВПИ*/
macro ПолучитьИСохранитьТекущуюСуммуПроцентовПоРЕПО(FD, dat, Kind, _str_err, Sum_CFI)

   var Sum = $0, str_err = "";

   Sum = Sum_CFI;

   if( not SmartConvertSum( Sum, Sum, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
      str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());
      SetParm(3, str_err);
      return $0;
   end;

   if( not СохранитьСуммуКомиссии( DL_SECURITYDOC, FD.tick.rec.DealID, Kind, 
                                   dat, Sum, $0, FD.GetPayFIID() ) )
      str_err = "Ошибка при сохранении суммы процентов по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(3, str_err);
      return $0;
   end; 

   SetParm(3, "");
   return Sum;
end;

MACRO ОбновитьСтатусЧастиСделки( leg, State:INTEGER ):BOOL
  return DL_ОбновитьСтатусЧастиСделки(leg, State);
END;

MACRO ОбновитьФлагиЧастиСделки( leg:OBJECT, BitMask:INTEGER ):BOOL
   if( not bAND( Leg.rec.BitMask, BitMask ) )
      Leg.rec.BitMask = bOR( Leg.rec.BitMask, BitMask );
      return OprUpdateDL_LEG( leg );
   end;
   return true;
END;

PRIVATE var _dl_leg_back = TRecHandler("dl_leg.dbt"); 

PRIVATE MACRO _UpdateRQ( FD )
   var rq_avdep = TRecHandler("dlrq.dbt");
   var NewSum;

   if(FD.ExistAvance)
     rq_avdep = FD.GetRQ(DLRQ_TYPE_AVANCE);
   elif(FD.ExistDeposit)
     rq_avdep = FD.GetRQ(DLRQ_TYPE_DEPOSIT);
   else
     rq_avdep.Clear();
   end;

   if( IsTwoPart(FD.Group) and FD.IsBack )
      NewSum = FD.dl_leg.rec.TotalCost;
      if( FD.dl_leg.rec.IncomeRate > 0.0 )
         NewSum = NewSum - FD.dl_leg.rec.ReturnIncome;
      elif( FD.dl_leg.rec.IncomeRate < 0.0 )
         NewSum = NewSum + FD.dl_leg.rec.ReturnIncome;
      end;
      NewSum = NewSum - rq_avdep.rec.Amount;
   else
      NewSum = FD.dl_leg.rec.TotalCost - rq_avdep.rec.Amount;
   end;
   if( NewSum != FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.Amount )
      if( NewSum <= $0 )   
         msgbox("Сумма ТО по оплате должна быть больше 0");
         return false;
      end;

      FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.Amount = NewSum;
   end;
   return true;
END;

macro ПереактуализироватьТОПроцентов( FD:SPFirstDoc, ReturnIncome )
   
   if(FD.ExistPC)
     if( ReturnIncome )
        FD.GetRQ(DLRQ_TYPE_INCREPO).rec.Amount = ReturnIncome;
     else
        FD.GetRQ(DLRQ_TYPE_INCREPO).rec.Amount = FD.dl_leg.rec.ReturnIncome;
     end;
   end;

   return 0;
end;

PRIVATE MACRO ИзменитьУсловияСделки( Dat:DATE, FD:SPFirstDoc, FD_back:SPFirstDoc, ChangeRQ:BOOL, ChangeFromCliring:BOOL )

   _dl_leg_back.Clear();
   if( FD_back )
      copy( _dl_leg_back, FD_back.dl_leg );
   end;

   if( ChangeFromCliring == NULL )
      ChangeFromCliring = false;
   end;

   if( OprInsertSPTKCHNG( Dat, IIF( ChangeFromCliring, SPTKCHNG_CHANGE, SPTKCHNG_RECALC), FD.tick, FD.dl_leg, _dl_leg_back ) == false )
      msgbox("Ошибка изменения условий сделки ");
      return false;
   end;

   if( ChangeRQ == true )
      if( _UpdateRQ( FD ) == false )
         return false;
      end;
      if( FD_back )
         if( _UpdateRQ( FD_back ) == false )
            return false;
         end;
         if( (ChangeFromCliring) and (FD_Back.dl_leg.rec.ReturnIncome != 0) and 
             (ПереактуализироватьТОПроцентов(FD_Back,FD_Back.dl_leg.rec.ReturnIncome) != 0) )
            return false;
         end;
      end;      
   end;
   return true;
END;

/* Изменить dl_leg и в случае изменения TotalCost платеж контрактива по сделке
   dl_leg, dl_leg_back - структуры с уже измененными значениями
   Если dl_leg_back == null, то при необходимости пересчитает суммы в dl_leg_back по dl_leg */
MACRO СохранитьИзмененияПоСделке( Dat, FD:SPFirstDoc, dl_leg:VARIANT, dl_leg_back:VARIANT, ChangeRQ:BOOL, ChangeAnotherPart:BOOL, ChangeFromCliring:BOOL )
   record NewDl_legBack( dl_leg ); /*по другой (относительно FD) части*/
   var FD1 = null, FD2 = null;

   if( ChangeRQ == null )
      ChangeRQ = true; /*по умолчанию изменяем и ТО*/
   end;

   if( ChangeAnotherPart == null )
      ChangeAnotherPart = true;
   end;

   if( not FD.IsBack )

      FD1 =  FD;
      if( dl_leg != null )
         copy( FD1.dl_leg, dl_leg );
      end;

      if( FD.ExistBack == true )
         FD2 = SPFirstDoc( FD.tick, true );
      end;

      if( (FD.ExistBack == true) AND (ChangeAnotherPart == true) AND IsTwoPart( FD.Group ) )

         if( dl_leg_back == null )
            /*пересчитаем суммы и цену второй части сделки по первой*/
            copy( NewDl_legBack, FD2.dl_leg );
            SP_CalcForREPO( FD1.dl_leg, NewDl_legBack, FD1.GetRQ(DLRQ_TYPE_DELIVERY).rec.PlanDate, FD2.GetRQ(DLRQ_TYPE_DELIVERY).rec.PlanDate );
         else
            copy(NewDl_legBack, dl_leg_back);
         end;

         copy( FD2.dl_leg, NewDl_legBack );        
      end;

      if( not ИзменитьУсловияСделки( Dat, FD1, FD2, ChangeRQ, ChangeFromCliring) )
         return false;
      end;


   else

      FD2 = FD;

      if( dl_leg_back != null )
         copy( FD2.dl_leg, dl_leg_back );      
      end;

      FD1   = SPFirstDoc( FD.tick, false );

      if( (ChangeAnotherPart == true) AND (dl_leg != null) AND IsTwoPart( FD.Group ) ) 
         copy( FD1.dl_leg, dl_leg );      
      end;

      /*обновим первую часть сделки, если она задана (в этом случае обновится только ставка)*/
      if( not ИзменитьУсловияСделки( Dat, FD1, FD2, ChangeRQ, ChangeFromCliring) )
         return false;
      end;
   end;

   return true;
END;

/*Нужно для информации об ошибках при выполнении проводок в сервисных операциях*/
PRIVATE VAR CarryError = "";
MACRO SC_GetCarryError()
   return CarryError;
END;

// FD передается тот, по которому открыт счет на 10603 или 10605
// Для дистрибутива счет на 10603 или 10605 пока всегда открывается по FD переданному в ПроводкаПоКатегориямУчета
MACRO SC_GetOFRRecID( FD, AccountPayer, AccountReceiver, FIRolePayer, FIRoleReceiver, ДатаВалютирования ):integer
  var RetVal:integer = 0;
  var DebBalance:bool = false, CredBalance:bool = false;
  var FIRole:integer;

  if( SC_SymbolOFRInCarry() and (FD != NULL) )

     if( (AccountPayer.Balance == "10603") or (AccountPayer.Balance == "10605") )
        DebBalance = true;
        FIRole = FD.GetBasisFIRole(FIRolePayer);
     end;

     if( (AccountReceiver.Balance == "10603") or (AccountReceiver.Balance == "10605") )
        CredBalance = true;
        FIRole = FD.GetBasisFIRole(FIRoleReceiver);
     end;

     if( ((DebBalance == true) and (CredBalance == false)) or
         ((DebBalance == false) and (CredBalance == true))
       )
        var ВидБумаги:integer = MC_GetParametrTemplate(FD, OBJTYPE_KINDCB, LLCLASS_KINDCB_INVESTMENT, ДатаВалютирования, FIRole);
        var ВидЭмитента:integer;

        if( ВидБумаги == 102 ) /*Долевая ц/б*/
           ВидЭмитента = MC_GetParametrTemplate(FD, OBJTYPE_KINDSUBJ, LLCLASS_KINDSUBJ_SHARE_ISSUER_DR, ДатаВалютирования, FIRole);
        else /* == 3 Долговое обязательство*/
           ВидЭмитента = MC_GetParametrTemplate(FD, OBJTYPE_KINDSUBJ, LLCLASS_KINDSUBJ_ISSUER_DR, ДатаВалютирования, FIRole);
        end;

        var СимволОФР:string = "";
        if( ((AccountPayer.Balance == "50220") or (AccountPayer.Balance == "50221") or (AccountPayer.Balance == "50720") or (AccountPayer.Balance == "50721")) and
            ((AccountReceiver.Balance == "10603") or (AccountReceiver.Balance == "10605"))
          )
           if( ВидБумаги == 3 ) /* Долговое обязательство*/
              СимволОФР = "71102";
           else /* == 102 Долевая ц/б */
                 СимволОФР = "71101";
           end;
        elif( ((AccountPayer.Balance == "10603") or (AccountPayer.Balance == "10605")) and
              ((AccountReceiver.Balance == "50220") or (AccountReceiver.Balance == "50221") or (AccountReceiver.Balance == "50720") or (AccountReceiver.Balance == "50721"))
            )
           if( ВидБумаги == 3 ) /* Долговое обязательство*/
              СимволОФР = "72102";
           else /* == 102 Долевая ц/б */
                 СимволОФР = "72101";
           end;
        elif( ((AccountPayer.Balance == "70606") or (AccountPayer.Balance == "10901"))and
              ((AccountReceiver.Balance == "10603") or (AccountReceiver.Balance == "10605"))
            )
           if( ВидБумаги == 3 ) /* Долговое обязательство*/
              СимволОФР = "71301";
           else /* == 102 Долевая ц/б */
                 СимволОФР = "71201";
           end;
        elif( ((AccountPayer.Balance == "10603") or (AccountPayer.Balance == "10605")) and
              ((AccountReceiver.Balance == "70601") or (AccountReceiver.Balance == "10801"))
            )
           if( ВидБумаги == 3 ) /* Долговое обязательство*/
              СимволОФР = "72301";
           else /* == 102 Долевая ц/б */
                 СимволОФР = "72201";
           end;
        end;

        if( СимволОФР != "" )
           var cmd = RSDCommand( " SELECT T_RECID " +
                                 "   FROM DOPUSYMB_DBT " +
                                 "  WHERE T_CODE = ? " +
                                 "    AND T_OPENDATE <= ? " +
                                 "    AND (T_CLOSEDATE >= ? OR T_CLOSEDATE = TO_DATE('01.01.0001','DD.MM.YYYY')) " );
           cmd.NullConversion = true;
           cmd.addParam("", RSDBP_IN, СимволОФР);
           cmd.addParam("", RSDBP_IN, ДатаВалютирования);
           cmd.addParam("", RSDBP_IN, ДатаВалютирования);
           var rs = TRsbDataSet(cmd);
           if( rs.movenext )
              RetVal = SQL_ConvTypeInteger(rs.RecID);
           end;
        end;
     end;
  end;

  return RetVal;
END;

/* Проводка по категориям учета (в том числе и мультивалютная)
   СчетДебет,СчетКредит - если тип V_STRING то категории, иначе record ACCOUNT*/
MACRO ПроводкаПоКатегориямУчета( FD, СчетДебет, СчетКредит, ДатаВалютирования,
                                 Chapter ,FIID, СуммаОперации, docum,
                                 Result_Carry, Kind_Oper,Numb_Document,Ground,
                                 PaymentID, FIRolePayer, FIRoleReceiver,
                                 СчетДебетFIID, СчетКредитFIID, FIID2, СуммаОперации2,
                                 PaymID_type, 
                                 IsSummaryCarry, /*Признак сводной проводки*/
                                 IsInnerCarry,   /*Признак провордки по ВУ*/
                                 ВидРО, PmObj, DebAccNumber:@string, CredAccNumber:@string, NatSum:@money,
                                 DebPairAcc, CredPairAcc, 
                                 SumEquivalentCarry )
   var stat:bool = true, CуммаДебет = $0, СуммаКредит  = $0, 
      СчетОВПДебет = "", СчетОВПКредит = "", СчетДоходов = "", СчетРасходов = "";

   var tr, NoCarry:bool = false;
   var PaymentObj = null;

   record AccountPayer(account);
   record AccountReceiver(account);

   macro SFContr_Is_Serv(p_cntr, p_srv_kd, p_srv_sb)
      var sqls, rsdc;
      sqls = 
      "DECLARE\n" +
      "   v_Cntr   Dsfcontr_Dbt.t_Id%TYPE := :p_Cntr;\n" + 
      "   v_Srv_Kd Dsfcontr_Dbt.t_Servkind%TYPE := :p_Srv_Kd;\n" + 
      "   v_Srv_Sb Dsfcontr_Dbt.t_Servkindsub%TYPE := :p_Srv_Sb;\n" + 
      "BEGIN\n" + 
      "   SELECT COUNT(1)\n" + 
      "     INTO :p_Res\n" + 
      "     FROM Dsfcontr_Dbt s\n" + 
      "    WHERE s.t_Id = v_Cntr\n" + 
      "      AND s.t_Servkind = v_Srv_Kd\n" + 
      "      AND (Nvl(v_Srv_Sb, 0) = 0 OR s.t_Servkindsub = v_Srv_Sb);\n" + 
      "END;";
      rsdc = rsdcommand(sqls);
      if ((p_cntr == null) or (p_cntr == nullval))
         p_cntr = "";
      end;
      if ((p_srv_kd == null) or (p_srv_kd == nullval))
         p_srv_kd = "";
      end;
      if ((p_srv_sb == null) or (p_srv_sb == nullval))
         p_srv_sb = "";
      end;
      rsdc.AddParam("p_Cntr", RSDBP_IN, p_cntr);
      rsdc.AddParam("p_Srv_Kd", RSDBP_IN, p_Srv_Kd);
      rsdc.AddParam("p_Srv_Sb", RSDBP_IN, p_Srv_Sb);
      rsdc.AddParam("p_Res", RSDBP_OUT, v_integer);
      rsdc.Execute;
      sqls = int(rsdc.Value("p_res"));
      rsdc = null;
      return sqls > 0;
   end;
   
   if ( FD != NULL )
    if(FD.kind !=159)    /*CHVA*/
      if ((Numb_Document == "") AND (GenPropID(FD,"tick") != -1) AND (FD.tick != NULL))
        Numb_Document = FD.tick.rec.DealCode;
      end;
    end;
   end;

   CarryError = "";
   macro SayCarryError( error )
     if( isOprMultiExec() == false )
        msgbox( error );
     else
        CarryError = error;
     end;
     return false;
   end;

   if( IsSummaryCarry == null )
     IsSummaryCarry = false;
   end;

   if( (СуммаОперации == null) AND (СуммаОперации2 == null) )  
     return SayCarryError( "В проводке не задана ни одна из сумм." );
   end;
     
   /*оставить только копейки для первой суммы, если она задана*/
   if( СуммаОперации != null )
     if( Chapter != 5 ) /*количество ц/б может быть дробным*/
        СуммаОперации = money( round( СуммаОперации, 2 ) );    
     end;
     if( СуммаОперации < $0 )  
        return SayCarryError( "Сумма проводки < 0." );
     end;
   else  
    СуммаОперации = $0;
   end;
   /*для второй суммы, если она задана*/
   if( СуммаОперации2 != null )
     if( Chapter != 5 ) /*количество ц/б может быть дробным*/
        СуммаОперации2 = money( round( СуммаОперации2, 2 ) );
     end;
     if( СуммаОперации2 < $0 )  
        return SayCarryError( "Вторая сумма проводки < 0." );
     end;
   else
    СуммаОперации2 = $0;
   end;

   if( (СуммаОперации == $0) AND (СуммаОперации2 == $0) )  
     return true;
   end;

   if( ValType(СчетДебет) == V_STRING ) /*задан через категорию*/
     if( (not FD.IsExistAccount( СчетДебет, null, true, FIRolePayer, AccountPayer, null, ДатаВалютирования, СчетДебетFIID)) and
         (not FD.OpenAccount( СчетДебет, null, true, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, null, DebPairAcc)) )
         if( not FD.ReOpenAccount( СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, DebPairAcc) )
             return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
         end;
     end;
   else
     copy( AccountPayer, СчетДебет );
   end;

   if( ValType(СчетКредит) == V_STRING ) /*задан через категорию*/
     if( (not FD.IsExistAccount( СчетКредит, null, true, FIRoleReceiver, AccountReceiver, null, ДатаВалютирования, СчетКредитFIID)) and
         (not FD.OpenAccount( СчетКредит, null, true, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, null, CredPairAcc)) )
         if( not FD.ReOpenAccount(СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, CredPairAcc) )
            return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
         end;
     end;
   else
     copy( AccountReceiver, СчетКредит );
   end;

   if( PaymID_type == null )
     PaymID_type = PMMET_ID;
   end;

   if( AccountPayer.Code_Currency == AccountReceiver.Code_Currency)

     /*задана только вторая сумма в валюте одного из счетов*/
     if( (FIID == null) AND (FIID2 != null) )
        FIID = FIID2;
     elif( (FIID == null) AND (FIID2 == null) )
        return SayCarryError("Не задана ни одна из валют проводки.");
     end;

     if( (FIID != AccountPayer.Code_Currency) AND
         (FIID != AccountReceiver.Code_Currency) )
        return SayCarryError( "В проводке не совпадают валюты счетов: " 
                               + string(AccountPayer.Code_Currency) + " " + string( AccountReceiver.Code_Currency ) +
                              "| и валюта документа: " + string(FIID) );
     end;

     if( СуммаОперации != $0 )
        CуммаДебет = СуммаКредит = СуммаОперации;
     elif( СуммаОперации2 != $0 )
        CуммаДебет = СуммаКредит = СуммаОперации2;
     end;
     
     if( (IsSummaryCarry == false) AND 
         НужнаСводнаяПроводка( FD, СчетДебет, СчетКредит, Chapter )
       )
        stat = ДобавитьСводнуюПроводку( FD, AccountPayer, AccountReceiver, ДатаВалютирования, CуммаДебет, $0, Result_Carry, Ground );
        if( not stat ) 
           return SayCarryError("Ошибка при вставке документа сводной проводки.");
        else
               NoCarry = true; /*сформировали сводную проводку - ниже выполнять проводку не надо*/
           end;
     end;

   else /* валюты разные - мультивалютная проводка */
      
     СуммаКредит = $0;
     CуммаДебет  = $0;
     
     /*задана одна сумма в валюте одного из счетов*/
     if( (FIID != null) AND (FIID2 == null) )
        if( FIID == AccountPayer.Code_Currency )
           CуммаДебет  = СуммаОперации;
        else
           СуммаКредит = СуммаОперации;
        end;
     /*задана только вторая сумма в валюте одного из счетов*/
     elif( (FIID2 != null) AND (FIID == null) )
        if( FIID2 == AccountPayer.Code_Currency )
           CуммаДебет  = СуммаОперации2;
        else
           СуммаКредит = СуммаОперации2;
        end;
     /*заданы обе суммы в валютах счетов по которым выполняем проводку*/
     elif( (FIID2 != null) AND (FIID != null) )                         
       if( FIID == AccountPayer.Code_Currency ) 
          CуммаДебет  = СуммаОперации;
       elif( FIID2 == AccountPayer.Code_Currency ) 
          CуммаДебет  = СуммаОперации2;
       end;

       if( FIID == AccountReceiver.Code_Currency ) 
          СуммаКредит = СуммаОперации;
       elif( FIID2 == AccountReceiver.Code_Currency ) 
          СуммаКредит = СуммаОперации2;
       end;
     else
        return SayCarryError("Не задана ни одна из валют проводки.");
     end;

     if( not CheckMultyCarrySum( AccountPayer.Code_Currency, AccountReceiver.Code_Currency,
                                 CуммаДебет, СуммаКредит, ДатаВалютирования ) )
        return SayCarryError("Ошибка при определении сумм мультивалютной проводки.");
     end;

     if( (IsSummaryCarry == false) AND 
         НужнаСводнаяПроводка( FD, СчетДебет, СчетКредит, Chapter )
       )
        stat = ДобавитьСводнуюПроводку( FD, AccountPayer, AccountReceiver, ДатаВалютирования, CуммаДебет, СуммаКредит, Result_Carry, Ground );
        if( not stat ) 
           return SayCarryError("Ошибка при вставке документа сводной проводки.");
        else
              NoCarry = true; /*сформировали сводную проводку - ниже выполнять проводку не надо*/
           end;
        end;
     end;

   //NoCarry = true;
   if( NoCarry == false )
      /* ------ Выполнить проводку ----------------------------------------------*/
      if( PmObj OR ((PaymID_type != PMMET_ID_TMP_OP) AND ((PaymentID != NULL) AND (PaymentID > 0))) )
           /*проводку формируем по платежу*/
         if (PmObj)
            PaymentObj = PmObj;
         else
            PaymentObj = RSBPayment( PaymentID );
         end;

         tr = PaymentObj.MakeTransaction();
      else
         /*проводку формируем без платежа*/
         tr = RsbAccTransaction();
      end;
      if( tr == NULL )
         return SayCarryError("Ошибка при создании проводки");
      end;

      tr.Chapter         = Chapter;
      tr.Date_Carry      = ДатаВалютирования;
      if( PaymentObj != null )
         tr.Number_Pack  = PaymentObj.NumberPack;
      end;
/*
  if((FD.Kind == DL_SECUROWN) or (FD.Kind == DL_AVRWRTOWN)  or  (FD.Kind == DL_RETIREMENT_OWN))
    Tr.Number_Pack  = 20/*СЭБ*/;
  else
    Tr.Number_Pack  = 10/*БОЦБ*/;
  end;
*/
      Tr.Number_Pack  = 10/*БОЦБ*/;

//IMPORT "role_model.mac";//ролевая модель
/*DAN.Ролевая модель Определяем конечного операциониста для проводки */
      if (FD != NULL)
        var retvalGetMO = GetMainOperInGroup(FD.Kind);
        if (retvalGetMO > 0)
	        Tr.Oper = retvalGetMO;
        else
           Tr.Oper = {Oper};
        end;
      end;
/*DAN*/

                        
      if (index(Ground,"писание оценочного резерва") > 0)
          Tr.Number_Pack  = 125/*Восстановление резервов*/;
      end;
      /*
      if ((FD.Kind != NULL) AND (FD.KindReserv != NULL) AND (FD.Kind == 5))
         Tr.Number_Pack  = 120/* ВР. Резерв */;
      end;*/
      
      /*BPV проводки по списаниям/зачислениям дс*/
      if (FD != NULL)
        if (genclassname(FD) == "DLFIRSTDOCNPTXOP")
          //Chesnokov D.S. 514737 - отключил USERFIELD2 = 1 для выгрузки в Бисквит
          //запрет на выгрузку был отключён, потому что не выгружались проводки с комиссией. Сейчас комиссий нет, запрет включается обратно
          if((FD.nptxop.rec.DocKind == DL_WRTMONEY) and (FD.nptxop.rec.SubKind_Operation == DL_NPTXOP_WRTKIND_ENROL))
            tr.UserField2 = "1";
          end;
          Tr.Number_Pack  = 11;
          if (SFContr_Is_Serv(Fd.Nptxop.rec.Contract, 21, 8))
            Tr.Number_Pack  = 90;
          end;
        end;
      end;

      tr.Numb_Document   = Numb_Document;
      tr.ResultCarry     = 1;
      tr.Kind_Oper       = Kind_Oper;
      tr.Ground          = Ground;
      tr.Department      = {OperDprt};
     // tr.Oper            = {oper};
      tr.FIIDPayer       = AccountPayer.Code_Currency;
      tr.FIIDReceiver    = AccountReceiver.Code_Currency;
      tr.SumPayer        = CуммаДебет;
      tr.SumReceiver     = СуммаКредит;
      tr.AccountPayer    = AccountPayer.Account;
      tr.AccountReceiver = AccountReceiver.Account;
      tr.Shifr_Oper      = DL_GetShifrOper(Chapter, AccountPayer, AccountReceiver);
      tr.AddOFRSymbol(SC_GetOFRRecID(FD, AccountPayer, AccountReceiver, FIRolePayer, FIRoleReceiver, ДатаВалютирования));

      if(SumEquivalentCarry != null)
        tr.SumEquivalentCarry = SumEquivalentCarry;
      end;

      if( not tr.Carry() )
         return SayCarryError("Ошибка при выполнении проводки");
      end;

      /*-------------------------------------------------------------------------*/  
      if( DebAccNumber != null )
         DebAccNumber = tr.AccountPayer;
      end;

      if( CredAccNumber != null )
         CredAccNumber = tr.AccountReceiver;
      end;

      if( NatSum != null )
         if( tr.FIIDPayer == NATCUR )
            NatSum = tr.SumPayer;
         elif( tr.FIIDReceiver == NATCUR )
            NatSum = tr.SumReceiver;
         else
            NatSum = $0.0;
         end;
      end;

   end;

   if( not stat ) 
      return SayCarryError("Ошибка при вставке документа проводки.");
   end;

   return stat;
END;

MACRO ПроставитьСтатусНаПлатеж( paym, PaymStatus, PaymID_type, NotFactPaym, _PmObj, _IsNoSetNetting:bool )
  var pmobj, IsNoSetNetting = false;                          

  if( (PaymStatus == PM_FINISHED) AND (paym.PaymStatus == PM_CLOSED_W_M_MOVEMENT) ) 
     return true; /*PM_FINISHED поверх PM_CLOSED_W_M_MOVEMENT не ставим (SCR 63093)*/
  end; 

  if (_PmObj)
     pmobj = _PmObj;
  else
     pmobj = RsbPayment( paym.PaymentID );
  end;

  if( ValType(_IsNoSetNetting) == V_BOOL )
     IsNoSetNetting = _IsNoSetNetting;
  end;
  /*проставим признак участия в неттинге*/
  /* SetNettingForPaym немного не подходит из-за .rec */
  if(СтатусПлатежаИсполнен(PaymStatus) AND (not IsNoSetNetting) )
     pmobj.Netting = SET_CHAR;
  end;

  if( paym.PaymStatus != PaymStatus ) 

     /*класс платежа пока работает только с платежами в постоянных базах*/
     if( _PmObj or ((PaymID_type == null) OR (PaymID_type == PMMET_ID) OR (PaymID_type == 0)) )
        pmobj.PaymStatus = PaymStatus;
        if( ( PaymStatus == PM_READY_TO_SEND ) AND (not NotFactPaym) )
           pmobj.IsFactPaym = "X";
        end;
     else
        if( not InsertPaymentStat( paym.PaymentID, PaymStatus, PaymID_type) )
           msgbox( "Ошибка при изменении статуса платежа" );
           return false;
        end;
     end;
  end;   
  return true;
END;

MACRO ОбработатьЛот( FD, pmwrtsum, dat, CommStatus )
/*
  if( (CommStatus != null) AND (CommStatus != 0) ) 
     pmwrtsum.BitMask = bOR( pmwrtsum.BitMask, CommStatus ); 
  end; 
*/ 
  if(( pmwrtsum.rec.State == PM_WRTSUM_NOTFORM ) or ( pmwrtsum.rec.State == PM_WRTSUM_SALE_BPP )) 
     if( not ОбновитьЛот( pmwrtsum, PM_WRTSUM_UPDTMODE_DELIVERY, dat, FD ) )
        return false;
     end;                   
  end; 

  return true; 
END;

/*Получить даты переноса по срокам.
  OprDate   - Дата вполнения шага (актуализации счетов "Форвард"). 
              Для первой части (или сделок без обр. части) - дата сделки, для второй - дата учета 
              первой части, либо дата изменения условий сделки, если она больше
  DateBeginPlus - Базовая дата требований (параметр MC_TYPE_PARAMETR_FINDATE для роли FIROLE_FIREQ)
  DateBeginMinus- Базовая дата обязательств (параметр MC_TYPE_PARAMETR_FINDATE для роли FIROLE_FICOM)*/
PRIVATE MACRO GetTransferDates( FD:VARIANT, DateBegin:DATE, КатУчетаТреб:STRING, КатУчетаОбяз:STRING, OprDate:@DATE, DateBeginPlus:@DATE, DateBeginMinus:@DATE )
   if( DateBegin == null )
      if( FD.IsBack == true ) 
        GetOprDate( DATE_DEALOUTBAL_2, OprDate );
      else
        GetOprDate( DATE_DEALDATE, OprDate );
      end;
      /*если дата изменения условий сделки больше, берем ее*/ 
      if( FD.tick.rec.ChangeDate > OprDate ) 
         OprDate = FD.tick.rec.ChangeDate;
      end;  
   else
      OprDate = DateBegin;
   end;

   DateBeginPlus  = FD.GetParametr(MC_TYPE_PARAMETR_FINDATE, OprDate, КатУчетаТреб, FD.GetBasisFiRole(FIROLE_FIREQ));
   DateBeginMinus = FD.GetParametr(MC_TYPE_PARAMETR_FINDATE, OprDate, КатУчетаОбяз, FD.GetBasisFiRole(FIROLE_FICOM));
END;

private macro FindPeriod( ID, FindPrevPeriod )
  file Period( mcperiod ) key 0;
  file PrevPeriod( mcperiod ) key 3;

  ClearRecord( Period );
  Period.ID = ID;
  if( GetEQ( Period ) )     
     copy( PrevPeriod, Period );
     PrevPeriod.Number = PrevPeriod.Number - 1;
     if( GetEQ(PrevPeriod) )
        Copy( FindPrevPeriod, PrevPeriod );
        return 0;
     end;
     /*Copy( FindPeriod, Period );*/
  end; 
  return 8400; 
end;

/* OprDate   - Дата вполнения шага (актуализации счетов "Форвард"). 
               Для первой части (или сделок без обр. части) - дата сделки, для второй - дата учета 
               первой части, либо дата изменения условий сделки, если она больше
   DateBegin - Базовая дата (параметр MC_TYPE_PARAMETR_FINDATE для роли FIROLE_FIREQ/FIROLE_FICOM)*/ 
PRIVATE MACRO НужноПереноситьПоСрокам( FD, Account, OprDate, DateBegin, DocID, FIID, FIRole, ActivateDate, ActionDate, pid  )
  record Period(mcperiod);
  var    stat, NeedTransf = false;

  ActionDate = ActivateDate = Date( 0, 0, 0 );

  if( pid ) 
     stat = FindPeriod( pid, Period );
  else 
     stat = MC_GetPeriodForCurrAcc( Account, FD.Kind, DocID, FD.GetBasisFIRole(FIRole), FIID, MC_PERIOD_PREV, false, Period);
  end; 

  if( stat == 0 )
     ActionDate   = GetTransferActionDate( Period, OprDate, DateBegin );
     ActivateDate = GetTransferActivateDate( Period, ActionDate );

     if( ActivateDate == Date( 0, 0, 0 ) ) /*Перенос по срокам не нужен*/ 
        if( ActivateDate > FD.DateArray[DATE_DEALBEGINEXEC] ) /*запрос 61288 */
           NeedTransf = true;
        end;
     else
        NeedTransf = true;
     end;
  elif (stat == 8400)
     stat = 0;
  end;

  SetParm( 7, ActivateDate );
  SetParm( 8, ActionDate );
  SetParm( 9, stat );
  return NeedTransf;
END;

/* Определить какой шаг нужно выполнять после шага "Вести внебал. учет ?" 
   для операций покупки/продажи 
   StepIfNo     - шаг выполняемый если НЕ вести внеб. учет
   StepIfYes    - шаг выполняемый если вести внеб. учет
   DateTransfer - дата переноса по срокам*/
MACRO ОпределитьШагВнебалансовогоУчета( FD, StepIfNo, StepIfYes )
  var dat;
  if( FD.IsBack ) /*во второй части*/
     dat = FD.DateArray[DATE_DEALOUTBAL_2];
     if( dat > {curdate} )
       MsgBox ("Преждевременное выполнение шага запрещено.");
       return 1;
     end;
  end;

  if( FD.ВедетсяВнебалУчетПоСделке() AND (not FD.БылоДосрочноеИсполнение()) ) 

     if( FD.IsBack ) /*во второй части*/
        if( (dat < {curdate}) AND (isOprMultiExec() == false) )
           if( GetTrue( true, "Выполнить постановку второй части сделки на внебаланс архивной датой?" ) == false )  
              return 1;
           end;  
        end; 
     end;
     return StepIfYes; /*Постановка на внебаланс*/
  else 

     if( FD.IsBack AND FD.БылоДосрочноеИсполнение() ) /*во второй части*/
        if( (dat < {curdate}) AND (isOprMultiExec() == false) )
           if( GetTrue( true, "Выполнить постановку второй части сделки на баланс архивной датой?" ) == false )  
              return 1;
           end;  
        end; 
     end;
     return StepIfNo; /*Не вести внебалансовый учет*/
  end;

end;

/* Определить какой шаг нужно выполнять после шага "Переносить по срокам ?" 
   для операций покупки/продажи 
   StepIfNoTrans - шаг выполняемый если не переносить
   StepIfTrans   - шаг выполняемый если переносить */
MACRO ОпределитьШагПереносаПоСрокам( FD, StepIfNoTrans, StepIfTrans, CheckRQ, _DateBegin, acc1, acc2, pid_plus, pid_minus, OtherRQ )
  var DateBegin, DateBeginMinus, DateBeginPlus, TransfDateMinus, 
      TransfDatePlus, TransfDate:date = date(0,0,0), ТОТреб, ТООбязат;
  var КатУчетаТреб = "+Форвард, дрейф", 
      КатУчетаОбяз = "-Форвард, дрейф";
  var Поставка, Оплата;

  if( ((FD.ВидСрочностиСделки() == СделкаПрочая) AND (FD.IsBack != true)) OR
      IsClientDeal(FD.tick.rec) OR
      (FD.БылоДосрочноеИсполнение())
    ) 
     return StepIfNoTrans; /*не переносить по срокам*/
  end;
  
  GetTransferDates( FD, _DateBegin, КатУчетаТреб, КатУчетаОбяз, @DateBegin, @DateBeginPlus, @DateBeginMinus );

  if( (acc1 != null) AND (acc2 != null) ) 
     copy( СчетУчетаТреб, acc1 );  
     copy( СчетУчетаОбяз, acc2 );  
  else 
     if( (not FD.IsExistAccount( КатУчетаТреб, null, true, FIROLE_FIREQ, СчетУчетаТреб, null, DateBegin)) OR
         (not FD.IsExistAccount( КатУчетаОбяз, null, true, FIROLE_FICOM, СчетУчетаОбяз, null, DateBegin))
     ) 
        return StepIfNoTrans; /*не переносить по срокам*/
     end;
  end;

  /*  это вызвается циклически на шаге определения необходимости переноса*/
  /*  если хотя бы у одного из счетов настала дата переноса (то есть перенос не требуется) */
  /*  то перенос более не выполняем, иначе планируем очередной шаг переноса                */
  if( CheckRQ == null )
     if( FD.BuySale == DEAL_TYPE_SALE ) 
        ТООбязат = FD.GetRQ(DLRQ_TYPE_DELIVERY);
        ТОТреб   = FD.GetRQ(DLRQ_TYPE_PAYMENT);
     else
        ТООбязат = FD.GetRQ(DLRQ_TYPE_PAYMENT);
        ТОТреб   = FD.GetRQ(DLRQ_TYPE_DELIVERY);
     end;

     if( (ТОТреб.rec.State != DLRQ_STATE_DELAYED) AND
         (not НужноПереноситьПоСрокам( FD, КатУчетаТреб, DateBegin, DateBeginPlus, FD.ID, СчетУчетаТреб.Code_Currency, FIROLE_FIREQ, TransfDatePlus, null, pid_plus ) )
       )
        return StepIfNoTrans; /*не переносить больше*/
     end;

     if( (ТООбязат.rec.State != DLRQ_STATE_DELAYED) AND
         (not НужноПереноситьПоСрокам( FD, КатУчетаОбяз, DateBegin, DateBeginMinus, FD.ID, СчетУчетаОбяз.Code_Currency, FIROLE_FICOM, TransfDateMinus, null, pid_minus ) )
       )
        return StepIfNoTrans; /*не переносить больше*/
     end;

     if( not FD.БылоОтложенноеИсполнение() )
        TransfDate = minDate( TransfDatePlus, TransfDateMinus );
     elif( (ТООбязат.rec.State != DLRQ_STATE_DELAYED ) OR
           (ТОТреб.rec.State != DLRQ_STATE_DELAYED )
         )
        if( ТООбязат.rec.State != DLRQ_STATE_DELAYED )
           TransfDate = TransfDateMinus;
        elif( ТОТреб.rec.State != DLRQ_STATE_DELAYED )
           TransfDate = TransfDatePlus;
        end;
     else
        TransfDate = FD.DateArray[DATE_DEALBEGINEXEC];
     end;

     if( TransfDate > FD.DateArray[DATE_DEALBEGINEXEC] )
        return StepIfNoTrans; /*не переносить больше. См. 91717*/
     end;

//  else /*эта ветка работает в операции "Расчеты по сделке" на шаге "Переносить поставку по срокам ?"*/
// Эта ветка больше не работает - см. 182087
/*
     Поставка = (CheckRQ.rec.Type == DLRQ_TYPE_DELIVERY);
     Оплата   = (CheckRQ.rec.Type == DLRQ_TYPE_PAYMENT);

     if( ( (FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.State == DLRQ_STATE_DELAYED ) AND
           (FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.State == DLRQ_STATE_DELAYED )
         ) OR
         ( (OtherRQ.rec.State != DLRQ_STATE_DELAYED) AND
           /*Обязательство - покупка и оплата или продажа и поставка */
           ( ( ( ( (FD.BuySale == DEAL_TYPE_BUY) AND
                   (Оплата == true)
                 ) OR
                 ( (FD.BuySale == DEAL_TYPE_SALE) AND
                   (Поставка == true)
                 )
               ) AND
               (not НужноПереноситьПоСрокам( FD, КатУчетаОбяз, DateBegin, DateBeginMinus, FD.ID, СчетУчетаОбяз.Code_Currency, FIROLE_FICOM, TransfDate, null, pid_minus ))
             ) OR
           /*Требование - продажа и оплата или покупка и поставка */
             ( ( ( (FD.BuySale != DEAL_TYPE_BUY) AND
                   (Оплата == true)
                 ) OR
                 ( (FD.BuySale != DEAL_TYPE_SALE) AND
                   (Поставка == true)
                 )
               ) AND
               (not НужноПереноситьПоСрокам( FD, КатУчетаТреб, DateBegin, DateBeginPlus, FD.ID, СчетУчетаТреб.Code_Currency, FIROLE_FIREQ, TransfDate, null, pid_plus ))
             )
           )
         )
       )
        return StepIfNoTrans; /*не переносить больше*/
     end;
*/
  end;

  FD.DateArray[DATE_DEALTRANSFER] = TransfDate;
  DefineOprDate( FD.GetKindDate(DATE_DEALTRANSFER), FD.DateArray[DATE_DEALTRANSFER] );
  return StepIfTrans; /*Переносить по срокам*/
END;

/* Проводки переноса требований и обязательств по срокам (для операций покупки/продажи)*/
MACRO ПеренестиПоСрокам( FD, Dat, Doc, NoErr, _СчетУчетаТребНов, _СчетУчетаОбязНов, _КатУчетаТреб, _КатУчетаОбяз  )

  var     ActionDate, TransfDateMinus, TransfDatePlus, Period, DateBeginPlus, DateBeginMinus, DateBegin,
          КатУчетаТреб = "+Форвард, дрейф", 
          КатУчетаОбяз = "-Форвард, дрейф";
  var ТребованияПролонгированы = false, ОбязательстваПролонгированы = false;
  var RestTrAcc = $0;
  Var ground = "";

  if( FD.БылоДосрочноеИсполнение() ) /*если на лоте стоит "Досрочное исполнение"*/    
     return 0; /*не надо переносить по срокам*/      
  end; 

  /*есть платеж снятый с пролонгации, значит перенос по срокам не выпоняем*/ 
  if( (FD.ExistsRQ(DLRQ_TYPE_DELIVERY) AND (FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.State != DLRQ_STATE_DELAYED) AND (ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_DELIVERY)))) OR  
      (FD.ExistsRQ(DLRQ_TYPE_PAYMENT) AND (FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.State != DLRQ_STATE_DELAYED) AND (ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_PAYMENT)))) OR  
      (FD.ExistsRQ(DLRQ_TYPE_AVANCE) AND (FD.GetRQ(DLRQ_TYPE_AVANCE).rec.State != DLRQ_STATE_DELAYED) AND (ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_AVANCE)))) OR
      (FD.ExistsRQ(DLRQ_TYPE_DEPOSIT) AND (FD.GetRQ(DLRQ_TYPE_DEPOSIT).rec.State != DLRQ_STATE_DELAYED) AND (ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_DEPOSIT))))
  )
     return 0;
  end; 

  if( (_КатУчетаТреб != null) AND (_КатУчетаОбяз != null) )
     КатУчетаТреб = _КатУчетаТреб;
     КатУчетаОбяз = _КатУчетаОбяз;
  end;

  if( (not FD.IsExistAccount( КатУчетаТреб, null, null, FIROLE_FIREQ, СчетУчетаТреб, null, Dat )) OR
      (not FD.IsExistAccount( КатУчетаОбяз, null, null, FIROLE_FICOM, СчетУчетаОбяз, null, Dat )) )
     return 1;
  end;

  if( (_СчетУчетаТребНов != null) AND (_СчетУчетаОбязНов != null)  )
     copy( СчетУчетаТребНов, _СчетУчетаТребНов );
     copy( СчетУчетаОбязНов, _СчетУчетаОбязНов );
  else
     GetTransferDates( FD, NULL, КатУчетаТреб, КатУчетаОбяз, @DateBegin, @DateBeginPlus, @DateBeginMinus );

     /*если пролонгирован один, а второй нет - то переносим непролонгированный, 
       пролонгированный не трогаем. см. 94321.*/
     ТребованияПролонгированы = ( ( (FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.State == DLRQ_STATE_DELAYED) AND IsSALE(FD.Group) )
                                  OR
                                  ( (FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.State == DLRQ_STATE_DELAYED) AND IsBUY(FD.Group) )
                                );

     ОбязательстваПролонгированы = ( ( (FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.State == DLRQ_STATE_DELAYED) AND IsSALE(FD.Group) )
                                     OR
                                     ( (FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.State == DLRQ_STATE_DELAYED) AND IsBUY(FD.Group) )
                                   );

     if( ( (НужноПереноситьПоСрокам( FD, КатУчетаТреб, DateBegin, DateBeginPlus, FD.ID, СчетУчетаТреб.Code_Currency, FIROLE_FIREQ, null, TransfDatePlus, null)
             AND (ТребованияПролонгированы == false)
           )
           or
             (ТребованияПролонгированы == true)
         ) AND 
         ( (НужноПереноситьПоСрокам( FD, КатУчетаОбяз, DateBegin, DateBeginMinus, FD.ID, СчетУчетаОбяз.Code_Currency, FIROLE_FICOM, null, TransfDateMinus, null)
             AND (ОбязательстваПролонгированы == false)
           )
           or
             (ОбязательстваПролонгированы == true)
         ) 
       )

        if (ТребованияПролонгированы)
           ActionDate = TransfDateMinus;
        elif (ОбязательстваПролонгированы)
           ActionDate = TransfDatePlus;
        else
           ActionDate = minDate( TransfDatePlus, TransfDateMinus );
        end;

        if( (not FD.ActualCheckPeriod( КатУчетаТреб, null, null, FIROLE_FIREQ, СчетУчетаТребНов, ActionDate, null, null, null, Dat )) OR
            (not FD.ActualCheckPeriod( КатУчетаОбяз, null, null, FIROLE_FICOM, СчетУчетаОбязНов, ActionDate, null, null, null, Dat ))
          )
           return 1;
        end;  
     else
        MsgBox( "Ошибка при определении даты переноса по срокам." );
        return 1;
     end;
  end; 

  if( (СчетУчетаТреб.Account == СчетУчетаТребНов.Account)  and 
      (СчетУчетаОбяз.Account == СчетУчетаОбязНов.Account ) )
     if( (NoErr != null) AND (NoErr == true) )
        return 0;
     else     
        if( not bAND( FD.dl_leg.rec.BitMask, DL_LEG_ALWAYS_DUE ) )  
           MsgBox("На дату " + string(Dat) + " перенос требований или обязательств не требуется.");
           return 1;
        else
           return 0; 
        end; 
     end; 
  end;

  if( СчетУчетаТреб.Account != СчетУчетаТребНов.Account )
     If(FD.tick.rec.ispfi == "X")
        ground = "ПФИ (). Перенос требований по сделке N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + ". К/агент: " + UserGetPartyShortName(FD.tick.rec.partyid);
     else
        ground = "Перенос требований по сделке N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + ". К/агент: " + UserGetPartyShortName(FD.tick.rec.partyid);
     end;
     /*оба счета активные, поэтому наоборот*/
     if( КОРРЕСП_ГЛАВА_Г() == true )
        if( not ПроводкаПоКатегориямУчета( FD, 
               СчетУчетаТребНов, СчетУчетаТреб, /* Деб , Кредит*/
               dat,                   /* Дата */
               4,                     /* Глава */
               СчетУчетаТреб.Code_Currency,  /* Валюта */
               ABS(GetRestAccount(СчетУчетаТреб, dat)),/* Сумма */
               Doc,                   /* Документ */
               INPCARRY,              /* Result_Carry */
               " 1",                  /* Kind_Oper */
               FD.tick.rec.DealCode,  /* Numb_Document */
               ground/*"Перенос требований по сделке " + FD.tick.rec.DealCode*/, /* Ground */
               0
              ))
            return 1;
        end;
     else

        RestTrAcc = ABS(GetRestAccount(СчетУчетаТреб, dat));

        FD.SetFIIDForCorAccNum(СчетУчетаТреб.Code_Currency);

        if( not ПроводкаПоКатегориямУчета( FD, 
               "СчКорреспГлаваГ", СчетУчетаТреб, /* Деб , Кредит*/
               dat,                   /* Дата */
               4,                     /* Глава */
               null,  /* Валюта */
               null,/* Сумма */
               Doc,                   /* Документ */
               INPCARRY,              /* Result_Carry */
               " 1",                  /* Kind_Oper */
               FD.tick.rec.DealCode,  /* Numb_Document */
               ground/*"Перенос требований по сделке " + FD.tick.rec.DealCode*/, /* Ground */
               0, FIROLE_CORACC_ACTIVE, null, null, null,
               СчетУчетаТреб.Code_Currency, RestTrAcc
              ))
            return 1;
        end;
        if( not ПроводкаПоКатегориямУчета( FD, 
               СчетУчетаТребНов, "СчКорреспГлаваГ", /* Деб , Кредит*/
               dat,                   /* Дата */
               4,                     /* Глава */
               СчетУчетаТребНов.Code_Currency,  /* Валюта */
               RestTrAcc,/* Сумма */
               Doc,                   /* Документ */
               INPCARRY,              /* Result_Carry */
               " 1",                  /* Kind_Oper */
               FD.tick.rec.DealCode,  /* Numb_Document */
               ground/*"Перенос требований по сделке " + FD.tick.rec.DealCode*/, /* Ground */
               0, null, FIROLE_CORACC_ACTIVE
              ))
            return 1;
        end;

     end;
  end;

  if( СчетУчетаОбяз.Account != СчетУчетаОбязНов.Account )

     If(FD.tick.rec.ispfi == "X")
        ground = "ПФИ (). Перенос обязательств по сделке N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + ". К/агент: " + UserGetPartyShortName(FD.tick.rec.partyid);
     else
        ground = "Перенос обязательств по сделке N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + ". К/агент: " + UserGetPartyShortName(FD.tick.rec.partyid);
     end;
     if( КОРРЕСП_ГЛАВА_Г() == true )
        if( not ПроводкаПоКатегориямУчета( FD, 
               СчетУчетаОбяз, СчетУчетаОбязНов, /* Деб , Кредит*/
               dat,                   /* Дата */
               4,                     /* Глава */
               СчетУчетаОбяз.Code_Currency,  /* Валюта */
               ABS(GetRestAccount(СчетУчетаОбяз, dat)),/* Сумма */
               Doc,                   /* Документ */
               INPCARRY,              /* Result_Carry */
               " 1",                  /* Kind_Oper */
               FD.tick.rec.DealCode,  /* Numb_Document */
               ground/*"Перенос обязательств по сделке " + FD.tick.rec.DealCode*/,/* Ground */
               0
              ))
            return 1;
        end;
     else

        RestTrAcc = ABS(GetRestAccount(СчетУчетаОбяз, dat));

        FD.SetFIIDForCorAccNum(СчетУчетаОбяз.Code_Currency);

        if( not ПроводкаПоКатегориямУчета( FD, 
               СчетУчетаОбяз, "СчКорреспГлаваГ", /* Деб , Кредит*/
               dat,                   /* Дата */
               4,                     /* Глава */
               СчетУчетаОбяз.Code_Currency,  /* Валюта */
               RestTrAcc,/* Сумма */
               Doc,                   /* Документ */
               INPCARRY,              /* Result_Carry */
               " 1",                  /* Kind_Oper */
               FD.tick.rec.DealCode,  /* Numb_Document */
               ground/*"Перенос обязательств по сделке " + FD.tick.rec.DealCode*/,/* Ground */
               0, null, FIROLE_CORACC_PASSIVE
              ))
            return 1;
        end;
        if( not ПроводкаПоКатегориямУчета( FD, 
               "СчКорреспГлаваГ", СчетУчетаОбязНов, /* Деб , Кредит*/
               dat,                   /* Дата */
               4,                     /* Глава */
               null,  /* Валюта */
               null,/* Сумма */
               Doc,                   /* Документ */
               INPCARRY,              /* Result_Carry */
               " 1",                  /* Kind_Oper */
               FD.tick.rec.DealCode,  /* Numb_Document */
               ground/*"Перенос обязательств по сделке " + FD.tick.rec.DealCode*/,/* Ground */
               0, FIROLE_CORACC_PASSIVE, null, null, null,
               СчетУчетаОбязНов.Code_Currency, RestTrAcc
              ))
            return 1;
        end;
     end;
  end;

  return 0;
END;

MACRO СконвертироватьСуммыСделки( FD:SPFirstDoc, ConvDate:DATE, ChangeRQ:BOOL )
  record NewDl_leg( dl_leg );
  var    K, NewNKD = $0, ChangeAnotherPart;
  
  //если погашаем паи, то ничего пересчитывать не надо, т.к. у пая нет номинала
  if( (FD.tick.rec.BofficeKind == DL_RETIREMENT) and (FI_IsInvestmentShare(FD.fininstr)) )
    return true; 
  end;

  if( not SmartConvertSum( NewNKD, FD.dl_leg.rec.NKD, ConvDate, FD.NKDFIID(), FD.dl_leg.rec.CFI, true))
     return false;
  end;

  if( NewNKD != (FD.dl_leg.rec.TotalCost - FD.dl_leg.rec.Cost) )
     copy( NewDl_leg, FD.dl_leg );
     if( FD.tick.rec.FixSum == SP_FIXED_PRICE )
        NewDl_leg.TotalCost = FD.dl_leg.rec.Cost + NewNKD;
        ChangeAnotherPart = true;
     elif( FD.tick.rec.FixSum == SP_FIXED_SUMMA)
        NewDl_leg.Cost  = FD.dl_leg.rec.TotalCost - NewNKD;
        NewDl_leg.Price = NewDl_leg.Cost/FD.dl_leg.rec.Principal;
        /*Округлить до точности сделки*/
        K = pow(10, FD.dl_leg.rec.Point);
        NewDl_leg.Price = Floor_Money( NewDl_leg.Price*K )/K;
        ChangeAnotherPart = false; /*в этом случае по другой части ничего не поменяется*/
     else
        MsgBox( "Неверное значение dl_tick.FixSum в сделке " + FD.tick.rec.DealCode );
        return false;
     end;
     /*Сохранить изменения с пересчетом сумм для другой части*/
     if( not FD.IsBack )
        if( not СохранитьИзмененияПоСделке( ConvDate, FD, NewDl_leg, null, ChangeRQ, ChangeAnotherPart) )
           return false;
        end;
     else
        if( not СохранитьИзмененияПоСделке( ConvDate, FD, null, NewDl_leg, ChangeRQ, ChangeAnotherPart) )
           return false;
        end;
     end;
  end;
  return true;
END;

/* Проводки постановки сделки на баланс (для операций покупки/продажи)*/
MACRO ПоставитьНаБаланс( FD, Dat, Doc, _chapter )

  if( not СконвертироватьСуммыСделки(FD, Dat, true) )
     return 1;
  end;

  if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_BALANCE ) )
     msgbox("Ошибка при изменении статуса сделки");
     return 1;
  end;

  return 0;
END;

MACRO ПолучитьСчетИзПлатежа( Paym, DebProp, CredProp, IsPayer, AccBuff, NoSayError, _chapter, PaymID_type, PmObj )

   var   payer_receiver, FIID, FindAcc = "";
   var   chapter:integer = 1;

   if( _chapter != null )
      chapter = _chapter;
   end;

   if( PaymID_type == null )
      PaymID_type = PMMET_ID;
   end;

   if( IsPayer )
      payer_receiver = " для плательщика";
   else
      payer_receiver = " для получателя";
   end;

   if( IsPayer )
      if( ID_gr_OurBank(Paym.PayerBankID) )
      FIID = Paym.BaseFIID;
         FindAcc = GetCorAcc( FIID, DebProp.Corschem, CORS_ACC_ACCOUNT);
      else
         FIID = Paym.FIID;
         if (PmObj)
            FindAcc = PmObj.PayerAccount;     
         else
            FindAcc = Paym.PayerAccount;     
         end;
      end;
   else   
      if( ID_gr_OurBank(Paym.ReceiverBankID) )
      FIID = Paym.BaseFIID;
         FindAcc = GetCorAcc( FIID, CredProp.Corschem, CORS_ACC_ACCOUNT);      
      else
         FIID = Paym.PayFIID;
         if (PmObj)
            FindAcc = PmObj.ReceiverAccount;     
         else
            FindAcc = Paym.ReceiverAccount;     
         end;
      end;
   end;
   if( FindAcc != "" )
     if( GetAccount( chapter, FIID, FindAcc, AccBuff, true ) == false ) 
        if( PmObj or (PaymID_type == PMMET_ID_TMP_OP) )
           /*возможно счета еще только во временной базе, если они открываются на одном шаге с созданием платежа*/
           if( (ValType(AccBuff) == V_STRUC) OR (ValType(AccBuff) == V_FILE) )
              ClearRecord( AccBuff );
              AccBuff.Code_Currency = FIID;
              AccBuff.Chapter       = chapter;
              AccBuff.Account       = FindAcc;
           else
              AccBuff.Clear();
              AccBuff.rec.Code_Currency = FIID;
              AccBuff.rec.Chapter       = chapter;
              AccBuff.rec.Account       = FindAcc;
           end;
        else
           if( NoSayError == false ) 
              msgbox( "Не найден счет ", FindAcc, " валюта ", ПолучитьКодФинИн(FIID), payer_receiver );
           end;
           return ""; 
        end;
     end;        
   else
      if( NoSayError == false ) 
         msgbox( "В платеже не задан счет", payer_receiver );
      end;
   end;
   return FindAcc;
END;

MACRO ПроверитьПлатежНаПросроченность( payment, PaymentName, OnlyCheck )

  if( payment.PaymStatus == PM_OVERDUE ) /*Просрочен*/
     msgbox( "Ожидается снятие платежа по " + PaymentName + " с просрочки." );
     return false;
  elif( payment.PaymStatus == PM_PROLONGATED ) /*Пролонгирован*/
     msgbox( "Платеж по " + PaymentName + " должен быть снят|с ожидания исполнения или положен на просрочку." );
     return false;
  end;

  if( (OnlyCheck != null) AND (OnlyCheck == true) )
     return true;
  end;

  if( isOprMultiExec() == false )
     if( (payment.PaymStatus != PM_BEFORE_PROCESS) AND     /*Досрочная обработка*/
         (payment.PaymStatus != PM_REMOVE_OVERDUE) AND     /*Снят с просрочки*/
         (payment.PaymStatus != PM_CLOSED_W_M_MOVEMENT )   /*Закрыт без движения*/
       ) 
        if( GetTrue( true, "Оформить оплату платежа по " + PaymentName + " ?" ) )
           return true;
        else
           return false;
        end;
     end;
  end;
  return true;
END; 

MACRO ПроверитьТОНаПросроченность( DlRq, RqName, OnlyCheck )

  if( DlRq.rec.State == DLRQ_STATE_OVERDUE ) /*Просрочено*/
     msgbox( "Ожидается снятие ТО по " + RqName + " с просрочки." );
     return false;
  elif( DlRq.rec.State == DLRQ_STATE_DELAYED ) /*Пролонгировано*/
     msgbox( "ТО по " + RqName + " должно быть снято|с ожидания исполнения или положено на просрочку." );
     return false;
  end;

  if( (OnlyCheck != null) AND (OnlyCheck == true) )
     return true;
  end;

//  if( (isOprMultiExec() == false) and (DlRq.rec.Netting == UNSET_CHAR))
//    if( GetTrue( true, "Оформить оплату ТО по " + RqName + " ?" ) )
//       return true;
//    else
//       return false;
//    end;
//  end;
  return true;
END;

PRIVATE MACRO ПроводкаСписанияРезерва( CodePC:string, RolePC:integer, FD:OBJECT, Dat:DATE, ReservAcc:VARIANT, ReservFIRole:INTEGER, Reserv:MONEY, Ground:STRING, Doc ):BOOL
   if( Reserv != 0 )
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         ReservAcc, "+" + CodePC, /* Деб, КатегКредит */
                                         Dat,                     /* Дата */
                                         1,                       /* Глава */
                                         NATCUR,                  /* Валюта */
                                         ABS(Reserv),             /* Сумма */
                                         Doc,                     /* Документ */
                                         INPCARRY,                /* Result_Carry */
                                         " 1",                    /* Kind_Oper */
                                         " 1",                    /* Numb_Document */
                                         Ground,                  /* Ground */
                                         null,
                                         ReservFIRole, RolePC
                                       )
        )
          return false;      
      end;
   end;
   return true;
END;

PRIVATE VAR ReservAcc = TRecHandler( "account" );  /*счет резерва*/
PRIVATE MACRO СписатьОстатокРезервДоговор( FD:SPFirstDoc, Doc, Dat:DATE, FIRole:INTEGER, Ground:STRING, IsAvance:BOOL ):BOOL
/*

  VAR Reserv, LastDate;

  if( FD.IsExistAccount( "Резерв, договор", null, true, FIRole, ReservAcc, null, Dat ) )
      if( IsBUY(FD.Group) AND IsTwoPart(FD.Group) AND (FIRole == FIROLE_RESERV_ROR) )
         if( (IsAvance) )
            if(FD.ExistAvance())
              Reserv = ПолучитьПоследнююСумму( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_RESERV_BACKREPO, LastDate );
              if( not СохранитьСуммуКомиссии( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_RESERV_BACKREPO, Dat, $0, $0, NATCUR ) )
                 return false;
              end; 
            end;
         else
            Reserv = ПолучитьПоследнююСумму( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DLSUM_KIND_RESERV_BACKREPO, LastDate );
            if( not СохранитьСуммуКомиссии( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DLSUM_KIND_RESERV_BACKREPO, Dat, $0, $0, NATCUR ) )
               return false;      
            end; 
         end;
      else
         Reserv = ABS(GetRestAccount( ReservAcc.rec, Dat ));
      end;

      if( Reserv != 0 )
         if( ПроводкаСписанияРезерва( FD, Doc, Dat, ReservAcc, FIRole, Reserv, 
                                      Ground + " Сделка " + FD.tick.rec.DealCode 
                                    ) == false 
           )
            return false;
         end;
      end;
  end;
*/

  return true;
END;

PRIVATE MACRO СписатьОстатокРезерваПоТребованиям( FD:SPFirstDoc, Doc, Dat:DATE, IsAvance:BOOL, FIRole:INTEGER, Ground:STRING ):BOOL

/*
  VAR RQID, LastDate, Reserv, SaveSumma,
      KindReserv = IIF( FIRole == FIROLE_RESERV_RSOP, DLSUM_KIND_RESERV_DELAY, DLSUM_KIND_RESERV_OVERDUE );

  if( FD.BuySale == DEAL_TYPE_SALE )
     /*требования - аванс или оплата*/
     if( IsAvance == true )
       if(FD.ExistAvance())
         RQID = FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID;
       end
     else
        RQID = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID;
     end;
  else
     /*требования - поставка*/
     RQID = FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID;
  end;

  if( RQID > 0 ) 
     Reserv = ПолучитьПоследнююСумму( DLDOC_PAYMENT, RQID, KindReserv, LastDate );

     if( Reserv != 0 )
        if( ПроводкаСписанияРезерва( FD, Doc, Dat, "Резерв, договор", FIROLE_RESERV_RSOP, Reserv, 
                                     Ground + " Сделка " + FD.tick.rec.DealCode 
                                   ) == false 
          )
           return false;
        end;

        /*После списания создается нулевая сумма того же вида*/
        if( LastDate == Dat ) /*Сумма сохраняется нарастающим итогом*/
           SaveSumma = -Reserv;
        else
           SaveSumma = $0;
        end;
        if( not СохранитьСуммуКомиссии( DLDOC_PAYMENT, RQID, KindReserv, Dat, SaveSumma, $0, NATCUR ) )
           return false;      
        end; 
     end;
  end;
*/

  return true;
END;

/*Списание резерва по вложениям в ц/б по продаваемым лотам*/
MACRO СписаниеРезерваЦБПоПРЕПО2ч( FD:OBJECT, Doc, dat:DATE ):BOOL
  var ReservAmount = $0, LastDate = Date(0,0,0);
/*
  ReservAmount = ПолучитьПоследнююСумму( DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_RESERV_SALEREPO2, LastDate );

  if (LastDate > dat)
     MsgBox( "Дата последней суммы резерва по требованиям (РПР) "+string(LastDate)+" для сделки с кодом " + 
             string(FD.tick.rec.DealCode) + 
             " не должна быть больше даты операции "+string(dat));      
     return false;
  end;

  if( ReservAmount != $0 )
     if( ПроводкаСписанияРезерва( FD, Doc, Dat, "Резерв ц/б", FIROLE_RESERV_SALEREPO2, 
                                   ReservAmount, 
                                   "Списание резерва по требованиям по 2 части ПР. Сделка " + FD.tick.rec.DealCode
                                 ) == false
       )
        return false;
     end;

     if( not СохранитьСуммуКомиссии( DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_RESERV_SALEREPO2, Dat, $0, $0, NATCUR ) )
        msgbox( "Ошибка при сохранении суммы резерва по требованиям по 2 части ПР" );      
        return false;
     end; 

  end;
*/
  return true;
END;

PRIVATE MACRO СписатьРезервПоТребованию( FD:SPFirstDoc, Doc, Dat:DATE, IsAvance:BOOL ):BOOL
  /*Резерв по требованиям по сделкам с отсрочкой платежа*/
  if( FD.ExistBack == false ) /*в сделках  покупки/продажи*/

     if( СписатьОстатокРезерваПоТребованиям( FD, Doc, Dat, IsAvance, FIROLE_RESERV_RSOP, 
                                             "Списание резерва по сделкам с отсрочкой платежа."
                                           ) == false 
       )
        return false;
     end;

     if( IsOUTEXCHANGE(FD.Group) )
        if( СписатьОстатокРезерваПоТребованиям( FD, Doc, Dat, IsAvance, FIROLE_RESERV_RPT, 
                                                "Списание резерва по просроченным требованиям."
                                              ) == false 
          )
           return false;
        end;
     end;
  end;

  /*Резерв по условным обязательствам кредитного характера*/
  if( IsBUY(FD.Group) AND IsTwoPart(FD.Group) ) /*списывается в сделках ОР*/
      if( FD.IsBack == false ) /*по первой части*/
         if( СписатьОстатокРезервДоговор( FD, Doc, Dat, FIROLE_RESERV_RUOKXOR, 
                                          "Списание резерва по условным обязательствам кредитного характера." 
                                        ) == false 
           )
            return false;
         end;
      else /*по второй части*/
         if( СписатьОстатокРезервДоговор( FD, Doc, Dat, FIROLE_RESERV_ROR, 
                                          "Списание резерва по требованиям по 2 части ОР.",
                                          IsAvance
                                        ) == false 
           )
            return false;
         end;

         if( СписатьОстатокРезервДоговор( FD, Doc, Dat, FIROLE_RESERV_RPOR, 
                                          "Списание резерва по получению процентных доходов."
                                        ) == false 
           )
            return false;
         end;

         if( FD.СделкаОРЦБ() == false )
            if( СписатьОстатокРезерваПоТребованиям( FD, Doc, Dat, IsAvance, FIROLE_RESERV_RPT, 
                                                    "Списание резерва по просроченным требованиям."
                                                  ) == false 
              )
               return false;
            end;

            if( СписатьОстатокРезервДоговор( FD, Doc, Dat, FIROLE_RESERV_RPTP, 
                                             "Списание резерва по просроченным процентным требованиям."
                                           ) == false 
              )
               return false;
            end;
         end;
      end;
  end;

  if( IsSALE(FD.Group) AND IsTwoPart(FD.Group) ) /*списывается в сделках ПР*/

     if( СписаниеРезерваЦБПоПРЕПО2ч( FD, Doc, Dat ) == false )
        return false;
     end;

     if( СписатьОстатокРезервДоговор( FD, Doc, Dat, FIROLE_RESERV_ROR, 
                                      "Списание резерва по требованиям по 2 части ПР.",
                                      IsAvance
                                    ) == false 
       )
        return false;
     end;

  end;

  return true;
END;

MACRO ПолучитьРолиДляСписаниеРезерваПоЦБ( KindPortf:INTEGER, FIRole:@INTEGER, FIRolePDD:@INTEGER, CodePC:@STRING, RolePC:@INTEGER, IsBond:BOOL )

  if( KindPortf == KINDPORT_SALE )
     FIRole        = FIROLE_BA_PPR;
     FIRolePDD     = FIROLE_PD_PPR;
  elif( KindPortf == KINDPORT_SALE )/*??*/
     FIRole        = FIROLE_BA_PPR_BPP;
     FIRolePDD     = FIROLE_PD_PPR;
  elif( KindPortf == KINDPORT_RETIRE )
     FIRole        = FIROLE_BA_PUDP;
     FIRolePDD     = FIROLE_PD_PUDP;
  elif( KindPortf == KINDPORT_PROMISSORY )
     FIRole        = FIROLE_BAINPROMISSORY;
     FIRolePDD     = FIROLE_PD_PDO;
  elif( KindPortf == KINDPORT_CONTR )
     FIRole        = FIROLE_BAINCONTR;
     FIRolePDD     = FIROLE_PD_PKU;
  end;

  if( (KindPortf == KINDPORT_CONTR) or (KindPortf == KINDPORT_PROMISSORY) or((KindPortf == KINDPORT_SALE) and (not IsBond) ) )
     CodePC = "+РС, д/с";
     RolePC = FIROLE_BA;
  else
     CodePC = "+РС,ц/б";
     RolePC = FIRole;
  end;

END;

/*Списание резерва по вложениям в ц/б по продаваемым лотам*/
MACRO СписаниеРезерваПоЦБ( FD:OBJECT, dat:DATE, doc, KindPortf:INTEGER, ReservAmountBuy:MONEY, IncomeReservBuy:MONEY ):BOOL
  VAR ReservAcc = TRecHandler( "account" );  /*счет резерва*/
  VAR FIRole = null, FIRolePDD = null;
  VAR CodePC:string, RolePC:integer;

  if( (ReservAmountBuy != 0) OR (IncomeReservBuy != 0) )

     ПолучитьРолиДляСписаниеРезерваПоЦБ(KindPortf,@FIRole,@FIRolePDD,@CodePC,@RolePC);

     if( (ПроводкаСписанияРезерва( CodePC, RolePC, FD, Dat, "Резерв ц/б", FIRole,
                                   ReservAmountBuy,
                                   "Списание резерва по вложениям в ц/б по продаваемым лотам",
                                   Doc
                                 ) == false
         ) OR
         (ПроводкаСписанияРезерва( "+РС,ц/б", FIRolePDD, FD, Dat, "Резерв ц/б", FIRolePDD,
                                   IncomeReservBuy,
                                   "Списание резерва по начисленному ПДД ц/б по продаваемым лотам",
                                   Doc
                                 ) == false
         )
       )
        return false;
     end;
  end;

  return true;
END;

/*Списсать резерв по сделке*/
MACRO СписатьРезерв( FD:SPFirstDoc, Doc, Dat:DATE, IsOutbal:BOOL, IsAvance:BOOL ):BOOL
   if( IsOutbal == true ) /*Списание резерва при снятии с внебаланса */
      if( СписатьОстатокРезервДоговор( FD, Doc, Dat, FIROLE_RESERV_RSS, 
                                       "Списание резерва по срочным сделкам."
                                     ) == false 
        )
         return false;
      end;
   else /*Списание резерва при исполнении требований*/
      if( СписатьРезервПоТребованию( FD, Doc, Dat, IsAvance ) == false )
         return false;
      end;
   end;

   return true;
END;

macro ВыполнитьПроводкиПереоценкиНВПИДляАванса(FD, Doc, dat)
   var Rо = $0, Rа = $0, Rп = $0, str_err = "", НужноВыполнятьПроводку = true, DateExec = Date(0,0,0), LastDate = Date(0,0,0),
       Sто_учт_а = $0, Sто_тек_а = $0, 
       Sто_учт_о = $0, Sто_тек_о = $0,
       Sто_учт_п = $0, Sто_тек_п = $0,
       Sum = $0, ground = "", CatDeb, CatCred, DebFIID, CredFIID, АвансПросрочен = false, ОплатаПросрочена = false, ПоставкаПросрочена = false;

   GetOprDate( FD.GetKindDate(DATE_DEALBEGINEXEC), DateExec );

   if(FD.ExistAvance)
     Sто_учт_а = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DateExec, str_err, true, LastDate );
     if (str_err != "")
        msgbox(str_err);
        return false;
     end;

     if( LastDate != dat )
        Sто_тек_а = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, str_err);
        if (str_err != "")
           msgbox(str_err);
           return false;
        end;
     else
        Sто_тек_а = Sто_учт_а;
     end;
   end;

   Sто_учт_о = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DateExec, str_err, true, LastDate);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   if( LastDate != dat )
      Sто_тек_о = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   else
      Sто_тек_о = Sто_учт_о;
   end;

   Sто_учт_п = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID, DateExec, str_err, true, LastDate);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   if( LastDate != dat )
      Sто_тек_п = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   else
      Sто_тек_п = Sто_учт_п;
   end;

   Rа = Sто_учт_а - Sто_тек_а;
   Rо = Sто_учт_о - Sто_тек_о;
   Rп = Sто_учт_п - Sто_тек_п;

   АвансПросрочен     = ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_AVANCE));
   ОплатаПросрочена   = ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_PAYMENT));
   ПоставкаПросрочена = ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_DELIVERY));

   if((FD.ExistAvance) and (not АвансПросрочен))
      Sum = Abs(Rа+Rо);
      ground = "Переоценка НВПИ непросроченных аванса и оплаты по сделке № " + ПолучитьНомерСделки(FD);
      if (IsBUY(FD.Group))
         if ((Rа+Rо) > 0)
            CatDeb   = "-Форвард, расчеты";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         else
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = "-Форвард, расчеты";
            CredFIID = FD.GetPayFIID();
         end;
      else
         if ((Rа+Rо) > 0)
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = "+Форвард, расчеты";
            CredFIID = FD.GetPayFIID();
         else
            CatDeb   = "+Форвард, расчеты";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         end;
      end;
   else
      if (ОплатаПросрочена)
         Sum = Abs(Rа + Rо);
         ground = "Переоценка НВПИ просроченных аванса и оплаты по сделке № " + ПолучитьНомерСделки(FD);
         if (IsBUY(FD.Group))
            if ((Rа + Rо) > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         else
            if ((Rа + Rо) > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;
      else
         /*Т.к. только в этом случа проводок может быть 2, то прямо тут их и выполним, чтобы потом перебор не делать*/
         НужноВыполнятьПроводку = false;
         Sum = Abs(Rо);
         ground = "Переоценка НВПИ непросроченной оплаты по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rо > 0)
               CatDeb   = "-Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "-Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rо > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "+Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "+Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;

         if (Sum != $0)
            if(not ПроводкаПоКатегориямУчета( FD, 
                   CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                   dat,                         /* Дата */
                   1,                           /* Глава */
                   CredFIID,                    /* Валюта */
                   Sum,                         /* Сумма  */
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground,
                   null,
                   null,
                   null,
                   DebFIID, CredFIID
                  ) 
              )
                return false;
            end;
         end;

         Sum = Abs(Rа);
         ground = "Переоценка НВПИ просроченного аванса по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rа > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rа > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;

         if (Sum != $0)
            if(not ПроводкаПоКатегориямУчета( FD, 
                   CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                   dat,                         /* Дата */
                   1,                           /* Глава */
                   CredFIID,                    /* Валюта */
                   Sum,                         /* Сумма  */
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground,
                   null,
                   null,
                   null,
                   DebFIID, CredFIID
                  ) 
              )
                return false;
            end;
         end;

      end;
   end;

   /*Не выполняем проводку только, если у нас случай с 2 проводками - а они уже выполнены.*/
   if (НужноВыполнятьПроводку)
      if (Sum != $0)
         if(not ПроводкаПоКатегориямУчета( FD, 
                CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                CredFIID,                    /* Валюта */
                Sum,                         /* Сумма  */
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null,
                null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      end;
   end;

   if ((not ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_PAYMENT) )) and (not ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_DELIVERY))))
      Sum = Abs(Rп);
      if (not ПоставкаПросрочена )
         ground = "Переоценка НВПИ непросроченной поставки по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "+Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "+Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rп > 0)
               CatDeb   = "-Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "-Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            end;
         end;
      else
         ground = "Переоценка НВПИ просроченной поставки по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rп > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         end;
      end;

      if (Sum != $0)
         if(not ПроводкаПоКатегориямУчета( FD, 
                CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                CredFIID,                    /* Валюта */
                Sum,                         /* Сумма  */
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null,
                null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      end;

   end;

   return true;
end;

macro ВыполнитьПроводкиПереоценкиНВПИДляОплаты(FD, Doc, dat)
   var Rо = $0, Rп = $0, str_err = "", DateExec = Date(0,0,0), LastDate = Date(0,0,0),
       Sто_учт_о = $0, Sто_тек_о = $0,
       Sто_учт_п = $0, Sто_тек_п = $0,
       Sum = $0, ground = "", CatDeb, CatCred, DebFIID, CredFIID, ОплатаПросрочена = false, ПоставкаПросрочена = false;

   GetOprDate( FD.GetKindDate(DATE_DEALBEGINEXEC), DateExec );

   Sто_учт_о = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DateExec, str_err, true, LastDate);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   if( LastDate != dat )
      Sто_тек_о = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   else
      Sто_тек_о = Sто_учт_о;
   end;

   Sто_учт_п = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID, DateExec, str_err, true, LastDate);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   if( LastDate != dat )
      Sто_тек_п = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   else
      Sто_тек_п = Sто_учт_п;
   end;

   Rо = Sто_учт_о - Sто_тек_о;
   Rп = Sто_учт_п - Sто_тек_п;

   ОплатаПросрочена = ТОБылоПросрочено( FD.GetRQ(DLRQ_TYPE_PAYMENT) );

   Sum = Abs(Rо);
   if( not ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_PAYMENT) ) )
      if (not ОплатаПросрочена )
         ground = "Переоценка НВПИ непросроченной оплаты по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rо > 0)
               CatDeb   = "-Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "-Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rо > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "+Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "+Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;
      else
         ground = "Переоценка НВПИ просроченной оплаты по сделке № " + ПолучитьНомерСделки(FD);
         if (IsBUY(FD.Group))
            if (Rо > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rо > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;
      end;

      if (Sum != $0)
         if(not ПроводкаПоКатегориямУчета( FD, 
                CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                CredFIID,                    /* Валюта */
                Sum,                         /* Сумма  */
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null,
                null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      end;
   end;

   ПоставкаПросрочена = ТОБылоПросрочено( FD.GetRQ(DLRQ_TYPE_DELIVERY) );

   Sum = Abs(Rп);
   if( not ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_DELIVERY) ) )
      if (not ПоставкаПросрочена)
         ground = "Переоценка НВПИ непросроченной поставки по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "+Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "+Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "-Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "-Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;
      else
         ground = "Переоценка НВПИ просроченной поставки по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rп > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         end;
      end;

      if (Sum != $0)
         if(not ПроводкаПоКатегориямУчета( FD, 
                CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                CredFIID,                    /* Валюта */
                Sum,                         /* Сумма  */
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null,
                null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      end;
   end;

   return true;
end;

macro ВыполнитьПроводкиПереоценкиНВПИДляПоставки(FD, Doc, dat)
   var Rо = $0, Rа = $0, str_err = "", НужноВыполнятьПроводку = true, 
       АвансПросрочен = false, АвансНеПросрочен = false, DateExec = Date(0,0,0), LastDate = Date(0,0,0),
       Sто_учт_а = $0, Sто_тек_а = $0, 
       Sто_учт_о = $0, Sто_тек_о = $0,
       Sum = $0, ground = "", CatDeb, CatCred, DebFIID, CredFIID,
       Rп = $0, Sто_учт_п = $0, Sто_тек_п = $0, ОплатаПросрочена = false, ПоставкаПросрочена = false;

   /*здесь обязательно проверяем, что оплата не исполнена, поскольку по ТЗ: Т/О по поставке не переоценивается, если оплата исполнена*/
   if( ТОЗакрыто( FD.pm_money.dlreq ) )
      return true;
   end;

   GetOprDate( FD.GetKindDate(DATE_DEALBEGINEXEC), DateExec );

   if (FD.ExistAvance and (not ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_AVANCE) )) )
      Sто_учт_а = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DateExec, str_err, true, LastDate);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;

      if( LastDate != dat )
         Sто_тек_а = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;
      else
         Sто_тек_а = Sто_учт_а;
      end;
   end;

   Sто_учт_п = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID, DateExec, str_err, true, LastDate);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   if( LastDate != dat )
      Sто_тек_п = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   else
      Sто_тек_п = Sто_учт_п;
   end;

   Sто_учт_о = ПолучитьУчтеннуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DateExec, str_err, true, LastDate);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   if( LastDate != dat )
      Sто_тек_о = ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   else
      Sто_тек_о = Sто_учт_о;
   end;

   if (FD.ExistAvance)
      Rа = Sто_учт_а - Sто_тек_а;
   else
      Rа = $0;
   end;

   Rо = Sто_учт_о - Sто_тек_о;
   Rп = Sто_учт_п - Sто_тек_п;

   /*Если аванса нет, то считаем, что оба условия выполняются, только Rа = $0. Чтобы лишние ветки не городить.*/
   АвансПросрочен   = ((not FD.ExistAvance) or ((FD.ExistAvance) and (ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_AVANCE)))));
   АвансНеПросрочен = ((not FD.ExistAvance) or ((FD.ExistAvance) and (not ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_AVANCE)))));
   ОплатаПросрочена   = ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_PAYMENT));
   ПоставкаПросрочена = ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_DELIVERY));

   if (АвансНеПросрочен and (not ОплатаПросрочена))
      Sum = Abs(Rа + Rо);
      ground = "Переоценка НВПИ непросроченных аванса и оплаты по сделке № " + ПолучитьНомерСделки(FD);

      if (IsBUY(FD.Group))
         if ((Rа + Rо) > 0)
            CatDeb   = "-Форвард, расчеты";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         else
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = "-Форвард, расчеты";
            CredFIID = FD.GetPayFIID();
         end;
      else
         if ((Rа + Rо) > 0)
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = "+Форвард, расчеты";
            CredFIID = FD.GetPayFIID();
         else
            CatDeb   = "+Форвард, расчеты";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         end;
      end;

   elif (АвансПросрочен and (ОплатаПросрочена))
      Sum = Abs(Rа + Rо);
      ground = "Переоценка НВПИ просроченных аванса и оплаты по сделке № " + ПолучитьНомерСделки(FD);

      if (IsBUY(FD.Group))
         if ((Rа + Rо) > 0)
            CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         else
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
            CredFIID = FD.GetPayFIID();
         end;
      else
         if ((Rа + Rо) > 0)
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
            CredFIID = FD.GetPayFIID();
         else
            CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         end;
      end;
   end;

   if (Sum != $0)
      if(not ПроводкаПоКатегориямУчета( FD, 
             CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             CredFIID,                    /* Валюта */
             Sum,                         /* Сумма  */
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             ground,
             null,
             null,
             null,
             DebFIID, CredFIID
            ) 
        )
          return false;
      end;
   end;


   /*Существование аванса проверяем, чтобы не выполнить некоторые проводки 2 раза.*/
   if (FD.ExistAvance and АвансПросрочен and (not ОплатаПросрочена))

      if ( not ОплатаПросрочена )
         Sum = Abs(Rо);
         ground = "Переоценка НВПИ непросроченной оплаты по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rо > 0)
               CatDeb   = "-Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "-Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rо > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "+Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "+Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;

         if (Sum != $0)
            if(not ПроводкаПоКатегориямУчета( FD, 
                   CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                   dat,                         /* Дата */
                   1,                           /* Глава */
                   CredFIID,                    /* Валюта */
                   Sum,                         /* Сумма  */
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground,
                   null,
                   null,
                   null,
                   DebFIID, CredFIID
                  ) 
              )
                return false;
            end;
         end;
      end;

      if (АвансПросрочен)
         Sum = Abs(Rа);
         ground = "Переоценка НВПИ просроченного аванса по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rа > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rа > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;

         if (Sum != $0)
            if(not ПроводкаПоКатегориямУчета( FD, 
                   CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                   dat,                         /* Дата */
                   1,                           /* Глава */
                   CredFIID,                    /* Валюта */
                   Sum,                         /* Сумма  */
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground,
                   null,
                   null,
                   null,
                   DebFIID, CredFIID
                  ) 
              )
                return false;
            end;
         end;
      end;
   end;

   Sum = Abs(Rп);
   if( not ТОЗакрыто( FD.GetRQ(DLRQ_TYPE_DELIVERY)) )
      if ( not ПоставкаПросрочена )
         ground = "Переоценка НВПИ непросроченной поставки по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "+Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "+Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = "-Форвард, расчеты";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "-Форвард, расчеты";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;
      else
         ground = "Переоценка НВПИ просроченной поставки по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rп > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rп > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         end;
      end;

      if (Sum != $0)
         if(not ПроводкаПоКатегориямУчета( FD, 
                CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                CredFIID,                    /* Валюта */
                Sum,                         /* Сумма  */
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null,
                null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      end;
   end;

   return true;
end;

macro ВыполнитьПроводкиПереоценкиНВПИДляАвансаПоРЕПО(FD, FD2, Doc, dat)
   var Rо1 = $0, Rа2 = $0, Rа2пр = $0, str_err = "",
       Sто_учт_а = $0, Sто_тек_а = $0, 
       Sто_учт_о = $0, Sто_тек_о = $0,
       Sто_учт = $0, Sто_тек = $0,
       Sum = $0, ground = "", CatDeb, CatCred, DebFIID, CredFIID;

   /*аванс 1ч*/
   if (FD2 == null)
      if( FD.dl_leg.rec.OperState == DL_LEG_OUTBAL )
         if(FD.ExistAvance)    
           Sто_учт_а = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE), FD.tick.rec.DealDate, str_err);
           if (str_err != "")
              msgbox(str_err);
              return false;
           end;

           Sто_тек_а = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE), str_err);
           if (str_err != "")
              msgbox(str_err);
              return false;
           end;
         end;

         Sто_учт_о = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT), FD.tick.rec.DealDate, str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Sто_тек_о = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT), str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Rо1 = Sто_учт_а - Sто_тек_а + Sто_учт_о - Sто_тек_о;

         Sum = Abs(Rо1);
         ground = "Переоценка НВПИ непросроченного аванса по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rо1 > 0)
               CatDeb   = "-Кредит, неисп.";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "ВнебалСчетКорресп";
               CredFIID = NATCUR;
            else
               CatDeb   = "ВнебалСчетКорресп";
               DebFIID  = NATCUR;
               CatCred  = "-Кредит, неисп.";
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rо1 > 0)
               CatDeb   = "ВнебалСчетКорресп";
               DebFIID  = NATCUR;
               CatCred  = "+Кредит, неисп.";
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = "+Кредит, неисп.";
               DebFIID  = FD.GetPayFIID();
               CatCred  = "ВнебалСчетКорресп";
               CredFIID = NATCUR;
            end;
         end;

         if (Sum != $0)
            if(not ПроводкаПоКатегориямУчета( FD, 
                   CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                   dat,                         /* Дата */
                   3,                           /* Глава */
                   CredFIID,                    /* Валюта */
                   Sum,                         /* Сумма  */
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground,
                   null,
                   null,
                   null,
                   DebFIID, CredFIID
                  ) 
              )
                return false;
            end;
         end;
      end;
   else  /*аванс 2ч*/
      if ((FD2.ExistAvance) and (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_AVANCE))))

         Sто_учт_о = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT), FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.PlanDate, str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Sто_тек_о = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_PAYMENT), str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Rа2 = Sто_учт_о - Sто_тек_о;

         Sum = Abs(Rа2);
         ground = "Переоценка НВПИ непросроченного аванса по сделке № " + ПолучитьНомерСделки(FD);
      else
/*!!! должно быть на дату выноса платежа на просрочку. пока ValueDate.*/
         Sто_учт = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_AVANCE), FD2.GetRQ(DLRQ_TYPE_AVANCE).rec.PlanDate, str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Sто_тек = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_AVANCE), str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Rа2пр = Sто_учт - Sто_тек;
         Sum = Abs(Rа2пр);
         ground = "Переоценка НВПИ просроченного аванса по сделке № " + ПолучитьНомерСделки(FD);
      end;


      if (IsBUY(FD.Group))
         if ((FD2.ExistAvance) and (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_AVANCE))))
            if (Rа2 > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rа2пр > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;
      else
         if ((FD2.ExistAvance) and (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_AVANCE))))
            if (Rа2 > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rа2пр > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         end;
      end;

      if (Sum != $0)
         if(not ПроводкаПоКатегориямУчета( FD2, 
                CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                CredFIID,                    /* Валюта */
                Sum,                         /* Сумма  */
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null,
                null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      end;
   end;

   return true;
end;

macro ВыполнитьПроводкиПереоценкиНВПИДляОплатыПоРЕПО(FD, FD2, Doc, dat)
   var Rо1 = $0, Rа2 = $0, Rа2пр = $0, str_err = "",
       Sто_учт_а = $0, Sто_тек_а = $0, 
       Sто_учт_о = $0, Sто_тек_о = $0,
       Sто_учт = $0, Sто_тек = $0,
       Sum = $0, ground = "", CatDeb, CatCred, DebFIID, CredFIID;

   /*оплата 1ч*/
   if (FD2 == null)
      if (FD.ExistAvance)
         Sто_учт_а = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE), FD.GetRQ(DLRQ_TYPE_AVANCE).rec.PlanDate, str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Sто_тек_а = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD, dat, FD.GetRQ(DLRQ_TYPE_AVANCE), str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Rо1 = Sто_учт_а - Sто_тек_а;

         Sum = Abs(Rо1);
         ground = "Переоценка НВПИ непросроченного аванса по сделке № " + ПолучитьНомерСделки(FD);

         if (IsBUY(FD.Group))
            if (Rо1 > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rо1 > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
               CredFIID = FD.GetPayFIID();
            end;
         end;

         if (Sum != $0)
            if(not ПроводкаПоКатегориямУчета( FD, 
                   CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                   dat,                         /* Дата */
                   1,                           /* Глава */
                   CredFIID,                    /* Валюта */
                   Sum,                         /* Сумма  */
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground,
                   null,
                   null,
                   null,
                   DebFIID, CredFIID
                  ) 
              )
                return false;
            end;
         end;
      end;
   else  /*оплата 2ч*/
      if (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_PAYMENT)))

         if (FD2.ExistAvance)
            Sто_учт_а = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_AVANCE), FD2.GetRQ(DLRQ_TYPE_AVANCE).rec.PlanDate, str_err);
            if (str_err != "")
               msgbox(str_err);
               return false;
            end;

            Sто_тек_а = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_AVANCE), str_err);
            if (str_err != "")
               msgbox(str_err);
               return false;
            end;
         else
            Sто_учт_а = $0;
            Sто_тек_а = $0;
         end;

         Sто_учт_о = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_PAYMENT), FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.PlanDate, str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Sто_тек_о = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_PAYMENT), str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Rа2 = Sто_учт_а - Sто_тек_а + Sто_учт_о - Sто_тек_о;

         Sum = Abs(Rа2);
         ground = "Переоценка НВПИ непросроченной оплаты по сделке № " + ПолучитьНомерСделки(FD);
      else
/*!!! должно быть на дату выноса платежа на просрочку. пока ValueDate.*/
         Sто_учт = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_PAYMENT), FD2.GetRQ(DLRQ_TYPE_PAYMENT).rec.PlanDate, str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Sто_тек = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_PAYMENT), str_err);
         if (str_err != "")
            msgbox(str_err);
            return false;
         end;

         Rа2пр = Sто_учт - Sто_тек;
         Sum = Abs(Rа2пр);
         ground = "Переоценка НВПИ просроченной оплаты по сделке № " + ПолучитьНомерСделки(FD);
      end;


      if (IsBUY(FD.Group))
         if (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_PAYMENT)))
            if (Rа2 > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         else
            if (Rа2пр > 0)
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               CredFIID = FD.GetPayFIID();
            else
               CatDeb   = IIF(IsBasket(FD.Group), "Треб. с н.с., корзина", "Треб. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            end;
         end;
      else
         if (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_PAYMENT)))
            if (Rа2 > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
               CredFIID = FD.GetPayFIID();
            end;
         else
            if (Rа2пр > 0)
               CatDeb   = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               DebFIID  = FD.GetPayFIID();
               CatCred  = "+МаржаНВПИ, ИВ";
               CredFIID = NATCUR;
            else
               CatDeb   = "-МаржаНВПИ, ИВ";
               DebFIID  = NATCUR;
               CatCred  = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
               CredFIID = FD.GetPayFIID();
            end;
         end;
      end;

      if (Sum != $0)
         if(not ПроводкаПоКатегориямУчета( FD2, 
                CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                CredFIID,                    /* Валюта */
                Sum,                         /* Сумма  */
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null,
                null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      end;
   end;

   return true;
end;

macro ВыполнитьПроводкиПереоценкиНВПИДляКомпВзносаПоРЕПО(FD, FD2, Doc, dat)
   var Rа2 = $0, str_err = "",
       Sто_учт_а = $0, Sто_тек_а = $0, 
       Sто_учт_о = $0, Sто_тек_о = $0,
       Sum = $0, ground = "", CatDeb, CatCred, DebFIID, CredFIID;

   if (FD2.ExistAvance and ((FD2.GetRQ(DLRQ_TYPE_AVANCE).rec.State == DLRQ_STATE_OVERDUE) or (ТОЗакрыто(FD.GetRQ(DLRQ_TYPE_AVANCE)))))
      Sто_учт_а = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_AVANCE), FD2.GetRQ(DLRQ_TYPE_AVANCE).rec.PlanDate, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;

      Sто_тек_а = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_AVANCE), str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   else
      Sто_учт_а = $0;
      Sто_тек_а = $0;
   end;

   Sто_учт_о = ПолучитьУчтеннуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_PAYMENT), FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.PlanDate, str_err);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   Sто_тек_о = ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD2, dat, FD2.GetRQ(DLRQ_TYPE_PAYMENT), str_err);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   Rа2 = Sто_учт_а - Sто_тек_а + Sто_учт_о - Sто_тек_о;

   Sum = Abs(Rа2);
   ground = "Переоценка НВПИ суммы ОД по сделке № " + ПолучитьНомерСделки(FD);


   if (IsBUY(FD.Group))
      if (Rа2 > 0)
         CatDeb   = "-МаржаНВПИ, ИВ";
         DebFIID  = NATCUR;
         CatCred  = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
         CredFIID = FD.GetPayFIID();
      else
         CatDeb   = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
         DebFIID  = FD.GetPayFIID();
         CatCred  = "+МаржаНВПИ, ИВ";
         CredFIID = NATCUR;
      end;
   else
      if (Rа2 > 0)
         CatDeb   = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
         DebFIID  = FD.GetPayFIID();
         CatCred  = "+МаржаНВПИ, ИВ";
         CredFIID = NATCUR;
      else
         CatDeb   = "-МаржаНВПИ, ИВ";
         DebFIID  = NATCUR;
         CatCred  = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");
         CredFIID = FD.GetPayFIID();
      end;
   end;

   if (Sum != $0)
      if(not ПроводкаПоКатегориямУчета( FD2, 
             CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             CredFIID,                    /* Валюта */
             Sum,                         /* Сумма  */
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             ground,
             null,
             null,
             null,
             DebFIID, CredFIID
            ) 
        )
          return false;
      end;
   end;

   return true;
end;

macro ВыполнитьПроводкиПереоценкиНВПИДляПроцентовПоРЕПО(FD, FD2, Doc, dat)
   var str_err = "", R;
   var R_б_pc = $0, R_вб_pc = $0, SтоPC_учт_вр = $0, SтоPC_вб_учт_вр = $0, SтоPC_тек_вр = $0, SтоPC_вб_тек_вр = $0,
       Sum = $0, SтоPC_учт_вц = $0, SтоPC_вб_учт_вц = $0, ground = "", CatDeb = "", CatCred = "", DebFIID, CredFIID;

   R = FD2.dl_leg.rec.IncomeRate;

   /*Получаем в ВР*/
   SтоPC_учт_вр = ПолучитьУчтеннуюСуммуПроцентовПоРЕПО(FD, dat, DLSUM_KIND_SUM_TO_PERCENT, str_err);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   /*Получаем в ВЦ*/
   SтоPC_учт_вц = ПолучитьУчтеннуюСуммуПроцентовПоРЕПО(FD, dat, DLSUM_KIND_SUM_TO_PERCENT_CFI, str_err);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   /*Сохраняем в ВР*/
   SтоPC_тек_вр = ПолучитьИСохранитьТекущуюСуммуПроцентовПоРЕПО(FD, dat, DLSUM_KIND_SUM_TO_PERCENT, str_err, SтоPC_учт_вц);
   if (str_err != "")
      msgbox(str_err);
      return false;
   end;

   if( ((R > 0.0) and (FD.BuySale == DEAL_TYPE_BUY)) or 
       ((R < 0.0) and (FD.BuySale == DEAL_TYPE_SALE))
     ) 
      /*Получаем в ВР*/
      SтоPC_вб_учт_вр = ПолучитьУчтеннуюСуммуПроцентовПоРЕПО(FD, dat, DLSUM_KIND_SUM_NOTCARRY_PERCENT, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;

      /*Получаем в ВЦ*/
      SтоPC_вб_учт_вц = ПолучитьУчтеннуюСуммуПроцентовПоРЕПО(FD, dat, DLSUM_KIND_SUM_NOTCARRY_PERCENT_CFI, str_err);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;

      /*Сохраняем в ВР*/
      SтоPC_вб_тек_вр = ПолучитьИСохранитьТекущуюСуммуПроцентовПоРЕПО(FD, dat, DLSUM_KIND_SUM_NOTCARRY_PERCENT, str_err, SтоPC_вб_учт_вц);
      if (str_err != "")
         msgbox(str_err);
         return false;
      end;
   end;

//   R_pc = Sто_учт - Sто_тек;
   R_б_pc  = (SтоPC_учт_вр - SтоPC_вб_учт_вр) - (SтоPC_тек_вр - SтоPC_вб_тек_вр);
   R_вб_pc = SтоPC_вб_учт_вр - SтоPC_вб_тек_вр;

   Sum = Abs(R_б_pc);

   if ( (IsBUY(FD.Group)  and (FD2.dl_leg.rec.IncomeRate > 0.0)) or
        (IsSALE(FD.Group) and (FD2.dl_leg.rec.IncomeRate < 0.0))
      )
      if (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_PAYMENT))) 
         ground = "Переоценка НВПИ непросроченных процентов по сделке № " + ПолучитьНомерСделки(FD);
         if (R_б_pc > 0)
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = "+% к погашению";
            CredFIID = FD.GetPayFIID();
         else
            CatDeb   = "+% к погашению";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         end;
      else
         if(not ( IsSALE(FD.Group) and (FD2.dl_leg.rec.IncomeRate < 0.0)) )
           ground = "Переоценка НВПИ просроченных процентов по сделке № " + ПолучитьНомерСделки(FD);
           if (R_б_pc > 0)
              CatDeb   = "-МаржаНВПИ, ИВ";
              DebFIID  = NATCUR;
              CatCred   = "+% с н.с.";
              CredFIID = FD.GetPayFIID();
           else
              CatDeb   = "+% с н.с.";
              DebFIID  = FD.GetPayFIID();
              CatCred  = "+МаржаНВПИ, ИВ";
              CredFIID = NATCUR;
           end;
         end;
      end;
   else
      if (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_PAYMENT))) /*проценты не просрочены*/
         ground = "Переоценка НВПИ непросроченных процентов по сделке № " + ПолучитьНомерСделки(FD);
         if (R_б_pc > 0)
            CatDeb   = "-% к погашению";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         else
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred  = "-% к погашению";
            CredFIID = FD.GetPayFIID();
         end;
      else
         ground = "Переоценка НВПИ просроченных процентов по сделке № " + ПолучитьНомерСделки(FD);
         if (R_б_pc > 0)
            CatDeb   = "-% с н.с.";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "+МаржаНВПИ, ИВ";
            CredFIID = NATCUR;
         else
            CatDeb   = "-МаржаНВПИ, ИВ";
            DebFIID  = NATCUR;
            CatCred   = "-% с н.с.";
            CredFIID = FD.GetPayFIID();
         end;
      end;
   end;

   if ( (Sum != $0) and (CatDeb != "") and ( CatCred != "" ) )
      if(not ПроводкаПоКатегориямУчета( FD2, 
             CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             CredFIID,                    /* Валюта */
             Sum,                         /* Сумма  */
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             ground,
             null,
             null,
             null,
             DebFIID, CredFIID
            ) 
        )
          return false;
      end;
   end;



   Sum = Abs(R_вб_pc);

   if ( (IsBUY(FD.Group)  and (FD2.dl_leg.rec.IncomeRate > 0.0)) or
        (IsSALE(FD.Group) and (FD2.dl_leg.rec.IncomeRate < 0.0))
      )
      if (not ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_PAYMENT))) /*проценты не просрочены*/
         ground = "Переоценка НВПИ непросроченных процентов по сделке № " + ПолучитьНомерСделки(FD);
         if (R_вб_pc > 0)
            CatDeb   = "ВнебалСчетКорресп";
            DebFIID  = NATCUR;
            CatCred  = "Задолж.% (внебаланс)";
            CredFIID = FD.GetPayFIID();
         else
            CatDeb   = "Задолж.% (внебаланс)";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "ВнебалСчетКорресп";
            CredFIID = NATCUR;
         end;
      else
         ground = "Переоценка НВПИ просроченных процентов по сделке № " + ПолучитьНомерСделки(FD);
         if (R_вб_pc > 0)
            CatDeb   = "ВнебалСчетКорресп";
            DebFIID  = NATCUR;
            CatCred   = "Задолж.%с н.с (внебаланс)";
            CredFIID = FD.GetPayFIID();
         else
            CatDeb   = "Задолж.%с н.с (внебаланс)";
            DebFIID  = FD.GetPayFIID();
            CatCred  = "ВнебалСчетКорресп";
            CredFIID = NATCUR;
         end;
      end;
   end;

   if ( (Sum != $0) and (CatDeb != "") and ( CatCred != "" ) )
      if(not ПроводкаПоКатегориямУчета( FD2, 
             CatDeb, CatCred,             /* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             3,                           /* Глава */
             CredFIID,                    /* Валюта */
             Sum,                         /* Сумма  */
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             ground,
             null,
             IIF(CatDeb=="ВнебалСчетКорресп",FIROLE_CA,null),
             IIF(CatCred=="ВнебалСчетКорресп",FIROLE_CA,null),
             DebFIID, CredFIID
            ) 
        )
          return false;
      end;
   end;

   return true;
end;

/*получить очередную роль из массива*/
PRIVATE MACRO GetNextFIRoleFromArray( FIRoles, i, loop, make_car, _FIRole )

   if( (FIRoles != null) AND (ValType( FIRoles ) == V_GENOBJ) ) /*массив ролей*/  

      if(FIRoles[i] != null)            
        loop     = true;                    
        make_car = true;
        _FIRole  = FIRoles[i];
      else
        loop     = false;                    
        make_car = false;
        _FIRole  = null;
      end;
      i = i + 1;    

   else
      loop       = false; /*перебор не нужен, только одна роль задана*/
      make_car   = true;
      _FIRole    = FIRoles;
   end;
   setparm( 1, i        );
   setparm( 2, loop     );
   setparm( 3, make_car );
   setparm( 4, _FIRole  );
END;

/*параметры процедуры проводок по ролям*/
CLASS ParmsCarryByRoles

   var IsBalance, IsOutlayBuy, IsNKDBuy, IsNKDBuyLink, IsNKDBuyDeal, IsNKDFactLink, IsReserve, IsPartly;
   var NKDBuySum, NKDBuyDeal;
   macro Clear()
      IsBalance = IsOutlayBuy = IsNKDBuy = IsNKDFactLink = IsNKDBuyLink = IsNKDBuyDeal = IsReserve = IsPartly = false;
      NKDBuySum = $0; /*вся сумма НКД, уплаченного при покупках*/
      NKDBuyDeal = $0; 
   end;   
END;

MACRO УчетПредварительныхЗатрат( FD, dat, Doc, _CarrySum_PreOutlay, _PreOutlayFIID:INTEGER, _CatDebetACC:STRING, _DebetACCFIID:INTEGER, _Ground:STRING )
   VAR AccPreOutlay = TRecHandler( "account" );
   var CarrySum_PreOutlay = $0, StrGround = NULL, PreOutlayFIID, CatDebetACC, DebetACCFIID, DebFiRole = null;

   if( _CarrySum_PreOutlay != null )
      CarrySum_PreOutlay   = _CarrySum_PreOutlay;
      //if( _Ground == NULL )
         //(!!!) закомментировано по 140614
        //StrGround = "Учет изменения предварительных затрат";      
      //end;
   else
      CarrySum_PreOutlay   = FD.tick.rec.PreOutlay;
      //if( _Ground == NULL )
         //(!!!) закомментировано по 140614
         //StrGround = "Учет предварительных затрат";
      //end;
   end;

   if( _Ground == NULL)
        StrGround = "Учет предварительных затрат";
   end;      

   if( IsClientDeal(FD.tick.rec) OR (CarrySum_PreOutlay == $0) )
      return true;
   end;

   if( _Ground != NULL )
      StrGround = _Ground;
   end;

   if( _PreOutlayFIID == NULL )
      PreOutlayFIID = NATCUR;
   else
      PreOutlayFIID = _PreOutlayFIID;
   end;

   if( _CatDebetACC == NULL )
      if( FD.pmwrtsum.rec.GroupID == KINDPORT_CONTR )
         CatDebetACC = "Наш портфель ПКУ, ц/б";
      else
         CatDebetACC = "Наш портфель ц/б";
      end;
      DebFiRole = GetFIRoleByPortfolio(FD.pmwrtsum.rec.GroupID);
   else
      CatDebetACC = _CatDebetACC;
   end;

   if( _DebetACCFIID == NULL )
      DebetACCFIID = FD.GetAccFIID(CatDebetACC);
   else
      DebetACCFIID = _DebetACCFIID;
   end;

   /*если есть счет и его остаток не 0, то надо учитывать*/
   if( FD.IsExistAccount( "Предв.затраты, ц/б", null, true, null, AccPreOutlay, null, dat, NATCUR ) AND
       (GetRestAccount( AccPreOutlay.rec, dat ) != 0) )
      
      if(not ПроводкаПоКатегориямУчета( FD, 
             CatDebetACC, AccPreOutlay, /* КатегДеб , КатегКредит*/
             dat,                   /* Дата */
             1 ,                    /* Глава */
             PreOutlayFIID,         /* Валюта */
             CarrySum_PreOutlay,    /* Сумма предварительных затрат */
             Doc,                   /* Документ */
             INPCARRY,              /* Result_Carry */
             " 1",                  /* Kind_Oper */
             FD.tick.rec.DealCode,  /* Numb_Document */
             StrGround, /* Ground */
             NULL, DebFiRole, NULL, 
             DebetACCFIID
            ) )
          return false;
      end;
   end;

   return true;
END;

MACRO ПроверитьЛотПоПервойЧастиСделки( deal )
   var FD_1 = SPFirstDoc( deal );
   if( FD_1.pmwrtsum.rec.State < PM_WRTSUM_FORM )
      msgbox( "Не выполнена поставка по первой части сделки." );
      return false;
   end;
   return true;
END;

/*Переинитить дату завершения сделки*/
macro УстановитьДатуЗавершенияСделки( FD, IsRedefine:BOOL ):INTEGER
   var    Do, Dp, Dk, CloseDate = Date(0,0,0); 

   if( IsRedefine == null )
      IsRedefine = false;
   end;

   Do = FD.DateArray[DATE_DEALPAY];
   Dp = FD.DateArray[DATE_DEALSETAVOIRISS];
   Dk = FD.DateArray[DATE_DEALCOMISS];

   if( (FD.ПроверитьНачисленностьЕдиновременныхКомиссий() == true) OR 
       ((FD.GetModeWriteOff() != "X") AND (FD.GetPeriodComOnFinalTrDay() == true))        
   )
      /*в онлайне учитываем дату комиссии в случае есди начислены единовременные комиссии,
        в офлайне, в случае, если на договоре есть периодические комиссии                 */
      CloseDate = maxDate( maxDate(Do, Dp), Dk);
   else
      CloseDate = maxDate(Do, Dp);
   end;

   if( IsRedefine )
      if( not OprReplanStepPlanDates( FD.GetKindDate(DATE_DEALEEND), CloseDate ) )
         msgbox("Ошибка при попытке переинициализировать дату завершения сделки." );         
         return 1;
      end;
   else
      if( not DefineOprDate( FD.GetKindDate(DATE_DEALEEND), maxDate( maxDate(Do, Dp), Dk) ) )
         msgbox("Ошибка при инициализации даты завершения сделки." );         
         return 1;
      end;
   end;

   return 0;
end;

macro ИзменитьДатуПоставки( FD:SPFirstDoc, NewDate:DATE )
   var OldNKD, OldIncome, pmobj, NewIncome, Expiry, Maturity;

   if( FD.pm_avoir.rec.ValueDate != NewDate )
      if( FI_IsCouponAvoiriss( FD.fininstr ) )
         OldNKD    = FD.dl_leg.rec.NKD;
         OldIncome = FD.dl_leg.rec.ReturnIncome;
         FD.dl_leg.rec.NKD = НКД( FD.dl_leg.rec.PFI, FD.dl_leg.rec.Principal, NewDate );
         if( not SmartConvertSum(FD.dl_leg.rec.NKD, FD.dl_leg.rec.NKD, NewDate, FD.FaceFIID(), FD.NKDFIID(), true) )
            return 1;
         end;

         /*установлен признак возврата дохода в займе*/
         if( (FD.IsOperLOAN == true) AND FD.tick.rec.flag3 == SET_CHAR ) 
            /* Пересчитать возвращаемый купонный доход. Сумма доходов по всем купонам, погашения 
               которых попадают в период с плановой даты получения до плановой даты возврата*/
            if( FD.IsBack == true )
               Maturity = FD.dl_leg.rec.Maturity;
               Expiry   = NewDate; 
            else
               Maturity = NewDate; 
               Expiry   = FD.dl_leg.rec.Expiry;
            end;

            NewIncome = ПолучитьНКДЗаПериод( FD.dl_leg.rec.PFI, FD.dl_leg.rec.Principal, Maturity, Expiry, false, false );
            NewIncome = NewIncome - НКД( FD.dl_leg.rec.PFI, FD.dl_leg.rec.Principal, Expiry );

            if( NewIncome < 0 ) /* такое бывает только если и Maturity и Expiry попадают в 1 купонный период*/
               NewIncome = 0; 
            end; 
            FD.dl_leg.rec.ReturnIncome = NewIncome;
         end;

         if( (OldNKD != FD.dl_leg.rec.NKD) OR (OldIncome != FD.dl_leg.rec.ReturnIncome) )
            if( not СконвертироватьСуммыСделки( FD, NewDate, false ) )
               return 1;
            end;
         end;
      end;
      pmobj = RsbPayment( FD.pm_avoir.rec.PaymentID );
      pmobj.ValueDate = NewDate;
/*
      if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_DATE, NewDate, NewDate ) )
         msgbox("Ошибка при обновлении даты поставки в лоте."); 
         return 1;
      end; */
   end;
   return 0;
end;

private record CarryDoc(acctrn);
/*получить сумму проводок на текущем шаге*/
MACRO СуммаПроводокНаШаге( Account, Chapter, Code_Currency )
   var ContinueDoc, CarrySum:money = $0.0;

   ClearRecord( CarryDoc );
   ContinueDoc = OprStepCarryFindFirst( CarryDoc );
   while( ContinueDoc )
      if( (CarryDoc.Chapter == Chapter) and (CarryDoc.State == 1) )/*фактические проводки*/
         if( (CarryDoc.Account_Payer == Account) and (CarryDoc.FIID_Payer == Code_Currency) );
            CarrySum = CarrySum - CarryDoc.Sum_Payer;
         elif( (CarryDoc.Account_Receiver == Account) AND (CarryDoc.Receiver == Code_Currency) )
            CarrySum = CarrySum + CarryDoc.Sum_Receiver;
         end;
      end;
      ContinueDoc = OprStepCarryFindNext( CarryDoc );
   end;
   OprStepCarryFindClose();

   return CarrySum;
END;

/* Обновляем лот. Устанавливаем статус, что он оплачен и завершен, если
   все комиссии оплачены. В случае ошибки возвращаем false.
      FD          -  SPFirstDoc по сделке
      ChangeDate  -  дата изменения */
macro ОбновитьЛот_ЛотОплачен( FD, ChangeDate )

   if( not ОбновитьФлагиЧастиСделки( FD.dl_leg, DL_LEG_PAY ) )
      msgbox("Ошибка при изменении битовых флагов сделки");
      return false;
   end;

   return true;
end;

MACRO РазрешеноВыполнятьПогашение( FD:SPFirstDoc ):BOOL
  VAR i = 0, Groups = TArray(), Amount = 0;
  VAR wrtcalc = TRecHandler( "pmwrtsum.dbt" ); 

  wrtcalc.Clear();

  ПолучитьГруппыСписания( FD, Groups );

  while( i < Groups.Size )
     if( WRT_Calc( FD.tick.rec.Department, FD.dl_leg.rec.PFI, FD.tick.rec.ClientID, IIF(FD.tick.rec.ClientID > 0, FD.tick.rec.ClientContrID, 0), Groups[i], FD.dl_leg.rec.Start, wrtcalc, true, true ) == true )
        Amount = Amount + wrtcalc.rec.Amount;
     else
        msgbox( "Ошибка при определении количества ц/б в портфеле." );      
        return false;
     end;
     i = i + 1;
  end;

  if( Amount <= 0 ) 
     msgbox( "Ни в одном из допустимых для списания портфелей заданной ц/б нет" );      
     return false;
  end; 
  return true;
end;

MACRO ИнициализироватьОперациюПогашения( FD:SPFirstDoc ):INTEGER
  if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_INITIAL ) )
     msgbox("Ошибка при изменении статуса сделки");
     return 1;
  end;

  return 0;             
END;

/*SetOffBalance = true - признак снятия с внебаланса. Чтобы взять остаток по счету.
  InOutFlag - не годится, в него передается false в вызове с шага оплаты аванса. 
  Чтобы не рушить логику, добавил новый флажок.
*/

private macro TransferOD( FD, Doc, CategOD, OldOD, dat, isA, NewAccount:@STRING )
   VAR FindAccount = "";
   VAR NewOD = TRecHandler( "account" );

   NewAccount = "";

   if( OldOD.rec.account != "" )
      if( not FD.ActualCheckPeriod( CategOD, null, null, null, NewOD, dat, null, null, null )) 
         return 1;
      end;

      if( NewOD.rec.Account != OldOD.rec.Account )
         if (isA)
             if( not ПроводкаПоКатегориямУчета( FD, 
                 NewOD, OldOD,/* Деб , Кредит*/
                 dat,                   /* Дата */
                 1,                     /* Глава */
                 OldOD.rec.Code_Currency,  /* Валюта */
                 ABS(GetRestAccount(OldOD.rec, dat)),/* Сумма */
                 Doc,                   /* Документ */
                 INPCARRY,              /* Result_Carry */
                 " 1",                  /* Kind_Oper */
                 FD.tick.rec.DealCode,  /* Numb_Document */
                 "Перенос остатка счета категории " + CategOD + " по сделке " + FD.tick.rec.DealCode, /* Ground */
                 0
                ))
                 return 1;
             end;
         else
             if( not ПроводкаПоКатегориямУчета( FD, 
                 OldOD, NewOD,/* Деб , Кредит*/
                 dat,                   /* Дата */
                 1,                     /* Глава */
                 OldOD.rec.Code_Currency,  /* Валюта */
                 ABS(GetRestAccount(OldOD.rec, dat)),/* Сумма */
                 Doc,                   /* Документ */
                 INPCARRY,              /* Result_Carry */
                 " 1",                  /* Kind_Oper */
                 FD.tick.rec.DealCode,  /* Numb_Document */
                 "Перенос остатка счета категории " + CategOD + " по сделке " + FD.tick.rec.DealCode, /* Ground */
                 0
                ))
                 return 1;
             end;
         end;

         NewAccount = NewOD.rec.Account;
      end;
   end;

   return 0;
end;

private macro SaveAccount( pm, Account, NewAccountOD )
//   if( (NewAccountOD != "") AND (Account != NewAccountOD) ) 
//      if( pm.rec.PayerAccount == Account )
//         pm.rec.PayerAccount = NewAccountOD;
//         СохранитьСчетаВПлатеже( pm );
//      elif( pm.rec.ReceiverAccount == Account )
//         pm.rec.ReceiverAccount = NewAccountOD;
//         СохранитьСчетаВПлатеже( pm );
//      end;
//   end;
end;

MACRO ПолучитьПараметрыОД( FD:SPFirstDoc, FD2:SPFirstDoc, dat:DATE, PlOD:TRecHandler, PlOD_2:TRecHandler, MnOD:TRecHandler, MnOD_2:TRecHandler, BegDateM:@DATE, BegDateP:@DATE, FinDateM:@DATE, FinDateP:@DATE )

  if( not FD.IsExistAccount( IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД"), null, true, null, MnOD, null, dat, null ) ) 
     MnOD.Clear();
  end;

  if( not FD.IsExistAccount( IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД"), null, true, null, PlOD, null, dat, null ) ) 
     PlOD.Clear();
  end;

  if( not FD2.IsExistAccount( IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД"), null, true, null, MnOD_2, null, dat, null ) ) 
     MnOD_2.Clear();
  end;

  if( not FD2.IsExistAccount( IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД"), null, true, null, PlOD_2, null, dat, null ) ) 
     PlOD_2.Clear();
  end;

  SC_GetDateOD( IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД"), FD, FD2, @BegDateM, @FinDateM );
  SC_GetDateOD( IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД"), FD, FD2, @BegDateP, @FinDateP );
END;
/*
MACRO ИзменитьСрочностьОД( Doc, Dat:DATE, FD:SPFirstDoc, FD2:SPFirstDoc, PlOD:TRecHandler, PlOD_2:TRecHandler, MnOD:TRecHandler, MnOD_2:TRecHandler, Save_BegDateP:DATE, Save_FinDateP:DATE, Save_BegDateM:DATE, Save_FinDateM:DATE ):INTEGER
  var  NewAccountOD;

  SC_GetDateOD( IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД"), FD, FD2, @FD.BegDate, @FD.FinDate );
  FD2.BegDate  = FD.BegDate;
  FD2.FinDate = FD.FinDate;

  if(( FD.BegDate != Save_BegDateP) or ( FD.FinDate != Save_FinDateP))

     if( TransferOD( FD, Doc, IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД"), PlOD, dat, true, @NewAccountOD ) != 0 )
        return 1;
     end;
     SaveAccount( FD.pm_money, PlOD.rec.Account, @NewAccountOD );
     if( FD.ExistAvance )
        SaveAccount( FD.pm_avance, PlOD.rec.Account, @NewAccountOD );
     end;

     if( TransferOD( FD2, Doc, IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД"), PlOD_2, dat, true, @NewAccountOD ) != 0 )
         return 1;
     end;    
     SaveAccount( FD2.pm_money, PlOD_2.rec.Account, @NewAccountOD );
     if( FD2.ExistAvance )
        SaveAccount( FD2.pm_avance, PlOD_2.rec.Account, @NewAccountOD );
     end;
  end;

  SC_GetDateOD( IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД"), FD, FD2, @FD.BegDate, @FD.FinDate );
  FD2.BegDate  = FD.BegDate;
  FD2.FinDate = FD.FinDate;
  if(( FD.BegDate != Save_BegDateM) or ( FD.FinDate != Save_FinDateM))
     if( TransferOD( FD, Doc, IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД"), MnOD, dat, false, @NewAccountOD ) != 0 )
        return 1;
     end;    
     SaveAccount( FD.pm_money, MnOD.rec.Account, @NewAccountOD );
     if( FD.ExistAvance )
        SaveAccount( FD.pm_avance, MnOD.rec.Account, @NewAccountOD );
     end;

     if( TransferOD( FD2, Doc, IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД"), MnOD_2, dat, false, @NewAccountOD ) != 0 )
        return 1;
     end;    
     SaveAccount( FD2.pm_money, MnOD_2.rec.Account, @NewAccountOD );
     if( FD2.ExistAvance )
        SaveAccount( FD2.pm_avance, MnOD_2.rec.Account, @NewAccountOD );
     end;
  end;
  return 0;
END;
*/
MACRO УстановитьСтатусТО(DlRq:Object, State:INTEGER, ChangeDate:DATE)
  var err = 0; 
  var OldState = DlRq.rec.State;
  if(DlRq.rec.ID > 0)
    DlRq.rec.State = State;
    if((DlRq.rec.State == DLRQ_STATE_EXEC) and (dlrq.rec.dockind != DL_RETIREMENT_OWN))
/*ak - w487: создание платежа по ТО*/
      var errmsg;
      err = ExecMacroFile("paymutil", "CreatingPaym", DlRq.rec.ID, null, @errmsg, true/*InStepOp*/, true/*IsSWIFT*/);
      if(err < 0)
        msgboxex("Ошибка при создании платежа по ТО\n" + errmsg);
        return 1;
      elif(err > 0)
        //msgboxex("По ТО созданы платежи (" + err + ")");
      end;
      err = 0;
/*~ak*/
      DlRq.rec.FactDate = ChangeDate;
    end;
    if( not ( (OldState == DLRQ_STATE_REJECT) and ( State == DLRQ_STATE_EXEC) ))
    err = DL_ChangeDLRQ(DlRq, ChangeDate, DLRQ_ACTION_UPDATE);
  end;
  end;
  return err;
END;

/* обработать любое денежное ТО */
/* FD может быть и не по сделке !!!*/
MACRO ОбработатьДенежноеТО( DlRq, DebetAccount, CreditAccount, FD, dat, Doc, StrGround, _IsDelimNKD )

  var chapter:integer = 1, Amount = $0, NKDAmount = $0, IsDelimNKD = false;
  var PayFIID = -1;
  
  if( _IsDelimNKD != null )/*НКД отдельной проводкой*/
     IsDelimNKD = _IsDelimNKD;
  end;

  if( (DlRq.rec.State != DLRQ_STATE_REJECT) and (not ТОСквитовано(DlRq)) ) /*если платеж не отказан и не сквитован*/
     if(УстановитьСтатусТО(DlRq, DLRQ_STATE_EXEC, dat) != 0)
       return 1;
     end;
  end;
   
  return 0;
 
end;

/* Для получения паёв  */
MACRO ОбработатьДенежноеТО_ИП( DlRq, DebetAccount, CreditAccount, FD, dat, Doc, StrGround, _IsDelimNKD )

  var chapter:integer = 1, Amount = $0, NKDAmount = $0, IsDelimNKD = false;
  var PayFIID = -1;
  
  if( _IsDelimNKD != null )/*НКД отдельной проводкой*/
     IsDelimNKD = _IsDelimNKD;
  end;

  if( DlRq.rec.State != DLRQ_STATE_REJECT ) /*если платеж не отказан */

     PayFIID = FD.GetPayFIID();
     if((DebetAccount.rec.Code_Currency == CreditAccount.rec.Code_Currency) and (DebetAccount.rec.Code_Currency != PayFIID))
       PayFIID = DebetAccount.rec.Code_Currency;
     end;

     SmartConvertSum(Amount, DlRq.rec.Amount, dat, DlRq.rec.FIID, PayFIID, false);

     if( IsDelimNKD AND (FD.dl_leg != null) AND (FD.dl_leg.rec.NKD > 0.) )
       SmartConvertSum(NKDAmount, FD.dl_leg.rec.NKD, dat, FD.FaceFIID(), PayFIID, false);
       Amount = Amount - NKDAmount;
     end;

     /*делаем проводку на сумму платежа*/ 
     if(not ПроводкаПоКатегориямУчета( FD, 
            DebetAccount, CreditAccount, /* КатегДеб , КатегКредит*/
            dat,                  /* Дата */
            chapter,                   /* Глава */
            PayFIID,  /* Валюта */
            Amount,/* Сумма  */
            Doc,                  /* Документ */
            INPCARRY,             /* Result_Carry */
            " 1",                 /* Kind_Oper */
            "",                   /* Numb_Document */
            StrGround, null,null,null,
            DebetAccount.rec.Code_Currency, CreditAccount.rec.Code_Currency     /* валюты счетов: Дт - Кт */ 
           ) )
         return 1;
     end;

     if( IsDelimNKD AND (NKDAmount > 0.) )
        if(not ПроводкаПоКатегориямУчета( FD, 
               DebetAccount, CreditAccount, /* КатегДеб , КатегКредит*/
               dat,                  /* Дата */
               chapter,                   /* Глава */
               PayFIID,  /* Валюта */
               NKDAmount,/* Сумма  */
               Doc,                  /* Документ */
               INPCARRY,             /* Result_Carry */
               " 1",                 /* Kind_Oper */
               "",                   /* Numb_Document */
               ClNKDCarryGround, 0,null,null,
               DebetAccount.rec.Code_Currency, CreditAccount.rec.Code_Currency     /* валюты счетов: Дт - Кт */ 
              ) )
            return 1;
        end;
     end;

     if(УстановитьСтатусТО(DlRq, DLRQ_STATE_EXEC, dat) != 0)
       return 1;
     end;
  end;
   
  return 0;
 
end;

MACRO ОбработатьТОПоОплате( FD, dat )

  var DlRq = TRecHandler("dlrq");

  DlRq = FD.GetRQ(DLRQ_TYPE_PAYMENT);

  if( ПроверитьТОНаПросроченность( DlRq, "оплате" ) == false )
     return 1;
  end;

  if( (DlRq.rec.Netting == UNSET_CHAR) and (not ТОСквитовано(DlRq)) )
    if(УстановитьСтатусТО(DlRq, DLRQ_STATE_EXEC, dat) != 0)
      return 1;
    end;
  end;
  
  return 0; 
END;

MACRO ОбработатьТОАвансаЗадатка( FD, dat, IsAvance )

  var DlRq = TRecHandler("dlrq");
  var ErrStr = "", IsSale;  
  var str_text = "";

  if( ((IsAvance == true) AND (FD.ExistAvance == true)) OR
      ((IsAvance == false) AND (FD.ExistDeposit == true)) )
                                                                                                     
     if( FD.BuySale == DEAL_TYPE_SALE )
        IsSale = true;
     else 
        IsSale = false;
     end;

     if( IsAvance == true )
       str_text = "авансу";
     else
       str_text = "задатку";
     end;

     if( (IsAvance == true) and (FD.ExistAvance == true))
       DlRq = FD.GetRQ(DLRQ_TYPE_AVANCE);
     else
       DlRq = FD.GetRQ(DLRQ_TYPE_DEPOSIT);
     end;

     if( ПроверитьТОНаПросроченность( DlRq, str_text ) == false )
        return 1;
     end;

     if( (DlRq.rec.Netting == UNSET_CHAR) and (not ТОСквитовано(DlRq)) )
       if(УстановитьСтатусТО(DlRq, DLRQ_STATE_EXEC, dat) != 0)
         return 1;
       end;
     end;
  else
     msgbox ("Отсутствует ТО по авансу или задатку");
     return 1;
  end;

  return 0; 
END;


macro SetOverRegistrValue(FD, FIID, ValueDate)
  record Account(account);
  var err = 0;

  if((not err) and (FD.ActualAccount("+Переоценка, ц/б ССПУ_ЦБ", null, true, FIROLE_BA_TP, Account, ValueDate) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_PLUSTP, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
     
  if((not err) and (FD.ActualAccount("-Переоценка, ц/б ССПУ_ЦБ", null, true, FIROLE_BA_TP, Account, ValueDate) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_MINUSTP, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
    
  if( ПарностьСчетовПереоценки() )
     if((not err) and (FD.ActualAccount("+Переоценка, ц/б СССД_ЦБ", null, true, FIROLE_BA_PPR, Account, ValueDate, null, null, MC_PAIRACCMODE_MANUAL) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_PLUSPPR, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
     
     if((not err) and (FD.ActualAccount("-Переоценка, ц/б СССД_ЦБ", null, true, FIROLE_BA_PPR, Account, ValueDate, null, null, MC_PAIRACCMODE_MANUAL) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_MINUSPPR, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
    
     if((not err) and (FD.ActualAccount("+ПО ДК 2014", null, true, FIROLE_BA_PPR, Account, ValueDate, null, null, MC_PAIRACCMODE_MANUAL) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_PLUSDK, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
     
     if((not err) and (FD.ActualAccount("-ПО ДК 2014", null, true, FIROLE_BA_PPR, Account, ValueDate, null, null, MC_PAIRACCMODE_MANUAL) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_MINUSDK, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
  else    
     if((not err) and (FD.ActualAccount( "+Переоценка, ц/б", null, true, FIROLE_BA_PPR, Account, ValueDate) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_PLUSPPR, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
     
     if((not err) and (FD.ActualAccount( "-Переоценка, ц/б", null, true, FIROLE_BA_PPR, Account, ValueDate) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_MINUSPPR, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
    
     if((not err) and (FD.ActualAccount( "+ПО ДК 2014", null, true, FIROLE_BA_PPR, Account, ValueDate) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_PLUSDK, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
     
     if((not err) and (FD.ActualAccount( "-ПО ДК 2014", null, true, FIROLE_BA_PPR, Account, ValueDate) != 0))
       err = DL_InsertDL_VALUE(DLDOC_ISSUE, FIID, DL_VALUE_KIND_MINUSDK, ValueDate, GetRestAccount(Account, ValueDate), Account.Code_Currency, 0);
     end;
  end;

  return err;
end;

macro ExistPlanGrDealBeforeDate(FIID:integer, ValueDate:date)
  var DataSet, cmd;
  var exist = false;

  cmd = DL_RSDCommand("select rsi_dlgr.RSI_ExistPlanGrDealBeforeDate(?, ?) as ExistPlanGrDeal from dual");
  cmd.AddParam(FIID);
  cmd.AddParam(ValueDate);

  DataSet = cmd.Execute();
  if((DataSet.moveNext()) and (DataSet.ExistPlanGrDeal))
    exist = true;
  end;

  return exist;
end;

macro ExistPlanGrDealBeforeDate2( FIID:integer, ValueDate:date ):bool
  var RetVal:bool = false;
  var query, cmd, DataSet;
  var cnt = 0;

  query = " select count(1) cnt " +
          "   from DDLGRDEAL_DBT GRDEAL, DDLGRACC_DBT GRACC " +
          "  where GRDEAL.T_FIID = ? " +
          "    and GRDEAL.T_PLANDATE <= ? " +
          "    and GRDEAL.T_PLANDATE <> TO_DATE('01.01.0001','DD.MM.YYYY') " +
          "    and GRACC.T_GRDEALID = GRDEAL.T_ID " +
          "    and GRACC.T_STATE = ? " +
          "    and GRACC.T_ACCNUM = ? " +
          "    and EXISTS(SELECT 1 FROM DDL_TICK_DBT TK WHERE TK.T_BOFFICEKIND = GRDEAL.T_DOCKIND AND TK.T_DEALID = GRDEAL.T_DOCID AND TK.T_CLIENTID = -1)" +
          "    and ROWNUM = 1";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(FIID);
  cmd.AddParam(ValueDate);
  cmd.AddParam(DLGRACC_STATE_PLAN);
  cmd.AddParam(DLGR_ACCKIND_ACCOUNTING);

  DataSet = cmd.Execute();
  if( DataSet.moveNext() and (int(DataSet.cnt) > 0) )
     RetVal = true;
  end;

  return RetVal;
end;

macro РолиСчРезерваПоТр2чПРЕПО(Portfolio:integer)
   if( Portfolio == KINDPORT_TRADE )
      return FIROLE_RESERV_SALEREPO2_TP;
   elif( Portfolio == KINDPORT_SALE )
      return FIROLE_RESERV_SALEREPO2_PPR;
   elif( Portfolio == KINDPORT_RETIRE )
      return FIROLE_RESERV_SALEREPO2_PUDP;
   elif( Portfolio == KINDPORT_CONTR )
      return FIROLE_RESERV_SALEREPO2_CONTR;
   elif( Portfolio == KINDPORT_BASICDEBT )
      return FIROLE_RESERV_SALEREPO2_PVO;
   end;
   return FIROLE_UNDEF; 
end;

macro GetDlSumKindResSaleRepo2(Portfolio:integer)
   if( Portfolio == KINDPORT_TRADE )
      return DLSUM_KIND_RESERV_SALEREPO2_TP;
   elif( Portfolio == KINDPORT_SALE )
      return DLSUM_KIND_RESERV_SALEREPO2_PPR;
   elif( Portfolio == KINDPORT_RETIRE )
      return DLSUM_KIND_RESERV_SALEREPO2_PUDP;
   elif( Portfolio == KINDPORT_CONTR )
      return DLSUM_KIND_RESERV_SALEREPO2_CONTR;
   end;
   return 0; 
end;

macro Квитовка_ПолучитьНашСчетТО( dlrq, dat, ReceiverAccount:@string )

  var PayerAccountBuff    = TRecHandler("account");
  var ReceiverAccountBuff = TRecHandler("account");
  var FD = NULL, LegKind = 0;

  ReceiverAccount = "";

  if(dlrq.rec.DealPart == 2)
     LegKind = LEG_KIND_DL_TICK_BACK;
  else
     LegKind = LEG_KIND_DL_TICK;
  end;

  FD = SPFirstDoc(LegKind, dlrq.rec.DocID);

  if( dlrq.rec.Type == DLRQ_TYPE_PAYMENT ) 
     if( ПолучитьНашСчетТОПоОплате( dlrq, FD, dat, ReceiverAccountBuff, ReceiverAccountBuff ) != 0 )
        return 1;
     end;
  elif( (dlrq.rec.Type == DLRQ_TYPE_AVANCE) or (dlrq.rec.Type == DLRQ_TYPE_DEPOSIT) ) 
     if( ПолучитьСчетаТОПоАвансуЗадатку( DlRq, FD, dat, (FD.BuySale == DEAL_TYPE_SALE), PayerAccountBuff, ReceiverAccountBuff ) != 0)
        return 1;
     end;
  elif( dlrq.rec.Type == DLRQ_TYPE_INCREPO )
     if(ПолучитьНашСчетТОПоПроцентамДляКвитовки( DlRq, FD, dat, ReceiverAccountBuff ) != 0)
        return 1;
     end;
  elif( dlrq.rec.Type == DLRQ_TYPE_COMPPAYM )
     if( ПолучитьСчетаКомпенсационногоТО(DlRq, FD, dat, PayerAccountBuff, ReceiverAccountBuff) != 0)
        return 1;
     end;
  elif( (dlrq.rec.Type == DLRQ_TYPE_PAYMREPOCOUP) or (dlrq.rec.Type == DLRQ_TYPE_PAYMREPOPART) )
     if( ПолучитьСчетаТОПоКупонуЧП(DlRq, FD, dat, PayerAccountBuff, ReceiverAccountBuff) != 0 )
        return 1;
     end;
  end;

  ReceiverAccount = ReceiverAccountBuff.rec.Account;

  return 0;
end;
