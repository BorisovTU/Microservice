/*
$Name:        scf110.mac
$Module:      Ценные бумаги
$Description: Отчет "Расшифровки отдельных показателей деятельности кредитной организации" - (форма 0409110)
*/
import "scf110_form.mac", "scf110_data.mac";

PRIVATE CONST C_PORTFOLIO      = "C",
              C_COST           = "J",
              C_NKDAMOUNT      = "K",
              C_INTERESTINCOME = "L",
              C_DISCOUNTINCOME = "M",
              C_CORRVALUE      = "O",
              C_CORRINTTOEIR   = "P",
              C_CARRYSUM       = "S",
              C_S385_16        = "T",
              C_S386_17        = "U",
              C_S175_16        = "V",
              C_S176_17        = "W",
              C_S_4_4          = "X",
              C_S_4_2          = "Y";

private macro GetNameOper( )
  file pers("person.dbt") key 0;     
  pers.Oper = {oper};
  if ( getEQ( pers ) )
       return pers.Name;
  else return "";
  end;
end;

PRIVATE CLASS (DL_CReportTemplate) SP_F110_Report
  PRIVATE CONST FORMULA = "formula=";
  PRIVATE CONST STARTROWNUM     = 1;
  PRIVATE VAR m_CurrStrNum      = STARTROWNUM;
  PRIVATE VAR m_CurrStartStrNum = STARTROWNUM;

  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO EndReport()
    ReplaceAndCalculate( FORMULA, "=" );
  END;

  PRIVATE MACRO F( Str:string ):string

     /* заменим разделитель целой и дробной частей */
     ReplaceSeparator( @Str, "." );
     ReplaceSeparator( @Str, "," );

     return FORMULA + Str;
  END;

  PRIVATE MACRO FormulaROUND():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "ROUND";
     else
        RetVal = "ОКРУГЛ";
     end;

     return RetVal;
  END;

  PRIVATE MACRO FormulaIF():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "IF";
     else
        RetVal = "ЕСЛИ";
     end;

     return RetVal;
  END;

  PRIVATE MACRO FormulaAND():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "AND";
     else
        RetVal = "И";
     end;

     return RetVal;
  END;

  PRIVATE MACRO FormulaSUM():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "SUM";
     else
        RetVal = "СУММ";
     end;

     return RetVal;
  END;

  PRIVATE MACRO FormulaABS():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "ABS";
     else
        RetVal = "ABS";
     end;

     return RetVal;
  END;

  MACRO GetAddr(Cell, RowNum):STRING
    var rn = m_CurrStrNum;

    if(RowNum != NULL)
      rn = RowNum;
    end;
    
    return (Cell+string(rn));
  END;

  MACRO PaintProtocolStr()
     var color = RGB(222,241,235);

     SetCellFont("N2_A1",  NULL, NULL, NULL, NULL, NULL, color);              
     SetCellFont("N2_A2",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A3",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A4",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A5",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A6",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A7",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A8",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A9",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A10", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A11", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A12", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A13", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A14", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A15", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A16", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A17", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A18", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A19", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A20", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A21", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A22", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A23", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A24", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_A25", NULL, NULL, NULL, NULL, NULL, color);
  END;

  MACRO PaintProtocolStrN2_1()
     var color = RGB(222,241,235);

     SetCellFont("N2_1_A1",  NULL, NULL, NULL, NULL, NULL, color);              
     SetCellFont("N2_1_A2",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A3",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A4",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A5",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A6",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A7",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A8",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A9",  NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A10", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A11", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A12", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A13", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A14", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A15", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A16", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A17", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A18", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A19", NULL, NULL, NULL, NULL, NULL, color);
     SetCellFont("N2_1_A20", NULL, NULL, NULL, NULL, NULL, color);
  END;

  MACRO Create()
    var BegDate = date(0,0,0), EndDate = date(0,0,0);
    var OurBank = TRecHandler( "party.dbt" );
    var Month = m_Form.GetFieldValue(PNFLD_SCF110_MONTH);
    var Year  = m_Form.GetFieldValue(PNFLD_SCF110_YEAR);
    var CheckRepPart2 = m_Form.GetFieldValue(PNFLD_SCF110_CHECKREP_PART2);
    var RepPart = m_Form.GetFieldValue(PNFLD_SCF110_PART);
    var curr_day, curr_month, curr_year;
    var month_name = "";
    var objData110 = NULL, objData110Protocol = NULL, objData110RefInf = NULL, objData110ProtocolPart1 = NULL;
    var f_S385_16, f_S386_17, f_S175_16, f_S176_17, f_S_4_4, f_S_4_2;
    var tf_S385_16 = "", tf_S386_17 = "", tf_S175_16 = "", tf_S176_17 = "", tf_S_4_4 = "", tf_S_4_2 = "";

    DateSplit({curdate}, curr_day, curr_month, curr_year);
    
    month_name = trim(string({curdate}:m));
    month_name = trim(substr(month_name, Index(month_name, " ")));
    month_name = trim(substr(month_name, 1, Index(month_name, " ")));
    
    Period_GetInterval(Month, Year, @BegDate, @EndDate );
    BegDate = date(1,1,Year);

    ПолучитьСубъекта({OurBank}, OurBank);

    objData110 = C_110_Secur(BegDate, EndDate);
    
    if(objData110.Get() == 0)

      SetActiveSheet("Расшифровки");

      PrintFormatString( NULL,
                         "N1_OKATO:c",      DL_GetOkatoCode({OurBank}, EndDate),
                         "N1_OKPO:c",       OurBank.rec.OKPO,
                         "N1_BANKREGNUM:c", ПолучитьКодСубъекта({OurBank}, PTCK_BANKREGNUM),
                         "N1_H0_1",         EndDate,
                         "N1_H0_2",         OurBank.rec.ShortName,
                         "N1_H0_3",         DL_GetRealAddress({OurBank}));

      
      PrintFormatString( NULL,
                         "N1_A1",   round(objData110.А50505_4/1000, 0, 2),
                         "N1_A2",   round(objData110.А50505_6_1/1000, 0, 2),
                         "N1_A3",   round(objData110.А50507_4/1000, 0, 2),
                         "N1_A4",   round(objData110.А50507_6_2/1000, 0, 2),
                         "N1_A5",   round(objData110.А505_4/1000, 0, 2),
                         "N1_A6",   round(objData110.А505_6_2/1000, 0, 2),
                         "N1_A7",   round(objData110.А5_2/1000, 0, 2),
                         "N1_A8",   round(objData110.А5_3/1000, 0, 2),
                         "N1_A9",   round(objData110.А5_4/1000, 0, 2),
                         "N1_A10",  round(objData110.А5_5/1000, 0, 2),
                         "N1_A11",  round(objData110.А5_6/1000, 0, 2),
                         "N1_A12",  round(objData110.А5_7/1000, 0, 2),
                         "N1_A13",  round(objData110.А474_5_9/1000, 0, 2),
                         "N1_A14",  round(objData110.А474_16_1/1000, 0, 2),
                         "N1_A15",  round(objData110.А474_16_2/1000, 0, 2),
                         "N1_A16",  round(objData110.А474_16_3/1000, 0, 2),
                         "N1_A17",  round(objData110.А474_16_5/1000, 0, 2),
                         "N1_A18",  round(objData110.А474_16_5_1/1000, 0, 2),
                         "N1_A19",  round(objData110.А474_16_10/1000, 0, 2),
                         "N1_A20",  round(objData110.А474_16_11/1000, 0, 2),
                         "N1_A21",  round(objData110.А474_18_1/1000, 0, 2),
                         "N1_A22",  round(objData110.А9_2/1000, 0, 2),
                         "N1_A23",  round(objData110.А9_3/1000, 0, 2),
                         "N1_A24",  round(objData110.А12/1000, 0, 2),
                         "N1_A25",  round(objData110.А18_4/1000, 0, 2),
                         "N1_A26",  round(objData110.А18_5/1000, 0, 2),
                         "N1_A27",  round(objData110.S155_16/1000, 0, 2),
                         "N1_A28",  round(objData110.S175_16/1000, 0, 2),
                         "N1_A29",  round(objData110.S156_17/1000, 0, 2),
                         "N1_A30",  round(objData110.S176_17/1000, 0, 2),
                         "N1_A31",  round(objData110.S_4_1/1000, 0, 2),
                         "N1_A32",  round(objData110.S_4_2/1000, 0, 2),
                         "N1_A33",  round(objData110.S375_16/1000, 0, 2),
                         "N1_A34",  round(objData110.S385_16/1000, 0, 2),
                         "N1_A35",  round(objData110.S376_17/1000, 0, 2),
                         "N1_A36",  round(objData110.S386_17/1000, 0, 2),
                         "N1_A37",  round(objData110.S_4_3/1000, 0, 2),
                         "N1_A38",  round(objData110.S_4_4/1000, 0, 2),
                         "N1_A39",  round(objData110.S_4_5/1000, 0, 2),
                         "N1_A40",  round(objData110.S_4_6/1000, 0, 2)
                       );


      PrintFormatString( NULL,
                         "N1_FIO_Boss",     {FIO_Boss},
                         "N1_FIO_Book",     {FIO_Book},
                         "N1_FIO_Oper",     GetNameOper(),
                         "N1_PhoneNumber",  Номер_телефона,
                         "N1_day",          curr_day,
                         "N1_month_year",   month_name+" "+curr_year
                       );
    
    
      if(CheckRepPart2 == SET_CHAR)
      if( (RepPart == "Все" ) OR (RepPart == " I"))    // по первой части

      SetActiveSheet("Проверочный отчет (1 раздел)");
        PrintFormatString( NULL,
                          "N2_1_BegDate", BegDate,
                          "N2_1_EndDate", EndDate
                        );

        RegisterTable( "N2_1_MainTable", "",
                       "N2_1_A1",                    
                       "N2_1_A2",
                       "N2_1_A3",
                       "N2_1_A4",
                       "N2_1_A5",
                       "N2_1_A6",
                       "N2_1_A7",
                       "N2_1_A8",
                       "N2_1_A9",
                       "N2_1_A10",
                       "N2_1_A11",
                       "N2_1_A12",
                       "N2_1_A13",
                       "N2_1_A14",
                       "N2_1_A15",
                       "N2_1_A16",
                       "N2_1_A17",
                       "N2_1_A18",
                       "N2_1_A19",
                       "N2_1_A20"
                     );
        objData110ProtocolPart1 = C_110_Secur_Protocol_Part1(BegDate, EndDate, KINDPORT_SSPU);

        while(objData110ProtocolPart1.GetNext())
          if(objData110ProtocolPart1.IsItogLine == true)
            PaintProtocolStrN2_1();
          end;
            PrintTableLine("N2_1_A1",  objData110ProtocolPart1.Date_,                       null,
                           "N2_1_A2",  objData110ProtocolPart1.PortfolioCode,               null,
                           "N2_1_A3",  objData110ProtocolPart1.AccountA3,                   null,
                           "N2_1_A4",  objData110ProtocolPart1.IssuerShortName,             null,
                           "N2_1_A5",  objData110ProtocolPart1.AvrKindName,                 null,
                           "N2_1_A6",  objData110ProtocolPart1.ISIN,                        null,
                           "N2_1_A7",  objData110ProtocolPart1.FaceValueFI_ISO,             null,
                           "N2_1_A8",  objData110ProtocolPart1.FaceValue,                   null,
                           "N2_1_A9",  objData110ProtocolPart1.Amount,                      null,
                           "N2_1_A10", objData110ProtocolPart1.SumCost,                     null,
                           "N2_1_A11", objData110ProtocolPart1.AccountA11,                  null,
                           "N2_1_A12", objData110ProtocolPart1.SumReservAmount,             null,
                           "N2_1_A13", objData110ProtocolPart1.AccountA13,                  null,
                           "N2_1_A14", objData110ProtocolPart1.SumCorrEstReserv_Prc,        null,
                           "N2_1_A15", objData110ProtocolPart1.SumInv,                      null,
                           "N2_1_A16", "",                                                  null,
                           "N2_1_A17", objData110ProtocolPart1.SumReserv,                   null,
                           "N2_1_A18", "",                                                  null,
                           "N2_1_A19", objData110ProtocolPart1.SumCorRestReserve,           null,
                           "N2_1_A20", "",                                                  null
                         );
          if(objData110ProtocolPart1.IsItogLine == false)
            if( not((objData110ProtocolPart1.AccountA3_1 == "") AND (objData110ProtocolPart1.SumNKDAmount == 0)))

              PrintTableLine("N2_1_A1", "",                                            null,                   
                             "N2_1_A2", "",                                            null,
                             "N2_1_A3", objData110ProtocolPart1.AccountA3_1,           null,
                             "N2_1_A4", "",                                            null, 
                             "N2_1_A5", "",                                            null,     
                             "N2_1_A6", "",                                            null,            
                             "N2_1_A7", "",                                            null, 
                             "N2_1_A8", "",                                            null,       
                             "N2_1_A9", "",                                            null,          
                             "N2_1_A10", objData110ProtocolPart1.SumNKDAmount,         null,
                             "N2_1_A11", "",                                           null,
                             "N2_1_A12", "",                                           null,
                             "N2_1_A13", "",                                           null,
                             "N2_1_A14", "",                                           null,
                             "N2_1_A15", "",                                           null,
                             "N2_1_A16", "",                                           null,
                             "N2_1_A17", "",                                           null,
                             "N2_1_A18", "",                                           null,
                             "N2_1_A19", "",                                           null,
                             "N2_1_A20", "",                                           null
                           );
            end;
            if( not((objData110ProtocolPart1.AccountA3_2 == "") AND (objData110ProtocolPart1.SumInterestIncome == 0) 
                AND (objData110ProtocolPart1.AccountA11_1 == "") AND (objData110ProtocolPart1.SumIncomeReserv == 0 ) AND (objData110ProtocolPart1.SumCorrEstReserv_Inv == 0)))

              PrintTableLine("N2_1_A1", "",                                            null,                   
                             "N2_1_A2", "",                                            null,
                             "N2_1_A3", objData110ProtocolPart1.AccountA3_2,           null,
                             "N2_1_A4", "",                                            null, 
                             "N2_1_A5", "",                                            null,     
                             "N2_1_A6", "",                                            null,            
                             "N2_1_A7", "",                                            null, 
                             "N2_1_A8", "",                                            null,       
                             "N2_1_A9", "",                                            null,          
                             "N2_1_A10", objData110ProtocolPart1.SumInterestIncome,    null,
                             "N2_1_A11", objData110ProtocolPart1.AccountA11_1,         null,
                             "N2_1_A12", objData110ProtocolPart1.SumIncomeReserv,      null,
                             "N2_1_A13", "",                                           null,
                             "N2_1_A14", objData110ProtocolPart1.SumCorrEstReserv_Inv, null,
                             "N2_1_A15", "",                                           null,
                             "N2_1_A16", "",                                           null,
                             "N2_1_A17", "",                                           null,
                             "N2_1_A18", "",                                           null,
                             "N2_1_A19", "",                                           null,
                             "N2_1_A20", "",                                           null
                           );
            end;
            if( not((objData110ProtocolPart1.AccountA3_3 == "") AND (objData110ProtocolPart1.SumDiscountIncome == 0)))

              PrintTableLine("N2_1_A1", "",                                            null,                   
                             "N2_1_A2", "",                                            null,
                             "N2_1_A3", objData110ProtocolPart1.AccountA3_3,           null,
                             "N2_1_A4", "",                                            null, 
                             "N2_1_A5", "",                                            null,     
                             "N2_1_A6", "",                                            null,            
                             "N2_1_A7", "",                                            null, 
                             "N2_1_A8", "",                                            null,       
                             "N2_1_A9", "",                                            null,          
                             "N2_1_A10", objData110ProtocolPart1.SumDiscountIncome,    null,
                             "N2_1_A11", "",                                           null,
                             "N2_1_A12", "",                                           null,
                             "N2_1_A13", "",                                           null,
                             "N2_1_A14", "",                                           null,
                             "N2_1_A15", "",                                           null,
                             "N2_1_A16", "",                                           null,
                             "N2_1_A17", "",                                           null,
                             "N2_1_A18", "",                                           null,
                             "N2_1_A19", "",                                           null,
                             "N2_1_A20", "",                                           null
                           );
            end;
          end;
        end;

        objData110ProtocolPart1 = C_110_Secur_Protocol_Part1(BegDate, EndDate, KINDPORT_SSSD);

        while(objData110ProtocolPart1.GetNext())
          if(objData110ProtocolPart1.IsItogLine == true)
            PaintProtocolStrN2_1();
          end;
            PrintTableLine("N2_1_A1", objData110ProtocolPart1.Date_,                       null,
                           "N2_1_A2", objData110ProtocolPart1.PortfolioCode,               null,
                           "N2_1_A3", objData110ProtocolPart1.AccountA3,                   null,
                           "N2_1_A4", objData110ProtocolPart1.IssuerShortName,             null,
                           "N2_1_A5", objData110ProtocolPart1.AvrKindName,                 null,
                           "N2_1_A6", objData110ProtocolPart1.ISIN,                        null,
                           "N2_1_A7", objData110ProtocolPart1.FaceValueFI_ISO,             null,
                           "N2_1_A8", objData110ProtocolPart1.FaceValue,                   null,
                           "N2_1_A9", objData110ProtocolPart1.Amount,                      null,
                           "N2_1_A10", objData110ProtocolPart1.SumCost,                    null,
                           "N2_1_A11", objData110ProtocolPart1.AccountA11,                 null,
                           "N2_1_A12", objData110ProtocolPart1.SumReservAmount,            null,
                           "N2_1_A13", objData110ProtocolPart1.AccountA13,                 null,
                           "N2_1_A14", objData110ProtocolPart1.SumCorrEstReserv_Prc,       null,
                           "N2_1_A15", "",                                                 null,
                           "N2_1_A16", objData110ProtocolPart1.SumInv,                     null,
                           "N2_1_A17", "",                                                 null,
                           "N2_1_A18", objData110ProtocolPart1.SumReserv,                  null,
                           "N2_1_A19", "",                                                 null,
                           "N2_1_A20", objData110ProtocolPart1.SumCorRestReserve,          null
                         );
          if(objData110ProtocolPart1.IsItogLine == false)
            if( not((objData110ProtocolPart1.AccountA3_1 == "") AND (objData110ProtocolPart1.SumNKDAmount == 0)))

              PrintTableLine("N2_1_A1", "",                                            null,                   
                             "N2_1_A2", "",                                            null,
                             "N2_1_A3", objData110ProtocolPart1.AccountA3_1,           null,
                             "N2_1_A4", "",                                            null, 
                             "N2_1_A5", "",                                            null,     
                             "N2_1_A6", "",                                            null,            
                             "N2_1_A7", "",                                            null, 
                             "N2_1_A8", "",                                            null,       
                             "N2_1_A9", "",                                            null,          
                             "N2_1_A10", objData110ProtocolPart1.SumNKDAmount,         null,
                             "N2_1_A11", "",                                           null,
                             "N2_1_A12", "",                                           null,
                             "N2_1_A13", "",                                           null,
                             "N2_1_A14", "",                                           null,
                             "N2_1_A15", "",                                           null,
                             "N2_1_A16", "",                                           null,
                             "N2_1_A17", "",                                           null,
                             "N2_1_A18", "",                                           null,
                             "N2_1_A19", "",                                           null,
                             "N2_1_A20", "",                                           null
                           );
            end;
            if( not((objData110ProtocolPart1.AccountA3_2 == "") AND (objData110ProtocolPart1.SumInterestIncome == 0) 
                AND (objData110ProtocolPart1.AccountA11_1 == "") AND (objData110ProtocolPart1.SumIncomeReserv == 0 ) AND (objData110ProtocolPart1.SumCorrEstReserv_Inv == 0)))
              PrintTableLine("N2_1_A1", "",                                            null,                   
                             "N2_1_A2", "",                                            null,
                             "N2_1_A3", objData110ProtocolPart1.AccountA3_2,           null,
                             "N2_1_A4", "",                                            null, 
                             "N2_1_A5", "",                                            null,     
                             "N2_1_A6", "",                                            null,            
                             "N2_1_A7", "",                                            null, 
                             "N2_1_A8", "",                                            null,       
                             "N2_1_A9", "",                                            null,          
                             "N2_1_A10", objData110ProtocolPart1.SumInterestIncome,    null,
                             "N2_1_A11", objData110ProtocolPart1.AccountA11_1,         null,
                             "N2_1_A12", objData110ProtocolPart1.SumIncomeReserv,      null,
                             "N2_1_A13", "",                                           null,
                             "N2_1_A14", objData110ProtocolPart1.SumCorrEstReserv_Inv, null,
                             "N2_1_A15", "",                                           null,
                             "N2_1_A16", "",                                           null,
                             "N2_1_A17", "",                                           null,
                             "N2_1_A18", "",                                           null,
                             "N2_1_A19", "",                                           null,
                             "N2_1_A20", "",                                           null
                           );
            end;
            if( not((objData110ProtocolPart1.AccountA3_3 == "") AND (objData110ProtocolPart1.SumDiscountIncome == 0)))
              PrintTableLine("N2_1_A1", "",                                            null,                   
                             "N2_1_A2", "",                                            null,
                             "N2_1_A3", objData110ProtocolPart1.AccountA3_3,           null,
                             "N2_1_A4", "",                                            null, 
                             "N2_1_A5", "",                                            null,     
                             "N2_1_A6", "",                                            null,            
                             "N2_1_A7", "",                                            null, 
                             "N2_1_A8", "",                                            null,       
                             "N2_1_A9", "",                                            null,          
                             "N2_1_A10", objData110ProtocolPart1.SumDiscountIncome,    null,
                             "N2_1_A11", "",                                           null,
                             "N2_1_A12", "",                                           null,
                             "N2_1_A13", "",                                           null,
                             "N2_1_A14", "",                                           null,
                             "N2_1_A15", "",                                           null,
                             "N2_1_A16", "",                                           null,
                             "N2_1_A17", "",                                           null,
                             "N2_1_A18", "",                                           null,
                             "N2_1_A19", "",                                           null,
                             "N2_1_A20", "",                                           null
                           );
            end;
          end;
        end;
        EndTable();

      end;
      if( (RepPart == "Все" ) OR (RepPart == "II"))    // по второй части

        SetActiveSheet("Проверочный отчет (2 раздел)");

        m_CurrStrNum      = STARTROWNUM;
        m_CurrStartStrNum = STARTROWNUM;

        PrintFormatString( NULL,
                          "N2_BegDate", BegDate,
                          "N2_EndDate", EndDate
                        );

        RegisterTable( "N2_MainTable", "",
                       "N2_A1",                    
                       "N2_A2",
                       "N2_A3",
                       "N2_A4",
                       "N2_A5",
                       "N2_A6",
                       "N2_A7",
                       "N2_A8",
                       "N2_A9",
                       "N2_A10",
                       "N2_A11",
                       "N2_A12",
                       "N2_A13",
                       "N2_A14",
                       "N2_A15",
                       "N2_A16",
                       "N2_A17",
                       "N2_A18",
                       "N2_A19",
                       "N2_A20",
                       "N2_A21",
                       "N2_A22",
                       "N2_A23",
                       "N2_A24",
                       "N2_A25"
                     );

        objData110Protocol = C_110_Secur_Protocol(BegDate, EndDate);
        while(objData110Protocol.GetNext())

          var str_prc = FormulaROUND()+"("+FormulaABS()+"("+GetAddr(C_CARRYSUM)+")"+
                                    "/("  +GetAddr(C_COST)+
                                       "+"+GetAddr(C_NKDAMOUNT)+
                                       "+"+GetAddr(C_INTERESTINCOME)+
                                       "+"+GetAddr(C_DISCOUNTINCOME)+
                                       "+"+GetAddr(C_CORRVALUE)+
                                       "+"+GetAddr(C_CORRINTTOEIR)+
                                     ")*("  +GetAddr(C_INTERESTINCOME)+
                                         "+"+GetAddr(C_DISCOUNTINCOME)+
                                   ");2)";

          if(objData110Protocol.IsItogLine == false)

            if(m_CurrStartStrNum == 0)
              m_CurrStartStrNum = m_CurrStrNum;
            end;

            f_S385_16 = F(FormulaIF()+"("+FormulaAND()+"("+GetAddr(C_PORTFOLIO)+"=\"СССД\";"+GetAddr(C_CARRYSUM)+">0);"+
                                        GetAddr(C_CARRYSUM)+"-"+GetAddr(C_S_4_4)+";"+
                                        ""+
                                      ")"
                         );



            f_S386_17 = F(FormulaIF()+"("+FormulaAND()+"("+GetAddr(C_PORTFOLIO)+"=\"АС\";"+GetAddr(C_CARRYSUM)+">0);"+
                                        GetAddr(C_CARRYSUM)+"-"+GetAddr(C_S_4_4)+";"+
                                        ""+
                                      ")"
                         );


            f_S175_16 = F(FormulaIF()+"("+FormulaAND()+"("+GetAddr(C_PORTFOLIO)+"=\"СССД\";"+GetAddr(C_CARRYSUM)+"<0);"+
                                        FormulaABS()+"("+GetAddr(C_CARRYSUM)+")"+"-"+GetAddr(C_S_4_2)+";"+
                                        ""+
                                      ")"
                         );


            f_S176_17 = F(FormulaIF()+"("+FormulaAND()+"("+GetAddr(C_PORTFOLIO)+"=\"АС\";"+GetAddr(C_CARRYSUM)+"<0);"+
                                        FormulaABS()+"("+GetAddr(C_CARRYSUM)+")"+"-"+GetAddr(C_S_4_2)+";"+
                                        ""+
                                      ")"
                         );

            f_S_4_4 = F(FormulaIF()+"("+GetAddr(C_CARRYSUM)+">0;"+
                                      str_prc+";"+
                                      ""+
                                    ")"
                         );

            f_S_4_2 = F(FormulaIF()+"("+GetAddr(C_CARRYSUM)+"<0;"+
                                      str_prc+";"+
                                      ""+
                                    ")"
                       );
          else
            //PaintProtocolStr();

            if(objData110Protocol.IsLastLine == false)
              if (m_CurrStartStrNum == 0)
                m_CurrStartStrNum = m_CurrStrNum - 1;
              end;

              f_S385_16 = F(FormulaSUM()+"("+GetAddr(C_S385_16, m_CurrStartStrNum)+":"+GetAddr(C_S385_16, m_CurrStrNum-1)+")");
              f_S386_17 = F(FormulaSUM()+"("+GetAddr(C_S386_17, m_CurrStartStrNum)+":"+GetAddr(C_S386_17, m_CurrStrNum-1)+")");
              f_S175_16 = F(FormulaSUM()+"("+GetAddr(C_S175_16, m_CurrStartStrNum)+":"+GetAddr(C_S175_16, m_CurrStrNum-1)+")");
              f_S176_17 = F(FormulaSUM()+"("+GetAddr(C_S176_17, m_CurrStartStrNum)+":"+GetAddr(C_S176_17, m_CurrStrNum-1)+")");
              f_S_4_4   = F(FormulaSUM()+"("+GetAddr(C_S_4_4  , m_CurrStartStrNum)+":"+GetAddr(C_S_4_4  , m_CurrStrNum-1)+")");
              f_S_4_2   = F(FormulaSUM()+"("+GetAddr(C_S_4_2  , m_CurrStartStrNum)+":"+GetAddr(C_S_4_2  , m_CurrStrNum-1)+")");

              tf_S385_16 = tf_S385_16 + IIF(tf_S385_16 != "", ";", "") + GetAddr(C_S385_16);
              tf_S386_17 = tf_S386_17 + IIF(tf_S386_17 != "", ";", "") + GetAddr(C_S386_17);
              tf_S175_16 = tf_S175_16 + IIF(tf_S175_16 != "", ";", "") + GetAddr(C_S175_16);
              tf_S176_17 = tf_S176_17 + IIF(tf_S176_17 != "", ";", "") + GetAddr(C_S176_17);
              tf_S_4_4   = tf_S_4_4   + IIF(tf_S_4_4   != "", ";", "") + GetAddr(C_S_4_4  );
              tf_S_4_2   = tf_S_4_2   + IIF(tf_S_4_2   != "", ";", "") + GetAddr(C_S_4_2  );

              m_CurrStartStrNum = 0;
            else
              f_S385_16 = F(FormulaSUM()+"("+tf_S385_16+")");
              f_S386_17 = F(FormulaSUM()+"("+tf_S386_17+")");
              f_S175_16 = F(FormulaSUM()+"("+tf_S175_16+")");
              f_S176_17 = F(FormulaSUM()+"("+tf_S176_17+")");
              f_S_4_4   = F(FormulaSUM()+"("+tf_S_4_4+")");
              f_S_4_2   = F(FormulaSUM()+"("+tf_S_4_2+")");
            end;
          end;

          //SetRowHeight(m_CurrStrNum, 12);

          PrintTableLine("N2_A1",  objData110Protocol.Date_Carry,        null,
                         "N2_A2",  objData110Protocol.Numb_Document,     null,
                         "N2_A3",  objData110Protocol.PortfolioCode,     null,
                         "N2_A4",  objData110Protocol.IssuerShortName,   null,
                         "N2_A5",  objData110Protocol.AvrKindName,       null,
                         "N2_A6",  objData110Protocol.ISIN,              null,
                         "N2_A7",  objData110Protocol.FaceValueFI_ISO,   null,
                         "N2_A8",  objData110Protocol.FaceValue,         null,
                         "N2_A9",  objData110Protocol.SumAmount,         null,
                         "N2_A10", objData110Protocol.SumCost,           null,
                         "N2_A11", objData110Protocol.SumNKDAmount,      null,
                         "N2_A12", objData110Protocol.SumInterestIncome, null,
                         "N2_A13", objData110Protocol.SumDiscountIncome, null,
                         "N2_A14", objData110Protocol.SumOutlay,         null,
                         "N2_A15", objData110Protocol.SumCorrValue,      null,
                         "N2_A16", objData110Protocol.SumCorrIntToEIR,   null,
                         "N2_A17", objData110Protocol.Account_Payer,     null,
                         "N2_A18", objData110Protocol.Account_Receiver,  null,
                         "N2_A19", objData110Protocol.Carry_Sum,         null,
                         "N2_A20", f_S385_16,                            null,
                         "N2_A21", f_S386_17,                            null,
                         "N2_A22", f_S175_16,                            null,
                         "N2_A23", f_S176_17,                            null,
                         "N2_A24", f_S_4_4,                              null,
                         "N2_A25", f_S_4_2,                              null
                        );

          m_CurrStrNum = m_CurrStrNum + 1;
        end;

        EndTable();
      end;


        SetActiveSheet("Справочная информация");
        
        RegisterTable( "N3_MainTable", "",
                       "N3_A1",                    
                       "N3_A2",
                       "N3_A3",
                       "N3_A4",
                       "N3_A5",
                       "N3_A6"
                     );

        objData110RefInf = C_110_Secur_RefInf(BegDate, EndDate);
        while(objData110RefInf.GetNext())

          PrintTableLine("N3_A1", objData110RefInf.Date_Carry,       null,
                         "N3_A2", objData110RefInf.Numb_Document,    null,
                         "N3_A3", objData110RefInf.Account_Payer,    null,
                         "N3_A4", objData110RefInf.Account_Receiver, null,
                         "N3_A5", objData110RefInf.Carry_Sum,        null,
                         "N3_A6", objData110RefInf.Ground,           null
                        );
        end;

        EndTable();

      end;
    
    end;
     
  END;

  initDL_CReportTemplate( SCF110_Panel(), "Report_scf110.xlsx", true, null, null, true, true );
END;

SP_F110_Report().Run();
exit(1);
