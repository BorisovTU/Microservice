/*
$Name:        npform1.mac
$Module:      Ценные бумаги
$Description: Отчет "Форма 1-НДФЛ"
*/
import "DlRepForm_h.mac", "secinter.mac", "sprepfun.mac";

PRIVATE CONST POI_MODE = TRUE;

PRIVATE CONST 
      NumOurCountry = "643";

PRIVATE CONST 
      Резидент   = 1,
      НеРезидент = 2;

PRIVATE CONST SelCodeKind = 1;

PRIVATE CONST 
      PNFLD_NPFORM1_ENDDATE         = 0,
      PNFLD_NPFORM1_INVERSTORCODE   = 1,
      PNFLD_NPFORM1_INVERSTORNAME   = 2,
      PNFLD_NPFORM1_PRINTMETHOD     = 3,
      PNFLD_NPFORM1_PARTLY_EXCEL    = 4,
      PNFLD_SHEETS_MAX_COUNT        = 5;

PRIVATE CONST
      DL_PNFLD_NPFORM1_ENDDATE         = 100,
      DL_PNFLD_NPFORM1_INVERSTORCODE   = 101,
      DL_PNFLD_NPFORM1_INVERSTORNAME   = 102,
      DL_PNFLD_NPFORM1_PRINTMETHOD     = 103,
      DL_PNFLD_NPFORM1_PARTLY_EXCEL    = 104,
      DL_PNFLD_SHEETS_MAX_COUNT        = 105;

PRIVATE CONST 
      Доход = 1,
      Вычет = 2;

PRIVATE CONST 
      PLUSG_STR   = "PlusG_",
      MINUSG_STR  = "MinusG_";

PRIVATE CONST ClientInfo = 
"СВЕДЕНИЯ О НАЛОГОПЛАТЕЛЬЩИКЕ (ПОЛУЧАТЕЛЕ ДОХОДОВ)\n"+
"2. Данные о физическом лице - получателе дохода\n"+
"2.1. ИНН ############   2.2. Фамилия, имя, отчество ####################################################################################################\n"+
"2.3. Статус налогоплательщика #  2.4. Дата рождения ##########\n"+
"2.5. Гражданство (код страны) ###\n"+
"2.6. Код документа, удостоверяющего личность ####################\n"+
"2.7. Серия и номер ##############################\n"+
"2.8. Адрес места жительства в Российской Федерации:  почтовый индекс ######\n"+
"    код региона ##\n"+
"    район ############################## город ############################## населенный пункт ##############################\n"+
"    Улица ######################################## Дом #### Корпус #### Квартира ####\n"+
"2.9. Адрес в стране проживания: Код страны ### Адрес ##############################\n";

PRIVATE CONST TaxSumItog =
"\nОБЩАЯ СУММА НАЛОГА ПО ИТОГАМ НАЛОГОВОГО ПЕРИОДА\n"+                            
"┌──────────────────┬───────────────────────────────────────┬───────────────────────────────────────┐\n"+
"│                  │ Общая сумма налога                    │  Долг по налогу                       │\n"+
"│ Показатели       ├───────────────────┬───────────────────┼───────────────────┬───────────────────┤\n"+
"│                  │ Исчисленная       │ Удержанная        │  За налогоплатель-│ За налоговым      │\n"+
"│                  │                   │                   │  щиком            │ агентом           │\n"+
"├──────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┤\n"+
"│ По  ставке 9%    │ ##################│ ##################│ ##################│ ##################│\n"+
"├──────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┤\n"+
"│ По  ставке 13%   │ ##################│ ##################│ ##################│ ##################│\n"+
"├──────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┤\n"+
"│ По  ставке 15%   │ ##################│ ##################│ ##################│ ##################│\n"+
"├──────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┤\n"+
"│ По  ставке 30%   │ ##################│ ##################│ ##################│ ##################│\n"+
"├──────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┤\n"+
"│    Итого         │ ##################│ ##################│ ##################│ ##################│\n"+
"└──────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┘\n";

MACRO GetClientShortName(ClientID:Integer):String
   var NameQuery = "select party.t_ShortName " +
                   "from dparty_dbt party " +
                   "where party.t_PartyID = ? ";

   var NameCmd = DL_RSDCommand(NameQuery);
   NameCmd.AddParam(ClientID);
   
   var NameDS = NameCmd.Execute();
   
   if(NameDS.MoveNext())
      return NameDS.ShortName;
   end;
   
   return "";
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  end;
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
END;

MACRO DL_FldProc_Client_SSD_Code_NPTXFORM1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER

  var Party     = TRecHandler("party.dbt");
  var partcode  = TBFile( "partcode.dbt",  "R", 0 );
  var whereCond:string  = "";

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;

     if( ((ValType(FldRealValue) == V_INTEGER) and (FldRealValue <= 0)) or ((ValType(FldRealValue) == V_GENOBJ) and (FldRealValue.Size() == 0)) )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( DL_PNFLD_NPFORM1_INVERSTORNAME, STR_ALLVALUE);
     else
        partcode.Clear();
        partcode.rec.PartyID  = FldRealValue[0];
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
        end;

        if( not ПолучитьСубъекта(FldRealValue, Party) )
           pThis.SetLinkedValue( DL_PNFLD_NPFORM1_INVERSTORNAME, Party.rec.ShortName);
        end;
     end;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     pThis.SetLinkedValue( DL_PNFLD_NPFORM1_INVERSTORNAME, STR_ALLVALUE );

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )

     whereCond = "     t.t_LegalForm = 2"
               + " AND t.T_PARTYID IN ( SELECT c2.T_PARTYID"
               + "                        FROM dclient_dbt c2"
               + "                       WHERE     t.T_PARTYID = c2.T_PARTYID"
               + "                             AND c2.t_servicekind IN (" + string(PTSK_STOCKDL) + ", "
               +                                                            string(PTSK_DV) + ", "
               +                                                            string(PTSK_SVO) + ", "
               +                                                            string(PTSK_DEPOS) + ")"
               + "                    )";

     if (Report_Kind != null)
       whereCond = " (( " + whereCond + " ) OR ( " + get_RepCond() + " )) ";
     end;

     var PartyIDArray = TArray();
     if( ListPText( Party, Party.rec.PartyID, whereCond, NULL, NULL, PartyIDArray) == true )
        if((PartyIDArray.Size() == 0) and (Party.rec.PartyID > 0))
           PartyIDArray[0] = Party.rec.PartyID;
        end;
        FldRealValue = PartyIDArray;
        partcode.Clear();
        partcode.rec.PartyID  = Party.rec.PartyID;
        partcode.rec.CodeKind = SelCodeKind;
        if (partcode.GetEQ())
          FldShowValue = partcode.rec.Code;
        end;
        var PartyQuery = "select t_ShortName from dparty_dbt where t_PartyID in (";
        var PartyCmd = DL_RSDCommand();
        var i = 0;
        while(i < PartyIDArray.Size())
           if(i > 0)
              PartyQuery = PartyQuery + ", ?";
           else
              PartyQuery = PartyQuery + "?";
           end;
           PartyCmd.AddParam(PartyIDArray[i]);

           i = i + 1;
        end;
        PartyQuery = PartyQuery + ")";
        var PartyDS = PartyCmd.Execute(PartyQuery);
        var Names = "";
        if(PartyDS.MoveNext())
           Names = Names + PartyDS.ShortName;
        end;
        
        while(PartyDS.MoveNext())
           Names = Names + ", " + PartyDS.ShortName;
        end;
        pThis.SetLinkedValue( DL_PNFLD_NPFORM1_INVERSTORNAME, Names);
     end;
  end;

  return CM_DEFAULT;
END;

MACRO DL_FldProc_Client_SSD_Name_NPTXFORM1(pThis:DL_CPanel, Cmd:Integer, Key:Integer, FldShowValue:@variant, FldRealValue:@variant)
   var Clients = pThis.GetLinkedValue(DL_PNFLD_NPFORM1_INVERSTORCODE);
   var i:integer = 0;

   if(Cmd == DLG_INIT)
      if((Clients == NULL) or ((ValType(Clients) == V_GENOBJ) and (Clients.Size == 0)) or ((ValType(Clients) == V_INTEGER) and (Clients < 0)))
         Clients = -1;
      end;

      if((ValType(Clients) == V_INTEGER) and (Clients < 0))
         FldShowValue = STR_ALLVALUE;
      else
         if(ValType(Clients) == V_GENOBJ)
            i = 0;
            while(i < Clients.Size)
               if(i > 0)
                  FldShowValue = FldShowValue + ", " + GetClientShortName(Clients[i]);
               elif(i == 0)
                  FldShowValue = GetClientShortName(Clients[i]);
               end;
               i = i + 1;
            end;
         end;
      end;
   elif(Cmd == DLG_CHANGEVALUE)
      FldShowValue = FldRealValue;
   end;
END;

MACRO FldProc_NPForm1_PrintMethod( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
   MACRO Name( Id:INTEGER )
      if( Id == DL_OUTREPORT_STD )
         return "Стандартный";
      elif( Id == DL_OUTREPORT_EXCEL )
         return "Excel";
      end;                                           
      return "";
   END;

   if( Cmd == DLG_INIT ) /*Установка значения в поле*/
      if( FldRealValue == null ) /*инициализация по умолчанию*/
         FldRealValue = DL_OUTREPORT_STD;
      end;
      FldShowValue = Name(FldRealValue);

   elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
      if(FldRealValue == DL_OUTREPORT_EXCEL)
         EnableFields(pThis.Data(), PNFLD_NPFORM1_PARTLY_EXCEL);
      else
         DisableFields(pThis.Data(), PNFLD_NPFORM1_PARTLY_EXCEL);
         DisableFields(pThis.Data(), PNFLD_SHEETS_MAX_COUNT);
         pThis.SetLinkedValue(DL_PNFLD_NPFORM1_PARTLY_EXCEL, UNSET_CHAR);
      end;
   elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
      DL_ListString( null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                     Name(DL_OUTREPORT_STD),  DL_OUTREPORT_STD,
                     Name(DL_OUTREPORT_EXCEL),DL_OUTREPORT_EXCEL
                   );
   end;
   return CM_DEFAULT;
END;

MACRO DL_FldProc_Partly_Excel(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
   if( Cmd == DLG_INIT )
      if( FldRealValue == null ) /*инициализация по умолчанию*/
         FldRealValue = UNSET_CHAR;
      end;
      FldShowValue = FldRealValue;
   elif( Cmd == DLG_CHANGEVALUE )
      FldRealValue = FldShowValue;
      if(FldRealValue == SET_CHAR)
         EnableFields(pThis.Data(), PNFLD_SHEETS_MAX_COUNT);
      else
         DisableFields(pThis.Data(), PNFLD_SHEETS_MAX_COUNT);
      end;
   elif( Cmd == DLG_KEY )
      if( Key == KEY_SPACE )
         if( FldRealValue != SET_CHAR )
            FldShowValue = FldRealValue = SET_CHAR;
         else
            FldShowValue = FldRealValue = UNSET_CHAR;
         end;
      end;
   end;
   return CM_DEFAULT;
END;

PRIVATE CLASS (DL_CPanel) Sp_NPFORM1_Panel()

  var m_IsPartlyReport = false;

  PRIVATE MACRO Init()
     VAR Year, EndDate;

     DateSplit( {curdate}, null, null, Year );
     EndDate = Date(31,12,Year-1);

     AddFieldProc( 0, PNFLD_NPFORM1_ENDDATE,        DL_PNFLD_NPFORM1_ENDDATE,         @DL_FldProc_EndDate, EndDate );
     AddFieldProc( 0, PNFLD_NPFORM1_INVERSTORCODE,  DL_PNFLD_NPFORM1_INVERSTORCODE,   @DL_FldProc_Client_SSD_Code_NPTXFORM1 );
     AddFieldProc( 0, PNFLD_NPFORM1_INVERSTORNAME,  DL_PNFLD_NPFORM1_INVERSTORNAME,   @DL_FldProc_Client_SSD_Name_NPTXFORM1 );
     AddFieldProc( 0, PNFLD_NPFORM1_PRINTMETHOD,    DL_PNFLD_NPFORM1_PRINTMETHOD,     @FldProc_NPForm1_PrintMethod, DL_OUTREPORT_EXCEL, 30, 7 );
     AddFieldProc( 0, PNFLD_NPFORM1_PARTLY_EXCEL,   DL_PNFLD_NPFORM1_PARTLY_EXCEL,    @DL_FldProc_Partly_Excel);
     AddFieldProc( 0, PNFLD_SHEETS_MAX_COUNT,       DL_PNFLD_SHEETS_MAX_COUNT,        @Default, 500 );
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel( "sp_rep.lbr", "npform1" );
END;

PRIVATE CLASS (DL_CReportTemplate) Sp_npform1_Report
  var m_EndDate, m_ClientID, m_Nrec, m_Client, m_OperDate, m_BegDate, m_CurrYear;
  var m_ClientRec = null;
  var m_TaxToReturn, m_TaxDue, m_TaxPaid, m_TaxCalculated, m_TaxBaseSum;
  var m_PlusG = TArray(), m_MinusG = TArray();
  var m_sizePlusG = 0, m_sizeMinusG = 0;
  var m_DataClient, m_DataOper, m_IsPrintFirstCol = false, 
      m_NumCol = 0, m_YPastClnt = 0;
  var m_address_fact = null, m_address_jur = null, m_DocumentNumber, m_DocumentType, m_DateBirth;
  var m_Tax30ToReturn, m_Tax15ToReturn, m_Tax13ToReturn, m_Tax9ToReturn;
  var m_Tax30Due, m_Tax15Due, m_Tax13Due, m_Tax9Due;
  var m_Tax30Paid, m_Tax15Paid, m_Tax13Paid, m_Tax9Paid;
  var m_TaxGeneral, m_TaxSpecial, m_DivPaySec;
  var m_CurrSheetName, m_IsExistClientData = false, m_StrWinRep = "";
  var m_PaymentDate = null, m_PaymentNumber = null;
  var m_ExistsSheetsNames = TArray();
  var m_IsPartlyExcel = NULL;
  var m_MaxSheetsCount = 500;

  var TableOp =  "     (select txop.* from "+
                 "      (select nptxop.T_CLIENT, "+
                 "              (case when ( nptxop.T_DOCKIND = ? "+                                                                            
                 "               and nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
                 "               then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') "+
                 "               else nptxop.T_OPERDATE end) OPERDATE "+                                
                 "         from dnptxop_dbt nptxop "+ 
                 "        where nptxop.T_CLIENT = ? "+
                 "          and nptxop.T_DOCKIND in(?,?) "+ 
                 "          and ? <= "+
                 "              case when ( nptxop.T_DOCKIND = ? "+                                                               
                 "                          and nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
                 "              then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') else nptxop.T_OPERDATE end "+    
                 "          and ? >= "+                                                                                                          
                 "              case when ( nptxop.T_DOCKIND = ? "+                                                              
                 "                          and nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
                 "              then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') else nptxop.T_OPERDATE end "+
                 "      ) txop "+
                 "      group by txop.T_CLIENT, txop.OPERDATE "+
                 "      ) txop "+
                 " left join (select nptxobj.T_SUM0 SUM0, txkind.KindCode, nptxobj.T_CLIENT, nptxobj.T_DATE "+
                 "              from dnptxobj_dbt nptxobj, "+ 
                 "                   (select nptxkind.T_ELEMENT, "+
                 "                           nptxkind.T_CODE KindCode "+
                 "                      from dnptxkind_dbt nptxkind "+
                 "                     where (nptxkind.T_CODE like '"+PLUSG_STR+"%' or nptxkind.T_CODE like '"+MINUSG_STR+"%')) txkind "+
                 "             where nptxobj.T_KIND = txkind.T_ELEMENT "+
                 "               and nptxobj.T_CLIENT = ? "+
                 "            ) txobj on (txobj.T_CLIENT = txop.T_CLIENT "+
                 "                        and txobj.T_DATE between ? and txop.OPERDATE) ";

  CONST FORMULA  = "formula=";

  PRIVATE MACRO InitClientData()
     m_ClientRec      = null;
     m_address_fact   = null;
     m_address_jur    = null;
     m_DocumentNumber = null;
     m_DocumentType   = null;
     m_DateBirth      = null;
     m_IsPrintFirstCol = false;
     m_NumCol         = 0;
  END;

  PRIVATE MACRO InitDataTaxSum() 
     m_TaxToReturn   = null;
     m_TaxDue        = null;
     m_TaxPaid       = null;
     m_TaxCalculated = null;
     m_TaxBaseSum    = null;
     m_OperDate      = Date(0,0,0);
     m_Tax30ToReturn = null;
     m_Tax15ToReturn = null;
     m_Tax13ToReturn = null;
     m_Tax9ToReturn  = null;
     m_Tax30Due      = null;
     m_Tax15Due      = null;
     m_Tax13Due      = null;
     m_Tax9Due       = null;
     m_Tax30Paid     = null;
     m_Tax15Paid     = null;
     m_Tax13Paid     = null;
     m_Tax9Paid      = null;
     m_TaxGeneral    = null;
     m_TaxSpecial    = null;
     m_DivPaySec     = null;
  END;

  PRIVATE MACRO GetSheetName(Name1:String, Name2:String, Name3:String):String
     var Name = SubStr(Name1, 1, 20) + SubStr(Name2, 1, 1) + SubStr(Name3, 1, 1);
     var CountOfEquals = 0;
     var NameSheet = Name;

     var i = 0;
     while(i < m_ExistsSheetsNames.Size)
        if(StrUpr(NameSheet) == StrUpr(m_ExistsSheetsNames[i]))
           CountOfEquals = CountOfEquals + 1;
           NameSheet = SubStr(Name, 1, 31 - StrLen(CountOfEquals)) + CountOfEquals;
        end;
        i = i + 1;
     end;
     
     m_ExistsSheetsNames[m_ExistsSheetsNames.Size] = NameSheet;
     return NameSheet;
  END;

  PRIVATE MACRO BeginReport()
    m_EndDate  = m_Form.GetFieldValue( PNFLD_NPFORM1_ENDDATE );
    m_ClientID = m_Form.GetFieldValue( PNFLD_NPFORM1_INVERSTORCODE );

    DateSplit( m_EndDate, null, null, m_CurrYear );
    m_BegDate = Date(1,1,m_CurrYear);/*начало года*/
    Dl_CallInsertStat(PrintMode());
    CreateTotalBook();

    m_IsPartlyExcel = m_Form.GetFieldValue(PNFLD_NPFORM1_PARTLY_EXCEL);
    m_MaxSheetsCount = m_Form.GetFieldValue(PNFLD_SHEETS_MAX_COUNT);
  END;

  MACRO PrintMode():INTEGER
    return m_Form.GetFieldValue( PNFLD_NPFORM1_PRINTMETHOD );
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
    if( this.PrintMode() == DL_OUTREPORT_EXCEL )
       ReplaceAndCalculate( FORMULA, "=" );
    end;
  END;

  PRIVATE MACRO FormulaSUM():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "SUM";
     else
        RetVal = "СУММ";
     end;

     return RetVal;
  END;

  PRIVATE MACRO F( Str:string, Transform:bool ):string

     /* заменим разделитель целой и дробной частей */
     var DecimalSeparator = GetLocaleDecimalSeparator();
     var index_ = Index(Str,".");
     while( (index_ != 0) and (index_ <= strlen(Str)) )
        Str = substr(Str, 1, index_ - 1) + DecimalSeparator + substr(Str, index_ + 1, strlen(Str) - 1);
        index_ = Index(Str,".");
     end;

     return FORMULA + Str;
  END;

  PRIVATE MACRO GetOperCode(Code:string,Kind:integer):string
     return "Код "+substr(Code,strlen(IIF(Kind==Доход,PLUSG_STR,MINUSG_STR))+1);
  END;

  PRIVATE MACRO PrintClientInfo()
     PrintFormatString( ClientInfo, "ClientINN",       this.ClientINN(),
                                    "FIO",             this.FIO(),
                                    "ResidenceStatus", this.ResidenceStatus(),
                                    "DateBirth",       this.DateBirth(),
                                    "Citizenship",     this.Citizenship(),
                                    "DocumentType",    this.DocumentType(),
                                    "DocumentNumber",  this.DocumentNumber(),
                                    "MailIndex",       this.MailIndex(),
                                    "RegionCode",      this.RegionCode(),
                                    "District",        this.District(),
                                    "City",            this.City(),
                                    "Town",            this.Town(),
                                    "Street",          this.Street(),
                                    "House",           this.House(),
                                    "Building",        this.Building(),
                                    "Appartment",      this.Appartment(),
                                    "ResidenceCountry",this.ResidenceCountry(),
                                    "ResidenceAdress", this.ResidenceAdress()
                      );

     CopyAllSheetInTotalBook( "1НДФЛ", false, "ClientInfo", 0, m_CurrSheetName, true );
  END;

  PRIVATE MACRO PrintTaxSumItog()

     if( this.PrintMode() == DL_OUTREPORT_STD )/*стандартный режим*/
       PrintFormatString( TaxSumItog, 
                                      "Tax9Calculated",  this.Tax9Calculated(),
                                      "Tax9Paid",        this.Tax9Paid(),
                                      "Tax9Due",         this.Tax9Due(),
                                      "Tax9ToReturn",    this.Tax9ToReturn(),
                                      "Tax13Calculated", this.Tax13Calculated(),
                                      "Tax13Paid",       this.Tax13Paid(),
                                      "Tax13Due",        this.Tax13Due(),
                                      "Tax13ToReturn",   this.Tax13ToReturn(),
                                      "Tax15Calculated", this.Tax15Calculated(),
                                      "Tax15Paid",       this.Tax15Paid(),
                                      "Tax15Due",        this.Tax15Due(),
                                      "Tax15ToReturn",   this.Tax15ToReturn(),
                                      "Tax30Calculated", this.Tax30Calculated(),
                                      "Tax30Paid",       this.Tax30Paid(),
                                      "Tax30Due",        this.Tax30Due(),
                                      "Tax30ToReturn",   this.Tax30ToReturn(),
                                      "TaxTotCalculated",this.TotCalculated(),
                                      "TaxTotPaid",      this.TotPaid(),
                                      "TaxTotDue",       this.TotDue(),
                                      "TaxTotToReturn",  this.TotToReturn()
                        );
     else
       PrintFormatString( "", "Tax9Calculated",  this.Tax9Calculated(),
                              "Tax13Calculated", this.Tax13Calculated(),
                              "Tax15Calculated", this.Tax15Calculated(),
                              "Tax30Calculated", this.Tax30Calculated(),
                              "TaxTotCalculated",(this.Tax9Calculated() + this.Tax13Calculated() + this.Tax15Calculated() + this.Tax30Calculated()),
                              "Tax9Paid",        this.Tax9Paid(),
                              "Tax13Paid",       this.Tax13Paid(),
                              "Tax15Paid",       this.Tax15Paid(),
                              "Tax30Paid",       this.Tax30Paid(),
                              "TaxTotPaid",      (this.Tax9Paid() + this.Tax13Paid() + this.Tax15Paid() + this.Tax30Paid()),
                              "Tax9Due",         this.Tax9Due(),
                              "Tax13Due",        this.Tax13Due(),
                              "Tax15Due",        this.Tax15Due(),
                              "Tax30Due",        this.Tax30Due(),
                              "TaxTotDue",       (this.Tax9Due() + this.Tax13Due() + this.Tax15Due() + this.Tax30Due()),
                              "Tax9ToReturn",    this.Tax9ToReturn(),
                              "Tax13ToReturn",   this.Tax13ToReturn(),
                              "Tax15ToReturn",   this.Tax15ToReturn(),
                              "Tax30ToReturn",   this.Tax30ToReturn(),
                              "TaxTotToReturn",  (this.Tax9ToReturn() + this.Tax13ToReturn() + this.Tax15ToReturn() + this.Tax30ToReturn())
                        );
     end;
     CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxSumItog", 0, m_CurrSheetName, true );
  END;

  MACRO GetDelimLine(Numrec:integer, Kind:integer)
     var i = 0;
     var StrWinRep;

     if( Kind )
        if( Kind == 1 )
           StrWinRep = "├───────────────┬────────────────────┼──────────────────";
        elif( Kind == 2 )
           StrWinRep = "├───────────────┼────────────────────┼──────────────────";
        elif( Kind == 3 )               
           StrWinRep = "├───────────────┴────────────────────┼──────────────────";
        elif( Kind == 4 )               
           StrWinRep = "│               ├────────────────────┼──────────────────";
        end;                               
     else
        StrWinRep =    "├────────────────────────────────────┼──────────────────";
     end;
     
     while( i < Numrec - 1 )
        StrWinRep = StrWinRep + "┼──────────────────";
        i = i + 1;
     end;
     StrWinRep = StrWinRep + "┤\n";
     return StrWinRep;
  END;

  PRIVATE MACRO PrintPartStr(Str:string,From:integer,Len:integer)
    var EmptyStr = "", PartStr = "";
    PartStr = mkstr(" ",len);
    if( strlen(Str) > 0 )
       PartStr = substr(Str,From,Len);              
       if( strlen(PartStr) < Len )                  
          EmptyStr = mkstr(" ",Len-strlen(PartStr));
          PartStr = PartStr + EmptyStr;             
       end;                                         
    end;
    return PartStr;
  END;

  PRIVATE MACRO FillArrayPlusMinusCode(ClientID:integer)
     var SqlCodeInOut, DataCodeInOut;
     var NPlus = 0, NMinus = 0;

     m_sizePlusG = 0;
     m_PlusG.Size = 0;
     m_sizeMinusG = 0;
     m_MinusG.Size = 0;

     /*получить все виды неулевых сумм типа PlusG_ и MinusG_ для всех операций клиента*/
     SqlCodeInOut = RSDCommand( 
            "select txop.T_CLIENT, txkind.KindCode, "+
            "       (case when (txkind.KindCode like '"+PLUSG_STR+"%')then 1 else 2 end) as NumC "+  
            "  from "+ 
            "      (select txop.* from "+                                                             
            "        (select nptxop.T_CLIENT, (case when ( nptxop.T_DOCKIND = ? "+                                                                            
            "                and nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
            "                then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') "+
            "                else nptxop.T_OPERDATE end) OPERDATE "+                                
            "           from dnptxop_dbt nptxop "+                                                
            "          where nptxop.T_CLIENT = ? "+                                               
            "            and nptxop.T_DOCKIND in(?,?) "+                                           
            "            and ? <= "+
            "                case when ( nptxop.T_DOCKIND = ? "+                                                               
            "                            and nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
            "                then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') else nptxop.T_OPERDATE end "+    
            "            and ? >= "+                                                                                                          
            "                case when ( nptxop.T_DOCKIND = ? "+                                                              
            "                            and nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
            "                then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') else nptxop.T_OPERDATE end "+
            "        ) txop "+
            "        group by txop.T_CLIENT, txop.OPERDATE "+
            "      ) txop, "+                          
            "       dnptxobj_dbt nptxobj, "+                                        
            "       (select nptxkind.T_ELEMENT, "+                                  
            "               nptxkind.T_CODE KindCode "+                             
            "          from dnptxkind_dbt nptxkind "+  
            "         where (nptxkind.T_CODE like '"+PLUSG_STR+"%' or nptxkind.T_CODE like '"+MINUSG_STR+"%')) txkind "+  
            " where nptxobj.T_KIND = txkind.T_ELEMENT "+                            
            "   and nptxobj.T_CLIENT = txop.T_CLIENT "+ 
            "   and nptxobj.T_SUM0 > 0 "+
            "   and nptxobj.T_DATE between ? and txop.OPERDATE "+
            " group by txop.T_CLIENT, txkind.KindCode "+                        
            " order by txkind.KindCode desc ");

     SqlCodeInOut.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlCodeInOut.addParam("", RSDBP_IN, ClientID);
     SqlCodeInOut.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlCodeInOut.addParam("", RSDBP_IN, DL_CALCNDFL);
     SqlCodeInOut.addParam("", RSDBP_IN, m_BegDate);
     SqlCodeInOut.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlCodeInOut.addParam("", RSDBP_IN, m_EndDate);
     SqlCodeInOut.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlCodeInOut.addParam("", RSDBP_IN, m_BegDate);
     
     SqlCodeInOut.execute();

     DataCodeInOut = TRsbDataSet(SqlCodeInOut);
     while( DataCodeInOut.MoveNext() )
        if( DataCodeInOut.NumC == 1 )
           m_PlusG[NPlus] = DataCodeInOut.KindCode;
           NPlus = NPlus + 1;
        else
           m_MinusG[NMinus] = DataCodeInOut.KindCode;
           NMinus = NMinus + 1;
        end;
     end;

     m_sizePlusG = m_PlusG.Size;
     m_sizeMinusG = m_MinusG.Size;
  END;

  PRIVATE MACRO GetElemByNPTXKind(Kind:string)

     var Sql = RSDCommand("select txkind.T_ELEMENT "+
                          "  from dnptxkind_dbt txkind "+
                          " where txkind.T_CODE like '"+string(Kind)+"'");
     Sql.execute();

     var SqlData = TRsbDataSet(Sql);

     if( SqlData.MoveNext() )
        return SqlData.ELEMENT;
     end;

     return 0;
  END;

  MACRO GetObjSumByKind(Kind:string,OperDate:Date):money
     var TaxSum = $0;
     var Elem = GetElemByNPTXKind(Kind);

     if( Elem )
       DL_GetNPTXOBJSumByClient(m_DataClient.Client,
                                string(Elem),
                                m_BegDate,
                                OperDate,
                                null,
                                null,
                                @TaxSum
                               );
     end;

     return TaxSum;
  END;

  /*для текстового режима печать*/
  MACRO PrintPart2InTextMode()
     var Query, SqlOp, DataOper, NRec, NRecData, Numrec = 0, i = 0, j=0;
     var OpDate = TArray();
     var PMNumb = TArray();

     macro PrintBlokPlusMinus(Kind:integer)
       var PlusMinusTxt, PlusMinussize = 0, PlusMinusTxt1;

       if( Kind == Доход )
          PlusMinusTxt = "Строка доходов";
          PlusMinussize = m_sizePlusG;
          PlusMinusTxt1 = "Доход";
       else
          PlusMinusTxt = "Строка вычетов";
          PlusMinussize = m_sizeMinusG;
          PlusMinusTxt1 = "Налоговый вычет";
       end;

       m_StrWinRep = m_StrWinRep + 
                     "│ "+PrintPartStr(PlusMinusTxt,1,35)+"│                  ";

       i = 0;
       while( i < Numrec - 1 )        
          m_StrWinRep = m_StrWinRep + "│                  ";
          i = i + 1;
       end;
       m_StrWinRep = m_StrWinRep + "│\n";
          
       if( PlusMinussize )
          m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec,1);           
       else
          m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec);           
       end;
      
       j = 0;
       while( j < PlusMinussize )
          m_StrWinRep = m_StrWinRep +
                        "│"+PrintPartStr(PlusMinusTxt1,1,15)+"│     "+PrintPartStr(GetOperCode(IIF(Kind==Доход,m_PlusG[j],m_MinusG[j]),Kind),1,15);
          i = 0;
          while( i < Numrec )         
             m_StrWinRep = m_StrWinRep + "│"+PrintPartStr(GetObjSumByKind(IIF(Kind==Доход,m_PlusG[j],m_MinusG[j]),OpDate[i]),1,18);
             i = i + 1;
          end;
      
          m_StrWinRep = m_StrWinRep + "│\n";
          m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec,IIF(((j+1)==PlusMinussize),3,2));
          j = j + 1;             
       end;

     end;

     m_StrWinRep     = "";

     Query = "select txop.T_CLIENT, txop.OPERDATE "+
             "  from "+
             TableOp+
             " group by txop.T_CLIENT, txop.OPERDATE "+
             " order by txop.OPERDATE";

     SqlOp = RSDCommand(Query);

     NRec = RSDCommand("select count(1) nRecs from(" + Query + ")");;

     SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlOp.addParam("", RSDBP_IN, m_DataClient.Client);
     SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlOp.addParam("", RSDBP_IN, DL_CALCNDFL);

     SqlOp.addParam("", RSDBP_IN, m_BegDate);
     SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlOp.addParam("", RSDBP_IN, m_EndDate);
     SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
     SqlOp.addParam("", RSDBP_IN, m_DataClient.Client);
     SqlOp.addParam("", RSDBP_IN, m_BegDate);

     NRec.addParam("", RSDBP_IN, DL_HOLDNDFL);
     NRec.addParam("", RSDBP_IN, m_DataClient.Client);
     NRec.addParam("", RSDBP_IN, DL_HOLDNDFL);
     NRec.addParam("", RSDBP_IN, DL_CALCNDFL);

     NRec.addParam("", RSDBP_IN, m_BegDate);
     NRec.addParam("", RSDBP_IN, DL_HOLDNDFL);
     NRec.addParam("", RSDBP_IN, m_EndDate);
     NRec.addParam("", RSDBP_IN, DL_HOLDNDFL);
     NRec.addParam("", RSDBP_IN, m_DataClient.Client);
     NRec.addParam("", RSDBP_IN, m_BegDate);
     
     SqlOp.execute();
     NRec.execute();
     
     DataOper = TRsbDataSet(SqlOp);
     NRecData = TRsbDataSet(NRec);

     if( NRecData.MoveNext() )
       Numrec = int(NRecData.nRecs); /*кол-во столбцов*/
     end;

     /*печать строки с датами всех операций*/
     i = 0;
     m_StrWinRep = "\nРАСЧЕТ НАЛОГОВОЙ БАЗЫ И НАЛОГА  НА  ДОХОДЫ  ФИЗИЧЕСКОГО ЛИЦА ПО ОПЕРАЦИЯМ С Ц/Б\n\n"+
                   "(для доходов, облагаемых по ставкам 13% и 30%)\n\n"+
                   "┌────────────────────────────────────┬──────────────────";
     while( i < Numrec - 1 )
        m_StrWinRep = m_StrWinRep + "┬──────────────────";
        i = i + 1;
     end;
     m_StrWinRep = m_StrWinRep + "┐\n"; 
                                                         
     m_StrWinRep = m_StrWinRep +                             
                   "│ Наименование показателя            "; 
                   
     i = 0;
     if( Numrec )
       while( DataOper.MoveNext() )          
          m_StrWinRep = m_StrWinRep +"│    "+string(SQL_ConvTypeDate(DataOper.OPERDATE))+"    ";
          OpDate[i] = SQL_ConvTypeDate(DataOper.OPERDATE);
          i = i + 1;
       end;
     else                           
        m_StrWinRep = m_StrWinRep + "│                  ";
     end;
     m_StrWinRep = m_StrWinRep +"│\n";
     m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec);           
     /*печать блока Строка доходов*/
     FillArrayPlusMinusCode(m_DataClient.Client);
     PrintBlokPlusMinus(Доход);
     /*печать блока Строка вычетов*/
     PrintBlokPlusMinus(Вычет);
     /*печать последних 5-ти строк столбца*/
     m_StrWinRep = m_StrWinRep + 
                   "│ Налоговая база (с начала года)     ";

     i = 0;
     if( Numrec )
        while( i < Numrec )
          InitDataTaxSum();
          m_OperDate  = OpDate[i];
          m_StrWinRep = m_StrWinRep +"│"+PrintPartStr(string(this.TaxBaseSum()),1,18); 
          i = i + 1;
        end;
     else
        m_StrWinRep = m_StrWinRep + "│      0.00        ";
     end;
     m_StrWinRep = m_StrWinRep + "│\n";
     m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec);           

     m_StrWinRep = m_StrWinRep + 
                   "│ Налог исчисленный                  ";
     i = 0;
     if( Numrec )
        while( i < Numrec )
          InitDataTaxSum();
          m_OperDate  = OpDate[i];
          m_StrWinRep = m_StrWinRep + "│"+PrintPartStr(string(this.TaxCalculated()),1,18);
          i = i + 1;
        end;
     else
        m_StrWinRep = m_StrWinRep + "│      0.00        ";
     end;
     m_StrWinRep = m_StrWinRep + "│\n";
     m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec);           

     m_StrWinRep = m_StrWinRep + 
                   "│ Налог удержанный                   ";
     i = 0;
     if( Numrec )
        while( i < Numrec )
          InitDataTaxSum();
          m_OperDate  = OpDate[i];
          m_StrWinRep = m_StrWinRep + "│" +PrintPartStr(string(this.TaxPaid()),1,18);
          i = i + 1;
        end;
     else
        m_StrWinRep = m_StrWinRep + "│      0.00        ";
     end;
     m_StrWinRep = m_StrWinRep + "│\n";
     m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec,1);           

     m_StrWinRep = m_StrWinRep + 
                   "│ Платежное     │        дата        ";
     i = 0;
     if( Numrec )
        while( i < Numrec )
          m_OperDate  = OpDate[i];                                  
          m_StrWinRep = m_StrWinRep + "│" +PrintPartStr(string(this.GetPmDate()),1,18);
          PMNumb[i]   = m_PaymentNumber;/*запоминаем для следующей строки*/
          m_PaymentDate   = null;
          m_PaymentNumber = null;
          i = i + 1;
        end;
     else
        m_StrWinRep = m_StrWinRep + "│                  ";
     end;
     m_StrWinRep = m_StrWinRep + "│\n";
     m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec,4);
           
     m_StrWinRep = m_StrWinRep + 
                   "│ поручение     │        номер       ";
     i = 0;
     if( Numrec )
        while( i < Numrec )
          m_StrWinRep = m_StrWinRep + "│" +PrintPartStr(string(PMNumb[i]),1,18);
          i = i + 1;
        end;
     else
        m_StrWinRep = m_StrWinRep + "│                  ";
     end;
     m_StrWinRep = m_StrWinRep + "│\n";
     m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec,3);           

     m_StrWinRep = m_StrWinRep + 
                   "│Долг по налогу за налогоплательщиком";
     i = 0;
     if( Numrec )
        while( i < Numrec )
          InitDataTaxSum();
          m_OperDate  = OpDate[i];
          m_StrWinRep = m_StrWinRep +"│"+PrintPartStr(string(this.TaxDue()),1,18);
          i = i + 1;
        end;
     else
        m_StrWinRep = m_StrWinRep + "│      0.00        ";
     end;
     m_StrWinRep = m_StrWinRep + "│\n";
     m_StrWinRep = m_StrWinRep + GetDelimLine(Numrec);           

     m_StrWinRep = m_StrWinRep + 
                   "│Долг по налогу за налоговым агентом ";
     i = 0;
     if( Numrec )
        while( i < Numrec )
          InitDataTaxSum();
          m_OperDate  = OpDate[i];
          m_StrWinRep = m_StrWinRep +"│"+PrintPartStr(string(this.TaxToReturn()),1,18);
          i = i + 1;
        end;
     else
        m_StrWinRep = m_StrWinRep + "│      0.00        ";
     end;
     m_StrWinRep = m_StrWinRep + "│\n";

     i = 0;                                              
     m_StrWinRep = m_StrWinRep + "└────────────────────────────────────┴──────────────────";
     while( i < Numrec - 1 )
        m_StrWinRep = m_StrWinRep + "┴──────────────────";
        i = i + 1;
     end;
     m_StrWinRep = m_StrWinRep + "┘\n"; 
     PrintFormatString(m_StrWinRep);
  END;

  PRIVATE MACRO TArrayOrIntToString(TArrayOrInt) : string
    var result : string = "";
    if (ValType(TArrayOrInt) == V_INTEGER)
      result = string(TArrayOrInt);
    elif (ValType(TArrayOrInt) == V_GENOBJ)
      var i;
      for (i, 0, TArrayOrInt.Size() - 1)
        result = result + IIF(i == 0, string(TArrayOrInt[i]), ", " + string(TArrayOrInt[i]));
      end;
    end;
    return result;
  END;

  PRIVATE MACRO ExecuteReport()
    var Num = 0, i = 0;
    var QueryCl, SqlCl, SqlOp, IsContinueMove = false, IsDataOper = false, TaxSum_Y = 0, PrevOperDate = ZeroDate;
    var IsExistClOper;
    var NRec, NRecData, Numrec = 0;
    var IsFirst = true;
    var PoiNum = 1;
    var Sym, ItogSym;

    m_CurrSheetName = "";
    SetActiveSheet( "1НДФЛ" );

    QueryCl = "   SELECT client.t_PartyID AS Client,"
            + "          persn.t_Name1 AS Name1,"
            + "          persn.t_Name2 AS Name2,"
            + "          persn.t_Name3 AS Name3"
            + "     FROM dclient_dbt client,"
            + "          dparty_dbt party,"
            + "          dpersn_dbt persn,"
            + "          dnptxop_dbt nptxop"
            + "    WHERE ";

    if (((ValType(m_ClientID) == V_INTEGER) and (m_ClientID    != -1))
    or  ((ValType(m_ClientID) == V_GENOBJ)  and (m_ClientID[0] != -1)))
      QueryCl = QueryCl + "client.t_PartyID IN (" + TArrayOrIntToString(m_ClientID) + ") AND";
    end;

    QueryCl = QueryCl
            + "              client.t_Branch     = 0"
            + "          AND client.t_Department = " + string({OperDprt})
            + "          AND client.t_ServiceKind IN (" + string(PTSK_STOCKDL) + ","
            +                                             string(PTSK_DV) + ","
            +                                             string(PTSK_DEPOS) + ")"
            + "          AND party.t_PartyID   = client.t_PartyID"
            + "          AND party.t_LegalForm = " + string(legal_form_phys)
            + "          AND persn.t_PersonID  = client.t_PartyID"
            + "          AND nptxop.t_DocKind  = " + string(DL_CALCNDFL)
            + "          AND nptxop.t_Client   = client.t_PartyID"
            + "          AND nptxop.t_OperDate BETWEEN " + GetSQLDate(m_BegDate) + " AND " + GetSQLDate(m_EndDate)
            + " ORDER BY persn.t_Name1, persn.t_Name2, persn.t_Name3";

    SqlCl = DL_RSDCommand(QueryCl);
    NRec  = DL_RSDCommand("SELECT COUNT(1) nRecs FROM (" + QueryCl + ")");

    m_DataClient = SqlCl.Execute();
    NRecData     = NRec.Execute();

    if (NRecData.MoveNext())
       Numrec = int(NRecData.nRecs);
    end;
    
    InitProgress( Numrec, "1-НДФЛ по ц/б", "Просмотр операций по клиентам" );
    while( m_DataClient.MoveNext() )
       m_IsExistClientData = true;
       m_CurrSheetName = GetSheetName(m_DataClient.Name1, m_DataClient.Name2, m_DataClient.Name3);

       UseNewSheetInTotalBook();

       InitClientData();

       m_ClientRec = TRecHandler( "party.dbt" );
       ПолучитьСубъекта(m_DataClient.Client, m_ClientRec);

       /*1-я секция по анкете клиента*/
       PrintClientInfo();

       if( this.PrintMode() == DL_OUTREPORT_STD )/*стандартный режим*/
          PrintPart2InTextMode();
       else
         SqlOp = RSDCommand("select txop.T_CLIENT, txop.OPERDATE, NVL(sum(txobj.SUM0),0) SUM0, txobj.KindCode "+
                            "  from "+
                            TableOp+
                            " group by txop.T_CLIENT, txop.OPERDATE, txobj.KindCode "+
                            " order by txop.OPERDATE, txobj.KindCode desc ");
         
         SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
         SqlOp.addParam("", RSDBP_IN, m_DataClient.Client);
         SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
         SqlOp.addParam("", RSDBP_IN, DL_CALCNDFL);
         
         SqlOp.addParam("", RSDBP_IN, m_BegDate);
         SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
         SqlOp.addParam("", RSDBP_IN, m_EndDate);
         SqlOp.addParam("", RSDBP_IN, DL_HOLDNDFL);
         SqlOp.addParam("", RSDBP_IN, m_DataClient.Client);
         SqlOp.addParam("", RSDBP_IN, m_BegDate);
         
         SqlOp.execute();
         
         m_DataOper = TRsbDataSet(SqlOp);
         
         IsExistClOper = m_DataOper.MoveNext();
         IsDataOper = true;
         /*не было операций - печатаем нули*/
         while( IsDataOper )
            InitDataTaxSum();
            if( IsExistClOper )
               m_OperDate = SQL_ConvTypeDate(m_DataOper.OperDate);
            end;
            /*печать строк первого столбца - на странице печатается один раз*/
            if( not m_IsPrintFirstCol )
               FillArrayPlusMinusCode(m_DataClient.Client);
               m_YPastClnt = GetLastPosition(m_CurrSheetName) + 17;/*для следующего столбца - начинается на уровне ячейки "Наименование показателя"*/
               /*печать строки доходов*/
               RegisterTable( "MainTable_PlusCode", "", "", "PlusCode" ); 
               i = 0;
               while( i < m_sizePlusG )
                  PrintTableLine( "PlusText", "Доход", null, 
                                  "PlusCode", GetOperCode(m_PlusG[i],Доход), null);
                  i = i + 1;
               end;
               if( not IsExistClOper or (m_sizePlusG==0) )
                  PrintTableLine( "PlusText", "Доход", null);
               end;
               EndTable();
               
               /*печать строки вычетов*/
               RegisterTable( "MainTable_MinusCode", "", "", "MinusCode" ); 
               i = 0;
               while( i < m_sizeMinusG )
                  PrintTableLine( "MinusText", "Налоговый вычет", null,
                                  "MinusCode", GetOperCode(m_MinusG[i],Вычет), null);
                  i = i + 1;
               end;
               if( not IsExistClOper or (m_sizeMinusG==0) )
                  PrintTableLine( "MinusText", "Налоговый вычет", null);
               end;
               EndTable();
         
               CopyAllSheetInTotalBook( "1НДФЛ", false, "BaseCalcTxt", 0, m_CurrSheetName, true );
               
               m_NumCol = 2;
         
               m_IsPrintFirstCol = true;
            end;
         
            /*печать следующего столбца с суммами за дату по операции*/
            /*дата операции*/
            PrintFormatString( "", "OperDate", SQL_ConvTypeDate(m_OperDate) );
            TaxSum_Y = m_YPastClnt-1;
            CopyAllSheetInTotalBook( "1НДФЛ", false, "OperDate", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            /*печать блока строк доходов*/
            PrintFormatString( "", "TaxSum", "" );
            TaxSum_Y = TaxSum_Y + 1;
            CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxSum", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            if( not IsExistClOper or (m_sizePlusG==0)  )
               PrintFormatString( "", "TaxSum", $0 );
               TaxSum_Y = TaxSum_Y + 1;
               CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxSum", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            end;
            i = 0;
            while( i < m_sizePlusG )
               if( IsContinueMove )
                  IsDataOper = m_DataOper.MoveNext();
                  IsContinueMove = false;
               end;
         
               if( m_PlusG[i] == m_DataOper.KindCode )
                  PrintFormatString( "", "TaxSum", money(m_DataOper.SUM0));
                  IsContinueMove = true;
               else
                  PrintFormatString( "", "TaxSum", $0 );
               end;
               i = i + 1;
         
               TaxSum_Y = TaxSum_Y + 1;
               CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxSum", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            end;
            /*печать блока строк вычетов*/
            PrintFormatString( "", "TaxSum", "" );
            TaxSum_Y = TaxSum_Y + 1;
            CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxSum", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            if( not IsExistClOper or (m_sizeMinusG==0) )
               PrintFormatString( "", "TaxSum", $0 );
               TaxSum_Y = TaxSum_Y + 1;
               CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxSum", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            end;
            i = 0;
            while( i < m_sizeMinusG )
               if( IsContinueMove )
                  IsDataOper = m_DataOper.MoveNext();
                  IsContinueMove = false;
               end;
               if( m_MinusG[i] == m_DataOper.KindCode )
                  PrintFormatString( "", "TaxSum", money(m_DataOper.SUM0) );
                  IsContinueMove = true;
               else
                  PrintFormatString( "", "TaxSum", $0 );
               end;
               i = i + 1;
               TaxSum_Y = TaxSum_Y + 1;
               CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxSum", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            end;
            IsContinueMove = false;
            /*печать последних 7-ти строк столбца*/
            PrintFormatString( "", "TaxBaseSum",    IIF(IsExistClOper,this.TaxBaseSum(),$0),
                                   "TaxCalculated", IIF(IsExistClOper,this.TaxCalculated(),$0),
                                   "TaxPaid",       IIF(IsExistClOper,this.TaxPaid(),$0),
                                   "PaymentDate",   IIF(IsExistClOper,this.GetPmDate(),""),
                                   "PaymentNumber", IIF(IsExistClOper,this.GetPmNumb(),""),
                                   "TaxDue",        IIF(IsExistClOper,this.TaxDue(),$0),
                                   "TaxToReturn",   IIF(IsExistClOper,this.TaxToReturn(),$0)
                             );
            m_PaymentDate   = null;
            m_PaymentNumber = null;

            TaxSum_Y = TaxSum_Y + 1;
            CopyAllSheetInTotalBook( "1НДФЛ", false, "TaxOperSum", _SplitCoord(TaxSum_Y,m_NumCol), m_CurrSheetName, true );
            m_NumCol = m_NumCol + 1;/*номер следующего столбца*/
         
            if( IsExistClOper )
               IsDataOper = m_DataOper.MoveNext();
            else
               IsDataOper = IsExistClOper;
            end;
         end;
       end;
       /*3-я секция*/
       PrintTaxSumItog();

       if((this.PrintMode() == DL_OUTREPORT_EXCEL) and POI_MODE and (m_IsPartlyExcel == SET_CHAR))
          if(IsFirst)
             Sym = m_CurrSheetName;
             IsFirst = false;
          end;

          if(PoiNum >= m_MaxSheetsCount)
             ItogSym = "Report_npform1_" + Sym + "_" + m_CurrSheetName;
             SaveSubTotalBook(ItogSym, false);
             CreateTotalBook();
             PoiNum = 1;
             IsFirst = true;
          else
             PoiNum = PoiNum + 1;
          end;
       end;

       UseProgress( Num = Num + 1 );
    end;
    RemProgress();
  END;

  PRIVATE MACRO Create()
     m_IsExistClientData = false;
     ExecuteReport();
     /*если данных вообще нет*/
     if(not m_IsExistClientData)
        PrintFormatString( "#", "NoData", "Нет данных, удовлетворяющих параметрам отчета." );
        CopyAllSheetInTotalBook( null, false, "NoData", 0 );
     end;
  END;

  MACRO ResidenceStatus():string
    if( m_ClientRec.rec.NotResident == SET_CHAR )
       return НеРезидент;
    end;
    return Резидент;
  END;

  MACRO TaxBaseSum():money
    var objstr = "";
    if( m_TaxBaseSum == null )
       objstr = string(TXOBJ_BASEMATERIAL)+", "+string(TXOBJ_BASEGENERAL);
       DL_GetNPTXOBJSumByClient(m_ClientRec.rec.PartyID,
                                objstr,
                                m_BegDate,
                                m_OperDate,
                                null,
                                null,
                                @m_TaxBaseSum
                               );
    end;
    return m_TaxBaseSum;
  END;

  MACRO TaxCalculated():money
    if( m_TaxCalculated == null )
       if( this.ResidenceStatus() == Резидент )
         m_TaxCalculated = this.TaxBaseSum() * NPTXGENTAXRATE_RESIDENT;
       else
         m_TaxCalculated = this.TaxBaseSum() * NPTXGENTAXRATE_NOTRESIDENT;
       end;
    end;
    return round(m_TaxCalculated,0);
  END;

  MACRO TPaid(objstr:string,OnDate:Date):money
     var v_TPaid = GetRubSumByClientOperDocKind(m_ClientRec.rec.PartyID, objstr, m_BegDate, OnDate, DL_CALCNDFL) + //созданные в операциях расчета НОБ
                   GetRubSumByClientOperDocKind(m_ClientRec.rec.PartyID, objstr, m_BegDate, OnDate, 0 /*только пользовательские*/) +
                   GetRubSumByClientFromDepo(m_ClientRec.rec.PartyID, objstr, m_BegDate, OnDate); /*созданные в операции "Расчет выплат по ц/б" в депозитарии*/
     if(OnDate == date(31,12,m_CurrYear))
       v_TPaid = v_TPaid + GetRubSumByClientOperDocKind(m_ClientRec.rec.PartyID, objstr, NULL, NULL, DL_HOLDNDFL, m_BegDate); //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
     else
       v_TPaid = v_TPaid + GetRubSumByClientOperDocKind(m_ClientRec.rec.PartyID, objstr, m_BegDate, OnDate, DL_HOLDNDFL, m_BegDate); //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
     end;
     return round(v_TPaid,0);
  END; 

  MACRO TaxPaid():money
    if( m_TaxPaid == null )
       m_TaxPaid = this.TPaid(string(TXOBJ_PAIDMATERIAL)+", "+string(TXOBJ_PAIDGENERAL),m_OperDate);
    end;
    return m_TaxPaid;
  END;

  MACRO TaxDue():money
    if( m_TaxDue == null )
      m_TaxDue = $0;
      if( this.TaxPaid() < this.TaxCalculated() )
         m_TaxDue = this.TaxCalculated() - this.TaxPaid();
      end;
    end;
    return m_TaxDue;
  END;

  MACRO TaxToReturn():money
    if( m_TaxToReturn == null )
      m_TaxToReturn = $0;
      if( this.TaxPaid() > this.TaxCalculated() )
         m_TaxToReturn = this.TaxPaid() - this.TaxCalculated();
      end;
    end;
    return m_TaxToReturn;
  END;

  MACRO GetPmGr()
    var DataGr,
    SqlGr = RSDCommand(
           "select * "+
           "  from( "+ 
           "       select GROUND.T_REGISTRDATE, GROUND.T_XLD "+                                               
           "         from dspground_dbt ground, dspgrdoc_dbt grdoc,  "+
           "              (select nptxop.T_ID, nptxop.T_DOCKIND "+
           "                 from dnptxop_dbt nptxop "+
           "                where nptxop.T_CLIENT = ? "+
           "                  and nptxop.T_DOCKIND = ? "+ 
           "                  and ? <= "+
           "                      case when ( nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
           "                      then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') else nptxop.T_OPERDATE end "+    
           "                  and ? >= "+                                                                                                          
           "                      case when ( nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
           "                      then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') else nptxop.T_OPERDATE end "+
           "                  and ? = case when ( nptxop.T_OPERDATE > to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy')) "+
           "                          then to_date('3112'||to_char(to_date(nptxop.T_PREVDATE),'yyyy'),'dd.mm.yyyy') "+
           "                          else nptxop.T_OPERDATE end  "+
           "              ) txop  "+
           "        where GROUND.T_SPGROUNDID = grdoc.T_SPGROUNDID "+                                 
           "          and grdoc.T_SOURCEDOCID = txop.t_ID "+                                                    
           "          and GROUND.T_KIND = 313 "+/*только поручение*/
           "          and grdoc.T_SOURCEDOCKIND = txop.t_DOCKIND "+            
           "     order by GROUND.T_REGISTRDATE desc, GROUND.T_REGISTRTIME desc, GROUND.T_XLD desc "+
           "      ) "+
           " where ROWNUM = 1");

    SqlGr.addParam("", RSDBP_IN, m_DataClient.Client);
    SqlGr.addParam("", RSDBP_IN, DL_HOLDNDFL);
    SqlGr.addParam("", RSDBP_IN, m_BegDate);
    SqlGr.addParam("", RSDBP_IN, m_EndDate);
    SqlGr.addParam("", RSDBP_IN, m_OperDate);

    SqlGr.execute();

    DataGr = TRsbDataSet(SqlGr);

    if( DataGr.MoveNext() )
       m_PaymentDate   = SQL_ConvTypeDate(DataGr.rec.REGISTRDATE);
       m_PaymentNumber = DataGr.rec.Xld;
       return true;
    end;

    m_PaymentDate = "";
    m_PaymentNumber = "";

    return false;
  END;

  MACRO GetPmDate()
    if( m_PaymentDate == null)
       GetPmGr();
    end;
    return m_PaymentDate;
  END;

  MACRO GetPmNumb():String
    if( m_PaymentNumber == null)
       GetPmGr();
    end;
    return m_PaymentNumber;
  END;
          
  private macro GetPasspData()
     var Sql, SqlSet;

     Sql = RSDCommand("select KIND.T_CODEDOCUM, PERSN.T_BORN, " +                                                        
                      "       PERSNIDC.T_PAPERSERIES, PERSNIDC.T_PAPERNUMBER " +                                   
                      "  from DPERSNIDC_DBT PERSNIDC, DPERSN_DBT PERSN, DPAPRKIND_DBT KIND "+                                          
                      " where PERSNIDC.t_PersonId = ? " +                                                                              
                      "   and PERSNIDC.T_ISMAIN = 'X' " +                                                                              
                      "   and PERSNIDC.t_PaperKind = KIND.t_PaperKind " +                                                              
                      "   and PERSN.t_PersonId = PERSNIDC.t_PersonId ");                                                               
                                                                                                                                       
     Sql.addParam( "", RSDBP_IN, m_ClientRec.rec.PartyID );                                                                              
     Sql.execute();                                                                                                                    
     SqlSet = TRsbDataSet(Sql);                                                                                                        
                                                                                                                                       
     if( SqlSet.movenext() )                                                                                                           
        m_DocumentType    = SqlSet.CODEDOCUM;                                                                                               
        m_DocumentNumber  = SqlSet.PAPERSERIES + " " +SqlSet.PAPERNUMBER;                                                                                        
        m_DateBirth       = SQL_ConvTypeDate(SqlSet.BORN);                                                                                               
        return true;                                                                                                                   
     end; 
                                                                                                                             
     return false;
  end;
      
  MACRO ClientINN():string
     return ПолучитьКодСубъекта(m_ClientRec.rec.PartyID, PTCK_INN);
  END;

  MACRO FIO():string
     return m_ClientRec.rec.Name;
  END;

  MACRO DateBirth():string
     if( m_DateBirth == NULL )
       if( not GetPasspData() )
          m_DateBirth = "";
       end;
     end;
     return m_DateBirth;
  END;

  MACRO Citizenship():string
     if(m_ClientRec.rec.NotResident == SET_CHAR)
        return SC_GetCountryByCodeLat3(m_ClientRec.rec.NRCountry).CodeNum3;
     end;
     return NumOurCountry;
  END;

  MACRO DocumentType():string
     if( m_DocumentType == NULL )
       if( not GetPasspData() )
          m_DocumentType = "";
       end;
     end;
     return m_DocumentType;
  END;

  MACRO DocumentNumber():string
     if( m_DocumentNumber == NULL )
       if( not GetPasspData() )
          m_DocumentNumber = "";
       end;
     end;
     return m_DocumentNumber;
  END;

  private macro address_jur():TRecHandler
     if( m_address_jur == NULL ) 
        m_address_jur = TRecHandler("adress.dbt");
        НайтиЮридическийАдресСубъекта(m_ClientRec.rec.PartyID,m_address_jur);
     end;
     return m_address_jur;
  end;
      
  private macro address_fact():TRecHandler
     if( m_address_fact == NULL ) 
        m_address_fact = TRecHandler("adress.dbt");
        НайтиАдресСубъекта(m_ClientRec.rec.PartyID,PTADDR_REAL,m_address_fact);
     end;
     return m_address_fact;
  end;

  MACRO MailIndex():string
     return address_jur.rec.POSTINDEX;
  END;

  MACRO RegionCode():string
     return address_jur.rec.RegionNum;
  END;

  MACRO District():string
     return address_jur.rec.Province;
  END;

  MACRO City():string
     return address_jur.rec.District;
  END;

  MACRO Town():string
     return address_jur.rec.Place;
  END;

  MACRO Street():string
     return address_jur.rec.Street;
  END;

  MACRO House():string
     return address_jur.rec.House;
  END;

  MACRO Building():string
     return address_jur.rec.NumCorps;
  END;

  MACRO Appartment():string
     return address_jur.rec.Flat;
  END;                                 

  MACRO ResidenceCountry():string
     var Sql = "", DataSql = "";
     if( (m_ClientRec.rec.NotResident == UNSET_CHAR) AND (SC_GetCountryByCodeLat3(m_ClientRec.rec.NRCountry).CodeNum3 == NumOurCountry) )
        return "";
     end;

     Sql = RSDCommand("select T_CodeNum3 " +                                                        
                      "  from DCOUNTRY_DBT  "+                                          
                      " where t_Codelat3 like '"+string(address_fact.rec.Country)+"' ");                                                               
                                                                                                                                       
     Sql.execute();                                                                                                                    
     DataSql = TRsbDataSet(Sql);                                                                                                        
     if( DataSql.MoveNext() ) 
        return DataSql.CodeNum3;                                                                                                                         
     end;

     return "";
  END;

  MACRO ResidenceAdress():string
     if( (m_ClientRec.rec.NotResident == UNSET_CHAR) AND (SC_GetCountryByCodeLat3(m_ClientRec.rec.NRCountry).CodeNum3 == NumOurCountry) )
        return "";
     end;                               
     return address_fact.rec.Adress;
  END;

  PRIVATE MACRO TaxSpecial():money
     if( m_TaxSpecial == null )
        DL_GetNPTXOBJSumByClient(m_ClientRec.rec.PartyID,
                                 string(TXOBJ_BASESPECIAL),
                                 m_BegDate,
                                 m_EndDate,
                                 null,
                                 null,
                                 @m_TaxSpecial
                                );
     end;
     return m_TaxSpecial;
  END; 

  PRIVATE MACRO DivPaySec():money
     if( m_DivPaySec == null )
        DL_GetNPTXOBJSumByClient(m_ClientRec.rec.PartyID,
                                 string(TXOBJ_DIVPAY_SEC),
                                 m_BegDate,
                                 m_EndDate,
                                 null,
                                 null,
                                 @m_DivPaySec
                                );
     end;
     return m_DivPaySec;
  END;

  PRIVATE MACRO TaxGeneral():money
     var objstr = "";
     if( m_TaxGeneral == null )
        objstr = string(TXOBJ_BASEGENERAL)+", "+string(TXOBJ_BASEMATERIAL);
        DL_GetNPTXOBJSumByClient(m_ClientRec.rec.PartyID,
                                 objstr,
                                 m_BegDate,
                                 m_EndDate,
                                 null,
                                 null,
                                 @m_TaxGeneral
                                );
     end;
     return m_TaxGeneral;
  END; 

  MACRO Tax9Calculated():money
     var Tax = $0;
     if( this.ResidenceStatus() == Резидент )
        Tax = 0.09 * TaxSpecial() + DivPaySec();
     end;
     return round(Tax,0);
  END; 

  MACRO Tax13Calculated():money
     var Tax = $0;
     if( this.ResidenceStatus() == Резидент )
        Tax = 0.13 * TaxGeneral();
     end;
     return round(Tax,0);
  END;                                 

  MACRO Tax15Calculated():money
     var Tax = $0;
     if( this.ResidenceStatus() == НеРезидент )
        Tax = 0.15 * TaxSpecial() + DivPaySec();
     end;
     return round(Tax,0);
  END;                                 

  MACRO Tax30Calculated():money
     var Tax = $0;
     if( this.ResidenceStatus() == НеРезидент )
        Tax = 0.30 * TaxGeneral();
     end;
     return round(Tax,0);
  END; 
                                
  MACRO TPaidAll(objstr:string):money
     var v_TPaid = GetRubSumByClientOperDocKind(m_ClientRec.rec.PartyID, objstr, m_BegDate, m_EndDate, null); //все: пользовательские и непользовательские
     return v_TPaid;
  END;

  MACRO Tax9Paid():money
    if( m_Tax9Paid == null )
       m_Tax9Paid = $0;
       if( this.ResidenceStatus() == Резидент )
          m_Tax9Paid = this.TPaid(string(TXOBJ_PAIDSPECIAL),m_EndDate) + this.TPaidAll(string(TXOBJ_DIVPAY_SEC) );
       end;
    end;
    return round(m_Tax9Paid,0);
  END;

  MACRO Tax13Paid():money
    if( m_Tax13Paid == null )
       m_Tax13Paid = $0;
       if( this.ResidenceStatus() == Резидент )
          m_Tax13Paid = this.TPaid(string(TXOBJ_PAIDMATERIAL)+", "+string(TXOBJ_PAIDGENERAL),m_EndDate);
       end;
    end;
    return round(m_Tax13Paid,0);
  END;

  MACRO Tax15Paid():money
    if( m_Tax15Paid == null )
       m_Tax15Paid = $0;
       if( this.ResidenceStatus() == НеРезидент )
          m_Tax15Paid = this.TPaid(string(TXOBJ_PAIDSPECIAL),m_EndDate) + this.TPaidAll(string(TXOBJ_DIVPAY_SEC) );
       end;
    end;
    return round(m_Tax15Paid,0);
  END;

  MACRO Tax30Paid():money
    if( m_Tax30Paid == null )
       m_Tax30Paid = $0;
       if( this.ResidenceStatus() == НеРезидент )
          m_Tax30Paid = this.TPaid(string(TXOBJ_PAIDMATERIAL)+", "+string(TXOBJ_PAIDGENERAL),m_EndDate);
       end;
    end;
    return round(m_Tax30Paid,0);
  END;

  MACRO Tax9Due():money
    if( m_Tax9Due == null )
       m_Tax9Due = $0;
       if( this.Tax9Paid() < this.Tax9Calculated() )
          m_Tax9Due = this.Tax9Calculated() - this.Tax9Paid();
       end;
    end;
    return m_Tax9Due;
  END;

  MACRO Tax13Due():money
    if( m_Tax13Due == null )
       m_Tax13Due = $0;
       if( this.Tax13Paid() < this.Tax13Calculated() )
          m_Tax13Due = this.Tax13Calculated() - this.Tax13Paid();
       end;
    end;
    return m_Tax13Due;
  END;

  MACRO Tax15Due():money
    if( m_Tax15Due == null )
       m_Tax15Due = $0;
       if( this.Tax15Paid() < this.Tax15Calculated() )
          m_Tax15Due = this.Tax15Calculated() - this.Tax15Paid();
       end;
    end;
    return m_Tax15Due;
  END;

  MACRO Tax30Due():money
    if( m_Tax30Due == null )
       m_Tax30Due = $0;
       if( this.Tax30Paid() < this.Tax30Calculated() )
          m_Tax30Due = this.Tax30Calculated() - this.Tax30Paid();
       end;
    end;
    return m_Tax30Due;
  END;
       
  MACRO Tax9ToReturn():money
    if( m_Tax9ToReturn == null )
       m_Tax9ToReturn = $0;
       if( this.Tax9Paid() > this.Tax9Calculated() )
          m_Tax9ToReturn = this.Tax9Paid() - this.Tax9Calculated();
       end;
    end;
    return m_Tax9ToReturn;
  END;
       
  MACRO Tax13ToReturn():money
    if( m_Tax13ToReturn == null )
       m_Tax13ToReturn = $0;
       if( this.Tax13Paid() > this.Tax13Calculated() )
          m_Tax13ToReturn = this.Tax13Paid() - this.Tax13Calculated();
       end;
    end;
    return m_Tax13ToReturn;
  END;
       
  MACRO Tax15ToReturn():money
    if( m_Tax15ToReturn == null )
       m_Tax15ToReturn = $0;
       if( this.Tax15Paid() > this.Tax15Calculated() )
          m_Tax15ToReturn = this.Tax15Paid() - this.Tax15Calculated();
       end;
    end;
    return m_Tax15ToReturn;
  END;

  MACRO Tax30ToReturn():money
    if( m_Tax30ToReturn == null )
       m_Tax30ToReturn = $0;
       if( this.Tax30Paid() > this.Tax30Calculated() )
          m_Tax30ToReturn = this.Tax30Paid() - this.Tax30Calculated();
       end;
    end;
    return m_Tax30ToReturn;
  END;

  /*итоги для стандатрного режима*/
  MACRO TotCalculated():money
    return this.Tax9Calculated()+this.Tax13Calculated()+this.Tax15Calculated()+this.Tax30Calculated();
  END;

  MACRO TotPaid():money
    return this.Tax9Paid()+this.Tax13Paid()+this.Tax15Paid()+this.Tax30Paid();
  END;

  MACRO TotDue():money
    return this.Tax9Due()+this.Tax13Due()+this.Tax15Due()+this.Tax30Due();
  END;

  MACRO TotToReturn():money
    return this.Tax9ToReturn()+this.Tax13ToReturn()+this.Tax15ToReturn()+this.Tax30ToReturn();
  END;

  initDL_CReportTemplate( Sp_NPFORM1_Panel(), "Report_npform1.xls", NULL, false, NULL, POI_MODE );
END;

Sp_npform1_Report().Run();
exit(1);
