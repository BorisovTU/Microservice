/*
$Name:         scret110.mac
$Module:       Ценные бумаги
$Description:  Операции погашения ц/б Шаг - закрытие операции
*/
import "secinter.mac", "sp_categ.mac", "dldlngfun.mac", "scservop.mac";
import "sc_qraccfd.mac", "sp_caracc.mac","qracctools.mac";
IMPORT "role_model.mac";//ролевая модель

/*СОВУ*/
Private macro VU_InAccountingExecOp_Schedul(commdate, opernum, num, dealtype, contractkind/*1-клиенские, 0-собственные*/, clientid, contrid, fiid, dealid, documentid:@integer)
  var cmdD, rsD;
  var comm = TRecHandler("dl_comm.dbt"), stat = 0, nextnumb = 0;

  documentid = 0;

  GenerateReference(227, nextnumb);
  
  comm.rec.dockind = DL_INACCSRVOP/*4613*/;
  comm.rec.oper = opernum;
  comm.rec.division = 1;
  comm.rec.commstatus = 0;
  comm.rec.PartyId = -1;
  comm.rec.issuerID = -1;
  comm.rec.newFIID = -1;//код ФИ заполнять если ц/б, иначе -1
  comm.rec.commcode = nextnumb + num;
  comm.rec.commdate = commdate;//Дата операции
  comm.rec.operationkind = 0;//Вид действия
  comm.rec.opersubkind = dealtype;//Вид операции
  comm.rec.fiid = fiid;// код ФИ заполнять если не ц/б, иначе -1
  comm.rec.contractkind = contractkind;
  comm.rec.clientid = clientid;
  comm.rec.deal1 = dealid;
  comm.rec.contractID = contrid;

  stat = SC_CreateDlCommOperation(comm);

  if(stat == 0)
     documentid = Int(comm.rec.DocumentID);
     stat = SC_ServOperExecuteSilent(DL_INACCSRVOP, Int(comm.rec.DocumentID));
  end;

  if(stat == 0)
    StartCaptureOutput();
    [ 
      select dl_comm.t_commstatus
      from ddl_comm_dbt dl_comm
      where dl_comm.t_documentid = ? and
            dl_comm.t_commstatus = 2
    ];
    cmdD = RSDCommand(EndCaptureOutput());
    cmdD.AddParam("documentid", RSDBP_IN, Int(comm.rec.DocumentID));
    cmdD.Execute();
    rsD = TRsbDataSet(cmdD);
    if(not rsD.movenext)
      return 1;
    end;
  end;

  return stat;
end;


/*СОБУ*/
Private macro WRT_AccountingExecOp_Schedul(commdate, opernum, num, clientid, contractID, fiid, flag1, flag4, flag6, documentid:@integer)
  var cmdD, rsD;
  var comm = TRecHandler("dl_comm.dbt"), stat = 0, nextnumb = 0;
  documentid = 0;

  GenerateReference(230, nextnumb);

  comm.rec.dockind = DL_SCACCOUNTING/*4615*/;
  comm.rec.oper = opernum;
  comm.rec.division = 1;
  comm.rec.commstatus = 0;
  comm.rec.PartyId = -1;
  comm.rec.issuerID = -1;
  comm.rec.FIID = fiid;//Выпуск ц/б
  comm.rec.commcode = nextnumb + num;
  comm.rec.commdate = commdate;//Дата операции
  comm.rec.contractID = contractID;
  comm.rec.clientid = clientid;
  comm.rec.avoirkind = 0;//Вид ц/б
  comm.rec.currency = -1;// Валюта номинала
  if(flag1)
    comm.rec.flag1 = "X";//искл.
  else
    comm.rec.flag1 = " ";//искл.
  end;
  comm.rec.flag2 = " ";//Неттинг
  comm.rec.flag3 = " ";//Клиентские комиссии за обороты
  if(flag4)
    comm.rec.flag4 = "X";//Рассчеты на бирже
  else
    comm.rec.flag4 = " ";//Рассчеты на бирже
  end;

  if(flag6)
    comm.rec.flag6 = "X";
  else
    comm.rec.flag6 = " ";
  end;

  comm.rec.createreport = "X";

  comm.rec.FlagSecur = "X";


  comm.rec.contractkind = 3;
  comm.rec.OperSubKind = 12021;
  
  stat = SC_CreateDlCommOperation(comm);

  if(stat == 0)
     documentid = Int(comm.rec.DocumentID);
     stat = SC_ServOperExecuteSilent(DL_SCACCOUNTING, Int(comm.rec.DocumentID));
  end;

  if(stat == 0)
    StartCaptureOutput();
    [ 
      select dl_comm.t_commstatus
      from ddl_comm_dbt dl_comm
      where dl_comm.t_documentid = ? and
            dl_comm.t_commstatus = 2
    ];
    cmdD = RSDCommand(EndCaptureOutput());
    cmdD.AddParam("documentid", RSDBP_IN, Int(comm.rec.DocumentID));
    cmdD.Execute();
    rsD = TRsbDataSet(cmdD);
    if(not rsD.movenext)
      return 1;
    end;
  end;

  return stat;
end;


Private Macro AddCOVUBU  (FD)
    Var Dealid;

       WRT_AccountingExecOp_Schedul(date(FD.tick.rec.dealdate), "1", "", FD.tick.rec.clientid, FD.tick.rec.clientcontrid, FD.tick.rec.pfi, false, false, true, Dealid);
//       WRT_AccountingExecOp_Schedul
       VU_InAccountingExecOp_Schedul(date(FD.tick.rec.dealdate), "1", "", FD.tick.rec.dealtype, 1,FD.tick.rec.clientid, FD.tick.rec.clientcontrid, FD.tick.rec.pfi, FD.tick.rec.dealid, Dealid)

End;



private macro execCarryQDA(_FD)
    var SQL, CMD, RS, FDQR, PayFIID,dS, err; 
    const chapter = 5;
    const rCarry = 1;
    private var corBuf = TRecHandler("account.dbt");
    private var accBuf = TRecHandler("account.dbt");

    private var tr;
    private var DealCode = "";
    private var isDepo, isKDU;

    GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_DEPOSITARY", V_BOOL, isDepo, err);
    GetRegistryValue("SECUR\\ВЕДЕНИЕ КДУ", V_BOOL, isKDU, err);
    
    if (err)
      MsgBox("Ошибка получение значений настроек \"WORK_WITH_DEPOSITARY\", \"ВЕДЕНИЕ КДУ\"");
      return 1;
    end;

    if (isDepo and isKDU)
      CreateErrMsg(err=28055);
    elif ((not isDepo) and (not isKDU))
      CreateErrMsg(err=28056);
    end;

    if(isDepo and (not isKDU))
      return 1;
    end;

    SQL = "SELECT sc.t_qrid, " +
          "       sc.t_fiid, " +
          "       ac.t_account, " +
          "       ABS (RSI_RSB_ACCOUNT.RestAC (ac.t_ACCOUNT, " +
          "                                    ac.t_CODE_CURRENCY, " +
          "                                    SYSDATE, " +
          "                                    ac.t_CHAPTER, " +
          "                                    0)) " +
          "          Accrest " +
          "  FROM dscqracc_dbt sc, daccount_dbt ac " +
          " WHERE SC.T_ACCOUNTID = AC.T_ACCOUNTID " +
          "       AND ABS (RSI_RSB_ACCOUNT.RestAC (ac.t_ACCOUNT, " +
          "                                        ac.t_CODE_CURRENCY, " +
          "                                        SYSDATE, " +
          "                                        ac.t_CHAPTER, " +
          "                                        0)) > 0 " +
          "        AND sc.t_fiid = ?                " ;
    CMD = RSDCommand(SQL);
    CMD.AddParam("?",RSDBP_IN, _FD.Tick.Rec.Pfi);
    RS=RSDRecordset(CMD, RSDVAL_CLIENT, RSDVAL_STATIC);
    while (RS.MoveNexT())
      FDQR = SC_QRAccFD(RS.Value("t_qrid"));
      PayFIID = RS.Value("t_Fiid");
      dS = RS.Value("AccRest");
      DealCode = _FD.Tick.Rec.DealCode;
      err = НайтиОткрытьСчетаКДУ(RS.Value("t_qrid"),{Curdate},accBuf,corBuf);
      if (not err)
        tr = RsbAccTransaction();
          if(tr == null)
             RunError("Ошибка при формировании проводки");
          end;

/*DAN.Ролевая модель. Определяем конечного операциониста для проводки */
      var retvalGetMO = GetMainOperInGroup(_FD.Kind);
      if (retvalGetMO > 0)
	 Tr.Oper = retvalGetMO;
      else
         Tr.Oper = {Oper};
      end;
/*DAN*/

          tr.Date_Carry = {CurDate};

          tr.Chapter         = 5;
          tr.Department      = {OperDprt};
          tr.Number_Pack     = 10;
          tr.Numb_Document   = "";
          tr.Ground          = "Списание ценных бумаг в операции погашения №" + DealCode;
          tr.FIIDPayer       = PayFIID;
          tr.FIIDReceiver    = PayFIID;
          tr.SumPayer        = dS;
          tr.SumReceiver     = dS;
          tr.AccountPayer    = corBuf.rec.Account;
          tr.AccountReceiver = accBuf.rec.Account;
          tr.Shifr_Oper = DL_GetShifrOper(5, accBuf.rec, corBuf.rec);
          if( not tr.Carry() )
            RunError("Ошибка при выполнении проводки");
          end;    

      end;  
    end;
end;




macro ExecuteStep( Doc, FDoc )
  record deal(dl_tick);       
  var    FD, error; 
  var    CloseAccArray = DL_AccCollector,
         ErrMsgArray   = DL_TUniqStrCollector;
  var    dat;
  var SQL, CMD, RS, FDQR; /*DAN*/
  var ErrCode = 0, OptionValue = false;


  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, false );

   if( ( not IsBROKER(FD.Group) ) AND (FD.tick.rec.Flag1 != SET_CHAR) OR (FD.tick.rec.CarryWrt == UNSET_CHAR))
      if( FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.State != DLRQ_STATE_EXEC  )
         MsgBox("Не выполнен шаг получения средств");
         return 1;
      end;
   end;
  
  if( not ВыполненыВсеПроводки( FD, error ) )
     msgbox( error );
     return 1;
  end;

  if( FD.ЕстьНеиспТО() )
     MsgBox("Обработаны не все ТО по операции");
     return 1;
  end;

 
 if(FD.Tick.rec.clientid == UnknownParty)
  execCarryQDA(FD);
 end;
 
 /*КД*/
 if((FD.Tick.rec.clientid != UnknownParty) and (FD.Tick.rec.dealtype == 12021))

    GetRegistryValue( "РСХБ\\СОБУ И СОВУ ПРИ ПОГАШ. КЛИЕНТ", V_BOOL, OptionValue, ErrCode );
    if( ErrCode != 0 )
       OptionValue = false;
    end;
    If(OptionValue)
       AddCOVUBU(FD);
    end;
 end;

 
  return 0;
end;
