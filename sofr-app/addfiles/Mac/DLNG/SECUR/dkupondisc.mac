/*****************************************************************************/ 
/*                                                           R-Style Softlab */ 
/*                                                                           */ 
/*           Доходы по начисленному купону и дисконту, отраженные            */
/*                          в бухгалтерском учете                            */
/*                                                                           */ 
/*  Create : Punyaev D.V.                                                    */ 
/*  Date   : 05.08.2019                                                      */ 
/*****************************************************************************/


import RsbFormsInter, Global, or_rep_h,"cb_sql.mac","or_tpl_h.mac";

const v_specval = 26;

private macro iif(a,b,c)
      if(a)
         return b;
      else
         return c;
      end;
   end;

CLASS OfferRep(Begdate, Enddate)

/*var Report;
var vDAte   = pDAte;  */

var printEngine, csvTable, csvFile, fName;                   
var rn = 1;
var _BegDate = begdate;        /*GAA:508905 Формироваиние отчета за периол. Ранее - на дату*/
var _EndDate = enddate;        
var sheet = 1,n_sheet = 2;
var count = 0;

var EXCEL_MONEY = "\"# ##0,00\"";

private macro ПечатьШапки ()        
    printEngine.SetValue_NameCell("templateTitle", "За период: " + string(_Begdate) +  " - "+ string(_EndDate):f);
end;

private macro ПечатьБлокаДанных(_rs);
  if(valtype(_rs) != v_undef)
    while(_rs.movenext)
      csvFile.AddCell(_rs.value("ac"));   // 1
      csvFile.AddCell(_rs.value("ost"));  // 2
      csvFile.AddCell(_rs.value("nam1")); // 3
      csvFile.AddCell(_rs.value("isin")); // 4
      csvFile.AddCell(_rs.value("sumk")); // 5
      csvFile.AddCell(_rs.value("sumd")); // 6
      csvFile.AddRow();
    end;
  end;
end;

macro run()
    var SQL, cmd, rs;

    printEngine = CTemplateSXLSX(NULL);

    csvFile = C_CSVFile();
    fName = csvFile.CreateFullFileName("Report_dkupondisc_csv.txt");

    if(printEngine.UsePoi())
        printEngine.SetXLSXFormat();
    end;

    printEngine.OpenTemplate("Report_dkupondisc.xlsx", true);
    printEngine.SheetChange(1);

    csvTable = printEngine.RegisterTable("templateTable", "templateTableHeader", true);

    if (printEngine.UsePoi())
        csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
    end;

    csvFile.FileOpen(fName, true);

    ПечатьШапки();

    SQL="drop table sgs_5";

    cmd = RSDCommand(SQL);
    cmd.execute; 

    SQL="CREATE TABLE sgs_5 AS                                                                                  "+
        "SELECT 1 kind,  a.t_account_receiver acc_receiver,  b.t_fiid, SUM(t_sum_natcur)  smm                       "+
        "FROM dacctrn_dbt A, dfininstr_Dbt b WHERE a.t_account_receiver LIKE '70601%' AND                           "+
        "t_account_payer IN                                                                                         "+
        "(SELECT PD.t_account PDAcc                                                                                 "+
        "FROM dmcaccdoc_dbt PD, dmctempl_dbt bPD                                                                    "+
        "WHERE PD.t_catid=386 AND bPD.t_catid=386                                                                   "+
        "            AND PD.t_templnum=bPD.t_number AND bPD.t_value4 = 1                                            "+
        "            AND PD.t_fiid=b.t_fiid AND PD.t_docid=0 )                                                      "+
        "AND a.t_date_carry between (" + GetSQLDate(_BegDate) + ") and  (" + GetSQLDate(_EndDate) + ")    AND t_state=1  "+ /*GAA: 508770 old: vDate+1; 508905*/
        "GROUP BY  a.t_account_receiver, b.t_fiid                                                                   ";
    cmd = RSDCommand(SQL);
    cmd.execute;
                                                                                                             
    SQL="INSERT INTO sgs_5                                                                                      "+
        "SELECT 1 kind,  a.t_account_payer acc_payer, b.t_fiid, -SUM(t_sum_natcur)  smm                             "+
        "FROM dacctrn_dbt A, dfininstr_Dbt b WHERE a.t_account_payer LIKE '70601%' AND                              "+
        "t_account_receiver IN                                                                                      "+
        "(SELECT PD.t_account PDAcc                                                                                 "+
        "FROM dmcaccdoc_dbt PD, dmctempl_dbt bPD                                                                    "+
        "WHERE PD.t_catid=386 AND bPD.t_catid=386                                                                   "+
        "            AND PD.t_templnum=bPD.t_number AND bPD.t_value4=1                                              "+
        "            AND PD.t_fiid=b.t_fiid AND PD.t_docid=0 )                                                      "+
        "AND a.t_date_carry between (" + GetSQLDate(_BegDate) + ") and  (" + GetSQLDate(_EndDate) + ")     AND t_state=1  "+ /*GAA: 508770? old: vDate+1; 508905*/
        "GROUP BY  a.t_account_payer, b.t_fiid                                                                      ";
    cmd = RSDCommand(SQL);
    cmd.execute;
  
    SQL="INSERT INTO sgs_5                                                                                      "+
        "SELECT 2 kind,  a.t_account_receiver acc_receiver, b.t_fiid, SUM(t_sum_natcur)  smm                        "+
        "FROM dacctrn_dbt A, dfininstr_Dbt b WHERE a.t_account_receiver LIKE '70601%' AND                           "+
        "t_account_payer IN                                                                                         "+
        "(SELECT PD.t_account PDAcc                                                                                 "+
        "FROM dmcaccdoc_dbt PD, dmctempl_dbt bPD                                                                    "+
        "WHERE PD.t_catid=386 AND bPD.t_catid=386                                                                   "+
        "            AND PD.t_templnum=bPD.t_number AND bPD.t_value4=2                                              "+
        "            AND PD.t_fiid=b.t_fiid AND PD.t_docid=0 )                                                      "+
        "AND a.t_date_carry between (" + GetSQLDate(_BegDate) + ") and  (" + GetSQLDate(_EndDate) + ")     AND t_state=1 "+ /*GAA: 508770? old: vDate+1; 508905*/
        "GROUP BY  a.t_account_receiver, b.t_fiid                                                                   ";
    cmd = RSDCommand(SQL);
    cmd.execute;
                                                                                                            
    SQL="INSERT INTO sgs_5                                                                                      "+
        "SELECT 2 kind,  a.t_account_payer acc_payer, b.t_fiid, -SUM(t_sum_natcur)  smm                             "+
        "FROM dacctrn_dbt A, dfininstr_Dbt b WHERE a.t_account_payer LIKE '70601%' AND                              "+
        "t_account_receiver IN                                                                                      "+
        "(SELECT PD.t_account PDAcc                                                                                 "+
        "FROM dmcaccdoc_dbt PD, dmctempl_dbt bPD                                                                    "+
        "WHERE PD.t_catid=386 AND bPD.t_catid=386                                                                   "+
        "            AND PD.t_templnum=bPD.t_number AND bPD.t_value4=2                                              "+
        "            AND PD.t_fiid=b.t_fiid AND PD.t_docid=0 )                                                      "+
        "AND a.t_date_carry between (" + GetSQLDate(_BegDate) + ") and  (" + GetSQLDate(_EndDate) + ")     AND t_state=1 "+ /*GAA: 508770? old: vDate+1; 508905*/
        "GROUP BY  a.t_account_payer, b.t_fiid                                                                      ";
    cmd = RSDCommand(SQL);
    cmd.execute;

    SQL="WITH pod AS (                                                                                          "+
        "SELECT kind,  acc_receiver, t_fiid, SUM(smm)  smm                                                            "+
        "FROM sgs_5                                                                                                   "+
        "GROUP BY acc_receiver, t_fiid, kind                                                                          "+
        ")                                                                                                            "+
        "SELECT c.acc_receiver ac /*Счёт*/,  rsb_account.RestAC(c.acc_receiver, 0,                                    "+
        " (" + GetSQLDate(_EndDate) + ") , 1, 0, 0) ost /*Остаток на счёте*/,                                      "+
        " (SELECT t_name FROM dfininstr_dbt WHERE t_fiid=c.t_fiid) nam1 /*Наименование ценной бумаги*/,               "+
        "(SELECT t_isin FROM davoiriss_dbt WHERE t_fiid=c.t_fiid) ISIN,  NVL(a.smm,0) sumk /*Сумма купона*/,          "+
        " NVL(b.smm,0) sumd /*Сумма дисконта*/                                                                        "+
        "FROM /* dfininstr_Dbt fi, */ (SELECT * FROM pod WHERE kind=1) A, (SELECT * FROM pod WHERE kind=2)  b,        "+
        "(SELECT DISTINCT acc_receiver, t_fiid FROM pod) C                                                            "+
        "WHERE c.acc_receiver = a.acc_receiver(+) AND c.acc_receiver = b.acc_receiver(+)                              "+
        " AND c.t_fiid = a.t_fiid(+) AND  c.t_fiid = b.t_fiid(+)                                                      "+
        "ORDER BY 1,2                                                                                                 ";

    cmd = RSDCommand(SQL);
    begaction(100,"Сбор данных...");
    rs = RSDRecordset(cmd, rsdval_client,rsdval_static);
    ПечатьБлокаДанных(rs);
    endaction;

    csvFile.FileClose();
    csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
    csvTable.EndTable();

    printEngine.SetAutoFilter("A6:F6", 1);

    printEngine.SaveAsTemplate("Доходы по начисленному купону и дисконту, отраженные в бухгалтерском учете на дату_" + string(_Begdate) +  " - "+ string(_EndDate):f, true);
    printEngine.Close();

 end;  

END;

CLASS (TRsbPanel) Pan                                                                                
    initTRsbPanel();                                                                                 
                                                                                                     
                                                                                                     
    const K_Enter = 13;                                                                              
    const K_F3    = 317;                                                                             
    const K_F2    = 316;                                                                             
                                                                                                     
    const BeginCalcDate_ID = 1;                                                                      
    const EndCalcDate_ID = 2;                                                                        
    var curstr = 1;                                                                                  
    Caption = "Доходы по начисленному купону и дисконту.";
    Status = "~ESC~Выход ~F2~Выполнить";                                                             
    setSize(37,4);                                                                                   
    setPosition(30,10);                                                                              
    var BeginCalcDate, EndCalcDate, dx;                                                              
    var RuDataFlag = 0;                                                                              
    var InPortfolioFlag = 1;                                                                         
                                                                                                     
    curstr = curstr+1;                                                                               
    BeginCalcDate = TRsbEditField(V_DATE);                                                           
    BeginCalcDate.setPosition(12,curstr);                                                            
    BeginCalcDate.setSize(8,1);                                                                      
    BeginCalcDate.name = "begincalcdate";                                                            
    BeginCalcDate.value = {curdate};                                                                 
    addControl(BeginCalcDate);                                                                       
                                                                                                     
    EndCalcDate = TRsbEditField(V_DATE);                                                             
    EndCalcDate.setPosition(23,curstr);                                                              
    EndCalcDate.setSize(8,1);                                                                        
    EndCalcDate.name = "endincalcdate";                                                              
    EndCalcDate.value = {curdate};                                                                   
    addControl(EndCalcDate);                                                                         
                                                                                                     
    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr," За период:");                                     
    addLabel (m_LabelCD);                                                                            
                                                                                                     
    var m_LabelT:TrsbLabel = TRsbLabel(21,curstr,"-");                                               
    addLabel (m_LabelT);                                                                             
                                                                                                     
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));                                  
                                                                                                     
                                                                                                     
    macro onKeyPressed(ev)                                                                           
        if (ev.KeyCode == K_F3)                                                                      
           if ((ev.id == BeginCalcDate_ID) or (ev.id == EndCalcDate_ID ))                            
            BeginCalcDate.value = GetDateByCalendar({CurDate});                                      
            this.redraw;                                                                             
           end;                                                                                      
        elif (ev.KeyCode == K_Enter)                                                                 
            this.redraw;                                                                             
        elif(ev.keyCode == K_F2)                                                                     
         var myRep = OfferRep(BeginCalcDate.value, EndCalcDate.value);                               
         myRep.run;                                                                                  
        end;                                                                                         
    end;                                                                                             
END;                                                                                                 
                                                                                                     
var myPanel:TRsbPanel = Pan;                                                                         
myPanel.run;                                                                                         
exit(1);
