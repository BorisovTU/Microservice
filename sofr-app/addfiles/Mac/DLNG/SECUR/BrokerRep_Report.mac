/*
$Name:        BrokerRep_Report.mac
$Module:      Ценные бумаги
$Description: Отчет брокера. 
              Формирование отчета.
ak - Корректировка по форме банка
ak - Отчет по срочным рынкам
ak - Архивные отчеты
*/

import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "scsrvrepfun.mac", "sc_inacc.mac";
import "dpstdrep.mac", "dl_util_poi_obj.mac";
//import sbcrdinter;
Import "or_tpl_h.mac";
Import "or_class.mac";

/*ak - Срочные рынки*/
import dv_categ;
/*~ak*/

PRIVATE CONST BROKERREP_ERRMAILTEMPL_NOREQ = 1; //Шаблон письма об отсутствующих заявках-поручениях

 var faceValueOnDate;/*CHVA 501688*/

//>dan протокол
class Logger()

    macro RepHeader()
       var str;
       str =     "                             ПРОТОКОЛ ФОРМИРОВАНИЯ ОТЧЕТА БРОКЕРА  \n";
       str = str+"\n";
       str = str+"Дата выполнения  : "+date()+"\n";
       str = str+"Время выполнения : "+time()+"\n";

       str = str+"┌──────┬──────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n";
       str = str+"│      │  ДОГОВОР                         │Комментарий                                                                                                                                                        │\n";
       str = str+"├──────┼──────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤";
       //toRep1(str);                                                                                                   
       println(str);                                                                                                   
    end;
             
    macro RepFooter(suc, er, tot)                                                       
       var str = "└──────┴──────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘\n";
       str = str+"Загружено успешно: "+suc+"\n";               
       str = str+"Ошибки обработки : "+er+"\n";
       str = str+"Всего            : "+tot+"\n";
      println(str);
    end;


    macro RepStr(p0, p1, p2)
        if(p2 == "")
           p2 = "OK"
        end;
       var str = "", a;
       var ar = StrSplit2(p2, 160, true);
       var i = 0;
       while (i < ar.size)
         if (i >=1)
           str = str + "\n";
           p0 = "";
           p1 = "";
         end;
         str  = str + "│"+string(p0   :6)   +"│"+
                          string(p1    :34:l)+"│"+
                          string(ar(i)    :163:l)+"│";
         i = i + 1;

      end;
       return println(str);
    end;

end;
//<dan

macro GetPrinter(ActvPrinter)
   var wsp = CreateObject("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject("WScript.Network", false);
   var printers = wsp.EnumPrinterConnections;
   var c = 0;
   var port = "", RetVal = "";
   for (var i, printers)
      if (mod(c,2)==0) port = i;end;
      if ((index(i,"Microsoft XPS Document Writer") > 0) and 
          (index(i,"redirected") == 0))
         RetVal = i;
      end;
      c = c + 1;
   end;
   if (port == "")
      return ActvPrinter;
   elif (index(port, "PORTPROM") > 0)
      return RetVal+" (Ne00:)";
   else
      return RetVal+" ("+port+")";
   end;
end;


private macro GetClientCode(PartyID, ShortName, Code) //BIQ-5485, короткое имя клиента и его код ММВБ (T_CODEKIND = 8)
    var Select, DataSet, Query;
    
    Query = "select prt.T_SHORTNAME, ob.T_CODE from dparty_dbt prt, dobjcode_dbt ob  "+
            " where ob.t_objectid = prt.t_partyid and OB.T_CODEKIND = 8 and prt.t_partyid = ? ";
    Select = DL_RSDCommand(Query);
    Select.AddParam(PartyID);
    DataSet = Select.Execute(Query);
    if(DataSet.MoveNext())
       setparm(1,DataSet.SHORTNAME);
       setparm(2,DataSet.CODE);
       return true;
    end;  
    return false;
end;

/*CHVA 501688*/
PRIVATE MACRO CheckFaceValueFi(fiid:integer, dateOfSearch:date)
    var facevaluefi:integer;
    var cmd = DL_RSDCommand(" SELECT fininstr.t_facevaluefi, RSB_FIINSTR.FI_GETNOMINALONDATE(?,?) facevalue "
                        + "   FROM dfininstr_dbt fininstr "
                        + "  WHERE  fininstr.t_FIID = ? ");
                      
      cmd.addParam(fiid);
      cmd.addParam(dateOfSearch);
      cmd.addParam(fiid); 
    var DataSet = cmd.execute();

  while (DataSet.moveNext())
    facevaluefi =  DataSet.t_facevaluefi;
    faceValueOnDate = DataSet.facevalue;
  end;
  
  return facevaluefi;     

END;
/*CHVA 501688*/

/*CHVA*/
PRIVATE MACRO isDealCanceled(DealCode:string,ChangeDateBeg:date,ChangeDateEnd:date) 

var cmd = DL_RSDCommand(" select  * "
                        + "   from ddl_tick_dbt tick, ddlrq_dbt rq "
                        + " where t_dealcode = ? and tick.t_dealid = rq.t_docid and rq.t_state = 7 "
                        +"  and rq.t_type = 8 and rq.t_changedate  >= ? and rq.t_changedate <= ?");
                      
   cmd.addParam(DealCode);
   cmd.addParam(ChangeDateBeg);
   cmd.addParam(ChangeDateEnd);
     
var DataSet = cmd.execute();

  while (DataSet.moveNext())
     return true;
  end;
return false; 
END;
/*CHVA*/

// KS 21.05.2019 Получить гарантийные обязательства по клиенту
private macro ГОпоКлиенту(ClientID, dt)
  var go = 0;
  var cmd = DL_RSDCommand(" SELECT lpad(t.t_dlcontrid, 34, '0') t_dlcontrid "
                        + "   FROM ddlcontr_dbt t, dparty_dbt party, dsfcontr_dbt sfcontr "
                        + "  WHERE sfcontr.t_ID = t.t_SfContrID AND "
                        + "        party.t_PartyID = sfcontr.t_PartyID "
                        + "    AND party.t_PartyID = ? "
                        + "  ORDER BY t.t_dlcontrid");

  cmd.addParam(ClientID); 
  var DataSet = cmd.execute();

  while (DataSet.moveNext())
    go = go + ReadNoteForObject(207, DataSet.value("t_dlcontrid"), 1, dt);
  end;
  
  return go;
end;

/*Дату в строку*/
private macro GetDateS(dt:date)
  var i;
  datesplit(dt, i);
  if(i < 10)
    return "0" + substr(string(dt),2);
  else
    return string(dt);
  end;
end;
private macro GetDateS2(dt:date)
  var i;
  datesplit(dt, i);
  if(i < 10)
    return "0" + substr(string(dt),2,5) + substr(string(dt),9);
  else
    return substr(string(dt),1,6) + substr(string(dt),9);
  end;
end;
private macro GetCDS()
  var cmd, DataSet;
  cmd = DL_RSDCommand("select trunc(sysdate) dt from dual");
  DataSet = cmd.execute();
  DataSet.moveNext();
//dan
  return {curdate};

  return date(DataSet.dt);
end;
/*~ak*/

// Добавление картинок в сохранённый файл xls
private MACRO BRR_AddPictureCell(ob:CDAOMSExcel, wb, CellName:string, FilePath:string, FlagLinkToPicFile:bool, FlagDeletePicFile:bool, IsCnv) : bool
   var stat:bool = TRUE;  

   if(  FilePath == "" )
      msgbox( "Не указан путь к файлу" );
      return FALSE;
   end;

   if( not existFile ( FilePath ) )
      msgbox( "Не найден файл ", FilePath, ".|Проверьте правильность пути" );
      return FALSE;
   end;

   if (CellName == "")
      MsgBox("[AddPicture] Ошибка!|Не задан адрес ячейки.");
      Return FALSE;
   end;

   if( StrUpr( GenClassName( ob ) ) == "CDAOMSEXCEL" )
      var Picture:Object = CPicture(FilePath, wb.Sheets(1).Range(CellName).Left, wb.Sheets(1).Range(CellName).Top);

      // Если работаем в трехзвенке, пошлем файлы рисунков на терминал
      if (NOT isStandAlone() and not IsCnv)
          if( NOT CopyFile( toANSI(Picture.GetFileName()), toANSI(Picture.GetTermFileName()) ) )
            MsgBox( "Ошибка при передаче файла <" + toAnsi(Picture.GetFileName()) + "> на терминал.|Из|<" + toAnsi(Picture.GetFileName()) + ">|в|<"+toAnsi(Picture.GetTermFileName()) + ">" );
            return false;
          end;
      end;

      // Вставим рисунок на лист
      stat = ob.AddPicture(IIF(IsCnv, GetCurDir(false)+"\\"+ FilePath, Picture.GetAbsTermFileName()),
                            FlagLinkToPicFile,
                            Picture.GetLeftPos(),
                            Picture.GetTopPos() );

      // Если работаем в трехзвенке, удадалим лишние файлы
      if( (NOT isStandAlone()) AND OR_ExistFile(toANSI(Picture.GetTermFileName())) and not IsCnv )
          OR_DeleteFile( Picture.GetTermFileName() );
      end;

   elif( IsEqClass( "RCW\\java\\ru.softlab.rsbank.poireports.Book", wb ))
      // Вставим рисунок на лист
      wb.addPicture( FilePath, wb.getRangeFirstCol(CellName), wb.getRangeFirstRow(CellName) );

   else
      return FALSE;
   end;
    
   Return stat;
OnError (ObjError)
   If (Index(ObjError.Message, "Range") > 0)
      // Скорее всего не найдена именованная ячейка
      Return TRUE;
   else
      ErrorMessage(ObjError, "[AddPicture] Oшибка!");
      Return FALSE;
   end;
end;  // BRR_AddPictureCell

/*ak - конвертация в pdf для нескольких листов*/
private MACRO SC_ConvertToFormatPDF(ExcelNameFile, FilePath, ResultFileName:@tarray, IsCnv, prefix, postfix, ServDocId, CreateOnTerm)
  var err = 0;

  if(ValType(IsCnv) == V_UNDEF)
    IsCnv = false;
  end;

  if(valtype(prefix) == V_UNDEF)
    prefix = "";
  end;

  if(valtype(postfix) == V_UNDEF)
    postfix = "";
  end;

  if(IsCnv == true)
    ReplaceMacro("isStandAlone", "ThisIsStandAlone"); //!!!Обязательно
  end;

  if(ValType(CreateOnTerm) == V_UNDEF)
    CreateOnTerm = isStandAlone();
  end;

  if( UseExcelApp( CreateOnTerm ) )
    var obj = CDAOMSExcel(ExcelNameFile, true);
    var f1count = obj.SheetCount();
    var filename;
    var i = 1;
    while(i <= f1count)
      obj.Book.Sheets(i).Activate();
      filename = GetFileName (prefix /*+ obj.Book.Sheets(i).Name*/ + postfix, "pdf", ServDocID);// prefix + obj.Book.Sheets(i).Name + postfix + ".pdf";

      if(obj.SaveAs(FilePath + filename, WINREP_FORMAT_PDF) == false)
        msgbox("Ошибка при сохранении файла отчета");
        err = 1;
      end;
      ResultFileName[ResultFileName.size] = filename;
      i = i + 1;
    end;
    obj.Book.Close();

    obj = NULL;
  else
    var t = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, false, true /*POI*/);
    var ExcelName, ext;
    var ExcelDir = SplitFile(ExcelNameFile, ExcelName, ext);

    if( CreateOnTerm )
       SC_CopyFile( "$" + ExcelDir, t.m_WorkDir + "\\", ExcelName + ext );
    end;

    var cr = t.GetReportCreator();
    var b1 = cr.openWorkbook( ExcelNameFile );
    var b1_count = b1.getSheetsCount();
    var i2 = 0;
    while( i2 < b1_count )
      b1.setActiveSheet(i2);
      filename = GetFileName (prefix /*+ obj.Book.Sheets(i).Name*/ + postfix, "pdf", ServDocID);
      var _fn, _fp;
      SplitFile(filename, _fn);
      _fn = _fn + ".xls";
      _fp = t.m_WorkDir + "\\" + _fn ;

      if( b1.saveAs(_fp) == false )
        msgbox("Ошибка при сохранении файла отчета");
        err = 1;
      end;

      if( ( not err ) and CreateOnTerm and ( SC_MoveFile( t.m_WorkDir + "\\", "$" + FilePath, _fn ) ) )
         msgbox("Ошибка при сохранении файла отчета");
         err = 1;
      end;

      if( ( not err) and ( WR_ConvertToFormatLibreOffice( iif( CreateOnTerm, "$" + FilePath + _fn, _fp ),
                                                          iif( CreateOnTerm, "$", "" ) + FilePath + filename,
                                                          WINREP_FORMAT_PDF, CreateOnTerm,  false ) == false ) )
        msgbox("Ошибка конвертации файла отчета в формат pdf");
        err = 1;
      end;

      ResultFileName[ResultFileName.size] = filename;
      i2 = i2 + 1;
    end;
    b1.close();
    b1 = null;
    t.Close();
  end;

  if(IsCnv == true)
    ReplaceMacro("isStandAlone", NULL);
  end;

  return err;
END;
/*~ak*/

/*ak - конвертация в xls для нескольких листов*/
private MACRO SC_ConvertToFormatXLS(ExcelNameFile, FilePath, ResultFileName:@tarray, IsCnv, prefix, postfix, ServDocId, CreateOnTerm)
  var err = 0, filename;
  var ob, mainbook, mainsize, childbook, ind = 1, t, cr, sheetname;

  if(ValType(IsCnv) == V_UNDEF)
    IsCnv = false;
  end;

  if(valtype(prefix) == V_UNDEF)
    prefix = "";
  end;

  if(valtype(postfix) == V_UNDEF)
    postfix = "";
  end;

  if(IsCnv == true)
    ReplaceMacro("isStandAlone", "ThisIsStandAlone"); //!!!Обязательно
  end;

  if(ValType(CreateOnTerm) == V_UNDEF)
    CreateOnTerm = isStandAlone();
  end;


  if( UseExcelApp( CreateOnTerm ) )
    /*Открываем приложение*/

    ob = CDAOMSExcel(null, true);
    ob.Create();
    mainbook = ob.Application.Workbooks.Open(ExcelNameFile, null, false);

    /*Определяем число листов в главной книге*/
    mainsize = mainbook.Sheets.Count;

    /*Цикл по листам*/
    ind = 1;
    while(ind <= mainsize)

      /*Добавляем новый лист*/
      childbook = ob.Application.Workbooks.Add();
      filename = GetFileName (prefix + mainbook.Sheets(ind).Name + postfix, "xls", ServDocID);
  //    filename = mainbook.Sheets(ind).Name + ".xls";

      /*Копируем лист*/
      mainbook.Sheets(ind).Copy(childbook.Sheets(1));
      childbook.Sheets(2).Delete;

      /*Сохраняем книгу*/
      if(childbook.SaveAs(FilePath + filename, WINREP_FORMAT_XLS) == false)
        msgbox("Ошибка при сохранении файла отчета");
        err = 1;
      end;

      /*Закрываем книгу*/
      childbook.Close();

      ResultFileName[ResultFileName.size] = filename;
      ind = ind + 1;
    end;

    /*Закрыаем книгу*/
    mainbook.Close();

    /*Закрываем приложение*/
    ob.Close();

  else
    t = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, false, true /*POI*/);

    var ExcelName, tmpfilexls, ext;
    var ExcelDir = SplitFile(ExcelNameFile, ExcelName, ext);

    if ( ext != ".xls" )
      tmpfilexls = t.m_WorkDir + "\\" + ExcelName + ".xls";

      if( WR_ConvertToFormatLibreOffice( iif( CreateOnTerm, "$", "" ) + ExcelNameFile, tmpfilexls, WINREP_FORMAT_XLS, CreateOnTerm,  false ) == false )
        msgbox("Ошибка при сохранении файла отчета");
        err = 1;
      end;
    elif( CreateOnTerm )
      tmpfilexls = t.m_WorkDir + "\\" + ExcelName + ".xls";

      if( not SC_MoveFile( "$" + ExcelDir, t.m_WorkDir + "\\", ExcelName + ext ) )
        msgbox("Ошибка при сохранении файла отчета");
        err = 1;
      end;
    else
      tmpfilexls = ExcelNameFile;
    end;

    if( not err )
      cr = t.GetReportCreator();
      mainbook = cr.openWorkbook( tmpfilexls );

      /*Определяем число листов в главной книге*/
      mainsize = mainbook.getSheetsCount;

      /*Цикл по листам*/
      ind = 0;
      while(ind < mainsize)
        mainbook.setActiveSheet( ind );
        sheetname = mainbook.getSheetName();

        /*Добавляем новый лист*/
        childbook = cr.addWorkbookXLS();
        filename = GetFileName (prefix + sheetname + postfix, "xls", ServDocID);

        /*Копируем лист*/
        mainbook.copySheet( childbook, sheetname, sheetname );

        /*Сохраняем книгу*/
        if( childbook.saveAs( FilePath + filename ) == false )
          msgbox("Ошибка при сохранении файла отчета");
          err = 1;
        end;

        childbook.close();
        childbook = null;

        ResultFileName[ResultFileName.size] = filename;
        ind = ind + 1;
      end;

      mainbook.close();
      mainbook = null;
      t.CLose();
    end;
  end;

  if(IsCnv == true)
    ReplaceMacro("isStandAlone", NULL);
  end;

  return err;
END;

/*Ковертация в Excel для одного листа*/
private MACRO SC_ConvertToFormatOneXLS(ExcelNameFile, FilePath, ResultFileName:@string, IsCnv, ServDocId, CurrentRepName, CreateOnTerm)
   var err = 0;

   if(ValType(IsCnv) == V_UNDEF)
      IsCnv = false;
   end;

   if(IsCnv == true)
      ReplaceMacro("isStandAlone", "ThisIsStandAlone"); //!!!Обязательно
   end;

   if(ValType(CreateOnTerm) == V_UNDEF)
      CreateOnTerm = isStandAlone();
   end;

   /*Определяем имя файла*/
   ResultFileName = GetFileName (CurrentRepName, "xls", ServDocID);

   if( not UseExcelApp )
      if( CreateOnTerm )
        ExcelNameFile = "$" + ExcelNameFile;
        FilePath = "$" + FilePath;
      end;

      if( WR_ConvertToFormatLibreOffice( ExcelNameFile, FilePath + ResultFileName, WINREP_FORMAT_XLS, CreateOnTerm,  false ) == false )
         msgbox("Ошибка при сохранении файла отчета");
         err = 1;
      end;
   else
      /*Открываем приложение*/
      var ob, wb, mainind;
      ob = CDAOMSExcel(null, true);
      ob.Create();

      /*Открываем книгу*/
      wb = ob.Application.Workbooks.Open(ExcelNameFile, null, false);

      /*Определяем имя файла*/
    //   ResultFileName = GetFileName (wb.Sheets(1).Name, "xls", ServDocID);
    //   ResultFileName = wb.Sheets(1).Name + ".xls";

      /*Сохраняем книгу*/
      if(wb.SaveAs(FilePath + ResultFileName, WINREP_FORMAT_XLS) == false)
          msgbox("Ошибка при сохранении файла отчета");
          err = 1;
      end;

      /*Закрываем книгу*/
      wb.Close();
   end;

   if(IsCnv == true)
      ReplaceMacro("isStandAlone", NULL);
   end;

   Return err;
END;

private macro err_msg(err)
   var count = 0, str = "", i = 0;
   if (err.Err)
      if (IsEqClass ("TRsComErr", err.err))
         count = err.err.Count;
         i = 0;
         while (i < count)
            str = string(str, err.err.Message(i), " (Code = ",err.err.Code(i), ", Level = ",err.err.Level(i), ")", strfor(10));
            i = i + 1
         end;
         str = str + " " + err.Module + " " + err.Line + " " + err.Message;
      elif (valtype(err.err) == v_string)
         str = err.err + " " + err.Module + " " + err.Line + " " + err.Message;
      else
         str = err.Module + " " + err.Line + " " + err.Message;
      end;    
   else
      str = err.Module + " " + err.Line + " " + err.Message;
   end;
   return str;
end;
/*CHVA*/
private macro getLastPb(sht)
      return sht.HPageBreaks.Item(sht.HPageBreaks.Count);
   OnError(er)
      return sht.HPageBreaks.Item(sht.HPageBreaks.Count-1);
   end;
/*CHVA*/
// Shabashov. 5.11.2019 добавил вызов функции сохранения картинки
private var ActvPrint;

private MACRO SC_ConvertToFormatOnePDF(ExcelNameFile, FilePath, ResultFileName:@tarray/*string*/, IsCnv, ServDocID, SignerParty, RepCrDate, CurrentRepName, CreateOnTerm)
   var err = 0, str = "", is2c = isStandAlone;
   var sWorkDir:String;
   var ob, wb, mainind;
   var rc;
   var nSign = 0, sLogo:String;
   var yy, mm,dd;
   var RepFileName;
   var TmpFullFileName, TmpFileName, TmpFileDir;
   
   macro ins_pagebreak
      var sht, last_pb, stmp_row;
      sht = ob.Sheet;
      if (IsShedulerRunning())
      ActvPrint = GetPrinter(ActvPrint);
      end;

      if (ActvPrint == null)
          ActvPrint = ob.Application.ActivePrinter;
      end;    
      //ob.Application.PrintCommunication = false;
      //sht.PageSetup.PaperSize = 9
      //sht.PageSetup.Zoom = 38;
      ob.Application.ActivePrinter = ActvPrint;
      //ob.Application.PrintCommunication = true;   
      // страничный режим
      ob.Application.ActiveWindow.View = 2;
      // если страниц больше одной
      if (sht.PageSetup.Pages.Count > 1) 
         stmp_row = sht.Range("STAMP").Cells.Row;
         //https://support.microsoft.com/ru-ru/help/210663/you-receive-a-subscript-out-of-range-error-message-when-you-use-hpageb
         //bpv обход косяка Excel из-за котрого иногда неверно определяется количество разрывов
         ob.Application.ActiveCell.specialcells(11/*xlLastCell*/).select;
         ob.Application.ActiveCell = "1";//заполни любую ячейку в конце документа
         //
         if (sht.HPageBreaks.Count !=0)/*CHVA*/
                  
         // последний разрыв страницы
         //last_pb = sht.HPageBreaks.Item(sht.HPageBreaks.Count);
          last_pb = getLastPb(sht);/*CHVA*/
         // если разрыв после ячейки со штампом
         if (last_pb.Location.Cells.Row > stmp_row - 16)
            // изменение положения разрыва
            last_pb.Location = sht.Rows(stmp_row - 18);
         end;
        
         ob.Application.ActiveCell.delete;//удалить костыль 
        
      end;/*CHVA*/
      end;
      ob.Application.ActiveWindow.View = 1;
      return true;
   onerror(err)
      str = err_msg(err);
      msgbox(str);
      ob.Application.ActiveWindow.View = 1;
      runerror(str,str);
      return 1; //Прерываем при возникновении ошибки
//      return false;
   end;
   
   GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\WORKDIR", V_STRING, sWorkDir);

   if (ValType(IsCnv) == V_UNDEF)
      IsCnv = false;
   end;
   if (IsCnv == true)
      ReplaceMacro("isStandAlone", "ThisIsStandAlone"); //!!!Обязательно
   end;

   if (ValType(CreateOnTerm) == V_UNDEF)
      CreateOnTerm = not isStandAlone();
   end;

   if( not UseExcelApp(CreateOnTerm) )
      var Ext;
      var sht, rowbreaks, internalSheet, rec;
      SplitFile( ExcelNameFile, TmpFileName, Ext );
      TmpFileDir = GetWorkDirName();
      TmpFullFileName = MergeFile(TmpFileDir, TmpFileName, ".xls");

      if( CreateOnTerm )
        ExcelNameFile = "$" + ExcelNameFile;
      end;

      if( WR_ConvertToFormatLibreOffice( ExcelNameFile, TmpFullFileName, WINREP_FORMAT_XLS, CreateOnTerm,  false ) )
         //ob.PoiOpenTotalBook(TmpFullFileName);
         var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
         rc = jvm.callStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");
         wb = rc.openWorkbook(TmpFullFileName);
      end;
   else
      /*Открываем приложение*/
      ob = CDAOMSExcel(null, true);
      // Shabashov. Другой способ открытия книги
      ob.Open(ExcelNameFile);
      ob.Application.DisplayAlerts = false;
      ob.Application.Visible = false;
      wb = ob.Book;
   end;
   // Добавить картинку в файл

   GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\LOGO", V_STRING, sLogo);
   if (NOT BRR_AddPictureCell(ob, wb, "LOGO", sLogo, FALSE, TRUE, IsCnv))
      MsgBox("Ошибка добавления картинки");
      err = 1;
   end;
/*
   sLogo = "";
   GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\STAMP", V_STRING, sLogo);
   if (NOT BRR_AddPictureCell(ob, wb, "STAMP", sLogo, FALSE, TRUE, IsCnv))
      MsgBox("Ошибка добавления картинки");
      err = 1;
   end;
*/
   sLogo = "";
   GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\SIGN_1", V_INTEGER, nSign);/*номер примечания в котором лежит путь*/
   sLogo = ReadNoteForObject(OBJTYPE_PARTY , string(SignerParty:o:10), nSign );

//   GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\SIGN_1", V_STRING, sLogo);
   if (NOT BRR_AddPictureCell(ob, wb, "SIGN_1", sLogo, FALSE, TRUE, IsCnv))
      MsgBox("Ошибка добавления картинки");
      err = 1;
   end;

   // вставить разрыв страницы
   if( UseExcelApp(CreateOnTerm) and ( not ins_pagebreak() ) )
      err = 1;
   end;

   /*Определяем имя файла*/

    var sheetname;
    if ( UseExcelApp(CreateOnTerm) )
      sheetname = ob.Sheet.Name;
    else
      sheetname = wb.getSheetName();
    end;

//   ResultFileName = ob.Sheet.Name + ".pdf";
   if( (CurrentRepName != "") or (CurrentRepName != NULL) )
     RepFileName = CurrentRepName  + ".pdf";
   elif (ServDocID == -1)
     DateSplit(RepCrDate, dd,mm,yy);
     RepFileName = string(ob.Sheet.Name,"_", yy:f, mm:2:o:f, dd:2:o:f, ".pdf");
   else
     RepFileName = GetFileName (ob.Sheet.Name, "pdf", ServDocID);
   end;
   /*Сохраняем книгу*/
   //wb.SaveAs(FilePath + RepFileName, WINREP_FORMAT_PDF);
   var FullRepFileName = FilePath + RepFileName;

   if( not UseExcelApp(CreateOnTerm) )
      // Сохраняем временный файл xls
      wb.save();

      // отправляем временный файл на термнал для конвертации в 3-звенке
      if( ( not err ) and CreateOnTerm and ( SC_MoveFile( TmpFileDir, "$" + FilePath, TmpFileName + ".xls" ) ) )
         msgbox("Ошибка при сохранении файла отчета");
         err = 1;
      end;

      // конвертируем в pdf
      if( ( not err ) and ( WR_ConvertToFormatLibreOffice( iif( CreateOnTerm, "$" + FilePath, TmpFileDir ) + TmpFileName + ".xls",
                                                           iif( CreateOnTerm, "$", "" ) + FullRepFileName,
                                                           WINREP_FORMAT_PDF, CreateOnTerm,  false ) == false ) )
         msgbox("Ошибка конвертации файла отчета в формат pdf");
         err = 1;
      end;
   else
      ob.Check_SaveAs(FullRepFileName);
      if(wb.ExportAsFixedFormat(0, FullRepFileName, 0, 0, 0, 1, 99, 0)== false)/*CHVA 515949*/
         msgbox("Ошибка при сохранении файла отчета");
         err = 1;
      end;

      /*Закрываем книгу*/
      wb.Close(false);
      wb = null;
      //ob.Application.Quit;
      ob = null;
   end;
   
   SplitFile(FullRepFileName, RepFileName);
   ResultFileName[ResultFileName.size] = RepFileName + ".pdf";

   if(IsCnv == true)
      ReplaceMacro("isStandAlone", NULL);
   end;
   Return err;
onerror(err)   
   str =  err_msg(err);
   msgbox(str);
   if (wb)
      wb.Close;
   end;   
   wb = null;
   //ob.Application.Quit;
   ob = null;
   if(IsCnv == true)
      ReplaceMacro("isStandAlone", NULL);
   end;
   return 1
END;
/*~ak*/

PRIVATE MACRO _POIAddPictureAndConvertToPDF( repPoiObj, TmpFilePath, FilePath, ResultFileName:@tarray/*string*/, IsCnv, ServDocID, SignerParty, RepCrDate, CurrentRepName )
  // Добавить картинку в файл
  var wb = repPoiObj.poiBook;

  macro ins_pagebreak()
    var rowBreaks = repPoiObj.FixRowHeightsAndRowBreaks();
    var sign_row = wb.getRangeFirstRow( "SIGN_1" );
    var shift = 0;
    for( var rowBreak, rowBreaks )
      if( ( rowBreak + shift > sign_row ) and ( rowBreak + shift < sign_row + 16 ) )
        shift = shift + ( sign_row - ( rowBreak + shift ) ) - 2;
      end;

      if( shift < 0 )
        repPoiObj.poiCurrentSheet.removeRowBreak( rowBreak );
        repPoiObj.poiCurrentSheet.setRowBreak( rowBreak + shift );
      end;
    end;
    return true;
  onError(err)
    MsgBox( "Ошибка установки разрывов страниц|" + err_msg( err ) );
    return false;
  end;

  var err = 0, str = "";
  var nSign = 0, sLogo:String;
  var yy, mm,dd;
  var RepFileName, TmpFileName;

  if (ValType(IsCnv) == V_UNDEF)
    IsCnv = false;
  end;
  if (IsCnv == true)
    ReplaceMacro("isStandAlone", "ThisIsStandAlone"); //!!!Обязательно
  end;

  GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\LOGO", V_STRING, sLogo);
  if (NOT BRR_AddPictureCell(null, wb, "LOGO", sLogo, FALSE, TRUE, IsCnv))
    MsgBox("Ошибка добавления картинки");
    err = 1;
  end;

  sLogo = "";
  GetRegistryValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\SIGN_1", V_INTEGER, nSign);/*номер примечания в котором лежит путь*/
  sLogo = ReadNoteForObject(OBJTYPE_PARTY , string(SignerParty:o:10), nSign );

  if (NOT BRR_AddPictureCell(null, wb, "SIGN_1", sLogo, FALSE, TRUE, IsCnv))
    MsgBox("Ошибка добавления картинки");
    err = 1;
  end;

  if( not ins_pagebreak()  )
    err = 1;
  end;

  /*Определяем имя файла*/
  var sheetname = repPoiObj.poiCurrentSheet.getSheetName();

  if( (CurrentRepName != "") or (CurrentRepName != NULL) )
    RepFileName = CurrentRepName  + ".pdf";
  elif (ServDocID == -1)
    DateSplit(RepCrDate, dd,mm,yy);
    RepFileName = string(sheetname,"_", yy:f, mm:2:o:f, dd:2:o:f, ".pdf");
  else
    RepFileName = GetFileName (sheetname, "pdf", ServDocID);
  end;

  SplitFile( RepFileName, TmpFileName );
  TmpFileName = MergeFile( TmpFilePath, TmpFileName, ".xls" );
  repPoiObj.Save( TmpFileName );

  var FullRepFileName = FilePath + RepFileName;

  // конвертируем в pdf
  if( ( not err ) and ( WR_ConvertToFormatLibreOffice( TmpFileName, FullRepFileName, FORMAT_PDF_ONLY ) == false ) )
    msgbox("Ошибка конвертации файла отчета в формат pdf");
    err = 1;
  end;

  RemoveFile( TmpFileName );

  SplitFile(FullRepFileName, RepFileName);
  ResultFileName[ResultFileName.size] = RepFileName + ".pdf";

  if(IsCnv == true)
    ReplaceMacro("isStandAlone", NULL);
  end;
  Return err;
onerror(err)
  str =  err_msg(err);
  msgbox(str);
  if(IsCnv == true)
    ReplaceMacro("isStandAlone", NULL);
  end;
  return 1
END;

CLASS CBrokerRepErrMail (_Subject, _Body)
  var Subject = _Subject;
  var Body = _Body;
END;

private macro GetErrMailTempl(TemplID:integer, err:@variant)
   var cmd = RSDCommand("begin RSB_BRKREP.GetErrMailTempl(:TemplID, :Subject, :Body, :err); end;");
   cmd.AddParam("TemplID", RSDBP_IN,  TemplID);
   cmd.AddParam("Subject", RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("Body",    RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("err",     RSDBP_OUT, V_INTEGER);
   cmd.NullConversion = true;
   cmd.Execute();

   if (cmd.Value("err") == 0)
      return CBrokerRepErrMail( iif(ValType(cmd.Value("Subject")) == V_STRING, cmd.Value("Subject"), ""),
                                iif(ValType(cmd.Value("Body")) == V_STRING, cmd.Value("Body"), ""));
   else
      err = "Не удалось получить шаблон письма для отправки сообщения об ошибке";
      return NULL;
   end;
onerror(er)
   err = err_msg(er);
   return NULL;
end;


CLASS CBrokerRepData(_NameFile:string, _Format:integer, _CreateDate:date, _CreateTime:time, _ContractID:integer)
  var NameFile   = _NameFile;      //имя сформированного файла
  var Format     = _Format;        //формат файла
  var CreateDate = _CreateDate;    //дата формирвоания
  var CreateTime = _CreateTime;    //время формирования
  var ContractID = _ContractID;  //
  if (ValType(ContractID) == V_UNDEF)
     ContractID = 0;
  end;
END;

CLASS CBrokerRepParams()
  var PeriodKind:integer = SC_REPPERIODKIND_DAY, // Вид периода
      BegDate:date       = {curdate},            // Начальная дата
      EndDate:date       = {curdate},            // Конечная дата
      ClientID:integer   = -1,                   // Клиент
      CntrID:integer     = 0,                    // Договор
      IsMarket:bool      = true,                 // по биржевым сделкам?
      ServDocId:integer      = -1,               // идентификатор сервисной операции
      ByStock:bool      = StrFor(0),             // 
      ByDv:bool      = StrFor(0),                // 
/*ak
      IsOutMarket:bool   = false,                // по внебиржевым сделкам?*/
      IsOutMarket:bool   = true,                 // по внебиржевым сделкам?
/*~ak*/
      IsFiMovement:bool  = true,                 // по движению ФИ?
/*ak
      IsNotZeroRest:bool = false,                // по ненулевым остаткам?*/
      IsNotZeroRest:bool = true,                 // по ненулевым остаткам?
/*~ak*/
/*ak
      ShowPlanRest:bool       = false,                // показывать плановые исходящие остатки*/
      ShowPlanRest:bool       = true,                // показывать плановые исходящие остатки
/*~ak*/
      SHOWEMPTY:bool     = false,                // показывать пустые пункты при отсутствии данных  
      IsApp:bool         = true,                 // апострофы?
/*ak
      PdfFormat:bool     = true,                 // печатать в PDF
      ExcelFormat:bool   = false,                // печатать в Excel*/
      PdfFormat:bool     = false,                // печатать в PDF
      ExcelFormat:bool   = true,                 // печатать в Excel
/*~ak*/

      ShowFile:bool      = false,                // показать отчет
      InCnv              = false,                // признак того, что отчет формируется в конвейере
      InServOp           = false,                // признак того, что отчет формируется в сервисной операции
      NoData:bool        = false,                // Нет данных для выпуска отчета
      NoReq:bool         = false,                // Нет заявок-поручений по сделкам клиента
      SignerParty        = -1,                   //номер операциониста подписанта. Из примечания на субъекте будет браться путь к скану подписи

      RepData            = TArray();             // массив данных о сформированных файлах
  var RepCrDate          = {Curdate};            //dan Пользовательский параметр. Дата составления отчета

  var ErrMails           = TArray();             // массив с сообщениями об ошибке

  var CourseCurVisible:bool = false;             //mva biq-12110 настройка "Отображение валюты котировки в Отчете Брокера"
END;


PRIVATE MACRO SubTypeContr (t_ID):INTEGER //BIQ-5485
var sql, cmd, DSet; 
   sql = "select T_SERVKINDSUB from  dsfcontr_dbt where t_id = ? ";
   cmd = DL_RSDCommand(sql);
   cmd.AddParam(t_ID);
   DSet = cmd.Execute();
      if(DSet.movenext())
       return DSet.T_SERVKINDSUB;
      end;
END;

PRIVATE MACRO AmountPrecision(Amount):INTEGER
  if(IsHaveFractPart(Amount)) 
     return 6;
  else
     return 0;
  end;
END;

PRIVATE CLASS СBrokerRep_ClientData(ClientID:integer, SfContrID:integer, EndDate:date)
/*ak*/
  class acc
    var CODE_CURRENCY, ACCOUNT, CHAPTER, RESTIN, RESTOUT, CREDITAC, DEBETAC;
  end;
/*~ak*/
  PRIVATE VAR m_ClientID  = ClientID;
  PRIVATE VAR m_SfContrID = SfContrID;
  PRIVATE VAR m_EndDate   = EndDate;

  PRIVATE VAR m_ShortName   = "";
  PRIVATE VAR m_ClientCode  = "";
  PRIVATE VAR m_ContrDate   = date(0,0,0);
  PRIVATE VAR m_ContrNumber = "";
/*ak*/
  private var m_IsIndividual = false;
  private var m_Note104DBO = "";
  private var m_Market = true;
  private var m_ClientEmail = "";
  private var m_IsMail = false;
/*~ak*/

  PRIVATE VAR m_accArr  = TArray();
  PRIVATE VAR m_ind = 0;
  
/*ak - Перенес в PL/SQL*/

  PRIVATE MACRO GetEmailByContactType(ClientID:integer, ContactType:integer, all:bool)
    var cmd, DataSet;
    var email = "";

    if(valtype(all) != V_BOOL)
      all = false;
    end;

    cmd = DL_RSDCommand(    " SELECT c.t_Value as email"
                          + "   FROM dcontact_dbt c "
                          + "  WHERE c.t_PartyID = ? "
                          + "    AND c.t_ContactKind = " + CNTK_EMAIL
                          + "    AND c.t_ContactType = ? " 
                          + "  order by c.t_IsMain desc"
                         );
    cmd.addParam(ClientID);
    cmd.addParam(ContactType);

    DataSet = cmd.execute();
    while(DataSet.moveNext())
      if(email == "")
        email = DataSet.email;
        if(not all)
          break;
        end;
      else
        email = email + "," + DataSet.email;
      end;
    end;

    return email;
  END;

  PRIVATE MACRO GetEmailDBO(ContractID:integer)
    var cmd, DataSet;
    var email = "";

    cmd = DL_RSDCommand("select dlcontr.t_email t_email "
                       +"from dsfcontr_dbt sfcontr "
                       +"join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_sfcontrid = sfcontr.t_id "
                       +"join ddlcontr_dbt dlcontr on dlcontr.t_dlcontrid = dlcontrmp.t_dlcontrid and dlcontr.t_email != chr(1) "
                       +"where sfcontr.t_id = ?");
    cmd.addParam(ContractID);

    DataSet = cmd.execute();
    if(DataSet.moveNext())
      email = DataSet.email;
    end;

    return email;
  END;

  MACRO Load()
    var cmd, query, DataSet, fncash, indx;
    var BrokerBccList:string = GetBrokerBccList(); //список адресов для отправки скрытой копии

    query =  " select t_ShortName, "
            + "       t_clientcode, "
            + "       t_contrdate, "
            + "       t_contrnumber, "
            + "       t_isindividual, "
            + "       t_note104dbo, "
            + "       t_clienttype "
            + "from dbrkrep_contr_u_tmp "
            + "where t_clientid = ? and "
            + "      t_contrid = ?";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_ClientID);
    cmd.AddParam(m_SfContrID);
    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      m_ShortName   = DataSet.ShortName;
      m_ClientCode  = DataSet.ClientCode;
      m_ContrDate   = date(DataSet.ContrDate);
      m_ContrNumber = DataSet.ContrNumber;
      if(DataSet.IsIndividual == "X")
        m_IsIndividual = true;
      end;
      m_Note104DBO = DataSet.note104dbo;
      if(DataSet.ClientType == "N")
        m_Market = false;
      end;
      /*Ищем email для отчетов в клиента*/
      m_ClientEmail = GetEmailByContactType(m_ClientID, CNTT_TOSENDREPORTS/*для отчетов*/, true/*все*/);
      /*Не нашли в клиенте - смотрим в ДБО*/
      if(m_ClientEmail == "")
        m_ClientEmail = GetEmailDBO(m_SfContrID);
      end;
      /*Не найден e-mail клиента*/
      if(m_ClientEmail == "")
        m_IsMail = true;
        indx = index(m_ContrNumber, "/");
        if((indx >= 2) and (indx <= 3))
          fncash = substr(m_ContrNumber, 1, indx - 1);
        else
          fncash = "0";
        end;
        query = "select nvl(case when regexp_like(s, '^\d{1,2}$') "
              + "                then (select max(dp_dep.t_partyid) "
              + "                      from ddp_dep_dbt dp_dep "
              + "                      where dp_dep.t_name = lpad(s,2,'0')||'00') "
              + "           else null end, "
              + "           (select nvl(max(dp_dep.t_partyid),0) "
              + "            from ddp_dep_dbt dp_dep "
              + "            where dp_dep.t_name = '0000')) t_partyid "
              + "from (select ? s from dual)";
        cmd = DL_RSDCommand(query);
        cmd.AddParam(fncash);
        DataSet = cmd.Execute();
        DataSet.moveNext();
        m_ClientEmail = GetEmailByContactType(DataSet.partyid, CNTT_TOSENDREPORTS/*для отчетов*/, false/*первый*/);
      /*Найден e-mail клиента*/
      else
        if(BrokerBccList != "")
          m_ClientEmail = BrokerBccList + "," + m_ClientEmail;
        end;
      end;
    end;

    query =   "select * "
            + "from dbrkrep_contr_acc_u_tmp "
            + "where t_clientid = ? and "
            + "      t_contrid = ?"
            + "order by t_code_currency, t_account";
/*
var exexlog =  RSDCommand("begin rshb_brkrep.InsertLog(?); end;");
    exexlog.addParam( "", RSDBP_IN, "3="+m_ClientID+"|"+m_SfContrID);
    exexlog.execute();
*/
    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_ClientID);
    cmd.AddParam(m_SfContrID);
    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      m_accArr[m_accArr.size] = acc;
      m_accArr[m_accArr.size-1].CODE_CURRENCY = DataSet.CODE_CURRENCY;
      m_accArr[m_accArr.size-1].ACCOUNT = DataSet.ACCOUNT;
      m_accArr[m_accArr.size-1].CHAPTER = DataSet.CHAPTER;
      m_accArr[m_accArr.size-1].RESTIN = DataSet.RESTIN;
      m_accArr[m_accArr.size-1].RESTOUT = DataSet.RESTOUT;
      m_accArr[m_accArr.size-1].CREDITAC = DataSet.CREDITAC;
      m_accArr[m_accArr.size-1].DEBETAC = DataSet.DEBETAC;
    end;

  END;

  MACRO ShortName():STRING
    return m_ShortName;
  END;

  MACRO ClientCode():STRING
    return m_ClientCode;
  END;

/*ak*/
  macro IsIndividual():bool
    return m_IsIndividual;
  end;

  macro Note104DBO():string
    return m_Note104DBO;
  end;

  macro Market():bool
    return m_Market;
  end;

  MACRO ClientEmail():STRING
    return m_ClientEmail;
  END;

  MACRO IsMail():BOOL
    return m_IsMail;
  END;

/*ak*/

  MACRO ContrDate():DATE
    return m_ContrDate;
  END;

  MACRO ContrNumber():STRING
    return m_ContrNumber;
  END;

  MACRO GetAccByInd(ind)
    if(ValType(m_accArr[ind]) != V_UNDEF)
      return m_accArr[ind];
    end;
    return NULL;
  END;

  MACRO GetFirstAcc()
    return GetAccByInd(m_ind = 0);
  END;

  MACRO GetNextAcc()
    return GetAccByInd(m_ind = m_ind + 1);
  END;

  Load();

END;

PRIVATE CONST DIRECTION_NO   = 0; //Направления нет (для итоговых строк)
PRIVATE CONST DIRECTION_BUY  = 1; //Покупка
PRIVATE CONST DIRECTION_SALE = 2; //Продажа

//Группы данных данных
PRIVATE CONST BROKERREP_PART_DEALINPERIOD = 1; //СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С : ПО :
PRIVATE CONST BROKERREP_PART_NOTEXECDEAL  = 2; //СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И НЕ ИСПОЛНЕННЫЕ НА
PRIVATE CONST BROKERREP_PART_EXECDEAL     = 3; //СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА
PRIVATE CONST BROKERREP_PART_REPODEAL     = 4; //СДЕЛКИ РЕПО, СОВЕРШЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА
PRIVATE CONST BROKERREP_PART_COUPPAYMS    = 5; //ИНФОРМАЦИЯ О КОМПЕНСАЦИОННЫХ ВЗНОСАХ И КУПОННЫХ ВЫПЛАТАХ
PRIVATE CONST BROKERREP_PART_MONEYMOVE    = 6; //ДВИЖЕНИЕ ПО ДЕНЕЖНЫМ СРЕДСТВАМ
PRIVATE CONST BROKERREP_PART_INACC        = 7; //СОСТАВ ПОРТФЕЛЯ ПО ИТОГАМ ТОРГОВ

PRIVATE CONST BROKERREP_PART_CANCELEDDEAL  = 8; //СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ОТМЕНЕННЫЕ НА   /*CHVA 503652*/

//Виды расчетных операций
PRIVATE CONST BROKERREP_CALCOP_RECEPCLCUR = 6; //Прием от клиента д/с
PRIVATE CONST BROKERREP_CALCOP_RETURNCLCUR = 7; //Возврат клиенту д/с

PRIVATE CONST BROKERREP_DL_SETTLOPER = 2030; //Расчетная операция ВУ

//Класс подготовки данных по движению денежных средств
PRIVATE CLASS СBrokerRep_MoveData(RepParams:CBrokerRepParams, ContrID:integer)
  VAR m_RepParams = RepParams;
  VAR m_ContrID = ContrID;
  VAR m_ClientData = СBrokerRep_ClientData(m_RepParams.ClientID, m_ContrID, m_RepParams.EndDate);
  PRIVATE VAR m_A36, m_A37, m_A38, m_A39, m_A40, m_A41, m_A42, m_A43, m_A44, m_A45, m_A46, m_A47, m_A48, m_A49, m_A49_1, m_A50, m_A51, m_A51_1;
/*ak*/
  private var m_A38f, m_A40f, m_A42f, m_A44f, m_A45f, m_A46f, m_MarketComissNDS;
/*~ak*/
  PRIVATE VAR m_Currency = -1;

  PRIVATE MACRO Clear()
    m_A36   = NULL;
    m_A37   = NULL;
    m_A38   = NULL;
    m_A39   = NULL;
    m_A40   = NULL;
    m_A41   = NULL;
    m_A42   = NULL;
    m_A43   = NULL;
    m_A44   = NULL;
    m_A45   = NULL;
    m_A46   = NULL;
    m_A47   = NULL;
    m_A48   = NULL;
    m_A49   = NULL;
    m_A49_1 = NULL;
    m_A50   = NULL;
    m_A51   = NULL;
    m_A51_1 = NULL;
/*ak*/
    m_A38f  = NULL;
    m_A40f  = NULL;
    m_A42f  = NULL;
    m_A44f  = NULL;
    m_A45f  = NULL;
    m_A46f  = NULL;
    m_MarketComissNDS = null;
/*~ak*/

    m_Currency = -1;
  END;

  //Получить массив валют счетов клиента
  MACRO GetCurrArr(currAcc:@tarray)
    var currArr = TArray();
    var acc = m_ClientData.GetFirstAcc();
    
    macro GetCurrInd(FIID)
      var ind = -1;
      var i = 0;
      while(i < currArr.size())
        if(currArr[i] == FIID)
          ind = i;
          break;
        end;

        i = i + 1;
      end;
      return ind;
    end;

    currAcc = tarray();
    while(acc != NULL)
      currAcc[currAcc.size] = acc.Account;
      var i = GetCurrInd(acc.Code_Currency);
      if(i == -1)
        currArr[currArr.size] = acc.Code_Currency;
      end;
      acc = m_ClientData.GetNextAcc();
    end;

    return currArr;
  END;

  MACRO SetCurrency(Currency)
    Clear();
    m_Currency = Currency;
  END;

  PRIVATE MACRO GetClientRestAC(AccountID:integer, OnDate:date):MONEY
    var query, cmd, DataSet;
    var Rest = $0;
    
    if(AccountID > 0)
      query =   " select rsb_account.restac(t_Account, t_Code_Currency, ?, t_Chapter, null) as t_rest"
              + "   from daccount_dbt "
              + "  where t_AccountID = ? ";

      cmd = DL_RSDCommand(query);         

      cmd.AddParam(OnDate);
      cmd.AddParam(AccountID);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        Rest = DataSet.Rest;
      end; 
    end;

    return Rest;
  END;

  PRIVATE MACRO GetClientInOutSum(AccNumber:string, isIN:bool, ServiceOperFound:@bool)
    var query, cmd, paramCopy, DataSet;
    var Sum = $0;
    
    if(AccNumber != "")
      query =   " select op.t_OutSum "
              + "   from dnptxop_dbt op "
              + "  where op.t_DocKind = " + DL_WRTMONEY
              + "    and op.t_Client = ? "
              + "    and op.t_Contract = ? "
              + "    and op.t_Account = ? "
              + "    and op.t_SubKind_Operation = ? " 
              + "    and op.t_Currency = ? "
              + "    and Exists( select 1 "
              + "                  from ddlrq_dbt rq "
              + "                 where rq.t_DocKind = op.t_DocKind "
              + "                   and rq.t_DocID = op.t_ID "
              + "                   and rq.t_FactDate >= ? "
              + "                   and rq.t_FactDate <= ? "
              + "                   and rq.t_FIID = op.t_Currency "
            /*  + "                   and rq.t_Amount = op.t_OutSum " *//*bpv по сумме отбирать нельзя, т.к. может быть два ТО - по выводу и по налогу*/
              + "              )";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_RepParams.ClientID);
      cmd.AddParam(m_ContrID);
      cmd.AddParam(AccNumber);
      cmd.AddParam(IIF(isIN, DL_NPTXOP_WRTKIND_ENROL, DL_NPTXOP_WRTKIND_WRTOFF));
      cmd.AddParam(m_Currency);
      cmd.AddParam(m_RepParams.BegDate);
      cmd.AddParam(m_RepParams.EndDate);

      //Считаем суммы по операциям списания и зачисления только если записи есть
      if (cmd.GetCount() > 0)
        ServiceOperFound=true;
        paramCopy = TArray(cmd.m_Params);
        cmd = DL_RSDCommand("select NVL(sum(t_OutSum), 0) as InOutSum from ("+query+")");
        cmd.m_Params = paramCopy;     

        DataSet = cmd.Execute();
        if(DataSet.moveNext())
          Sum = DataSet.InOutSum;
        end;        
      end;
    end;

    return Sum;
  END;  

  //Поиск сумм списания/зачисления по расчетным операциям ВУ
  PRIVATE MACRO GetClientInAccSum(AccNumber:string, isIN:bool)
    var query, cmd, DataSet;
    var Sum = $0;
/*
    query = "select NVL(sum(in_acc.t_sum), 0) as InOutSum "
      + " from ddl_acc_dbt dl_acc, ddlinacc_dbt in_acc "
      + " where dl_acc.t_dockind = in_acc.t_documentkind "
      + " and dl_acc.t_id = in_acc.t_documentid "
      + " and dl_acc.t_fiid = in_acc.t_fiid "
      + " and dl_acc.t_opertype = in_acc.t_opertype "
      + " and dl_acc.t_fikind = ? "
      + " and dl_acc.t_fiid = ? "
      + " and dl_acc.t_operkind = ? "
      + " and dl_acc.t_opertype = ? "
      + " and dl_acc.t_client = ? "
      + " and dl_acc.t_clientcontr = ? "
      + " and dl_acc.t_dockind = ? "
      + " and in_acc.t_date >= ? "
      + " and in_acc.t_date <= ? ";
*/
/*      
    query = " SELECT NVL (SUM (in_acc.t_sum), 0) AS InOutSum "
          + "   FROM ddl_acc_dbt dl_acc, ddlinacc_dbt in_acc "
          + "  WHERE     dl_acc.t_dockind = in_acc.t_documentkind "
          + "        AND dl_acc.t_id = in_acc.t_documentid "
          + "        AND dl_acc.t_fiid = in_acc.t_fiid "
          + "        AND dl_acc.t_opertype = in_acc.t_opertype "
          + "        AND dl_acc.t_fikind = :fikind "
          + "        AND dl_acc.t_fiid = :currency "
          + "        AND dl_acc.t_operkind = :operkind "
          + "        AND dl_acc.t_opertype = 1 "
          + "        AND dl_acc.t_client = :clientid "
          + "        AND dl_acc.t_dockind = :calcoper "
          + "        AND in_acc.t_date >= :begdate "
          + "        AND in_acc.t_date <= :enddate "
          + "        AND in_acc.t_debacc IN "
          + "               (  SELECT t_account "
          + "                    FROM dmcaccdoc_dbt "
          + "                   WHERE     t_clientcontrid = :contrid "
          + "                         AND t_catnum = :catnum "
          + "                         AND t_disablingdate = TO_DATE ('01.01.0001', 'dd.mm.yyyy') "
          + "                         AND t_isusable = CHR(88) "
          + "                GROUP BY t_account) ";
*/
    //Golovkin 19.08.2019 IM2971095 счет по дебету в РОВУ - списание, по кредиту - зачисление
    query = " SELECT NVL (SUM (dl_acc.t_sum), 0) AS InOutSum              " +
            "   FROM ddl_acc_dbt dl_acc,                                  " +
            "        doproper_dbt oproper,                                " +
            "        doprdocs_dbt oprdocs,                                " +
            "        dacctrn_dbt acctrn                                   " +
            "  WHERE     dl_acc.t_fikind = :fikind                        " +
            "        AND dl_acc.t_fiid = :currency                        " +
            "        AND dl_acc.t_operkind = :operkind                    " +
            "        AND dl_acc.t_opertype = 1                            " +
            "        AND dl_acc.t_client = :clientid                      " +
            "        AND dl_acc.t_dockind = :calcoper                     " +
            "        AND dl_acc.t_valuedate >= :begdate                   " +
            "        AND dl_acc.t_valuedate <= :enddate                   " +
            "        AND dl_acc.t_dockind = oproper.t_dockind             " +
            "        AND LPAD (DL_ACC.T_ID, 10, 0) = oproper.t_documentid " +
            "        AND oprdocs.t_id_operation = oproper.t_id_operation  " +
            "        AND OPRDOCS.T_ACCTRNID = acctrn.t_acctrnid           ";
    if(isIN)
        query = query + " AND ACCTRN.T_ACCOUNT_RECEIVER = :accNumber ";
    else
        query = query + " AND ACCTRN.T_ACCOUNT_PAYER = :accNumber ";
    end;

    cmd = DL_RSDCommand(query);
    cmd.AddParam(FIKIND_CURRENCY);
    cmd.AddParam(m_Currency);
    cmd.AddParam(BROKERREP_DL_SETTLOPER);
    //cmd.AddParam(IIF(isIN, BROKERREP_CALCOP_RECEPCLCUR, BROKERREP_CALCOP_RETURNCLCUR));
    cmd.AddParam(m_RepParams.ClientID);
    //cmd.AddParam(m_ContrID);
    cmd.AddParam(DL_CALCOPER);
    cmd.AddParam(m_RepParams.BegDate);
    cmd.AddParam(m_RepParams.EndDate);
    //cmd.AddParam(m_ContrID); // 
    //cmd.AddParam(IIF(isIN, 531, 533)); //
    cmd.AddParam(AccNumber); // 

    DataSet = cmd.Execute();

    if(DataSet.moveNext())
      Sum = DataSet.InOutSum;
    end;

    return Sum;
  end;

  PRIVATE MACRO GetFiWarntsSum(IsPartial:bool)
    var query, cmd, DataSet;
    var Sum = $0;

    cmd = DL_RSDCommand();

    query =   " select NVL( Sum( "+IIF(IsPartial, "leg.t_Cost", "leg.t_NKD")+"), 0) as PaySum "
            + "   from ddl_tick_dbt tk, ddl_leg_dbt leg, ddlrq_dbt rq "
            + "  where tk.t_BOfficeKind = " + DL_RETIREMENT
            + "    and tk.t_ClientID = ? "
            + "    and tk.t_ClientContrID = ? "
            + "    and leg.t_DealID = tk.t_DealID "
            + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
            + "    and leg.t_LegID = 0 " 
            + "    and leg.t_CFI = ? "
            + "    and rq.t_DocKind = tk.t_BOfficeKind "
            + "    and rq.t_DocID = tk.t_DealID "
            + "    and rq.t_Type = " + DLRQ_TYPE_PAYMENT
            + "    and rq.t_FactDate >= ? "
            + "    and rq.t_FactDate <= ? ";
            
    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(m_ContrID);
    cmd.AddParam(m_Currency);
    cmd.AddParam(m_RepParams.BegDate);
    cmd.AddParam(m_RepParams.EndDate);

    if(IsPartial)
      query = query + " and tk.t_Number_Partly <> chr(1)";
    else
      query = query + " and tk.t_Number_Coupon <> chr(1)";
    end;

    DataSet = cmd.Execute(query);

    if(DataSet.moveNext())
      Sum = DataSet.PaySum;
    end;

    return Sum;
  END;
  
 
  PRIVATE MACRO GetExecDealSum(Direction:integer, future)
    var query, cmd, DataSet;
    var Sum = $0;
/*ak*/
    if(valtype(future) != V_BOOL)
      future = false;
    end;
/*~ak*/

    query =   " select NVL( Sum(t_A16), 0) as DealsSum "
            + "   from dbrkrepdeal_u_tmp "
            + "  where t_ClientID = ? "
            + "    and t_ContrID = ? "
            //+ "    and t_Part IN ("+BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL+")"
            + "    and t_IsItog = CHR(0) "
            + "    and t_Direction = ? "
            + "    and t_A14_C = ? ";
/*ak*/
    if(not future)
      query = query
            + "    and (t_part = 3 or (t_part = 1 and t_a06 <= ?)) ";
    else
      query = query
            + "    and (t_part = 2 or (t_part = 1 and t_a06 > ?)) ";
    end;
/*~ak*/

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(m_ContrID);
    cmd.AddParam(Direction);
    cmd.AddParam(m_Currency);
/*ak*/
    cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Sum = DataSet.DealsSum;
    end;

    return Sum; 
  END;

 PRIVATE MACRO GetDealNKD(Direction:integer, future)
    var query, cmd, DataSet;
    var Sum = $0;
/*ak*/
    if(valtype(future) != V_BOOL)
      future = false;
    end;
/*~ak*/

    query =   " select NVL( Sum(t_A26), 0) as NKDSum "
            + "   from dbrkrepdeal_u_tmp "
            + "  where t_ClientID = ? "
            + "    and t_ContrID = ? "
            //+ "    and t_Part IN ("+BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL+")"
            + "    and t_IsItog = CHR(0) "
            + "    and t_Direction = ? "
            + "    and t_A14_C = ? ";
/*ak*/
    if(not future)
      query = query
            + "    and (t_part = 3 or (t_part = 1 and t_a06 <= ?)) ";
    else
      query = query
            + "    and (t_part = 2 or (t_part = 1 and t_a06 > ?)) ";
    end;
/*~ak*/

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(m_ContrID);
    cmd.AddParam(Direction);
    cmd.AddParam(m_Currency);
/*ak*/
    cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Sum = DataSet.NKDSum;
    end;

    return Sum; 
  END; 

  //Входящая сумма средств на счете
  MACRO A36():MONEY
    if(m_A36 == NULL)
      var acc = m_ClientData.GetFirstAcc();

      m_A36 = $0;
      while(acc != NULL)
        if(m_Currency == acc.Code_Currency)
          m_A36 = m_A36 + acc.restIN;//GetClientRestAC(acc.rec.AccountID, m_RepParams.BegDate-1/*на начало дня - т.е. на конец предыдущего*/);
        end;

        acc = m_ClientData.GetNextAcc();
      end;
    end;

    return m_A36;
  END;

  //Перечислено на торги
  MACRO A37():MONEY
    var ServiceOperFound=false;

    if(m_A37 == NULL)
      var acc = m_ClientData.GetFirstAcc();

      m_A37 = $0;
      while(acc != NULL)
        if(m_Currency == acc.Code_Currency)
          m_A37 = m_A37 + GetClientInOutSum(acc.Account, true, @ServiceOperFound);
          m_A37 = m_A37 + GetClientInAccSum(acc.Account, true);
        end;
        acc = m_ClientData.GetNextAcc();
      end;
      //if (not ServiceOperFound)
        //m_A37 = GetClientInAccSum(true);
      //end;      
    end;

    return m_A37;
  END;

  //Зачислено на счет
  MACRO A38():MONEY
    if(m_A38 == NULL)
      // Golovkin 12.07.2019 Требуется настроить формирование отчета брокера,чтобы при операции погашения цб отражалось только списание цб в портфеле клиента и не было зачисления дс и выплаты купона
      m_A38 = this.A39() + this.A40()/* + this.A41() + GetFiWarntsSum(true)*/;
    end;

    return m_A38;
  END;

  //Зачислено на счет
  MACRO A38f():MONEY
    if(m_A38f == NULL)
      m_A38f = /*Сумма продаж*/
               GetExecDealSum(DIRECTION_SALE, true) 
               /*ПКД*/
             //+ this.A40()
               /*Выплата купона*/ 
             // Chesnokov D.S. 30.07.2019 491011 При погашении бумаги и купона денежные средства не зачисляются на брокерский счет, в плановый остаток не показываем
             //+ GetFiWarntsSum(false, true) 
             //+ GetFiWarntsSum(true, true)
             ;
    end;

    return m_A38f;
  END;

  //Сумма продаж
  MACRO A39():MONEY
    if(m_A39 == NULL)
      m_A39 = GetExecDealSum(DIRECTION_SALE);
    end;
    return m_A39;
  END;

  //ПКД
  MACRO A40():MONEY
    if(m_A40 == NULL)
      m_A40 = GetDealNKD(DIRECTION_SALE);
    end;
    return m_A40;
  END;

  //ПКД
  MACRO A40f():MONEY
    if(m_A40f == NULL)
      m_A40f = GetDealNKD(DIRECTION_SALE, true);
    end;
    return m_A40f;
  END;

  //Выплата купона
  MACRO A41():MONEY
    if(m_A41 == NULL)
      m_A41 = GetFiWarntsSum(false);
    end;
    //return m_A41;
    return 0; // Golovkin 12.07.2019 Требуется настроить формирование отчета брокера,чтобы при операции погашения цб отражалось только списание цб в портфеле клиента и не было зачисления дс и выплаты купона
  END;

  //Списано со счета
  MACRO A42():MONEY
    if(m_A42 == NULL)
      m_A42 = this.A43() + this.A44()/* + this.A45() + this.A46()*/;
    end;

    return m_A42;
  END;

  //Списано со счета
  MACRO A42f():MONEY
    if(m_A42f == NULL)
      m_A42f = /*Сумма покупок*/
               GetExecDealSum(DIRECTION_BUY, true)
               /*УНКД*/
             //+ this.A44()
               /*Комиссия биржи*/
             /*+ this.A45f()
               /*Комиссия брокеру*/
             + this.A46f()*/;
    end;

    return m_A42f;
  END;

  //Сумма покупок
  MACRO A43():MONEY
    if(m_A43 == NULL)
      m_A43 = GetExecDealSum(DIRECTION_BUY);
    end;
    return m_A43;
  END;

  //УНКД
  MACRO A44():MONEY
    if(m_A44 == NULL)
      m_A44 = GetDealNKD(DIRECTION_BUY);
    end;
    return m_A44;
  END;

  //УНКД
  MACRO A44f():MONEY
    if(m_A44f == NULL)
      m_A44f = GetDealNKD(DIRECTION_BUY, true);
    end;
    return m_A44f;
  END;

  //Комиссия биржи
  MACRO A45():MONEY
    var query, cmd, DataSet;

    if(m_A45 == NULL)
      m_A45 = $0; 

      query =   " select NVL( Sum(t_A20 + t_A21 + t_A22), 0) as ComissSum "
              + "   from dbrkrepdeal_u_tmp "
              + "  where t_ClientID = ? "
              + "    and t_ContrID = ? "
              + "    and t_IsItog = CHR(0) "
              + "    and t_mcicomissfiid = ? ";
/*ak*/
      query = query
              + "    and (t_part = 3 or (t_part = 1 and t_a06 <= ?)) ";
/*~ak*/

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_RepParams.ClientID);
      cmd.AddParam(m_ContrID);
      cmd.AddParam(m_Currency);
/*ak*/
      cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        m_A45 = DataSet.ComissSum;
      end;

    end;

    return m_A45;
  END;

  //Комиссия биржи
  MACRO A45f():MONEY
    var query, cmd, DataSet;

    if(m_A45f == NULL)
      m_A45f = $0; 

      query =   " select NVL( Sum(t_A20 + t_A21 + t_A22), 0) as ComissSum "
              + "   from dbrkrepdeal_u_tmp "
              + "  where t_ClientID = ? "
              + "    and t_ContrID = ? "
              + "    and t_IsItog = CHR(0) "
              + "    and t_mcicomissfiid = ? ";
/*ak*/
      query = query
              + "    and (t_part = 2 or (t_part = 1 and t_a06 > ?)) ";
/*~ak*/

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_RepParams.ClientID);
      cmd.AddParam(m_ContrID);
      cmd.AddParam(m_Currency);
/*ak*/
      cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        m_A45f = DataSet.ComissSum;
      end;

    end;

    return m_A45f;
  END;

/*ak*/
  //НДС комиссии биржи
  MACRO MarketComissNDS(future):MONEY
    var query, cmd, DataSet;
/*ak*/
    if(valtype(future) != V_BOOL)
      future = false;
    end;
/*~ak*/

    if(m_MarketComissNDS == NULL)
      m_MarketComissNDS = $0; 

      if(m_Currency == NATCUR)

        query =   " select NVL( Sum(t_marketcomissnds + t_cliringcomissnds + t_tscomissnds), 0) as ComissSum "
                + "   from dbrkrepdeal_u_tmp "
                + "  where t_ClientID = ? "
                + "    and t_ContrID = ? "
                //+ "    and t_Part = " + BROKERREP_PART_DEALINPERIOD
                + "    and t_IsItog = CHR(0) ";
/*ak*/
        if(not future)
          query = query
                + "    and (t_part = 3 or (t_part = 1 and t_a06 <= ?)) ";
        else
          query = query
                + "    and (t_part = 2 or (t_part = 1 and t_a06 > ?)) ";
        end;
/*~ak*/

        cmd = DL_RSDCommand(query);

        cmd.AddParam(m_RepParams.ClientID);
        cmd.AddParam(m_ContrID);
/*ak*/
        cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

        DataSet = cmd.Execute();
        if(DataSet.moveNext())
          m_MarketComissNDS = DataSet.ComissSum;
        end;
      end;
    end;

    return m_MarketComissNDS;
  END;
/*~ak*/

  //Комиссия брокеру
  MACRO A46():MONEY
    var query, cmd, DataSet;

    if(m_A46 == NULL)
      m_A46 = $0; 

      query =   " select NVL( Sum(t_A18), 0) as ComissSum "
              + "   from dbrkrepdeal_u_tmp "
              + "  where t_ClientID = ? "
              + "    and t_ContrID = ? "
              + "    and t_IsItog = CHR(0) "
              + "    and t_A19_C = ? ";
/*ak*/
      query = query
              + "    and (t_part = 3 or (t_part = 1 and t_a06 <= ?)) ";
/*~ak*/

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_RepParams.ClientID);
      cmd.AddParam(m_ContrID);
      cmd.AddParam(m_Currency);
/*ak*/
      cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        m_A46 = DataSet.ComissSum;
      end;
    end;

    return m_A46;
  END;

  //Комиссия брокеру
  MACRO A46f():MONEY
    var query, cmd, DataSet;

    if(m_A46f == NULL)
      m_A46f = $0; 

      query =   " select NVL( Sum(t_A18), 0) as ComissSum "
              + "   from dbrkrepdeal_u_tmp "
              + "  where t_ClientID = ? "
              + "    and t_ContrID = ? "
              + "    and t_IsItog = CHR(0) "
              + "    and t_A19_C = ? ";
/*ak*/
      query = query
              + "    and (t_part = 2 or (t_part = 1 and t_a06 > ?)) ";
/*~ak*/

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_RepParams.ClientID);
      cmd.AddParam(m_ContrID);
      cmd.AddParam(m_Currency);
/*ak*/
      cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        m_A46f = DataSet.ComissSum;
      end;
    end;

    return m_A46f;
  END;

  //Сальдо расчетов
  MACRO A47():MONEY
    if(m_A47 == NULL)
      m_A47 = this.A38()-this.A42()-this.A45()-this.A46()-this.A49_1();
    end;

    return m_A47;
  END;

  //Возврат средств
  MACRO A48():MONEY
    var ServiceOperFound=false;
    if(m_A48 == NULL)
      var acc = m_ClientData.GetFirstAcc();
      m_A48 = $0;
      while(acc != NULL)
        if(acc.Code_Currency == m_Currency)
          m_A48 = m_A48 + GetClientInOutSum(acc.Account, false, @ServiceOperFound);
          m_A48 = m_A48 + GetClientInAccSum(acc.Account, false);
        end;
        
        acc = m_ClientData.GetNextAcc();
      end;
      //if (not ServiceOperFound)
        //m_A48 = GetClientInAccSum(false);
      //end; 
    end;

    return m_A48;
  END;

  //Компенсационные взносы
  MACRO A49():MONEY
    var query, cmd, DataSet;

    if(m_A49 == NULL)
      m_A49 = $0; 

      query =   " select NVL(Sum(t_A33_1), 0) as CompSum "
              + "   from dbrkrepdeal_u_tmp "
              + "  where t_ClientID = ? "
              + "    and t_ContrID = ? "
              + "    and t_Part = " + BROKERREP_PART_COUPPAYMS
              + "    and t_IsItog = CHR(0) "
              + "    and t_A33_2 = ? ";
/*ak*/
      query = query
              + "    and (t_part = 3 or (t_part = 1 and t_a06 <= ?)) ";
/*~ak*/

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_RepParams.ClientID);
      cmd.AddParam(m_ContrID);
      cmd.AddParam(m_Currency);
/*ak*/
      cmd.AddParam(m_RepParams.EndDate);
/*~ak*/

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        m_A49 = DataSet.CompSum;
      end;
    end;

    return m_A49;
  END;

  //ДЕПОЗИТАРНАЯ КОМИССИЯ BIQ-10484 CCVO-5829
  macro GetAccDeposComiss(acc)
    var res;
    var query, cmd, DataSet;
    query = 
      "SELECT sum(acctrn.t_sum_payer) sum FROM doprdocs_dbt t, dacctrn_dbt acctrn, dacctrn_state_dbt acctrn_state WHERE   "+
      "  (t.t_id_operation in (SELECT t_id_operation FROM doproper_dbt t WHERE  (t.t_dockind =159  AND t.t_documentid in ( "+
      "  select lpad(to_char(ac.t_id), 10, '0') from ddl_acc_dbt ac where ac.t_opertype = 48 and ac.t_valuedate between ? and ?  "+
      "  and ac.t_client = " + m_RepParams.clientid + " and ac.t_clientcontr = " + m_RepParams.cntrid + " and ac.t_fiid = " + acc.Code_Currency +
      "  )))) "+
      "  AND  (t.t_DocKind=1 AND t.t_AccTrnID=acctrn.t_AccTrnID AND  "+
      "  ((acctrn.t_State=1 OR acctrn.t_State=2) OR acctrn.t_State=3) AND acctrn.t_State=acctrn_state.t_State(+)) "+
      "  and acctrn.t_accountid_payer in (select da.t_accountid from daccount_dbt da where da.t_account = '" + acc.Account + "') ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_RepParams.BegDate);
    cmd.AddParam(m_RepParams.EndDate);
    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      res = DataSet.sum;
    end;
    if (res!=null)
      return res;
    else
      return 0;
    end; 
  end;

  //ДЕПОЗИТАРНАЯ КОМИССИЯ BIQ-10484 CCVO-5829
  MACRO A49_1():MONEY

    if(m_A49_1 == NULL)
      m_A49_1 = $0; 
      var acc = m_ClientData.GetFirstAcc();
      while(acc != NULL)
        if(acc.Code_Currency == m_Currency)
          m_A49_1 = m_A49_1 + GetAccDeposComiss(acc);
        end;
        acc = m_ClientData.GetNextAcc();
      end;
    end;

    return m_A49_1;
  END;


  //ПРОЧЕЕ ДВИЖЕНИЕ ПО СЧЕТУ
  MACRO A50():MONEY
    if(m_A50 == NULL)
      m_A50 = this.A51()-this.A36()-this.A37()-this.A38()+this.A42()+this.A45()+this.A46()+this.A49_1();
/*ak - возврат средств*/
      m_A50 = m_A50 + m_A48;
/*~ak*/
    end;

    return m_A50;
  END;

  //ОСТАТОК СРЕДСТВ НА СЧЕТЕ
  MACRO A51():MONEY
    if(m_A51 == NULL)
      var acc = m_ClientData.GetFirstAcc();

      m_A51 = $0;
      while(acc != NULL)
        if(m_Currency == acc.Code_Currency)
          m_A51 = m_A51 + acc.restOut;//GetClientRestAC(acc.rec.AccountID, m_RepParams.EndDate);
        end;

        acc = m_ClientData.GetNextAcc();
      end;
    end;

    return m_A51;
  END;

  //ОСТАТОК СРЕДСТВ НА СЧЕТЕ (ПЛАНОВЫЙ)
  MACRO A51_1():MONEY
    
    var query, cmd, DataSet;

    if(m_A51_1 == NULL)
      var acc = m_ClientData.GetFirstAcc();
      m_A51_1 = this.A51();
      m_A51_1 = m_A51_1 + this.A38f + this.A40f() - this.A42f - this.A44f - this.A45f - this.A46f;
/*ak
      while(acc != NULL)
        if(m_Currency == acc.Code_Currency)
          query =   " select NVL(Sum(rq.t_Amount*(case when (rq.t_Kind = "+DLRQ_KIND_COMMIT+" and td.t_ClientID = ?) or "
                  + "                                       (rq.t_Kind = "+DLRQ_KIND_REQUEST+" and td.t_PartyID = ?)"
                  + "                                       then -1 "
                  + "                                  else 1 end)), 0) as Amount "
                  + "   from ddlrq_dbt rq, dv_sctotaldeals td "
                  + "  where ((   td.t_ClientID = ? "
                  + "         and td.t_ClientContrID = ? "
                  + "         ) or "
                  + "         (    td.t_IsPartyClient = 'X' "
                  + "          and td.t_PartyID = ? "
                  + "          and td.t_PartyContrID = ? "
                  + "         )"
                  + "        )"
                  + "    and td.t_DealDate <= ? "
                  + "    and rq.t_DocKind = td.t_DocKind "
                  + "    and rq.t_DocID = td.t_DocID "
                  + "    and rq.t_SubKind = " + DLRQ_SUBKIND_CURRENCY
                  + "    and Exists(select 1 "
                  + "                 from ddlrqacc_dbt rqacc "
                  + "                where rqacc.t_DocKind = rq.t_DocKind "
                  + "                  and rqacc.t_DocID = rq.t_DocID "
                  + "                  and rqacc.t_SubKind = rq.t_SubKind "
                  + "                  and rqacc.t_Party = ? "
                  + "                  and rqacc.t_Type IN (rq.t_Type, -1)" 
                  + "                  and rqacc.t_Account = ? "
                  + "                  and rqacc.t_Chapter = ? "
                  + "                  and rqacc.t_FIID = ? "
                  + "              )"
                  + "    and ( (td.t_Status = " + DL_PREPARING + " and td.t_Prognos = chr(88)) "
                  + "          or "
                  + "          (Exists(select 1 "
                  + "                    from ddlgrdeal_dbt gr "
                  + "                   where gr.t_DocKind = rq.t_DocKind "
                  + "                     and gr.t_DocID   = rq.t_DocID "
                  + "                     and (   (rq.t_Type IN ("+DLRQ_TYPE_COMISS+")                        and td.t_ClientID = ?                                 and gr.t_TemplNum IN ("+DLGR_TEMPL_PAYCOM+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_COMISS+")                        and td.t_IsPartyClient = 'X' and td.t_PartyID = ?     and gr.t_TemplNum IN ("+DLGR_TEMPL_PAYCOMCONTR+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_AVANCE+", "+DLRQ_TYPE_DEPOSIT+") and rq.t_DealPart = 1                                 and gr.t_TemplNum IN ("+DLGR_TEMPL_PAYAVANCE+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_PAYMENT+")                       and rq.t_DealPart = 1                                 and gr.t_TemplNum IN ("+DLGR_TEMPL_PAYMENT+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_AVANCE+")                        and rq.t_DealPart = 2                                 and gr.t_TemplNum IN ("+DLGR_TEMPL_PAYAVANCE2+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_PAYMENT+","+DLRQ_TYPE_INCREPO+") and rq.t_DealPart = 2                                 and gr.t_TemplNum IN ("+DLGR_TEMPL_PAYMENT2+","+DLGR_TEMPL_PAYPC+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_COMPPAYM+")                                                                            and gr.t_TemplNum IN ("+DLGR_TEMPL_COMPPAYMENT+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_PAYMREPOCOUP+")                                                                        and gr.t_TemplNum IN ("+DLGR_TEMPL_COUP+")) "
                  + "                          or (rq.t_Type IN ("+DLRQ_TYPE_PAYMREPOPART+")                                                                        and gr.t_TemplNum IN ("+DLGR_TEMPL_PARTREP+")) "
                  + "                         ) "
                  + "                     and Exists(select 1 "
                  + "                                  from ddlgracc_dbt gracc "
                  + "                                 where gracc.t_GrDealID = gr.t_ID "
                  + "                                   and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                  + "                                   and ( gracc.t_State = " + DLGRACC_STATE_PLAN
                  + "                                       or (gracc.t_State = " + DLGRACC_STATE_FACTEXEC+ " and gracc.t_FactDate > ? ) "
                  + "                                       )"
                  + "                               ) "
                  + "                 ) "
                  + "          ) "
                  + "        ) ";

          cmd = DL_RSDCommand(query);

          cmd.AddParam(m_RepParams.ClientID);
          cmd.AddParam(m_RepParams.ClientID);

          cmd.AddParam(m_RepParams.ClientID);
          cmd.AddParam(m_ContrID);
          cmd.AddParam(m_RepParams.ClientID);
          cmd.AddParam(m_ContrID);

          cmd.AddParam(m_RepParams.EndDate);

          cmd.AddParam(m_RepParams.ClientID);
          cmd.AddParam(acc.Account);
          cmd.AddParam(acc.Chapter);
          cmd.AddParam(acc.Code_Currency);

          cmd.AddParam(m_RepParams.ClientID);
          cmd.AddParam(m_RepParams.ClientID);

          cmd.AddParam(m_RepParams.EndDate);

          DataSet = cmd.Execute();
          if(DataSet.moveNext())
            m_A51_1 = m_A51_1 + DataSet.Amount;
          end;
        end;

        acc = m_ClientData.GetNextAcc();
      end;
~ak*/
    end;

    return m_A51_1;
  END;

  Clear();

END;

//Класс подготовки данных по сумме активов
PRIVATE CLASS СBrokerRep_ActiveSumData(RepParams:CBrokerRepParams, ContrID:integer)
  VAR m_RepParams = RepParams;
  VAR m_ContrID = ContrID;
  VAR m_Sн, m_Sк;

  PRIVATE MACRO Clear()
    m_Sн = NULL;
    m_Sк = NULL;
  END;

  PRIVATE MACRO Sвх():MONEY
    var MoveData = СBrokerRep_MoveData(m_RepParams, m_ContrID);
    var currArr = MoveData.GetCurrArr();
    var Sвх = $0;
    var i = 0;

    while(i < currArr.size())
      MoveData.SetCurrency(currArr[i]);

      var S = MoveData.A36();

      if(S != 0)
        if(currArr[i] != NATCUR)
          SmartConvertSum( S, S, m_RepParams.BegDate-1, currArr[i], NATCUR, true );
        end;
      end;

      Sвх = Sвх + S;

      i = i + 1;
    end;

    return Sвх;
  END;

  PRIVATE MACRO Sисх():MONEY
    var MoveData = СBrokerRep_MoveData(m_RepParams, m_ContrID);
    var currArr = MoveData.GetCurrArr();
    var Sисх = $0;
    var i = 0;

    while(i < currArr.size())
      MoveData.SetCurrency(currArr[i]);

      var S = MoveData.A51();

      if(S != 0)
        if(currArr[i] != NATCUR)
          SmartConvertSum( S, S, m_RepParams.EndDate, currArr[i], NATCUR, true );
        end;
      end;

      Sисх = Sисх + S;

      i = i + 1;
    end;

    return Sисх;
  END;

  PRIVATE MACRO Sоц():MONEY
    var query, cmd, DataSet;
    var Sоц = $0;

    query =   " select NVL(SUM(RSI_RSB_FIInstr.ConvSum((rep.t_A55 * NVL(RSI_RSB_FIInstr.ConvSumType(1, fin.t_FIID, fin.t_FaceValueFI, ?, ?), 0) "
            + "                                         + NVL(RSI_RSB_FIInstr.CalcNKD(fin.t_FIID, ?, rep.t_A55, 1), 0)"
            + "                                        ), fin.t_FaceValueFI, "+NATCUR+", ?)"
            + "               ), 0) as S "
            + "   from dbrkrepinacc_u_tmp rep, dfininstr_dbt fin "
            + "  where rep.t_ClientID = ? "
            + "    and rep.t_ContrID = ? "
            + "    and rep.t_IsItog = CHR(0) "
            + "    and fin.t_FIID = rep.t_FIID ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(ПолучитьВидКурса(SP_RATETYPE_MarketPrice));
    cmd.AddParam(m_RepParams.BegDate-1);
    cmd.AddParam(m_RepParams.BegDate-1);
    cmd.AddParam(m_RepParams.BegDate-1);
    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(m_ContrID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Sоц = DataSet.S;
    end;

    return Sоц;
  END;

  PRIVATE MACRO Scost():MONEY
    var query, cmd, DataSet;
    var Scost = $0;

    query =  " select NVL(SUM(t_A61+t_A63), 0) as S "
           + "   from dbrkrepinacc_u_tmp  "
           + "  where t_ClientID = ? "
           + "    and t_ContrID = ? "
           + "    and t_IsItog = 'X' ";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(m_ContrID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Scost = DataSet.S;
    end;

    return Scost;
  END;

  MACRO Sн():MONEY
    if(m_Sн == NULL)
      m_Sн = Sвх() + Sоц();
    end;

    return m_Sн;
  END;

  MACRO Sк():MONEY
    if(m_Sк == NULL)
      m_Sк = Sисх() + Scost();
    end;

    return m_Sк;
  END;

  Clear();

END;


//Класс для формирования всех данных для отчета
PRIVATE CLASS SP_BrokerRep_CreateData(RepParams:CBrokerRepParams)
  PRIVATE VAR m_RepParams = RepParams;
/*ak - надо разобраться с плановыми остатками*/
  PRIVATE MACRO CreateInAccData(ContrID:integer)

    var sql, exec;
    var query;

    //InitProgress(-1, "Подготовка данных для раздела 6", "Состав портфеля по итогам торгов");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP.CreateInAccData(?, ?, ?, ?); "
         + "END; ";
     
    exec = RSDCommand(sql);

    exec.addParam( "", RSDBP_IN, m_RepParams.ClientID );
    exec.addParam( "", RSDBP_IN, ContrID );
    exec.addParam( "", RSDBP_IN, m_RepParams.BegDate );
    exec.addParam( "", RSDBP_IN, m_RepParams.EndDate );
    exec.execute();

    //RemProgress();


    //Подготовить плановые данные
    if(m_RepParams.ShowPlanRest == true)
      var inaccdata = NULL;
      var CheckCatArr = TArray();
      var repdataCache = RsbSQLInsert("brkrepinacc_u.tmp");
      var repdataArr = TArray();
      var inacc = NULL;

      CheckCatArr[CheckCatArr.size] = "ЦБ Клиента, ВУ";

      SC_GetPlanInAcc(@inaccdata, 0, m_RepParams.ClientID, ContrID, m_RepParams.BegDate, m_RepParams.EndDate, CheckCatArr);

      if((ValType(inaccdata) != V_UNDEF) and (inaccdata.m_InAccArr.size > 0))

        //InitProgress(inaccdata.m_InAccArr.size, "Плановые данные для раздела 6", "Состав портфеля по итогам торгов");

        var sz = 0;
        var i = 0;
        while(i < inaccdata.m_InAccArr.size)

          sz = repdataArr.size;

          inacc = inaccdata.m_InAccArr[i];

          if(inaccdata.m_GroundArr[sz].State != DLRQ_STATE_REJECT)

            repdataArr[sz] = TRecHandler("brkrepinacc_u.tmp");

            repdataArr[sz].Clear();

            repdataArr[sz].rec.ClientID = m_RepParams.ClientID;
            repdataArr[sz].rec.ContrID  = ContrID;
            repdataArr[sz].rec.IsItog   = UNSET_CHAR;

            repdataArr[sz].rec.PlaceID  = inacc.rec.PlaceID;
            repdataArr[sz].rec.FIID     = inacc.rec.FIID;


            if(inacc.rec.DebAcc != "")
               repdataArr[sz].rec.A56_1 = inacc.rec.Sum; /*зачисление*/
            else
               repdataArr[sz].rec.A57_1 = inacc.rec.Sum; /*списание*/
            end;

          end;
          
          //UseProgress(i = i + 1);
        end;

        repdataCache.AddRecordArray(repdataArr);

        repdataCache.Insert();

        //RemProgress();
      end;
    end;


    //InitProgress(-1, "Корректировка данных для раздела 6", "Состав портфеля по итогам торгов");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP.CorrectInAccData(?, ?,  ?); "
         + "END; ";
     
    exec = RSDCommand(sql);

    exec.addParam( "", RSDBP_IN, m_RepParams.ClientID );
    exec.addParam( "", RSDBP_IN, ContrID );
    exec.addParam( "", RSDBP_IN, m_RepParams.EndDate );
    exec.execute();

    //RemProgress();

  END;

/*ak - Перенес в PL/SQL
  PRIVATE MACRO CreateByMode(ContrID:integer, Mode:integer)
  PRIVATE MACRO CreateCoupAndCompPayms(ContrID:integer)
  PRIVATE MACRO SetUsingContr(ContrID:integer)

  PRIVATE MACRO CreatePoolData(ContrID:integer)
  PRIVATE MACRO CreateAllData(ContrID:integer)
  PRIVATE MACRO IsValidClientContr(ContrID:integer)
~ak*/
  
  MACRO Create(errmes:@string)

/*ak - Перенес все в PL/SQL*/
   var sfcontr = TBFile("sfcontr.dbt");/*CHVA 507445*/
    sfcontr.Clear();
    sfcontr.rec.ID =m_RepParams.CntrID;
    sfcontr.GetEQ(); /*CHVA 507445*/

    var exec = RSDCommand("begin ? := rshb_brkrep.CreateData(?, ?, ?, ?, ?, ?, ?, ?, ?,?,?); end;");
    exec.addParam("res", RSDBP_OUT, V_INTEGER);
    exec.addParam("", RSDBP_IN, m_RepParams.ClientID);
    exec.addParam("", RSDBP_IN, m_RepParams.CntrID);
    exec.addParam("", RSDBP_IN, m_RepParams.BegDate);
    exec.addParam("", RSDBP_IN, m_RepParams.EndDate);
    exec.addParam("", RSDBP_IN, IIF(m_RepParams.IsMarket == true, 1, 0));
    exec.addParam("", RSDBP_IN, IIF(m_RepParams.IsOutMarket == true, 1, 0));
    exec.addParam("", RSDBP_IN, IIF(m_RepParams.IsFiMovement == true, 1, 0));
    exec.addParam("", RSDBP_IN, IIF(m_RepParams.IsNotZeroRest == true, 1, 0));
   if ( (m_RepParams.CntrID > 0) and ( m_RepParams.ByStock == false) and ( m_RepParams.ByDv  == false) )/*CHVA 507445*/
      if ( sfcontr.rec.servkind ==1)
        m_RepParams.ByStock =true;
        m_RepParams.ByDv  = false;
      elif (sfcontr.rec.servkind == 15)
        m_RepParams.ByStock =false;
        m_RepParams.ByDv  = true;
      end;
   elif  ( (m_RepParams.ClientID >= 0 ) and (m_RepParams.CntrID == 0) and ( m_RepParams.ByStock == false) and ( m_RepParams.ByDv  == false) )
        m_RepParams.ByStock =true;
        m_RepParams.ByDv  = true;
   end;/*CHVA 507445*/
    exec.addParam("", RSDBP_IN, IIF(m_RepParams.ByStock == true, 1, 0));/*CHVA 507294*/
    exec.addParam("", RSDBP_IN, IIF(m_RepParams.ByDv == true, 1, 0));/*CHVA  507294*/
    exec.addParam("errmes", RSDBP_IN_OUT, "                                                                                                                                                                                                        ");
    exec.execute();
    if((valtype(exec.value("res")) != V_INTEGER) or (exec.value("res") <= 0))
      if((valtype(exec.value("errmes")) != V_STRING) or (strlen(exec.value("errmes")) <= 0))
        errmes = "Неизвестная ошибка при формировании отчета";
      else
        errmes = exec.value("errmes");
        return false;
      end;
    else
      errmes = "";
      return true;
    end;
/*~ak*/
  END;
END;


PRIVATE MACRO GetPlanName(PlanID:integer)
  var PlanName = "";

  var cmd = DL_RSDCommand("select t_Name from dsfplan_dbt where t_SfPlanID = ? ");
  cmd.AddParam(PlanID);

  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    if (DataSet.Name == "Профессиональный_РепоБазовый")
       PlanName = "Профессиональный";
    else
       PlanName = DataSet.Name;
    end;
  end;

  return PlanName;
END;


PRIVATE MACRO GetPlanNameByContr(ContrID:integer, EndDate:date)
  var PlanName = "";

  var cmd = DL_RSDCommand("select nvl(max(t_name),chr(1)) t_name "
                        + "from dsfcontrplan_dbt sfcontrplan "
                        + "join dsfplan_dbt sfplan on sfplan.t_sfplanid = sfcontrplan.t_sfplanid "
                        + "where sfcontrplan.t_sfcontrid = ? and "
                        + "      sfcontrplan.t_begin <= ? and "
                        + "      (sfcontrplan.t_end >= ? or "
                        + "       sfcontrplan.t_end = to_date('01.01.0001','dd.mm.yyyy'))");
  cmd.AddParam(ContrID);
  cmd.AddParam(EndDate);
  cmd.AddParam(EndDate);

  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    PlanName = DataSet.Name;
  end;

  return PlanName;
end;


PRIVATE MACRO ВидЦБ( FIID )

  var AvrKind:string = "";

  var cmd = DL_RSDCommand( " select nvl(avrkind.t_Name, chr(1)) Name " +
                           "   from dfininstr_dbt fin, davrkinds_dbt avrkind " +
                           "  where fin.t_fiid = ? " +
                           "    and avrkind.t_AvoirKind = fin.t_AvoirKind " +
                           "    and avrkind.t_FI_KIND   = fin.t_FI_Kind "
                         );
  cmd.AddParam(FIID);
  var dataSet = cmd.Execute();
                                                                    
  if( dataSet.movenext() )
     AvrKind = dataSet.Name;
  end;

  return AvrKind;
END;

PRIVATE CLASS СBrokerRep_PrintRep(RepParams:CBrokerRepParams)

  PRIVATE VAR m_rep = T_Poi_Rep();
  VAR m_RepParams = RepParams;
  var m_ClientData = NULL;
  VAR m_CurrentRepName = "";
  PRIVATE VAR m_FullPath = "";
/*ak - Меняем заливку заголовка на белый цвет
  PRIVATE VAR m_CellColor = "CAF9FA";*/
  PRIVATE VAR m_CellColor = "FFFFFF";
/*~ak*/
  PRIVATE VAR m_TableHeadStyle = "BOR;HA=C;VA=T;IC="+m_CellColor+";";
  PRIVATE VAR m_CellHeight:integer = 15;


  PRIVATE MACRO PrintHeader(CntrID:integer, count:integer, notServOp:bool)/*CHVA 510695*/
         if (valtype(count) == v_undef) count = 1; end;
     m_Rep.Set_WrapText(0);

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
if ((count  > 1) and (notServOp))/*CHVA 510695*/
     m_rep.Put_Str("Логотип", "FC=W;CN=LOGO2;");
else
     m_rep.Put_Str("Логотип", "FC=W;CN=LOGO;");
end;
     m_rep.Put_Str("email:"+m_ClientData.ClientEmail, "FC=W;END;");

     m_rep.Blank_Line();
     m_rep.Blank_Line();
     if(m_RepParams.BegDate == m_RepParams.EndDate)
       m_rep.Put_Val("", "START;", m_CellHeight);
       m_rep.Put_Str("Отчет по сделкам и операциям с ценными бумагами, совершенным в течение дня", "HA=L;END;");
       if (SubTypeContr (CntrID) == 10) //BIQ-5485
          m_rep.Put_Val("               (ОТЧЕТ АНДЕРРАЙТЕРА) "+GetDateS(m_RepParams.BegDate), "START;HA=L;END;", m_CellHeight);
       elif (SubTypeContr (CntrID) == 11) //BIQ-8720
          m_rep.Put_Val("               (ОТЧЕТ АГЕНТА ПО ПРИОБРЕТЕНИЮ) "+GetDateS(m_RepParams.BegDate), "START;HA=L;END;", m_CellHeight);
       else
          m_rep.Put_Val("               (ОТЧЕТ БРОКЕРА) "+GetDateS(m_RepParams.BegDate), "START;HA=L;END;", m_CellHeight);
       end;   
     else
       m_rep.Put_Val("", "START;", m_CellHeight);
       m_rep.Put_Str("Отчет по сделкам и операциям с ценными бумагами, совершенным за период", "HA=L;END;");
       if (SubTypeContr (CntrID) == 10) //BIQ-5485
        m_rep.Put_Val("               (ОТЧЕТ АНДЕРРАЙТЕРА)   с "+GetDateS(m_RepParams.BegDate)+" по "+GetDateS(m_RepParams.EndDate), "START;HA=L;END;", m_CellHeight);       
       elif (SubTypeContr (CntrID) == 11) //BIQ-8720
          m_rep.Put_Val("               (ОТЧЕТ АГЕНТА ПО ПРИОБРЕТЕНИЮ) "+GetDateS(m_RepParams.BegDate)+" по "+GetDateS(m_RepParams.EndDate), "START;HA=L;END;", m_CellHeight);
       else
        m_rep.Put_Val("               (ОТЧЕТ БРОКЕРА)   с "+GetDateS(m_RepParams.BegDate)+" по "+GetDateS(m_RepParams.EndDate), "START;HA=L;END;", m_CellHeight);
       end; 
     end;
     m_rep.Blank_Line();
    
     if ( (valtype(m_ClientData.ShortName()) == V_UNDEF ) and (SubTypeContr (CntrID) == 10) )//BIQ-5485 Если сделка андерра, то возьмет реквичиты иначе
        var ClientShortName = "", ClientCode = "";
        GetClientCode(m_RepParams.ClientId, ClientShortName, ClientCode);
        m_rep.Put_Val("По операциям:" + ClientShortName, "START;HA=L;END;", m_CellHeight); 
        m_rep.Put_Val("Уникальный код: " + ClientCode, "START;HA=L;END;", m_CellHeight); /*bpv 25 04 2019 по просьбе Радионовой О.С.*/
     else
        m_rep.Put_Val("По операциям:" + m_ClientData.ShortName(), "START;HA=L;END;", m_CellHeight);
        m_rep.Put_Val("Уникальный код: " + m_ClientData.ClientCode(), "START;HA=L;END;", m_CellHeight); /*bpv 25 04 2019 по просьбе Радионовой О.С.*/
     end;
     m_rep.Blank_Line();

     
     if (SubTypeContr (CntrID) == 10)  //рабочий вариант BIQ-5485
        m_rep.Put_Val("  Дата и номер договора об оказании услуг при размещении облигаций: " + GetDateS(m_ClientData.ContrDate()) + " №", "START;HA=L;", m_CellHeight);     
     elif (SubTypeContr (CntrID) == 11)  //рабочий вариант BIQ-8720
        m_rep.Put_Val("  Дата и номер договора об оказании услуг при приобретении облигаций: " + GetDateS(m_ClientData.ContrDate()) + " №", "START;HA=L;", m_CellHeight);     
     else
        m_rep.Put_Val("  Дата и номер договора на брокерское обслуживание: " + GetDateS(m_ClientData.ContrDate()) + " №", "START;HA=L;", m_CellHeight);
     end;    
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str(m_ClientData.ContrNumber(), "HA=L;END;");

     if(not m_ClientData.IsIndividual)
       m_rep.Put_Str(" Валюта:", "START;HA=L;");
       m_rep.Put_Str(" Счета клиента в " + ПолучитьКороткоеИмяСубъекта({OurBank}) + ":", "R=2;HA=L;END;");
       var acc = m_ClientData.GetFirstAcc();
       while(acc != NULL)
         m_rep.Put_Str("  " + GetFinInstrCcy(acc.Code_Currency, true, false), "START;HA=L;");
         m_rep.Put_Str("  " + acc.Account, "HA=L;END;");
         acc = m_ClientData.GetNextAcc();
       end;
     end;
     m_rep.Blank_Line();

     m_rep.Put_Val(" Дата начала периода:", "START;R=1;HA=L;", m_CellHeight );
     m_rep.Put_Str("  " + GetDateS(m_RepParams.BegDate), "HA=L;END;");

     m_rep.Put_Val(" Дата окончания периода:", "START;R=1;HA=L;", m_CellHeight);
     m_rep.Put_Str("  " + GetDateS(m_RepParams.EndDate), "HA=L;END;");

     m_rep.Put_Val(" Настоящим сообщаем, в вышеуказанный отчетный период по Вашему поручению", "START;HA=L;END;", m_CellHeight);
     m_rep.Put_Val(" совершены следующие операции:", "START;HA=L;END;", m_CellHeight);

     m_rep.Blank_Line();
/*ak - Добавляем*/
     m_rep.Blank_Line();
/*~ak*/

  END;

  PRIVATE MACRO PrintByMode(ContrID, Mode)
    VAR fininstrBond = TRecHandler( "fininstr" );    /*CHVA 508450*/
     var query, cmd, DataSet;
     var prevPlanID = NULL;
     var prevFIID = NULL;
     var prevDealDirect = null;
     var DealData = NULL;
     var cnt = 0;
     var i = 0;
     var isep;

     //Напечатать итоговые строки
     MACRO PrintItogLines(PlanID:integer, FIID:integer, DealDirect)
       var q, Select, ds;
       
/*ak - Добавялем поля и убираем группировку по виду сделки
       q =   " select t_Direction, t_A16, t_A17, t_A18, t_A20, t_A21, t_A22, t_A27, t_A30 "*/
       q =   " select t_A15, t_A16, t_A17, t_A18, t_A20, t_A21, t_A22, t_A26, t_A27, t_A28, t_A29, nvl(fininstr.t_ccy,chr(1)) t_A30 "
           + " from (select sum(t_A15) t_A15, sum(t_A16) t_A16, sum(t_A17) t_A17, sum(t_A18) t_A18, sum(t_A20) t_A20, sum(t_A21) t_A21, sum(t_A22) t_A22, "
           + "              sum(t_A26) t_A26, sum(t_A27) t_A27, "
           + "              sum(decode(t_direction, 1, t_A28, 0)) t_A28, "
           + "              sum(decode(t_direction, 1, 0, t_A29)) t_A29, t_A30 "
/*~ak*/
           + "   from dbrkrepdeal_u_tmp t "
           + "   left join dfininstr_dbt fininstr on fininstr.t_fiid = t_A30 "
           + "  where t_ClientID = ? "
           + "    and t_ContrID = ? "
           + "    and t_Part = ? "
           + "    and t_PlanID = ? "
           + "    and t.t_fiid = ? "
           + "    and t.t_A10 = ? "
           + "    and t_IsItog = 'X' "
/*ak
           + " order by t_A30, t_Direction ";*/
           + " group by t_A30) "
           + " left join dfininstr_dbt fininstr on fininstr.t_fiid = t_A30 "
           + " where t_A30 is not null "
           + " and nvl(fininstr.t_ccy,chr(1)) <> CHR(1)"
           + " order by fininstr.t_fiid ";
/*~ak*/

       Select = DL_RSDCommand(q);
       Select.AddParam(m_RepParams.ClientID);
       Select.AddParam(ContrID);
       Select.AddParam(Mode);
       Select.AddParam(PlanID);
       Select.AddParam(FIID);
       Select.AddParam(DealDirect);


       if(Select.GetCount())
         ds = Select.Execute();
         
         m_Rep.Set_WrapText(1);
         while(ds.moveNext())
/*ak - Убираем групировку по виду сделки
           m_rep.Put_Str("Итого "+IIF(ds.Direction == DIRECTION_BUY, "покупок", "продаж")+" в " + ds.A30, "BOR;R=1;P=C;START;");*/
           m_rep.Put_Val("Итого в " + ds.A30, "BOR;HA=L;R=1;P=C;START;", m_CellHeight);
/*~ak*/
           m_rep.Put_Str("",     "BOR;P=C;");
           if(not m_ClientData.Market)
             m_rep.Put_Str("",     "BOR;P=C;");
           end;
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;");
/*ak - Убираем колонку Вид сделки
           m_rep.Put_Str("",     "BOR;P=C;");
~ak*/
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;"); //BIQ-7324
           if((SubTypeContr (ContrID) == 10) or (SubTypeContr (ContrID) == 11))//BIQ-5485 этой колонки в шаблоне андерра нет. BIQ-8720 тоже. Сдвиг на 2 колонки.
           else 
            m_rep.Put_Str("",     "BOR;P=C;");
            m_rep.Put_Str("",     "BOR;P=C;");
           end; 
/*ak - Добавляем
           m_rep.Put_Str("",     "BOR;P=C;");*/
           m_rep.Put_Str(ds.A15, "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A29)+";");
/*~ak*/
/* MAA: iS - 529619
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;"); */

           m_rep.Put_Val(ds.A16, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Val(ds.A17, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Val(ds.A18, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Val(ds.A20, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Val(ds.A21, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Val(ds.A22, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;");
           m_rep.Put_Str(ds.A26, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Val(ds.A27, "BOR;HA=R;VA=C;T=M2;");
/*ak - Добавляем
           m_rep.Put_Val("",     "BOR;P=C;");
           m_rep.Put_Str("",     "BOR;P=C;");*/
           m_rep.Put_Val(ds.A28, "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Str(ds.A29, "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A29)+";");
/*~ak*/

           m_rep.Put_Str("","END;");
         end;
       end;
     END;
/*CHVA 522870*/
   MACRO DealState( p_DealCode, p_ClientId:integer)
      var DealState  = 0;
      var query,cmd, DataSet;
      query = "SELECT t_dealstatus "+
                      "  FROM DDL_TICK_DBT "+
                       "  WHERE t_dealcode LIKE '%"+p_DealCode+"'"+
                       " AND t_clientid = ?";
    cmd  = DL_RSDCommand(query);
    cmd.AddParam(p_ClientId);
    DataSet = cmd.execute();
     
      if( DataSet.MoveNext() )
        DealState = DataSet.t_dealstatus;
      end;

      return DealState;
   END;

   MACRO getNKD(p_DealCode:string, p_ClientId:integer, p_LegKind:integer)     
     var costArr = tarray();
     var query,cmd, DataSet;
     query = "SELECT leg.t_cost, leg.t_totalcost "+
             "  FROM DDL_LEG_DBT leg, DDL_TICK_DBT tk"+
             " WHERE leg.t_DealID = tk.t_DealID "+
             "   AND decode(tk.t_DealCodeTS, chr(1), tk.t_DealCode, tk.t_DealCodeTS) = ? "+
             "   AND tk.t_ClientID = ? "+
             "   AND leg.t_LegKind = ? ";
     cmd = DL_RSDCommand(query);
     cmd.AddParam(p_DealCode);
     cmd.AddParam(p_ClientId);
     cmd.AddParam(p_LegKind);
     DataSet = cmd.execute();
     
     if(DataSet.MoveNext())
       costArr[costArr.size] = DataSet.value(0); 
       costArr[costArr.size] = DataSet.value(1); 
     end;

     return costArr;
   END;

/*CHVA 522870*/

     /*Пустой отчет*/
     if(mode == 0)
       m_rep.Put_Str("СДЕЛКИ, СОВЕРШЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА  "+GetPlanNameByContr(ContrID, m_RepParams.EndDate), "START;HA=L;END;");
       m_rep.Put_Str("Операций не производилось", "START;HA=L;END;");
       m_rep.Blank_Line();
       return;
     end;

     query =   " select t_PlanID, case when t_A10 in ('Продажа РЕПО ч. 2', 'Покупка РЕПО ч. 2') then 2 else 0 end t_LegKind, "
             + "        t_A05_D, t_A05_T, t_A06, t_A07, t_A08, t_A09, t_A10, t_A11, t_A12, t_A13, t_A13_i, "
             + "        t_A14, t_A15, t_A16, t_A17, t_A18, t_A19, t_A20, t_A21, t_A22, t_A23, "
             + "        t_A24, t_A25, t_A26, t_A27, "
             + "        decode(t_direction, 1, t_A28, 0) t_A28, "
             + "        decode(t_direction, 1, 0, t_A29) t_A29, t_FIID, t_A95, t_A95_M, t_mcicomissfiname "
             + "   from dbrkrepdeal_u_tmp  "
             + "  where t_ClientID = ? "
             + "    and t_ContrID = ? "
             + "    and t_Part = ? "
             + "    and t_IsItog = CHR(0) "
             + " order by t_PlanID desc, t_fiid, t_A05_D, decode(t_A10, 'Продажа РЕПО ч. 1','1','Покупка РЕПО ч. 2','2', t_A10), t_A05_T, t_A06, t_A07";
             
     cmd = DL_RSDCommand(query);
     cmd.AddParam(m_RepParams.ClientID);
     cmd.AddParam(ContrID);
      cmd.AddParam(Mode);
     
     cnt = cmd.GetCount();
     
     if(cnt)
     
       DealData = cmd.Execute();

       var PartStr = "";
       
       m_Rep.Set_WrapText(0);
       if(Mode == BROKERREP_PART_DEALINPERIOD)
         if ((SubTypeContr (ContrID) == 10) or (SubTypeContr (ContrID) == 11)) //BIQ-5485, 8720
           PartStr = "ИСПОЛНЕННЫЕ СДЕЛКИ НА "+GetDateS(m_RepParams.BegDate);
         else  
           PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С "+GetDateS(m_RepParams.BegDate)+" ПО "+GetDateS(m_RepParams.EndDate);
         end; 
         m_rep.Put_Str(PartStr, "START;HA=L;R=6;END;");
         m_rep.Blank_Line();
       elif(Mode == BROKERREP_PART_NOTEXECDEAL)
         PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И НЕ ИСПОЛНЕННЫЕ НА "+GetDateS(m_RepParams.EndDate);
         m_rep.Put_Str(PartStr, "START;HA=L;R=6;END;");
         m_rep.Blank_Line();
       elif(Mode == BROKERREP_PART_EXECDEAL)
         PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА "+GetDateS(m_RepParams.EndDate);
         m_rep.Put_Str(PartStr, "START;HA=L;R=6;END;");
         m_rep.Blank_Line();
       elif(Mode == BROKERREP_PART_REPODEAL)
         PartStr = "СДЕЛКИ РЕПО, ЗАКЛЮЧЕННЫЕ И ИСПОЛНЕННЫЕ НА "+GetDateS(m_RepParams.EndDate);
       elif(Mode == BROKERREP_PART_CANCELEDDEAL)/*CHVA*/
         PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С  "+GetDateS(m_RepParams.BegDate) +" ПО "+GetDateS(m_RepParams.EndDate) ;
         m_rep.Put_Str(PartStr, "START;HA=L;R=6;END;");
         m_rep.Blank_Line();
       end;


       /*Подготовка разделов отчета*/

       while(DealData.moveNext())
        
         if ( ( (isDealCanceled(DealData.T_A07,m_RepParams.BegDate,m_RepParams.EndDate) == false) and (Mode != BROKERREP_PART_CANCELEDDEAL) )  
               or ( (Mode == BROKERREP_PART_CANCELEDDEAL) and (isDealCanceled(DealData.T_A07,m_RepParams.BegDate,m_RepParams.EndDate) == true ) ) );  /*CHVA 503652*/

         if((prevPlanID != NULL) and (prevPlanID == DealData.PlanID) and ((prevFIID != DealData.FIID) or (prevDealDirect != DealData.T_A10)))
           if(prevFIID != NULL)
             PrintItogLines(prevPlanID, prevFIID, prevDealDirect);
           end;
           prevFIID = DealData.FIID;
           prevDealDirect = DealData.T_A10;
         end;

         if(prevPlanID != DealData.PlanID)
           if(prevPlanID != NULL)
             PrintItogLines(prevPlanID, prevFIID, PrevDealDirect);
             m_rep.Blank_Line();
           end;
           prevFIID = DealData.FIID;
           prevDealDirect = DealData.T_A10;           

           m_Rep.Set_WrapText(0);
           //if(Mode == BROKERREP_PART_REPODEAL)
           if((SubTypeContr (ContrID) == 10) or (SubTypeContr (ContrID) == 11) ) //BIQ-5485 этой строки в шаблоне андерра нет, BIQ-8720 тоже
             m_rep.Put_Str("", "START;HA=L;R=0;END;");
           else
             m_rep.Put_Str("СДЕЛКИ"+IIF(DealData.PlanID < 0, " РЕПО", "")+", СОВЕРШЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА "+ IIF(DealData.PlanID < 0, GetPlanNameByContr(ContrID, m_RepParams.EndDate), GetPlanName(DealData.PlanID)), "START;HA=L;R=6;END;");
           end;
           m_Rep.Set_WrapText(1);
           if(m_ClientData.Market)
             m_rep.Put_Str("Дата и время заключения сделки", m_TableHeadStyle+"START;", 51);
           else
             m_rep.Put_Str("Дата и время заключения сделки (договора)", m_TableHeadStyle+"START;", 51);
             m_rep.Put_Str("Дата поставки",                m_TableHeadStyle);
           end;
           m_rep.Put_Str("Дата исполнения сделки",         m_TableHeadStyle);
           if(m_ClientData.Market)
             m_rep.Put_Str("Номер",                        m_TableHeadStyle);
           else
             m_rep.Put_Str("Номер (договора)",             m_TableHeadStyle);
           end;
           m_rep.Put_Str("Номер в ТС",                     m_TableHeadStyle);
           m_rep.Put_Str("Торговая площадка:",             m_TableHeadStyle);
           m_rep.Put_Str("Вид сделки",                     m_TableHeadStyle);
           m_rep.Put_Str("Эмитент",                        m_TableHeadStyle);
/*ak - Убираем колонку Вид ЦБ
           m_rep.Put_Str("Вид ЦБ",                         m_TableHeadStyle);
~ak*/
           m_rep.Put_Str("Гос. рег. номер выпуска/ISIN",   m_TableHeadStyle);
           //m_rep.Put_Str("Цена ЦБ",                        m_TableHeadStyle);
           if(SubTypeContr (ContrID) == 11) //BIQ-8720 Колонки "Цена заявки" нет, в вместо "Цена сделки" - "Цена ЦБ"
              m_rep.Put_Str("Цена ЦБ",                    m_TableHeadStyle);
           else 
              m_rep.Put_Str("Цена заявки",                    m_TableHeadStyle); // BIQ-7324
              m_rep.Put_Str("Цена сделки",                    m_TableHeadStyle);
           end;   
           if((SubTypeContr (ContrID) == 10) or (SubTypeContr (ContrID) == 11)) //BIQ-5485 этой колонки в шаблоне андерра нет, BIQ-8720 тоже
           else 
              m_rep.Put_Str("Ставка РЕПО",                    m_TableHeadStyle);
           end; 
           m_rep.Put_Str("Валюта сделки",                  m_TableHeadStyle);
           m_rep.Put_Str("Количество бумаг",               m_TableHeadStyle);
           m_rep.Put_Str("Сумма сделки",                   m_TableHeadStyle);
           m_rep.Put_Str("Сумма сделки в рублях",          m_TableHeadStyle);
           m_rep.Put_Str("Валюта комиссии брокера",        m_TableHeadStyle);
           m_rep.Put_Str("Комиссия брокера",               m_TableHeadStyle);
           m_rep.Put_Str("Валюта комиссии торговых систем",m_TableHeadStyle);
           m_rep.Put_Str("Комиссия торговой площадки",     m_TableHeadStyle);
           m_rep.Put_Str("Комиссия клирингового центра",   m_TableHeadStyle);
           m_rep.Put_Str("Комиссия за ИТС",                m_TableHeadStyle);
           m_rep.Put_Str("Тип сделки",                     m_TableHeadStyle);
           m_rep.Put_Str("Контрагент",                     m_TableHeadStyle);
           m_rep.Put_Str("Код контрагента",                m_TableHeadStyle);
           m_rep.Put_Str("Сумма НКД",                      m_TableHeadStyle);
           m_rep.Put_Str("Сумма НКД в рублях",             m_TableHeadStyle);
           if(SubTypeContr (ContrID) == 11) //BIQ-8720 
              m_rep.Put_Str("ДС",            m_TableHeadStyle);
              m_rep.Put_Str("ЦБ",            m_TableHeadStyle);
           else 
              m_rep.Put_Str("Обязательство по ДС",            m_TableHeadStyle);
              m_rep.Put_Str("Обязательство по ЦБ",            m_TableHeadStyle);
           end;
           m_rep.Put_Str("","END;");

         end;

         m_rep.Put_Val(string(date(DealData.A05_D):f) + " " + string(time(DealData.A05_T)), "BOR;P=C;START;", 28);
         if(not m_ClientData.Market)
           m_rep.Put_Str(string(date(DealData.A06)), "BOR;P=C;");
         end;
         m_rep.Put_Str(string(date(DealData.A06):f), "BOR;P=C;");
         m_rep.Put_Str(DealData.A07,       "BOR;P=C;");
         m_rep.Put_Str(DealData.A08,       "BOR;P=C;");
         if(m_ClientData.Market)
           if(strlen(DealData.A09) > 0)
             m_rep.Put_Str(DealData.A09 + " фондовый рынок", "BOR;P=C;");
           else
             m_rep.Put_Str(DealData.A09,   "BOR;P=C;");
           end;
         else
           m_rep.Put_Str("Внебиржевая сделка", "BOR;P=C;");
         end;
         m_rep.Put_Str(DealData.A10,       "BOR;P=C;");
         m_rep.Put_Str(DealData.A11,       "BOR;HA=C;VA=T;");
/*ak - убираем колонку Вид ЦБ
         m_rep.Put_Str(ВидЦБ(DealData.FIID),"BOR;P=C;");
~ak*/
         isep = index(DealData.A12,"/");
         if(isep > 0)
           m_rep.Put_Str(substr(DealData.A12,1,isep) + "\n" + substr(DealData.A12,isep+1), "BOR;HA=C;VA=T;");
         else
           m_rep.Put_Str(DealData.A12,       "BOR;HA=C;VA=T;");
         end;
         var price = "";
         var dealCost=tarray();/*CHVA 522870*/
         var dealNKD = 0.0;/*CHVA 522870*/
//         if(DealData.A13_i != 0.0) /*Репо 2 часть*/
//           price = "ставка " + ЧислоCЗаданнойТочностью(DoubleToMoney(DealData.A13_i), 4) + " %";
//         elif (DealData.A13!=0.0)//если это Репо 1 часть, то пустое место (ноль не выводим)
          /*CHVA 501688 */
       var isFininstrBond = false;
       if(FI_isBond(DealData.FIID))
         var  checkFiid = CheckFaceValueFi(DealData.FIID, date(DealData.A05_D));
         ПолучитьФинИнПоISO( DealData.A14, fininstrBond);/*CHVA 508450*/
         isFininstrBond = true;
       end;
        var CourseOut, CourceSinceDateOut;
         if((isFininstrBond == true) and (checkFiid != fininstrBond.rec.fiid/*NATCUR*/) and (m_ClientData.Market == true))
           if(DealState(DealData.A07, m_RepParams.clientid) == 20)/*CHVA 522870 получалось, что курс всегда брался на дату заключения сделки и если цена на тикете сделки после исполнения менялась, то отчет показывал не верную Цену ЦБ.Добавил проверку на статус сделки и если сделка закрыта, брать курс на дату испонения*/
             if(not ПолучитьКурсЗаданногоTипа(@CourseOut, checkFiid, NATCUR, 7, date(DealData.A06), false, @CourceSinceDateOut) or
                ((CourceSinceDateOut != date(DealData.A06)) and (CourseOut == 0.0)) 
               )
               MsgBox("Для валюты " + ПолучитьКодФинИн(checkFiid) + " не задан курс Банка России на дату " + String( date(DealData.A06)));
               return 1;
             end;
           else
             if(not ПолучитьКурсЗаданногоTипа(@CourseOut, checkFiid, NATCUR, 7, date(DealData.A05_D), false, @CourceSinceDateOut) or
                ((CourceSinceDateOut != date(DealData.A05_D)) and (CourseOut == 0.0)) 
               )
               MsgBox("Для валюты " + ПолучитьКодФинИн(checkFiid) + " не задан курс Банка России на дату " + String( date(DealData.A05_D)));
               return 1;
             end;
           end;
           /*для сделок, у которых валюта НКД выражена в иностранной валюте возникает проблема . В биржевом файле приходит НКД в рублях, а на сделке д.б. в иностранной валюте и при пересчете может получиться, что расчетное значение НКД */
           /*имеет три знака после запятой. Но так как в системе у нас НКД имеет тип MONEY  происходит округление до двух знаков ,то получается некорректная сумма на сделке и , соответственно, в отчете */
           /*приходится напрямую смотреть в ddl_leg_dbt*/
           dealCost = getNKD(DealData.A07, m_RepParams.clientid, DealData.LegKind);/*CHVA 522870 */
           dealNKD  = dealCost[1] - dealCost[0]; 
           DealData.A16 = DealData.A17 = dealCost[0];/*CHVA 522870 */
           DealData.A26 = DealData.A27 = dealNKD;/*CHVA 522870 */
           
           price = ЧислоCЗаданнойТочностью(DoubleToMoney(((DealData.A13/faceValueOnDate)/CourseOut)*100), 4);
         else
           price = ЧислоCЗаданнойТочностью(DoubleToMoney(DealData.A13), 4);
         end;
         //end;
           /*CHVA 501688*/ 

         if( SubTypeContr (ContrID) == 11) //BIQ-8720 этой колонки (Цена заявки) в шаблоне нет 
         else
           if (DealData.A95_M == SET_CHAR)
             m_rep.Put_Str("",           "BOR;P=C;");
             //m_rep.Put_Str("Принудительное закрытие позиций",   "BOR;P=C;");
           elif(ValType(DealData.A95) == V_UNDEF)
             m_rep.Put_Str("",           "BOR;P=C;");
           elif (index(DealData.A10 ,"РЕПО ч.") > 0) /*По Репо выводим цену сделки (в заявке всегда 0.0 по Репо)*/ /*В пользовательском пакете нет ОРЕПО  и ПРЕПО */
             m_rep.Put_Val(price,        "BOR;HA=R;VA=C;T=N4;");
           elif (DealData.A95 == 0.0) /*Если не Репо и в заявке нет цены, но заявка есть*/
             m_rep.Put_Str("Рыночная",   "BOR;P=C;");
           else
             m_rep.Put_Val(DealData.A95, "BOR;HA=R;VA=C;T=N4;");
           end;
         end;   
         
         m_rep.Put_Str(price,       "BOR;P=C;VA=C;T=N4;");

         if((SubTypeContr (ContrID) == 10) or (SubTypeContr (ContrID) == 11)) //BIQ-5485 этой колонки (ставка РЕПО) в шаблоне андерра нет, BIQ-8720 тоже 
         else
            if(DealData.A13_i != 0.0)
               m_rep.Put_Str(ЧислоCЗаданнойТочностью(DoubleToMoney(DealData.A13_i), 4) + "%",    "BOR;P=C;");
            else
               m_rep.Put_Str("",               "BOR;P=C;");
            end;
         end; 
         m_rep.Put_Str(DealData.A14,       "BOR;P=C;");
         m_rep.Put_Val(DealData.A15,       "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A15)+";");
         m_rep.Put_Val(DealData.A16,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A17,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Str(DealData.A19,       "BOR;P=C;");
         m_rep.Put_Val(DealData.A18,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Str(DealData.mcicomissfiname,"BOR;P=C;");
         m_rep.Put_Val(DealData.A20,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A21,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A22,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Str(DealData.A23,       "BOR;P=C;");
         m_rep.Put_Str(DealData.A24,       "BOR;P=C;");
         m_rep.Put_Str(DealData.A25,       "BOR;P=C;");
         //А26 (НКД) - не заполняем, т.к. ВН ц/б в обеспечении могут быть разными
         //if (DealData.A26!= 0.0)//сделка НЕ на корзину
           m_rep.Put_Val(DealData.A26,       "BOR;HA=R;VA=C;T=M2;");
         //else //сделка на корзину
         //  m_rep.Put_Val(" ",       "BOR;P=C;");
         //end;

         m_rep.Put_Val(DealData.A27,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A28,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A29,       "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A29)+";");

         m_rep.Put_Str("","END;");

         prevPlanID = DealData.PlanID;

       end;
    end;
       PrintItogLines(prevPlanID, prevFIID, prevDealDirect);
       m_rep.Blank_Line();
       if (Mode == BROKERREP_PART_REPODEAL)
          m_rep.Put_Str("Информация о размере полученной дополнительной выгоды Брокера: 0.00 руб.", "START;HA=L;R=6;END;");
          m_rep.Blank_Line();
       end;
      
     end;

/*ak*/
     return cnt;
/*~ak*/
  END;

  PRIVATE MACRO PrintCoupAndCompPayms(ContrID)
     var query, cmd, DataSet;
     var DealData = NULL;
     var cnt = 0;
     var i = 0;
     var isep;

     query =   " select rep.t_A05_D, rep.t_A05_T, rep.t_A06, rep.t_A07, rep.t_A09, rep.t_A10, rep.t_A11, rep.t_A12, rep.t_A13, rep.t_A13_i, "
             + "        rep.t_A15, rep.t_A16, rep.t_A17, rep.t_A24, rep.t_A26, rep.t_A28, rep.t_A29, rep.t_A31, rep.t_A32_1, "
             + "        rep.t_A33_1, rep.t_A33_3, rep.t_A34, rep.t_A35, rep.t_FIID, rep.t_A95, rep.t_A95_M, "
             + "        NVL(fin32.t_CCY, CHR(1)) as A32_CCY, NVL(fin33.t_CCY, CHR(1)) as A33_CCY"
             + "   from dbrkrepdeal_u_tmp rep "
             + "        left join dfininstr_dbt fin32 on fin32.t_FIID = rep.t_A32_2 "
             + "        left join dfininstr_dbt fin33 on fin33.t_FIID = rep.t_A33_2 "
             + "  where rep.t_ClientID = ? "
             + "    and rep.t_ContrID = ? "
             + "    and rep.t_Part = ? "
             + "    and rep.t_IsItog = CHR(0) "
             + " order by rep.t_A05_D, rep.t_A05_T, rep.t_A07, rep.t_A10";

     cmd = DL_RSDCommand(query);
     cmd.AddParam(m_RepParams.ClientID);
     cmd.AddParam(ContrID);
     cmd.AddParam(BROKERREP_PART_COUPPAYMS);
     
     cnt = cmd.GetCount();


     if(cnt)
       DealData = cmd.Execute();

       //InitProgress(cnt, "Идет подготовка отчета", "Информация о компенсационных взносах и купонных доходах");

       m_Rep.Set_WrapText(0);
//       m_rep.Put_Str("4. ИНФОРМАЦИЯ О КОМПЕНСАЦИОННЫХ ВЗНОСАХ И КУПОННЫХ ВЫПЛАТАХ", "START;FB;HA=L;R=6;END;");
       m_rep.Put_Str("ИНФОРМАЦИЯ О КОМПЕНСАЦИОННЫХ ВЗНОСАХ И КУПОННЫХ ВЫПЛАТАХ", "START;HA=L;R=6;END;");


       m_Rep.Set_WrapText(1);
       m_rep.Put_Str("Дата и время заключения сделки",                    m_TableHeadStyle+"START;");
       m_rep.Put_Str("Дата исполнения сделки",                            m_TableHeadStyle);
       m_rep.Put_Str("Дата проведения платежа",                           m_TableHeadStyle);
       m_rep.Put_Str("Номер сделки",                                      m_TableHeadStyle);
       m_rep.Put_Str("Торговая площадка:",                                m_TableHeadStyle);
       m_rep.Put_Str("Вид сделки",                                        m_TableHeadStyle);
       m_rep.Put_Str("Эмитент",                                           m_TableHeadStyle);
       //m_rep.Put_Str("Вид ЦБ",                                            m_TableHeadStyle);
       m_rep.Put_Str("Гос. рег. номер выпуска/ISIN",                      m_TableHeadStyle);
       m_rep.Put_Str("Цена заявки",                                       m_TableHeadStyle);
       m_rep.Put_Str("Цена сделки",                                       m_TableHeadStyle);
       m_rep.Put_Str("Ставка РЕПО",                                       m_TableHeadStyle);
       m_rep.Put_Str("Количество бумаг",                                  m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки",                                      m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки в рублях",                             m_TableHeadStyle);
       m_rep.Put_Str("Выплата купонного дохода",                          m_TableHeadStyle);
       m_rep.Put_Str("Валюта выплаты",                                    m_TableHeadStyle);
       m_rep.Put_Str("Сумма компенсационного взноса",                     m_TableHeadStyle);
       m_rep.Put_Str("Валюта платежа",                                    m_TableHeadStyle);
       m_rep.Put_Str("Сумма КВ в рублях",                                 m_TableHeadStyle);
       m_rep.Put_Str("Сумма купонного дохода и КВ по денежным средствам в рублях", m_TableHeadStyle);
       m_rep.Put_Str("Сумма КВ по ценным бумагам",                        m_TableHeadStyle);
       m_rep.Put_Str("Обязательство по ДС",                               m_TableHeadStyle);
       m_rep.Put_Str("Обязательство по ЦБ",                               m_TableHeadStyle);
       m_rep.Put_Str("Сумма НКД",                                         m_TableHeadStyle);
       m_rep.Put_Str("Контрагент",                                        m_TableHeadStyle);


       m_rep.Put_Str("","END;");

       while(DealData.moveNext())

         m_rep.Put_Str(string(date(DealData.A05_D):f) + " " + string(time(DealData.A05_T)), "BOR;WT;P=C;START;", 28);
         m_rep.Put_Val(date(DealData.A06),   "BOR;P=C;T=D;");
         m_rep.Put_Str(DealData.A31,         "BOR;P=C;T=D;");
         m_rep.Put_Str(DealData.A07,         "BOR;P=C;");
         m_rep.Put_Str(DealData.A09 + " фондовый рынок", "BOR;P=C;");
         m_rep.Put_Str(DealData.A10,         "BOR;P=C;");
         m_rep.Put_Str(DealData.A11,         "BOR;HA=C;VA=T;");
         //m_rep.Put_Str(ВидЦБ(DealData.FIID), "BOR;P=C;");
         isep = index(DealData.A12,"/");
         if(isep > 0)
           m_rep.Put_Str(substr(DealData.A12,1,isep) + "\n" + substr(DealData.A12,isep+1), "BOR;HA=C;VA=T;");
         else
           m_rep.Put_Str(DealData.A12,       "BOR;HA=C;VA=T;");
         end;

        var price = "";
          price = ЧислоCЗаданнойТочностью(DoubleToMoney(DealData.A13), 4);

         if (DealData.A95_M == SET_CHAR)
           m_rep.Put_Str("",           "BOR;P=C;");
           //m_rep.Put_Str("Принудительное закрытие позиций",   "BOR;P=C;");
         elif(ValType(DealData.A95) == V_UNDEF)
           m_rep.Put_Str("",           "BOR;P=C;");
         elif (index(DealData.A10 ,"РЕПО ч.") > 0) /*По Репо выводим цену сделки (в заявке всегда 0.0 по Репо)*/
           m_rep.Put_Val(price,        "BOR;HA=R;VA=C;T=N4;");
         elif (DealData.A95 == 0.0) /*Если не Репо и в заявке нет цены, но заявка есть*/
           m_rep.Put_Str("Рыночная",   "BOR;P=C;");
         else
           m_rep.Put_Val(DealData.A95, "BOR;HA=R;VA=C;T=N4;");
         end;

         m_rep.Put_Str(price,       "BOR;P=C;");

         if(DealData.A13_i != 0.0)
           m_rep.Put_Val(ЧислоCЗаданнойТочностью(DoubleToMoney(DealData.A13_i), 4) + "%",    "BOR;P=C;");
         else
           m_rep.Put_Str("",                 "BOR;P=C;");
         end;

         m_rep.Put_Val(DealData.A15,         "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A15)+";");
         m_rep.Put_Val(DealData.A16,         "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A17,         "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A32_1,       "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A32_CCY,     "BOR;P=C;");
         
         var NeedPrefix = "";
         if (DealData.A33_1 != 0) NeedPrefix = "+;"; end;

         m_rep.Put_Val(DealData.A33_1,       "BOR;HA=R;VA=C;T=M2;" + NeedPrefix);
         m_rep.Put_Val(DealData.A33_CCY,     "BOR;P=C;");
         m_rep.Put_Val(DealData.A33_3,       "BOR;HA=R;VA=C;T=M2;" + NeedPrefix);
         m_rep.Put_Str(DealData.A34,         "BOR;HA=R;VA=C;T=M2;");
         
         NeedPrefix = "";
         if (DealData.A35 != 0) NeedPrefix = "+;"; end;

         m_rep.Put_Val(DealData.A35,         "BOR;HA=R;VA=C;T=M6;" + NeedPrefix);
         m_rep.Put_Val(DealData.A28,         "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A29,         "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A29)+";");
         m_rep.Put_Val(DealData.A26,         "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(DealData.A24,         "BOR;P=C;");

         m_rep.Put_Str("","END;");

         //UseProgress(i = i + 1);
       end;

       //RemProgress();

       m_rep.Blank_Line();
     end;
  END; 

  PRIVATE MACRO PrintAccMoneyMoving(ContrID:integer)
    var MoveData = СBrokerRep_MoveData(m_RepParams, ContrID);
    var FirstColStyle  = "START;BOR;IC="+m_CellColor+";HA=L;R=4;";
    var SecondColStyle = "BOR;HA=R;T=M2;";
    var currAcc;
    var currArr = MoveData.GetCurrArr(@currAcc);
    var dataA36Arr   = TArray();
    var dataA37Arr   = TArray();
    var dataA38Arr   = TArray();
    var dataA39Arr   = TArray();
    var dataA40Arr   = TArray();
    var dataA41Arr   = TArray();
    var dataA42Arr   = TArray();
    var dataA43Arr   = TArray();
    var dataA44Arr   = TArray();
    var dataA45Arr   = TArray();
    var dataA46Arr   = TArray();
    var dataA47Arr   = TArray();
    var dataA48Arr   = TArray();
    var dataA49Arr   = TArray();
    var dataA49_1Arr = TArray();
    var dataA50Arr   = TArray();
    var dataA51Arr   = TArray();
    var dataA51_1Arr = TArray();
/*ak*/
    var dataMarketComissNDSArr = TArray();
/*~ak*/
    var i = 0;
    
    //возвращает максимальное количество проводок по РОВУ в разрезе по валютам
    private macro maxTrnsROVU()
      var fiidConcat = "", comma; 
      for (var h:numeric,0,currArr.size-1)
        if (h!=(currArr.size-1))
          comma = ",";
        else
          comma = "";
        end;
        fiidConcat = fiidConcat + string(currArr(h)) + comma;
      end;
      var accountsConcat = ""; 
      for (var f:numeric,0,currAcc.size-1)
        if (f!=(currAcc.size-1))
          comma = ",";
        else
          comma = "";
        end;
        accountsConcat = accountsConcat + "'" + string(currAcc(f)) + "'" + comma;
      end;
      var query =  
       " select max(cnt) max_trns_curr from (                                                                                                                                                             "+
       " SELECT count(*) cnt, acctrn.t_fiid_payer FROM doprdocs_dbt t, dacctrn_dbt acctrn, dacctrn_state_dbt acctrn_state WHERE                                                                           "+
       " (t.t_id_operation in (SELECT t_id_operation FROM doproper_dbt t WHERE  (t.t_dockind =159  AND t.t_documentid in (                                                                                "+
       " select lpad(to_char(ac.t_id), 10, '0') from ddl_acc_dbt ac where ac.t_opertype = 48 and ac.t_valuedate between ? and ?                                                                           "+
       " and ac.t_client = " + m_RepParams.clientid + " and ac.t_clientcontr = " + m_RepParams.cntrid + " and ac.t_fiid in ("+fiidConcat+")                                                               "+
       " ))))                                                                                                                                                                                             "+
       " AND  (t.t_DocKind=1 AND t.t_AccTrnID=acctrn.t_AccTrnID AND                                                                                                                                       "+
       " ((acctrn.t_State=1 OR acctrn.t_State=2) OR acctrn.t_State=3) AND acctrn.t_State=acctrn_state.t_State(+))                                                                                         "+
       " and acctrn.t_accountid_payer in (select da.t_accountid from daccount_dbt da where da.t_account in ("+accountsConcat+"))                                                                          "+
       " group by acctrn.t_fiid_payer )                                                                                                                                                                   ";
      var cmd = DL_RSDCommand(query);
      cmd.AddParam(m_RepParams.BegDate);
      cmd.AddParam(m_RepParams.EndDate);
      var DataSet = cmd.Execute();
      if(DataSet.moveNext())
        if (DataSet.max_trns_curr!=null)
          return DataSet.max_trns_curr;
        end;
      end;       
      return 0;
    end;
    
    //вернуть строку таблицы раздела "Расшифровка Депозитарной комиссии"
    private macro getRecTrnROVU(n,account) //n - условный порядковый номер проводки (отсчет с 1), account - счет клиента для операции РОВУ
      var query = 
        "SELECT acctrn.*, pm_scrhlp.GetFinInstrCode(acctrn.t_fiid_payer,1) iso_fiid FROM doprdocs_dbt t, dacctrn_dbt acctrn, dacctrn_state_dbt acctrn_state WHERE                                                                                             "+
        " (t.t_id_operation in (SELECT t_id_operation FROM doproper_dbt t WHERE  (t.t_dockind =159  AND t.t_documentid in (                                                                        "+
        " select lpad(to_char(ac.t_id), 10, '0') from ddl_acc_dbt ac where ac.t_opertype = 48 and ac.t_valuedate between ? and ?                                                                   "+
        " and ac.t_client = " + m_RepParams.clientid + " and ac.t_clientcontr = " + m_RepParams.cntrid + 
        "))))                                                                                                                                                                                      "+
        "AND  (t.t_DocKind=1 AND t.t_AccTrnID=acctrn.t_AccTrnID AND                                                                                                                                "+
        "((acctrn.t_State=1 OR acctrn.t_State=2) OR acctrn.t_State=3) AND acctrn.t_State=acctrn_state.t_State(+))                                                                                  "+
        "and acctrn.t_accountid_payer in (select da.t_accountid from daccount_dbt da where da.t_account = '"+account+"')                                                                           "+
        "order by acctrn.t_acctrnid";
      var cmd = DL_RSDCommand(query);
      cmd.AddParam(m_RepParams.BegDate);
      cmd.AddParam(m_RepParams.EndDate);
      var DataSet = cmd.Execute();
      var arr = TArray();
      var s=0;
      while (DataSet.moveNext())
        s = s + 1;
        if (s==n)
          arr(0) = GetDateS(DataSet.Date_Carry);
          arr(1) = string(DataSet.Sum_Payer);
          arr(2) = string(DataSet.iso_Fiid);
          arr(3) = DataSet.Ground;
          return arr;
        end;  
      end;
      arr(0) = "";
      arr(1) = "";
      arr(2) = "";
      arr(3) = "";
      return arr;    
    end;


    if(currArr.size > 0)

      while(i < currArr.size)
        MoveData.SetCurrency(currArr[i]);

        dataA36Arr[i]   = MoveData.A36;
        dataA37Arr[i]   = MoveData.A37;
        dataA38Arr[i]   = MoveData.A38;
        dataA39Arr[i]   = MoveData.A39;
        dataA40Arr[i]   = MoveData.A40;
        dataA41Arr[i]   = MoveData.A41;
        dataA42Arr[i]   = MoveData.A42;
        dataA43Arr[i]   = MoveData.A43;
        dataA44Arr[i]   = MoveData.A44;
        dataA45Arr[i]   = MoveData.A45;
        dataA46Arr[i]   = MoveData.A46;
        dataA47Arr[i]   = MoveData.A47;
        dataA48Arr[i]   = MoveData.A48;
        dataA49Arr[i]   = MoveData.A49;
        dataA49_1Arr[i] = MoveData.A49_1;
        dataA50Arr[i]   = MoveData.A50;
        dataA51Arr[i]   = MoveData.A51;
/*ak*/
        dataMarketComissNDSArr[i] = MoveData.MarketComissNDS;
/*~ak*/

        if(m_RepParams.ShowPlanRest == true)
          dataA51_1Arr[i] = MoveData.A51_1;
        end;

        i = i + 1;
      end;

      m_Rep.Set_WrapText(0);
      
      //m_rep.Put_Str("ДВИЖЕНИЕ ПО ДЕНЕЖНЫМ СРЕДСТВАМ", "START;HA=L;R="+string(4+currArr.size)+";END;");

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str(" ДВИЖЕНИЕ ПО ДЕНЕЖНЫМ СРЕДСТВАМ", "START;HA=L;");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str(" ДВИЖЕНИЕ ПО ДЕНЕЖНЫМ СРЕДСТВАМ", "HA=L;");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("","");
          m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
        end;
        i = i + 1;
      end;

      m_Rep.Set_WrapText(1);

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Val(GetFinInstrCcy(currArr[i],true,false), "START;BRL;BRT;HA=L;", m_CellHeight);
          m_rep.Put_Str("","BRT;");
          m_rep.Put_Str("","BRT;");
          m_rep.Put_Str("","BRT;");
          m_rep.Put_Str("","BRT;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str(GetFinInstrCcy(currArr[i],true,false), "BRL;BRT;HA=L;");
          m_rep.Put_Str("","BRT;");
          m_rep.Put_Str("","BRT;");
          m_rep.Put_Str("","BRT;");
          m_rep.Put_Str("","BRT;");
        end;
        m_rep.Put_Str("","BRT;");
        m_rep.Put_Str("", "BRT;BRR;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          if(m_ClientData.IsIndividual)
            m_rep.Put_Str("ВХОДЯЩАЯ СУММА СРЕДСТВ НА СЧЕТЕ","START;BOR;HA=L;R=4;");
          else
            m_rep.Put_Str("ВХОДЯЩАЯ СУММА СРЕДСТВ НА СЧЕТЕ " + currAcc[i],"START;BOR;HA=L;R=4;");
          end;
        else
          m_rep.Put_Str("","");
          if(m_ClientData.IsIndividual)
            m_rep.Put_Str("ВХОДЯЩАЯ СУММА СРЕДСТВ НА СЧЕТЕ","BOR;HA=L;R=4;");
          else
            m_rep.Put_Str("ВХОДЯЩАЯ СУММА СРЕДСТВ НА СЧЕТЕ " + currAcc[i],"BOR;HA=L;R=4;");
          end;
        end;
        m_rep.Put_Str(dataA36Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("Перечислено на торги","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("Перечислено на торги","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA37Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("ЗАЧИСЛЕНО НА СЧЕТ","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("ЗАЧИСЛЕНО НА СЧЕТ","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA38Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("Сумма продаж","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("Сумма продаж","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA39Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("ПКД","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("ПКД","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA40Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("Выплата купона","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("Выплата купона","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA41Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("СПИСАНО СО СЧЕТА","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("СПИСАНО СО СЧЕТА","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA42Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("Сумма покупок","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("Сумма покупок","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA43Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("УНКД","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("УНКД","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA44Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("КОМИССИЯ БИРЖИ","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("КОМИССИЯ БИРЖИ","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA45Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

/*ak
      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("Комиссия биржи без НДС","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("Комиссия биржи без НДС","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(money(dataA45Arr[i] - dataMarketComissNDSArr[i]), SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("НДС с комиссии биржи","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("НДС с комиссии биржи","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataMarketComissNDSArr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;
~ak*/

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("КОМИССИЯ БРОКЕРА","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("КОМИССИЯ БРОКЕРА","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA46Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("САЛЬДО РАСЧЕТОВ","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("САЛЬДО РАСЧЕТОВ","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA47Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("Возврат средств","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("Возврат средств","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA48Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      
      if((SubTypeContr (ContrID) == 10) or (SubTypeContr (ContrID) == 11))//BIQ-5485 этой строки в шаблоне андерра нет, BIQ-8720 тоже
            // m_rep.Put_Str("", "START;HA=L;R=0;END;");
      else 
         while(i < currArr.size)
           if(i == 0)
             m_rep.Put_Str("Компенсационные взносы","START;BOR;HA=L;R=4;");
           else
             m_rep.Put_Str("","");
             m_rep.Put_Str("Компенсационные взносы","BOR;HA=L;R=4;");
           end;
           m_rep.Put_Str(dataA49Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
           i = i + 1;
         end;
      end;   

      i = 0;

      while(i < currArr.size)
        if(i == 0)
          m_rep.Put_Str("ДЕПОЗИТАРНАЯ КОМИССИЯ","START;BOR;HA=L;R=4;");
        else
          m_rep.Put_Str("","");
          m_rep.Put_Str("ДЕПОЗИТАРНАЯ КОМИССИЯ","BOR;HA=L;R=4;");
        end;
        m_rep.Put_Str(dataA49_1Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        i = i + 1;
      end;

      i = 0;
      
        while(i < currArr.size)
          if(dataA50Arr[i] != 0) 
            if(i == 0)
              m_rep.Put_Str("ПРОЧЕЕ ДВИЖЕНИЕ ПО СЧЕТУ","START;BOR;HA=L;R=4;");
            else
              m_rep.Put_Str("","");
              m_rep.Put_Str("ПРОЧЕЕ ДВИЖЕНИЕ ПО СЧЕТУ","BOR;HA=L;R=4;");
            end;
            m_rep.Put_Str(dataA50Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
          else
            if(i == 0)
              m_rep.Put_Str("ОСТАТОК СРЕДСТВ НА СЧЕТЕ","START;BOR;HA=L;R=4;");
            else
              m_rep.Put_Str("","");
              m_rep.Put_Str("ОСТАТОК СРЕДСТВ НА СЧЕТЕ","BOR;HA=L;R=4;");
            end;
            m_rep.Put_Str(dataA51Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
          end;
          i = i + 1;
        end;
      

      i = 0;
      while(i < currArr.size)
        if(dataA50Arr[i] != 0)
          if(i == 0)
            m_rep.Put_Str("ОСТАТОК СРЕДСТВ НА СЧЕТЕ","START;BOR;HA=L;R=4;");
          else
            m_rep.Put_Str("","");
            m_rep.Put_Str("ОСТАТОК СРЕДСТВ НА СЧЕТЕ","BOR;HA=L;R=4;");
          end;
          m_rep.Put_Str(dataA51Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        else
          if(i == 0)
            m_rep.Put_Str("ПЛАНОВЫЙ ОСТАТОК СРЕДСТВ НА СЧЕТЕ","START;BOR;HA=L;R=4;");
          else
            m_rep.Put_Str("","");
            m_rep.Put_Str("ПЛАНОВЫЙ ОСТАТОК СРЕДСТВ НА СЧЕТЕ","BOR;HA=L;R=4;");
          end;
          m_rep.Put_Str(dataA51_1Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        end;
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(dataA50Arr[i] != 0)
          if(i == 0)
            m_rep.Put_Str("ПЛАНОВЫЙ ОСТАТОК СРЕДСТВ НА СЧЕТЕ","START;BOR;HA=L;R=4;");
          else
            m_rep.Put_Str("","");
            m_rep.Put_Str("ПЛАНОВЫЙ ОСТАТОК СРЕДСТВ НА СЧЕТЕ","BOR;HA=L;R=4;");
          end;
          m_rep.Put_Str(dataA51_1Arr[i], SecondColStyle+"R=1;"+IIF(i==currArr.size-1, "END;",""));
        else
          if(i == 0)
            m_rep.Put_Str("","START;R=4;");
          else
            m_rep.Put_Str("","");
            m_rep.Put_Str("","R=4;");
          end;
          m_rep.Put_Str("", "R=1;"+IIF(i==currArr.size-1, "END;",""));
        end;
        i = i + 1;
      end;

      m_rep.Blank_Line();

      m_Rep.Set_WrapText(0);
      
      i = 0;
      while(i < currArr.size)
        if(i == 0)
          if ((dataA49_1Arr[i]!=null) and (dataA49_1Arr[i]>0))
              m_rep.Put_Str(" Расшифровка Депозитарной комиссии", "START;HA=L;");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          else 
              m_rep.Put_Str("", "START;HA=L;");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          end;
        else
          if ((dataA49_1Arr[i]!=null) and (dataA49_1Arr[i]>0))
              m_rep.Put_Str("","");
              m_rep.Put_Str(" Расшифровка Депозитарной комиссии", "HA=L;");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          else 
              m_rep.Put_Str("","");
              m_rep.Put_Str("", "HA=L;");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          end;
        end;
        i = i + 1;
      end;

      i = 0;
      while(i < currArr.size)
        if(i == 0)
          if ((dataA49_1Arr[i]!=null) and (dataA49_1Arr[i]>0))
              m_rep.Put_Str("Дата комиссии", "START;HA=L;BOR;WT");
              m_rep.Put_Str("Сумма комиссии","BOR;WT");
              m_rep.Put_Str("Валюта комиссии","BOR;WT");
              m_rep.Put_Str("Основание проводки по комиссии","WT;BOR");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          else 
              m_rep.Put_Str("", "START;HA=L;");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          end;
        else
          if ((dataA49_1Arr[i]!=null) and (dataA49_1Arr[i]>0))
              m_rep.Put_Str("","");
              m_rep.Put_Str("Дата комиссии", "HA=L;BOR;WT");
              m_rep.Put_Str("Сумма комиссии","BOR;WT");
              m_rep.Put_Str("Валюта комиссии","BOR;WT");
              m_rep.Put_Str("Основание проводки по комиссии","BOR;WT");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          else 
              m_rep.Put_Str("","");
              m_rep.Put_Str("", "HA=L;");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("","");
              m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
          end;
        end;
        i = i + 1;
      end;

      var maxLines = maxTrnsROVU(); 
      for (var j:numeric, 1, maxLines)
        i = 0; //пройти по массиву валют
        while(i < currArr.size)
          if(i == 0)
            if ((dataA49_1Arr[i]!=null) and (dataA49_1Arr[i]>0))
                var t = getRecTrnROVU(j,currAcc(i)); //запись из таблицы проводок по порядковому номеру проводки и счету, сортируем по id проводки
                if (strlen(t(0))>0)
                  m_rep.Put_Str(t(0),"START;HA=L;BOR");
                  m_rep.Put_Str(t(1),"BOR");
                  m_rep.Put_Str(t(2),"BOR");
                  m_rep.Put_Str(t(3),"BOR;WT");  
                else
                  m_rep.Put_Str(t(0),"START;HA=L");
                  m_rep.Put_Str(t(1),"");
                  m_rep.Put_Str(t(2),"");
                  m_rep.Put_Str(t(3),"WT"); 
                end;
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
            else 
                m_rep.Put_Str("", "START;HA=L;");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
            end;
          else
            if ((dataA49_1Arr[i]!=null) and (dataA49_1Arr[i]>0))
                var m = getRecTrnROVU(j,currAcc(i)); //запись из таблицы проводок по порядковому номеру проводки и счету, сортируем по id проводки
                m_rep.Put_Str("","");
                if (strlen(m(1))>0)
                  m_rep.Put_Str(m(0), "HA=L;BOR");
                  m_rep.Put_Str(m(1),"BOR");
                  m_rep.Put_Str(m(2),"BOR");
                  m_rep.Put_Str(m(3),"BOR;WT"); 
                else
                  m_rep.Put_Str(m(0), "HA=L");
                  m_rep.Put_Str(m(1),"");
                  m_rep.Put_Str(m(2),"");
                  m_rep.Put_Str(m(3),"WT");  
                end;
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
            else 
                m_rep.Put_Str("","");
                m_rep.Put_Str("", "HA=L;");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("","");
                m_rep.Put_Str("",IIF(i==currArr.size-1, "END;",""));
            end;
          end;
          i = i + 1;
        end;
      end;

      m_rep.Blank_Line();

    end;

  END;

  PRIVATE MACRO PrintInAccData(ContrID:integer)
/*ak - текущие параметры ЦБ*/
     PRIVATE MACRO ТекущиеПараметры( FIID, dt )
       var cmd = DL_RSDCommand(
                             " select 'купон '||case when fiwarnts.t_relativeincome = chr(88) "
                             + "                      then trim(to_char(fiwarnts.t_incomerate,'99999999999999999990.'||lpad('0',fiwarnts.t_incomepoint,'9'))) "
                             + "                      else trim(to_char(fiwarnts.t_incomevolume,'99999999999999999990.'||lpad('0',fiwarnts.t_incomepoint,'9')))||' '||nvl(fininstr.t_ccy,'?') "
                             + "                 end "
                           /*  + "               ||case when dininstrp.t_drawingdate != to_date('01.01.0001','dd.mm.yyyy') "
                             + "                      then ' дата погашения '||to_char(dininstrp.t_drawingdate,'dd.mm.yyyy') "
                             + "                      else '' "
                             + "                 end " */
   /*bpv временно берем дату погашения из ру даты, все ради нулевой даты погашения по бессрочным облигациям*/
           + "    ||case when rd.fintoolid is not null                                                   "
           + "           then ' дата погашения '||to_char(rd.endmtydate,'dd.mm.yyyy' )                   "
           + "           else                                                                            "
           + "           case when dininstrp.t_drawingdate != to_date('01.01.0001','dd.mm.yyyy')         "
           + "                then ' дата погашения '||to_char(dininstrp.t_drawingdate,'dd.mm.yyyy')     "
           + "                else ''                                                                    "
           + "           end                                                                             "
           + "      end                                                                                  "
                             + "               || ' номинал '||case when RSB_FIINSTR.FI_GETNOMINALONDATE(d.t_fiid,?) > 0 then RSB_FIINSTR.FI_GETNOMINALONDATE(d.t_fiid,?) else dininstrp.t_facevalue end " /*CHVA 525951*/ 

                             + "               ||' '|| (select (select t_ccy from dfininstr_dbt where t_fiid = f.t_facevaluefi) from dfininstr_dbt f where f.t_fiid = d.t_fiid) t_cupon "
                             + "from dfiwarnts_dbt fiwarnts "
                             + "left join dfininstr_dbt fininstr on fininstr.t_fiid = fiwarnts.t_incomefi "
                             + "join (select t_fiid, t_id "
                             + "      from (select fiwarnts.t_fiid, fiwarnts.t_id "
                             + "            from dfiwarnts_dbt fiwarnts "
                             + "            where fiwarnts.t_fiid = ? and "
                             + "                  fiwarnts.t_drawingdate >= ? "
                             + "            order by fiwarnts.t_drawingdate, fiwarnts.t_id desc) "
                             + "      where rownum = 1) d on rsi_rsb_fiinstr.FI_IsCouponAvoiriss(d.t_fiid) = 1 and "
                             + "                             fiwarnts.t_id = d.t_id "
                             + "join dfininstr_dbt dininstrp on dininstrp.t_fiid = d.t_fiid"
+" left join dobjcode_dbt o  on t_objecttype = 9 and t_codekind = 104 and t_objectid = d.t_fiid "
+" left join sofr_info_fintoolreferencedata rd on rd.fintoolid = o.t_code                       "
); 
       cmd.AddParam(dt);  /*CHVA 525951*/ 
       cmd.AddParam(dt);
       cmd.AddParam(FIID);
       cmd.AddParam(dt);
       var dataSet = cmd.Execute();
       if(dataSet.movenext())
         return dataSet.cupon;
       else
         cmd = DL_RSDCommand("select 'дата погашения '||to_char(fininstr.t_drawingdate,'dd.mm.yyyy') "
                             + "               || ' номинал '||case when RSB_FIINSTR.FI_GETNOMINALONDATE(fininstr.t_fiid,?) > 0 then RSB_FIINSTR.FI_GETNOMINALONDATE(fininstr.t_fiid,?) else fininstr.t_facevalue end " /*PNV 511546*/ 
                             + "               ||' '|| (select (select t_ccy from dfininstr_dbt where t_fiid = f.t_facevaluefi) from dfininstr_dbt f where f.t_fiid = fininstr.t_fiid) "
                             + "  t_cupon "
                           + "from dfininstr_dbt fininstr "
                           + "where fininstr.t_fiid = ? and "
                           + "      fininstr.t_drawingdate != to_date('01.01.0001','dd.mm.yyyy')");
         cmd.AddParam(dt);
         cmd.AddParam(dt);  /*PNV 511546*/ 

         cmd.AddParam(FIID);
         dataSet = cmd.Execute();
         if(dataSet.movenext())
           return dataSet.cupon;
         else
           return "";
         end;
       end;
     END;
/*~ak*/
     var query, cmd, DataSet;
     var InAccData = NULL;
     var prevPlaceID = NULL;
     var cnt = 0, i = 0;

     //Напечатать итоговые строки
     MACRO PrintItogLines(PlaceID:integer)
       var q, Select, ds;
       
       q =   " select sum(t_A55) t_A55, sum(t_A56) t_A56, sum(t_A56_1) t_A56_1, sum(t_A57) t_A57, sum(t_A57_1) t_A57_1, sum(t_A58) t_A58, sum(t_A58_1) t_A58_1, sum(t_A60) t_A60, sum(t_A61) t_A61, sum(t_A62) t_A62, sum(t_A63) t_A63 "
           + "   from dbrkrepinacc_u_tmp  "
           + "  where t_ClientID = ? "
           + "    and t_ContrID = ? "
          // + "    and t_PlaceID = ? "
           + "    and t_IsItog = 'X' ";

       Select = DL_RSDCommand(q);
       Select.AddParam(m_RepParams.ClientID);
       Select.AddParam(ContrID);
       //Select.AddParam(PlaceID);
       
       if(Select.GetCount())
         ds = Select.Execute();
         
         m_Rep.Set_WrapText(1);
         while(ds.moveNext())
/*ak - Объединям
           m_rep.Put_Str("Итого:", "BOR;P=C;START;");*/
           m_rep.Put_Val("Итого:", "BOR;HA=C;VA=T;START;R=1;", m_CellHeight);
/*~ak*/
/*ak - Объединям
           m_rep.Put_Str("",       "BOR;P=C;");*/
           m_rep.Put_Str("",       "BOR;P=C;R=1;");
/*~ak*/
/*ak - Добавляем*/
           m_rep.Put_Str("",       "BOR;P=C;");
/*~ak*/
           m_rep.Put_Val(ds.A55,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A55)+";");
           m_rep.Put_Val(ds.A56,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A56)+";");
/*ak - Убираем
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Val(ds.A56_1, "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A56_1)+";");
           end;
~ak*/
           m_rep.Put_Val(ds.A57,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A57)+";");
/*ak - Убираем
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Val(ds.A57_1, "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A57_1)+";");
           end;
~ak*/
           m_rep.Put_Val(ds.A58,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A58)+";");
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Val(ds.A58_1, "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A58_1)+";");
           end;
/*ak - Объединям
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Val(ds.A61,   "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Val(ds.A63,   "BOR;HA=R;VA=C;T=M2;");*/
           m_rep.Put_Str("",       "BOR;P=C;R=1;");

           if(m_RepParams.CourseCurVisible)
             m_rep.Put_Val("",     "BOR;P=C;R=1;");
           end;

           m_rep.Put_Str(ds.A60,   "BOR;HA=C;VA=T;T=M2;R=1;");
           m_rep.Put_Val(ds.A61,   "BOR;HA=C;VA=T;T=M2;R=1;");
           m_rep.Put_Str(ds.A62,   "BOR;HA=C;VA=T;T=M2;R=1;");
           m_rep.Put_Val(ds.A63,   "BOR;HA=C;VA=T;T=M2;R=1;");
/*~ak*/

           m_rep.Put_Str("","END;");
         end;
       end;
     END;
     
     query =   " select t_PlaceID, t_A53, t_A54, t_A55, t_A56, t_A56_1, t_A57, t_A57_1, t_A58, t_A58_1, t_A59, t_A59_1, t_A60, t_A61, t_A62, t_A63, "
/*ak - добавляем цб*/
             + "        brkrepinacc.t_fiid, "
/*~ak*/
             + "        NVL(pt.t_ShortName, CHR(1)) as PlaceName, "
             + "        NVL(fin59.t_CCY, CHR(1)) as A59_CCY "
             + "   from dbrkrepinacc_u_tmp brkrepinacc "
             + "        left join dparty_dbt pt on pt.t_PartyID = t_PlaceID"
             + "        left join dfininstr_dbt fin59 on fin59.t_FIID = t_A59_1 "
             + "  where t_ClientID = ? "
             + "    and t_ContrID = ? "
             + "    and t_IsItog = CHR(0) "
             + "  order by t_A53";//t_PlaceID";
             
     cmd = DL_RSDCommand(query);
     cmd.AddParam(m_RepParams.ClientID);
     cmd.AddParam(ContrID);

     cnt = cmd.GetCount();
     
     if(cnt)
     
       InAccData = cmd.Execute();

       m_Rep.Set_WrapText(0);
/*ak - Меняем шрифт и убираем нумерацию, убираем пустую строку, выводим со второй колонки
       m_rep.Put_Str("6.    СОСТАВ ПОРТФЕЛЯ ПО ИТОГАМ ТОРГОВ С "+DL_DateToStr(m_RepParams.BegDate:f)+" ПО "+DL_DateToStr(m_RepParams.EndDate:f), "START;FB;HA=L;R=6;END;");*/
       m_rep.Blank_Line();
       m_rep.Put_Str("СОСТАВ ПОРТФЕЛЯ ПО ИТОГАМ ТОРГОВ С "+GetDateS(m_RepParams.BegDate)+" ПО "+GetDateS(m_RepParams.EndDate), "START;I=2;HA=L;R=6;END;");
/*~ak*/

       //InitProgress(cnt, "Подготовка раздела 6", "Состав портфеля по итогам торгов");

       while(InAccData.moveNext())
         
/*ak
         if(prevPlaceID != InAccData.PlaceID)
           if(prevPlaceID != NULL)
             PrintItogLines(prevPlaceID);
             m_rep.Blank_Line();
           end;*/
           
         if(prevPlaceID == NULL)
           m_rep.Blank_Line();
           prevPlaceID = 0;
/*~ak*/

           m_Rep.Set_WrapText(0);
/*ak
           m_rep.Put_Str("Отчет/Выписка о движении по счету: Место хранения ЦБ: ", "START;HA=L;R=4;");
           m_rep.Put_Str(InAccData.PlaceName, "HA=L;END;");*/
           //m_rep.Put_Str("Отчет/Выписка о движении по счету: Счет/Раздел счета ДЕПО: " + m_ClientData.Note104DBO(), "START;HA=L;R=4;END;");
           m_rep.Put_Str("Отчет/Выписка о движении по счету: Счет/Раздел счета ДЕПО: " + m_ClientData.Note104DBO(), "START;HA=L;END;");
/*~ak*/
/*ak - Убираем пустую строку
           m_rep.Blank_Line();
~ak*/
           
           m_Rep.Set_WrapText(1);
/*ak - Объединяем два столбца
           m_rep.Put_Str("Номер гос. регистрации/ ISIN", m_TableHeadStyle+"START;");*/
           m_rep.Put_Val("Номер гос. регистрации/ISIN", m_TableHeadStyle+"START;R=1;", 25.5/*, m_CellHeight*/);
/*~ak*/
/*ak - Объединяем два столбца
           m_rep.Put_Str("Выпуск ЦБ",                    m_TableHeadStyle);*/
           m_rep.Put_Str("Выпуск ЦБ",                    m_TableHeadStyle+"R=1;");
/*~ak*/
/*ak - Добавляем столбец*/
           m_rep.Put_Str("Текущие параметры",                    m_TableHeadStyle);
/*~ak*/
           m_rep.Put_Str("Остаток входящий",             m_TableHeadStyle);
           m_rep.Put_Str("Зачислено",                    m_TableHeadStyle);
/*ak - Убираем
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Str("Зачислено (план.)",            m_TableHeadStyle);
           end;
~ak*/
           m_rep.Put_Str("Списано",                      m_TableHeadStyle);
/*ak - Убираем
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Str("Списано (план.)",              m_TableHeadStyle);
           end;
~ak*/
           m_rep.Put_Str("Остаток исходящий",            m_TableHeadStyle);
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Str("Остаток исходящий(ПЛАНОВЫЙ)",    m_TableHeadStyle);
           end;
/*ak - Объединяем два столбца
           m_rep.Put_Str("Котировка",                    m_TableHeadStyle);*/
           m_rep.Put_Str("Котировка",                    m_TableHeadStyle+"R=1;");
          
           if(m_RepParams.CourseCurVisible)
             m_rep.Put_Str("Валюта котировки",           m_TableHeadStyle+"R=1;");
           end;
/*~ak*/
/*ak - Объединяем два столбца
           m_rep.Put_Str("Стоимость (8*10)",              m_TableHeadStyle);*/
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Str("Стоимость (6*8)",              m_TableHeadStyle+"R=1;");
           else
             m_rep.Put_Str("Стоимость (5*7)",              m_TableHeadStyle+"R=1;");
           end;
/*~ak*/
/*ak - Объединяем два столбца
           m_rep.Put_Str("Стоимость в рублях",           m_TableHeadStyle);*/
           m_rep.Put_Str("Стоимость в рублях",           m_TableHeadStyle+"R=1;");
/*~ak*/
/*ak - Объединяем два столбца
           m_rep.Put_Str("НКД",                          m_TableHeadStyle);*/
           m_rep.Put_Str("НКД",                          m_TableHeadStyle+"R=1;");
/*~ak*/
/*ak - Объединяем два столбца
           m_rep.Put_Str("НКД в рублях",                 m_TableHeadStyle);*/
           m_rep.Put_Str("НКД в рублях",                 m_TableHeadStyle+"R=1;");
/*~ak*/

           m_rep.Put_Str("","END;");


           m_Rep.Set_WrapText(1);
/*ak - Объединяем два столбца
           m_rep.Put_Str("1", "BOR;P=C;START;");*/
           m_rep.Put_Val("1", "BOR;P=C;START;R=1;", m_CellHeight);
/*~ak*/
/*ak - Объединяем два столбца
           m_rep.Put_Str("2", "BOR;P=C;");*/
           m_rep.Put_Str("2", "BOR;P=C;R=1;");
/*~ak*/
/*ak - Добавляем столбец*/
           m_rep.Put_Str("2а", "BOR;P=C;");
/*~ak*/
           m_rep.Put_Str("3", "BOR;P=C;");
           m_rep.Put_Str("4", "BOR;P=C;");
/*ak - Убираем
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Str("5", "BOR;P=C;");
           end;
~ak*/
/*ak
           m_rep.Put_Str("6", "BOR;P=C;");*/
           m_rep.Put_Str("5", "BOR;P=C;");
/*~ak*/
/*ak - Убираем
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Str("7", "BOR;P=C;");
           end;
~ak*/
/*ak
           m_rep.Put_Str("8", "BOR;P=C;");*/
           m_rep.Put_Str("6", "BOR;P=C;");
/*~ak*/
/*ak*/
           var delta = 0;
/*~ak*/
           if(m_RepParams.ShowPlanRest == true)
/*ak
             m_rep.Put_Str("9", "BOR;P=C;");*/
             delta = delta + 1;
             m_rep.Put_Str(string(6+delta), "BOR;P=C;");
/*~ak*/
           end;
/*ak
           m_rep.Put_Str("10", "BOR;P=C;");
           m_rep.Put_Str("11", "BOR;P=C;");
           m_rep.Put_Str("12", "BOR;P=C;");
           m_rep.Put_Str("13", "BOR;P=C;");
           m_rep.Put_Str("14", "BOR;P=C;");*/
           m_rep.Put_Str(string(7+delta), "BOR;P=C;R=1;");

           if(m_RepParams.CourseCurVisible)
             delta = delta + 1;
             m_rep.Put_Str(string(7+delta), "BOR;P=C;R=1;");
           end;

           m_rep.Put_Str(string(8+delta), "BOR;P=C;R=1;");
           m_rep.Put_Str(string(9+delta), "BOR;P=C;R=1;");
           m_rep.Put_Str(string(10+delta), "BOR;P=C;R=1;");
           m_rep.Put_Str(string(11+delta), "BOR;P=C;R=1;");
/*~ak*/

           m_rep.Put_Str("","END;");

         end;

/*ak - Объединяем
         m_rep.Put_Str(InAccData.A53,   "BOR;P=C;START;");*/
         m_rep.Put_Val(InAccData.A53,   "BOR;HA=C;VA=T;START;R=1;", 38.25/*, m_CellHeight*/);
/*~ak*/
/*ak - Объединяем
         m_rep.Put_Str(InAccData.A54,   "BOR;P=C;");*/
         m_rep.Put_Str(InAccData.A54,   "BOR;HA=C;VA=T;R=1;");
/*~ak*/
/*ak - Добавляем*/
         m_rep.Put_Str(ТекущиеПараметры(InAccData.fiid, m_RepParams.EndDate),   "BOR;HA=C;VA=T;");
/*~ak*/
         m_rep.Put_Val(InAccData.A55,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A55)+";");
         m_rep.Put_Val(InAccData.A56,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A56)+";");
/*ak - Убираем
         if(m_RepParams.ShowPlanRest == true)
           m_rep.Put_Val(InAccData.A56_1, "BOR;HA=C;VA=C;T=M"+AmountPrecision(InAccData.A56_1)+";");
         end;
~ak*/
         m_rep.Put_Val(InAccData.A57,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A57)+";");
/*ak - Убираем
         if(m_RepParams.ShowPlanRest == true)
           m_rep.Put_Val(InAccData.A57_1, "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A57_1)+";");
         end;
~ak*/
         m_rep.Put_Val(InAccData.A58,   "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A58)+";");
         if(m_RepParams.ShowPlanRest == true)
           m_rep.Put_Val(InAccData.A58_1, "BOR;HA=C;VA=T;T=M2"+AmountPrecision(InAccData.A58_1)+";");
         end;
/*ak - Объединяем
         m_rep.Put_Val(InAccData.A59,    "BOR;HA=R;VA=C;T=M2;");

         if(m_RepParams.CourseCurVisible)
           m_rep.Put_Val(InAccData.A59_CCY,"BOR;P=C");
         end;

         m_rep.Put_Val(InAccData.A60,    "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(InAccData.A61,    "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(InAccData.A62,    "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(InAccData.A63,    "BOR;HA=R;VA=C;T=M2;");*/
         m_rep.Put_Val(InAccData.A59,    "BOR;HA=C;VA=T;T=N4;R=1;");

         if(m_RepParams.CourseCurVisible)
           m_rep.Put_Val(InAccData.A59_CCY,"BOR;HA=C;VA=T;R=1");
         end;

         //m_rep.Put_Val(InAccData.A58*InAccData.A59/*InAccData.A60*/,   "BOR;HA=C;VA=T;T=M2;R=1;");
         m_rep.Put_Val(InAccData.A60,    "BOR;HA=C;VA=T;T=M2;R=1;");
         m_rep.Put_Val(InAccData.A61,    "BOR;HA=C;VA=T;T=M2;R=1;");
         m_rep.Put_Val(InAccData.A62,    "BOR;HA=C;VA=T;T=M2;R=1;");
         m_rep.Put_Val(InAccData.A63,    "BOR;HA=C;VA=T;T=M2;R=1;");
/*~ak*/

         m_rep.Put_Str("","END;");

         prevPlaceID   = InAccData.PlaceID;

         //UseProgress(i = i + 1);
       end;

       //RemProgress();

       PrintItogLines(prevPlaceID);
       m_rep.Blank_Line();
     end;
  END;

  PRIVATE MACRO PrintPoolData(ContrID:integer)
     var query, cmd, DataSet;
     var PoolData = NULL;
     var prevPlaceID = NULL, prevPoolID = NULL;
     var cnt = 0, i = 0, _i = 0;

     //Напечатать итоговые строки
     MACRO PrintItogLines(PlaceID:integer, PoolID:integer)
       var q, Select, ds;
       
       q =   " select t_A75, t_A76, t_A77, t_A78, t_A81, t_A83, t_A84, t_A85 "
           + "   from dbrkreppool_u_tmp  "
           + "  where t_ClientID = ? "
           + "    and t_ContrID = ? "
           + "    and t_PlaceID = ? "
           + "    and t_PoolID = ? "
           + "    and t_IsItog = 'X' ";

       Select = DL_RSDCommand(q);
       Select.AddParam(m_RepParams.ClientID);
       Select.AddParam(ContrID);
       Select.AddParam(PlaceID);
       Select.AddParam(PoolID);
       
       if(Select.GetCount())
         ds = Select.Execute();
         
         m_Rep.Set_WrapText(1);
         while(ds.moveNext())
           m_rep.Put_Str("Итого:", "BOR;P=C;START;");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Val(ds.A75,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A75)+";");
           m_rep.Put_Val(ds.A76,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A76)+";");
           m_rep.Put_Val(ds.A77,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A77)+";");
           m_rep.Put_Val(ds.A78,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A78)+";");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Str("",       "BOR;P=C;");

           if(m_RepParams.CourseCurVisible)
             m_rep.Put_Str("",       "BOR;P=C;");
           end;

           m_rep.Put_Val(ds.A81,   "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Val(ds.A83,   "BOR;HA=R;VA=C;T=M2;");
           m_rep.Put_Str("",       "BOR;P=C;");
           m_rep.Put_Val(ds.A85,   "BOR;HA=R;VA=C;T=M2;");

           m_rep.Put_Str("","END;");
         end;
       end;
     END;
     
     query =   " select t_PlaceID, t_PoolID, brkreppool.t_FIID, t_A73, t_A74, t_A75, t_A76, t_A77, t_A78, t_A79, t_A80, t_A81, t_A82, t_A83, t_A84, t_A85, t_A86, "
             + "        NVL(pt.t_ShortName, CHR(1)) as PlaceName, "
             + "        NVL(llv.t_Name, CHR(1)) as PoolName, "
             + "        NVL(fin79.t_CCY, CHR(1)) as A79_CCY "
             + "   from dbrkreppool_u_tmp brkreppool"
             + "        left join dparty_dbt pt on pt.t_PartyID = t_PlaceID "
             + "        left join dllvalues_dbt llv on llv.t_List = "+OBJTYPE_POOLKSU+" and llv.t_Element = t_PoolID "
             + "        left join dfininstr_dbt fin79 on fin79.t_FIID = t_A79_1 "
             + "  where t_ClientID = ? "
             + "    and t_ContrID = ? "
             + "    and t_IsItog = CHR(0) "
             + "  order by t_PlaceID, t_PoolID";
             
     cmd = DL_RSDCommand(query);
     cmd.AddParam(m_RepParams.ClientID);
     cmd.AddParam(ContrID);

     cnt = cmd.GetCount();
     
     if(cnt)
     
       PoolData = cmd.Execute();

       m_Rep.Set_WrapText(0);
       m_rep.Put_Str("7.  СОСТАВ ЦЕННЫХ БУМАГ ВНЕСЕННЫХ В ИМУЩЕСТВЕННЫЙ ПУЛ КСУ С "+DL_DateToStr(m_RepParams.BegDate:f)+" ПО "+DL_DateToStr(m_RepParams.EndDate:f), "START;FB;HA=L;R=7;END;");
       m_rep.Blank_Line();

       //InitProgress(cnt, "Подготовка раздела 7", "Состав ценных бумаг внесенных в имущественный пул");

       while(PoolData.moveNext())
         
         if((prevPlaceID != PoolData.PlaceID) or (prevPoolID != PoolData.PoolID))
           if(prevPoolID != NULL)
             PrintItogLines(prevPlaceID, prevPoolID);
             m_rep.Blank_Line();
           end;
           
           m_Rep.Set_WrapText(0);
           m_rep.Put_Str("Отчет/Выписка о движении по счету: Место хранения ЦБ: ", "START;HA=L;R=4;");
           m_rep.Put_Str(PoolData.PlaceName, "HA=L;END;");
           m_rep.Put_Str("                    Наименование имущественного пула: ", "START;HA=L;R=4;");
           m_rep.Put_Str(PoolData.PoolName, "HA=L;END;");
           m_rep.Blank_Line();
           
           m_Rep.Set_WrapText(1);
           m_rep.Put_Str("Номер гос. регистрации/ ISIN",     m_TableHeadStyle+"START;", 36);
           m_rep.Put_Str("Вид ЦБ",                           m_TableHeadStyle);
           m_rep.Put_Str("Выпуск ЦБ",                        m_TableHeadStyle);
           m_rep.Put_Str("Эмитент",                          m_TableHeadStyle);
           m_rep.Put_Str("Остаток входящий",                 m_TableHeadStyle);
           m_rep.Put_Str("Зачислено",                        m_TableHeadStyle);
           m_rep.Put_Str("Списано",                          m_TableHeadStyle);
           m_rep.Put_Str("Остаток исходящий",                m_TableHeadStyle);
           m_rep.Put_Str("Котировка",                        m_TableHeadStyle);

           if(m_RepParams.CourseCurVisible)
             m_rep.Put_Str("Валюта котировки",                 m_TableHeadStyle);
           end;

           m_rep.Put_Str("Стоимость (8*9)",                  m_TableHeadStyle);
           m_rep.Put_Str("Стоимость в рублях",               m_TableHeadStyle);
           m_rep.Put_Str("НКД",                              m_TableHeadStyle);
           m_rep.Put_Str("НКД в рублях",                     m_TableHeadStyle);
           m_rep.Put_Str("Итого стоимость (10+12)",          m_TableHeadStyle);
           m_rep.Put_Str("Итого стоимость в рублях (11+13)", m_TableHeadStyle);
           m_rep.Put_Str("","END;");

           m_Rep.Set_WrapText(1);
           _i = 0;
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;START;"); //1
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //2
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //3
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //4
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //5
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //6
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //7
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //8
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //9

           if(m_RepParams.CourseCurVisible)
             m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //10
           end;

           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //11 (10)
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //12 (11)
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //13 (12)
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //14 (13)
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //15 (14)
           m_rep.Put_Str(_i=_i+1, "BOR;P=C;"); //16 (15)
           m_rep.Put_Str("","END;");

         end;

         m_rep.Put_Str(PoolData.A73, "BOR;P=C;START;", 36);
         m_rep.Put_Str(ВидЦБ(PoolData.FIID), "BOR;P=C;");
         m_rep.Put_Str(PoolData.A74, "BOR;P=C;");
         m_rep.Put_Str(PoolData.A86, "BOR;P=C;");
         m_rep.Put_Val(PoolData.A75, "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A75)+";");
         m_rep.Put_Val(PoolData.A76, "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A76)+";");
         m_rep.Put_Val(PoolData.A77, "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A77)+";");
         m_rep.Put_Val(PoolData.A78, "BOR;HA=R;VA=C;T=M"+AmountPrecision(PoolData.A78)+";");
         m_rep.Put_Val(PoolData.A79, "BOR;HA=R;VA=C;T=M2;");

         if(m_RepParams.CourseCurVisible)
           m_rep.Put_Val(PoolData.A79_CCY, "BOR;P=C;");
         end;

         m_rep.Put_Val(PoolData.A80, "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(PoolData.A81, "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(PoolData.A82, "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(PoolData.A83, "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(PoolData.A84, "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(PoolData.A85, "BOR;HA=R;VA=C;T=M2;");

         m_rep.Put_Str("","END;");

         prevPlaceID = PoolData.PlaceID;
         prevPoolID  = PoolData.PoolID;

         //UseProgress(i = i + 1);
       end;

       //RemProgress();

       PrintItogLines(prevPlaceID, prevPoolID);
       m_rep.Blank_Line();
     end;
  END;

  PRIVATE MACRO PrintActiveSumData(ContrID:integer)
    var ActiveSumData = СBrokerRep_ActiveSumData(m_RepParams, ContrID);
    var FirstColStyle  = "START;BOR;IC="+m_CellColor+";HA=L;R=5;";
    var SecondColStyle = "BOR;HA=R;T=M2;END;";

    m_rep.Set_WrapText(0);
    m_rep.Put_Str("8. СУММА АКТИВОВ", "START;FB;HA=L;R=6;END;");

    m_rep.Set_WrapText(1);
    m_rep.Put_Str("СУММА АКТИВОВ на начало отчетного периода, в рублях", FirstColStyle);
    m_rep.Put_Str(ActiveSumData.Sн(), SecondColStyle);

    m_rep.Put_Str("СУММА АКТИВОВ на конец отчетного периода, в рублях", FirstColStyle);
    m_rep.Put_Str(ActiveSumData.Sк(), SecondColStyle);

    m_rep.Blank_Line();
  END;

/*ak - Пользовательская подпись
this->m_rep
*/
   MACRO AddStandardFooter(mode, count: integer, notServOp:bool, _ContrID:integer)/*CHVA 510695*/
     MACRO Операционист():string

         var cmd = DL_RSDCommand("SELECT person.t_Name " +
                                    "  FROM dperson_dbt person " +
                                    " WHERE person.t_PartyID = ? "
                                   );
            cmd.AddParam(m_repparams.SignerParty);

         var RS = cmd.Execute();
         if( RS.MoveNext() )
            return RS.Name;
         else 
            cmd = null;
            cmd = DL_RSDCommand("SELECT person.t_Name " +
                                    "  FROM dperson_dbt person " +
                                    " WHERE person.t_Oper = ? "
                                   );
            cmd.AddParam({oper});
            if( RS.MoveNext() )
               return RS.Name;
            end;
         end;
         return "";
     END;

     MACRO ДолжностьОперациониста():string
         return "Исполнитель";
     END;

     MACRO ТелефонОперациониста():string
         return "(495) 363-02-94";
         var PhoneNumber = "";
         var cmd = DL_RSDCommand("SELECT person.t_PartyID "
                                 "  FROM dperson_dbt person " +
                                 " WHERE person.t_Oper = ? "
                                );
         cmd.AddParam({oper});

         var RS = cmd.Execute();
         if( ( RS.MoveNext() ) and ( FindAdressContactValue( RS.PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber ) == 0 ) )
            return PhoneNumber;
         end;
         return "";
     END;

     var PostOper;

     if(valtype(mode) == V_UNDEF)
       mode = 0;
     end;

     PostOper = ДолжностьОперациониста();

     m_rep.Set_WrapText(0);

     if(mode == 0)
       m_rep.Blank_Line();

       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
if (valtype(count) == v_undef) count = 1; end;
      if ( (count  > 1) and (notServOp)) /*CHVA 510695*/
       m_rep.Put_Str("Подпись1", "FC=W;END;CN=SIGN_2;");
      else
       m_rep.Put_Str("Подпись1", "FC=W;END;CN=SIGN_1;");   
      end;
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   " + PostOper + ": " + Операционист(),"START;P=L;END;");
       m_rep.Put_Str("   М.П.", "START;P=L;END;");/*CHVA 515949*/
       m_rep.Blank_Line();/*CHVA 515949*/
       
       if(SubTypeContr (_ContrID) == 11)//BIQ-8720, DEF-15847 одна строка между МП и Датой составления.
       else 
        m_rep.Put_Str("", "START");/*CHVA 515949*/
        m_rep.Put_Str("", "");/*CHVA 515949*/
        if ((count  > 1) and (notServOp))  /*CHVA 510695*/
          m_rep.Put_Str("Печать", "FC=W;END;CN=STAMP2;");
        else
          m_rep.Put_Str("", "");
          m_rep.Put_Str("", "");
          m_rep.Put_Str("", "");
          m_rep.Put_Str("", "");
          m_rep.Put_Str("", "");
         m_rep.Put_Str("Печать", "FC=W;END;CN=STAMP;"); 
        end;
       m_rep.Blank_Line();
       end; 
       m_rep.Put_Val(string("Дата составления: ", m_RepParams.RepCrDate)/*GetDateS(GetCDS())*/, "START;P=L;END;", m_CellHeight); //dan изменено на пользовательский параметр  RepCrDate

       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Val("   Отчет получен", "START;P=L;END;", m_CellHeight);
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Val("   Клиент_________________________/_________________/Подпись", "START;P=L;END;", m_CellHeight);
       m_rep.Blank_Line();
       m_rep.Put_Val("   ""____""______________20___г.", "START;P=L;END;", m_CellHeight);
     else
       m_rep.Blank_Line(mode);
       m_rep.Put_Str("", "START;");
      if ((count  > 1) and (notServOp)) /*CHVA 510695*/
       m_rep.Put_Str("Подпись1", "FC=W;CN=SIGN_2;");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("Печать", "FC=W;END;CN=STAMP2;");
      else
       m_rep.Put_Str("Подпись1", "FC=W;CN=SIGN_1;");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("Печать", "FC=W;END;CN=STAMP;");
      end;
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();

       m_rep.Blank_Line(mode);
       m_rep.Put_Val(PostOper,"START;VA=C;HA=R;FS=8;", mode);
       m_rep.Put_Val("____________________","P=C;FB;FS=8;");
       m_rep.Put_Val("/ "+Операционист()+" /","VA=C;HA=L;FB;FS=8;END;");
       m_rep.Put_Val("","START;", mode);
       m_rep.Put_Val("М.П,","P=C;FB;FS=8;");
       m_rep.Put_Val("","END;");
       m_rep.Blank_Line(mode);
       m_rep.Put_Val("Отчет получен","START;VA=C;HA=R;FS=8;", mode);
       m_rep.Put_Val("____________________","P=C;FB;FS=8;D=1");
       m_rep.Put_Val("/____________________/","VA=C;HA=L;FB;FS=8;D=1;END;");
       m_rep.Put_Val("Клиент","START;VA=C;HA=R;FS=8;END;", mode);
       m_rep.Blank_Line(mode);
       m_rep.Put_Val("\"____\"______________20___г.","START;VA=C;HA=L;FS=8;END;", mode);
       m_rep.Blank_Line(mode);
     end;

   END;
/*~ak*/

  PRIVATE MACRO PrintReport(ContrID:integer, num:integer, notServOp : bool) /*CHVA 510695*/
    var partcnt = 0;

    PrintHeader(ContrID, num, notServOp); /*CHVA 510695*/
    
    partcnt = partcnt + PrintByMode(ContrID, BROKERREP_PART_DEALINPERIOD);
    //UseProgress(1);
    
    partcnt = partcnt + PrintByMode(ContrID, BROKERREP_PART_NOTEXECDEAL);
    //UseProgress(2);

    partcnt = partcnt + PrintByMode(ContrID, BROKERREP_PART_EXECDEAL);
    //UseProgress(3); 
    partcnt = partcnt + PrintByMode(ContrID, BROKERREP_PART_CANCELEDDEAL); /*CHVA 503652 добавил печать раздела отмененных сделок*/
    //UseProgress(4); 

    //PrintByMode(ContrID, BROKERREP_PART_REPODEAL);
    //UseProgress(4); 

    if(partcnt == 0)
       PrintByMode(ContrID, 0);
    end;
    
    PrintCoupAndCompPayms(ContrID);
    //UseProgress(5);   

    PrintAccMoneyMoving(ContrID);
    //UseProgress(6);

    PrintInAccData(ContrID);
    //UseProgress(7);

    PrintPoolData(ContrID);
    //UseProgress(8);

/*ak - Раздел Сумма активов не выводим
    PrintActiveSumData(ContrID);
    UseProgress(9);
~ak*/

/*ak - Пользовательская подпись
    m_rep.AddStandardFooter();*/
    AddStandardFooter(null, num, notServOp,ContrID);/*CHVA 510695*/ //Для BIQ-8720 добавлено ContrID
/*~ak*/

    //RemProgress();

  END;
  private macro PrintEmptyReport(CreateOnTerm : bool, CreateDate : date, CreateTime : time)
    var brokFileManager =  BrokerRepFileStatusManager(m_CurrentRepName+".xml", CreateOnTerm);

    m_rep.Init("utf8", m_RepParams.IsApp, 42, true);

    m_rep.Set_Column_Width(/* 1*/  65,
                           /* 2*/  49,
                           /* 3*/  59,
                           /* 4*/  50,
                           /* 5*/  53,
                           /* 6*/  56,
                           /* 7*/  101,
                           /* 8*/  58,
                           /* 9*/  52,
                           /*10*/  52,
                           /*11*/  52,
                           /*12*/  40,
                           /*13*/  51,
                           /*14*/  51,
                           /*15*/  58,
                           /*16*/  66,
                           /*17*/  66,
                           /*18*/  93,
                           /*19*/  65,
                           /*20*/  56,
                           /*21*/  50,
                           /*22*/  163,
                           /*23*/  59,
                           /*24*/  52,
                           /*25*/  60,
                           /*26*/  77,
                           /*27*/  77,
                           /*28*/  65);

    m_rep.Set_Landscape();
    m_rep.Set_Indent(0);

    m_rep.Print_Header(m_CurrentRepName, "Calibri", 9);

    m_ClientData = СBrokerRep_ClientData(m_RepParams.ClientID, m_RepParams.CntrID, m_RepParams.EndDate);
    PrintReport(m_RepParams.CntrID, 1);

    m_rep.Print_Bottom();
    m_rep.Move(brokFileManager.Get_GENERATED_REPORTS_path());

    var resultFileName : string;
    var err;

    if(m_RepParams.ExcelFormat == true)
      resultFileName = m_CurrentRepName + ".xls";

      err = SC_ConvertToFormat(brokFileManager.Get_CURRENT_path(), brokFileManager.Get_CURRENT_path_no_file_name()+resultFileName, SC_SRVREPFORMAT_EXCEL_XLSX, m_RepParams.InCnv);

      if(not err)
        m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepData(resultFileName, SC_SRVREPFORMAT_EXCEL_XLSX, CreateDate, CreateTime);

        brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);

        if((not err) and (m_RepParams.ShowFile == true))
          brokFileManager.ShowFile();
        end;
      end;
    end;

    if(m_RepParams.PdfFormat == true)
      var brokFileManager2 = BrokerRepFileStatusManager(m_CurrentRepName + ".pdf", CreateOnTerm);

      err = SC_ConvertToFormat(brokFileManager.Get_CURRENT_path(), brokFileManager2.Get_CURRENT_filename_with_ext(), SC_SRVREPFORMAT_PDF, m_RepParams.InCnv);

      if(not err)
        m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepData(brokFileManager2.Get_CURRENT_filename_with_ext(), SC_SRVREPFORMAT_PDF, CreateDate, CreateTime);

        brokFileManager2.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);

        if((not err) and (m_RepParams.ShowFile == true))
          brokFileManager2.ShowFile();
        end;
      end;
    end;

    m_rep.Delete();
  end;

/*ak - ФИССиКО*/
  var tot_inrest, tot_outrest, tot_bonusopc, tot_combr, tot_comts, tot_comclir, tot_margin, tot_clplus, tot_clminus, tot_guar;


  //Поиск сумм списания/зачисления по расчетным операциям ВУ
  PRIVATE MACRO GetClientInAccSum(AccNumber:string, Currency:numeric, isIN:bool)
    var query, cmd, DataSet;
    var Sum = $0;
    //Golovkin 19.08.2019 IM2971095 счет по дебету в РОВУ - списание, по кредиту - зачисление
    query = " SELECT NVL (SUM (dl_acc.t_sum), 0) AS InOutSum              " +
            "   FROM ddl_acc_dbt dl_acc,                                  " +
            "        doproper_dbt oproper,                                " +
            "        doprdocs_dbt oprdocs,                                " +
            "        dacctrn_dbt acctrn                                   " +
            "  WHERE     dl_acc.t_fikind = :fikind                        " +
            "        AND dl_acc.t_fiid = :currency                        " +
            "        AND dl_acc.t_operkind = :operkind                    " +
            "        AND dl_acc.t_opertype = 1                            " +
            "        AND dl_acc.t_client = :clientid                      " +
            "        AND dl_acc.t_dockind = :calcoper                     " +
            "        AND dl_acc.t_valuedate >= :begdate                   " +
            "        AND dl_acc.t_valuedate <= :enddate                   " +
            "        AND dl_acc.t_dockind = oproper.t_dockind             " +
            "        AND LPAD (DL_ACC.T_ID, 10, 0) = oproper.t_documentid " +
            "        AND oprdocs.t_id_operation = oproper.t_id_operation  " +
            "        AND OPRDOCS.T_ACCTRNID = acctrn.t_acctrnid           ";
    if(isIN)
        query = query + " AND ACCTRN.T_ACCOUNT_RECEIVER = :accNumber ";
    else
        query = query + " AND ACCTRN.T_ACCOUNT_PAYER = :accNumber ";
    end;

    cmd = DL_RSDCommand(query);
    cmd.AddParam(FIKIND_CURRENCY);
    cmd.AddParam(Currency);
    cmd.AddParam(BROKERREP_DL_SETTLOPER);
    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(DL_CALCOPER);
    cmd.AddParam(m_RepParams.BegDate);
    cmd.AddParam(m_RepParams.EndDate);
    cmd.AddParam(AccNumber); // 

    DataSet = cmd.Execute();

    if(DataSet.moveNext())
      Sum = DataSet.InOutSum;
    end;

    return Sum;
  end;

  PRIVATE MACRO PrintHeaderFM(ContrID, row_height, count : integer, notServOp:bool)/*CHVA 510695*/
     m_rep.Set_WrapText(0);

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     if ((count >1) and (notServOp))/*CHVA 510695*/
     m_rep.Put_Str("Логотип", "FC=W;CN=LOGO2;");
     else
      m_rep.Put_Str("Логотип", "FC=W;CN=LOGO;");
     end;
     m_rep.Put_Str("email:"+m_ClientData.ClientEmail, "FC=W;END;");

     m_rep.Blank_Line(row_height);
     m_rep.Put_Val("ОТЧЕТ", "START;FB;FS=11;HA=C;END;", row_height);
     m_rep.Blank_Line(row_height);
     m_rep.Put_Val("по срочным сделкам и операциям, с ними связанным", "START;FB;FS=9;HA=C;END;", row_height);
     m_rep.Put_Val("За период с "+GetDateS2(m_RepParams.BegDate)+" по "+GetDateS2(m_RepParams.EndDate), "START;FB;FS=9;HA=C;END;", row_height);
     m_rep.Put_Val("Дата формирования отчета " + GetDateS2(GetCDS()), "START;FB;FS=9;HA=C;END;", row_height);
     m_rep.Put_Val("Клиент", "START;FS=8;HA=L;", row_height); 
     m_rep.Put_Val(m_ClientData.ShortName(), "FU;FS=8;HA=L;END;");
     m_rep.Put_Val("Код клиента", "START;FS=8;HA=L;", row_height);
     m_rep.Put_Val(m_ClientData.ClientCode, "FU;FS=8;HA=L;END;");
     m_rep.Put_Val("Договор об оказании брокерских услуг:", "START;FS=8;HA=L;", row_height);
     m_rep.Put_Val(m_ClientData.ContrNumber + " от " + GetDateS2(m_ClientData.ContrDate), "FU;FS=8;HA=L;END;");
     if(not m_ClientData.IsIndividual)
       m_rep.Put_Val("Номер брокерского счета:", "START;FS=8;HA=L;", row_height);
     end;
     var a = m_ClientData.GetFirstAcc();
     var ai = 0;
     var as = "";
     if(a != NULL)
       if(a.code_currency == NATCUR)
         as = a.account;
         tot_inrest = a.restIn;//RestA(a.rec.account, m_RepParams.BegDate-1);
         tot_outrest = a.restOut;//RestA(a.rec.account, m_RepParams.EndDate);
         tot_clplus = tot_clplus + GetClientInAccSum(a.account, a.code_currency, true); // Golovkin 19.08.2019 IM2971095
        tot_clminus = tot_clminus + GetClientInAccSum(a.account, a.code_currency, false); // CHVA  503909
       end;
       while((a = m_ClientData.GetNextAcc()) != NULL)
         if(a.code_currency == NATCUR)
           if(as == "")
             as = a.account;
             tot_inrest = a.restIn;
             tot_outrest = a.restOut;//RestA(a.rec.account, m_RepParams.EndDate);
             tot_clplus = tot_clplus + GetClientInAccSum(a.account, a.code_currency, true); // Golovkin 19.08.2019 IM2971095
             tot_clminus = tot_clminus + GetClientInAccSum(a.account, a.code_currency, false); // CHVA  503909
           else
             as = as + ", " + a.account;
             tot_inrest = tot_inrest + a.restIn;
             tot_outrest = tot_outrest + a.restOut;//RestA(a.rec.account, m_RepParams.EndDate);
             tot_clplus = tot_clplus + GetClientInAccSum(a.account, a.code_currency, true); // Golovkin 19.08.2019 IM2971095
             tot_clminus = tot_clminus + GetClientInAccSum(a.account, a.code_currency, false); // CHVA  503909
           end;
         end;
       end;
     end;
     if(not m_ClientData.IsIndividual)
       m_rep.Put_Val(as, "FU;FS=8;HA=L;END;", row_height);
     end;
     m_rep.Blank_Line(row_height);
  END;

  PRIVATE MACRO PrintFM(ContrID, row_height, count: integer, notServOp:bool)
    var TableHeadLineStyle = "FB;FS=9;HA=L;";
    var TableHeadStyle = "BOR;FB;FS=8;P=C;IC="+m_CellColor+";";
    var TableHeadStyle2 = "BOR;FB;FS=8;VA=C;HA=L;IC="+m_CellColor+";";
    var TableLineStyle = "BOR;FS=7;VA=C;IC="+m_CellColor+";";
    var query, cmd, rs;

/*
    /*Получить вариационную маржу*/
    macro GetMargin(DealID)
      var tquery, tcmd, trs;
      tquery = "select dvdlturn.t_margin t_margin "
             + "from ddvdlturn_dbt dvdlturn "
             + "join (select max(dvdlturn.t_id) t_id "
             + "      from ddvdlturn_dbt dvdlturn "
             + "      where dvdlturn.t_dealid = ? and "
             + "            dvdlturn.t_date <= ?) t on t.t_id = dvdlturn.t_id";
      tcmd = DL_RSDCommand(tquery);
      tcmd.AddParam(DealID);
      tcmd.AddParam(m_RepParams.EndDate);
      trs = tcmd.Execute();
      if(trs.movenext())
        return trs.margin;
      else
        return $0;
      end;
    end;
*/
/*CHVA*/                
  /*Получить вариационную маржу*/
    macro GetMargin(ClientID)
      var tquery, tcmd, trs;
          
      tquery = " select nvl (sum (turn.t_marginday + turn.t_margindeals), 0) as t_margin"
             + " from ddvfiturn_dbt turn , dfininstr_dbt fin   "
             + "     where turn.t_client =? and "
             + "    fin.t_fiid = turn.t_fiid and "
             + "    turn.t_date between ? and ?  ";
             
      tcmd = DL_RSDCommand(tquery);
      tcmd.AddParam(ClientID);
      tcmd.AddParam(m_RepParams.BegDate);
      tcmd.AddParam(m_RepParams.EndDate);
    
      trs = tcmd.Execute();
      if(trs.movenext())
        return trs.margin;
      else
        return $0;
      end;
    end;
/*CHVA*/

    MACRO GetValue_tMarginCall(t_MarginCall:STRING)
      var s:string = "";
      if(t_MarginCall == SET_CHAR)
        s = "Принудительное закрытие позиций";
      end;
      return s;
    END;

    /*I. ИНФОРМАЦИЯ О СДЕЛКАХ*/
    macro PrintFM_I()
      m_rep.Put_Val("I. ИНФОРМАЦИЯ О СДЕЛКАХ.", "START;" + TableHeadLineStyle + "END", row_height);
      m_rep.Put_Val("", "START;R=13;" + TableHeadLineStyle + "END", row_height);
      m_rep.Put_Val("№ сделки", TableHeadStyle+"START;", 63);
      m_rep.Put_Val("Дата и время заключения сделки", TableHeadStyle);
      m_rep.Put_Val("Вид контракта", TableHeadStyle);
      m_rep.Put_Val("Контракт", TableHeadStyle);
      m_rep.Put_Val("Вид сделки", TableHeadStyle);
      m_rep.Put_Val("Место заключения сделки", TableHeadStyle);
      m_rep.Put_Val("Дата расчетов по сделке", TableHeadStyle);
      m_rep.Put_Val("Цена заявки", TableHeadStyle);

      m_rep.Put_Val("Цена одного фьючерсного контракта (размер премии по опциону)", TableHeadStyle);
      m_rep.Put_Val("Цена исполнения по опциону", TableHeadStyle);
      m_rep.Put_Val("Кол-во", TableHeadStyle);
      m_rep.Put_Val("Сумма сделки, руб", TableHeadStyle);
      m_rep.Put_Val("Вариационная маржа, руб.", TableHeadStyle);
      m_rep.Put_Val("Комиссия ТС, руб", TableHeadStyle);
      m_rep.Put_Val("Комиссия брокера, руб", TableHeadStyle);
      m_rep.Put_Val("Примечание", TableHeadStyle);
      m_rep.Put_Val("","END;");
      m_rep.Put_Val("1", TableHeadStyle + "START;", row_height);
      m_rep.Put_Val("2", TableHeadStyle);
      m_rep.Put_Val("3", TableHeadStyle);
      m_rep.Put_Val("4", TableHeadStyle);
      m_rep.Put_Val("5", TableHeadStyle);
      m_rep.Put_Val("6", TableHeadStyle);
      m_rep.Put_Val("7", TableHeadStyle);
      m_rep.Put_Val("8", TableHeadStyle);
      m_rep.Put_Val("9", TableHeadStyle);
      m_rep.Put_Val("10", TableHeadStyle);
      m_rep.Put_Val("11", TableHeadStyle);
      m_rep.Put_Val("12", TableHeadStyle);
      m_rep.Put_Val("13", TableHeadStyle);
      m_rep.Put_Val("14", TableHeadStyle);
      m_rep.Put_Val("15", TableHeadStyle);
      m_rep.Put_Val("16", TableHeadStyle);
      m_rep.Put_Val("","END;");

      query = "select t_dealid, "
            + "       t_code, "
            + "       to_char(t_date,'dd.mm.yyyy')||' '||to_char(t_time, 'hh24:mi:ss') t_date, "
            + "       t_contrname,  t_contr, t_name, t_market, t_paydate, "
            + "       t_cost, t_costopt, t_bonusopt, t_amount, t_positioncost, "
            + "       t_margin, t_commark, t_comclir, t_combr, "
            + "       t_bonussign, t_reqprice, t_MarginCall "
            + "from dbrkrepdeal_u_fm1_tmp t "  
            + "where ((t_dealisfinish = 1) or (t_date between ? AND ?)) "
            + "  and t_contrid = ? "
            + "order by t.t_code, t.t_date, t_time";
      cmd = DL_RSDCommand(query);
      cmd.AddParam(m_RepParams.BegDate);
      cmd.AddParam(m_RepParams.EndDate);
      cmd.AddParam(ContrID);
      rs = cmd.Execute();
      while(rs.movenext())
        //tot_bonusopc = tot_bonusopc + rs.bonussign * rs.bonusopt * rs.amount;
        //m_rep.Put_Val(rs.code, TableLineStyle + "GA=L;" + "START;");			/* № сделки */
        m_rep.Put_Val(rs.code, TableLineStyle + "GA=L;" + "START;", IIF(GetValue_tMarginCall(rs.t_MarginCall) != "", 27)); /* № сделки */
        m_rep.Put_Val(rs.date, TableLineStyle + "GA=L;");				/* Дата и время заключения сделки */
        m_rep.Put_Val(rs.contrname, TableLineStyle + "GA=L;");				/* Вид контракта */
        m_rep.Put_Val(rs.contr, TableLineStyle + "GA=L;");				/* Контракт */
        m_rep.Put_Val(rs.name, TableLineStyle + "GA=L;");				/* Вид сделки */
        m_rep.Put_Val(rs.market, TableLineStyle + "GA=L;");				/* Место заключения сделки */
        m_rep.Put_Val(rs.paydate, TableLineStyle + "GA=L;T=D1;");	  		/* Дата расчетов по сделке */			

        If(rs.t_MarginCall == SET_CHAR)						      	/* Цена заявки */	
           m_rep.Put_Val("", TableLineStyle + "GA=L;");
        elIf(rs.reqprice == 0.0)		
           m_rep.Put_Val("рыночная", TableLineStyle + "GA=L;");
        else
           m_rep.Put_Val(rs.reqprice, TableLineStyle + "GA=R;T=M2;");
        end;

        m_rep.Put_Val(rs.cost, TableLineStyle + "GA=R;T=M2;");                   	/* Цена одного фьючерсного контракта (размер премии по опциону) */
        if(rs.costopt != 0)                    						/* Цена исполнения по опциону */
          m_rep.Put_Val(rs.costopt, TableLineStyle + "GA=R;T=M2;");
        else
          m_rep.Put_Val("", TableLineStyle + "GA=R;");
        end;
        m_rep.Put_Val(rs.amount, TableLineStyle + "GA=R;T=M0;");			/* Кол-во */
        m_rep.Put_Val(rs.positioncost, TableLineStyle + "GA=R;T=M2;");			/* Сумма сделки, руб */
        m_rep.Put_Val(rs.margin, TableLineStyle + "GA=R;T=M2;");			/* Вариационная маржа, руб. */
        m_rep.Put_Val(rs.commark + rs.comclir, TableLineStyle + "GA=R;T=M2;");		/* Комиссия ТС, руб */
        m_rep.Put_Val(rs.combr, TableLineStyle + "GA=R;T=M2;");				/* Комиссия брокера, руб */
        m_rep.Put_Val(GetValue_tMarginCall(rs.t_MarginCall), TableLineStyle + "GA=L;");	        /* Примечание */
        m_rep.Put_Val("","END;");
        //tot_comts = tot_comts + rs.commark;
        //tot_comclir = tot_comclir + rs.comclir;
        tot_comts = tot_comts + rs.commark + rs.comclir;
        tot_combr = tot_combr + rs.combr;
       
      end;
      m_rep.Blank_Line(row_height);
    end;

    /*II. ИНФОРМАЦИЯ ОБ ИНЫХ ОПЕРАЦИЯХ*/
    macro PrintFM_II()
      m_rep.Put_Val("II. ИНФОРМАЦИЯ ОБ ИНЫХ ОПЕРАЦИЯХ.", "START;" + TableHeadLineStyle + "END", row_height);
      m_rep.Blank_Line(row_height);
      m_rep.Put_Val("Исполнение контрактов:", "START;" + TableHeadLineStyle + "END", row_height);
      m_rep.Put_Val("№ сделки", TableHeadStyle+"START;", 31.5);
      m_rep.Put_Val("Дата исполнения", TableHeadStyle);
      m_rep.Put_Val("Вид контракта", TableHeadStyle);
      m_rep.Put_Val("Контракт", TableHeadStyle);
      m_rep.Put_Val("Вид операции", TableHeadStyle);
      m_rep.Put_Val("Цена.", TableHeadStyle);
      m_rep.Put_Val("Кол-во", TableHeadStyle);
      m_rep.Put_Val("Сумма, руб", TableHeadStyle);
      m_rep.Put_Val("Комиссия ТС, руб", TableHeadStyle);
      m_rep.Put_Val("Клиринговая комиссия, руб", TableHeadStyle);
      m_rep.Put_Val("Комиссия брокера, руб.", TableHeadStyle);
      m_rep.Put_Val("","END;");
      m_rep.Put_Val("1", TableHeadStyle + "START;", row_height);
      m_rep.Put_Val("2", TableHeadStyle);
      m_rep.Put_Val("3", TableHeadStyle);
      m_rep.Put_Val("4", TableHeadStyle);
      m_rep.Put_Val("5", TableHeadStyle);
      m_rep.Put_Val("6", TableHeadStyle);
      m_rep.Put_Val("7", TableHeadStyle);
      m_rep.Put_Val("8", TableHeadStyle);
      m_rep.Put_Val("9", TableHeadStyle);
      m_rep.Put_Val("10", TableHeadStyle);
      m_rep.Put_Val("11", TableHeadStyle);
      m_rep.Put_Val("","END;");
      query = "select t_dealid, "
            + "       t_code, "
            + "       to_char(t_date,'dd.mm.yyyy') t_date, "
            + "       t_contrname, "
            + "       t_contr, "
            + "       t_name, "
            + "       t_market, "
            + "       t_paydate, "
            + "       t_cost, "
            + "       t_amount, "
            + "       t_positioncost, "
            + "       t_commark, "
            + "       t_comclir, "
            + "       t_combr "
            + "from dbrkrepdeal_u_fm2_1_tmp t "
            + "where ((t_dealisfinish = 1) or (t_date between ? AND ?)) "
            + "  and t_contrid = ? "
            + "order by t_code, t.t_date, t_time";
      cmd = DL_RSDCommand(query);
      cmd.AddParam(m_RepParams.BegDate);
      cmd.AddParam(m_RepParams.EndDate);
      cmd.AddParam(ContrID);
      rs = cmd.Execute();
      while(rs.movenext())
        m_rep.Put_Val(rs.code, TableLineStyle + "GA=L;" + "START;");
        m_rep.Put_Val(rs.date, TableLineStyle + "GA=L;");
        m_rep.Put_Val(rs.contrname, TableLineStyle + "GA=L;");
        m_rep.Put_Val(rs.contr, TableLineStyle + "GA=L;");
        m_rep.Put_Val(rs.name, TableLineStyle + "GA=L;");
        m_rep.Put_Val(rs.cost, TableLineStyle + "GA=R;T=M2;");
        m_rep.Put_Val(rs.amount, TableLineStyle + "GA=R;T=M2;");
        m_rep.Put_Val(rs.positioncost, TableLineStyle + "GA=R;T=M2;");
        m_rep.Put_Val(rs.commark, TableLineStyle + "GA=R;T=M2;");
        m_rep.Put_Val(rs.comclir, TableLineStyle + "GA=R;T=M2;");
        m_rep.Put_Val(rs.combr, TableLineStyle + "GA=R;T=M2;");
        m_rep.Put_Val("","END;");
        tot_comts = tot_comts + rs.commark;
        tot_comclir = tot_comclir + rs.comclir;
        tot_combr = tot_combr + rs.combr;
      end;
      m_rep.Blank_Line(row_height);
      m_rep.Put_Val("Прочие операции:", "START;" + TableHeadLineStyle + "END", row_height);
      m_rep.Put_Val("№ операции", TableHeadStyle+"R=1;"+"START;");
      m_rep.Put_Val("Дата", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Вид операции", TableHeadStyle+"R=4;");
      m_rep.Put_Val("Списано, руб.", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Зачислено, руб.", TableHeadStyle+"R=1;");
      m_rep.Put_Val("","END;");
      m_rep.Put_Val("1", TableHeadStyle+"R=1;" + "START;", row_height);
      m_rep.Put_Val("2", TableHeadStyle+"R=1;");
      m_rep.Put_Val("3", TableHeadStyle+"R=4;");
      m_rep.Put_Val("4", TableHeadStyle+"R=1;");
      m_rep.Put_Val("5", TableHeadStyle+"R=1;");
      m_rep.Put_Val("","END;");

      query = "select t_code, t_operdate, t_opername, t_sum_payer, t_sum_receiver "
            + "from dbrkrepdeal_u_fm2_2_tmp t "
            + "where t_dealisfinish = 1 and "
            + "      t_contrid = ? "
            + "order by t_operdate, t_code";
      cmd = DL_RSDCommand(query);
      cmd.AddParam(ContrID);
      rs = cmd.Execute();
      // KS 01.07.2019 Радионова - Требуется из раздела "Прочие операции:" исключить информация по зачислению (списанию) дс клиента с брокерского счета 
      ///*
      while(rs.movenext())
        //m_rep.Put_Val(rs.code, TableLineStyle + "GA=L;R=1;" + "START;");
        //m_rep.Put_Val(rs.operdate, TableLineStyle + "GA=L;T=D1;R=1;");
        //m_rep.Put_Val(rs.opername, TableLineStyle + "GA=L;R=4;");
        //m_rep.Put_Val(rs.sum_payer, TableLineStyle + "GA=R;T=M2;R=1;");
        tot_clminus = tot_clminus + rs.sum_payer;
        //m_rep.Put_Val(rs.sum_receiver, TableLineStyle + "GA=R;T=M2;R=1;");
        tot_clplus = tot_clplus + rs.sum_receiver;
        //m_rep.Put_Val("","END;");
      end;
      //*/
      // KS 22.05.2019 3) В разделе "Прочие операции" создавать строчку на разницу между значением примечания "сегодня" и "в предыдущий рабочий день".
      //                  Если значение "сегодня" больше, чем "в предыдущий рабочий день", то разница попадает в "списано, руб.", в противном случае - в "зачислено, руб.".
      //                  Никаких бухгалтерских проводок при этом создавать не нужно.
      var dt = m_RepParams.BegDate, sum_payer, sum_receiver;
      var dts = "";
      while (dt <= m_RepParams.EndDate)
        sum_payer = ГОпоКлиенту(m_RepParams.ClientID, dt)-ГОпоКлиенту(m_RepParams.ClientID, dt-1);
        if (sum_payer > 0)
          sum_receiver = 0;
        else
          sum_receiver = -sum_payer;
          sum_payer = 0;
        end;
        if ((sum_payer != 0) or (sum_receiver != 0))
          dts = GetDateS(dt);
          m_rep.Put_Val(substr(dts,9,2)+substr(dts,4,2)+substr(dts,1,2)+"-"+m_ClientData.ClientCode+"-1", TableLineStyle + "GA=L;R=1;" + "START;");
//          m_rep.Put_Val(dt, TableLineStyle + "GA=L;T=D1;R=1;");
          m_rep.Put_Val(dts, TableLineStyle + "GA=L;R=1;");
          m_rep.Put_Val("Заблокированнo / Разблокированно средств под ГО", TableLineStyle + "GA=L;R=4;");
          m_rep.Put_Val(sum_payer, TableLineStyle + "GA=R;T=M2;R=1;");
          //tot_clminus = tot_clminus + sum_payer;
          m_rep.Put_Val(sum_receiver, TableLineStyle + "GA=R;T=M2;R=1;");
          //tot_clplus = tot_clplus + sum_receiver;
          m_rep.Put_Val("","END;");
        end;
        dt = dt + 1;
      end;
      m_rep.Blank_Line(row_height);
    end;

    /*III. ДВИЖЕНИЕ СТАНДАРТНЫХ КОНТРАКТОВ*/
    macro PrintFM_III()
    var cmd2,query2,rs2;/*CHVA 513925*/
      m_rep.Put_Val("III. ДВИЖЕНИЕ СТАНДАРТНЫХ КОНТРАКТОВ.", "START;" + TableHeadLineStyle + "END", row_height);
      m_rep.Put_Val("", "START;" + TableHeadLineStyle + "END", row_height);
      m_rep.Put_Val("Вид контракта", TableHeadStyle+"R=1;"+"START;", 60);
      m_rep.Put_Val("Контракт", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Входящий остаток(шт.)", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Зачислено(шт.)", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Списано(шт.)", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Исходящий остаток (шт.)", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Расчетная цена предыдущего дня, руб.", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Расчетная цена текущего дня, руб.", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Вариационная маржа, начисленная на ранее открытую позицию", TableHeadStyle+"R=1;");
      m_rep.Put_Val("Изменение гарантийного обеспечения", TableHeadStyle+"R=1;");
      m_rep.Put_Val("","END;");
      m_rep.Put_Val("1", TableHeadStyle + "R=1;" + "START;", row_height);
      m_rep.Put_Val("2", TableHeadStyle + "R=1;");
      m_rep.Put_Val("3", TableHeadStyle + "R=1;");
      m_rep.Put_Val("4", TableHeadStyle + "R=1;");
      m_rep.Put_Val("5", TableHeadStyle + "R=1;");
      m_rep.Put_Val("6", TableHeadStyle + "R=1;");
      m_rep.Put_Val("7", TableHeadStyle + "R=1;");
      m_rep.Put_Val("8", TableHeadStyle + "R=1;");
      m_rep.Put_Val("9", TableHeadStyle + "R=1;");
      m_rep.Put_Val("10", TableHeadStyle + "R=1;");
      m_rep.Put_Val("","END;");
      query = "select t_fi_name, "
            + "       t_fi_code, "
            + "       t_inRest, "
            + "       t_turnPlus, "
            + "       t_turnMinus, "
            + "       t_outRest, "
            + "       t_inMargin, "
            + "       t_outMargin, "
            + "       t_inGuaranty, "
            + "       t_outGuaranty, "
            + "       t_Pin, "
            + "       t_Pout "
            + "from dbrkrepdeal_u_fm3_tmp t "
            + "where t_dealisfinish = 1 and "
            + "      t_contrid = ? "
            //+ IIF(m_RepParams.IsNotZeroRest, " and (t_inRest !=0 or t_OutRest !=0 or t_turnPlus !=0 or t_turnMinus !=0) ", "")
            + "  and (t_inRest !=0 or t_OutRest !=0 or t_turnPlus !=0 or t_turnMinus !=0) "
            + "order by t_fi_name, t_fi_code";
      cmd = DL_RSDCommand(query);
      cmd.AddParam(ContrID);
      rs = cmd.Execute();
      while(rs.movenext())
      /*CHVA 513925 для того , чтобы  в разделе отобразилось списание контрактов (экспирация без исполнения')*/
            query2 = "select  t_contr, "
            + "       t_name, "
            + "       t_paydate, "
            + "       t_amount "
            + "from dbrkrepdeal_u_fm2_1_tmp "
            + "where t_dealisfinish = 1 and "
            + "      t_contrid = ? "
            +" and t_contr = ?   "
            +" and ( t_name like 'Экспирация без исполнения%'  OR t_name like 'Исполнение фьючерсов' )" /*CHVA 519602*/
            + "order by t_code, t_date, t_time";
              cmd2 = DL_RSDCommand(query2);
              cmd2.AddParam(ContrID);
              cmd2.AddParam(rs.fi_code);
             rs2 = cmd2.Execute();
             if(rs2.movenext())
                rs.turnMinus =  rs.turnMinus + rs2.amount - rs.inRest;/*CHVA 519602, 522201*/
                rs.outRest = 0;//rs.turnPlus - rs.turnMinus ;
             end;
      /*CHVA */
        m_rep.Put_Val(rs.fi_name, TableLineStyle + "GA=L;R=1;" + "START;");
        m_rep.Put_Val(rs.fi_code, TableLineStyle + "GA=L;R=1;");
        m_rep.Put_Val(rs.inRest, TableLineStyle + "GA=R;T=M0;R=1;");
        m_rep.Put_Val(rs.turnPlus, TableLineStyle + "GA=R;T=M0;R=1;");
        m_rep.Put_Val(rs.turnMinus, TableLineStyle + "GA=R;T=M0;R=1;");
        m_rep.Put_Val(rs.outRest, TableLineStyle + "GA=R;T=M0;R=1;");
        m_rep.Put_Val(rs.Pin, TableLineStyle + "GA=R;T=M2;R=1;");
        m_rep.Put_Val(rs.Pout, TableLineStyle + "GA=R;T=M2;R=1;");
        m_rep.Put_Val(rs.inMargin, TableLineStyle + "GA=R;T=M2;R=1;");
//        m_rep.Put_Val(rs.outmargin, TableLineStyle + "GA=R;T=M2;R=1;");
        m_rep.Put_Val((rs.outGuaranty - rs.inGuaranty), TableLineStyle + "GA=R;T=M2;R=1;");
        m_rep.Put_Val("","END;");
        //tot_guar = tot_guar + rs.outGuaranty - rs.inGuaranty; // KS 21.05.2019 Гарантийное обеспечение берём из примечания.
        //tot_margin = tot_margin + rs.outmargin - rs.inMargin; // KS 22.05.2019 Маржу вычисляем как разницу.
      end;
      // KS 21.05.2019 Гарантийное обеспечение берём из примечания. Оставлю здесь, чтобы недалеко искать
      tot_guar = tot_guar + ГОпоКлиенту(m_RepParams.ClientID, m_RepParams.EndDate);
      // KS 22.05.2019 Маржу вычисляем как разницу.
    //  tot_margin = tot_outrest-tot_inrest-tot_bonusopc+tot_combr+tot_comts+tot_comclir+tot_clminus-tot_clplus;             /*CHVA 502883 вариационную маржу берем из dvfiturn_dbt*/
     tot_margin = GetMargin(m_RepParams.ClientID);
     m_rep.Blank_Line(row_height);
    end;

    /*IV. ИНФОРМАЦИЯ О СОСТОЯНИИ БРОКЕРСКИХ СЧЕТОВ*/
    macro PrintFM_IV()
      m_rep.Put_Val("IV. ИНФОРМАЦИЯ О СОСТОЯНИИ БРОКЕРСКИХ СЧЕТОВ.", "START;" + TableHeadLineStyle + "END", 2 * row_height);
      m_rep.Put_Val("", TableHeadStyle+"R=4;"+"START;", row_height);
      m_rep.Put_Val("Сумма", TableHeadStyle2+"R=1;"+"END;");
      m_rep.Put_Val("Входящий остаток", TableHeadStyle2+"R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_inrest, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Вариационная маржа:", TableLineStyle+"HA=L;R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_margin, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Премия по опционам:", TableLineStyle+"HA=L;R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_bonusopc, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Комиссия брокера:", TableLineStyle+"HA=L;R=4;"+"START;", row_height);
      m_rep.Put_Val(-tot_combr, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Комиссия торговой системы:", TableLineStyle+"HA=L;R=4;"+"START;", row_height);
      m_rep.Put_Val(-tot_comts, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Клиринговая комиссия:", TableLineStyle+"HA=L;R=4;"+"START;", row_height);
      m_rep.Put_Val(-tot_comclir, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Списано по поручению клиента:", TableLineStyle+"HA=L;R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_clminus, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Зачислено по поручению клиента:", TableLineStyle+"HA=L;R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_clplus, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Исходящий остаток", TableHeadStyle2+"R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_outrest, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Плановый исходящий остаток", TableHeadStyle2+"R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_outrest, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("в т.ч.гарантийное обеспечение:", TableHeadStyle2+"R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_guar, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Put_Val("Свободные средства:", TableHeadStyle2+"R=4;"+"START;", row_height);
      m_rep.Put_Val(tot_outrest - tot_guar, TableLineStyle+"HA=R;R=1;T=M2;"+"END;");
      m_rep.Blank_Line(row_height);
    end;

    m_rep.Set_WrapText(1);


    PrintFM_I();
    PrintFM_II();
    PrintFM_III();
    PrintFM_IV();
    AddStandardFooter(row_height, count: integer, notServOp);/*CHVA 510695*/

  END; 

  PRIVATE MACRO PrintReportFM(ContrID:integer, num: integer, notServOp:bool)/*CHVA 510695*/

    tot_inrest = tot_outrest = tot_bonusopc = tot_combr = tot_comts = tot_comclir = tot_margin = tot_clplus = tot_clminus = tot_guar = $0;


    PrintHeaderFM(ContrID, 15, num, notServOp);/*CHVA 510695*/
    
    PrintFM(ContrID, 15 ,num, notServOp);/*CHVA 510695*/
    //UseProgress(1);
    
    //RemProgress();
  END;

/*~ak*/

  //Создание файла отчета следующим образом:
  //если отчет выпускается сам по себе, т.е. из пункта меню:
  // - в двухзвенке он формируется на СП,  
  // - в трехзвенке на терминале
  //если отчет выпускается в сервисной операции отправки:
  // - в двухзвенке он формируется на СП
  // - в трехзвенке при работе с конвейерами он формируется на СП
  // - в трехзвенке без конвейеров он формируется на терминале, но затем перемещается на СП
  MACRO CreateReport(errmes:@string)
    macro NewList(list:@tarray, str)
      var i = 0;
      var j = 1;
      var k = index(str, "/");
      while(k > 0)
        str = substr(str,1,k-1)+"-"+substr(str,k+1);
        k = index(str, "/");
      end;
      while(i < list.size)
        if(list[i] == str)
          j = j + 1;
        end;
        i = i + 1;
      end;
      list[list.size] = str;
      if(j == 1)
        return str;
      else
        return str + " (" + j + ")";
      end;
    end;

    macro uGetRepName(CntrID, RepCrDAte)
      var repnamefile = "";
      var repnamefile_tmp = "";
      var day, mon, year;

      DateSplit(RepCrDAte, day, mon, year);

      var cmd = RSDCommand(" Select sfc.t_number, sfc.t_servkind, sfc.t_servkindsub, cmp.t_marketid from dsfcontr_dbt sfc, ddlcontrmp_dbt cmp where sfc.t_id = ? and cmp.t_sfcontrid = sfc.t_id ");
          cmd.AddParam("id", rsdbp_in, CntrID);
      var rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
      if(rs.MoveNext())
        repnamefile_tmp = rs.value("t_number");
        if( (Index(StrUpr(repnamefile_tmp),"_Ф") == 0) AND (Index(StrUpr(repnamefile_tmp),"_В") == 0) AND (Index(StrUpr(repnamefile_tmp),"_С") == 0) AND (Index(StrUpr(repnamefile_tmp),"_C") == 0) AND (Index(StrUpr(repnamefile_tmp),"_V") == 0) AND (Index(StrUpr(repnamefile_tmp),"_S") == 0) )
          if (rs.value("t_servkind") == PTSK_CM)
            repnamefile_tmp = repnamefile_tmp + "_v";
          elif (rs.value("t_servkind") == PTSK_DV)
            repnamefile_tmp = repnamefile_tmp + "_c";
          elif (rs.value("t_servkind") == PTSK_STOCKDL)
            if(rs.value("t_servkindsub") == 9) //внебиржа
              repnamefile_tmp = repnamefile_tmp + "_в";
            else
              repnamefile_tmp = repnamefile_tmp + IIF(rs.value("t_marketid") == SPB_ID(), "_s", "_ф"); 
            end;
          end;
          repnamefile = repnamefile_tmp + "_"+string(year)+string(mon:2:o:f)+string(day:2:o:f);
        else 
          repnamefile = rs.value("t_number") + "_"+string(year)+string(mon:2:o:f)+string(day:2:o:f);
        end;
      end;
      repnamefile = StrSubst ( repnamefile, "/", "-" );
      repnamefile = StrSubst ( repnamefile, "\\", "-" );
      return repnamefile;
    end;                

    var err = 0;
    var query, cmd, DataSet;
    var cnt = 0;
    var resultFileName = "";
    var ShowFilePath = "";
    var ShowFilePathMail = "";
    var CreateOnTerm = ((m_RepParams.InCnv == false) and (not isStandAlone()));
    var i, filename;

/*ak*/
    var InOneList;
    if(m_RepParams.InServOp)
      InOneList = false;
    else
      InOneList = true;
    end;
/*~ak*/
    m_RepParams.RepData.size = 0;
    m_RepParams.NoData = m_RepParams.NoReq = false;

    var CreateDate = date();
    var CreateTime = time();
    var day, mon, year;
    var hour, min, sec;

    DateSplit(CreateDate, day, mon, year);
    TimeSplit(CreateTime, hour, min, sec);

    m_CurrentRepName = uGetRepName(m_RepParams.CntrID, m_RepParams.RepCrDate);

    if(m_CurrentRepName == "")
      m_CurrentRepName = ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR)
                         +"_"+string(year)+string(mon:f)+string(day:f)
                         +"_"+string(hour:f)+string(min:f)+string(sec:f);
    end;

    if((not m_RepParams.InCnv) and (not m_RepParams.InServOp))
      BegAction(1,"Формирование отчета брокера. Ждите...");
    end;
      
    if(not SP_BrokerRep_CreateData(m_RepParams).Create(@errmes))
      if((not m_RepParams.InCnv) and (not m_RepParams.InServOp))
        msgboxex(errmes);
      end;
      return false;
    end;
/*ak*/
    query = "select (select t_number from dsfcontr_dbt where t_id = t_contrid) t_number, t_contrid, t_contrtype, T_CONTRNUMBERFULL "
          + "from dbrkrep_contr_u_tmp "
          + "where t_clientid = ? "
          + "group by t_contrid, t_contrtype, t_contrnumber, T_CONTRNUMBERFULL "
          + "order by t_contrnumber";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_RepParams.ClientID);
    cnt = cmd.GetCount();
/*~ak*/

    if(cnt > 0)

     //Поиск сделок без связанных заявок 
     var query1, cmd1, DataSet1, cnt1; 
     query1 =   " select t_Sort, t_DealCode "
              + "   from (select DISTINCT 1 as t_Sort, t_A07 as t_DealCode "
              + "           from dbrkrepdeal_u_tmp "
              + "          where t_ClientID = ? "
              + "            and t_ContrID > 0 "
              + "            and t_IsItog = CHR(0) "
              + "            and t_A07 <> CHR(1) "
              + "            and t_A95 IS NULL "
              + "            and t_A95_M <> 'X' " 
              + "            and t_Part IN ("+BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_NOTEXECDEAL+","+BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL+") " 
              + "         union all "
              + "         select DISTINCT 2 as t_Sort, t_code as t_DealCode "
              + "           from dbrkrepdeal_u_fm1_tmp "
              + "          where t_ClientID = ? "
              + "            and t_dealisfinish = 1 "
              + "            and t_ContrID > 0 "
              + "            and t_code <> CHR(1) "
              + "            and t_reqprice IS NULL "
              + "            and t_MarginCall <> 'X' " 
              + "        ) "
              + "  order by t_Sort, t_DealCode ";
      cmd1 = DL_RSDCommand(query1);
      cmd1.AddParam(m_RepParams.ClientID);
      cmd1.AddParam(m_RepParams.ClientID);
      
      cnt1 = cmd1.GetCount(); 

      if(cnt1 > 0)
         m_RepParams.NoReq = true;
         DataSet1 = cmd1.Execute();

         var clientCode = ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR);
         var errMessage = "Ошибка! По клиенту \""+clientCode+"\" отсутствуют заявки-поручения по сделкам: ";
         var firstStr = true;
         var errDealList = "", errGetMailTempl = null;
         var errMailTempl;

         while(DataSet1.moveNext())
            errDealList = errDealList + IIF(firstStr, "", ", ") + "\"" + DataSet1.DealCode + "\"";
            firstStr = false;
         end;
         errmes = errMessage + errDealList; 

         errMailTempl = GetErrMailTempl(BROKERREP_ERRMAILTEMPL_NOREQ, @errGetMailTempl);
         if (ValType(errMailTempl) == V_GENOBJ)
            m_RepParams.ErrMails[m_RepParams.ErrMails.Size] = CBrokerRepErrMail(errMailTempl.Subject, 
                                                                                StrSubst(StrSubst(errMailTempl.Body, 
                                                                                                  "<код клиента>", clientCode ),
                                                                                                  "<Номера сделок>", errDealList));
         else
            msgbox("Ошибка при получении шаблона письма об ошибке с кодом \"" + BROKERREP_ERRMAILTEMPL_NOREQ + "\"");
            return;
         end;
      end;
      var brokFileManager = null;

      DataSet = cmd.Execute();

/*ak - считаем листы*/
      cnt = 0;
      var ListName;
      var ListArr = tarray;
/*~ak*/
      while(DataSet.moveNext())
        if((cnt == 0) or (not InOneList))
          m_rep.Init("utf8", m_RepParams.IsApp, null, true);
          m_rep.Set_Landscape();
          m_rep.Set_Indent(0);
        end;
        cnt = cnt + 1;
        m_ClientData = СBrokerRep_ClientData(m_RepParams.ClientID, DataSet.ContrID, m_RepParams.EndDate);
        if(DataSet.ContrType == 1)
          if(m_ClientData.Market)
            m_rep.Set_Column_Width(/* 1*/  59,
                                   /* 2*/  59,
                                   /* 3*/  59,
                                   /* 4*/  139, //CCBO-45782
                                   /* 5*/  119, //5485
                                   /* 6*/  56,
                                   /* 7*/  102,
                                   /* 8*/  64,
                                   /* 9*/  85,
                                   /*10*/  105,
                                   /*11*/  129,
                                   /*12*/  139, //CCBO-45782
                                   /*13*/  50,
                                   /*14*/  60,/*old:56*/
                                   /*15*/  64,
                                   /*16*/  64,
                                   /*17*/  64,
                                   /*18*/  56,
                                   /*19*/  60,
                                   /*20*/  139,  //CCBO-45782
                                   /*21*/  60,
                                   /*22*/  60,
                                   /*23*/  70,
                                   /*24*/  60,
                                   /*25*/  70,
                                   /*26*/  70,
                                   /*27*/  70,
                                   /*28*/  139); //CCBO-45782
          else
            m_rep.Set_Column_Width(/* 1*/  59,
                                           59,
                                   /* 2*/  59,
                                   /* 3*/  59,
                                   /* 4*/  52,
                                   /* 5*/  102,
                                   /* 6*/  56,
                                   /* 7*/  102,
                                   /* 8*/  64,
                                   /* 9*/  85,
                                   /*10*/  52, //BIQ-7324
                                   /*11*/  52, //BIQ-7324
                                   /*12*/  105,
                                   /*13*/  129,
                                   /*14*/  54,
                                   /*15*/  54,
                                   /*16*/  56,
                                   /*17*/  64,
                                   /*18*/  64,
                                   /*19*/  64,
                                   /*20*/  56,
                                   /*21*/  60,
                                   /*22*/  51,
                                   /*23*/  60,
                                   /*24*/  60,
                                   /*25*/  70,
                                   /*26*/  60,
                                   /*27*/  70,
                                   /*28*/  70,
                                   /*29*/  70);
          end;
        else
          m_rep.Set_Column_Width(/* 1*/  254, //271
                                 /* 2*/  171,
                                 /* 3*/  120,
                                 /* 4*/  100,
                                 /* 5*/  50,
                                 /* 6*/  50,
                                 /* 7*/  50,
                                 /* 8*/  50,
                                 /* 9*/  50,
                                 /*10*/  50,
                                 /*11*/  50,
                                 /*12*/  50,
                                 /*13*/  50,
                                 /*14*/  50);
        end;


        ListName = NewList(@ListArr, DataSet.t_NUMBER/*m_ClientData.ContrNumber*/);
        if ( ListName == "" ) //Если наименования ДО нет, то проверим принадлежность к андеррайтингу BIQ-5485
            if (SubTypeContr (DataSet.ContrID) == 10)  //рабочий вариант
              ListName = m_ClientData.ContrNumber;
            end;
        end;
        if(not InOneList)
          if(DataSet.ContrType == 1)
            m_rep.Print_Header(ListName, "Calibri", 9);
          else
            m_rep.Print_Header(ListName, "Arial Cyr", 7);
          end;
        else
          if(cnt == 1)
            if(DataSet.ContrType == 1)
              m_rep.Print_Header(ListName, "Calibri", 9);
            else
              m_rep.Print_Header(ListName, "Arial Cyr", 7);
            end;
          else
            if(DataSet.ContrType == 1)
              m_rep.Print_Header(ListName, "Calibri", 9, true);
            else
              m_rep.Print_Header(ListName, "Arial Cyr", 7, true);
            end;
          end;
        end;
        if(DataSet.ContrType == 1)
          PrintReport(DataSet.ContrID, cnt, InOneList);/*CHVA 510695*/
        else
          PrintReportFM(DataSet.ContrID, cnt, InOneList);/*CHVA 510695*/
        end;

        if(not InOneList)
          m_rep.Print_Bottom();

          resultFileName = GetFileName (m_CurrentRepName, "xlsx", m_RepParams.ServDocId);

          brokFileManager = BrokerRepFileStatusManager(resultFileName, CreateOnTerm);
          m_rep.Save(brokFileManager.Get_GENERATED_REPORTS_path());

          if(not err)
            /*Добавляем файл к сервисной операции*/
            m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepData(resultFileName, SC_SRVREPFORMAT_EXCEL_XLSX, CreateDate, CreateTime,DataSet.ContrID);

            brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);
          end;
          if(m_RepParams.PdfFormat == true)

            err = SC_ConvertToFormatOnePDF( resultFileName, brokFileManager.Get_CURRENT_path_no_file_name(), @resultFileName, m_RepParams.InCnv, m_RepParams.ServDocId, m_RepParams.SignerParty, m_RepParams.RepCrDate, m_CurrentRepName);

            brokFileManager = BrokerRepFileStatusManager(resultFileName, CreateOnTerm);

            if(not err)
              m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepData(resultFileName, SC_SRVREPFORMAT_PDF, CreateDate, CreateTime,DataSet.ContrID);

              //переместить файл на СП
              brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);
            end;

          end;
        end;

/*~ak*/
      
      end;
/*ak - закрываем дополнительные вкладки*/
      if(InOneList)
        m_rep.Print_Bottom();
        while(cnt > 1)
          m_rep.Print_Bottom(true);
          cnt = cnt - 1;
        end;
      end;

/*~ak*/

      /*Excel вручную*/
      if(m_RepParams.ExcelFormat == true)

        resultFileName = m_CurrentRepName + ".xls";

        brokFileManager = BrokerRepFileStatusManager(resultFileName, (m_RepParams.InServOp == false));

        m_rep.Save(brokFileManager.Get_GENERATED_REPORTS_path());

        if(not err)
          m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepData(resultFileName, SC_SRVREPFORMAT_EXCEL_XLSX, CreateDate, CreateTime);

          brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);

          if((not err) and (m_RepParams.ShowFile == true))
            brokFileManager.ShowFile();
          end;
        end;
      end;

      if((m_RepParams.PdfFormat == true) and InOneList)
        resultFileName = tarray();
        brokFileManager = BrokerRepFileStatusManager(m_CurrentRepName + ".pdf", (m_RepParams.InServOp == false));
        err = _POIAddPictureAndConvertToPDF( m_rep, brokFileManager.Get_CURRENT_path_no_file_name(), brokFileManager.Get_CURRENT_path_no_file_name(), @resultFileName, m_RepParams.InCnv, m_RepParams.ServDocId, m_RepParams.SignerParty, m_RepParams.RepCrDate, m_CurrentRepName );
        if (not err)
          brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);
        end;
      end;
      
      m_rep.Delete();

    elif (m_RepParams.ShowEmpty)
      m_RepParams.NoData = true;
      PrintEmptyReport(CreateOnTerm, CreateDate, CreateTime);
    else
      m_RepParams.NoData = true;
      msgbox("Нет данных для выпуска отчета");
    end;

    if((not m_RepParams.InCnv) and (not m_RepParams.InServOp))
      EndAction(1);
    end;

    return true;
  END;

END;

MACRO SC_CreateRepBroker(params, errmes:@string)
  var cmd, query, DataSet;
  var CntrID =params.CntrID;
  var cnt = 0, i = 0;
  var errcnt = 0; // счетчик ошибок
  var err = 0;
  cmd = DL_RSDCommand();

  //log
  var log = Logger();
  var dt = StrSubSt(string(Date()),".","");
  var tm = StrSubSt(string(time()),":","");
  var InfoLogFileName = GetTxtFileName( "!LOG_BRKREP"+dt+"_"+StrSubst(tm," ","0") + "_" + FileName);
  SetOutput( InfoLogFileName, true ); //Пишем лог в файл. Начало
  log.RepHeader();

  GetRegistryValue( "SECUR\\BROKER_REPORT\\COURSE_CURRENCY_COLUMN_VISIBLE", V_BOOL, params.CourseCurVisible, err );
  if(err != 0)
    params.CourseCurVisible = false;
  end;

  query =   " select sf.t_ID, sf.t_Number "
          + "   from dsfcontr_dbt sf "
          + "  where sf.t_ServKind in(1, 15) ";

  if(params.CntrID > 0)
    query = query + " and sf.t_ID = ? ";
    cmd.AddParam(params.CntrID);
  else
    query = query + " and sf.t_PartyID = ? " 
                  + "    and sf.t_DateBegin <= ? "
                  + "    and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ? ) ";

    cmd.AddParam(params.ClientID);
    cmd.AddParam(params.EndDate);
    cmd.AddParam(params.BegDate);
  end;

  cnt = cmd.GetCount(query);
  if(cnt > 0)
    InitProgress(cnt, "Договоры клиента", "Договоры клиента" );
    DataSet = cmd.Execute(query);
    
    while(DataSet.moveNext())
      var exec = RSDCommand("begin rshb_brkrep.ClearData; end;");
      exec.execute();

      params.CntrID = DataSet.ID;
      var report = СBrokerRep_PrintRep(params);

      errmes = "";
      report.CreateReport(@errmes);

      UseProgress(i = i + 1);

      log.RepStr(i, DataSet.Number, errmes); // протокол
      if(errmes != "")
         errcnt = errcnt + 1;
      end;

      if(params.ErrMails.Size > 0)
        var im = 0;

        while(im < params.ErrMails.Size)
          SC_SendBrkRepErrMail(params.ErrMails[im].Subject,
                               params.ErrMails[im].Body);
          im = im + 1;
        end;
        
        params.ErrMails.Size = 0;
      end;
    end;
    
    RemProgress();

    log.RepFooter(i - errcnt, errcnt, i); // протокол
    SetOutput( NULL, true ); //Пишем лог в файл. Конец
    ViewFile( InfoLogFileName );
  end;
  
  params.CntrID = CntrID;

  return 0;
END;
