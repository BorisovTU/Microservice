/*                           
$Name:        QUIK_ReconAndPrint.mac
$Module:      Ценные бумаги
$Description: Сверка и печать результата
*/
import BankInter, XmlRpcInter, "dllog_xml.mac", "DlReport_h.mac", "dldlngfun.mac";

private var MICEX_CODE_CURMARKET;
private var MICEX_CODE_STOCKMARKET;

private macro getQueryWhere(alias,secur_checked, cur_checked, first_cond)
   var query_where = "";
   if (ValType(first_cond) == V_UNDEF)
      first_cond = false;
   end;

   if (alias != "")
      alias = alias + ".";
   end;

   if (( secur_checked ) and (cur_checked))
      query_where = " ("+alias+"t_firm_id = '"+MICEX_CODE_CURMARKET+"' or "+alias+"t_firm_id = '"+MICEX_CODE_STOCKMARKET+"') ";
   elif( secur_checked )
      query_where = " "+alias+"t_firm_id = '"+MICEX_CODE_STOCKMARKET+"' ";
   elif(cur_checked)
      query_where = " "+alias+"t_firm_id = '"+MICEX_CODE_CURMARKET+"' ";
   else
      query_where = "  1 = 1  ";
   end;

   return iif(first_cond, " where ", " and ") +  query_where;
end;

CLASS (DL_CReportTemplate) QUIK_Recon( MarketID, MarketCode, CalcDate, secur_checked, cur_checked)
  PRIVATE VAR m_PrintMode = DL_OUTREPORT_EXCEL;
  PRIVATE VAR m_MarketID = MarketID;
  PRIVATE VAR m_MarketCode = MarketCode;
  PRIVATE VAR m_CalcDate = CalcDate;
  PRIVATE VAR m_secur_checked = secur_checked;
  PRIVATE VAR m_cur_checked = cur_checked;
  PRIVATE VAR m_count_diverg = 0;
  PRIVATE VAR SheetName;

  PRIVATE MACRO PrintMode():INTEGER
     return m_PrintMode;
  END;
  
  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO SwitchSheetName(v_SheetName:string)
    SheetName = v_SheetName;
    SetActiveSheet(v_SheetName);
  END;

  MACRO КоличествоРасхождений()
    return m_count_diverg;
  END;

  PRIVATE MACRO FillFirmID()
    var Stock = TBfile("dl_limitprm.dbt", "R", 1);
    var Curr  = TBfile("dl_limitprm.dbt", "R", 1);
    Stock.Clear();
    Curr.Clear();

    if(m_cur_checked)
      Curr.rec.MarketID = m_MarketID;
      Curr.rec.MarketKind = ALG_DL_LIMITPRM_MARKETKIND_CURRENCY;
      if(GetEQ(Curr))
        MICEX_CODE_CURMARKET = Curr.rec.FirmCode;
      else
        MICEX_CODE_CURMARKET = "";
      end;
    else
      MICEX_CODE_CURMARKET = "";
    end;

    if(m_secur_checked)
      Stock.rec.MarketID = m_MarketID;
      Stock.rec.MarketKind = ALG_DL_LIMITPRM_MARKETKIND_STOCK;
      if(GetEQ(Stock))
        MICEX_CODE_STOCKMARKET = Stock.rec.FirmCode;
      else
        MICEX_CODE_STOCKMARKET = "";
      end;
    else
      MICEX_CODE_STOCKMARKET = "";
    end;
  END;
  
  private macro SearchAndPrintN1( )
    var IsFirst = true;

    CopyAllSheetInTotalBook(SheetName, false, "N1_Header", 1, SheetName);
    CopyAllSheetInTotalBook(SheetName, false, "N1_TableHeader", 1, SheetName);

    RegisterTable( "N1_TableData", NULL,
                    "P1", 
                    "P2",
                    "P3",
                    "P4",
                    "P5",
                    "P6",
                    "P7",
                    "P8",
                    "P9",
                    "P10",
                    "P11",
                    "P12"
                  );
    var querydepo, querymoney, cmdmoney, cmddepo, rsmoney, rsdepo;

      querydepo ="SELECT lim.t_client_code,                              "+ //0
      "                 'T' || lim.t_limit_kind,                         "+ //1
      "                 qlim.t_limit_kind,                               "+ //2
      "                 lim.t_SECCODE,                                   "+ //3
      "                 lim.t_open_balance,                              "+ //4
      "                 qlim.t_open_balance,                             "+ //5
      "                 lim.t_trdaccid,                                  "+ //6
      "                 qlim.t_trdaccid,                                 "+ //7
      "                 lim.T_ISBLOCKED,                                 "+ //8
      "                 lim.t_limitkindrest                              "+ //9
      "            FROM    (SELECT t_firm_id,                            "+
      "                            t_SECCODE,                            "+
      "                            t_client_code,                        "+
      "                            t_limit_kind,                         "+
      "                              case when t_limit_kind = 0 then t_quantity " + 
      "                                else lag(t_open_balance,1,0) over (partition by t_seccode, t_client_code order by t_seccode, t_client_code, t_limit_kind)   end " +
      "                               as t_open_balance, "+      
      "                              case when t_limit_kind = 0 then 'остаток счета' " + 
      "                                else ' '   end "
      "                               as t_limitkindrest, "+      
      "                            t_TRDACCID,                           "+
      "                            t_isblocked                           "+
      "                       FROM DDL_LIMITSECURITES_DBT                "+
      "                      WHERE t_date = ? AND t_market = ? " + getQueryWhere("", m_secur_checked, m_cur_checked) + ") lim "+
      "                 LEFT JOIN                                        "+
      "                    DDL_LIMITSECURITESIN_DBT qlim                 "+
      "                 ON     lim.t_client_code = qlim.t_client_code    "+
      "                    AND lim.t_SECCODE = qlim.t_SECCODE            "+
      "                    AND lim.t_limit_kind = qlim.t_limit_kind      "+
      "                    AND lim.t_open_balance <> QLIM.t_open_balance  " + getQueryWhere("qlim", m_secur_checked, m_cur_checked) + 
      "           WHERE QLIM.t_open_balance IS NOT NULL                    "+
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind                                ";
                
      cmddepo = RSDCommand(querydepo);
      cmddepo.AddParam("", RSDBP_IN, m_CalcDate);
      cmddepo.AddParam("", RSDBP_IN, m_MarketCode);
      rsdepo = RsdRecordset(cmddepo);

      while (rsdepo.movenext)
        PrintTableLine( "P1", "DEPO", NULL,
                        "P2", rsdepo.value(0), NULL,
                        "P3", IIF((rsdepo.value(9) != " "), rsdepo.value(9), rsdepo.value(1)), NULL,
                        "P4", rsdepo.value(2), NULL,
                        "P5", rsdepo.value(3), NULL, 
                        "P6", rsdepo.value(4), NULL,
                        "P7", rsdepo.value(5), NULL,
                        "P8", rsdepo.value(6), NULL,
                        "P9", rsdepo.value(7), NULL,
                        "P10", rsdepo.value(4)-rsdepo.value(5), NULL,
                        "P11", IIF((rsdepo.value(1)=="T0"), rsdepo.value(4)-rsdepo.value(5), " "), NULL,
                        "P12", rsdepo.value(8), NULL
                    );
        IsFirst = false;
        m_count_diverg = m_count_diverg + 1;
      end;

      querymoney = 
        "SELECT             lim.t_client_code,                                                    "+ //0
        "                   'T' || lim.t_limit_kind,                                              "+ //1
        "                   qlim.t_limit_kind,                                                    "+ //2
        "                   lim.t_curr_code,                                                      "+ //3
        "                   nvl(lim.t_open_balance,0),                                            "+ //4
        "                   nvl(qlim.t_open_balance,0),                                           "+ //5
        "                   ' ',                                                                  "+ //6
        "                   ' ',                                                                  "+ //7
        "                   lim.t_isblocked,                                                      "+ //8
        "                   lim.t_limitkindrest                                                   "+ //9
        "              FROM    (SELECT cash.t_firm_id,                                            "+
        "                              cash.t_tag,                                                "+
        "                              cash.t_curr_code,                                          "+
        "                              cash.t_client_code,                                        "+
        "                              cash.t_limit_kind,                                         "+
        "                              case when t_limit_kind = 0 then cash.t_money306 " + 
        "                                else lag(cash.t_open_balance,1,0) over (partition by cash.t_curr_code, cash.t_client_code order by cash.t_curr_code, cash.t_client_code, cash.t_limit_kind)   end " +
        "                               as t_open_balance, "+ 
        "                              case when t_limit_kind = 0 then 'остаток счета'            "+ 
        "                                else ' '  end                                            "+
        "                               as t_limitkindrest,                                       "+  
        "                              cash.t_leverage,                                           "+
        "                              cash.T_ISBLOCKED,                                          "+
        "                              PRM.T_CORDIVERG                                            "+
        "                         FROM DDL_LIMITCASHSTOCK_dbt cash, ddl_limitprm_dbt prm          "+
        "                        WHERE cash.t_date = ?  AND cash.t_market = ? AND prm.t_marketid = ?        "+
        "                        AND PRM.T_MARKETKIND IN (CASE"+
        "                                                    WHEN " + IIF(m_secur_checked, "'X'", "''") + " = 'X' "+
        "                                                    THEN                                 "+
        "                                                       1                                 "+
        "                                                    ELSE                                 "+
        "                                                       0                                 "+
        "                                                 END,                                    "+
        "                                                 CASE                                    "+
        "                                                    WHEN " + IIF(m_cur_checked, "'X'", "''") + " = 'X'"+
        "                                                    THEN                                 "+
        "                                                       3                                 "+
        "                                                    ELSE                                 "+
        "                                                       0                                 "+
        "                                                 END)                                    "+
        "                        AND CASH.T_FIRM_ID = PRM.T_FIRMCODE                              "+
        "                        AND cash.t_tag = PRM.T_POSCODE ) lim                             "+
        "                   LEFT JOIN                                                             "+
        "                      DDL_LIMITCASHSTOCKIN_DBT qlim                                      "+
        "                   ON     lim.t_client_code = qlim.t_client_code                         "+
        "                      AND lim.t_curr_code = qlim.t_curr_code                             "+
        "                      AND lim.t_limit_kind = qlim.t_limit_kind                           "+
        "                      AND lim.t_firm_id = QLIM.T_FIRM_ID                                 "+
        "                      AND lim.t_tag = QLIM.T_TAG                                         "+
        "                      AND lim.t_open_balance <> (CASE WHEN lim.t_cordiverg > 0 THEN QLIM.t_open_balance_cor ELSE QLIM.t_open_balance END) "+
        "             WHERE QLIM.t_open_balance IS NOT NULL                                       "+
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind              ";
                  
      cmdmoney = RSDCommand(querymoney);
      cmdmoney.AddParam("", RSDBP_IN, m_CalcDate);
      cmdmoney.AddParam("", RSDBP_IN, m_MarketCode);
      cmdmoney.AddParam("", RSDBP_IN, m_MarketID);
      rsmoney = RsdRecordset(cmdmoney);

      while (rsmoney.movenext)
        PrintTableLine( "P1", "MONEY", NULL,
                        "P2", rsmoney.value(0), NULL,
                        "P3", IIF((rsmoney.value(9) != " "), rsmoney.value(9), rsmoney.value(1)), NULL,
                        "P4", rsmoney.value(2), NULL,
                        "P5", rsmoney.value(3), NULL,
                        "P6", rsmoney.value(4), NULL,
                        "P7", rsmoney.value(5), NULL,
                        "P8", rsmoney.value(6), NULL,
                        "P9", rsmoney.value(7), NULL,
                        "P10", rsmoney.value(4)-rsmoney.value(5), NULL,
                        "P11", IIF((rsmoney.value(1)=="T0"), rsmoney.value(4)-rsmoney.value(5), " "), NULL,
                        "P12", rsmoney.value(8), NULL
                    );
        IsFirst = false;
        m_count_diverg = m_count_diverg + 1;
      end;
    
    if ( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;
  end;

  private macro SearchAndPrintN2( )
    var IsFirst = true;

    CopyAllSheetInTotalBook(SheetName, false, "N2_Header", 1, SheetName);
    CopyAllSheetInTotalBook(SheetName, false, "N2_TableHeader", 1, SheetName);

    RegisterTable(  "N2_TableData", NULL,
                    "С1",
                    "С2",
                    "С3",
                    "С4",
                    "С5",
                    "С6",
                    "С7"
                  );
    var querydepo, querymoney, cmdmoney, cmddepo, rsmoney, rsdepo;

      querydepo = "SELECT lim.t_client_code,                                            "+ //0
      "                  'T' || lim.t_limit_kind,                                     "+ //1
      "                  lim.t_SECCODE,                                               "+ //2
      "                  lim.t_quantity,                                              "+ //3
      "                  lim.t_trdaccid,                                              "+ //4
      "                  lim.T_ISBLOCKED                                              "+ //5
      "             FROM DDL_LIMITSECURITES_DBT lim                                   "+
      "            LEFT JOIN DDL_LIMITSECURITESIN_DBT lt                              "+
      "                           ON     LIM.t_client_code = LT.t_client_code         "+
      "                                 AND LIM.t_SECCODE = LT.t_SECCODE              "+
      "                                 AND LIM.t_limit_kind = LT.t_limit_kind " + getQueryWhere("lt", m_secur_checked, m_cur_checked) + " " 
                                      + getQueryWhere("lim", m_secur_checked, m_cur_checked, true) + 
      "                  and lim.t_market = ? " +
      "                           AND lt.t_firm_id is null and lim.t_date = ?" +
      "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind   ";
      cmddepo = RSDCommand(querydepo);
      cmddepo.AddParam("", RSDBP_IN, m_MarketCode);
      cmddepo.AddParam("", RSDBP_IN, m_CalcDate);
      
      rsdepo = RsdRecordset(cmddepo);
      while (rsdepo.movenext)
        PrintTableLine( "С1", "DEPO", NULL,
                        "С2", rsdepo.value(0), NULL,
                        "С3", rsdepo.value(1), NULL,
                        "С4", rsdepo.value(2), NULL,
                        "С5", rsdepo.value(3), NULL,
                        "С6", rsdepo.value(4), NULL,
                        "С7", rsdepo.value(5), NULL
                    );
        IsFirst = false;
        m_count_diverg = m_count_diverg + 1;
      end;        

      querymoney = "SELECT  lim.t_client_code,                                          "+ //0
      "                   'T' || lim.t_limit_kind,                                    "+ //1
      "                   lim.t_curr_code,                                            "+ //2
      "                   lim.t_open_balance,                                         "+ //3
      "                   ' ',                                                        "+ //4
      "                   lim.T_ISBLOCKED                                             "+ //5
      "              FROM DDL_LIMITCASHSTOCK_dbt lim                                  "+
      "             LEFT JOIN DDL_LIMITCASHSTOCKIN_DBT lt                             "+
      "                            ON     LIM.t_client_code = LT.t_client_code        "+
      "                                  AND LIM.t_curr_code = LT.t_curr_code         "+
      "                                  AND LIM.t_limit_kind = LT.t_limit_kind " + getQueryWhere("lt", m_secur_checked, m_cur_checked) + " " 
                                        + getQueryWhere("lim", m_secur_checked, m_cur_checked, true) +  
      "                   AND lim.t_market = ? " +
      "                           AND lt.t_firm_id is null AND lim.t_date = ?" +
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind  ";
      cmdmoney = RSDCommand(querymoney);
      cmdmoney.AddParam("", RSDBP_IN, m_MarketCode);
      cmdmoney.AddParam("", RSDBP_IN, m_CalcDate);

      rsmoney = RsdRecordset(cmdmoney);
      while (rsmoney.movenext)
        PrintTableLine( "С1", "MONEY", NULL,
                        "С2", rsmoney.value(0), NULL,
                        "С3", rsmoney.value(1), NULL,
                        "С4", rsmoney.value(2), NULL,
                        "С5", rsmoney.value(3), NULL,
                        "С6", rsmoney.value(4), NULL,
                        "С7", rsmoney.value(5), NULL
                    );
        IsFirst = false;
        m_count_diverg = m_count_diverg + 1;
      end; 
    
    if ( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;
  end;

  private macro SearchAndPrintN3( )
    var IsFirst = true;

    CopyAllSheetInTotalBook(SheetName, false, "N3_Header", 1, SheetName);
    CopyAllSheetInTotalBook(SheetName, false, "N3_TableHeader", 1, SheetName);

    RegisterTable(  "N3_TableData", NULL,
                    "И1",
                    "И2",
                    "И3",
                    "И4",
                    "И5",
                    "И6"
                  );
    var querydepo, querymoney, cmdmoney, cmddepo, rsmoney, rsdepo;

         querydepo = "SELECT lim.t_client_code,                                      "+ //0
      "                  lim.t_limit_kind,                                           "+ //1
      "                  lim.t_SECCODE,                                              "+ //2
      "                  lim.t_open_balance,                                         "+ //3
      "                  lim.t_trdaccid                                              "+ //4
      "             FROM DDL_LIMITSECURITESIN_DBT lim                                  "+
      "            LEFT JOIN  DDL_LIMITSECURITES_dbt lt                    "+
      "                           ON     LIM.t_client_code = LT.t_client_code     "+
      "                                 AND LIM.t_SECCODE = LT.t_SECCODE             "+
      "                                 AND LIM.t_limit_kind = LT.t_limit_kind       "+
      "                                 AND lt.t_market = ? AND lt.t_date = ? " + getQueryWhere("lt", m_secur_checked, m_cur_checked) + " " + 
                                     getQueryWhere("lim", m_secur_checked, m_cur_checked, true) +  
      "                           AND lt.t_firm_id is null" +
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind                                ";
      cmddepo = RSDCommand(querydepo);
      cmddepo.AddParam("", RSDBP_IN, m_MarketCode);
      cmddepo.AddParam("", RSDBP_IN, m_CalcDate);
      
      rsdepo = RsdRecordset(cmddepo);
      while (rsdepo.movenext)
        PrintTableLine( "И1", "DEPO", NULL,
                        "И2", rsdepo.value(0), NULL,
                        "И3", rsdepo.value(1), NULL,
                        "И4", rsdepo.value(2), NULL,
                        "И5", rsdepo.value(3), NULL,
                        "И6", rsdepo.value(4), NULL
                    );
        IsFirst = false;
        m_count_diverg = m_count_diverg + 1;
      end;        

           querymoney = "SELECT lim.t_client_code,                                   "+ //0
      "                  'T' || lim.t_limit_kind,                                  "+ //1
      "                  lim.t_curr_code,                                          "+ //2
      "                  lim.t_open_balance,                                       "+ //3
      "                  ' '                                                       "+ //4
      "                        FROM DDL_LIMITCASHSTOCKIN_DBT lim                   "+
      "                        LEFT JOIN DDL_LIMITCASHSTOCK_dbt lt                 "+
      "                            ON     LIM.t_client_code = LT.t_client_code     "+
      "                                  AND LIM.t_curr_code = LT.t_curr_code      "+
      "                                  AND LIM.t_limit_kind = LT.t_limit_kind    "+
      "                            AND lt.t_market = ? AND lt.t_date = ? " + getQueryWhere("lt", m_secur_checked, m_cur_checked) + "  " 
                                  + getQueryWhere("lim", m_secur_checked, m_cur_checked, true) + 
      "                           AND lt.t_firm_id is null" +
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind ";
      cmdmoney = RSDCommand(querymoney);
      cmdmoney.AddParam("", RSDBP_IN, m_MarketCode);
      cmdmoney.AddParam("", RSDBP_IN, m_CalcDate);

      rsmoney = RsdRecordset(cmdmoney);
      while (rsmoney.movenext)
        PrintTableLine( "И1", "MONEY", NULL,
                        "И2", rsmoney.value(0), NULL,
                        "И3", rsmoney.value(1), NULL,
                        "И4", rsmoney.value(2), NULL,
                        "И5", rsmoney.value(3), NULL,
                        "И6", rsmoney.value(4), NULL
                    );
        IsFirst = false;
        m_count_diverg = m_count_diverg + 1;
      end; 
    
    if ( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;
  end;

  private macro SearchAndPrintN4( )
    var IsFirst = true;
    CopyAllSheetInTotalBook(SheetName, false, "N4_Header", 1, SheetName);
    CopyAllSheetInTotalBook(SheetName, false, "N4_TableHeader", 1, SheetName);

    RegisterTable(  "N4_TableData", NULL,
                    "Н1", 
                    "Н2",
                    "Н3",
                    "Н4",
                    "Н5",
                    "Н6",
                    "Н7",
                    "Н8",
                    "Н9",
                    "Н10"
                  );
    var querydepo, querymoney, cmdmoney, cmddepo, rsmoney, rsdepo;

      querydepo ="SELECT lim.t_client_code,                                "+ //0
      "                 'T' || lim.t_limit_kind lim,                         "+ //1
      "                 qlim.t_limit_kind,                               "+ //2
      "                 lim.t_SECCODE,                                   "+ //3
      "                 lim.t_open_balance,                              "+ //4
      "                 qlim.t_open_balance,                             "+ //5
      "                 lim.t_trdaccid,                                  "+ //6
      "                 qlim.t_trdaccid,                                 "+ //7
      "                 lim.T_ISBLOCKED,                                 "+ //8
      "                 lim.t_limitkindrest                              "+ //9
      "            FROM    (SELECT t_firm_id,                            "+
      "                            t_SECCODE,                            "+
      "                            t_client_code,                        "+
      "                            t_limit_kind,                         "+
      "                              case when t_limit_kind = 0 then t_quantity " + 
      "                                else lag(t_open_balance,1,0) over (partition by t_seccode, t_client_code order by t_seccode, t_client_code, t_limit_kind)   end " +
      "                               as t_open_balance, "+      
      "                              case when t_limit_kind = 0 then 'остаток счета' " + 
      "                                else ' '   end "
      "                               as t_limitkindrest, "+      
      "                            t_TRDACCID,                           "+
      "                            t_isblocked                           "+
      "                       FROM DDL_LIMITSECURITES_DBT                "+
      "                      WHERE t_date = ? AND t_market = ? " + getQueryWhere("", m_secur_checked, m_cur_checked) + ") lim "+
      "                 LEFT JOIN                                        "+
      "                    DDL_LIMITSECURITESIN_DBT qlim                 "+
      "                 ON     lim.t_client_code = qlim.t_client_code    "+
      "                    AND lim.t_SECCODE = qlim.t_SECCODE            "+
      "                    AND lim.t_limit_kind = qlim.t_limit_kind      "+
      "                    AND lim.t_open_balance = QLIM.t_open_balance  " + getQueryWhere("qlim", m_secur_checked, m_cur_checked) + 
      "           WHERE QLIM.t_open_balance IS NOT NULL                    "+
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind                                ";
                
      cmddepo = RSDCommand(querydepo);
      cmddepo.AddParam("", RSDBP_IN, m_CalcDate);
      cmddepo.AddParam("", RSDBP_IN, m_MarketCode);
      rsdepo = RsdRecordset(cmddepo);

      while (rsdepo.movenext)
        PrintTableLine( "Н1", "DEPO", NULL,
                        "Н2", rsdepo.value(0), NULL,
                        "Н3", IIF((rsdepo.value(9) != " "), rsdepo.value(9), rsdepo.value(1)), NULL,
                        "Н4", rsdepo.value(2), NULL,
                        "Н5", rsdepo.value(3), NULL,
                        "Н6", rsdepo.value(4), NULL,
                        "Н7", rsdepo.value(5), NULL,
                        "Н8", rsdepo.value(6), NULL,
                        "Н9", rsdepo.value(7), NULL,
                        "Н10", rsdepo.value(8), NULL
                    );
        IsFirst = false;
      end;

      querymoney = 
        "SELECT             lim.t_client_code,                                                    "+ //0
        "                   'T' || lim.t_limit_kind lim,                                              "+ //1
        "                   qlim.t_limit_kind,                                                    "+ //2
        "                   lim.t_curr_code,                                                      "+ //3
        "                   nvl(lim.t_open_balance,0),                                            "+ //4
        "                   nvl(qlim.t_open_balance,0),                                           "+ //5
        "                   ' ',                                                                  "+ //6
        "                   ' ',                                                                  "+ //7
        "                   lim.t_isblocked,                                                      "+ //8
        "                   lim.t_limitkindrest                                                   "+ //9
        "              FROM    (SELECT cash.t_firm_id,                                            "+
        "                              cash.t_tag,                                                "+
        "                              cash.t_curr_code,                                          "+
        "                              cash.t_client_code,                                        "+
        "                              cash.t_limit_kind,                                         "+
        "                              case when t_limit_kind = 0 then cash.t_money306 " + 
        "                                else lag(cash.t_open_balance,1,0) over (partition by cash.t_curr_code, cash.t_client_code order by cash.t_curr_code, cash.t_client_code, cash.t_limit_kind)   end " +
        "                               as t_open_balance, "+ 
        "                              case when t_limit_kind = 0 then 'остаток счета'            "+ 
        "                                else ' '  end                                            "+
        "                               as t_limitkindrest,                                       "+  
        "                              cash.t_leverage,                                           "+
        "                              cash.T_ISBLOCKED,                                          "+
        "                              PRM.T_CORDIVERG                                            "+
        "                         FROM DDL_LIMITCASHSTOCK_dbt cash, ddl_limitprm_dbt prm          "+
        "                        WHERE cash.t_date = ?  AND cash.t_market = ? AND prm.t_marketid = ? "+
        "                        AND PRM.T_MARKETKIND IN (CASE"+
        "                                                    WHEN " + IIF(m_secur_checked, "'X'", "''") + " = 'X' "+
        "                                                    THEN                                 "+
        "                                                       1                                 "+
        "                                                    ELSE                                 "+
        "                                                       0                                 "+
        "                                                 END,                                    "+
        "                                                 CASE                                    "+
        "                                                    WHEN " + IIF(m_secur_checked, "'X'", "''") + " = 'X'"+
        "                                                    THEN                                 "+
        "                                                       3                                 "+
        "                                                    ELSE                                 "+
        "                                                       0                                 "+
        "                                                 END)                                    "+
        "                        AND CASH.T_FIRM_ID = PRM.T_FIRMCODE                              "+
        "                        AND cash.t_tag = PRM.T_POSCODE ) lim                             "+
        "                   LEFT JOIN                                                             "+
        "                      DDL_LIMITCASHSTOCKIN_DBT qlim                                      "+
        "                   ON     lim.t_client_code = qlim.t_client_code                         "+
        "                      AND lim.t_curr_code = qlim.t_curr_code                             "+
        "                      AND lim.t_limit_kind = qlim.t_limit_kind                           "+
        "                      AND lim.t_firm_id = QLIM.T_FIRM_ID                                 "+
        "                      AND lim.t_tag = QLIM.T_TAG                                         "+
        "                      AND lim.t_open_balance = (CASE WHEN lim.t_cordiverg > 0 THEN QLIM.t_open_balance_cor ELSE QLIM.t_open_balance END) "+
        "             WHERE QLIM.t_open_balance IS NOT NULL                                   "+
        "             order by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind              ";
                  
      cmdmoney = RSDCommand(querymoney);
      cmdmoney.AddParam("", RSDBP_IN, m_CalcDate);
      cmdmoney.AddParam("", RSDBP_IN, m_MarketCode);
      cmdmoney.AddParam("", RSDBP_IN, m_MarketID);
      rsmoney = RsdRecordset(cmdmoney);

      while (rsmoney.movenext)
        PrintTableLine( "Н1", "MONEY", NULL,
                        "Н2", rsmoney.value(0), NULL,
                        "Н3", IIF((rsmoney.value(9) != " "), rsmoney.value(9), rsmoney.value(1)), NULL,
                        "Н4", rsmoney.value(2), NULL,
                        "Н5", rsmoney.value(3), NULL,
                        "Н6", rsmoney.value(4), NULL,
                        "Н7", rsmoney.value(5), NULL,
                        "Н8", rsmoney.value(6), NULL,
                        "Н9", rsmoney.value(7), NULL,
                        "Н10", rsmoney.value(8), NULL
                    );
        IsFirst = false;
      end;
    
    if ( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;
  end;

  private macro SearchAndPrintN5( )
    var IsFirst = true;
    CopyAllSheetInTotalBook(SheetName, false, "N5_Header", 0, SheetName);
    CopyAllSheetInTotalBook(SheetName, false, "N5_TableHeader", 1, SheetName);

    RegisterTable(  "N5_TableData", NULL,
                    "О1",
                    "О2",
                    "О3",
                    "О4",
                    "О5",
                    "О6",
                    "О7",
                    "О8"
                  );
    var querydepo, querymoney, cmdmoney, cmddepo, rsmoney, rsdepo;

      querydepo ="SELECT lim.t_client_code,                                "+ //0
      "                 'T' || lim.t_limit_kind,                         "+ //1
      "                 lim.t_SECCODE,                                   "+ //2
      "                 lim.t_open_balance,                              "+ //3
      "                 lim.t_trdaccid,                                  "+ //4
      "                 lim.t_quantity,                                  "+ //5
      "                 lim.T_ISBLOCKED                                  "+ //6
      "            FROM  DDL_LIMITSECURITES_DBT lim                       "+
      "             WHERE lim.t_date = ? AND lim.t_market = ? " + getQueryWhere("lim", m_secur_checked, m_cur_checked) + 
      "               AND lim.t_quantity < 0                             " +
      "             ORDER by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind ";
                
      cmddepo = RSDCommand(querydepo);
      cmddepo.AddParam("", RSDBP_IN, m_CalcDate);
      cmddepo.AddParam("", RSDBP_IN, m_MarketCode);
      rsdepo = RsdRecordset(cmddepo);

      while (rsdepo.movenext)
        PrintTableLine( "О1", "DEPO", NULL,
                        "О2", rsdepo.value(0), NULL,
                        "О3", rsdepo.value(1), NULL,
                        "О4", rsdepo.value(2), NULL,
                        "О5", rsdepo.value(3), NULL,
                        "О6", rsdepo.value(4), NULL,
                        "О7", rsdepo.value(5), NULL,
                        "О8", rsdepo.value(6), NULL
                    );
        IsFirst = false;
      end;

      querymoney = "SELECT lim.t_client_code,                            "+ //0
      "                 'T' || lim.t_limit_kind,                         "+ //1
      "                 lim.t_curr_code,                                 "+ //2
      "                 lim.t_open_balance,                              "+ //3
      "                 ' ',                                             "+ //4
      "                 lim.t_money306,                                  "+ //5
      "                 lim.T_ISBLOCKED                                  "+ //6
      "            FROM  DDL_LIMITCASHSTOCK_dbt lim                       "+
      "             WHERE lim.t_date = ? AND lim.t_market = ? " + getQueryWhere("lim", m_secur_checked, m_cur_checked) + 
      "               AND lim.t_money306 < 0                             " +
      "             ORDER by  lim.t_client_code, lim.t_curr_code, lim.t_limit_kind ";
                  
      cmdmoney = RSDCommand(querymoney);
      cmdmoney.AddParam("", RSDBP_IN, m_CalcDate);
      cmdmoney.AddParam("", RSDBP_IN, m_MarketCode);
      rsmoney = RsdRecordset(cmdmoney);

      while (rsmoney.movenext)
        PrintTableLine( "О1", "MONEY", NULL,
                        "О2", rsmoney.value(0), NULL,
                        "О3", rsmoney.value(1), NULL,
                        "О4", rsmoney.value(2), NULL,
                        "О5", rsmoney.value(3), NULL,
                        "О6", rsmoney.value(4), NULL,
                        "О7", rsmoney.value(5), NULL,
                        "О8", rsmoney.value(6), NULL
                    );
        IsFirst = false;
      end;
    
    if ( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;
  end;

  private macro SearchAndPrintN6( )
    var IsFirst = true;

    CopyAllSheetInTotalBook(SheetName, false, "N6_Header", 1, SheetName);
    CopyAllSheetInTotalBook(SheetName, false, "N6_TableHeader", 1, SheetName);

    RegisterTable( "N6_TableData", NULL,
                    "W1_", 
                    "W2_",
                    "W3_",
                    "W4_",
                    "W5_",
                    "W6_"
                  );
    var querydepo, cmddepo, rsdepo;

      querydepo ="SELECT lim.t_client_code,                              "+ //0
      "                 lim.t_SECCODE,                                   "+ //1
      "                 lim.t_trdaccid,                                  "+ //2
      "                 lim.t_wa_position_price,                         "+ //3
      "                 qlim.t_wa_position_price                         "+ //4
      "            FROM    (SELECT t_firm_id,                            "+
      "                            t_SECCODE,                            "+
      "                            t_limit_kind,                         "+
      "                            t_client_code,                        "+
      "                            t_wa_position_price,                  "+
      "                            t_TRDACCID                            "+
      "                       FROM DDL_LIMITSECURITES_DBT                "+
      "                      WHERE t_date = ? AND t_market = ? " + getQueryWhere("", m_secur_checked, m_cur_checked) + ") lim "+
      "                 LEFT JOIN                                        "+
      "                    DDL_LIMITSECURITESIN_DBT qlim                 "+
      "                 ON     lim.t_client_code = qlim.t_client_code    "+
      "                    AND lim.t_SECCODE = qlim.t_SECCODE            "+
      "                    AND lim.t_limit_kind = qlim.t_limit_kind      "+
      "                    AND lim.t_wa_position_price <> QLIM.t_wa_position_price  " + getQueryWhere("qlim", m_secur_checked, m_cur_checked) + 
      "           WHERE QLIM.t_wa_position_price IS NOT NULL                    "+
        "             order by  lim.t_client_code, lim.t_seccode, lim.t_limit_kind";
                
      cmddepo = RSDCommand(querydepo);
      cmddepo.AddParam("", RSDBP_IN, m_CalcDate);
      cmddepo.AddParam("", RSDBP_IN, m_MarketCode);
      rsdepo = RsdRecordset(cmddepo);

      while (rsdepo.movenext)
        PrintTableLine( "W1_", rsdepo.value(0), NULL,
                        "W2_", rsdepo.value(1), NULL,
                        "W3_", rsdepo.value(2), NULL,
                        "W4_", rsdepo.value(3), NULL, 
                        "W5_", rsdepo.value(4), NULL,
                        "W6_", (rsdepo.value(3) - rsdepo.value(4)), NULL
                    );
        IsFirst = false;
        m_count_diverg = m_count_diverg + 1;
      end;
    
    if ( not IsFirst )
       EndTable();
       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
    end;
  end;

  PRIVATE MACRO CorBeforeRecon()
  var stat = 0;
  var cmd;
  var ErrStr = "", errorCount = 0, i = 0;

  cmd = RsdCommand("{CALL RSI_SCLIMIT.RSI_CorBeforeRecon(?, ?, ?, chr(?), chr(?)) }");

  cmd.addParam("p_CalcDate",        RSDBP_IN, m_CalcDate );
  cmd.addParam("p_MarketID",        RSDBP_IN, m_MarketID );
  cmd.addParam("p_MarketCode",      RSDBP_IN, IIF(m_MarketCode == "", "", m_MarketCode) );
  cmd.addParam("p_CheckSecur",      RSDBP_IN, IIF(m_secur_checked, 88, 0) );
  cmd.addParam("p_CheckCurr",       RSDBP_IN, IIF(m_cur_checked, 88, 0) );

  RslDefCon.BeginTrans();

  InitProgress(-1, "Выполняется корректирка данных для сверки", "Корректировка данных для сверки");
  
  cmd.execute();
  
  RemProgress();

  RslDefCon.CommitTrans();

  return stat;

OnError(er)
  
  RemProgress();

  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();                    
  end;

  if (IsEqClass ("TrslError", er))
    ErrStr=er.Message;
    if(IsEqClass ("TDbError", er.err))
      ErrStr=ErrStr+":|"+er.err.Stat+"-"+er.err.Oper+"-"+er.err.Table+"-"+er.err.Message;
    elif (isEqClass("TRsdError", er.err))

      errorCount = er.err.environment.ErrorCount;
      while (i < errorCount)
          ErrStr=ErrStr+er.err.environment.Error(i).Descr;
          i = i + 1;
      end;
    end;
  end;

  if(ErrStr == "")
    ErrStr=er.module+ " "+er.line+" "+er.message;
  end;

  msgbox(ErrStr);

  return 1;
END;

  PRIVATE MACRO Create()
    FillFirmID();
    var market_str = "";
    if (m_secur_checked and m_cur_checked) 
      market_str = "фондовому и валютному рынкам";
    elif (m_secur_checked) 
      market_str = "фондовому рынку";
    elif (m_cur_checked) 
      market_str = "валютному рынку";
    end;

    if (not CorBeforeRecon())
      InitProgress(6,"","Сверка данных по " + market_str);
      SwitchSheetName("Расшифровка расхождений");
      SearchAndPrintN1();
      useprogress (1);
      SearchAndPrintN2();
      useprogress (2);
      SearchAndPrintN3();
      useprogress (2);
      SwitchSheetName("Данные без расхождений");
      SearchAndPrintN4();
      useprogress (4);
      SwitchSheetName("Отрицательный остаток в СОФР");
      SearchAndPrintN5();
      useprogress (5);
      SwitchSheetName("Расшифровка расхождений");
      SearchAndPrintN6();
      RemProgress;
    end;
  END;
    
  initDL_CReportTemplate( NULL, "Infosverka.xlsx", true, null, null, false);
END;
