/*******************************************************************************
 DESCRIPTION  :   Žâç¥â "¥£¨áâà ­¥ââ¨­£ " (“)
 PROGRAMMED BY:   ‹¥®­®¢ ˆ. ….
 CREATION DATE:   05.10.06
*******************************************************************************/
IMPORT "NtgReg_Form.mac";

PRIVATE CONST H011 = "PP",
              H01  = "01",
              H02  = "XXX",
              H03  = "01",
              ItogsLineName = "‚á¥£®:";

PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR ReportHeader =
"\n\n##############################  ###########################\n" +
"à¨«®¦¥­¨¥ ü ##.## \n" +
"€­ «¨â¨ç¥áª¨© à¥£¨áâà ­ «®£®¢®£® ãç¥â  ü 1-02-#####-###-##-000-##-210302-##-##-70102000000000000000\n" +
"                ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
"                ³                    1 ³ ¨¬¥­®¢ ­¨¥ ­ «®£®¢®© ¡ §ë                      ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                   02 ³‹¨áâ ¤¥ª« à æ¨¨                                  ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                ##### ³®¬¥à ¯à¨«®¦¥­¨ï á¨­â¥â¨ç¥áª®£® à¥£¨áâà          ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                  ### ³Š®¤ áâà®ª¨ ¢ á¨­â¥â¨ç¥áª®¬ à¥£¨áâà¥              ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                   ## ³®¬¥à  ­ «¨â¨ç¥áª®£® à¥£¨áâà                     ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                  000 ³Š®¤ ä¨«¨ «                                       ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                   ## ³                                                 ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³               210302 ³                                                 ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                   ## ³®¬¥à ¬¥áïæ  (¯®á«¥¤­¨© ¢ ®âç¥â­®¬ ¯¥à¨®¤¥)      ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³                   ## ³„¢¥ ¯®á«¥¤­¨¥ æ¨äàë £®¤                          ³\n" +
"                ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
"                ³ 70102000000000000000 ³®¬¥à «¨æ. áç¥â  ¯® ãç¥âã ¤®å®¤®¢/à áå®¤®¢ ¡ ­ª  ³\n" +
"                ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\n" +
"#######################################################################################################################################################\n" +
"§  ¯¥à¨®¤ á ########## ¯® ##########\n" +
"ƒàã¯¯  ­ «®£®¢®£® ãç¥â : #################################################################\n" +
"‚¨¤ æ/¡:                 #################################################################\n" +
"‚ë¯ãáª æ/¡:              #################################################################\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
PRIVATE VAR TableHeader =                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
"ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄ¿\n" +
"³   „ â    ³    ®¬¥à           ³   „ â    ³  ®¬¥à             ³      ‚ë¯ãáª æ¥­­®©      ³ Š®¤ –         ³Š®«-¢®     ³Š®¤   ³     –¥­  à¥ «¨§ æ¨¨     ³   ‘â®¨¬®áâì à¥ «¨§ æ¨¨            ³„ â         ³    ®¬¥à á¤¥«ª¨    ³‚ «îâ ³    –¥­  ¯à¨®¡à¥â¥­¨ï    ³       ‘â®¨¬®áâì ¯à¨®¡à¥â¥­¨ï      ³  Š„ ­          ³Š®¬¨áá¨ï,        ³Š®­âà £¥­â          ³”¨­ ­á®¢ë©       ³       ‚ â®¬ ç¨á«¥                 ³Šãàá        ³Šãàá        ³ƒŽ/ä¨«¨ « ³ƒŽ/ä¨«¨ « ³à¨§­ ª³à¨§­ ª³ «®-³\n" +
"³ ­¥ââ¨­£  ³  ¤®£®¢®à           ³§ ª«îç¥­¨ï³  á¤¥«ª¨            ³         ¡ã¬ £¨          ³                ³¯à®¤ ­­ëå  ³¢ «îâëÃÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´§ ª«îç¥­¨ï  ³       ¯®ªã¯ª¨      ³æ¥­ë  ÃÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ´                                   ³   ¤ âã          ³ã¯« ç¥­­ ï       ³                    ³à¥§ã«ìâ â -      ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´¯¥à¥áç¥â    ³¯¥à¥áç¥â    ³¯® á¤¥«ª¥ ³¯® á¤¥«ª¥ ³áà®ç­®-³áà®ç­®-³£®¢ ï³\n" +
"³  æ¥­­ëå  ³  ­¥ââ¨­£           ³  á¤¥«ª¨  ³  ¯à®¤ ¦¨           ³                         ³                ³¡ã¬ £,     ³æ¥­ë  ³ ¢ ¢ «îâ¥   ³   ¢ àã¡«ïå ³ ¢ ¢ «îâ¥        ³   ¢ àã¡«ïå      ³á¤¥«ª¨      ³                    ³¯à¨®¡-³  ¢ ¢ «îâ¥  ³  ¢ àã¡«ïå  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ­¥ââ¨­£         ³¯® á¤¥«ª ¬       ³                    ³¢á¥£®, àã¡.      ³    à¨¡ë«ì      ³     “¡ëâ®ª      ³æ¥­ë/áâ-â¨  ³æ¥­ë/áâ-â¨  ³à¥ «¨§ æ¨¨³¯à¨®¡à¥â¥-³áâ¨ ¯® ³áâ¨ ¯® ³£àã¯-³\n" +
"³   ¡ã¬ £  ³                    ³à¥ «¨§ æ¨¨³                    ³                         ³                ³èâ.        ³à¥ «¨-³   æ¥­ë     ³            ³   æ¥­ë          ³                 ³¯à¨®¡à¥â¥­¨ï³                    ³à¥â¥- ³    æ¥­ë    ³            ³   ¢ ¢ «îâ¥      ³ ¢ àã¡«ïå        ³                 ³ ­¥ââ¨­£         ³                    ³                 ³                 ³                 ³à¥ «¨§ æ¨¨  ³¯à¨®¡à¥â¥­¨ï³          ³­¨ï       ³á¤¥«ª ¬³á¤¥«ª ¬³¯    ³\n" +
"³          ³                    ³    –    ³                    ³                         ³                ³           ³§ æ¨¨ ³            ³            ³                 ³                 ³–          ³                    ³­¨ï   ³            ³            ³     æ¥­ë        ³                 ³                 ³                 ³                    ³                 ³                 ³                 ³¢ àã¡«¥¢ë©  ³¢ àã¡«¥¢ë©  ³          ³          ³¯à®¤ ¦¨³¯®ªã¯ª¨³     ³\n" +
"³          ³                    ³          ³                    ³                         ³                ³           ³      ³            ³            ³                 ³                 ³            ³                    ³      ³            ³            ³                 ³                 ³                 ³                 ³                    ³                 ³                 ³                 ³íª¢¨¢ «¥­â  ³íª¢¨¢ «¥­â  ³          ³          ³       ³       ³     ³\n" +
"³          ³                    ³          ³                    ³                         ³                ³           ³      ³            ³            ³                 ³                 ³            ³                    ³      ³            ³            ³                 ³                 ³                 ³                 ³                    ³                 ³                 ³                 ³            ³            ³          ³          ³       ³       ³     ³\n" +
"ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄ´\n" +
"³    1     ³      2             ³    3     ³     4              ³            5            ³    6           ³    7      ³   8  ³     9      ³      10    ³     11          ³        12       ³     13     ³           14       ³  15  ³    16      ³     17     ³         18      ³        19       ³        20       ³      21         ³       22           ³        23       ³        24       ³        25       ³      ’1    ³     ’2     ³    T3    ³    T4    ³   T5  ³   T6  ³ ’7  ³\n" +
"ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄ´";

/*Žâç¥â "¥£¨áâà ­¥ââ¨­£ "*/
PRIVATE CLASS (TX_RegistrReport) SP_NtgReg_Report
  PRIVATE VAR m_AvrGroup, m_LinkDate, m_LinkAmount/*,
              m_CacheFinInstr = TX_CacheFinInstr()*/;
  
  PRIVATE MACRO PrintMode():INTEGER
     return m_Form.GetFieldValue( PNFLD_NTGREG_PRINTMETHOD );
  END;

  PRIVATE MACRO BeginReport()
     VAR Month, Year, INN, KPP,
         AttrID = m_Form.GetFieldValue( PNFLD_NTGREG_AVRGROUP),
         GroupName = "";

     DateSplit( FormData.EndDate, null, Month, Year );

     Year = SubStr( string(Year), strlen(string(Year))-1 );
     SplitFullINN( ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ ({OurBank}, PTCK_INN), INN, KPP );

     if (AttrID > 0)
        GroupName = GetLLVALname (2903, AttrID);
     else
        GroupName = "‚á¥";
     end;
              
     SetActiveSheet( "0101" );
     PrintFormatString( ReportHeader,
                        "N1_H0_A:l" , ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ({OurBank}),  //  ­ª
                        "N1_H0_B:l" , INN + "/" + KPP,  // ˆ­­/Š
                        "N1_H0_1"   , H01,  // à¨«®¦¥­¨¥ ü
                        "N1_H0_3"   , H03,
                        "N1_H0_12"  , H011, // €­ «¨â¨ç¥áª¨© à¥£¨áâà ­ «®£®¢®£® ãç¥â  ü
                        "N1_H0_2"   , H02,
                        "N1_H0_3"   , H03,
                        "N1_H0_1"   , H01,
                        "N1_H0_4"   , string(Month),
                        "N1_H0_5"   , string(Year),
                        "N1_H0_12"  , H011, // ®¬¥à ¯à¨«®¦¥­¨ï á¨­â¥â¨ç¥áª®£® à¥£¨áâà 
                        "N1_H0_2"   , H02,  // Š®¤ áâà®ª¨ ¢ á¨­â¥â¨ç¥áª®¬ à¥£¨áâà¥
                        "N1_H0_3"   , H03,  // ®¬¥à  ­ «¨â¨ç¥áª®£® à¥£¨áâà 
                        "N1_H0_1"   , H01,
                        "N1_H0_4"   , string(Month:2:o),  // ®¬¥à ¬¥áïæ  (¯®á«¥¤­¨© ¢ ®âç¥â­®¬ ¯¥à¨®¤¥)
                        "N1_H0_5"   , string(Year:2:o),   // „¢¥ ¯®á«¥¤­¨¥ æ¨äàë £®¤ 
                        ""          , " áç¥â ä¨­ ­á®¢®£® à¥§ã«ìâ â  ¯® ®¯¥à æ¨ï¬ á æ¥­­ë¬¨ ¡ã¬ £ ¬¨, âà¥¡®¢ ­¨ï (®¡ï§ â¥«ìáâ¢ ) ¯® ª®â®àë¬ ¨á¯®«­¥­ë ¢§ ¨¬®§ çñâ®¬ (­¥ââ¨­£®¬) æ¥­­ëå ¡ã¬ £",  // ˆ¬ï ®âç¥â 
                        "N1_H0_6"   , FormData.BeginDate, // §  ¯¥à¨®¤ á
                        "N1_H0_7"   , FormData.EndDate,   // ¯®
                        "N1_H0_8"   , GroupName,  // ƒàã¯¯  ­ «®£®¢®£® ãç¥â 
                        "N1_H0_9"  , FormData.AvrKind,   // ‚¨¤ æ/¡
                        "N1_H0_10"  , FormData.AvrName    // ‚ë¯ãáª æ/¡
                      );

     RegisterTable( "N1_MainTable", TableHeader,
                    "N1_DN",      "N1_CodeN",  "N1_DZS",   "N1_CodeS",  "N1_SecName", "N1_SecCode",   
                    "N1_Qnty",    "N1_VprS",   "N1_PrSvp", "N1_PrSrub", "N1_SumSvp",  "N1_SumSrub",   
                    "N1_DZB",     "N1_CodeB",  "N1_VPrB",  "N1_PrBvp",  "N1_PrBrub",  "N1_SumBvp",    
                    "N1_SumBrub", "N1_NkdVN",  "N1_ComN",  "N1_Cont",   "N1_FR",      "N1_Doh",   
                    "N1_Rash",    "N1_CrSD",   "N1_CrBD",  "N1_FilS",   "N1_FilB",    "N1_FS",    
                    "N1_FB",      "N1_SecType"           
                  );

     SetCellAutoSumma( ItogsLineName, "N1_SumSrub", "N1_SumBrub", "N1_NkdVN", "N1_ComN", "N1_FR", "N1_Doh", "N1_Rash" );

     SetCurrentLineFont( 8, true, false );
     PrintTableLine( "N1_DN",  ItogsLineName, null );
     SetCurrentLineFont( 8, false, false );
     PrintTableLine( "N1_DN",  "¢ â®¬ ç¨á«¥:", null );
  END;

  PRIVATE MACRO EndReport()
     EndTable();
     this.¥ç â âìà®¬¥¦ãâ®ç­ë¥ˆâ®£¨();
     AddStandardFooter( "N1_" );
  END;

  MACRO ¥ç â âìà®¬¥¦ãâ®ç­ë¥ˆâ®£¨()
     
   SetSubtotal(29, 26 + MAXROWSHEET,
               "L23",  
               "S23",  
               "T23",    
               "U23",     
               "W23",       
               "X23",      
               "Y23"     
              );                                                                      
  END;


  PRIVATE MACRO SignFutures( Deal:TBFile, FIID:INTEGER, AvrDate:DATE ):STRING
     VAR RS, Query, IsFutures = false;

     Query =   RSDCommand("SELECT " +
                          " rsb_sctx.DealIsTerm(?, ?, ?) as IsTerm "
                          " FROM DUAL");
     
     Query.addParam( "", RSDBP_IN, Deal.rec.DealID );
     Query.addParam( "", RSDBP_IN, FIID );
     Query.addParam( "", RSDBP_IN, AvrDate );
     Query.execute();

     RS = TRsbDataSet( Query );

     if( RS.MoveNext() AND (RS.IsTerm != 0) )
       IsFutures = true;
     end;

     if( IsFutures )
        return "„ ";
     end;
     return "";
  END;

  MACRO PrSvp():DOUBLE // –¥­  à¥ «¨§ æ¨¨ - ¢ ¢ «îâ¥ æ¥­ë
     var PrSvp = this.PrSvp();
     if(FI_IsBond(m_RS.FIID))
       PrSvp = this.SumSvp()/this.Qnty();
     end;
     return PrSvp;
  END;

  MACRO CrSD():DOUBLE //  Šãàá ¯¥à¥áç¥â  æ¥­ë/áâ-â¨ à¥ «¨§ æ¨¨ ¢ àã¡«¥¢ë© íª¢¨¢ «¥­â 
    if(m_CrSD == NULL)
      if( m_RS.VprS == NATCUR)
        if(m_RS.FaceValueFI == NATCUR)
          m_CrSD = 1;
        else
          m_CrSD = GetRateOnDateCrossDbl( this.DN(), m_RS.FaceValueFI, NATCUR, true );
        end;
      else
        if(m_RS.FaceValueFI == NATCUR)
          m_CrSD = ®«ãç¨âìŠãàá®áâ ­®¢ª¨  « ­á( this.DealSale() );
        else
          m_CrSD = GetRateOnDateCrossDbl( this.DN(), m_RS.VprS, NATCUR, true );
        end;
      end;
    end;

    if((m_CrSD == NULL) or (m_CrSD == 0.0))
      m_CrSD = NULL;
      return 1.0;
    end;

    return m_CrSD;
  END;

  MACRO PrBvp():DOUBLE // –¥­  à¥ «¨§ æ¨¨ - ¢ ¢ «îâ¥ æ¥­ë
     var PrBvp = this.PrBvp();
     if(FI_IsBond(m_RS.FIID))
       PrBvp = this.SumBvp()/this.Qnty();
     end;
     return PrBvp;
  END;

  MACRO CrBD():DOUBLE //  Šãàá ¯¥à¥áç¥â  æ¥­ë/áâ-â¨ ¯à¨®¡à¥â¥­¨ï ¢ àã¡«¥¢ë© íª¢¨¢ «¥­â „«ï ¯®¤¢¨¤  0204; 0205;0206:Šãàá – ” ­  ¤ âã ¯à¨®¡à¥â¥­¨ï
    if(m_CrBD == NULL)
      if( m_RS.VprB == NATCUR)
        if(m_RS.FaceValueFI == NATCUR)
          m_CrBD = 1;
        else
          m_CrBD = GetRateOnDateCrossDbl( this.DN(), m_RS.FaceValueFI, NATCUR, true );
        end;
      else
        if(m_RS.FaceValueFI == NATCUR)
          m_CrBD = ®«ãç¨âìŠãàá®áâ ­®¢ª¨  « ­á( this.DealBuy() );
        else
          m_CrBD = GetRateOnDateCrossDbl( this.DN(), m_RS.VprB, NATCUR, true );
        end;
      end;
    end;
    
    if((m_CrBD == NULL) or (m_CrBD == 0.0))
      m_CrBD = NULL;
      return 1.0;
    end;

    return m_CrBD;
  END;

  PRIVATE MACRO Create()
     VAR DataQuery, AvrFIID, Num = 0, AvrKind, AddWhere = "", DealSumm;
     VAR PriceSaleRUR = 0, PriceSaleCUR= 0, CostSaleRUR= $0, CostSaleCUR= $0,
         PriceBuyRUR  = 0, PriceBuyCUR = 0, CostBuyRUR = $0, CostBuyCUR = $0,
         Commission= $0, AgentSaleCom = $0, AgentBuyCom = $0, BuyRate, SaleRate;

     VAR LotSale, LotBuy,
         DealSale    = TBFile( "dl_tick.dbt", "R", 0 ),
         DealBuy     = TBFile( "dl_tick.dbt", "R", 0 ),
         DealNetting = TBFile( "dl_nett.dbt", "R", 0 ),
         LegSale     = TBFile( "dl_leg.dbt", "R", 0),
         LegBuy      = TBFile( "dl_leg.dbt", "R", 0);

     m_CacheFinInstr.Clear();
     T_Dep.ClearArray();

     /*æ¥­­ë¥ ¡ã¬ £¨ ¢ á®¥¤¨­¥­­ëå á¤¥«ª å  ¤®«¦­ë ã¤®¢«¥â¢®àïâì ãá«®¢¨ï¬, § ¤ ­­ë¬ ¯ ­¥«¨ ¯®¤£®â®¢ª¨ ®âç¥â */
     AvrFIID = m_Form.GetFieldValue( PNFLD_NTGREG_AVRCODE);
     if( (AvrFIID != null) AND (AvrFIID > 0 ) ) /*§ ¤ ­  ¡ã¬ £ */
        AddWhere = AddWhere + " AND FinInstr.t_FIID = " + string(AvrFIID);
     else

        AvrKind  = m_Form.GetFieldValue( PNFLD_NTGREG_AVRKIND );
        if( (AvrKind != null) AND (AvrKind > 0 ) ) /*§ ¤ ­ ¢¨¤ ¡ã¬ £¨*/
           AddWhere = AddWhere + " AND RSB_FIInstr.FI_AvrKindsEQ(2, " + string(AvrKind) + ", FinInstr.t_AvoirKind) = 1 ";
        end;

        m_AvrGroup = m_Form.GetFieldValue( PNFLD_NTGREG_AVRGROUP );
        if( (m_AvrGroup != null) AND (m_AvrGroup > 0 ) ) /*§ ¤ ­  ª â¥£®à¨ï ¡ã¬ £¨*/
           AddWhere = AddWhere + " AND av.t_TaxGroup = " + string(m_AvrGroup);
        end;
     end;

     DataQuery = " SELECT TXLink.t_Date, TXLink.t_Amount, TXLink.t_SaleID, TXLink.t_BuyID," +
                 "        FinInstr.t_FIID, FinInstr.t_FaceValueFI, FinInstr.t_FI_Code AS AvrCode, FinInstr.t_Name AS AvrName, av.t_TaxGroup, "+
                 "        Nett.t_DealNumber as NettDealNumber, TXLotSale.t_DEALDATE AS DealSaleDate, TXLotSale.t_DEALCODETS AS DealSaleCodeTS, " +
                 "        TXLotSale.t_DealID AS DealSaleID, LegS.t_Price AS SalePrice, LegS.t_Principal AS SaleAmount, "
                 "        TXLotBuy.t_DealID  AS DealBuyID, TXLotBuy.t_DEALDATE AS DealBuyDate, TXLotBuy.t_DEALCODETS AS DealBuyCodeTS, LegS.t_Price AS BuyPrice, "
                 "        LegS.t_Principal AS BuyAmount, DealSale.t_Department AS DealSaleDepartment, DealBuy.t_Department AS DealBuyDepartment, "+
                 "        Rsb_SCTX.TXGetComissionsSum(DealSale.t_DealID, DealSale.t_BOfficeKind, TXLink.t_Date, "+NATCUR+") as CommSale, " +
                 "        Rsb_SCTX.TXGetComissionsSum(DealBuy.t_DealID,  DealBuy.t_BOfficeKind,  TXLink.t_Date, "+NATCUR+") as CommBuy, " +
                 "        DataBuy.DealBuyGroup AS DealBuyGroup, DataSale.DealSaleGroup AS DealSaleGroup, " +
                 "        LegS.t_Cost as SDealCost, LegS.t_CFI as VprS, LegS.t_NKD as NKDS," +
                 "        LegB.t_Cost as BDealCost, LegB.t_CFI as VprB, " +
                 "        (select t_ShortName from dparty_dbt where t_PartyID = nett.t_Contractor) as PartyShortNameNett " + 
                 "   FROM DSCTXLNK_DBT  TXLink,"+
                 "        DSCTXLOT_DBT  TXLotBuy," +
                 "        DSCTXLOT_DBT  TXLotSale," +
                 "        DDL_TICK_DBT  DealSale," +
                 "        DDL_TICK_DBT  DealBuy," +
                 "        ddl_leg_dbt   LegS, " + 
                 "        ddl_leg_dbt   LegB, " +
                 "        DDL_NETT_DBT  Nett, "
                 "        DFININSTR_DBT FinInstr, " + 
                 "        DAVOIRISS_DBT av, " + 
                 
                 "        ( Select SaleOper.t_Kind_Operation, SaleOper.t_DocKind, " +
                 "                 rsb_secur.get_OperationGroup(SaleOper.t_SysTypes) as DealSaleGroup, " +
                 "                 (CASE WHEN " +
                 "                            ((Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsAvrWrtIn(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                            ) " +
                 "                       THEN 2 " +
                 "                       ELSE 0 END " +
                 "                 ) as LegKindSale " +
                 "            From " +
                 "                 doprkoper_dbt SaleOper " + 
                 "        ) DataSale, " +

                 "        ( Select BuyOper.t_Kind_Operation, BuyOper.t_DocKind, " +
                 "                 rsb_secur.get_OperationGroup(BuyOper.t_SysTypes) as DealBuyGroup, " +
                 "                 (CASE WHEN " +
                 "                            ((Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(BuyOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsAvrWrtOut(rsb_secur.get_OperationGroup(BuyOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsRet_Issue(rsb_secur.get_OperationGroup(BuyOper.t_SysTypes))=1) " +
                 "                            ) " +
                 "                       THEN 2 " +
                 "                       ELSE 0 END " +
                 "                 ) as LegKindBuy " +
                 "            From " +
                 "                 doprkoper_dbt BuyOper " + 
                 "        ) DataBuy " +

                 "  WHERE TXLink.t_Type = " + TXLNK_NETTING + " AND " +
                 "        TXLink.t_Date BETWEEN " + GetSQLDate( FormData.BeginDate ) + " AND " + 
                                                    GetSQLDate( FormData.EndDate ) + " AND " +
                 "        TXLotBuy.t_ID = TXLink.t_BuyID AND " +
                 "        TXLotSale.t_ID = TXLink.t_SaleID AND " +
                 "        DealSale.t_DealID = TXLotSale.t_DealID AND "+
                 "        DealBuy.t_DealID = TXLotBuy.t_DealID AND "+
                 "        DataSale.t_Kind_Operation = DealSale.t_DealType AND " +
                 "        DataSale.t_DocKind        = DealSale.t_BOfficeKind AND " +
                 "        DataBuy.t_Kind_Operation  = DealBuy.t_DealType AND " +
                 "        DataBuy.t_DocKind         = DealBuy.t_BOfficeKind AND " +
                 "        LegS.t_DealID    = TXLotSale.t_DealID AND " +
                 "        LegS.t_LegKind   = DataSale.LegKindSale AND " +
                 "        LegS.t_LegID     = 0 AND " +
                 "        LegB.t_DealID    = TXLotBuy.t_DealID AND " +
                 "        LegB.t_LegKind   = DataBuy.LegKindBuy AND " +
                 "        LegB.t_LegID     = 0 AND " +
                 "        Nett.t_NettingID = TXLotBuy.t_NettingID AND " +
                 "        FinInstr.t_FIID = TXLotSale.t_FIID AND " +
                 "        FinInstr.t_FIID = av.t_FIID" +
                          AddWhere;

     InitProgress( SQL_GetNRecs( DataQuery ), HTML_StSheetName, HTML_StSheetName );

     m_RS = TRsbDataSet( DataQuery );
     while( m_RS.MoveNext() )

        ClearCacheOneRecord();

        PrintTableLine("N1_DN",          this.DN(),                    null, // „ â  ­¥ââ¨­£ 
                       "N1_CodeN",       this.CodeN(),                 null, // ü ­¥ââ¨­£ 
                       "N1_DZS",         this.DZS(),                   null, // „ â  § ª«îç¥­¨ï á¤¥«ª¨ à¥ «¨§ æ¨¨ –
                       "N1_CodeS",       this.CodeS(),                 null, // ü ¯à®¤ ¦¨
                       "N1_SecName",     this.SecName(),               null, // Šà âª®¥ ­ ¨¬¥­®¢ ­¨¥ æ¥­­®© ¡ã¬ £¨
                       "N1_SecCode",     this.SecCode(),               null, // Š®¤ æ¥­­®© ¡ã¬ £¨ ¨§ á¤¥«ª¨
                       "N1_Qnty",        this.Qnty(),                  null, // Š®«¨ç¥áâ¢® æ¥­­ëå ¡ã¬ £ ¨§ á¢ï§¨ "­¥ââ¨­£"
                       "N1_VprS",        this.VPrSNumber(),            null, // –¨äà®¢®© ª®¤ ¢ «îâë à áç¥â®¢ á¤¥«ª¨ ¯à®¤ ¦¨
                       "N1_PrSvp",       this.PrSvp(),                 null, // –¥­  à¥ «¨§ æ¨¨ - ¢ ¢ «îâ¥ æ¥­ë
                       "N1_PrSrub",      this.PrSrub(),                null,
                       "N1_SumSvp",      iif(this.VPrS() != NATCUR, this.SumSvp(), null),  null, //‘â®¨¬®áâì à¥ «¨§ æ¨¨ - ¢ ¢ «îâ¥ æ¥­ë
                       "N1_SumSrub",     this.SumSrub(),               null,
                       "N1_DZB",         this.DZB(),                   null,
                       "N1_CodeB",       this.CodeB(),                 null,
                       "N1_VPrB",        this.VPrBNumber(),            null,
                       "N1_PrBvp",       this.PrBvp(),                 null,
                       "N1_PrBrub",      this.PrBrub(),                null,
                       "N1_SumBvp",      iif(this.VPrB() != NATCUR, this.SumBvp(), null),  null,
                       "N1_SumBrub",     this.SumBrub(),               null,
                       "N1_NkdVN",       this.NkdVN(),                 null,
                       "N1_ComN",        this.ComN(),                  null,
                       "N1_Cont",        this.Cont(),                  null,
                       "N1_FR",          this.FR(),                    null,
                       "N1_Doh",         iif(this.FR() > 0.0, this.FR(), null), null,
                       "N1_Rash",        iif(this.FR() < 0.0, abs(this.FR()), null), null,
                       "N1_CrSD",        this.printCrSD(),             null,
                       "N1_CrBD",        this.printCrBD(),             null,
                       "N1_FilS",        this.FilS(),                  null,
                       "N1_FilB",        this.FilB(),                  null,
                       "N1_FS",          SignFutures( this.DealSale(), m_RS.FIID, this.DZS() ), null,
                       "N1_FB",          SignFutures( this.DealBuy(), m_RS.FIID, this.DZB() ), null,
                       "N1_SecType",     this.SecType(),               null
                      );
        
        UseProgress( Num = Num + 1 );
     end;
     
     RemProgress();
  END;
  
  initTX_RegistrReport( SP_NtgReg_Panel(), "Report_TxNetting.xls" );
END;

SP_NtgReg_Report().Run();
Exit(1);

