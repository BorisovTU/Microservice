/*
PkoWriteOffBuffer.mac

Класс для работы с таблицей-буфером сообщений pko_writeoff
*/

import PTInter, oralib;
import "cb_sql.mac";

Class Assigment()
    var assigmentID = 0;
    var operationDealID = 0;
    var pkoStatus = 0;
    var idContract = 0;
    var countPapers = 0;
    var securityID = 0;
    var securMarket = "";
    var assigmentGUID = "";
    var step2Reject = 0;
    var isLimCorrected = "";
    var operType:integer;
End;

Class PKOWriteOff(_dealID)

    private var assigm = Assigment();
    private var dealID = _dealID;
  
    private macro Init()
        var sql = "select id, dealid, idcontract, pkostatus, qnty, securityid, market, guid, step2_reject, islimitcorrected, "
              + "         opertype "
              + "  from pko_writeoff "
              + " where dealid = :1 ";
        var cmd = RSDCommand(sql);
        cmd.AddParam(":1",RSDBP_IN,dealID);
        var result = RSDRecordSet(cmd);

        if (result.moveNext)
            assigm.assigmentID = result.value("id");
            assigm.operationDealID = SQL_ConvTypeInteger(result.value("dealid"));
            assigm.idContract = result.value("idcontract");
            assigm.pkoStatus = result.value("pkostatus");
            assigm.countPapers = result.value("qnty");
            assigm.securityID = result.value("securityid");
            assigm.securMarket = result.value("market");
            assigm.assigmentGUID = result.value("guid");
            assigm.step2Reject = result.value("step2_reject");
            assigm.isLimCorrected = result.value("islimitcorrected"); 
            assigm.operType = result.value("opertype");
        end;
    end;

    macro GetId()
        return assigm.assigmentID;
    end;

    macro GetDealId()
        return assigm.operationDealID;
    end;

    macro GetIdContract()
        return assigm.idContract;
    end;

    macro GetPkoStatus()
      return assigm.pkoStatus;
    end;

    macro GetQNTY()
      return assigm.countPapers;
    end;

    macro GetSecurityId()
        return assigm.securityID;
    end;

    macro GetMarket()
        return assigm.securMarket;
    end;

    macro GetGUID()
        return assigm.assigmentGUID;
    end;

    macro GetStep2Reject()
        return assigm.step2Reject;
    end;

    macro GetOperType()
        return assigm.operType;
    end;

    macro isLimitCorrected():bool
        if(assigm.isLimCorrected == "X")
            return true;
        end;
        return false;
    end;

    //является ли операция добровольным погашением ц/б
    macro isVoluntaryRedemption():bool
        return assigm.operType == 102;
    end;

    Init();
End;

class WriteOffMessageSender()

    macro FinalStateToMsa(pkoId:integer)
        var query =  
              "begin "
            + "    it_sinv.send_ca_securities_final_state(p_id => :id); "
            + "end; ";
        var params = MakeSqlParamsArray(pkoId);
        ExecSql(query, params);
    end;
end;