/*
$Name:        owninfmsgsc.mac
$Module:      Ценные бумаги (ОЭБ)
$Description: Макрос списка сообщений по раскрытию информации
*/
import DealsInter, SPInter, PTInter, globals, sptagfl;
import RsbDataSet;

/* Уже заполненные структуры, все изменения отразятся в базах */
PRIVATE VAR Документ         = TRecHandler( "scownmsg" );
PRIVATE VAR СтарыйДокумент   = TRecHandler( "scownmsg" ); /* заполняется при редактировании */

/* Макрофункция инициализации нового актива 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Новый_Документ()
  
  return 0;
END;

private macro Проверить_Документ( Режим:integer )
  if(Режим == 3) //редактирование операции

    //здесь должны быть проверки при редактировании

  elif(Режим == 1) //удаление
    
    //здесь должны быть проверки при удалении

  end;

  return 0;
end;

/* Установка подсказки для скролингов из макроса */
private MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string

  //пример
  //return "/*+FIRST_ROWS LEADING(t) INDEX(t dscownmsg_dbt_idx0)*/";

  return DefaultHint;

END;

/* Вызывается по CTRL+Z из скроллинга */
private macro Функция_Пользователя()
  MsgBox( "Выполняется макрофункция \"owninfmsgsc.mac\\ Функция_Пользователя\"." );
  return 0;
end;

private macro ПолучитьДатуОтправки()
  var SentDate = date(0,0,0);

  if( not GetDate(SentDate,"Введите дату отправки") ) 
     return date(0,0,0);
  end;

  return SentDate;
end;

private macro ПолучитьНомерИсхДокумента()
  var d, m, y;
  var RefID, ref = "";
  
  DateSplit(Документ.rec.PrepareDate, d, m, y);
  
  if(Документ.rec.ExtNum != "")
    var ind = Index(Документ.rec.ExtNum, "/");
    ref = substr(Документ.rec.ExtNum, ind+1);
  end;

  if(ref == "")
    ref = 0;
    if((GetReferenceIDByType(OBJTYPE_KINDDOC, REFOBJ_OWNMSGR_EXTNUM, RefID) != 0) or (GenerateReference(RefID, ref, 0, Документ) != 0))
       msgbox("Ошибка при генерации номера");
    end;
  end;

  return string(SP_StrTrimLeft(string(d),2)+"-"+SP_StrTrimLeft(string(m),2)+"/"+string(ref));
end;