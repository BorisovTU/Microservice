/*
$Name:        sp_carrl.mac
$Module:      Ценные бумаги
$Description: ПРОЦЕДУРЫ ПОЛУЧЕНИЯ РОЛЕЙ ФИНИНСТРУМЕНТА ДЛЯ ПРОВОДОК В ОПЕРАЦИЯХ С ЦЕННЫМИ БУМАГАМИ
*/

import FIInter,spinter,ctinter,oprinter,"secinter.mac ";

PRIVATE MACRO AvrIsShare( FI )
   return (FI_IsInvestmentShare(FI) OR FI_IsShare( FI ) );
END;

MACRO ПолучитьРолиКатегорийВложенийДляКонвертацииДР( Portfolio, Roles )
   if( (Portfolio < 0) AND (SP_WriteOffOnlySetPortofolio == false) )
          Roles[0] = FIROLE_BA_TP;
          Roles[1] = FIROLE_BA_PPR;
          Roles[2] = FIROLE_BAINCONTR;
   elif( Portfolio == KINDPORT_TRADE )
       if( SP_WriteOffOnlySetPortofolio == false )
          Roles[0] = FIROLE_BA_TP;
          Roles[1] = FIROLE_BA_PPR;
       else
          Roles[0] = FIROLE_BA_TP;
       end;
   elif( Portfolio == KINDPORT_SALE )
       if( SP_WriteOffOnlySetPortofolio == false )
          Roles[0] = FIROLE_BA_TP;
          Roles[1] = FIROLE_BA_PPR;
       else
          Roles[0] = FIROLE_BA_PPR;
       end;
   elif( Portfolio == KINDPORT_CONTR )
          Roles[0] = FIROLE_BAINCONTR;
   end;
END;

/*Если роль нужна для конкретного портфеля (при переборе групп списания или при зачислении).*/
MACRO ПолучитьРольДляКонвертацииДР_ПоПортфелю( Portfolio )
   if( Portfolio == KINDPORT_TRADE )
      return FIROLE_BA_TP;
   elif( Portfolio == KINDPORT_SALE )
      return FIROLE_BA_PPR;
   elif( Portfolio == KINDPORT_CONTR )
      return FIROLE_BAINCONTR;
   end;

   return -1;
END;

MACRO ПолучитьРолиКатегорийПереоценкиДляКонвертацииДР( Portfolio, Roles )
   if( (Portfolio < 0) AND (SP_WriteOffOnlySetPortofolio == false) )
          Roles[0] = FIROLE_BA_TP;
          Roles[1] = FIROLE_BA_PPR;
   elif( Portfolio == KINDPORT_TRADE )
       if( SP_WriteOffOnlySetPortofolio == false )
          Roles[0] = FIROLE_BA_TP;
          Roles[1] = FIROLE_BA_PPR;
       else
          Roles[0] = FIROLE_BA_TP;
       end;
   elif( Portfolio == KINDPORT_SALE )
       if( SP_WriteOffOnlySetPortofolio == false )
          Roles[0] = FIROLE_BA_TP;
          Roles[1] = FIROLE_BA_PPR;
       else
          Roles[0] = FIROLE_BA_PPR;
       end;
   elif( Portfolio == KINDPORT_CONTR )
          Roles[0] = null;
   end;
END;

MACRO ПолучитьРолиКатегорийРезерваДляКонвертацииДР( Portfolio, Roles )
   if( (Portfolio < 0) AND (SP_WriteOffOnlySetPortofolio == false) )
          Roles[0] = FIROLE_BA_PPR;
          Roles[1] = FIROLE_BAINCONTR;
   elif( Portfolio == KINDPORT_TRADE )
       if( SP_WriteOffOnlySetPortofolio == false )
          Roles[0] = FIROLE_BA_PPR;
       else
          Roles[0] = null;
       end;
   elif( Portfolio == KINDPORT_SALE )
          Roles[0] = FIROLE_BA_PPR;
   elif( Portfolio == KINDPORT_CONTR )
          Roles[0] = FIROLE_BAINCONTR;
   end;
END;

MACRO ПолучитьРолиКатегорийВложений( FD, Roles )
   var   TypePort, Quoted, IsBond, IsShare;
/*
   if( (FD.Kind == DLDOC_ISSUE) AND (FD.KindReserv != null) ) /*резервирование по бумаге*/
      Quoted  = FI_IsQuoted( FD.avoiriss );
      IsBond  = FI_IsBond( FD.fininstr );
      IsShare = AvrIsShare( FD.fininstr );

      if( (IsBond == true) AND (Quoted == true) )
         Roles[0] = FIROLE_BA_INVEST;
         Roles[1] = FIROLE_BAINPROMISSORYSALE;
         Roles[2] = FIROLE_BAINPROMISSORYINVEST;
         Roles[3] = null;

      elif( (IsShare == true) AND (Quoted == true) )
         Roles[0] = FIROLE_BA_INVEST;
         Roles[1] = FIROLE_BAINCONTR;
         Roles[2] = null;

      elif( (IsBond == true) AND (Quoted == false) )
         Roles[0] = FIROLE_BA_RESALE;
         Roles[1] = FIROLE_BA_INVEST;
         Roles[2] = FIROLE_BAINPROMISSORYSALE;
         Roles[3] = FIROLE_BAINPROMISSORYINVEST;
         Roles[4] = null;

      elif( (IsShare == true) AND (Quoted == false) )
         Roles[0] = FIROLE_BAININVEST;
         Roles[1] = FIROLE_BAINCONTR;
         Roles[2] = null;
      end;

   else 
      if( IsClientDeal(FD.tick.rec) )      
         Roles[0] = FIROLE_BA;
         Roles[1] = null;      
      else   
         TypePort    = FD.KindPortf;
         Quoted      = FI_IsQuoted( FD.avoiriss );
         IsBond      = FI_IsBond( FD.fininstr );
         IsShare     = AvrIsShare( FD.fininstr );

         if( FD.tick.rec.BofficeKind == DL_CONVAVR )   

            if( SP_WriteOffOnlySetPortofolio == false )
               if( TypePort < 0  )
                  if( Quoted == true ) 
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_INVEST;
                     Roles[2] = FIROLE_BAINCONTR;
                     Roles[3] = null;
                  else
                     Roles[0] = FIROLE_BAININVEST;
                     Roles[1] = FIROLE_BAINCONTR;
                     Roles[2] = null;
                  end;
               elif( TypePort == KINDPORT_TRADE )
                  if( Quoted == true ) 
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_INVEST;
                     Roles[2] = FIROLE_BAINCONTR;
                     Roles[3] = null;
                  end;
               elif( TypePort == KINDPORT_INVEST )
                  if( Quoted == true ) 
                     Roles[0] = FIROLE_BA_INVEST;
                     Roles[1] = FIROLE_BA_RESALE;
                     Roles[2] = FIROLE_BAINCONTR;
                     Roles[3] = null;
                  else
                     Roles[0] = FIROLE_BAININVEST;
                     Roles[1] = FIROLE_BAINCONTR;
                     Roles[2] = null;
                  end;
               elif( TypePort == KINDPORT_CONTR )
                  if( Quoted == true ) 
                     Roles[0] = FIROLE_BAINCONTR;
                     Roles[1] = FIROLE_BA_RESALE;
                     Roles[2] = FIROLE_BA_INVEST;
                     Roles[3] = null;
                  else
                     Roles[0] = FIROLE_BAINCONTR;
                     Roles[1] = FIROLE_BAININVEST;
                     Roles[2] = null;
                  end;
               end;
            else /*SP_WriteOffOnlySetPortofolio == true */
               if( TypePort == KINDPORT_TRADE )
                  if( Quoted == true ) 
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = null;
                  end;
               elif( TypePort == KINDPORT_INVEST )
                  if( Quoted == true ) 
                     Roles[0] = FIROLE_BA_INVEST;
                     Roles[1] = null;
                  else
                     Roles[0] = FIROLE_BAININVEST;
                     Roles[1] = null;
                  end;
               elif( TypePort == KINDPORT_CONTR )
                  Roles[0] = FIROLE_BAINCONTR;
                  Roles[1] = null;
               end;
            end;

         elif( FD.tick.rec.BofficeKind == DL_SECURITYDOC )   
            if( FD.IsOperLOAN == true ) /*Операция займа*/
               if(SP_WriteOffOnlySetPortofolio == true )
                  Roles[0] = null;
               else
                  if( IsShare == true )
                     if( Quoted == true )
                        Roles[0] = FIROLE_BA_RESALE;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = FIROLE_BAINCONTR;
                        Roles[3] = null;
                     else
                        Roles[0] = FIROLE_BAININVEST;
                        Roles[1] = FIROLE_BAINCONTR;
                        Roles[2] = null;
                     end;
                  else
                     if( Quoted == true )
                        Roles[0] = FIROLE_BA_RESALE;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = FIROLE_BAINPROMISSORYSALE;
                        Roles[3] = FIROLE_BAINPROMISSORYINVEST;
                        Roles[4] = null;
                     else
                        Roles[0] = FIROLE_BA_RESALE;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = FIROLE_BAINPROMISSORYSALE;
                        Roles[3] = FIROLE_BAINPROMISSORYINVEST;
                        Roles[4] = null;
                     end;
                  end;
               end;

            elif( FD.ExistBack == true ) /*Сделки с обратной частью*/

               if( SP_WriteOffOnlySetPortofolio == false )
                  if( Quoted == true ) 
                     if( IsShare == true )
                        Roles[0] = FIROLE_BA_RESALE;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = FIROLE_BAINCONTR;
                        Roles[3] = null;
                     elif( IsBond == true ) /* Долговое обязательство */
                        Roles[0] = FIROLE_BA_RESALE;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = FIROLE_BAINPROMISSORYSALE;
                        Roles[3] = FIROLE_BAINPROMISSORYINVEST;
                        Roles[4] = null;
                     end;
                  else
                     if( IsShare == true )
                        Roles[0] = FIROLE_BAININVEST;
                        Roles[1] = FIROLE_BAINCONTR;
                        Roles[2] = null;
                     elif( IsBond == true  ) /* Долговое обязательство */
                        Roles[0] = FIROLE_BA_RESALE;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = FIROLE_BAINPROMISSORYSALE;
                        Roles[3] = FIROLE_BAINPROMISSORYINVEST;
                        Roles[4] = null;
                     end;
                  end;
               else
                  Roles[0] = null;
               end;
               
            else
               if( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
                  if(SP_WriteOffOnlySetPortofolio == false )
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_INVEST;
                     Roles[2] = null;
                  else
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = null;
                  end;
               elif( (TypePort == KINDPORT_INVEST) AND (Quoted == true) )
                  if(SP_WriteOffOnlySetPortofolio == false )
                     Roles[0] = FIROLE_BA_INVEST;
                     Roles[1] = FIROLE_BA_RESALE;
                     Roles[2] = null;
                  else
                     Roles[0] = FIROLE_BA_INVEST;
                     Roles[1] = null;
                  end;
               elif( (TypePort == KINDPORT_INVEST) AND (IsBond == true) AND (Quoted == false) )
                  if(SP_WriteOffOnlySetPortofolio == false )
                     Roles[0] = FIROLE_BA_INVEST;
                     Roles[1] = FIROLE_BA_RESALE;
                     Roles[2] = null;
                  else
                     Roles[0] = FIROLE_BA_INVEST;
                     Roles[1] = FIROLE_BA_RESALE;
                     Roles[2] = null;
                  end;
               elif( (TypePort == KINDPORT_INVEST) AND (IsShare == true) AND (Quoted == false) )
                  if(SP_WriteOffOnlySetPortofolio == false )
                     Roles[0] = FIROLE_BA;
                     Roles[1] = null;
                  else
                     Roles[0] = FIROLE_BA;
                     Roles[1] = null;
                  end;
               elif( (TypePort == KINDPORT_PROMISSORY) AND (IsBond == true) )

                  Roles[0] = FIROLE_BA_INVEST;
                  Roles[1] = FIROLE_BA_RESALE;
                  Roles[2] = null;

               elif( (TypePort == KINDPORT_CONTR) AND (IsShare == true) )

                  Roles[0] = FIROLE_BA;
                  Roles[1] = null;

               elif( (TypePort == KINDPORT_REPO) OR (TypePort == KINDPORT_LOAN) )
                  if( SP_WriteOffOnlySetPortofolio == false )
                     if( (Quoted == true) OR (IsBond == true) )
                        Roles[0] = FIROLE_BA_RESALE;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = null;
                     elif( IsShare == true )
                        Roles[0] = FIROLE_BAININVEST;
                        Roles[1] = null;
                     end;
                  else
                     Roles[0] = null;
                  end;
               end;
            end;
         elif( FD.tick.rec.BofficeKind == DL_RETIREMENT )
            if( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
               Roles[0] = FIROLE_BA_RESALE;
               Roles[1] = FIROLE_BA_INVEST;
               Roles[2] = null;
            elif( (TypePort == KINDPORT_INVEST) AND (Quoted == false) )      
               Roles[0] = FIROLE_BA_RESALE;
               Roles[1] = FIROLE_BA_INVEST;
               Roles[2] = null;
            elif( TypePort == KINDPORT_PROMISSORY )      
               Roles[0] = FIROLE_BA_RESALE;
               Roles[1] = FIROLE_BA_INVEST;
               Roles[2] = null;
            end;
         end; /*if( FD.tick.rec.BofficeKind == DL_SECURITYDOC )*/
      end;
   end; /*if( FD.Kind == DLDOC_ISSUE )*/
*/
END;

MACRO ПолучитьРолиКатегорийПоДоговорам( FD, Roles )
   var   Quoted      = FI_IsQuoted( FD.avoiriss );
   var   IsShare     = AvrIsShare( FD.fininstr );
   var   TypePort    = FD.KindPortf;
/*
   if( IsClientDeal(FD.tick.rec) )      
      Roles[0] = FIROLE_BA;
      Roles[1] = null;      
   else
      if( FD.tick.rec.BofficeKind == DL_SECURITYDOC )   
         if( FD.IsOperLOAN == true ) /*Операция займа*/
            if( SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA_REPO;
               Roles[1] = FIROLE_BA_LOAN;
               Roles[2] = null;
            else
               Roles[0] = FIROLE_BA_LOAN;
               Roles[1] = null;
            end;

         elif( FD.ExistBack == true ) /*Сделки с обратной частью*/
            if( SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA_REPO;
               Roles[1] = FIROLE_BA_LOAN;
               Roles[2] = null;
            else
               Roles[0] = FIROLE_BA_REPO;
               Roles[1] = null;
            end;
         else
            if( (TypePort == KINDPORT_TRADE) OR (TypePort == KINDPORT_INVEST) )
               if( SP_WriteOffOnlySetPortofolio == false )
                  Roles[0] = FIROLE_BA_REPO;
                  Roles[1] = FIROLE_BA_LOAN;
                  Roles[2] = null;
               end;
            elif( TypePort == KINDPORT_REPO )
               if( SP_WriteOffOnlySetPortofolio == false )
                  Roles[0] = FIROLE_BA_REPO;
                  Roles[1] = FIROLE_BA_LOAN;
                  Roles[2] = null;
               else 
                  Roles[0] = FIROLE_BA_REPO;
                  Roles[1] = null;
               end;
            elif( TypePort == KINDPORT_LOAN )
               if( SP_WriteOffOnlySetPortofolio == false )
                  Roles[0] = FIROLE_BA_LOAN;
                  Roles[1] = FIROLE_BA_REPO;
                  Roles[2] = null;
               else 
                  Roles[0] = FIROLE_BA_LOAN;
                  Roles[1] = null;
               end;
            end;
         end;
      /*для погашения купонов*/
      elif( (FD.tick.rec.BofficeKind == DL_RETIREMENT) AND 
            (IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group)) 
          ) 
         Roles[0] = FIROLE_BA_REPO;
         Roles[1] = FIROLE_BA_LOAN;
         Roles[2] = null;
      end; 
   end;
*/
end;

MACRO ПолучитьРолиКатегорийЗатрат( FD, Roles )
   var   TypePort    = FD.KindPortf;
   var   Quoted      = FI_IsQuoted( FD.fininstr.rec.FIID );
   var   IsBond      = FI_IsBond( FD.fininstr );
   var   IsShare     = AvrIsShare( FD.fininstr );
/*   
   if( IsClientDeal(FD.tick.rec) )      
      Roles[0] = FIROLE_BA;
      Roles[1] = null;      
   else
      if( FD.tick.rec.BofficeKind == DL_SECURITYDOC )   

         if( FD.IsOperLOAN == true ) /*Операция займа*/
            if(SP_WriteOffOnlySetPortofolio == true )
               Roles[0] = null;
            else
               if( IsShare == true )
                  if( Quoted == true )
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_INVEST;
                     Roles[2] = FIROLE_BAINCONTR;
                     Roles[3] = null;
                  else
                     Roles[0] = FIROLE_BAININVEST;
                     Roles[1] = FIROLE_BAINCONTR;
                     Roles[2] = null;
                  end;
               else
                  if( Quoted == true )
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_INVEST;
                     Roles[2] = null;
                  else
                     Roles[1] = FIROLE_BAININVEST;
                     Roles[2] = null;
                  end;
               end;
            end;

         elif( FD.ExistBack == true ) /*Сделки с обратной частью*/

            if( SP_WriteOffOnlySetPortofolio == false )
               if( Quoted == true ) 
                  if( IsShare == true )
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_INVEST;
                     Roles[2] = FIROLE_BAINCONTR;
                     Roles[3] = null;
                  elif( IsBond == true ) /* Долговое обязательство */
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_INVEST;
                     Roles[2] = null;
                  end;
               else
                  if( IsShare == true )
                     Roles[0] = FIROLE_BAININVEST;
                     Roles[1] = FIROLE_BAINCONTR;
                     Roles[2] = null;
                  elif( IsBond == true ) /* Долговое обязательство */
                     Roles[0] = FIROLE_BAININVEST;
                     Roles[1] = null;
                  end;
               end;
            else
               Roles[0] = null;
            end;

         elif( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
            if(SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA_RESALE;
               Roles[1] = FIROLE_BA_INVEST;
               Roles[2] = null;
            else
               Roles[0] = FIROLE_BA_RESALE;
               Roles[1] = null;
            end;
         elif( (TypePort == KINDPORT_INVEST) AND (Quoted == true) )
            if(SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA_INVEST;
               Roles[1] = FIROLE_BA_RESALE;
               Roles[2] = null;
            else
               Roles[0] = FIROLE_BA_INVEST;
               Roles[1] = null;
            end;
         elif( (TypePort == KINDPORT_INVEST) AND (Quoted == false) )
            if(SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA;
               Roles[1] = null;
            else
               Roles[0] = FIROLE_BA;
               Roles[1] = null;
            end;
         elif( (TypePort == KINDPORT_PROMISSORY) AND (IsBond == true) )

            Roles[0] = FIROLE_BA;
            Roles[1] = null;

         elif( (TypePort == KINDPORT_CONTR) AND (IsShare == true) )

            Roles[0] = FIROLE_BA;
            Roles[1] = null;

         elif( (TypePort == KINDPORT_REPO) OR (TypePort == KINDPORT_LOAN) )
            if(SP_WriteOffOnlySetPortofolio == false )
               if( Quoted == true )
                  Roles[0] = FIROLE_BA_RESALE;
                  Roles[1] = FIROLE_BA_INVEST;
                  Roles[2] = null;
               elif( IsShare == true )
                  Roles[0] = FIROLE_BAININVEST;
                  Roles[1] = null;
               end;
            else
               Roles[0] = null;
            end;
         end;
      elif( FD.tick.rec.BofficeKind == DL_RETIREMENT )
         if( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
            Roles[0] = FIROLE_BA_RESALE;
            Roles[1] = FIROLE_BA_INVEST;
            Roles[2] = null;
         elif( (TypePort == KINDPORT_INVEST) AND (Quoted == false) )      
            Roles[0] = FIROLE_BA;
            Roles[1] = null;
         elif( TypePort == KINDPORT_PROMISSORY )      
            Roles[0] = FIROLE_BA;
            Roles[1] = null;
         end;
      end;      
   end;
*/
END;

MACRO ПолучитьРолиКатегорийДляПеребора( FD, Roles, FindContractorGrp )
   var   TypePort    = FD.KindPortf;
   var   Quoted      = FI_IsQuoted( FD.fininstr.rec.FIID );
   var   IsBond      = FI_IsBond( FD.fininstr );
   var   IsShare     = AvrIsShare( FD.fininstr );
/*
   if( IsClientDeal(FD.tick.rec) OR (FindContractorGrp == true) )      
      Roles[0] = FIROLE_BA;
      Roles[1] = null;      
   else   
      if( FD.ExistBack == true ) /*Сделки с обратной частью*/

         if( SP_WriteOffOnlySetPortofolio == false )
            if( Quoted == true ) 
               if( IsShare == true )
                  Roles[0] = FIROLE_BA_RESALE;
                  Roles[1] = FIROLE_BA_REPO;
                  Roles[2] = FIROLE_BA_LOAN;
                  Roles[3] = FIROLE_BA_INVEST;
                  Roles[4] = FIROLE_BAINCONTR;
                  Roles[5] = null;
               elif( IsBond == true ) /* Долговое обязательство */
                  Roles[0] = FIROLE_BA_RESALE;
                  Roles[1] = FIROLE_BA_REPO;
                  Roles[2] = FIROLE_BA_LOAN;
                  Roles[3] = FIROLE_BA_INVEST;
                  Roles[4] = FIROLE_BAINPROMISSORY;
                  Roles[5] = null;
               end;
            else
               if( IsShare == true )
                  Roles[0] = FIROLE_BA_REPO;
                  Roles[1] = FIROLE_BA_LOAN;
                  Roles[2] = FIROLE_BAININVEST;
                  Roles[3] = FIROLE_BAINCONTR;
                  Roles[4] = null;
               elif( IsBond == true ) /* Долговое обязательство */
                  Roles[0] = FIROLE_BA_REPO;
                  Roles[1] = FIROLE_BA_LOAN;
                  Roles[2] = FIROLE_BAININVEST;
                  Roles[3] = FIROLE_BAINPROMISSORY;
                  Roles[4] = null;
               end;
            end;
         else
            Roles[0] = FIROLE_BA_REPO;
            Roles[1] = null;
         end;

      elif(FD.tick.rec.BofficeKind == DL_SECURITYDOC)
         if( FD.IsOperLOAN == true ) /*Операция займа*/
            if(SP_WriteOffOnlySetPortofolio == true )
               Roles[0] = FIROLE_BA_LOAN;
               Roles[1] = null;
            else
               if( IsShare == true )
                  if( Quoted == true )
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_REPO;
                     Roles[2] = FIROLE_BA_LOAN;
                     Roles[3] = FIROLE_BA_INVEST;
                     Roles[4] = FIROLE_BAINCONTR;
                     Roles[5] = null;
                  else
                     Roles[0] = FIROLE_BA_REPO;
                     Roles[1] = FIROLE_BA_LOAN;
                     Roles[2] = FIROLE_BAININVEST;
                     Roles[3] = FIROLE_BAINCONTR;
                     Roles[4] = null;
                  end;
               else
                  if( Quoted == true )
                     Roles[0] = FIROLE_BA_RESALE;
                     Roles[1] = FIROLE_BA_REPO;
                     Roles[2] = FIROLE_BA_LOAN;
                     Roles[3] = FIROLE_BA_INVEST;
                     Roles[4] = FIROLE_BAINPROMISSORY;
                     Roles[5] = null;
                  else
                     Roles[0] = FIROLE_BA_REPO;
                     Roles[1] = FIROLE_BA_LOAN;
                     Roles[2] = FIROLE_BAININVEST;
                     Roles[3] = FIROLE_BAINPROMISSORY;
                     Roles[4] = null;
                  end;
               end;
            end;

         elif( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
            if(SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA_RESALE;
               Roles[1] = FIROLE_BA_REPO;
               Roles[2] = FIROLE_BA_LOAN;
               Roles[3] = FIROLE_BA_INVEST;
               Roles[4] = null;
            else
               Roles[0] = FIROLE_BA_RESALE;
               Roles[1] = null;
            end;
         elif( (TypePort == KINDPORT_INVEST) AND (Quoted == true) )
            if(SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA_INVEST;
               Roles[1] = FIROLE_BA_RESALE;
               Roles[2] = FIROLE_BA_REPO;
               Roles[3] = FIROLE_BA_LOAN;
               Roles[4] = null;
            else
               Roles[0] = FIROLE_BA_INVEST;
               Roles[1] = null;
            end;
         elif( (TypePort == KINDPORT_INVEST) AND (Quoted == false) )
            if(SP_WriteOffOnlySetPortofolio == false )
               Roles[0] = FIROLE_BA;
               Roles[1] = FIROLE_BA_REPO;
               Roles[2] = FIROLE_BA_LOAN;
               Roles[3] = null;
            else
               Roles[0] = FIROLE_BA;
               Roles[1] = null;
            end;
         elif( (TypePort == KINDPORT_PROMISSORY) AND (IsBond == true) )

            Roles[0] = FIROLE_BA;
            Roles[1] = null;

         elif( (TypePort == KINDPORT_CONTR) AND (IsShare == true) )

            Roles[0] = FIROLE_BA;
            Roles[1] = null;

         elif( TypePort == KINDPORT_REPO )

            if(SP_WriteOffOnlySetPortofolio == false )
               if( Quoted == true )
                  Roles[0] = FIROLE_BA_REPO;
                  Roles[1] = FIROLE_BA_RESALE;
                  Roles[2] = FIROLE_BA_LOAN;
                  Roles[3] = FIROLE_BA_INVEST;
                  Roles[4] = null;
               else
                  Roles[0] = FIROLE_BA_REPO;
                  Roles[1] = FIROLE_BAININVEST;
                  Roles[2] = FIROLE_BA_LOAN;
                  Roles[3] = null;
               end;
            else
               Roles[0] = FIROLE_BA_REPO;
               Roles[1] = null;
            end;

         elif( TypePort == KINDPORT_LOAN )
            if(SP_WriteOffOnlySetPortofolio == false )
               if( Quoted == true )
                  Roles[0] = FIROLE_BA_LOAN;
                  Roles[1] = FIROLE_BA_RESALE;
                  Roles[2] = FIROLE_BA_REPO;
                  Roles[3] = FIROLE_BA_INVEST;
                  Roles[4] = null;
               else
                  Roles[0] = FIROLE_BA_LOAN;
                  Roles[1] = FIROLE_BAININVEST;
                  Roles[2] = FIROLE_BA_REPO;
                  Roles[3] = null;
               end;
            else
               Roles[0] = FIROLE_BA_LOAN;
               Roles[1] = null;
            end;
         end;

      elif( FD.tick.rec.BofficeKind == DL_RETIREMENT )
         if( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
            Roles[0] = FIROLE_BA_RESALE;
            Roles[1] = FIROLE_BA_INVEST;
            if( IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group))
               Roles[2] = FIROLE_BA_REPO;
               Roles[3] = FIROLE_BA_LOAN;
               Roles[4] = null;
            else
               Roles[2] = null;
            end;
         elif( (TypePort == KINDPORT_INVEST) AND (Quoted == false) )      
            Roles[0] = FIROLE_BA;
            if( IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group))
               Roles[1] = FIROLE_BA_REPO;
               Roles[2] = FIROLE_BA_LOAN;
               Roles[3] = null;
            else            
               Roles[1] = null;
            end;
         elif( TypePort == KINDPORT_PROMISSORY )      
            Roles[0] = FIROLE_BA;
            if( IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group))
               Roles[1] = FIROLE_BA_REPO;
               Roles[2] = FIROLE_BA_LOAN;
               Roles[3] = null;
            else
               Roles[1] = null;
            end;
         end;
      elif (FD.tick.rec.BofficeKind == DL_AVRWRT)
        Roles[0] = FIROLE_BA;
      end;
   end;
*/
END;

MACRO ПолучитьРолиКатегорийРезерва( FD, Roles )
   var   TypePort, Quoted, IsBond, IsShare;
/*
   if( (FD.Kind == DLDOC_ISSUE) AND (FD.KindReserv != null) ) /*резервирование по бумаге*/
      IsBond   = FI_IsBond( FD.fininstr );
      IsShare  = AvrIsShare( FD.fininstr );

      if( IsShare )
         Roles[0] = FIROLE_BAININVEST;
         Roles[1] = FIROLE_BAINCONTR;
         Roles[2] = null;
      elif( IsBond )
         Roles[0] = FIROLE_BAININVEST;
         Roles[1] = FIROLE_BAINPROMISSORY;
         Roles[2] = null;
      end;

   else
      if( FD.tick != null )
         if( IsClientDeal(FD.tick.rec) )      
            Roles[0] = FIROLE_BA;
            Roles[1] = null;      
         else
            TypePort    = FD.KindPortf;
            Quoted      = FI_IsQuoted( FD.fininstr.rec.FIID );
            IsBond      = FI_IsBond( FD.fininstr );
            IsShare     = AvrIsShare( FD.fininstr );

            if( FD.tick.rec.BofficeKind == DL_CONVAVR )   

               if( SP_WriteOffOnlySetPortofolio == false )
                  if( TypePort < 0  )
                     if( Quoted == true ) 
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = FIROLE_BAINCONTR;
                        Roles[2] = null;
                     else
                        Roles[0] = FIROLE_BAININVEST;
                        Roles[1] = FIROLE_BAINCONTR;
                        Roles[2] = null;
                     end;
                  elif( TypePort == KINDPORT_TRADE )
                     if( Quoted == true ) 
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = FIROLE_BAINCONTR;
                        Roles[2] = null;
                     end;
                  elif( TypePort == KINDPORT_INVEST )
                     if( Quoted == true ) 
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = FIROLE_BAINCONTR;
                        Roles[2] = null;
                     else
                        Roles[0] = FIROLE_BAININVEST;
                        Roles[1] = FIROLE_BAINCONTR;
                        Roles[2] = null;
                     end;
                  elif( TypePort == KINDPORT_CONTR )
                     if( Quoted == true ) 
                        Roles[0] = FIROLE_BAINCONTR;
                        Roles[1] = FIROLE_BA_INVEST;
                        Roles[2] = null;
                     else
                        Roles[0] = FIROLE_BAINCONTR;
                        Roles[1] = FIROLE_BAININVEST;
                        Roles[2] = null;
                     end;
                  end;
               else /*SP_WriteOffOnlySetPortofolio == true */
                  if( TypePort == KINDPORT_TRADE )
                     Roles[0] = null;
                  elif( TypePort == KINDPORT_INVEST )
                     if( Quoted == true ) 
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = null;
                     else
                        Roles[0] = FIROLE_BAININVEST;
                        Roles[1] = null;
                     end;
                  elif( TypePort == KINDPORT_CONTR )
                     Roles[0] = FIROLE_BAINCONTR;
                     Roles[1] = null;
                  end;
               end;

            elif( FD.tick.rec.BofficeKind == DL_SECURITYDOC )
               if( FD.ExistBack == true ) /*Сделки с обратной частью*/

                  if( SP_WriteOffOnlySetPortofolio == false )
                     if( Quoted == true ) 
                        if( IsShare == true )
                           Roles[0] = FIROLE_BA_INVEST;
                           Roles[1] = FIROLE_BAINCONTR;
                           Roles[2] = null;
                        elif( IsBond == true ) /* Долговое обязательство */
                           Roles[0] = FIROLE_BA_INVEST;
                           Roles[1] = FIROLE_BAINPROMISSORYSALE;
                           Roles[2] = FIROLE_BAINPROMISSORYINVEST;
                           Roles[3] = null;
                        end;
                     else
                        if( IsShare == true )
                           Roles[0] = FIROLE_BAININVEST;
                           Roles[1] = FIROLE_BAINCONTR;
                           Roles[2] = null;
                        elif( IsBond == true ) /* Долговое обязательство */
                           Roles[0] = FIROLE_BA_RESALE;
                           Roles[1] = FIROLE_BA_INVEST;
                           Roles[2] = FIROLE_BAINPROMISSORYSALE;
                           Roles[3] = FIROLE_BAINPROMISSORYINVEST;
                           Roles[4] = null;
                        end;
                     end;
                  else
                     Roles[0] = null;
                  end;

               else /*сделки без обратной части*/

                  if( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
                     if(SP_WriteOffOnlySetPortofolio == false )
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = null;
                     else
                        Roles[0] = null;
                     end;
                  elif( (TypePort == KINDPORT_INVEST) AND (Quoted == true) )
                     if(SP_WriteOffOnlySetPortofolio == false )
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = null;
                     else
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = null;
                     end;
                  elif( (TypePort == KINDPORT_INVEST) AND (IsBond == true) AND (Quoted == false) )
                     if(SP_WriteOffOnlySetPortofolio == false )
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = FIROLE_BA_RESALE;
                        Roles[2] = null;
                     else
                        Roles[0] = FIROLE_BA_INVEST;
                        Roles[1] = FIROLE_BA_RESALE;
                        Roles[2] = null;
                     end;
                  elif( (TypePort == KINDPORT_INVEST) AND (IsShare == true) AND (Quoted == false) )
                     if(SP_WriteOffOnlySetPortofolio == false )
                        Roles[0] = FIROLE_BA;
                        Roles[1] = null;
                     else
                        Roles[0] = FIROLE_BA;
                        Roles[1] = null;
                     end;
                  elif( (TypePort == KINDPORT_PROMISSORY) AND (IsBond == true) )

                     Roles[0] = FIROLE_BA_INVEST;
                     Roles[1] = FIROLE_BA_RESALE;
                     Roles[2] = null;

                  elif( (TypePort == KINDPORT_CONTR) AND (IsShare == true) )

                     Roles[0] = FIROLE_BA;
                     Roles[1] = null;
                  end;
               end;

            elif( FD.tick.rec.BofficeKind == DL_RETIREMENT )

               if( (TypePort == KINDPORT_TRADE) AND (Quoted == true) )
                  Roles[0] = FIROLE_BA_INVEST;
                  Roles[1] = null;
               elif( (TypePort == KINDPORT_INVEST) AND (Quoted == false) )
                  Roles[0] = FIROLE_BA_RESALE;
                  Roles[1] = FIROLE_BA_INVEST;
                  Roles[2] = null;
               elif( TypePort == KINDPORT_PROMISSORY )
                  Roles[0] = FIROLE_BA_RESALE;
                  Roles[1] = FIROLE_BA_INVEST;
                  Roles[2] = null;
               end;
            end;
         end;
      end;
   end;
*/
END;

MACRO ПолучитьГруппыСписания( FD, Groups:TArray ):BOOL
  var Portofolio = KINDPORT_UNDEF;

  Groups.Size = 0;

  if( (FD.Kind == DL_SECURITYDOC) OR (FD.Kind == DL_AVRWRT) OR (FD.Kind == DL_SECURLEG) )
     if( not IsREPO(FD.Group) )
        Portofolio = FD.GetPortofolio();
     end;
     if( IsClientDeal(FD.tick.rec) )
        Groups[0] = KINDPORT_CLIENT;
     elif( Portofolio == KINDPORT_TRADE )
        Groups[0] = KINDPORT_TRADE;
        if( SP_WriteOffOnlySetPortofolio == false )
           Groups[1] = KINDPORT_SALE;
           Groups[2] = KINDPORT_RETIRE;
           Groups[3] = KINDPORT_BACK;
        end;
     elif( Portofolio == KINDPORT_SALE )
        Groups[0] = KINDPORT_SALE;
        if( SP_WriteOffOnlySetPortofolio == false )
           Groups[1] = KINDPORT_TRADE;
           Groups[2] = KINDPORT_RETIRE;
           Groups[3] = KINDPORT_BACK;
        end;
     elif( Portofolio == KINDPORT_RETIRE )
        Groups[0] = KINDPORT_RETIRE;
        if( SP_WriteOffOnlySetPortofolio == false )
           Groups[1] = KINDPORT_SALE;
           Groups[2] = KINDPORT_TRADE;
           Groups[3] = KINDPORT_BACK;
        end;
     elif( Portofolio == KINDPORT_BACK )
        Groups[0] = KINDPORT_BACK;
        if( SP_WriteOffOnlySetPortofolio == false )
           Groups[1] = KINDPORT_TRADE;
           Groups[2] = KINDPORT_SALE;
           Groups[3] = KINDPORT_RETIRE;
        end;
     elif( Portofolio == KINDPORT_CONTR )
        Groups[0] = KINDPORT_CONTR;
     elif( Portofolio == KINDPORT_PROMISSORY )
        Groups[0] = KINDPORT_PROMISSORY;
     elif( (Portofolio == KINDPORT_UNDEF) AND
           IsREPO(FD.Group) )
        if (IsSALE(FD.Group))
           Groups[0] = KINDPORT_TRADE;
           Groups[1] = KINDPORT_SALE;
           Groups[2] = KINDPORT_RETIRE;
           Groups[3] = KINDPORT_BACK;
        else
           Groups[0] = KINDPORT_TRADE;
           Groups[1] = KINDPORT_SALE;
           Groups[2] = KINDPORT_BACK;
        end;
     else
        Groups[0] = KINDPORT_UNDEF;
     end;

  elif( (FD.Kind == DL_TRUSTDOC) OR (FD.Kind == DL_TRUSTAVRWRT) OR (FD.Kind == DL_TRUSTRETIREMENT) )
     Groups[0] = KINDPORT_TRUST;
  elif( FD.Kind == DL_RETIREMENT )
     if( IsClientDeal(FD.tick.rec) )
        Groups[0] = KINDPORT_CLIENT;
     elif( IsRET_ISSUE(FD.Group) ) // Для погашения выпусков 
        Groups[0] = KINDPORT_RETIRE;
        Groups[1] = KINDPORT_TRADE;
        Groups[2] = KINDPORT_SALE;
        Groups[3] = KINDPORT_PROMISSORY;
     else   // для погашения купонов/чп
        Groups[0] = KINDPORT_RETIRE;
        Groups[1] = KINDPORT_TRADE;
        Groups[2] = KINDPORT_SALE;
        Groups[3] = KINDPORT_BACK;
     end;
  elif( IsCONVERT_SHARE(FD.Group) OR IsCONVERT_RECEIPT(FD.Group) )
     if( FD.KindPortf == KINDPORT_TRADE )
        if( SP_WriteOffOnlySetPortofolio == false )
           Groups[0] = KINDPORT_TRADE;
           Groups[1] = KINDPORT_SALE;
        else
           Groups[0] = KINDPORT_TRADE;
        end;
     elif( FD.KindPortf == KINDPORT_SALE )
        if( SP_WriteOffOnlySetPortofolio == false )
           Groups[0] = KINDPORT_SALE;
           Groups[1] = KINDPORT_TRADE;
        else
           Groups[0] = KINDPORT_SALE;
        end;
     elif( FD.KindPortf == KINDPORT_CONTR )
        Groups[0] = KINDPORT_CONTR;
     elif( (FD.KindPortf < 0) AND (SP_WriteOffOnlySetPortofolio == false) )
        Groups[0] = KINDPORT_TRADE;
        Groups[1] = KINDPORT_SALE;
        Groups[2] = KINDPORT_CONTR;
     elif( IsClientDeal(FD.tick.rec) )
        Groups[0] = KINDPORT_CLIENT;
     end;
  end;

  return true;
END;
