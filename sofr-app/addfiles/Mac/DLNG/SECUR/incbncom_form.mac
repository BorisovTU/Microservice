/*******************************************************************************
 DESCRIPTION  :   Отчет "Доходы в виде комиссий по оказанным банком услугам" (НУ) - форма ввода данных
 PROGRAMMED BY:   Никольская В.В.
 CREATION DATE:   19.12.07
*******************************************************************************/
import "DlRepForm_h.mac", "globals.mac";

/*Номера полей в форме отчета*/
CONST PNFLD_COMMREG_PERIOD       = 0, //Период
      PNFLD_COMMREG_YEAR         = 1, 
      PNFLD_COMMREG_CONTRSUBKIND = 2, //Подвид договора обслуживания
      PNFLD_COMMREG_COMFREETYPE  = 3, //Номер Комиссии
      PNFLD_COMMREG_COMNUMBER    = 4, //Наименовани комиссии
      PNFLD_COMMREG_COMPRINTMETHOD  = 5; 

CONST H_PNFLD_PERIOD       = 20,
      H_PNFLD_CONTRSUBKIND = 21,
      H_PNFLD_COMFREETYPE  = 22,//номер
      H_PNFLD_COMNUMBER    = 23;//наименование

VAR ComFeeType;

/*листалка подвидов обслуживания*/
MACRO ListContrSubKind( FldShowValue:@VARIANT, FldRealValue:@VARIANT, X:INTEGER, Y:INTEGER ):BOOL
  return DL_ComboBox( "select t_Name, t_Servicekindsub from dservksub_dbt where t_servicekind = " + string(PTSK_STOCKDL),
                      "t_Name", "t_Servicekindsub", 
                      @FldShowValue, @FldRealValue, X, Y
                    );

END;

/*листалка комиссий*/
PRIVATE MACRO ListSfComiss( Name:@VARIANT, FldShowValue:@VARIANT, FldRealValue:@VARIANT, X:INTEGER, Y:INTEGER ):BOOL
  VAR Choice = DL_Scroll("select t_Code, t_Name, t_Number, t_DateBegin, t_DateEnd, t_FeeType from dsfcomiss_dbt "+
                         " where t_receiverid = "+string({OurBank})+" and t_servicekind = " + string(PTSK_STOCKDL),
                         "Комиссия", X, Y,
                         "t_Code","Код","t_Name","Наименование","t_Number","Номер",
                         "t_DateBegin","Дата нач.","t_DateEnd","Дата оконч."
                        );
  if( Choice != NULL )
     FldRealValue = Choice.Value("t_Number"); 
     FldShowValue = Choice.Value("t_Code");
     Name         = Choice.Value("t_Name");
     ComFeeType   = Choice.Value("t_FeeType");
  end;
  return (Choice != NULL);
END;                              

/*обработчик видов обслуживания*/
MACRO FldProc_ContrSubKind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = "";
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) ) 
     FldRealValue = -1;
     FldShowValue = "";
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     ListContrSubKind( @FldShowValue, @FldRealValue, 31, 12 );
  end;
  return CM_DEFAULT;
END;

/*обработчик поля комиссия*/
MACRO FldProc_ComFreeType( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR Name;

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = "";
        pThis.SetLinkedValue( H_PNFLD_COMNUMBER, "");
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) ) 
     FldRealValue = -1;
     FldShowValue = "";
     pThis.SetLinkedValue( H_PNFLD_COMNUMBER, "");
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
      ListSfComiss( @Name, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
      if( (FldRealValue != null) and (FldRealValue > 0) ) 
         pThis.SetLinkedValue( H_PNFLD_COMNUMBER, Name);
      end;
  end;
  return CM_DEFAULT;
END;

MACRO FldProc_Period( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  VAR BeginDate, EndDate, Month, Year, BegD, EndD;

  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        DateSplit( {curdate}, null, Month, null );
        FldRealValue = ((Month - 1)/3 + 1)*3;
     end;
     FldShowValue = DL_GetNameAlg( ALG_CB_PERIOD_IN_QUART, FldRealValue );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     DL_ListNA( ALG_CB_PERIOD_IN_QUART, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
  end;
  return CM_DEFAULT;
END;


PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) SP_COMMREG_Panel()

  PRIVATE MACRO Init()
     VAR CurMonth, PrevQuartal, Year;
     DateSplit( {curdate}, null, CurMonth, Year );

     PrevQuartal = ((CurMonth - 1)/3 + 1)*3; 
     if( PrevQuartal == 0 )
        PrevQuartal = 12;
        Year        = Year - 1;
     end;

     AddFieldProc( 0, PNFLD_COMMREG_PERIOD,      H_PNFLD_PERIOD,      @FldProc_Period, PrevQuartal, 24, 10 ); 
     AddFieldProc( 0, PNFLD_COMMREG_YEAR,        DL_PNFLD_YEAR,       @DL_FldProc_Year, Year );
     AddFieldProc( 0, PNFLD_COMMREG_CONTRSUBKIND,H_PNFLD_CONTRSUBKIND,@FldProc_ContrSubKind, "");
     AddFieldProc( 0, PNFLD_COMMREG_COMFREETYPE, H_PNFLD_COMFREETYPE, @FldProc_ComFreeType, "" );
     AddFieldProc( 0, PNFLD_COMMREG_COMNUMBER,   H_PNFLD_COMNUMBER,   @Default, "" );
    /* AddFieldProc( 0, PNFLD_COMMREG_COMPRINTMETHOD, DL_PNFLD_PRINTMETHOD, @DL_FldProc_PrintMethod, DL_OUTREPORT_EXCEL, 26, 15 ); */
     AddFieldProc( 0, PNFLD_COMMREG_COMPRINTMETHOD,     DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox, "X" );
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel( "sp_res.lbr", "INCBNCOM" ); 
END;
