import oralib, likepy, globals, rsexts, commonutil/*Simanov. избавляемся от библиотеки , commoninter*/;
import "DlRepForm_h.mac", "dlmisc.mac","globals", Календарь, RSD, RsbDataSet, "or_tpl_h.mac",prnfrm,or_tpl_h, PTInter,rcw;
import RsbFormsInter, "scincfun.mac";


private macro MakeReport (dateIn: date)
var Obtemp = CTemplateXLS();
Obtemp.OpenTemplate("Report_657_3_Repo.xlsx", false);//имя шаблона
var obcsvfile = C_CSVFile(";");
obcsvfile.FileOpen(string(UserNumber)+"repo.txt",true);// цсв таблица
var obtable, obtable1, obtable2, obtable3;
obtable = Obtemp.RegisterTable("bodyline");



var cmd,rs;
	cmd = "SELECT DISTINCT DEAL_NUMBER,                                                                                                                  "+   
"                     REPO_DIRECTION,                                                                                                                        "+    
"	              REPO_EXCHANGE,                                                                                                                         "+
"                     DECODE(NVL(SUBJECT, CHR(1)), CHR(1), CHR(0), SUBJECT) AS SUBJECT,                                                                      "+
"	              nvl(SUBJ_RATING,chr(0)) SUBJ_RATING,                                                                                                   "+
"                     CHR (0),                                                                                                                               "+
"	              nvl(SECUR_DWHINFO.GetRate((select t_partyid from  ddl_tick_dbt where t_dealcode = deal_number and t_bofficekind = 101), 3, 19, 436, :ndate), chr(0)) as AKRA,  "+ 
"	              nvl(SECUR_DWHINFO.GetRate((select t_partyid from  ddl_tick_dbt where t_dealcode = deal_number and t_bofficekind = 101), 3, 19, 367, :ndate), chr(0)) as EXPERT,"+ 
"	              DECODE(NVL(SUBJ_COUNTRY, CHR(1)), CHR(1), CHR(0), SUBJ_COUNTRY) AS SUBJ_COUNTRY,                                                       "+
"                     DEAL_DT,                                                                                                                               "+
"	              PART_1_EX_DT,                                                                                                                          "+
"                     PART_2_EX_DT,                                                                                                                          "+
"	              IS_LIQ_NETTING,                                                                                                                        "+
"                     IS_CLC_NETTING,                                                                                                                        "+
"	              nvl(IS_REPOSITORY,chr(0)) IS_REPOSITORY,                                                                                               "+
"		      DECODE(NVL(ACCOUNT_BOND, CHR(1)), CHR(1), CHR(0), ACCOUNT_BOND) AS ACCOUNT_BOND,                                                       "+
"	              nvl(ISSUE_NAME,chr(0)) ISSUE_NAME,                                                                                                     "+ 
"                     nvl(ISSUER_RATING_SP, chr(0)),                                                                                                         "+
"	              nvl(ISSUER_RATING_MOODYS,chr(0)),                                                                                                      "+  
"                     nvl(ISSUER_RATING_FITCH,chr(0)),                                                                                                       "+
"	              nvl(ISSUER_RATING_3453U_SP,chr(0)),                                                                                                    "+  
"                     nvl(ISSUER_RATING_3453U_MOODYS,chr(0)),                                                                                                "+
"	              nvl(ISSUER_RATING_3453U_FITCH,chr(0)),                                                                                                 "+  
"                     nvl(ISSUE_RATING_SP,chr(0)),                                                                                                           "+
"	              nvl(ISSUE_RATING_MOODYS,chr(0)),                                                                                                       "+  
"                     nvl(ISSUE_RATING_FITCH,chr(0)),                                                                                                        "+
"	              nvl(ISSUE_RATING_3453U_SP,chr(0)),                                                                                                     "+  
"                     nvl(ISSUE_RATING_3453U_MOODYS,chr(0)),                                                                                                 "+
"	              nvl(ISSUE_RATING_3453U_FITCH,chr(0)),                                                                                                  "+ 
"                     nvl(ISSUER_RATING_AKRA,chr(0)),                                                                                                        "+
"	              nvl(ISSUE_RATING_AKRA,chr(0)),                                                                                                         "+ 
"                     nvl(ISSUER_RATING_EXPERT,chr(0)),                                                                                                      "+
"	              nvl(ISSUE_RATING_EXPERT,chr(0)),                                                                                                       "+
"	              decode( DEPLOY_DT, to_date ('01010001', 'ddmmyyyy'), chr(0), to_char(deploy_dt)),                                                      "+
"	              ISSUER_COUNTRY,                                                                                                                        "+ 
"                     DECODE(NVL(ISIN, CHR(1)), CHR(1), CHR(0), ISIN) AS ISIN,                                                                               "+
"	              QUANTITY,                                                                                                                              "+ 
"                     BALANCE_PRICE,                                                                                                                         "+
"	              nvl(OVERPRICE,0),                                                                                                                      "+
"                     DECODE(NVL(ACCOUNT_MONEY, CHR(1)), CHR(1), CHR(0), ACCOUNT_MONEY) AS ACCOUNT_MONEY,                                                    "+
"	              AMOUNT_MONEY,                                                                                                                          "+
"        	      DECODE(NVL(ACCOUNT_RERC, CHR(1)), CHR(1), CHR(0), ACCOUNT_RERC) AS ACCOUNT_RERC,                                                       "+
"	              AMOUNT_PERC,                                                                                                                           "+ 
"                     'Да',                                                                                                                                  "+
"	              case when exists (select 1 from dpartyown_dbt where t_partykind = 2                                                                    "+
"	              and t_partyid = (select t_issuer from dfininstr_dbt where t_fiid =  (select t_pfi from ddl_tick_dbt where t_dealcode = deal_number and t_bofficekind = 101)))  "+                                         
"	              then 'Да'                                                                                                                              "+
"	              else chr(0) end as BankIs, /* сюда банк(эмитент*/                                                                                      "+
"	              'Да',                                                                                                                                  "+ 
"                     'Да',                                                                                                                                  "+
"	              NVL (IS_SUBORD_BOND, CHR (0)),                                                                                                         "+
"	              ISSUER,                                                                                                                                "+
"	              NVL (IS_USE_FOR_INDEX, CHR (0)),                                                                                                       "+
"                     rate                                                                                                                                   "+
"	         FROM trshb_repo_pkl_2chd                                                                                                                    "+
"	        WHERE report_dt = :ndate                                                                                                                     "+
"	        order by account_bond, issue_name                                                                                                            ";
	cmd = RSDCommand(cmd);                                                                                                              
       cmd.AddParam("ndate", RSDBP_IN, DateIn);
	rs = RsdRecordset(cmd);                                                                                                                                     
	while (rs.movenext)                                                                                                                                         
		obcsvfile.AddCell(rs.value(0));                                                                                                                     
		obcsvfile.AddCell(rs.value(1));                                                                                                                     
		obcsvfile.AddCell(rs.value(2));
		obcsvfile.AddCell(rs.value(3));
		obcsvfile.AddCell(rs.value(4));
		obcsvfile.AddCell(rs.value(5));
		obcsvfile.AddCell(rs.value(6));
		obcsvfile.AddCell(rs.value(7));
		obcsvfile.AddCell(rs.value(8));
		obcsvfile.AddCell(date(rs.value(9)));
		obcsvfile.AddCell(date(rs.value(10)));
		obcsvfile.AddCell(date(rs.value(11)));
		obcsvfile.AddCell(rs.value(12));
		obcsvfile.AddCell(rs.value(13));
		obcsvfile.AddCell(rs.value(14));
		obcsvfile.AddCell(rs.value(15));
		obcsvfile.AddCell(rs.value(16));
		obcsvfile.AddCell(rs.value(17));
		obcsvfile.AddCell(rs.value(18));
		obcsvfile.AddCell(rs.value(19));
		obcsvfile.AddCell(rs.value(20));
		obcsvfile.AddCell(rs.value(21));
		obcsvfile.AddCell(rs.value(22));
		obcsvfile.AddCell(rs.value(23));
		obcsvfile.AddCell(rs.value(24));
		obcsvfile.AddCell(rs.value(25));
		obcsvfile.AddCell(rs.value(26));
		obcsvfile.AddCell(rs.value(27));
		obcsvfile.AddCell(rs.value(28));
		obcsvfile.AddCell(rs.value(29));
		obcsvfile.AddCell(rs.value(30));
		obcsvfile.AddCell(rs.value(31));
		obcsvfile.AddCell(rs.value(32));
		obcsvfile.AddCell(rs.value(33));
		obcsvfile.AddCell(rs.value(34));
		obcsvfile.AddCell(rs.value(35));
		obcsvfile.AddCell(rs.value(36));
		obcsvfile.AddCell(rs.value(37));
		obcsvfile.AddCell(rs.value(38));
		obcsvfile.AddCell(rs.value(39));
		obcsvfile.AddCell(rs.value(40));
		obcsvfile.AddCell(rs.value(41));
		obcsvfile.AddCell(rs.value(42));
		obcsvfile.AddCell(rs.value(43));
		obcsvfile.AddCell(rs.value(44));
		obcsvfile.AddCell(rs.value(45));
		obcsvfile.AddCell(rs.value(46));
		obcsvfile.AddCell(rs.value(47));
		obcsvfile.AddCell(rs.value(48));
		obcsvfile.AddCell(rs.value(49));
		obcsvfile.AddCell(rs.value(50));
		obcsvfile.addrow();
	end;
	Obcsvfile.fileclose();

	Obtemp.SetValue_NameCell("Date", DateIn);
	Obtemp.SetValue_NameCell("bodyline");
	obtable.FillTabelFromCSV(string(UserNumber)+"repo.txt",NULL,";");
       var dt = String({curdate});
       dt = StrSubst(dt, " ", "0");
       dt = StrSubst(dt, ".", "");
       dt = "Report_657_3_Repo" + dt;
	Obtemp.SaveAsTemplate(dt,TRUE);
	RemProgress(8);	
end;

macro Chekdata(DateIn: date)
   begaction(2000, "Формирование данных");
   ExecMacroFile("SOFR_PKL_Start.mac", "Repo", DateIn);
   endaction(200);
   MakeReport(DateIn);
end;


var dateout = {curdate};
var stat = GetDate(dateout, "Введите дату отчета");
if (stat);
ChekData(dateout);
else 
exit(1);
end;
exit(1);