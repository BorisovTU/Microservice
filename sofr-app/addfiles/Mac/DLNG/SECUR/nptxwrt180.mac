/**
  @file   mac\dlng\secur\nptxwrt180.mac
  @brief  Шаг 180. Исполнение платежа
  # changelog
  |date       |author        |tasks        |note
  |-----------|--------------|-------------|----------------------------
  |2025.10.13 |Васильев Н.А. |AVT_BOSS-104 |
*/
import oralib, "dlquery.mac", "mmlib.mac";
import "Refill_CreatePayment.mac", "cblogger2.mac";
import Refill_Class;
import InsCarryDoc;

private var itlog = NewLogger(c_logger.IT_LOG_TYPE, "nptxwrt180");

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro getId(ID_Operation, FDoc)
   var cmd = DL_RSDCommand("SELECT to_number(TRIM(t_documentid)) as id FROM doproper_dbt p  JOIN dnptxop_dbt n " +
                           "ON n.t_id = TO_NUMBER(TRIM(p.t_documentid)) " +
                           "WHERE p.t_id_operation = ?  AND p.t_dockind = ?;");
   cmd.AddParam(ID_Operation);
   cmd.AddParam(FDoc);
   var DataSet = cmd.Execute();
   if (DataSet.moveNext())
      return SQL_ConvTypeInteger(DataSet.id);
   end;
end;

MACRO ExecuteStep(kind_oper, DocKind, FDoc, ID_Operation, ID_Step)
   var errmsg, id;
   var sql = String("SELECT T_PAYMENTID FROM unptxop_payment_link_dbt WHERE T_NPTXOPID = " + getId(ID_Operation, FDoc) + ";");
   var ds = TRsbDataSet(sql); 
   ds.movenext();
   id = ds.paymentid;
   if(RunRefillPayment(errmsg, id) == false)
      if( {oper} != 9997)
         MsgBox(errmsg);
      end;
         return 1;
   end; 
     if( not InsertOprStatus(46073, 1)) //Установить ВН = Открыт
      return Error( "Ошибка при установке статуса вида \"Установить ВН\" операции" );        
  end;
      if( not InsertOprStatus(484131, 4)) //Установить ИРК = Закрытие
         return Error( "Ошибка при установке статуса вида \"Установить ИРК \" операции" );
      end;
 return 0;
END;