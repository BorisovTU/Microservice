/*
$Name:        uniavr50.mac
$Module:      Ценные бумаги
$Description: Операция конвертации ц/б. Шаг "Проводки по зачислению нового выпуска"
*/
import InsCarryDoc, "sp_car.mac", RsbDataSet, "sp_cars.mac", qracctools;

private record CredCatAcc(account);
private record NewAcnt(account);

private var UniAvrObj = NULL;

private macro it_log(text)
  var sql = "begin it_log.log(:1); end;";
  var cmd = RSDCommand(sql);
  cmd.AddParam("",RSDBP_IN,text);
  cmd.execute;
end;


private macro ВыполнитьПроводкиДляНепоставленных(comm, Doc)
  var Query, DataSet, FD_Deal, FD_Deal_New, Rest, N, CatCode, CarSum, CarFIID, CurNumber = 0;
  file   mcconacc( mcconacc );

  /*Если будем открывать/закрывать счета - нужно для сохранения инфы для протокола*/
  Query = RSDCommand(
                     " SELECT NVL(MAX(t_AccDocID), 0) MaxNumber " + 
                     "   FROM dmcconacc_dbt " + 
                     "  WHERE T_DOCKIND = ? " +
                     "    AND T_DOCID = ? "
                    );

  Query.addParam( "", RSDBP_IN, comm.DocKind );
  Query.addParam( "", RSDBP_IN, comm.DocumentID );
  Query.execute();

  DataSet = TRsbDataSet(Query);

  if ((not DataSet.MoveNext()) or (DataSet.MaxNumber < 1) )
     CurNumber = 0;
  else
     CurNumber = DataSet.MaxNumber;
  end;

  Query = RSDCommand(
                     " SELECT Count(1) v_Count " + 
                     "   FROM dscdlfi_dbt " + 
                     "  WHERE T_DEALKIND = ? " +
                     "    AND T_DEALID   = ? "
                    );

  Query.addParam( "", RSDBP_IN, comm.DocKind );
  Query.addParam( "", RSDBP_IN, comm.DocumentID );
  Query.execute();

  DataSet = TRsbDataSet(Query);

  if ((not DataSet.MoveNext()) or (DataSet.v_Count < 1) )
     N = 0;
  else
     N = DataSet.v_Count;
  end;

  if ((comm.Flag1 == SET_CHAR) and (N == 1) and (comm.BeginDate != comm.EndDate))

     Query = DL_RSDCommand(
                          " SELECT s.t_DealID, s.t_SumID, pmwr.t_NewFIID, pmwr.t_NewCost, pmwr.t_OldCost " + 
                          "   FROM dscdlpmwr_dbt pmwr, dpmwrtsum_dbt s " + 
                          "  WHERE pmwr.T_DEALKIND   = ?  " +
                          "    AND pmwr.T_DEALID     = ?  " +
                          "    AND pmwr.T_STATE      = " + SCDLPMWR_STATE_NOT_READY + 
                          "    AND pmwr.T_PARTY      = -1 " +
                          "    AND s.T_DEPARTMENT    = ?  " +
                          "    AND pmwr.T_SUMID      = s.T_SUMID " +
                          "    AND NOT EXISTS(SELECT 1 " +
                          "                     FROM DSCUNIAVRSTOBJ_DBT o "+
                          "                    WHERE o.t_ID_Operation = ? "+
                          "                      AND o.t_IsWrt = 0 "+
                          "                      AND o.t_ObjKind = "+ UniAvrObj.OBJKIND_SUMID +
                          "                      AND o.t_ObjID = s.t_SumID"+
                          "                      AND o.t_FIID = pmwr.t_NewFIID"+
                          "                  )"
                         );

     Query.addParam(comm.DocKind );
     Query.addParam(comm.DocumentID );
     Query.addParam(comm.Division );
     Query.addParam(UniAvrObj.GetID_Operation());

     DataSet = Query.execute();
     while (DataSet.MoveNext())
        if(UniAvrObj.NeedBreak())
          UniAvrObj.SetRecurseStep();
          break;
        else
          UniAvrObj.AddRec(UniAvrObj.OBJKIND_SUMID, DataSet.SumID, DataSet.NewFIID);
        end;
        
        FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );
        if ((FD_Deal.ExistAvance and (not ТОЗакрыто(FD_Deal.GetRQ(DLRQ_TYPE_AVANCE)))) or 
            (not FD_Deal.ExistAvance and (not ТОЗакрыто(FD_Deal.GetRQ(DLRQ_TYPE_PAYMENT)))) or 
            (FD_Deal.GetRQ(DLRQ_TYPE_DELIVERY).rec.State == DLRQ_STATE_OVERDUE)
           )
        else
           FD_Deal_New = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

           FD_Deal_New.v_BaseFIID = DataSet.NewFIID;

           if (IsBuy(FD_Deal_New.Group))
              CatCode = "+Форвард, расчеты";
           else
              CatCode = "-Форвард, расчеты";
           end;

           if( ( not FD_Deal_New.IsExistAccount( CatCode, null, null, FIROLE_SRCA, NewAcnt, null, comm.EndDate ) ) AND 
               ( not FD_Deal_New.OpenAccount( CatCode, null, null, FIROLE_SRCA, NewAcnt, comm.EndDate ) ))
              return 1;
           else
              CurNumber = CurNumber + 1;
              // сохраняем для протокола
              ClearRecord(mcconacc);
              mcconacc.DocKind  = comm.DocKind;
              mcconacc.DocID    = comm.DocumentID;
              mcconacc.AccDocID = CurNumber;
              mcconacc.NewAccount = NewAcnt.Account;
              mcconacc.IsOpen   = SET_CHAR;

              OprUpdateMCCONACC( mcconacc );
           end;

           CarSum = FD_Deal.dl_leg.rec.TotalCost;
           if( IsRelativePrice( FD_Deal.tick.rec, FD_Deal.dl_leg.rec ) )
              CarFIID = FD_Deal.FaceFIID();
           else
              CarFIID = FD_Deal.dl_leg.rec.CFI;
           end;

           if (IsSale(FD_Deal_New.Group))
              if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                     "-Расчеты, ГО", NewAcnt, /* КатегДеб , КатегКредит*/
                     comm.EndDate,                /* Дата */
                     1,                           /* Глава */
                     CarFIID,                     /* Валюта */
                     CarSum,                      /* Сумма */
                     Doc,                         /* Документ */
                     INPCARRY,                    /* Result_Carry */
                     " 1",                        /* Kind_Oper */
                     "",                          /* Numb_Document */
                     "Перенос остатка лицевого счета",
                     null,
                     null, null, 
                     FD_Deal.GetPayFIID(), FD_Deal.GetPayFIID()
                    ) 
                )
                  return 1;
              end;
           else
              if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                     NewAcnt, "+Расчеты, ГО", /* КатегДеб , КатегКредит*/
                     comm.EndDate,                /* Дата */
                     1,                           /* Глава */
                     CarFIID,                     /* Валюта */
                     CarSum,                      /* Сумма */
                     Doc,                         /* Документ */
                     INPCARRY,                    /* Result_Carry */
                     " 1",                        /* Kind_Oper */
                     "",                          /* Numb_Document */
                     "Перенос остатка лицевого счета",
                     null,
                     null, null, 
                     FD_Deal.GetPayFIID(), FD_Deal.GetPayFIID()
                    ) 
                )
                  return 1;
              end;
           end;
        end;
     end;
  end;

  return 0;
end;

private macro ВыполнитьПроводкиПереноса(comm, Doc, ID_Operation, ID_Step)
  var query, cmd, DataSet;
  var oldAcc = TRecHandler("account.dbt");
  var newAcc = TRecHandler("account.dbt");
  var CarrySum = $0;
  var FDold = NULL, FDnew = NULL;
  var CatOverPlusAcc = "", CatOverMinusAcc = "";
  var newCatRes = "";
  var oldRest = $0, newRest = $0;
  var CatCode = "";
  var IsBond = FI_IsBond(comm.FIID);

  query =   " select DISTINCT l.t_Portfolio, l.t_FIID "
          + "   from dpmwrtsum_dbt l, dpmwrtlnk_dbt lnk "
          + "  where lnk.t_ID_Operation = ? "
          + "    and l.t_Source = lnk.t_BuyID "
          + "    and NOT EXISTS(SELECT 1 "
          + "                     FROM DSCUNIAVRSTOBJ_DBT o "
          + "                    WHERE o.t_ID_Operation = lnk.t_ID_Operation "
          + "                      AND o.t_IsWrt        = 0 "
          + "                      AND o.t_ObjKind      = " + UniAvrObj.OBJKIND_PORTF
          + "                      AND o.t_ObjID        = l.t_Portfolio "
          + "                      AND o.t_FIID         = l.t_FIID "
          + "                  )";  

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ID_Operation);

  DataSet = cmd.Execute();

  while(DataSet.moveNext())
    if(UniAvrObj.NeedBreak())
      UniAvrObj.SetRecurseStep();
      break;
    else
      UniAvrObj.AddRec(UniAvrObj.OBJKIND_PORTF, DataSet.Portfolio, DataSet.FIID);
    end;
    
    FDold = SPFirstDocFI(DLDOC_ISSUE, comm.FIID, comm.FIID, DataSet.Portfolio, {OurBank}, null, null, null);
    FDnew = SPFirstDocFI(DLDOC_ISSUE, DataSet.FIID, DataSet.FIID, DataSet.Portfolio, {OurBank}, null, null, null);

    CatCode = "Наш портфель ц/б";
    if(DataSet.Portfolio == KINDPORT_CONTR)
      CatCode = "Наш портфель ПКУ, ц/б";
    end;

    if( FDold.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, null, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          CatCode, oldAcc, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос по счету вложений", /* Ground */
                                          null, 
                                          GetFIRoleByPortfolio(DataSet.Portfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FDold.IsExistAccount("Уплаченный НКД", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, null, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          "Уплаченный НКД", oldAcc, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос по счету уплаченных процентов", /* Ground */
                                          null, 
                                          GetFIRoleByPortfolio(DataSet.Portfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FDold.IsExistAccount("Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, true), oldAcc, null, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          "Начисл.ПДД, ц/б", oldAcc, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос по счету начисленных процентов", /* Ground */
                                          null, 
                                          GetFIRoleByPortfolio(DataSet.Portfolio, false, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FDold.IsExistAccount("Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio, true), oldAcc, null, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          "Начисл.ПДД, ц/б", oldAcc, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос по счету дисконта", /* Ground */
                                          null, 
                                          GetFIRoleByPortfolio(DataSet.Portfolio, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FDold.IsExistAccount("Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(DataSet.Portfolio), oldAcc, null, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          "Премия, ц/б", oldAcc, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос по счету премии", /* Ground */
                                          null, 
                                          GetFIRoleByPortfolioBonus(DataSet.Portfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FDold.IsExistAccount("+Корректировка, ц/б", null, true, GetFIRoleByPortfolioBonus(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          "+Корректировка, ц/б", oldAcc, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос по счетам корректировок стоимости", /* Ground */
                                          null, 
                                          GetFIRoleByPortfolio(DataSet.Portfolio),
                                          null,null,null,null,null,null,null,null,null,null,null,null,null,
                                          MC_PAIRACCMODE_MANUAL
                                         ))
            return 1;
        end;
      end;
    end;

    if( FDold.IsExistAccount("-Корректировка, ц/б", null, true, GetFIRoleByPortfolioBonus(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          oldAcc, "-Корректировка, ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос по счетам корректировок стоимости", /* Ground */
                                          null, null,
                                          GetFIRoleByPortfolio(DataSet.Portfolio),
                                          null,null,null,null,null,null,null,null,null,null,null,null,
                                          null, MC_PAIRACCMODE_MANUAL
                                         ))
            return 1;
        end;
      end;
    end;

    if(DataSet.Portfolio == KINDPORT_SSPU)
      CatOverPlusAcc  = IIF(ПарностьСчетовПереоценки(), "+Переоценка, ц/б ССПУ_ЦБ", "+Переоценка, ц/б");
      CatOverMinusAcc = IIF(ПарностьСчетовПереоценки(), "-Переоценка, ц/б ССПУ_ЦБ", "-Переоценка, ц/б");

      //Если у доп. выпуска остаток на счете +Переоценка 
      if( FDold.IsExistAccount(CatOverPlusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
        oldRest = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

        if(OldRest > 0)
          //Если у основного выпуска остаток на счете -Переоценка 
          if( (FDnew.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
              ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
            )

            if(newRest >= oldRest)
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                newAcc, oldAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки" /* Ground */
                                               ))
                  return 1;
              end;
            else
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                newAcc, oldAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                newAcc.rec.Code_Currency,    /* Валюта */
                                                newRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки" /* Ground */
                                               ))
                  return 1;
              end;

              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                CatOverPlusAcc, oldAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                newAcc.rec.Code_Currency,    /* Валюта */
                                                (oldRest-newRest),           /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки", /* Ground */
                                                null, 
                                                GetFIRoleByPortfolio(DataSet.Portfolio),
                                                null,null,null,null,null,null,null,null,null,null,null,null,null,
                                                MC_PAIRACCMODE_MANUAL
                                               ))
                  return 1;
              end;
            end;

          else
            if(not ПроводкаПоКатегориямУчета( FDnew, 
                                              CatOverPlusAcc, oldAcc, 
                                              comm.CommDate,               /* Дата */
                                              1,                           /* Глава */
                                              oldAcc.rec.Code_Currency,    /* Валюта */
                                              oldRest,                     /* Сумма */
                                              Doc,                         /* Документ */
                                              INPCARRY,                    /* Result_Carry */
                                              " 1",                        /* Kind_Oper */
                                              comm.CommCode,               /* Numb_Document */
                                              "Перенос по счетам переоценки", /* Ground */
                                              null, 
                                              GetFIRoleByPortfolio(DataSet.Portfolio),
                                              null,null,null,null,null,null,null,null,null,null,null,null,null,
                                              MC_PAIRACCMODE_MANUAL
                                             ))
                return 1;
            end;
          end;
        end;

      end;

      //Если у доп. выпуска остаток на счете -Переоценка 
      if( FDold.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
        oldRest = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

        if(OldRest > 0)
          //Если у основного выпуска остаток на счете +Переоценка 
          if( (FDnew.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
              ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
            )

            if(newRest >= oldRest)
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                oldAcc, newAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки" /* Ground */
                                               ))
                  return 1;
              end;
            else
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                oldAcc, newAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                newAcc.rec.Code_Currency,    /* Валюта */
                                                newRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки" /* Ground */
                                               ))
                  return 1;
              end;

              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                oldAcc, CatOverMinusAcc,  
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                newAcc.rec.Code_Currency,    /* Валюта */
                                                (oldRest-newRest),           /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки", /* Ground */
                                                null,null, 
                                                GetFIRoleByPortfolio(DataSet.Portfolio),
                                                null,null,null,null,null,null,null,null,null,null,null,null,
                                                null,MC_PAIRACCMODE_MANUAL
                                               ))
                  return 1;
              end;
            end;

          else
            if(not ПроводкаПоКатегориямУчета( FDnew, 
                                              oldAcc, CatOverMinusAcc,  
                                              comm.CommDate,               /* Дата */
                                              1,                           /* Глава */
                                              oldAcc.rec.Code_Currency,    /* Валюта */
                                              oldRest,                     /* Сумма */
                                              Doc,                         /* Документ */
                                              INPCARRY,                    /* Result_Carry */
                                              " 1",                        /* Kind_Oper */
                                              comm.CommCode,               /* Numb_Document */
                                              "Перенос по счетам переоценки", /* Ground */
                                              null,null, 
                                              GetFIRoleByPortfolio(DataSet.Portfolio),
                                              null,null,null,null,null,null,null,null,null,null,null,null,
                                              null,MC_PAIRACCMODE_MANUAL
                                             ))
                return 1;
            end;
          end;
        end;
      end;

    elif(DataSet.Portfolio == KINDPORT_SSSD)
      var oldPODK = TRecHandler("account.dbt");

      if(ПарностьСчетовПереоценки() == false)
        CatOverPlusAcc  = "+Переоценка, ц/б";
        CatOverMinusAcc = "-Переоценка, ц/б";

        //Если у доп. выпуска остаток на счете +Переоценка 
        if( FDold.IsExistAccount(CatOverPlusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
          oldRest = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

          if(OldRest > 0)

            //Если у основного выпуска остаток на счете -Переоценка 
            if( (FDnew.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
              )

              if(newRest >= oldRest)
                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  newAcc, oldAcc, 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  oldRest,                     /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки" /* Ground */
                                                 ))
                    return 1;
                end;

              else
                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  newAcc, oldAcc, 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  newAcc.rec.Code_Currency,    /* Валюта */
                                                  newRest,                     /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки" /* Ground */
                                                 ))
                    return 1;
                end;

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  CatOverPlusAcc, oldAcc, 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  newAcc.rec.Code_Currency,    /* Валюта */
                                                  (oldRest-newRest),           /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,null,
                                                  MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;

              if((FDold.IsExistAccount("+ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  oldPODK, "-ПО ДК 2014", 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null,null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  null,MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;

            else
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                CatOverPlusAcc, oldAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки", /* Ground */
                                                null, 
                                                GetFIRoleByPortfolio(DataSet.Portfolio),
                                                null,null,null,null,null,null,null,null,null,null,null,null,null,
                                                MC_PAIRACCMODE_MANUAL
                                               ))
                  return 1;
              end;

              if((FDold.IsExistAccount("+ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  oldPODK, "+ПО ДК 2014", 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null,null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  null,MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;
            end;
          end;

        end;

        //Если у доп. выпуска остаток на счете -Переоценка 
        if( FDold.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
          oldRest = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

          if(OldRest > 0)
            //Если у основного выпуска остаток на счете +Переоценка 
            if( (FDnew.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
              )

              if(newRest >= oldRest)
                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  oldAcc, newAcc, 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  oldRest,                     /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки" /* Ground */
                                                 ))
                    return 1;
                end;
              else
                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  oldAcc, newAcc, 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  newAcc.rec.Code_Currency,    /* Валюта */
                                                  newRest,                     /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки" /* Ground */
                                                 ))
                    return 1;
                end;

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  oldAcc, CatOverMinusAcc,  
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  newAcc.rec.Code_Currency,    /* Валюта */
                                                  (oldRest-newRest),           /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null,null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  null,MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;

              if((FDold.IsExistAccount("-ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  "+ПО ДК 2014", oldPODK,  
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;

            else
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                oldAcc, CatOverMinusAcc,  
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки", /* Ground */
                                                null,null, 
                                                GetFIRoleByPortfolio(DataSet.Portfolio),
                                                null,null,null,null,null,null,null,null,null,null,null,null,
                                                null,MC_PAIRACCMODE_MANUAL
                                               ))
                  return 1;
              end;

              if((FDold.IsExistAccount("-ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  "-ПО ДК 2014", oldPODK,  
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;
            end;
          end;
        end;
      else //ПарностьСчетовПереоценки() == true
        CatOverPlusAcc  = "+Переоценка, ц/б СССД_ЦБ";
        CatOverMinusAcc = "-Переоценка, ц/б СССД_ЦБ";

        //Если у доп. выпуска остаток на счете +Переоценка 
        if( FDold.IsExistAccount(CatOverPlusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
          oldRest = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

          if(OldRest > 0)

            //Если у основного выпуска остаток на счете -Переоценка 
            if( (FDnew.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
              )

              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                newAcc, oldAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки" /* Ground */
                                               ))
                  return 1;
              end;

              if((FDold.IsExistAccount("+ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  oldPODK, "-ПО ДК 2014", 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null,null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  null,MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;

            else
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                CatOverPlusAcc, oldAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки", /* Ground */
                                                null, 
                                                GetFIRoleByPortfolio(DataSet.Portfolio),
                                                null,null,null,null,null,null,null,null,null,null,null,null,null,
                                                MC_PAIRACCMODE_MANUAL
                                               ))
                  return 1;
              end;

              if((FDold.IsExistAccount("+ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  oldPODK, "+ПО ДК 2014", 
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null,null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  null,MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;
            end;
          end;

        end;

        //Если у доп. выпуска остаток на счете -Переоценка 
        if( FDold.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
          oldRest = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

          if(OldRest > 0)
            //Если у основного выпуска остаток на счете +Переоценка 
            if( (FDnew.IsExistAccount(CatOverMinusAcc, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
              )

              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                oldAcc, newAcc, 
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки" /* Ground */
                                               ))
                  return 1;
              end;
              

              if((FDold.IsExistAccount("-ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  "+ПО ДК 2014", oldPODK,  
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;

            else
              if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                oldAcc, CatOverMinusAcc,  
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                oldAcc.rec.Code_Currency,    /* Валюта */
                                                oldRest,                     /* Сумма */
                                                Doc,                         /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос по счетам переоценки", /* Ground */
                                                null,null, 
                                                GetFIRoleByPortfolio(DataSet.Portfolio),
                                                null,null,null,null,null,null,null,null,null,null,null,null,
                                                null,MC_PAIRACCMODE_MANUAL
                                               ))
                  return 1;
              end;

              if((FDold.IsExistAccount("-ПО ДК 2014", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldPODK, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
                 ((CarrySum = abs(GetRestAccount(oldPODK.rec, comm.CommDate))) > 0)
                )

                if(not ПроводкаПоКатегориямУчета( FDnew, 
                                                  "-ПО ДК 2014", oldPODK,  
                                                  comm.CommDate,               /* Дата */
                                                  1,                           /* Глава */
                                                  oldAcc.rec.Code_Currency,    /* Валюта */
                                                  CarrySum,                    /* Сумма */
                                                  Doc,                         /* Документ */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  comm.CommCode,               /* Numb_Document */
                                                  "Перенос по счетам переоценки", /* Ground */
                                                  null, 
                                                  GetFIRoleByPortfolio(DataSet.Portfolio),
                                                  null,null,null,null,null,null,null,null,null,null,null,null,
                                                  MC_PAIRACCMODE_MANUAL
                                                 ))
                    return 1;
                end;
              end;
            end;
          end;
        end;

      end;
    end;


    if( FDold.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, null, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          oldAcc, "Резерв ц/б",
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос РВП", /* Ground */
                                          null, null, 
                                          GetFIRoleByPortfolio(DataSet.Portfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FDold.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, true), oldAcc, null, comm.CommDate) )
      CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FDnew, 
                                          oldAcc, "Резерв ц/б",
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          oldAcc.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос РВП", /* Ground */
                                          null, null,
                                          GetFIRoleByPortfolio(DataSet.Portfolio, false, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if((DataSet.Portfolio == KINDPORT_SSSD) and (IsBond == false))
      if( FDold.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
        CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

        if(CarrySum > 0)
          if(not ПроводкаПоКатегориямУчета( FDnew, 
                                            "+Кор_Резерв, ЦБ", oldAcc,   
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            oldAcc.rec.Code_Currency,    /* Валюта */
                                            CarrySum,                    /* Сумма */
                                            Doc,                         /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перенос РВП",               /* Ground */
                                            null, 
                                            GetFIRoleByPortfolio(DataSet.Portfolio),
                                            null,null,null,null,null,null,null,null,null,null,null,null,null,
                                            MC_PAIRACCMODE_MANUAL
                                           ))
              return 1;
          end;
        end;
      end;
    end;

    if(isBond == true)

      if( FDold.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
        CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

        if(CarrySum > 0)
          newCatRes = "-Кор_Резерв, ЦБ";
          if((FDold.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
             ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
            )
            newCatRes = "+Кор_Резерв, ЦБ";
          end;

          if(not ПроводкаПоКатегориямУчета( FDnew, 
                                            oldAcc, newCatRes,
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            oldAcc.rec.Code_Currency,    /* Валюта */
                                            CarrySum,                    /* Сумма */
                                            Doc,                         /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перенос ОР", /* Ground */
                                            null,null, 
                                            GetFIRoleByPortfolio(DataSet.Portfolio),
                                            null,null,null,null,null,null,null,null,null,null,null,null,
                                            null, MC_PAIRACCMODE_MANUAL
                                           ))
              return 1;
          end;
        end;
      end;

      if( FDold.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), oldAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
        CarrySum = abs(GetRestAccount(oldAcc.rec, comm.CommDate));

        if(CarrySum > 0)
          newCatRes = "+Кор_Резерв, ЦБ";
          if((FDold.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), newAcc, MC_PAIRACCMODE_MANUAL, comm.CommDate)) and
             ((newRest = abs(GetRestAccount(newAcc.rec, comm.CommDate))) > 0)
            )
            newCatRes = "-Кор_Резерв, ЦБ";
          end;

          if(not ПроводкаПоКатегориямУчета( FDnew, 
                                            newCatRes, oldAcc, 
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            oldAcc.rec.Code_Currency,    /* Валюта */
                                            CarrySum,                    /* Сумма */
                                            Doc,                         /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перенос ОР", /* Ground */
                                            null, 
                                            GetFIRoleByPortfolio(DataSet.Portfolio),
                                            null,null,null,null,null,null,null,null,null,null,null,null,null,
                                            MC_PAIRACCMODE_MANUAL
                                           ))
              return 1;
          end;
        end;
      end;
      
    end;

  end;

  return 0;
end;

private macro ВыполнитьПроводкиЗачисления(comm, Doc)
  private record OldAcnt(account);
  var    FD, FD_Old, dat, cmd, DataSet, cmd2, Query2, GroupID, SumCost;
  var OpenOldAcnt:bool = false;

  FD_Old = SPFirstDocDLCOMMGlobal(comm);

  //Для всех scdlfi F по операции
  cmd = DL_RSDCommand("SELECT s.* " +
                      "  FROM dscdlfi_dbt s" +
                      " WHERE s.t_DealKind  = ? " +
                      "   AND s.t_DealID    = ? " +
                      "   AND NOT EXISTS(SELECT 1 "+
                      "                    FROM DSCUNIAVRSTOBJ_DBT o "+
                      "                   WHERE o.t_ID_Operation = ? "+
                      "                     AND o.t_IsWrt = 0 "+
                      "                     AND o.t_ObjKind = "+ UniAvrObj.OBJKIND_SCDLFI +
                      "                     AND o.t_ObjID = s.t_ID"+
                      "                     AND o.t_FIID = s.t_NewFIID"+
                      "                 )"+
                      " ORDER BY s.t_Num  " );

  cmd.addParam(comm.DocKind );
  cmd.addParam(comm.DocumentID );
  cmd.addParam(UniAvrObj.GetID_Operation());
  DataSet = cmd.execute();

  while( DataSet.movenext() )
     if(UniAvrObj.NeedBreak())
       UniAvrObj.SetRecurseStep();
       break;
     else
       UniAvrObj.AddRec(UniAvrObj.OBJKIND_SCDLFI, DataSet.ID, DataSet.NewFIID);
     end;

     FD = SPFirstDocScdlfiByGlobalConvert(DL_SCDLFI, DataSet.ID);
     dat = comm.EndDate;

     cmd2 = RSDCommand("SELECT NVL(SUM(t_Cost + t_NKDAmount), 0) Cost, NVL(SUM(t_BegBonus), 0) BegBonus, t_GroupID GroupID, " +
                       "       NVL(SUM(t_NKDAmount), 0) NKDAmount " +
                       "  FROM v_scwrthistex " +
                       " WHERE t_DocKind  = ? AND " +
                       "       t_DocID    = ? AND " +
                       "       t_Party    = -1 AND " +
                       "       t_Buy_Sale = ? AND " +
                       "       t_Action   = ? AND " +
                       "       t_Instance = 0 AND " +
                       "       t_FIID     = ?     " +
                       " GROUP BY t_GroupID " );

     cmd2.addParam( "", RSDBP_IN, comm.DocKind );
     cmd2.addParam( "", RSDBP_IN, comm.DocumentID );
     cmd2.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
     cmd2.addParam( "", RSDBP_IN, PM_WRTSUM_UPDTMODE_GLOBALIN );
     cmd2.addParam( "", RSDBP_IN, DataSet.NewFIID );
     cmd2.execute();

     Query2 = TRsbDataSet(cmd2);
     while( Query2.movenext() )
        GroupID = Query2.GroupID;

        if( ОтдельныйУчетУплНКД() )
           SumCost = Query2.Cost - Query2.NKDAmount;
        else
           SumCost = Query2.Cost;
        end;

        SumCost = SumCost - Query2.BegBonus;

        if (comm.BeginDate == comm.EndDate)
           if( not OpenOldAcnt )
              if( not FD_Old.IsExistAccount( "Реализация, ц/б", null, true, null, OldAcnt, null, comm.EndDate, NATCUR ) )
                 if( not FD_Old.OpenAccount("Реализация, ц/б", null, null, null, OldAcnt, comm.EndDate, NATCUR) )
                    return 1;
                 end;
              end;
              OpenOldAcnt = true;
           end;
           var ConvSum = SumCost;
           if( FD.GetAccFIID("Наш портфель ц/б") != FD.FaceFIID())
              SmartConvertSum(ConvSum, money(ConvSum), dat, FD.FaceFIID(), FD.GetAccFIID("Наш портфель ц/б"));
           end;
           if(not ПроводкаПоКатегориямУчета( FD, 
                  "Наш портфель ц/б", OldAcnt, /* КатегДеб , КатегКредит*/
                  dat,                         /* Дата */
                  1,                           /* Глава */
                  FD.GetAccFIID("Наш портфель ц/б"),/* Валюта */
                  ConvSum,                     /* Сумма */
                  Doc,                         /* Документ */
                  INPCARRY,                    /* Result_Carry */
                  " 1",                        /* Kind_Oper */
                  "",                          /* Numb_Document */
                  "Зачисление стоимости ц/б нового выпуска " + FD.fininstr.rec.FI_Code,
                  null,
                  GetFIRoleByPortfolio( GroupID ), null, 
                  FD.GetAccFIID("Наш портфель ц/б"), NATCUR
                 ) 
             )
               return 1;
           end;

           if( ОтдельныйУчетУплНКД() and (Query2.NKDAmount > 0))
              if(not ПроводкаПоКатегориямУчета( FD, 
                     "Уплаченный НКД", OldAcnt,/* КатегДеб , КатегКредит*/
                     dat,                         /* Дата */
                     1,                           /* Глава */
                     FD.FaceFIID(),               /* Валюта */
                     Query2.NKDAmount,            /* Сумма */
                     Doc,                         /* Документ */
                     INPCARRY,                    /* Result_Carry */
                     " 1",                        /* Kind_Oper */
                     "",                          /* Numb_Document */
                     "Зачисление НКД по ц/б нового выпуска " + FD.fininstr.rec.FI_Code,
                     null,
                     GetFIRoleByPortfolio( GroupID), null, 
                     FD.FaceFIID(), NATCUR
                    ) 
                )
                  return 1;
              end;
           end;

           if( Query2.BegBonus > 0 )
              if(not ПроводкаПоКатегориямУчета( FD, 
                     "Премия, ц/б", OldAcnt,/* КатегДеб , КатегКредит*/
                     dat,                         /* Дата */
                     1,                           /* Глава */
                     FD.FaceFIID(),               /* Валюта */
                     Query2.BegBonus,             /* Сумма */
                     Doc,                         /* Документ */
                     INPCARRY,                    /* Result_Carry */
                     " 1",                        /* Kind_Oper */
                     "",                          /* Numb_Document */
                     "Зачисление премии по ц/б нового выпуска " + FD.fininstr.rec.FI_Code,
                     null,
                     GetFIRoleByPortfolioBonus(GroupID), null, 
                     FD.FaceFIID(), NATCUR
                    ) 
                )
                  return 1;
              end;
           end;
        else
           if(not ПроводкаПоКатегориямУчета( FD, 
                  "Наш портфель ц/б", "+Расчеты, ГО",/* КатегДеб , КатегКредит*/
                  dat,                         /* Дата */
                  1,                           /* Глава */
                  FD.GetAccFIID("Наш портфель ц/б"),/* Валюта */
                  SumCost,                     /* Сумма */
                  Doc,                         /* Документ */
                  INPCARRY,                    /* Result_Carry */
                  " 1",                        /* Kind_Oper */
                  "",                          /* Numb_Document */
                  "Зачисление стоимости ц/б нового выпуска " + FD.fininstr.rec.FI_Code,
                  null,
                  GetFIRoleByPortfolio( GroupID ), null
                 ) 
             )
               return 1;
           end;

           if( ОтдельныйУчетУплНКД() and (Query2.NKDAmount > 0))
              if(not ПроводкаПоКатегориямУчета( FD, 
                     "Уплаченный НКД", "+Расчеты, ГО",/* КатегДеб , КатегКредит*/
                     dat,                         /* Дата */
                     1,                           /* Глава */
                     FD.FaceFIID(),               /* Валюта */
                     Query2.NKDAmount,            /* Сумма */
                     Doc,                         /* Документ */
                     INPCARRY,                    /* Result_Carry */
                     " 1",                        /* Kind_Oper */
                     "",                          /* Numb_Document */
                     "Зачисление НКД по ц/б нового выпуска " + FD.fininstr.rec.FI_Code,
                     null,
                     GetFIRoleByPortfolio( GroupID), null 
                    ) 
                )
                  return 1;
              end;
           end;

           if( Query2.BegBonus > 0 )
              if(not ПроводкаПоКатегориямУчета( FD, 
                     "Премия, ц/б", "+Расчеты, ГО",/* КатегДеб , КатегКредит*/
                     dat,                         /* Дата */
                     1,                           /* Глава */
                     FD.FaceFIID(),               /* Валюта */
                     Query2.BegBonus,             /* Сумма */
                     Doc,                         /* Документ */
                     INPCARRY,                    /* Result_Carry */
                     " 1",                        /* Kind_Oper */
                     "",                          /* Numb_Document */
                     "Зачисление премии по ц/б нового выпуска " + FD.fininstr.rec.FI_Code,
                     null,
                     GetFIRoleByPortfolioBonus(GroupID), null
                    ) 
                )
                  return 1;
              end;
           end;

        end;

     end;
  end;

  return 0;
end;

PRIVATE MACRO GetTemplNumClient(CatCode:string, CatID:INTEGER, Number:INTEGER, TemplNum:@INTEGER)
  var query, DataSet;
  var Select;

  /* У клиента 2 цифра в балансовом счете зависит от вида обслуживания. */
  /* Для этого в sql запросе есть условие t1.t_value1 = t2.t_value1. */
  query =   " SELECT t2.t_Number TemplNum"
          + " FROM dmctempl_dbt t1, dmctempl_dbt t2 "
          + " WHERE t1.t_CatID = ? "
          + "   and t1.t_Number = ? "
          + "   and t1.t_value1 = t2.t_value1 "
          + "   and t2.t_CatID = (SELECT t_ID FROM dmccateg_dbt WHERE t_Code = ?) ";

  Select = RSDCommand( query );

  Select.addParam( "", RSDBP_IN, CatID ); 
  Select.addParam( "", RSDBP_IN, Number ); 
  Select.addParam( "", RSDBP_IN, CatCode ); 

  Select.execute();

  DataSet = TRsbDataSet(Select);

  if(DataSet.MoveNext())
    TemplNum = DataSet.TemplNum;
    return TRUE;
  end;

  return FALSE;
END;

private macro ОткрытьОбщесистСчет(CatCode:string,ActionDate:Date,AccBuf:Variant,FIID:Integer,AccdocID:integer)
   var BackOutAccount = false, ChangeOpenDate  = false;
   var    RealOpenMode, FindAccount = "";
   var TemplNum;

   file   mcaccdoc( mcaccdoc );

   mcaccdoc.ID=AccdocID;

   if(GetGE( mcaccdoc ) and (mcaccdoc.ID == AccdocID))

      mcaccdoc.FIID=FIID;

      MC_GetAccountOpenParms( CatCode, @BackOutAccount, @ChangeOpenDate );
      /* Добавила поиск номера шаблона для КУ "ЦБ, Расч. с клиентом, ВУ", */
      /* т.к. номера шаблона (TemplNum) счета mcaccdoc и КУ "ЦБ, Расч. с клиентом, ВУ" не совпадают.*/
      /* У банка такой проблемы нет.*/
      if (CatCode == "ЦБ, Расч. с клиентом, ВУ")
         if (not GetTemplNumClient(CatCode, mcaccdoc.CatID, mcaccdoc.TemplNum, @TemplNum))
            MsgBox("Счет категории \"" + CatCode + "\" неопределен или недоступен в данной операции");
            return false;
         end;
      else
         TemplNum = mcaccdoc.TemplNum;
      end;
      
      FindAccount = MC_FindAndOpenCommonAcc( CatCode,
                                        ActionDate,
                                        MC_OPENACC_CREATE,
                                        TemplNum,
                                        mcaccdoc,
                                        mcaccdoc.PeriodID,
                                        FIID,
                                        NULL,
                                        mcaccdoc.DepartmentID,
                                        AccBuf,
                                        RealOpenMode,
                                        null,
                                        MC_PAIRACCMODE_MANUAL,
                                        BackOutAccount,
                                        ChangeOpenDate 
                                      );

   end;

   if ( FindAccount=="" )
      MsgBox("Счет категории \"" + CatCode + "\" неопределен или недоступен в данной операции");
      return false;
   end;

   return true;
end;

private macro CorrectAccountName(category: String, accBuf: Variant)
  var newAccountName: String = "";

  if (Index(accBuf.nameAccount, category) > 0)
    if (category == "ЦБ Клиента, ВУ")
      newAccountName = StrSubst(accBuf.nameAccount, category, "ЦБ-3 Места хранения ЦБ клиентов, ВУ");
    elif (category == "ЦБ, Расч. с клиентом, ВУ")
      newAccountName = StrSubst(accBuf.nameAccount, category, "ЦБ-3 Клиента, ВУ");
    end;
  end;

  if (StrLen(newAccountName) > 0)
    var cmd = RSDCommand("UPDATE dAccount_dbt SET t_nameAccount = :accname WHERE t_account = :acc");

    cmd.AddParam("accname", RSDBP_IN, newAccountName);
    cmd.AddParam("acc",     RSDBP_IN, accBuf.account);
    cmd.Execute();
  end;
end;

private macro ЕстьОбщесистемныйСчет(Account:string,Party:integer,ClientContrID:integer,Place:integer,FIID:integer,ComMcAccID:@integer)
    var DataSet, IsExists = false;
    var query =
         RSDCommand(
             "SELECT accdoc.t_ID " +
             "FROM dmcaccdoc_dbt accdoc " +
             "WHERE accdoc.t_IsCommon          = 'X' " +
             "      AND accdoc.t_Chapter       = 22 " +
             "      AND accdoc.t_FIID          = ? " +
             "      AND accdoc.t_Account       = ? " +
             "      AND accdoc.t_Owner         = ? " +
             "      AND accdoc.t_ClientContrID = ? " +
             "      AND accdoc.t_Place         = ? "
        );

    Query.addParam( "", RSDBP_IN, FIID );
    Query.addParam( "", RSDBP_IN, Account );
    Query.addParam( "", RSDBP_IN, Party );
    Query.addParam( "", RSDBP_IN, IIF(ClientContrID<=0,-1,ClientContrID) );      
    Query.addParam( "", RSDBP_IN, Place );

    Query.execute();                                                          
    
    DataSet = TRsbDataSet(Query);
    
    if( DataSet.MoveNext() )
       ComMcAccID = DataSet.ID;
       IsExists = true;
    end;

    return IsExists;
end;                                               

private macro ПроводкиПоВУ(comm, Doc)
    record acc( account );
    record acc2( account );
    var    FD, DataSet, Query, ВидРО = 78, n = 0;
    var    ComMcAccID, Categ;

    if( not ВестиВнутреннийУчет() )
        return true;
    end;

    FD = SPFirstDocDLCOMM(comm);

    /*Вычислить количество К в проводке как сумму по лотам по состоянию на на дату операции*/
    Query = RSDCommand( " SELECT tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_NewFIID, SUM(tb.t_NewAmount) t_NewAmount, 0 t_ClientContrID, tb.t_Place, tb.T_Number, tb.t_pfi " +
                        "   FROM ( SELECT distinct acc.t_AccountID, accdoc.t_Account, S.t_Party, S.t_NewFIID, S.t_NewAmount, tick.t_ClientContrID, accdoc.t_Place, categ.T_Number, tick.t_pfi " +
                        "            FROM DPMWRTSUM_DBT L, DSCDLPMWR_DBT S, ddl_tick_dbt tick, dmcaccdoc_dbt accdoc, DMCCATEG_DBT categ, daccount_dbt acc " +
                        "           WHERE S.T_DEALKIND      = ? " +
                        "             AND S.T_DEALID        = ? " +
                        "             AND S.t_State         = ? " +
                        "             AND S.T_PARTY         = -1 " +
                        "             AND S.t_SumID         = L.t_SumID "+ 
                        "             AND S.t_Kind          = 1 "+
                        "             AND tick.t_DealID     = L.t_DealID " +
                        "             AND accdoc.t_DocKind  = tick.t_BofficeKind " +
                        "             AND accdoc.t_DocID    = tick.t_DealID " +
                        "             AND accdoc.t_CatID    = categ.T_ID "+
                        "             AND categ.T_Number    = ? "+
                        "             AND categ.T_LevelType = 1 "+
                        "             AND accdoc.t_FIID     = ? " +
                        "             AND accdoc.t_Chapter  = 22 "+
                        "             AND acc.t_Account     = accdoc.t_Account " +
                        "             AND acc.t_Chapter     = accdoc.t_Chapter " +
                        "             AND acc.t_Code_Currency = accdoc.t_Currency " +
                        "             AND NOT EXISTS(SELECT 1 FROM DSCUNIAVRSTOBJ_DBT o WHERE o.t_ID_Operation = ? AND o.t_IsWrt = 0 AND o.t_ObjKind = "+UniAvrObj.OBJKIND_ACCID+" AND o.t_ObjID = acc.t_AccountID AND o.t_FIID = S.t_NewFIID)"+
                        "        ) tb " + 
                        " GROUP BY tb.t_Number, tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_Place, tb.t_NewFIID, tb.t_pfi " +
                        " union " +
                        " SELECT tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_NewFIID, SUM(tb.t_NewAmount) t_NewAmount, 0 t_ClientContrID, tb.t_Place, tb.T_Number, tb.t_pfi " +
                        "   FROM ( SELECT distinct acc.t_AccountID, accdoc.t_Account, S.t_Party, S.t_NewFIID, S.t_NewAmount, accdoc.t_ClientContrID, accdoc.t_Place, categ.T_Number, tick.t_pfi " +
                        "            FROM DPMWRTSUM_DBT L, DSCDLPMWR_DBT S, dmcaccdoc_dbt accdoc, DMCCATEG_DBT categ, daccount_dbt acc, ddl_tick_dbt  tick " +
                        "           WHERE S.T_DEALKIND      = ? " +
                        "             AND S.T_DEALID        = ? " +
                        "             AND S.t_State         = ? " +
                        "             AND S.T_PARTY         = -1 " +
                        "             AND S.t_SumID         = L.t_SumID "+
                        "             AND S.t_Kind          = 1 "+ 
                        "             AND accdoc.t_DocKind  = 0 " +
                        "             AND accdoc.t_DocID    = 0 " +
                        "             AND accdoc.t_CatID    = categ.T_ID "+
                        "             AND categ.T_Number    = ? "+
                        "             AND categ.T_LevelType = 1 "+
                        "             AND accdoc.t_FIID     = ? " +
                        "             AND accdoc.t_owner    = L.t_party " +
                        "             AND accdoc.t_clientcontrid <= 0 " +
                        "             AND accdoc.t_Chapter  = 22 " +
                        "             AND acc.t_Account     = accdoc.t_Account " +
                        "             AND acc.t_Chapter     = accdoc.t_Chapter " +
                        "             AND acc.t_Code_Currency = accdoc.t_Currency " +
                        "             AND tick.t_DealID = L.t_DealID " +
                        "             AND NOT EXISTS(SELECT 1 FROM DSCUNIAVRSTOBJ_DBT o WHERE o.t_ID_Operation = ? AND o.t_IsWrt = 0 AND o.t_ObjKind = "+UniAvrObj.OBJKIND_ACCID+" AND o.t_ObjID = acc.t_AccountID AND o.t_FIID = S.t_NewFIID)"+
                        "        ) tb " + 
                        " GROUP BY tb.t_Number, tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_Place, tb.t_NewFIID, tb.t_pfi " +
                        " union " +
                        " SELECT tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_NewFIID, SUM(tb.t_NewAmount) t_NewAmount, tb.t_ClientContrID, tb.t_Place, tb.T_Number, -1 " +
                        "   FROM ( SELECT distinct acc.t_AccountID, accdoc.t_Account, S.t_Party, S.t_NewFIID, S.t_NewAmount, tick.t_ClientContrID, accdoc.t_Place, categ.T_Number " +
                        "            FROM DPMWRTCL_DBT L, DSCDLPMWR_DBT S, ddl_tick_dbt tick, dmcaccdoc_dbt accdoc, DMCCATEG_DBT categ, daccount_dbt acc " +
                        "           WHERE S.T_DEALKIND         = ? " +
                        "             AND S.T_DEALID           = ? " +
                        "             AND S.t_State            = ? " +
                        "             AND S.T_PARTY           != -1 " +
                        "             AND S.t_SumID            = L.t_ID "+ 
                        "             AND S.t_Kind             = 2 "+
                        "             AND tick.t_ClientID      = L.t_Party " +
                        "             AND tick.t_ClientContrID = L.t_Contract " +
                        "             AND accdoc.t_DocID       = tick.t_DealID " +
                        "             AND accdoc.t_DocKind     = tick.t_BofficeKind " +
                        "             AND accdoc.t_CatID       = categ.T_ID "+
                        "             AND categ.T_Number       = ? "+
                        "             AND categ.T_LevelType = 1 "+
                        "             AND accdoc.t_FIID     = ? " +
                        "             AND accdoc.t_Chapter  = 22 " +
                        "             AND acc.t_Account     = accdoc.t_Account " +
                        "             AND acc.t_Chapter     = accdoc.t_Chapter " +
                        "             AND acc.t_Code_Currency = accdoc.t_Currency " +
                        "             AND NOT EXISTS(SELECT 1 FROM DSCUNIAVRSTOBJ_DBT o WHERE o.t_ID_Operation = ? AND o.t_IsWrt = 0 AND o.t_ObjKind = "+UniAvrObj.OBJKIND_ACCID+" AND o.t_ObjID = acc.t_AccountID AND o.t_FIID = S.t_NewFIID)"+
                        "        ) tb " + 
                        " GROUP BY tb.t_Number, tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_ClientContrID, tb.t_Place, tb.t_NewFIID "
                        " union " +
                        " SELECT tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_NewFIID, SUM(tb.t_NewAmount) t_NewAmount, tb.t_ClientContrID, tb.t_Place, tb.T_Number, -1 " +
                        "   FROM ( SELECT distinct acc.t_AccountID, accdoc.t_Account, S.t_Party, S.t_NewFIID, S.t_NewAmount, accdoc.t_ClientContrID, accdoc.t_Place, categ.T_Number " +
                        "            FROM DPMWRTCL_DBT L, DSCDLPMWR_DBT S, dmcaccdoc_dbt accdoc, DMCCATEG_DBT categ, daccount_dbt acc " +
                        "           WHERE S.T_DEALKIND         = ? " +
                        "             AND S.T_DEALID           = ? " +
                        "             AND S.t_State            = ? " +
                        "             AND S.T_PARTY           != -1 " +
                        "             AND S.t_SumID            = L.t_ID "+
                        "             AND S.t_Kind             = 2 "+ 
                        "             AND accdoc.t_DocID       = 0 " +
                        "             AND accdoc.t_DocKind     = 0 " +
                        "             AND accdoc.t_CatID       = categ.T_ID "+
                        "             AND categ.T_Number       = ? "+
                        "             AND categ.T_LevelType = 1 "+
                        "             AND accdoc.t_FIID     = ? " +
                        "             AND accdoc.t_owner = l.t_party " +
                        "             AND accdoc.t_clientcontrid = l.t_contract " +
                        "             AND accdoc.t_Chapter  = 22 "+
                        "             AND acc.t_Account     = accdoc.t_Account " +
                        "             AND acc.t_Chapter     = accdoc.t_Chapter " +
                        "             AND acc.t_Code_Currency = accdoc.t_Currency " +
                        "             AND NOT EXISTS(SELECT 1 FROM DSCUNIAVRSTOBJ_DBT o WHERE o.t_ID_Operation = ? AND o.t_IsWrt = 0 AND o.t_ObjKind = "+UniAvrObj.OBJKIND_ACCID+" AND o.t_ObjID = acc.t_AccountID AND o.t_FIID = S.t_NewFIID)"+
                        "        ) tb " + 
                        " GROUP BY tb.t_Number, tb.t_AccountID, tb.t_Account, tb.t_Party, tb.t_ClientContrID, tb.t_Place, tb.t_NewFIID "  
 
                      );

    Query.addParam( "", RSDBP_IN, comm.DocKind );
    Query.addParam( "", RSDBP_IN, comm.DocumentID );
    Query.addParam( "", RSDBP_IN, SCDLPMWR_STATE_READY );      
    Query.addParam( "", RSDBP_IN, 550/*"ЦБ Банка, ВУ"*/ );      
    Query.addParam( "", RSDBP_IN, comm.FIID );
    Query.addParam( "", RSDBP_IN, UniAvrObj.GetID_Operation() );

    Query.addParam( "", RSDBP_IN, comm.DocKind );
    Query.addParam( "", RSDBP_IN, comm.DocumentID );
    Query.addParam( "", RSDBP_IN, SCDLPMWR_STATE_READY );      
    Query.addParam( "", RSDBP_IN, 550/*"ЦБ Банка, ВУ"*/ );      
    Query.addParam( "", RSDBP_IN, comm.FIID );
    Query.addParam( "", RSDBP_IN, UniAvrObj.GetID_Operation() );

    Query.addParam( "", RSDBP_IN, comm.DocKind );
    Query.addParam( "", RSDBP_IN, comm.DocumentID );
    Query.addParam( "", RSDBP_IN, SCDLPMWR_STATE_READY );      
    Query.addParam( "", RSDBP_IN, 560/*"ЦБ Клиента, ВУ"*/ );      
    Query.addParam( "", RSDBP_IN, comm.FIID );
    Query.addParam( "", RSDBP_IN, UniAvrObj.GetID_Operation() );

    Query.addParam( "", RSDBP_IN, comm.DocKind );
    Query.addParam( "", RSDBP_IN, comm.DocumentID );
    Query.addParam( "", RSDBP_IN, SCDLPMWR_STATE_READY );      
    Query.addParam( "", RSDBP_IN, 560/*"ЦБ Клиента, ВУ"*/ );      
    Query.addParam( "", RSDBP_IN, comm.FIID );
    Query.addParam( "", RSDBP_IN, UniAvrObj.GetID_Operation() ); 
    
    Query.execute();                                                          

    DataSet = TRsbDataSet(Query);
    InitProgress(-1, "Формирование проводок ВУ (зачисление нового выпуска)", "Формирование проводок ВУ (зачисление нового выпуска)");
    while (DataSet.MoveNext() )
       if(UniAvrObj.NeedBreak())
         UniAvrObj.SetRecurseStep();
         break;
       else
         UniAvrObj.AddRec(UniAvrObj.OBJKIND_ACCID, DataSet.AccountID, DataSet.NewFIID);
       end;
       
       /*если существует такой же, но общесистемный счет по старому выпуску, то открываем общеситстемный счет по новому выпуску
         с такими же КУ, владельцем, договором обсл, местом хранения как у счета старого выпуска*/
       if( ЕстьОбщесистемныйСчет(DataSet.Account,DataSet.Party,DataSet.ClientContrID,DataSet.Place,comm.FIID,@ComMcAccID) )

           if( not GetAccount( 22, comm.FIID, DataSet.Account, null, true ) )
              MsgBox( "Не найден лицевой счет " + DataSet.Account );
              return false;
           end;
  
           if( DataSet.Number == 550 )
              Categ = "ЦБ Банка, ВУ";
           else
              Categ = "ЦБ Клиента, ВУ";
           end;

           if(not ОткрытьОбщесистСчет(Categ,comm.EndDate,acc,DataSet.NewFIID,ComMcAccID) )
               return false;
           end;
           
           CorrectAccountName(Categ, acc);

           var OldPrec = setDefMoneyPrec(12);
           if ( DataSet.Number == 550  ) //ЦБ Банка, ВУ
          
               if(not ОткрытьОбщесистСчет("ЦБ, Прч. счета банка, ВУ",comm.EndDate,acc2,DataSet.NewFIID,ComMcAccID) )
                   return false;
               end;
          
               if( not ПроводкаПоКатегориямВнутреннегоУчета( ВидРО,
                                                             FD,
                                                             Doc,                 
                                                             comm.EndDate,   
                                                             DataSet.NewFIID,  
                                                             money(DataSet.NewAmount),
                                                             null, null, null, null,
                                                             acc,acc2
                       )
                   )
                   return false;
               end;
          
           else //ЦБ Клиента, ВУ
          
               if(not ОткрытьОбщесистСчет("ЦБ, Расч. с клиентом, ВУ",comm.EndDate,acc2,DataSet.NewFIID,ComMcAccID) )
                   return false;
               end;
               
               CorrectAccountName("ЦБ, Расч. с клиентом, ВУ", acc2);
               
               if( not ПроводкаПоКатегориямВнутреннегоУчета( ВидРО,                    
                                                             FD,                    
                                                             Doc,                   
                                                             comm.EndDate,          
                                                             DataSet.NewFIID,       
                                                             money(DataSet.NewAmount),     
                                                             null, null, null, null,
                                                             acc,acc2               
                       )
                   )
                   return false;
               end;
           end;
           setDefMoneyPrec(OldPrec);
       end;
       UseProgress(n=n+1);
    end;
    RemProgress;
    return true;
end;

macro ВыполнитьПроводкиЗачисленияКДУ(comm, Doc, idOperation)
  var stat = 0;

  var m_qracc = TBFile("scqracc.dbt","w");
  
  var QrAcc = TRecHandler("account.dbt");
  var CorrAcc = TRecHandler("account.dbt");
  var FD;

  var qrAccId = 0;

  var query = 
    " SELECT sc.*, fi.t_sumprecision "
   +"   FROM dscdlfi_dbt sc, dfininstr_dbt fi "
   +"  WHERE sc.t_DealKind = ? AND sc.t_DealID = ? AND fi.t_fiid = sc.t_NewFiid";


  var cmd = DL_RSDCommand(query), cmd2;
  cmd.addParam(comm.DocKind);
  cmd.addParam(comm.DocumentID);

  var DataSet = cmd.execute(), DataSet2;

  while (DataSet.MoveNext())
    query = 
      " SELECT acctrn.t_sum_receiver, scqr.t_QRID, scqr.t_FIID "
     +"   FROM doprdocs_dbt t, "
     +"        dacctrn_dbt acctrn, "
     +"        dacctrn_state_dbt acctrn_state, "
     +"        DOPRSTEP_DBT step, "
     +"        DSCQRACC_DBT scqr "
     +"  WHERE     t.t_id_operation = ? "
     +"        AND STEP.T_ID_OPERATION = t.t_id_operation "
     +"        AND t.t_id_step = STEP.T_ID_STEP "
     +"        AND STEP.T_SYMBOL = 'О' "
     +"        AND scqr.t_fiid = ? "
     +"        AND SCQR.T_ACCOUNTID = ACCTRN.T_ACCOUNTID_RECEIVER "
     +"        AND NOT EXISTS(SELECT 1 " 
     +"                         FROM DSCUNIAVRSTOBJ_DBT o "
     +"                        WHERE o.t_ID_Operation = t.t_id_operation "
     +"                          AND o.t_IsWrt = 0 "
     +"                          AND o.t_ObjKind = "+ UniAvrObj.OBJKIND_QRID 
     +"                          AND o.t_ObjID = scqr.t_QRID"
     +"                          AND o.t_FIID = scqr.t_FIID"
     +"                      )"
     +"        AND (    t.t_DocKind = 1 "
     +"             AND t.t_AccTrnID = acctrn.t_AccTrnID "
     +"             AND (   (acctrn.t_State = 1 OR acctrn.t_State = 2) "
     +"                  OR acctrn.t_State = 3) "
     +"             AND acctrn.t_State = acctrn_state.t_State(+)) " ;

    cmd2 =  DL_RSDCommand(query);
    cmd2.addParam(idOperation);
    cmd2.addParam(comm.Fiid);
    DataSet2 = cmd2.execute();

    while (DataSet2.MoveNext())
      
      if(UniAvrObj.NeedBreak())
        UniAvrObj.SetRecurseStep();
        return 0;
      else
        UniAvrObj.AddRec(UniAvrObj.OBJKIND_QRID, DataSet2.QRID, DataSet2.FIID);
      end;

      //Находим регистр КДУ по проводке списания
      m_qracc.Clear();
      m_qracc.KeyNum = 0;
      m_qracc.rec.QRID = DataSet2.QRID;
      if (not m_qracc.GetEQ())
        return 1;
      end;

      //Ищем регистр КДУ с новой ЦБ
      m_qracc.rec.QRID = 0;
      m_qracc.rec.AccountId = 0;
      m_qracc.rec.Fiid = DataSet.NewFiid;
      m_qracc.KeyNum = 2;
      qrAccId = 0;
      if (not m_qracc.GetEQ())
        qrAccId = SC_InsertQRACC(m_qracc);
        if (qrAccId <= 0)
          return 1;
        end;
        m_qracc.rec.QrId = qrAccId;
      end;
      FD = SC_QRAccFD(m_qracc);

      if (НайтиОткрытьСчетаКДУ(FD,comm.CommDate,QrAcc,CorrAcc))
        return 1;
      end;

      var OldPrec = setDefMoneyPrec(12);

      var SumQRAcc = money(round(DataSet2.sum_receiver*(double(DataSet.NUMERATOR)/double(DataSet.DENOMINATOR)), DataSet.SumPrecision)); // high precision

      if(not ПроводкаПоКатегориямУчета( FD, 
            QrAcc, CorrAcc, /* КатегДеб , КатегКредит*/
            comm.CommDate,               /* Дата */
            QrAcc.rec.Chapter,           /* Глава */
            DataSet.NewFiid,             /* Валюта */
            SumQRAcc,             /* Сумма */
            Doc,                         /* Документ */
            INPCARRY,                    /* Result_Carry */
            " 1",                        /* Kind_Oper */
            "",                          /* Numb_Document */
            "Зачисление остатка лицевого счета КДУ"
          ) 
        )
        return 1;
      end;

      setDefMoneyPrec(OldPrec);
      
    end;
    
  end;

  return stat;
end;

macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step )

  record comm( dl_comm );
  SetBuff( comm, FDoc );

  UniAvrObj = UniAvrStObj(ID_Operation, ID_Step, false);

  if (ВыполнитьПроводкиДляНепоставленных(comm, Doc) == 1)
     return 1;
  end;

  if (comm.Flag3 == SET_CHAR)
     if(comm.OperSubKind == SC_GLOBAL_OPER_UNIAVR /*Объединение*/)
       if (ВыполнитьПроводкиПереноса(comm, Doc, ID_Operation, ID_Step) == 1)
          return 1;
       end;
     else
       if (ВыполнитьПроводкиЗачисления(comm, Doc) == 1)
          return 1;
       end;
     end;
  end;

  if( not ПроводкиПоВУ(comm, Doc) )
     RemProgress;
     return 1;
  end;
           
  if (GetDepoMode() == 2) //Работаем с КДУ
    if (ВыполнитьПроводкиЗачисленияКДУ(comm, Doc, ID_Operation) != 0)
       return 1;
    end;
  end;

  if(UniAvrObj.Save() != 0)
    return 1;
  end;

  var StatusKind = SP_OPERSTATUS_GLOBALOPER_SO_END;

  if(UniAvrObj.NeedRecurseStep()) 
    StatusKind = SP_OPERSTATUS_GLOBALOPER_SO_CARRYIN;
  end;

  if( not InsertOprStatus( SP_OPERSTATUS_GLOBALOPER_KIND_SO, StatusKind) ) 
     msgbox( "Ошибка при установке статуса операции" );
     return 1;
  end;

  return 0;
end; 


/* Макрос постобработки */
MACRO PostStep (CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,          /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

  UniAvrObj = UniAvrStObj(ID_Operation, ID_Step, false);
  
  if( errTrn OR (CommitOrRollback == 2) ) /* Произошла ошибка или происходит откат */ 
    UniAvrObj.DeleteStepDocs();
  end;
  
  return 0;

END;