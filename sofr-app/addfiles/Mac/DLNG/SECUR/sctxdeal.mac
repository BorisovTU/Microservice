import "DLReport_h.mac", "dlreport.mac";

PRIVATE CLASS (DL_CReportTemplate) CPrintScrol( sqlQuery:STRING )
  PRIVATE VAR m_RS, m_NumRec = 0,
              m_SqlQuery = sqlQuery;

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
     this.SetActiveSheet( "Записи скроллинга" );

     this.CreateTable( "ScrolName", "H_", "N_", "V_",
                       "Сделки для налогового учета",
                       "ID сделки",    V_INTEGER,
                       "Внутренний №", V_STRING,
                       "Внешний №",    V_STRING,
                       "Вид",          V_STRING,
                       "Выпуск ц/б",   V_STRING,
                       "Количество",   V_MONEY, 
                       "Дата",         V_DATE,
                       "Дата 2ч",      V_DATE,
                       "Дата закл.",   V_DATE,
                       "Время",        V_TIME,
                       "Тип",          V_STRING,
                       "Цена",         V_DOUBLE,
                       "ВЦ",           V_STRING
                     );
  END;

  PRIVATE MACRO EndReport()
     EndTable();

     m_ObjTemplateXLS.SetValue_NameCell( "itog", m_NumRec );
  END;

  MACRO ПечататьСтрокуТаблицы( )
     PrintTableLine( "V_"     , m_RS.ID,                                 null,
                     "V_1"    , m_RS.DealCode,                           null,
                     "V_2"    , m_RS.DealCodeTS,                         null,
                     "V_3"    , DL_GetNameAlg(7300, m_RS.Type),          null,
                     "V_4"    , m_RS.FIName,                             null,
                     "V_5"    , m_RS.Amount,                             m_RS.SumPrecision,
                     "V_6"    , SQL_ConvTypeDate(m_RS.Date1),            null,
                     "V_7"    , SQL_ConvTypeDate(m_RS.Date2),            null,
                     "V_8"    , SQL_ConvTypeDate(m_RS.DealDate),         null,
                     "V_9"    , TIME(m_RS.DealTime),                     null,
                     "V_10"   , DL_GetNameAlg(7301, m_RS.VirtualType),   null,
                     "V_11"   , m_RS.Price,                              null,
                     "V_12"   , m_RS.PriceCUR,                           null
                   );
  END;                                                

  PRIVATE MACRO GetNRecs()
      var dataSet = TRsbDataSet( "select count(1) nRecs " + m_sqlQuery );

      if( dataSet.moveNext() ) 
          return Int(dataSet.nRecs);
      end;
      return 0;
  END;

  PRIVATE MACRO Create()
     InitProgress( GetNRecs(), "Печать скроллинга", "Печать скроллинга" );

     m_RS = TRsbDataSet( "select * " + m_sqlQuery + " order by t_ID");

     while( m_RS.MoveNext() )
        ПечататьСтрокуТаблицы();

        UseProgress( m_NumRec = m_NumRec + 1 );
     end;

     RemProgress();
  END;

  initDL_CReportTemplate( NULL, "TXScrolRec.xls" );
END;

macro PrintSCTXDEAL( sqlQuery:STRING )

  CPrintScrol( sqlQuery ).Run();
  exit( 1 );
end;

