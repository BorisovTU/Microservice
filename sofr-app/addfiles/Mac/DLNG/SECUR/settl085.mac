/*
$Name:        settl085.mac
$Module:      Ценные бумаги
$Description: Операция Расчеты на ОРЦБ. Шаг - Вывод средств с торгового счета
*/
import "settl.mac";

/* Глобальная структура с данными для поплнения торгового счета (то, что вводится в панели поплнения счета))*/
PRIVATE VAR TorgAccData = TRecHandler( "dl_comm.dbt");
PRIVATE VAR MoneySourceBase:Integer; // Источник средств в первоначальной операции, при создании (не при изменении на шаге)

PRIVATE RECORD Account(account);

/*процедура подсчета остатков на счетах - вызывается программно для расчета суммы вывода в форме, вызываемой на данном шаге*/
PRIVATE MACRO CalcRestOnMarketAccounts()
  var FiRole = null;
  var FD = SPFirstDocDLCOMM( TorgAccData );

  GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);

  if( FD.IsExistAccount( "Торговый счет", null, null, FiRole, Account, null, FD.comm.rec.CommDate, TorgAccData.rec.Currency ) )
     TorgAccData.rec.hidden_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
  end; 

  if( FD.comm.rec.FIID > 0 )
    if( FD.IsExistAccount( "Торговый счет", null, null, FiRole, Account, null, FD.comm.rec.CommDate, TorgAccData.rec.FIID ) )
       TorgAccData.rec.Currency_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
    end; 
  end; 

END;

MACRO ExecuteStep( Doc, adr, DocKind, ID_Operation, ID_Step )

  VAR comm = TRecHandler( "dl_comm.dbt" );

  comm.SetRecordAddr( adr );

  if( not ВыводСредствСТорговогоСчета( Doc, TorgAccData, ID_Operation, ID_Step ) )
     return 1;
  end;

  return 0;
END;
