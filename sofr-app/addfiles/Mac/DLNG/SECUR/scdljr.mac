/**
 @file 		mac\dlng\secur\scdljr.mac
 @brief 	"Субрегистр спорных сделок" (ФКЦБ)

 # menu
 - ЦБ \ Внутренний учет \ Отчеты \ Регистры внутреннего учета \ Субрегистр спорных сделок

 # tag
 - functional_block: Отчетность_внутренняя
 - code_type: Report

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |09.09.2025 |Велигжанин А.В.|DEF-100869                                      |Отсутствовал RemProgress
 |15.02.2002 |Леонов И. Е.   |                                                |Создание
*/
import "spRepFn2.mac", "dlsubjrn_form.mac", "dltkjrnl_form.mac", "dlquery.mac", globals;
/* !!!   Надо переделать хранение данных во временном файле.
   !!!   Хранить там только ключевые параметры, например, DealID, LegKind,
   !!!   FIID, параметры для сортировки, а все остальное вычислять при печати.
   !!!   Иначе, приходится часто менять структуру временной базы. */


//VAR m_rep:T_XML_Rep;
private const SUBKIND_DRIVE_CB = 3; /*подвид доверительное управление*/
private var ReportRun = false, IsFirstUse = true;

/*Тип выпускаемого отчета*/
private const REGISTER_DEAL_REPORT    = 0, /*Отчет "Регистр сделок"*/
              SUBREGISTER_DEAL_REPORT = 1; /*Отчет "Субрегистр спорных сделок"*/

private const DOCKIND_CONTR_FIRST  = 22,  /* договор по первой части*/
              DOCKIND_CONTR_SECOND = 23,  /* договор по второй части*/
              DOCKIND_MARKETREP    = 25,  /* отчет проф. участнику */
              DOCKIND_BUYSALEREP   = 26,  /* договор купли продажи */
              DOCKIND_COMMANDREP   = 27;  /* распорядительная записка */

private const DEALTYPE_OWN    = 0,  /* собственные сделки */
              DEALTYPE_BROKER = 1,  /* брокерские сделки */
              DEALTYPE_DU     = 2;  /* доверительное управление*/

private const KIND_EX_1 = 1,
              KIND_IN   = 2,  
              KIND_OUT  = 3,  
              KIND_EX_2 = 4;  

private const POI_MODE = true;

private var ReportTMP = TBFile( "scdljr.tmp", "W", 0 );
                      
private record r_sfcontr(sfcontr);
private record rParty( party );
private record rFininstr( "fininstr" );
private record rAvoiriss( "avoiriss" );

/*Возвращает время в формате ЧЧ:ММ*/
private macro SPTimeSplit(_Time)
  var Result_Time = "", h, m, s;
  TimeSplit( _Time, h, m, s );
  if(m == 0)
    m = string(m) + string(m); /*Чтобы не было 7:0 вместо 7:00*/
  elif(m < 10)
    m ="0" + string(m); /*Чтобы не было 7:7 вместо 7:07*/
  else  
m=string(m); 
  end;

  if(s == 0)
    s = string(s) + string(s); /*Чтобы не было 7:0 вместо 7:00*/
  elif(s < 10)
    s ="0" + string(s); /*Чтобы не было 7:7 вместо 7:07*/
  else  
s=string(s); 
  end;

  return string(h)+":"+string(m)+":"+string(s);
end;


/* Структура с исходными данными */
private class (TBaseReportData) SourceData(
                  _ReportType, _DprtID:integer, _AvrTypeID: integer, _EmiID: integer,
                  _AvrID: integer, _DealType: integer,  _ClientID: integer,
                  _IsFormID:integer, _FormSubID:integer, _IsVidID:integer, _VidSubID:integer, _NoResident:bool, 
                  _DealMarket:bool,_MarketID:integer, _DealNotMarket:bool, _DealBroker:bool,
                  _BrokerID:integer, _dateMin: date,  _dateMax: date,
                  _IsPartDate:bool,_DealStatus:integer, _Qualified:integer, _apostrSum: bool, _DealREPO:bool )

   var
      PrintHead,
      ReportType    =  _ReportType,
      DprtID        =  _DprtID,
      AvrTypeID     =  _AvrTypeID,
      EmiID         =  _EmiID,
      AvrID         =  _AvrID,
      DealType      =  _DealType,
      ClientID      =  _ClientID,

      IsForm      = _IsFormID,
      FormSub     = _FormSubID,
      IsVid       = _IsVidID,
      VidSub      = _VidSubID,
      NoResident    = _NoResident,

      DealMarket    =  _DealMarket,
      MarketID      =  _MarketID,
      DealREPO      =  _DealREPO,
      DealNotMarket =  _DealNotMarket,
      DealBroker    =  _DealBroker,
      BrokerID      =  _BrokerID,
      dateMin       =  _dateMin,
      dateMax       =  _dateMax,
      IsPartDate    =  _IsPartDate,
      DealStatus    =  _DealStatus,
      Qualified     =  _Qualified;

   var  AgentId = -1;

   initTBaseReportData( _apostrSum );
/*GAA*/
   var
      ShowDealChange = false; // GAA: 498874, old: GetOption_ShowDealChange; по просьбе банка отчет формируется как при значении "NO" настройки "SECUR\SHOW_DEAL_CHANGE_IN_REPS" 

   var ReportName = "";
   if( ReportType == REGISTER_DEAL_REPORT ) /*Отчет "Регистр сделок"*/
      ReportName = "Регистр сделок с эмиссионными ценными бумагами";
   elif( ReportType == SUBREGISTER_DEAL_REPORT ) /*Отчет "Субрегистр спорных сделок"*/
      ReportName = "Субрегистр спорных сделок с эмиссионными ценными бумагами";
   end;
end;

private var  TableHead1 = "┌───────┬──────────┬──────────┬──────────┬──────────┬──────────┬────────────┬──────────────────────┬──────────────────┬───────────────────┬─────────┬───────────┬────────────────────┬───────┬────────────────┬────────────────────┬───────┬────────────────┬──────┬───────┬────────────────────────┬──────┬──────────────────────────────────────────────────────────────┬──────┬──────────┬──────────┬──────────┬──────────┬───────────────────────────────────┬──────────────┐\n"+
                          "│       │          │ Референс │          │          │          │   Место    │          Вид         │                  │                   │    №    │    №      │                    │       │                │                    │       │    № гос.      │Валюта│       │                        │Валюта│               Сумма сделки                                   │Валюта│Дата пере-│Дата пере-│   Дата   │   Дата   │       Подтверждающий документ     │    Отказ     │\n"+
                          "│ № п/п │ № сделки │обязатель-│   Дата   │   Время  │ Действие │ совершения │        сделки        │    Контрагент    │       Клиент      │поручения│ договора  │      Эмитент       │Вид ц/б│     Код ц/б    │        Серия       │ Транш │   регистрации  │расче-│Кол-во │    Цена/Ставка РЕПО    │ цены ├────────────────────┬────────────────────┬────────────────────┤ цены │хода прав │хода прав │  оплаты  │  оплаты  ├───────────┬────────────┬──────────┤              │\n"+
                          "│       │          │ства      │          │          │          │   сделки   │                      │                  │                   │         │           │                    │       │                │                    │       │     (ISIN)     │тов   │       │                        │      │      в валюте      │      в валюте      │      в валюте      │сделки│  на ц/б  │  на ц/б  │   план.  │   факт.  │    Вид    │  № док-та  │   Дата   │              │\n"+         
                          "│       │          │          │          │          │          │            │                      │                  │                   │         │           │                    │       │                │                    │       │                │      │       │                        │      │       сделки       │      расчётов      │         РФ         │      │   План.  │   Факт.  │          │          │  док-та   │            │          │              │\n"+
                          "├───────┼──────────┼──────────┼──────────┼──────────┼──────────┼────────────┼──────────────────────┼──────────────────┼───────────────────┼─────────┼───────────┼────────────────────┼───────┼────────────────┼────────────────────┼───────┼────────────────┼──────┼───────┼────────────────────────┼──────┼────────────────────┼────────────────────┼────────────────────┼──────┼──────────┼──────────┼──────────┼──────────┼───────────┼────────────┼──────────┼──────────────┤";
   
private var  TableHead2 = "┌──────────┬──────────┬──────────┬────────────┬──────────────────────┬──────────────────┬───────────────────┬─────────┬───────────┬────────────────────┬───────┬────────────────┬────────────────────┬───────┬────────────────────────┬────┬──────────┬───────┬────────────────────┬──────┬──────┬──────────┬──────────┬──────────┬──────────┬───────────────────────────────────┬──────────────┬────────────┬────────────┐\n"+
                          "│          │          │          │   Место    │          Вид         │                  │                   │    №    │    №      │                    │       │                │                    │       │                        │Ва- │  Ставка  │       │                    │Валюта│Валюта│   Пере-  │  Пере-   │   Дата   │   Дата   │      Подтверждающий документ      │    Отказ     │ Основание  │  Принятые  │\n"+
                          "│ № сделки │   Дата   │   Время  │ совершения │        сделки        │    Контрагент    │       Клиент      │поручения│ договора  │      Эмитент       │Вид ц/б│     Код ц/б    │        Серия       │ Транш │          Цена          │люта│   РЕПО   │Кол-во │   Сумма сделки     │ цены │расче-│ регистр. │ регистр. │  оплаты  │  оплаты  ├─────────────┬──────────┬──────────┤              │для внесения│  меры по   │\n"+
                          "│          │          │          │   сделки   │                      │                  │                   │         │           │                    │       │                │                    │       │                        │цены│          │       │                    │сделки│ тов  │   план.  │  факт.   │   план.  │   факт.  │  Вид док-та │ № док-та │   Дата   │              │ сведений в │  разрешению│\n"+         
                          "│          │          │          │            │                      │                  │                   │         │           │                    │       │                │                    │       │                        │    │          │       │                    │      │      │          │          │          │          │             │          │          │              │ субрегистр │  претензий │\n"+
                          "├──────────┼──────────┼──────────┼────────────┼──────────────────────┼──────────────────┼───────────────────┼─────────┼───────────┼────────────────────┼───────┼────────────────┼────────────────────┼───────┼────────────────────────┼────┼──────────┼───────┼────────────────────┼──────┼──────┼──────────┼──────────┼──────────┼──────────┼─────────────┼──────────┼──────────┼──────────────┼────────────┼────────────┤";

private var  TableHead1_2 = "┌───────┬──────────┬──────────┬──────────┬────────┬───────────┬──────────┬─────────┬────────────────────┬───────┬────────────┬────────────────────┬────────────────────┬────────────────────┬──────────┬──────────────┬──────┬────────────────┬────────────────┬────────────────┐\n"+
                            "│       │          │Референс  │   Дата   │  Вид   │ Основание │Управляю- │    №    │                    │       │            │                    │                    │        №           │  Кол-во  │ Цена операции│Валюта│ Сумма операции │      НКД       │     Сумма      │\n"+
                            "│ № п/п │ № сделки │обязатель-│ операции │операции│ операции  │щий обес- │договора │       Эмитент      │Вид ц/б│   Код ц/б  │        Серия       │        Транш       │  гос. регистрации  │ операции │              │опера-│                │                │                │\n"+
                            "│       │          │ства      │          │        │           │печением  │         │                    │       │            │                    │                    │      (ISIN)        │          │              │ции   │                │                │                │\n"+         
                            "│       │          │          │          │        │           │          │         │                    │       │            │                    │                    │                    │          │              │      │                │                │                │\n"+
                            "├───────┼──────────┼──────────┼──────────┼────────┼───────────┼──────────┼─────────┼────────────────────┼───────┼────────────┼────────────────────┼────────────────────┼────────────────────┼──────────┼──────────────┼──────┼────────────────┼────────────────┼────────────────┤";

private var Header = "                                                 Регистр сделок с эмиссионными ценными бумагами ###########################################\n\n"+
                     "#################################################################################\n"+
                     "#######################################################\n"+
                     "#######################################################\n"+
                     "#######################################################\n"+
                     "#######################################################\n"+
                     "#######################################################\n";
                          
private var Rep2 = CMakeReport(TableHead2);
private var Rep;
private const FontStyleTitel =  "ex_FS(b)";

//Переменные для варианта WindowsReports, поддерживающего POIReports
var csvFile, fName, csvTable, printEngine;

private macro GetISINbyAvrCode( AvrCode )
  var rsd;
  var cmd = RsdCommand("SELECT avr.t_LSIN, avr.t_ISIN FROM dfininstr_dbt fi, davoiriss_dbt avr WHERE avr.t_FIID =  fi.t_FIID AND fi.t_FI_Code = ?");
   cmd.addParam("", RSDBP_IN, AvrCode);
   cmd.execute();
   rsd = TRsbDataSet(cmd);
   if( rsd.MoveNext() )
      return IIF( rsd.rec.LSIN != "", rsd.rec.LSIN, rsd.rec.ISIN);
   end;

   return "";
end;

private macro GetFIIDbyCCY( CCY )
  var rsd;
  var cmd = RsdCommand("SELECT fi.t_FIID FROM dfininstr_dbt fi WHERE fi.t_Ccy = ?");
   cmd.addParam("", RSDBP_IN, CCY);
   cmd.execute();
   rsd = TRsbDataSet(cmd);
   if( rsd.MoveNext() )
      return rsd.rec.FIID;
   end;
   return -1;
end;


private macro PrintHead( Data, IsExcel:bool )
   file Dprt( dp_dep );
   var  DprtName = ""; 
   var TableHead = "";
   /*Название филиала*/
   if( Data.DprtID != 0 )
     // Dprt.Code = Data.DprtID;
      //if( GetEQ( Dprt ) )  
        DprtName = ПолучитьКороткоеИмяСубъекта( 1/*Dprt.PartyID*/, Data.DateMax );
      //else
        // msgBox ("Не найдено имя филиала с кодом ", Data.DprtID );    
      //end;

     if (IsExcel)
      printEngine.SetValue_NameCell("titleFilial", "Филиал    " + DprtName);
      printEngine.CopyAllSheetInTotalBook (null, false, "templateHeaderFilial", 0, "Отчет");
     else
      Rep.AddPrintCell("Филиал    " + DprtName, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
     end;

   end;

   if( Data.ReportType == SUBREGISTER_DEAL_REPORT )
      Rep = Rep2;

   end;

   Data.PrintHead = true;
end;

private macro GetReportHead( Data, ReportDate, H:TArray )

   /*Вид ЦБ*/
   if( Data.AvrTypeID != -1 )
      H[0] = AvoirKindName( Data.AvrTypeID );
   else H[0] = "";
   end;

   /*эмитент*/
   if( (Data.EmiID != -1) AND (not ПолучитьСубъекта( Data.EmiID, rParty )) )
      H[1] = rParty.ShortName;
   else H[1] = "";
   end;

   /*Код ЦБ*/
   if( (Data.AvrID > 0) AND (not ПолучитьФинИн( Data.AvrID, rFininstr )) )
      H[2] = rFininstr.FI_Code;
   else H[2] = "";
   end;

   /*Клиент*/
   if( (Data.ClientID != -1) AND (not ПолучитьСубъекта( Data.ClientID, rParty ) ))
      H[3] = rParty.ShortName;
   else H[3] = "";
   end;

   /*Биржа*/
   H[4] = "";
   if( Data.DealMarket == true )
      H[4] = H[4] + "Биржевые ";
      if ( Data.DealNotMarket == true )
         H[4] = H[4] + "и внебиржевые ";
      else H[4] = H[4] + "";
      end;
   else 
      if ( Data.DealNotMarket == true )
         H[4] = H[4] + "Внебиржевые ";
      else H[4] = H[4] + "";
      end;
   end;

   if( H[4] != "" )
      H[4] = H[4] + "сделки";
   end;

   if( Data.DealBroker == true ) 
      if ( H[4] == "" )
         H[4] = H[4] + "Сделки через брокера";
      else 
         H[4] = H[4] + " и сделки через брокера";
      end;
   end;

   /*Сделки с квалифицированными ценными бумагами*/
   if( Data.Qualified == 0 )
      H[5] = "Сделки с квалифицированными ценными бумагами";
   elif( Data.Qualified == 1 )
      H[5] = "Сделки с иностранными финансовыми инструментами, не квалифицированными в качестве ценных бумаг";
   elif( Data.Qualified == 2 )
      H[5] = "Сделки покупки иностранных финансовых инструментов, не квалифицированных в качестве ценных бумаг";
   else // NULL or -1
      H[5] = "";
   end;
  
end;

private macro PrintReportHead( Data, ReportDate, IsExcel:bool )
   var H = TArray; /*Подкачиваемые поля (имена и названия), одинаковые для всех 
                    сделок. Определяются при печати шапки отчета. */

   GetReportHead( Data, ReportDate, H );

   if (IsExcel)
      if( (ValType(ReportDate) == V_DATE) and (Data.IsPartDate == true) )
         printEngine.SetValue_NameCell("title", Data.ReportName + " за дату " + string(date(ReportDate):f));
      else
         printEngine.SetValue_NameCell("title", Data.ReportName + " за период с " + string(date(Data.dateMin):f) + " по " + string(date(Data.dateMax):f));
      end;
      printEngine.SetValue_NameCell("titleH5", H[5]);
      printEngine.SetValue_NameCell("titleH0", "Вид ц/б:   " + H[0]);
      printEngine.SetValue_NameCell("titleH1", "Эмитент:   " + H[1]);
      printEngine.SetValue_NameCell("titleH2", "Ценная бумага:  " + H[2]);
      printEngine.SetValue_NameCell("titleH3", "Клиент:    " + H[3]);
      printEngine.SetValue_NameCell("titleH4", H[4]);

      printEngine.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, "Отчет");
   else
      if( not IsFirstUse )
         Rep.AddEmptyStr();
      else
         IsFirstUse = false;
      end;

      if( (ValType(ReportDate) == V_DATE) and (Data.IsPartDate == true) )
         Rep.AddPrintCell("                                       " + Data.ReportName + " за дату " + string(date(ReportDate):f), Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      else
         Rep.AddPrintCell("                                       " + Data.ReportName + " за период с " + string(date(Data.dateMin):f) + " по " + string(date(Data.dateMax):f), Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      end;
      Rep.AddStr();
      Rep.AddPrintCell(H[5], Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
      Rep.AddPrintCell("Вид ц/б:   " + H[0], Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
      Rep.AddPrintCell("Эмитент:   " + H[1], Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
      Rep.AddPrintCell("Ценная бумага:  " + H[2], Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
      Rep.AddPrintCell("Клиент:    " + H[3], Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
      Rep.AddPrintCell(H[4], Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
      Rep.AddEmptyStr();
   end;
end;

private macro PrintLine2( DealCode:string, Date1: string, Time1: string, PartyShort1:string,DealKindName:string, ContrShortName:string,
                 ClientShortName:string, DocNumber:string, SfContrNumber:string, IssShortName:string, AvrKind:string,
                 AvrCode:string, AvrSeries:string, AvrIssue:string, Price:string, PriceISO:string, RepoRate1:string, Amount:money, SumInNom:string, 
                 PriceISO2:string, PayCCY:string, StateDate:string, StateFactDate:string, PayDate:string, PayFactDate:string, ReportKind:string,
                 ReportNum:string, ReportDate:string, RejectInfo:string, NoteGround:string, NoteArrange:string, IsApp:bool, Borders:string, IsExcel:bool )

  var RepKind;
  var StrApp = IIF(IsApp, ":a", "");
  if(ReportKind == "отчёт")
    RepKind = "отчёт проф. участнику";
  else
    RepKind = ReportKind;
  end;

  if (IsExcel)
        csvFile.AddCell(DealCode);
        csvFile.AddCell(Date1);
        csvFile.AddCell(Time1);
        csvFile.AddCell(PartyShort1);
        csvFile.AddCell(DealKindName);
        csvFile.AddCell(ContrShortName);
        csvFile.AddCell(ClientShortName);
        csvFile.AddCell(DocNumber);
        csvFile.AddCell(SfContrNumber);
        csvFile.AddCell(IssShortName);
        csvFile.AddCell(AvrKind);
        csvFile.AddCell(AvrCode);
        csvFile.AddCell(AvrSeries);
        csvFile.AddCell(AvrIssue);
        /* 2 часть РЕПО (выводится ставка РЕПО и символ "%") - оставляем текстом */
        if ((Price != "") and (Index(Price, "%") == 0))
           Price = StrSubst(Price, "'", "");
           csvFile.AddCell(money(Price));
        else
           csvFile.AddCell(Price);
        end;
        csvFile.AddCell(PriceISO);
        csvFile.AddCell(RepoRate1);
        csvFile.AddCell(IIF(Amount != $0, Amount, ""));
        csvFile.AddCell(IIF(money(SumInNom) != $0, money(SumInNom), ""));
        csvFile.AddCell(PriceISO2);
        csvFile.AddCell(PayCCY);
        csvFile.AddCell(StateDate);
        csvFile.AddCell(StateFactDate);
        csvFile.AddCell(PayDate);
        csvFile.AddCell(PayFactDate);
        csvFile.AddCell(RepKind);
        csvFile.AddCell(ReportNum);
        csvFile.AddCell(ReportDate);
        csvFile.AddCell(RejectInfo);
        csvFile.AddCell(NoteGround);    
        csvFile.AddCell(NoteArrange);
        csvFile.AddRow();
  else
      Borders = ":ex_B("+Borders+")";

        Rep.AddPrintCell(DealCode,        0, 0, "c"+Borders);
        Rep.AddPrintCell(Date1,           0, 0, "l"+Borders);
        Rep.AddPrintCell(Time1,           0, 0, "l"+Borders);
        Rep.AddPrintCell(PartyShort1,  0, 0, "l"+Borders);
        Rep.AddPrintCell(DealKindName,    0, 0, "c"+Borders);
        Rep.AddPrintCell(ContrShortName,  0, 0, "l"+Borders);
        Rep.AddPrintCell(ClientShortName, 0, 0, "l"+Borders);
        Rep.AddPrintCell(DocNumber,       0, 0, "l"+Borders);
        Rep.AddPrintCell(SfContrNumber,   0, 0, "l"+Borders);
        Rep.AddPrintCell(IssShortName,    0, 0, "l"+Borders);
        Rep.AddPrintCell(AvrKind,         0, 0, "c"+Borders);
        Rep.AddPrintCell(AvrCode,         0, 0, "c"+Borders);
        Rep.AddPrintCell(AvrSeries,       0, 0, "c"+Borders);
        Rep.AddPrintCell(AvrIssue,        0, 0, "c"+Borders);
        /* 2 часть РЕПО (выводится ставка РЕПО и символ "%") - оставляем текстом */
        if ((Price != "") and (Index(Price, "%") == 0))
           Price = StrSubst(Price, "'", "");
           Rep.AddPrintCell(money(Price), 0, StrLen(Price) - Index(Price, "."), "c" + StrApp+Borders);
        else
           Rep.AddPrintCell(Price, 0, 0, "c"+Borders);
        end;
        Rep.AddPrintCell(PriceISO,        0, 0, "c"+Borders);
        Rep.AddPrintCell(RepoRate1,        0, 0, "c"+Borders);
        Rep.AddPrintCell(IIF(Amount != $0, Amount, ""),      0, SetPrecisionByFractPart( Amount, 6, 0 ), "c"+Borders);
        Rep.AddPrintCell(IIF(money(SumInNom) != $0, money(SumInNom), ""), 0, 2, "c" + StrApp+Borders);
        Rep.AddPrintCell(PriceISO2,       0, 0, "c"+Borders);
        Rep.AddPrintCell(PayCCY,          0, 0, "c"+Borders);
        Rep.AddPrintCell(StateDate,       0, 0, "l"+Borders);
        Rep.AddPrintCell(StateFactDate,   0, 0, "l"+Borders);
        Rep.AddPrintCell(PayDate,         0, 0, "l"+Borders);
        Rep.AddPrintCell(PayFactDate,     0, 0, "l"+Borders);
        Rep.AddPrintCell(RepKind,         0, 0, "l"+Borders);
        Rep.AddPrintCell(ReportNum,       0, 0, "l"+Borders);
        Rep.AddPrintCell(ReportDate,      0, 0, "c"+Borders);
        Rep.AddPrintCell(RejectInfo,      0, 0, "c"+Borders);
        Rep.AddPrintCell(NoteGround,      0, 0, "l"+Borders);    
        Rep.AddPrintCell(NoteArrange,     0, 0, "l"+Borders);
        Rep.AddStr();
   end;
   ReportRun = true;                                                                                                                                                                                                      
end;

private macro PrintDeals( Title, Data, KindRecord, ReportDate, IsExcel:bool )
   var Continue_cicle, Date1, RepoRate1, PartyShortName1;
   var ReportKind = "", DocNum = "", DocDate = "",
       ReportKind2 = "", DocNum2 = "", DocDate2 = "";
   var query, DataSet, Select, cnt = 0, i = 0;

  // file dl_tick ( "dl_tick" ) key 1;
   var Price = "", PriceISO = "", PriceISO2 = "", FilterCond = "";
   var CurNumber = 1;
   var IsBack = false;
   var borders = "";
   var dl_tick, cmd;

   ClearRecord( ReportTMP );
   rewind(ReportTMP);

   FilterCond = "t_KindRecord = " + string(KindRecord);
   if( (ValType(ReportDate) == V_DATE) and (Data.IsPartDate == true) )
      FilterCond = FilterCond + " and t_ChangeDate = " + GetSQLDate(ReportDate);
   end;

   ReportTMP.AddFilter(FilterCond);
   Continue_cicle = Next(ReportTMP);

   if( Continue_cicle AND (ReportTMP.rec.KindRecord == KindRecord) )

      if( Data.ReportType == SUBREGISTER_DEAL_REPORT )
       if (IsExcel)                                                                                                                                                                                                                                                                                                                 
         printEngine.SetValue_NameCell("titleType", Title);
         printEngine.CopyAllSheetInTotalBook (null, false, "templateHeaderType", 0, "Отчет");
       else
         Rep.AddPrintCell(Title, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
         Rep.AddStr();
       end;
      end;
   end;

   var HeaderPrint = false;

   while( Continue_cicle AND
          (ReportTMP.rec.KindRecord == KindRecord)
        )

      ReportKind = ""; 
      DocNum = ""; 
      DocDate = "";
      cnt = 0;

      borders = "BTRL";

      Date1 = DateToStr( ReportTMP.rec.ChangeDate ) + ","+ SPTimeSplit(ReportTMP.rec.DealTime); 
      PartyShortName1 = ReportTMP.rec.PartyShortName + " " + ReportTMP.rec.BrokerShortName;    

      if(Data.ReportType == SUBREGISTER_DEAL_REPORT)
         if( Index(string(ReportTMP.rec.RepoRate),"%") != 0 )
            Price = "";
            PriceISO = "";
            RepoRate1 = ReportTMP.rec.RepoRate;
         else
            Price = ReportTMP.rec.RepoRate;
            PriceISO = ReportTMP.rec.RepoRateCCY;
            RepoRate1 = "";
         end;
      end;

      IsBack = IIF(ReportTMP.rec.LegKind==LEG_KIND_DL_TICK_BACK,true,false);
  /*    cmd = DL_RSDCommand ("select t.*, s.t_number, \n" +
                           "(select r.t_codets from ddl_req_dbt r join dspgrdoc_dbt rd on r.t_id = rd.t_SOURCEDOCID and rd.t_sourcedockind = 350 join dspgrdoc_dbt spgrdoc \n" +
                           "            ON rd.t_SPgroundID = spgrdoc.t_SPGroundID where  spgrdoc.t_SourceDocKind = t.t_bofficekind AND spgrdoc.t_SourceDocID =  t.t_dealid) codets \n" +
                           " from ddl_tick_dbt t join dsfcontr_dbt s on s.t_id = t.t_clientcontrid \n" +
                           "where   t.t_dealid = ? and t.t_bofficekind = 101  \n" 
                           ); */
  cmd = DL_RSDCommand ("select t.*, s.t_number \n" +
                           " from ddl_tick_dbt t join dsfcontr_dbt s on s.t_id = t.t_clientcontrid \n" +
                           "where   t.t_dealid = ? and t.t_bofficekind = 101  \n" 
                           );  

      cmd.addParam(ReportTMP.rec.Dealid); 
      dl_tick = cmd.execute(); //RsdRecordSet(dl_tick);
//      dl_tick.dealcode = ReportTMP.rec.DealCode;
  //    dl_tick.bofficekind = 101;
 //     if(GetEQ(dl_tick))
      if (dl_tick.movenext())
         IF( Data.DprtID == dl_tick.Department )
            /*
            query =   " select count(1) over() reccnt, spground.t_Xld, spground.t_Kind, case when spground.t_kind = 251 then r.t_codets else spground.t_AltXld end AltXld, spground.t_RegistrDate, llv.t_Name as KindName "
                    + "   from dspground_dbt spground, dllvalues_dbt llv, dspgrdoc_dbt spgrdoc left join dspgrdoc_dbt rd on  rd.t_spgroundid = spground.t_spgroundid and spground.t_kind = 251 and rd.t_sourcedockind = 350 "
                    + "    left join ddl_req_dbt r on r.t_id = rd.t_SOURCEDOCID " 
                    + "  where spgrdoc.t_SourceDocKind = ? "  
                    + "    and spgrdoc.t_SourceDocID   = ? "
                    + "    and spground.t_SPgroundID   = spgrdoc.t_SPGroundID "
                    + "    and llv.t_List = " + OBJTYPE_KINDDOC
                    + "    and llv.t_Element = spground.t_Kind "
                    + "  order by spground.t_Kind asc";   */

           query =    "  SELECT COUNT (1) OVER () reccnt, spground.t_Xld, spground.t_kind, \n" +
                      "         CASE \n" +
                      "            WHEN spground.t_kind = 251 THEN r.t_codets \n" +
                      "            ELSE spground.t_AltXld \n" +
                      "         END AltXld, \n" +
                      "         spground.t_RegistrDate, \n" +
                      "         llv.t_Name AS KindName \n" +
                      "    FROM dspground_dbt spground \n" +
                      "         JOIN dllvalues_dbt llv \n" +
                      "            ON llv.t_List = ? AND llv.t_Element = spground.t_Kind \n" +
                      "         JOIN dspgrdoc_dbt spgrdoc \n" +
                      "            ON spground.t_SPgroundID = spgrdoc.t_SPGroundID \n" +
                      "         LEFT JOIN dspgrdoc_dbt rd \n" +
                      "            ON     rd.t_spgroundid = spground.t_spgroundid \n" +
                      "               AND spground.t_kind = 251 \n" +
                      "               AND rd.t_sourcedockind = 350 \n" +
                      "         LEFT JOIN ddl_req_dbt r \n" +
                      "            ON r.t_id = rd.t_SOURCEDOCID \n" +
                      "   WHERE spgrdoc.t_SourceDocKind = ? AND spgrdoc.t_SourceDocID = ? \n" +
                      " ORDER BY spground.t_Kind ASC \n" ;


            Select = DL_RSDCommand(query);
            Select.AddParam(OBJTYPE_KINDDOC);
            Select.AddParam(dl_tick.BOfficeKind);
            Select.AddParam(dl_tick.DealID);

            //cnt = Select.GetCount();
            cnt = 0 ;
            //if(cnt > 0)
              DataSet = Select.Execute();
              if(DataSet.moveNext())
                if(cnt == 0)
                   cnt = int(DataSet.reccnt) ;
                end;
                ReportKind = string(DataSet.KindName);
                DocDate = string(date(DataSet.RegistrDate):f);
                if (dl_tick.marketid > 0)
                  DocNum = DataSet.AltXld;
                else 
                  DocNum = DataSet.Xld;
                end;
              end;

              if(cnt > 1)
                borders = "TRL";
              end;
            //end;
          
            if (IsExcel)
               csvFile = C_CSVFile();
               if (printEngine.UsePoi())
                  csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
               end;
               fName = csvFile.CreateFullFileName("scdlj_mac_csv.txt");
               csvFile.FileOpen(fName, true);

               csvTable = printEngine.RegisterTable("tableRow", "templateTableHeader1", true);
            end;

            if (isExcel and not HeaderPrint)
               printEngine.CopyAllSheetInTotalBook (null, false, "TemplateTableHeader", 0, "Отчет");
               HeaderPrint = true;
            end;

            if(cnt > 1)
              i = 2;
              while(DataSet.moveNext())
                ReportKind2 = string(DataSet.KindName);
                DocDate2 = string(date(DataSet.RegistrDate):f);
                if (dl_tick.marketid > 0)
                  DocNum2 = DataSet.AltXld;
                else 
                  DocNum2 = DataSet.Xld;
                end;

                if (i==2)
                   //первый раз печатаем всегда
                   if( Data.ReportType == SUBREGISTER_DEAL_REPORT )   
                      PrintLine2(ReportTMP.rec.DealCode, DateToStr( ReportTMP.rec.ChangeDate ), SPTimeSplit(ReportTMP.rec.DealTime),
                                 PartyShortName1, ReportTMP.rec.DealKindName, ReportTMP.rec.ContrShortName,ReportTMP.rec.ClientShortName, 
                                 /*ReportTMP.rec.DocNumber*/ docnum2, /*ReportTMP.rec.SfContrNumber*/dl_tick.number,ReportTMP.rec.IssShortName,ReportTMP.rec.AvrKind,
                                 ReportTMP.rec.AvrCode,ReportTMP.rec.AvrSeries,ReportTMP.rec.AvrIssue,
                                 Price,PriceISO,RepoRate1,ReportTMP.rec.Amount,
                                 ReportTMP.rec.SumInNom,PriceISO,ReportTMP.rec.PayCCY,ReportTMP.rec.StateDate,ReportTMP.rec.StateFactDate,
                                 ReportTMP.rec.PayDate, ReportTMP.rec.PayFactDate,ReportKind,DocNum,
                                 DocDate,ReportTMP.rec.RejectInfo,ReportTmp.rec.NoteGround, ReportTmp.rec.NoteArrange,
                                 Data.GetAppFlag, borders, IsExcel);
                   end;   
                end;

                if(i < cnt)
                  borders = "RL";
                else
                  borders = "BRL";
                end;
                               
                if( Data.ReportType == SUBREGISTER_DEAL_REPORT )                                                                                                                                                                                                                                                                                                                 
                   PrintLine2("", "", "",
                              "", "", "","", 
                              "","","","",
                              "","","",
                              "","","","",
                              "","","","","",
                              "", "",ReportKind2,DocNum2,
                              DocDate2,"","", "",
                              Data.GetAppFlag, borders, IsExcel);
                end;

                i = i + 1;
              end;
            else
               //первый раз печатаем всегда
               if( Data.ReportType == SUBREGISTER_DEAL_REPORT )
                  PrintLine2(ReportTMP.rec.DealCode, DateToStr( ReportTMP.rec.ChangeDate ), SPTimeSplit(ReportTMP.rec.DealTime),
                             PartyShortName1, ReportTMP.rec.DealKindName, ReportTMP.rec.ContrShortName,ReportTMP.rec.ClientShortName, 
                             /*ReportTMP.rec.DocNumber*/ docnum, /*ReportTMP.rec.SfContrNumber*/dl_tick.number,ReportTMP.rec.IssShortName,ReportTMP.rec.AvrKind,
                             ReportTMP.rec.AvrCode,ReportTMP.rec.AvrSeries,ReportTMP.rec.AvrIssue,
                             Price,PriceISO,RepoRate1,ReportTMP.rec.Amount,
                             ReportTMP.rec.SumInNom,PriceISO,ReportTMP.rec.PayCCY,ReportTMP.rec.StateDate,ReportTMP.rec.StateFactDate,
                             ReportTMP.rec.PayDate, ReportTMP.rec.PayFactDate,ReportKind,DocNum,
                             DocDate,ReportTMP.rec.RejectInfo,ReportTmp.rec.NoteGround, ReportTmp.rec.NoteArrange,
                             Data.GetAppFlag, borders, IsExcel);
               end;   
            end;

            if (IsExcel)
               csvFile.FileClose();
               csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
               csvTable.EndTable();

               
               printEngine.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                                false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                                csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                                   0,
                                                "Отчет") ;

            end;

         end;                                                   
      end;                                                      

      Continue_cicle = Next( ReportTMP );
   end;

   ReportTMP.DropFilter();
end;

private macro GetSpGroundByEns(Kind:integer)
   var vSpGround = "";

   if( (Kind == KIND_IN) or (Kind == KIND_OUT) )
      vSpGround = "Компенсация";
   elif( Kind == KIND_EX_1 )
      vSpGround = "Поставка";
   else
      vSpGround = "Исполнение";
   end;

   return vSpGround;
end;

private macro GetOperKindByEns(Kind:integer)
   var vSpGround = "";

   if( (Kind == KIND_EX_1) or (Kind == KIND_IN) )
      vSpGround = "Передача";
   else
      vSpGround = "Принятие";
   end;

   return vSpGround;
end;

private macro GetRegistrarByDeal(DealID:integer, RegistrarID:@integer, RegistrarContrID:@integer)
   var Select, DataSet;

   RegistrarID       = 0; 
   RegistrarContrID  = 0;

   Select = DL_RSDCommand("select LEG.T_REGISTRAR, LEG.T_REGISTRARCONTRID from ddl_leg_dbt leg "+
                          " where LEG.T_DEALID  = ? "+ 
                          "   and LEG.T_LEGID = 0 "+
                          "   and LEG.T_LEGKIND = ?"
                         );

   Select.AddParam(DealID);
   Select.AddParam(LEG_KIND_DL_TICK);

   DataSet = Select.Execute();

   if(DataSet.moveNext())
      RegistrarID       = DataSet.REGISTRAR; 
      RegistrarContrID  = DataSet.REGISTRARCONTRID;
      return true;
   end;

   return false;
end;

private macro GetTotalSumFromLot(Kind:integer, DealID:integer, FIID:integer, OnDate:date, Amount:@money, Cost:@money, NKD:@money)
   var Select, DataSet, query;

   Amount = Cost = NKD = $0;

   query = "SELECT nvl(sum(T.T_AMOUNT),0) T_AMOUNT, nvl(sum(T.T_COST),0) T_COST, nvl(sum(T.T_NKDAMOUNT),0) T_NKDAMOUNT "+
           "  FROM v_scwrthistex t, ddlrq_dbt dlrq "+
           " where T.T_DOCKIND = ? "+
           "   and T.T_DOCID = DLRQ.T_ID "+
           "   and DLRQ.T_DOCID = ? "+
           "   and DLRQ.T_TYPE = ? "+
           "   and DLRQ.T_NUM = 0 "+ 
           "   and DLRQ.T_DEALPART = 2 "+
           "   and T.T_FIID = ? ";

   if( Kind == KIND_OUT )
      query = query +
           "   and t.t_instance = (SELECT min(t_instance) - 1 "+
           "                         FROM v_scwrthistex "+
           "                        WHERE t_sumid = t.t_sumid "+
           "                          AND t_action = 480 "+
           "                          AND t_changedate = ? "+
           "                      ) ";
   else
      query = query +
           "   and t.t_instance = (SELECT max(t_instance) "+
           "                         FROM v_scwrthistex "+
           "                        WHERE t_sumid = t.t_sumid "+
           "                          AND t_state != 1 "+
           "                          AND t_changedate <= ? "+
           "                      ) ";
   end;

   Select = DL_RSDCommand( query );

   Select.AddParam(DLDOC_PAYMENT);
   Select.AddParam(DealID);
   Select.AddParam(DLRQ_TYPE_DELIVERY);
   Select.AddParam(FIID);
   Select.AddParam(OnDate);

   DataSet = Select.Execute();

   if(DataSet.moveNext())
      Amount = DataSet.Amount;
      Cost   = DataSet.Cost;
      NKD    = DataSet.NKDAMOUNT;
      return true;
   end;

   return false;
end;

/*Определение примечаний для сделки
   "Основание для включения в Субрегистр спорных сделок", 
   "Принятые меры по разрешению претензий по спорной сделке"*/
private macro GetDealSubRegisterNote( Deal, Date, NoteGround:@STRING, NoteArrange:@STRING)
   NoteGround  = readNoteForObject( OBJTYPE_SECDEAL, UniID( Deal, OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_SR_GROUND, Date );
   NoteArrange = readNoteForObject( OBJTYPE_SECDEAL, UniID( Deal, OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_SR_ARRANGE, Date );
end;


private macro Get_DocNumber(ClientID, DealID, BOKind, IsBack, DocNumber:@STRING, Data)
   var Order1, Order2;
   Order1 = GetSPGroundRecByDeal( DealID, DOCKIND_ORD_CLIENTOP, 1, BOKind );
   if (ClientID == Order1.Party )
      if( Data.ReportType == REGISTER_DEAL_REPORT )
         DocNumber = Order1.ALTXld;
      elif( Data.ReportType == SUBREGISTER_DEAL_REPORT )
         DocNumber = Order1.Xld;
      end;
   end;
end;

/* Сохраняем параметры сделки во временном файле.
      Data        -  данные отчета
      FD          -  FD по соответствующей части сделки
      IsBack      -  обрабатываем вторую часть
      DealCh      -  параметры сделки, записанные в структуру sptkchng
      RejectInfo  -  информация об отказе */
private macro SaveDealInfo( Data, FD, IsBack, DealCh, RejectInfo, DateNote )
   var
      Order1, Order2, Leg1, Leg2, CurLeg,
      DocNum = "", DocDate = date(0,0,0), Group,
      DealID, BOKind, ExistBack, ClientDeal,
      TotalCost, Price = 0.0, CFI, Deal;

   var query, DataSet, Select;

   var DealChnDZ  = TRecHandler( "sptkchng" ),
       FinInDZ    = TRecHandler( "fininstr" ),
       AvoirDZ    = TRecHandler( "avoiriss" ),
       DealChnCur = TRecHandler( "sptkchng" );

   Deal        = FD.tick.rec;
   DealID      = Deal.DealID;
   BOKind      = Deal.BOfficeKind;
   Group       = GetOpGroup( Deal );
   ExistBack   = IsTwoPart(Group);
   ClientDeal  = Deal.ClientID > 0;
   CurLeg      = FD.dl_leg.rec;
   TotalCost   = IIF( IsBack, DealCh.OldTotalCost2, DealCh.OldTotalCost1 );
   CFI         = IIF( IsBack, DealCh.OldCFI2, DealCh.OldCFI1 );
   ClearRecord( ReportTMP );

   /* Определяем вид сделки. */
   if( not ClientDeal )
      ReportTMP.rec.KindRecord = DEALTYPE_OWN;
   else
      if( Data.ReportType == SUBREGISTER_DEAL_REPORT )
         ReportTMP.rec.KindRecord = IIF( r_sfcontr.servkindsub != SUBKIND_DRIVE_CB, DEALTYPE_BROKER, DEALTYPE_DU );
      else
         ReportTMP.rec.KindRecord = DEALTYPE_BROKER;
      end;
   end;

   /* A1 - № сделки
      Номер сделки в системе внутр. учета */
   ReportTMP.rec.DealID   = DealID;
   ReportTMP.rec.DealCode = Deal.DealCode;
   ReportTMP.rec.LegKind = IIF(IsBack, LEG_KIND_DL_TICK_BACK, LEG_KIND_DL_TICK);

   /* D1 - Дата
      Дата заключения сделки. Для включенной настройки "Отображать
      изменение условий сделок в отчетах" для всех вариантов условий сделки
      после первоначального - дата изменения условий сделки. См. "Алгоритм
      формирования отчета". */
   /* DealDate оставляем для правильной сортировки записей. */
   if( Data.ShowDealChange and (DealCh.OldChangeDate != ZeroDate) )
      /* Включена настройка и это не первоначальные условия. */
      ReportTMP.rec.ChangeDate = DealCh.OldChangeDate;
   else
      ReportTMP.rec.ChangeDate = Deal.DealDate;
   end;
   ReportTMP.rec.DealDate = ReportTMP.rec.ChangeDate;

   /* A1.1 = Заполняется, только если включена настройка "Отображать изменение
      условий сделок в отчетах". Для первоначального варианта условий сделки -
      текст "заключ." Для  новых условий сделок, заменяющих старые - текст
      "изменен." */
   if( Data.ShowDealChange )
     /*Chesnokov D.S. Ставим признак отказ*/
     if(index(RejectInfo, "отк.") != 0)
       ReportTmp.rec.ChangeInfo = "отказ";
     else
       ReportTmp.rec.ChangeInfo = IIF(  DealCh.OldInstance != 0,
                                     "изменен.", "заключ." );
     end;
   else
      ReportTmp.rec.ChangeInfo = "";
   end;

   /* Т1 - Время
      Время заключения сделки */
   ReportTMP.rec.DealTime = Deal.DealTime;

   /* A2 - Посредник
      Для биржевых сделок - сокр. наименование биржи
      для внебиржевых - "вне биржи"
      брокера - сокр наименование биржи (если указана) */
   if( IsEXCHANGE(Group, true) and (not FD.СделкаРЕПОБрокер()) )
      ReportTMP.rec.PartyShortName = ПолучитьКороткоеИмяСубъекта( Deal.MarketID, Deal.dealdate );
   elif( IsOutEXCHANGE(Group,  true) and (not FD.СделкаРЕПОБрокер()) )
         Data.AgentId = ОпределитьПосредникаСделки( Deal );
         if( Data.AgentId != -1)
            ReportTMP.rec.PartyShortName = GetPartyShortNameByID(Data.AgentId);
         end;

         if((not ReportTMP.rec.PartyShortName) or (IsOTC(Group)) ) 
      ReportTMP.rec.PartyShortName = "вне биржи";
         end;
   elif( IsBROKER(Group) or FD.СделкаРЕПОБрокер() )
      ReportTMP.rec.BrokerShortName = "брокер " + ПолучитьКороткоеИмяСубъекта( Deal.BrokerID, Deal.dealdate );
      if( Deal.MarketID <= 0 )
         ReportTMP.rec.PartyShortName = "";
      else
         ReportTMP.rec.PartyShortName = ПолучитьКороткоеИмяСубъекта( Deal.MarketID, Deal.dealdate );
      end;
   end;

   /* A3 - Вид сделки
      Наименование вида операции: "Покупка", "Продажа", "Продажа с ОВ, 1
      ч.", "Продажа с ОВ, 2 ч." , "Покупка с ОП, 1ч.", "Покупка с ОП, 1ч.",
      "Покупка с ОП, 2ч.", "Прямое РЕПО, 1ч.", "Прямое РЕПО, 2ч.",
      "Обратное РЕПО, 1ч.", "Обратное РЕПО, 2ч.", "Погашение". Термин
      "прямое РЕПО" используется для операций "РЕПО/продажа", "обратное
      РЕПО" - для операций "РЕПО/покупка". */
   if ((Deal.IsPartyClient == SET_CHAR) and (Deal.PartyContrID != 0) and (not ClientDeal))
      ReportTMP.rec.DealKindName = ПолучитьВидСделкиКонтрагентаД( Group, IsBack, true, true );
   else
      ReportTMP.rec.DealKindName = ПолучитьВидОперации( Group, IsBack, true, true );
   end;

   /* A4 - Контрагент
      Для внебиржевых сделок - сокращенное наименование контрагента, код
      которого указан в  параметрах сделки. Для биржевых сделок -
      сокращенное наименование контрагента, код которого указан в поле
      "Контрагент по биржевой сделке", а если код там не указан - то не
      заполняется. */
   if ((Deal.IsPartyClient == SET_CHAR) and (Deal.PartyContrID != 0) and (not ClientDeal))
      ReportTMP.rec.ContrShortName = "";
   else
      ReportTMP.rec.ContrShortName = "";
      if( IsOutEXCHANGE(Group) or IsEXCHANGE(Group) )
         ReportTMP.rec.ContrShortName = ПолучитьКороткоеИмяСубъекта( Deal.PartyID, Deal.dealdate );
      end;
   end;

   /* A5 - Клиент
      Краткое наименование клиента; если сделка собственная, то поле не
      заполняется */
   if( ClientDeal )
      ReportTMP.rec.ClientShortName = ПолучитьКороткоеИмяСубъекта( Deal.ClientID, Deal.dealdate );
   else
      if ((Deal.IsPartyClient == SET_CHAR) and (Deal.PartyContrID != 0))
         ReportTMP.rec.ClientShortName = ПолучитьКороткоеИмяСубъекта( Deal.PartyID, Deal.dealdate );
      end;
   end;

   /* A6 - № поручения
      Если сделка для клиента, то - № поручения на сделку
      (Dl_tick.IndocId), иначе - не заполняется. Если для сделки с обратной
      продажей/покупкой в "Документах по сделке" пользователем заданы
      параметры двух поручений, то для первой части выводить поручение с
      более ранней датой и временем приема, а для второй - с более поздней
      датой и временем приема. */
   ReportTMP.rec.DocNumber = "";
   if( ClientDeal )
      Get_DocNumber(Deal.ClientID, DealID, BOKind, IsBack, @ReportTMP.rec.DocNumber,Data);
   else
      if ((Deal.IsPartyClient == SET_CHAR) and (Deal.PartyContrID != 0))
         Get_DocNumber(Deal.PartyID, DealID, BOKind, IsBack, @ReportTMP.rec.DocNumber,Data);
      end;
   end;

   /* A6.1 - № поручения
      Только для клиентских сделок с контрагентом Д - № поручения на сделку,
      контрагентом по которому является контрагент Д*/
   ReportTMP.rec.DocNumberD = "";
   if( ClientDeal AND (Deal.IsPartyClient == SET_CHAR) AND (Deal.PartyContrID != 0) )
      Get_DocNumber(Deal.ClientID, DealID, BOKind, IsBack, @ReportTMP.rec.DocNumberD,Data);
   end;

   /* A7 - № договора
      № договора банка с клиентом, который был выбран для клиента при вводе
      сделки, для собственных сделок банка поле не заполняется */
   ReportTMP.rec.SfContrNumber = "";
   if( ClientDeal )
      ReportTMP.rec.SfContrNumber = GetContrNumberByID( Deal.ClientContrID );
   else
      if ((Deal.IsPartyClient == SET_CHAR) AND (Deal.PartyContrID != 0))
//         ReportTMP.rec.SfContrNumber = GetContrNumberByID( Deal.PartyContrID );  до исправления длины поля бесполезно, убрал для оптимизации
      end;
   end;

   /* A7.1 - № договора
      Только для клиентских сделок с контрагентом Д - № договора банка с контрагентом Д,
      который был выбран для контрагента при вводе сделки*/
   ReportTMP.rec.SfContrNumberD = "";
   if( ClientDeal AND (Deal.IsPartyClient == SET_CHAR) AND (Deal.PartyContrID != 0))
      ReportTMP.rec.SfContrNumberD = GetContrNumberByID( Deal.PartyContrID );
   end;

   /*5.  В отчете выводится та ценная бумага, которая была указана при заключении сделки*/
   SP_GetDealParmsByDate( FD.tick, FD.tick.rec.DealDate, DealChnDZ );
   if( ПолучитьФинИн(IIF( IsBack, DealChnDZ.rec.OldPFI2, DealChnDZ.rec.OldPFI1 ),FinInDZ,AvoirDZ) == 0 )
      /* A8 - Эмитент
         Краткое наименование эмитента */
      ReportTMP.rec.IssShortName = ПолучитьКороткоеИмяСубъекта( FI_GetIssuerOnDate( FinInDZ, Data.dateMax), Deal.dealdate);

      /* A9.1 - Вид ц/б
         Сокращенное наименование вида ценной бумаги */
      AvoirKindName( FinInDZ.rec.AvoirKind, ReportTMP.rec.AvrKind );
     
      /* A10 - Код ц/б
         Код ц/б (Fininstr.FI_Code) */
      ReportTMP.rec.AvrCode = FinInDZ.rec.FI_Code;
     
      /* A12 - Серия, транш
         Серия ц/б */
      ReportTMP.rec.AvrSeries = AvoirDZ.rec.Series;
     
      /* A12.1 - Транш
         Транш ц/б (вторая очередь) */
      ReportTMP.rec.AvrIssue = AvoirDZ.rec.Tranche;
   end;

   /* М1 - Цена/Ставка РЕПО
      Для всех сделок, кроме 2 части РЕПО выводится цена одной ц/б, для 2
      части РЕПО выводится ставка РЕПО и символ "%". */
   if( not IsBasket(FD.Group) )
      if( IsTwoPart(Group) AND IsBack )
         /* Вторая часть сделок РЕПО */
         ReportTMP.rec.RepoRate = Data.NumToStr( DealCh.OldIncomeRate ) + " %";
         if(Data.ReportType == REGISTER_DEAL_REPORT)
            ReportTMP.rec.RepoRateCCY = GetFinInstrCcy( CFI );
         end;
      elif(not IsDealKSU(FD.Group))
         Price = GetPriceByDlTickDlLeg( Deal, CurLeg, false, DealCh );
         ReportTMP.rec.RepoRate    = Data.NumToStr( Price, CurLeg.Point );
         ReportTMP.rec.RepoRateCCY = GetFinInstrCcy( CFI );
      end;
   else
      ReportTMP.rec.RepoRateCCY = GetFinInstrCcy( CFI );
   end;

   /* N1 - Кол-во = Количество ц/б */
   ReportTMP.rec.Amount = IIF(IsBasket(FD.Group), 1, DealCh.OldPrincipal);

   /* М2 - Сумма сделки
      Сумма сделки (или 2 части для сделок с ОП и РЕПО) в валюте цены */
   ReportTMP.rec.SumInNom = TotalCost;

   /* Сумма сделки в валюте расчёта */
   if(CFI != FD.dl_leg.rec.PayFIID)
      SmartConvertSum(ReportTMP.rec.SumInCalc, money(TotalCost), date(Deal.DealDate), CFI, FD.dl_leg.rec.PayFIID, false);
   else
      ReportTMP.rec.SumInCalc = TotalCost;
   end;

   /* A14 - Валюта расчетов
      Буквенный код валюты (по ISO) из платежа по оплате ц/б */
   ReportTMP.rec.PayCCY = GetFinInstrCcy( FD.dl_leg.rec.PayFIID );

   ReportTMP.rec.ReportKind = ReportTMP.rec.ReportNum = ReportTMP.rec.ReportDate = "";

   /* D2 - Перерегистрация план.
      Плановая дата поставки ц/б */
   ReportTMP.rec.StateDate = DateToStr( GetDealSetAvPlanDate(CurLeg, DealCh) );

  /* Дата поставки ц/б - фактическая */
//  ReportTMP.rec.StateFactDate = date_as_string( 1, FD.DateArray[DATE_DEALSETAVOIRISS]);
  ReportTMP.rec.StateFactDate = date_as_string( 1, FD.GetRQ(8, iif(FD.IsBack,2,1)).rec.factdate);

 
  if ( FD.pm_avoir.dlreq == null ) 
    msgbox("Не найдено ТО по поставке сделки с кодом "+FD.tick.rec.DealCode);
    ReportTMP.rec.StateFactDate = Date(0,0,0);
  elif ( not ТОЗакрыто(FD.pm_avoir.dlreq) ) 
    ReportTMP.rec.StateFactDate = Date(0,0,0);
  end;
  if ((WasRejectDealPart( FD.dl_leg.rec ) AND FD.IsBack)) 
    ReportTMP.rec.StateFactDate = "";
  end;

   /* D3 - Дата оплаты план
      Плановая дата платежа по оплате ц/б */
   ReportTMP.rec.PayDate = DateToStr( GetDealPayPlanDate(CurLeg, DealCh) );

  /* Дата оплаты ц/б - фактическая */
//  ReportTMP.rec.PayFactDate = date_as_string( 1, FD.DateArray[DATE_DEALPAY]);
  ReportTMP.rec.PayFactDate = date_as_string( 1, FD.GetRQ(2,iif(FD.IsBack,2,1)).rec.factdate);

  if(not IsLoan(FD.Group))
    if ( FD.pm_money.dlreq == null ) 
      msgbox("Не найдено ТО по оплате сделки с кодом "+FD.tick.rec.DealCode);
      ReportTMP.rec.StateFactDate = Date(0,0,0);
    elif( not ТОЗакрыто(FD.pm_money.dlreq) )
      ReportTMP.rec.PayFactDate = Date(0,0,0);
    end;
  end;
  if ((WasRejectDealPart( FD.dl_leg.rec )) AND FD.IsBack ) 
    ReportTMP.rec.PayFactDate = "";
  end;

  ReportTMP.rec.ReportKind = "";
  ReportTMP.rec.ReportNum  = "";      /*№ отчета*/
  ReportTMP.rec.ReportDate = "";     /*Дата отчета*/

  /* D4 - Отказ */
  ReportTMP.rec.RejectInfo = RejectInfo;

  if( Data.ReportType == SUBREGISTER_DEAL_REPORT )
     GetDealSubRegisterNote( FD.tick, DateNote, @ReportTMP.rec.NoteGround, @ReportTMP.rec.NoteArrange );
  end;

  InsertRecTempTBFile( ReportTMP );
     
end;

private macro CheckDeal( Data, Deal, LegKind, FD )
   var DealChnCur  = TRecHandler( "sptkchng" );
   var scdljr, count = 0, query, NameFile;
   var Group = GetOpGroup( Deal.rec );
   //var FD = SPFirstDoc( LegKind, Deal.rec.DealID );

   /*Погашение купонов попадать в отчет не должны*/
   if(IsRET_COUPON(Group))
      return false;
   end;

   if ((Data.DealNotMarket == false) AND (IsOTC(Group)) )
      return false;
   end;

   SP_GetDealParmsByDate( Deal, Deal.rec.DealDate, DealChnCur );

   if( Data.AvrID != -1 )
      if( FD.IsBack AND (DealChnCur.rec.OldPFI2 != Data.AvrID) )
         return false;
      elif( (not FD.IsBack) AND (DealChnCur.rec.OldPFI1 != Data.AvrID))
         return false;
      end;
   end;

   Data.AgentId = ОпределитьПосредникаСделки( Deal.rec );
     
   if(not(((Data.DealMarket == true) AND (IsEXCHANGE(Group, true)) AND (not FD.СделкаРЕПОБрокер()) ) OR
          ( (Data.DealMarket == true) AND ((IsOUTEXCHANGE(Group, true)) AND ( Data.AgentId != -1) )) OR
          ((Data.DealNotMarket == true) AND (IsOUTEXCHANGE(Group, true)) AND (not FD.СделкаРЕПОБрокер())) OR
          ((Data.DealBroker == true) AND ((IsBROKER(Group)) or FD.СделкаРЕПОБрокер())) OR
          ((Data.DealREPO == true) AND (IsREPO(Group))) OR // DEF-62655, как иначе сделки РЕПО в отчет попадут?                    
          IsLoan(FD.Group)
         )
     ) 
     return false;
   end;

   if(Data.DealType != -1)  /*Указан тип сделки*/
     if(Deal.rec.ClientID > 0) 
        if((Data.DealType != SC_DEAL_BROKER) and (Data.DealType != SC_DEAL_CB))
           return false;
        else
           if( ПолучитьДоговорПоСделке( Deal, r_sfcontr, false, true) )
              if( ((Data.DealType == SC_DEAL_BROKER) AND (r_sfcontr.servkindsub != SUBKIND_DRIVE_CB) AND 
                    (Data.ReportType == SUBREGISTER_DEAL_REPORT)) OR
                  ((Data.DealType == SC_DEAL_BROKER) AND (r_sfcontr.servkindsub == SUBKIND_DRIVE_CB) AND 
                    (Data.ReportType == REGISTER_DEAL_REPORT)) OR
                  ((Data.DealType == SC_DEAL_CB)     AND (r_sfcontr.servkindsub != SUBKIND_DRIVE_CB))
                )
                 return false;
              end;
           end;
        end;
     end;
   end;

   if( Data.ReportType == SUBREGISTER_DEAL_REPORT )
      /*только по тем сделкам, по которым задано хотя бы одно из двух примечаний: 
        "Основание для включения в Субрегистр спорных сделок", 
        "Принятые меры по разрешению претензий по спорной сделке",
         причем дата соответствующего примечания не превышает
         дату окончания отчетного периода.
         Дата закрытия сделки НЕ меньше даты начала отчетного периода.
       */
      if(not ((Deal.rec.CloseDate == date(0, 0, 0)) OR (Deal.rec.CloseDate >= Data.dateMin)))
        return false;
      end;

      /*Проверим, включена ли уже   проверяемая сделка в отчёт*/
      NameFile = FileName(ReportTMP);
      NameFile = "d"+NameFile;
      NameFile = StrSubst ( NameFile, ".", "_" );

      query = " SELECT t_DealCode"
            + " FROM " + NameFile
            + " WHERE t_DealCode    = '" + string(Deal.rec.DealCode) + "'"
            + "   AND t_LegKind     = " + string(LegKind);

      scdljr = TRsbDataSet( query );

      if (scdljr.MoveNext()) /*Часть сделки уже включена*/
        return false;
      end;
   end;
   return true;
end;

/*По конкретному филиалу*/
private macro ExecuteReportByDepartment( Data )

   /* Обрабатываем часть сделки. */
   macro ProcessDealPart( Deal, FD, IsBack, DateNote )
      var
         DealChange  = TRecHandler( "sptkchng" ),
         DealChangeOld  = TRecHandler( "sptkchng" ),
         DealChnCur  = TRecHandler( "sptkchng" ),
         ArrDateChange, ChngCounter, RejectInfo, ChangeIsBack = false;

      /* Получаем текущие условия сделки. */
      SP_GetDealParmsByDate( Deal, Deal.rec.ChangeDate, DealChnCur );

      /* Получаем параметры отказа.
         D4 - Отказ = Если по сделке был выполнен отказ от второй части, то
         выводится дата фактического выполнения шага сделки "Отказ от
         исполнения 2 части". Если был выполнен отказ сделки, то выводится
         дата фактического выполнения шага сделки "Отказ от сделки" A17 =
         Если по сделке был выполнен отказ от второй части, то выводится
         текст "отк. от  2ч". Если был выполнен отказ сделки, то выводится
         текст "отк. от сделки" */
      RejectInfo = "";
      if( DealChnCur.rec.OldRejectDate1 != ZeroDate )
         RejectInfo =  DateToStr( DealChnCur.rec.OldRejectDate1 )
                                 + "\n" + "отк. от сделки";
      elif( FD.ExistBack )
         if( DealChnCur.rec.OldRejectDate2 != ZeroDate )
            RejectInfo =  DateToStr( DealChnCur.rec.OldRejectDate2 )
                                    + "\n" + "отк. от 2ч";
         end;
      end;

      if( Data.ShowDealChange )
         /* Надо показывать изменение условий. */

         /* Получим массив дат изменения условий сделки. */
         ArrDateChange = GetArrayDateDealChangeEx( Deal.rec, " and t_OldChangeKind NOT IN (2,3,4,9) " );

         if( ArrDateChange.Size == 0 )
            /* Изменений нет. Сохраняем текущие условия. */
            SP_GetDealParmsByDate( Deal, Deal.rec.DealDate, DealChnCur, false, false );
            SaveDealInfo( Data, FD, IsBack, DealChnCur.rec, RejectInfo, DateNote );
         else
         /* Сохраняем измененные условия. */
         ChngCounter = 0;
         while( ChngCounter < ArrDateChange.Size )
            DealChange.Clear();
            SP_GetDealParmsByDate( Deal, ArrDateChange[ChngCounter], DealChange, false, false );

            if( ChngCounter )
               SP_GetDealParmsByDate( Deal, ArrDateChange[ChngCounter-1], DealChangeOld, false, false );
            end;

               if((not((IsBack == false) and (DealChange.rec.oldInstance == 0))) and
                  ((DealChange.rec.OldCFI2 != DealChangeOld.rec.OldCFI2) 
                  OR (DealChange.rec.OldPrice2 != DealChangeOld.rec.OldPrice2)
                  OR (DealChange.rec.OldPoint2 != DealChangeOld.rec.OldPoint2)         
                  OR (DealChange.rec.OldCost2 != DealChangeOld.rec.OldCost2)
                  OR (DealChange.rec.OldTotalCost2 != DealChangeOld.rec.OldTotalCost2)
                  OR (DealChange.rec.OldFormula2 != DealChangeOld.rec.OldFormula2)
                  OR (DealChange.rec.OldNKD2 != DealChangeOld.rec.OldNKD2)
                  OR (DealChange.rec.OldPFI2 != DealChangeOld.rec.OldPFI2)
                  OR (DealChange.rec.OldPayFIID2 != DealChangeOld.rec.OldPayFIID2)
                  OR (DealChange.rec.OldAdvance2 != DealChangeOld.rec.OldAdvance2)   
                  OR (DealChange.rec.OldStart2 != DealChangeOld.rec.OldStart2)              
                  OR (DealChange.rec.OldExpiry2 != DealChangeOld.rec.OldExpiry2)
                  OR (DealChange.rec.OldMaturity2 != DealChangeOld.rec.OldMaturity2)
                  OR (DealChange.rec.OldMaturityIsPrincipal2 != DealChangeOld.rec.OldMaturityIsPrincipal2)
                  OR (DealChange.rec.OldPayRegTax2 != DealChangeOld.rec.OldPayRegTax2)
                  OR (DealChange.rec.OldRegistrar2 != DealChangeOld.rec.OldRegistrar2)
                     OR (DealChange.rec.OldRejectDate2 != DealChangeOld.rec.OldRejectDate2))
              )
                ChangeIsBack = true;
            end; 

            if( ((IsBack != false) AND (ChangeIsBack != false)) OR 
                ((IsBack != true) AND (ChangeIsBack != true)) 
              )
            SaveDealInfo( Data, FD, IsBack, DealChange.rec, RejectInfo, DateNote );
            end;

            ChangeIsBack = false;
            inc( ChngCounter );
         end;
         end;
      else
         /* Показывать изменение условий не надо.
            Покажем текущие условия. */
         SaveDealInfo( Data, FD, IsBack, DealChnCur.rec, RejectInfo, DateNote );
      end;
   end;

   macro ProcessOneDeal_SubRegister( FDeals, Data, DateNote, LegKind )
      var FD=SPFirstDoc( LegKind, FDeals.rec.DealID );;
      if( CheckDeal(Data, FDeals, LegKind, FD) )

         /* Получаем FD по сделке. */
         //FD = SPFirstDoc( LegKind, FDeals.rec.DealID );

         /* Обрабатываем только одну часть, которая попалась. */
         ProcessDealPart( FDeals, FD, (LegKind == LEG_KIND_DL_TICK_BACK), DateNote );
      end;
   end;

   macro ProcessOneDeal( FDeals, Data, DateNote )
      var DealChnDZ  = TRecHandler( "sptkchng" ),
          FinInDZ    = TRecHandler( "fininstr" ),
          AvoirDZ    = TRecHandler( "avoiriss" );
      var FD = SPFirstDoc( LEG_KIND_DL_TICK, FDeals.rec.DealID );;
      var isQualified;

      if( CheckDeal(Data, FDeals, LEG_KIND_DL_TICK, FD) )

         /* Получаем FD по сделке. */
         //FD = SPFirstDoc( LEG_KIND_DL_TICK, FDeals.rec.DealID );

         SP_GetDealParmsByDate( FD.tick, FD.tick.rec.DealDate, DealChnDZ );
         if( ПолучитьФинИн(DealChnDZ.rec.OldPFI1,FinInDZ,AvoirDZ) )
            return;
         end;

         isQualified = QualifiedSecur(AvoirDZ, FinInDZ, FDeals.rec.DealDate);

         if( Data.Qualified == -1 )
         elif( (Data.Qualified == 0) AND (isQualified == true ) )
         elif( (Data.Qualified == 1) AND (isQualified == false) )
         elif( (Data.Qualified == 2) AND (isQualified == false) AND (IsBuy(FD.Group) == true) )
         else
            return;
         end;
         
         /* Обрабатываем первую часть. */
         ProcessDealPart( FDeals, FD, false, DateNote );

         /* Обрабатываем вторую часть. */
         if( FD.ExistBack OR IsLOAN(FD.Group) )
            FD = SPFirstDoc( LEG_KIND_DL_TICK_BACK, FDeals.rec.DealID );
            ProcessDealPart( FDeals, FD, true, DateNote );
         end;

      end;
   end;

   macro ProcessDeals( FDeals, Data, DealID, DateNote, LegKind )
      var Query, CheckFinCond = false, sqlQuery, DataQuery, NRec, DataQueryNRec, dl_tick, cmd;
      /* Сформируем условие проверки финансового инструмета. */
      if( (Data.AvrTypeID != -1) or (Data.EmiID > 0) or (Data.AvrID != -1) )
         CheckFinCond = true;
      end;

      Query =  "select count(1) over () as reccnt ,tick.t_DealID " +
               "  from ddl_tick_dbt tick left outer join dparty_dbt Pty on  Pty.T_PARTYID =  case when tick.T_CLIENTID  = -1 then " + {OurBank} +"   else tick.T_CLIENTID end  ";

      if( CheckFinCond )
         Query = Query + ", dfininstr_dbt fin " ;
      end;

      Query = Query + " where " +
               IIF (Data.ReportType == REGISTER_DEAL_REPORT,
                      "tick.t_DealDate >= " + GetSQLDate(Data.dateMin) +
               " and tick.t_DealDate <= " + GetSQLDate(Data.dateMax) +
               " and ", "")
               +    "tick.t_BofficeKind = " + string(DL_SECURITYDOC) +
               " and tick.t_DealStatus >= " + string(DL_READIED) +
               IIF(   Data.DealStatus != -1,
                        " and tick.t_DealStatus = " + string(Data.DealStatus), "" )
               + IIF(   Data.DprtID != -1,
                        " and tick.t_Department = " + string(Data.DprtID), "" )
               + IIF(   Data.ClientID > 0,
                        " and (tick.t_ClientID = " + string(Data.ClientID) + 
                        " or  ( tick.t_PartyID = " + string(Data.ClientID) + 
                        " and   tick.t_IsPartyClient = 'X' ) )", "" )   ;

      if( (Data.IsForm > 0) and (Data.FormSub != 0) )
        if(Data.IsForm == 1)
          Query = Query + "    and ( Pty.T_LEGALFORM = " + String (Data.FormSub) + ")";
        end;
        if(Data.IsForm == 2)            	
          Query = Query + "    and  ( Pty.T_LEGALFORM !=   " + String (Data.FormSub) + ")";
        end;
      end;
    
      if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
        if(Data.IsVid == 1)
          Query = Query + "   and   ( EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID))  " ;
        end;
        if(Data.IsVid == 2)            	
          Query = Query + "    and   (NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID))  " ;
        end;
      end;

      /// DEF-54142
      if (Data.DealRepo)
        Query = Query + "   and  (RSB_SECUR.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1) ";
      end;
      /// end of DEF-54142 

      if(Data.NoResident)
        Query = Query + " and ( Pty.T_NOTRESIDENT = 'X')"; 
      end;

      Query = Query    + IIF(   Data.MarketID > 0,
                        " and tick.t_MarketID = " + string(Data.MarketID), "" )
               + IIF(   Data.BrokerID > 0,
                        " and tick.t_BrokerID = " + string(Data.BrokerID), "" )
               + IIF(   (Data.DealType != SC_DEAL_OWN) and (Data.DealType != -1),
                        " and tick.t_ClientID > 0", "" )
               + IIF(   Data.DealType == SC_DEAL_OWN,
                        " and tick.t_ClientID <= 0", "" )
               + IIF(   Data.ReportType == SUBREGISTER_DEAL_REPORT,
                        " and tick.t_DealID = " +DealID,"");

      if( CheckFinCond )
          /*в отчете выводится та ценная бумага, которая была указана при заключении сделки*/
         if( Data.AvrID != -1 )
            Query = Query + " and fin.t_FIID = "+Data.AvrID;
         else
            if( Data.AvrTypeID != -1 )
               Query = Query + " and RSB_FIInstr.FI_AvrKindsEQ(2,"+Data.AvrTypeID+", fin.t_AvoirKind) = 1 ";
            end;
            
            if( Data.EmiID > 0 )
               Query = Query + " and fin.t_Issuer = " + string(Data.EmiID);
            end;
         end;

         Query = Query +
              " and ("+
              "      (select count(1) "+
              "         from dsptkchng_dbt sptk "+
              "        where sptk.t_DealID = tick.t_DealID "+
              "          and sptk.t_OldInstance = (select NVL(max(sptk2.t_OldInstance),-1) "+
              "                                      from dsptkchng_dbt sptk2 "+
              "                                     where sptk2.t_DealID = tick.t_DealID "+
              "                                       and sptk2.t_OldChangeDate = (select NVL(max(sptk1.t_OldChangeDate),'01.01.0001') "+
              "                                                                     from dsptkchng_dbt sptk1 "+
              "                                                                    where sptk1.t_DealID = tick.t_DealID"+
              "                                                                      and sptk1.t_OldChangeDate <= tick.t_DealDate) "+
              "                                   )"+
              "          and (sptk.t_OldPFI1 = fin.t_FIID or sptk.t_OldPFI2 = fin.t_FIID)"+
              "      ) > 0 "+
              "      or ((select count(1) "+
              "             from ddl_leg_dbt leg"+
              "            where leg.t_DealID = tick.t_DealID "+
              "              and leg.t_PFI = fin.t_FIID "+
              "          ) > 0 and (tick.t_ChangeDate = '01.01.0001' or tick.t_ChangeDate <= tick.t_DealDate)) "+
              "     )";                                      
      end;

      // DEF-54007, в отчете нужна сортировка
      Query = Query + " ORDER BY tick.t_DealDate, tick.t_DealTime ";

      sqlQuery = RSDCommand(Query);
      sqlQuery.execute();
      DataQuery = TRsbDataSet( sqlQuery );

      if (Data.ReportType == SUBREGISTER_DEAL_REPORT)
         if(DataQuery.MoveNext())
            cmd = DL_RSDCommand ("select * from ddl_tick_dbt where t_dealid = ? and t_bofficekind = 101 ");
            cmd.addParam(dealid); 
            dl_tick = cmd.execute();//RsdRecordSet(dl_tick);

            //FDeals.Clear;
            //FDeals.rec.DealID = DealID;
            if (dl_tick.movenext() /*FDeals.GetEQ()*/)
                dl_tick.GetRecord().CopyTo(FDeals.rec);
                ProcessOneDeal_SubRegister( FDeals, Data, DateNote, LegKind );
            end;
         end;
      else
          NRec = 0;
         //sqlQueryNRec = RSDCommand("select count(1) NRec from (" +Query+ ")");
         //sqlQueryNRec.execute();
         //DataQueryNRec = TRsbDataSet(sqlQueryNRec);

         /*if( DataQueryNRec.MoveNext() )
             InitProgressBar( Int(DataQueryNRec.NRec), "Отчет \"Регистр сделок\"",
                           "Просмотр сделок" );
         end; */
         while(DataQuery.MoveNext())
          if( NRec == 0 )
              NRec = int(DataQuery.reccnt);
             InitProgressBar( NRec, "Отчет \"Регистр сделок\"",
                           "Просмотр сделок" );
           end; 
            cmd = DL_RSDCommand ("select * from ddl_tick_dbt where t_dealid = ? and t_bofficekind = 101 ");
            cmd.addParam(DataQuery.DealID); 
            dl_tick = cmd.execute(); //RsdRecordSet(dl_tick);

//            FDeals.Clear;
//            FDeals.rec.DealID = DataQuery.DealID;
            if( dl_tick.movenext() /*FDeals.GetEQ() */)
               dl_tick.GetRecord().CopyTo(FDeals.rec);
               ProcessOneDeal( FDeals, Data );
               UseProgressBar;
            end;
         end;
         RemProgressBar;
      end;
   end;

   var  
      FDeals   = TBFile( "dl_tick", "R" ),
      NoteText = TBFile( "notetext", "R" ),
      rOper    = TRecHandler( "oproper.dbt" ),
      QueryNoteText, NoteGround, NoteArrange, Query, DataSet, LegKind, OK;
      record deal("dl_tick");

   Clone( ReportTMP );

   Data.PrintHead = false;

   FDeals.KeyNum = 0;
   if( Data.ReportType == REGISTER_DEAL_REPORT )
      ProcessDeals( FDeals, Data );
   else
      /*Перебор NoteText, получаем сделку*/
      QueryNoteText =
              "     t_ValidToDate >= " + GetSQLDate(Data.dateMin)
            + " and t_Date <= " + GetSQLDate(Data.dateMax)
            + " and t_ObjectType = " + string(OBJTYPE_SECDEAL)
            + " and (t_NoteKind  = " + string(NOTEKIND_SECDEAL_SR_GROUND)
            + " or   t_NoteKind  = " + string(NOTEKIND_SECDEAL_SR_ARRANGE) + ") ";

      NoteText.Clear;
      NoteText.AddFilter( QueryNoteText );

      InitProgressBar(  NoteText.NRecords, "Отчет \"Субрегистр спорных сделок\"",
                        "Просмотр примечаний" );

      while( NoteText.Next ) 

         if( RestoreFromUniID( NoteText.rec.DocumentID, deal, OBJTYPE_SECDEAL ))
            GetDealSubRegisterNote( deal, NoteText.rec.Date, @NoteGround, @NoteArrange);
            if ((NoteGround != "") OR (NoteArrange != ""))
               FDeals.Clear();
               FDeals.rec.DealID = deal.DealID;
               if (FDeals.GetEQ())
                  /*Проверим, что для этой сделки есть запись об изменении, 
                    дата которого (sptkchng.OldChangeDate, или dl_tick.ChangeDate) равна NoteText.Date.
                    Кроме того, вид изменения - просрочка (оплаты, аванса или поставки).
                    По символу шага просрочки определяем часть сделки.

                    Если такую запись об изменении не нашли - выводим сообщение в лог.
                  */

                  if( ПолучитьОперациюПоСделке( FDeals, rOper ) )

                     Query = RSDCommand(" Select b.t_Symbol as Symbol, sp.t_DealID as DealID "
                           + "   From doprstep_dbt oprstep, doproblck_dbt b, dsptkchng_dbt sp "
                           + "  Where oprstep.t_ID_Operation = ? "
                           + "    and oprstep.t_IsExecute    = 'X' "

                           + "    and b.t_BlockID            = oprstep.t_BlockID "

                           + "    and (   b.t_Symbol   = '?' " /*Перенос на просрочку поставки 2ч*/
                           + "         or b.t_Symbol   = '*' " /*Перенос на просрочку оплаты 2ч*/
                           + "         or b.t_Symbol   = '9' " /*Перенос на просрочку аванса 2ч*/
                           + "         or b.t_Symbol   = 'б' " /*Отложить аванс/оплату по 2ч*/
                           + "         or b.t_Symbol   = 'г' " /*Отложить поставку по 2ч*/
                           + "        ) "

                           + "    and sp.t_ID_Operation       = oprstep.t_ID_Operation " 
                           + "    and sp.t_ID_Step            = oprstep.t_ID_Step " 

                             /*Проверка даты шагов:*/

                           + "    and ( exists ( Select sp2.t_DealID "
                           + "                     From dsptkchng_dbt sp2 "
                           + "                    Where sp2.t_DealID       = sp.t_DealID "
                           + "                      and sp2.t_OldInstance  = sp.t_OldInstance + 1 "
                           + "                      and sp.t_OldInstance != ( "
                           + "                                                 Select MAX(sp3.t_OldInstance) "
                           + "                                                   From dsptkchng_dbt sp3 " 
                           + "                                                  Where sp3.t_DealID = sp.t_DealID "
                           + "                                               ) "
                           + "                      and sp2.t_OldChangeDate = ? "
                           + "                 ) "
                           + "          or "
                           + "          exists ( Select dl.t_DealID "
                           + "                     From ddl_tick_dbt dl "
                           + "                    Where dl.t_DealID        = sp.t_DealID "
                           + "                      and dl.t_Instance   = sp.t_OldInstance + 1 "
                           + "                      and dl.t_ChangeDate = ? "
                           + "                 ) "
                           + "        ) ");

                     Query.addParam( "", RSDBP_IN, rOper.rec.ID_Operation );
                     Query.addParam( "", RSDBP_IN, NoteText.rec.Date );
                     Query.addParam( "", RSDBP_IN, NoteText.rec.Date );
                     Query.execute();
                     DataSet = TRsbDataSet( Query );

                     OK = false;
                     if(DataSet.MoveNext())
                        ProcessDeals( FDeals, Data, FDeals.rec.DealID, NoteText.rec.Date, LEG_KIND_DL_TICK_BACK );
                     else
                        ProcessDeals( FDeals, Data, FDeals.rec.DealID, NoteText.rec.Date, LEG_KIND_DL_TICK );
                     end;
                  end;
               end;
            end;
         end;

         UseProgressBar;
      end;
      NoteText.DropFilter;
      RemProgressBar;
   end;

end;

private macro PrintReportByDepartment( Data, IsExcel:bool )
   
   var selSQL, DateData;

   if( Data.IsPartDate == true )
      selSQL = RSDCommand("select distinct(t_ChangeDate) as ReportDate from dscdljr_tmp order by t_ChangeDate");

      selSQL.execute();
      DateData = TRsbDataSet( selSQL );

      while( DateData.MoveNext() )

         PrintReportHead( Data, Date(DateData.ReportDate), IsExcel );
         PrintHead( Data, IsExcel );

         Message( "Печать отчета по собственным сделкам" );
         PrintDeals( "Собственные сделки", Data, DEALTYPE_OWN, Date(DateData.ReportDate), IsExcel ); 

         Message( "Печать отчета по брокерским сделкам" );
         PrintDeals( "Брокерские сделки", Data, DEALTYPE_BROKER, Date(DateData.ReportDate), IsExcel ); 

         Message( "Печать отчета по сделкам доверительного управления" );
         PrintDeals( "Доверительное управление", Data, DEALTYPE_DU, Date(DateData.ReportDate), IsExcel ); 

         if (isExcel)
            printEngine.CopyAllSheetInTotalBook (null, false, "emptyString", 0, "Отчет");
         end; 

         Data.PrintHead = false;
      end;
   else
      if( Data.PrintHead == false )  
         PrintHead( Data, IsExcel ); 
      end;
      PrintReportHead( Data, IsExcel );

      Message( "Печать отчета по собственным сделкам" );
      PrintDeals( "Собственные сделки", Data, DEALTYPE_OWN, IsExcel ); 
      Message( "Печать отчета по брокерским сделкам" );
      PrintDeals( "Брокерские сделки", Data, DEALTYPE_BROKER, IsExcel ); 

      Message( "Печать отчета по сделкам доверительного управления" );
      PrintDeals( "Доверительное управление", Data, DEALTYPE_DU, IsExcel ); 
   end;

end;

/*По всем филиалам*/
private macro ExecuteReportByAllDepartment( Data, IsExcel:bool )
   var  Continue_cicle, Num = 0;
   file Department( dp_dep );

   InitProgress( NRecords(Department), "Отчет \""+Data.ReportName+"\"", "Просмотр сделок для филиалов" );

   ClearRecord( Department );
   Department.Code = 0;
   Continue_cicle = GetGE(Department); 
   while( Continue_cicle )
      ClearGlobalTmp( "dscdljr_tmp" );
      if( Department.Code != {OperDprt} ) /*Свой уже распечатан (первый при запуске)*/
         Data.DprtID = Department.Code;
         ExecuteReportByDepartment( Data );
         PrintReportByDepartment( Data, IsExcel );
      end;
      Continue_cicle = Next(Department); 
      Num = Num + 1;
      UseProgress( Num );
   end;
   RemProgress;
end;

private macro RunReport( Data:SourceData, IsExcel:bool )
   FILE ReportOutFile() txt write; /*файл вывода для отчета*/
   VAR ReportFileName, TblName = "report", errcode, errtext;

   ClearGlobalTmp( "dscdljr_tmp" );

   Rep = Rep2;

   Message( "Выполнение отчета \""+Data.ReportName+"\" ..." );

   if (IsExcel)
      printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);

      if(printEngine.UsePoi())
         printEngine.SetXLSXFormat();
      end;

      printEngine.CreateTotalBook();

      InitProgress(-1, "", "");

      printEngine.OpenTemplate("scdljr_mac.xlsx", true);
      printEngine.SheetChange(1);

      RemProgress;  // DEF-100869 Отсутствовал
   end;
   
   if( Data.DprtID == -1 ) /* Не задан филиал, то сначала для себя, затем по всем 
                         оставшимся филиалам */
     Data.DprtID = {OperDprt};
     ExecuteReportByDepartment( Data );
     PrintReportByDepartment( Data, IsExcel);
     ExecuteReportByAllDepartment( Data, IsExcel );
   else 
     ExecuteReportByDepartment( Data );
     PrintReportByDepartment( Data, IsExcel );
   end;

   if( ReportRun == false )
      msgbox( "\n В указанный период сделок модуля БО ЦБ, соответствующих параметрам отчета, не проводилось.\n");
      return;
   else
      after_44_footer(Rep);
      if( IsExcel )
         printEngine.SetValue_NameCell("reportDate", {curdate});
         printEngine.CopyAllSheetInTotalBook (null, false, "reportFooter", 0, "Отчет");

         printEngine.Close();
         printEngine.SaveTotalBook("report_scdljr");
      else
         ReportFileName = GetTxtFileName( TblName );
         if( Open( ReportOutFile, ReportFileName ) == false )
            errcode = status( errtext );
            MsgBox( "Ошибка при открытии файла отчета|"+ ReportFileName +"|(" + errcode + ") " + errtext);
            break;
         end;
         SetOutput( ReportFileName );
         Rep.PrintRep();
         SetOutput( NULL, true );
         close( ReportOutFile );
         ViewFile( ReportOutFile );
      end;
   end;
end;

PRIVATE CLASS (DL_CReportTemplate) SP_RegDeal(Data, IsExel:bool)
  private var m_Data = Data, m_IsExcel = IsExel, m_IsPrint = false, m_IsHeadPrint = true;

  PRIVATE MACRO PrintMode():INTEGER
     if(m_IsExcel)
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;                                                                                                                                                                         

  macro PrintHead()
     file Dprt( dp_dep );
     var  DprtName = ""; 
     var TableHead = "";
     /*Название филиала*/
     if( m_Data.DprtID != 0 )
        Dprt.Code = m_Data.DprtID;
        if( GetEQ( Dprt ) )  
          DprtName = ПолучитьКороткоеИмяСубъекта( Dprt.PartyID, m_Data.DateMax );
        else
           msgBox ("Не найдено имя филиала с кодом ", m_Data.DprtID );    
        end;

        PrintFormatString( "Филиал: #####################################################",
                          "N1_DprtName", DprtName
                         );

        CopyAllSheetInTotalBook( NULL, false, "N1_HeaderDep", IIF(IsFirstUse,0,1) );
  
     end;
  
     m_Data.PrintHead = true;
  end;

  macro PrintReportHead( ReportDate:Date )
     var H = TArray; /*Подкачиваемые поля (имена и названия), одинаковые для всех 
                      сделок. Определяются при печати шапки отчета. */
     
     GetReportHead( m_Data, ReportDate, H );
     
     PrintFormatString( Header,
                        "N1_ReportDate", IIF((ValType(ReportDate) == V_DATE) and (m_Data.IsPartDate == true)," за дату " + string(date(ReportDate):f), " за период с " + string(date(m_Data.dateMin):f) + " по " + string(date(m_Data.dateMax):f)),
                        "N1_H_0", H[5],
                        "N1_H_1", "Вид ц/б:"+      H[0],
                        "N1_H_2", "Эмитент:"+      H[1],
                        "N1_H_3", "Ценная бумага:"+H[2],
                        "N1_H_4", "Клиент:"+       H[3],
                        "N1_H_5", H[4]
                      );
     CopyAllSheetInTotalBook( NULL, false, "N1_Header", 1 );

     if( IsFirstUse )
        IsFirstUse = false;
     end;

  end;

  private macro DigitIsApp(Digit, SumPrec:Integer, IsPrintNul:bool)
    if(Digit AND (not m_IsExcel))                                 
      if(m_Data.GetAppFlag)                                 
        return ЧислоCЗаданнойТочностью(Digit, SumPrec, "a");
      else
        return ЧислоCЗаданнойТочностью(Digit,SumPrec);                
      end;                                      
    elif(not Digit)
      if(IsPrintNul) 
         return $0; 
      else
         return "";                                
      end;             
    end; 
                                 
    return Digit;                            
  end;                                          

  macro PrintLine1(CurNumber:integer, DealCode:string, DealCodeTS:string, Date1: string, Time1: string, ChangeInfo: string, PartyShort1:string,DealKindName:string, ContrShortName:string,
                           ClientShortName:string, DocNumber:string, SfContrNumber:string, IssShortName:string, AvrKind:string,
                           AvrCode:string, AvrSeries:string, AvrIssue:string, AvrISIN:string, PayCCY:string, Amount:money, Price:string, PriceISO:string,SumInNom:string, SumInCalc:string,
                           DealDate:date, PriceISO2:string, StateDate:string, StateFactDate:string, PayDate:string, PayFactDate:string, ReportKind:string,
                           ReportNum:string, ReportDate:string, RejectInfo:string, IsApp:bool, Borders:string )
   
     var RepKind;
     var SumInNatcur = $0;

     if(ReportKind == "отчёт")
       RepKind = "отчёт проф. участнику";
     else
       RepKind = ReportKind;
     end;

     SumInNatcur = money(SumInNom);
     if( PriceISO2 != {CCYNatCur} )
        var CFI =  GetFIIDbyCCY(PriceISO2); 

        if(CFI != -1)
           //SmartConvertSum(SumInNatcur, SumInNatcur, m_Data.dateMax, CFI, NATCUR, false);
           SmartConvertSum(SumInNatcur, SumInNatcur, DealDate, CFI, NATCUR, false);/*golovkin*/
        end;
     end;

     /* 2 часть РЕПО (выводится ставка РЕПО и символ "%") - оставляем текстом */
     if ((Price != "") and (Index(Price, "%") == 0))
        Price = StrSubst(Price, "'", "");
        Price = DigitIsApp(money(Price),3);
     end;

     PrintTableLine(   "N1_CurNumber_1",        IIF(CurNumber == 0, "", CurNumber),              null,
                       "N1_DealCode_1",         DealCode /*DealCodeTS  DEF-66965*/,              null,
                       "N1_DealCodeTS_1",       DealCodeTS,                                      null,
                       "N1_Date_1",             IIF(CurNumber == 0, "", string(date(Date1):f)),  null, 
                       "N1_Time_1",             IIF(CurNumber == 0, "", time(trim(Time1))),      null,
                       "N1_ChangeInfo_1",       ChangeInfo,                                      null,
                       "N1_PartyShort_1",       PartyShort1,                                     null,
                       "N1_DealKindName_1",     DealKindName,                                    null,
                       "N1_ContrShortName_1",   ContrShortName,                                  null,
                       "N1_ClientShortName_1",  ClientShortName,                                 null,
                       "N1_DocNumber_1",        DocNumber,                                       null,
                       "N1_SfContrNumber_1",    SfContrNumber,                                   null,
                       "N1_IssShortName_1",     IssShortName,                                    null,
                       "N1_AvrKind_1",          AvrKind,                                         null,
                       "N1_AvrCode_1",          AvrCode,                                         null,
                       "N1_AvrSeries_1",        AvrSeries,                                       null,
                       "N1_AvrIssue_1",         AvrIssue,                                        null,
                       "N1_AvrISIN_1",          AvrISIN,                                         null,
                       "N1_PayCCY_1",           PayCCY,                                          null,
                       "N1_Amount_1",           IIF(Amount != $0, DigitIsApp(Amount,6), ""),     SetPrecisionByFractPart( Amount, 6, 0 ),
                       "N1_Price_1",            Price,                                           3,
                       "N1_PriceISO_1",         PriceISO,                                        null,
                       "N1_SumInNom_1",         IIF(money(SumInNom) != $0, DigitIsApp(money(SumInNom),2), ""), null,
                       "N1_SumInCalc_1",        IIF(money(SumInCalc) != $0, DigitIsApp(money(SumInCalc),2),""),null,
                       "N1_SumInNatcur_1",      DigitIsApp(money(SumInNatcur),2),                null,
                       "N1_PriceISO2_1",        PriceISO2,                                       null,
                       "N1_StateDate_1",        StateDate,                                       null,
                       "N1_StateFactDate_1",    StateFactDate,                                   null,
                       "N1_PayDate_1",          PayDate,                                         null,
                       "N1_PayFactDate_1",      PayFactDate,                                     null,
                       "N1_RepKind_1",          RepKind,                                         null,
                       "N1_ReportNum_1",        ReportNum,                                       null,
                       "N1_ReportDate_1",       ReportDate,                                      null,
                       "N1_RejectInfo_1",       RejectInfo,                                      null
                    );

     ReportRun = true; 
     m_IsPrint = true;                                                                                                                                                                                                
  end;      

  macro PrintDeals( Title, KindRecord, ReportDate, IsExcel:bool )
     var Continue_cicle, Date1, RepoRate1, PartyShortName1;
     var ReportKind = "", DocNum = "", DocDate = "",
       ReportKind2 = "", DocNum2 = "", DocDate2 = "";
     var query, DataSet, Select, cnt = 0, i = 0;
     var  m_query, m_Select, m_cnt = 0, m_DataSet, m_DealDate;/*GAA:502887*/  
//     file dl_tick ( "dl_tick" ) key 1;
     var dl_tick, cmd;
     var Price = "", PriceISO = "", PriceISO2 = "", FilterCond = "";
     var CurNumber = 1;
     var IsBack = false;
     var ReportTmp, q="";

     m_IsPrint = false;
//     ClearRecord( ReportTMP );
//     rewind(ReportTMP);

  
     FilterCond = "t_KindRecord = " + string(KindRecord);
     if( (ValType(ReportDate) == V_DATE) and (m_Data.IsPartDate == true) )
        FilterCond = FilterCond + " and t_ChangeDate = " + GetSQLDate(ReportDate);
     end;
     reporttmp = TRsbDataSet("select * from DSCDLJR_TMP where "+FilterCond);
  
    // ReportTMP.AddFilter(FilterCond);
   //  Continue_cicle = Next(ReportTMP);
     Continue_cicle = ReportTMP.movenext();
     InitProgress(-1,"Printing..");
     while( Continue_cicle AND
            (ReportTMP.KindRecord == KindRecord)
          )
  
        ReportKind = ""; 
        DocNum = ""; 
        DocDate = "";
        ReportKind2 = ""; 
        DocNum2 = ""; 
        DocDate2 = "";
        cnt = 0;
  
        Date1 = DateToStr( SQL_ConvTypeDate(ReportTMP.ChangeDate) ) + ","+ SPTimeSplit(Sql_ConvTypeTime(ReportTMP.DealTime)); 
        PartyShortName1 = ReportTMP.PartyShortName + " " + ReportTMP.BrokerShortName;    
  
        IsBack = IIF(ReportTMP.LegKind==LEG_KIND_DL_TICK_BACK,true,false);

        Price = ReportTMP.RepoRate;
        PriceISO = IIF(not IsBack,ReportTMP.RepoRateCCY,"");
        PriceISO2 = ReportTMP.RepoRateCCY;

      //  dl_tick.dealcode = ReportTMP.DealCode;
       // dl_tick.bofficekind = 101;
//      cmd = DL_RSDCommand ("select t.*, s.t_number from ddl_tick_dbt t, dsfcontr_dbt s where s.t_id = t.t_clientcontrid and t.t_dealid = ? and t.t_bofficekind = 101 ");
  /*    cmd = DL_RSDCommand ("select t.*, s.t_number, \n" +
                           "(select r.t_codets from ddl_req_dbt r join dspgrdoc_dbt rd on r.t_id = rd.t_SOURCEDOCID and rd.t_sourcedockind = 350 join dspgrdoc_dbt spgrdoc \n" +
                           "            ON rd.t_SPgroundID = spgrdoc.t_SPGroundID where  spgrdoc.t_SourceDocKind = t.t_bofficekind AND spgrdoc.t_SourceDocID =  t.t_dealid) codets \n" +
                           " from ddl_tick_dbt t join dsfcontr_dbt s on s.t_id = t.t_clientcontrid \n" +
                           "where   t.t_dealid = ? and t.t_bofficekind = 101  \n" 
                           ); */
  cmd = DL_RSDCommand ("select t.*, s.t_number \n" +
                           " from ddl_tick_dbt t left join dsfcontr_dbt s on s.t_id = t.t_clientcontrid \n" +
                           "where   t.t_dealid = ? and t.t_bofficekind = 101  \n" 
                           );
  

      cmd.addParam(ReportTMP.Dealid); 
      dl_tick = cmd.execute(); //RsdRecordSet(dl_tick);
        if(dl_tick.movenext() /*GetEQ(dl_tick)*/)
           IF( m_Data.DprtID == dl_tick.Department )
  
          /*  query =   " select count(1) over() reccnt, spground.t_Xld, spground.t_kind, case when spground.t_kind = 251 then r.t_codets else spground.t_AltXld end AltXld, spground.t_RegistrDate, llv.t_Name as KindName "
                    + "   from dspground_dbt spground, dllvalues_dbt llv, dspgrdoc_dbt spgrdoc left join dspgrdoc_dbt rd on  rd.t_spgroundid = spground.t_spgroundid and spground.t_kind = 251 and rd.t_sourcedockind = 350 "
                    + "    left join ddl_req_dbt r on r.t_id = rd.t_SOURCEDOCID " 
                      + "  where spgrdoc.t_SourceDocKind = ? "  
                      + "    and spgrdoc.t_SourceDocID   = ? "
                      + "    and spground.t_SPgroundID   = spgrdoc.t_SPGroundID "
                      + "    and llv.t_List = " + OBJTYPE_KINDDOC
                      + "    and llv.t_Element = spground.t_Kind "
                      + "  order by spground.t_Kind asc";    */

           query =    "  SELECT COUNT (1) OVER () reccnt, spground.t_Xld, spground.t_kind, \n" +
                      "         CASE \n" +
                      "            WHEN spground.t_kind = 251 THEN r.t_codets \n" +
                      "            ELSE spground.t_AltXld \n" +
                      "         END AltXld, \n" +
                      "         spground.t_RegistrDate, \n" +
                      "         llv.t_Name AS KindName \n" +
                      "    FROM dspground_dbt spground \n" +
                      "         JOIN dllvalues_dbt llv \n" +
                      "            ON llv.t_List = ? AND llv.t_Element = spground.t_Kind \n" +
                      "         JOIN dspgrdoc_dbt spgrdoc \n" +
                      "            ON spground.t_SPgroundID = spgrdoc.t_SPGroundID \n" +
                      "         LEFT JOIN dspgrdoc_dbt rd \n" +
                      "            ON     rd.t_spgroundid = spground.t_spgroundid \n" +
                      "               AND spground.t_kind = 251 \n" +
                      "               AND rd.t_sourcedockind = 350 \n" +
                      "         LEFT JOIN ddl_req_dbt r \n" +
                      "            ON r.t_id = rd.t_SOURCEDOCID \n" +
                      "   WHERE spgrdoc.t_SourceDocKind = ? AND spgrdoc.t_SourceDocID = ? \n" +
                      " ORDER BY spground.t_Kind ASC \n" ;

  
              Select = DL_RSDCommand(query);
              Select.AddParam(OBJTYPE_KINDDOC);
              Select.AddParam(dl_tick.BOfficeKind);
              Select.AddParam(dl_tick.DealID);
  
              //cnt = Select.GetCount();
              cnt=0;
              //if(cnt > 0)
                DataSet = Select.Execute();
                if(DataSet.moveNext())
                  if (cnt==0)
                    cnt=int(DataSet.reccnt) ;
                  end;
                  ReportKind = string(DataSet.KindName);
                  DocDate = string(date(DataSet.RegistrDate):f);
                  if (dl_tick.marketid > 0)
                    DocNum = DataSet.AltXld;
                  else 
                    DocNum = DataSet.Xld;
                  end;

                end;
  
              //end;
  
              if( not m_IsHeadPrint )
                 this.PrintHead(); 
                 this.PrintReportHead( ReportDate );
                 m_IsHeadPrint = true;
              end;

              if( not m_IsPrint )
                 PrintFormatString( "\n#",
                                    "N1_H_6", Title
                                  );
                 
                 CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader1", 1 );
                 
                 RegisterTable( "N1_MainTable1", TableHead1,
                                "N1_CurNumber_1", 
                                "N1_DealCode_1", 
                                "N1_DealCodeTS_1", 
                                "N1_Date_1", 
                                "N1_Time_1", 
                                "N1_ChangeInfo_1", 
                                "N1_PartyShort_1",   
                                "N1_DealKindName_1",  
                                "N1_ContrShortName_1",   
                                "N1_ClientShortName_1",   
                                "N1_DocNumber_1", 
                                "N1_SfContrNumber_1", 
                                "N1_IssShortName_1",  
                                "N1_AvrKind_1",  
                                "N1_AvrCode_1",  
                                "N1_AvrSeries_1", 
                                "N1_AvrIssue_1", 
                                "N1_AvrISIN_1",  
                                "N1_PayCCY_1",   
                                "N1_Amount_1",   
                                "N1_Price_1", 
                                "N1_PriceISO_1", 
                                "N1_SumInNom_1", 
                                "N1_SumInCalc_1", 
                                "N1_SumInNatcur_1",   
                                "N1_PriceISO2_1", 
                                "N1_StateDate_1", 
                                "N1_StateFactDate_1", 
                                "N1_PayDate_1",  
                                "N1_PayFactDate_1",   
                                "N1_RepKind_1",  
                                "N1_ReportNum_1", 
                                "N1_ReportDate_1", 
                                "N1_RejectInfo_1"
                              );
              end;
              /*GAA: 502887*/
              m_DealDate = ReportTMP.ChangeDate;
              //if (KindRecord == DEALTYPE_OWN) /*PNV 535319 клиентские сделки тоже нужно проверить*/
                 /*GAA: 503800 может быть несколько одинаковых T_DEALCODE, в итоге ошибка. Заменил на T_DEALID*/
                 m_query = "SELECT t_dealdate FROM ddl_tick_dbt WHERE t_dealid = (SELECT t.T_REQUESTID FROM ddl_tick_dbt t WHERE t.T_DEALID = ?)";
                 m_Select = DL_RSDCommand(m_query);
                 m_Select.AddParam(ReportTMP.DealId);
  
                // m_cnt = m_Select.GetCount();
                   m_cnt = 0 ;
                // if(m_cnt > 0)

                   m_DataSet = m_Select.Execute();
                   if(m_DataSet.moveNext())
                     if (m_cnt == 0)
                       m_cnt = int(m_DataSet.reccnt) ;
                     end ;
                     m_DealDate = m_DataSet.DealDate;  /*дата первоначальной сделки*/
                   end;
                // end;
              //end;/**/

  
              if(cnt > 1)
                i = 2;
                while(DataSet.moveNext())
                  ReportKind2 = string(DataSet.KindName);
                  DocDate2 = string(date(DataSet.RegistrDate):f);
                  if (dl_tick.partyid > 0)
                    DocNum2 = DataSet.AltXld;
                  else 
                    DocNum2 = DataSet.Xld;
                  end;
                  if (i==2)
                     //первый раз печатаем всегда
                        //первый раз печатаем всегда
                        this.PrintLine1(CurNumber, ReportTMP.DealCode, dl_tick.DealCodeTS, DateToStr(SQL_ConvTypeDate(m_DealDate)/*GAA: 502887, old: ReportTMP.ChangeDate*/), SQL_ConvTypeTime(ReportTMP.DealTime),
                                   ReportTMP.ChangeInfo, 
                                   PartyShortName1, ReportTMP.DealKindName, ReportTMP.ContrShortName,
                                   ReportTMP.ClientShortName, /*ReportTMP.DocNumber*/ IIF(dl_tick.clientid==-1,ReportTMP.DocNumber,docnum2),/*ReportTMP.SfContrNumber*/dl_tick.number,
                                   ReportTMP.IssShortName,ReportTMP.AvrKind,ReportTMP.AvrCode,ReportTMP.AvrSeries,ReportTMP.AvrIssue, GetISINbyAvrCode(ReportTMP.AvrCode),
                                   ReportTMP.PayCCY,ReportTMP.Amount,Price,PriceISO,
                                   ReportTMP.SumInNom, ReportTMP.SumInCalc, SQL_ConvTypeDate(m_DealDate)/*GAA: 502887, old:ReportTMP.DealDate*/, PriceISO2,
                                   ReportTMP.StateDate,SQL_ConvTypeDate(ReportTMP.StateFactDate),
                                   SQL_ConvTypeDate(ReportTMP.PayDate), ReportTMP.PayFactDate,ReportKind,
                                   DocNum,DocDate,ReportTMP.RejectInfo
                                   );
                  end;


  
                  this.PrintLine1(0, "", "", "", "", "", "", "", "", "", "","", "","","","","", "", "","","","", "", "", 
                             date(0,0,0),"","", "", "","", 
                             ReportKind2, DocNum2, DocDate2,""
                             );
  
                  i = i + 1;
                end;
              else
              this.PrintLine1(CurNumber, ReportTMP.DealCode, dl_tick.DealCodeTS, DateToStr(m_DealDate/*GAA: 502887, old: ReportTMP.ChangeDate*/), SQL_ConvTypeTime(ReportTMP.DealTime),
                         ReportTMP.ChangeInfo, 
                         PartyShortName1, ReportTMP.DealKindName, ReportTMP.ContrShortName,
                         ReportTMP.ClientShortName, /*ReportTMP.DocNumber*/ IIF(dl_tick.clientid==-1,ReportTMP.DocNumber,docnum),/*ReportTMP.SfContrNumber*/dl_tick.number,
                         ReportTMP.IssShortName,ReportTMP.AvrKind,ReportTMP.AvrCode,ReportTMP.AvrSeries,ReportTMP.AvrIssue, GetISINbyAvrCode(ReportTMP.AvrCode),
                         ReportTMP.PayCCY,ReportTMP.Amount,Price,PriceISO,
                         ReportTMP.SumInNom, ReportTMP.SumInCalc, m_DealDate/*GAA: 502887, old:ReportTMP.DealDate*/, PriceISO2,
                         ReportTMP.StateDate,ReportTMP.StateFactDate,
                         ReportTMP.PayDate, ReportTMP.PayFactDate,ReportKind,
                         DocNum,DocDate,ReportTMP.RejectInfo
                         );

              end;
           end;                                                   
        end;                                                      
  
        //Continue_cicle = Next( ReportTMP );
        CurNumber = CurNumber + 1;
        Continue_cicle = ReportTMP.movenext();
        UseProgress(CurNumber);

     end;
   //  ReportTMP.DropFilter();
     RemProgress;

     if( m_IsPrint )
       EndTable();
       CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
     end;

  end;

  macro PrintLine1_2(CurNumber:integer, DealCode:string, DealCodeTS:string, Date1:string, OperKind:string, SpGround:string, RegistrarShortName:string, RegistrarContrNum:string,
                             IssShortName:string, AvrKind:string, AvrCode:string, AvrSeries:string,  AvrIssue:string,  AvrISIN:string, 
                             Amount:money, Price:double, PriceISO:string, Cost:money, NKD:money, TotalCost:money )
  
     PrintTableLine(  "N1_CurNumber_2",       CurNumber,                                         null,
                      "N1_DealCode_2",        /*DealCode*/DealCodeTS,                            null,
                      "N1_DealCodeTS_2",      DealCodeTS,                                        null,
                      "N1_Date_2",            Date1,                                             null, 
                      "N1_OperKind_2",        OperKind,                                          null,
                      "N1_Ground_2",          SpGround,                                          null,
                      "N1_Registrar_2",       RegistrarShortName,                                null,
                      "N1_RegistrarContr_2",  RegistrarContrNum,                                 null,
                      "N1_Issuer_2",          IssShortName,                                      null,
                      "N1_AvrKind_2",         AvrKind,                                           null,
                      "N1_AvrCode_2",         AvrCode,                                           null,
                      "N1_AvrSeries_2",       AvrSeries,                                         null,
                      "N1_AvrIssue_2",        AvrIssue,                                          null,
                      "N1_AvrISIN_2",         AvrISIN,                                           null,
                      "N1_Amount_2",          IIF(Amount != $0, DigitIsApp(Amount,6), ""),       SetPrecisionByFractPart( Amount, 6, 0 ),
                      "N1_Price_2",           DigitIsApp(Price,6),                               null,
                      "N1_PriceISO_2",        PriceISO,                                          null,
                      "N1_Cost_2",            IIF(Cost != $0, DigitIsApp(Cost,2), ""),           null,
                      "N1_NKD_2",             IIF(NKD != $0, DigitIsApp(NKD,2), ""),             null,
                      "N1_TotalCost_2",       IIF(TotalCost != $0, DigitIsApp(TotalCost,2), ""), null
                    );

     ReportRun = true;
  end;      
 
  macro PrintBasket( KindRecord, ReportDate )
     var ReportKind = "";
     var query, DataSet, Select, cnt = 0, i = 0;
  
     var CurNumber = 1;
  
     var SpGround = "", RegistrarShortName = "", RegistrarContrNum = "", RegistrarID, RegistrarContrID,
         IssShortName = "", AvrKind = "", AvrCode = "", AvrSeries = "",  AvrIssue = "",  AvrISIN = "", OperKind = "",
         Amount = $0, Price = 0.0, PriceISO = "", Cost = $0, NKD = $0, TotalCost = $0;
  
     var TotalAmount = $0, TotalNKD = $0;
     var dateMin, dateMax;

     if(ReportDate!=null)
        dateMin = ReportDate;
     else
        dateMin = m_Data.dateMin;
     end;
  
     if(ReportDate!=null)
        dateMax = ReportDate;
     else
        dateMax = m_Data.dateMax;
     end;

     query = " select count(1) over() reccnt, q.* from ( select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS,  ENS.T_DATE T_DATE, ENS.T_FIID, ENS.T_PRINCIPAL,  ENS.T_NKD, ENS.T_TOTALCOST, 2 T_KIND "+
             "   from (select distinct scdljr.t_DealID t_DealID from dscdljr_tmp scdljr) scdljr, ddl_tick_dbt tick, ddl_tick_ens_dbt ens "+
             "  where tick.t_DealID = scdljr.t_DealID "+
             "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
             "    and tick.t_Department = ? " +
             "    and ENS.T_DEALID  = scdljr.t_DealID "+
             "    and ENS.T_KIND   = ? "+
             "    and ENS.T_DATE   >= ? "+
             "    and ENS.T_DATE   <= ? "+
             "    and ENS.T_DATE   != TICK.T_DEALDATE "+
             "    and ENS.T_ID     != (select min(ens1.t_ID) from ddl_tick_ens_dbt ens1 where ENS1.T_DEALID = ENS.T_DEALID and ENS1.T_FIID = ENS.T_FIID and ens1.t_Kind = ENS.T_KIND) "+
             " union all "+       
             " select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS,  ENS.T_DATE T_DATE, ENS.T_FIID, ENS.T_PRINCIPAL,  ENS.T_NKD, ENS.T_TOTALCOST, 3 T_KIND "+
             "   from (select distinct scdljr.t_DealID t_DealID from dscdljr_tmp scdljr) scdljr, ddl_tick_dbt tick, ddl_tick_ens_dbt ens "+
             "  where tick.t_DealID = scdljr.t_DealID "+
             "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
             "    and tick.t_Department = ? " +
             "    and ENS.T_DEALID  = scdljr.t_DealID "+
             "    and ENS.T_KIND    = ? "+
             "    and ENS.T_DATE   >= ? "+
             "    and ENS.T_DATE   <= ? "+
             " union all "+       
             " select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS, DLRQ.T_FACTDATE T_DATE, ENS.T_FIID,  ENS.T_PRINCIPAL,  ENS.T_NKD,ENS.T_TOTALCOST, 1 T_KIND "+
             "   from (select distinct scdljr.t_DealID t_DealID from dscdljr_tmp scdljr) scdljr, ddl_tick_dbt tick, ddl_tick_ens_dbt ens, ddlrq_dbt dlrq "+
             "  where tick.t_DealID   = scdljr.t_DealID "+
             "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
             "    and tick.t_Department = ? " +
             "    and DLRQ.T_DOCID    = scdljr.t_DealID "+
             "    and DLRQ.T_DOCKIND  = TICK.T_BOFFICEKIND "+
             "    and DLRQ.T_TYPE     = ? "+ 
             "    and DLRQ.T_NUM      = 0 "+
             "    and DLRQ.T_DEALPART = 1 "+
             "    and DLRQ.T_FACTDATE >= ? "+
             "    and DLRQ.T_FACTDATE <= ? "+
             "    and ENS.T_DEALID     = scdljr.t_DealID "+
             "    and ENS.T_KIND       = ? "+
             "    and ENS.T_ID         = (select min(ens1.t_ID) from ddl_tick_ens_dbt ens1 where ENS1.T_DEALID = ENS.T_DEALID and ENS1.T_FIID = ENS.T_FIID and ens1.t_Kind = ENS.T_KIND) "+
             " union all "+           
             " select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS, DLRQ.T_FACTDATE T_DATE, "+
             "        ENS.T_FIID, sum (case when ens.t_kind = 0 then nvl(ens.t_principal,0)  else nvl(-ens.t_principal, 0) end) t_principal, "+
             "        SUM(CASE WHEN ens.T_KIND = 0 THEN NVL(ens.T_NKD,0) ELSE NVL(-ens.T_NKD,0) END) T_NKD, "+
             "        SUM(CASE WHEN ens.T_KIND = 0 THEN NVL(ens.T_TOTALCOST,0) ELSE NVL(-ens.T_TOTALCOST,0) END) T_TOTALCOST, 4 T_KIND "+
             "   from (select distinct scdljr.t_DealID t_DealID from dscdljr_tmp scdljr) scdljr, ddl_tick_dbt tick, ddl_tick_ens_dbt ens, ddlrq_dbt dlrq "+
             "  where tick.t_DealID   = scdljr.t_DealID "+
             "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
             "    and tick.t_Department = ? " +
             "    and DLRQ.T_DOCID    = scdljr.t_DealID "+
             "    and DLRQ.T_DOCKIND  = TICK.T_BOFFICEKIND "+
             "    and DLRQ.T_TYPE     = ? "+
             "    and DLRQ.T_NUM      = 0 "+
             "    and DLRQ.T_DEALPART = 2 "+
             "    and DLRQ.T_FACTDATE >= ? "+
             "    and DLRQ.T_FACTDATE <= ? "+
             "    and ENS.T_DEALID     = scdljr.t_DealID "+
             " group by ENS.T_FIID, tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS, DLRQ.T_FACTDATE ) q "+
             " order by T_DATE, t_DealCodeTS, T_KIND, T_FIID";
  
     Select = DL_RSDCommand();
  
     Select.AddParam(m_Data.DprtID);
     Select.AddParam(TICKENS_KIND_IN);
     Select.AddParam(dateMin);
     Select.AddParam(dateMax);
  
     Select.AddParam(m_Data.DprtID);
     Select.AddParam(TICKENS_KIND_OUT);
     Select.AddParam(dateMin);
     Select.AddParam(dateMax);
  
     Select.AddParam(m_Data.DprtID);
     Select.AddParam(DLRQ_TYPE_PAYMENT);
     Select.AddParam(dateMin);
     Select.AddParam(dateMax);
     Select.AddParam(TICKENS_KIND_IN);
  
     Select.AddParam(m_Data.DprtID);
     Select.AddParam(DLRQ_TYPE_PAYMENT);
     Select.AddParam(dateMin);
     Select.AddParam(dateMax);
  
     DataSet = Select.Execute(query);

     //cnt = Select.GetCount(query);
     cnt = 0 ;
     while(DataSet.moveNext())
         if(cnt == 0)
      
           if( not m_IsExcel )
              PrintFormatString( "\n#",
                       "", "Регистр операций с обеспечением по сделкам РЕПО с корзиной ценных бумаг"
                     );
           end;

           CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader2", 1 );
           
           RegisterTable( "N1_MainTable2", TableHead1_2,
                          "N1_CurNumber_2", 
                          "N1_DealCode_2",  
                          "N1_DealCodeTS_2", 
                          "N1_Date_2", 
                          "N1_OperKind_2",  
                          "N1_Ground_2",    
                          "N1_Registrar_2", 
                          "N1_RegistrarContr_2",    
                          "N1_Issuer_2",    
                          "N1_AvrKind_2",   
                          "N1_AvrCode_2",   
                          "N1_AvrSeries_2", 
                          "N1_AvrIssue_2",  
                          "N1_AvrISIN_2",   
                          "N1_Amount_2",    
                          "N1_Price_2", 
                          "N1_PriceISO_2",  
                          "N1_Cost_2",  
                          "N1_NKD_2",   
                          "N1_TotalCost_2"
                        );
      
           cnt = Int(DataSet.reccnt) ;

           InitProgressBar( Int(cnt), "Отчет \"Регистр операций с обеспечением по сделкам РЕПО с корзиной ценных бумаг\"",
                         "Просмотр сделок" );

          end;
          SpGround = GetSpGroundByEns(DataSet.Kind);
          OperKind = GetOperKindByEns(DataSet.Kind);
  
          RegistrarShortName = RegistrarContrNum = "";
          if( GetRegistrarByDeal(DataSet.DealID,@RegistrarID,@RegistrarContrID) )
             RegistrarContrNum = GetContrNumberByID( RegistrarContrID );
             RegistrarShortName = ПолучитьКороткоеИмяСубъекта(RegistrarID, Date(DataSet.Date));
          end;
  
          if( ПолучитьФинИн( DataSet.FIID, rFininstr, rAvoiriss ) == 0 )
             IssShortName = ПолучитьКороткоеИмяСубъекта( FI_GetIssuerOnDate( rFininstr, dateMax), Date(DataSet.Date) );
             /* Сокращенное наименование вида ценной бумаги */
             AvoirKindName( rFininstr.AvoirKind, AvrKind );
             /* Код ц/б (Fininstr.FI_Code) */
             AvrCode = rFininstr.FI_Code;
             /* Серия ц/б */
             AvrSeries = rAvoiriss.Series;
             /* Транш ц/б */
             AvrIssue = rAvoiriss.Tranche;
             AvrISIN  = rAvoiriss.ISIN;
  
             Amount = DataSet.principal;
             
             Price = NKD = Cost = TotalCost = $0;
  
             if( (DataSet.Kind == KIND_EX_1) or ( DataSet.Kind == KIND_IN ) )
               Cost     = DataSet.TOTALCOST - DataSet.NKD*Amount;
               if( Amount != $0 )
                 Price = Cost/Amount;
               end;
               
               PriceISO = {CCYNatCur};
               NKD = DataSet.NKD*Amount;                                
               TotalCost = DataSet.TOTALCOST;
             else
               GetTotalSumFromLot(DataSet.Kind, DataSet.DealID, DataSet.FIID, SQL_ConvTypeDate(DataSet.Date), @TotalAmount, @Cost, @TotalNKD);
               if( DataSet.Kind == KIND_EX_2 )
                 if( Amount != $0 )
                   Price = (Cost/Amount);                    
                   NKD = (TotalNKD/Amount);
                 end;                
               else                   
                 if( Amount != $0 )
                   Price = Cost/Amount; 
                 end;
                 if( (Amount != $0) and (TotalAmount != $0) )
                   NKD = TotalNKD/TotalAmount*Amount;
                 end;
               end;
               
               Cost = Price*Amount;
               PriceISO = {CCYNatCur};
               TotalCost = Cost + NKD;
             end;


             this.PrintLine1_2(CurNumber, DataSet.DealCode, DataSet.DealCodeTS, string(SQL_ConvTypeDate(DataSet.Date):f), OperKind, SpGround, RegistrarShortName, RegistrarContrNum,
                               IssShortName, AvrKind, AvrCode, AvrSeries,  AvrIssue,  AvrISIN, 
                               Amount, Price, PriceISO, Cost, NKD, TotalCost);
          else
             msgBox ("Не найдена ц/б с FIID = "+string(DataSet.FIID));    
          end;
  
          CurNumber = CurNumber + 1;

          UseProgressBar;
  
      end;
     if(cnt != 0)

       RemProgressBar;

       EndTable();
       CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
  
      end;
  
  end;

  macro PrintReportByDepartment()

     var selSQL, DateData;

     if( m_Data.IsPartDate == true )
        selSQL = RSDCommand("select distinct(t_ChangeDate) as ReportDate from dscdljr_tmp order by t_ChangeDate");
     
        selSQL.execute();
        DateData = TRsbDataSet( selSQL );
        while( DateData.MoveNext() )
           m_IsHeadPrint = false;
           Message( "Печать отчета по собственным сделкам" );
     
           this.PrintDeals( "Собственные сделки", DEALTYPE_OWN, Date(DateData.ReportDate) ); 
           Message( "Печать отчета по брокерским сделкам" );
           this.PrintDeals( "Брокерские сделки", DEALTYPE_BROKER, Date(DateData.ReportDate) ); 
     
           Message( "Регистр операций с обеспечением по сделкам РЕПО с корзиной ценных бумаг" );
           this.PrintBasket( DEALTYPE_OWN, Date(DateData.ReportDate) ); 

           if( m_IsHeadPrint )
              AddStandardFooter( "N1_" );
              CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );
           end;

        end;
     else
        m_IsHeadPrint = false;
        Message( "Печать отчета по собственным сделкам" );
        this.PrintDeals( "Собственные сделки", DEALTYPE_OWN ); 
        Message( "Печать отчета по брокерским сделкам" );
        this.PrintDeals( "Брокерские сделки", DEALTYPE_BROKER ); 
     
        Message( "Регистр операций с обеспечением по сделкам РЕПО с корзиной ценных бумаг" );
        this.PrintBasket( DEALTYPE_OWN ); 
     
        if( m_IsHeadPrint )
           AddStandardFooter( "N1_" );
           CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );
        end;
     end;

  end;

  /*По всем филиалам*/
  macro ExecuteReportByAllDepartment()
     var  Continue_cicle, Num = 0;
     file Department( dp_dep );
   
     InitProgress( NRecords(Department), "Отчет \""+m_Data.ReportName+"\"", "Просмотр сделок для филиалов" );
   
     ClearRecord( Department );
     Department.Code = 0;
     Continue_cicle = GetGE(Department); 
     while( Continue_cicle )
        ClearGlobalTmp( "dscdljr_tmp" );
        if( Department.Code != {OperDprt} ) /*Свой уже распечатан (первый при запуске)*/
           m_Data.DprtID = Department.Code;
           ExecuteReportByDepartment(m_Data);
           this.PrintReportByDepartment();
        end;
        Continue_cicle = Next(Department); 
        Num = Num + 1;
        UseProgress( Num );
     end;

     RemProgress;
  end;

  PRIVATE MACRO BeginReport()
     CreateTotalBook();     
  END;

  PRIVATE MACRO EndReport()
     SaveTotalBook();
  END;

  PRIVATE MACRO Create()
     ClearGlobalTmp( "dscdljr_tmp" );
     SetXLSXFormat();
     if( m_Data.DprtID == -1 ) /* Не задан филиал, то сначала для себя, затем по всем 
                           оставшимся филиалам */
       m_Data.DprtID = {OperDprt};
       ExecuteReportByDepartment(m_Data);
       this.PrintReportByDepartment();

       this.ExecuteReportByAllDepartment();
     else 
       ExecuteReportByDepartment(m_Data);
       this.PrintReportByDepartment();
     end;

     if( ReportRun == false )
        PrintFormatString( "#", "N1_ReportRunFalse", "В указанный период сделок модуля БО ЦБ, соответствующих параметрам отчета, не проводилось." );
        CopyAllSheetInTotalBook( NULL, false, "N1_ReportRunFalse", 1 );
     end;
  END;

  initDL_CReportTemplate( NULL, "Report_RegDeal.xlsx", true, NULL, NULL, POI_MODE, TRUE  );

END;

/*Запуск отчета "Регистр сделок"*/
macro DealJrnReport( DataFromPan:DlTkRegFormData )
   var Data = SourceData( REGISTER_DEAL_REPORT, DataFromPan.DepartmentID, DataFromPan.FIAvrKindID, DataFromPan.EmiID, DataFromPan.AvrKindID, 
                          DataFromPan.DealType, DataFromPan.ClientID,0,0,0,0,false, DataFromPan.IsMarket, DataFromPan.MarketID, DataFromPan.IsOutMkt,
                          DataFromPan.IsBroker, DataFromPan.BrokerID,
                          DataFromPan.BeginDate,DataFromPan.EndDate, DataFromPan.IsEveryDate, DataFromPan.DealStatus, 
                          DataFromPan.Qualified, DataFromPan.IsUseOpostrofs, DataFromPan.IsRepo );
   SP_RegDeal(Data,DataFromPan.IsExportToExel).Run();
end;

/*Запуск отчета "Субрегистр спорных сделок"*/
macro DealSubRegisterReport( DataFromPan:DlSubJrnFormData )
   
   var Data = SourceData( SUBREGISTER_DEAL_REPORT, DataFromPan.DepartmentID,  DataFromPan.FIAvrKindID, DataFromPan.EmiID, DataFromPan.AvrKindID, 
                           DataFromPan.DealType, DataFromPan.ClientID,
                           DataFromPan.IsForm, DataFromPan.FormSub, DataFromPan.IsVid, DataFromPan.VidSub, DataFromPan.NoResident,
                           DataFromPan.IsMarket, DataFromPan.MarketID, 
                           DataFromPan.IsOutMkt, DataFromPan.IsBroker, DataFromPan.BrokerID,
                           DataFromPan.BeginDate, DataFromPan.EndDate, true, DataFromPan.DealStatus, NULL, DataFromPan.IsUseApp ); 
   RunReport( Data, DataFromPan.IsExportToExel );
end;
