/*¬ ªà®á ®âç¥â  ®¯¥à æ¨© ¨§¬¥­¥­¨ï ­®¬¨­ «  æ/¡*/

IMPORT BankInter, PTInter, TSInter, RsbDataSet, "cbRepFun.mac", "secinter.mac", "spserv.mac";

private const UnknownParty = -1;
private const ALG_SP_CHGAVRNOM_SUBKINDS = 3150;


private macro PrintHead( DocumentID )
  var query, DataSet;
  var Select;
  var AvrKindName = "", AvrSubKindName = "";

  query = " SELECT dppt.t_ShortName DeptName, comm.t_CommDate CommDate, nalg.t_szNameAlg OpKindName, " +
          "        issuer.t_ShortName IssuerName, fi.t_FI_Code FI_Code, fi.t_Name FI_Name, avr.t_LSIN LSIN, " +
          "        comm.t_Hidden_Sum OldNominal, comm.t_Currency_Sum NewNominal, fi.t_AvoirKind AvoirKind, finom.t_CCY NominalFICode, " +
          "        TO_CHAR(Round(comm.t_Hidden_Sum/t_Currency_Sum, 12)) Coeff " +
          " FROM ddl_comm_dbt comm, ddp_dep_dbt dp JOIN dparty_dbt dppt ON (dppt.t_PartyID = dp.t_PartyID), " +
          "      dnamealg_dbt nalg, dfininstr_dbt fi, dparty_dbt issuer, davoiriss_dbt avr, dfininstr_dbt finom " +
          " WHERE comm.t_DocumentId = ? /*1*/ " +
          " AND dp.t_Code = comm.t_Division " +
          " AND nalg.t_iTypeAlg = " + ALG_SP_CHGAVRNOM_SUBKINDS +
          " AND nalg.t_iNumberAlg = comm.t_OperSubkind " +
          " AND fi.t_FIID = comm.t_FIID " +
          " AND issuer.t_PartyID = RSI_RSB_FIInstr.FI_GetIssuerOnDate( fi.t_FIID, comm.t_CommDate ) " + 
          " AND avr.t_FIID = fi.t_FIID " +
          " AND finom.t_FIID = fi.t_FaceValueFi ";

  Select = RSDCommand( query );
  
  Select.AddParam("DocumentID", RSDBP_IN, DocumentID );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  if(DataSet.moveNext())
    AvoirKindNameAndSubName(DataSet.AvoirKind, NULL, AvrKindName, AvrSubKindName);

[
”¨«¨ «  #
                 à®â®ª®« ®¯¥à æ¨¨ ¨§¬¥­¥­¨ï ­®¬¨­ « 

„ â  ®¯¥à æ¨¨     #
‚¨¤ ®¯¥à æ¨¨      #

‚›“‘Š
Œˆ’…’  #
Š®¤      ################   ¨¬¥­®¢ ­¨¥   #
ü £®á. à¥£¨áâà æ¨¨ #
‚¨¤ æ/¡  ############################  ®¤¢¨¤  ########################################
®¬¨­ « ¤® ®¯¥à æ¨¨    ############# ###
®¬¨­ « ¯®á«¥ ®¯¥à æ¨¨ ############# ###
Š””ˆ–ˆ…’ Š‚…’€–ˆˆ #

]( String(DataSet.DeptName),
   Date(DataSet.CommDate):f,
   String(DataSet.OpKindName),
   String(DataSet.IssuerName),
   String(DataSet.FI_Code),
   String(DataSet.FI_Name),
   String(DataSet.LSIN),
   AvrKindName,
   AvrSubKindName,
   DataSet.OldNominal,
   String(DataSet.NominalFICode),
   DataSet.NewNominal,
   String(DataSet.NominalFICode),
   String(DataSet.Coeff)
 );
    return String(DataSet.FI_Name);
  end;
  return "";
end;


// ’®çª  ¢å®¤  ¢ ¬ ªà®á
macro PrintReport( DocumentID )
  file sfcontr(sfcontr);
  var query, DataSet;
  var Select;
  var stat, FI_Name, OldAmountTotal = 0, NewAmountTotal = 0, Contract = "";

  FI_Name = PrintHead( DocumentID );

  query = " SELECT pt.t_ShortName Name, t_Contract, t_OldAmount OldAmount, t_NewAmount NewAmount " +
          " FROM ( SELECT decode(X.t_Party, " + UnknownParty + ", " + {OurBank} + ", X.t_Party) t_PartyID, X.t_Contract, " +
          "               Sum (B.t_Amount) t_OldAmount, " +
          "               Sum (X.t_Amount) t_NewAmount " +
          "        FROM v_scwrthistex X, dpmwrtbc_dbt B, doproper_dbt op " +
          "        WHERE X.t_ID_Operation = op.t_ID_Operation " +
          "          AND X.t_Action = " + PM_WRTSUM_UPDTMODE_CHGAVRNOM +
          "          AND X.t_SumID = B.t_SumID " +
          "          AND B.t_Instance = (X.t_Instance-1) " +
          "          AND X.t_State = " + PM_WRTSUM_FORM +
          "          AND X.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
          "          AND op.t_DocKind = " + DL_CHGAVRNOM +
          "          AND TO_NUMBER(op.t_DocumentID) = ? /*1*/ " +
          "        GROUP BY X.t_Party, X.t_Contract ) t, dparty_dbt pt " +
          " WHERE pt.t_PartyID = t.t_PartyID ";
          
  Select = RSDCommand( query );
  
  Select.AddParam("DocumentID", RSDBP_IN, DocumentID );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);

  println("„ ­­ë¥ ®¡ ®áâ âª å æ¥­­ëå ¡ã¬ £ ¯® ¢« ¤¥«ìæ ¬");

  stat = DataSet.moveNext();
  if(stat)
[
ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
³                                 ³                                 ³         #########################         ³
³          ‚« ¤¥«¥æ æ/¡           ³             „®£®¢®à             ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
³                                 ³                                 ³ ®áâ â®ª ¤® ®¯¥à æ¨¨ ³   â¥ªãé¨© ®áâ â®ª   ³
ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
](FI_Name);

    while(stat)

      Contract = "";
      ClearRecord(sfcontr);
      sfcontr.ID = int(DataSet.Contract);

      if( GetEQ(sfcontr) )
         Contract = sfcontr.Number;
      end;

[³#################################³#################################³#####################³#####################³
ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
](String(DataSet.Name):w, Contract:w, Floor_Money(SQL_ConvTypeSum(DataSet.OldAmount)):c, Floor_Money(SQL_ConvTypeSum(DataSet.NewAmount)):c );

      OldAmountTotal = OldAmountTotal + SQL_ConvTypeSum(DataSet.OldAmount);
      NewAmountTotal = NewAmountTotal + SQL_ConvTypeSum(DataSet.NewAmount);

      stat = DataSet.moveNext();
    end;
[³‚á¥£®                            ³                                 ³#####################³#####################³
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
](Floor_Money(OldAmountTotal):c, Floor_Money(NewAmountTotal):c);
  else
    println( "®âáãâáâ¢ãîâ" );
  end;

  after_44_footer();
end;
