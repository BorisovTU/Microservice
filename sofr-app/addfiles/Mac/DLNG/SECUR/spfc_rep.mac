/*
$Name:        spfc_rep.mac
$Module:      ñ•≠≠Î• °„¨†£®
$Description: é‚Á•‚ ØÆ ÆØ•‡†Ê®® "îÆ‡¨®‡Æ¢†≠®• ™Æ¨®··®© èáé"
*/

/*******************************************************************************
 DESCRIPTION  :   é‚Á•‚ ØÆ ÆØ•‡†Ê®® "îÆ‡¨®‡Æ¢†≠®• ™Æ¨®··®© èáé" 
 CREATION DATE:   10.07.12
*******************************************************************************/
import BankInter, RsbDataSet, "cb_sql.mac", "dvserv.mac", "dvrepfun2.mac", "spserv.mac";

PRIVATE VAR dl_com = TrecHandler( "dl_comm" );

PRIVATE MACRO FindDL_COMM( DocumentID:INTEGER ):BOOL
  var   Data = TRsbDataSet( "SELECT * FROM ddl_comm_dbt WHERE t_DocumentID = " + string(DocumentID) );

  if( Data.MoveNext() )
     Data.GetRecord().CopyTo( dl_com.rec );
     return true;
  end;
  return false;
END;

PRIVATE VAR InvestorSumma = TArray();
PRIVATE CLASS CInvSum( _PaySum, _TaxSum, _FIID )
  VAR PaySum = _PaySum, TaxSum = _TaxSum, FIID = _FIID;
END;

PRIVATE MACRO StoreInvestorSumm( PaySum:MONEY, TaxSum:MONEY, FIID:INTEGER )
  VAR i = 0;

  while( i < InvestorSumma.size)
     if( InvestorSumma[i].FIID == FIID )
        InvestorSumma[i].PaySum = InvestorSumma[i].PaySum + PaySum;
        InvestorSumma[i].TaxSum = InvestorSumma[i].TaxSum + TaxSum;
        return;
     end;

     i = i + 1;
  end;

  InvestorSumma[InvestorSumma.Size] = CInvSum( PaySum, TaxSum, FIID );
END;

PRIVATE MACRO PrintInvestor( DS )
[≥ à≠¢•·‚Æ‡ ##################################  §Æ£Æ¢Æ‡ ¸  ################                            ≥
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
]( èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†( DS.Investor ), DS.OrderNum );

  InvestorSumma.Size = 0;
END;

PRIVATE MACRO PrintInvestorFooter( DS, IsLast:BOOL )
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
];

  VAR i = 0;
  while( i < InvestorSumma.size)

[≥ à‚Æ£Æ ØÆ ®≠¢•·‚Æ‡„ ß† §•≠Ï                           ≥################# ###≥########################≥
](InvestorSumma[i].PaySum, 
  GetCCY(InvestorSumma[i].FIID), 
  InvestorSumma[i].TaxSum
);
     i = i + 1;
  end;

 if( IsLast )
[¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
];
 else
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
];
 end;

END;

PRIVATE MACRO PrintCommission( DS );
[≥#################≥####################################≥################# ###≥########################≥
]( DS.ComCode, 
   èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†( DS.ComReceiverID ):w,
   DS.PaySum, 
   GetCCY(DS.AccFIID), 
   DS.TaxSum
);

   StoreInvestorSumm( DS.PaySum, DS.TaxSum, DS.AccFIID )
END;

PRIVATE MACRO Report():BOOL

  VAR DS, cmd, NumRec, LastInv = -1, LastOrder = -1;

[                        èêéíéäéã éèÖêÄñàà îéêåàêéÇÄçàü äéåàëëàâ èáé
  Ñ†‚† ÆØ•‡†Ê®®: ##########  ™Æ§: #
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥   äÆ§ ™Æ¨®··®®  ≥          èÆ´„Á†‚•´Ï ™Æ¨®··®®       ≥         ë„¨¨†       ≥       Ç ‚.Á. çÑë       ≥
√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
]( dl_com.rec.CommDate, dl_com.rec.CommCode );

  InitProgress( -1, "èÆ§£Æ‚Æ¢™† Æ‚Á•‚† ...", "é‚Á•‚ ØÆ ÆØ•‡†Ê®® ‰Æ‡¨®‡Æ¢†≠®Ô ™Æ¨®··®© èáé" );

  cmd = RSDCommand( 
                    " select contr.t_partyID Investor, contr.t_ID OrderID, contr.t_Number OrderNum, commiss.t_Code ComCode, "+
                    "        commiss.t_receiverid ComReceiverID, dlcom.t_Sum PaySum, dlcom.t_NDS TaxSum, commiss.T_FIID_COMM AccFIID, "+
                    "        dlcom.t_comnumber comNumber, commiss.t_feetype FeeType "+ 
                    " from ddlcomis_dbt dlcom, dsfcontr_dbt contr, dsfcomiss_dbt commiss  "+
                    " where dlcom.t_servoperid= ? "+
                    " AND commiss.t_feetype=dlcom.t_feetype "+
                    " and CONTR.T_ID=dlcom.T_Contract " +
                    " AND commiss.t_number=dlcom.t_comnumber  "+
                    " order by Investor,FeeType, comNumber "


                   );


  cmd.addParam( "", RSDBP_IN, dl_com.rec.DocumentID );
  cmd.execute();
  DS = TRsbDataSet( cmd );
  NumRec = 0;
  while( DS.MoveNext() )

     if( (LastInv != DS.Investor) OR ( LastOrder != DS.OrderID) )
        if( (LastInv > 0) AND (LastInv != DS.Investor) )
           PrintInvestorFooter( DS, false )
        end;
        PrintInvestor( DS );
     end;

     PrintCommission( DS );

     LastInv   = DS.Investor;
     LastOrder = DS.OrderID;
     UseProgress( NumRec = NumRec + 1 );
  end;

  if( LastInv > 0 )
     PrintInvestorFooter( DS, true )
  end;

  RemProgress();

  return true;
END;

MACRO PrintReport( DocumentID:INTEGER )

  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*‰†©´ ¢Î¢Æ§† §´Ô Æ‚Á•‚†*/

  if( not FindDL_COMM( DocumentID ) )
     MsgBox( "ç• ≠†©§•≠† ·•‡¢®·≠†Ô ÆØ•‡†Ê®Ô ‰Æ‡¨®‡Æ¢†≠®Ô ™Æ¨®··®© (ID="+string(DocumentID)+")" );
     return false;
  end;

  ReportFileName = GetTxtFileName( "spfc_" + dl_com.rec.CommCode );
  if( not Open( ReportOutFile, ReportFileName ) )
     errcode = status(errtext);
     RunError( "éË®°™† Ø‡® ·Æß§†≠®® ‰†©´†|"+ReportFileName+"|(" + errcode + ") " + errtext );
  end;
  SetOutput( ReportFileName );

  Report();

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );
  return true;
END;
