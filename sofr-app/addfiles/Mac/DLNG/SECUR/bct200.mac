/*
$Name:         bct200.mac
$Module:       Ценные бумаги
$Description:  Операция покупки ц/б today Шаг "Учет себестоимости offline"
*/
import InsCarryDoc, "sp_class.mac", "scservop.mac", "sp_carcm.mac";

/*группа списания для операции*/
VAR    WriteOffGroups = TArray;   /*данные в массиве используются программой при выполнении шага*/      

macro ExecuteStep( Doc, FDoc )

  record deal(dl_tick);
  var    FD, dat, OldPortf; 
  var    CloseAccArray = DL_AccCollector,
         ErrMsgArray   = DL_TUniqStrCollector;
 
  SetBuff( deal, FDoc );
  FD = SPFirstDoc ( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat ); /*Дата поставки ц/б */
  if( dat > {curdate} )
     return SayErrorBuySale( deal, "Преждевременное выполнение шага запрещено." );
  end;

  if( FD.GetModeWriteOff( true ) != "X" ) /*режим списания владельца - offline*/
                   
     if( ОбработатьЛот( FD, FD.pmwrtsum, dat ) == false )
        return 1;
     end; 

     GetOprDate( DATE_DEALEEND, dat );
     
     if( DL_CloseAccountByDeal(FD.tick.rec.DealID,FD.tick.rec.BofficeKind,dat,CloseAccArray,ErrMsgArray) )
        if( ErrMsgArray.Size() > 0 )
           return SayErrorBuySale( deal, ErrMsgArray, true );
        else
           return SayErrorBuySale( deal, "Ошибка при закрытии счетов по сделке." );
        end;
     end;
     
     SaveDataCloseAccArray(deal,CloseAccArray);

//     if( SvOpIsServiceOper == true )
//        ScOpReportLineData[ScOpReportLineData.Size] = SvOpDeal( deal, FD.IsBack );
//     end;

     if( not FD.IsOldDeal() )
        if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_F1, SP_OPERSTATUS_SECURDEALS_F1_FINISH) )
           msgbox( "Ошибка при установке статуса <Учет по 1 ч offline> операции" );
           return 1;
        end;
     end;
  end;

  return 0;
end;
