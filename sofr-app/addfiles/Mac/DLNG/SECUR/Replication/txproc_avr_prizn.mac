/*
$Name:             txproc_avr_prizn.mac
$Module:           БОЦБ 
$Description:      Репликация признаков ц/б
*/
import txproc_avr_fun, txrepl_func;                           

private var SQL, cmd, rs, Счетчик, НаименованиеБумаги, MaxVal;

macro Process_Avr_Prizn()
   var SQL1, cmd1, CatErr, T_TYPE, T_VALUE;

   НаименованиеБумаги = ПолучитьНаименованиеБумаги(rs.Value("T_AVOIRISSID"));

   if (rs.Value("T_TYPE") == 1)
      // Блокируем репликацию признака обращаемости.

      SQL1 = "update DTXAVRATTR_DBT set t_replstate = 1 where T_AVOIRISSID = " + rs.value("T_AVOIRISSID") + " and t_action = 1 and t_replstate = 0";
      SQL1 = SQL1 + " and t_type = " + rs.value("t_type") + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      SQL1 = SQL1 + " and trunc(t_attrdate) = " + getsqlDate_SK(DateStamp(rs.value("t_attrdate")));

      cmd1 = RsdCommand( SQL1);
      cmd1.execute;

      return true;

      T_TYPE = 17;
   elif (rs.Value("T_TYPE") == 2)
      T_TYPE = 18;
   end;

   if (trim(rs.Value("T_VALUE")) == StrFor(88))
      T_VALUE = 1;
   else
      if (T_TYPE == 18)
         T_VALUE = 2;
      elif (T_TYPE == 17)
         T_VALUE = 0;
      end;
   end;

   if (rs.Value("T_ACTION") == 1)
      if ((T_VALUE == 1) or (T_VALUE == 2))
         if ( not DisconnectObjAttr( OBJTYPE_AVOIRISS, ДополнениеСлева(trim(String(numeric(ПолучитьСоответствие(20, rs.Value("T_AVOIRISSID"))):15:0)), 10, "0" ), T_TYPE))
            ЗанестиЗаписьВПротокол(631, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка при обновлении признака ценной бумаги " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
            AbortTrn;
         end;

         if ( not ConnectObjAttr( CatErr, OBJTYPE_AVOIRISS, ДополнениеСлева(trim(String(numeric(ПолучитьСоответствие(20, rs.Value("T_AVOIRISSID"))):15:0)), 10, "0" ), T_TYPE, ПолучитьIDАтрибута(OBJTYPE_AVOIRISS, T_TYPE, T_VALUE), NULL, NULL, Date(rs.Value("T_ATTRDATE"))))
            ЗанестиЗаписьВПротокол(632, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка при вставке признака ценной бумаги " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
            AbortTrn;
         end;

         if (CatErr != 0)
            ЗанестиЗаписьВПротокол(632, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка при вставке признака ценной бумаги " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
            AbortTrn;
         end;
      end;

      SQL1 = "update DTXAVRATTR_DBT set t_replstate = 1 where T_AVOIRISSID = " + rs.value("T_AVOIRISSID") + " and t_action = 1 and t_replstate = 0";
      SQL1 = SQL1 + " and t_type = " + rs.value("t_type") + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      SQL1 = SQL1 + " and trunc(t_attrdate) = " + getsqlDate_SK(DateStamp(rs.value("t_attrdate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   elif (rs.Value("T_ACTION") == 2)
      if (СущественныйАтрибут(21, rs.Value("T_AVOIRISSID"), "T_ATTRDATE", rs.Value("T_ATTRDATE"), int(rs.Value("T_TYPE"))))
         ЗанестиЗаписьВПротокол(125, 21, rs.Value("T_AVOIRISSID"), int(rs.Value("T_TYPE")), "T_ATTRDATE", "Предупреждение: изменение существенного атрибута 'Дата начала действия значения', новая дата - " + String(Date(rs.Value("T_ATTRDATE"))) + " , бумага " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
      end;
      if (СущественныйАтрибут(21, rs.Value("T_AVOIRISSID"), "T_VALUE", rs.Value("T_VALUE"), int(rs.Value("T_TYPE"))))
         ЗанестиЗаписьВПротокол(126, 21, rs.Value("T_AVOIRISSID"), int(rs.Value("T_TYPE")), "T_VALUE", "Предупреждение: изменение существенного атрибута 'Значение признака', бумага " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
      end;

      if ( not DisconnectObjAttr( OBJTYPE_AVOIRISS, ДополнениеСлева(trim(String(numeric(ПолучитьСоответствие(20, rs.Value("T_AVOIRISSID"))):15:0)), 10, "0" ), T_TYPE))
         ЗанестиЗаписьВПротокол(631, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка при обновлении признака ценной бумаги " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
         AbortTrn;
      end;

      if ((T_VALUE == 1) or (T_VALUE == 2))
         if ( not ConnectObjAttr( CatErr, OBJTYPE_AVOIRISS, ДополнениеСлева(trim(String(numeric(ПолучитьСоответствие(20, rs.Value("T_AVOIRISSID"))):15:0)), 10, "0" ), T_TYPE, ПолучитьIDАтрибута(OBJTYPE_AVOIRISS, T_TYPE, T_VALUE), NULL, NULL, Date(rs.Value("T_ATTRDATE"))))
            ЗанестиЗаписьВПротокол(631, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка при обновлении признака ценной бумаги " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
            AbortTrn;
         end;
      end;

      if ((CatErr != 0) and (ValType(CatErr) != V_UNDEF))
         ЗанестиЗаписьВПротокол(631, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка при обновлении признака ценной бумаги " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
         AbortTrn;
      end;

      SQL1 = "update DTXAVRATTR_DBT set t_replstate=1 where T_AVOIRISSID=" + rs.value("T_AVOIRISSID") + " and t_action=2 and t_replstate=0";
      SQL1 = SQL1 + " and t_type=" + rs.value("t_type") + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      SQL1 = SQL1 + " and trunc(t_attrdate) = " + getsqlDate_SK(DateStamp(rs.value("t_attrdate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   elif (rs.Value("T_ACTION") == 3)
      if ( not DisconnectObjAttr( OBJTYPE_AVOIRISS, ДополнениеСлева(trim(String(numeric(ПолучитьСоответствие(20, rs.Value("T_AVOIRISSID"))):15:0)), 10, "0" ), T_TYPE))
         ЗанестиЗаписьВПротокол(633, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка при удалении признака ценной бумаги " + НаименованиеБумаги, rs.Value("T_INSTANCEDATE"));
         AbortTrn;
      end;

      SQL1 = "update DTXAVRATTR_DBT set t_replstate=1 where T_AVOIRISSID=" + rs.value("T_AVOIRISSID") + " and t_action=3 and t_replstate=0";
      SQL1 = SQL1 + " and t_type=" + rs.value("t_type") + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      SQL1 = SQL1 + " and trunc(t_attrdate) = " + getsqlDate_SK(DateStamp(rs.value("t_attrdate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   end;

   Return TRUE;
OnError(er)
   if (Trim(er.message) != "Error:")
      ЗанестиЗаписьВПротокол(600, 21, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка: " + er.message, rs.Value("T_INSTANCEDATE"));
   end;
   AbortTrn;
end;

macro Обработать_ПризнакЦБ(Action, t_instancedate, Init_Action:String)
   SQL = "select count(*) from DTXAVRATTR_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate;
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
      MaxVal = rs.Value(0);
   end;

   var ProgressIndicator = CreateProgressIndicator(true);
   ProgressIndicator.Start(Int(MaxVal), "Обработка признаков ценных бумаг...");

   Счетчик = 0;

   SQL = "select * from DTXAVRATTR_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate + " order by t_avoirissid, t_type, trunc(t_attrdate)";
   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);
  
   while (rs.Movenext)
      Счетчик = Счетчик + 1;

      ProgressIndicator.Update(Int(Счетчик), MaxVal);
   
      if (not ProcessTrn(Null, "Process_Avr_Prizn"))
      end;
   end;

   ProgressIndicator.Stop();
   
   return TRUE;
OnError(er)
   ЗанестиЗаписьВПротокол(600, 21, "", "", StrFor(1), "Ошибка: " + er.message, date(t_instancedate));
end;