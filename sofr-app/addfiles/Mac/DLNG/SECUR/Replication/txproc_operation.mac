/*
$Name:             txproc_operation.mac
$Module:           БОЦБ 
$Description:      Макрос репликации операций
*/
import txproc_oper_fun, txrepl_func, txproc_paym_fun;

private var SQL, cmd, rs, Счетчик, DealIsClose, MaxVal;

macro ProcessOperation()
   var OperData = TOperationInfo;
   var SQL1, cmd1, rs1;
   var SaveInChangeHistory = FALSE;
   var DemandData;
   var MainREPO; // Исходная сделка РЕПО на корзину для фиктивной операции, описывающей движение обеспечения.
   var ЗерГуд;
   VAR IsBasket = false;

   var T_CLOSEDATE_Change, T_PAYDATE2_Change, T_SUPLDATE2_Change, T_RATE_Change;

   T_CLOSEDATE_Change = T_PAYDATE2_Change = T_SUPLDATE2_Change = T_RATE_Change = FALSE;

   if (rs.Value("T_TECHTYPE") != 0) 
      ЗанестиЗаписьВПротокол(300, 80, rs.value("T_DEALID"), 1, StrFor(1), "Предупреждение: техническая сделка в систему не реплицируется", rs.Value("T_INSTANCEDATE"));

      SQL1 = "update DTXDEAL_DBT set t_replstate = 2 where t_dealid = " + rs.value("t_DEALID") +" and t_action = 1 and t_replstate = 0";
      SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;

      Return TRUE;
   end;

   if (rs.Value("T_ACTION") == 1)
      OperData.T_DEALID    =  rs.Value("T_DEALID");
   else
      OperData.T_DEALID    =  ПолучитьСоответствие(80, rs.Value("T_DEALID"));
   end;

   OperData.OldDealID = rs.Value("T_DEALID");

   if (rs.Value("T_ACTION") == 2)
      if (ПроверитьНаРучноеИзменение(80, rs.value("T_DEALID")))
         ЗанестиЗаписьВПротокол(206, 80, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: объект находится в режиме ручного редактирования", rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      if (ЗакрытаяСделка(ПолучитьСоответствие(80, rs.Value("T_DEALID"))))
         DealIsClose = TRUE;
         ЧтоИзменилосьвЗакрытойСделке(rs.value("T_DEALID"), rs.value("T_INSTANCEDATE"));
      else
         if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_CLOSEDATE", rs.Value("T_CLOSEDATE")))
            SaveInChangeHistory = TRUE;
            T_CLOSEDATE_Change = TRUE;
         end;
         if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_PAYDATE2", rs.Value("T_PAYDATE2")))
            SaveInChangeHistory = TRUE;
            T_PAYDATE2_Change = TRUE;
         end;
         if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_SUPLDATE2", rs.Value("T_SUPLDATE2")))
            SaveInChangeHistory = TRUE;
            T_SUPLDATE2_Change = TRUE;
         end;
         if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_RATE", rs.Value("T_RATE")))
            SaveInChangeHistory = TRUE;
            T_RATE_Change = TRUE;
         end;
      end;
   end;
   OperData.T_KIND      =  rs.Value("T_KIND");
   if ((OperData.T_KIND == 500) or (OperData.T_KIND == 510))
      IsBasket=true; end;
      OperData.T_EXTCODE   =  trim(rs.Value("T_EXTCODE"));

      if ((trim(rs.Value("T_MARKETCODE")) != NullVal) and (trim(rs.Value("T_MARKETCODE")) != StrFor(32))
           and (trim(rs.Value("T_MARKETCODE")) != StrFor(1)) and (trim(rs.Value("T_MARKETCODE")) != StrFor(0)))
         OperData.T_MARKETCODE = trim(rs.Value("T_MARKETCODE"));
      end;

      if ((trim(rs.Value("T_PARTYCODE")) != NullVal) and (trim(rs.Value("T_PARTYCODE")) != StrFor(32)) and
          (trim(rs.Value("T_PARTYCODE")) != StrFor(1)) and (trim(rs.Value("T_PARTYCODE")) != StrFor(0)))
         OperData.T_PARTYCODE =  trim(rs.Value("T_PARTYCODE"));
      end;

      OperData.T_CODE      =  trim(rs.Value("T_CODE"));

      if ((DateStamp(rs.Value("T_DATE")) + 1) == Date(02,01,0001))
         OperData.T_DATE   =  date(00,00,0000);
      else
         OperData.T_DATE   =  Date(rs.Value("T_DATE"));
      end;
   
      OperData.T_TIME      =  Time(rs.Value("T_TIME"));
   
      if ((DateStamp(rs.Value("T_CLOSEDATE")) + 1) == Date(02,01,0001))
         OperData.T_CLOSEDATE   =  date(00,00,0000);
      else
         OperData.T_CLOSEDATE   =  Date(rs.Value("T_CLOSEDATE"));
      end;
   
      OperData.T_TSKIND    =  rs.Value("T_TSKIND");
      OperData.T_ACCOUNTTYPE  = rs.Value("T_ACCOUNTTYPE");
   
      if (rs.Value("T_MARKETID") != NullVal)
         OperData.T_MARKETID  =  ПолучитьСоответствие(30, rs.Value("T_MARKETID"));
         OperData.T_SECTOR    =  ПолучитьСоответствие(40, rs.Value("T_MARKETID"), rs.Value("T_SECTOR"));
      end;
   
      if (rs.Value("T_BROKERID") != NullVal)
         OperData.T_BROKERID  =  ПолучитьСоответствие(30, rs.Value("T_BROKERID"));
      end;
   
      if (rs.Value("T_PARTYID") != NullVal)
         OperData.T_PARTYID           =  ПолучитьСоответствие(30, rs.Value("T_PARTYID"));
   
         if ((rs.Value("T_PARTYID") > 0) and (OperData.T_PARTYID == -1))
            ЗанестиЗаписьВПротокол(596, 80, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: для сделки не найден контрагент", rs.Value("T_INSTANCEDATE"));
            Return FALSE;
         end;
      end;
   
      if (rs.Value("T_DEPARTMENT") != NullVal)   
         OperData.T_DEPARTMENT        =  ПолучитьУзелТС(ПолучитьСоответствие(30, rs.Value("T_DEPARTMENT")));
      end;
      if ((rs.Value("T_AVOIRISSID") != NullVal) and (rs.Value("T_AVOIRISSID") == -20))
         OperData.T_AVOIRISSID = -20;  // РЕПО на корзину ценных бумаг.
      else
         OperData.T_AVOIRISSID        =  ПолучитьСоответствие(20, rs.Value("T_AVOIRISSID"));
      end;
      if (rs.Value("T_WARRANTID") != NullVal)
         OperData.T_WARRANTID  =  ПолучитьСоответствие(50, rs.Value("T_WARRANTID"))
      else
         OperData.T_WARRANTID = "null";
      end;
      if (rs.Value("T_PARTIALID") != NullVal)
        OperData.T_PARTIALID  =  ПолучитьСоответствие(60, rs.Value("T_PARTIALID"))
      else
        OperData.T_PARTIALID = "null";
      end;
      if (rs.Value("T_AMOUNT") != NullVal)       
         OperData.T_AMOUNT     =  rs.Value("T_AMOUNT");
      end;
      if (rs.Value("T_CURRENCYID") != NullVal)
         OperData.T_CURRENCYID        =  ПолучитьСоответствие(10, rs.Value("T_CURRENCYID"));
      end;
      if (rs.Value("T_PRICE") != NullVal)
         OperData.T_PRICE  =  rs.Value("T_PRICE");
      else
         OperData.T_PRICE = "null";
      end;
      if (rs.Value("T_POINT") != NullVal)
         OperData.T_POINT             =  rs.Value("T_POINT");
      end;
      if (rs.Value("T_COST") != NullVal)
        OperData.T_COST              =  rs.Value("T_COST");
      end;
      if (rs.Value("T_NKD") != NullVal)
        OperData.T_NKD               =  rs.Value("T_NKD");
      end;
      if (rs.Value("T_TOTALCOST") != NullVal)
        OperData.T_TOTALCOST  =  rs.Value("T_TOTALCOST")
      else
        OperData.T_TOTALCOST = "null";
      end;
      if (rs.Value("T_RATE") != NullVal)
        OperData.T_RATE   =  rs.Value("T_RATE");
      else
        OperData.T_RATE = "null";
      end;
      OperData.T_REPOBASE          = -1;

      if (rs.Value("T_REPOBASE")  != nullval)
         if ((rs.Value("T_REPOBASE") > 0) AND (rs.Value("T_REPOBASE") < 6))
            OperData.T_REPOBASE       =  rs.Value("T_REPOBASE");
         end;
      end;
      
     if (rs.Value("T_ISPFI_1")  != nullval)
        OperData.T_ISPFI_1 = rs.Value("T_ISPFI_1");
     end;
    
     if (rs.Value("T_ISPFI_2")  != nullval)
        OperData.T_ISPFI_2 = rs.Value("T_ISPFI_2");
     end;
  
     if (rs.Value("T_LIMIT")  != nullval)
        OperData.T_LIMIT = rs.Value("T_LIMIT");
     end;
  
     if (rs.Value("T_CHRATE")  != nullval)
        OperData.T_CHRATE = rs.Value("T_CHRATE");
     end;
     if (rs.Value("T_COUNTRY")  != nullval)
        OperData.T_COUNTRY = rs.Value("T_COUNTRY");
        if (rs.Value("T_COUNTRY")  == "")
           OperData.T_COUNTRY = 643;
        end;
     else
        OperData.T_COUNTRY = 643;
     end;

     if ((rs.Value("T_CHAVR")  != nullval)  and ((DateStamp(rs.Value("T_CHAVR")) + 1) != Date(02,01,0001)))
        OperData.T_CHAVR = rs.Value("T_CHAVR");
     else
        OperData.T_CHAVR = date(00,00,0000);
     end;

     if (rs.Value("T_PRICE2") != NullVal)
        OperData.T_PRICE2            =  rs.Value("T_PRICE2");
     end;
  
     if (rs.Value("T_COST2") != NullVal)
        OperData.T_COST2             =  rs.Value("T_COST2");
     end;
  
     if (rs.Value("T_NKD2") != NullVal)
        OperData.T_NKD2              =  rs.Value("T_NKD2");
     end;
  
     if (rs.Value("T_TOTALCOST2") != NullVal)
        OperData.T_TOTALCOST2        =  rs.Value("T_TOTALCOST2");
     end;
  
     if ((DateStamp(rs.Value("T_PAYDATE")) + 1) == Date(02,01,0001))
        OperData.T_PAYDATE   =  date(00,00,0000);
        if (OperData.T_AVOIRISSID == -20) OperData.T_PAYDATE = Date(rs.Value("T_SUPLDATE"));
        end;
     else
        OperData.T_PAYDATE   =  Date(rs.Value("T_PAYDATE"));
     end;
  
     if ((DateStamp(rs.Value("T_SUPLDATE")) + 1) == Date(02,01,0001))
        OperData.T_SUPLDATE   =  date(00,00,0000);
        if (OperData.T_AVOIRISSID == -20)
           OperData.T_SUPLDATE = OperData.T_PAYDATE;  // Для РЕПО на корзину дата не будет пустой.
        end;
     else
        OperData.T_SUPLDATE   =  Date(rs.Value("T_SUPLDATE"));
     end;

     if ((DateStamp(rs.Value("T_PAYDATE2")) + 1) == Date(02,01,0001))
        OperData.T_PAYDATE2   =  date(00,00,0000);
     else
        OperData.T_PAYDATE2   =  Date(rs.Value("T_PAYDATE2"));
     end;
  
     if ((DateStamp(rs.Value("T_SUPLDATE2")) + 1) == Date(02,01,0001))
        OperData.T_SUPLDATE2   =  date(00,00,0000);
     else
        OperData.T_SUPLDATE2   =  Date(rs.Value("T_SUPLDATE2"));
     end;
  
     if (rs.Value("T_CONTRNUM") != NullVal)
        OperData.T_CONTRNUM  =  trim(rs.Value("T_CONTRNUM"));
  
        if ((DateStamp(rs.Value("T_CONTRDATE")) + 1) == Date(02,01,0001))
           OperData.T_CONTRDATE   =  date(00,00,0000);
        else
           OperData.T_CONTRDATE   =  Date(rs.Value("T_CONTRDATE"));
        end;
     end;

     if (rs.Value("T_COSTCHANGE") != NullVal)
        OperData.T_COSTCHANGE  = rs.Value("T_COSTCHANGE");
     end;

     OperData.T_PAYMCUR = -1;
     if (rs.Value("T_PAYMCUR") != NullVal)
        OperData.T_PAYMCUR  = ПолучитьСоответствие(10, rs.Value("T_PAYMCUR"));
     end;
  
     if (rs.Value("T_COSTCHANGEONCOMP") != NullVal)
        OperData.T_COSTCHANGEONCOMP  = rs.Value("T_COSTCHANGEONCOMP");
     end;

     if (rs.Value("T_DOPCONTROL") != NullVal)
        OperData.T_DOPCONTROL  = rs.Value("T_DOPCONTROL");
     end;
  
     if (rs.Value("T_FISSKIND") != NullVal)
        OperData.T_FISSKIND  = rs.Value("T_FISSKIND");
     end;
  
     if (rs.Value("T_PRICE_CALC") != NullVal)
        OperData.T_PRICE_CALC  = rs.Value("T_PRICE_CALC");
     end;
  
     if (rs.Value("T_PRICE_CALC_METHOD") != NullVal)
        OperData.T_PRICE_CALC_METHOD  = rs.Value("T_PRICE_CALC_METHOD");
     end;

     if (rs.Value("T_PRICE_CALC_VAL") == NullVal)
        OperData.T_PRICE_CALC_VAL = -1;
     elif  (rs.Value("T_PRICE_CALC_VAL") == 0)
        OperData.T_PRICE_CALC_VAL = "%";
     else
        OperData.T_PRICE_CALC_VAL  = ПолучитьКодВалюты( rs.Value("T_PRICE_CALC_VAL"));
     end;
  
     if (rs.Value("T_PRICE_CALC_DEF") != NullVal)
        OperData.T_PRICE_CALC_DEF  = rs.Value("T_PRICE_CALC_DEF");
     end;
  
     if (rs.Value("T_PRICE_CALC_OUTLAY") != NullVal)
        OperData.T_PRICE_CALC_OUTLAY  = rs.Value("T_PRICE_CALC_OUTLAY");
     end;
  
     if (rs.Value("T_DOPCONTROL_NOTE") != NullVal)
        OperData.T_DOPCONTROL_NOTE  = rs.Value("T_DOPCONTROL_NOTE");
     end;
  
     if (rs.Value("T_PRICE_CALC_MET_NOTE") != NullVal)
        OperData.T_PRICE_CALC_MET_NOTE  = rs.Value("T_PRICE_CALC_MET_NOTE");
     end;
  
     if ((rs.Value("T_PARENTID") != NullVal) AND (rs.Value("T_PARENTID") != 0))
        OperData.T_PARENTID = ПолучитьСоответствие(80, rs.Value("T_PARENTID"));
     else
        OperData.T_PARENTID = 0;
     end;

     if (OperData.T_PARENTID != 0)
        IsBasket=true;
     end;

     if ( IsBasket )
        if (OperData.T_PARENTID == -1)
           ЗанестиЗаписьВПротокол(596, 80, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: не найдена сделка РЕПО на корзину.", rs.Value("T_INSTANCEDATE"));
           Return FALSE;
        end;
     end;
  
     if (rs.Value("T_COSTCHANGEONAMOR") != NullVal)
        OperData.T_COSTCHANGEONAMOR  = rs.Value("T_COSTCHANGEONAMOR");
     end;
  
     if (rs.Value("T_ADJUSTMENT") != NullVal)
        OperData.T_ADJUSTMENT  = rs.Value("T_ADJUSTMENT");
     end;
  
     if (rs.Value("T_ATANYDAY") != NullVal)
        OperData.T_ATANYDAY    = Trim(rs.Value("T_ATANYDAY"));
     else
        OperData.T_ATANYDAY    = "";
     end;
  
     if (rs.Value("T_DIV") != NullVal)
        OperData.T_DIV    = Trim(rs.Value("T_DIV"));
     else
        OperData.T_DIV    = "";
     end;

     if ((rs.Value("T_CONDITIONS") != NullVal) and (rs.Value("T_CONDITIONS") != StrFor(32)) and
         (rs.Value("T_CONDITIONS") != StrFor(1)) and (rs.Value("T_CONDITIONS") != StrFor(0)))
        OperData.T_CONDITIONS  = trim(rs.Value("T_CONDITIONS"));
     end;
  
     if (rs.Value("T_NKDFIID")  != nullval) OperData.T_NKDFIID = ПолучитьСоответствие(10, rs.Value("T_NKDFIID"));
         else OperData.T_NKDFIID = -1;
     end;
  
     OperData.T_STATE  = 1;
  
     OperData.T_INSTANCEDATE = Date(rs.Value("T_INSTANCEDATE"));
  
     if (rs.Value("T_BALANCEDATE") == nullval )
        OperData.T_BALANCEDATE   =  OperData.T_DATE;
     elif ((DateStamp(rs.Value("T_BALANCEDATE")) + 1) == Date(02,01,0001))
        OperData.T_BALANCEDATE   =  OperData.T_DATE;
     else
        OperData.T_BALANCEDATE   =  Date(rs.Value("T_BALANCEDATE"));
     end;

     if (((rs.Value("T_ACTION") == 3) or (rs.Value("T_ACTION") == 2)) and (rs.Value("T_NEEDDEMAND") == "X"))
        OperData.DeleteDemands = TRUE;
     end;

     OperData.InTRN    = TRUE;
     ЗерГуд = FALSE;
     //------------------------------------------------------------------------------------------------

     if ( IsBasket )    // Если это фиктивная операция для обработки РЕПО на корзину.
        if( ОбработатьОперацию_корзина( OperData, rs.Value("T_ACTION"), SaveInChangeHistory ) == false )
           Return FALSE;
        else
           ЗерГуд = true;
        end;
     else
     //------------------------------------------------------------------------------------------------
        if( ОбработатьОперацию( OperData, rs.Value("T_ACTION"), SaveInChangeHistory ) == false )
           Return FALSE;
        else
           ЗерГуд = true;
        end;  
     end;
     //------------------------------------------------------------------------------------------------

   if ( ЗерГуд )
      if ((rs.Value("T_ACTION") == 1) or (rs.Value("T_ACTION") == 2))
         if (rs.Value("T_ACTION") == 1)
            SQL1 = "delete from DTXREPLOBJ_DBT where T_OBJECTTYPE=80 and t_objstate = 2 and t_objectid = " + rs.Value("T_DEALID");
            cmd1 = RsdCommand( SQL1);
            cmd1.execute;

            SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
            SQL1 = SQL1 + "T_OBJSTATE) values (80, " + rs.Value("T_DEALID") + ", 1, ";
            SQL1 = SQL1 + OperData.T_DEALID + " ,1 , 0)";

            cmd1 = RsdCommand( SQL1);
            cmd1.execute;
         elif (rs.Value("T_ACTION") == 3)
            SQL1 = "delete from ddlrq_dbt where t_type IN (2,8) and t_docid = " + ПолучитьСоответствие(80, rs.Value("T_DEALID"));
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;

            SQL1 = "update DTXREPLOBJ_DBT set t_objstate=2 where t_objecttype=90 and t_destid = " + rs.Value("T_DEALID");
            cmd1 = RsdCommand( SQL1);
            cmd1.execute;
         end;

         SQL1 = "update DTXDEAL_DBT set t_replstate = 1 where t_DEALID = " + rs.value("T_DEALID") + " and t_action = " + rs.Value("T_ACTION") + " and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         if ((Trim(rs.Value("T_NEEDDEMAND")) == "X") and ( IsBasket==false))
            SQL1 = "delete from DDLRQ_DBT where t_docid = " + ПолучитьСоответствие(80, rs.Value("T_DEALID"));
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;

            DemandData = TDemandData;
            DemandData.T_DEMANDID      = rs.Value("T_DEALID");
            DemandData.T_DEALID        = ПолучитьСоответствие(80, rs.Value("T_DEALID"));
            DemandData.T_ISFACT        = "X";
            DemandData.T_DATE          = OperData.T_SUPLDATE;
            DemandData.T_NETTING       = 0;
            DemandData.InTRN          = TRUE;
            DemandData.OldDealID       = rs.Value("T_DEALID");

            if ((OperData.T_KIND != 80) and (OperData.T_KIND != 90) and (OperData.T_AVOIRISSID > -20) )
               DemandData.T_KIND          = 10;

               if (OperData.T_KIND == 10)
                  DemandData.T_DIRECTION     = 1;
               elif ((OperData.T_KIND == 20) or (OperData.T_KIND == 70))
                  DemandData.T_DIRECTION     = 2;
               end;

               DemandData.T_FIKIND        = 20;
               DemandData.T_SUM           = OperData.T_AMOUNT;
               DemandData.T_PART          = 1;
               DemandData.T_NOTE          = StrFor(1);
               DemandData.T_STATE         = 3;

               if( ОбработатьТребование( DemandData, 1 ) == false )
                  Return FALSE;
               else
                  SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
                  SQL1 = SQL1 + "T_OBJSTATE) values (90, " + rs.Value("T_DEALID") + ", 81, ";
                  SQL1 = SQL1 + DemandData.T_DEMANDID + " ,1 , 0)";
                  cmd1 = RsdCommand( SQL1);
                  cmd1.execute;
               end;
            end;

            DemandData.T_DEMANDID      = rs.Value("T_DEALID");
            DemandData.T_KIND          = 40;
            DemandData.T_FIKIND        = 10;
            DemandData.T_DATE          = OperData.T_PAYDATE;   /*I-Support 272911*/
            DemandData.T_SUM           = OperData.T_TOTALCOST;
            DemandData.T_PAYCURRENCYID = OperData.T_CURRENCYID;
            DemandData.T_PAYSUM        = OperData.T_TOTALCOST;
            DemandData.T_PART          = 1;

            DemandData.IsAvoirissPaym  = FALSE;

            if (OperData.T_KIND == 10)
               DemandData.T_DIRECTION     = 2;
            elif ((OperData.T_KIND == 20) or (OperData.T_KIND == 70) or (OperData.T_KIND == 80) or (OperData.T_KIND == 90))
               DemandData.T_DIRECTION     = 1;
            end;
            if (ОбработатьТребование( DemandData, 1 ) == false)
               Return FALSE;
            else
                 SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
                 SQL1 = SQL1 + "T_OBJSTATE) values (90, " + rs.Value("T_DEALID") + ", 82, ";
                 SQL1 = SQL1 + DemandData.T_DEMANDID + " ,1 , 0)";

                 cmd1 = RsdCommand( SQL1);
                 cmd1.execute;
            end;
         end;
      end;
      
      if (rs.Value("T_ACTION") == 2)
         if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_DATE", rs.Value("T_DATE")))
            ЗанестиЗаписьВПротокол(136, 80, rs.Value("T_DEALID"), 1, "T_DATE", "Предупреждение: изменение существенного атрибута 'Дата'", rs.Value("T_INSTANCEDATE"));
         end;

         if (not DealIsClose)
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_CURRENCYID", rs.Value("T_CURRENCYID")))
               ЗанестиЗаписьВПротокол(133, 80, rs.Value("T_DEALID"), 1, "T_CURRENCYID", "Предупреждение: изменение существенного атрибута 'Валюта'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_KIND", rs.Value("T_KIND")))
               ЗанестиЗаписьВПротокол(134, 80, rs.Value("T_DEALID"), 1, "T_KIND", "Предупреждение: изменение существенного атрибута 'Вид'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_TIME", rs.Value("T_TIME")))
               ЗанестиЗаписьВПротокол(135, 80, rs.Value("T_DEALID"), 1, "T_TIME", "Предупреждение: изменение существенного атрибута 'Время'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_CONTRDATE", rs.Value("T_CONTRDATE")))
               ЗанестиЗаписьВПротокол(137, 80, rs.Value("T_DEALID"), 1, "T_CONTRDATE", "Предупреждение: изменение существенного атрибута 'Дата договора'", rs.Value("T_INSTANCEDATE"));
            end;
            if (T_PAYDATE2_Change)
               ЗанестиЗаписьВПротокол(139, 80, rs.Value("T_DEALID"), 1, "T_PAYDATE2", "Предупреждение: изменение существенного атрибута 'Дата оплаты по второй части'", rs.Value("T_INSTANCEDATE"));
            end;
            if (T_SUPLDATE2_Change)
               ЗанестиЗаписьВПротокол(140, 80, rs.Value("T_DEALID"), 1, "T_SUPLDATE2", "Предупреждение: изменение существенного атрибута 'Дата поставки по второй части'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_CONDITIONS", rs.Value("T_CONDITIONS")))
               ЗанестиЗаписьВПротокол(141, 80, rs.Value("T_DEALID"), 1, "T_CONDITIONS", "Предупреждение: изменение существенного атрибута 'Дополнительные условия'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_EXTCODE", rs.Value("T_EXTCODE")))
               ЗанестиЗаписьВПротокол(142, 80, rs.Value("T_DEALID"), 1, "T_EXTCODE", "Предупреждение: изменение существенного атрибута 'Код во внешней системе'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_AMOUNT", rs.Value("T_AMOUNT")))
               ЗанестиЗаписьВПротокол(143, 80, rs.Value("T_DEALID"), 1, "T_AMOUNT", "Предупреждение: изменение существенного атрибута 'Количество'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_PARTYID", rs.Value("T_PARTYID")))
               ЗанестиЗаписьВПротокол(144, 80, rs.Value("T_DEALID"), 1, "T_AMOUNT", "Предупреждение: изменение существенного атрибута 'Контрагент'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_NKD", rs.Value("T_NKD")))
               ЗанестиЗаписьВПротокол(145, 80, rs.Value("T_DEALID"), 1, "T_NKD", "Предупреждение: изменение существенного атрибута 'НКД'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_NKD2", rs.Value("T_NKD2")))
               ЗанестиЗаписьВПротокол(146, 80, rs.Value("T_DEALID"), 1, "T_NKD2", "Предупреждение: изменение существенного атрибута 'НКД по второй части'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_CONTRNUM", rs.Value("T_CONTRNUM")))
               ЗанестиЗаписьВПротокол(147, 80, rs.Value("T_DEALID"), 1, "T_CONTRNUM", "Предупреждение: изменение существенного атрибута 'Номер договора'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_TOTALCOST", rs.Value("T_TOTALCOST")))
               ЗанестиЗаписьВПротокол(148, 80, rs.Value("T_DEALID"), 1, "T_TOTALCOST", "Предупреждение: изменение существенного атрибута 'Общая сумма'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_TOTALCOST2", rs.Value("T_TOTALCOST2")))
               ЗанестиЗаписьВПротокол(149, 80, rs.Value("T_DEALID"), 1, "T_TOTALCOST2", "Предупреждение: изменение существенного атрибута 'Общая сумма по второй части'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_COSTCHANGE", rs.Value("T_COSTCHANGE")))
               ЗанестиЗаписьВПротокол(150, 80, rs.Value("T_DEALID"), 1, "T_COSTCHANGE", "Предупреждение: изменение существенного атрибута 'Признак изменения стоимости при выплате доходов'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_ADJUSTMENT", rs.Value("T_ADJUSTMENT")))
               ЗанестиЗаписьВПротокол(151, 80, rs.Value("T_DEALID"), 1, "T_ADJUSTMENT", "Предупреждение: изменение существенного атрибута 'Признак урегулирования требований'", rs.Value("T_INSTANCEDATE"));
            end;
            if (T_RATE_Change)
               ЗанестиЗаписьВПротокол(152, 80, rs.Value("T_DEALID"), 1, "T_RATE", "Предупреждение: изменение существенного атрибута 'Ставка'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_COST", rs.Value("T_COST")))
               ЗанестиЗаписьВПротокол(153, 80, rs.Value("T_DEALID"), 1, "T_COST", "Предупреждение: изменение существенного атрибута 'Стоимость'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_COST2", rs.Value("T_COST2")))
               ЗанестиЗаписьВПротокол(154, 80, rs.Value("T_DEALID"), 1, "T_COST2", "Предупреждение: изменение существенного атрибута 'Стоимость по второй части'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_ACCOUNTTYPE", rs.Value("T_ACCOUNTTYPE")))
               ЗанестиЗаписьВПротокол(155, 80, rs.Value("T_DEALID"), 1, "T_ACCOUNTTYPE", "Предупреждение: изменение существенного атрибута 'Тип расчетов'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_POINT", rs.Value("T_POINT")))
               ЗанестиЗаписьВПротокол(156, 80, rs.Value("T_DEALID"), 1, "T_POINT", "Предупреждение: изменение существенного атрибута 'Точность'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_DEPARTMENT", rs.Value("T_DEPARTMENT")))
               ЗанестиЗаписьВПротокол(157, 80, rs.Value("T_DEALID"), 1, "T_DEPARTMENT", "Предупреждение: изменение существенного атрибута 'Филиал'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_PRICE", rs.Value("T_PRICE")))
               ЗанестиЗаписьВПротокол(158, 80, rs.Value("T_DEALID"), 1, "T_PRICE", "Предупреждение: изменение существенного атрибута 'Цена'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_PRICE2", rs.Value("T_PRICE2")))
               ЗанестиЗаписьВПротокол(159, 80, rs.Value("T_DEALID"), 1, "T_PRICE2", "Предупреждение: изменение существенного атрибута 'Цена по второй части'", rs.Value("T_INSTANCEDATE"));
            end;
            if (СущественныйАтрибут(80, rs.Value("T_DEALID"), "T_AVOIRISSID", rs.Value("T_AVOIRISSID")))
               ЗанестиЗаписьВПротокол(160, 80, rs.Value("T_DEALID"), 1, "T_AVOIRISSID", "Предупреждение: изменение существенного атрибута 'Идентификатор ценной бумаги'", rs.Value("T_INSTANCEDATE"));
            end;
            if (rs.Value("T_PAYMCUR") != nullval)
               if (СущественныйАтрибут(80, rs.Value("T_PAYMCUR"), "T_PAYMCUR", rs.Value("T_PAYMCUR")))
                  ЗанестиЗаписьВПротокол(160, 80, rs.Value("T_DEALID"), 1, "T_PAYMCUR", "Предупреждение: изменение существенного атрибута 'Валюта платежа'", rs.Value("T_INSTANCEDATE"));
               end;
            end;
         end;
      elif (rs.Value("T_ACTION") == 3)
         SQL1 = "update DTXDEAL_DBT set t_replstate = 1 where T_DEALID = " + rs.value("T_DEALID") + " and t_action = 3 and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         SQL1 = "update DTXREPLOBJ_DBT ots set ots.T_OBJSTATE = 2 where ots.T_OBJECTTYPE=80 and ots.T_OBJECTID=" + rs.value("T_DEALID");
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         if (Trim(rs.Value("T_NEEDDEMAND")) == "X")
            SQL1 = "update DTXREPLOBJ_DBT set T_OBJSTATE = 2 where T_OBJECTTYPE = 90 and T_OBJECTID = " + rs.value("T_DEALID") + " and T_SUBOBJNUM in (81, 82)";
            cmd1 = RsdCommand( SQL1);
            cmd1.execute;
         end;
         ЗанестиЗаписьВПротокол(600, 80, rs.value("T_DEALID"), 1, StrFor(1), "Сделка удалена.");
      end;

      Return TRUE;
   end;
OnError(er)
   if (Trim(er.message) != "Error:")
      ЗанестиЗаписьВПротокол(600, 80, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: " + er.message, rs.Value("T_INSTANCEDATE"));
   end;
   Aborttrn;
end;

macro Обработать_Операцию(Action, t_instancedate, Init_Action:String)
   SQL = "select count(*) from DTXDEAL_DBT where t_replstate = 0 and ((t_parentid is null) or (t_parentid=0)) and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate;
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
	  MaxVal = rs.Value(0);

      if (Счетчик > 0 )
         var ProgressIndicator = CreateProgressIndicator(true);
         ProgressIndicator.Start(Int(MaxVal), "Обработка сделок...");
   
         Счетчик = 0;
   
         SQL = "select * from DTXDEAL_DBT where t_replstate = 0 and ((t_parentid is null) or (t_parentid=0)) and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate + " order by t_dealid";
         cmd = RsdCommand( SQL);
         rs = RsdRecordSet(cmd);
 
         while (rs.Movenext)
            Счетчик = Счетчик + 1;
            ProgressIndicator.Update(Int(Счетчик), MaxVal);
   
            if (not ProcessTrn(Null, "ProcessOperation"))
            end;
         end;

         ProgressIndicator.Stop();
      end;
   end;

   // Теперь корзина.
   SQL = "select count(*) from DTXDEAL_DBT where t_replstate = 0 and t_parentid>0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate;
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
      MaxVal = rs.Value(0);

      if (Счетчик > 0 )
         ProgressIndicator = CreateProgressIndicator(true);
         ProgressIndicator.Start(Int(MaxVal), "Обработка сделок...");
         Счетчик = 0;
   
         SQL = "select * from DTXDEAL_DBT where t_replstate = 0 and t_parentid>0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate + " order by t_dealid";
         cmd = RsdCommand( SQL);
         rs = RsdRecordSet(cmd);

         while (rs.Movenext)
            Счетчик = Счетчик + 1;
            ProgressIndicator.Update(Int(Счетчик), MaxVal);
   
            if (not ProcessTrn(Null, "ProcessOperation"))
            end;
         end;

         ProgressIndicator.Stop();
      end;
   end;
   
   return TRUE;
OnError(er)
      ЗанестиЗаписьВПротокол(600, 80, "", "", StrFor(1), "Ошибка: " + er.message, date(t_instancedate));
end;