/*
$Name:             txproc_comiss.mac
$Module:           БОЦБ 
$Description:      Макрос репликации комиссий
*/
import txrepl_func, PTInter;
import "cb_sql.mac";

var NDSSUM;
var SQL, cmd, rs, Счетчик;
private var MaxVal;

private macro ПолучитьДоговорОбслуживания(OurDealID, SfContrID, SfPartyID)
   private var SQL, rs1, cmd1, PartyContrID;

   SQL = "select count(*) from dsfcontr_dbt";
   cmd1 = RsdCommand(SQL);
   rs1 = RsdRecordSet(cmd1);
   rs1.Movenext;

   SQL = "select t_id, T_CONTRACTORID from dsfcontr_dbt";
   cmd1 = RsdCommand(SQL);
   rs1 = RsdRecordSet(cmd1);

   if (rs1.Movenext)
      SetParm (1, rs1.Value(0));
      SetParm (2, rs1.Value(1));
   else
      ЗанестиЗаписьВПротокол(598, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: не найден договор обслуживания " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
      Return FALSE;
   end;

   Return TRUE;
end;

macro ProcessComiss(rs)
   var SQL1, cmd1, rs1, Count, ComID, SfContrID, SfFIID, SfPartyID, OurDealID;
   var SQL2, cmd2, rs2;
   var commnumber, err = 0;

   SQL1 = "SELECT T_DESTID FROM DTXREPLOBJ_DBT where T_OBJECTTYPE = 100 and T_OBJECTID = " + rs.value("T_COMISSID") + " AND T_OBJSTATE != 2";
   cmd1 = RsdCommand( SQL1);
   rs1 = RsdRecordSet(cmd1);

   if (rs1.movenext)
      count = Rs1.Value(0); // ID-шник в БО. Был ID-шник из sfdefcom, теперь DDL_Comis_dbt.t_ID.
   else
      count = 0;
   end;

   if (rs.Value("T_ACTION") != 3) // кроме удаления
      OurDealID = ПолучитьСоответствие(80, rs.Value("T_DEALID")); // OurDealID = ID сделки в БО

      if (OurDealID == -1)
         ЗанестиЗаписьВПротокол(589, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно вставить комиссию для несуществующей сделки " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;
   end;

   SQL1 = "SELECT t_destid FROM DTXREPLOBJ_DBT WHERE t_objecttype = 10 AND t_objectid = " + rs.Value("T_CURRENCYID") + " AND t_objstate != 2";

   cmd1 = RsdCommand( SQL1);
   rs1 = RsdRecordSet(cmd1);

   if (rs1.Movenext)
      SfFIID = rs1.Value(0); // SfFIID = ФИ валюты комиссии в БО
   else
      ЗанестиЗаписьВПротокол(591, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно вставить комиссию для несуществующей валюты комиссии, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
      Return FALSE;
   end;

   var ReceiverCommission:Integer; // получатель комиссии
   GetRegistryValue("SECUR\\ФИКТИВНЫЙ ПОЛУЧАТЕЛЬ КОМИССИИ", v_Integer, ReceiverCommission, err);
   if(err == 0)
      if(ReceiverCommission > 0)
         SQL1 = "select t_partyid from dparty_dbt where t_partyid = " + string(ReceiverCommission);
         cmd1 = RsdCommand( SQL1);
         rs1 = RsdRecordSet(cmd1);

         if (not rs1.Movenext)
            err = 1;
         end;
      else
         SQL1 = 
         " SELECT " +
         " ( " +
         "  CASE WHEN RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 THEN " +
         "     tick.t_MarketID " +
         "  ELSE " +
         "     CASE WHEN RSB_SECUR.IsOutExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 THEN " +
         "         tick.t_PartyID " +
         "         ELSE " +
         "             CASE WHEN RSB_SECUR.IsBroker(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 THEN " +
         "                 tick.t_BrokerID " +
         "             ELSE " +
         "                 -1 " +
         "             END " +
         "     END  " +
         "  END " +
         " ) t_Receiver " +
         " FROM " +
         "   DDL_TICK_DBT tick " +
         " WHERE " +
         "   tick.t_DealID = " + string(OurDealID);

         cmd1 = RsdCommand( SQL1);
         rs1 = RsdRecordSet(cmd1);

         if ((not rs1.Movenext) or (rs1.Value(0) <= 0))
           err = 1;
         else
           ReceiverCommission = SQL_ConvTypeInteger(rs1.Value(0));
         end;
      end;
   end;

   if(err != 0)
      ЗанестиЗаписьВПротокол(591, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: не найден получатель комисии, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
      Return FALSE;
   end;
/*
   SQL1 = " SELECT DISTINCT " +
          "     t_Number " +
          " FROM " +
          "     dsfcomiss_dbt c " +
          " WHERE " +
          "     c.t_ServiceKind = " + string(PTSK_STOCKDL) + // Фондовый дилинг
          " AND c.t_feeType = 1 " +                          // Тип взимания
          " AND c.t_FIID_COMM = " + string(SfFIID) +         // Валюта комиссии
          " AND " + getsqlDate_SK(DateStamp(rs.value("T_DATE"))) + " BETWEEN c.t_DateBegin AND c.t_DateEnd " + // дата комиссии между DateBegin и DateEnd
          " AND c.t_ReceiverID = " + string(ReceiverCommission); // получатель комиссии

   cmd1 = RsdCommand( SQL1);
   rs1 = RsdRecordSet(cmd1);
   if (rs1.Movenext)
      commnumber = rs1.Value(0);
   else
      ЗанестиЗаписьВПротокол(591, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: не удалось получить номер комиссии, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
      Return FALSE;
   end;

Здесь не учтен тип комиссии! 
*/
      if (SfFIID == 0)
         commnumber = "100" + string(rs.value("T_TYPE"));
      elif (SfFIID == 1)
         commnumber = "101" + string(rs.value("T_TYPE"));
      elif (SfFIID == 3)
         commnumber = "103" + string(rs.value("T_TYPE"));
      elif (SfFIID == 22)
         commnumber = "122" + string(rs.value("T_TYPE"));
      end;

   if (rs.Value("T_ACTION") == 1) // вставка
      if (count > 0)
         ЗанестиЗаписьВПротокол(426, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно вставить существующую комиссию по сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      else
         SQL1 = "select count(*) from ddl_tick_dbt where t_dealid = " + OurDealID;
         cmd1 = RsdCommand(SQL1);
         rs1 = RsdRecordSet(cmd1);
         rs1.Movenext;

         if (rs1.Value(0) == 0)
            ЗанестиЗаписьВПротокол(589, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно вставить комиссию для несуществующей сделки " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
            Return FALSE;
         end;
      end;

      if (not ПолучитьДоговорОбслуживания(OurDealID, SfContrID, SfPartyID))
         ЗанестиЗаписьВПротокол(590, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно вставить комиссию для несуществующего договора обслуживания, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      var nds_rate:double = 0; 
      if ( not GetNDSRateByDate(nds_rate, BILNDSRATE_BASE, rs.value("T_DATE")) )    
          nds_rate = 0;
      end;

      if (rs.value("T_DATE") <= Date(31,12,2012))
         NDSSUM = rs.value("T_SUM") - round ((rs.value("T_SUM")/(nds_rate+100)*100),2,0,1);
      else
         if ((rs.value("T_TYPE")==3) or (rs.value("T_TYPE")==9) )
            NDSSUM = rs.value("T_SUM") - round ((rs.value("T_SUM")/(nds_rate+100)*100),2,0,1);
         else
            NDSSUM = 0;
         end; 
      end;
	  
	  SQL1 = "select ddlcomis_dbt_seq.nextval FROM dual;";
	  cmd1 = RsdCommand(SQL1);
      rs1 = RsdRecordSet(cmd1);
	  rs1.MoveNext;

      SQL1 = "insert into ddlcomis_dbt(T_ID, T_DOCKIND, T_DOCID, T_CONTRACT, T_FEETYPE, T_COMNUMBER, T_SUM, T_NDS, T_DATE, T_PLANPAYDATE, T_FACTPAYDATE, T_INPUTMEDIUM) values(";
      SQL1 = SQL1 + rs1.value(0) + ",";                                     /*T_ID*/
	  SQL1 = SQL1 + "101,";                                                 /*T_DOCKIND             NUMBER(10)*/
      SQL1 = SQL1 + OurDealID + ", ";                                       /*T_DOCID        VARCHAR2(35)*/
      SQL1 = SQL1 + SfContrID + ", ";                                       /*T_CONTRACT          NUMBER(10)*/
      SQL1 = SQL1 + "1, ";                                                  /*T_FEETYPE             NUMBER(5)*/
      SQL1 = SQL1 + commnumber + ", ";                                      /*T_COMNUMBER                NUMBER(10)*/
      SQL1 = SQL1 + rs.value("T_SUM") + ", ";                               /*T_SUM             NUMBER(32)*/
      SQL1 = SQL1 + NDSSUM + ", ";                                          /*T_NDS              NUMBER(32)*/
      SQL1 = SQL1 + getsqlDate_SK(DateStamp(rs.value("T_DATE"))) + ", ";    /*T_DATE  */
      SQL1 = SQL1 + getsqlDate_SK(DateStamp(rs.value("T_DATE"))) + ", ";    /*T_PLANPAYDATE  */
      SQL1 = SQL1 + getsqlDate_SK(DateStamp(rs.value("T_DATE"))) + ", ";    /*T_FACTPAYDATE  */
      SQL1 = SQL1 + "'P'";                                                   /*T_INPUTMEDIUM  */
      SQL1 = SQL1 + ")";
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      ComID = rs1.value(0);
      SQL1 = "delete from DTXREPLOBJ_DBT where T_OBJECTTYPE=100 and t_objectid = " + rs.Value("T_COMISSID");
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;


      SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
      SQL1 = SQL1 + "T_OBJSTATE) values (100, " + rs.Value("t_comissid") + ", 1, ";
      SQL1 = SQL1 + ComID + " ,1 , 0)";
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
      
      SQL1 = "update DTXCOMISS_DBT set t_replstate = 1 where t_comissid = " + rs.value("t_comissid") + " and t_action = 1 ";
      SQL1 = SQL1 + " and t_replstate = 0 and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   elif (rs.Value("T_ACTION") == 2) // обновление
      if (count == 0)
         ЗанестиЗаписьВПротокол(427, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно обновить несуществующую комиссию, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      if (ПроверитьНаРучноеИзменение(100, rs.value("T_COMISSID")))
         ЗанестиЗаписьВПротокол(208, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: объект находится в режиме ручного редактирования, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      if (rs.value("T_DATE") <= Date(31,12,2012))
        NDSSUM = rs.value("T_SUM") - round ((rs.value("T_SUM")/118*100),2,0,1);
      else
        if ((rs.value("T_TYPE")==3) or (rs.value("T_TYPE")==9) )
          NDSSUM = rs.value("T_SUM") - round ((rs.value("T_SUM")/118*100),2,0,1);
        else 
          NDSSUM = 0;
        end; 
      end;

      if (not ПолучитьДоговорОбслуживания(rs.Value("T_DEALID"), SfContrID, SfPartyID))
         ЗанестиЗаписьВПротокол(592, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно обновить комиссию для несуществующего договора обслуживания, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;


      SQL1 = "select t_id from ddlcomis_dbt where t_dockind = 101 and T_COMNUMBER = " + commnumber + " and t_docID = " + OurDealid;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;
      rs1 = RsdRecordSet(cmd1);

      if (not rs1.Movenext)
		  
              SQL1 = "select ddlcomis_dbt_seq.nextval FROM dual;";
  	      cmd1 = RsdCommand(SQL1);
	      rs1 = RsdRecordSet(cmd1);
	      rs1.MoveNext;
	      ComID = rs1.value(0);

	      SQL1 = "insert into ddlcomis_dbt(T_ID, T_DOCKIND, T_DOCID, T_CONTRACT, T_FEETYPE, T_COMNUMBER, T_SUM, T_NDS, T_DATE, T_PLANPAYDATE, T_FACTPAYDATE, T_INPUTMEDIUM) values(";
	      SQL1 = SQL1 + ComID + ",";                                     	    /*T_ID*/
	      SQL1 = SQL1 + "101,";                                                 /*T_DOCKIND             NUMBER(10)*/
	      SQL1 = SQL1 + OurDealID + ", ";                                       /*T_DOCID        VARCHAR2(35)*/
	      SQL1 = SQL1 + SfContrID + ", ";                                       /*T_CONTRACT          NUMBER(10)*/
	      SQL1 = SQL1 + "1, ";                                                  /*T_FEETYPE             NUMBER(5)*/
	      SQL1 = SQL1 + commnumber + ", ";                                      /*T_COMNUMBER                NUMBER(10)*/
	      SQL1 = SQL1 + rs.value("T_SUM") + ", ";                               /*T_SUM             NUMBER(32)*/
	      SQL1 = SQL1 + NDSSUM + ", ";                                          /*T_NDS              NUMBER(32)*/
	      SQL1 = SQL1 + getsqlDate_SK(DateStamp(rs.value("T_DATE"))) + ", ";    /*T_DATE  */
	      SQL1 = SQL1 + getsqlDate_SK(DateStamp(rs.value("T_DATE"))) + ", ";    /*T_PLANPAYDATE  */
	      SQL1 = SQL1 + getsqlDate_SK(DateStamp(rs.value("T_DATE"))) + ", ";    /*T_FACTPAYDATE  */
	      SQL1 = SQL1 + "'P'";                                                   /*T_INPUTMEDIUM  */
	      SQL1 = SQL1 + ")";
	      cmd1 = RsdCommand(SQL1);
	      cmd1.execute;
	
	      SQL1 = "delete from DTXREPLOBJ_DBT where T_OBJECTTYPE=100 and t_objectid = " + rs.Value("T_COMISSID");
	      cmd1 = RsdCommand( SQL1);
	      cmd1.execute;
	
	      SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
	      SQL1 = SQL1 + "T_OBJSTATE) values (100, " + rs.Value("t_comissid") + ", 1, ";
	      SQL1 = SQL1 + ComID + " ,1 , 0)";
	      cmd1 = RsdCommand( SQL1);
	      cmd1.execute;
	      
	      SQL1 = "update DTXCOMISS_DBT set t_replstate = 1 where t_comissid = " + rs.value("t_comissid") + " and t_action = 1 ";
	      SQL1 = SQL1 + " and t_replstate = 0 and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
	      cmd1 = RsdCommand( SQL1);
	      cmd1.execute;
	
	      return true;
      end;


      SQL1 = "update ddlcomis_dbt set T_COMNUMBER = " + commnumber;
      SQL1 = SQL1 + ", T_SUM = " + rs.value("T_SUM");
      SQL1 = SQL1 + ", T_NDS = " + NDSSUM;
      SQL1 = SQL1 + ", T_DATE        = " + getsqlDate_SK(DateStamp(rs.value("T_DATE")));
      SQL1 = SQL1 + ", T_PLANPAYDATE = " + getsqlDate_SK(DateStamp(rs.value("T_DATE")));
      SQL1 = SQL1 + ", T_FACTPAYDATE = " + getsqlDate_SK(DateStamp(rs.value("T_DATE")));       
      SQL1 = SQL1 + " where T_ID = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "update DTXCOMISS_DBT set t_replstate = 1 where t_comissid = " + rs.value("t_comissid") + " and t_action = 2 and t_replstate = 0";
      SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   elif (rs.Value("T_ACTION") == 3) // удаление
      if (count == 0)
         ЗанестиЗаписьВПротокол(428, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно удалить несуществующую комиссию, сделка " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      SQL2 = "select * from DTXCOMISS_DBT where t_replstate = 1 and t_action in (1,2) and t_comissid = " + rs.value("T_COMISSID") + " order by t_instancedate desc";
      cmd2 = RsdCommand( SQL2);
      rs2  = RsdRecordSet(cmd2);
      if (not rs2.Movenext)
         ЗанестиЗаписьВПротокол(428, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: в буферной схеме не найдена информация по комиссии", rs.Value("T_INSTANCEDATE"));
         return false;
      end;

      OurDealID = ПолучитьСоответствие(80, rs2.Value("T_DEALID"));

      if (OurDealID == -1)
         ЗанестиЗаписьВПротокол(589, 100, rs2.value("T_COMISSID"), 1, StrFor(1), "Ошибка: невозможно удалить комиссию для несуществующей сделки " + String(rs2.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      SQL1 = "delete from ddlcomis_dbt where t_id = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      if ( rs.Value("T_INSTANCEDATE") >= rs.Value("T_DATE"))
          ЗанестиЗаписьВПротокол(428, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Предупреждение: удалена историческая комиссия", rs.Value("T_INSTANCEDATE"));
      end;

      SQL1 = "update DTXCOMISS_DBT set t_replstate = 1 where t_comissid = " + rs.value("t_comissid") + " and t_action = 3 and t_replstate = 0";
      SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;

      SQL1 = "delete from DTXREPLOBJ_DBT ots where ots.T_OBJECTTYPE = 100 and ots.T_OBJSTATE = 2 and ots.T_OBJECTID = " + rs.value("t_comissid");
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;

      SQL1 = "update DTXREPLOBJ_DBT ots set ots.T_OBJSTATE = 2 where ots.T_OBJECTTYPE = 100 and ots.T_OBJECTID = " + rs.value("t_comissid");
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   end;

   RETURN TRUE;
OnError(er)
   if (Trim(er.message) != "Error:")
      ЗанестиЗаписьВПротокол(600, 100, rs.value("T_COMISSID"), 1, StrFor(1), "Ошибка: " + er.message, rs.Value("T_INSTANCEDATE"));
   end;
   AbortTrn;
end;

macro ОбработатьКомиссию(Action, t_instancedate, Init_Action:String)
   SQL = "select count(*) from DTXCOMISS_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate;
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
      MaxVal = rs.Value(0);
   end;

   var ProgressIndicator = CreateProgressIndicator(true);
   ProgressIndicator.Start(Int(MaxVal), "Обработка комиссий...");

   Счетчик = 0;

   SQL = "select * from DTXCOMISS_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate + " order by t_dealid";
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);
  
   while (rs.Movenext)
      Счетчик = Счетчик + 1;

      ProgressIndicator.Update(Int(Счетчик), MaxVal);
   
      if (RslDefCon.IsInTrans) RslDefCon.RollbackTrans(); end;
      RslDefCon.BeginTrans();

      if (ProcessComiss(rs))
         RslDefCon.CommitTrans();
      else
         RslDefCon.RollbackTrans();
      end;
   end;

   ProgressIndicator.Stop();

   return TRUE;
OnError(er)
   ЗанестиЗаписьВПротокол(600, 100, "", "", StrFor(1), "Ошибка: " + er.message, date(t_instancedate));
end;