/*
$Name:             txproc_link.mac
$Module:           БОЦБ 
$Description:      Обработка связей
*/
import txproc_txlnk_fun, txrepl_func;

private var SQL, cmd, rs, Счетчик, MaxVal;

macro Process_Link()
   var LinkData = TTXLinkData();
   var SQL1, cmd1, rs1;

   LinkData.T_TYPE              = rs.Value("T_TYPE");
   LinkData.T_BUYID             = ПолучитьСоответствие(80, rs.Value("T_BUYID"));
   LinkData.T_SALEID            = ПолучитьСоответствие(80, rs.Value("T_SALEID"));

   if ((rs.Value("T_SOURCEID") != NullVal) and (rs.Value("T_SOURCEID") > 0))
      LinkData.T_SOURCEID               = ПолучитьСоответствие(80, rs.Value("T_SOURCEID"));
   end;

   if ((rs.Value("T_DESTID") != NullVal) and (rs.Value("T_DESTID") > 0))
      LinkData.T_DESTID         = ПолучитьСоответствие(80, rs.Value("T_DESTID"));
   end;

   if ((rs.Value("T_LOT1ID") != NullVal) and (rs.Value("T_LOT1ID") > 0))
      LinkData.T_LOT1ID         = ПолучитьСоответствие(80, rs.Value("T_LOT1ID"));
   end;

   if ((rs.Value("T_LOT2ID") != NullVal) and (rs.Value("T_LOT2ID") > 0))
      LinkData.T_LOT2ID         = ПолучитьСоответствие(80, rs.Value("T_LOT2ID"));
   end;

   LinkData.T_DATE              = rs.Value("T_DATE");
   LinkData.T_AMOUNT            = rs.Value("T_AMOUNT");

   LinkData.InTRN               = TRUE;
   LinkData.Action              = 1;

   if( ОбработатьСвязь( LinkData, 1 ) == false )
      LinkData.PrintErrors();
      Return FALSE;
   else
      LinkData.PrintErrors(); 

      if (1 == 1)
         SQL1 = "update DTXLINK_DBT set t_replstate = 1 where t_replstate = 0 and T_TYPE = " + rs.Value("T_TYPE") + " and T_BUYID = ";
         SQL1 = SQL1 + rs.Value("T_BUYID") + " and T_SALEID = " + rs.Value("T_SALEID") + " and T_SOURCEID = " + rs.Value("T_SOURCEID");
         SQL1 = SQL1 + " and T_DESTID = " + rs.Value("T_DESTID") + " and T_LOT1ID = " + rs.Value("T_LOT1ID") + " and T_LOT2ID = ";
         SQL1 = SQL1 + rs.Value("T_LOT2ID");
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;
      end;

      Return TRUE;
   end;
OnError(er)
   LinkData.PrintErrors();
   AbortTrn;
end;

macro Обработать_Связь()
/*
   SQL = "select count(*) from dtxlink_DBT where t_replstate = 0";
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
      MaxVal = rs.Value(0);
   end;

   var ProgressIndicator = CreateProgressIndicator(true);
   ProgressIndicator.Start(Int(MaxVal), "Обработка связей...");

   Счетчик = 0;

   SQL = "select * from dtxlink_DBT where t_replstate = 0 order by trunc(T_INSTANCEDATE)";
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);
  
   while (rs.Movenext)
      Счетчик = Счетчик + 1;

      ProgressIndicator.Update(Int(Счетчик), MaxVal);
   
      if (not ProcessTrn(Null, "Process_Link"))
      end;
   end;

   ProgressIndicator.Stop();
*/
   return TRUE;
OnError(er)
   AbortTrn;
end;