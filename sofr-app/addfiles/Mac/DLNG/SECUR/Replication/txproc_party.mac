/*
$Name:             txproc_party.mac
$Module:           БОЦБ 
$Description:      Макрос репликации субъектов
*/
import txrepl_func;

private var NameParty;
private var MaxVal;

macro ProcessParty(rs, code)
   var SQL1, cmd1, rs1, count, maxpartyid, innertime, SQL_pown, cmd_pown, rs_pown, SfContrID, HaveINN, T_NRCOUNTRY, T_INTERFERENCE, T_ISBANKDEP, count_inn, count_bic;
   var HaveBIC, HaveUrAdr, HavePostAdr, T_NOTRESIDENT;
   var CatID, CatName, StrUNIID, SetCatID;
   var CatErr:integer    =  0;
   PRIVATE FILE party ("party.dbt"); /*описание персоны*/

   NameParty = StrSubst(trim(rs.Value("T_FULLNAME")), "'", "''");

   SQL1 = "SELECT T_DESTID FROM DTXREPLOBJ_DBT where T_OBJECTTYPE = 30 and T_OBJECTID = " + rs.value("t_partyid") + " AND T_OBJSTATE != 2";
   cmd1 = RsdCommand( SQL1);
   rs1 = RsdRecordSet(cmd1);

   if (rs1.movenext)
      count = Rs1.Value(0);
   else
      count = 0;
   end;

   if ((rs.Value("T_ACTION") == 1) or (rs.Value("T_ACTION") == 2))
      SQL1 = "select count(*) from dobjcode_dbt oc where oc.T_OBJECTTYPE = 3 and oc.T_CODEKIND = 16 and oc.T_CODE = '" + trim(rs.Value("t_inn")) + "'";
      cmd1 = RsdCommand(SQL1);
      rs1 = RsdRecordSet(cmd1);

      if (rs1.movenext)
         count_inn = Rs1.Value(0);
      else
         count_inn = 0;
      end;

      SQL1 = "select count(*) from dobjcode_dbt oc where oc.T_OBJECTTYPE = 3 and oc.T_CODEKIND = 3 and oc.T_CODE='" + trim(rs.Value("t_bic")) + "'";
      cmd1 = RsdCommand(SQL1);
      rs1 = RsdRecordSet(cmd1);

      if (rs1.movenext)
         count_bic = Rs1.Value(0);
      else
         count_bic = 0;
      end;
  
      if (rs.Value("T_NRCOUNTRY") == NullVal)
         T_NRCOUNTRY = StrFor(1);
      else
         T_NRCOUNTRY = trim(rs.Value("T_NRCOUNTRY"));
      end;

      if (rs.Value("T_NOTRESIDENT") == NullVal)
         T_NOTRESIDENT = "chr(0)";
      elif (trim(rs.Value("T_NOTRESIDENT")) == StrFor(88))
         T_NOTRESIDENT = "chr(88)";
      else
         T_NOTRESIDENT = "chr(0)";
      end;
   end;

   if (rs.Value("T_ACTION") == 1)
      if (count > 0)
         ЗанестиЗаписьВПротокол(400, 30, rs.value("t_partyid"), 1, StrFor(1), "Ошибка: невозможно вставить существующего субъекта " + NameParty, rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      SQL1 = "select to_char(dparty_dbt_SEQ.nextval) from dual";
      cmd1 = RsdCommand(SQL1);
      rs1 = RsdRecordSet(cmd1);
      rs1.movenext;
      maxpartyid = rs1.Value(0);

      SQL1 = "INSERT INTO dparty_dbt (T_PARTYID,T_IOWNERKIND,T_LEGALFORM,T_SHORTNAME,T_NAME,T_ADDNAME,T_OKPO,T_NOTRESIDENT,T_SUPERIOR,T_CHANGE_DATE,T_CHANGE_DATEPREV,T_LOCKED,T_TAXINSTITUTION,T_TAXREGDATE,T_SYSTYPE,";
      SQL1 = SQL1 + "T_USERTYPE,T_USERFIELD1,T_USERFIELD2,T_USERFIELD3,T_USERFIELD4,T_NRCOUNTRY,T_CONSOLIDATERECORD,T_SETACCSEARCHALG,T_BRANCH,T_NUMSESSION,T_OFSHOREZONE,T_MAINPARTYID,T_ISPROBDOUBLER,T_ISDOUBLER,";
      SQL1 = SQL1 + "T_HASDOUBLER,T_PARAMSETID,T_HASHVALUE,T_LATNAME,T_RESERVE,T_CBDK_ISSYNCH,T_CBDK_DATEUPDATE,T_CBDK_TIMEUPDATE, T_LASTCHECKTERRDATE, T_NOTIDENTIFY, T_CLOSEDASDOUBLERID, T_CBDK_SYNCHINFO)";
      SQL1 = SQL1 + " VALUES (" + maxpartyid + ", ";                            /*T_PARTYID                     NUMBER (10)*/
      SQL1 = SQL1 + "0, ";                                                      /*T_IOWNERKIND                  NUMBER (5)*/
      SQL1 = SQL1 + rs.Value("T_LEGALFORM")+", '";                              /*T_LEGALFORM                   NUMBER (5)*/
      SQL1 = SQL1 + StrSubst(trim(rs.Value("T_SHORTNAME")), "'", "''") + "', '";/*T_SHORTNAME                   VARCHAR2 (20)*/
      SQL1 = SQL1 + StrSubst(trim(rs.Value("T_FULLNAME")), "'", "''") + "', ";  /*T_NAME                        VARCHAR2 (320)*/
      SQL1 = SQL1 + "chr(1), '";                                                /*T_ADDNAME                     VARCHAR2 (320)*/
      SQL1 = SQL1 + trim(rs.Value("T_OKPO")) + "', ";                           /*T_OKPO                        VARCHAR2 (15)*/
      SQL1 = SQL1 + T_NOTRESIDENT + ", ";                                       /*T_NOTRESIDENT                 CHAR (1)*/
      SQL1 = SQL1 + "-1, ";                                                     /*T_SUPERIOR                    NUMBER (10)*/
      SQL1 = SQL1 + nulldate + ", ";                                            /*T_CHANGE_DATE                 DATE*/
      SQL1 = SQL1 + nulldate + ", ";                                            /*T_CHANGE_DATEPREV             DATE*/
      SQL1 = SQL1 + "chr(0), ";                                                 /*T_LOCKED                      CHAR (1)*/
      SQL1 = SQL1 + "-1, ";                                                     /*T_TAXINSTITUTION              NUMBER (10)*/
      SQL1 = SQL1 + nulldate + ", ";                                            /*T_TAXREGDATE                  DATE*/
      SQL1 = SQL1 + "chr(1), ";                                                 /*T_SYSTYPE                     VARCHAR2 (16)*/
      SQL1 = SQL1 + "chr(1), ";                                                 /*T_USERTYPE                    VARCHAR2 (16)*/
      SQL1 = SQL1 + "chr(1), ";                                                 /*T_USERFIELD1                  VARCHAR2 (120)*/
      SQL1 = SQL1 + "chr(1), ";                                                 /*T_USERFIELD2                  VARCHAR2 (120)*/
      SQL1 = SQL1 + "chr(1), ";                                                 /*T_USERFIELD3                  VARCHAR2 (120)*/
      SQL1 = SQL1 + "chr(1), '";                                                /*T_USERFIELD4                  VARCHAR2 (120)*/
      SQL1 = SQL1 + T_NRCOUNTRY + "', ";                                        /*T_NRCOUNTRY                   VARCHAR2 (3)*/
      SQL1 = SQL1 + "chr(0), ";                                                 /*T_CONSOLIDATERECORD           CHAR (1)*/
      SQL1 = SQL1 + "1, ";                                                      /*T_SETACCSEARCHALG             NUMBER (5)*/
      SQL1 = SQL1 + "0, ";                                                      /*T_BRANCH                      NUMBER (5)*/
      SQL1 = SQL1 + "0, ";                                                      /*T_NUMSESSION                  NUMBER (10)*/
      SQL1 = SQL1 + "0, ";                                                      /*T_OFSHOREZONE                 NUMBER (10)*/
      SQL1 = SQL1 + "0, ";                                                      /*T_MAINPARTYID                 NUMBER (10)*/
      SQL1 = SQL1 + "chr(0), ";                                                 /*T_ISPROBDOUBLER               CHAR (1)*/
      SQL1 = SQL1 + "chr(0), ";                                                 /*T_ISDOUBLER                   CHAR (1)*/
      SQL1 = SQL1 + "chr(0), ";                                                 /*T_HASDOUBLER                  CHAR (1)*/
      SQL1 = SQL1 + "0, ";                                                     /*T_PARAMSETID                  NUMBER (10)*/
      SQL1 = SQL1 + "'00000000000000000000000000000000', ";                      /*T_HASHVALUE                   RAW (16)*/
      SQL1 = SQL1 + "chr(1), ";                                                 /*T_LATNAME                     VARCHAR2 (320)*/
      SQL1 = SQL1 + "chr(1), ";                                                  /*T_RESERVE                     VARCHAR2 (468)*/
      SQL1 = SQL1 + "chr(1), ";                                                  /*T_CBDK_ISSYNCH                CHAR (1)*/
      SQL1 = SQL1 + nulldate + ", ";                                             /*T_CBDK_DATEUPDATE             DATE*/
      SQL1 = SQL1 + nulldate + ", ";                                             /*T_CBDK_TIMEUPDATE             DATE*/
      SQL1 = SQL1 + nulldate + ", ";                                            /*T_LASTCHECKTERRDATE           DATE*/
      SQL1 = SQL1 + "chr(88), ";						                                /* T_NOTIDENTIFY   		       CHAR(1) */
      SQL1 = SQL1 + "0, ";                                                      /*T_CLOSEDASDOUBLERID           NUMBER (10)*/
      SQL1 = SQL1 + "chr(1) ";                                                  /*T_CBDK_SYNCHINFO              VARCHAR2 (32)*/
      SQL1 = SQL1 +  ")";
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      /* Поставим клиента на обслуживание - для нормальной работы */
      SQL1 = "";
      SQL1 = SQL1 + "INSERT INTO dclient_dbt (T_PARTYID,T_SERVICEKIND,T_OPER,T_STARTDATE,T_FINISHDATE,T_DEPARTMENT, T_BRANCH) VALUES(";
      SQL1 = SQL1 + string(maxpartyid) + ", ";                  /* T_PARTYID */
      SQL1 = SQL1 +  " 1, ";                            /* T_SERVICEKIND */
      SQL1 = SQL1 +  {Oper} + ", ";                     /* T_OPER */
      SQL1 = SQL1 +  "to_date('" + {CurDate} + "','dd.mm.yyyy'), to_date('01.01.0001','dd.mm.yyyy'), " + {OperDprt} + " , 0)";
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      // добавить принадлежность Клиент
      SQL1 = "insert into dpartyown_dbt values (";
      SQL1 = SQL1 + string(maxpartyid)+", ";            /*T_PARTYID     NUMBER (10)*/
      SQL1 = SQL1 + "1, "; /*PTK_CLIENT*/               /*T_PARTYKIND   NUMBER (5)*/
      SQL1 = SQL1 + "0, ";                              /*T_SUPERIOR    NUMBER (10)*/
      SQL1 = SQL1 + "0, ";                              /*T_SUBKIND     NUMBER (10)*/
      SQL1 = SQL1 + "0, ";                              /*T_BRANCH      NUMBER (5)*/
      SQL1 = SQL1 + "0 ";                               /*T_NUMSESSION  NUMBER (10)*/
      SQL1 = SQL1 + ")";
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      var Depart = 0;
      if( CB_GetParentFilial( {OperDprtNode}, Depart ) == 0 )
         SQL1 = "insert into DPTSVDP_DBT values (";
         SQL1 = SQL1 + string(maxpartyid)+", ";            /*T_PARTYID     NUMBER (10)*/
         SQL1 = SQL1 + "1, "; /*PTK_CLIENT*/               /*T_PARTYKIND   NUMBER (5)*/
         SQL1 = SQL1 + Depart;                             /*T_DEPARTMENT  NUMBER (5)*/
         SQL1 = SQL1 + ")";
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      SQL1 = "INSERT INTO dobjcode_dbt (T_OBJECTTYPE,T_CODEKIND,T_OBJECTID,T_CODE,T_STATE,T_BANKDATE,T_SYSDATE,T_SYSTIME,T_USERID,T_BRANCH,T_BANKCLOSEDATE,T_NUMSESSION )";
      SQL1 = SQL1 + " VALUES (3, ";                                                     /*T_OBJECTTYPE  NUMBER (5)*/
      SQL1 = SQL1 + "1, ";                                                              /*T_CODEKIND    NUMBER (5)*/
      SQL1 = SQL1 + maxpartyid + ", '";                                           /*T_OBJECTID    NUMBER (10)*/
      SQL1 = SQL1 + code + "', ";                                                       /*T_CODE        VARCHAR2 (35)*/
      SQL1 = SQL1 + "0, ";                                                              /*T_STATE       NUMBER (5)*/
      SQL1 = SQL1 + getsqlDate_SK({CurDate}) + ", ";                                    /*T_BANKDATE    DATE*/
      SQL1 = SQL1 + getsqlDate_SK(DateStamp(ПолучитьTimeStamp()/*DtTm(Date, time)*/, innertime)) + ", ";          /*T_SYSDATE     DATE*/
      SQL1 = SQL1 + GetSQLTime(innertime) + ", ";                                       /*T_SYSTIME     DATE*/
      SQL1 = SQL1 + {Oper} + ", ";                                                      /*T_USERID      NUMBER (5)*/
      SQL1 = SQL1 + "0, ";                                                              /*T_BRANCH      NUMBER (5)*/
      SQL1 = SQL1 + "to_date('01.01.0001','dd.mm.yyyy'), ";                             /*T_BANKCLOSEDATE  DATE*/
      SQL1 = SQL1 + "0";                                                               /*T_NUMSESSION  NUMBER (10)*/
      SQL1 = SQL1 + ")";
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "INSERT INTO dobjcode_dbt (T_OBJECTTYPE,T_CODEKIND,T_OBJECTID,T_CODE,T_STATE,T_BANKDATE,T_SYSDATE,T_SYSTIME,T_USERID,T_BRANCH,T_BANKCLOSEDATE,T_NUMSESSION )";
      SQL1 = SQL1 + " VALUES (3, ";                                                     /*T_OBJECTTYPE  NUMBER (5)*/
      SQL1 = SQL1 + "38, ";                                                              /*T_CODEKIND    NUMBER (5)*/
      SQL1 = SQL1 + maxpartyid + ",'";                                           	/*T_OBJECTID    NUMBER (10)*/
      SQL1 = SQL1 + rs.value("t_partyid") + "', ";                                                       /*T_CODE        VARCHAR2 (35)*/
      SQL1 = SQL1 + "0, ";                                                              /*T_STATE       NUMBER (5)*/
      SQL1 = SQL1 + getsqlDate_SK({CurDate}) + ", ";                                    /*T_BANKDATE    DATE*/
      SQL1 = SQL1 + getsqlDate_SK(DateStamp(ПолучитьTimeStamp()/*DtTm(Date, time)*/, innertime)) + ", ";          /*T_SYSDATE     DATE*/
      SQL1 = SQL1 + GetSQLTime(innertime) + ", ";                                       /*T_SYSTIME     DATE*/
      SQL1 = SQL1 + {Oper} + ", ";                                                      /*T_USERID      NUMBER (5)*/
      SQL1 = SQL1 + "0, ";                                                              /*T_BRANCH      NUMBER (5)*/
      SQL1 = SQL1 + "to_date('01.01.0001','dd.mm.yyyy'), ";                             /*T_BANKCLOSEDATE  DATE*/
      SQL1 = SQL1 + "0";                                                               /*T_NUMSESSION  NUMBER (10)*/
      SQL1 = SQL1 + ")";
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      if (count_inn > 0)
         ЗанестиЗаписьВПротокол(600, 30, rs.value("t_partyid"), 1, StrFor(1), "Предупреждение: вставляемый ИНН уже существует в базе, субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
      elif ((count_inn == 0) and (rs.Value("t_inn") != NullVal) and (trim(rs.Value("t_inn")) != ""))
         SQL1 = "INSERT INTO dobjcode_dbt(T_OBJECTTYPE,T_CODEKIND,T_OBJECTID,T_CODE,T_STATE,T_BANKDATE,T_SYSDATE,T_SYSTIME,T_USERID,T_BRANCH,T_BANKCLOSEDATE,T_NUMSESSION)      ";
         SQL1 = SQL1 + " VALUES (3, ";                                                       /*T_OBJECTTYPE  NUMBER (5)*/
         SQL1 = SQL1 + "16, ";                                                               /*T_CODEKIND    NUMBER (5)*/
         SQL1 = SQL1 + maxpartyid+", '";                                                 /*T_OBJECTID    NUMBER (10)*/
         SQL1 = SQL1 + trim(rs.Value("t_inn"))+"', ";                                        /*T_CODE        VARCHAR2 (35)*/
         SQL1 = SQL1 + "0, ";                                                                /*T_STATE       NUMBER (5)*/
         SQL1 = SQL1 + getsqlDate_SK({CurDate})+", ";                                        /*T_BANKDATE    DATE*/
         SQL1 = SQL1 + getsqlDate_SK(DateStamp(ПолучитьTimeStamp(), innertime))+", ";        /*T_SYSDATE     DATE*/
         SQL1 = SQL1 + GetSQLTime(innertime)+", ";                                           /*T_SYSTIME     DATE*/
         SQL1 = SQL1 + {Oper}+", ";                                                          /*T_USERID      NUMBER (5)*/
         SQL1 = SQL1 + "0, ";                                                                /*T_BRANCH      NUMBER (5)*/
         SQL1 = SQL1 + "to_date('01.01.0001','dd.mm.yyyy'), ";                               /*T_BANKCLOSEDATE  DATE*/
         SQL1 = SQL1 + "0";                                                                  /*T_NUMSESSION  NUMBER (10)*/
         SQL1 = SQL1 + ")";
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      if (count_bic > 0)
         ЗанестиЗаписьВПротокол(601, 30, rs.value("t_partyid"), 1, StrFor(1), "Предупреждение: вставляемый БИК уже существует в базе, субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
      elif ((count_bic == 0) and (rs.Value("t_bic") != NullVal) and (trim(rs.Value("t_bic")) != ""))
         SQL1 = "INSERT INTO dobjcode_dbt(T_OBJECTTYPE,T_CODEKIND,T_OBJECTID,T_CODE,T_STATE,T_BANKDATE,T_SYSDATE,T_SYSTIME,T_USERID,T_BRANCH,T_BANKCLOSEDATE,T_NUMSESSION)      ";
         SQL1 = SQL1 + " VALUES (3, ";                                            /*T_OBJECTTYPE  NUMBER (5)*/
         SQL1 = SQL1 + "3, ";                                                     /*T_CODEKIND    NUMBER (5)*/
         SQL1 = SQL1 + maxpartyid+", '";                                              /*T_OBJECTID    NUMBER (10)*/
         SQL1 = SQL1 + trim(rs.Value("t_bic")) + "', ";                           /*T_CODE        VARCHAR2 (35)*/
         SQL1 = SQL1 + "0, ";                                                     /*T_STATE       NUMBER (5)*/
         SQL1 = SQL1 + getsqlDate_SK({CurDate})+", ";                             /*T_BANKDATE    DATE*/
         SQL1 = SQL1 + getsqlDate_SK(DateStamp(ПолучитьTimeStamp(), innertime))+", ";/*T_SYSDATE  DATE*/
         SQL1 = SQL1 + GetSQLTime(innertime)+", ";                                        /*T_SYSTIME     DATE*/
         SQL1 = SQL1 + {Oper}+", ";                                                       /*T_USERID      NUMBER (5)*/
         SQL1 = SQL1 + "0, ";                                                     /*T_BRANCH      NUMBER (5)*/
         SQL1 = SQL1 + "to_date('01.01.0001','dd.mm.yyyy'), ";                               /*T_BANKCLOSEDATE  DATE*/
         SQL1 = SQL1 + "0";                                                               /*T_NUMSESSION  NUMBER (10)*/
         SQL1 = SQL1 + ")";
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      if (rs.Value("T_LEGALFORM") == 2)
         SQL1 = "insert into dpersn_dbt (T_PERSONID,T_NAME1,T_NAME2,T_NAME3,T_BORN,T_BIRSPLASE,T_ISMALE,T_ETHNOS,T_ISEMPLOYER,T_LICENCENUMBER,T_LICENCEDATE,T_REGIONBORN,";
         SQL1 = SQL1 + "T_RAIONBORN,T_PLACEBORN,T_PLACEWORK,T_DEATH,T_KATEGOR,T_GROUPAUTHOR,T_GROUPWIL,T_PENSCARDNUMBER,T_PENSCARDDATE,T_ISLITERATE,T_SPECIALACCESS,T_VZAIMOSVYAZANNIY,T_OFFSHORERESIDENT,T_BRANCH,T_NUMSESSION,T_RESERVE) values (";
         SQL1 = SQL1 + maxpartyid + ", '";                                    /*T_PERSONID            NUMBER (10)*/
         SQL1 = SQL1 + StrSubst(trim(rs.Value("T_NAME1")), "'", "''") + "', '"; /*T_NAME1               VARCHAR2 (24)*/
         SQL1 = SQL1 + StrSubst(trim(rs.Value("T_NAME2")), "'", "''") + "', '"; /*T_NAME2               VARCHAR2 (24)*/
         SQL1 = SQL1 + StrSubst(trim(rs.Value("T_NAME3")), "'", "''") + "', ";  /*T_NAME3               VARCHAR2 (24)*/
         SQL1 = SQL1 + nulldate+", ";                                           /*T_BORN                DATE*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_BIRSPLASE           VARCHAR2 (80)*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_ISMALE              CHAR (1)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_ETHNOS              VARCHAR2 (24)*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_ISEMPLOYER          CHAR (1)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_LICENCENUMBER       VARCHAR2 (20)*/
         SQL1 = SQL1 + nulldate+", ";                                           /*T_LICENCEDATE         DATE*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_REGIONBORN          VARCHAR2 (11)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_RAIONBORN           VARCHAR2 (24)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_PLACEBORN           VARCHAR2 (24)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_PLACEWORK           VARCHAR2 (52)*/
         SQL1 = SQL1 + nulldate+", ";                                           /*T_DEATH               DATE*/
         SQL1 = SQL1 + "0, ";                                                   /*T_KATEGOR             NUMBER (5)*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_GROUPAUTHOR         CHAR (1)*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_GROUPWIL            CHAR (1)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_PENSCARDNUMBER      VARCHAR2 (15)*/
         SQL1 = SQL1 + nulldate+", ";                                           /*T_PENSCARDDATE        DATE*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_ISLITERATE          CHAR (1)*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_SPECIALACCESS       CHAR (1)*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_VZAIMOSVYAZANNIY    CHAR (1)*/
         SQL1 = SQL1 + "chr(0), ";                                              /*T_OFFSHORERESIDENT    CHAR (1)*/
         SQL1 = SQL1 + "0, ";                                                   /*T_BRANCH              NUMBER (5)*/
         SQL1 = SQL1 + "0, ";                                                   /*T_NUMSESSION          NUMBER (10)*/
         SQL1 = SQL1 + "chr(1) ";                                               /*T_RESERVE             VARCHAR2 (93)*/
         SQL1 = SQL1 + ")";
         cmd1=RsdCommand(SQL1);
         cmd1.execute;
      end;

      if ((trim(rs.Value("t_address_ur")) != NullVal) and 
          (StrLen(trim(rs.Value("t_address_ur"))) > 1))
         SQL1 = "insert into dadress_dbt (T_PARTYID,T_TYPE,T_ADRESS,T_COUNTRY,T_POSTINDEX,T_REGION,T_CODEPROVINCE,T_PROVINCE,T_CODEDISTRICT,T_DISTRICT,T_CODEPLACE,T_PLACE,T_CODESTREET,T_STREET,T_HOUSE,T_NUMCORPS,";
         SQL1 = SQL1 + "T_FLAT,T_TERRITORY,T_BRANCH,T_NUMSESSION,T_KLADR,T_CODEREGION,T_OKATO,T_REGIONNUM) values (";
         SQL1 = SQL1 + maxpartyid + ", ";                                  /*T_PARTYID             NUMBER (10)*/
         SQL1 = SQL1 + "1, '";                                               /*T_TYPE                NUMBER (5)*/
         SQL1 = SQL1 + StrSubst(trim(rs.Value("t_address_ur")), "'", "''")+"', ";    /*T_ADRESS              VARCHAR2 (511)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_COUNTRY             VARCHAR2 (3)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_POSTINDEX           VARCHAR2 (15)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_REGION              VARCHAR2 (5)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEPROVINCE        NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_PROVINCE            VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEDISTRICT        NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_DISTRICT            VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEPLACE           NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_PLACE               VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_CODESTREET          NUMBER (10)*/ 
         SQL1 = SQL1 + "chr(1), ";                                           /*T_STREET              VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_HOUSE               VARCHAR2 (10)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_NUMCORPS            VARCHAR2 (5)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_FLAT                VARCHAR2 (5)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_TERRITORY           VARCHAR2 (2)*/
         SQL1 = SQL1 + "0, ";                                                /*T_BRANCH              NUMBER (5)*/
         SQL1 = SQL1 + "0, ";                                                /*T_NUMSESSION          NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                           /*T_KLADR               VARCHAR2 (23)*/
         SQL1 = SQL1 + "chr(1), ";                                            /*T_CODEREGION          VARCHAR2 (20)*/
         SQL1 = SQL1 + "chr(1),chr(1))";
         cmd1=RsdCommand(SQL1);
         cmd1.execute;
      end;

      if ((trim(rs.Value("t_address_post")) != NullVal) and 
          (StrLen(trim(rs.Value("t_address_post"))) > 1))
         SQL1 = "insert into dadress_dbt (T_PARTYID,T_TYPE,T_ADRESS,T_COUNTRY,T_POSTINDEX,T_REGION,T_CODEPROVINCE,T_PROVINCE,T_CODEDISTRICT,T_DISTRICT,T_CODEPLACE,T_PLACE,T_CODESTREET,T_STREET,T_HOUSE,T_NUMCORPS,";
         SQL1 = SQL1 + "T_FLAT,T_TERRITORY,T_BRANCH,T_NUMSESSION,T_KLADR,T_CODEREGION,T_OKATO,T_REGIONNUM) values (";
         SQL1 = SQL1 + maxpartyid + ", ";                                     /*T_PARTYID             NUMBER (10)*/
         SQL1 = SQL1 + "3, '";                                                  /*T_TYPE                NUMBER (5)*/
         SQL1 = SQL1 + StrSubst(trim(rs.Value("T_ADDRESS_POST")), "'", "''")+"', ";     /*T_ADRESS              VARCHAR2 (511)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_COUNTRY             VARCHAR2 (3)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_POSTINDEX           VARCHAR2 (15)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_REGION              VARCHAR2 (5)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_CODEPROVINCE        NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_PROVINCE            VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_CODEDISTRICT        NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_DISTRICT            VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_CODEPLACE           NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_PLACE               VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_CODESTREET          NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_STREET              VARCHAR2 (49)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_HOUSE               VARCHAR2 (10)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_NUMCORPS            VARCHAR2 (5)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_FLAT                VARCHAR2 (5)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_TERRITORY           VARCHAR2 (2)*/
         SQL1 = SQL1 + "0, ";                                                   /*T_BRANCH              NUMBER (5)*/
         SQL1 = SQL1 + "0, ";                                                   /*T_NUMSESSION          NUMBER (10)*/
         SQL1 = SQL1 + "chr(1), ";                                              /*T_KLADR               VARCHAR2 (23)*/
         SQL1 = SQL1 + "chr(1), ";                                               /*T_CODEREGION          VARCHAR2 (20)*/
         SQL1 = SQL1 + "chr(1),chr(1))";
         cmd1=RsdCommand(SQL1);
         cmd1.execute;
      end;

      SQL1 = "delete from DTXREPLOBJ_DBT where T_OBJECTTYPE=30 and t_objstate = 2 and t_objectid = " + rs.value("t_partyid");
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;

      SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
      SQL1 = SQL1 + "T_OBJSTATE) values (30, " + rs.value("t_partyid") + ", 1, ";
      SQL1 = SQL1 + (maxpartyid ) + " ,1 , 0)";

      cmd1 = RsdCommand( SQL1);
      cmd1.execute;

      SQL1 = "update DTXPARTY_DBT set t_replstate = 1 where t_partyid = " + rs.value("t_partyid") + " and t_action = 1 and t_replstate = 0";
      SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));

      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   elif (rs.Value("T_ACTION") == 2)
      if (count == 0)
         ЗанестиЗаписьВПротокол(401, 30, rs.value("t_partyid"), 1, StrFor(1), "Ошибка: невозможно обновить несуществующего субъекта " + NameParty, rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;
      if (ПроверитьНаРучноеИзменение(30, rs.value("t_partyid")))
         ЗанестиЗаписьВПротокол(200, 30, rs.value("t_partyid"), 1, StrFor(1), "Ошибка: объект находится в режиме ручного редактирования, субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;
      if (СущественныйАтрибут(30, rs.value("t_partyid"), "T_SHORTNAME", /*StrSubst(trim(*/rs.Value("T_SHORTNAME")/*), "'", "''")*/))
         ЗанестиЗаписьВПротокол(100, 30, rs.value("t_partyid"), 1, "T_SHORTNAME", "Предупреждение: изменение существенного атрибута 'Краткое наименование', субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
      end;
      if (СущественныйАтрибут(30, rs.value("t_partyid"), "T_NOTRESIDENT", rs.value("T_NOTRESIDENT")))
         ЗанестиЗаписьВПротокол(101, 30, rs.value("t_partyid"), 1, "T_NOTRESIDENT", "Предупреждение: изменение существенного атрибута 'Признак нерезидента', субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
      end;
      if (СущественныйАтрибут(30, rs.value("t_partyid"), "T_NRCOUNTRY", rs.Value("T_NRCOUNTRY")))
         ЗанестиЗаписьВПротокол(102, 30, rs.value("t_partyid"), 1, "T_NRCOUNTRY", "Предупреждение: изменение существенного атрибута 'Страна нерезидента', субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
      end;

      SQL1 = "update dparty_dbt set T_LEGALFORM = " + rs.Value("T_LEGALFORM") + ", T_SHORTNAME = '";
      SQL1 = SQL1 + StrSubst(trim(rs.Value("T_SHORTNAME")), "'", "''") + "', T_NAME = '" + StrSubst(trim(rs.Value("T_FULLNAME")), "'", "''");
      SQL1 = SQL1 + "', T_OKPO = '" + trim(rs.Value("T_OKPO")) + "', T_NOTRESIDENT = " + T_NOTRESIDENT + ", T_NRCOUNTRY = '";
      SQL1 = SQL1 + /*trim(rs.Value("T_NRCOUNTRY"))*/T_NRCOUNTRY + "' where T_PARTYID = " + Count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      // признаки - Является взаимозависимым лицом (101) и Является филиалом банка (102)
      // Установка значения категории Является взаимозависимым лицом ( 101 )
      party.partyid = Count;
	  StrUniID = string( UniID(party, OBJTYPE_PARTY));
      CatID = 101;
      CatName = "Является взаимозависимым лицом";
      if ( T_INTERFERENCE != null )
         SetCatID = T_INTERFERENCE;

         if( rs.Value("T_ACTION") != 1 )
            DisconnectObjAttr( 3, StrUniID, CatID );
         end;

         if( ( not ConnectObjAttr( CatErr, 3, StrUniID,  CatID,
                                   ПолучитьIDАтрибута(3, CatID, SetCatID), NULL, NULL, rs.Value("T_INSTANCEDATE") )
             ) OR
             ( CatErr != 0 )
           )
            ЗанестиЗаписьВПротокол(678, 80, rs.Value("T_DEALID"), 1, StrFor(1), "Предупреждение: ошибка при установке категории " + CatName + " для сделки", rs.Value("T_INSTANCEDATE"));
         end;
      end;

      // Установка значения категории Является филиалом банка ( 102 )
      CatID = 102;
      CatName = "Является филиалом банка";
      if ( T_ISBANKDEP != null )
         SetCatID = T_ISBANKDEP;

         if( rs.Value("T_ACTION") != 1 )
            DisconnectObjAttr( 3, StrUniID, CatID );
         end;

         if( ( not ConnectObjAttr( CatErr, 3, StrUniID,  CatID,
                                   ПолучитьIDАтрибута(3, CatID, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
             ) OR
             ( CatErr != 0 )
           )
            ЗанестиЗаписьВПротокол(678, 80, rs.Value("T_DEALID"), 1, StrFor(1), "Предупреждение: ошибка при установке категории " + CatName + " для сделки", rs.Value("T_INSTANCEDATE"));
         end;
      end;

      if (strlen(trim(rs.Value("t_inn"))) >= 10)
         SQL1 = " SELECT count(*)";
         SQL1 = SQL1 +  "   FROM dobjcode_dbt oc";
         SQL1 = SQL1 +  "  WHERE oc.t_objecttype = 3";
         SQL1 = SQL1 +  "    AND oc.t_codekind = 16";
         SQL1 = SQL1 +  "    AND oc.t_objectid = " + count;
         cmd1 = RsdCommand(SQL1);
         rs1 = RsdRecordSet(cmd1);

         rs1.Movenext;     
         HaveINN = rs1.Value(0);

         if ((HaveINN == 0) and (count_inn == 0))
            SQL1 = "INSERT INTO dobjcode_dbt(T_OBJECTTYPE,T_CODEKIND,T_OBJECTID,T_CODE,T_STATE,T_BANKDATE,T_SYSDATE,T_SYSTIME,T_USERID,T_BRANCH,T_BANKCLOSEDATE,T_NUMSESSION)   ";
            SQL1 = SQL1 + " VALUES (3, ";                                               /*T_OBJECTTYPE  NUMBER (5)*/
            SQL1 = SQL1 + "16, ";                                                       /*T_CODEKIND    NUMBER (5)*/
            SQL1 = SQL1 + count+", '";                                                  /*T_OBJECTID    NUMBER (10)*/
            SQL1 = SQL1 + trim(rs.Value("t_inn"))+"', ";                                /*T_CODE        VARCHAR2 (35)*/
            SQL1 = SQL1 + "0, ";                                                        /*T_STATE       NUMBER (5)*/
            SQL1 = SQL1 + getsqlDate_SK({CurDate})+", ";                                /*T_BANKDATE    DATE*/
            SQL1 = SQL1 + getsqlDate_SK(DateStamp(ПолучитьTimeStamp(), innertime))+", ";/*T_SYSDATE     DATE*/
            SQL1 = SQL1 + GetSQLTime(innertime)+", ";                                   /*T_SYSTIME     DATE*/
            SQL1 = SQL1 + {Oper}+", ";                                                  /*T_USERID      NUMBER (5)*/
            SQL1 = SQL1 + "0, ";                                                        /*T_BRANCH      NUMBER (5)*/
            SQL1 = SQL1 + "to_date('01.01.0001','dd.mm.yyyy'), ";                               /*T_BANKCLOSEDATE  DATE*/
            SQL1 = SQL1 + "0";                                                          /*T_NUMSESSION  NUMBER (10)*/
            SQL1 = SQL1 + ")";
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;
         else
            SQL1 = "update dobjcode_dbt set T_CODE = '" + trim(rs.Value("t_inn")) + "' where T_OBJECTTYPE = 3 and T_CODEKIND = 16 and";
            SQL1 = SQL1 + " T_OBJECTID = " + count;
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;
         end;
      else
         SQL1 = "delete from dobjcode_dbt where T_CODEKIND = 16 and T_OBJECTTYPE = 3 and T_OBJECTID = " + count;
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      if (strlen(trim(rs.Value("t_bic"))) == 9)
         SQL1 = " SELECT count(*)";
         SQL1 = SQL1 +  "   FROM dobjcode_dbt oc";
         SQL1 = SQL1 +  "  WHERE oc.t_objecttype = 3";
         SQL1 = SQL1 +  "    AND oc.t_codekind = 3";
         SQL1 = SQL1 +  "    AND oc.t_objectid = " + count;
         cmd1 = RsdCommand(SQL1);
         rs1 = RsdRecordSet(cmd1);
     
         rs1.Movenext;
         HaveBIC = rs1.Value(0);

         if ((HaveBIC == 0) and (count_bic == 0))
            SQL1 = "INSERT INTO dobjcode_dbt(T_OBJECTTYPE,T_CODEKIND,T_OBJECTID,T_CODE,T_STATE,T_BANKDATE,T_SYSDATE,T_SYSTIME,T_USERID,T_BRANCH,T_BANKCLOSEDATE,T_NUMSESSION)   ";
            SQL1 = SQL1 + " VALUES (3, ";                                               /*T_OBJECTTYPE  NUMBER (5)*/
            SQL1 = SQL1 + "3, ";                                                        /*T_CODEKIND    NUMBER (5)*/
            SQL1 = SQL1 + count + ", '";                                                /*T_OBJECTID    NUMBER (10)*/
            SQL1 = SQL1 + trim(rs.Value("t_bic")) + "', ";                              /*T_CODE        VARCHAR2 (35)*/
            SQL1 = SQL1 + "0, ";                                                        /*T_STATE       NUMBER (5)*/
            SQL1 = SQL1 + getsqlDate_SK({CurDate})+", ";                                /*T_BANKDATE    DATE*/
            SQL1 = SQL1 + getsqlDate_SK(DateStamp(ПолучитьTimeStamp(), innertime))+", ";/*T_SYSDATE     DATE*/
            SQL1 = SQL1 + GetSQLTime(innertime)+", ";                                   /*T_SYSTIME     DATE*/
            SQL1 = SQL1 + {Oper}+", ";                                                  /*T_USERID      NUMBER (5)*/
            SQL1 = SQL1 + "0, ";                                                        /*T_BRANCH      NUMBER (5)*/
            SQL1 = SQL1 + "to_date('01.01.0001','dd.mm.yyyy'), ";                               /*T_BANKCLOSEDATE  DATE*/
            SQL1 = SQL1 + "0";                                                          /*T_NUMSESSION  NUMBER (10)*/
            SQL1 = SQL1 + ")";
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;
         else
            SQL1 = "update dobjcode_dbt set T_CODE = '" + trim(rs.Value("t_bic")) + "' where T_OBJECTTYPE = 3 and T_CODEKIND = 3 and";
            SQL1 = SQL1 + " T_OBJECTID = " + count;
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;
         end;
      else
         SQL1 = "delete from dobjcode_dbt where T_CODEKIND = 3 and T_OBJECTTYPE = 3 and T_OBJECTID = " + count;
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      if (rs.Value("T_LEGALFORM") == 2)
         if (СущественныйАтрибут(30, rs.value("t_partyid"), "T_NAME2", trim(rs.Value("T_NAME2"))))
            ЗанестиЗаписьВПротокол(103, 30, rs.value("t_partyid"), 1, "T_NAME2", "Предупреждение: изменение существенного атрибута 'Имя', субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
         end;

         if (СущественныйАтрибут(30, rs.value("t_partyid"), "T_NAME1", trim(rs.Value("T_NAME1"))))
            ЗанестиЗаписьВПротокол(104, 30, rs.value("t_partyid"), 1, "T_NAME1", "Предупреждение: изменение существенного атрибута 'Фамилия', субъект " + NameParty, rs.Value("T_INSTANCEDATE"));
         end;

         SQL1 = "update dpersn_dbt set T_NAME1 = '" + trim(rs.Value("T_NAME1")) + "', T_NAME2 = '" + trim(rs.Value("T_NAME2")) + "', T_NAME3 = '";
         SQL1 = SQL1 + trim(rs.Value("T_NAME3")) + "' where T_PERSONID=" + count;
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      if ((trim(rs.Value("t_address_ur")) != NullVal) and (trim(rs.Value("t_address_ur")) != StrFor(1)))
         SQL1 = " SELECT COUNT (*)";
         SQL1 = SQL1 +  "   FROM dadress_dbt adr";
         SQL1 = SQL1 +  "  WHERE adr.t_type = 1";
         SQL1 = SQL1 +  "    AND adr.t_partyid =" + count;
         cmd1 = RsdCommand(SQL1);
         rs1 = RsdRecordSet(cmd1);

         rs1.Movenext;     
         HaveUrAdr = rs1.Value(0);

         if ((HaveUrAdr == 0) and (trim(rs.Value("t_address_ur")) != NullVal) and (StrLen(trim(rs.Value("t_address_ur"))) > 1))
            SQL1 = "insert into dadress_dbt (T_PARTYID,T_TYPE,T_ADRESS,T_COUNTRY,T_POSTINDEX,T_REGION,T_CODEPROVINCE,T_PROVINCE,T_CODEDISTRICT,T_DISTRICT,T_CODEPLACE,T_PLACE,T_CODESTREET,T_STREET,T_HOUSE,T_NUMCORPS,";
            SQL1 = SQL1 + "T_FLAT,T_TERRITORY,T_BRANCH,T_NUMSESSION,T_KLADR,T_CODEREGION,T_OKATO,T_REGIONNUM) values (";
            SQL1 = SQL1 + count+", ";                                           /*T_PARTYID             NUMBER (10)*/
            SQL1 = SQL1 + "1, '";                                               /*T_TYPE                NUMBER (5)*/
            SQL1 = SQL1 + StrSubst(trim(rs.Value("t_address_ur")), "'", "''")+"', ";    /*T_ADRESS              VARCHAR2 (511)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_COUNTRY             VARCHAR2 (3)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_POSTINDEX           VARCHAR2 (15)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_REGION              VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEPROVINCE        VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_PROVINCE            VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEDISTRICT        VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_DISTRICT            VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEPLACE           VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_PLACE               VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODESTREET          VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_STREET              VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_HOUSE               VARCHAR2 (10)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_NUMCORPS            VARCHAR2 (5)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_FLAT                VARCHAR2 (5)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_TERRITORY           VARCHAR2 (2)*/
            SQL1 = SQL1 + "0, ";                                                /*T_BRANCH              NUMBER (5)*/
            SQL1 = SQL1 + "0, ";                                                /*T_NUMSESSION          NUMBER (10)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_KLADR               VARCHAR2 (23)*/
            SQL1 = SQL1 + "chr(1), ";                                            /*T_CODEREGION          VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1),chr(1))";
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;
         else
            if (trim(rs.Value("t_address_ur")) != "")
               SQL1 = "update dadress_dbt set T_ADRESS = '" + StrSubst(trim(rs.Value("t_address_ur")), "'", "''") + "' where T_TYPE = 1 and ";
               SQL1 = SQL1 + "T_PARTYID = " + count;
               cmd1 = RsdCommand(SQL1);
               cmd1.execute;
            else
               SQL1 = "delete from dadress_dbt where t_type = 1 and t_partyid = " + count;
               cmd1 = RsdCommand(SQL1);
               cmd1.execute;
            end;
         end;
      else
         SQL1 = "delete from dadress_dbt where t_type = 1 and t_partyid = " + count;
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      if ((trim(rs.Value("t_address_post")) != NullVal) and (trim(rs.Value("t_address_post")) != StrFor(1)) )
         SQL1 = " SELECT COUNT (*)";
         SQL1 = SQL1 +  "   FROM dadress_dbt adr";
         SQL1 = SQL1 +  "  WHERE adr.t_type = 3";
         SQL1 = SQL1 +  "    AND adr.t_partyid ="+count;
         cmd1 = RsdCommand(SQL1);
         rs1 = RsdRecordSet(cmd1);
     
         rs1.Movenext;
         HavePostAdr = rs1.Value(0);

         if ((HavePostAdr == 0) and (trim(rs.Value("t_address_post")) != NullVal) and (StrLen(trim(rs.Value("t_address_post"))) > 1))
            SQL1 = "insert into dadress_dbt(T_PARTYID,T_TYPE,T_ADRESS,T_COUNTRY,T_POSTINDEX,T_REGION,T_CODEPROVINCE,T_PROVINCE,T_CODEDISTRICT,T_DISTRICT,"+
                   "T_CODEPLACE,T_PLACE,T_CODESTREET,T_STREET,T_HOUSE,T_NUMCORPS,T_FLAT,"+
                   "T_TERRITORY,T_BRANCH,T_NUMSESSION,T_KLADR,T_CODEREGION,T_OKATO,T_REGIONNUM)  values (";
            SQL1 = SQL1 + count+", ";                                           /*T_PARTYID             NUMBER (10)*/
            SQL1 = SQL1 + "3, '";                                               /*T_TYPE                NUMBER (5)*/
            SQL1 = SQL1 + StrSubst(trim(rs.Value("t_address_post")), "'", "''")+"', ";/*T_ADRESS                VARCHAR2 (511)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_COUNTRY             VARCHAR2 (3)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_POSTINDEX           VARCHAR2 (15)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_REGION              VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEPROVINCE        VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_PROVINCE            VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEDISTRICT        VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_DISTRICT            VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODEPLACE           VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_PLACE               VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_CODESTREET          VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_STREET              VARCHAR2 (49)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_HOUSE               VARCHAR2 (10)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_NUMCORPS            VARCHAR2 (5)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_FLAT                VARCHAR2 (5)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_TERRITORY           VARCHAR2 (2)*/
            SQL1 = SQL1 + "0, ";                                                /*T_BRANCH              NUMBER (5)*/
            SQL1 = SQL1 + "0, ";                                                /*T_NUMSESSION          NUMBER (10)*/
            SQL1 = SQL1 + "chr(1), ";                                           /*T_KLADR               VARCHAR2 (23)*/
            SQL1 = SQL1 + "chr(1), ";                                            /*T_CODEREGION          VARCHAR2 (20)*/
            SQL1 = SQL1 + "chr(1),chr(1))";
            cmd1 = RsdCommand(SQL1);
            cmd1.execute;
         else
            if (trim(rs.Value("t_address_post")) != "")
               SQL1 = "update dadress_dbt set T_ADRESS = '" + StrSubst(trim(rs.Value("t_address_post")), "'", "''")+"' where T_TYPE = 3 and ";
               SQL1 = SQL1 + "T_PARTYID = " + count;
               cmd1 = RsdCommand(SQL1);
               cmd1.execute;
            else
               SQL1 = "delete from dadress_dbt where t_type = 3 and t_partyid = " + count;
               cmd1 = RsdCommand(SQL1);
               cmd1.execute;
            end;
         end;
      else
         SQL1 = "delete from dadress_dbt where t_type = 3 and t_partyid = " + count;
         cmd1 = RsdCommand(SQL1);
         cmd1.execute;
      end;

      SQL1 = "update DTXPARTY_DBT set t_replstate = 1 where t_partyid = " + rs.value("t_partyid") + " and t_action = 2 and t_replstate = 0";
      SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));

      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   elif (rs.Value("T_ACTION") == 3)
      if (count == 0)
            ЗанестиЗаписьВПротокол(402, 30, rs.value("t_partyid"), 1, StrFor(1), "Ошибка: невозможно удалить несуществующего субъекта " + NameParty, rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

      SQL1 = "delete from dparty_dbt where T_PARTYID="+count;
      cmd1=RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "delete from dobjcode_dbt where T_OBJECTTYPE = 3 and T_OBJECTID = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "delete from dpersn_dbt where T_PERSONID = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "delete from dadress_dbt where T_PARTYID = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "delete from dpartyown_dbt where T_PARTYID = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "delete from dclient_dbt where T_PARTYID = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;
	  
      SQL1 = "delete from DPTSVDP_DBT where T_PARTYID = " + count;
      cmd1 = RsdCommand(SQL1);
      cmd1.execute;

      SQL1 = "update DTXREPLOBJ_DBT set T_OBJSTATE = 2 where T_OBJECTTYPE = 30 and T_DESTID = " + count + " and T_OBJECTID = " + rs.value("t_partyid");
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;

      SQL1 = "update DTXPARTY_DBT set t_replstate = 1 where t_partyid = " + rs.value("t_partyid") + " and t_action = 3 and t_replstate = 0";
      SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
      cmd1 = RsdCommand( SQL1);
      cmd1.execute;
   end;

   return TRUE;
OnError(er) 
   ЗанестиЗаписьВПротокол(601, 30, rs.value("t_partyid"), 1, StrFor(1), "Ошибка: " + er.message, rs.Value("T_INSTANCEDATE"));
   AbortTrn;
end;

macro ОбработатьСубъекта(Action, t_instancedate, Init_Action:String)
   var SQL, cmd, rs, stat, code, Счетчик;

   SQL = "select count(*) from DTXPARTY_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate;
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
      MaxVal = rs.Value(0);
   end;

   var ProgressIndicator = CreateProgressIndicator(true);
   ProgressIndicator.Start(Int(MaxVal), "Обработка субъектов...");

   Счетчик = 0;

   SQL = "select * from DTXPARTY_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate + " order by t_partyid";
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);
 
   while (rs.Movenext)
      Счетчик = Счетчик + 1;

      ProgressIndicator.Update(Int(Счетчик), MaxVal);

      if (rs.value("T_ACTION") == 1)
         code = GenerateReference_SK();
         if (code == "")
            ЗанестиЗаписьВПротокол(602, 30, rs.value("t_partyid"), 1, StrFor(1), "Ошибка: невозможно сгенерировать код субъекта " + NameParty, rs.Value("T_INSTANCEDATE"));
            Return FALSE;
         end;
      end;
   
      if (RslDefCon.isintrans == false)
         RslDefCon.BeginTrans();
      end;

      if (ProcessParty(rs, code))
         RslDefCon.CommitTrans();
      else
         RslDefCon.RollbackTrans();
      end;
   end;

   ProgressIndicator.Stop();

   return TRUE;
OnError(er)
   ЗанестиЗаписьВПротокол(601, 30, "", "", StrFor(1), "Ошибка: " + er.message, date(t_instancedate));
end;