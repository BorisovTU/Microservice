/*
$Name:             txproc_oper_fun.mac
$Module:           БОЦБ 
$Description:      Процедуры для репликации данных в БОЦБ из внешних систем
                   Процедура - ОбработатьОперацию
*/
IMPORT  txproc_paym_fun, ws_common, ws_deals_regenerate;

private const KINDPORT_INVEST = 5;

/*данные с информацие по операции с ценными бумагами, для передачи в процедуру ОбработатьОперацию*/
CLASS TOperationInfo
   var   T_DEALID:numeric;          /* Идентификатор операции*/
   var   T_KIND:integer;            /* Вид операции: 10 -  Покупка, 20 -  Продажа, 30 -  Репо покупка, 40 -  Репо продажа, 50 -  Займ привлечение, 60 -  Займ размещение, 70 -  Погашение выпуска, 80 -  Погашение купона, 90 -  Частичное погашение, 100 -  Получение дивидендов,  110 -  Неттинг*/
   var   T_EXTCODE:string;          /* Код во внешней системе */
   var   T_MARKETCODE:string;       /* Код на бирже - только для биржевых сделок */
   var   T_PARTYCODE:string;        /* Код у контрагента - только если задан контрагент*/   
   var   T_CODE:string;             /* По умолчанию - очередной код */
   var   T_DATE:date;               /* Дата заключения сделки*/
   var   T_TIME:time;               /* Время заключения сделки*/
   var   T_CLOSEDATE:date;          /* Плановая дата завершения. Если не задана, берется MAX(Дата оплаты, Дата поставки)*/
   var   T_TSKIND:string;           /* Режим торгов (на ММВБ): P - аукцыон, T - системная, N - внесистемная, L - неполные лоты F - перевод R - репо*/
   var   T_ACCOUNTTYPE:integer;     /* Тип расчетов (во внебиржевых): 1 - DVP Поставка против платежа  2 - DFP  Поставка без платежа 3 - PP Предоплата 4 - PD Предпоставка */
   var   T_MARKETID:integer;        /* Идентификатор биржи*/
   var   T_SECTOR:integer;          /* Идентификатор сектора биржи*/
   var   T_BROKERID:integer;        /* Идентификатор брокера*/
   var   T_PARTYID:integer;         /* Идентификатор контрагента*/
   var   T_DEPARTMENT:integer;      /* Филиал*/
   var   T_AVOIRISSID:integer;      /* Идентификатор ценной бумаги*/
   var   T_WARRANTID:integer;       /* Идентификатор купона*/
   var   T_PARTIALID:integer;       /* Идентификатор частичного погашения (амортизации)*/
   var   T_AMOUNT:money;            /* Количество ценных бумаг*/
   var   T_CURRENCYID:integer;      /* Идентификатор валюты сделки (операции)*/
   var   T_PRICE:money;             /* Цена за шт. ценной бумаги не включая НКД*/
   var   T_POINT:integer;           /* Точность цены*/
   var   T_COST:money;              /* Стоимость ценных бумаг без НКД*/
   var   T_NKD:money;               /* Накопленный купонный доход по поставляемым ценным бумагам в валюте номинала*/
   var   T_TOTALCOST:money;         /* Общая сумма - Общая сумма по сделке (операции) вкл.  НКД в валюте операции.*/   
   var   T_RATE:money;              /* Ставка (репо, займ)*/
   var   T_PRICE2:money;            /* Цена за шт. ценной бумаги не включая НКД по 2 части Репо*/
   var   T_COST2:money;             /* Стоимость ценных бумаг без НКД по 2 части Репо*/
   var   T_NKD2:money;              /* Накопленный купонный доход по поставляемым ценным бумагам в валюте номинала по 2 части Репо*/
   var   T_TOTALCOST2:money;        /* Общая сумма по сделке (операции) вкл.  НКД в валюте операции по 2 части Репо*/   
   var   T_PAYDATE:date;            /* Плановая дата оплаты в сделках. В Репо - дата оплаты по 1 ч*/
   var   T_SUPLDATE:date;           /* Плановая дата поставки в сделках. В Репо - дата поставки по 1 ч., в займе -дата размещения/привлечения ценных бумаг*/
   var   T_PAYDATE2:date;           /* Плановая дата оплаты по 2 ч. Репо*/
   var   T_SUPLDATE2:date;          /* Плановая дата поставки по 2 части Репо, плановая дата возврата ценных бумаг в займе*/
   var   T_CONTRNUM:string;         /* Номер договора -  основания совершения сделки: купли/продажи, займа и т.д*/   
   var   T_CONTRDATE:date;          /* Дата  договора -  основания совершения сделки: купли/продажи, займа и т.д*/
   var   T_COSTCHANGE:string;       /* Признак изменеия стоимости реализации/приобретения по 2 части Репо при выплате купонного дохода/дивидентов/частичного погашения ценных бумаг*/
   var   T_COSTCHANGEONCOMP:string; /* Признак изменения стоимости при выплате компенсационного взноса - Признак изменения стоимости реализации/приобретения во 2 части Репо  при выплате компенсационного взноса.*/
   var   T_COSTCHANGEONAMOR:string; /* Признак изменения стоимости при выплате амортизации - Признак изменения стоимости реализации/приобретения по 2 части Репо при выплате амортизации */
   var   T_ADJUSTMENT:string;       /* Признак урегулирования требований по ст.282 НК РФ.*/
   var   T_NEEDDEMAND:string;       /* Признак, нужно ли создавать Т/О на стороне RS-Securities, или нет */
   var   T_ATANYDAY:string;         /* Признак означает, что сделка может быть выполнена в любой день */
   var   T_CONDITIONS:string;       /* Дополнительные условия VARCHAR2(1500) */
   var   T_STATE:string;            /* Состояние сделки: 0 - Планируется (зарезервировано) 1 - Открыта 2 - Закрыта */
   var   T_REPOBASE:integer;        /* База расчета - Количество дней в году. Задается только во внебиржевом Репо 1-365,2-360 */
   var   T_NKDFIID:integer;         /* Валюта НКД по сделке */
   var   T_PAYMCUR:integer;         /* Валюта платежа */
   var   T_INSTANCEDATE:date;       /* Дата начала действия признака */ 
   var   T_BALANCEDATE:date;        /* Дата принятия к учету */  /*I-Support 272941 */
   var   T_DOPCONTROL:integer;       /* Сделка подлежит дополнительному контролю. Список значений. */
   var   T_DOPCONTROL_NOTE;       /* Комментарий к классификатору "Сделка подлежит дополнительному контролю. */
   var   T_FISSKIND: integer;     /* Вид сделок ФИСС: 1 - форвард, 2 - фьючерс, 3 - опцион.   */
   var   T_PRICE_CALC: money;     /* Расчетная цена  */
   var   T_PRICE_CALC_MET_NOTE;     /* Комментарий к классификатору "Способ определения РЦ. */
   var   T_PRICE_CALC_METHOD: integer; /* способ определения расчетной цены. Заполняется в соответствии с Приложением 3. */
   var   T_PRICE_CALC_VAL; /* Единица измерения расчетной цены. 1 - % от номинала, 2 - валюта номинала, 3 - валюта договора, 4 - валюта котировки. */
   var   T_PRICE_CALC_DEF: money;   /* Отклонение от расчетной цены */
   var   T_PRICE_CALC_OUTLAY: money;   /* Расходы по оценке рыночной стоимости */
   var    T_PARENTID: integer;       /* Ссылка на родительскую сделку для сделок РЕПО с корзиной ценных бумаг */

   var   InTrn:bool; /*признак выполнения процедуры уже в начатой транзакции*/

   var   ExistBack:bool;            /* признак наличия обратной части сделки*/
   var   OperGroup:integer;         /* группа операции, используется для определения типа операции */
   var   StrUniID:string;           /* уникальный идентификатор сделки в строковом виде: используется для категорий и примечаний по сделке*/
   var   ObjType:integer;           /* вид объекта (сделка\погашение) к которому привязываются примечания\платежи */
   var   LoanToRepo:bool;           /* признак трансформации операции РЕПО в операцию займа*/
   var   IsMarketOper:bool;         /* признак биржевой операции с ц/б*/
   var   IsJudicialOper:bool;       /* сделка - передача бумаг по решению суда, общая стоимость и цена в такой сделке может быть равна нулю*/ 
   var   IsLOAN:bool;               /* признак операции займа  */
   var   BofficeKind:integer;       /* вид первичного документа операции*/
   var   OperExist:bool;            /* признак надичия в системе обрабатываемой операции*/   
   var   Action:integer;            /* выполняемое действие (1 - вставка, 2 - изменение, 3 - удаление.)*/
   var   DeleteDemands:bool;        /* признак удаления платежей\лотов при удалении операции */
   var   SaveInChangeHistory:bool;  /* признак занесения записи в историю изменений по сделке*/
   var   OldDealID:numeric;

   var   Error:TArray;           /* массив строк с текстами ошибок*/

   var   T_ISPFI_1:string;     /* признак "Является ПФИ */
   var   T_ISPFI_2:string;     /* признак "Является ПФИ */
   var   T_LIMIT:string;       /* признак блокировки ц/б */
   var   T_CHRATE:string;      /* признак сделки РЕПО с изменением процентной ставки */
   var   T_CHAVR:date;            /* признак сделки РЕПО с заменой бумаг. Передается дата замены */
   var   T_COUNTRY:integer;       /* место заключения сделки */
   var   T_DIV:string;         /* признак принадлежности дивидендов продавцу первой части */
   var   ISBASKET:bool;      /* сделка РЕПО является сделкой с корзиной ценных бумаг. */

   MACRO MakeError( ErrorMes:string )
      this.Error[this.Error.Size] = string(this.Error.Size) + ":" + ErrorMes;
   END;

   MACRO PrintErrors()
      var i = 0;
      while( this.Error[i] != null )
         println( this.Error[i] );
         i = i + 1;   
      end;     
   END;  

   MACRO Init()
      this.ExistBack             =  false;
      this.OperGroup             =  0;
      this.LoanToRepo            =  false;
      this.IsMarketOper          =  false;   
      this.IsLOAN                =  false;
      this.OperExist             =  false;
      this.Error                 =  TArray;
      this.BofficeKind           =  0;
      this.Action                =  0;
      this.DeleteDemands         =  false; 
      this.SaveInChangeHistory   =  false; 
      this.ISBASKET              =  false;
   END;

   Init();
END;


PRIVATE FILE nett( "dl_nett.dbt") write; /*сделки неттинга*/
PRIVATE FILE deal ("dl_tick.dbt")  write; /*описание сделки*/
PRIVATE FILE spgr( "spground.dbt") write; /*договор по сделке*/
PRIVATE FILE spgrdoc( "spgrdoc.dbt") write; /*привязка договора к сделке*/
PRIVATE FILE partyown( "partyown.dbt" ) write;
PRIVATE FILE rq( "dlrq.dbt") write; /*ТО по сделке*/

PRIVATE var  leg1 = TBfile("dl_leg.dbt", "W"); /*ценовые условия сделки*/
PRIVATE var  leg2 = TBfile("dl_leg.dbt", "W"); /*ценовые условия сделки по 2-ой части*/

PRIVATE  var   party       =  TRecHandler("party.dbt");
PRIVATE  var   avoiriss    =  TRecHandler("avoiriss.dbt");
PRIVATE  var   gOperData   =  TOperationInfo;

private var Con_own, Env_own;

/*массив для кэширования признаков котируемости цб*/
private var quoting_data  = TArray();

PRIVATE MACRO GetIsoNumber(ID)
   var sql, cmd;
   sql = "select t_iso_number from dfininstr_dbt where t_fiid = " + ID;
   cmd = TRsbDataSet( sql );

   if( cmd.MoveNext())
      return cmd.iso_number;
   else
      return "";
   end;
END;

PRIVATE MACRO GetCodeCountry(ID)
   var sql, cmd;
   sql = "select t_codelat3 from dcountry_dbt where t_codenum3 = '"+ID+"'";
   cmd = TRsbDataSet( sql );

   if( cmd.MoveNext())
      return cmd.codelat3;
   else
      return "";
   end;
END;

PRIVATE MACRO Кэш_ПолучитьКотируемостьБумаги( avoiriss, OnDate:date )
   if( quoting_data[avoiriss.rec.FIID] == null )
      quoting_data[avoiriss.rec.FIID] = FI_IsQuoted( avoiriss, OnDate );
   end;
   return quoting_data[avoiriss.rec.FIID];
END;

/*массив для кэширования проверки цб - облигация?*/
private var bond_data  = TArray();

PRIVATE MACRO Кэш_БумагаОблигация( AvoirissID:integer )
   if( bond_data[AvoirissID] == null )
      bond_data[AvoirissID] = FI_IsBond( AvoirissID );
   end;
   return bond_data[AvoirissID];   
END;

/*массив для кэширования ID найденных субъектов*/
private var party_data  = TArray();

PRIVATE MACRO Кэш_ПолучитьСубъекта( ID:integer )
   var sqlQuery:string = "", DataSet;
       
   if( party_data[ID] == null )
      sqlQuery =  "  SELECT count(1) as QuontParty " +
                  "  FROM dparty_dbt pt " +             
                  "  WHERE  pt.T_PARTYID = " + string(ID) ;
      DataSet = TRsbDataSet( sqlQuery );

      if( DataSet.MoveNext() and (DataSet.QuontParty > 0) )
         party_data[ID] = true;
      else
         party_data[ID] = false;
      end;
   end;

   return party_data[ID];
END;


/*массив для кэширования кодов найденных субъектов*/
private var code_data  = TArray();

PRIVATE MACRO Кэш_ПолучитьКодСубъекта( PartyID:integer )
   if( code_data[PartyID] == null )
      code_data[PartyID] = ПолучитьКодСубъекта( PartyID, PTCK_CONTR );   
   end;
   return code_data[PartyID];     
END;

PRIVATE MACRO НомерКупонаИлиЧП( FIID:integer, _ID:string, IsPartial:string )
   var sqlQuery:string = "", DataSet;

   if (IsPartial == UNSET_CHAR)
      IsPartial = "chr(0)";
   elif (IsPartial == SET_CHAR)
      IsPartial = "chr(88)";
   end;

   sqlQuery =  "  SELECT T_NUMBER as NUM " +
               "  FROM dfiwarnts_dbt fiw " +             
               "  WHERE  fiw.T_IsPartial = " + IsPartial    + " AND " +  
               "         fiw.T_FIID = "      + string(FIID) + " AND " +
               "         fiw.T_ID = "    + _ID ;

   DataSet = TRsbDataSet( sqlQuery );

   if( DataSet.MoveNext() )
      return string(DataSet.NUM);
   end;

   return "";
END;

PRIVATE MACRO ПроверитьНаличиеКупона( FIID:integer, Number:string, IsPartial:string )
   var sqlQuery:string = "", DataSet;

   if (IsPartial == UNSET_CHAR)
      IsPartial = "chr(0)";
   elif (IsPartial == SET_CHAR)
      IsPartial = "chr(88)";
   end;

   sqlQuery =  "  SELECT count(1) as QuontCoupons " +
               "  FROM dfiwarnts_dbt fiw " +             
               "  WHERE  fiw.T_IsPartial = " + IsPartial    + " AND " +  
               "         fiw.T_FIID = "      + string(FIID) + " AND " +
               "         fiw.T_ID = "    + Number ;

   DataSet = TRsbDataSet( sqlQuery );

   if( DataSet.MoveNext() and (DataSet.QuontCoupons > 0) )
      return true;
   else
      return false;
   end;
END;

PRIVATE MACRO ЗадатьСубъектуВид( PARTYID:integer, PartyKind:integer )
   private var SQL, cmd;

   Env_own = RsdEnvironment("RDDrvO","RDDrvO.dll");
   Con_own = RsdConnection(Env_own, GetIniString( "CONNSTRING", "rsreq.ini" ));

   SQL = "insert into dpartyown_dbt values (";
   SQL = SQL + PARTYID + ", ";                     /*T_PARTYID     NUMBER (10)*/
   SQL = SQL + PartyKind + ", ";                   /*T_PARTYKIND   NUMBER (5)*/
   SQL = SQL + "0, ";                              /*T_SUPERIOR    NUMBER (10)*/
   SQL = SQL + "0, ";                              /*T_SUBKIND     NUMBER (10)*/
   SQL = SQL + "0, ";                              /*T_BRANCH      NUMBER (5)*/
   SQL = SQL + "0 ";                               /*T_NUMSESSION  NUMBER (10)*/
   SQL = SQL + ")";

   cmd = RsdCommand(Con_own, SQL);
   cmd.execute;

   Return TRUE;
OnError()
   AbortTrn;
END;

PRIVATE MACRO UpdateDlLeg( leg )

   var m_RSDcmd = RsdCommand( RslDefCon, "UPDATE ddl_leg_dbt SET t_PFI = ?, t_CFI = ?, " +
                                       " t_Maturity = ?, t_Expiry = ?, " +
                                       " t_Principal = ?, t_Price = ?, t_Cost = ?, " +
                                       " t_Formula = ?, t_Scale = ?, t_Point = ?, t_RelativePrice = ?, " +
                                       " t_NKD = ?, t_TotalCost = ?, t_MaturityIsPrincipal = ?, " +
                                       " t_IncomeRate = ?, t_IncomeScale = ?, t_IncomePoint = ?, " +
                                       " t_ReceiptAmount = ?, t_Basis = ?, t_DeliveringFIID = ? " +
                                       " WHERE t_LegKind = ? AND t_DealID = ? AND t_LegID = ? ");

   m_RSDcmd.addParam( "t_PFI",                  RSDBP_IN,   leg.PFI       );
   m_RSDcmd.addParam( "t_CFI",                  RSDBP_IN,   leg.CFI       );
   m_RSDcmd.addParam( "t_Maturity",             RSDBP_IN,   leg.Maturity  );
   m_RSDcmd.addParam( "t_Expiry",               RSDBP_IN,   leg.Expiry    );
   m_RSDcmd.addParam( "t_Principal",            RSDBP_IN,   leg.Principal );
   m_RSDcmd.addParam( "t_Price",                RSDBP_IN,   leg.Price     );
   m_RSDcmd.addParam( "t_Cost",                 RSDBP_IN,   leg.Cost      );
   m_RSDcmd.addParam( "t_Formula",              RSDBP_IN,   leg.Formula   );
   m_RSDcmd.addParam( "t_Scale",                RSDBP_IN,   leg.Scale     );
   m_RSDcmd.addParam( "t_Point",                RSDBP_IN,   leg.Point     );
   m_RSDcmd.addParam( "t_RelativePrice",        RSDBP_IN,   leg.RelativePrice );
   m_RSDcmd.addParam( "t_NKD",                  RSDBP_IN,   leg.NKD       );
   m_RSDcmd.addParam( "t_TotalCost",            RSDBP_IN,   leg.TotalCost );
   m_RSDcmd.addParam( "t_MaturityIsPrincipal",  RSDBP_IN,   leg.MaturityIsPrincipal );
   m_RSDcmd.addParam( "t_IncomeRate",           RSDBP_IN,   leg.IncomeRate    );
   m_RSDcmd.addParam( "t_IncomeScale",          RSDBP_IN,   leg.IncomeScale   );
   m_RSDcmd.addParam( "t_IncomePoint",          RSDBP_IN,   leg.IncomePoint   );
   m_RSDcmd.addParam( "t_ReceiptAmount",        RSDBP_IN,   leg.ReceiptAmount );
   m_RSDcmd.addParam( "t_Basis",                RSDBP_IN,   leg.Basis      );
   m_RSDcmd.addParam( "t_DeliveringFIID",       RSDBP_IN,   leg.DeliveringFIID);
   m_RSDcmd.addParam( "t_LegKind",              RSDBP_IN,   leg.LegKind    );
   m_RSDcmd.addParam( "t_DealID",               RSDBP_IN,   leg.DealID     );
   m_RSDcmd.addParam( "t_LegID",                RSDBP_IN,   leg.LegID      );
   m_RSDcmd.Execute();
END;

/*обработка операций, хранящихся в DL_NETT и связанных с ней базах*/
/* операции НЕТТИНГА*/
MACRO ProcessDL_NETT()
   var   MarketCode:string =  "";
   var   IsWrongParms:bool =  false;
   var   ret:bool          =  true;
   var   sqlQuery:string = "", DataSet;
   var   DemandData:TDemandData;
   var   m_RSDcmd;
   var   SQL, cmd, rs;

   /*чистим используемые структуры*/
   ClearRecord( nett );

   /*для обновления и удаления должен быть задан T_DEALID*/
   if( (gOperData.Action  == 2) OR (gOperData.Action == 3) )
      if( (gOperData.T_DEALID == null) OR (gOperData.T_DEALID <= 0) )
         gOperData.MakeError("Ошибка: не найдена сделка неттинга" );
         ЗанестиЗаписьВПротокол(540, 80, gOperData.T_DEALID, 1, StrFor(1), "Ошибка: не найдена сделка неттинга", gOperData.T_INSTANCEDATE);
         IsWrongParms = true;
         AbortTrn;
      else
         KeyNum(nett, 0 );
         nett.NettingID = gOperData.T_DEALID;
         if( GetEQ( nett ) )   
            gOperData.OperExist = true;
         else
            gOperData.OperExist = false;
         end;      
      end;
   end;
   
   if( IsWrongParms == false )
      if( gOperData.Action  == 1  )  /* вставка   */
         if( gOperData.OperExist )
            gOperData.MakeError("Ошибка: сделка уже существует в целевой системе");
            ЗанестиЗаписьВПротокол(421, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: сделка уже существует в целевой системе", gOperData.T_INSTANCEDATE);             
            AbortTrn;  
         end;
         nett.NettingID = 0;
      elif( gOperData.Action  == 2  )  /* изменение */
         if( gOperData.OperExist == false )
            gOperData.MakeError("Ошибка: сделка не найдена в целевой системе");
            ЗанестиЗаписьВПротокол(422, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: сделка не найдена в целевой системе", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;
      elif( gOperData.Action  == 3  )  /* удаление  */
         if( gOperData.OperExist == false )
            gOperData.MakeError("Ошибка: сделка уже удалена в целевой системе");
            ЗанестиЗаписьВПротокол(423, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: сделка уже удалена в целевой системе", gOperData.T_INSTANCEDATE);
            AbortTrn;        
         end;
      else
         gOperData.MakeError( "Ошибка: неверный вид выполняемого действия: " + string( gOperData.Action ) ); 
         ЗанестиЗаписьВПротокол(530, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: неверный вид выполняемого действия", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;
   end;

   /*инициализация данных операции для вставки\изменения*/
   if( (IsWrongParms == false) AND ((gOperData.Action == 1) OR (gOperData.Action == 2)) )
      nett.Status          =  10/*NTG_OPEN*/;
      nett.Oper            =  {oper};          
      nett.Contractor      =  -1;   
      nett.Kind_Operation  =  1080; /*неттинг по сделкам*/
      nett.DocKind         =  gOperData.BOfficeKind;
	  nett.IDENTPROGRAM    = 14; // !? Для отбора в скроллинг неттинга БОЦБ

      if( (gOperData.T_DATE != null) and (gOperData.T_DATE != date(0,0,0)) )
         nett.SigningDate     =  nett.RegisterDate = nett.ValueDate = gOperData.T_DATE;
      else
         gOperData.MakeError("Ошибка: не задана дата заключения сделки неттинга, T_DATE" );
         ЗанестиЗаписьВПротокол(531, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задана дата заключения сделки неттинга, T_DATE", gOperData.T_INSTANCEDATE);
         IsWrongParms = true;
      end;

      if( (gOperData.T_CODE != null) and (gOperData.T_CODE != "") )
         nett.DealNumber   =  gOperData.T_CODE;
      else
         gOperData.MakeError( "Ошибка: не задан номер сделки неттинга, T_CODE" );
         ЗанестиЗаписьВПротокол(532, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан номер сделки неттинга, T_CODE", gOperData.T_INSTANCEDATE);
         IsWrongParms = true;
      end;

      if( (gOperData.T_EXTCODE != null) and (gOperData.T_EXTCODE != "") )
         nett.ExtCode = gOperData.T_EXTCODE;
      end;

      party.Clear(); 
      party.rec.PartyID = -1;
      if( (gOperData.T_PARTYID != null) AND (gOperData.T_PARTYID > 0) )
         if(( gOperData.T_PARTYID == {OurBank} ) and ( gOperData.T_KIND != 70 ) and ( gOperData.T_KIND != 80 ) and ( gOperData.T_KIND != 90 ))
            gOperData.MakeError("Ошибка: неверно задан параметр T_PARTYID, наш банк не может быть контрагентом");
            ЗанестиЗаписьВПротокол(533, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: неверно задан параметр T_PARTYID, наш банк не может быть контрагентом", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else 
            if( Кэш_ПолучитьСубъекта( gOperData.T_PARTYID ) == true )
               party.rec.PartyID = gOperData.T_PARTYID; 
               if( ВидСубъекта( gOperData.T_PARTYID, PTK_CONTR ) == true )
                  nett.Contractor = gOperData.T_PARTYID;
               else
                  if( ЗадатьСубъектуВид( gOperData.T_PARTYID, PTK_CONTR ) != true )
                     gOperData.MakeError("Ошибка: ошибка при добавлениии субъекту с T_PARTYID = " + string(gOperData.T_PARTYID) + " вида - контрагент по сделкам");
                     ЗанестиЗаписьВПротокол(654, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при добавлениии субъекту вида - контрагент по сделкам", gOperData.T_INSTANCEDATE);
                     IsWrongParms = true;
                  else
                     nett.Contractor = gOperData.T_PARTYID;
                  end;
               end;
            else
               gOperData.MakeError("Ошибка: не найден субъект с T_PARTYID = " + string(gOperData.T_PARTYID) );
               ЗанестиЗаписьВПротокол(534, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найден субъект", gOperData.T_INSTANCEDATE);
               IsWrongParms = true;
            end;
         end;
      else
         gOperData.MakeError("Ошибка: для сделки неттинга не найден контрагент, параметр T_PARTYID" );
         ЗанестиЗаписьВПротокол(535, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: для сделки неттинга не найден контрагент, параметр T_PARTYID", gOperData.T_INSTANCEDATE);
         IsWrongParms = true;
      end; 

      if( (gOperData.T_DEPARTMENT != null) AND (gOperData.T_DEPARTMENT > 0) ) 
         nett.Department = gOperData.T_DEPARTMENT;
      else
         nett.Department = {OperDprt};
      end;
                                              
      if( (gOperData.T_AVOIRISSID != null) AND (gOperData.T_AVOIRISSID > 0) )
         sqlQuery =  "  SELECT count(1) as QuontAvrs " +
                     "  FROM dfininstr_dbt fi, davoiriss_dbt av  " +             
                     "  WHERE  fi.T_FIID = "  +  string(gOperData.T_AVOIRISSID) + " AND av.T_FIID = fi.T_FIID" ;
         DataSet = TRsbDataSet( sqlQuery );

         if( (not DataSet.MoveNext()) OR (DataSet.QuontAvrs <= 0) )
            gOperData.MakeError("Ошибка: не найдена ценная бумага с T_AVOIRISSID = " + string(gOperData.T_AVOIRISSID) );
            ЗанестиЗаписьВПротокол(536, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена ценная бумага", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else
            nett.FI_Kind   =  FIKIND_AVOIRISS; /*ценнобумажный неттинг*/
            nett.BaseFIID  =  gOperData.T_AVOIRISSID;
         end;
      end;

      if( nett.FI_Kind !=  FIKIND_AVOIRISS )   
         if( gOperData.T_CURRENCYID != null )
            sqlQuery =  "  SELECT count(1) as QuontFins " +
                        "  FROM dfininstr_dbt fi  " +             
                        "  WHERE  fi.T_FIID = "  +  string(gOperData.T_CURRENCYID);
            DataSet = TRsbDataSet( sqlQuery );

            if( (not DataSet.MoveNext()) OR (DataSet.QuontFins <= 0) )
               gOperData.MakeError("Ошибка: не найдена валюта оплаты сделки неттинга с gOperData.T_CURRENCYID = " + string(gOperData.T_CURRENCYID) );
               ЗанестиЗаписьВПротокол(537, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена валюта оплаты сделки неттинга", gOperData.T_INSTANCEDATE);
               IsWrongParms = true;
            else
               nett.FI_Kind   = FIKIND_CURRENCY; /*денежный неттинг*/
               nett.PayFIID   = gOperData.T_CURRENCYID;
            end;       
         else
            gOperData.MakeError("Ошибка: не найдена валюта сделки денежного неттинга" );
            ЗанестиЗаписьВПротокол(538, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена валюта сделки денежного неттинга", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;
      end;

   end;

   /*некорректные входящие параметры - прерываем транзакцию*/
   if( IsWrongParms == true )
      AbortTrn;
   end;

   if( gOperData.Action == 1  )  /* вставка   */
      if( Insert( nett ) == false )
         gOperData.MakeError( "Ошибка: ошибка при вставке в ddl_nett_dbt" );
         ЗанестиЗаписьВПротокол(639, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при вставке в ddl_nett_dbt", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;

      gOperData.T_DEALID = nett.NettingID;

       /*если в параметрах заданы номер и дата договора - добавим догвоор и запись о его привязке к сделке*/
      if( (gOperData.T_CONTRNUM != null) and (gOperData.T_CONTRDATE != null) )
         ClearRecord(spgr);
         spgr.Kind            =  28;   /* */
         spgr.DocLog          =  513;  /* виды документов БОЦБ */
         spgr.Direction       =  2;    /* исходящие   */ 
         spgr.Receptionist    =  nett.Oper;
         spgr.References      =  1;
         spgr.Xld             =  SubStr( gOperData.T_CONTRNUM, 1, 20 ); 
         spgr.SignedDate      =  spgr.RegistrDate = gOperData.T_CONTRDATE;
         spgr.Party           =  party.rec.PartyID; /*если во входных параетрах контрагент (T_PARTYID) корректно задан, будет заполнен party.PartyID*/
         spgr.SourceDocKind   =  DL_NTGDOC;
         spgr.SourceDocID     =  nett.NettingID; 
         spgr.Department      =  spgr.Branch = nett.Department;

         if( Insert( spgr ) == false )
            gOperData.MakeError( "Ошибка: ошибка при вставке в dspground_dbt данных по договору неттинга" );
            ЗанестиЗаписьВПротокол(660, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при вставке в dspground_dbt данных по договору неттинга", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;
      end;
   elif( gOperData.Action  == 2  )  /* изменение */
      if( Update( nett ) == false )
         gOperData.MakeError( "Ошибка: ошибка при обновлении в ddl_nett_dbt" );
         ЗанестиЗаписьВПротокол(642, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при обновлении в ddl_nett_dbt", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;

       /*если в параметрах заданы номер и дата договора - добавим договор и запись о его привязке к сделке*/
      if( (gOperData.T_CONTRNUM != null) and (gOperData.T_CONTRDATE != null) )
         m_RSDcmd = RsdCommand( RslDefCon, "UPDATE dspground_dbt SET t_SignedDate = ?, t_Xld = ? " +
                                           " WHERE t_SourceDocKind = ? AND t_SourceDocID = ? AND t_Direction = ? AND t_Department = ? ");
         m_RSDcmd.addParam("t_SignedDate",     RSDBP_IN,  gOperData.T_CONTRDATE );
         m_RSDcmd.addParam("t_Xld",            RSDBP_IN,  SubStr( gOperData.T_CONTRNUM, 1, 20 )   );
         m_RSDcmd.addParam("t_SourceDocKind",  RSDBP_IN,  DL_NTGDOC );
         m_RSDcmd.addParam("t_SourceDocID",    RSDBP_IN,  nett.NettingID );
         m_RSDcmd.addParam("t_Direction",      RSDBP_IN,  2 );
         m_RSDcmd.addParam("t_Department",     RSDBP_IN,  nett.Department );
         m_RSDcmd.Execute();
      end;
   elif( gOperData.Action  == 3  )  /* удаление  */
      /*удалим договора по сделке и записи привязки договоров к сделке*/
      ret = true;   
      KeyNum(spgrdoc, 1 );
      ClearRecord(spgrdoc);
      spgrdoc.SourceDocKind = DL_NTGDOC;
      spgrdoc.SourceDocID   = nett.NettingID; 
      if( GetGE( spgrdoc ) == true ) 
         while(   (ret == true) and
                  (spgrdoc.SourceDocKind == DL_NTGDOC) and 
                  (spgrdoc.SourceDocID   == nett.NettingID) )
            KeyNum( spgr, 0);
            ClearRecord( spgr );
            spgr.SPGroundID = spgrdoc.SPGroundID;
            if( GetEQ(spgr) == true )               
               if( Delete( spgr ) == false )
                  gOperData.MakeError( "Ошибка: ошибка при удалении в dspground_dbt записи о договоре по сделке неттинга" );
                  ЗанестиЗаписьВПротокол(667, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в dspground_dbt записи о договоре по сделке неттинга", gOperData.T_INSTANCEDATE);
                  AbortTrn;
               end;
            end;

            if( Delete( spgrdoc ) == false )
               gOperData.MakeError( "Ошибка: ошибка при удалении в dspgrdoc_dbt записи о привязке договора к сделке неттинга" );
               ЗанестиЗаписьВПротокол(668, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в dspgrdoc_dbt записи о привязке договора к сделке неттинга", gOperData.T_INSTANCEDATE);
               AbortTrn;
            end;

            ret = next(spgrdoc);
         end;
      end;

      /*платежи и лоты, если они есть*/
	  SQL = "SELECT rq.t_ID FROM DDLRQ_DBT rq WHERE rq.t_DocKind = " +string(DL_NTGDOC)+ " AND rq.t_DocID =  " +string(nett.NettingID);
      cmd = RsdCommand( SQL);
      rs = RsdRecordSet(cmd);
	  while(rs.MoveNext())
         if( gOperData.DeleteDemands == false )

            gOperData.MakeError( "Ошибка: удаление прервано, так как есть привязанные к сделке неттинга платежи" );
            ЗанестиЗаписьВПротокол(645, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: удаление прервано, так как есть привязанные к сделке неттинга платежи", gOperData.T_INSTANCEDATE);
            AbortTrn;
         else
            DemandData = TDemandData;
            DemandData.T_DEMANDID   =  rs.value("T_ID");
            if( nett.FI_Kind !=  FIKIND_AVOIRISS )
               DemandData.T_KIND =  70; /*по ценным бумагам*/
            else
               DemandData.T_KIND =  60; /*по валюте*/
            end;
            DemandData.InTrn  = true;
            if( ОбработатьТребование( DemandData, 3 /*удаление*/, gOperData.Error ) == false )
               ЗанестиЗаписьВПротокол(645, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка при удалении привязанных платежей", gOperData.T_INSTANCEDATE);
               DemandData.PrintErrors();
               AbortTrn;
            else
               DemandData.PrintErrors();  /*распечатка некритичных ошибок*/
            end;
         end;
      end;

      if( Delete( nett ) == false )
         gOperData.MakeError( "Ошибка: ошибка при удалении в ddl_nett_dbt" );
         ЗанестиЗаписьВПротокол(646, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в ddl_nett_dbt", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;
   else
      gOperData.MakeError( "Ошибка: неверный вид выполняемого действия: " + string( gOperData.Action ) ); 
      ЗанестиЗаписьВПротокол(530, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: неверный вид выполняемого действия", gOperData.T_INSTANCEDATE);
      AbortTrn;
   end;
END;

/*обработка операций, хранящихся в DL_TICK и связанных с ней базах*/
MACRO ProcessDL_TICK()
   var   MarketCode:string =  "";
   var   IsWrongParms:bool =  false;
   var   ret:bool          =  true;
   var   CatErr:integer    =  0;
   var   SetCatID:integer  =  0;
   var   strcmd:string     =  "";
   var   sqlQuery:string = "", DataSet;
   var   CurNominal:money = $0;
   var   IsoCode;
   var   DemandData:TDemandData;
   var   CatID, CatName, rez;
   var    pcm;
   var   IsKSU = FI_IsKSU(gOperData.T_AvoirissID);

   /*чистим используемые структуры*/
   ClearRecord( deal );

   leg1.Clear();
   if( gOperData.ExistBack )
      leg2.Clear();
   end;

   if( (gOperData.T_CODE == null) OR (gOperData.T_CODE == "")   )
      gOperData.MakeError("Ошибка: не задан параметр T_CODE - код сделки" );
      ЗанестиЗаписьВПротокол(539, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_CODE - код сделки", gOperData.T_INSTANCEDATE);
      AbortTrn;
   end;

   deal.DealCode     = gOperData.T_CODE;
   deal.BofficeKind  = gOperData.BofficeKind;

   /* вставка   */
   if( gOperData.Action == 1 ) 
      sqlQuery =  "  SELECT /*+ INDEX(deal DDL_TICK_DBT_IDX1) */ count(1) as QuontDeals " +
                  "  FROM ddl_tick_dbt deal " +             
                  "  WHERE  deal.T_BOFFICEKIND = "  +  string(gOperData.BofficeKind) + " AND deal.T_DEALCODE = '" + gOperData.T_CODE + "'";
      DataSet = TRsbDataSet( sqlQuery );

      if( DataSet.MoveNext() AND (DataSet.QuontDeals > 0) )
         gOperData.OperExist = true;   
      else
         gOperData.OperExist = false;   
      end;
   /* обновление - удаление */
   else 
      /*спозиционируемся на записях сделки для обновления\удаления*/
      if( (gOperData.T_DEALID != null) AND (gOperData.T_DEALID > 0) )
         KeyNum( deal, 0 );
         deal.DealID   = gOperData.T_DEALID;  
      end;

      if( GetEQ( deal ) )
         gOperData.OperExist = true;   
         gOperData.OperGroup = GetOpGroup( deal ); 
         gOperData.StrUniID = string( UniID(deal, OBJTYPE_SECDEAL) );

         if( gOperData.Action == 2 )
            /* при обновлении не совпадают переданный вид сделки и вид сделки уже введенной в целевую систему  */
            /* выполним проверки - такое возможно только для случая трансформации займа в РЕПО                 */

            if( deal.BofficeKind != gOperData.BofficeKind )
               gOperData.MakeError("Ошибка: при обновлении не совпадает переданный вид первичного документа сделки с таковым уже введенной сделки" );
               ЗанестиЗаписьВПротокол(647, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: при обновлении не совпадает переданный вид первичного документа сделки с таковым уже введенной сделки", gOperData.T_INSTANCEDATE);
               AbortTrn;   
            end;

            /* проверяем необходимость трансформации займа в операцию РЕПО*/
            if( (IsLOAN( gOperData.OperGroup )) AND ((gOperData.T_KIND == 30) OR (gOperData.T_KIND == 40)) )
               if( IsBUY(gOperData.OperGroup) AND (gOperData.T_KIND != 30) )
                  gOperData.MakeError("Предупреждение: сделку \"Займ, привлечение\" нельзя трансформировать в \"РЕПО, продажа\" " );
                  ЗанестиЗаписьВПротокол(648, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: сделку 'Займ, привлечение' нельзя трансформировать в 'РЕПО, продажа'", gOperData.T_INSTANCEDATE);
               end;
               if( IsSALE(gOperData.OperGroup) AND (gOperData.T_KIND != 40) )
                  gOperData.MakeError("Предупреждение: сделку \"Займ, размещение\" нельзя трансформировать в \"РЕПО, покупка\" " );
                  ЗанестиЗаписьВПротокол(649, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: сделку 'Займ, размещение' нельзя трансформировать в 'РЕПО, покупка'", gOperData.T_INSTANCEDATE);
               end;
               gOperData.LoanToRepo = true;               
            end;
         end;

         leg1.KeyNum(0);
         leg1.rec.LegKind   =  LEG_KIND_DL_TICK;
         leg1.rec.DealID    =  deal.DealID;
         leg1.rec.LegID     =  0;       
         if( leg1.GetEQ() == false )
            gOperData.MakeError("Ошибка: не найдена запись с условиями сделки (ddl_leg_dbt)");
            ЗанестиЗаписьВПротокол(650, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена запись с условиями сделки (ddl_leg_dbt)", gOperData.T_INSTANCEDATE);
            AbortTrn;                    
         end;
         /*если надо, ищем обратную часть, при трансформации из займа в РЕПО не ищем, так как обратной части еще нет*/
         if( (gOperData.ExistBack) AND (gOperData.LoanToRepo == false) )
            leg2.KeyNum(0);
            leg2.rec.LegKind   =  LEG_KIND_DL_TICK_BACK;
            leg2.rec.DealID    =  deal.DealID;
            leg2.rec.LegID     =  0;       
            if( leg2.GetEQ() == false )
               gOperData.MakeError("Ошибка: не найдена запись с условиями второй части сделки (ddl_leg_dbt)");
               ЗанестиЗаписьВПротокол(651, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена запись с условиями второй части сделки (ddl_leg_dbt)", gOperData.T_INSTANCEDATE);
               AbortTrn;                    
            end;
         end;
      end;
   end;

   if( IsWrongParms == false )
      if( gOperData.Action  == 1  )  /* вставка   */
         if( gOperData.OperExist )
            gOperData.MakeError("Ошибка: сделка уже существует в целевой системе");
            ЗанестиЗаписьВПротокол(421, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: сделка уже существует в целевой системе", gOperData.T_INSTANCEDATE);            
            AbortTrn; 
         end;
         deal.DealID = 0;
      elif( gOperData.Action  == 2  )  /* изменение */
         if( gOperData.OperExist == false )
            gOperData.MakeError("Ошибка: сделка не найдена в целевой системе");
            ЗанестиЗаписьВПротокол(422, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: сделка не найдена в целевой системе", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;
      elif( gOperData.Action  == 3  )  /* удаление  */
         if( gOperData.OperExist == false )
            gOperData.MakeError("Ошибка: сделка уже удалена в целевой системе");
            ЗанестиЗаписьВПротокол(423, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: сделка уже удалена в целевой системе", gOperData.T_INSTANCEDATE);
            AbortTrn;        
         end;
      else
         gOperData.MakeError( "Ошибка: неверный вид выполняемого действия: " + string( gOperData.Action ) ); 
         ЗанестиЗаписьВПротокол(530, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: неверный вид выполняемого действия", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;

      /*для обновления и удаления должен быть задан T_DEALID*/
      if( (gOperData.Action  == 2) OR (gOperData.Action == 3) )
         if( (gOperData.T_DEALID == null) OR (gOperData.T_DEALID <= 0) )
            gOperData.MakeError("Ошибка: не найдена сделка" );
            ЗанестиЗаписьВПротокол(540, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена сделка", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else
            if( gOperData.T_DEALID != deal.DealID )
               gOperData.MakeError("Ошибка: не совпадают идентификаторы сделки, переданный T_DEALID и в системе ddl_tick.dbt.t_DealID ");
               ЗанестиЗаписьВПротокол(541, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не совпадают идентификаторы сделки, переданный T_DEALID и в системе ddl_tick.dbt.t_DealID", gOperData.T_INSTANCEDATE);
               AbortTrn;         
            end;
         end;
      end;
   end;

   /*инициализация данных операции для вставки\изменения*/
   if( (IsWrongParms == false) AND ((gOperData.Action == 1) OR (gOperData.Action == 2)) )
      deal.DealStatus   =  DL_READIED;
      deal.Oper         =  {oper};
      deal.PartyID      =  -1;   
      deal.BrokerID     =  -1;   
      deal.ClientID     =  -1;   
      deal.TraderID     =  -1;   
      deal.DepositID    =  -1;   
      deal.MarketID     =  -1;   
      deal.Points       =  4;

      if( gOperData.IsLOAN == true )
         //deal.PortfolioID = KINDPORT_LOAN; // !?
      else
         /* по умолчанию торговый, но ниже возможно переопределится в инвестиционный, если ц/б некотируемая*/
         deal.PortfolioID  =  KINDPORT_TRADE;
         if( gOperData.ExistBack )
            deal.PortfolioID_2   = KINDPORT_TRADE;
         end;
      end;

      deal.BuyGoal = BUYGOAL_RESALE;
   
      if( gOperData.T_KIND == 10 )
         if( gOperData.IsMarketOper )
            deal.DealType  =  2143; /* покупка биржевая     */
         else
            deal.DealType  =  2183; /* покупка внебиржевая  */
         end;
      elif( gOperData.T_KIND == 20 )
         if( gOperData.IsMarketOper )
            deal.DealType  =  2153; /* продажа биржевая     */
         else
            deal.DealType  =  2193; /* продажа внебиржевая  */
         end;
      elif( gOperData.T_KIND == 30 )
         if( gOperData.IsMarketOper )
            if( IsKSU )
               deal.DealType = 2123;   /* репо покупка биржевая КСУ*/
            else
               deal.DealType = 2122;   /* репо покупка биржевая*/
            end;
         else
            deal.DealType = 2132;   /* репо покупка внебиржевая*/
         end;
      elif( gOperData.T_KIND == 40 )
         if( gOperData.IsMarketOper )
            if( IsKSU )
               deal.DealType = 2128;   /* репо продажа биржевая КСУ*/
            else
               deal.DealType = 2127;   /* репо продажа биржевая*/
            end;
         else
            deal.DealType = 2137;   /* репо продажа внебиржевая*/
         end;
      elif( gOperData.T_KIND == 50 )
         deal.DealType = 2195;   /* займ - привлечение*/
         gOperData.IsLOAN = true;
      elif( gOperData.T_KIND == 60 )
         deal.DealType = 2197;      /* займ - размещение */
         gOperData.IsLOAN = true;
      elif( gOperData.T_KIND == 70 )
         deal.DealType = 2021;   /* погашение выпуска  */
      elif( gOperData.T_KIND == 80 )
         deal.DealType = 2022;   /* погашение купона  */   
      elif( gOperData.T_KIND == 90 )
         deal.DealType = 2027;   /* погашение облигации частичное*/
      elif( gOperData.T_KIND == 100 )
         deal.DealType = 2105; 
      end;

      //----------- РЕПО с корзиной -----------------------------
      if (gOperData.T_AVOIRISSID == -20) 
         sqlQuery = "SELECT T_FIID FICTFI FROM DFININSTR_DBT WHERE t_name like 'Корзина с%'";
         DataSet = TRsbDataSet( sqlQuery );
         if (DataSet.MoveNext())
            gOperData.T_AVOIRISSID = DataSet.FICTFI;
         else
            gOperData.T_AVOIRISSID = 2192;
         end;

         gOperData.ISBASKET = true; 

         if  (( deal.DealType == 2122 ) OR (deal.DealType = 2132))
            deal.DealType = 2139; // 2134; // обратное РЕПО на корзину
         elif(( deal.DealType == 2127 ) OR (deal.DealType = 2137))
            deal.DealType = 2139; // прямое РЕПО на корзину
         else  ЗанестиЗаписьВПротокол(542, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: неверный тип операции с корзиной ц/б, ожидается РЕПО.", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;

         deal.DealType = 2139;  // прямое репо на корзину.
		 
         leg1.rec.Registrar = leg2.rec.Registrar = SP_GetPartyID( GetTWsPartyExByID( ПолучитьКодСубъекта( GetSecurNRDCode(), PTCK_CONTR ) ) ); 
         if( leg1.rec.Registrar > 0 )
            leg1.rec.RegistrarContrID = SP_GetContrID( DL_GetClientContrByPartyID( gOperData.T_DATE, leg1.rec.Registrar, PTSK_STOCKDL ) );
         end;
      end;
      //---------------------------------------------------------
   
      deal.DealCodeTS = gOperData.T_EXTCODE;
      deal.DealCode  =  gOperData.T_CODE;
      deal.RegDate   =  deal.DealDate  =  gOperData.T_DATE;
      deal.DealTime  =  gOperData.T_TIME;
      deal.CloseDate =  gOperData.T_CLOSEDATE;
      deal.TypeDoc   =  gOperData.T_TSKIND;
      /*KD добавляем данные о стране заключения сделки и в тикет сделки.*/
      if( ( gOperData.T_COUNTRY != null ) and (gOperData.T_COUNTRY != 643) )
         deal.country = GetCodeCountry(gOperData.T_COUNTRY);
      end;

      if( gOperData.IsMarketOper )
         deal.flag1 = "X";
      end;

      if( gOperData.T_ACCOUNTTYPE == 1 )
         leg1.rec.Formula = 50 /*"DVP"*/; 
      elif( gOperData.T_ACCOUNTTYPE == 2 )
         leg1.rec.Formula = 49 /*"DFP"*/; 
      elif( gOperData.T_ACCOUNTTYPE == 3 )
         leg1.rec.Formula = 52 /*"PP"*/; 
      elif( gOperData.T_ACCOUNTTYPE == 4 )
         leg1.rec.Formula = 51 /*"PD"*/; 
      end;

      if( (gOperData.T_MARKETID != null) AND (gOperData.T_MARKETID > 0) )  
         if( gOperData.T_MARKETID == {OurBank} )
            gOperData.MakeError("Ошибка: неверно задан параметр T_MARKETID, наш банк не может быть биржой");
            ЗанестиЗаписьВПротокол(542, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: неверно задан параметр T_MARKETID, наш банк не может быть биржой", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else
            if( Кэш_ПолучитьСубъекта( gOperData.T_MARKETID ) == true )
               if( ВидСубъекта( gOperData.T_MARKETID, PTK_MARKETPLASE ) == true )
                  deal.MarketID =   gOperData.T_MARKETID;
               else
                  if( ЗадатьСубъектуВид( gOperData.T_MARKETID, PTK_MARKETPLASE ) != true )
                     gOperData.MakeError("Ошибка: ошибка при добавлениии субъекту с T_MARKETID = " + string(gOperData.T_MARKETID) + " вида - биржа");
                     ЗанестиЗаписьВПротокол(652, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при добавлениии субъекту вида - биржа", gOperData.T_INSTANCEDATE);
                     IsWrongParms = true;
                  else
                     deal.MarketID =  gOperData.T_MARKETID;
                  end;
               end;

               if( deal.MarketID > 0 )   
                  MarketCode = Кэш_ПолучитьКодСубъекта( deal.MarketID );

                  if( (gOperData.T_SECTOR != null) AND (gOperData.T_SECTOR > 0) )
                     if( ПолучитьНаименованиеСектора( deal.MarketID, gOperData.T_SECTOR ) == "" )
                        gOperData.MakeError("Ошибка: не найден сектор биржи с T_SECTOR = " + string(gOperData.T_SECTOR) + " для биржи " + MarketCode );
                        ЗанестиЗаписьВПротокол(543, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найден сектор биржи", gOperData.T_INSTANCEDATE);
                        IsWrongParms = true;
                     else
                        deal.MarketOfficeID = gOperData.T_SECTOR;
                     end;
                  else
                     gOperData.MakeError("Ошибка: не найден сектор биржи" );
                     ЗанестиЗаписьВПротокол(544, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найден сектор биржи", gOperData.T_INSTANCEDATE);
                     IsWrongParms = true;
                  end;
               end;
            else
               gOperData.MakeError("Ошибка: не найден субъект с T_MARKETID = " + string(gOperData.T_MARKETID) );
               ЗанестиЗаписьВПротокол(534, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найден субъект", gOperData.T_INSTANCEDATE);
               IsWrongParms = true;
            end;
         end;
      end; 

      if( (gOperData.T_BROKERID != null) AND (gOperData.T_BROKERID > 0) )  
         if( gOperData.T_BROKERID == {OurBank} )
            gOperData.MakeError("Предупреждение: неверно задан параметр T_BROKERID, наш банк не может быть брокером");
            ЗанестиЗаписьВПротокол(545, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: неверно задан параметр T_BROKERID, наш банк не может быть брокером", gOperData.T_INSTANCEDATE);
         else
            if( Кэш_ПолучитьСубъекта( gOperData.T_BROKERID ) == true )
               if( ВидСубъекта( gOperData.T_BROKERID, PTK_BROKER ) == true )
                  deal.BrokerID =  gOperData.T_BROKERID;
               else
                  if( ЗадатьСубъектуВид( gOperData.T_BROKERID, PTK_BROKER ) != true )
                     gOperData.MakeError("Ошибка: ошибка при добавлениии субъекту с T_BROKERID = " + string(gOperData.T_PARTYID) + " вида - брокер");
                     ЗанестиЗаписьВПротокол(653, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при добавлениии субъекту вида - брокер", gOperData.T_INSTANCEDATE);
                     IsWrongParms = true;
                  else
                     deal.BrokerID =  gOperData.T_BROKERID;
                  end;
               end;
            else
               gOperData.MakeError("Ошибка: не найден субъект с T_BROKERID = " + string(gOperData.T_BROKERID) );
               ЗанестиЗаписьВПротокол(534, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найден субъект", gOperData.T_INSTANCEDATE);
               IsWrongParms = true;
            end;
         end;
      end; 

      party.Clear(); 
      party.rec.PartyID = -1;

      if( (gOperData.T_PARTYID != null) AND (gOperData.T_PARTYID > 0) )
         if(( gOperData.T_PARTYID == {OurBank} ) and ( gOperData.T_KIND != 70 ) and ( gOperData.T_KIND != 80 ) and ( gOperData.T_KIND != 90 ))
            gOperData.MakeError("Предупреждение: неверно задан параметр T_PARTYID, наш банк не может быть контрагентом");
            ЗанестиЗаписьВПротокол(546, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: неверно задан параметр T_PARTYID, наш банк не может быть контрагентом", gOperData.T_INSTANCEDATE);
         else
            if( Кэш_ПолучитьСубъекта( gOperData.T_PARTYID ) == true )
               party.rec.PartyID = gOperData.T_PARTYID; 

               if( ВидСубъекта( gOperData.T_PARTYID, PTK_CONTR ) == true )
                  deal.PartyID =  gOperData.T_PARTYID;
               else
                  if( ЗадатьСубъектуВид( gOperData.T_PARTYID, PTK_CONTR ) != true )
                     gOperData.MakeError("Ошибка: ошибка при добавлениии субъекту с T_PARTYID = " + string(gOperData.T_PARTYID) + " вида - контрагент по сделкам");
                     ЗанестиЗаписьВПротокол(654, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при добавлениии субъекту вида - контрагент по сделкам", gOperData.T_INSTANCEDATE);
                     IsWrongParms = true;
                  else
                     deal.PartyID =  gOperData.T_PARTYID;
                  end;
               end;
            else
               gOperData.MakeError("Ошибка: не найден субъект с T_PARTYID = " + string(gOperData.T_PARTYID) );
               ЗанестиЗаписьВПротокол(534, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найден субъект", gOperData.T_INSTANCEDATE);
               IsWrongParms = true;
            end;
         end;

      else
         if( gOperData.IsMarketOper == false )
            gOperData.MakeError("Ошибка: для внебиржевой сделки не найден контрагент, параметр T_PARTYID" );
            ЗанестиЗаписьВПротокол(547, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: для внебиржевой сделки не найден контрагент, параметр T_PARTYID", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;
      end; 

      if( (gOperData.T_DEPARTMENT != null) AND (gOperData.T_DEPARTMENT > 0) ) 
         deal.Department = gOperData.T_DEPARTMENT;
      else
         deal.Department = {OperDprt};
      end;

      if( (gOperData.T_AVOIRISSID != null) AND (gOperData.T_AVOIRISSID > 0) )
         sqlQuery =  "  SELECT av.T_ISIN " +
                     "  FROM dfininstr_dbt fi, davoiriss_dbt av  " +             
                     "  WHERE  fi.T_FIID = "  +  string(gOperData.T_AVOIRISSID) + " AND av.T_FIID = fi.T_FIID" ;
         DataSet = TRsbDataSet( sqlQuery );

         if( not DataSet.MoveNext() )
            gOperData.MakeError("Ошибка: не найдена ценная бумага с T_AVOIRISSID = " + string(gOperData.T_AVOIRISSID) );
            ЗанестиЗаписьВПротокол(536, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена ценная бумага", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else
            deal.PFI          = gOperData.T_AVOIRISSID;
            avoiriss.rec.FIID = gOperData.T_AVOIRISSID;
            leg1.rec.PFI          = gOperData.T_AVOIRISSID;

            /*если бумага - облигация и операция НЕ погашение, взводим признак того, что цена задана в процентах от номинала*/
            if( (Кэш_БумагаОблигация(gOperData.T_AVOIRISSID)) AND (gOperData.BofficeKind != DL_RETIREMENT) )
               leg1.rec.RelativePrice = SET_CHAR;

               if( gOperData.ExistBack )
                  leg2.rec.RelativePrice = SET_CHAR;
               end;
            end;

            /*если это не операция займа, переопределим тип портфеля в зависимости от котируемости бумаг*/
            if( gOperData.IsLOAN != true ) 
               if( Кэш_ПолучитьКотируемостьБумаги( avoiriss, deal.DealDate ) )
                  deal.PortfolioID  =  KINDPORT_TRADE;
                  if( gOperData.ExistBack )
                     deal.PortfolioID_2   = KINDPORT_TRADE;
                  end;
               else
                  deal.PortfolioID  =  KINDPORT_INVEST;
                  if( gOperData.ExistBack )
                     deal.PortfolioID_2   = KINDPORT_INVEST;
                 end;
               end;
            end;

            if( gOperData.ExistBack )
               leg2.rec.PFI = gOperData.T_AVOIRISSID;
            end;

            if(gOperData.T_KIND == 80)  
               if( ( (gOperData.T_WARRANTID == null) OR (gOperData.T_WARRANTID <= 0)) )
                  gOperData.MakeError("Ошибка: для сделки погашения купона не найден купон" );
                  ЗанестиЗаписьВПротокол(548, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: для сделки погашения купона не найден купон", gOperData.T_INSTANCEDATE);
                  IsWrongParms = true;
               else
                  if( ПроверитьНаличиеКупона( gOperData.T_AVOIRISSID, string(gOperData.T_WARRANTID), UNSET_CHAR  ) == false )
                     gOperData.MakeError("Ошибка: не найден купон с T_WARRANTID = " + string( gOperData.T_WARRANTID ) + " для ценной бумаги " + string(DataSet.ISIN) );
                     ЗанестиЗаписьВПротокол(549, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найден купон", gOperData.T_INSTANCEDATE);
                     IsWrongParms = true;
                  else
                     deal.number_coupon = НомерКупонаИлиЧП( gOperData.T_AVOIRISSID, string(gOperData.T_WARRANTID), UNSET_CHAR  );
                  end;
               end;           
            end;

            if( gOperData.T_KIND == 90 )   
               if( ((gOperData.T_PARTIALID == null) OR (gOperData.T_PARTIALID <= 0)) )
                  gOperData.MakeError("Ошибка: для сделки частичного погашения облигации не найдено частичное погашение" );
                  ЗанестиЗаписьВПротокол(550, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: для сделки частичного погашения облигации не найдено частичное погашение", gOperData.T_INSTANCEDATE);
                  IsWrongParms = true;
               else
                  if( ПроверитьНаличиеКупона( gOperData.T_AVOIRISSID, string(gOperData.T_PARTIALID), SET_CHAR ) == false )
                     gOperData.MakeError("Ошибка: не найдено частичное погашение с T_PARTIALID = " + string( gOperData.T_PARTIALID ) + " для ценной бумаги " + string(DataSet.ISIN) );
                     ЗанестиЗаписьВПротокол(551, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдено частичное погашение", gOperData.T_INSTANCEDATE);
                     IsWrongParms = true;
                  else
                     deal.number_partly = НомерКупонаИлиЧП( gOperData.T_AVOIRISSID, string(gOperData.T_PARTIALID), SET_CHAR  );
                  end;  
               end;
            end;
         end;
      else
         gOperData.MakeError("Ошибка: не найдена ценная бумага" );
         ЗанестиЗаписьВПротокол(552, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена ценная бумага", gOperData.T_INSTANCEDATE);
         IsWrongParms = true;
      end;

      if( (gOperData.T_AMOUNT != null) AND (gOperData.T_AMOUNT > $0) )
         leg1.rec.PRINCIPAL = gOperData.T_AMOUNT;

         if( gOperData.ExistBack )
            leg2.rec.PRINCIPAL = gOperData.T_AMOUNT;
         end;
      else
         gOperData.MakeError("Ошибка: не задан параметр T_AMOUNT - количество ценных бумаг" );
         ЗанестиЗаписьВПротокол(553, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_AMOUNT - количество ценных бумаг", gOperData.T_INSTANCEDATE);
         IsWrongParms = true;
      end;

      if( gOperData.T_CURRENCYID != null )
         sqlQuery =  "  SELECT count(1) as QuontFins " +
                     "  FROM dfininstr_dbt fi  " +             
                     "  WHERE  fi.T_FIID = "  +  string(gOperData.T_CURRENCYID);
         DataSet = TRsbDataSet( sqlQuery );

         if( (not DataSet.MoveNext()) OR (DataSet.QuontFins <= 0) )
            gOperData.MakeError("Ошибка: не найдена валюта сделки с gOperData.T_CURRENCYID = " + string(gOperData.T_CURRENCYID) );
            ЗанестиЗаписьВПротокол(554, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена валюта сделки", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else
            leg1.rec.CFI = gOperData.T_CURRENCYID;
         end;       
      else
         gOperData.MakeError("Ошибка: не найдена валюта сделки" );
         ЗанестиЗаписьВПротокол(555, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена валюта сделки", gOperData.T_INSTANCEDATE);
         IsWrongParms = true;
      end;

      if( gOperData.T_NKDFIID != -1 )
         sqlQuery =  "  SELECT count(1) as QuontFins " +
                     "  FROM dfininstr_dbt fi  " +             
                     "  WHERE  fi.T_FIID = "  +  string(gOperData.T_NKDFIID);
         DataSet = TRsbDataSet( sqlQuery );

         if( (not DataSet.MoveNext()) OR (DataSet.QuontFins <= 0) )
            gOperData.MakeError("Ошибка: не найдена валюта НКД  gOperData.T_NKDFIID = " + string(gOperData.T_CURRENCYID) );
            ЗанестиЗаписьВПротокол(554, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена валюта НКД", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else
            leg1.rec.NKDFIID = gOperData.T_NKDFIID;
         end;       
      else
         sqlQuery =  "  SELECT t_facevaluefi as fi from dfininstr_Dbt where t_fiid =  " + string(gOperData.T_AVOIRISSID);
         DataSet = TRsbDataSet( sqlQuery );
         if (DataSet.MoveNext())
            leg1.rec.NKDFIID = DataSet.FI;
         else
            gOperData.MakeError("Ошибка: не найдена валюта НКД" );
            ЗанестиЗаписьВПротокол(555, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена валюта НКД", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;
      end;

      /*KD заполняем пока валютой цены*/
      leg1.rec.PAYFIID = gOperData.T_CURRENCYID;

      if( ((gOperData.T_PRICE == null ) OR (gOperData.T_PRICE == $0)) AND 
          ((gOperData.T_TOTALCOST == null ) OR (gOperData.T_TOTALCOST == $0)) AND
          ((gOperData.T_COST == null ) OR (gOperData.T_COST == $0))
      )
         gOperData.IsJudicialOper = true;  /*передача бумаг по решению суда, общая стоимость и цена могут быть нулевые*/
      else
         gOperData.IsJudicialOper = false;
      end;

      if( (gOperData.T_PRICE != null ) AND (gOperData.T_PRICE > $0) )
         leg1.rec.Price = gOperData.T_PRICE;
      else
         if( gOperData.IsJudicialOper == false )
            if ((gOperData.T_KIND != 70) and (gOperData.T_KIND != 80) and
              (gOperData.T_KIND != 90) and (gOperData.T_KIND != 100) and (gOperData.T_KIND != 110))
              gOperData.MakeError("Ошибка: не задан параметр T_PRICE - цена за шт. ценной бумаги, не включая НКД" );
              ЗанестиЗаписьВПротокол(556, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_PRICE - цена за шт. ценной бумаги, не включая НКД", gOperData.T_INSTANCEDATE);
              IsWrongParms = true;
            end;
         end;
      end;

      /*для погашений облигации, купонов облигации цена определяется иначе!*/
      if( (gOperData.BofficeKind == DL_RETIREMENT) AND (Кэш_БумагаОблигация(gOperData.T_AVOIRISSID) == true) )
         /*полное и частичное поагашение, цена = текущий номинал*/
         if( (gOperData.T_KIND == 70) OR (gOperData.T_KIND == 90) )
            if( FI_GetNominal(leg1.rec.PFI, CurNominal) != 0 )
               leg1.rec.Price = $0;
               gOperData.MakeError("Не определена величина номинала ц/б" );
            else
               leg1.rec.Price = CurNominal;
            end;
         /*погашение купона, цена = $0 */
         elif( gOperData.T_KIND == 80 )
            leg1.rec.Price = $0;
         end;
      end;

      leg1.rec.Scale = 1;
      if( (gOperData.T_POINT != null) AND (gOperData.T_POINT > 0) )
         leg1.rec.Point = gOperData.T_POINT;
      else
         leg1.rec.Point = 4; /*по-умолчанию*/
      end;

      if( (gOperData.T_COST != null) AND (gOperData.T_COST >= $0) ) /* >= так как в операции погашения купона T_COST может быть нулевым*/
         leg1.rec.Cost = gOperData.T_COST;
         FI_GetNominal(leg1.rec.PFI, CurNominal);
         if( gOperData.IsJudicialOper == false )
            if (leg1.rec.RelativePrice == SET_CHAR)
               if (Round(gOperData.T_COST) != Round((gOperData.T_PRICE * CurNominal)/100 * gOperData.T_AMOUNT)) /* ввели округление до копеек перед проверкой */
                  /* Если цена относительная - домножаем на номинал бумаги. */
                  gOperData.MakeError("Предупреждение: стоимость (T_COST) не равна произведению цены (T_PRICE) в валюте на количество бумаг (T_AMOUNT)" );
                  ЗанестиЗаписьВПротокол(655, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: стоимость (T_COST) не равна произведению цены (T_PRICE) в валюте на количество бумаг (T_AMOUNT)", gOperData.T_INSTANCEDATE);
               end;
            else
               if (Round(gOperData.T_COST) != Round(gOperData.T_PRICE * gOperData.T_AMOUNT)) /* ввели округление до копеек перед проверкой */
                  gOperData.MakeError("Предупреждение: стоимость (T_COST) не равна произведению цены (T_PRICE) на количество бумаг (T_AMOUNT)" );
                  ЗанестиЗаписьВПротокол(655, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: стоимость (T_COST) не равна произведению цены (T_PRICE) на количество бумаг (T_AMOUNT)", gOperData.T_INSTANCEDATE);
               end;
            end;
         end;
      else
         if( gOperData.IsJudicialOper == false )
            gOperData.MakeError("Ошибка: не задан параметр T_COST - стоимость ценных бумаг без НКД" );
            ЗанестиЗаписьВПротокол(557, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_COST - стоимость ценных бумаг без НКД", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;
      end;
 
      if( gOperData.T_NKD != null )
         leg1.rec.NKD = gOperData.T_NKD;
      end;

      if( (gOperData.T_TOTALCOST != null) AND (gOperData.T_TOTALCOST > $0) )
         leg1.rec.TotalCost = gOperData.T_TOTALCOST;
      else
         if ((gOperData.IsJudicialOper == false) and ( gOperData.t_kind != 70 ))
            gOperData.MakeError("Ошибка: не задан параметр T_TOTALCOST - общая сумма сделки вкл. НКД в валюте сделки" );
            ЗанестиЗаписьВПротокол(558, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_TOTALCOST - общая сумма сделки вкл. НКД в валюте сделки", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         elif ((gOperData.IsJudicialOper == false) and ( gOperData.t_kind == 70 ))
            gOperData.MakeError("Предупреждение: не задан параметр T_TOTALCOST - общая сумма сделки вкл. НКД в валюте сделки" );
            ЗанестиЗаписьВПротокол(558, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: не задан параметр T_TOTALCOST - общая сумма сделки вкл. НКД в валюте сделки", gOperData.T_INSTANCEDATE);
         end;
      end;

      if( gOperData.T_RATE != null )
         leg1.rec.IncomeRate = gOperData.T_RATE;
      end;

      leg1.rec.IncomeScale = 1;
      leg1.rec.IncomePoint = 2;

      if( gOperData.IsLOAN == true ) /*для займов*/
         if( (gOperData.T_SUPLDATE != null) AND (gOperData.T_SUPLDATE2 != null) ) 
            leg1.rec.MaturityIsPrincipal   = SET_CHAR;
            leg1.rec.Maturity              = gOperData.T_SUPLDATE; 
            leg1.rec.Expiry                = gOperData.T_SUPLDATE2; 
         else
            if( gOperData.T_SUPLDATE == null )
               gOperData.MakeError("Ошибка: не задан параметр T_SUPLDATE - плановая дата передачи\возврата в займе" );
               ЗанестиЗаписьВПротокол(559, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_SUPLDATE - плановая дата передачи/возврата в займе", gOperData.T_INSTANCEDATE);
            end;
            if( gOperData.T_SUPLDATE2 == null )
               gOperData.MakeError("Ошибка: не задан параметр T_SUPLDATE2 - плановая дата передачи\возврата в займе" );
               ЗанестиЗаписьВПротокол(560, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_SUPLDATE2 - плановая дата передачи/возврата в займе", gOperData.T_INSTANCEDATE);
            end;
            IsWrongParms = true;
         end;

         /* так как в займе нет второго dl_leg,  */   
         /* для займов вторая сумма НКД заносится в специфическое поле - ReceiptAmount */
         if( gOperData.T_NKD2 != null )
            leg1.rec.ReceiptAmount = gOperData.T_NKD2;
         end;
      elif ((gOperData.T_KIND == 80) or (gOperData.T_KIND == 90)) /*для дляпогашений и ЧП*/      
         leg1.rec.MaturityIsPrincipal = SET_CHAR;
         leg1.rec.Expiry = gOperData.T_BALANCEDATE;
         leg1.rec.Maturity = gOperData.T_BALANCEDATE; 
      else /*для остальных видов операций*/      
         if( (gOperData.T_SUPLDATE != null) AND (gOperData.T_PAYDATE != null) )
            if( gOperData.T_SUPLDATE < gOperData.T_PAYDATE  )
               leg1.rec.MaturityIsPrincipal = SET_CHAR;
            else
               leg1.rec.MaturityIsPrincipal = UNSET_CHAR;
            end;

            if( gOperData.T_SUPLDATE >= gOperData.T_PAYDATE )
               leg1.rec.Expiry = gOperData.T_SUPLDATE; 
            else
               leg1.rec.Expiry = gOperData.T_PAYDATE; 
            end;

            if( gOperData.T_SUPLDATE <= gOperData.T_PAYDATE )
               leg1.rec.Maturity = gOperData.T_SUPLDATE;
            else
               leg1.rec.Maturity = gOperData.T_PAYDATE;
            end;
         else
            if( gOperData.T_SUPLDATE == null )
               gOperData.MakeError("Ошибка: не задан параметр T_SUPLDATE - плановая дата поставки в сделках" );
               ЗанестиЗаписьВПротокол(561, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_SUPLDATE - плановая дата поставки в сделках", gOperData.T_INSTANCEDATE);
            end;
            if( gOperData.T_PAYDATE == null )
               gOperData.MakeError("Ошибка: не задан параметр T_PAYDATE - плановая дата оплаты в сделках" );
               ЗанестиЗаписьВПротокол(562, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_PAYDATE - плановая дата оплаты в сделках", gOperData.T_INSTANCEDATE);
            end;
            IsWrongParms = true;
         end;
      end;

      /* вторая часть сделки */
      if( gOperData.ExistBack )
         leg2.rec.Formula = leg1.rec.Formula;
         leg2.rec.CFI = gOperData.T_CURRENCYID;
         leg2.rec.NKDFIID = leg1.rec.NKDFIID;
         leg2.rec.PAYFIID = leg1.rec.PAYFIID;

         if( (gOperData.T_PRICE2 != null) AND (gOperData.T_PRICE2 > $0) )
            leg2.rec.Price = gOperData.T_PRICE2;
         else
            gOperData.MakeError("Ошибка: не задан параметр T_PRICE2 - цена за шт. ценной бумаги, не включая НКД по 2-ой части РЕПО" );
            ЗанестиЗаписьВПротокол(563, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_PRICE2 - цена за шт. ценной бумаги, не включая НКД по 2-ой части РЕПО", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;

         leg2.rec.Scale = leg1.rec.Scale;
         leg2.rec.Point = leg1.rec.Point;

         if( (gOperData.T_COST2 != null) AND (gOperData.T_COST2 > $0) )
            leg2.rec.Cost = gOperData.T_COST2;
            if (leg2.rec.RelativePrice == SET_CHAR)
               if (Round(gOperData.T_COST2) != Round((gOperData.T_PRICE2 * CurNominal)/100 * gOperData.T_AMOUNT)) /* ввели округление до копеек перед проверкой */
                  /* Если цена относительная - домножаем на номинал бумаги. */
                  gOperData.MakeError("Предупреждение: стоимость по второй части сделки (T_COST2) не равна произведению цены второй части сделки (T_PRICE2) на количество бумаг (T_AMOUNT)" );
                  ЗанестиЗаписьВПротокол(656, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: стоимость по второй части сделки (T_COST2) не равна произведению цены второй части сделки (T_PRICE2) на количество бумаг (T_AMOUNT)", gOperData.T_INSTANCEDATE);
               end;
            else
               if (Round(gOperData.T_COST2) != Round(gOperData.T_PRICE2 * gOperData.T_AMOUNT)) /* ввели округление до копеек перед проверкой */
                  gOperData.MakeError("Предупреждение: стоимость по второй части сделки (T_COST2) не равна произведению цены второй части сделки (T_PRICE2) на количество бумаг (T_AMOUNT)" );
                  ЗанестиЗаписьВПротокол(656, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: стоимость по второй части сделки (T_COST2) не равна произведению цены второй части сделки (T_PRICE2) на количество бумаг (T_AMOUNT)", gOperData.T_INSTANCEDATE);
               end;
            end;
         else
            gOperData.MakeError("Ошибка: не задан параметр T_COST2 - стоимость ценных бумаг без НКД по 2-ой части РЕПО" );
            ЗанестиЗаписьВПротокол(564, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_COST2 - стоимость ценных бумаг без НКД по 2-ой части РЕПО", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;

         if( gOperData.T_NKD2 != null )
            leg2.rec.NKD = gOperData.T_NKD2;
         end;   

         if( (gOperData.T_TOTALCOST2 != null) AND (gOperData.T_TOTALCOST2 > $0) )
            leg2.rec.TotalCost = gOperData.T_TOTALCOST2;
         else
            gOperData.MakeError("Ошибка: не задан параметр T_TOTALCOST2 - общая сумма сделки вкл. НКД в валюте сделки ао 2-ой части РЕПО" );
            ЗанестиЗаписьВПротокол(565, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_TOTALCOST2 - общая сумма сделки вкл. НКД в валюте сделки ао 2-ой части РЕПО", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         end;

         leg2.rec.IncomeRate   = leg1.rec.IncomeRate;
         leg2.rec.IncomeScale  = leg1.rec.IncomeScale;
         leg2.rec.IncomePoint  = leg1.rec.IncomePoint;

         if( (gOperData.T_SUPLDATE2 != null) AND (gOperData.T_PAYDATE2 != null) )
            if( gOperData.T_SUPLDATE2 < gOperData.T_PAYDATE2 ) 
               leg2.rec.MaturityIsPrincipal = SET_CHAR;
            else
               leg2.rec.MaturityIsPrincipal = UNSET_CHAR;
            end;

            if( gOperData.T_SUPLDATE2 >= gOperData.T_PAYDATE2 )
               leg2.rec.Expiry = gOperData.T_SUPLDATE2; 
            else
               leg2.rec.Expiry = gOperData.T_PAYDATE2; 
            end;

            if( gOperData.T_SUPLDATE2 <= gOperData.T_PAYDATE2 )
               leg2.rec.Maturity = gOperData.T_SUPLDATE2; 
            else
               leg2.rec.Maturity = gOperData.T_PAYDATE2;      
            end;
         else
            if( gOperData.T_SUPLDATE2 == null )
               gOperData.MakeError("Ошибка: не задан параметр T_SUPLDATE2 - плановая дата поставки в сделках" );
               ЗанестиЗаписьВПротокол(566, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_SUPLDATE2 - плановая дата поставки в сделках", gOperData.T_INSTANCEDATE);
            end;
            if( gOperData.T_PAYDATE2 == null )
               gOperData.MakeError("Ошибка: не задан параметр T_PAYDATE2 - плановая дата оплаты в сделках" );
               ЗанестиЗаписьВПротокол(567, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_PAYDATE2 - плановая дата оплаты в сделках", gOperData.T_INSTANCEDATE);
            end;
            IsWrongParms = true;
         end;
      end;
   end;

   /*некорректные входящие параметры - прерываем транзакцию*/
   if( IsWrongParms == true )
      AbortTrn;
   end;

   if( gOperData.Action == 1  )  /* вставка   */
      if( Insert( deal ) == false )
         gOperData.MakeError( "Ошибка: ошибка при вставке в ddl_tick_dbt" );
         ЗанестиЗаписьВПротокол(657, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при вставке в ddl_tick_dbt", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;

      gOperData.T_DEALID = deal.DealID;

      if (addNoteForObject (OBJTYPE_SECDEAL, UniID(deal, OBJTYPE_SECDEAL), 24, gOperData.T_BALANCEDATE, date())) /*I-Support 272941, заполнение примечания "Дата принятия к учету". UPD 01.12.2014: требование банка изменилось, теперь любую заполненную дату необходимо загружать в примечание*/
         msgbox ("Не удалось сохранить значение примечания \"Дата принятия к учету\"!|");
      end;
      
      gOperData.StrUniID = string( UniID(deal, OBJTYPE_SECDEAL) );

      leg1.rec.LegKind   =  LEG_KIND_DL_TICK;
      leg1.rec.DealID    =  deal.DealID;
      leg1.rec.LegID     =  0;
      leg1.rec.BASIS = 0;
      if( gOperData.T_REPOBASE != -1 )
         leg1.rec.BASIS = gOperData.T_REPOBASE - 1;
      end;

      if( leg1.Insert() == false )
         gOperData.MakeError( "Ошибка: ошибка при вставке в ddl_leg_dbt" );
         ЗанестиЗаписьВПротокол(658, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при вставке в ddl_leg_dbt", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;

      if( gOperData.ExistBack )
         leg2.rec.LegKind   =  LEG_KIND_DL_TICK_BACK;
         leg2.rec.DealID    =  deal.DealID;
         leg2.rec.LegID     =  0;
         leg2.rec.BASIS     = 0;
         if( gOperData.T_REPOBASE != -1 )
            leg2.rec.BASIS = gOperData.T_REPOBASE - 1;
         end;

         if( leg2.Insert() == false )
            gOperData.MakeError( "Ошибка: ошибка при вставке в ddl_leg_dbt данных по второй части сделки" );
            ЗанестиЗаписьВПротокол(659, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при вставке в ddl_leg_dbt данных по второй части сделки", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;
      end;

      /*если в параметрах заданы номер и дата договора - добавим догвоор и запись о его привязке к сделке*/
      if( (gOperData.T_CONTRNUM != null) and (gOperData.T_CONTRDATE != null) )
         ClearRecord(spgr);
         spgr.Kind            =  26;   /* договор купли/продажи   */
         spgr.DocLog          =  513;  /* виды документов БОЦБ */
         spgr.Direction       =  2;    /* исходящие   */ 
         spgr.Receptionist    =  deal.Oper;
         spgr.References      =  1;
         spgr.AltXld          =  SubStr( gOperData.T_CONTRNUM, 1, 20 ); 
         spgr.SignedDate      =  spgr.RegistrDate = gOperData.T_CONTRDATE;
         spgr.Party           =  party.rec.PartyID; /*если во входных параетрах контрагент (T_PARTYID) корректно задан, будет заполнен party.PartyID*/

         if( Insert( spgr ) == false )
            gOperData.MakeError( "Ошибка: ошибка при вставке в dspground_dbt данных по договору" );
            ЗанестиЗаписьВПротокол(660, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при вставке в dspground_dbt данных по договору", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;

         ClearRecord(spgrdoc);   
         spgrdoc.SourceDocKind = deal.BofficeKind;
         spgrdoc.SourceDocID   = deal.DealID; 
         spgrdoc.SPGroundID    = spgr.SPgroundID;
         if( Insert( spgrdoc ) == false )
            gOperData.MakeError( "Ошибка: ошибка при вставке в dspgrdoc_dbt данных по по привязке договора к сделке" );
            ЗанестиЗаписьВПротокол(661, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при вставке в dspgrdoc_dbt данных по по привязке договора к сделке", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;
      end;
   elif( gOperData.Action  == 2  )  /* изменение */
      /* вызов процедуры сохранения изменений условий в истории ОБЯЗАТЕЛЬНО должен  */
      /* выполняться ДО вызова самих процедур обновления                            */

      if( gOperData.SaveInChangeHistory == true )
         CatErr = SP_InsertSPTKCHNG( {curdate}, SPTKCHNG_CHANGE, deal, leg1, leg2, true );
         if( CatErr != 0 )
            gOperData.MakeError( "Ошибка: ошибка при добавлении записи в историю изменений сделки. Ошибка: " + string( CatErr ) );
         end;
      else
         if( Update( Deal ) == false )
            gOperData.MakeError( "Ошибка: ошибка при обновлении в ddl_tick_dbt" );
            ЗанестиЗаписьВПротокол(662, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при обновлении в ddl_tick_dbt", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;
      end;

      leg1.rec.BASIS = 0;
      if( gOperData.T_REPOBASE != -1 ) 
         leg1.rec.BASIS = gOperData.T_REPOBASE - 1;
      end;
      leg1.rec.DeliveringFIID = ALLFININSTR;
      UpdateDlLeg( leg1.rec );

      if( gOperData.ExistBack )
         if( gOperData.LoanToRepo == false )
            leg2.rec.BASIS = 0;
            if( gOperData.T_REPOBASE != -1 ) 
               leg2.rec.BASIS = gOperData.T_REPOBASE - 1;
            end;
            leg2.rec.DeliveringFIID = ALLFININSTR;
            UpdateDlLeg( leg2.rec );
         else
            /*добавляем данные по второй части РЕПО при трансформации займа в РЕПО*/
            leg2.rec.LegKind   =  LEG_KIND_DL_TICK_BACK;
            leg2.rec.DealID    =  deal.DealID;
            leg2.rec.LegID     =  0;

            if( gOperData.LoanToRepo == true )
               if( leg2.Insert() == false )
                  gOperData.MakeError( "Ошибка: выполняется трансформация займа в РЕПО. Ошибка при добавлении в ddl_leg_dbt данных по второй части сделки. " );
                  ЗанестиЗаписьВПротокол(665, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: выполняется трансформация займа в РЕПО. Ошибка при добавлении в ddl_leg_dbt данных по второй части сделки", gOperData.T_INSTANCEDATE);
                  AbortTrn;
               end;
            end;
         end;
      end;

      /*обработка снятия ранее установленного примечания "Замена ц/б", если приходит запись на обновление сделки с соответствующим признаком, то есть chavr==null*/
      if ( gOperData.T_CHAVR == date(0,0,0) )
         strcmd =  "delete from dnotetext_dbt note where note.t_ObjectType = " + string(gOperData.ObjType) + " and note.t_DocumentID = '" + gOperData.StrUniID + "' and note.t_notekind=104 ";
         execSQL(strcmd);
      end;
   elif( gOperData.Action  == 3  )  /* удаление  */
      /*удалим примечания к операции*/
      strcmd =  "delete from dnotetext_dbt note where note.t_ObjectType = " + string(gOperData.ObjType) + " and note.t_DocumentID = " + gOperData.StrUniID;
      execSQL(strcmd);

      /*удалим договора по сделке и записи привязки договоров к сделке*/
      ret = true;   
      KeyNum(spgrdoc, 1 );
      ClearRecord(spgrdoc);
      spgrdoc.SourceDocKind = deal.BofficeKind;
      spgrdoc.SourceDocID   = deal.DealID; 
      if( GetGE( spgrdoc ) == true ) 
         while(   (ret == true) and
                  (spgrdoc.SourceDocKind == deal.BofficeKind) and 
                  (spgrdoc.SourceDocID   == deal.DealID) )
            KeyNum( spgr, 0);
            ClearRecord( spgr );
            spgr.SPGroundID = spgrdoc.SPGroundID;
            if( GetEQ(spgr) == true )               
               if( Delete( spgr ) == false )
                  gOperData.MakeError( "Ошибка: ошибка при удалении в dspground_dbt записи о договоре по сделке" );
                  ЗанестиЗаписьВПротокол(667, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в dspground_dbt записи о договоре по сделке", gOperData.T_INSTANCEDATE);
                  AbortTrn;
               end;
            end;

            if( Delete( spgrdoc ) == false )
               gOperData.MakeError( "Ошибка: ошибка при удалении в dspgrdoc_dbt записи о привязке договора к сделке" );
               ЗанестиЗаписьВПротокол(668, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в dspgrdoc_dbt записи о привязке договора к сделке", gOperData.T_INSTANCEDATE);
               AbortTrn;
            end;

            ret = next(spgrdoc);
         end;
      end;

      if( leg1.Delete() == false )
         gOperData.MakeError( "Ошибка: ошибка при удалении в ddl_leg_dbt" );
         ЗанестиЗаписьВПротокол(669, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в ddl_leg_dbt", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;
      if( gOperData.ExistBack )
         if( leg2.Delete() == false )
            gOperData.MakeError( "Ошибка: ошибка при удалении в ddl_leg_dbt данных по второй части сделки" );
            ЗанестиЗаписьВПротокол(669, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в ddl_leg_dbt данных по второй части сделки", gOperData.T_INSTANCEDATE);
            AbortTrn;
         end;
      end;

      /*платежи и лоты: либо проверим их наличие, либо удалим, это зависит от флага gOperData.DeleteDemands*/
      strcmd = "delete from dpmwrtsum_dbt where t_docid in (select t_id from ddlrq_dbt where t_docid = " + deal.DealID + ")";
      execSQL(strcmd);
      strcmd = "delete from ddlrq_dbt where t_docid = " + deal.DealID;
      execSQL(strcmd);


      if (gOperData.T_INSTANCEDATE >= gOperData.T_DATE)
          ЗанестиЗаписьВПротокол(670, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: удалена историческая сделка", gOperData.T_INSTANCEDATE);
      end;

      if( Delete( Deal ) == false )
         gOperData.MakeError( "Ошибка: ошибка при удалении в ddl_tick_dbt" );
         ЗанестиЗаписьВПротокол(672, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: ошибка при удалении в ddl_tick_dbt", gOperData.T_INSTANCEDATE);
         AbortTrn;
      end;

   else
      gOperData.MakeError( "Ошибка: неверный вид выполняемого действия: " + string( gOperData.Action ) ); 
      ЗанестиЗаписьВПротокол(530, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: неверный вид выполняемого действия", gOperData.T_INSTANCEDATE);
      AbortTrn;
   end;

   /*общие действия для вставки или обновления - которые желательно выполнять когда уже известен FIID инструмента*/
   if( (gOperData.Action == 1) OR (gOperData.Action == 2) )
      /*добавим\обновим примечание*/
      /*дополнительные условия по сделке*/
      if( gOperData.T_CONDITIONS != null )
        if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                              101 /*пользовательский вид примечаний*/, gOperData.T_CONDITIONS, deal.DealDate ) )
           gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида 101 \"Дополнительные условия по сделке\", параметр T_CONDITIONS" );
           ЗанестиЗаписьВПротокол(673, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида 101 с дополнительными условиями по сделке", gOperData.T_INSTANCEDATE);
        end; 
      end;

      /*Код на бирже*/
      if( gOperData.T_MARKETCODE != null )
        if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                              102 /*пользовательский вид примечаний*/, gOperData.T_MARKETCODE, deal.DealDate ) )
           gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида 102 \"Код на бирже\", параметр T_MARKETCODE" );
           ЗанестиЗаписьВПротокол(674, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида 102 'Код на бирже', параметр T_MARKETCODE", gOperData.T_INSTANCEDATE);
        end; 
      end;

      /*Код у контрагента*/
      if( gOperData.T_PARTYCODE != null )
        if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                              103 /*пользовательский вид примечаний*/, string(gOperData.T_PARTYCODE), deal.DealDate ) )
           gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида 103 \"Код у контрагента\", параметр T_PARTYCODE" );
           ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида 103 'Код у контрагента', параметр T_PARTYCODE", gOperData.T_INSTANCEDATE);
        end; 
      end;

      /* Расчетная цена (23) */
      CatID = 23; 
      CatName = "Расчетная цена";   
      rez = removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, CatID);
      if ( gOperData.T_PRICE_CALC != null )
         removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, CatID);
         if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                               CatID /*пользовательский вид примечаний*/, double(gOperData.T_PRICE_CALC), deal.DealDate ) )
            gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида " + CatName );
            ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида " + CatName, gOperData.T_INSTANCEDATE);
         end; 
      end;

      /* Отклонение от расчетной цены (27) */
      CatID = 27; 
      CatName = "Отклонение от расчетной цены";
      rez = removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, CatID);  
      if ( gOperData.T_PRICE_CALC_DEF != null )
        if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                              CatID /*пользовательский вид примечаний*/, money(gOperData.T_PRICE_CALC_DEF), deal.DealDate ) )
           gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида " + CatName );
           ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида " + CatName, gOperData.T_INSTANCEDATE);
        end; 
      end;

      /* Единица измерения расчетной цены (28) */
      CatID = 28; 
      CatName = "Единица измерения расчетной цены";
      rez = removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, CatID);  
      if (int(gOperData.T_PRICE_CALC_VAL) > -1)
        if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                              CatID /*пользовательский вид примечаний*/, string(gOperData.T_PRICE_CALC_VAL), deal.DealDate ) )
           gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида " + CatName );
           ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида " + CatName, gOperData.T_INSTANCEDATE);
        end; 
      end;

      /* Примечание Расходы по оценке рыночной стоимости (116)*/
      CatID = 116;   
      CatName = "Расходы по оценке рыночной стоимости";
      rez = removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, CatID);  
      if ( gOperData.T_PRICE_CALC_OUTLAY != null )
         if (( gOperData.T_PRICE_CALC_OUTLAY != "" )and  ( gOperData.T_PRICE_CALC_OUTLAY != 0 ))
            if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                                  CatID /*пользовательский вид примечаний*/, money(gOperData.T_PRICE_CALC_OUTLAY), deal.DealDate ) )
                gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида " + CatName );
                ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида " + CatName, gOperData.T_INSTANCEDATE);
            end; 
         end;
      end;

      /* Комментарий к допконтролю (26)*/
      CatID = 26; 
      CatName = "Комментарий к допконтролю";
      rez = removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, CatID);  
      if ( gOperData.T_DOPCONTROL_NOTE != null )
         if ( gOperData.T_DOPCONTROL_NOTE != "" )
           if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                                 CatID /*пользовательский вид примечаний*/, string(gOperData.T_DOPCONTROL_NOTE), deal.DealDate ) )
              gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида " + CatName );
              ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида " + CatName, gOperData.T_INSTANCEDATE);
           end; 
         end;  
      end;
    
      /* Комментарий к способу определения РЦ (29)*/
      CatID = 29; 
      CatName = "Способ определения РЦ";
      rez = removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, CatID);  
      if ( gOperData.T_PRICE_CALC_MET_NOTE != null )
         if ( gOperData.T_PRICE_CALC_MET_NOTE != "" )
           if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                                 CatID /*пользовательский вид примечаний*/, string(gOperData.T_PRICE_CALC_MET_NOTE), deal.DealDate ) )
              gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида " + CatName );
              ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида " + CatName, gOperData.T_INSTANCEDATE);
           end; 
         end;  
      end;
    
      /*KD*/
      if( gOperData.T_PAYMCUR != -1 )
         sqlQuery =  "  SELECT count(1) as QuontFins " +
                     "  FROM dfininstr_dbt fi  " +             
                     "  WHERE  fi.T_FIID = "  +  string(gOperData.T_PAYMCUR);
         DataSet = TRsbDataSet( sqlQuery );

         if( (not DataSet.MoveNext()) OR (DataSet.QuontFins <= 0) )
            gOperData.MakeError("Ошибка: не найдена валюта платежа gOperData.T_PAYMCUR = " + string(gOperData.T_PAYMCUR) );
            ЗанестиЗаписьВПротокол(554, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не найдена валюта платежа", gOperData.T_INSTANCEDATE);
            IsWrongParms = true;
         else
           IsoCode = GetIsoNumber(gOperData.T_PAYMCUR);
            if(IsoCode != "")
               /* Валюта платежа */
               rez = removeNoteForObject( gOperData.ObjType, gOperData.StrUniID, 112); 
               if( addNoteForObject( gOperData.ObjType, gOperData.StrUniID,
                                     112 /*пользовательский вид примечаний*/, IsoCode, deal.DealDate ) )
                  gOperData.MakeError( "Предупреждение: ошибка при добавлении примечания вида 112 \"Валюта платежа\", параметр T_PAYMCUR" );
                  ЗанестиЗаписьВПротокол(675, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при добавлении примечания вида 112 'Валюта платежа', параметр T_PAYMCUR", gOperData.T_INSTANCEDATE);
               end; 
            end;
         end;       
      end;

      if( (gOperData.BofficeKind == DL_SECURITYDOC)
       or (gOperData.BofficeKind == DL_RETIREMENT) )
         // Установка значения категории Сделка подлежит дополнительному контролю ( 32 )
         CatID = 32;
         CatName = "Сделка подлежит дополнительному контролю";
         if ( gOperData.T_DOPCONTROL != null )
            SetCatID = gOperData.T_DOPCONTROL;
            if  (SetCatID == 1 ) SetCatID = 1;
            elif (SetCatID == 2 ) SetCatID = 2;
            elif (SetCatID == 3 ) SetCatID = 3;
            elif (SetCatID == 4 ) SetCatID = 4;
            elif (SetCatID == 5 ) SetCatID = 5;
            elif (SetCatID == 6 ) SetCatID = 6;
            elif (SetCatID == 7 ) SetCatID = 9;
            elif (SetCatID == 8 ) SetCatID = 91;
            elif (SetCatID == 9 ) SetCatID = 92;
            elif (SetCatID == 10) SetCatID = 94;
            elif (SetCatID == 11) SetCatID = 95;
            elif (SetCatID == 12) SetCatID = 96;
            elif (SetCatID == 13) SetCatID = 13;
            elif (SetCatID == 14) SetCatID = 23;
            elif (SetCatID == 15) SetCatID = 25;
            elif (SetCatID == 16) SetCatID = 7;
            elif (SetCatID == 17) SetCatID = 8;
            elif (SetCatID == 18) SetCatID = 38;
            elif (SetCatID == 19) SetCatID = 938;
            elif (SetCatID == 20) SetCatID = 93;
            elif (SetCatID == 21) SetCatID = 913;
            elif (SetCatID == 22) SetCatID = 925;
            end;

            if( gOperData.Action != 1 )
               rez = DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, CatID );
            end;

            if (gOperData.T_DOPCONTROL > 0)
               if( not ConnectObjAttr( CatErr, gOperData.ObjType, gOperData.StrUniID,  CatID,
                                ПолучитьIDАтрибута(gOperData.ObjType, CatID, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                   
                 )
                  var operName = IIF(gOperData.BofficeKind == DL_SECURITYDOC, " для сделки", " для погашения");
                  gOperData.MakeError("Предупреждение: ошибка при установке категории " + CatName + operName );
                  ЗанестиЗаписьВПротокол(678, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории " + CatName + operName, gOperData.T_INSTANCEDATE);
               end;
            end;
         end;
      end;

      if( gOperData.BofficeKind == DL_SECURITYDOC ) /*только для сделок с ц/б*/ 
         /* Признак изменеия стоимости реализации/приобретения по 2 части Репо при выплате купонного дохода/дивидентов/частичного погашения ценных бумаг */
         if( gOperData.T_COSTCHANGE != null )
            if( gOperData.T_COSTCHANGE == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
            end;

            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 18 /*Признак изменения стоимости*/ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      18,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 18, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Признак изменения стоимости\" для сделки" );            
               ЗанестиЗаписьВПротокол(676, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Признак изменения стоимости' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         /* Признак изменения стоимости реализации/приобретения по 2 части Репо при выплате купонного дохода/дивидентов/частичного погашения ценных бумаг */
         if( gOperData.T_COSTCHANGEONCOMP != null )
            if( gOperData.T_COSTCHANGEONCOMP == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
            end;

            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 21 /*Признак изменения стоимости при выплате компенсационного взноса*/ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      21,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 21, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Признак изменения стоимости при выплате компенсационного возноса\" для сделки" );            
               ЗанестиЗаписьВПротокол(677, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Признак изменения стоимости при выплате компенсационного возноса' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         /* Признак изменения стоимости реализации/приобретения по 2 части Репо при выплате купонного дохода/дивидентов/частичного погашения ценных бумаг */
         if( gOperData.T_COSTCHANGEONAMOR != null )
            if( gOperData.T_COSTCHANGEONAMOR == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
            end;

            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 22 /*Признак изменения стоимости при выплате компенсационного взноса*/ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      22,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 22, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Признак изменения стоимости при выплате амортизации\" для сделки" );            
               ЗанестиЗаписьВПротокол(678, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Признак изменения стоимости при выплате амортизации' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         // Установка значения категории Вид сделок ФИСС ( 33 )
         CatID = 33;
         CatName = "Вид сделок ФИСС";
         if ( gOperData.T_FISSKIND != null )
            if ( gOperData.T_FISSKIND != 0 )
               SetCatID = gOperData.T_FISSKIND;

               if( gOperData.Action != 1 )
                  rez = DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, CatID );
               end;

               if(  not ConnectObjAttr( CatErr, gOperData.ObjType, gOperData.StrUniID,  CatID,
                                         ПолучитьIDАтрибута(gOperData.ObjType, CatID, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                 )
                  gOperData.MakeError("Предупреждение: ошибка при установке категории " + CatName + " для сделки" );            
                  ЗанестиЗаписьВПротокол(678, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории " + CatName + " для сделки", gOperData.T_INSTANCEDATE);
               end;
            end;
         end;

         // Установка значения категории Способ определения РЦ ( 34 )
         CatID = 34;

         if   (gOperData.T_PRICE_CALC_METHOD == 1 ) pcm = "10-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 2 ) pcm = "10-80";
         elif (gOperData.T_PRICE_CALC_METHOD == 3 ) pcm = "11-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 4 ) pcm = "11-01";
         elif (gOperData.T_PRICE_CALC_METHOD == 5 ) pcm = "12-50";
         elif (gOperData.T_PRICE_CALC_METHOD == 6 ) pcm = "12-51";
         elif (gOperData.T_PRICE_CALC_METHOD == 7 ) pcm = "12-80";
         elif (gOperData.T_PRICE_CALC_METHOD == 8 ) pcm = "12-81";
         elif (gOperData.T_PRICE_CALC_METHOD == 9 ) pcm = "19-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 10) pcm = "20-80";
         elif (gOperData.T_PRICE_CALC_METHOD == 11) pcm = "21-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 12) pcm = "21-01";
         elif (gOperData.T_PRICE_CALC_METHOD == 13) pcm = "22-10";
         elif (gOperData.T_PRICE_CALC_METHOD == 14) pcm = "22-11";
         elif (gOperData.T_PRICE_CALC_METHOD == 15) pcm = "22-20";
         elif (gOperData.T_PRICE_CALC_METHOD == 16) pcm = "22-21";
         elif (gOperData.T_PRICE_CALC_METHOD == 17) pcm = "22-30";
         elif (gOperData.T_PRICE_CALC_METHOD == 18) pcm = "22-31";
         elif (gOperData.T_PRICE_CALC_METHOD == 19) pcm = "22-40";
         elif (gOperData.T_PRICE_CALC_METHOD == 20) pcm = "22-41";
         elif (gOperData.T_PRICE_CALC_METHOD == 21) pcm = "22-50";
         elif (gOperData.T_PRICE_CALC_METHOD == 22) pcm = "22-51";
         elif (gOperData.T_PRICE_CALC_METHOD == 23) pcm = "22-60";
         elif (gOperData.T_PRICE_CALC_METHOD == 24) pcm = "22-61";
         elif (gOperData.T_PRICE_CALC_METHOD == 25) pcm = "22-70";
         elif (gOperData.T_PRICE_CALC_METHOD == 26) pcm = "22-71";
         elif (gOperData.T_PRICE_CALC_METHOD == 27) pcm = "22-80";
         elif (gOperData.T_PRICE_CALC_METHOD == 28) pcm = "22-81";
         elif (gOperData.T_PRICE_CALC_METHOD == 29) pcm = "29-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 30) pcm = "31-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 31) pcm = "31-01";
         elif (gOperData.T_PRICE_CALC_METHOD == 32) pcm = "32-50";
         elif (gOperData.T_PRICE_CALC_METHOD == 33) pcm = "32-51";
         //elif (gOperData.T_PRICE_CALC_METHOD == 42) pcm = "39-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 34) pcm = "99-00";
         elif (gOperData.T_PRICE_CALC_METHOD == 35) pcm = "11-80";
         elif (gOperData.T_PRICE_CALC_METHOD == 36) pcm = "11-81";
         end;

         CatName = "Способ определения РЦ";
         if ( gOperData.T_PRICE_CALC_METHOD != null )
            if (gOperData.T_PRICE_CALC_METHOD > 0 )
               SetCatID = gOperData.T_PRICE_CALC_METHOD;
               if( gOperData.Action != 1 )
                  rez = DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, CatID );
               end;

               if( not ConnectObjAttr( CatErr, gOperData.ObjType, gOperData.StrUniID,  CatID,
                                         ПолучитьIDАтрибута(gOperData.ObjType, CatID, pcm), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                 )
                  gOperData.MakeError("Предупреждение: ошибка при установке категории " + CatName + " для сделки" );            
                  ЗанестиЗаписьВПротокол(678, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории " + CatName + " для сделки", gOperData.T_INSTANCEDATE);
               end;
            end;
         end;

         /*Признак урегулирования требований по ст.282 НК РФ.*/
         if( gOperData.T_ADJUSTMENT != null )
            if( gOperData.T_ADJUSTMENT == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
            end;

            if( gOperData.Action != 1 )
                DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 19 /*Урегулирование требований*/ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      19,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 19, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Признак урегулирования требований\" для сделки" );            
               ЗанестиЗаписьВПротокол(679, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Признак урегулирования требований' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         /* Признак ограничения прав покупателя по сделке РЕПО - "Блокировка ц/б" */
         if( gOperData.T_LIMIT != null )
            if( gOperData.T_LIMIT == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
               strcmd = "update ddl_tick_dbt SET t_blocked = chr(88) where t_dealid = " + deal.DealID;
               execSQL(strcmd);
            end;

            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 103 /*Блокировка ц/б*/ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      103,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 103, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Блокировка ц/б\" для сделки" );            
               ЗанестиЗаписьВПротокол(677, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Блокировка ц/б' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         /* Признак изменения ставки - "Плавающая ставка" */
         if( gOperData.T_CHRATE != null )
            if( gOperData.T_CHRATE == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
            end;

            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 26 /*Плавающая ставка*/ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      26,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 26, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Плавающая ставка\" для сделки" );            
               ЗанестиЗаписьВПротокол(677, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Плавающая ставка' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         /* Признак изменения ставки - "Принадлежность дивидендов" */
         if(( gOperData.T_DIV != null ) and (trim(gOperData.T_DIV) != "" )) /*BPV так будет поуниверсальней, понадежней*/
            if( gOperData.T_DIV == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
            end;

            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 25 /*Принадлежность дивидендов*/ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      25,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 25, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Принадлежность дивидендов продавцу 1 части\" для сделки" );            
               ЗанестиЗаписьВПротокол(677, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Принадлежность дивидендов продавцу 1 части' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         /*  "Место заключения сделки" */
         if (( gOperData.T_COUNTRY != null ) and (gOperData.ObjType == 101) and (gOperData.T_COUNTRY != 643)) /*KD Если страна Россия - то не вставляем*/
            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 105 /* Место заключения сделки */ );
            end;

            if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                      gOperData.StrUniID,
                                      105,
                                      ПолучитьIDАтрибута(gOperData.ObjType, 105, gOperData.T_COUNTRY), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                ) OR
                ( CatErr != 0 )
              )
               gOperData.MakeError("Предупреждение: ошибка при установке категории \"Место заключения сделки\" для сделки" );            
               ЗанестиЗаписьВПротокол(677, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Место заключения сделки' для сделки", gOperData.T_INSTANCEDATE);
            end;
         end;

         /*Признак исполнения сделки в любой день*/  
         if( gOperData.T_ATANYDAY != null )
            if( gOperData.T_ATANYDAY == UNSET_CHAR )
               SetCatID = 0;   
            else
               SetCatID = 1;   
            end;

            if( gOperData.Action != 1 )
               DisconnectObjAttr( gOperData.ObjType, gOperData.StrUniID, 20 /*Исполняется в любой день*/ );
            end;

            if (SetCatID == 1)
               if( ( not ConnectObjAttr( CatErr, gOperData.ObjType,
                                         gOperData.StrUniID,
                                         20,
                                         ПолучитьIDАтрибута(gOperData.ObjType, 20, SetCatID), NULL, NULL, Date(0,0,0)/*gOperData.T_INSTANCEDATE*/ )
                   ) OR
                   ( CatErr != 0 )
                 )
                  gOperData.MakeError("Предупреждение: ошибка при установке категории \"Признак исполнения сделки в любой день\" для сделки" );            
                  ЗанестиЗаписьВПротокол(680, 80, gOperData.OldDealID, 1, StrFor(1), "Предупреждение: ошибка при установке категории 'Признак исполнения сделки в любой день' для сделки", gOperData.T_INSTANCEDATE);
               end;
            end;
         end;
      end;
   end;
END;

private MACRO ProcessOper()
   var ret:bool = true;   

   if( (gOperData.T_MARKETID != null) AND (gOperData.T_MARKETID > 0) )  
      gOperData.IsMarketOper = true;
   else          
      gOperData.IsMarketOper = false;
   end;

   if( (gOperData.T_KIND == null) OR (gOperData.T_KIND == "")   )
      gOperData.MakeError("Ошибка: не задан параметр T_KIND - вид сделки" );
      ЗанестиЗаписьВПротокол(568, 80, gOperData.OldDealID, 1, StrFor(1), "Ошибка: не задан параметр T_KIND - вид сделки", gOperData.T_INSTANCEDATE);
      AbortTrn;
   else
      if( (gOperData.T_KIND == 30) OR (gOperData.T_KIND == 40) )
         gOperData.ExistBack = true;
      end;

      if(  (gOperData.T_KIND == 70) OR (gOperData.T_KIND == 80) OR (gOperData.T_KIND == 90) )
         gOperData.BofficeKind = DL_RETIREMENT; /*погашение*/
      elif( gOperData.T_KIND == 100 ) /*получение дивидендов*/
         gOperData.BofficeKind = 158; /*DL_GET_DIVIDEND */
      elif( gOperData.T_KIND == 110 )
         gOperData.BofficeKind = DL_NTGDOC; /*неттинга*/
      else /*все остальные*/
         gOperData.BofficeKind = DL_SECURITYDOC; /*сделка с ц/б*/
      end;
   end;

   if( gOperData.BofficeKind == DL_RETIREMENT )
      gOperData.ObjType = 117 /*OBJTYPE_RETIRE*/;
   else
      gOperData.ObjType = OBJTYPE_SECDEAL;
   end;

   if( gOperData.BofficeKind == DL_NTGDOC)
      if( gOperData.InTrn == false )
         if (ProcessTrn(0, "ProcessDL_NETT", nett, spgr, spgrdoc, partyown, deal ) == false )   
            ret = false;
         end;
      else
         ProcessDL_NETT();
      end;
   else
      if( gOperData.InTrn == false )
         if (ProcessTrn(0, "ProcessDL_TICK", deal, leg1, leg2, spgr, spgrdoc, partyown ) == false )
            ret = false;
         end;
      else
         ProcessDL_TICK();
      end;
   end;

   return ret;
END;

/* Функция обработки торговой операции */
/* OperData - обязательный. IN. TOperationInfo. Параметры необходимые для выполнения процедуры.  */
/* Action - обязательный. IN. Integer. Выполняемое действие (1 - вставка, 2 - изменение, 3 - удаление.)  */
/* SaveInChangeHistory - необязательный. IN. Bool. Признак занесения записи в историю изменения по сделке, в режиме изменения*/
/* Error - необязательный. OUT. String. */
/* Функция возвращает TRUE (0) в случае успешного выполнения и FALSE (1) в случае ошибки. */
/* можно предварительно заполнить OperData.DeleteDemand = true, тогда при удалении будут откатываться платежи и лоты */
/* 
До выполнения вставки операции выполняется проверка на существование такой операции. Если такая операция уже есть, должна возвращаться ошибка. 
Также при вставке должна проверяться заполненность основных полей структуры (ID ценной бумаги и т.д.), если они не заполнены, то должна возвращаться ошибка. 
Поле ID операции при вставке не играет роли. После вставки в поле "Идентификатор операции" должно записываться значение ID вставленной операции. 
Также при вставке должны осуществляться остальные необходимые проверки (существование контрагента и т.д.) 
При обновлении и удалении должна проверяться проверка на существование такой операции (по ID), если ее нет, то возвращается ошибка
*/
MACRO ОбработатьОперацию( OperData:TOperationInfo, Action:integer, SaveInChangeHistory:bool, Error:TArray ) : BOOL
   var   ret:bool = true;

   gOperData               = OperData;
   gOperData.Action        = Action;

   if( SaveInChangeHistory != null )
      gOperData.SaveInChangeHistory = SaveInChangeHistory;
   else
      gOperData.SaveInChangeHistory = false;
   end;

   if( (Error != null) and (valtype(Error) == V_GENOBJ) )
      gOperData.Error   = Error;
   end;

   return ProcessOper();
END;

// обработка фиктивной операции с корзиной 
MACRO ОбработатьОперацию_корзина( OperData:TOperationInfo, Action:integer, SaveInChangeHistory:bool, Error:TArray ) : BOOL

   var  main_oper, SQL, SQL2, cmd, rs;
   var  ret:bool = true;
   var  M_Date; // Дата рамочной сделки
   var  Direction;  // Направление движения обеспечения: 0-ввод, 1-вывод
   var  Payer, Receiver; // для платежей
   var  VDate, VDateN, VDateReturn;  // Для преобразования дат
   var  EnsID;   // Идентификатор записи в таблице обеспечения
   var  rq_type, rq_id, rq_dealpart;
   var  count_by_fiid;  // количество бумаг, по которым идет движение. Используется для контроля и коррекции платежа по второй части.
   var  first_movement;  // Признак того, что данное движение является первым под сделкой.

   gOperData               = OperData;
   gOperData.Action        = Action;

   if( SaveInChangeHistory != null )
      gOperData.SaveInChangeHistory = SaveInChangeHistory;
   else
      gOperData.SaveInChangeHistory = false;
   end;

   if( (Error != null) and (valtype(Error) == V_GENOBJ) )
      gOperData.Error   = Error;
   end;

   // вытаскиваем исходную сделку с корзиной.
   main_oper = TRsbDataSet( "SELECT a.*, (select coalesce( nullif(t_maturity, to_date('01.01.0001','dd.mm.yyyy')), nullif(t_expiry, to_date('01.01.0001','dd.mm.yyyy'))) from ddl_leg_dbt where t_legkind=2 and t_dealid=a.t_dealid) retdate, (select coalesce( nullif(t_maturity, to_date('01.01.0001','dd.mm.yyyy')), nullif(t_expiry, to_date('01.01.0001','dd.mm.yyyy'))) from ddl_leg_dbt where t_legkind=0 and t_dealid=a.t_dealid) begdate FROM DDL_TICK_DBT a WHERE T_DEALID = " + OperData.t_parentid );

   if ( not main_oper.movenext() )
      ЗанестиЗаписьВПротокол(568, 80, OperData.t_dealid, 1, StrFor(1), "Ошибка: не найдена сделка с корзиной " + gOperData.t_parentid, gOperData.T_INSTANCEDATE);
      AbortTrn;
      return false;
   end;

   if (OperData.T_KIND > 20)
      ЗанестиЗаписьВПротокол(568, 80, OperData.t_dealid, 1, StrFor(1), "Ошибка: неопределенное направление движения обеспечения (корзина) " + gOperData.t_parentid, gOperData.T_INSTANCEDATE);
      return false;
   end; 

   // определим направление 
   Direction = 0;
   Receiver = OperData.t_partyid; 
   Payer = 1;
   if   (main_oper.t_dealtype == 2139)  // Прямое РЕПО на корзину.
      if (OperData.T_KIND == 10 )
         Direction = 1;
         Payer = OperData.t_partyid;
         Receiver = 1; 
      else
         Direction = 0;
         Payer = 1;
         Receiver = OperData.t_partyid; 
      end;
   elif (main_oper.t_dealtype == 2134)  // Обратное РЕПО на корзину
      if (OperData.T_KIND == 10 )
         Direction = 0;
         Payer = 1;
         Receiver = OperData.t_partyid;
      else
         Direction = 0;
         Payer = OperData.t_partyid;
         Receiver = 1;
      end;
   end;

   VDate  = "to_date('" + OperData.t_date + "','dd.mm.yyyy')";
   VDateN = "to_date('01/01/0001 12:00:00 AM', 'MM/DD/YYYY HH:MI:SS AM')";
   VDateReturn = "to_date('" + main_oper.retdate + "','dd.mm.yyyy')";

   if (Action == 1)
      //---------- Блок работы с таблицей обеспечения DDL_TICK_ENS_DBT ------
      // Считаем остаток бумаг на дату текущего движения. Бумаги, по которым идет движение.
   
      SQL2 = TRsbDataSet( "SELECT nvl(sum(t_principal * (CASE t_kind WHEN 0 THEN 1 WHEN 1 THEN -1 END)),0) cou FROM DDL_TICK_ENS_DBT WHERE T_dealid=" + main_oper.t_dealid + " and t_fiid=" + OperData.t_avoirissid); // + " and t_date <= " + VDate);
      if (SQL2.movenext())
         count_by_fiid = SQL2.cou;
      else    
         count_by_fiid = 0;
      end;
   
      SQL2 = TRsbDataSet( "SELECT 1 FROM DDL_TICK_ENS_DBT WHERE T_dealid=" + main_oper.t_dealid);
      if (SQL2.movenext())
         first_movement = 1;  // До этого движения под сделкой ничего не было
      else    
         first_movement = 0;
      end;
   
      // Количество бумаг после этого движения
      if ( Direction == 1 ) 
         count_by_fiid = count_by_fiid - OperData.t_amount; // Вывод.
      else
         count_by_fiid = count_by_fiid + OperData.t_amount;
      end;  
   
      // если это вывод - проследим, чтобы хватило обеспечения. 
      if ( count_by_fiid < 0 )
         ЗанестиЗаписьВПротокол(568, 80, OperData.t_dealid, 1, StrFor(1), "Ошибка: недостаточно обеспечения для вывода, операция - " + gOperData.t_parentid, gOperData.T_INSTANCEDATE);   
         return false;
      end;
   
      // получаем идентификатор записи для таблицы обеспечения
      SQL = TRsbDataSet( "SELECT ddl_tick_ens_dbt_seq.nextval id FROM DUAL" );
      SQL.movenext();
      EnsID = SQL.id;
   
      // вставка в таблицу движения обеспечения
      SQL = "insert into ddl_tick_ens_dbt(T_ID, T_DEALID, T_FIID, T_DATE, T_KIND, T_PRINCIPAL, T_TOTALCOST, T_COSTFIID, T_NKD ) values (";
      SQL = SQL + EnsID + ", ";                    /*T_ID         NUMBER (10)*/
      SQL = SQL + main_oper.t_dealid + ", ";          /*T_DEALID     NUMBER (10)*/
      SQL = SQL + OperData.t_avoirissid + ", ";       /*T_FIID        NUMBER (5)*/
      SQL = SQL + VDate + ", ";                       /*T_DATE          DATE */
      SQL = SQL + Direction + ", ";                   /*T_KIND       */
      SQL = SQL + OperData.t_amount + ", ";           /*T_PRINCIPAL  */
      SQL = SQL + OperData.t_totalcost + ", ";        /*T_TOTALCOST  */
      SQL = SQL + OperData.t_currencyid + ", ";       /*T_COSTFIID   */
      SQL = SQL + OperData.t_nkd;               /*T_NKD        */
      SQL = SQL + ")";
   
      cmd = RsdCommand(SQL);
      cmd.execute;   
   
      gOperData.t_dealid = EnsID;
   
      //---------- Блок работы с платежами ---------------------------------
      //      Определение назначения платежа. СГС.
      //rq_type = 7; /*компенсационный платеж*/
      rq_type = 9;   /*компенсационая поставка*/
      rq_dealpart = 2;
   
      // всё опять изменилось. Поскольку управлять очередностью поступления платежей в БС невозможно, ориентируемся на плановые даты.
      if ((main_oper.retdate == OperData.t_date ) AND ( Direction == 1 ))
         rq_type = 8;
         rq_dealpart = 2;
      end;
   
      if ((rq_type != 8) and (  Direction == 0 ) )  // Если это не поставка второй части и ввод обеспечения.
         // дополнительно проверим, что пополнение происходит в дату зачисления денег.
         SQL = TRsbDataSet( "select to_char(min(t_plandate),'dd.mm.yyyy') ddate from ddlrq_dbt where t_type=2 and t_docid="+main_oper.t_dealid ); // !?
         if ((SQL.movenext) and (SQL.ddate != null))
            if ( date(SQL.ddate) == OperData.t_date )
               rq_type = 8;
               rq_dealpart = 1;
            end;
         else
            // Если денежных платежей нет - смотрим на дату заключения сделки
            if ( OperData.t_date == main_oper.t_dealdate )
               rq_type = 8;
               rq_dealpart = 1;
            end;
         end;
      end;
   
      ClearRecord(rq);
   
      sql = "select t_fi_kind-1 t_subkind from dfininstr_dbt where t_fiid = " + string(OperData.t_avoirissid);
      cmd = RsdCommand(SQL);
      rs  = RsdRecordSet(cmd);
      
      if (rs.MoveNext)
          rq.subkind = rs.Value(0);
      else
         if (OperData.t_avoirissid.fiid < 10)
            rq.subkind = 0;
         else
            rq.subkind = 1;
         end;   
      end;
   
      rq.Type = rq_type;
      rq.dealpart = rq_dealpart;
   
      if( payer == 1 )
         rq.Kind = 1; // Обязательство
      else
         rq.Kind = 0;
      end;
   
      rq.State         = 2;
      rq.FactDate      = OperData.t_date;
      rq.Amount        = OperData.t_amount;
      rq.FIID          = OperData.t_avoirissid;
      rq.DocKind       = 101;
      rq.DocID         = main_oper.t_dealid;
      rq.Num           = 0;
      rq.Party         = payer + receiver - 1;
      rq.PlanDate      = OperData.t_date;
      rq.ID_Step       = 2908;
      rq.RqAccID       = -1;
      rq.PlaceID       = -1;
      rq.Instance      = 0;
      rq.ChangeDate    = OperData.t_date;
      rq.Action        = 0;
      rq.ID_Operation  = 0;
      rq.Source        = 0;
      rq.SourceObjKind = -1;
      rq.SourceObjID   = 0;
      
      if( Insert( rq ) == false )
         return false;
      end;
   ELSE  // Action == 2 и 3
      EnsID = OperData.t_dealid;

      // В OperData.T_DEALID содержится номер записи в таблице обеспечения. Вытаскиваем по ней ID платежа.
      SQL = TRsbDataSet( "SELECT rq.t_ID FROM DDLRQ_DBT rq, DDL_TICK_ENS_DBT ens WHERE rq.T_PLANDATE=ens.T_DATE and rq.t_fiid=ens.T_FIID and rq.t_amount=ens.t_principal and ens.t_id =  " + EnsID );

      if (SQL.movenext())
         rq_id = SQL.t_id;
      else
         ЗанестиЗаписьВПротокол(568, 80, OperData.t_dealid, 1, StrFor(1), "Ошибка: не найдено обеспечение " + OperData.t_dealid, gOperData.T_INSTANCEDATE);
         AbortTrn;
         return false;
      end;

      if ( Action == 3 )
         SQL = "delete from DDLRQ_DBT where t_id = " + rq_id;
         cmd = RsdCommand(SQL);
         cmd.execute;

         SQL = "delete from DDL_TICK_ENS_DBT where t_id = " + EnsID;
         cmd = RsdCommand(SQL);
         cmd.execute;
      end;

      // Считаем остаток бумаг на дату текущего движения. Бумаги, по которым идет движение.
      SQL2 = TRsbDataSet( "SELECT nvl(sum(t_principal * (CASE t_kind WHEN 0 THEN 1 WHEN 1 THEN -1 END)),0) cou FROM DDL_TICK_ENS_DBT WHERE T_dealid=" + main_oper.t_dealid + " and t_fiid=" + OperData.t_avoirissid + " and t_date <= " + VDate);
      if (SQL2.movenext())
         count_by_fiid = SQL2.cou;
      else    
         count_by_fiid = 0;
      end;
   END;

   //---------- Корректировка DDL_TICK_DBT ------------------------------
   SQL = "update ddl_leg_dbt set t_principal = (SELECT nvl(sum(t_principal * (CASE t_kind WHEN 0 THEN 1 WHEN 1 THEN -1 END)),0) cou FROM DDL_TICK_ENS_DBT WHERE T_dealid=" + main_oper.t_dealid + ") WHERE T_dealid=" + main_oper.t_dealid;
   cmd = RsdCommand(SQL);
   cmd.execute;   

   return true;
END;
