/*
$Name:             txproc_money_fun.mac
$Module:           БОЦБ 
$Description:      Процедуры для репликации данных в БОЦБ из внешних систем
                   Процедура - ОбработатьОперацию
*/
IMPORT "nptxfun.mac", "txrepl_func";

/*данные с информацие по операции с ценными бумагами, для передачи в процедуру ОбработатьОперацию*/
CLASS TMoneyInfo
   var   T_DEALID:numeric;          /* Идентификатор операции*/
   var   T_TYPE:integer;            /* Тип операции: 0 -  Ввод денежных средств, 1 -  Вывод денежных средств, 2 -  Удержание НДФЛ, 3 -  Внутренняя комиссия */
   var   T_EXTCODE:string;          /* Код во внешней системе */
   var   T_CODE:string;             /* По умолчанию - очередной код */
   var   T_CLIENTID:integer;        /* Идентификатор клиента*/
   var   T_CLIENTACCOUNT:integer;   /* Счет клиента*/
   var   T_FIID:integer;            /* Идентификатор валюты операции - ссылка на идентификатор таблицы Валюта */
   var   T_TAXPAYTYPE:integer;      /* Тип удержания НДФЛ: 1 - окончание года, 2 - вывод д/с, 3 - вывод ц/б, 4 - материальная выгода, 5 - закрытие договора */
   var   T_TAXYEAR:integer;         /* Налоговый год, только для операции удержания НДФЛ */
   var   T_SUM:money;               /* Сумма операции*/
   var   T_DATE:date;               /* Дата заключения сделки*/
   var   T_FUTOPERTYPE:integer;     /* Тип суммы по операциям с деривативами:  1-доходы по фьюч., БФИ - бумага, 2 - расходы с БПИ-бумагой, 3 - доходы с иным БПИ, 4 - расходы с иным БПИ. */
   var   T_INSTANCEDATE:date;       /* Дата начала действия признака */

   var   BofficeKind:integer;       /* вид первичного документа операции*/
   var   OperExist:bool;            /* признак надичия в системе обрабатываемой операции*/   
   var   Action:integer;            /* выполняемое действие (1 - вставка, 2 - изменение, 3 - удаление.)*/
   var   OldDealID:numeric;
   var   InTrn;                     /* транзакция начата */
   var   Error:TArray;              /* массив строк с текстами ошибок*/

   MACRO MakeError( ErrorMes:string )
      this.Error[this.Error.Size] = string(this.Error.Size) + ":" + ErrorMes;
   END;

   MACRO PrintErrors()
      var i = 0;
      while( this.Error[i] != null )
         println( this.Error[i] );
         i = i + 1;   
      end;     
   END;  

   MACRO Init()
      this.OperExist     =  false;
      this.Error         =  TArray;
      this.BofficeKind   =  0;
      this.Action        =  0;
   END;
   
   Init();
END;
                                    
// Выполняет действия в RSBANK. Успешно - возвращает true;
MACRO ExecuteOperation(OperData, Action, rs)
   var sql2, cmd2, rs2, TaxType, direction, FutType,  tid, sql3, cmd3, rs3, sumall;
   var pi_sum, pi_sum0, dd,mm,yyyy;
   DateSplit( OperData.t_date, dd, mm, yyyy);

   if (Action == 1)
     if ((OperData.T_TYPE == 0) OR (OperData.T_TYPE == 1))   // ввод-вывод денсредств
        // ввод-вывод ден. средств. вывод должен оформляться внутренними операциями
      elif (OperData.T_TYPE == 3)  // внутренняя комиссия, не разнесенная по объектам.
        SQL2 = "SELECT dnptxobj_dbt_seq.nextval a FROM dual";
        cmd2 = RsdCommand( SQL2 );
        rs2 = TRSBDataSet(cmd2);
        rs2.movenext();
        OperData.T_DEALID = rs2.a;
        direction = TXOBJ_DIR_OUT;

        SQL2 =  "insert into dnptxobj_dbt(t_objid, t_date, t_client, t_direction, t_level, t_user, t_kind, t_cur, t_sum, t_sum0) " +
                "values(?, ?, ?, ?, ?, chr(88), ?, ?, ?, ?)";
        cmd2 = RsdCommand( SQL2 );
        cmd2.addParam( "t_objid",  RSDBP_IN,   OperData.T_DEALID );
        cmd2.addParam( "t_date",  RSDBP_IN,    date(OperData.T_DATE));
        cmd2.addParam( "t_client",  RSDBP_IN,  OperData.T_CLIENTID );
        cmd2.addParam( "t_direction",  RSDBP_IN,   direction );
        cmd2.addParam( "t_level",  RSDBP_IN,   4 );
        cmd2.addParam( "t_kind",  RSDBP_IN,   520 );
        cmd2.addParam( "t_cur",   RSDBP_IN,   OperData.T_FIID);
        cmd2.addParam( "t_sum",   RSDBP_IN,   OperData.T_SUM );
        cmd2.addParam( "t_sum0",  RSDBP_IN,   OperData.T_SUM );
        cmd2.execute;
      elif (OperData.T_TYPE == 4)  // финрез по операциям с деривативами.
         SQL2 = "SELECT dnptxobj_dbt_seq.nextval a FROM dual";
         cmd2 = RsdCommand( SQL2 );
         rs2 = TRSBDataSet(cmd2);
         rs2.movenext();
         OperData.T_DEALID = rs2.a;

         if   (OperData.T_FUTOPERTYPE == 1)
               direction = TXOBJ_DIR_IN;
               FutType = 640; // Доходы по обращающимся ПИ фондового рынка
         elif (OperData.T_FUTOPERTYPE == 2)
               direction = TXOBJ_DIR_OUT;
               FutType = 770; // Все расходы по обращающимся ПИ фондового рынка
         elif (OperData.T_FUTOPERTYPE == 3)
               direction = TXOBJ_DIR_IN;
               FutType = 650; // Доходы по обращающимся ПИ не-фондового рынка
         elif (OperData.T_FUTOPERTYPE == 4)
               direction = TXOBJ_DIR_OUT;
               FutType = 780; // Все расходы по обращающимся ПИ не-фондового рынка 
         end;

         // Сравним с последней суммой дохода ( по этому клиенту в течение года )
         SQL2 = "select nvl(sum(T_SUM),0) T_SUMALL from dnptxobj_dbt where t_client = ? and t_date > ? and t_direction = ? and t_level = ? and t_kind = ? order by t_date desc";
         cmd2 = RsdCommand( SQL2 );
         cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
         cmd2.addParam( "t_date",  RSDBP_IN,   date(1, 1, yyyy));
         cmd2.addParam( "t_direction",  RSDBP_IN,   direction );
         cmd2.addParam( "t_level",  RSDBP_IN,   5 );
         cmd2.addParam( "t_kind",  RSDBP_IN,   FutType );
         cmd2.execute;
         rs2 = TRSBDataSet(cmd2);
         if (rs2.movenext())    // нашли предыдущую запись по деривативам   
            pi_sum = OperData.T_SUM - rs2.T_SUMALL;  // корректируем сумму
            pi_sum0 = pi_sum;
            if (pi_sum < 0)
               ЗанестиЗаписьВПротокол(207, 120, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: новая сумма по FORTS клиента меньше предыдущей: операция " + OperData.T_CODE, rs.Value("T_INSTANCEDATE"));
               return false;
            end;
         else
            pi_sum = OperData.T_SUM;
            pi_sum0 = pi_sum;
         end;

         if (pi_sum > 0)
            SQL2 =  "insert into dnptxobj_dbt(t_objid, t_date, t_client, t_direction, t_level, t_user, t_kind, t_cur, t_sum, t_sum0) " +
                     "values(?, ?, ?, ?, ?, chr(88), ?, ?, ?, ?)";
            cmd2 = RsdCommand( SQL2 );
            cmd2.addParam( "t_objid",  RSDBP_IN,   OperData.T_DEALID );
            cmd2.addParam( "t_date",  RSDBP_IN,   date(OperData.T_DATE));
            cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
            cmd2.addParam( "t_direction",  RSDBP_IN,   direction );
            cmd2.addParam( "t_level",  RSDBP_IN,   5 );
            cmd2.addParam( "t_kind",  RSDBP_IN,   FutType );
            cmd2.addParam( "t_cur",   RSDBP_IN,   OperData.T_FIID);
            cmd2.addParam( "t_sum",   RSDBP_IN,   pi_sum );
            cmd2.addParam( "t_sum0",  RSDBP_IN,   pi_sum0 );
            cmd2.execute;
         end;
      elif (OperData.T_TYPE == 2)  // операция удержания НДФЛ
         if ( OperData.T_TAXPAYTYPE == 1 )   // по концу года
            // на случай, если в буферной схеме уже лежат несколько записей по этому клиенту - найдем их общую сумму. 
            // это если удерживали в несколько приемов. Придется операцию удержания откатить и накатить заново.
            SQL3 = "SELECT sum(T_SUM) total FROM dtxmoney_dbt WHERE t_clientid = ? and t_type = ? and t_taxpaytype = ? and t_taxyear = ? and t_action=1";
            cmd3 = RsdCommand(  SQL3 );
            cmd3.addParam( "t_clientid",  RSDBP_IN,   OperData.t_clientid);
            cmd3.addParam( "t_type",  RSDBP_IN,   OperData.t_type);
            cmd3.addParam( "t_taxpaytype",  RSDBP_IN,   OperData.t_taxpaytype);
            cmd3.addParam( "t_taxyear",  RSDBP_IN,   OperData.T_TAXYEAR);
            rs3 = TRSBDataSet(cmd3);
            if (rs3.movenext())
               sumall = rs3.total;
            end;
        
            SQL2 = "SELECT t_id tid from dnptxop_dbt where t_dockind = ? and t_kind_operation = ? and t_subkind_operation = ? and t_prevdate = ? and t_client = ? and t_Status=1";
            cmd2 = RsdCommand( SQL2 );
            cmd2.addParam( "t_dockind",  RSDBP_IN,   4608 );
            cmd2.addParam( "t_kind_operation", RSDBP_IN,   2038 );
            cmd2.addParam( "t_subkind_operation", RSDBP_IN,   10  );
            cmd2.addParam( "t_prevdate",  RSDBP_IN,   date(01, 01, OperData.T_TAXYEAR) );
            cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
            rs2 = TRSBDataSet(cmd2);
            if (rs2.movenext())
               tid = rs2.tid;
               SQL2 = "UPDATE dnptxop_dbt set t_tax = ? where t_dockind = ? and t_kind_operation = ? and t_subkind_operation = ? and t_prevdate = ? and t_client = ? and t_Status=1";
               cmd2 = RsdCommand( SQL2 );
               cmd2.addParam( "t_tax",   RSDBP_IN,   sumall /*OperData.T_SUM*/);
               cmd2.addParam( "t_dockind",  RSDBP_IN,   4608 );
               cmd2.addParam( "t_kind_operation", RSDBP_IN,   2038 );
               cmd2.addParam( "t_subkind_operation", RSDBP_IN,   10  );
               cmd2.addParam( "t_prevdate",  RSDBP_IN,   date(01, 01, OperData.T_TAXYEAR) );
               cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
               //cmd2.execute();
               // теперь это делаем со стороны Securities
 
               SQL2 = "INSERT into dnptxflag_dbt(t_id, t_status, t_date) values(?,?,sysdate)";
               cmd2 = RsdCommand(  SQL2 );
               cmd2.addParam( "t_id",   RSDBP_IN,   tid);
               cmd2.addParam( "t_status",  RSDBP_IN,   1 );
               //cmd2.execute();
            else 
               ЗанестиЗаписьВПротокол(207, 120, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: не найдена открытая операция удержания НДФЛ по клиенту " + OperData.T_CLIENTID + " за " + OperData.T_TAXYEAR + " год.", rs.Value("T_INSTANCEDATE"));
               return false;
            end;
         else  // в основном, при выводе средств..
            if (OperData.T_SUM < 0)  // используем эту ветку только для возврата клиентам излишне удержанных средств
               SQL2 = "SELECT dnptxobj_dbt_seq.nextval a FROM dual";
               cmd2 = RsdCommand( SQL2 );
               rs2 = TRSBDataSet(cmd2);
               rs2.movenext();
               OperData.T_DEALID = rs2.a;

               var year = 0, Date_Oper = "";
               DateSplit(date(OperData.T_DATE), 0, 0, year);
               if (String(year) != OperData.t_taxyear)
                  Date_Oper = Date("31.12." + OperData.t_taxyear);
               else 
                  Date_Oper = date(OperData.T_DATE);
               end;

               SQL2 =  "insert into dnptxobj_dbt(t_objid, t_date, t_client, t_direction, t_level, t_user, t_kind, t_sum, t_cur, t_sum0, t_comment) " +
                       "values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
               cmd2 = RsdCommand( SQL2 );
               cmd2.addParam( "t_objid",  RSDBP_IN,   int(OperData.T_DEALID));
               cmd2.addParam( "t_date",  RSDBP_IN,   date(Date_Oper));
               cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
               cmd2.addParam( "t_direction",  RSDBP_IN,   2 );
               cmd2.addParam( "t_level",  RSDBP_IN,   8 );
               cmd2.addParam( "t_user",  RSDBP_IN,   "X" );
               cmd2.addParam( "t_kind",  RSDBP_IN,   870 );
               cmd2.addParam( "t_sum",   RSDBP_IN,   OperData.T_SUM );
               cmd2.addParam( "t_cur",   RSDBP_IN,   int(0) );
               cmd2.addParam( "t_sum0",  RSDBP_IN,   OperData.T_SUM );
               cmd2.addParam( "t_comment",  RSDBP_IN,   "Возврат средств клиенту" );
               cmd2.execute;
            end;
         end;   // конец куска по T_TAXPAYTYPE - при выводе средств
      end;   // конец ветки по T_TYPE - НДФЛ
   // обновление записей
   elif (Action == 2)
      if ((OperData.T_TYPE == 0) OR (OperData.T_TYPE == 1))   // ввод-вывод денсредств
      
      elif (OperData.T_TYPE == 3)  // внутренняя комиссия, не разнесенная по объектам.
         direction = TXOBJ_DIR_OUT;
         SQL2 =  "update dnptxobj_dbt set t_date = ?, t_client = ?, t_direction = ?, t_level = ?, t_user=chr(0), t_kind = ?, t_cur = ?, t_sum = ?, t_sum0 = ? where t_objid = ?";
         cmd2 = RsdCommand( SQL2 );
         cmd2.addParam( "t_date",  RSDBP_IN,   date(OperData.T_DATE));
         cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
         cmd2.addParam( "t_direction",  RSDBP_IN,   direction );
         cmd2.addParam( "t_level",  RSDBP_IN,   4 );
         cmd2.addParam( "t_kind",  RSDBP_IN,   520 );
         cmd2.addParam( "t_cur",   RSDBP_IN,   OperData.T_FIID);
         cmd2.addParam( "t_sum",   RSDBP_IN,   OperData.T_SUM );
         cmd2.addParam( "t_sum0",  RSDBP_IN,   OperData.T_SUM );
         cmd2.addParam( "t_objid",  RSDBP_IN,   OperData.T_DEALID );
         cmd2.execute;
      elif (OperData.T_TYPE == 4)  // финрез по операциям с деривативами.
         if (OperData.T_FUTOPERTYPE == 1)
            direction = TXOBJ_DIR_IN;
            FutType = 640; // Доходы по обращающимся ПИ фондового рынка
         elif (OperData.T_FUTOPERTYPE == 2)
            direction = TXOBJ_DIR_OUT;
            FutType = 770; // Все расходы по обращающимся ПИ фондового рынка
         elif (OperData.T_FUTOPERTYPE == 3)
            direction = TXOBJ_DIR_IN;
            FutType = 650; // Доходы по обращающимся ПИ не-фондового рынка
         elif (OperData.T_FUTOPERTYPE == 4)
            direction = TXOBJ_DIR_OUT;
            FutType = 780; // Все расходы по обращающимся ПИ не-фондового рынка 
         end;
         // Сравним с последней суммой дохода ( по этому клиенту в течение года )

         SQL2 = "select nvl(sum(T_SUM),0) T_SUMALL from dnptxobj_dbt where t_client = ? and t_date>? and t_direction = ? and t_level = ? and t_kind = ? order by t_date desc";
         cmd2 = RsdCommand( SQL2 );
         cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
         cmd2.addParam( "t_date",  RSDBP_IN,   date(1, 1, yyyy));
         cmd2.addParam( "t_direction",  RSDBP_IN,   direction );
         cmd2.addParam( "t_level",  RSDBP_IN,   5 );
         cmd2.addParam( "t_kind",  RSDBP_IN,   FutType );
         cmd2.execute;
         rs2 = TRSBDataSet(cmd2);
         if (rs2.movenext())    // нашли предыдущую запись по деривативам   
            pi_sum = OperData.T_SUM - rs2.T_SUMALL;  // корректируем сумму
            pi_sum0 = pi_sum;
            if (pi_sum < 0)
               ЗанестиЗаписьВПротокол(207, 120, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: новая сумма по FORTS клиента меньше предыдущей: операция " + OperData.T_CODE, rs.Value("T_INSTANCEDATE"));
               return false;
            end;
         else
            pi_sum = OperData.T_SUM;
            pi_sum0 = pi_sum;
         end;

         if (pi_sum > 0)
            SQL2 =  "update dnptxobj_dbt set  t_date = ?, t_client = ?, t_direction = ?, t_level = ?, t_user=chr(0), t_kind = ?, t_cur = ?, t_sum = ?, t_sum0 = ? where t_objid = ? ";
            cmd2 = RsdCommand( SQL2 );
            cmd2.addParam( "t_date",  RSDBP_IN,   date(OperData.T_DATE));
            cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
            cmd2.addParam( "t_direction",  RSDBP_IN,   direction );
            cmd2.addParam( "t_level",  RSDBP_IN,   5 );
            cmd2.addParam( "t_kind",  RSDBP_IN,   FutType );
            cmd2.addParam( "t_cur",   RSDBP_IN,   OperData.T_FIID);
            cmd2.addParam( "t_sum",   RSDBP_IN,   pi_sum );
            cmd2.addParam( "t_sum0",  RSDBP_IN,   pi_sum0 );
            cmd2.addParam( "t_objid",  RSDBP_IN,   OperData.T_DEALID );
            cmd2.execute;
         end;
      elif (OperData.T_TYPE == 2)  // операция удержания НДФЛ
         SQL2 = "SELECT count(1) cou from dnptxop_dbt where t_dockind = ? and t_code = ?";
         cmd2 = RsdCommand( SQL2 );
         cmd2.addParam( "t_dockind",  RSDBP_IN,   4608 );
         cmd2.addParam( "t_code",  RSDBP_IN,   OperData.T_CODE );
         rs2 = TRSBDataSet(cmd2);
         rs2.movenext();
         if (rs2.cou > 0) 
            ЗанестиЗаписьВПротокол(207, 120, rs.value("T_DEALID"), 1, StrFor(1), "Ошибка: невозможно обновить; операция с кодом " + OperData.T_CODE + " и типом 4608 уже существует в dnptxop_dbt", rs.Value("T_INSTANCEDATE"));
            return false;
         end;
         TaxType = 20;  // OperData.T_TAXPAYTYPE * 10; // Кодировка: 10-окончание года, 20-вывод д/с, 30-вывод ц/б, 40-матвыгода, 50-закрытие договора.
             
         SQL2 =  "update dnptxop_dbt set "+
                 "t_dockind = ?, "+
                 "t_kind_operation = ?, "+
                 "t_subkind_operation = ?, "+
                 "t_code=LPAD(?,5,'0'), "+
                 "t_operdate = ?, "+
                 "t_client = ?, "+
                 "t_contract= (select max(t_id) from dsfcontr_dbt where t_partyid = ?), "+
                 "t_prevdate = ?, "+
                 "t_placekind = ?, "+
                 "t_place = ?, "+
                 "t_taxbase = ?, "+
                 "t_outsum = ?, "+
                 "t_outcost = ?, "+
                 "t_tout = ?, "+
                 "t_totaltaxsum = ?, "+
                 "t_prevtaxsum = ?, "+
                 "t_taxsum = ?, "+
                 "t_method = ?, "+
                 "t_account = ?, "+
                 "t_currency = ?, "+
                 "t_status = ?, "+
                 "t_oper = ?, "+
                 "t_department = ? " +
                 "where t_id = ?";

         cmd2 = RsdCommand( SQL2 );
         cmd2.addParam( "t_dockind",  RSDBP_IN,   4608 );
         cmd2.addParam( "t_kind_operation", RSDBP_IN,   2038 );
         cmd2.addParam( "t_subkind_operation", RSDBP_IN,   TaxType );
         cmd2.addParam( "t_code",  RSDBP_IN,   OperData.T_CODE );
         cmd2.addParam( "t_operdate",  RSDBP_IN,   date(OperData.T_DATE) );
         cmd2.addParam( "t_client",  RSDBP_IN,   OperData.T_CLIENTID );
         cmd2.addParam( "t_contract",  RSDBP_IN,   OperData.T_CLIENTID );
         cmd2.addParam( "t_prevdate",  RSDBP_IN,   date(01, 01, OperData.T_TAXYEAR) );
         cmd2.addParam( "t_placekind",  RSDBP_IN,   0  );
         cmd2.addParam( "t_place",  RSDBP_IN,   0  );
         cmd2.addParam( "t_taxbase",  RSDBP_IN,   0  );
         cmd2.addParam( "t_outsum",  RSDBP_IN,   0  );
         cmd2.addParam( "t_outcost",  RSDBP_IN,   0  );
         cmd2.addParam( "t_out",   RSDBP_IN,   0  );
         cmd2.addParam( "t_totaltaxsum",  RSDBP_IN,   0  );
         cmd2.addParam( "t_prevtaxsum",  RSDBP_IN,   0  );
         cmd2.addParam( "t_taxsum",  RSDBP_IN,   OperData.T_SUM);
         cmd2.addParam( "t_tax",   RSDBP_IN,   OperData.T_SUM);
         cmd2.addParam( "t_method",  RSDBP_IN,   20  );
         cmd2.addParam( "t_account",  RSDBP_IN,   ""  );
         cmd2.addParam( "t_currency",  RSDBP_IN,   0  );
         cmd2.addParam( "t_status",  RSDBP_IN,   0  );
         cmd2.addParam( "t_oper",  RSDBP_IN,   {oper} );
         cmd2.addParam( "t_department",  RSDBP_IN,   1  );
         cmd2.addParam( "t_id",   RSDBP_IN,   int(OperData.T_DEALID));
         cmd2.execute;
      end;
   end;
   return true; 
onerror(er)
   return false;     
END;
