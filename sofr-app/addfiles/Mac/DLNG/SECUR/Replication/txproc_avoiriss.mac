/*
$Name:             txproc_avoiriss.mac
$Module:           БОЦБ 
$Description:      Макрос репликации ц/б
*/
import txproc_avr_fun, txrepl_func;

private var SQL, cmd, rs, Счетчик, MaxVal;

macro Process_Avoiriss()
   var AvoirData = TAvoirData();
   var SQL1, cmd1, rs1;

   if (rs.Value("T_ACTION") == 1)
      AvoirData.T_AVOIRISSID = rs.Value("T_AVOIRISSID");
   else
      AvoirData.T_AVOIRISSID =  ПолучитьСоответствие(20, rs.Value("T_AVOIRISSID"));
   end;
   AvoirData.T_CODE              = "";
   AvoirData.T_CODEINACCOUNT     = trim(rs.Value("T_CODEINACC"));
   AvoirData.T_KIND              = rs.Value("T_KIND");
   AvoirData.T_SHORTNAME         = trim(rs.Value("T_SHORTNAME"));
   AvoirData.T_DEFINITION        = trim(rs.Value("T_DEFINITION"));
   AvoirData.T_INVSTNAME         = trim(rs.Value("T_INVSTNAME"));
   if (rs.Value("T_SETTLEMENT_CODE") != NullVal)
      AvoirData.T_SETTLEMENT_CODE  = rs.Value("T_SETTLEMENT_CODE");
   end; 
   if (rs.Value("T_SUBKIND") != NullVal)
      AvoirData.T_SUBKIND       = rs.Value("T_SUBKIND");
   else
      AvoirData.T_SUBKIND       = 0;      
   end;
   if (rs.Value("T_EMISSIVE") != NullVal)
      AvoirData.T_EMISSIVE      = rs.Value("T_EMISSIVE");
   end;
   if (rs.Value("T_NOTSTANDART") != NullVal)
      AvoirData.T_NOTSTANDART  = rs.Value("T_NOTSTANDART");
   end;
   if (rs.Value("T_CFI") != NullVal)
      AvoirData.T_CFI             = rs.Value("T_CFI");
   else
      AvoirData.T_CFI = "";   
   end;
   if (rs.Value("T_TAXGROUP") != NullVal)    
      AvoirData.T_TAXGROUP = rs.Value("T_TAXGROUP"); 
   end; 
   if (rs.Value("T_INVSTTYPE") != NullVal)   
      AvoirData.T_INVSTTYPE = rs.Value("T_INVSTTYPE"); 
   end; 
   if (rs.Value("T_LSIN") != NullVal)
      AvoirData.T_LSIN  = trim(rs.Value("T_LSIN")); 
   end; 
   if (rs.Value("T_ISIN") != NullVal) 
      AvoirData.T_ISIN  = trim(rs.Value("T_ISIN")); 
   end;
   AvoirData.T_ISSUERID          = ПолучитьСоответствие(30, rs.Value("T_ISSUERID"));
   AvoirData.T_ISSUED            = rs.Value("T_ISSUED");
   AvoirData.T_INCIRCULATIONDATE = rs.Value("T_INCIRCULATIONDATE");
   AvoirData.T_DRAWINGDATE       = rs.Value("T_DRAWINGDATE");
   AvoirData.T_VTINCLUDEDATE     = sql_ConvTypeDate(rs.Value("T_VTINCLUDEDATE"));
   AvoirData.T_VTEXCLUDEDATE     = sql_ConvTypeDate(rs.Value("T_VTEXCLUDEDATE"));
   if (rs.Value("T_QTY")!=NullVal)
      AvoirData.T_QTY               = rs.Value("T_QTY");
   else
      AvoirData.T_QTY               = 0;
   end;
   AvoirData.T_FACEVALUE         = rs.Value("T_FACEVALUE");
   if (rs.Value("T_FACEVALUEFIID") != 0)
      AvoirData.T_FACEVALUEFIID     = ПолучитьСоответствие(10, rs.Value("T_FACEVALUEFIID"));
   else 
      AvoirData.T_FACEVALUEFIID     = ПолучитьСоответствие(10, 2);
   end;
   AvoirData.T_FIRSTPRICE        = rs.Value("T_FIRSTPRICE");
  if (rs.Value("T_INCOMERATE") != NullVal)
     AvoirData.T_INCOMERATE = rs.Value("T_INCOMERATE");
  else
     AvoirData.T_INCOMERATE = 1; 
  end;
   AvoirData.T_BASEFIID          = ПолучитьСоответствие(20, rs.Value("T_BASEFIID"));
   if (rs.Value("T_NKDBASE_KIND") != NullVal)  
      AvoirData.T_NKDBASE_KIND = rs.Value("T_NKDBASE_KIND");
   else 
	  AvoirData.T_NKDBASE_KIND = 0;
   end;
   if (rs.Value("T_NKDROUND_KIND") != NullVal)
      AvoirData.T_NKDROUND_KIND = rs.Value("T_NKDROUND_KIND");
   else 
      AvoirData.T_NKDROUND_KIND = 0;
   end;

   if (rs.Value("T_NKDNONSTANDART") != NullVal)
   AvoirData.T_NKDNONSTANDART    = rs.Value("T_NKDNONSTANDART");
   end;

   if (rs.Value("T_SUMPRECISION") != NullVal)
      AvoirData.T_SUMPRECISION = rs.Value("T_SUMPRECISION");
   end;
   if (rs.Value("T_SCALE") != NullVal)
      AvoirData.T_SCALE = rs.Value("T_SCALE");
   end;
   AvoirData.T_POINT = 4;
   AvoirData.T_INSTANCEDATE      = rs.Value("T_INSTANCEDATE");
   AvoirData.InTRN               = TRUE;

   if (rs.Value("T_ACTION") == 2)
      if (ПроверитьНаРучноеИзменение(20, rs.value("T_AVOIRISSID")))
         ЗанестиЗаписьВПротокол(203, 20, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка: объект находится в режиме ручного редактирования, бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;
   end;

   if( ОбработатьЦБ( AvoirData, rs.Value("T_ACTION") ) == false )
      Return FALSE;
   else
      if (rs.Value("T_ACTION") == 1)
         SQL1 = "delete from DTXREPLOBJ_DBT where T_OBJECTTYPE=20 and t_objstate = 2 and t_objectid = " + rs.Value("T_AVOIRISSID");
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
         SQL1 = SQL1 + "T_OBJSTATE) values (20, " + rs.Value("T_AVOIRISSID") + ", 1, ";
         SQL1 = SQL1 + AvoirData.T_AVOIRISSID + " ,1 , 0)";

         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         SQL1 = "update DTXAVOIRISS_DBT set t_replstate = 1 where T_AVOIRISSID = " + rs.value("T_AVOIRISSID") + " and t_action = 1 and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));

         cmd1 = RsdCommand( SQL1);
         cmd1.execute;
      elif (rs.Value("T_ACTION") == 2)
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_BASEFIID", rs.Value("T_BASEFIID")))
            ЗанестиЗаписьВПротокол(105, 20, rs.Value("T_AVOIRISSID"), 1, "T_BASEFIID", "Предупреждение: изменение существенного атрибута 'Базовый выпуск', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_FACEVALUEFIID", rs.Value("T_FACEVALUEFIID")))
            ЗанестиЗаписьВПротокол(106, 20, rs.Value("T_AVOIRISSID"), 1, "T_FACEVALUEFIID", "Предупреждение: изменение существенного атрибута 'Валюта номинала', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_KIND", rs.Value("T_KIND")))
            ЗанестиЗаписьВПротокол(107, 20, rs.Value("T_AVOIRISSID"), 1, "T_KIND", "Предупреждение: изменение существенного атрибута 'Вид', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_NKDBASE_KIND", rs.Value("T_NKDBASE_KIND")))
            ЗанестиЗаписьВПротокол(108, 20, rs.Value("T_AVOIRISSID"), 1, "T_NKDBASE_KIND", "Предупреждение: изменение существенного атрибута 'Вид базиса расчета НКД', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_SUBKIND", rs.Value("T_SUBKIND")))
            ЗанестиЗаписьВПротокол(109, 20, rs.Value("T_AVOIRISSID"), 1, "T_SUBKIND", "Предупреждение: изменение существенного атрибута 'Вид облигации', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_NKDROUND_KIND", rs.Value("T_NKDROUND_KIND")))
            ЗанестиЗаписьВПротокол(110, 20, rs.Value("T_AVOIRISSID"), 1, "T_NKDROUND_KIND", "Предупреждение: изменение существенного атрибута 'Вид округления при расчете НКД', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_LSIN", rs.Value("T_LSIN")))
            ЗанестиЗаписьВПротокол(111, 20, rs.Value("T_AVOIRISSID"), 1, "T_LSIN", "Предупреждение: изменение существенного атрибута 'Государственный регистрационный номер', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_TAXGROUP", rs.Value("T_TAXGROUP")))
            ЗанестиЗаписьВПротокол(112, 20, rs.Value("T_AVOIRISSID"), 1, "T_TAXGROUP", "Предупреждение: изменение существенного атрибута 'Группа налогового учета', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_INCIRCULATIONDATE", rs.Value("T_INCIRCULATIONDATE")))
            ЗанестиЗаписьВПротокол(113, 20, rs.Value("T_AVOIRISSID"), 1, "T_INCIRCULATIONDATE", "Предупреждение: изменение существенного атрибута 'Дата ввода в обращение', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_ISSUED", rs.Value("T_ISSUED")))
            ЗанестиЗаписьВПротокол(114, 20, rs.Value("T_AVOIRISSID"), 1, "T_ISSUED", "Предупреждение: изменение существенного атрибута 'Дата выпуска', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_DRAWINGDATE", rs.Value("T_DRAWINGDATE")))
            ЗанестиЗаписьВПротокол(115, 20, rs.Value("T_AVOIRISSID"), 1, "T_DRAWINGDATE", "Предупреждение: изменение существенного атрибута 'Дата погашения', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_SHORTNAME", rs.Value("T_SHORTNAME")))
            ЗанестиЗаписьВПротокол(116, 20, rs.Value("T_AVOIRISSID"), 1, "T_SHORTNAME", "Предупреждение: изменение существенного атрибута 'Краткое наименование', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_SCALE", rs.Value("T_SCALE")))
            ЗанестиЗаписьВПротокол(117, 20, rs.Value("T_AVOIRISSID"), 1, "T_SCALE", "Предупреждение: изменение существенного атрибута 'Масштаб курса', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_ISIN", rs.Value("T_ISIN")))
            ЗанестиЗаписьВПротокол(118, 20, rs.Value("T_AVOIRISSID"), 1, "T_ISIN", "Предупреждение: изменение существенного атрибута 'Международный идентификационный номер', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_INVSTNAME", rs.Value("T_INVSTNAME")))
            ЗанестиЗаписьВПротокол(119, 20, rs.Value("T_AVOIRISSID"), 1, "T_INVSTNAME", "Предупреждение: изменение существенного атрибута 'Наименование фонда', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_NKDNONSTANDART", rs.Value("T_NKDNONSTANDART")))
            ЗанестиЗаписьВПротокол(120, 20, rs.Value("T_AVOIRISSID"), 1, "T_NKDNONSTANDART", "Предупреждение: изменение существенного атрибута 'Нестандартные правила расчета НКД', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_FACEVALUE", rs.Value("T_FACEVALUE")))
            ЗанестиЗаписьВПротокол(121, 20, rs.Value("T_AVOIRISSID"), 1, "T_FACEVALUE", "Предупреждение: изменение существенного атрибута 'Номинал', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_DEFINITION", rs.Value("T_DEFINITION")))
            ЗанестиЗаписьВПротокол(122, 20, rs.Value("T_AVOIRISSID"), 1, "T_DEFINITION", "Предупреждение: изменение существенного атрибута 'Описание', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_FIRSTPRICE", rs.Value("T_FIRSTPRICE")))
            ЗанестиЗаписьВПротокол(123, 20, rs.Value("T_AVOIRISSID"), 1, "T_FIRSTPRICE", "Предупреждение: изменение существенного атрибута 'Цена первичного размещения', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(20, rs.Value("T_AVOIRISSID"), "T_ISSUERID", rs.Value("T_ISSUERID")))
            ЗанестиЗаписьВПротокол(124, 20, rs.Value("T_AVOIRISSID"), 1, "T_ISSUERID", "Предупреждение: изменение существенного атрибута 'Эмитент', бумага " + trim(rs.Value("T_DEFINITION")), rs.Value("T_INSTANCEDATE"));
         end;

         SQL1 = "update DTXAVOIRISS_DBT set t_replstate = 1 where T_AVOIRISSID = " + rs.value("T_AVOIRISSID") + " and t_action = 2 and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));

         cmd1 = RsdCommand( SQL1);
         cmd1.execute;
      elif (rs.Value("T_ACTION") == 3)
         SQL1 = "update DTXAVOIRISS_DBT set t_replstate = 1 where T_AVOIRISSID = " + rs.value("T_AVOIRISSID") + " and t_action = 3 and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));

         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         SQL1 = "update DTXREPLOBJ_DBT ots set ots.T_OBJSTATE = 2 where ots.T_OBJECTTYPE = 20 and ots.T_OBJECTID = " + rs.value("T_AVOIRISSID");

         cmd1 = RsdCommand( SQL1);
         cmd1.execute;
      end;

      Return TRUE;
   end;
OnError(er)
   if (Trim(er.message) != "Error:")
      println(er.message);
      ЗанестиЗаписьВПротокол(600, 20, rs.value("T_AVOIRISSID"), 1, StrFor(1), "Ошибка: " + er.message, rs.Value("T_INSTANCEDATE"));
   end;
   AbortTrn;
end;

macro Обработать_ЦБумагу(Action, t_instancedate, Init_Action:String)
   SQL = "select count(*) from DTXAVOIRISS_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate;
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
      MaxVal = rs.Value(0);
   end;

   var ProgressIndicator = CreateProgressIndicator(true);
   ProgressIndicator.Start(Int(MaxVal), "Обработка ценных бумаг...");

   Счетчик = 0;
   SQL = "select * from DTXAVOIRISS_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate + " order by t_avoirissid";
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);
  
   while (rs.Movenext)
      Счетчик = Счетчик + 1;

      ProgressIndicator.Update(Int(Счетчик), MaxVal);
   
      if (not ProcessTrn(Null, "Process_Avoiriss"))
      end;
   end;

   ProgressIndicator.Stop();

   return TRUE;
OnError(er)
   ЗанестиЗаписьВПротокол(600, 20, "", "", StrFor(1), "Ошибка: " + er.message, date(t_instancedate));
end;