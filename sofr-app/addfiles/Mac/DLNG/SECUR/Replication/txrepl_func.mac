/*
$Name:             txrepl_func.mac
$Module:           БОЦБ 
$Description:      Общие функции для репликации
*/
import RSD, globals, CTInter;
import "ws_progress.mac", "cb_sql.mac";

var {WebID};
const nulldate = "TO_DATE ('01.01.0001', 'DD.MM.YYYY')";
private var Env1 = RsdEnvironment("RDDrvO","RDDrvO.dll");
private var Con1 = RsdConnection(Env1, GetIniString( "CONNSTRING", "rsreq.ini" ));

macro ПолучитьПроцентДляЧП(Income, FIID)
   private var SQL, cmd, rs;

   SQL = "select t_facevalue from dfininstr_dbt where t_fiid = " + FIID;

   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return (Income / rs.Value(0)) * 100;
   end;

   Return 0;
end;

macro ПолучитьIDОперацииПоКомиссии(ComissID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT d.t_dealid ";
   SQL = SQL + "  FROM DTXDEAL_DBT d, ";
   SQL = SQL + "       (SELECT t_dealid ";
   SQL = SQL + "          FROM DTXCOMISS_DBT dm ";
   SQL = SQL + "         WHERE dm.t_comissid = ? ";
   SQL = SQL + "           AND TRUNC (dm.t_instancedate) = ? ) dd ";
   SQL = SQL + " WHERE d.t_dealid = dd.t_dealid ";
   SQL = SQL + "   AND d.t_replstate = 1 ";
   SQL = SQL + "   AND d.t_action IN (1, 2) ";
   SQL = SQL + "   AND d.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "             FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "            WHERE d1.t_dealid = dd.t_dealid ";
   SQL = SQL + "              AND d1.t_replstate = 1 ";
   SQL = SQL + "              AND (d1.t_action = 1 OR d1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("ComissID", RSDBP_IN, ComissID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return Trim(String(rs.Value(0):15:0));
   end;

   Return "";
end;

macro ПолучитьIDОперацииПоТО(DemandID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT d.t_dealid ";
   SQL = SQL + "  FROM DTXDEAL_DBT d, ";
   SQL = SQL + "       (SELECT t_dealid ";
   SQL = SQL + "          FROM DTXDEMAND_DBT dm ";
   SQL = SQL + "         WHERE dm.t_demandid = ? ";
   SQL = SQL + "           AND TRUNC (dm.t_instancedate) = ? ) dd ";
   SQL = SQL + " WHERE d.t_dealid = dd.t_dealid ";
   SQL = SQL + "   AND d.t_replstate = 1 ";
   SQL = SQL + "   AND d.t_action IN (1, 2) ";
   SQL = SQL + "   AND d.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "             FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "            WHERE d1.t_dealid = dd.t_dealid ";
   SQL = SQL + "              AND d1.t_replstate = 1 ";
   SQL = SQL + "              AND (d1.t_action = 1 OR d1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("DemandID", RSDBP_IN, DemandID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return Trim(String(rs.Value(0):15:0));
   end;

   Return "";
end;

macro ПолучитьВидОперацииПоКомиссии(ComissID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT CASE d.t_kind ";
   SQL = SQL + "          WHEN 10 ";
   SQL = SQL + "             THEN 'Покупка' ";
   SQL = SQL + "          WHEN 20 ";
   SQL = SQL + "             THEN 'Продажа' ";
   SQL = SQL + "          WHEN 30 ";
   SQL = SQL + "             THEN 'Репо обратное' ";
   SQL = SQL + "          WHEN 40 ";
   SQL = SQL + "             THEN 'Репо прямое' ";
   SQL = SQL + "          WHEN 50 ";
   SQL = SQL + "             THEN 'Займ обратный' ";
   SQL = SQL + "          WHEN 60 ";
   SQL = SQL + "             THEN 'Займ прямой' ";
   SQL = SQL + "          WHEN 70 ";
   SQL = SQL + "             THEN 'Погашение выпуска' ";
   SQL = SQL + "          WHEN 80 ";
   SQL = SQL + "             THEN 'Погашение купона' ";
   SQL = SQL + "          WHEN 90 ";
   SQL = SQL + "             THEN 'Частичное погашение' ";
   SQL = SQL + "          WHEN 100 ";
   SQL = SQL + "             THEN 'Получение дивидендов' ";
   SQL = SQL + "          WHEN 110 ";
   SQL = SQL + "             THEN 'Неттинг' ";
   SQL = SQL + "       END t_kind ";
   SQL = SQL + "  FROM DTXDEAL_DBT d, ";
   SQL = SQL + "       (SELECT t_dealid ";
   SQL = SQL + "          FROM DTXCOMISS_DBT dm ";
   SQL = SQL + "         WHERE dm.t_comissid = ? ";
   SQL = SQL + "           AND TRUNC (dm.t_instancedate) = ? ) dd ";
   SQL = SQL + " WHERE d.t_dealid = dd.t_dealid ";
   SQL = SQL + "   AND d.t_replstate = 1 ";
   SQL = SQL + "   AND d.t_action IN (1, 2) ";
   SQL = SQL + "   AND d.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "             FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "            WHERE d1.t_dealid = dd.t_dealid ";
   SQL = SQL + "              AND d1.t_replstate = 1 ";
   SQL = SQL + "              AND (d1.t_action = 1 OR d1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("ComissID", RSDBP_IN, ComissID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьВидОперацииТО(DemandID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT CASE d.t_kind ";
   SQL = SQL + "          WHEN 10 ";
   SQL = SQL + "             THEN 'Покупка' ";
   SQL = SQL + "          WHEN 20 ";
   SQL = SQL + "             THEN 'Продажа' ";
   SQL = SQL + "          WHEN 30 ";
   SQL = SQL + "             THEN 'Репо обратное' ";
   SQL = SQL + "          WHEN 40 ";
   SQL = SQL + "             THEN 'Репо прямое' ";
   SQL = SQL + "          WHEN 50 ";
   SQL = SQL + "             THEN 'Займ обратный' ";
   SQL = SQL + "          WHEN 60 ";
   SQL = SQL + "             THEN 'Займ прямой' ";
   SQL = SQL + "          WHEN 70 ";
   SQL = SQL + "             THEN 'Погашение выпуска' ";
   SQL = SQL + "          WHEN 80 ";
   SQL = SQL + "             THEN 'Погашение купона' ";
   SQL = SQL + "          WHEN 90 ";
   SQL = SQL + "             THEN 'Частичное погашение' ";
   SQL = SQL + "          WHEN 100 ";
   SQL = SQL + "             THEN 'Получение дивидендов' ";
   SQL = SQL + "          WHEN 110 ";
   SQL = SQL + "             THEN 'Неттинг' ";
   SQL = SQL + "       END t_kind ";
   SQL = SQL + "  FROM DTXDEAL_DBT d, ";
   SQL = SQL + "       (SELECT t_dealid ";
   SQL = SQL + "          FROM DTXDEMAND_DBT dm ";
   SQL = SQL + "         WHERE dm.t_demandid = ? ";
   SQL = SQL + "           AND TRUNC (dm.t_instancedate) = ? ) dd ";
   SQL = SQL + " WHERE d.t_dealid = dd.t_dealid ";
   SQL = SQL + "   AND d.t_replstate = 1 ";
   SQL = SQL + "   AND d.t_action IN (1, 2) ";
   SQL = SQL + "   AND d.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "             FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "            WHERE d1.t_dealid = dd.t_dealid ";
   SQL = SQL + "              AND d1.t_replstate = 1 ";
   SQL = SQL + "              AND (d1.t_action = 1 OR d1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("DemandID", RSDBP_IN, DemandID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьВидОперацииSK(DealID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT CASE d.t_kind ";
   SQL = SQL + "          WHEN 10 ";
   SQL = SQL + "             THEN 'Покупка' ";
   SQL = SQL + "          WHEN 20 ";
   SQL = SQL + "             THEN 'Продажа' ";
   SQL = SQL + "          WHEN 30 ";
   SQL = SQL + "             THEN 'Репо обратное' ";
   SQL = SQL + "          WHEN 40 ";
   SQL = SQL + "             THEN 'Репо прямое' ";
   SQL = SQL + "          WHEN 50 ";
   SQL = SQL + "             THEN 'Займ обратный' ";
   SQL = SQL + "          WHEN 60 ";
   SQL = SQL + "             THEN 'Займ прямой' ";
   SQL = SQL + "          WHEN 70 ";
   SQL = SQL + "             THEN 'Погашение выпуска' ";
   SQL = SQL + "          WHEN 80 ";
   SQL = SQL + "             THEN 'Погашение купона' ";
   SQL = SQL + "          WHEN 90 ";
   SQL = SQL + "             THEN 'Частичное погашение' ";
   SQL = SQL + "          WHEN 100 ";
   SQL = SQL + "             THEN 'Получение дивидендов' ";
   SQL = SQL + "          WHEN 110 ";
   SQL = SQL + "             THEN 'Неттинг' ";
   SQL = SQL + "       END t_kind ";
   SQL = SQL + "  FROM DTXDEAL_DBT d ";
   SQL = SQL + " WHERE d.t_dealid = ? ";
   SQL = SQL + "   AND TRUNC (d.t_instancedate) = ? ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("DealID", RSDBP_IN, DealID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьКодБумагиПоКомиссии(ComissID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT a.t_code ";
   SQL = SQL + "  FROM DTXAVOIRISS_DBT a, ";
   SQL = SQL + "       (SELECT d.t_avoirissid ";
   SQL = SQL + "          FROM DTXDEAL_DBT d ";
   SQL = SQL + "         WHERE d.t_dealid = ";
   SQL = SQL + "                  (SELECT d.t_dealid ";
   SQL = SQL + "                     FROM DTXCOMISS_DBT d ";
   SQL = SQL + "                    WHERE d.t_comissid = ? ";
   SQL = SQL + "                      AND TRUNC (d.t_instancedate) = ?) ";
   SQL = SQL + "           AND d.t_replstate = 1 ";
   SQL = SQL + "           AND d.t_action IN (1, 2) ";
   SQL = SQL + "           AND d.t_instancedate = ";
   SQL = SQL + "                  (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "                     FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "                    WHERE d1.t_dealid = ";
   SQL = SQL + "                             (SELECT d.t_dealid ";
   SQL = SQL + "                                FROM DTXCOMISS_DBT d ";
   SQL = SQL + "                               WHERE d.t_comissid = ? ";
   SQL = SQL + "                                 AND TRUNC (d.t_instancedate) = ?) ";
   SQL = SQL + "                      AND d1.t_replstate = 1 ";
   SQL = SQL + "                      AND (d1.t_action = 1 OR d1.t_action = 2))) d1 ";
   SQL = SQL + " WHERE a.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "   AND a.t_replstate = 1 ";
   SQL = SQL + "   AND a.t_action IN (1, 2) ";
   SQL = SQL + "   AND a.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (a1.t_instancedate) ";
   SQL = SQL + "             FROM DTXAVOIRISS_DBT a1 ";
   SQL = SQL + "            WHERE a1.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "              AND a1.t_replstate = 1 ";
   SQL = SQL + "              AND (a1.t_action = 1 OR a1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("ComissID1", RSDBP_IN, ComissID);
   cmd.AddParam("InstanceDate1", RSDBP_IN, InstanceDate);
   cmd.AddParam("ComissID2", RSDBP_IN, ComissID);
   cmd.AddParam("InstanceDate2", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьНаименованиеБумагиПоКомиссии(ComissID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT a.t_shortname ";
   SQL = SQL + "  FROM DTXAVOIRISS_DBT a, ";
   SQL = SQL + "       (SELECT d.t_avoirissid ";
   SQL = SQL + "          FROM DTXDEAL_DBT d ";
   SQL = SQL + "         WHERE d.t_dealid = ";
   SQL = SQL + "                  (SELECT d.t_dealid ";
   SQL = SQL + "                     FROM DTXCOMISS_DBT d ";
   SQL = SQL + "                    WHERE d.t_comissid = ? ";
   SQL = SQL + "                      AND TRUNC (d.t_instancedate) = ?) ";
   SQL = SQL + "           AND d.t_replstate = 1 ";
   SQL = SQL + "           AND d.t_action IN (1, 2) ";
   SQL = SQL + "           AND d.t_instancedate = ";
   SQL = SQL + "                  (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "                     FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "                    WHERE d1.t_dealid = ";
   SQL = SQL + "                             (SELECT d.t_dealid ";
   SQL = SQL + "                                FROM DTXCOMISS_DBT d ";
   SQL = SQL + "                               WHERE d.t_comissid = ? ";
   SQL = SQL + "                                 AND TRUNC (d.t_instancedate) = ?) ";
   SQL = SQL + "                      AND d1.t_replstate = 1 ";
   SQL = SQL + "                      AND (d1.t_action = 1 OR d1.t_action = 2))) d1 ";
   SQL = SQL + " WHERE a.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "   AND a.t_replstate = 1 ";
   SQL = SQL + "   AND a.t_action IN (1, 2) ";
   SQL = SQL + "   AND a.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (a1.t_instancedate) ";
   SQL = SQL + "             FROM DTXAVOIRISS_DBT a1 ";
   SQL = SQL + "            WHERE a1.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "              AND a1.t_replstate = 1 ";
   SQL = SQL + "              AND (a1.t_action = 1 OR a1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("ComissID1", RSDBP_IN, ComissID);
   cmd.AddParam("InstanceDate1", RSDBP_IN, InstanceDate);
   cmd.AddParam("ComissID2", RSDBP_IN, ComissID);
   cmd.AddParam("InstanceDate2", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьКодБумагиПоТО(DemandID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT a.t_code ";
   SQL = SQL + "  FROM DTXAVOIRISS_DBT a, ";
   SQL = SQL + "       (SELECT MAX(d.t_avoirissid) t_avoirissid";
   SQL = SQL + "          FROM DTXDEAL_DBT d ";
   SQL = SQL + "         WHERE d.t_dealid = ";
   SQL = SQL + "                  (SELECT MAX(d.t_dealid) ";
   SQL = SQL + "                     FROM DTXDEMAND_DBT d ";
   SQL = SQL + "                    WHERE d.t_demandid = ? ";
   SQL = SQL + "                      AND TRUNC (d.t_instancedate) = ? ) ";
   SQL = SQL + "           AND d.t_replstate = 1 ";
   SQL = SQL + "           AND d.t_action IN (1, 2) ";
   SQL = SQL + "           AND d.t_instancedate = ";
   SQL = SQL + "                  (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "                     FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "                    WHERE d1.t_dealid = ";
   SQL = SQL + "                             (SELECT MAX(d.t_dealid) ";
   SQL = SQL + "                                FROM DTXDEMAND_DBT d ";
   SQL = SQL + "                               WHERE d.t_demandid = ? ";
   SQL = SQL + "                                 AND TRUNC (d.t_instancedate) = ? ) ";
   SQL = SQL + "                      AND d1.t_replstate = 1 ";
   SQL = SQL + "                      AND (d1.t_action = 1 OR d1.t_action = 2))) d1 ";
   SQL = SQL + " WHERE a.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "   AND a.t_replstate = 1 ";
   SQL = SQL + "   AND a.t_action IN (1, 2) ";
   SQL = SQL + "   AND a.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (a1.t_instancedate) ";
   SQL = SQL + "             FROM DTXAVOIRISS_DBT a1 ";
   SQL = SQL + "            WHERE a1.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "              AND a1.t_replstate = 1 ";
   SQL = SQL + "              AND (a1.t_action = 1 OR a1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("DemandID1", RSDBP_IN, DemandID);
   cmd.AddParam("InstanceDate1", RSDBP_IN, InstanceDate);
   cmd.AddParam("DemandID2", RSDBP_IN, DemandID);
   cmd.AddParam("InstanceDate2", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьНаименованиеБумагиПоТО(DemandID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT a.t_shortname ";
   SQL = SQL + "  FROM DTXAVOIRISS_DBT a, ";
   SQL = SQL + "       (SELECT MAX(d.t_avoirissid) t_avoirissid";
   SQL = SQL + "          FROM DTXDEAL_DBT d ";
   SQL = SQL + "         WHERE d.t_dealid = ";
   SQL = SQL + "                  (SELECT MAX(d.t_dealid) ";
   SQL = SQL + "                     FROM DTXDEMAND_DBT d ";
   SQL = SQL + "                    WHERE d.t_demandid = ? ";
   SQL = SQL + "                      AND TRUNC (d.t_instancedate) = ? ) ";
   SQL = SQL + "           AND d.t_replstate = 1 ";
   SQL = SQL + "           AND d.t_action IN (1, 2) ";
   SQL = SQL + "           AND d.t_instancedate = ";
   SQL = SQL + "                  (SELECT MAX (d1.t_instancedate) ";
   SQL = SQL + "                     FROM DTXDEAL_DBT d1 ";
   SQL = SQL + "                    WHERE d1.t_dealid = ";
   SQL = SQL + "                             (SELECT MAX(d.t_dealid) ";
   SQL = SQL + "                                FROM DTXDEMAND_DBT d ";
   SQL = SQL + "                               WHERE d.t_demandid = ? ";
   SQL = SQL + "                                 AND TRUNC (d.t_instancedate) = ? ) ";
   SQL = SQL + "                      AND d1.t_replstate = 1 ";
   SQL = SQL + "                      AND (d1.t_action = 1 OR d1.t_action = 2))) d1 ";
   SQL = SQL + " WHERE a.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "   AND a.t_replstate = 1 ";
   SQL = SQL + "   AND a.t_action IN (1, 2) ";
   SQL = SQL + "   AND a.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (a1.t_instancedate) ";
   SQL = SQL + "             FROM DTXAVOIRISS_DBT a1 ";
   SQL = SQL + "            WHERE a1.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "              AND a1.t_replstate = 1 ";
   SQL = SQL + "              AND (a1.t_action = 1 OR a1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("DemandID1", RSDBP_IN, DemandID);
   cmd.AddParam("InstanceDate1", RSDBP_IN, InstanceDate);
   cmd.AddParam("DemandID2", RSDBP_IN, DemandID);
   cmd.AddParam("InstanceDate2", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьКодБумагиПоСделке(DealID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT a.t_code ";
   SQL = SQL + "  FROM DTXAVOIRISS_DBT a, ";
   SQL = SQL + "       (SELECT d.t_avoirissid ";
   SQL = SQL + "          FROM DTXDEAL_DBT d ";
   SQL = SQL + "         WHERE d.t_dealid = ? ";
   SQL = SQL + "           AND TRUNC (d.t_instancedate) = ? ) d1 ";
   SQL = SQL + " WHERE a.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "   AND a.t_replstate = 1 ";
   SQL = SQL + "   AND a.t_action IN (1, 2) ";
   SQL = SQL + "   AND a.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (a1.t_instancedate) ";
   SQL = SQL + "             FROM DTXAVOIRISS_DBT a1 ";
   SQL = SQL + "            WHERE a1.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "              AND a1.t_replstate = 1 ";
   SQL = SQL + "              AND (a1.t_action = 1 OR a1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("DealID", RSDBP_IN, DealID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьНаименованиеБумагиПоСделке(DealID, InstanceDate)
   private var SQL, cmd, rs;

   SQL = " SELECT a.t_shortname ";
   SQL = SQL + "  FROM DTXAVOIRISS_DBT a, ";
   SQL = SQL + "       (SELECT d.t_avoirissid ";
   SQL = SQL + "          FROM DTXDEAL_DBT d ";
   SQL = SQL + "         WHERE d.t_dealid = ? ";
   SQL = SQL + "           AND TRUNC (d.t_instancedate) = ? ) d1 ";
   SQL = SQL + " WHERE a.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "   AND a.t_replstate = 1 ";
   SQL = SQL + "   AND a.t_action IN (1, 2) ";
   SQL = SQL + "   AND a.t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (a1.t_instancedate) ";
   SQL = SQL + "             FROM DTXAVOIRISS_DBT a1 ";
   SQL = SQL + "            WHERE a1.t_avoirissid = d1.t_avoirissid ";
   SQL = SQL + "              AND a1.t_replstate = 1 ";
   SQL = SQL + "              AND (a1.t_action = 1 OR a1.t_action = 2)) ";

   cmd = RsdCommand( SQL);
   cmd.AddParam("DealID", RSDBP_IN, DealID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьДатуУчетаСделки( DealID, InstanceDate )
   private var SQL, cmd, rs;

   SQL = " SELECT d.t_BalanceDate "
       + "   FROM DTXDEAL_DBT d "
       + "  WHERE d.t_dealid = ? "
       + "    AND TRUNC(d.t_instancedate) = ? ";

   cmd = RsdCommand(SQL);
   cmd.AddParam("DealID", RSDBP_IN, DealID);
   cmd.AddParam("InstanceDate", RSDBP_IN, InstanceDate);

   rs = RsdRecordSet(cmd);

   if( (rs.Movenext) and (rs.Value(0) != NullVal) )
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьКодБумаги(FIID)
   private var SQL, cmd, rs;

   SQL = "select t_fi_code from dfininstr_dbt where t_fiid = " + FIID;

   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   else
      Return "Неизвестно";
   end;  
end;

macro DateStamp(InDateStamp, innertime)
   private var DT, TM;

   if (ValType(InDateStamp) == V_DATE)
      Return InDateStamp;
   elif (ValType(InDateStamp) != V_DTTM)
      Return null;
   else
      DtTmSplit(InDateStamp, DT, TM);
      SetParm(1, TM);
      Return DT;
   end;
end;

macro GenerateReference_SK()
   private var SQL, cmd, rs;

   SQL =       "SELECT max(to_number(t_code)) FROM ( ";
   SQL = SQL + "SELECT * FROM DOBJCODE_DBT ";
   SQL = SQL + "WHERE t_codekind = 1 ";
   SQL = SQL + "AND t_objecttype = 3 ";
   SQL = SQL + "MINUS (";
   SQL = SQL + "SELECT * FROM DOBJCODE_DBT ";
   SQL = SQL + "WHERE NOT LENGTH (TRANSLATE(t_code, '_1234567890', '_' )) = 0))";

   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)

      if (rs.Value(0) == NullVal)
         Return "1";
      end;

      Return trim(String((rs.Value(0) + 1):15:0));
   end;

   Return "";
end;

macro ПолучитьНаименованиеВалюты(t_fiid)
   private var SQL, cmd, rs;

   SQL = " SELECT t_name ";
   SQL = SQL + "  FROM DTXCURRENCY_DBT ";
   SQL = SQL + " WHERE t_fiid = " + t_fiid;
   SQL = SQL + "   AND t_replstate = 1 ";
   SQL = SQL + "   AND t_action IN (1, 2) ";
   SQL = SQL + "   AND t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (t_instancedate) ";
   SQL = SQL + "             FROM DTXCURRENCY_DBT ";
   SQL = SQL + "            WHERE t_fiid = " + t_fiid;
   SQL = SQL + "              AND t_replstate = 1 ";
   SQL = SQL + "              AND (t_action = 1 OR t_action = 2)) ";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro НомерОперацииПоID(t_id)
   private var SQL, cmd, rs;

   SQL = " SELECT t_extcode ";
   SQL = SQL + "  FROM DTXDEAL_DBT ";
   SQL = SQL + " WHERE t_dealid = " + t_id;
   SQL = SQL + "   AND t_replstate = 1 ";
   SQL = SQL + "   AND t_action IN (1, 2) ";
   SQL = SQL + "   AND t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (t_instancedate) ";
   SQL = SQL + "             FROM DTXDEAL_DBT ";
   SQL = SQL + "            WHERE t_dealid = " + t_id;
   SQL = SQL + "              AND t_replstate = 1 ";
   SQL = SQL + "              AND (t_action = 1 OR t_action = 2)) ";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьКодВалюты(t_fiid)
   private var SQL, cmd, rs;

   SQL = " SELECT t_iso_number ";
   SQL = SQL + "  FROM DTXCURRENCY_DBT ";
   SQL = SQL + " WHERE t_fiid = " + t_fiid;
   SQL = SQL + "   AND t_replstate = 1 ";
   SQL = SQL + "   AND t_action IN (1, 2) ";
   SQL = SQL + "   AND t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (t_instancedate) ";
   SQL = SQL + "             FROM DTXCURRENCY_DBT ";
   SQL = SQL + "            WHERE t_fiid = " + t_fiid;
   SQL = SQL + "              AND t_replstate = 1 ";
   SQL = SQL + "              AND (t_action = 1 OR t_action = 2)) ";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

macro ПолучитьНаименованиеСубъекта(t_partyid)
   private var SQL, cmd, rs;

   SQL = " SELECT t_fullname ";
   SQL = SQL + "  FROM DTXPARTY_DBT ";
   SQL = SQL + " WHERE t_partyid = " + t_partyid;
   SQL = SQL + "   AND t_replstate = 1 ";
   SQL = SQL + "   AND t_action IN (1, 2) ";
   SQL = SQL + "   AND t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (t_instancedate) ";
   SQL = SQL + "             FROM DTXPARTY_DBT ";
   SQL = SQL + "            WHERE t_partyid = " + t_partyid;
   SQL = SQL + "              AND t_replstate = 1 ";
   SQL = SQL + "              AND (t_action = 1 OR t_action = 2)) ";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return StrSubst(trim(rs.Value(0)), "'", "''");
   end;

   Return "";
end;

macro ПолучитьНаименованиеБумаги(t_avoirissid)
   private var SQL, cmd, rs;

   SQL = " SELECT t_shortname ";
   SQL = SQL + "  FROM DTXAVOIRISS_DBT ";
   SQL = SQL + " WHERE t_avoirissid = " + t_avoirissid;
   SQL = SQL + "   AND t_replstate = 1 ";
   SQL = SQL + "   AND t_action IN (1, 2) ";
   SQL = SQL + "   AND t_instancedate = ";
   SQL = SQL + "          (SELECT MAX (t_instancedate) ";
   SQL = SQL + "             FROM DTXAVOIRISS_DBT ";
   SQL = SQL + "            WHERE t_avoirissid = " + t_avoirissid;
   SQL = SQL + "              AND t_replstate = 1 ";
   SQL = SQL + "              AND (t_action = 1 OR t_action = 2)) ";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != NullVal))
      Return rs.Value(0);
   end;

   Return "";
end;

MACRO GetSQLDate_SK( _date )
   if ( _date != date(0,0,0) )
      return string( "TO_DATE( '",_date,"', 'DD.MM.YYYY' )" );
   else
      return "TO_DATE('01-01-0001', 'DD-MM-YYYY')";
   end;
end;

macro ЗанестиЗаписьВПротокол(T_MSGCODE, T_OBJTYPE, T_OBJECTID, T_SUBOBJNUM, T_FIELD, T_MESSAGE, T_INSTANCEDATE:Date)
   private var SQL, cmd, T_SEVERITY;

   if ((T_INSTANCEDATE == Null) or (ValType(T_INSTANCEDATE) == V_UNDEF))
      T_INSTANCEDATE = Date(0,0,0);
   end;

   if ((T_MSGCODE >= 0) and (T_MSGCODE <= 99))
      T_SEVERITY = 10;
   elif ((T_MSGCODE >= 100) and (T_MSGCODE <= 199))
      T_SEVERITY = 9;
   elif ((T_MSGCODE >= 200) and (T_MSGCODE <= 299))
      T_SEVERITY = 8;
   elif ((T_MSGCODE >= 300) and (T_MSGCODE <= 399))
      T_SEVERITY = 7;
   elif ((T_MSGCODE >= 400) and (T_MSGCODE <= 499))
      T_SEVERITY = 6;
   elif ((T_MSGCODE >= 500) and (T_MSGCODE <= 599))
      T_SEVERITY = 5;
   elif ((T_MSGCODE >= 600) and (T_MSGCODE <= 699))
      T_SEVERITY = 4;
   end;

   SQL = "insert into DTXLOADLOG_DBT (T_ID, T_MSGTIME, T_MSGCODE, T_SEVERITY, T_OBJTYPE, T_OBJECTID, ";
   SQL = SQL + "T_SUBOBJNUM, T_FIELD, T_MESSAGE, T_CORRECTION, T_CORRUSER, T_CORRTIME, T_INSTANCEDATE) values (";
   SQL = SQL + "0, ";                               /*T_ID           NUMBER(10)*/
   SQL = SQL + "(select SYSDATE from dual), ";      /*T_MSGTIME      DATE*/
   SQL = SQL + T_MSGCODE + ", ";                    /*T_MSGCODE      NUMBER(5)*/
   SQL = SQL + T_SEVERITY + ", ";                   /*T_SEVERITY     NUMBER(5)*/
   SQL = SQL + T_OBJTYPE + ", ";                    /*T_OBJTYPE      NUMBER(5)*/
   SQL = SQL + T_OBJECTID + ", ";                   /*T_OBJECTID     NUMBER(10)*/
   SQL = SQL + T_SUBOBJNUM + ", '";                 /*T_SUBOBJNUM    NUMBER(5)*/
   SQL = SQL + T_FIELD + "', '";                    /*T_FIELD        VARCHAR2(30)*/
   SQL = SQL + StrSubst(T_MESSAGE,"'","''") + "', ";/*T_MESSAGE      VARCHAR2(1000)*/
   SQL = SQL + "chr(0), ";                          /*T_CORRECTION   CHAR(1)*/
   SQL = SQL + "chr(1), ";                          /*T_CORRUSER     VARCHAR2(24)*/
   SQL = SQL + nulldate + ", ";                     /*T_CORRTIME     DATE*/
   SQL = SQL + GetSQLDate_SK(T_INSTANCEDATE) + ")"; /*T_INSTANCEDATE DATE*/

   cmd = RsdCommand(Con1, SQL);

   cmd.execute;

   Return TRUE;
OnError(er)
   println(er.message);
   AbortTrn;
end;

macro ЧтоИзменилосьвЗакрытойСделке (DealID:numeric, InstanceDate:date)
   private var SQL, cmd, rs, n = 0, razdposition;

   SQL = " SELECT DECODE (d1.t_kind, d2.t_kind, '-', 'T_KIND|Код на бирже'),"; 
   SQL = SQL +  "        DECODE (d1.t_extcode, d2.t_extcode, '-', 'T_EXTCODE|Код во внешней системе'),";      
   SQL = SQL +  "        DECODE (d1.t_marketcode, d2.t_marketcode, '-', 'T_MARKETCODE|Код на бирже'),";       
   SQL = SQL +  "        DECODE (d1.t_partycode, d2.t_partycode, '-', 'T_PARTYCODE|Код у контрагента'),";     
   SQL = SQL +  "        DECODE (d1.t_code, d2.t_code, '-', 'T_CODE|Код'),";                                  
   SQL = SQL +  "        DECODE (d1.t_date, d2.t_date, '-', 'T_DATE|Дата заключения сделки'),";               
   SQL = SQL +  "        DECODE (d1.t_time, d2.t_time, '-', 'T_TIME|Время заключения сделки'),";              
   SQL = SQL +  "        DECODE (d1.t_tskind, d2.t_tskind, '-', 'T_TSKIND|Режим торгов'),";                   
   SQL = SQL +  "        DECODE (d1.t_accounttype, d2.t_accounttype, '-', 'T_ACCOUNTTYPE|Тип расчетов'),";    
   SQL = SQL +  "        DECODE (d1.t_marketid, d2.t_marketid, '-', 'T_MARKETID|Идентификатор биржи'),";      
   SQL = SQL +  "        DECODE (d1.t_sector, d2.t_sector, '-', 'T_SECTOR|Идентификатор сектора биржи'),";    
   SQL = SQL +  "        DECODE (d1.t_brokerid, d2.t_brokerid, '-', 'T_BROKERID|Идентификатор брокера'),";   
   SQL = SQL +  "        DECODE (d1.t_partyid, d2.t_partyid, '-', 'T_PARTYID|Идентификатор контрагента'),";   
   SQL = SQL +  "        DECODE (d1.t_department, d2.t_department, '-', 'T_DEPARTMENT|Филиал'),";             
   SQL = SQL +  "        DECODE (d1.t_avoirissid,";                                                          
   SQL = SQL +  "                d2.t_avoirissid, '-',";
   SQL = SQL +  "                'T_AVOIRISSID|Идентификатор ценной бумаги'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_warrantid, d2.t_warrantid, '-', 'T_WARRANTID|Идентификатор купона'),";  
   SQL = SQL +  "        DECODE (d1.t_partialid,";                                                            
   SQL = SQL +  "                d2.t_partialid, '-',";
   SQL = SQL +  "                'T_PARTIALID|Идентификатор частичного погашения'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_amount, d2.t_amount, '-', 'T_AMOUNT|Количество ценных бумаг'),";        
   SQL = SQL +  "        DECODE (d1.t_currencyid,";                                                           
   SQL = SQL +  "                d2.t_currencyid, '-',";
   SQL = SQL +  "                'T_CURRENCYID|Идентификатор валюты сделки'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_price,";                                                               
   SQL = SQL +  "                d2.t_price, '-',";
   SQL = SQL +  "                'T_PRICE|Цена за шт. ценной бумаги не включая НКД'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_point, d2.t_point, '-', 'T_POINT|Точность цены'),";                     
   SQL = SQL +  "        DECODE (d1.t_cost, d2.t_cost, '-', 'T_COST|Стоимость ценных бумаг без НКД'),";       
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "           (d1.t_nkd,";                                                                      
   SQL = SQL +  "            d2.t_nkd, '-',";
   SQL = SQL +  "            'T_NKD|Накопленный купонный доход по поставляемым ценным бумагам в валюте номинала'";
   SQL = SQL +  "           ),";
   SQL = SQL +  "        DECODE (d1.t_totalcost, d2.t_totalcost, '-', 'T_TOTALCOST|Общая сумма по сделке'),"; 
   SQL = SQL +  "        DECODE (d1.t_rate, d2.t_rate, '-', 'T_RATE|Ставка'),";                               
   SQL = SQL +  "        DECODE (d1.t_price2,";                                                               
   SQL = SQL +  "                d2.t_price2, '-',";
   SQL = SQL +  "                'T_PRICE2|Цена за шт. ценной бумаги не включая НКД по 2 части Репо'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_cost2,";                                                                
   SQL = SQL +  "                d2.t_cost2, '-',";
   SQL = SQL +  "                'T_COST2|Стоимость ценных бумаг без НКД по 2 части Репо'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "           (d1.t_nkd2,";                                                                     
   SQL = SQL +  "            d2.t_nkd2, '-',";
   SQL = SQL +  "            'T_NKD2|Накопленный купонный доход по поставляемым ценным бумагам в валюте номинала по 2 части Репо'";
   SQL = SQL +  "           ),";
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "           (d1.t_totalcost2,";
   SQL = SQL +  "            d2.t_totalcost2, '-',";
   SQL = SQL +  "            'T_TOTALCOST2|Общая сумма по сделке вкл.  НКД в валюте сделки по 2 части Репо'";
   SQL = SQL +  "           ),";
   SQL = SQL +  "        DECODE (d1.t_paydate, d2.t_paydate, '-', 'T_PAYDATE|Плановая дата оплаты'),";
   SQL = SQL +  "        DECODE (d1.t_supldate, d2.t_supldate, '-', 'T_SUPLDATE|Плановая дата поставки'),";
   SQL = SQL +  "        DECODE (d1.t_paydate2,";
   SQL = SQL +  "                d2.t_paydate2, '-',";
   SQL = SQL +  "                'T_PAYDATE2|Плановая дата оплаты по 2 ч. Репо'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_supldate2,";
   SQL = SQL +  "                d2.t_supldate2, '-',";
   SQL = SQL +  "                'T_SUPLDATE2|Плановая дата поставки по 2 части Репо'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_contrnum, d2.t_contrnum, '-', 'T_CONTRNUM|Номер договора'),";
   SQL = SQL +  "        DECODE (d1.t_contrdate, d2.t_contrdate, '-', 'T_CONTRDATE|Дата  договора'),";
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "           (d1.t_costchange,";
   SQL = SQL +  "            d2.t_costchange, '-',";
   SQL = SQL +  "            'T_COSTCHANGE|Признак изменеия стоимости реализации/приобретения по 2 части Репо при выплате купонного дохода/дивидентов/частичного погашения ценных бумаг'";
   SQL = SQL +  "           ),";
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "           (d1.t_costchangeoncomp,";
   SQL = SQL +  "            d2.t_costchangeoncomp, '-',";
   SQL = SQL +  "            'T_COSTCHANGEONCOMP|Признак изменения стоимости при выплате компенсационного взноса - Признак изменения стоимости реализации/приобретения во 2 части Репо  при выплате компенсационного взноса'";
   SQL = SQL +  "           ),";
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "           (d1.t_costchangeonamor,";
   SQL = SQL +  "            d2.t_costchangeonamor, '-',";
   SQL = SQL +  "            'T_COSTCHANGEONAMOR|Признак изменения стоимости при выплате амортизации - Признак изменения стоимости реализации/приобретения по 2 части Репо при выплате амортизации'";
   SQL = SQL +  "           ),";
   SQL = SQL +  "        DECODE (d1.t_adjustment,";
   SQL = SQL +  "                d2.t_adjustment, '-',";
   SQL = SQL +  "                'T_ADJUSTMENT|Признак урегулирования требований'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "           (d1.t_needdemand,";
   SQL = SQL +  "            d2.t_needdemand, '-',";
   SQL = SQL +  "            'T_NEEDDEMAND|Признак, нужно ли создавать Т/О на стороне RS-Securities, или нет'";
   SQL = SQL +  "           ),";
   SQL = SQL +  "        DECODE";
   SQL = SQL +  "              (d1.t_atanyday,";
   SQL = SQL +  "               d2.t_atanyday, '-',";
   SQL = SQL +  "               'T_ATANYDAY|Признак означает, что сделка может быть выполнена в любой день'";
   SQL = SQL +  "              ),";
   SQL = SQL +  "        DECODE (d1.t_conditions,";
   SQL = SQL +  "                d2.t_conditions, '-',";
   SQL = SQL +  "                'T_CONDITIONS|Дополнительные условия'";
   SQL = SQL +  "               ),";
   SQL = SQL +  "        DECODE (d1.t_repobase, d2.t_repobase, '-', 'T_REPOBASE|База расчета')";
   SQL = SQL +  "   FROM DTXDEAL_DBT d1, DTXDEAL_DBT d2";
   SQL = SQL +  "  WHERE d1.t_dealid = " + DealID;
   SQL = SQL +  "    AND TRUNC (d1.t_instancedate) = " + GetSQLDate_SK(InstanceDate);
   SQL = SQL +  "    AND d2.t_dealid = d1.t_dealid";
   SQL = SQL +  "    AND d2.t_instancedate < d1.t_instancedate";
   SQL = SQL +  "    AND d2.t_instancedate =";
   SQL = SQL +  "           (SELECT MAX (t_instancedate)";
   SQL = SQL +  "              FROM DTXDEAL_DBT";
   SQL = SQL +  "             WHERE t_dealid = " + DealID;
   SQL = SQL +  "               AND (t_action = 1 OR t_action = 2)";
   SQL = SQL +  "               AND t_replstate = 1)";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      while (n != rs.FldCount)
         if (rs.Value(n) != "-")
            razdposition = index(rs.Value(n), "|");
            ЗанестиЗаписьВПротокол(167, 80, DealID, 1, substr(rs.Value(n), 1, razdposition - 1), "Предупреждение: изменение атрибута закрытой сделки - " + substr(rs.Value(n), razdposition + 1), InstanceDate);
         end;
         n = n + 1;
      end;
   end;
end;

macro ЗакрытаяСделка (DealID)
   private var SQL, cmd, rs;

   SQL = " SELECT count(rq.T_ID) ";
   SQL = SQL + "  FROM ddlrq_dbt rq ";
   SQL = SQL + " WHERE rq.t_docid = ?";
   SQL = SQL + "   AND rq.t_dockind IN (101, 117, 140, 158) ";
   SQL = SQL + "   AND rq.t_state = 2 ";
   SQL = SQL + "   AND EXISTS (SELECT 1 ";
   SQL = SQL + "                 FROM davoiriss_dbt a ";
   SQL = SQL + "                WHERE a.t_fiid = rq.t_fiid) ";

   cmd = RsdCommand(SQL);
   cmd.AddParam("DealID", RSDBP_IN, DealID);

   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) != 0))
      Return TRUE;
   end;

   Return FALSE;
end;

macro ПолучитьУзелТС(PartyID)
   private var SQL, cmd, rs;

   SQL = "select t_code from ddp_dep_dbt where t_partyid = " + PartyID;

   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return rs.Value(0);
   end;

   Return -1;
end;

macro ПолучитьIDАтрибута(ObjType, GroupID, Атрибут)
   private var SQL, cmd, rs;

   SQL = " SELECT t_attrid";
   SQL = SQL +  "   FROM dobjattr_dbt";
   SQL = SQL +  "  WHERE t_objecttype = " + ObjType + " AND t_groupid = " + GroupID + " AND t_nameobject = '" + Атрибут + "'";

   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return rs.Value(0);
   end;

   Return -1;
end;

macro ПолучитьВалютуНоминала(ID)
   private var SQL, cmd, rs;

   SQL = " SELECT t_facevaluefiid";
   SQL = SQL +  "   FROM DTXAVOIRISS_DBT";
   SQL = SQL +  "  WHERE t_avoirissid = " + ID;
   SQL = SQL +  "    AND t_instancedate =";
   SQL = SQL +  "           (SELECT MAX (t_instancedate)";
   SQL = SQL +  "              FROM DTXAVOIRISS_DBT";
   SQL = SQL +  "             WHERE t_avoirissid = " + ID;
   SQL = SQL +  "               AND t_replstate = 1";
   SQL = SQL +  "               AND (t_action = 1 OR t_action = 2))";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return rs.Value(0);
   end;

   Return -1;
end;

macro ПроверитьНаРучноеИзменение(objtype, objid)
   private var SQL, cmd, rs;

   if (objtype == 40)
      SQL = "select T_OBJSTATE from DTXREPLOBJ_DBT where T_OBJECTTYPE = " + objtype + " and T_SUBOBJNUM = " + objid;
   else
      SQL = "select T_OBJSTATE from DTXREPLOBJ_DBT where T_OBJECTTYPE = " + objtype + " and T_OBJECTID = " + objid;
   end;

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if ((rs.Movenext) and (rs.Value(0) == 1))
      Return TRUE;
   end;

   Return FALSE;
end;

macro СущественныйАтрибут(objtype, objid, field, fieldvalue, type)
   private var SQL, SQL1, cmd, rs;

   SQL = " SELECT " + field;

   if (objtype == 20)
      SQL1 = "   FROM DTXAVOIRISS_DBT";
      SQL1 = SQL1 +  "  WHERE  T_AVOIRISSID = " + objid;
   elif (objtype == 21)
      SQL1 = "   FROM DTXAVRATTR_DBT";
      SQL1 = SQL1 +  "  WHERE  T_AVOIRISSID = " + objid + " and T_TYPE = " + type;
   elif (objtype == 30)
      SQL1 = "   FROM DTXPARTY_DBT";
      SQL1 = SQL1 +  "  WHERE t_partyid = " + objid;
   elif ((objtype == 50) or (objtype == 60))
      SQL1 = "   FROM DTXFIWARNTS_DBT";
      SQL1 = SQL1 +  "  WHERE T_WARRANTID = " + objid;
   elif (objtype == 70)
      SQL1 = "   FROM DTXCOURSE_DBT";
      SQL1 = SQL1 +  "  WHERE T_COURSEID = " + objid + " and T_TYPE = " + type;
   elif (objtype == 80)
      SQL1 = "   FROM DTXDEAL_DBT";
      SQL1 = SQL1 +  "  WHERE t_dealid = " + objid;
   elif (objtype == 90)
      SQL1 = "   FROM DTXDEMAND_DBT";
      SQL1 = SQL1 +  "  WHERE  T_DEMANDID = " + objid;
   end;

   SQL = SQL +  SQL1 + "    AND (t_action = 1 OR t_action = 2) and t_replstate = 1";
   SQL = SQL +  "    AND t_instancedate =";
   SQL = SQL +  "                  (SELECT MAX (t_instancedate)";
   SQL = SQL + SQL1;
   SQL = SQL +  " AND (t_action = 1 OR t_action = 2) and t_replstate = 1)";

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);
  
   if (rs.Movenext)

      if (rs.Value(0) != fieldvalue)
         Return TRUE;
      end;

   end;

   Return FALSE;
end;

macro ПолучитьСоответствие(type_obj, objectid, objectsubid)
   private var SQL, cmd, rs;

   if (type_obj == 40)
      SQL = "select t_destsubobjnum from DTXREPLOBJ_DBT where t_objecttype = " + type_obj + " and t_objectid = " + objectid + " and t_objstate != 2";
      SQL = SQL + " and t_subobjnum = " + objectsubid;
   elif (type_obj == 70)
      SQL = " SELECT t_destid  FROM DTXREPLOBJ_DBT WHERE t_objecttype = " + type_obj + " AND t_objectid = " + objectid + " AND t_subobjnum = " + objectsubid;
   elif (type_obj == 444)
      Return 1;
   elif ((type_obj == 90) and ((objectsubid == 81) or (objectsubid == 82)))
      SQL = "select t_destid from DTXREPLOBJ_DBT where t_objecttype = " + type_obj + " and t_objectid = " + objectid + " and t_objstate != 2";
      SQL = SQL + " and t_subobjnum = " + objectsubid;
   else
      SQL = "select t_destid from DTXREPLOBJ_DBT where t_objecttype=" + type_obj + " and t_objectid=" + objectid + " and t_objstate != 2";
   end;

   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Return rs.Value(0);
   else
      Return -1;
   end;
end;

macro ДополнениеСлева(Что, Сколько, Чем)
   private var SQL, cmd, rs;

   SQL="select lpad('"+Что+"', "+Сколько+", '"+Чем+"') from dual";

   cmd=RsdCommand(SQL);
   
   rs=RsdRecordSet(cmd);

   if (rs.MoveNext)
      Return rs.Value(0);
   end;
end;

macro ПолучитьTimeStamp()
   private var SQL, cmd, rs;
   
   SQL="select sysdate from dual";
   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);

   if (rs.MoveNext)
      Return rs.Value(0);
   end;
end;

MACRO GetSQLTime( _time )
   return String("TO_DATE('01-01-0001 "+_time+"', 'DD-MM-YYYY HH24:MI:SS')");
end;

MACRO SetRQByPaym( paym, rq )
   var sql, cmd, rs;
   
   sql = "select t_fi_kind-1 t_subkind from dfininstr_Dbt where t_fiid = " + string(paym.Fiid);
   cmd = RsdCommand(SQL);
   rs  = RsdRecordSet(cmd);
   if (rs.MoveNext)
       rq.subkind = rs.Value(0);
   else
      if (paym.fiid < 10)
         rq.subkind = 0;
      else
         rq.subkind = 1;
      end;   
   end;

   if (paym.Purpose == 1)
      rq.type      =  8;
      rq.subkind   =  1;
      rq.dealpart  =  1;
   elif (paym.Purpose == 2)
      rq.type      =  2;
      rq.dealpart  =  1;
   elif (paym.Purpose == 3)
      rq.type      =  8;
      rq.subkind   =  1;
      rq.dealpart  =  2;
   elif (paym.Purpose == 4)
      rq.type      =  2;
      rq.dealpart  =  2;
   elif (paym.Purpose == 11)
      rq.type      =  3;
      rq.dealpart  =  2;
   elif (paym.Purpose == 40)
      rq.type      =  6;
      rq.dealpart  =  1;
   elif (paym.Purpose == 42)
      rq.type      =  0;
      rq.dealpart  =  1;
   elif (paym.Purpose == 43)
      rq.type      =  0;
      rq.dealpart  =  2;
   elif (paym.Purpose == 61)
      rq.type      =  4;
      rq.dealpart  =  2;
   elif (paym.Purpose == 62)
      rq.type      =  5;
      rq.dealpart  =  2;
   elif (paym.Purpose == 63)
      rq.type      =  2;
      //rq.dealpart  =  2;
   elif (paym.Purpose == 64)
      rq.type      =  9;
      rq.subkind   =  1;
      rq.dealpart  =  2;
   elif (paym.Purpose == 65)
      rq.type      =  7;
      rq.dealpart  =  2;
   elif (paym.Purpose == 66)
      rq.type      =  7;
      //rq.dealpart  =  2;
   elif (paym.Purpose == 67)
      rq.type      =  9;
      rq.subkind   =  1;
      rq.dealpart  =  2;
   else
      rq.type      =  0;
      rq.dealpart  =  1;
   end;
   
   if( paym.payer == 1 )
      rq.Kind = 1; // Обязательство
   else
      rq.Kind = 0;
   end;

   if( (paym.paymstatus == 32000) OR (paym.paymstatus == 150) )
      rq.State = 2;
      rq.FactDate = paym.ValueDate;
   else
      rq.State = 0;
      rq.FactDate = Date(0,0,0);
   end;

   if( paym.FutureReceiverAmount > paym.FuturePayerAmount )
      rq.Amount = paym.FutureReceiverAmount;
      rq.FIID = paym.PayFIID;
   else
      rq.Amount = paym.FuturePayerAmount;
      rq.FIID = paym.FIID;
   end;

   rq.DocKind       = paym.DocKind;
   rq.DocID         = paym.DocumentID;
   rq.Num           = paym.subpurpose;
   rq.Party         = paym.payer + paym.receiver - 1;
   rq.PlanDate      = paym.valuedate;
   rq.ID_Step       = 2908;
   rq.RqAccID       = -1;
   rq.PlaceID       = -1;
   rq.Instance      = 0;
   rq.ChangeDate    = paym.valuedate;
   rq.Action        = 0;
   rq.ID_Operation  = 0;
   rq.Source        = 0;
   rq.SourceObjKind = -1;
   rq.SourceObjID   = 0;

   //return rq;
END;