/*
$Name:             txproc_all.mac
$Module:           БОЦБ 
$Description:      Макрос репликации объектов
*/
import txproc_party, txproc_partykind, txproc_sector, txproc_currency, txproc_avoiriss, txproc_avr_prizn, txproc_avr_code, txproc_coupon, txproc_rate,
       txproc_operation, txproc_demand, txproc_comiss, txproc_link, txproc_money, txloadlog_excel;

private var SQL, cmd, rs, Init_Action;

private macro ОбработатьВсе(Action:integer, t_instancedate:String, ReplDate:Date)
   if ((Action == 1) or (Action == 2))
      if (Action == 1)
         Init_Action = "Вставка, " + ReplDate;
      else
         Init_Action = "Обновление, " + ReplDate;
      end;
      ОбработатьСубъекта(Action, t_instancedate, Init_Action);
      ОбработатьВидСубъекта(Action, t_instancedate, Init_Action);
      ОбработатьСектор(Action, t_instancedate, Init_Action);
      ОбработатьВалюту(Action, t_instancedate, Init_Action);
      Обработать_ЦБумагу(Action, t_instancedate, Init_Action);
      Обработать_ПризнакЦБ(Action, t_instancedate, Init_Action);
      Обработать_КодЦБ(Action, t_instancedate, Init_Action);
      Обработать_Купон(Action, t_instancedate, Init_Action);
      ОбработатьКурс(Action, t_instancedate, Init_Action); 
      Обработать_Операцию(Action, t_instancedate, Init_Action);
      Обработать_Денежную_Операцию(Action, t_instancedate, Init_Action);
      Обработать_Требование(Action, t_instancedate, Init_Action);
      ОбработатьКомиссию(Action, t_instancedate, Init_Action);
      if (Action == 1)
         Обработать_Связь(Action, t_instancedate, Init_Action);
      end;
   elif (Action == 3)
      Init_Action = "Удаление, " + ReplDate;
      ОбработатьКомиссию(Action, t_instancedate, Init_Action);
      Обработать_Требование(Action, t_instancedate, Init_Action);
      Обработать_Денежную_Операцию(Action, t_instancedate, Init_Action);
      Обработать_Операцию(Action, t_instancedate, Init_Action);
      ОбработатьКурс(Action, t_instancedate, Init_Action);
      Обработать_Купон(Action, t_instancedate, Init_Action);
      Обработать_КодЦБ(Action, t_instancedate, Init_Action);
      Обработать_ПризнакЦБ(Action, t_instancedate, Init_Action);
      Обработать_ЦБумагу(Action, t_instancedate, Init_Action);
      ОбработатьВалюту(Action, t_instancedate, Init_Action);
      ОбработатьСектор(Action, t_instancedate, Init_Action);
      ОбработатьВидСубъекта(Action, t_instancedate, Init_Action);
      ОбработатьСубъекта(Action, t_instancedate, Init_Action);
   end;
end;

macro RunAll( MySessID:string)
   ЗанестиЗаписьВПротокол(1, 0, 0, 1, StrFor(1), "Предупреждение: начало репликации");
	
   {WebID} = MySessID;

   SQL = " (SELECT TRUNC (t_instancedate) t_instancedate ";
   SQL = SQL + "   FROM dtxavoiriss_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxavrattr_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxavrcode_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxcomiss_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxcourse_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxcurrency_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxdeal_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxdemand_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxfiwarnts_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxmarksect_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxparty_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxpartykind_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0 ";
   SQL = SQL + " UNION ";
   SQL = SQL + " SELECT TRUNC (t_instancedate) ";
   SQL = SQL + "   FROM dtxmoney_dbt ";
   SQL = SQL + "  WHERE t_replstate = 0) ";
   SQL = SQL + "ORDER BY 1 ";

   cmd = RsdCommand(SQL);
   rs = RsdRecordSet(cmd);

   while (rs.Movenext)
      ОбработатьВсе(3, GetSQLDate_SK(Date(rs.Value(0))), Date(rs.Value(0)));
      ОбработатьВсе(1, GetSQLDate_SK(Date(rs.Value(0))), Date(rs.Value(0)));
      ОбработатьВсе(2, GetSQLDate_SK(Date(rs.Value(0))), Date(rs.Value(0)));
   end;

   ЗанестиЗаписьВПротокол(2, 0, 0, 1, StrFor(1), "Предупреждение: окончание репликации");

   return 0;
end;
