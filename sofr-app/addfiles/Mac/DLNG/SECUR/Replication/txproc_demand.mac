/*
$Name:             txproc_demand.mac
$Module:           БОЦБ 
$Description:      Макрос репликации ТО
*/
import txproc_paym_fun, txrepl_func;

private var SQL, cmd, rs, MaxVal;

macro Process_Demand()
   var DemandData = TDemandData;
   var SQL1, cmd1, rs1, CloseDeal = FALSE;

   if ((rs.Value("T_ACTION") != 1) and (ЗакрытаяСделка(ПолучитьСоответствие(80,rs.value("T_DEALID")))))
      CloseDeal = TRUE;
   end;

   if (ПроверитьНаРучноеИзменение(80, rs.value("T_DEALID")))
         ЗанестиЗаписьВПротокол(207, 90, rs.value("T_DEMANDID"), 1, StrFor(1), "Ошибка: сделка " + String(rs.value("T_DEALID"):11:0) + " находится в режиме ручного редактирования", rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;

   if (rs.Value("T_ACTION") == 2)
      if (ПроверитьНаРучноеИзменение(90, rs.value("T_DEMANDID")))
         ЗанестиЗаписьВПротокол(401, 90, rs.value("T_DEMANDID"), 1, StrFor(1), "Ошибка: Т/О по сделке " + String(rs.value("T_DEALID"):11:0) + " находится в режиме ручного редактирования", rs.Value("T_INSTANCEDATE"));
         Return FALSE;
      end;
   end;

   if (rs.Value("T_ACTION") == 1)
      DemandData.T_DEMANDID = rs.Value("T_DEMANDID");
   else
      DemandData.T_DEMANDID =  ПолучитьСоответствие(90, rs.Value("T_DEMANDID"));
   end;

   DemandData.T_DEALID        = ПолучитьСоответствие(80, rs.Value("T_DEALID"));
   DemandData.OldDealID       = rs.Value("T_DEALID");
   DemandData.OldDemandID     = rs.Value("T_DEMANDID");
   DemandData.T_PART          = rs.Value("T_PART");
   DemandData.T_ISFACT = "";
   
   if (rs.Value("T_ISFACT") != NullVal)
      if (rs.Value("T_ISFACT") == "X") DemandData.T_ISFACT = "X"; 
      end;
   end;

   DemandData.T_KIND          = rs.Value("T_KIND");
   DemandData.T_DIRECTION     = rs.Value("T_DIRECTION");
   DemandData.T_FIKIND        = rs.Value("T_FIKIND");
   DemandData.T_DATE          = Date(rs.Value("T_DATE"));
   DemandData.T_SUM           = rs.Value("T_SUM");

   if ((rs.Value("T_PAYCURRENCYID") == NullVal) and (rs.Value("T_ACTION") != 3) and (rs.Value("T_FIKIND") == 10))
      ЗанестиЗаписьВПротокол(161, 90, rs.Value("T_DEMANDID"), 1, "T_PAYCURRENCYID", "Предупреждение: изменение существенного атрибута 'Валюта оплаты' для Т/О к сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
      Return FALSE;
   end;

   if (rs.Value("T_PAYCURRENCYID") != NullVal)
      DemandData.T_PAYCURRENCYID = ПолучитьСоответствие(10, rs.Value("T_PAYCURRENCYID"));
   end;

   if (rs.Value("T_PAYSUM") != NullVal)
      DemandData.T_PAYSUM    = rs.Value("T_PAYSUM");
   end;

   DemandData.T_PAYRATE       = rs.Value("T_PAYRATE"); /*ПолучитьСоответствие(70, rs.Value("T_PAYRATE"));*/

   if (rs.Value("T_NETTING") != NullVal)
      DemandData.T_NETTING      = ПолучитьСоответствие(80, rs.Value("T_NETTING"));
   else
      DemandData.T_NETTING      = 0;
   end;

   if (rs.Value("T_PLANDEMEND") != NullVal)
      DemandData.T_PLANDEMEND    = ПолучитьСоответствие(90, rs.Value("T_PLANDEMEND"));
   end;

   if (trim(rs.Value("T_NOTE") != "") and (rs.Value("T_NOTE") != NullVal) and (rs.Value("T_NOTE") != Null));
      DemandData.T_NOTE          = trim(rs.Value("T_NOTE"));
   end;

   DemandData.T_STATE         = rs.Value("T_STATE");
   DemandData.T_INSTANCEDATE  = rs.Value("T_INSTANCEDATE");
   DemandData.InTRN           = TRUE;

   if( ОбработатьТребование( DemandData, rs.Value("T_ACTION") ) == false )
      Return FALSE;
   else
      if (rs.Value("T_ACTION") == 1)

         SQL1 = "delete from DTXREPLOBJ_DBT where T_OBJECTTYPE=90 and t_objstate = 2 and t_objectid = " + rs.Value("T_DEMANDID");
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         SQL1 = "insert into DTXREPLOBJ_DBT (T_OBJECTTYPE, T_OBJECTID, T_SUBOBJNUM, T_DESTID, T_DESTSUBOBJNUM,";
         SQL1 = SQL1 + "T_OBJSTATE) values (90, " + rs.Value("T_DEMANDID") + ", 1, ";
         SQL1 = SQL1 + DemandData.T_DEMANDID + " ,1 , 0)";
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         SQL1 = "update DTXDEMAND_DBT set t_replstate = 1 where T_DEMANDID = " + rs.value("T_DEMANDID") + " and t_action = 1 and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         if (DemandData.T_KIND == 120)
            ЗанестиЗаписьВПротокол(161, 90, rs.Value("T_DEALID"), 1, "T_AMOUNT", "Предупреждение: изменение объема сделки (поступление комп.взноса)", rs.Value("T_INSTANCEDATE"));
            SQL1 = "update ddl_leg_dbt set t_amount2 = t_amount - " + rs.Value("T_SUM") + " where t_legkind = 2 and t_dealid = " + DemandData.T_DEMANDID;
            //cmd1 = RsdCommand(SQL1);
            //cmd1.execute;     
         end;
      elif (rs.Value("T_ACTION") == 2)
         if (СущественныйАтрибут(90, rs.Value("T_DEMANDID"), "T_PAYCURRENCYID", rs.Value("T_PAYCURRENCYID")))
            ЗанестиЗаписьВПротокол(161, 90, rs.Value("T_DEMANDID"), 1, "T_PAYCURRENCYID", "Предупреждение: изменение существенного атрибута 'Валюта оплаты' для Т/О по сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(90, rs.Value("T_DEMANDID"), "T_DATE", rs.Value("T_DATE")))
            ЗанестиЗаписьВПротокол(162, 90, rs.Value("T_DEMANDID"), 1, "T_DATE", "Предупреждение: изменение существенного атрибута 'Дата' для Т/О по сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(90, rs.Value("T_DEMANDID"), "T_PAYRATE", rs.Value("T_PAYRATE")))
            ЗанестиЗаписьВПротокол(163, 90, rs.Value("T_DEMANDID"), 1, "T_PAYRATE", "Предупреждение: изменение существенного атрибута 'Курс оплаты' для Т/О по сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(90, rs.Value("T_DEMANDID"), "T_NETTING", rs.Value("T_NETTING")))
            ЗанестиЗаписьВПротокол(164, 90, rs.Value("T_DEMANDID"), 1, "T_NETTING", "Предупреждение: изменение существенного атрибута 'Неттинг' для Т/О по сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(90, rs.Value("T_DEMANDID"), "T_SUM", rs.Value("T_SUM")))
            ЗанестиЗаписьВПротокол(165, 90, rs.Value("T_DEMANDID"), 1, "T_SUM", "Предупреждение: изменение существенного атрибута 'Сумма' для Т/О по сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         end;
         if (СущественныйАтрибут(90, rs.Value("T_DEMANDID"), "T_PAYSUM", rs.Value("T_PAYSUM")))
            ЗанестиЗаписьВПротокол(166, 90, rs.Value("T_DEMANDID"), 1, "T_PAYSUM", "Предупреждение: изменение существенного атрибута 'Сумма оплаты' для Т/О по сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         end;

         SQL1 = "update DTXDEMAND_DBT set t_replstate = 1 where T_DEMANDID = " + rs.value("T_DEMANDID") + " and t_action=2 and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         if (DemandData.T_KIND == 120)
            ЗанестиЗаписьВПротокол(161, 90, rs.Value("T_DEALID"), 1, "T_AMOUNT", "Предупреждение: изменение объема сделки (изменение комп.взноса)", rs.Value("T_INSTANCEDATE"));
          //SQL1 = "update ddl_leg_dbt set t_amount2 = t_amount - " + rs.Value("T_SUM") + " where t_legkind = 2 and t_dealid = " + DemandData.T_DEMANDID;
          //cmd1 = RsdCommand(SQL1);
          cmd1.execute;     
        end;
      elif (rs.Value("T_ACTION") == 3)
         if (CloseDeal)
            ЗанестиЗаписьВПротокол(168, 90, rs.value("T_DEMANDID"), 1, StrFor(1), "Предупреждение: удаление Т/О по закрытой сделке " + String(rs.value("T_DEALID"):11:0), rs.Value("T_INSTANCEDATE"));
         end;

         SQL1 = "update DTXDEMAND_DBT set t_replstate = 1 where T_DEMANDID=" + rs.value("T_DEMANDID") + " and t_action = 3 and t_replstate = 0";
         SQL1 = SQL1 + " and trunc(t_instancedate) = " + getsqlDate_SK(DateStamp(rs.value("t_instancedate")));
         cmd1 = RsdCommand( SQL1);
         cmd1.execute;

         SQL1 = "update DTXREPLOBJ_DBT ots set ots.T_OBJSTATE = 2 where ots.T_OBJECTTYPE = 90 and ots.T_OBJECTID = " + rs.value("T_DEMANDID");

         if (DemandData.T_KIND == 120)
            ЗанестиЗаписьВПротокол(161, 90, rs.Value("T_DEALID"), 1, "T_AMOUNT", "Предупреждение: изменение объема сделки (удаление комп.взноса)", rs.Value("T_INSTANCEDATE"));
            //SQL1 = "update ddl_leg_dbt set t_amount2 = t_amount where t_legkind = 2 and t_dealid = " + DemandData.T_DEMANDID;
            //cmd1 = RsdCommand(SQL1);
            cmd1.execute;     
         end;

         cmd1 = RsdCommand( SQL1);
         cmd1.execute;
      end;

      Return TRUE;
   end;
OnError(er)
   if (Trim(er.message) != "Error:")
      ЗанестиЗаписьВПротокол(600, 90, rs.value("T_DEMANDID"), 1, StrFor(1), "Ошибка: " + er.message, rs.Value("T_INSTANCEDATE"));
   end;
   AbortTrn;
end;

macro Обработать_Требование(Action, t_instancedate, Init_Action:String)

   var Счетчик;

   SQL = "select count(*) from DTXDEMAND_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate;
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);

   if (rs.Movenext)
      Счетчик = rs.Value(0);
      MaxVal = rs.Value(0);
   end;

   var ProgressIndicator = CreateProgressIndicator(true);
   ProgressIndicator.Start(Int(MaxVal), "Обработка требований/обязательств...");

   Счетчик = 0;

   SQL = "select * from DTXDEMAND_DBT where t_replstate = 0 and t_action = " + Action + " and trunc(t_instancedate) = " + t_instancedate + " order by t_dealid, t_isfact";
   cmd = RsdCommand( SQL);
   rs = RsdRecordSet(cmd);
  
   while (rs.Movenext)

      Счетчик = Счетчик + 1;

      ProgressIndicator.Update(Int(Счетчик), MaxVal);

      if (not ProcessTrn(Null, "Process_Demand"))
      end;
   end;

   ProgressIndicator.Stop();

   return TRUE;
OnError(er)
   ЗанестиЗаписьВПротокол(600, 90, "", "", StrFor(1), "Ошибка: " + er.message, date(t_instancedate));
end;