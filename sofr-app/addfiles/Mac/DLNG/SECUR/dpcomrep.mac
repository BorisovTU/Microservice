/*
$Name:        dpcomrep.mac
$Module:      ñ•≠≠Î• °„¨†£®
$Description: é‚Á•‚ "Çß®¨†•¨Î• ™Æ¨®··®® °Ì™-Æ‰®·†" 
*/
import "dpcomrep_form.mac", "dlmisc.mac";

const ALG_SFDEFCOMSTATUS  = 2379; /* ·Æ·‚ÆÔ≠®• „§•‡¶†≠≠Æ© ™Æ¨®··®® */
const ALG_SV_SERVICE_TYPE = 2375; /* í®Ø „·´„£® */

private const Cap = "ÇáàåÄÖåõÖ äéåàëëàà Åùä-éîàëÄ áÄ èÖêàéÑ ë ";

private var comm_alg = DL_GetNameAlg( ALG_SV_SERVICE_TYPE, SF_FEE_TYPE_PERIOD );

PRIVATE VAR DPCOMREP_Form = DPComRep_Panel();

/* ë‚‡„™‚„‡† · §†≠≠Î¨® §´Ô Æ‚Á•‚†*/
class SourceData( _ClientID:integer, _ContractID:integer,
                  _CommNumber:integer,
                  _dateMin:date, _dateMax:date, _apostrSum:bool, _toExcel:bool )
   var 
      ClientID      =  _ClientID,
      ContractID    =  _ContractID,
      CommNumber    =  _CommNumber,
      dateMin       =  _dateMin,
      dateMax       =  _dateMax,
      apostrSum     =  _apostrSum,
      toExcel       =  _toExcel;

   var 
      PrintHeadClient = false,
      PrintHeadContr  = false,
      ReportRun       = false;
end;

private class (DL_CReportTemplate) dpcomrep_Report()

   private var Data:SourceData; 

   private var TableHeader =
   "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
   "≥              ≥          ≥         äÆ¨®··®Ô       ≥                    ≥              ≥\n" + 
   "≥ äÆ§ ™Æ¨®··®® ≥Ñ†‚† ¢ß®¨.√ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¥    ë„¨¨† çÑë       ≥ í®Ø ¢ß®¨†≠®Ô ≥\n" + 
   "≥              ≥          ≥   ë„¨¨†    ≥   Ç†´Ó‚†  ≥                    ≥              ≥\n" + 
   "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";
                    
   private var TableHeader_2 =
   "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
   "≥              ≥          ≥         äÆ¨®··®Ô       ≥                    ≥              ≥              ≥\n" + 
   "≥ äÆ§ ™Æ¨®··®® ≥Ñ†‚† ¢ß®¨.√ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¥    ë„¨¨† çÑë       ≥ í®Ø ¢ß®¨†≠®Ô ≥ ë„È•·‚¢•≠≠†Ô?≥\n" + 
   "≥              ≥          ≥   ë„¨¨†    ≥   Ç†´Ó‚†  ≥                    ≥              ≥              ≥\n" + 
   "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

   PRIVATE var ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î = false;

   private var m_CommCode = "",  
               m_CommDate = date(0,0,0),  
               m_CommSum = $0,   
               m_FIIDCCY = "",   
               m_CommNDS = $0,   
               m_Immaterial = "",
               m_ContrNumber = "",
               m_DateConc = date(0,0,0);
     
   private macro PrintMode():INTEGER
      if(DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_EXCEL))
         return DL_OUTREPORT_EXCEL;
      else
         return DL_OUTREPORT_STD;
      end;
   end;  

   private macro BeginReport()
      Dl_CallInsertStat(PrintMode());
      CreateTotalBook();
      SetActiveSheet( "Çß®¨†•¨Î• ™Æ¨®··®®" );
   end;

   private macro PrintReportHead( )
      PrintFormatString(
         Cap + " #",
         "N1_Cap", Cap + " " + date_as_string(1, Data.dateMin) + " èé " + date_as_string(1, Data.dateMax)
      );

      CopyAllSheetInTotalBook( NULL, false, "N1_Cap", 0 );
   end;
   
   private macro Register_Table()
      if( ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î )
         RegisterTable(
            "N1_TableLine_2", TableHeader_2,
            "N1_A1",
            "N1_A2",
            "N1_A3",
            "N1_A4",
            "N1_A5",
            "N1_A6",
            "N1_A7"
         );
      else
         RegisterTable(
            "N1_TableLine", TableHeader,
            "N1_A1",
            "N1_A2",
            "N1_A3",
            "N1_A4",
            "N1_A5",
            "N1_A6"
         );
      end;
   end;

   private macro EndCopyTable()
      EndTable();
      CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
   end;

   private macro EndReport()
      
      if(Data.ReportRun)
         if(Data.PrintHeadClient)
            EndCopyTable();
            Data.PrintHeadClient = false;
         end;
         AddStandardFooter("N1_");
         CopyAllSheetInTotalBook(NULL, false, "N1_Footer", 1);
      else
         PrintFormatString(
            "ç•‚ ≠†Á®·´•≠≠ÎÂ ®´® ÆØ´†Á•≠≠ÎÂ ™Æ¨®··®©, ·ÆÆ‚¢•‚·‚¢„ÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†.",
            "N1_NoData", "ç•‚ ≠†Á®·´•≠≠ÎÂ ®´® ÆØ´†Á•≠≠ÎÂ ™Æ¨®··®©, ·ÆÆ‚¢•‚·‚¢„ÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†."
         );
         
         CopyAllSheetInTotalBook( NULL, false, "N1_NoData", 1 );
      end;
      
      SaveTotalBook();
   end;

   macro PrintHeadClient( )
     record  rParty( party );
     var     Title = "", ClientCode;

     ClientCode = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†( Data.ClientID, PTCK_CONTR );
     if( (ClientCode == "") OR
         (èÆ´„Á®‚Ïë„°Í•™‚†( Data.ClientID, rParty ) != 0)
       )
        msgbox( "éË®°™† Ø‡® ÆØ‡•§•´•≠®® ™´®•≠‚† · ®§•≠‚®‰®™†‚Æ‡Æ¨ ", Data.ClientID );
     else 
        Title = ClientCode + "  " + rParty.ShortName;
     end;
      
      Title = "ä´®•≠‚: " + Title;
      
      PrintFormatString(
            "#",
            "N1_H1", Title, null
      );

      CopyAllSheetInTotalBook( NULL, false, IIF(ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î,"N1_TableHeader_2","N1_TableHeader"), 1 );

      Register_Table();

      Data.ReportRun       = true;
      Data.PrintHeadClient = true;
   end;

   macro PrintHeadContr()
      var  Title;

      if( Data.PrintHeadClient == false )  PrintHeadClient();  end;

      if( Data.PrintHeadContr == false )
         Title = "ÑÆ£Æ¢Æ‡ ¸ " + m_ContrNumber + "  Æ‚  " + string(m_DateConc);

         if(Data.toExcel)
            Merge("N1_A1", IIF(ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î,"N1_A7","N1_A6"));
         end;

         PrintTableLine(
            "N1_A1", Title, null
         );
      end;

      Data.PrintHeadContr = true;
   end;

   macro PrintSum( Sum )
     if( Sum == 0 ) return "";end;

     if( not Data.toExcel )
        if( Data.apostrSum == true )  return string( Sum:a );
        else return string(Sum);
        end;
     else
        return Sum;
     end;
   end;

   macro PrintCommLine()
      PrintHeadContr();

      if( ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î )
         PrintTableLine( 
            "N1_A1",  m_CommCode,                                                         null,
            "N1_A2",  m_CommDate,                                                         null,
            "N1_A3",  PrintSum( m_CommSum ),                                              null,
            "N1_A4",  m_FIIDCCY,                                                          null,
            "N1_A5",  PrintSum( m_CommNDS ),                                              null,
            "N1_A6",  comm_alg,                                                           null,
            "N1_A7",  IIF( (Data.ClientID=={OurBank}) and (m_Immaterial!="X"), "X", "" ), null 
         );
      else
         PrintTableLine( 
            "N1_A1",  m_CommCode,                                   null,
            "N1_A2",  m_CommDate,                                   null,
            "N1_A3",  PrintSum( m_CommSum ),                        null,
            "N1_A4",  m_FIIDCCY,                                    null,
            "N1_A5",  PrintSum( m_CommNDS ),                        null,
            "N1_A6",  comm_alg,                                     null
         );
      end;

   end;

   private macro è•Á†‚Ïé‚Á•‚†()
      var queryTxt, cmd, DataSet, queryNRec, NRec = 0, NRecData, NumClient = 0;
      var PrevClient = -1, PrevContrID = -1;
   
      PrintReportHead();
       
      var queryCond =  
         "         client.T_ServiceKind = ? "+
         "     and client.t_Department = ? "+
         "     and client.t_Branch = 0 "+
         "     and sfcontr.t_PartyID = CLIENT.T_PARTYID "+
         "     and sfcontr.t_ServKind = client.T_ServiceKind "+
         "     and sfcontr.t_FIID  = -1 "+
         "     and (sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY') or sfcontr.t_DateClose >= ?) "+
         "     and sfcontr.t_DateConc <= ? "+
         "     and SFCOMISS.T_FEETYPE = ? ";

      if( Data.ClientID > 0 )
         queryCond =  queryCond +
         "     and sfcontr.t_PartyID = ? ";
      end;

      if( Data.ContractID > 0 )
         queryCond =  queryCond +
         "     and SFCONTR.T_ID = ? ";
      end;

      if( Data.CommNumber > 0 )
         queryCond =  queryCond +
         "     and SFCOMISS.T_NUMBER = ? ";
      end;

      queryTxt =
         " Select sfcontr.t_PartyID, SFCONTR.T_ID, sfcontr.t_Number, sfcontr.t_DateConc, SFCOMISS.T_CODE, DLCOMIS.T_FACTPAYDATE PAYDATE, FIN.T_CCY, "+
         "        "+IIF(ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î,"decode(sfcontr.t_PartyID,"+{OurBank}+",DLCOMIS.T_IMMATERIAL,chr(0))","chr(0)")+" T_IMMATERIAL, sum(DLCOMIS.T_SUM - DLCOMIS.T_NDS) T_SUM, sum(DLCOMIS.T_NDS) NDS "+
         "    From DCLIENT_DBT client, dsfcontr_dbt sfcontr, ddlcomis_dbt dlcomis, dsfcomiss_dbt sfcomiss, dfininstr_dbt fin "+
         "   Where " + queryCond +
         "     and DLCOMIS.T_CONTRACT = SFCONTR.T_ID "+
         "     and rsb_secur.CheckExistGrDealByCom(DLCOMIS.T_DocKind, DLCOMIS.T_DocID, DLCOMIS.T_Contract, DLCOMIS.T_PLANPAYDATE, "+DLGRACC_STATE_FACTEXEC+") = 1 "+
         "     and SFCOMISS.T_NUMBER = DLCOMIS.T_COMNUMBER "+
         "     and SFCOMISS.T_FEETYPE = DLCOMIS.T_FEETYPE "+
         "     and DLCOMIS.T_FACTPAYDATE between ? and ? "+
         "     and FIN.T_FIID = sfcomiss.t_FIID_COMM " +
         " group by sfcontr.t_PartyID, SFCONTR.T_ID, sfcontr.t_Number, sfcontr.t_DateConc, SFCOMISS.T_CODE, DLCOMIS.T_FACTPAYDATE, FIN.T_CCY "+IIF(ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î,", T_IMMATERIAL ","")+
         "        "+
         "     union all "+         
         /*+™Æ¨®··®® ØÆ §Æ£Æ¢Æ‡„, ™Æ‚Æ‡Î• ≠• °®´® ≠® Ì™·ØÆ‡‚®‡Æ¢†≠Ô ¢ èáé, ≠® ‡†··Á®‚†≠Î ¢ ÆØ•‡†Ê®® ß†™‡Î‚®Ô §≠Ô èé ëÑÖãäÄå*/
         "   Select sfcontr.t_PartyID, SFCONTR.T_ID, sfcontr.t_Number, sfcontr.t_DateConc, SFCOMISS.T_CODE, SFDEF.T_DATEFEE PAYDATE, FIN.T_CCY, "+
         "          chr(0) T_IMMATERIAL, SFDEF.T_SUM, SFDEF.T_SUMNDS NDS "+
         "     From DCLIENT_DBT client, dsfcontr_dbt sfcontr, dsfdef_dbt SFDEF, dsfcomiss_dbt sfcomiss, dfininstr_dbt fin "+ 
         "   Where " + queryCond +
         "      and SFDEF.t_SFCONTRID = SFCONTR.T_ID "+
         "      and SFCOMISS.T_FEETYPE = SFDEF.T_FEETYPE "+
         "      and SFCOMISS.T_NUMBER = SFDEF.T_COMMNUMBER "+
         "      and SFDEF.T_SUM > 0 "+
         "      and SFDEF.T_DATEFEE != TO_DATE('01.01.0001','DD.MM.YYYY') "+
         "      and SFDEF.T_DATEFEE between ? and ? "+
         "      and FIN.T_FIID = SFDEF.T_FIID_SUM " +
         "      and (select count(1) from DDLCOMIS_DBT DLCOMIS "+
         "            where SFDEF.t_SFCONTRID  = DLCOMIS.T_CONTRACT "+
         "              and SFDEF.T_FEETYPE    = DLCOMIS.T_FEETYPE "+
         "              and SFDEF.T_COMMNUMBER = DLCOMIS.T_COMNUMBER "+
         "              and SFDEF.T_DATEFEE    = DLCOMIS.T_FACTPAYDATE) = 0 "+
         "     order by t_PartyID, T_ID, t_Number, T_CODE, PAYDATE ";

      queryNRec = RSDCommand("select count(1) NRec from ("+queryTxt+")");
      
      queryNRec.addParam("", RSDBP_IN, PTSK_STOCKDL);
      queryNRec.addParam("", RSDBP_IN, {OperDprt});
      queryNRec.addParam("", RSDBP_IN, Data.dateMin);
      queryNRec.addParam("", RSDBP_IN, Data.dateMax);
      queryNRec.addParam("", RSDBP_IN, SF_FEE_TYPE_PERIOD);
      if( Data.ClientID > 0 )
         queryNRec.addParam("", RSDBP_IN, Data.ClientID);
      end;
      if( Data.ContractID > 0 )
         queryNRec.addParam("", RSDBP_IN, Data.ContractID);
      end;
      if( Data.CommNumber > 0 )
         queryNRec.addParam("", RSDBP_IN, Data.CommNumber);
      end;
      queryNRec.addParam("", RSDBP_IN, Data.dateMin);
      queryNRec.addParam("", RSDBP_IN, Data.dateMax);
      
      queryNRec.addParam("", RSDBP_IN, PTSK_STOCKDL);
      queryNRec.addParam("", RSDBP_IN, {OperDprt});
      queryNRec.addParam("", RSDBP_IN, Data.dateMin);
      queryNRec.addParam("", RSDBP_IN, Data.dateMax);
      queryNRec.addParam("", RSDBP_IN, SF_FEE_TYPE_PERIOD);
      if( Data.ClientID > 0 )
         queryNRec.addParam("", RSDBP_IN, Data.ClientID);
      end;
      if( Data.ContractID > 0 )
         queryNRec.addParam("", RSDBP_IN, Data.ContractID);
      end;
      if( Data.CommNumber > 0 )
         queryNRec.addParam("", RSDBP_IN, Data.CommNumber);
      end;
      queryNRec.addParam("", RSDBP_IN, Data.dateMin);
      queryNRec.addParam("", RSDBP_IN, Data.dateMax);
      
      queryNRec.execute();
      
      NRecData = TRsbDataSet(queryNRec);
      
      if( NRecData.MoveNext() and (NRecData.NRec > 0) )
         NRec = int(NRecData.NRec);
      end;

      if( NRec > 0 )
      
         cmd = RSDCommand(queryTxt);
        
         cmd.addParam("", RSDBP_IN, PTSK_STOCKDL);
         cmd.addParam("", RSDBP_IN, {OperDprt});
         cmd.addParam("", RSDBP_IN, Data.dateMin);
         cmd.addParam("", RSDBP_IN, Data.dateMax);
         cmd.addParam("", RSDBP_IN, SF_FEE_TYPE_PERIOD);
         if( Data.ClientID > 0 )
            cmd.addParam("", RSDBP_IN, Data.ClientID);
         end;
         if( Data.ContractID > 0 )
            cmd.addParam("", RSDBP_IN, Data.ContractID);
         end;
         if( Data.CommNumber > 0 )
            cmd.addParam("", RSDBP_IN, Data.CommNumber);
         end;
         cmd.addParam("", RSDBP_IN, Data.dateMin);
         cmd.addParam("", RSDBP_IN, Data.dateMax);
        
         cmd.addParam("", RSDBP_IN, PTSK_STOCKDL);
         cmd.addParam("", RSDBP_IN, {OperDprt});
         cmd.addParam("", RSDBP_IN, Data.dateMin);
         cmd.addParam("", RSDBP_IN, Data.dateMax);
         cmd.addParam("", RSDBP_IN, SF_FEE_TYPE_PERIOD);
         if( Data.ClientID > 0 )
            cmd.addParam("", RSDBP_IN, Data.ClientID);
         end;
         if( Data.ContractID > 0 )
            cmd.addParam("", RSDBP_IN, Data.ContractID);
         end;
         if( Data.CommNumber > 0 )
            cmd.addParam("", RSDBP_IN, Data.CommNumber);
         end;
         cmd.addParam("", RSDBP_IN, Data.dateMin);
         cmd.addParam("", RSDBP_IN, Data.dateMax);
        
         cmd.execute();
         
         DataSet = TRsbDataSet(cmd);
        
         Data.PrintHeadClient = false;

         InitProgress( NRec, "é‚Á•‚ \"Çß®¨†•¨Î• ™Æ¨®··®® °Ì™-Æ‰®·†\"", 
                       "è•Á†‚Ï ™Æ¨®··®© ™´®•≠‚Æ¢ ‰Æ≠§Æ¢Æ£Æ §®´®≠£†" );

         while(DataSet.MoveNext())
        
            if( PrevClient != DataSet.PartyID )
               if(Data.PrintHeadClient)
                  EndCopyTable();
                  Data.PrintHeadClient = false;
               end;
            end;
        
            if( PrevContrID != DataSet.ID )
               Data.PrintHeadContr = false;
            end;
        
            Data.ClientID = DataSet.PartyID;  
            m_ContrNumber = DataSet.Number;  
            m_DateConc    = SQL_ConvTypeDate(DataSet.DateConc);  
        
            m_CommCode    = DataSet.Code;  
            m_CommDate    = SQL_ConvTypeDate(DataSet.PAYDATE);  
            m_CommSum     = DataSet.Sum;   
            m_FIIDCCY     = DataSet.CCY;   
            m_CommNDS     = DataSet.NDS;
            m_Immaterial  = IIF(DataSet.IMMATERIAL,"X","");
        
            PrintCommLine();

            PrevClient      = DataSet.PartyID;
            PrevContrID     = DataSet.ID; 
 
            NumClient = NumClient + 1;
            UseProgress( NumClient );
       
         end;

         RemProgress;

      end;

   end;

   private macro Create()
      Data = SourceData( DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_CLIENT), 
                         DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_CONTRACT), 
                         DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_COMISS), 
                         DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_BEGINDATE),
                         DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_ENDDATE), 
                         DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_WITHAPP), 
                         DPCOMREP_Form.GetFieldValue(PNFLD_DPCOMREP_EXCEL) 
                       );
      ìÁ®‚Î¢†‚Ïç•·„Èá†‚‡†‚Î = è‡Æ¢•‡Ô‚Ïë„È•·‚¢•≠≠Æ·‚Ïá†‚‡†‚();
      è•Á†‚Ïé‚Á•‚†();
   end;

   initDL_CReportTemplate(DPCOMREP_Form(), "Report_dpcomrep.xlsx", null, null, null, true, true);
end;

dpcomrep_Report().Run();
exit(1);                   
