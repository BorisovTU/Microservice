/*
$Name:        scinc310.mac
$Module:      Ценные бумаги
$Description: Операция начисления ПДД. Шаг "учет ПДД"
*/
import "scincfun.mac";

private record Avoiriss( avoiriss );

macro ExecuteStep( D, FirstDoc, _DocKind, ID_Operation, ID_Step )

   SetBuff( Avoiriss, FirstDoc );
   return ВыполнитьПроводкиНачисленияПоБумаге( D, ScOprServDoc, Avoiriss, ID_Operation, ID_Step, (ScOprServDoc.Flag1 == SET_CHAR), (ScOprServDoc.Flag4 == SET_CHAR) );
end;

/* Макрос постобработки */
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    
    SetBuff( Avoiriss, FirstDoc ); 
    InsertErrorLog_XML(ScOprServDoc.DocumentID, ScOprServDoc.DocKind);
    ClearErrorArr();
    if (errTrn OR (CommitOrRollback == 2)) /* Произошла ошибка или происходит откат */
       if( CommitOrRollback == 2 )
          DL_DeleteDataByStep_XML(ID_Operation, ID_Step);
       end;
       return;
    else
       if(ScOpReportLineData.size > 0)
          DL_SaveDataForReport_XML(ScOprServDoc.DocumentID, ScOprServDoc.DocKind, ScOpReportLineData, LOG_TYPE_DATA, ID_Operation, ID_Step);
       end;
    end;

    return 0;
END;