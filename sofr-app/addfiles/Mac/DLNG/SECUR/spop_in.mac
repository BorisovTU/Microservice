/*AV 25.01.02*/
/* общий макрос инициализации операций с ценными бумагами   */
/* покупки\продажи\погашения                                */
IMPORT OprInter, "sp_class.mac", SFInter;

MACRO InitOperation( KindOpr, KindDoc, FDoc )

    RECORD Deal(dl_tick);
    var    contrID = 0, FD, FD_2, ContrNum = "";

    SetBuff( Deal, FDoc );   

    FD = SPFirstDoc( Deal ); 

    /*УсловияСделки - глобальная структура, описанная в макросе скроллинга
      (spDeal.mac spRetire.mac)*/
    copy( FD.dl_leg, УсловияСделки );

    if( not FD.CheckCliring( true ) ) 
       return 1;
    end;

    if( IsBUY( FD.Group ) OR IsAVRWRTIN(FD.Group) OR Deal.BofficeKind == DL_INVESTSHARE )
       if( Deal.PortfolioID == KINDPORT_PROMISSORY )  
          if( Deal.DealDate < FD.fininstr.rec.DrawingDate )
             if( MsgBoxEx( "Дата сделки меньше даты погашения ц/б.|Выполнять операцию ?",
                 MB_YES+MB_NO, IND_NO, 
                 "", "Подтверждение начала операции" ) != IND_YES ) 
                return 1; 
             end;
          end; 
       else
          if( (FD.fininstr.rec.DrawingDate != Date(0,0,0)) AND (Deal.DealDate > FD.fininstr.rec.DrawingDate) )
             if( MsgBoxEx( "Дата сделки больше даты погашения ц/б.|Выполнять операцию ?",
                 MB_YES+MB_NO, IND_NO,
                 "", "Подтверждение начала операции" ) != IND_YES ) 
                return 1; 
             end;
          end; 
       end;
    end;

    return 0;
END;