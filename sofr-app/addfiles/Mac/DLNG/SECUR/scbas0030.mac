/*
$Name:        scbas0030.mac
$Module:      Ценные бумаги
$Description: Операция "Прямое РЕПО на корзину ц/б". Шаг "Исполнения 2ч"
*/
import InsCarryDoc, "sp_car.mac", "sp_car2.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  record deal(dl_tick);
  var    FD, dat;

  SetBuff(deal, FDoc); 
  FD = SPFirstDoc(deal, true);

  GetOprDate(FD.GetKindDate(DATE_DEALEXEC), dat);

  if( dat > {curdate} )
     MsgBox ("Преждевременное выполнение шага запрещено.");
     return 1;
  end;

  if( FD.БылОтказОтИсполнения() != false )
     return 0;
  end;

  if( ПроверитьТОНаПросроченность(FD.GetRQ(DLRQ_TYPE_PAYMENT), "оплате" ) == false)
     return 1;
  end;

  if( УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_PAYMENT), DLRQ_STATE_EXEC, Dat) != 0 )
     return 1;
  end;

  if( FD.ExistPC )
     if( УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_INCREPO), DLRQ_STATE_EXEC, dat) != 0 )
        return 1;
     end;
  end;

  if( ВыполнитьНатуральныйУчетЦенныхБумаг(FD, Doc, dat, NULL) != 0 )
     return 1;
  end; 

  if( DL_UpdateGrDealAcc(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYMENT2, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;

  var ArrFIID = FD.RQGetArrFIID(DLRQ_TYPE_DELIVERY);
  var j:integer = 0;
  while( j < ArrFIID.size )
     if( DL_UpdateGrDealAcc(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, ArrFIID(j), DLGR_TEMPL_DELIVERY2, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
       return 1;
     end;
     j = j + 1;
  end;

  return 0;
end;
