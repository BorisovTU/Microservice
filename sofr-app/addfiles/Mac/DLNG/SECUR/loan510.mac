/*
$Name:        loan510.mac
$Module:      Ценные бумаги
$Description: Операция займа. Шаг "Просрочка возврата ц/б".
*/
import InsCarryDoc, "sp_class.mac", "sp_car.mac";

private record SpChangeDates("spchdate.str");/*глобальная структура с данными для расчетов*/

macro ExecuteStep( doc, FDoc)

   record deal(dl_tick);
   var    FD, Summa, dat = SpChangeDates.FactDate, pmobj;

   if( SpChangeDates.Action <= 0 )
      msgbox("Шаг просрочки возврата ц/б из списка шагов выполнять запрещено."); 
      return 1;
   end; 

   SetBuff( deal, FDoc ); 
   FD = SPFirstDoc( deal, true );

   if( FD.СуммаПлатежейНКД() != 0 )
      /*Если уже был возврат, то полученный НКД уже списани с "ОД"*/
      Summa = FD.dl_leg.rec.Cost;
   else
      Summa = FD.dl_leg.rec.TotalCost;
   end;

   if(not ПроводкаПоКатегориямУчета( FD, 
          "ОД", "Обяз. с н.с.", /* КатегДеб , КатегКредит*/
          dat,                  /* Дата */
          1 ,                   /* Глава */
          FD.dl_leg.rec.CFI,    /* Валюта */
          Summa,                /* Сумма */
          Doc,                  /* Документ */
          INPCARRY,             /* Result_Carry */
          " 1",                 /* Kind_Oper */
          FD.tick.rec.DealCode, /* Numb_Document */
          "Перенос суммы основного долга на просрочку" /* Ground */
         ))
       return 1;
   end;

   pmobj = RsbPayment( FD.pm_avoir.rec.PaymentID );
   pmobj.PaymStatus = PM_OVERDUE;

   return 0;
end;
