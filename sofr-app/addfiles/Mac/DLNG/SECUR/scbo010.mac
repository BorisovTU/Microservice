/*
$Name:         scbo010.mac
$Module:       Ценные бумаги
$Description:  Операция внебиржевой покупки ц/б
*/
/* Шаг настройки операции           */

import InsCarryDoc, "sp_class.mac", "sp_car2.mac", "spservsql.mac", "SPQICheckOper.mac";


private macro ПроверитьСделкуРСХБ(_FD):bool
const UncknownParty = -1;
const OutMarktBuy   = 12183;
const OutMarktSell  = 12193;
const ON = 1; const OFF= 0;

if((_FD.tick.rec.dealtype == OutMarktBuy) or (_FD.tick.rec.dealtype == OutMarktBuy))
    if(_FD.dl_leg.rec.depositid == UncknownParty)
     if(GetDialogFlag() == 0)
        setdialogflag(ON);
        if( MsgBoxEx("В сделке " + _FD.tick.rec.dealcode + " не указан расчетный депозитарий.\n Поручение депо будет сформировано с ошибкой.\n Обработать сделку?" , MB_YES + MB_NO, IND_NO) == IND_YES )
          setdialogflag(OFF);
          return true;
        else
          setdialogflag(OFF);
          return false;
        end;

     else 
        if( MsgBoxEx("Не указан расчетный депозитарий.\n Поручение депо будет сформировано с ошибкой.\n Обработать сделку?" , MB_YES + MB_NO, IND_NO) == IND_YES )
         return true;
        else;
         return false;
        end;

     end;
    end;  
end;
  return true;
end;


macro executeParamStep( kind_oper, BOf_kind, FDoc, ID_Operation, ID_Step )

  record  deal(dl_tick);
  var     err, FD, LegOperState, Dd;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY), true );

  if(ПроверитьПринадлежностьКИ( FD ) == false)
     return 1;
  end;

//AND
  if(not ПроверитьСделкуРСХБ( FD ))
    return 1;
  end;
//AND


  DefineOprDate( FD.GetKindDate(DATE_DEALDATE),        FD.DateArray[DATE_DEALDATE]         );
  DefineOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), FD.DateArray[DATE_DEALSETAVOIRISS]  );
  DefineOprDate( FD.GetKindDate(DATE_DEALPAY),         FD.DateArray[DATE_DEALPAY]          );
  DefineOprDate( FD.GetKindDate(DATE_DEALCOMISS),      FD.DateArray[DATE_DEALCOMISS]       );
  DefineOprDate( FD.GetKindDate(DATE_DEALBEGINEXEC),   FD.DateArray[DATE_DEALBEGINEXEC]    );
  DefineOprDate( FD.GetKindDate(DATE_DEALEEND),        FD.DateArray[DATE_DEALEEND]         );
  DefineOprDate( FD.GetKindDate(DATE_DEALDEPOSIT),     FD.DateArray[DATE_DEALDEPOSIT]      );
  DefineOprDate( FD.GetKindDate(DATE_DEALAVANCE),      FD.DateArray[DATE_DEALAVANCE]       );

  if( (FD.ExistBack == true) AND (not FD.IsBack) )
     /*дата инициализируется при инициализации сделки*/
     DefineOprDate( FD.GetKindDate(DATE_DEALBEGIN_2), FD.DateArray[DATE_DEALBEGIN_2] );
  end;

  if(not FD.IsBack)
     if( УстановитьНачальныйСтатусСделки( FD ) )
        return 1;
     end;
  end;

  /* Если необходимо оформлять договор, ОД = "Оформить", иначе ОД = "Завершить" */
//  if( deal.flag2 != "" ) /*в сделке взведен флаг "подписание договора"*/
//     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_OD, SP_OPERSTATUS_SECURDEALS_OD_FORM) ) 
//        msgbox( "Ошибка при установке статуса <Оформление договора> операции" );
//        return 1;
//     end;
//  else
//     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_OD, SP_OPERSTATUS_SECURDEALS_OD_FINISH) ) 
//        msgbox( "Ошибка при установке статуса <Оформление договора> операции" );
//        return 1;
//     end;
//  end;

  if( FD.ExistDeposit == true ) /*существует ТО задатка*/
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_AZ, SP_OPERSTATUS_SECURDEALS_AZ_PAYZ) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса/задатка> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_AZ, SP_OPERSTATUS_SECURDEALS_AZ_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса/задатка> операции" );
        return 1;
     end;
  end;

  if( FD.ExistAvance == true ) 
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A1, SP_OPERSTATUS_SECURDEALS_A1_PAY) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 1 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A1, SP_OPERSTATUS_SECURDEALS_A1_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 1 ч> операции" );
        return 1;
     end;
  end;

  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_O1, SP_OPERSTATUS_SECURDEALS_O1_PAY) ) 
     msgbox( "Ошибка при установке статуса <Оплата> операции" );
     return 1;
  end;

  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_P1, SP_OPERSTATUS_SECURDEALS_P1_SET) ) 
     msgbox( "Ошибка при установке статуса <Поставка> операции" );
     return 1;
  end;

  if((FD.tick.rec.IsPFI == SET_CHAR) and РАБОТА_С_РЕПОЗИТАРИЕМ())
    if(SP_InsertGrDealFairValueRevaluation(FD, FD.DateArray[DATE_DEALDATE]))
      msgbox(1, "Ошибка при вствке действия графика \"Переоценка СС\"");
      return 1;
    end;
  end;
  return 0;
end;
                       
