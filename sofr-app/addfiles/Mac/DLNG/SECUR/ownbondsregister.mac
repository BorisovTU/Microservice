/*
$Name:             ownbondsregister.mac
$Module:           АРНУ 
$Description:      WEB. АРНУ. Отчет Регистр по собственным облигациям
*/

IMPORT "ws_txreportform.mac", "DlRepForm_h.mac", "globals.mac", "spRepFun.mac", "ws_ficlass.mac", "OwnBondsRegister_Form.mac";

PRIVATE VAR WebMenuItem;
PRIVATE VAR WebFormData;
PRIVATE VAR OwnBondsRepForm;

/*namealg 8243*/
PRIVATE VAR ReportKind_0261_0262 = 1,
            ReportKind_0461 = 2,
            ReportKind_АР_07_17_1 = 3,
            ReportKind_АР_07_17_2 = 4,
            ReportKind_АР_07_17_1_2 = 5;

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА = 13;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ = 7;

PRIVATE CONST AP_1_TYPEDEAL_PREV = 1; //Сделки предыдущего отчётного периода
PRIVATE CONST AP_1_TYPEDEAL_CURRENT = 2; //Сделки текущего отчётного периода

PRIVATE VAR  C_D5     = "E",
             C_D6     = "F",
             C_D9     = "I",
             C_D10    = "J",
             C_D11    = "K",
             C_D12    = "L",
             C_D13    = "M",
             C_D14    = "N",
             C_D15    = "O",
             C_D16    = "P",
             C_D17    = "Q",
             C_D18    = "R",
             C_D19    = "S",
             C_D20    = "T",
             C_D21    = "U",
             C_D22    = "V",
             C_D23    = "W",
             C_D24    = "X",
             C_D25    = "Y",
             C_D26    = "Z",
             C_D27    = "AA",
             C_D28    = "AB",
             C_D29    = "AC",
             C_D30    = "AD",
             C_D31    = "AE",
             C_D32    = "AF",
             C_D33    = "AG",
             C_D34    = "AH",
             C_D35    = "AI",
             C_D36    = "AJ",
             C_D39    = "AM",
             C_D41    = "AO",
             C_D42    = "AP",
             C_D43    = "AQ",
             C_D45    = "AS",
             C_D46    = "AT",
             C_D47    = "AU",
             C_D51    = "AY",
             C_D52    = "AZ",        
             C_D53    = "BA",
             C_D54    = "BB";
        

var AvrFIIDList = TArray;
var BeginDate;
var EndDate;
var Year;
var Period;
var AddItog;
var ReportKindList = TArray;

PRIVATE CLASS CFIIDS(pAvrFIIDList, pBeginDate, pEndDate, pYear, pReportKindList)
  private var m_AvrFIIDList,
              idx, cnt,
              m_BeginDate, m_EndDate, m_Year, m_ReportKindList;

  private macro Init(pAvrFIIDList, pBeginDate, pEndDate, pYear, pReportKindList)
    m_BeginDate = pBeginDate;
    m_EndDate = pEndDate;
    m_Year = pYear;
    m_ReportKindList = pReportKindList;
    if( (pAvrFIIDList != null) and (pAvrFIIDList.Size > 0) )
      m_AvrFIIDList = pAvrFIIDList;
    else
      m_AvrFIIDList = TArray();

      var cmd = DL_RSDCommand( " SELECT fi.t_FIID, fi.t_Name " +
                             "   FROM dfininstr_dbt fi, davoiriss_dbt avoiriss, " +
                             "        (select min(rq.t_FactDate) as t_PlacementDate, qFI.t_FIID " +
                             "         from ddlrq_dbt rq, ddl_tick_dbt tkPl, dfininstr_dbt qFI" +
                             "         where rq.t_DocKind (+) = " + string(DL_SECUROWN) +
                             "           AND rq.t_Type (+) = " + string(DLRQ_TYPE_DELIVERY) +
                             "           AND rq.t_FIID (+) = qFI.t_FIID" +
                             "           AND tkPl.t_DealID (+)  = rq.t_DocID" +
                             "           AND rsb_secur.IsSale(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tkPl.t_DealType (+), tkPl.t_BofficeKind (+)))) = 1"
                             "           AND tkPl.t_Placement (+) = '" + string(SET_CHAR) + "'" +
                             "         group by qFI.t_FIID" +
                             "        ) tickPl" +
                             "  WHERE fi.t_Issuer = ? " +
                             "    AND (fi.t_DrawingDate > ? OR fi.t_DrawingDate = to_date('01.01.0001', 'dd.mm.yyyy')) " +
                             "    AND RSI_RSB_FIInstr.FI_AvrKindsGetRoot( 2, fi.t_AvoirKind ) = ? " +
                             "    AND RSB_FIINSTR.FI_IsCouponAvoiriss(fi.t_FIID) = 1 " +
                             //"    AND fi.t_FaceValueFI = " + string(NATCUR) +  GAA: перенес из пользовательских 10.04.2020 при адаптации на 48.2
                             "    AND avoiriss.t_FIID = fi.t_FIID " +
                             "    AND tickPl.t_FIID = fi.t_FIID " +
                             "    AND " +
                             "       ( " +
                             "          CASE " +
                             "          WHEN avoiriss.t_BegPlacementDate < tickPl.t_PlacementDate and avoiriss.t_BegPlacementDate <> to_date('01.01.0001', 'dd.mm.yyyy') " +
                             "          THEN avoiriss.t_BegPlacementDate " +
                             "          WHEN tickPl.t_PlacementDate <> to_date('01.01.0001', 'dd.mm.yyyy')"
                             "          THEN tickPl.t_PlacementDate " +
                             "          ELSE avoiriss.t_BegPlacementDate " +
                             "          END " +
                             "       ) < ?"
                       );
      cmd.AddParam({OurBank});
      cmd.AddParam(m_BeginDate);
      cmd.AddParam(AVOIRISSKIND_BOND);
      cmd.AddParam(m_EndDate);
      var ds = cmd.Execute();

      while( ds.movenext() )
        m_AvrFIIDList[m_AvrFIIDList.size] = TWsFinInstr(int(ds.FIID), null, null, null, null, ds.Name);
      end;
    end;
    cnt = m_AvrFIIDList.Size;
  end;

  macro Count()
    return cnt;
  end;

  macro GetFIID(progress_idx)
    if( progress_idx < m_AvrFIIDList.Size )
      return m_AvrFIIDList[progress_idx];
    else
      return -1;
    end;
  end;

  Init(pAvrFIIDList, pBeginDate, pEndDate, pYear, pReportKindList);
END;

PRIVATE VAR FIIDS:CFIIDS;

MACRO GetAvoirListAddWhere(RepSubKind)
   return "";
END;

//ищем на дату, дата должна быть равной дате выплаты купона 
PRIVATE MACRO ПолучитьДопДоходНаЕдиницу(FIID, DateBIO)
   var ДопДоходНаЕдиницу = $0;
   var query, cmd,  DataSet;
   query =   " select NVL (T_ONEITEMFV, 0) AS sum "
           + "   from dbiofrval_dbt "
           + "  where t_FIID = ? "
           + "    and t_Date = ? ";

   cmd = DL_RSDCommand(query);

   cmd.AddParam(FIID);
   cmd.AddParam(DateBIO);

   DataSet = cmd.Execute();
   if(DataSet.moveNext())
     ДопДоходНаЕдиницу = DataSet.sum;
   end;
   return ДопДоходНаЕдиницу;
END;

PRIVATE MACRO ПолучитьДопДоход(FIID, DateBIO)
   var ДопДоходНаЕдиницу = $0;
   var query, cmd,  DataSet;
   query =   " select NVL(SUM(lnk.T_ADDINCOMEOWNCHANGE), 0 )  AS sum "
           + "   from DPMWRTLNK_DBT lnk"
           + "  where lnk.T_KIND =  "  + PMWRTLINK_KIND_RETADDINCOME
           + "    and lnk.T_CREATEDATE = ? "
           + " AND lnk.T_BUYID IN (SELECT T_SUMID FROM DPMWRTSUM_DBT WHERE T_FIID = ?)"
;

   cmd = DL_RSDCommand(query);

   cmd.AddParam(DateBIO);
   cmd.AddParam(FIID);

   DataSet = cmd.Execute();
   if(DataSet.moveNext())
     ДопДоходНаЕдиницу = DataSet.sum;
   end;
   return ДопДоходНаЕдиницу;
END;


PRIVATE CLASS ( DL_CReportTemplate ) Own_Bonds_Registers_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
   var m_BegDate;
   var m_EndDate;
   var m_Avoir;
   var m_Year;
   var m_DepartmentName;
   var m_Nominal;
   var m_BegPlacementDate;

   var m_CurrStrNum;
   var m_F012;
   var m_H01;
   var m_DataSet;
   var m_DataExists;

   var НОМЕР_ПЕРВОЙ_СТРОКИ = 12;

   PRIVATE VAR m_num = 1;
   PRIVATE VAR m_CntAvr = 0, m_DateC3 = date(0,0,0), m_DateC4 = date(0,0,0);
   PRIVATE VAR m_IsFirstCallIndicator = true, m_progress_idx = 0, m_HeaderIndicator = "Обработка ц/б";

   PRIVATE MACRO InitVariables()
      m_BegDate = BeginDate;
      m_EndDate = EndDate;
      m_Avoir   = FIIDS.GetFIID(m_progress_idx);
      m_Year    = Year;
      m_DepartmentName = "";
      m_Nominal = $0;
      m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ;
      m_F012 = 0;
      m_H01 = string(BeginDate:f) + " - " + string(EndDate:f);
      m_DataSet = NULL;
      m_DataExists = false;
      
      var DepartmentQuery = "select party.t_Name from dparty_dbt party where party.t_PartyID = " + string({OurBank});
      var DepartmentSelect = DL_RSDCommand(DepartmentQuery);
      var DepartmentDS = DepartmentSelect.Execute();

      if(DepartmentDS.MoveNext())
         m_DepartmentName = DepartmentDS.Name;
      end;

      var NominalQuery = "select RSB_FIINSTR.FI_GetNominalOnDate(avoir.t_FIID, ?, 1) as t_Nominal, avoir.t_BegPlacementDate from davoiriss_dbt avoir where avoir.t_FIID = ?";
      var NominalSelect = DL_RSDCommand(NominalQuery);
      NominalSelect.AddParam(m_BegDate);
      NominalSelect.AddParam(m_Avoir.FIID);
      var NominalDS = NominalSelect.Execute();

      if(NominalDS.MoveNext())
         m_Nominal = NominalDS.Nominal;
         m_BegPlacementDate = NominalDS.BegPlacementDate;
      end;
   END;

   PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
   END;

   PRIVATE MACRO FSUM(CellName:String)
      return F(FormulaSum() + "(" + CellName + string(НОМЕР_ПЕРВОЙ_СТРОКИ) + ":" + CellName + IIF(m_DataExists, string(m_CurrStrNum - 1), string(m_CurrStrNum)) + ")");
   END;

   PRIVATE MACRO BeginReport(NumCopy:INTEGER)
      if(FIIDS.Count > 0)
         InitVariables();
      end;
   END;

   PRIVATE MACRO RegisterTable0261()
      RegisterTable(   "N1_MainTable", "N1_Header",
                       "N1_A1",
                       "N1_A2",
                       "N1_A3",
                       "N1_A4",
                       "N1_A5",
                       "N1_A6",
                       "N1_A7",
                       "N1_A8",
                       "N1_A9",
                       "N1_A10",
                       "N1_A11",
                       "N1_A12"
                   );
   END;

   PRIVATE MACRO PrintReportHead0261()
      PrintFormatString(   NULL,
                           "N1_H1", m_DepartmentName,
                           "N1_H0.1", m_H01
                       );

      if(FIIDS.Count > 0)
         PrintFormatString(   NULL,
                              "N1_H0.2", m_Avoir.Name,
                              "N1_H0.4", m_Nominal
                          );
      else
         PrintFormatString(   NULL,
                              "N1_H0.2", "",
                              "N1_H0.4", ""
                          );
      end;
   END;

   PRIVATE MACRO PrintTableLine0261(A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12)
      PrintTableLine(   "N1_A1", A1, NULL,
                        "N1_A2", A2, NULL,
                        "N1_A3", A3, NULL,
                        "N1_A4", A4, NULL,
                        "N1_A5", A5, NULL,
                        "N1_A6", A6, NULL,
                        "N1_A7", A7, NULL,
                        "N1_A8", A8, NULL,
                        "N1_A9", A9, NULL,
                        "N1_A10", A10, NULL,
                        "N1_A11", A11, NULL,
                        "N1_A12", A12, NULL
                    );

      if(FIIDS.Count > 0)
         m_F012 = m_F012 + Int(A12);
         m_CurrStrNum = m_CurrStrNum + 1;
      end;
   END;

   PRIVATE MACRO PrintItogs0261()
      if(FIIDS.Count > 0)
         PrintFormatString(   "",
                              "N1_F0.4", FSUM("D"),
                              "N1_F0.6", FSUM("F"),
                              "N1_F0.8", FSUM("H"),
                              "N1_F0.9", FSUM("I"),
                              "N1_F0.10", FSUM("J"),
                              "N1_F0.11", FSUM("K"),
                              "N1_F0.12", FSUM("L")
                          );
      else
         PrintFormatString(   "",
                              "N1_F0.4", "",
                              "N1_F0.6", "",
                              "N1_F0.8", "",
                              "N1_F0.9", "",
                              "N1_F0.10", "",
                              "N1_F0.11", "",
                              "N1_F0.12", ""
                          );
      end;
   END;

   PRIVATE MACRO PrintFooter0261()
      if(FIIDS.Count > 0)
         PrintFormatString(   NULL,
                              "N1_A13", IIF(m_F012 < 0, m_F012, 0),
                              "N1_A14", IIF(m_F012 < 0, m_F012, 0)
                          );
      else
         PrintFormatString(   NULL,
                              "N1_A13", 0,
                              "N1_A14", 0
                          );
      end;
   END;

   PRIVATE MACRO A2():DATE
     return date(m_DataSet.DeliveryDate);
   END;

   PRIVATE MACRO A3():STRING
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return "BUY";
        end;

        return "SELL";
     end;

     return "";
   END;

   PRIVATE MACRO A4():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return m_DataSet.DealAmount;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A5():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          if(m_DataSet.RelativePrice == SET_CHAR)
            return m_DataSet.Price;
          else
            return m_DataSet.Price * 100.0 / m_DataSet.FaceValue;
          end;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A6():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return m_DataSet.DealAmount;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A7():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          if(m_DataSet.RelativePrice == SET_CHAR)
            return m_DataSet.Price;
          else
            return m_DataSet.Price * 100.0 / m_DataSet.FaceValue;
          end;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A8():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return m_DataSet.RealizAmount;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A9():MONEY
     if(FIIDS.Count > 0)
        if(A6() == 0)
          return A4() - A8();
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A10():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return A6() * m_DataSet.FaceValue;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A11():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return A6() * A7() * m_DataSet.FaceValue / 100.0;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A12():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return A11() - A10();
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO PrintReport0261(IsEmpty)
      var query, cmd, i = 1;

      m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ = 12;
      SetActiveSheet("Справка (B-S)");
      PrintReportHead0261();
      RegisterTable0261();

      if(IsEmpty == NULL)
         IsEmpty = false;
      end;
      if(IsEmpty == false)
         cmd = DL_RSDCommand(query);

         query =   " select rq.t_FactDate as DeliveryDate, "
                 + "        RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) as DealIsBuy, "
                 + "        rq.t_Amount as DealAmount, "
                 + "        leg.t_Price as Price, "
                 + "        leg.t_RelativePrice as RelativePrice, "
                 + "        RSB_FIInstr.FI_GetNominalOnDate(rq.t_FIID, ?) as FaceValue, "
                 + "        NVL((select sum(lnk.t_Amount) "
                 + "               from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lot "
                 + "              where lot.t_DealID = rq.t_DocID "
                 + "                and lnk.t_BuyID = lot.t_SumID "
                 + "                and lnk.t_CreateDate <= ? "
                 + "                and lnk.t_Kind = " + PMWRTLINK_KIND_SALE_BUYOUT
                 + "           ),0) as RealizAmount "
                 + "   from ddlrq_dbt rq, dfininstr_dbt fin, ddl_tick_dbt tk, ddl_leg_dbt leg "
                 + "  where rq.t_DocKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
                 + "    and rq.t_FactDate >= ? "
                 + "    and rq.t_FactDate <= ? "
                 + "    and rq.t_Type = " + DLRQ_TYPE_DELIVERY
                 + "    and fin.t_FIID = rq.t_FIID "
                 + "    and fin.t_FaceValueFI = " + NATCUR
                 + "    and RSB_FIInstr.FI_IsCouponAvoiriss(rq.t_FIID) != 0 "
                 + "    and tk.t_DealID = rq.t_DocID "
                 + "    and leg.t_DealID = rq.t_DocID "
                 + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
                 + "    and leg.t_LegID = 0 ";

         cmd.AddParam(m_EndDate);
         cmd.AddParam(m_EndDate);
         cmd.AddParam(m_BegDate);
         cmd.AddParam(m_EndDate);

         if((m_Avoir != null) and (m_Avoir.FIID > 0))
           query = query + " and rq.t_FIID = ? ";
           cmd.AddParam(m_Avoir.FIID);
         end;

         query = query
                 + " order by rq.t_FactDate ASC, RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) DESC ";

         m_DataSet = cmd.Execute(query);

         while(m_DataSet.MoveNext())
            m_DataExists = true;
            PrintTableLine0261(i, A2(), A3(), A4(), A5(), A6(), A7(), A8(), A9(), A10(), A11(), A12());
            i = i + 1;
         end;
      else
         PrintTableLine0261(i, "", "", "", "", "", "", "", "", "", "", "");
      end;

      EndTable();
      PrintItogs0261();

      PrintFooter0261();
   END;

   PRIVATE MACRO RegisterTable0262()
      RegisterTable(   "N2_MainTable", "N2_Header",
                       "N2_A1",
                       "N2_A2",
                       "N2_A3",
                       "N2_A4",
                       "N2_A5",
                       "N2_A6",
                       "N2_A7",
                       "N2_A8",
                       "N2_A9",
                       "N2_A10",
                       "N2_A11",
                       "N1_A12"
                   );
   END;

   PRIVATE MACRO PrintReportHead0262()
      PrintFormatString(   NULL,
                           "N2_H1", m_DepartmentName,
                           "N2_H0.1", m_H01
                       );

      if(FIIDS.Count > 0)
         PrintFormatString(   NULL,
                              "N2_H0.2", m_Avoir.Name,
                              "N2_H0.4", m_Nominal
                          );
      else
         PrintFormatString(   NULL,
                              "N2_H0.2", "",
                              "N2_H0.4", ""
                          );
      end;
   END;

   PRIVATE MACRO PrintTableLine0262(A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13)
      PrintTableLine(   "N2_A1", A1, NULL,
                        "N2_A2", A2, NULL,
                        "N2_A3", A3, NULL,
                        "N2_A4", A4, NULL,
                        "N2_A5", A5, NULL,
                        "N2_A6", A6, NULL,
                        "N2_A7", A7, NULL,
                        "N2_A8", A8, NULL,
                        "N2_A9", A9, NULL,
                        "N2_A10", A10, NULL,
                        "N2_A11", A11, NULL,
                        "N2_A12", A12, NULL,
                        "N2_A13", A13, NULL
                    );

      m_CurrStrNum = m_CurrStrNum + 1;
   END;

   PRIVATE MACRO PrintItogs0262()
      if(FIIDS.Count > 0)
         PrintFormatString(NULL, "N2_F0.4", FSUM("D"),
                                 "N2_F0.6", FSUM("F"),
                                 "N2_F0.7", FSUM("G"),
                                 "N2_F0.8", FSUM("H"),
                                 "N2_F0.9", FSUM("I"),
                                 "N2_F0.10", FSUM("J"),
                                 "N2_F0.11", FSUM("K"),
                                 "N2_F0.12", FSUM("L"),
                                 "N2_F0.13", FSUM("M")
                          );
      else
         PrintFormatString(NULL, "N2_F0.4", "",
                                 "N2_F0.6", "",
                                 "N2_F0.7", "",
                                 "N2_F0.8", "",
                                 "N2_F0.9", "",
                                 "N2_F0.10", "",
                                 "N2_F0.11", "",
                                 "N2_F0.12", "",
                                 "N2_F0.13", ""
                          );
      end;
   END;

   PRIVATE MACRO A2_0262():DATE
     if(FIIDS.Count > 0)
        return date(m_DataSet.DeliveryDate);
     end;

     return date(0, 0, 0);
   END;

   PRIVATE MACRO A3_0262():STRING
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return "BUY";
        end;

        return "SELL";
     end;

     return "";
   END;

   PRIVATE MACRO A4_0262():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return m_DataSet.DealAmount;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A5_0262():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return m_DataSet.DealNKD;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A6_0262():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return m_DataSet.DealAmount;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A7_0262():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return m_DataSet.DealNKD;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A8_0262():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return m_DataSet.RealizAmount;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A9_0262():MONEY
     if(FIIDS.Count > 0)
        if(A6_0262() == 0)
          return A4_0262() - A8_0262();
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A10_0262():MONEY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return m_DataSet.NKDBuyOnce * A6_0262();
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A11_0262():MONEY
     if(FIIDS.Count > 0)
        if(A6_0262() != 0)
          return A7_0262() - A10_0262();
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A12_0262():MONEY   //BUY
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy > 0)
          return m_DataSet.SumBIO;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO A13_0262():MONEY   //SELL
     if(FIIDS.Count > 0)
        if(m_DataSet.DealIsBuy == 0)
          return m_DataSet.SumBIO;
        end;
     end;

     return 0;
   END;

   PRIVATE MACRO PrintReport0262(IsEmpty)
      var query, cmd, i = 1;
   
      m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ;
      m_DataExists = false;
      SeTActiveSheet("Справка (НКД)");
      PrintReportHead0262();
      RegisterTable0262();

      if(IsEmpty == NULL)
         IsEmpty = false;
      end;
      if(IsEmpty == false)
         cmd = DL_RSDCommand(query);

         query =   " select rq.t_FactDate as DeliveryDate, "
                 + "        RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) as DealIsBuy, "
                 + "        rq.t_Amount as DealAmount, "
                 + "        leg.t_NKD as DealNKD, "
                 + "        NVL((select sum(lnk.t_Amount) "
                 + "               from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lot "
                 + "              where lot.t_DealID = rq.t_DocID "
                 + "                and lnk.t_BuyID = lot.t_SumID "
                 + "                and lnk.t_CreateDate <= ? "
                 + "                and lnk.t_Kind = " + PMWRTLINK_KIND_SALE_BUYOUT
                 + "           ),0) as RealizAmount, "
                 + "        NVL((select sum(lotBuy.t_NKDAmount/lotBuy.t_Amount)"
                 + "               from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lotSale, v_scwrthistex lotBuy"
                 + "              where lotSale.t_DealID = rq.t_DocID "
                 + "                and lnk.t_SaleID = lotSale.t_SumID "
                 + "                and lotBuy.t_SumID = lnk.t_BuyID "
                 + "                and lotBuy.t_Instance = 0 "
                 + "           ), 0) as NKDBuyOnce, "
                 + "        NVL((select sum(lnk.t_Amount) "
                 + "               from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lot "
                 + "              where lot.t_DealID = rq.t_DocID "
                 + "                and lnk.t_BuyID = lot.t_SumID "
                 + "                and lnk.t_CreateDate <= ? "
                 + "                and lnk.t_Kind = " + PMWRTLINK_KIND_RETADDINCOME
                 + "           ),0) as SumBIO "
                 + "   from ddlrq_dbt rq, dfininstr_dbt fin, ddl_tick_dbt tk, ddl_leg_dbt leg "
                 + "  where rq.t_DocKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
                 + "    and rq.t_FactDate >= ? "
                 + "    and rq.t_FactDate <= ? "
                 + "    and rq.t_Type = " + DLRQ_TYPE_DELIVERY
                 + "    and fin.t_FIID = rq.t_FIID "
                 + "    and fin.t_FaceValueFI = " + NATCUR
                 + "    and RSB_FIInstr.FI_IsCouponAvoiriss(rq.t_FIID) != 0 "
                 + "    and tk.t_DealID = rq.t_DocID "
                 + "    and tk.t_Placement = CHR(0) "
                 + "    and leg.t_DealID = rq.t_DocID "
                 + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
                 + "    and leg.t_LegID = 0 ";

         cmd.AddParam(m_EndDate);
         cmd.AddParam(m_BegDate);
         cmd.AddParam(m_BegDate);
         cmd.AddParam(m_EndDate);

         if((m_Avoir != null) and (m_Avoir.FIID > 0))
           query = query + " and rq.t_FIID = ? ";
           cmd.AddParam(m_Avoir.FIID);
         end;

         query = query
                 + " order by rq.t_FactDate ASC, RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) DESC ";

         m_DataSet = cmd.Execute(query);
         while(m_DataSet.moveNext())
            m_DataExists = true;
            PrintTableLine0262(i, A2_0262(), A3_0262(), A4_0262(), A5_0262(), A6_0262(), A7_0262(), A8_0262(), A9_0262(), A10_0262(), A11_0262, A12_0262(), A13_0262());
            i = i + 1;
         end;
      else
         PrintTableLine0262(i, "", "", "", "", "", "", "", "", "", "", "", "");
      end;
      
      EndTable();
      PrintItogs0262();      
   END;

   PRIVATE MACRO PrintReportHead0461()
      if(FIIDS.Count > 0)
         var FIcmd = DL_RSDCommand("select t_ISIN from davoiriss_dbt where t_FIID = ?");
         FIcmd.AddParam(m_Avoir.FIID);
         var FIDS = FIcmd.Execute();
         var ISIN = "";
         if(FIDS.MoveNext() and (FIDS.ISIN != ""))
            ISIN = " (" + FIDS.ISIN + ")";
         end;
      end;
      
      PrintFormatString(NULL, "N3_H1", m_DepartmentName,
                              "N3_H0.1", m_H01,
                              "N3_H0.5", m_BegPlacementDate
                       );

      if(FIIDS.Count > 0)
         PrintFormatString(NULL, "N3_H0.2", m_Avoir.Name + ISIN,
                                 "N3_H0.4", m_Nominal
                          );
      else
         PrintFormatString(NULL, "N3_H0.2", "",
                                 "N3_H0.4", ""
                          );
      end;
   END;

   PRIVATE MACRO RegisterTable0461_1()
      m_Num = 1;
      RegisterTable(   "N3_MainTable1", "N3_Header",
                       "N3_A1",
                       "N3_A2",
                       "N3_A3",
                       "N3_A4",
                       "N3_A5",
                       "N3_A6",
                       "N3_A7",
                       "N3_A8",
                       "N3_A8_2",
                       "N3_A9"
                   );

      НОМЕР_ПЕРВОЙ_СТРОКИ = 16;
      m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ;
   END;

   PRIVATE MACRO RegisterTable0461_2()
      m_Num = 1;
      RegisterTable(   "N3_MainTable2", "N3_Header",
                       "N3_A10",
                       "N3_A11",
                       "N3_A12",
                       "N3_A13",
                       "N3_A14",
                       "N3_A15",
                       "N3_A16",
                       "N3_A17",
                       "N3_A17_2",
                       "N3_A18"
                   );

      НОМЕР_ПЕРВОЙ_СТРОКИ = m_CurrStrNum + IIF(m_DataExists, 3, 4);
      m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ;
      m_DataExists = false;
   END;

   PRIVATE MACRO RegisterTable0461_3()
      m_Num = 1;
      RegisterTable(   "N3_MainTable3", "N3_Header",
                       "N3_A19",
                       "N3_A20",
                       "N3_A21",
                       "N3_A22",
                       "N3_A23",
                       "N3_A24",
                       "N3_A25",
                       "N3_A26",
                       "N3_A26_2",
                       "N3_A27"
                   );

      НОМЕР_ПЕРВОЙ_СТРОКИ = m_CurrStrNum + IIF(m_DataExists, 3, 4);
      m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ;
      m_DataExists = false;
   END;

   PRIVATE MACRO GetPlacedAmountOnDate(OnDate:DATE):NUMERIC
      var Amount = 0;
      var query = "select RSB_PMWRTOFF.WRTGetAmountOwn( ?, ?, ?, ?, ? ) Amount from dual ";
      var cmd = DL_RSDCommand(query);
      cmd.AddParam(-1);
      cmd.AddParam(m_Avoir.rec.FIID);
      cmd.AddParam(OnDate);
      cmd.AddParam(1);
      cmd.AddParam(0);
 
      var DataSet = cmd.Execute();
 
      if(DataSet.moveNext())
        Amount = DataSet.Amount;
      end;
 
      return Amount;
   END;

   PRIVATE MACRO A2_0461():NUMERIC
     return m_CntAvr;
   END;

   PRIVATE MACRO A3_0461():DATE
     return m_DateC3;
   END;

   PRIVATE MACRO A4_0461():DATE
     return m_DateC4;
   END;

   PRIVATE MACRO A5_0461():INTEGER
     if(FIIDS.Count > 0)
        return A4_0461() - A3_0461();
     else
        return 0;
     end;
   END;

   PRIVATE MACRO A6_0461():DOUBLE
     var query, cmd, DataSet;
     var rate = 0.0;

     if(FIIDS.Count > 0)
        query =   " select * "
                + "   from dfiwarnts_dbt "
                + "  where t_FIID = ? "
                + "    and t_IsPartial = CHR(0) "
                + "    and t_DrawingDate > ? "
                + "  order by t_DrawingDate ASC ";

        cmd = DL_RSDCommand(query);

        cmd.AddParam(m_Avoir.FIID);
        cmd.AddParam(A3_0461());

        DataSet = cmd.Execute();
        if(DataSet.moveNext())
          var CalcNKDCmd = DL_RSDCommand("select RSI_RSB_FIInstr.CalcNKD_Ex(?, ?, 1, 1, 0) from dual");
          CalcNKDCmd.AddParam(DataSet.FIID);
          CalcNKDCmd.AddParam(DataSet.DrawingDate);
          var CalcNKDDS = CalcNKDCmd.Execute();
          
          var RateIncomeCmd = DL_RSDCommand("select RSI_RSB_FIInstr.FI_ReturnIncomeRate() as t_Rate from dual");
          var RateIncomeDS = RateIncomeCmd.Execute();
          if(RateIncomeDS.MoveNext())
             rate = RateIncomeDS.Rate/100.0;
          end;
        end;
     end;

     return rate;
   END;

   PRIVATE MACRO A7_0461():INTEGER
     var fw = TRecHandler("fiwarnts.dbt");
     var avr = TRecHandler("avoiriss.dbt");
     var DaysInYear = 0, DaysInCoupon = 0;

     if(FIIDS.Count > 0)
        fw.Clear();

        ПолучитьФинИн(m_Avoir.FIID, null, avr);

        ПолучитьПараметрыБазисаРасчетаКупона(avr.rec.NKDBase_Kind, fw.rec, m_EndDate, DaysInYear, DaysInCoupon);
     end;

     return DaysInYear;
   END;

   PRIVATE MACRO A8_0461():MONEY
     var NKD = $0, err = 0;

     if(FIIDS.Count > 0)
        NKD = round(ПолучитьНКДЗаПериод(m_Avoir.FIID, 1, A3_0461()+1, A4_0461(), false, false, err, true), 2);
     end;

     return NKD;
   END;

   PRIVATE MACRO A8_0461_2():MONEY
     var ДопДоход = $0, err = 0;

     if(FIIDS.Count > 0)
        ДопДоход = round(ПолучитьДопДоходНаЕдиницу(m_Avoir.FIID, A4_0461()), 2);
     end;

     return ДопДоход;
   END;

   PRIVATE MACRO A8_0461_2_():MONEY
     var ДопДоход = $0, err = 0;

     if(FIIDS.Count > 0)
        ДопДоход = round(ПолучитьДопДоход(m_Avoir.FIID, A4_0461()), 2);
// берем данные c линков (фактические)
     end;

     return ДопДоход;
   END;


   PRIVATE MACRO A9_0461():MONEY
     if(FIIDS.Count > 0)
        return A2_0461() * A8_0461() + A8_0461_2_();
     end;

     return 0;
   END;

   PRIVATE MACRO PrintTableLine0461_1(CntAvr, DateA3, DateA4)
      if(CntAvr > 0)
         m_DataExists = true;
         m_CntAvr = CntAvr; 
         m_DateC3 = DateA3; 
         m_DateC4 = DateA4;
         PrintTableLine( "N3_A1", m_Num, NULL,
                         "N3_A2", A2_0461(), NULL,
                         "N3_A3", A3_0461(), NULL,
                         "N3_A4", A4_0461(), NULL,
                         "N3_A5", A5_0461(), NULL,
                         "N3_A6", A6_0461(), NULL,
                         "N3_A7", A7_0461(), NULL,
                         "N3_A8", A8_0461(), NULL,
                         "N3_A8_2", "", NULL,
                         "N3_A9", A9_0461(), NULL
                       );
   
         m_Num = m_Num + 1;
         m_CurrStrNum = m_CurrStrNum + 1;
      end;
   END;

   PRIVATE MACRO PrintTableLine0461_2(CntAvr, DateA3, DateA4)
      if(CntAvr > 0)
         m_DataExists = true;
         m_CntAvr = CntAvr; 
         m_DateC3 = DateA3; 
         m_DateC4 = DateA4;
         PrintTableLine( "N3_A10", m_Num, NULL,
                         "N3_A11", A2_0461(), NULL,
                         "N3_A12", A3_0461(), NULL,
                         "N3_A13", A4_0461(), NULL,
                         "N3_A14", A5_0461(), NULL,
                         "N3_A15", A6_0461(), NULL,
                         "N3_A16", A7_0461(), NULL,
                         "N3_A17", A8_0461(), NULL,
                         "N3_A17_2", A8_0461_2(), NULL,
                         "N3_A18", A9_0461(), NULL
                       );
   
         m_Num = m_Num + 1;
         m_CurrStrNum = m_CurrStrNum + 1;
      end;
   END;

   PRIVATE MACRO PrintTableLine0461_3(CntAvr, DateA3, DateA4)
      if(CntAvr > 0)
         m_DataExists = true;
         m_CntAvr = CntAvr; 
         m_DateC3 = DateA3; 
         m_DateC4 = DateA4;
         PrintTableLine( "N3_A19", m_Num, NULL,
                         "N3_A20", A2_0461(), NULL,
                         "N3_A21", A3_0461(), NULL,
                         "N3_A22", A4_0461(), NULL,
                         "N3_A23", A5_0461(), NULL,
                         "N3_A24", A6_0461(), NULL,
                         "N3_A25", A7_0461(), NULL,
                         "N3_A26", A8_0461(), NULL,
                         "N3_A26_2",""/* A8_0461_2()*/, NULL,
                         "N3_A27", A9_0461(), NULL
                       );
   
         m_Num = m_Num + 1;
         m_CurrStrNum = m_CurrStrNum + 1;
      end;
   END;

   PRIVATE MACRO FSET(StrNum)
      return F("J" + string(StrNum));
   END;

   PRIVATE MACRO GetRedemptLnkCountInDate(LnkDate:date, _startdate: date/*GAA:517923*/)
      var query, cmd, DataSet;
      var Amount = 0;
 
      query =   " select NVL(SUM(lnk.t_Amount), 0) as Amount"
              + "   from dpmwrtsum_dbt lot, ddl_tick_dbt tk, dpmwrtlnk_dbt lnk "
              + "  where lot.t_FIID = ? "
              + "    and lot.t_Portfolio = -1 "
              + "    and lot.t_Party = -1 "
              + "    and tk.t_DealID = lot.t_DealID "
              + "    and tk.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
              + "    and lnk.t_SaleID = lot.t_SumID "
              + "    and lnk.t_CreateDate <= ? "
              + "    and lnk.t_CreateDate > ? "/*GAA:517923*/
              + "    and lnk.t_Kind != " + PMWRTLINK_KIND_SALE_BUYOUT;
 
      cmd = DL_RSDCommand(query);
 
      cmd.AddParam(m_Avoir.FIID);
      cmd.AddParam(LnkDate);
      cmd.AddParam(_startdate);/*GAA:517923*/
      
      DataSet = cmd.Execute();
 
      if(DataSet.moveNext())
        Amount = int(DataSet.Amount);
      end;
 
      return Amount;
   END;

   //Дата последнего погашения (для A3 EndDate = m_BegDate)
   MACRO GetDrawingDate(EndDate)
      var query =   " select t_DrawingDate "
                + "   from dfiwarnts_dbt "
                + "  where t_FIID = ? "
                + "    and t_IsPartial = CHR(0) "
                + "    and t_DrawingDate <= ? "
                + "  order by t_DrawingDate DESC";
      
      var cmd = DL_RSDCommand(query);
 
      cmd.AddParam(m_Avoir.FIID);
      cmd.AddParam(EndDate);
      var DataSet = cmd.Execute();
      if(DataSet.moveNext())
        return date(DataSet.DrawingDate);
      else
        //фактическая дата начала купонного периода при первичном размещении данного выпуска (при условии, что данный период открыт),
        // но не превышающая дату окончания предыдущего отчетного (налогового) периода <Н0.1> - 1 день
        return date(0, 0, 0);
      end;
   END;

   //фактическая дата начала купонного периода при первичном размещении данного выпуска (при условии, что данный период открыт),
   //но не превышающая дату EndDate - 1 день (для A3 EndDate = m_BegDate) 
   MACRO GetStartCouponDate(EndDate, IsA12, IsA21)
      if(IsA12 == NULL)
         IsA12 = false;
      end;
      if(IsA21 == NULL)
         IsA21 = false;
      end;
      
//      var query =   "select fiwarnts.t_FirstDate" + IIF(IsA12 or IsA21, " - 1", "") + " as t_FirstDate "
      var query =   "select fiwarnts.t_FirstDate - 1 as t_FirstDate "/*GAA: 517923 Если не отнимать 1 в А3, то при первичном размещении в пред. пер. теряется 1 день начислений*/
                  + "from dfiwarnts_dbt fiwarnts "
                  + "where fiwarnts.t_FIID = ? "
                  + "   and fiwarnts.t_IsPartial <> '" + SET_CHAR + "'"
                  + "   and fiwarnts.t_DrawingDate > ( "
                  + "                                   select min(rq.t_FactDate) "
                  + "                                   from ddl_tick_dbt tick, ddlrq_dbt rq "
                  + "                                   where rq.t_FIID = fiwarnts.t_FIID "
                  + "                                     and rq.t_DocKind = " + string(DL_SECUROWN)
                  + "                                     and rq.t_Type = " + string(DLRQ_TYPE_DELIVERY)
                  + "                                     and tick.t_DealID = rq.t_DocID "
                  + "                                     and tick.t_Placement = '" + SET_CHAR + "'"
                  + "                                ) ";
                  if(IsA12)
                     query = query + "   and ("
                                   + "          fiwarnts.t_DrawingDate between ? and ?"
                                   + "          or (select nvl(min(lnk.t_CreateDate), to_date('01.01.0001', 'dd.mm.yyyy')) "
                                   + "              from dpmwrtsum_dbt lot, ddl_tick_dbt tk, dpmwrtlnk_dbt lnk "
                                   + "              where lot.t_FIID = fiwarnts.t_FIID "
                                   + "                and lot.t_Portfolio = -1 "
                                   + "                and lot.t_Party = -1 "
                                   + "                and tk.t_DealID = lot.t_DealID "
                                   + "                and tk.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+", "+DL_RETIREMENT_OWN+") "
                                   + "                and lnk.t_SaleID = lot.t_SumID "
                                   + "                and lnk.t_CreateDate > fiwarnts.t_FirstDate "
                                   + "                and lnk.t_CreateDate < fiwarnts.t_DrawingDate "
                                   + "                and lnk.t_Kind != " + PMWRTLINK_KIND_SALE_BUYOUT
                                   + "             ) between ? and ?"
                                   + "       )";
                  elif(IsA21)
                     query = query + "   and fiwarnts.t_DrawingDate < ? ";
                  else
                     query = query + "   and fiwarnts.t_FirstDate < ? ";
                  end;

      query = query + "   and fiwarnts.t_FirstDate = ( "
                    + "                                 select min(fiwarnts1.t_FirstDate) "
                    + "                                 from dfiwarnts_dbt fiwarnts1 "
                    + "                                 where fiwarnts1.t_FIID = fiwarnts.t_FIID "
                    + "                              ) "
                    + "order by fiwarnts.t_FirstDate ASC";

        var cmd = DL_RSDCommand(query);
        cmd.AddParam(m_Avoir.FIID);
        if(IsA12)
           cmd.AddParam(m_BegDate);
           cmd.AddParam(EndDate);
           cmd.AddParam(m_BegDate);
           cmd.AddParam(EndDate);
        elif(IsA21)
           cmd.AddParam(EndDate);
        else
           cmd.AddParam(EndDate);
        end;

        var DataSet = cmd.Execute();
        if(DataSet.MoveNext())
             return date(DataSet.FirstDate);
        else
           return date(0, 0, 0);
        end;
   END;

   PRIVATE MACRO PrintReport0461(IsEmpty)
      var A281StrNum = 0;
      var A282StrNum = 0;
      var A283StrNum = 0;

      var query, cmd, DataSet;
      var q, cmd1, ds;
      var CurrEndDate = date(0,0,0);
      var PrevCoupStartDate = date(0, 0, 0), PrevCoupEndDate = date(0, 0, 0), FirstCoupEndDate = date(0, 0, 0);
      var Periods = TArray();
//debugbreak;/*GAA*/
      var DateA3 = date(0, 0, 0);
      var DatePrevCoup = date(0, 0, 0);
      var isPrevRazm = false;

      if(IsEmpty == NULL)
         IsEmpty = false;
      end;

      SetActiveSheet("COUP");

      if(IsEmpty == false)
         InitVariables();
      end;

      m_DataExists = false;
      PrintReportHead0461();

      if(IsEmpty == false)
         //Таблица 1
         //Найдем дату последнего погашения купона в предыдущем налоговом периоде
         DateA3 = GetDrawingDate(m_BegDate-1);
/*GAA*/
         if(DateA3 != date(0, 0, 0))
            DatePrevCoup = DateA3;
         end; /*GAA*/
         if(DateA3 == date(0, 0, 0))
            DateA3 = GetStartCouponDate(m_BegDate);
         end;

         RegisterTable0461_1();

         //отбираем лоты, по которым был остаток на конец предыдущего налогового периода
         //группируем их по дате размещения, если она больше даты последнего погашения купона в предыдущем периоде, либо по дате последнего погашения купона в предыдущем периоде
         //каждая группа - отдельная строка в таблице
    
         q =   " select q.LotDate, SUM(q.Amount) as Amount "
             + "   from (select (CASE WHEN lot.t_Date < ? THEN ? ELSE lot.t_Date END) as LotDate, "
             + "                lot.t_Amount as Amount "
             + "           from v_scwrthistex lot "
             + "          where lot.t_FIID = ? "
             + "            and lot.t_State = " + PM_WRTSUM_PLACE_OWN
             + "            and lot.t_Amount > 0 "
             + "            and lot.t_Date < ? "
             + "            and lot.t_Instance = (select MAX(l.t_Instance) "
             + "                                    from v_scwrthistex l "
             + "                                   where l.t_SumID = lot.t_SumID "
             + "                                     and l.t_ChangeDate < ? "
             + "                                 ) "
             + "        ) q "
             + "  group by q.LotDate "
             + "  order by q.LotDate ASC ";
    
         cmd1 = DL_RSDCommand(q);
    
         cmd1.AddParam(DateA3);
         cmd1.AddParam(DateA3);
         cmd1.AddParam(m_Avoir.FIID);
         cmd1.AddParam(m_BegDate);
         cmd1.AddParam(m_BegDate);
    
         ds = cmd1.Execute();

         while(ds.MoveNext())
            if(DateA3 == date(0, 0, 0))
               DateA3 = ds.LotDate;
            end;
//debugbreak;/*GAA*/
            if(DatePrevCoup != ds.LotDate)
               isPrevRazm = true;        //после погашения последнего купона в предыдущем периоде были размещения.
            end;
            PrintTableLine0461_1(ds.Amount, iif(DateA3==ds.LotDate, DateA3, ds.LotDate), m_BegDate-1); /*GAA: 517923--добавил проверку, иначе теряются даты размещений после погашения посденего купона в предыдущем переоде*/
//            PrintTableLine0461_1(ds.Amount, DateA3, m_BegDate-1);
         end;
         A281StrNum = m_CurrStrNum;
         if(not m_DataExists)
            A281StrNum = A281StrNum + 1;
         end;
         EndTable();
         PrintFormatString(NULL, "N3_F0.2", FSUM("B"),
                                 "N3_F0.9", FSUM("J")
                          );

         CurrEndDate = GetDrawingDate(m_EndDate);

         //Таблица 2
         RegisterTable0461_2();

         //отбираем все даты окончания учетных периодов до даты погашения последнего купона в текущем отченом периоде
         //это будут как даты погашения купонов, так же даты выкупов/погашений до даты окончания отченого периода
         query =   " select (CASE WHEN q.EndDate < ? THEN q.EndDate ELSE ? END) as EndDate, IsBuy "
                 + "   from ((select t_DrawingDate as EndDate, 0 as IsBuy "
                 + "            from dfiwarnts_dbt fiwarnts "
                 + "           where fiwarnts.t_FIID = ? "
                 + "             and fiwarnts.t_IsPartial = CHR(0) "
                 + "             and fiwarnts.t_DrawingDate <= ? "
                 + "             and fiwarnts.t_DrawingDate >= ?"
                 + "         ) UNION "
                 + "         (select DISTINCT lnk.t_CreateDate as EndDate, 1 as IsBuy"
                 + "            from dpmwrtsum_dbt lot, ddl_tick_dbt tk, dpmwrtlnk_dbt lnk "
                 + "           where lot.t_FIID = ? "
                 + "             and lot.t_Portfolio = -1 "
                 + "             and lot.t_Party = -1 "
                 + "             and tk.t_DealID = lot.t_DealID "
                 + "             and tk.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
                 + "             and lnk.t_SaleID = lot.t_SumID "
                 + "             and lnk.t_CreateDate <= ? "
                 + "             and lnk.t_CreateDate >= ? "
                 + "             and lnk.t_Kind != " + PMWRTLINK_KIND_SALE_BUYOUT
                 + "         ) "
                 + "        ) q"
                 + "  order by q.EndDate ASC";

         cmd = DL_RSDCommand(query);

         cmd.AddParam(m_EndDate);
         cmd.AddParam(m_EndDate);
         cmd.AddParam(m_Avoir.FIID);
         cmd.AddParam(m_EndDate);
         cmd.AddParam(m_BegDate);
         cmd.AddParam(m_Avoir.FIID);
         cmd.AddParam(m_EndDate);
         cmd.AddParam(m_BegDate);
         DataSet = cmd.Execute();

         //ищем дату начала "учётного периода":
         //дата начала <учетного периода> = максимальная из двух дат - ДНОП и ближайшей к ней даты оплаты той операции, по которой ценная бумага
         //была размещена/реализована в данном <учетном периоде> (эмиссия/продажа);
         var StartDate = GetStartCouponDate(m_EndDate, true);
         while(DataSet.MoveNext())
            var EndDate = DataSet.EndDate;
            var OldEndDate = date(0, 0, 0);
            var OldEndDateQuery =   " select nvl(max(q.EndDate), to_date('01.01.0001', 'dd.mm.yyyy')) as t_EndDate "
                                  + "   from ((select t_DrawingDate as EndDate "
                                  + "            from dfiwarnts_dbt fiwarnts "
                                  + "           where fiwarnts.t_FIID = ? "
                                  + "             and fiwarnts.t_IsPartial = CHR(0) "
                                  + "             and fiwarnts.t_DrawingDate < ? "
                                  + "         ) UNION "
                                  + "         (select DISTINCT lnk.t_CreateDate as EndDate "
                                  + "            from dpmwrtsum_dbt lot, ddl_tick_dbt tk, dpmwrtlnk_dbt lnk "
                                  + "           where lot.t_FIID = ? "
                                  + "             and lot.t_Portfolio = -1 "
                                  + "             and lot.t_Party = -1 "
                                  + "             and tk.t_DealID = lot.t_DealID "
                                  + "             and tk.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
                                  + "             and lnk.t_SaleID = lot.t_SumID "
                                  + "             and lnk.t_CreateDate <= ? "
                                  + "             and lnk.t_Kind != " + PMWRTLINK_KIND_BUYOUT
                                  + "         ) "
                                  + "        ) q";

            var OldEndDateSelect = DL_RSDCommand(OldEndDateQuery);
            OldEndDateSelect.AddParam(m_Avoir.FIID);
            OldEndDateSelect.AddParam(EndDate);
            OldEndDateSelect.AddParam(m_Avoir.FIID);
            OldEndDateSelect.AddParam(EndDate);
            var OldEndDateDS = OldEndDateSelect.execute();

            if(OldEndDateDS.MoveNext())
               OldEndDate = OldEndDateDS.EndDate;
            end;

            if(StartDate == date(0, 0, 0))
               StartDate = OldEndDate;
            end;
            

            if(DataSet.IsBuy == 1)
//debugbreak;/*GAA*/
               //после погашения последнего купона были выкупы
               //значит выводим строки с расходом только на выкупленное кол-во
//               PrintTableLine0461_2(GetRedemptLnkCountInDate(Date(EndDate)), Date(StartDate), Date(EndDate));
               PrintTableLine0461_2(GetRedemptLnkCountInDate(Date(EndDate), Date(StartDate)), Date(StartDate), Date(EndDate)); /*GAA: 517925*/
            else
               q =   " select NVL (SUM(lot.t_Amount), 0) as Amount "
                   + "   from v_scwrthistex lot "
                   + "  where lot.t_FIID = ? "
                   + "    and lot.t_State = " + PM_WRTSUM_PLACE_OWN
                   + "    and lot.t_Amount > 0 "
                   + "    and lot.t_Date < ? "
                   + "    and lot.t_Instance = (select MAX(l.t_Instance) "
                   + "                            from v_scwrthistex l "
                   + "                           where l.t_SumID = lot.t_SumID "
                   + "                             and l.t_ChangeDate < ? "
                   + "                         )";
     
               cmd1 = DL_RSDCommand(q);
     
               cmd1.AddParam(m_Avoir.FIID);
               cmd1.AddParam(date(StartDate));
               cmd1.AddParam(date(EndDate));
     
               ds = cmd1.Execute();
               if(ds.MoveNext())
                 if (ds.Amount > 0)  
                    m_DataExists = true;
                    /*GAA*/ //Если были размещения после последнего погашения купона в предыдущем периоде и есть количесто бумаг до даты данного размещения, то дата начала(А12) = дата посл. пог. куп. в пред. пер.
                    if (isPrevRazm)
                      PrintTableLine0461_2(ds.Amount, Date(DatePrevCoup), Date(EndDate));
                      isPrevRazm = false;                       
                    else
                      PrintTableLine0461_2(ds.Amount, Date(StartDate), Date(EndDate));
                    end;/*GAA*/
//                    PrintTableLine0461_2(ds.Amount, Date(StartDate), Date(EndDate));
                 end;
               end;
            end;

            //на дату окончания каждого учетного периода отбираем всем лоты, которые имели остаток на эту дату
            //групиируем по дате размещения из лота, если она больше даты начала учетного периода, либо по дате начала учетного периода
            //одна группа = одной строке в таблице

            q =   " select NVL(SUM(lot.t_Amount),0) as Amount, lot.t_Date "
                + "           from v_scwrthistex lot "
                + "          where lot.t_FIID = ? "
                + "            and lot.t_State = " + PM_WRTSUM_PLACE_OWN
                + "            and lot.t_Amount > 0 "
                + "    and lot.t_Date >= ? "
                + "            and lot.t_Instance = (select MAX(l.t_Instance) "
                + "                                    from v_scwrthistex l "
                + "                                   where l.t_SumID = lot.t_SumID "
                + "                                     and l.t_ChangeDate < ? "
                + "                                 )"
                + "  group by lot.t_Date"
                + "  order by lot.t_Date ASC ";
     
            cmd1 = DL_RSDCommand(q);
     
            cmd1.AddParam(m_Avoir.FIID);
            cmd1.AddParam(date(StartDate));
            cmd1.AddParam(date(EndDate));
     
            ds = cmd1.Execute();
            while(ds.MoveNext())
               if(ds.Amount > 0)
            m_DataExists = true;
                 PrintTableLine0461_2(ds.Amount, Date(ds.Date), Date(EndDate));
            end;
            end;

            if(DataSet.IsBuy == 1) 
               StartDate = OldEndDate;
            else
            StartDate = Date(EndDate);
            end;
         end;
         A282StrNum = m_CurrStrNum;
         if(not m_DataExists)
            A282StrNum = A282StrNum + 1;
         end;
         EndTable();
         PrintFormatString(NULL, "N3_F0.18", FSUM("J"));

         //Таблица 3
         RegisterTable0461_3();

         query =  " select t_DrawingDate "
                + " from dfiwarnts_dbt "
                + " where t_FIID = ? "
                + "   and t_DrawingDate > ? "
                + " order by t_DrawingDate ASC ";
         cmd = DL_RSDCommand(query);
         cmd.AddParam(m_Avoir.FIID);
         cmd.AddParam(m_EndDate);
         DataSet = cmd.Execute();
         if(DataSet.MoveNext())
            //если дата погашения последнего в отченом периоде купона меньше даты окончания отченого периода
            //то тогда по бумагам, размещенным на дату окончания отченого периода будут неуплаченные расходы
            CurrEndDate = GetDrawingDate(m_EndDate);
            if(CurrEndDate == date(0, 0, 0))
               CurrEndDate = GetStartCouponDate(m_EndDate, false, true);
            end;
         end;
         if((CurrEndDate < m_EndDate))
            //отбираем все лоты, по которым был остаток да дату окончания отченого периода
            //группируем по дате размещения из лота, если она больше даты последнего погашенного купона в отченом периоде, либо по дате последнего погашенного купона в отченом периоде
            //одна группа = одна строка в отчете
            
            q =   " select q.LotDate, SUM(q.Amount) as Amount"
                + "   from (select (CASE WHEN lot.t_Date < ? THEN ? ELSE lot.t_Date END) as LotDate, "
                + "                lot.t_Amount as Amount"
                + "           from v_scwrthistex lot "
                + "          where lot.t_FIID = ? "
                + "            and lot.t_State = " + PM_WRTSUM_PLACE_OWN
                + "            and lot.t_Amount > 0 "
                + "            and lot.t_Date < ? "
                + "            and lot.t_Instance = (select MAX(l.t_Instance) "
                + "                                    from v_scwrthistex l "
                + "                                   where l.t_SumID = lot.t_SumID "
                + "                                     and l.t_ChangeDate < ? "
                + "                                 )"
                + "        ) q"
                + "  group by q.LotDate "
                + "  order by q.LotDate ASC ";
     
            cmd1 = DL_RSDCommand(q);
     
            cmd1.AddParam(CurrEndDate);
            cmd1.AddParam(CurrEndDate);
            cmd1.AddParam(m_Avoir.FIID);
            cmd1.AddParam(m_EndDate);
            cmd1.AddParam(m_EndDate);
     
            ds = cmd1.Execute();

            while(ds.MoveNext())
               PrintTableLine0461_3(ds.Amount, Date(ds.LotDate), m_EndDate);
            end;
         end;
         A283StrNum = m_CurrStrNum;
         if(not m_DataExists)
            A283StrNum = A283StrNum + 1;
         end;

         EndTable();

         PrintFormatString(NULL, "N3_F0.20", FSUM("B"),
                                 "N3_F0.27", FSUM("J")
                          );
      else
         RegisterTable0461_1();
         PrintTableLine0461_1("", "", "");
         EndTable();
         PrintFormatString(NULL, "N3_F0.2", FSUM("B"),
                                 "N3_F0.9", FSUM("J")
                          );
         A281StrNum = m_CurrStrNum + 1;
         RegisterTable0461_2();
         PrintTableLine0461_2("", "", "");
         EndTable();
         PrintFormatString(NULL, "N3_F0.18", FSUM("J"));
         A282StrNum = m_CurrStrNum + 1;
         RegisterTable0461_3();
         PrintTableLine0461_3("", "", "");
         EndTable();
         PrintFormatString(NULL, "N3_F0.20", FSUM("B"),
                                 "N3_F0.27", FSUM("J")
                          );
         A283StrNum = m_CurrStrNum + 1;
      end;

      PrintFormatString(NULL, "N3_A28.1", FSET(A281StrNum),
                              "N3_A28.2", FSET(A282StrNum),
                              "N3_A28.3", FSET(A283StrNum)
                       );
      НОМЕР_ПЕРВОЙ_СТРОКИ = m_CurrStrNum + IIF(m_DataExists, 2, 3);
      m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ + 3;
      PrintFormatString(NULL, "N3_F0.28", F("-H"+НОМЕР_ПЕРВОЙ_СТРОКИ+"+H"+(НОМЕР_ПЕРВОЙ_СТРОКИ+1)+"+H"+(НОМЕР_ПЕРВОЙ_СТРОКИ+2)));
   END;

   PRIVATE MACRO Create(NumCopy:INTEGER)
      var i = 0;

      if( FIIDS.Count > 0 )
         if( m_IsFirstCallIndicator )
            m_ProgressIndicator.Start(FIIDS.Count(), m_HeaderIndicator, m_HeaderIndicator);
            m_IsFirstCallIndicator = false;
         else
            m_ProgressIndicator.Update(m_progress_idx, FIIDS.Count(), m_HeaderIndicator);
         end;

         if((ReportKindList != null) and (ReportKindList.Size > 0))
            while(i < ReportKindList.Size)  
               if(ReportKindList[i] == ReportKind_0261_0262)
                  PrintReport0261();
                  PrintReport0262();
               elif(ReportKindList[i] == ReportKind_0461)
                  PrintReport0461();
               end;
               i = i + 1;
            end;
         else
            PrintReport0261();
            PrintReport0262();
            PrintReport0461();
         end;

         m_progress_idx = m_progress_idx + 1;
         if( m_progress_idx < FIIDS.Count() )
            m_ProgressIndicator.Update(m_progress_idx, FIIDS.Count(), m_HeaderIndicator);
         else
            m_ProgressIndicator.Stop();
         end;
      else
         if((ReportKindList != null) and (ReportKindList.Size > 0))
            while(i < ReportKindList.Size)
               if(ReportKindList[i] == ReportKind_0261_0262)
                  PrintReport0261(true);
                  PrintReport0262(true);
               elif(ReportKindList[i] == ReportKind_0461)
                  PrintReport0461(true);
               end;
               i = i + 1;
            end;
         else
            PrintReport0261(true);
            PrintReport0262(true);
            PrintReport0461(true);
         end;
      end;
   END;

   PRIVATE MACRO EndReport(NumCopy:INTEGER)
      ReplaceFormulaAndCalculate();
   END;

   initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;
  
/**
 @brief  Функция формирования кода периода за который создаётся отчёт
 @return Строка с кодом пероида
*/  
private macro GetPeriodCode():string
  var code = "";
  var _period;
  
  _period = Period + 12;
  // значения _period 1-12 номер месяца, 13-16 кварталы I-IV
  if((_period == 13) or (AddItog and (_period == 3)))
    code = "21";
  elif(AddItog and ((_period == 14) or (_period == 6)))
    code = "31";
  elif(AddItog and ((_period == 15) or (_period == 9)))
    code = "33";
  elif(AddItog and ((_period == 16) or (_period == 12)))
    code = "34";
  end;

  return code;
end;

/**
 @brief  Функция формирования текстового описания периода за который создаётся отчёт
 @return Строка с текстовым обозначением периода
*/ 
private macro GetPeriodTxt():string
  const ytxt = " ГОДА";
  const y2txt = " ГОД";
  const mtxt = " МЕСЯЦЕВ ";
  const qtxt = " КВАРТАЛ ";

  var code = "";
  var _period;
  var y = string(Year);

  _period = Period + 12;

  // значения _period 1-12 номер месяца, 13-16 кварталы I-IV
  if((_period == 13) or (AddItog and (_period == 3))) // 1 кв
    code = "1"+qtxt+y+ytxt;
  elif(AddItog and ((_period == 14) or (_period == 6)))
    code = "I ПОЛУГОДИЕ " + y + ytxt;
  elif(AddItog and ((_period == 15) or (_period == 9)))
    code = "9" + mtxt + y + ytxt;
  elif(AddItog and ((_period == 16) or (_period == 12)))
    code = y + y2txt;
  elif(AddItog and (_period > 0) and (_period < 12))
    code = string(_period) + mtxt + y + ytxt;
  elif((not AddItog) and (_period > 13) and (_period < 17))
    code = string(_period-12) + qtxt + y + ytxt;
  elif((not AddItog) and (_period > 0) and (_period < 13))
    code = StrUpr( MonName(_period) ) + " " + y + ytxt;
  end;

  return code;
end;

/**
 @brief Класс для создания отчётов АР_07_17_1 и АР_07_17_2
*/
PRIVATE CLASS ( DL_CReportTemplate ) Own_Bonds_Registers_Report_17( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, ForceFormatRep:INTEGER )
  var m_BegDate;
  var m_EndDate;
  var m_Year;
  var m_CurrStrNum;
  var m_StartStrNum;
  var m_DataSet;
  var m_DataSetPlacement;
  var m_DataSetBuy;
  var m_DataSetFIID;
  var m_DataExists;
  var m_DrawingData;
  var m_SheetNumber;
  var НОМЕР_ПЕРВОЙ_СТРОКИ = 13;

  PRIVATE VAR m_HeaderIndicator = "Обработка ц/б";

  /**
   @brief Инициализация переменных
  */
  PRIVATE MACRO InitVariables()
    m_BegDate = BeginDate;
    m_EndDate = EndDate;
    m_Year    = Year;
    m_CurrStrNum = НОМЕР_ПЕРВОЙ_СТРОКИ;
    m_StartStrNum = 0;
    m_DataSet = NULL;
    m_DataSetPlacement = NULL;
    m_DataSetBuy = NULL;
    m_DataSetFIID = NULL;
    m_DataExists = false;
    m_DrawingData = false;
  END;

  /**
   @brief Формула суммы ячеек
   @param[in] CellName Имя столбца
   @param[in] StartRow Номер первой строки диапазона
   @return    Формула EXCEL для формирования сумм по одной ц/б
  */
  PRIVATE MACRO FSUM(CellName:String, StartRow:integer)
    return F(FormulaSum() + "(" + CellName + string(StartRow) + ":" + CellName + string(m_CurrStrNum - 1) + ")");
  END;

  /**
   @brief Формула суммы ячеек для итогов 
   @param[in] CellName Имя столбца
   @return    Формула EXCEL для суммирования итогов по всем ц/б
  */
  macro FSUMITOG(CellName:string)
    if(m_SheetNumber == ReportKind_АР_07_17_1)
      return F(FormulaSUMIF()+"("+"H" + string(НОМЕР_ПЕРВОЙ_СТРОКИ) + ":" + "H" +MAXROWSHEET+";\"Итог\";" + CellName + string(НОМЕР_ПЕРВОЙ_СТРОКИ) + ":" + CellName + MAXROWSHEET + ")");
    else
      return F(FormulaSUMIF()+"("+"D" + string(НОМЕР_ПЕРВОЙ_СТРОКИ) + ":" + "D" +MAXROWSHEET+";\"Итог\";" + CellName + string(НОМЕР_ПЕРВОЙ_СТРОКИ) + ":" + CellName + MAXROWSHEET + ")");
    end;
  end;

  /**
   @brief Функция форматирования имени операциониста по требованиям РСХБ
   @return Имя операциониста
  */
  private macro Oper_rshb():string
    var fio = GetOperRecByID({oper}).Name;
    return ConvetFIO_Report(fio);
  end;

  /**
   @brief Переопределение базового метода для получения вида отчёта
   @return Доступен формат только в Excel
  */
  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  /**
   @brief Переопределение базового метода начала отчёта
   @param[in] NumCopy Число копий (по умолчанию = 1)
  */
  PRIVATE MACRO BeginReport(NumCopy:INTEGER)
    InitVariables();
  END;

  /**
   @brief Метод установки фильтров по колонкам
   @param[in] sheet наименование листа отчёта
   @param[in] range для каких колонок добавлять фильтр
  */
  MACRO SetOnAutoFilter(sheet, range)
    if( ExistsSheet( sheet ) )
      m_ObjTemplateXLS.SetAutoFilter(range, sheet);
    end;
  end;

  /**
   @brief Метод установки автоматической ширины для столбцов
  */
  macro SetAutoSize()
    m_ObjTemplateXLS.SetAutoFit("C", "АР-07-17-2");    
  end;

  /**
   @brief Найти дату последнего погашения купона/дату начала начисления процентов
   @param[in] EndDate На конец какого периода ведём поиск даты
   @return Искомая дата
  */
  MACRO GetDrawingDate(EndDate)
    var query =   " select t_DrawingDate "
                + "   from dfiwarnts_dbt "
                + "  where t_FIID = ? "
                + "    and t_IsPartial = CHR(0) "
                + "    and t_DrawingDate <= ? "
                + "  order by t_DrawingDate DESC";
      
    var cmd = DL_RSDCommand(query);
 
    cmd.AddParam(m_DataSetFIID.FIID);
    cmd.AddParam(EndDate);
    var DataSet = cmd.Execute();
    if(DataSet.moveNext())
      return date(DataSet.DrawingDate);
    else
      return date(m_DataSetFIID.BegPlacementDate);
    end;
  END;

  /**
   @brief Найти дату следующего погашения купона/дату погашения выпуска
   @param[in] StartDate Для какой даты ведём поиск следующего погашения
   @return Искомая дата
  */
  MACRO GetNextDrawingDate(StartDate)
    var query =   " select t_DrawingDate "
                + "   from dfiwarnts_dbt "
                + "  where t_FIID = ? "
                + "    and t_IsPartial = CHR(0) "
                + "    and t_DrawingDate >= ? "
                + "  order by t_DrawingDate ASC";
      
    var cmd = DL_RSDCommand(query);
 
    cmd.AddParam(m_DataSetFIID.FIID);
    cmd.AddParam(StartDate);
    var DataSet = cmd.Execute();
    if(DataSet.moveNext())
      return date(DataSet.DrawingDate);
    else
      return date(m_DataSetFIID.DrawingDate);
    end;
  END;

  /**
   @brief Получить процентную ставку купона и НКД на 1 единицу
   @param[in]  RateDate Дата на которую ищем информацию по купонам облигации
   @param[out] NKD В случае если передана переменная, возвращает расчётный НКД
   @return процентная ставка купона на дату
  */
  PRIVATE MACRO GetIncomeRateNKD(RateDate:date, NKD:@money)
    var rate = 0.0;

    var CalcNKDCmd = DL_RSDCommand("select RSI_RSB_FIInstr.CalcNKD_Ex(?, ?, 1, 1, 0) CalcNKD from dual");
    CalcNKDCmd.AddParam(m_DataSetFIID.FIID);
    CalcNKDCmd.AddParam(RateDate);
    var CalcNKDDS = CalcNKDCmd.Execute();
    if( (NKD != NULL) and (CalcNKDDS.MoveNext()))
      NKD = CalcNKDDS.CalcNKD;
    end;      
    var RateIncomeCmd = DL_RSDCommand("select RSI_RSB_FIInstr.FI_ReturnIncomeRate() as t_Rate from dual");
    var RateIncomeDS = RateIncomeCmd.Execute();
    if(RateIncomeDS.MoveNext())
      rate = round(RateIncomeDS.Rate, 2);
    end;

    return rate;
  END;

  /**
   @brief Заполнить информацию по выплаченным купонам в рамках сделки размещения
   @param[out] AP1_D37 Значение графы 36
   @param[out] AP1_D38 Значение графы 37
   @param[out] AP1_D39 Значение графы 38
  */
  PRIVATE MACRO GetDealCoupInfo(AP1_D37:@variant, AP1_D38:@string, AP1_D39:@string)
    AP1_D38 = "";
    AP1_D39 = "";
    var cmd = DL_RSDCommand("SELECT t_calcnkd, t_fixdate from downbondsregister_tmp where t_DrawingDate between ? and ? AND t_isbuy != chr(88) "+
                             " UNION ALL "+
                            " SELECT t_calcnkd, t_fixdate from downbondsregister_tmp where t_DrawingDate = ? AND t_isbuy = chr(88) "); 
    cmd.AddParam(m_DataSet.DeliveryDate);
    if(m_DataSetBuy)//Выплата купона при выкупе учитывается только в строке с указанием этого выкупа
      cmd.AddParam(m_DataSetBuy.DealDate);
      cmd.AddParam(m_DataSetBuy.DealDate);
    else
      cmd.AddParam(m_EndDate);
      cmd.AddParam(date(0,0,0));
    end;

    AP1_D37 = cmd.GetCount();
    var DataSet = cmd.Execute();
    while(DataSet.MoveNext())
      if(AP1_D38 != "")
        AP1_D38 = AP1_D38 + "+";
        AP1_D39 = AP1_D39 + "+";
      end;
      AP1_D38 = AP1_D38 + DataSet.calcnkd;
      AP1_D39 = AP1_D39 + DataSet.calcnkd + "*" + GetRateOnDate(  DataSet.fixdate, m_DataSetFIID.facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
    end;
    if(AP1_D38 != "")
      AP1_D38 = F("("+AP1_D38+")"+"*"+C_D10+string(m_CurrStrNum));
      AP1_D39 = F("("+AP1_D39+")"+"*"+C_D10+string(m_CurrStrNum));
    else
      AP1_D37 = "";
    end;
  END;

  /**
   @brief Получить счет по категории
   @param[in] FIID Идентификатор ЦБ 
   # GetParam - Категории для поиска счета
  */
  PRIVATE MACRO IsExistAccounts(fiid)
   var Query, cmd, DataSet, Categ, CatArr = "", i = 1;
   
   while( GetParm( i, Categ) )
     if(i==1)
       CatArr = "'" + Categ + "'";
     else
       CatArr = CatArr + "," + "'" + Categ + "'";
     end;
     Categ = NULL;
     i = i + 1;
   end;
  
   Query = "SELECT distinct accdoc.t_Account, "+
           "       case when accdoc.t_disablingdate = to_date('01010001','ddmmyyyy') "+
           "         then to_date('31129999','ddmmyyyy') "+
           "         else accdoc.t_disablingdate "+
           "       end as t_disablingdate "+
           "  FROM dmcaccdoc_dbt accdoc, dmccateg_dbt cat "+
           " WHERE cat.t_Code in(" + CatArr + ")"+
           "   AND accdoc.t_CatID = cat.t_ID "+
           "   AND accdoc.t_FIID = ?  "+
           "   ORDER BY t_disablingdate DESC"+
           "   FETCH FIRST 1 ROWS ONLY";

   cmd = DL_RSDCommand( Query );
   cmd.AddParam(fiid); 
   DataSet = cmd.Execute();

   if( DataSet.MoveNext )
      return DataSet.Account;
   end;

   return "";
  END;

  /**
   @brief Получить счет БУ по учету расходов
  */
  PRIVATE MACRO GetD50()
   var Query, cmd, DataSet;

   Query = "SELECT acc.t_account " +
           "  FROM dmcaccdoc_dbt acc, dmccateg_dbt mcc " +
           " WHERE     acc.t_CatID = mcc.t_ID " +
           "       AND mcc.t_code = '%Расход, ОЭБ' " +
           "       AND acc.t_iscommon = CHR (88) " +
           "       AND acc.t_templnum = ? " ;

   cmd = DL_RSDCommand( Query );
   cmd.AddParam(iif(m_DataSetFIID.t_facevaluefi == NATCUR, 1/*Шаблон для НацВалюты*/, 2/*Шаблон для ИнВалюты*/));
   DataSet = cmd.Execute();

   if( DataSet.MoveNext )
      return DataSet.Account;
   end;

   return "";
  END;

  /**
   @brief Заполнить информацию по счетам выпуска
   @param[in] FIID Идентификатор ЦБ 
   @param[out] AP1_D48 Значение графы БУ-1. Счет БУ по учету номинала
   @param[out] AP1_D49 Значение графы БУ-2. Счет БУ по учету купона
   @param[out] AP1_D50 Значение графы БУ-3. Счет БУ по учету расходов
   @param[out] AP1_D51 Значение графы БУ-4. Сумма процентных расходов по БУ за период
   @param[out] AP1_D52 Значение графы БУ-5. Сумма переоценки счета 52501 по БУ за период (доходы)
   @param[out] AP1_D53 Значение графы БУ-6. Сумма переоценки счета 52501 по БУ за период (расходы)
  */
  PRIVATE MACRO GetAccountInfo(FIID:integer, AP1_D48:@variant, AP1_D49:@variant, AP1_D50:@variant, AP1_D51:@variant, AP1_D52:@variant, AP1_D53:@variant)
  
    AP1_D48 = IsExistAccounts(FIID, "Размещ. ОЭБ", "Размещ., суборд.ОЭБ");
    AP1_D49 = IsExistAccounts(FIID, "Обяз%, ОЭБ");
    AP1_D50 = GetD50();
 
    var query =  " select nvl(sum(t_sum_natcur), 0) TrnSum "
               + "   from dacctrn_dbt "
               + "  where t_account_payer = ? " 
               + "  and   t_account_receiver = ? "
               + "  and   t_date_carry between ? and ? ";

    var cmd = DL_RSDCommand(query);

    cmd.AddParam(AP1_D50);
    cmd.AddParam(AP1_D49);
    cmd.AddParam(m_BegDate);
    cmd.AddParam(m_EndDate);
    var DataSet = cmd.Execute();

    if(DataSet.MoveNext())
      AP1_D51 = DataSet.TrnSum;
    else 
      AP1_D51 = 0;
    end;

    query =  " select nvl(sum(t_sum_natcur), 0) TrnSum "
               + "   from dacctrn_dbt "
               + "  where t_account_payer = ? " 
               + "  and   t_account_receiver LIKE '%70603%' "
               + "  and   t_date_carry between ? and ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(AP1_D49);
    cmd.AddParam(m_BegDate);
    cmd.AddParam(m_EndDate);
    DataSet = cmd.Execute();

    if(DataSet.MoveNext())
      AP1_D52 = DataSet.TrnSum;
    else 
      AP1_D52 = 0;
    end;

    query =  " select nvl(sum(t_sum_natcur), 0) TrnSum "
               + "   from dacctrn_dbt "
               + "  where t_account_receiver = ? " 
               + "  and   t_account_payer LIKE '%70608%' "
               + "  and   t_date_carry between ? and ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(AP1_D49);
    cmd.AddParam(m_BegDate);
    cmd.AddParam(m_EndDate);
    DataSet = cmd.Execute();

    if(DataSet.MoveNext())
      AP1_D53 = DataSet.TrnSum;
    else 
      AP1_D53 = 0;
    end;
  END;

  /**
   @brief Получить корректную информацию по дате выкупа для неверно перенесённых из интеграции сделок
   @param[in] DealID     ID сделки выкупа
   @param[in] DealAmount Количество выкупленных бумаг
  */
  PRIVATE MACRO GetCorrectBuyDate(DealID:integer, DealAmount:money)
    if(not DealID)
      return date(m_DataSetBuy.Maturity);
    end;
    var Query, cmd, DataSet;

    Query = "SELECT hst.t_changedate " +
            "  FROM downbondsregisterhst_dbt hst " +
            " WHERE     hst.t_DealID = ? " +
            "       AND hst.t_Amount = ? " +
            "       AND hst.t_isBuy != 'X' " +
            "       AND hst.t_ReSell = 'X' " ;

    cmd = DL_RSDCommand( Query );
    cmd.AddParam(DealID);
    cmd.AddParam(DealAmount);
    DataSet = cmd.Execute();

    if( DataSet.MoveNext )
      return date(DataSet.ChangeDate);
    end;
    //Если не нашли скорректированную информацию, выводим дату из информации по выкупу
    return date(m_DataSetBuy.Maturity);
  END;

  /**
   @brief Процедура вставки информации по купонам во временную таблицу
  */
  PRIVATE MACRO InsertCoupInfo()
    var drawperiod, incomerate, fixdate;
    var calcnkd = $0;
    //Очищаем временную таблицу
    RSDCommand("TRUNCATE TABLE DOWNBONDSREGISTER_TMP").execute();
    //отбираем все даты окончания учетных периодов до даты погашения последнего купона в текущем отченом периоде
    //это будут как даты погашения купонов, так же даты выкупов/погашений до даты окончания отченого периода
    var query =  " select q.EndDate, IsBuy "
               + "   from ((select t_DrawingDate as EndDate, chr(0) as IsBuy "
               + "            from dfiwarnts_dbt fiwarnts "
               + "           where fiwarnts.t_FIID = ? "
               + "             and fiwarnts.t_IsPartial = CHR(0) "
               + "             and fiwarnts.t_DrawingDate <= ? "
               + "             and fiwarnts.t_DrawingDate >= ?"
               + "         ) UNION "
               + "         (select DISTINCT lnk.t_CreateDate as EndDate, chr(88) as IsBuy "
               + "            from dpmwrtsum_dbt lot, ddl_tick_dbt tk, dpmwrtlnk_dbt lnk "
               + "           where lot.t_FIID = ? "
               + "             and lot.t_Portfolio = -1 "
               + "             and lot.t_Party = -1 "
               + "             and tk.t_DealID = lot.t_DealID "
               + "             and tk.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
               + "             and lnk.t_SaleID = lot.t_SumID "
               + "             and lnk.t_CreateDate <= ? "
               + "             and lnk.t_CreateDate >= ? "
               + "             and lnk.t_Kind != " + PMWRTLINK_KIND_SALE_BUYOUT
               + "         ) UNION "
               + "         (select DISTINCT hst.t_ChangeDate as EndDate, chr(88) as IsBuy "
               + "            from downbondsregisterhst_dbt hst "
               + "           where hst.t_FIID = ? "
               + "             and hst.t_ChangeDate <= ? "
               + "             and hst.t_ChangeDate >= ? "
               + "             and hst.t_isBuy = 'X' "
               + "             and hst.t_reSell != 'X' "
               + "         ) "
               + "        ) q"
               + "  order by q.EndDate ASC";

    var cmd = DL_RSDCommand(query);

    cmd.AddParam(m_DataSetFIID.FIID);
    cmd.AddParam(m_EndDate);
    cmd.AddParam(m_BegDate);
    cmd.AddParam(m_DataSetFIID.FIID);
    cmd.AddParam(m_EndDate);
    cmd.AddParam(m_BegDate);
    cmd.AddParam(m_DataSetFIID.FIID);
    cmd.AddParam(m_EndDate);
    cmd.AddParam(m_BegDate);
    var DataSet = cmd.Execute();

    while(DataSet.MoveNext())
      drawperiod = date(DataSet.EndDate) - GetDrawingDate(date(DataSet.EndDate)-1);
      incomerate = GetIncomeRateNKD(GetNextDrawingDate(DataSet.EndDate));
      GetIncomeRateNKD(DataSet.EndDate, @calcnkd);
      fixdate =  GetDateAfterWorkDays(date(DataSet.EndDate), -1);
      VAR ins = RSDCommand("INSERT INTO DOWNBONDSREGISTER_TMP (T_DRAWINGDATE, T_DRAWPERIOD, T_INCOMERATE, T_CALCNKD, T_FIXDATE, T_ISBUY) VALUES (?,?,?,?,?,"+IIF(DataSet.isBuy == SET_CHAR, "chr(88)", "chr(0)")+")");
      ins.addParam("", RSDBP_IN, date(DataSet.EndDate));
      ins.addParam("", RSDBP_IN, drawperiod);
      ins.addParam("", RSDBP_IN, incomerate);
      ins.addParam("", RSDBP_IN, calcnkd);
      ins.addParam("", RSDBP_IN, fixdate);
      ins.execute();
    end;
  END;

  /**
   @brief Является ли сделка первичным размещением
   @return true - является, false - не является
  */
  PRIVATE MACRO isDealPlacement()
    if( (m_DrawingData) and (m_DataSetFIID.t_facevaluefi == NATCUR))
      return false;
    elif((m_DataSet.DocKind == DL_AVRWRTOWN) and (m_DataSet.DeliveryDate < m_BegDate))
      return true;
    else
      return (m_DataSet.Placement == SET_CHAR);
    end;   
  END;

  /**
   @brief Сделка заключена в предыдушем периоде
   @return true - да, false - нет
  */
  PRIVATE MACRO isPrevDeal()
    return (m_DataSet.TypeDealInRegister == AP_1_TYPEDEAL_PREV);  
  END;

  /**
   @brief Сделка в дату первичного размещения
   @return true - да, false - нет
  */
  PRIVATE MACRO isFirstPlacement()
    return (m_DataSetFIID.BegPlacementDate == m_DataSet.DeliveryDate);  
  END;

  /**
   @brief Бумаги по сделке погашены на конец отчётного периода
   @return true - да, false - нет
  */
  PRIVATE MACRO isDealRedeem()
    return ((m_DataSet.lotamount_end == 0) or ((m_DataSetFIID.DrawingDate >= m_BegDate) and (m_DataSetFIID.DrawingDate < m_EndDate)));  
  END;

  /**
   @brief АР_07_17_1 графа 1 
   @return Наименование выпуска ц/б
  */
  PRIVATE MACRO AP1_D2():STRING
    return m_DataSetFIID.FIName;
  END;

  /**
   @brief АР_07_17_1 графа 2 
   @return ISIN
  */
  PRIVATE MACRO AP1_D3():STRING
    return m_DataSetFIID.ISIN;
  END;

  /**
   @brief АР_07_17_1 графа 3 
   @return Дата размещения
  */
  PRIVATE MACRO AP1_D4():DATE
    return date(m_DataSetFIID.BegPlacementDate);
  END;

  /**
   @brief АР_07_17_1 графа 4 
   @return Дата погашения
  */
  PRIVATE MACRO AP1_D5()
    if (date(m_DataSetFIID.DrawingDate) == date(31,12,2999) )
      return "";
    else
      return date(m_DataSetFIID.DrawingDate);
    end;
  END;

  /**
   @brief АР_07_17_1 графа 5 
   @return Дата выкупа
  */
  PRIVATE MACRO AP1_D6()
    if(m_DataSetBuy)
      return date(m_DataSetBuy.DealDate);
    else
      return "";
    end;
  END;

  /**
   @brief АР_07_17_1 графа 6
   @return Дата вторичного размещения
  */
  PRIVATE MACRO AP1_D7()
    if(isDealPlacement or isPrevDeal)
      return "";
    else
      return date(m_DataSet.DeliveryDate);
    end;
  END;

  /**
   @brief АР_07_17_1 графа 7
   @return Код валюты номинала
  */
  PRIVATE MACRO AP1_D8():STRING
    var code = ПолучитьКОдФИнИН(m_DataSetFIID.t_facevaluefi);
    if (code == "810") return "643";
    end;
    return code;
  END;

  /**
   @brief АР_07_17_1 графа 8
   @return Номинал в валюте
  */
  PRIVATE MACRO AP1_D9():MONEY
    return m_DataSetFIID.FaceValue;
  END;

  /**
   @brief АР_07_17_1 графа 9 
   @param[in] DrawingDate Дата погашения для заполнения информации по купонам
   @return Количество ц/б
  */
  PRIVATE MACRO AP1_D10(DrawingDate:date, is):INTEGER
    if(m_DataSetBuy)
      return m_DataSetBuy.BuyAmount;
    else
      return IIF(m_DataSet.isCorrected == SET_CHAR, m_DataSet.lotamount_end_corr, m_DataSet.lotamount_end);
    end;
  END;

  /**
   @brief АР_07_17_1 графа 9 для строк с купонной информацией 
   @param[in] DrawingDate Дата погашения для заполнения информации по купонам
   @param[in] isBuy Погашение купона при выкупе
   @return Количество ц/б
  */
  PRIVATE MACRO AP1_D10_Coup(DrawingDate:date, isBuy:bool):INTEGER
    var query, cmd;
    var Amount = $0;
    if(isBuy)
      query = "     select NVL(SUM(lnk.t_Amount), 0) as Amount " //Информация по сделкам выкупа за дату
            + "            from dpmwrtsum_dbt lot, ddl_tick_dbt tk, dpmwrtlnk_dbt lnk "
            + "           where lot.t_FIID = ? "
            + "             and lot.t_Portfolio = -1 "
            + "             and lot.t_Party = -1 "
            + "             and tk.t_DealID = lot.t_DealID "
            + "             and tk.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
            + "             and lnk.t_SaleID = lot.t_SumID "
            + "             and lnk.t_CreateDate = ? "
            + "             and lnk.t_Kind != " + PMWRTLINK_KIND_SALE_BUYOUT
            + " UNION "                                        
            + "     select NVL(SUM(hst.t_Amount), 0) as Amount " //Скорректированная информация по неверно заведённым размещениям
            + "             from downbondsregisterhst_dbt hst "
            + "            where hst.t_FIID = ?  "
            + "              and hst.t_isBuy = 'X'    "
            + "              and hst.t_reSell != 'X' "
            + "              and hst.t_ChangeDate = ? ";
      cmd = DL_RSDCommand(query);
 
      cmd.AddParam(m_DataSetFIID.FIID);
      cmd.AddParam(DrawingDate);
      cmd.AddParam(m_DataSetFIID.FIID);
      cmd.AddParam(DrawingDate);
    else
      query = " select NVL (SUM(lot.t_Amount), 0) as Amount " //Остатки на лотах сделок с собственными облигациями
            + "   from v_scwrthistex lot "
            + "  where lot.t_FIID = ? "
            + "    and lot.t_State = " + PM_WRTSUM_PLACE_OWN
            + "    and lot.t_Amount > 0 "
            + "    and lot.t_Date < ? "
            + "    and lot.t_Instance = (select MAX(l.t_Instance) "
            + "                            from v_scwrthistex l "
            + "                           where l.t_SumID = lot.t_SumID "
            + "                             and l.t_ChangeDate < ? "
            + "                         ) "
            + " UNION "
            + "     select NVL(SUM(hst.t_Amount), 0) as Amount " //Скорректированная информация по неверно заведённым размещениям
            + "             from downbondsregisterhst_dbt hst "
            + "            where hst.t_FIID = ?  "
            + "              and hst.t_isBuy != 'X'   "
            + "              and hst.t_reSell != 'X'  "
            + "              and hst.t_ChangeDate < ? "
            + "    and hst.t_ChangeDate = (select MAX(l.t_ChangeDate) "
            + "                              from downbondsregisterhst_dbt l "
            + "                             where l.t_DealID = hst.t_DealID "
            + "                               and l.t_ChangeDate < ? "
            + "                           ) ";
      cmd = DL_RSDCommand(query);
 
      cmd.AddParam(m_DataSetFIID.FIID);
      cmd.AddParam(DrawingDate);
      cmd.AddParam(DrawingDate);
      cmd.AddParam(m_DataSetFIID.FIID);
      cmd.AddParam(DrawingDate);
      cmd.AddParam(DrawingDate);
    end;  

    var DataSet = cmd.Execute();
    while(DataSet.moveNext())
      Amount = Amount + DataSet.Amount;
    end;
    return Amount;
  END;

  /**
   @brief АР_07_17_1 графа 10
   @return База для расчёта НКД
  */
  PRIVATE MACRO AP1_D11():INTEGER
    var fw = TRecHandler("fiwarnts.dbt");
    var avr = TRecHandler("avoiriss.dbt");
    var DaysInYear = 0, DaysInCoupon = 0;
    fw.Clear();
    ПолучитьФинИн(m_DataSetFIID.FIID, null, avr);
    ПолучитьПараметрыБазисаРасчетаКупона(avr.rec.NKDBase_Kind, fw.rec, m_EndDate, DaysInYear, DaysInCoupon);
    return DaysInYear;
  END;

  /**
   @brief АР_07_17_1 графа 11
   @return Процентные расходы
  */
  PRIVATE MACRO AP1_D12()
    return F(FormulaSum() + "(" +C_D36+string(m_CurrStrNum)+";"+C_D39+string(m_CurrStrNum)+")-"+FormulaSum()+"("+C_D20+string(m_CurrStrNum)+";"+ C_D28+string(m_CurrStrNum))+")";
  END;

  /**
   @brief АР_07_17_1 графа 12
   @return Дата последней выплаты купона/начала начисления процентов
  */
  PRIVATE MACRO AP1_D13()
    var DrawingDate = date(0,0,0);
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;
    DrawingDate = GetDrawingDate(m_DataSet.DeliveryDate);

    return DrawingDate;  
  END;

  /**
   @brief АР_07_17_1 графа 13
   @return Дата размещения (вторичного размещения)
  */
  PRIVATE MACRO AP1_D14()
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;
    return date(m_DataSet.DeliveryDate)
  END;

  /**
   @brief АР_07_17_1 графа 14
   @return Пероид расчёта купона
  */
  PRIVATE MACRO AP1_D15()
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;
    return F(C_D14+string(m_CurrStrNum)+"-"+C_D13+string(m_CurrStrNum));
  END;

  /**
   @brief АР_07_17_1 графа 15
   @return Размер купона, % годовых
  */
  PRIVATE MACRO AP1_D16()
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;

    return GetIncomeRateNKD(GetNextDrawingDate(AP1_D13+1));
  END; 

  /**
   @brief АР_07_17_1 графа 16
   @return Формула для НКД на одну шт. за дату размещения 
  */
  PRIVATE MACRO AP1_D17()
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D9+string(m_CurrStrNum)+"*"+C_D16+string(m_CurrStrNum)+"%/"+C_D11+string(m_CurrStrNum)+"*"+C_D15+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 17
   @return Курс ЦБ РФ на дату размещения
  */
  PRIVATE MACRO AP1_D18()
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;
    var CourceDate = AP1_D14;
    return GetRateOnDate( CourceDate, m_DataSetFIID.t_facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_1 графа 18
   @return Купон, уменьшающий расходы в валюте номинала 
  */
  PRIVATE MACRO AP1_D19()
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D10+string(m_CurrStrNum)+"*"+C_D17+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа 19
   @return Купон, уменьшающий расходы в рублях  
  */
  PRIVATE MACRO AP1_D20()
    if(isPrevDeal or isFirstPlacement)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D18+string(m_CurrStrNum)+"*"+C_D19+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа 20
   @return Дата последней выплаты купона/начала начисления процентов
  */
  PRIVATE MACRO AP1_D21()
    var DrawingDate = date(0,0,0);
    if(not isPrevDeal)
      return "";
    end;
    DrawingDate = GetDrawingDate(m_BegDate-1);

    return DrawingDate;  
  END;

  /**
   @brief АР_07_17_1 графа 21
   @return Дата окончания начисления процентов
  */
  PRIVATE MACRO AP1_D22()
    if(not isPrevDeal)
      return "";
    end;
    return date(m_BegDate-1)
  END;

  /**
   @brief АР_07_17_1 графа 22
   @return Пероид расчёта купона
  */
  PRIVATE MACRO AP1_D23()
    if(not isPrevDeal)
      return "";
    end;
    return F(C_D22+string(m_CurrStrNum)+"-"+C_D21+string(m_CurrStrNum));
  END;

  /**
   @brief АР_07_17_1 графа 23
   @return Размер купона, % годовых
  */
  PRIVATE MACRO AP1_D24()
    if(not isPrevDeal)
      return "";
    end;
    return GetIncomeRateNKD(GetNextDrawingDate(AP1_D21+1));
  END; 

  /**
   @brief АР_07_17_1 графа 24
   @return Формула для НКД на одну шт. на последний день предыдущего периода
  */
  PRIVATE MACRO AP1_D25()
    if(not isPrevDeal)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D9+string(m_CurrStrNum)+"*"+C_D24+string(m_CurrStrNum)+"%/"+C_D11+string(m_CurrStrNum)+"*"+C_D23+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 25
   @return Курс ЦБ РФ на последний день предыдущего периода
  */
  PRIVATE MACRO AP1_D26()
    if(not isPrevDeal)
      return "";
    end;
    var CourceDate = AP1_D22;
    return GetRateOnDate( CourceDate, m_DataSetFIID.t_facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_1 графа 26
   @return Купон, уменьшающий расходы в валюте номинала 
  */
  PRIVATE MACRO AP1_D27()
    if(not isPrevDeal)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D10+string(m_CurrStrNum)+"*"+C_D25+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа 27
   @return Купон, уменьшающий расходы в рублях  
  */
  PRIVATE MACRO AP1_D28()
    if(not isPrevDeal)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D27+string(m_CurrStrNum)+"*"+C_D26+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа 28
   @return Дата последней выплаты купона/начала начисления процентов
  */
  PRIVATE MACRO AP1_D29()
    var DrawingDate = date(0,0,0);
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    DrawingDate = GetDrawingDate(m_EndDate);

    return DrawingDate; 
  END;

  /**
   @brief АР_07_17_1 графа 29
   @return Дата окончания отчётного периода
  */
  PRIVATE MACRO AP1_D30()
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    return date(m_EndDate)
  END;

  /**
   @brief АР_07_17_1 графа 30
   @return Пероид расчёта купона
  */
  PRIVATE MACRO AP1_D31()
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    return F(C_D30+string(m_CurrStrNum)+"-"+C_D29+string(m_CurrStrNum));
  END;

  /**
   @brief АР_07_17_1 графа 31
   @return Размер купона, % годовых
  */
  PRIVATE MACRO AP1_D32()
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    return GetIncomeRateNKD(GetNextDrawingDate(AP1_D29+1));
  END; 

  /**
   @brief АР_07_17_1 графа 32
   @return Формула для НКД на одну шт. на последний день предыдущего периода
  */
  PRIVATE MACRO AP1_D33()
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D9+string(m_CurrStrNum)+"*"+C_D32+string(m_CurrStrNum)+"%/"+C_D11+string(m_CurrStrNum)+"*"+C_D31+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 33
   @return Курс ЦБ РФ на последний день предыдущего периода
  */
  PRIVATE MACRO AP1_D34()
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    var CourceDate = AP1_D30;
    return GetRateOnDate( CourceDate, m_DataSetFIID.t_facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_1 графа 34
   @return Купон, уменьшающий расходы в валюте номинала 
  */
  PRIVATE MACRO AP1_D35()
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D10+string(m_CurrStrNum)+"*"+C_D33+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа 35
   @return Купон, уменьшающий расходы в рублях  
  */
  PRIVATE MACRO AP1_D36()
    if(m_DataSetBuy or isDealRedeem)
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D35+string(m_CurrStrNum)+"*"+C_D34+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа Куп-4
   @return Формула для НКД на одну шт. за дату размещения 
  */
  PRIVATE MACRO AP1_D43()
    var Formula = FormulaROUND+"("+C_D9+string(m_CurrStrNum)+"*"+C_D42+string(m_CurrStrNum)+"%/"+C_D11+string(m_CurrStrNum)+"*"+C_D41+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа Куп-7
   @return Купон, выплаченный Банком при погашении купонов в отчетном периоде в валюте номинала
  */
  PRIVATE MACRO AP1_D45()
    return GetRateOnDate( date(m_DataSet.FixDate), m_DataSetFIID.t_facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_1 графа Куп-7
   @return Купон, выплаченный Банком при погашении купонов в отчетном периоде в валюте номинала
  */
  PRIVATE MACRO AP1_D46()
    var Formula = FormulaROUND+"("+C_D43+string(m_CurrStrNum)+"*"+C_D10+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа Куп-8
   @return Купон, выплаченный Банком при погашении купонов в отчетном периоде в рублях
  */
  PRIVATE MACRO AP1_D47()
    var Formula = FormulaROUND+"("+C_D46+string(m_CurrStrNum)+"*"+C_D45+string(m_CurrStrNum)+";2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_1 графа К-1
   @return Контроль
  */
  PRIVATE MACRO AP1_D54()
    return F(FormulaSum() + "(" +C_D12+string(m_CurrStrNum)+";"+C_D52+string(m_CurrStrNum)+")-"+FormulaSum()+"("+C_D51+string(m_CurrStrNum)+";"+ C_D53+string(m_CurrStrNum))+")";
  END;

  /**
   @brief Определение диапазона ячеек основной таблицы отчёта 
  */
  PRIVATE MACRO RegisterTable_АР_07_17_1()
    RegisterTable(   "N1_TableData", "N1_TableHeader",
                     "N1_D1", "N1_D2", "N1_D3", "N1_D4", "N1_D5", "N1_D6", "N1_D7", "N1_D8", "N1_D9", "N1_D10",
                     "N1_D11", "N1_D12", "N1_D13", "N1_D14", "N1_D15", "N1_D16", "N1_D17", "N1_D18", "N1_D19", "N1_D20",
                     "N1_D21", "N1_D22", "N1_D23", "N1_D24", "N1_D25", "N1_D26", "N1_D27", "N1_D28", "N1_D29", "N1_D30",
                     "N1_D31", "N1_D32", "N1_D33", "N1_D34", "N1_D35", "N1_D36", "N1_D37", "N1_D38", "N1_D39", "N1_D40",
                     "N1_D41", "N1_D42", "N1_D43", "N1_D44", "N1_D45", "N1_D46", "N1_D47", "N1_D48", "N1_D49", "N1_D50",
                     "N1_D51", "N1_D52", "N1_D53", "N1_D54", "N1_D55"
                 );
  END;

  /**
   @brief Напечатать заголовок отчёта
  */
  PRIVATE MACRO PrintReportHead_АР_07_17_1()
    PrintFormatString( NULL,
                       "N1_H1", Year,
                       "N1_H2", GetPeriodCode(),
                       "N1_H3", 0,
                       "N1_H4", "АР-07-17-1",
                       "N1_H5", "997950001",
                       "N1_H6", "Банк",
                       "N1_H7", 1,
                       "N1_H8", GetPeriodTxt(),
                       "N1_H9", $0,
                       "N1_H10", $0,
                       "N1_H11", $0,
                       "N1_H12", $0,
                       "N1_H13", $0,
                       "N1_H14", $0,
                       "N1_H16", $0,
                       "N1_H17", $0,
                       "N1_H18", Oper_rshb()
                     );
  END;

  /**
   @brief Напечатать стоку таблицы
  */
  PRIVATE MACRO PrintTableLine_АР_07_17_1(D1, D2, D3, D4, D5, D6, D7, D8, D9, D10, D11, D12, D13, D14, D15, D16, D17, D18, D19, D20, D21, D22, D23, D24, D25, D26, D27, D28, D29, D30,
                                          D31, D32, D33, D34, D35, D36, D37, D38, D39, D40, D41, D42, D43, D44, D45, D46, D47, D48, D49, D50, D51, D52, D53, D54, D55)
    PrintTableLine( "N1_D1", D1, NULL, "N1_D2", D2, NULL, "N1_D3", D3, NULL,
                    "N1_D4", D4, NULL, "N1_D5", D5, NULL,
                    "N1_D6", D6, NULL, "N1_D7", D7, NULL,
                    "N1_D8", D8, NULL, "N1_D9", D9, NULL,
                    "N1_D10", D10, NULL, "N1_D11", D11, NULL,
                    "N1_D12", D12, NULL, "N1_D13", D13, NULL,
                    "N1_D14", D14, NULL, "N1_D15", D15, NULL,
                    "N1_D16", D16, NULL, "N1_D17", D17, NULL,
                    "N1_D18", D18, NULL, "N1_D19", D19, NULL,
                    "N1_D20", D20, NULL, "N1_D21", D21, NULL,
                    "N1_D22", D22, NULL, "N1_D23", D23, NULL,
                    "N1_D24", D24, NULL, "N1_D25", D25, NULL,
                    "N1_D26", D26, NULL, "N1_D27", D27, NULL,
                    "N1_D28", D28, NULL, "N1_D29", D29, NULL,
                    "N1_D30", D30, NULL, "N1_D31", D31, NULL,
                    "N1_D32", D32, NULL, "N1_D33", D33, NULL,
                    "N1_D34", D34, NULL, "N1_D35", D35, NULL,
                    "N1_D36", D36, NULL, "N1_D37", D37, NULL,
                    "N1_D38", D38, NULL, "N1_D39", D39, NULL,
                    "N1_D40", D40, NULL, "N1_D41", D41, NULL,
                    "N1_D42", D42, NULL, "N1_D43", D43, NULL,
                    "N1_D44", D44, NULL, "N1_D45", D45, NULL,
                    "N1_D46", D46, NULL, "N1_D47", D47, NULL,
                    "N1_D48", D48, NULL, "N1_D49", D49, NULL,
                    "N1_D50", D50, NULL, "N1_D51", D51, NULL,
                    "N1_D52", D52, NULL, "N1_D53", D53, NULL,
                    "N1_D54", D54, NULL, "N1_D55", D55, NULL
                  );
    m_CurrStrNum = m_CurrStrNum + 1;
  END;

  /**
   @brief Метод печати итоговых строк по ц/б для регистра АР_07_17_1
   @param[in] FIName Наименование выпуска ц/б
   @param[in] ISIN   ISIN ц/б
  */
  MACRO PrintItogsFIIDLine_АР_07_17_1(AP1_D48, AP1_D49, AP1_D50, AP1_D51, AP1_D52, AP1_D53)
    this.SetCurrentLineFont( 7, true, true );
    this.SetCellFont("N1_D1", 10, true, false, null, RGB(0,0,255), RGB(217,217,217) );
    this.SetCellAlignment(NULL, ALIGN_CENTER); 
    PrintTableLine_АР_07_17_1("N", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x",     
                                      "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x");
    this.SetCurrentLineFont( 12, true, true );
    this.SetCellFont("N1_D1", 10, true, false, null, RGB(0,0,0), RGB(255,255,255) );
    this.SetCellFont("N1_D2", 9, true, true );
    this.SetCellFont("N1_D3", 9, true, true );
    this.SetCellFont("N1_D4", 9, true, true );
    this.SetCellFont("N1_D8", 9, true, true );
    this.SetCellFont("N1_D46", 9, true, true );
    this.SetCellFont("N1_D47", 9, true, true );
    this.SetCellFont("N1_D48", 8, false, false );
    this.SetCellFont("N1_D49", 8, false, false );
    this.SetCellFont("N1_D50", 8, false, false );

    PrintTableLine_АР_07_17_1("", AP1_D2, AP1_D3, "", "", "", "", "Итог", "", "", "", FSUM(C_D12, m_StartStrNum), "", "", "", "", "", "", "", FSUM(C_D20, m_StartStrNum), "", "", 
                              "", "", "", "", "", FSUM(C_D28, m_StartStrNum), "", "", "", "", "", "", "", FSUM(C_D36, m_StartStrNum), "", "", FSUM(C_D39, m_StartStrNum), "", "",             
                              "", "", "", "", FSUM(C_D46, m_StartStrNum), FSUM(C_D47, m_StartStrNum), AP1_D48, AP1_D49, AP1_D50, AP1_D51, AP1_D52, AP1_D53, AP1_D54, "" );             
  END;

  /**
   @brief Метод печати итогов по регистру АР_07_17_1  
  */
  PRIVATE MACRO PrintItogs_АР_07_17_1()
    PrintFormatString("",
                      "N1_H9",  FSUMITOG(C_D12),
                      "N1_H10", FSUMITOG(C_D20),
                      "N1_H11", FSUMITOG(C_D28),
                      "N1_H12", FSUMITOG(C_D36),
                      "N1_H13", FSUMITOG(C_D39),
                      "N1_H14", FSUMITOG(C_D51),
                      "N1_H15", FSUMITOG(C_D52),
                      "N1_H16", FSUMITOG(C_D53),
                      "N1_H17", FSUMITOG(C_D54)  
                     );
  END;

  /**
   @brief Печать регистра АР_07_17_1
   @param[in] IsEmpty Печать пустого отчёта

   Основная процедура печати регистра   
  */
  PRIVATE MACRO PrintReport_АР_07_17_1(IsEmpty)
    var query, cmd, querybuy, cmdbuy, i = 0;
    var cmdcoup, AP1_D37, AP1_D38, AP1_D39, AP1_D48, AP1_D49, AP1_D50, AP1_D51, AP1_D52, AP1_D53;
    var nextRec = true;
    var whereFiCond = "";

    m_CurrStrNum = 1; //НОМЕР_ПЕРВОЙ_СТРОКИ + 2;
    m_StartStrNum = 0;
    m_SheetNumber = ReportKind_АР_07_17_1;

    SetActiveSheet("АР-07-17-1");
    PrintReportHead_АР_07_17_1();
    PrintItogs_АР_07_17_1();    
    RegisterTable_АР_07_17_1();
    if( (AvrFIIDList != null) and (AvrFIIDList.Size > 0) )
      whereFiCond = " AND  fi.t_FIID IN ("; 
      while (i < AvrFIIDList.Size)
        if(i != 0)
          whereFiCond = whereFiCond + ", ";
        end;
        whereFiCond = whereFiCond + AvrFIIDList[i].FIID;
        i = i + 1;
      end;
      whereFiCond = whereFiCond + ")";
    end;
    i = 1;
    //Информация о подходящих под критерии ц/б
    var FIID_QUERY =  " SELECT fi.t_fiid, fi.t_name finame, avoiriss.t_isin, fi.t_facevaluefi, avoiriss.t_begplacementdate, " +
	                  "         CASE WHEN  fi.t_drawingdate =  to_date('01.01.0001', 'dd.mm.yyyy') THEN  to_date('31.12.9999', 'dd.mm.yyyy') ELSE fi.t_drawingdate END as t_drawingdate, " +
                      "        RSB_FIInstr.FI_GetNominalOnDate(fi.t_FIID, ?) as FaceValue, tickPl.t_PlacementDate " +
                      "   FROM dfininstr_dbt fi, davoiriss_dbt avoiriss, " +
                      "        (select min(rq.t_FactDate) as t_PlacementDate, qFI.t_FIID " +
                      "         from ddlrq_dbt rq, ddl_tick_dbt tkPl, dfininstr_dbt qFI" +
                      "         where rq.t_DocKind (+) = "+DL_SECUROWN+
                      "           AND rq.t_Type   (+) = " + string(DLRQ_TYPE_DELIVERY) +
                      "           AND rq.t_FIID   (+) = qFI.t_FIID" +
                      "           AND tkPl.t_DealID (+) = rq.t_DocID" +
                      "           AND rsb_secur.IsSale(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tkPl.t_DealType (+), tkPl.t_BofficeKind (+)))) = 1"
                      "           AND tkPl.t_Placement (+) = '" + string(SET_CHAR) + "'" +
                      "         group by qFI.t_FIID" +
                      "        ) tickPl" +
                      "  WHERE fi.t_Issuer = ? " +
                      "    AND (fi.t_DrawingDate > ? OR fi.t_DrawingDate = to_date('01.01.0001', 'dd.mm.yyyy')) " +
                      "    AND RSI_RSB_FIInstr.FI_AvrKindsGetRoot( 2, fi.t_AvoirKind ) = ? " +
                      "    AND RSB_FIINSTR.FI_IsCouponAvoiriss(fi.t_FIID) = 1 " +
                      "    AND avoiriss.t_FIID = fi.t_FIID " +                          
                      "    AND tickPl.t_FIID = fi.t_FIID " + whereFiCond +
                      "    AND " +
                      "       ( " +
                      "          CASE " +
                      "          WHEN avoiriss.t_BegPlacementDate < tickPl.t_PlacementDate and avoiriss.t_BegPlacementDate <> to_date('01.01.0001', 'dd.mm.yyyy') " +
                      "          THEN avoiriss.t_BegPlacementDate " +
                      "          WHEN tickPl.t_PlacementDate <> to_date('01.01.0001', 'dd.mm.yyyy')"
                      "          THEN tickPl.t_PlacementDate " +
                      "          ELSE avoiriss.t_BegPlacementDate " +
                      "          END " +
                      "       ) < ? ";
    var FIID_CMD = DL_RSDCommand(FIID_QUERY);
    FIID_CMD.AddParam(m_EndDate);
    FIID_CMD.AddParam({OurBank});
    FIID_CMD.AddParam(m_BegDate);
    FIID_CMD.AddParam(AVOIRISSKIND_BOND);
    FIID_CMD.AddParam(m_EndDate);
    var FIID_Count = FIID_CMD.GetCount();
    if (FIID_Count > 0)
      m_ProgressIndicator.Start(FIID_Count, m_HeaderIndicator, m_HeaderIndicator);
    end;
    m_DataSetFIID = FIID_CMD.Execute();
    while (m_DataSetFIID.MoveNext())
      m_StartStrNum = m_CurrStrNum;
      m_DataExists = false;
      AP1_D51 = null;
      m_ProgressIndicator.Update(i, FIID_Count, m_HeaderIndicator);
      InsertCoupInfo();
      //Сделки, заключённые в предыдущем периоде
      query =  "   select * from( "
               + ""
               + " select tk.t_placement, tk.t_DealCode, tk.t_DealID, tk.t_dealdate, rq.t_DocKind, leg.t_Price, leg.t_RelativePrice, "
               + "        nvl((select 'X' from downbondsregisterhst_dbt corrhst1 where corrhst1.t_DealID = tk.t_DealID and corrhst1.t_ReSell != 'X' FETCH FIRST 1 ROWS ONLY),chr(0)) isCorrected, "
               + "        RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) as DealIsBuy, "
               + "        rq.t_Amount as DealAmount, rq.t_FactDate DeliveryDate, " + AP_1_TYPEDEAL_PREV + " as TypeDealInRegister, "
               + "        (select lothist_beg.t_Amount from v_scwrthistex lothist_beg where lothist_beg.t_SumID = lot.t_SumID "
               + "            and lothist_beg.t_Instance = (select MAX(l.t_Instance) "
               + "                                            from v_scwrthistex l "
               + "                                           where l.t_SumID = lothist_beg.t_SumID "
               + "                                             and l.t_ChangeDate <= ? ))  as lotamount_beg, " 
               + "        (select lothist_end.t_Amount from v_scwrthistex lothist_end where lothist_end.t_SumID = lot.t_SumID "
               + "            and lothist_end.t_Instance = (select MAX(l.t_Instance) "
               + "                                            from v_scwrthistex l "
               + "                                           where l.t_SumID = lothist_end.t_SumID "
               + "                                             and l.t_ChangeDate <= least(?, ?) ))  as lotamount_end, " 
               + "        nvl((select corrhst2.t_Amount from downbondsregisterhst_dbt corrhst2 where corrhst2.t_DealID = tk.t_DealID "
               + "            and corrhst2.t_isBuy != 'X'   "
               + "            and corrhst2.t_reSell != 'X' "
               + "            and corrhst2.t_ChangeDate = (select MAX(l.t_ChangeDate) "
               + "                                            from downbondsregisterhst_dbt l "
               + "                                           where l.t_DealID = corrhst2.t_DealID "
               + "                                             and l.t_ChangeDate <= least(?, ?) )),0) as lotamount_end_corr "                     
               + "   from ddlrq_dbt rq, ddl_leg_dbt leg, ddl_tick_dbt tk, dpmwrtsum_dbt lot  "
               + "  where rq.t_DocKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
               + "    and rq.t_FactDate < ? "
               + "    and rq.t_FactDate >= ? "
               + "    and rq.t_Type = " + DLRQ_TYPE_DELIVERY
               + "    and RSB_FIInstr.FI_IsCouponAvoiriss(rq.t_FIID) != 0 "
               + "    and lot.t_DealID = rq.t_DocID "
               + "    and tk.t_DealID = rq.t_DocID "
               + "    and leg.t_DealID = rq.t_DocID "
               + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
               + "    and leg.t_LegID = 0 "
               + "    and rq.t_FIID   = ?  "
               + "    and RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 ) subq "
               + ""
               + "    where subq.lotamount_beg != 0 order by subq.t_dealdate" ;

      cmd = DL_RSDCommand(query); 
      
      cmd.AddParam(m_BegDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(date(m_DataSetFIID.DrawingDate)-1);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(date(m_DataSetFIID.DrawingDate)-1);
      cmd.AddParam(m_BegDate);
      cmd.AddParam(m_DataSetFIID.BegPlacementDate);
      cmd.AddParam(m_DataSetFIID.FIID);
      m_DataSet = cmd.Execute();
      while(m_DataSet.MoveNext())
        //Ведётся поиск сделок выкупа. Если на конец периода есть не выкупленный остаток, формируем ещё одну строку.
        if(m_DataSet.isCorrected == SET_CHAR) //Скорректированные сделки размещения
          querybuy = " select ? as Price, ? as RelativePrice, hst.t_ChangeDate as DealDate, "
                   + "    RSB_FIInstr.FI_GetNominalOnDate(?, hst.t_ChangeDate) FaceValue, hst.t_Amount as BuyAmount "
                   + "   from downbondsregisterhst_dbt hst  "
                   + "  WHERE hst.t_DealID = ? "
                   + "    and hst.t_isBuy = 'X' "
                   + "    and hst.t_reSell != 'X' "
                   + "    and hst.t_ChangeDate between ? AND ? ";
      
          cmdbuy = DL_RSDCommand(querybuy);
          cmdbuy.AddParam(m_DataSet.Price);
          cmdbuy.AddParam(m_DataSet.RelativePrice);
          cmdbuy.AddParam(m_DataSetFIID.FIID);
          cmdbuy.AddParam(m_DataSet.DealID); 
          cmdbuy.AddParam(m_BegDate);
          cmdbuy.AddParam(m_EndDate);
        else //Стандартная обработка 
          querybuy = " select leg.t_Price, leg.t_RelativePrice, leg.t_maturity, lotbuy.t_Date as DealDate, "
                   + "    RSB_FIInstr.FI_GetNominalOnDate(?, leg.t_maturity) FaceValue, lnk.t_Amount as BuyAmount "
                   + "   from ddl_leg_dbt leg, dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lotbuy, dpmwrtsum_dbt lotsell  "
                   + "  WHERE lotsell.t_DealID = ? "
                   + "    and lnk.t_BuyID = lotsell.t_SumID "
                   + "    and lnk.t_Kind = " + PMWRTLINK_KIND_BUYOUT
                   + "    and lotbuy.t_SumID = lnk.t_SaleID "
                   + "    and lotbuy.t_Date between ? AND ? "
                   + "    and leg.t_DealID   = lotbuy.t_DealID "
                   + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
                   + "    and leg.t_LegID   = 0 " +
                   " ORDER BY leg.t_maturity  ";
      
          cmdbuy = DL_RSDCommand(querybuy);
          cmdbuy.AddParam(m_DataSetFIID.FIID); 
          cmdbuy.AddParam(m_DataSet.DealID);
          cmdbuy.AddParam(m_BegDate);
          cmdbuy.AddParam(m_EndDate);
        end;
        m_DataSetBuy = cmdbuy.Execute();
        while(m_DataSetBuy.moveNext())
          GetDealCoupInfo(@AP1_D37, @AP1_D38, @AP1_D39);
          PrintTableLine_АР_07_17_1("", AP1_D2, AP1_D3, AP1_D4, AP1_D5, AP1_D6, AP1_D7, AP1_D8, AP1_D9, AP1_D10, AP1_D11, AP1_D12, AP1_D13, AP1_D14, AP1_D15, AP1_D16, AP1_D17,
                                    AP1_D18, AP1_D19, AP1_D20, AP1_D21, AP1_D22, AP1_D23, AP1_D24, AP1_D25, AP1_D26, AP1_D27, AP1_D28, AP1_D29, AP1_D30, AP1_D31, AP1_D32, AP1_D33, AP1_D34, AP1_D35, AP1_D36,
                                    AP1_D37, AP1_D38, AP1_D39);
          m_DataExists = true;
        end;
        m_DataSetBuy = null;
        if((m_DataSet.lotamount_end != 0) and ((m_DataSet.isCorrected != SET_CHAR) or (m_DataSet.lotamount_end_corr != 0)))
          GetDealCoupInfo(@AP1_D37, @AP1_D38, @AP1_D39);
          PrintTableLine_АР_07_17_1("", AP1_D2, AP1_D3, AP1_D4, AP1_D5, AP1_D6, AP1_D7, AP1_D8, AP1_D9, AP1_D10, AP1_D11, AP1_D12, AP1_D13, AP1_D14, AP1_D15, AP1_D16, AP1_D17,
                                    AP1_D18, AP1_D19, AP1_D20, AP1_D21, AP1_D22, AP1_D23, AP1_D24, AP1_D25, AP1_D26, AP1_D27, AP1_D28, AP1_D29, AP1_D30, AP1_D31, AP1_D32, AP1_D33, AP1_D34, AP1_D35, AP1_D36,
                                    AP1_D37, AP1_D38, AP1_D39);
          m_DataExists = true;
        end;     
      end;
      if(m_DataExists)
        GetAccountInfo(m_DataSetFIID.FIID, @AP1_D48, @AP1_D49, @AP1_D50, @AP1_D51, @AP1_D52, @AP1_D53);  
      end;

      //Сделки заключённые в отчётном периоде
      query =   " select tk.t_placement, tk.t_DealCode, tk.t_DealID, tk.t_dealdate, rq.t_DocKind, leg.t_Price, leg.t_RelativePrice, "
               + "        nvl((select 'X' from downbondsregisterhst_dbt corrhst1 where corrhst1.t_DealID = tk.t_DealID and corrhst1.t_ReSell != 'X' FETCH FIRST 1 ROWS ONLY),chr(0)) isCorrected, "
               + "       RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) as DealIsBuy, "
               + "       rq.t_Amount as DealAmount, rq.t_FactDate DeliveryDate, " + AP_1_TYPEDEAL_CURRENT + " as TypeDealInRegister, "
               + "       (select lothist_end.t_Amount from v_scwrthistex lothist_end where lothist_end.t_SumID = lot.t_SumID "
               + "           and lothist_end.t_Instance = (select MAX(l.t_Instance) "
               + "                                           from v_scwrthistex l "
               + "                                          where l.t_SumID = lothist_end.t_SumID "
               + "                                            and l.t_ChangeDate <= least(?, ?) ))  as lotamount_end,  "
               + "        nvl((select corrhst2.t_Amount from downbondsregisterhst_dbt corrhst2 where corrhst2.t_DealID = tk.t_DealID "
               + "            and corrhst2.t_isBuy != 'X'   "
               + "            and corrhst2.t_reSell != 'X' "
               + "            and corrhst2.t_ChangeDate = (select MAX(l.t_ChangeDate) "
               + "                                            from downbondsregisterhst_dbt l "
               + "                                           where l.t_DealID = corrhst2.t_DealID "
               + "                                             and l.t_ChangeDate <= least(?, ?) )),0) as lotamount_end_corr "     
               + "   from ddlrq_dbt rq, ddl_leg_dbt leg, ddl_tick_dbt tk, dpmwrtsum_dbt lot "
               + "  where rq.t_DocKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
               + "    and rq.t_FactDate >= ? "
               + "    and rq.t_FactDate <= ? "
               + "    and rq.t_Type = " + DLRQ_TYPE_DELIVERY
               + "    and RSB_FIInstr.FI_IsCouponAvoiriss(rq.t_FIID) != 0 "
               + "    and lot.t_DealID = rq.t_DocID "
               + "    and tk.t_DealID = rq.t_DocID "
               + "    and leg.t_DealID = rq.t_DocID "
               + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
               + "    and leg.t_LegID = 0 "
               + "    and rq.t_FIID   = ?  "
               + "    and RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 "
               +"     order by tk.t_dealdate ";

      cmd = DL_RSDCommand(query); 

      cmd.AddParam(m_EndDate);
      cmd.AddParam(date(m_DataSetFIID.DrawingDate)-1);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(date(m_DataSetFIID.DrawingDate)-1);
      cmd.AddParam(m_BegDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_DataSetFIID.FIID);
      m_DataSet = cmd.Execute();
      while(m_DataSet.MoveNext())
        //Ведётся поиск сделок выкупа. Если на конец периода есть не выкупленный остаток, формируем ещё одну строку.
        if(m_DataSet.isCorrected == SET_CHAR) //Скорректированные сделки размещения
          querybuy = " select ? as Price, ? as RelativePrice, hst.t_ChangeDate as DealDate, "
                   + "    RSB_FIInstr.FI_GetNominalOnDate(?, hst.t_ChangeDate) FaceValue, hst.t_Amount as BuyAmount "
                   + "   from downbondsregisterhst_dbt hst  "
                   + "  WHERE hst.t_DealID = ? "
                   + "    and hst.t_isBuy = 'X' "
                   + "    and hst.t_reSell != 'X' "
                   + "    and hst.t_ChangeDate between ? AND ? ";
      
          cmdbuy = DL_RSDCommand(querybuy);
          cmdbuy.AddParam(m_DataSet.Price);
          cmdbuy.AddParam(m_DataSet.RelativePrice);
          cmdbuy.AddParam(m_DataSetFIID.FIID);
          cmdbuy.AddParam(m_DataSet.DealID); 
          cmdbuy.AddParam(m_BegDate);
          cmdbuy.AddParam(m_EndDate);
        else //Стандартная обработка
          querybuy = " select leg.t_Price, leg.t_RelativePrice, leg.t_maturity, lotbuy.t_Date as DealDate, "
                   + "    RSB_FIInstr.FI_GetNominalOnDate(?, leg.t_maturity) FaceValue, lnk.t_Amount as BuyAmount "
                   + "   from ddl_leg_dbt leg, dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lotbuy, dpmwrtsum_dbt lotsell  "
                   + "  WHERE lotsell.t_DealID = ? "
                   + "    and lnk.t_BuyID = lotsell.t_SumID "
                   + "    and lnk.t_Kind = " + PMWRTLINK_KIND_BUYOUT
                   + "    and lotbuy.t_SumID = lnk.t_SaleID "
                   + "    and lotbuy.t_Date between ? AND ? "
                   + "    and leg.t_DealID   = lotbuy.t_DealID "
                   + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
                   + "    and leg.t_LegID   = 0 " +
                   " ORDER BY leg.t_maturity  ";
      
          cmdbuy = DL_RSDCommand(querybuy);
          cmdbuy.AddParam(m_DataSetFIID.FIID); 
          cmdbuy.AddParam(m_DataSet.DealID);
          cmdbuy.AddParam(m_BegDate);
          cmdbuy.AddParam(m_EndDate);
        end;
        m_DataSetBuy = cmdbuy.Execute();
        while(m_DataSetBuy.moveNext())
          GetDealCoupInfo(@AP1_D37, @AP1_D38, @AP1_D39);
          PrintTableLine_АР_07_17_1("", AP1_D2, AP1_D3, AP1_D4, AP1_D5, AP1_D6, AP1_D7, AP1_D8, AP1_D9, AP1_D10, AP1_D11, AP1_D12, AP1_D13, AP1_D14, AP1_D15, AP1_D16, AP1_D17,
                                    AP1_D18, AP1_D19, AP1_D20, AP1_D21, AP1_D22, AP1_D23, AP1_D24, AP1_D25, AP1_D26, AP1_D27, AP1_D28, AP1_D29, AP1_D30, AP1_D31, AP1_D32, AP1_D33, AP1_D34, AP1_D35, AP1_D36,
                                    AP1_D37, AP1_D38, AP1_D39);
          m_DataExists = true;
        end;
        m_DataSetBuy = null;
        if((m_DataSet.lotamount_end != 0) and ((m_DataSet.isCorrected != SET_CHAR) or (m_DataSet.lotamount_end_corr != 0)))
          GetDealCoupInfo(@AP1_D37, @AP1_D38, @AP1_D39);
          PrintTableLine_АР_07_17_1("", AP1_D2, AP1_D3, AP1_D4, AP1_D5, AP1_D6, AP1_D7, AP1_D8, AP1_D9, AP1_D10, AP1_D11, AP1_D12, AP1_D13, AP1_D14, AP1_D15, AP1_D16, AP1_D17,
                                    AP1_D18, AP1_D19, AP1_D20, AP1_D21, AP1_D22, AP1_D23, AP1_D24, AP1_D25, AP1_D26, AP1_D27, AP1_D28, AP1_D29, AP1_D30, AP1_D31, AP1_D32, AP1_D33, AP1_D34, AP1_D35, AP1_D36,
                                    AP1_D37, AP1_D38, AP1_D39);
          m_DataExists = true;
        end;    
      end;
   
      if(m_DataExists and (AP1_D51 == null))
        GetAccountInfo(m_DataSetFIID.FIID, @AP1_D48, @AP1_D49, @AP1_D50, @AP1_D51, @AP1_D52, @AP1_D53);  
      end;

      if(m_DataExists)
        m_DrawingData = true;
        //Информация по купонам текущей облигации
        query =  "select * from downbondsregister_tmp ORDER BY t_drawingdate ASC";

        cmd = DL_RSDCommand(query); 

        m_DataSet = cmd.Execute();
        while(m_DataSet.MoveNext())
          this.SetCellFont("N1_D1", 10, true, false, null, RGB(0,0,255), RGB(217,217,217) );
          PrintTableLine_АР_07_17_1("N", AP1_D2, AP1_D3, "", "", "", "", AP1_D8, AP1_D9, AP1_D10_Coup(date(m_DataSet.DrawingDate), m_DataSet.isBuy == SET_CHAR), AP1_D11, AP1_D12, "", "", "", "", "",
                                    "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                                    "", "", "", date(m_DataSet.DrawingDate), m_DataSet.DrawPeriod, m_DataSet.IncomeRate, AP1_D43, date(m_DataSet.FixDate), AP1_D45, AP1_D46, AP1_D47);

        end;
        m_DrawingData = false;
      end;

      if( m_DataExists )
        PrintItogsFIIDLine_АР_07_17_1(AP1_D48, AP1_D49, AP1_D50, AP1_D51, AP1_D52, AP1_D53); 
      end;    
      i = i + 1;                   
    end;

    if (FIID_Count > 0)
      m_ProgressIndicator.Stop();
    end;
    if(m_CurrStrNum == 1) //НОМЕР_ПЕРВОЙ_СТРОКИ + 2
      PrintTableLine( "N1_D2", "ДАННЫХ НЕТ", null);
    end;

    EndTable();

    if(m_CurrStrNum > 1) //!= НОМЕР_ПЕРВОЙ_СТРОКИ
      SetOnAutoFilter("АР-07-17-1", "A14:BC14"); 
    end;   
  END;

  /**
   @brief АР_07_17_2 графа 1. Выпуск ц/б
  */
  PRIVATE MACRO AP2_D2()
    return m_DataSetFIID.FIName;
  END;

  /**
   @brief АР_07_17_2 графа 2. ISIN
  */
  PRIVATE MACRO AP2_D3()
    return m_DataSetFIID.ISIN;
  END;

  /**
   @brief АР_07_17_2 графа 3. Код валюты номинала
  */
  PRIVATE MACRO AP2_D4()
    return ПолучитьКОдФИнИН(m_DataSetFIID.facevaluefi, null, FICK_ISONUMBER);
  END;

  /**
   @brief АР_07_17_2 графа 4. Номинал в валюте
  */
  PRIVATE MACRO AP2_D5()
    return m_DataSetFIID.FaceValue;
  END;

  /**
   @brief АР_07_17_2 графа 5. Количество ц/б
  */
  PRIVATE MACRO AP2_D6()
    if(m_DataSetBuy)
      return m_DataSetBuy.AmountBuy;
    else
      return m_DataSet.DealAmount;
    end;
  END;

  /**
   @brief АР_07_17_2 графа 6. Дата размещения
  */
  PRIVATE MACRO AP2_D7()
    //DEF-62011. Shvetsov Y.A. При переносе из интеграции для бумаги выставили дату 17.12.2018, ОД требует в этом отчёте выводить 18 число. Пока захардкодим.
    if(m_DataSetFIID.ISIN == "RU000A0ZZY59") 
      return date(18,12,2018);
    elif(isDealPlacement)
      return date(m_DataSet.DealDate);
    else
      return date(m_DataSetFIID.BegPlacementDate);
    end;
  END;

  /**
   @brief АР_07_17_2 графа 7. Дата погашения по условиям выпуска
  */
  PRIVATE MACRO AP2_D8()
    if (date(m_DataSetFIID.DrawingDate) == date(31,12,2999) )
      return "";
    else
      return date(m_DataSetFIID.DrawingDate);
    end;
  END;

  /**
   @brief АР_07_17_2 графа 8. Курс ЦБ РФ на дату размещения
  */
  PRIVATE MACRO AP2_D9()
    var CourceDate = AP2_D7;
    return GetRateOnDate( CourceDate, m_DataSetFIID.facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_2 графа 9. Цена размещения, % от номинала
  */
  PRIVATE MACRO AP2_D10()
    var Cource, Price, RelativePrice, FaceValue;
    Cource = AP2_D9;
   
    if((not m_DataSetPlacement) or (isDealPlacement))
      RelativePrice = m_DataSet.RelativePrice;
      FaceValue = m_DataSetFIID.FaceValue;
      Price  = m_DataSet.Price; 
    else
      RelativePrice = m_DataSetPlacement.RelativePrice;
      FaceValue = m_DataSetPlacement.FaceValue;
      Price  = m_DataSetPlacement.Price; 
    end;

    if(RelativePrice == SET_CHAR)
      return Price;
    else
      return Price * 100.0 / (FaceValue * Cource);
    end;
  END;

  /**
   @brief АР_07_17_2 графа 10. Стоимость размещения
  */
  PRIVATE MACRO AP2_D11()
    var Formula = FormulaROUND+"("+C_D5+string(m_CurrStrNum)+"*"+C_D6+string(m_CurrStrNum)+"*"+C_D10+string(m_CurrStrNum)+"%;2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 11. Дата выкупа
  */
  PRIVATE MACRO AP2_D12()
    if(m_DataSetBuy)
      return date(GetCorrectBuyDate(m_DataSet.DealID, AP2_D6));
    elif( (m_DrawingData) and (isDealPlacement) )
      return date(m_DataSetFIID.DrawingDate);
    else
      return "";
    end;  
  END;

  /**
   @brief АР_07_17_2 графа 14. Курс ЦБ РФ на дату выкупа
  */
  PRIVATE MACRO AP2_D15()
    if( (isDealPlacement) and (not m_DrawingData) and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    end;
    var CourceDate = AP2_D12();
    return GetRateOnDate( CourceDate, m_DataSetFIID.facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_2 графа 12. Цена выкупа в % от номинала
  */
  PRIVATE MACRO AP2_D13()
    if(isDealPlacement and (m_DataSet.IsCorrected != SET_CHAR))
      return IIF(m_DrawingData, 100.0, "");
    end;

    var Cource = AP2_D15();

    if(m_DataSetBuy.RelativePrice == SET_CHAR)
      return m_DataSetBuy.Price;
    else
      return m_DataSetBuy.Price * 100.0 / (m_DataSetBuy.FaceValue * Cource);
    end;  
  END;

  /**
   @brief АР_07_17_2 графа 13. Стоимость выкупа
  */
  PRIVATE MACRO AP2_D14()
    if( (isDealPlacement) and (not m_DrawingData) and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D5+string(m_CurrStrNum)+"*"+C_D6+string(m_CurrStrNum)+"*"+C_D13+string(m_CurrStrNum)+"%;2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 15. Дата вторичного размещения
  */
  PRIVATE MACRO AP2_D16()
    if(isDealPlacement and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    end;
    return date(m_DataSet.DeliveryDate);
  END;

  /**
   @brief АР_07_17_2 графа 18. Курс ЦБ РФ на дату вторичного размещения
  */
  PRIVATE MACRO AP2_D19()
    if(isDealPlacement and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    end;
    var CourceDate = AP2_D16;
    return GetRateOnDate( CourceDate, m_DataSetFIID.t_facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_2 графа 16. Цена вторичного размещения %
  */
  PRIVATE MACRO AP2_D17()
    if(isDealPlacement and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    end;
    var Price = 0;
    var Cource = AP2_D19;
    if(m_DataSetBuy and (m_DataSet.IsCorrected == SET_CHAR))
      Price  = m_DataSetBuy.PriceSell;
    else
      Price = m_DataSet.Price;  
    end;
    if(m_DataSet.RelativePrice == SET_CHAR)
      return Price;
    else
      return Price * 100.0 / (m_DataSet.FaceValue * Cource);
    end;  
  END;

  /**
   @brief АР_07_17_2 графа 17. Цена вторичного размещения %
  */
  PRIVATE MACRO AP2_D18()
    if(isDealPlacement and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    end;
    var Formula = FormulaROUND+"("+C_D5+string(m_CurrStrNum)+"*"+C_D6+string(m_CurrStrNum)+"*"+C_D17+string(m_CurrStrNum)+"%;2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 19. Доходы от перепродажи ценных бумаг
  */
  PRIVATE MACRO AP2_D20()
    var Formula = "";
    if(isDealPlacement and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    elif (m_DrawingData)
      Formula = FormulaROUND+"("+FormulaIF+"(("+C_D11+string(m_CurrStrNum)+"-"+C_D14+string(m_CurrStrNum)+")"+">0;("+C_D11+string(m_CurrStrNum)+"-"+C_D14+string(m_CurrStrNum)+")"+";0);2)";
    else
      Formula = FormulaROUND+"("+FormulaIF+"(("+C_D18+string(m_CurrStrNum)+"-"+C_D14+string(m_CurrStrNum)+")"+">0;("+C_D18+string(m_CurrStrNum)+"-"+C_D14+string(m_CurrStrNum)+")"+";0);2)";
    end;

    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 20. Расходы от перепродажи ценных бумаг
  */
  PRIVATE MACRO AP2_D21()
    var Formula = "";
    if(isDealPlacement and (m_DataSet.IsCorrected != SET_CHAR))
      return "";
    elif (m_DrawingData)
      Formula = FormulaROUND+"("+FormulaIF+"(("+C_D11+string(m_CurrStrNum)+"-"+C_D14+string(m_CurrStrNum)+")"+"<0;("+C_D14+string(m_CurrStrNum)+"-"+C_D11+string(m_CurrStrNum)+")"+";0);2)";
    else
      Formula = FormulaROUND+"("+FormulaIF+"(("+C_D18+string(m_CurrStrNum)+"-"+C_D14+string(m_CurrStrNum)+")"+"<0;("+C_D14+string(m_CurrStrNum)+"-"+C_D18+string(m_CurrStrNum)+")"+";0);2)"; 
    end;

    return F(Formula); 
  END;

  /**
  @brief АР_07_17_2 графа 21. Доходы - курсовая разница по выкупленным облигациям 
  */
  PRIVATE MACRO AP2_D22()
    if((not m_DrawingData) or (m_DataSetFIID.t_facevaluefi == NATCUR))
      return "";
    end; 
    var Formula = FormulaROUND+"("+FormulaIF+"((("+C_D11+string(m_CurrStrNum)+"*"+C_D9+string(m_CurrStrNum)+")-("+C_D14+string(m_CurrStrNum)+"*"+C_D15+string(m_CurrStrNum)+"))>0;("+C_D11+string(m_CurrStrNum)+"*"+C_D9+string(m_CurrStrNum)+")-("+C_D14+string(m_CurrStrNum)+"*"+C_D15+string(m_CurrStrNum)+");0);2)";
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 22. Расходы - курсовая разница по выкупленным облигациям
  */
  PRIVATE MACRO AP2_D23()
    if((not m_DrawingData) or (m_DataSetFIID.t_facevaluefi == NATCUR))
      return "";
    end;
    var Formula = FormulaROUND+"("+FormulaIF+"((("+C_D11+string(m_CurrStrNum)+"*"+C_D9+string(m_CurrStrNum)+")-("+C_D14+string(m_CurrStrNum)+"*"+C_D15+string(m_CurrStrNum)+"))<0;("+C_D14+string(m_CurrStrNum)+"*"+C_D15+string(m_CurrStrNum)+")-("+C_D11+string(m_CurrStrNum)+"*"+C_D9+string(m_CurrStrNum)+");0);2)";    
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 23. Последний день отчётного периода
  */
  PRIVATE MACRO AP2_D24()
    if(m_DataSetFIID.t_facevaluefi == NATCUR)
      return "";
    end;
    return date(m_EndDate);
  END;

  /**
   @brief АР_07_17_2 графа 24. Курс ЦБ РФ на последний день отчётного периода
  */
  PRIVATE MACRO AP2_D25()
    if(m_DataSetFIID.t_facevaluefi == NATCUR)
      return "";
    end;
    var CourceDate = AP2_D24;
    return GetRateOnDate( CourceDate, m_DataSetFIID.facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_2 графа 25. Курс ЦБ РФ на последний день предыдущего периода
  */
  PRIVATE MACRO AP2_D26()
    if(m_DataSetFIID.t_facevaluefi == NATCUR)
      return "";
    end;
    var CourceDate = date(31,12,m_Year-1);
    return GetRateOnDate( CourceDate, m_DataSetFIID.facevaluefi, NATCUR, false, 7/*Курс ЦБ*/ );
  END;

  /**
   @brief АР_07_17_2 графа 26. Курсовая разница по непогашенным облигациям по состоянию на конец предыдущего периода
  */
  PRIVATE MACRO AP2_D27()
    if(m_DataSetFIID.t_facevaluefi == NATCUR)
      return "";
    elif( (AP2_D7 > m_BegDate) and (AP2_D7 < m_EndDate) )
      return 0;
    end;
    var Formula = "";
    Formula = "("+C_D9+string(m_CurrStrNum)+"-"+C_D26+string(m_CurrStrNum)+")*"+C_D11+string(m_CurrStrNum);
    return F(Formula); 
  END;

  /**
   @brief АР_07_17_2 графа 27. Курсовая разница по непогашенным облигациям по состоянию на конец текущего периода
  */
  PRIVATE MACRO AP2_D28()
    if(m_DataSetFIID.t_facevaluefi == NATCUR)
      return "";
    elif(m_DrawingData)
      return 0;
    end;
    var Formula = "";
    Formula = "("+C_D9+string(m_CurrStrNum)+"-"+C_D25+string(m_CurrStrNum)+")*"+C_D11+string(m_CurrStrNum);
    return F(Formula); 
  END;

  /**
   @brief определение диапазона ячеек основной таблицы регистра АР_07_17_2 
  */
  PRIVATE MACRO RegisterTable_АР_07_17_2()
    RegisterTable(   "N2_TableData", "N2_TableHeader",
                     "N2_D1", "N2_D2", "N2_D3", "N2_D4", "N2_D5", "N2_D6", "N2_D7", "N2_D8", "N2_D9", "N2_D10",
                     "N2_D11", "N2_D12", "N2_D13", "N2_D14", "N2_D15", "N2_D16", "N2_D17", "N2_D18", "N2_D19", "N2_D20",
                     "N2_D21", "N2_D22", "N2_D23", "N2_D24", "N2_D25", "N2_D26", "N2_D27", "N2_D28"
                 );
  END;

  /**
   @brief напечатать заголовок отчёта АР_07_17_2
  */
  PRIVATE MACRO PrintReportHead_АР_07_17_2()
    PrintFormatString( NULL,
                       "N2_H1", Year,
                       "N2_H2", GetPeriodCode(),
                       "N2_H3", 0,
                       "N2_H4", "АР-07-17-2",
                       "N2_H5", "997950001",
                       "N2_H6", "Банк",
                       "N2_H7", 1,
                       "N2_H8", GetPeriodTxt(),
                       "N2_H9", $0,
                       "N2_H10", $0,
                       "N2_H11", $0,
                       "N2_H12", $0,
                       "N2_H13", $0,
                       "N2_H14", $0,
                       "N2_H15", Oper_rshb()
                     );
  END;

  /**
   @brief напечатать стоку таблицы АР_07_17_2
  */
  PRIVATE MACRO PrintTableLine_АР_07_17_2(D1, D2, D3, D4, D5, D6, D7, D8, D9, D10, D11, D12, D13, D14, D15, D16, D17, D18, D19, D20, D21, D22, D23, D24, D25, D26, D27, D28)
    PrintTableLine( "N2_D1", D1, NULL,
                    "N2_D2", D2, NULL, "N2_D3", D3, NULL,
                    "N2_D4", D4, NULL, "N2_D5", D5, NULL,
                    "N2_D6", D6, NULL, "N2_D7", D7, NULL,
                    "N2_D8", D8, NULL, "N2_D9", D9, NULL,
                    "N2_D10", D10, NULL, "N2_D11", D11, NULL,
                    "N2_D12", D12, NULL, "N2_D13", D13, NULL,
                    "N2_D14", D14, NULL, "N2_D15", D15, NULL,
                    "N2_D16", D16, NULL, "N2_D17", D17, NULL,
                    "N2_D18", D18, NULL, "N2_D19", D19, NULL,
                    "N2_D20", D20, NULL, "N2_D21", D21, NULL,
                    "N2_D22", D22, NULL, "N2_D23", D23, NULL,
                    "N2_D24", D24, NULL, "N2_D25", D25, NULL,
                    "N2_D26", D26, NULL, "N2_D27", D27, NULL,
                    "N2_D28", D28, NULL
                  );
    m_CurrStrNum = m_CurrStrNum + 1;
  END;

  /**
   @brief Метод печати итоговых строк по ц/б для регистра АР_07_17_2
  */
  MACRO PrintItogsFIIDLine_АР_07_17_2()
    this.SetCurrentLineFont( 7, true, true );
    this.SetCellFont("N2_D1", 10, true, false, null, RGB(0,0,255), RGB(217,217,217) );
    this.SetCellAlignment(NULL, ALIGN_CENTER);         
    PrintTableLine_АР_07_17_2("N", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x",     
                                      "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x", "x");
    this.SetCurrentLineFont( 9, true, true );
    this.SetCellFont("N2_D1", 10, true, false, null, RGB(0,0,255), RGB(217,217,217) );
    this.SetCellFont("N2_D20", 12, true, false );
    this.SetCellFont("N2_D21", 12, true, false );
    this.SetCellFont("N2_D22", 12, true, false );
    this.SetCellFont("N2_D23", 12, true, false );
    this.SetCellFont("N2_D27", 12, true, false );
    this.SetCellFont("N2_D28", 12, true, false );

    PrintTableLine_АР_07_17_2("N", AP2_D2, AP2_D3, "Итог", "", "", "", "", "", "", "", 
                              "", "", "", "", "", "", "", "", FSUM(C_D20, m_StartStrNum), FSUM(C_D21, m_StartStrNum), FSUM(C_D22, m_StartStrNum),
                              FSUM(C_D23, m_StartStrNum), "", "", "", FSUM(C_D27, m_StartStrNum), FSUM(C_D28, m_StartStrNum));             
  END;

  /**
   @brief Метод печати итогов по регистру АР_07_17_2  
  */
  PRIVATE MACRO PrintItogs_АР_07_17_2()

      PrintFormatString("",
                        "N2_H9",  FSUMITOG(C_D20),
                        "N2_H10", FSUMITOG(C_D21),
                        "N2_H11", FSUMITOG(C_D22),
                        "N2_H12", FSUMITOG(C_D23),
                        "N2_H13", FSUMITOG(C_D27),
                        "N2_H14", FSUMITOG(C_D28) 
                       );
  END;

  /**
   @brief Основной метод печати информации в регистре АР_07_17_2 
  */
  PRIVATE MACRO PrintReport_АР_07_17_2()
    var query, cmd, querypl, cmdpl, querybuy, cmdbuy, i = 0;
    var PricePl = 0; var RelativePricePl = ""; var FaceValuePl = 0;
    var whereFiCond = "";
    
    m_CurrStrNum = 1; //НОМЕР_ПЕРВОЙ_СТРОКИ;
    m_StartStrNum = 0;
    m_SheetNumber = ReportKind_АР_07_17_2;

    SetActiveSheet("АР-07-17-2");
    PrintReportHead_АР_07_17_2();
    PrintItogs_АР_07_17_2();
    RegisterTable_АР_07_17_2();
    if( (AvrFIIDList != null) and (AvrFIIDList.Size > 0) )
      whereFiCond = " AND  fi.t_FIID IN ("; 
      while (i < AvrFIIDList.Size)
        if(i != 0)
          whereFiCond = whereFiCond + ", ";
        end;
        whereFiCond = whereFiCond + AvrFIIDList[i].FIID;
        i = i + 1;
      end;
      whereFiCond = whereFiCond + ")";
    end;
    i = 1;
    //Информация о подходящих под критерии ц/б
    var FIID_QUERY = " SELECT fi.t_fiid, fi.t_name finame, avoiriss.t_isin, fi.t_facevaluefi, avoiriss.t_begplacementdate, " +
	                 "   CASE WHEN  fi.t_drawingdate =  to_date('01.01.0001', 'dd.mm.yyyy') THEN  to_date('31.12.9999', 'dd.mm.yyyy') ELSE fi.t_drawingdate END as t_drawingdate, " +
                     "   RSB_FIInstr.FI_GetNominalOnDate(fi.t_FIID, ?) as FaceValue, tickPl.t_PlacementDate  " +
                     "  FROM dfininstr_dbt fi, davoiriss_dbt avoiriss, "
                     "       (select min(rq.t_FactDate) as t_PlacementDate, qFI.t_FIID " +
                     "         from ddlrq_dbt rq, ddl_tick_dbt tkPl, dfininstr_dbt qFI" +
                     "         where rq.t_DocKind  (+) = " + string(DL_SECUROWN) +
                     "           AND rq.t_Type     (+) = " + string(DLRQ_TYPE_DELIVERY) +
                     "           AND rq.t_FIID     (+) = qFI.t_FIID " +
                     "           AND tkPl.t_DealID (+) = rq.t_DocID " +
                     "           AND rsb_secur.IsSale(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tkPl.t_DealType (+), tkPl.t_BofficeKind (+)))) = 1 "
                     "           AND tkPl.t_Placement (+) = '" + string(SET_CHAR) + "'" +
                     "         group by qFI.t_FIID " +
                     "        ) tickPl" +
                     "  WHERE fi.t_Issuer = ? " +
                     "    AND (fi.t_DrawingDate > ? OR fi.t_DrawingDate = to_date('01.01.0001', 'dd.mm.yyyy')) " +
                     "    AND RSI_RSB_FIInstr.FI_AvrKindsGetRoot( 2, fi.t_AvoirKind ) = ? " +
                     "    AND RSB_FIINSTR.FI_IsCouponAvoiriss(fi.t_FIID) = 1 " +
                     "    AND avoiriss.t_FIID = fi.t_FIID " +                           
                     "    AND tickPl.t_FIID = fi.t_FIID " + whereFiCond +
                     "    AND " +
                     "       ( " +
                     "          CASE " +
                     "          WHEN avoiriss.t_BegPlacementDate < tickPl.t_PlacementDate and avoiriss.t_BegPlacementDate <> to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "          THEN avoiriss.t_BegPlacementDate " +
                     "          WHEN tickPl.t_PlacementDate <> to_date('01.01.0001', 'dd.mm.yyyy') "
                     "          THEN tickPl.t_PlacementDate " +
                     "          ELSE avoiriss.t_BegPlacementDate " +
                     "          END " +
                     "       ) < ? order by fi.t_facevaluefi DESC";
    var FIID_CMD = DL_RSDCommand(FIID_QUERY);
    FIID_CMD.AddParam(m_EndDate);
    FIID_CMD.AddParam({OurBank});
    FIID_CMD.AddParam(m_BegDate);
    FIID_CMD.AddParam(AVOIRISSKIND_BOND);
    FIID_CMD.AddParam(m_EndDate);
    var FIID_Count = FIID_CMD.GetCount();
    if (FIID_Count > 0)
      m_ProgressIndicator.Start(FIID_Count, m_HeaderIndicator, m_HeaderIndicator);
    end;
    m_DataSetFIID = FIID_CMD.Execute(); 
    while (m_DataSetFIID.MoveNext())
      var PlacementDate = IIF(m_DataSetFIID.PlacementDate != null, m_DataSetFIID.PlacementDate, m_DataSetFIID.BegPlacementDate);
      m_StartStrNum = m_CurrStrNum;
      m_DataExists = false;
      m_DrawingData = ((m_DataSetFIID.DrawingDate >= m_BegDate) and (m_DataSetFIID.DrawingDate <= m_EndDate) and (m_DataSetFIID.t_facevaluefi != NATCUR));
      m_ProgressIndicator.Update(i, FIID_Count, m_HeaderIndicator);

      //Информация о сделке первичного размещения
      querypl = " select leg.t_Price, leg.t_RelativePrice, "
              + "    RSB_FIInstr.FI_GetNominalOnDate(rq.t_FIID, rq.t_FactDate) FaceValue "
              + "   from ddl_leg_dbt leg, ddlrq_dbt rq, ddl_tick_dbt tick   "
              + "  WHERE leg.t_DealID  = rq.t_DocID "
              + "    and ((rq.t_DocKind  = " + string(DL_SECUROWN)
              + "    and tick.t_Placement = '" + string(SET_CHAR) + "') "
              + "    or (rq.t_DocKind  = " + string(DL_AVRWRTOWN) + ")) " 
              + "    and rq.t_Type     = " + string(DLRQ_TYPE_DELIVERY) 
              + "    and rq.t_FIID     = ? " 
              + "    and tick.t_DealID = rq.t_DocID " 
              + "    and rsb_secur.isBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0 " 
              + "    and rq.t_FactDate = ? "
              + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
              + "    and leg.t_LegID = 0 "
              + "    FETCH FIRST 1 ROWS ONLY ";
      
      cmdpl = DL_RSDCommand(querypl);
 
      cmdpl.AddParam(m_DataSetFIID.FIID);
      cmdpl.AddParam(date(PlacementDate));
      m_DataSetPlacement = cmdpl.Execute();
      if(not m_DataSetPlacement.moveNext())
        m_DataSetPlacement = NULL;
      end;

      //Сделки размещения в периоде
      query =   " select tk.t_dealdate, tk.t_placement, leg.t_DealID, rq.t_Amount DealAmount, leg.t_Price, leg.t_RelativePrice, rq.t_FactDate DeliveryDate, "
              + "        nvl((select 'X' from downbondsregisterhst_dbt corrhst1 where corrhst1.t_DealID = tk.t_DealID AND corrhst1.t_isBuy = 'X' AND corrhst1.t_reSell = 'X' FETCH FIRST 1 ROWS ONLY),chr(0)) isCorrected, "
              + "        RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) as DealIsBuy, rq.t_DocKind "
              + "   from ddlrq_dbt rq, ddl_tick_dbt tk, ddl_leg_dbt leg  "
              + "  where rq.t_DocKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
              + "    and ((rq.t_FactDate >= ? and tk.t_Placement != '" + string(SET_CHAR) + "' and rq.t_FactDate <= ? and "+m_DataSetFIID.FaceValueFI+" = " + NATCUR +" and rq.t_DocKind != "+DL_AVRWRTOWN+") " // Вторичное размещение невалютных бумаг
              + "         OR "
              + "    (rq.t_FactDate >= ? and tk.t_Placement = '" + string(SET_CHAR) + "' and rq.t_FactDate <= ? and "+m_DataSetFIID.FaceValueFI+" = " + NATCUR +" and exists " // Вторичное размещение невалютных бумаг, заведённое как первичное
              + "    (select 'X' from downbondsregisterhst_dbt corrhst1 where corrhst1.t_DealID = tk.t_DealID AND corrhst1.t_isBuy = 'X' AND corrhst1.t_reSell = 'X' FETCH FIRST 1 ROWS ONLY) ) "
              + "         OR "
              + "         ("+m_DataSetFIID.FaceValueFI+" != " + NATCUR + " and rq.t_FactDate <= ? and ((tk.t_Placement = '" + string(SET_CHAR) + "') or (rq.t_DocKind = "+DL_AVRWRTOWN+")))) " // Первичное размещение по валютным бумагам
              + "    and rq.t_Type = " + DLRQ_TYPE_DELIVERY                     
              + "    and RSB_FIInstr.FI_IsCouponAvoiriss(rq.t_FIID) != 0 "
              + "    and RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 "
              + "    and tk.t_DealID = rq.t_DocID "
              + "    and leg.t_DealID = rq.t_DocID "
              + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
              + "    and leg.t_LegID = 0 "
              + "    and rq.t_FIID = ? order by tk.t_dealdate "; 

      cmd = DL_RSDCommand(query); 
    
      cmd.AddParam(m_BegDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_BegDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_DataSetFIID.FIID);
      m_DataSet = cmd.Execute();
      while(m_DataSet.MoveNext())
        if((m_DataSet.IsCorrected != SET_CHAR) and isDealPlacement)
          PrintTableLine_АР_07_17_2("", AP2_D2, AP2_D3, AP2_D4, AP2_D5, AP2_D6, AP2_D7, AP2_D8, AP2_D9, AP2_D10, AP2_D11, 
                                        AP2_D12, AP2_D13, AP2_D14, AP2_D15, AP2_D16, AP2_D17, AP2_D18, AP2_D19, AP2_D20,
                                        AP2_D21, AP2_D22, AP2_D23, AP2_D24, AP2_D25, AP2_D26, AP2_D27, AP2_D28 );
          m_DataExists = true;
        else //Для сделок вторичного размещения нужно найти соответствующие им сделки выкупа
          if(m_DataSet.isCorrected == SET_CHAR) //Скорректированные сделки размещения
            querybuy = " select ? as Price, ? as RelativePrice, hst.t_ChangeDate as maturity, hst.t_Price as PriceSell, "
                     + "    RSB_FIInstr.FI_GetNominalOnDate(?, hst.t_ChangeDate) FaceValue, hst.t_Amount as AmountBuy "
                     + "   from downbondsregisterhst_dbt hst  "
                     + "  WHERE hst.t_DealID = ? "
                     + "    and hst.t_isBuy  = 'X' "
                     + "    and hst.t_reSell = 'X' "
                     " ORDER BY hst.t_ChangeDate ";
      
            cmdbuy = DL_RSDCommand(querybuy);
            if(not m_DataSetPlacement)
              cmdbuy.AddParam(m_DataSet.Price);
              cmdbuy.AddParam(m_DataSet.RelativePrice);
            else
              cmdbuy.AddParam(m_DataSetPlacement.Price);
              cmdbuy.AddParam(m_DataSetPlacement.RelativePrice);
            end;
            cmdbuy.AddParam(m_DataSetFIID.FIID);
            cmdbuy.AddParam(m_DataSet.DealID); 
          else //Стандартная обработка
            querybuy = " select leg.t_Price, leg.t_RelativePrice, leg.t_maturity, lnk.t_amount AmountBuy, 100 as PriceSell, "
                     + "    RSB_FIInstr.FI_GetNominalOnDate(?, leg.t_maturity) FaceValue "
                     + "   from ddl_leg_dbt leg, dpmwrtlnk_dbt lnk, dpmwrtsum_dbt lotbuy, dpmwrtsum_dbt lotsell  "
                     + "  WHERE lotsell.t_DealID  = ? "
                     + "    and lnk.t_SaleID = lotsell.t_SumID "
                     + "    and lnk.t_Kind = " + PMWRTLINK_KIND_SALE_BUYOUT
                     + "    and lotbuy.t_SumID = lnk.t_BuyID "
                     + "    and leg.t_DealID   = lotbuy.t_DealID "
                     + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
                     + "    and leg.t_LegID   = 0 " +
                     " ORDER BY leg.t_maturity ";
      
            cmdbuy = DL_RSDCommand(querybuy);
            cmdbuy.AddParam(m_DataSetFIID.FIID); 
            cmdbuy.AddParam(m_DataSet.DealID);
          end;
          m_DataSetBuy = cmdbuy.Execute();
          while(m_DataSetBuy.moveNext())
            PrintTableLine_АР_07_17_2("", AP2_D2, AP2_D3, AP2_D4, AP2_D5, AP2_D6, AP2_D7, AP2_D8, AP2_D9, AP2_D10, AP2_D11, 
                                          AP2_D12, AP2_D13, AP2_D14, AP2_D15, AP2_D16, AP2_D17, AP2_D18, AP2_D19, AP2_D20,
                                          AP2_D21, AP2_D22, AP2_D23, AP2_D24, AP2_D25, AP2_D26, AP2_D27, AP2_D28 );
            m_DataExists = true;
          end;
          m_DataSetBuy = null;           
        end;
      end;

      //Если погашение происходит в периоде, то выводится информация по выкупленным и не размещённым ц/б для рублёвых облигаций
      if( (m_DataSetFIID.DrawingDate >= m_BegDate) and (m_DataSetFIID.DrawingDate <= m_EndDate) and (m_DataSetFIID.t_facevaluefi == NATCUR) ) 
        m_DrawingData = true;          
        querybuy = " select leg.t_Price, leg.t_RelativePrice, RSB_FIInstr.FI_GetNominalOnDate(fin.t_FIID, leg.t_maturity) as FaceValue, fin.t_facevaluefi, leg.t_maturity, rq.t_DocKind, 100 as PriceSell, "
                 + "        lothist.t_Amount as AmountBuy, RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) as DealIsBuy "
                 + "   from ddlrq_dbt rq, dfininstr_dbt fin, ddl_tick_dbt tk, ddl_leg_dbt leg, dpmwrtsum_dbt lot, v_scwrthistex lothist  "
                 + "  where rq.t_DocKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+") "
                 + "    and rq.t_FactDate <= ? "
                 + "    and rq.t_Type = " + DLRQ_TYPE_DELIVERY
                 + "    and fin.t_FIID = ? "
                 + "    and fin.t_FIID = rq.t_FIID "
                 + "    and lot.t_DealID = rq.t_DocID "
                 + "    and lothist.t_SumID = lot.t_SumID "
                 + "    and lothist.t_Amount <> 0 "
                 + "    and RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) <> 0 "
                 + "    and lothist.t_Instance = (select MAX(l.t_Instance) "
                 + "                                from v_scwrthistex l "
                 + "                               where l.t_SumID = lothist.t_SumID "
                 + "                                 and l.t_ChangeDate < fin.t_drawingdate )  "
                 + "    and tk.t_DealID = rq.t_DocID "
                 + "    and leg.t_DealID = rq.t_DocID "
                 + "    and leg.t_LegKind = " + LEG_KIND_DL_TICK
                 + "    and leg.t_LegID = 0 ";
        cmdbuy = DL_RSDCommand(querybuy);
        cmdbuy.AddParam(m_EndDate);
        cmdbuy.AddParam(m_DataSetFIID.FIID);
        m_DataSetBuy = cmdbuy.Execute();
        while(m_DataSetBuy.moveNext())
          PrintTableLine_АР_07_17_2("", AP2_D2, AP2_D3, AP2_D4, AP2_D5, AP2_D6, AP2_D7, AP2_D8, AP2_D9, AP2_D10, AP2_D11, 
                                        date(m_DataSetBuy.Maturity), AP2_D13, AP2_D14, AP2_D15, "", "", "", "", AP2_D20,
                                        AP2_D21, AP2_D22, AP2_D23, "", "", "", "", "" );
          m_DataExists = true;
        end;
        m_DataSetBuy  = null;
      end;
      if( m_DataExists )
        PrintItogsFIIDLine_АР_07_17_2(AP2_D2, AP2_D3); 
      end;
      i = i + 1;                       
    end;

    if (FIID_Count > 0)
      m_ProgressIndicator.Stop();
    end;
    if(m_CurrStrNum == 1) //НОМЕР_ПЕРВОЙ_СТРОКИ
      PrintTableLine( "N2_D2", "ДАННЫХ НЕТ", null);
    end;

    EndTable();

    if(m_CurrStrNum > 1) //!= НОМЕР_ПЕРВОЙ_СТРОКИ
      SetOnAutoFilter("АР-07-17-2", "A12:AB12");
      //SetAutoSize(); 
    end;   
  END;

  /**
   @brief Переопределение базового метода создания отчёта
   @param[in] NumCopy Число копий (по умолчанию = 1)
  */
  PRIVATE MACRO Create(NumCopy:INTEGER)
    //Для ReportKind_АР_07_17_1 оставляем закомментированные заготовки для дальнейшего внедрения
    var PrintAll17 = false;
    var i = 0;
    if((ReportKindList != null) and (ReportKindList.Size > 0))
      while(i < ReportKindList.Size)
        if(ReportKindList[i] == ReportKind_АР_07_17_1_2)
          PrintReport_АР_07_17_1();
          PrintReport_АР_07_17_2();  
          PrintAll17 = true;
        end;
        i = i + 1;
      end;

      if (not PrintAll17)
        i = 0;
        while(i < ReportKindList.Size)
          if(ReportKindList[i] == ReportKind_АР_07_17_1)
            PrintReport_АР_07_17_1();
          elif(ReportKindList[i] == ReportKind_АР_07_17_2)
            PrintReport_АР_07_17_2();
          end;
          i = i + 1;
        end;
      end;
    else //Выбраны "все" отчёты
      PrintReport_АР_07_17_1();
      PrintReport_АР_07_17_2();
    end;
  END;

  /**
   @brief Переопределение базового метода завершения отчёта
   @param[in] NumCopy Число копий (по умолчанию = 1)
  */
  PRIVATE MACRO EndReport(NumCopy:INTEGER)
    ReplaceFormulaAndCalculate();
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode, ForceFormatRep );
END;

MACRO ReportRunEx( IsWebService   :BOOL,
                   FormData,
                   ReportHashCode :Integer,
                   menuItem
                 )

   var FullReportFileNames = TArray();
   var Register_Report;
   var stat = true;
   var NewRep = false, OldRep = false;
   file Bond (fininstr);

   WebMenuItem = menuItem;
   
   if(IsWebService)
      if(ValType(FormData) != V_UNDEF)
         OwnBondsRepForm = WS_OwnBondsRegister_Panel(FormData);

         AvrFIIDList = FormData.AvrFIIDList;
         BeginDate = FormData.BeginDate;
         EndDate = FormData.EndDate;
         Year = FormData.Year;
         Period = FormData.Period - 12;
         AddItog = FormData.AddItog;
         var i = 0;
         while(i < FormData.ReportKindList.Size)
            ReportKindList[i] = FormData.ReportKindList[i].NumberAlg;
            i = i + 1;
         end;
      else
         stat = false;
      end;
   else
      OwnBondsRepForm = SP_OwnBondsRegister_Panel();
   end;

   while(stat)
      if(not IsWebService)
         stat = OwnBondsRepForm.Run();
         if(not stat)
            break;
         end;
         AvrFIIDList = TArray;
         if(OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_AVRCODE) > 0)
            Bond.FIID = OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_AVRCODE);
            if(GetEQ(Bond))
              AvrFIIDList[0] = Bond;
            end;
         end;
         BeginDate = OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_BEGDATE);
         EndDate = OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_ENDDATE);
         Year = OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_YEAR);
         Period = OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_PERIOD) - 12;
         AddItog = IIF(OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_GROWTH) == SET_CHAR,true,false);
         ReportKindList = TArray;
         if(OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_REPKIND) > 0)
            ReportKindList[0] = OwnBondsRepForm.GetFieldValue(PNFLD_OWNB_REPKIND);
         end;
      end;

      var k = 0;
      if((ReportKindList != null) and (ReportKindList.Size > 0))
        while(k < ReportKindList.Size)
          if((ReportKindList[k] == ReportKind_0261_0262) OR (ReportKindList[k] == ReportKind_0461))
            OldRep = true;
          elif((ReportKindList[k] == ReportKind_АР_07_17_1) OR (ReportKindList[k] == ReportKind_АР_07_17_2) OR (ReportKindList[k] == ReportKind_АР_07_17_1_2)) 
            NewRep = true;
          end;
          k = k + 1;
        end;
      else
        OldRep = true;
        NewRep = true;
      end;   
      if (OldRep)
        FIIDS = CFIIDS(AvrFIIDList, BeginDate, EndDate, Year, ReportKindList);
        Register_Report = Own_Bonds_Registers_Report( NULL, "Report_TxRegister_OwnBonds.xlsx", NULL, IsWebService );
        Register_Report.Run(FIIDS.Count);

        if(IsWebService)
          FullReportFileNames = Register_Report.GetFullReportFileNames();
          Dl_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem);
          stat = false;
        else
          Dl_CallInsertStat(DL_OUTREPORT_EXCEL);
        end;
      end;

      if (NewRep)
        Register_Report = Own_Bonds_Registers_Report_17( NULL, "Report_TxRegister_OwnBonds_17.xlsx", NULL, IsWebService, NULL, true, true, WINREP_FORMAT_XLSX);
        Register_Report.Run();

        if(IsWebService)
          FullReportFileNames = Register_Report.GetFullReportFileNames();
          Dl_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem);
          stat = false;
        else
          Dl_CallInsertStat(DL_OUTREPORT_EXCEL);
        end;
      end;
   end;

   FIIDS = null;
   Register_Report = null;

   return FullReportFileNames;
END;
