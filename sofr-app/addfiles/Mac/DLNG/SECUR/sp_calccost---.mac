/*  
$Name:        sp_calccost.mac
$Module:      Ценные бумаги
$Description: Процедура расчета текущей справедливой стоимости (TCC) ц/б
*/
import "secinter.mac", "scservop.mac", "sp_categ.mac", SPInter;

CONST CALCCOST_CATEGORY  = 27;/*Возможность надежного расчета TCC*/


Private Macro GetNkdDate(RepDate)
var d, m, y, m1, y1;
Var LastWDate, LastDate;

datesplit(RepDate, d, m ,y);

If(m == 12)
   m1 = 1;
   y1 = y+1;
Else
   m1 = m+1;
   y1 = y;
end;

LastWDate  = GetDateAfterWorkDays(Date(1, m1, y1), -1);
LastDate = Date(1, m1, y1) -1;

//Println(LastWDate);
//Println(LastDate);
If(RepDate == LastWDate)
   return LastDate;
else
   return RepDate;
end;
   return RepDate;
End;


MACRO  ExCalcCost(Comm:VARIANT/*ak*/, recs:@integer, errrecs:@integer, errmsg:@string/*~ak*/)

  record dl_comm( dl_comm );
  SetBuff( dl_comm, Comm ) ;

  /*ak*/
  recs = 0;
  errrecs = 0;
  errmsg = "";
  /*~ak*/
  PRIVATE VAR MMVB_ID;
  var isMMVB = false;

  PRIVATE MACRO GetMMVB_ID()
    var stat = 0;
    var MMVB_Code = "", _MMVB_ID = -1;
  
    GetRegistryValue("SECUR\\MICEX_CODE", V_STRING, MMVB_Code, stat);
    if(stat != 0)
      msgbox("Ошибка при получении значения настройки SECUR\\MICEX_CODE");
    elif(MMVB_Code == "")
      stat = 1;
      msgbox("Не задано значение настройки SECUR\\MICEX_CODE");
    else
      _MMVB_ID = GetCodeParty(MMVB_Code,PTCK_CONTR);
    end;
  
    return _MMVB_ID;
  end;

  PRIVATE MACRO GetDataRate(Fiid, FaceValueFi, FaceValue, AvoirKind)                                                                    
    VAR Select, Data; 
    Var CourceType1 = 1001, CourceType2 = 4, CourceType3 = SP_RATETYPE_MarketPrice, CourceType4 = 23, Course, erFlag, SinceDate;
    If(FaceValueFi !=0)
       CourceType2 = 23;
       CourceType3 = 4;
       CourceType4 = SP_RATETYPE_MarketPrice;
    else
       CourceType2 = 4;
       CourceType3 = SP_RATETYPE_MarketPrice;
       CourceType4 = 23
    end;
    Var  i = 0;

    Var arrCourse = TArray();
    arrCourse[arrCourse.size] = SP_RATETYPE_MediumPrice;
    arrCourse[arrCourse.size] = SP_RATETYPE_MarketPrice;
    arrCourse[arrCourse.size] = SP_RATETYPE_CloseCost;
    While(i<arrCourse.size)
        Select = " select rate.T_RateID, rate.T_OtherFI OtherFI, " + FaceValue + " as FaceValue, " + FaceValueFi + " as FaceValueFi, " +
                          AvoirKind + " as AvoirKind, rate.T_Scale RScale, rate.T_Point RPoint, " +                                     
                 "        rate.T_FIID Fiid, fin.t_Scale Scale, fin.t_Point Point, rate.t_Rate Rate," +                                  
                 "        rate.t_IsInverse IsInverse, rate.t_IsRelative IsRelative, rate.t_Market_Place, " +                            
                 "        avoiriss.T_NKDRound_Kind " +                                                                                  
                 " from dratedef_dbt rate, dfininstr_dbt fin, davoiriss_dbt avoiriss " +                                                
                 " where rate.T_OtherFI = " + string(FIID) +                                                                            
                 "   and rate.T_TYPE = " + string(arrCourse[i]) +
                 "   and rate.T_Market_Place = " + MMVB_ID +
                 "   and fin.T_fiid = " + string(FIID) +                                                                                
                 "  and avoiriss.T_FIID = fin.T_FIID";                                                                                  
                                                                                                                                        
        Data = TRsbDataSet(Select);                                                                                                     
        if( Data.MoveNext() )                                                                                                           
           Course = GetRateOnDate( dl_comm.CommDate, FIID, Data.FIID, false, arrCourse[i], erFlag, SinceDate, Data.Market_Place );
           If(Course ==0 )
              isMMVB = true;
              return Data;                                                                                                                 
           else
              If(SinceDate >= dl_comm.CommDate-90) 
                 isMMVB = true;
                 return Data;                                                                                                                 
              end;
           end;
        end;                                                                                                                            

      i = i + 1;
    end;

    isMMVB = false;

        Select = " select rate.T_RateID, rate.T_OtherFI OtherFI, " + FaceValue + " as FaceValue, " + FaceValueFi + " as FaceValueFi, " +
                          AvoirKind + " as AvoirKind, rate.T_Scale RScale, rate.T_Point RPoint, " +                                     
                 "        rate.T_FIID Fiid, fin.t_Scale Scale, fin.t_Point Point, rate.t_Rate Rate," +                                  
                 "        rate.t_IsInverse IsInverse, rate.t_IsRelative IsRelative, rate.t_Market_Place, " +                            
                 "        avoiriss.T_NKDRound_Kind " +                                                                                  
                 " from dratedef_dbt rate, dfininstr_dbt fin, davoiriss_dbt avoiriss " +                                                
                 " where rate.T_OtherFI = " + string(Fiid) +                                                                            
                 "   and rate.T_TYPE = " + string(1001/*SP_RATETYPE_MarketPrice*/) +
  //               "   and rate.T_SinceDate <= " + GetSQLDate(dl_comm.CommDate) +                                                       
                 "   and fin.T_fiid = " + string(Fiid) +                                                                                
                 "  and avoiriss.T_FIID = fin.T_FIID";                                                                                  
                                                                                                                                        
        Data = TRsbDataSet(Select);                                                                                                     
        if( Data.MoveNext() )                                                                                                           
           Course = GetRateOnDate( dl_comm.CommDate, FIID, FaceValueFI, false, 1001, erFlag, SinceDate );
           If(Course ==0 )
              return Data;                                                                                                                 
           else
              If(SinceDate >= dl_comm.CommDate-30)
                 return Data;                                                                                                                 
              end;
           end;
        end;                                                                                                                            
        Select = " select rate.T_RateID, rate.T_OtherFI OtherFI, " + FaceValue + " as FaceValue, " + FaceValueFi + " as FaceValueFi, " +
                          AvoirKind + " as AvoirKind, rate.T_Scale RScale, rate.T_Point RPoint, " +                                     
                 "        rate.T_FIID Fiid, fin.t_Scale Scale, fin.t_Point Point, rate.t_Rate Rate," +                                  
                 "        rate.t_IsInverse IsInverse, rate.t_IsRelative IsRelative, rate.t_Market_Place, " +                            
                 "        avoiriss.T_NKDRound_Kind " +                                                                                  
                 " from dratedef_dbt rate, dfininstr_dbt fin, davoiriss_dbt avoiriss " +                                                
                 " where rate.T_OtherFI = " + string(Fiid) +                                                                            
                 "   and rate.T_TYPE = " + string(CourceType2) +
  //               "   and rate.T_SinceDate <= " + GetSQLDate(dl_comm.CommDate) +                                                       
                 "   and fin.T_fiid = " + string(Fiid) +                                                                                
                 "  and avoiriss.T_FIID = fin.T_FIID";                                                                                  
                                                                                                                                        
        Data = TRsbDataSet(Select);                                                                                                     
        if( Data.MoveNext() )                                                                                                           
           Course = GetRateOnDate( dl_comm.CommDate, FIID, FaceValueFI, false, CourceType2, erFlag, SinceDate );
           If(Course ==0 )
              return Data;                                                                                                                 
           else
              If(SinceDate >= dl_comm.CommDate-90)
                 return Data;                                                                                                                 
              end;
           end;
        end;                                                                                                                            
        Select = " select rate.T_RateID, rate.T_OtherFI OtherFI, " + FaceValue + " as FaceValue, " + FaceValueFi + " as FaceValueFi, " +
                          AvoirKind + " as AvoirKind, rate.T_Scale RScale, rate.T_Point RPoint, " +                                     
                 "        rate.T_FIID Fiid, fin.t_Scale Scale, fin.t_Point Point, rate.t_Rate Rate," +                                  
                 "        rate.t_IsInverse IsInverse, rate.t_IsRelative IsRelative, rate.t_Market_Place, " +                            
                 "        avoiriss.T_NKDRound_Kind " +                                                                                  
                 " from dratedef_dbt rate, dfininstr_dbt fin, davoiriss_dbt avoiriss " +                                                
                 " where rate.T_OtherFI = " + string(Fiid) +                                                                            
                 "   and rate.T_TYPE = " + string(CourceType3) +
  //               "   and rate.T_SinceDate <= " + GetSQLDate(dl_comm.CommDate) +                                                       
                 "   and fin.T_fiid = " + string(Fiid) +                                                                                
                 "  and avoiriss.T_FIID = fin.T_FIID";                                                                                  
                                                                                                                                        
        Data = TRsbDataSet(Select);                                                                                                     
        if( Data.MoveNext() )                                                                                                           
           Course = GetRateOnDate( dl_comm.CommDate, FIID, FaceValueFI, false, CourceType3, erFlag, SinceDate );
           If(Course ==0 )
              return Data;                                                                                                                 
           else
              If(SinceDate >= dl_comm.CommDate-90)
                 return Data;                                                                                                                 
              end;
           end;
        end;                                                                                                                            
        Select = " select rate.T_RateID, rate.T_OtherFI OtherFI, " + FaceValue + " as FaceValue, " + FaceValueFi + " as FaceValueFi, " +
                          AvoirKind + " as AvoirKind, rate.T_Scale RScale, rate.T_Point RPoint, " +                                     
                 "        rate.T_FIID Fiid, fin.t_Scale Scale, fin.t_Point Point, rate.t_Rate Rate," +                                  
                 "        rate.t_IsInverse IsInverse, rate.t_IsRelative IsRelative, rate.t_Market_Place, " +                            
                 "        avoiriss.T_NKDRound_Kind " +                                                                                  
                 " from dratedef_dbt rate, dfininstr_dbt fin, davoiriss_dbt avoiriss " +                                                
                 " where rate.T_OtherFI = " + string(Fiid) +                                                                            
                 "   and rate.T_TYPE = " + string(CourceType4) +
  //               "   and rate.T_SinceDate <= " + GetSQLDate(dl_comm.CommDate) +                                                       
                 "   and fin.T_fiid = " + string(Fiid) +                                                                                
                 "  and avoiriss.T_FIID = fin.T_FIID";                                                                                  
                                                                                                                                        
        Data = TRsbDataSet(Select);                                                                                                     
        if( Data.MoveNext() )                                                                                                           
           Course = GetRateOnDate( dl_comm.CommDate, FIID, FaceValueFI, false, CourceType4, erFlag, SinceDate );
           If(Course ==0 )
              return Data;                                                                                                                 
           else
              If(SinceDate >= dl_comm.CommDate-90)
                 return Data;                                                                                                                 
              end;
           end;
        end;                                                                                                                            

        return false;                                                                                                                   
  END;                                                                                                                                  

  FILE RateRec("ratedef") key 0;

  PRIVATE MACRO MediumMarketCost(DataRate)                                                                                   
    VAR continue_circle = true, TCC = $0., count = 0, Sum = $0., NKD = $0.,                                                   
        Rate = 0, Error, SinceDate, Scale = 1, Point = 9, MarketPlace, stat = 0;                                                       
                                                                                                                             
    record RateRecTSS(ratedef);                                                                                              
    VAR ErrorFlag;                                                                                                           
    var wrtcalc = TRecHandler( "pmwrtsum.dbt" );                                                                             
    var TSSFIID:integer = -1;                                                                                                
    var isEqvivFIID:bool = false;/*наличие рыночных курсов валюте номинала*/                                                 
    array  arFiid,arTSSFiid,arTSSCount,arMarketPlace, arSinceDate;
    Var NKDDate;                                                                                                                          
    macro MakeArFIID(_TSSFIID:integer,_MarketPlace:integer)                                                                  
      var SinceDate, error;
      Rate = GetRateValueOnDate( RateRec, dl_comm.CommDate, RateRec.OtherFI, _TSSFIID, false, error, SinceDate );
      if( Rate != 0.0 )                                                                                                      
        if( SmartConvertSum( Sum, ToMoney(Rate), dl_comm.CommDate, DataRate.Fiid, _TSSFIID, true ) )                         
                                                                                                                             
                                                                                                                             
           if (arFiid(_TSSFIID) == null)                                                                                     
               arFiid(_TSSFIID) = _TSSFIID;                                                                                  
           end;                                                                                                              
                                                                                                                             
           if (arTSSFiid(_TSSFIID) == null)                                                                                  
               arTSSFiid(_TSSFIID) = Sum;                                                                                    
           else                                                                                                              
               arTSSFiid(_TSSFIID) = arTSSFiid(_TSSFIID) + Sum;                                                              
           end;                                                                                                              
                                                                                                                             
           if (arTSSCount(_TSSFIID) == null)                                                                                 
               arTSSCount(_TSSFIID) = 1;                                                                                     
           else                                                                                                              
               arTSSCount(_TSSFIID) = arTSSCount(_TSSFIID) + 1;                                                              
           end;                                                                                                              
                                                                                                                             
           arMarketPlace(_TSSFIID) = _MarketPlace;
           arSinceDate(_TSSFIID) = SinceDate;
                                                                                                                             
           TSSFIID = _TSSFIID;                                                                                               
           count = count + 1;                                                                                                
                                                                                                                             
         end;                                                                                                                
       end;                                                                                                                  
    end;                                                                                                                     
                                                                                                                             
    wrtcalc.Clear();                                                                                                         
                                                                                                                             
    while( continue_circle )                                                                                                 
       ClearRecord( RateRec );                                                                                               
       RateRec.RateID = DataRate.RateID;                                                                                     
       if( GetEQ(RateRec) )                                                                                                  
                                                                                                                             
          /*!!!!! для нескольких бирж взять если не эквивал валюты*/                                                         
          if (not isEqvivFIID )                                                                                              
            if (ToInt(DataRate.FaceValueFI) != RateRec.FIID)                                                                 
                                                                                                                             
              MakeArFIID(RateRec.FIID,DataRate.Market_Place);                                                                
            else                                                                                                             
              isEqvivFIID = true;                                                                                            
                                                                                                                             
              MakeArFIID(ToInt(DataRate.FaceValueFI),0);                                                                     
            end;                                                                                                             
          else                                                                                                               
            /*берем только совпадающие валюты т.к один раз уже совпало*/                                                     
            if (ToInt(DataRate.FaceValueFI) == RateRec.FIID)                                                                 
                                                                                                                             
              MakeArFIID(ToInt(DataRate.FaceValueFI),0);                                                                     
            end;                                                                                                             
          end;                                                                                                               
       end;                                                                                                                  
       continue_circle = DataRate.MoveNext();                                                                                
    end;                                                                                                                     
                                                                                                                             
    if(count == 0)                                                                                                           
       return 1;                                                                                                             
    end;                                                                                                                     
                                                                                                                             
    TCC = arTSSFiid(TSSFIID)/arTSSCount(TSSFIID);                                                                            
                                                                                                                             
    if (arTSSCount(TSSFIID) > 1)                                                                                             
      MarketPlace = 0;                                                                                                       
    else                                                                                                                     
      MarketPlace = arMarketPlace(TSSFIID);
    end;                                                                                                                     
                                                                                                                             
    if( FI_IsAvrKindBond( ToInt(DataRate.AvoirKind) ) )/*если ц\б явл. облигацией, то + НКД*/                                

       NKDDate = dl_comm.EndDate;

       If(DataRate.FaceValueFI == 0)
          NKDDate = GetNkdDate(dl_comm.CommDate);
       end;
    /*для всех бумаг, у которых стоит Округление купона - "Округление платежа по НКД"                                        
      считать НКД не на одну бумагу, а считать НКД из расчета всех бумаг на балансе и получать значение для одной бумаги,    
      поделив полученное НКД на кол-во бумаг*/                                                                               
       if( DataRate.NKDRound_Kind == 2 )                                                                                     
          if( WRT_Calc( {NumDprt}, DataRate.OtherFI, -1, 0, -1, dl_comm.CommDate, wrtcalc, true, false ) )                   
             if( wrtcalc.rec.Amount > 0 )                                                                                    
                NKD = НКД(DataRate.OtherFI, wrtcalc.rec.Amount, NKDDate/*dl_comm.CommDate*/)/wrtcalc.rec.Amount;
             end;
             /*GAA: 503511*/
             if (NKD == 0 ) 
//Т.к. для ц/б, у которых стоит Округление купона - "Округление платежа по НКД" курс ТСС  указывакется с точностью до 9 знаков, то в НКД необходимо так же соблюдать аналогичную точность
                NKD = НКД(DataRate.OtherFI, 100000000, NKDDate/*dl_comm.CommDate*/)/100000000;  
//                NKD = НКД(DataRate.OtherFI, 1, NKDDate/*dl_comm.CommDate*/);
             end; /**/                                                                                                             
          end;                                                                                                               
       else                                                                                                                  
          NKD = НКД(DataRate.OtherFI, 1, NKDDate/*dl_comm.CommDate*/);
       end;                                                                                                                  
                                                                                                                             
       TCC = TCC + NKD;                                                                                                      
    end;                                                                                                                     
                                                                                                                             
    ClearRecord( RateRecTSS );
    ErrorFlag = ПолучитьКурс( RateRecTSS, TSSFIID, DataRate.OtherFI, SP_RATETYPE_RightCost );                                
    if( not ErrorFlag )                                                                                                      
       if( ПолучитьЗначениеКурса( RateRecTSS, dl_comm.CommDate ) == 0 )                                                      
          Scale = RateRecTSS.Scale;                                                                                          
          Point = RateRecTSS.Point;                                                                                          
       end;                                                                                                                  
    end;                                                                                                                     
                                                                                                                             
    if( FI_IsAvrKindBond(ToInt(DataRate.AvoirKind)) AND (DataRate.NKDRound_Kind == 2) )                                      
       Point = 9;                                                                                                            
    end;                                                                                                                     
    
    Sum = TCC;/*сумма для протокола*/                                                                                                                     
    TCC = Round(TCC*Scale*Pow(10,Point),0);                                                                                  
                                                                                                                             
    stat = SetRateTss(TSSFIID, DataRate.OtherFI, SP_RATETYPE_RightCost, UNSET_CHAR, Double(TCC), Scale, Point,               
               dl_comm.CommDate, UNSET_CHAR, UNSET_CHAR, MarketPlace);

    if(stat == 0)
       /*сохраняем для протокола*/
       If(arSinceDate(TSSFIID) < dl_comm.CommDate) 
          ScOpReportLineData[ScOpReportLineData.size] = SvOpCALCTSS( DataRate.OtherFI,
                                                                  Sum, 
                                                                  TSSFIID, 
                                                                  "Использовался курс от " + arSinceDate(TSSFIID)
                                                                );
       else
          ScOpReportLineData[ScOpReportLineData.size] = SvOpCALCTSS( DataRate.OtherFI,
                                                                  Sum, 
                                                                  TSSFIID 
                                                                );
       end;
    end;

    return stat;

  END;                                                                                                                       

  VAR avoiriss = TRecHandler("avoiriss");

  VAR Query, Select, Data, DataRate, Num = 0, i=0;
  VAR NRec, Err = "";

  copy(ScOprServDoc,dl_comm);
  ScOpInit();

  Select  = DL_RSDCommand();
 
  Query =  "select fin.T_FIID Fiid, fin.T_FACEVALUE FaceValue, fin.T_FACEVALUEFI FaceValueFi, fin.T_AvoirKind AvoirKind" +
           "  from dfininstr_dbt fin, davrkinds_dbt avrkind, davoiriss_dbt avr " +
           " where avr.t_FIID = fin.t_FIID " +
           "   and fin.T_FI_KIND = ?" + 
           "   and avrkind.T_FI_KIND = fin.T_FI_KIND" +
           "   and fin.T_AVOIRKIND = avrkind.T_AVOIRKIND" +
//           "   and fin.T_fiid in( 5454 ) " +
           "   and avrkind.T_ISINDIVIDUAL != 'X'";

  Select.addParam(FIKIND_AVOIRISS);

  if( CheckTaxDepositoryMode() == false )
     Query = Query + " and avr.T_SPISCLOSED != 'X' ";
  else
     Query = Query + " and fin.T_ISCLOSED != 'X' ";
  end;
  if( dl_comm.AvoirKind > 0 )
     Query = Query + " and RSB_FIInstr.FI_AvrKindsEQ(?, ?, Fin.t_AvoirKind) = 1 "; 

     Select.addParam(FIKIND_AVOIRISS);
     Select.addParam(dl_comm.AvoirKind);
  end; 

  NRec = Select.GetCount(Query);

  if( NRec > 0 )
     Data = Select.execute(Query);
     MMVB_ID = GetMMVB_ID();
     InitProgress( NRec, "Выполнение операции...", "Расчет текущей справедливой стоимости" );     
     while( Data.MoveNext() )                                                                    
        i=i+1;                                                                                  
        if( (ПолучитьФинИн( Data.Fiid, null, avoiriss ) == 0)/* AND                               
             ExistNOSS( avoiriss, dl_comm.CommDate )*/ /*ТСС может быть надежно определена*/      
          )    
           DataRate = GetDataRate(Data.Fiid, Data.FaceValueFi, Data.FaceValue, Data.AvoirKind); 
           if( DataRate )                                                                       
              if(MediumMarketCost(DataRate)!=0)
                 Err = GetErrMsg();
                 SC_SaveErrorForReport_XML(dl_comm.DocumentID, dl_comm.DocKind, "Ошибка установки курса \""+DL_GetRateTypeName(SP_RATETYPE_RightCost)+"\"" + IIF(Err!="",": "+Err,""), 1, dl_comm.CommCode, avoiriss, DLDOC_ISSUE);
                 /*ak*/
                 errrecs = errrecs + 1;
                 /*~ak*/
              end;                                                                           
           else
//              SC_SaveErrorForReport_XML(dl_comm.DocumentID, dl_comm.DocKind, "Не задан курс вида \""+DL_GetRateTypeName(SP_RATETYPE_MarketPrice)+"\"", 1, dl_comm.CommCode, avoiriss, DLDOC_ISSUE);
              /*ak*/
              errrecs = errrecs + 1;
              /*~ak*/
           end;                                                                                 
           /*ak*/
           recs = recs + 1;
           /*~ak*/
        end;                                                                                    
        UseProgress( Num = Num + 1 );                                                           
     end;                                                                                        
     RemProgress();                                                                              
  end;

  DL_SaveDataForReport_XML(dl_comm.DocumentID, dl_comm.DocKind, ScOpReportLineData, LOG_TYPE_DATA);
  ScOpReportLineData.Size = 0;
  InsertErrorLog_XML(dl_comm.DocumentID, dl_comm.DocKind);
  ClearErrorArr();

  if(dl_comm.CreateReport)
     ScOpPrintReport(dl_comm.DocKind,Comm,true,true);
  end;
                                                                                        
  return 0;

OnError( RslErrObj )
  RemProgress();
  ScOpInsertError( DLDOC_ISSUE, dl_comm, null, 1, RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message );
  /*ak*/
  errmsg = RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message;
  /*~ak*/
  InsertErrorLog_XML(dl_comm.DocumentID, dl_comm.DocKind);
  return 1;
END;
exit(1);
