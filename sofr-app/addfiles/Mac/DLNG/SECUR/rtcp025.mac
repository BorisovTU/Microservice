/*
$Name:         rtcp025.mac
$Module:       Ценные бумаги
$Description:  Операции погашения купона/ ЧП Шаг - Шаг зачисления средств владельцу ц/б
*/
import "sp_cars.mac";

macro ExecuteStep( doc , ticket )
  record  deal(dl_tick);
  var     FD, dat, ВидРО;
  var     rq_money = TRecHandler("dlrq.dbt");

  SetBuff( deal, ticket );
  FD = SPFirstDoc( deal );

  dat = FD.tick.rec.DealDate;

  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERY, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;

  if( ( IsBROKER(FD.Group) ) OR (FD.СделкаОРЦБ()) OR (FD.tick.rec.CarryWrt == UNSET_CHAR))
    if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYMENT, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
      return 1;
    end;

    if(FD.ExistRQMoney(DLRQ_TYPE_PAYMENT))
       if(УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_PAYMENT), DLRQ_STATE_EXEC, dat) != 0)
        return 1;
      end;
    end;
  end;

  return 0;
end;

