/*
$Name:        revision.mac
$Module:      Ценные бумаги
$Description: Процедура проведения ревизии при завершении дня
*/
import "secinter.mac", "mctplprm.mac", "sp_categ.mac", "spserv.mac", "mccatacc.mac", "spRepFun.mac";

private var IsReportRun = false,
            AllErrorCount  = 0,
            AllObjectCount = 0;

private var allPortf = TArray();

private macro PrintHead( RevDate:Date, SubTitle:String )
   if( IsReportRun == false )
      IsReportRun = true;
      println( "\n                       Протокол процедуры ревизии счетов" );
      println( " Дата ревизии: ", RevDate );
   end;

   Message( SubTitle + " ..." );
   println( "\n ", SubTitle, "\n" );
end;

private macro PrintFooter()
   if( IsReportRun == false )
      MsgBoxEX( "В параметрах ревизии не задано ни одного вида проверок.", 0, 0, "Запуск процедуры ревизии", "Запуск процедуры ревизии" );
      exit(1);
   end;
   println();
   println( " Всего проверено: ", AllObjectCount, " объектов" );
   println( " Всего ошибок   : ", AllErrorCount, "\n\n" );
   FooterExecuterSign({oper});
end;

private macro PrintLocalFooter( ErrorNum, ObjectNum, ObjectName )
   println( " Проверено ", ObjectName, ": ", ObjectNum );
   println( " Найдено ошибок: ", ErrorNum, "\n" );
   AllErrorCount  = AllErrorCount  + ErrorNum;
   AllObjectCount = AllObjectCount + ObjectNum;
end;

private macro PrintError( ErrorNum:@Integer )
   var i, curval, StrError = "";

   i = 1;
   while( GetParm(i, curval) )
      StrError = StrError + string(curval);
      i = i + 1;
   end;

[   #########################################################################################

]
(StrError:w);

   ErrorNum = ErrorNum + 1;
   InitError();
end;

private macro ПроверитьОбработкуТО( RevDate:Date )
   var SelectCurRQ, DataSet, QueryCurRQ, /*текущее проверяемое ТО*/
       Deal = TBFile( "dl_tick", "R", 0 ),    /*сделка по CurRQ*/
       CurRQ = TRecHandler("dlrq"),
       Lot  = TRecHandler( "pmwrtsum" );      /*лот по AvrP*/
   var RQNum, ErrorNum = 0, ObjectNum = 0, isback = false, LastRQDocID;

   macro SetError( Error:String )
      var Group, DealKind = "", RQType = "", PartNum = "";

      Group = SP_GetOperationGroup( Deal.rec );

      if( Deal.rec.BofficeKind == DL_SECURITYDOC )
         DealKind = "По сделке \"" + DL_GetKindOperName(Deal.rec.DealType);
      else
         DealKind = "По операции \"" + DL_GetKindOperName(Deal.rec.DealType);
      end;

      RQType = DL_GetNameAlg(7513/*Тип ТО*/, CurRQ.rec.Type);

      if( CurRQ.rec.DealPart == 2 )
         PartNum = " по 1-й части";
      else
         PartNum = " по 2-й части";
      end;

      PrintError( @ErrorNum, DealKind,"\" № ",Deal.rec.DealCode," ТО \"",RQType, "\"", PartNum, " не обработано в срок: ", Error );
   end;

   macro GetDealByRQ()
      ObjectNum = ObjectNum + 1;
      if( LastRQDocID != CurRQ.rec.DocID )
        LastRQDocID = CurRQ.rec.DocID;

        Deal.Clear();
        Deal.rec.DealID = CurRQ.rec.DocID;
        if( not Deal.GetEQ() )
           PrintError( @ErrorNum, "Не найдена сделка по ТО dlrq.ID = ", CurRQ.rec.ID );
           return false;
        end;
      end;
      return true;
   end;
   
   macro CheckLotByAvrRQ()
      if( ПолучитьЛотПоСделке( Deal.rec, PM_WRITEOFF_SUM_UNDEF, Lot, false, null, isback ) )
         if( Lot.rec.State >= PM_WRTSUM_FORM ) /*поставлен и выше*/
            if( (ТОЗакрыто(CurRQ) == false) AND (CurRQ.rec.State != DLRQ_STATE_OVERDUE) )
               SetError( "ТО должно быть исполнено или вынесено на просрочку." );
            end;                          
         elif( (CurRQ.rec.State != DLRQ_STATE_PLAN) AND (CurRQ.rec.State != DLRQ_STATE_DELAYED ) and (CurRQ.rec.State != DLRQ_STATE_EXEC) )
            SetError( "ТО должно быть исполнено или отложено." );
         end;
      else
         if(Deal.rec.ClientID <= 0) // не клиентские сделки
           PrintError( @ErrorNum, "Не найден лот по сделке ", Deal.rec.DealCode );
         end;
         return false;
      end;
      return true;
   end;

   macro CheckRQByDocKind( DocKind:Integer, CheckKindTxt )
      var Num = 0;

      QueryCurRQ = "select rq.* "+
                   "  from ddlrq_dbt rq "+
                   " where rq.t_DocKind = ? "+
                   "   and rq.t_PlanDate = ? "+
                   "   and (   rq.t_Type = " + DLRQ_TYPE_DELIVERY+
                   "        or rq.t_Type = " + DLRQ_TYPE_PAYMENT+
                   "        or rq.t_Type = " + DLRQ_TYPE_AVANCE+
                   "        or rq.t_Type = " + DLRQ_TYPE_DEPOSIT+
                   "       )"; 

      SelectCurRQ = DL_RSDCommand( QueryCurRQ );
      SelectCurRQ.addParam(DocKind);
      SelectCurRQ.addParam(RevDate);

      RQNum = SelectCurRQ.GetCount();

      QueryCurRQ = QueryCurRQ + " order by rq.t_DocID, rq.t_Type";

      DataSet = SelectCurRQ.execute(QueryCurRQ);

      InitProgress( int(RQNum), "Проверка своевременности обработки ТО", CheckKindTxt );
      InitError(); 

      LastRQDocID = -1;
      while( DataSet.MoveNext() )

         DataSet.GetRecord().CopyTo( CurRQ.rec );

         if(CurRQ.rec.DealPart == 2)
            isback = true;
         else
            isback = false;                
         end;

         if( GetDealByRQ() )
            CheckLotByAvrRQ();
         end;

         UseProgress( Num = Num + 1 );
      end;

      RemProgress();

   end;

   PrintHead( RevDate, "Проверка своевременности обработки ТО" );

   CheckRQByDocKind( DL_SECURITYDOC, "Просмотр ТО сделок с ц/б" );
   CheckRQByDocKind( DL_RETIREMENT, "Просмотр ТО погашений ц/б" );

   PrintLocalFooter( ErrorNum, ObjectNum, "ТО" );
end;

private var AvoirissFI;//Bobrov 14.10.08 #106 926
private var wrtcalc    = TRecHandler( "pmwrtsum" );
private var wrtcalc_bpp    = TRecHandler( "pmwrtsum" );
private var AccBuf     = TRecHandler( "account" );

/*Получить остатки бумаг в портфеле на дату */
private macro ОстатокВПортфеле( AvrFI:Object, CalcDate:Date, Portf:Integer, _Amount:@money, _BalanceCost:@money, _NKD:@money, IsBPP:bool )

   if(WRT_TotalCalc(
                  {OperDprt},
                  AvrFI.FIID, 
                  {OurBank},
                  0,  
                  Portf, 
                  CalcDate, time(0,0,0), 
                  date(0,0,0), 
                  wrtcalc,
                  IIF(IsBPP,false,true), 
                  IIF(IsBPP,true,false) 
               )
     )
      _Amount=wrtcalc.rec.Amount;
      _BalanceCost = wrtcalc.rec.BalanceCost;
      _NKD         = wrtcalc.rec.NKDAmount;
   else
      return false;
   end;   

   return true;
end;

private macro GetPortfName( KindPortf:Integer, BPP_:bool, ED_:bool)
   var Name = "", BPP = false, ED = false;

   if( BPP_ != null )
      BPP = BPP_;
   end;

   if( ED_ != null )
      ED = ED_;
   end;

   
   if( KindPortf == KINDPORT_TRADE )
      if( BPP )
         Name = "портфеля ц/б, переданных без прекращения признания из предназначенных для торговли";
      else
         Name = "торгового портфеля";
      end;
   elif( KindPortf == KINDPORT_CONTR )
      if( ED ) 
        Name = "портфеле контрольного участия";
      else
        Name = "портфеля контрольного участия";
      end;
   elif( KindPortf == KINDPORT_SALE )
      if( BPP )
         Name = "портфеля ц/б, переданных без прекращения признания из портфеля для продажи";
      else
         if( ED )
           Name = "портфеле ц/б для продажи";
         else
           Name = "портфеля ц/б для продажи";
         end;
      end;
   elif( KindPortf == KINDPORT_BACK )
      Name = "портфеля ц/б, полученных на возвратной основе";
   elif( KindPortf == KINDPORT_PROMISSORY )
      Name = "портфеля просроченных долговых обязательств";
   elif( KindPortf == KINDPORT_RETIRE )
      if( BPP )
         Name = "портфеля ц/б, переданных без прекращения признания из портфеля удерживаемых до погашения";
      else
         Name = "портфеля ДО, удерживаемых до погашения";
      end;
   elif( KindPortf == KINDPORT_BASICDEBT )
      Name = "портфеля ц/б, переданных из ПВО по сделкам прямого РЕПО";
   end;
   
   return Name;
end;

private macro ОстатокПоПортфелюДляСделки( DealID, Categ, Portf, RevDate, Percent, IsBPP:bool, FIID:integer)
   var FindAccount, Chapter, FaceVal, Role, Discount = false, Acc, AccDS, FD_deal, Query, 
       ЭтоКорзинныйСчет = ((Categ == "Ц/б, Корзина ПВО") or (Categ == "Ц/б, Корзина БПП") or (Categ == "Ц/б, ПВО_БПП, Корзина"));

   FD_deal = SPFirstDoc( LEG_KIND_DL_TICK, DealID );

   if( Percent == NULL )
      Percent = false;
   else
      if(not Percent)
         Discount = true;
      end;
   end;

   AccBuf.Clear();

   if( ((Categ == "Ц/б, ПВО") or (Categ == "Ц/б, Корзина ПВО")) AND (Portf == KINDPORT_BACK) )
      Role = FIROLE_BA;
   elif( (Categ == "Ц/б, ПВО_БПП") or (Categ == "Ц/б, ПВО_БПП, Корзина") )
      Role = GetFIRoleByPortfolio(KINDPORT_BACK, Discount, Percent, IsBPP );
   else
      Role = GetFIRoleByPortfolio(Portf, Discount, Percent, IsBPP );
   end;

   Role = FD_deal.GetBasisFIRole( Role );

   if( ЭтоКорзинныйСчет )
      FD_deal.SetCurPFI(FIID);
   end;
   FaceVal = FD_deal.fininstr.rec.FaceValueFI;

   Acc = DL_RSDCommand();

   Query = " select acd.t_Chapter, acd.t_Account, acd.t_Currency " +
                        " from dmcaccdoc_dbt acd, dmccateg_dbt cat " +
                        " where         cat.t_LevelType = 1 " +
                        "  AND cat.t_Code = ? ";
   if( ЭтоКорзинныйСчет )
      Query = Query +
                        "           AND acd.t_DocKind = ? " +
                        "  AND acd.t_DocID = (select NVL(min(ens.t_id),0) " +
                        "                       from ddl_tick_ens_dbt ens " +
                        "                      where ens.t_dealid = ? " +
                        "                        and ens.t_fiid = acd.t_FIID " +
                        "                     ) ";
   else
      Query = Query +
                        "  AND acd.t_DocKind = ? " +
                        "  AND acd.t_DocID = ? ";
   end;

   Query = Query +
                        "           AND acd.t_CatID = cat.t_ID " +
                        "           AND acd.t_FIRole = ? " +
                        "           AND acd.t_Currency = ? " +
           "             AND acd.t_DepartmentID = ? ";

   Acc.addParam(Categ);

   if( ЭтоКорзинныйСчет )
      Acc.addParam(DL_TICK_ENS_DOC);
      Acc.addParam(FD_deal.tick.rec.DealID);
   else
      Acc.addParam(FD_deal.Kind);
      Acc.addParam(FD_deal.ID);
   end;

   Acc.addParam(Role);
   Acc.addParam(FaceVal);
   Acc.addParam({OperDprt});

   if( ЭтоКорзинныйСчет )
      Query = Query + 
           "             AND acd.t_FIID = ? ";
      Acc.addParam(FIID);
   end;

   AccDS = Acc.execute(Query);
   if( AccDS.movenext() )
      FindAccount = AccDS.Account;
      Chapter     = AccDS.Chapter;
   end;

   if( GetAccount(Chapter,FaceVal,FindAccount,AccBuf,true) )
      return Abs(GetRestAccount(AccBuf.rec, RevDate)); 
   end;  

   return 0;
end;

private macro ОстатокПоПортфелю(FD, Categ, Portf, RevDate, Percent, IsBPP:bool, _Chapter)
   var FindAccount, Chapter = 1, FaceVal, Role;
   var Discount = false;

   if( Percent == NULL )
      Percent = false;
   else
      if(not Percent)
         Discount = true;
      end;
   end;

   AccBuf.Clear();

   Role = GetFIRoleByPortfolio(Portf, Discount, Percent, IsBPP );

   if( _Chapter != null )
      Chapter = _Chapter;
   end;

   if( FD.FindNumberAccount( Categ, FindAccount, true, Role ) )

      if( (Categ == "+Переоценка, ц/б") or 
          (Categ == "-Переоценка, ц/б") or
          (Categ == "+ПО ДК") or
          (Categ == "-ПО ДК") or
          (Categ == "Наш портфель ПКУ, ц/б")
        )
         FaceVal = NATCUR;
      else
         FaceVal = FD.fininstr.rec.FaceValueFI;
      end;
      if( GetAccount(Chapter,FaceVal,FindAccount,AccBuf,true) )
         return Abs(GetRestAccount(AccBuf.rec, RevDate)); 
      end;  
   end;

   return 0;
end;

private macro ExistNOSS( FIID:INTEGER, DealDate:DATE ):BOOL
   var NumInList = "", ValidFromDate = DATE(0,0,0);

   return (    
      (GetMainObjAttr( null, OBJTYPE_AVOIRISS, L_Z( FIID, 10 ), 27, null, null, NumInList, DealDate, ValidFromDate) == true)
      AND (ValidFromDate <= DealDate)
      AND (NumInList == "1")
   );
end;

private macro ПроверитьCчетаУчетаБалСтоим( RevDate:Date )
   var FD, ErrorNum = 0, ObjectNum = 0, AvrNum = 0, Num = 0;   

   macro CheckSumm(AvoirissFI, allPortf, Categ, BPP)
      var Слс, ОстатокНаСчете;
      var pNum = 0, FindAccount;
      var haveError = false;
      var Query = "", Select = "", pmwbpp = "", pmwpvo = "", Select_pvo_bpp = "", pmw_pvo_bpp = "", DealID = 0, OldCateg = "",
          ЭтоКорзинныйСчет = ((Categ == "Ц/б, Корзина ПВО") or (Categ == "Ц/б, Корзина БПП") or (Categ == "Ц/б, ПВО_БПП, Корзина"));

      macro CheckRest(DealID:integer)
         var FaceVal:integer = ALLFININSTR;

         if( Categ == "Наш портфель ПКУ, ц/б" )
            FaceVal = NATCUR;
         else
            FaceVal = AvoirissFI.FaceValueFI;
         end;

         if(abs(ОстатокНаСчете) != abs(Слс))
            PrintError( 
               @ErrorNum, 
               "Для выпуска <", AvoirissFI.FI_Code, ">",
               " <",AvoirissFI.Name, ">",IIF(DealID!=null,", по сделке с ID = "+string(DealID),""), 
               " сумма балансовой стоимости лотов ",
               GetPortfName(allPortf(pNum),BPP), 
               " (", Слс, " ", ПолучитьКодФинИн(FaceVal, FICK_ISOSTRING), ")",
               " не равна остатку счета по категории <" + Categ + "> <", AccBuf.rec.Account,">", 
               " (", ОстатокНаСчете, " ", IIF(AccBuf.rec.Account!="",ПолучитьКодФинИн(AccBuf.rec.Code_Currency, FICK_ISOSTRING),""), ")."
            );      
         end;
         
         if( (ОстатокНаСчете != 0) OR (Слс != 0) )
            AvrNum = AvrNum + 1;
         end;

      end;

      while(pNum<allPortf.Size()) //перебираем портфели

         ОстатокНаСчете = 0; Слс = 0;

         if( (Categ == "Ц/б, БПП") or (Categ == "Ц/б, ПВО") or (Categ == "Ц/б, ПВО_БПП") or ЭтоКорзинныйСчет )
            /*для БПП ищем счет через ПД по лоту->сделке (по выпуску есть один счет БППтп и\или БППппр)*/
            if( (Categ == "Ц/б, БПП") or (Categ == "Ц/б, Корзина БПП") )
               Query = "SELECT t.t_Parent, sum(t.t_Cost) Cost, sum(t.t_NKDAmount) NKDAmount, sum(t.t_BegBonus) BegBonus, sum(t.t_Bonus) Bonus FROM v_scwrthistex t " +   
                       " WHERE t.t_buy_sale = 0 " +
                       "   AND t.t_Party = -1 " +
                       "   AND t.t_dockind = 29 " +  
                       "   AND t.t_kind = 210 " +
                       "   AND t.t_Fiid = ? " +
                       "   AND t.t_instance = (SELECT MAX (t_instance) " +                                                               
                       "                       FROM v_scwrthistex " +
                       "                      WHERE t_sumid = t.t_sumid " +
                       "                        AND t_changedate <= ?) " + 
                       "   AND t.t_state = 3 " +
                       "   AND t.t_portfolio = ? " +
                       "   AND rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(NVL((select tick.t_DealType "+
                       "                                                                                         from ddl_tick_dbt tick, dpmwrtsum_dbt wrtsum " +
                       "                                                                                        where wrtsum.t_SumID = t.t_Parent " +
                       "                                                                                          and tick.t_DealID = wrtsum.t_DealID),0), ?))) ";
               if( ЭтоКорзинныйСчет )
                  Query = Query + " = 1 ";
               else
                  Query = Query + " != 1 ";
               end;

               Query = Query + " group by t.t_Parent ";

               Select = RSDCommand(Query);

               Select.addParam("", RSDBP_IN, AvoirissFI.FIID);
               Select.addParam("", RSDBP_IN, RevDate);
               Select.addParam("", RSDBP_IN, allPortf(pNum));
               Select.addParam("", RSDBP_IN, DL_SECURITYDOC);
               Select.execute();
 
               pmwbpp = TRsbDataSet(Select);
               while( pmwbpp.movenext() )
                  ОстатокНаСчете = $0;

                  Слс = round(SQL_ConvTypeSum(pmwbpp.Cost));

                  if( not ОтдельныйУчетУплНКД() )
                     Слс = Слс + round(SQL_ConvTypeSum(pmwbpp.NKDAmount));
                  end;

                  Слс = Слс - round(SQL_ConvTypeSum(pmwbpp.BegBonus)) + round(SQL_ConvTypeSum(pmwbpp.Bonus));

                  DealID = GetLotFile( SQL_ConvTypeInteger(pmwbpp.Parent),true,false ).rec.DealID;
                  if( DealID > 0 )
                     ОстатокНаСчете = ОстатокПоПортфелюДляСделки(DealID, Categ, allPortf(pNum), RevDate, null, null, AvoirissFI.FIID);
                  end;
                  CheckRest(DealID);
               end;
            elif( (Categ == "Ц/б, ПВО") or (Categ == "Ц/б, Корзина ПВО") ) /*для ПВО счет ищем по ПД по лоту->сделке*/
               Query = "select t.t_BalanceCost, t.t_InterestIncome, t.t_DiscountIncome, t.t_SumID, t.t_DealID " +
                               "     FROM v_scwrthistex t " +
                               " where t.t_Party = -1 " + 
                               " AND t.t_State = 1 " +
                               " and t.t_Amount != 0 " +
                               " and t.t_AmountBD = 0 " +
                               " and t.t_Buy_Sale = 3 " + 
                               " AND t.t_Fiid = ? " +
                               " AND t.t_Portfolio = ? " +
                               " AND t.t_instance =(SELECT MAX (t_instance) " +
                               "                      FROM v_scwrthistex " +
                               "                     WHERE t_sumid = t.t_sumid " +
                               "                       AND t_changedate <= ?) " +
                               " AND rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(NVL((select tick.t_DealType "+
                               "                                                                                       from ddl_tick_dbt tick " +
                               "                                                                                      where tick.t_DealID = t.t_DealID),0), ?))) ";
               if( ЭтоКорзинныйСчет )
                  Query = Query + " = 1 ";
               else
                  Query = Query + " != 1 ";
               end;

               Select = RSDCommand(Query);

               Select.addParam("", RSDBP_IN, AvoirissFI.FIID);
               Select.addParam("", RSDBP_IN, allPortf(pNum));/*KINDPORT_BACK*/
               Select.addParam("", RSDBP_IN, RevDate);
               Select.addParam("", RSDBP_IN, DL_SECURITYDOC);
               Select.execute();
 
               pmwpvo = TRsbDataSet(Select);
               while( pmwpvo.movenext() )

                  ОстатокНаСчете = ОстатокПоПортфелюДляСделки(SQL_ConvTypeInteger(pmwpvo.DealID), Categ, allPortf(pNum), RevDate, null, null, AvoirissFI.FIID);         
                  /*для ПВО стоимость + переоценка учитываются на основном счете вложений*/
                  Слс = round(SQL_ConvTypeSum(pmwpvo.BalanceCost)) - (round(SQL_ConvTypeSum(pmwpvo.InterestIncome)) + round(SQL_ConvTypeSum(pmwpvo.DiscountIncome)));
                  /*ищем те лоты ПВО_БПП, которые образовались путем продажи в ПРЕПО из данного лота ОРЕПО*/
                  Select_pvo_bpp = RSDCommand("SELECT sum(t.t_BALANCECOST) BALANCECOST FROM v_scwrthistex t, dpmwrtlnk_dbt lnk " +
                                  "    where t.t_Party = -1 " + 
                                  "    AND t.t_dockind = ? " +   
                                  "    and t.t_Amount > 0 " +
                                  "    AND t.t_Fiid = ? " +
                                  "    and t.t_instance =(SELECT MAX (t_instance) " +
                                  "                         FROM v_scwrthistex " +
                                  "                        WHERE t_sumid = t.t_sumid " +
                                  "                          AND t_changedate <= ? ) " +
                                  "    and ((t.t_State = ? and t.t_Portfolio = ? ) or" + 
                                  "         (t.t_State = ? and t.t_Portfolio = ? ))" + 
                                  "    and t.t_Buy_Sale = ? " +
                                  "    and lnk.t_BuyID = ? " +
                                  "    and t.t_Source = lnk.t_BuyID "+
                                  "    and lnk.t_SaleID = t.t_Parent ");

                  Select_pvo_bpp.addParam("", RSDBP_IN, DLDOC_PAYMENT);
                  Select_pvo_bpp.addParam("", RSDBP_IN, AvoirissFI.FIID);
                  Select_pvo_bpp.addParam("", RSDBP_IN, RevDate);
                  Select_pvo_bpp.addParam("", RSDBP_IN, PM_WRTSUM_NOTFORM);
                  Select_pvo_bpp.addParam("", RSDBP_IN, KINDPORT_BASICDEBT);
                  Select_pvo_bpp.addParam("", RSDBP_IN, PM_WRTSUM_FORM);
                  Select_pvo_bpp.addParam("", RSDBP_IN, KINDPORT_BACK);
                  Select_pvo_bpp.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY);
                  Select_pvo_bpp.addParam("", RSDBP_IN, pmwpvo.SumID);
                  Select_pvo_bpp.execute();
                 
                  pmw_pvo_bpp = TRsbDataSet(Select_pvo_bpp);
                  while( pmw_pvo_bpp.movenext() )
                     Слс = Слс + round(SQL_ConvTypeSum(pmw_pvo_bpp.BALANCECOST));
                  end;

                  CheckRest(SQL_ConvTypeInteger(pmwpvo.DealID));
               end;
            elif( (Categ == "Ц/б, ПВО_БПП") or (Categ == "Ц/б, ПВО_БПП, Корзина") )
               Query = "SELECT t.t_Parent, sum(t.t_BALANCECOST) BALANCECOST FROM v_scwrthistex t " +
                       " where t.t_Party = -1 " + 
                       "   AND t.t_dockind = ? " +   
                       "   and t.t_State = ? " +
                       "   and t.t_Amount > 0 " +
                       "   AND t.t_Fiid = ? " +
                       "   and t.t_instance =(SELECT MAX (t_instance) " +
                       "                        FROM v_scwrthistex " +
                       "                       WHERE t_sumid = t.t_sumid " +
                       "                         AND t_changedate <= ? ) " +
                       "   and t.t_Portfolio = ? " + 
                       "   and t.t_Buy_Sale = ? " +
                       "   and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(NVL((select tick.t_DealType "+
                       "                                                                                         from ddl_tick_dbt tick, dpmwrtsum_dbt wrtsum " +
                       "                                                                                        where wrtsum.t_SumID = t.t_Parent " +
                       "                                                                                          and tick.t_DealID = wrtsum.t_DealID),0), ?))) ";
               if( ЭтоКорзинныйСчет )
                  Query = Query + " = 1 ";
               else
                  Query = Query + " != 1 ";
               end;

               Query = Query + " group by t.t_Parent ";

               Select = RSDCommand(Query);

               Select.addParam("", RSDBP_IN, DLDOC_PAYMENT);
               Select.addParam("", RSDBP_IN, PM_WRTSUM_NOTFORM);
               Select.addParam("", RSDBP_IN, AvoirissFI.FIID);
               Select.addParam("", RSDBP_IN, RevDate);
               Select.addParam("", RSDBP_IN, allPortf(pNum));/*KINDPORT_BASICDEBT*/
               Select.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY);
               Select.addParam("", RSDBP_IN, DL_SECURITYDOC);
               Select.execute();
 
               pmwbpp = TRsbDataSet(Select);
               while( pmwbpp.movenext() )
                  ОстатокНаСчете = $0;
                  Слс = round(SQL_ConvTypeSum(pmwbpp.BALANCECOST));
                  DealID = GetLotFile( SQL_ConvTypeInteger(pmwbpp.Parent),true,false ).rec.DealID;
                  if( DealID > 0 )
                     ОстатокНаСчете = ОстатокПоПортфелюДляСделки(DealID, Categ, allPortf(pNum), RevDate, null, null, AvoirissFI.FIID);          
                  end;
                  CheckRest(DealID);
               end;
            end;

         else

            haveError = not WRT_TotalCalc(
               {OperDprt},
               AvoirissFI.FIID, 
               {OurBank},
               0,  
               allPortf(pNum), 
               RevDate, time(0,0,0), 
               date(0,0,0), 
               wrtcalc, //BalanceCost
               IIF(BPP,false,true), IIF(BPP,true,false) 
            );
           
            if(haveError)
               PrintError( 
                  @ErrorNum, 
                  "Ошибка при определении стоимости на лицевом счете ", 
                  GetPortfName(allPortf(pNum),BPP) + ", по ",
                  "выпуску " + AvoirissFI.FI_Code 
               );   
            else
               Слс = wrtcalc.rec.Cost;

               if( not ОтдельныйУчетУплНКД() )
                  Слс = Слс + wrtcalc.rec.NKDAmount;
               end;

               Слс = Слс - wrtcalc.rec.BegBonus;

               OldCateg = Categ;
               if( (Categ == "Наш портфель ц/б") and (allPortf(pNum) == KINDPORT_CONTR) and (RevDate >= Date(1,11,2014)) )
                 Categ = "Наш портфель ПКУ, ц/б";
               end;
               ОстатокНаСчете = ОстатокПоПортфелю(FD, Categ, allPortf(pNum), RevDate, false, BPP);
               CheckRest();
               Categ = OldCateg;
            end;

         end;

         pNum = pNum + 1;
      end; /*while*/
   end;   

   private macro ПроверитьПереоценку(AvoirissFI, allPortf, CategPlus, CategMinus)
      
      var Переоценка, OverAmount;
      var pNum=0;
      var haveError = false, haveError_bpp = false;

      while(pNum<allPortf.Size()) //перебираем портфели

         Переоценка = 0;OverAmount=0;
         
         haveError = not WRT_TotalCalc(
                  {OperDprt},
                  AvoirissFI.FIID, 
                  {OurBank},
                  0,  
                  allPortf(pNum), 
                  RevDate, time(0,0,0), 
                  date(0,0,0),
                  wrtcalc,
               true, false);

          haveError_bpp = not WRT_TotalCalc(
               {OperDprt},
               AvoirissFI.FIID, 
               {OurBank},
               0,  
               allPortf(pNum), 
               RevDate, time(0,0,0), 
               date(0,0,0),
               wrtcalc_bpp,
               false, true);
   
         if( haveError )
            PrintError( 
               @ErrorNum, 
               "Ошибка при определении стоимости на лицевом счете ", 
               GetPortfName(allPortf(pNum)) + ", по ",
               "выпуску " + AvoirissFI.FI_Code 
            );
         elif( haveError_bpp )
            PrintError( 
               @ErrorNum, 
               "Ошибка при определении стоимости на лицевом счете ", 
               GetPortfName(allPortf(pNum),true) + ", по ",
               "выпуску " + AvoirissFI.FI_Code 
            );
         else

            OverAmount = wrtcalc.rec.OverAmount + wrtcalc_bpp.rec.OverAmount;

            Переоценка =   ОстатокПоПортфелю(FD, CategPlus,  allPortf(pNum), RevDate) -
                           ОстатокПоПортфелю(FD, CategMinus, allPortf(pNum), RevDate);

            if ( OverAmount != Переоценка )
               PrintError( 
                  @ErrorNum, 
                  "Для выпуска <", AvoirissFI.FI_Code, ">",
                  " <",AvoirissFI.Name, "> ", 
                  "сумма переоценки ",
                  GetPortfName(allPortf(pNum)),
                  " Стек - Слс <", OverAmount, ">",                               
                  " не равно остатку счета по категории <" + CategPlus + "> ",
                  "-  остаток счета по категории <" + CategMinus + ">"
               );
            end;
         end;         

         if( (Переоценка != 0) OR (OverAmount != 0) )
            AvrNum = AvrNum + 1;
         end;

         pNum = pNum + 1; 

      end;
   end;

   macro ПроверитьДоходы(AvoirissFI, allPortf, ПроцентныйДоход, BPP:bool)

      var Начисл, Доход;
      var warn;

      var pNum=0;
      
      while(pNum<allPortf.Size()) //перебираем портфели      

         if( WRT_TotalCalc(
               {OperDprt},
               AvoirissFI.FIID, 
               {OurBank},
               0,  
               allPortf(pNum), 
               RevDate, time(0,0,0), 
               date(0,0,0),
               wrtcalc,
               IIF(BPP,false,true), IIF(BPP,true,false) 
                          )
           )             
            if( ПроцентныйДоход )
               Начисл = wrtcalc.rec.InterestIncome;
               Доход = ОстатокПоПортфелю(FD, "Начисл.ПДД, ц/б",  allPortf(pNum), RevDate, true, BPP);
            else
               Начисл = wrtcalc.rec.DiscountIncome;
               Доход = ОстатокПоПортфелю(FD, "Начисл.ПДД, ц/б",  allPortf(pNum), RevDate, false, BPP);
            end;            

            if ( Начисл != Доход )
                warn = " не равна остатку счета по категории <Начисл.ПДД, ц/б> <" + AccBuf.rec.Account;
                
                if( ПроцентныйДоход )   
                   warn = warn + "> открытом для процентного дохода";
                else
                   warn = warn + "> открытом для дисконтного дохода";
                end;

                PrintError( 
                   @ErrorNum, 
                   "Для выпуска <", AvoirissFI.FI_Code, ">",
                   " <",AvoirissFI.Name, "> ", 
                   " сумма " + IIF(ПроцентныйДоход, "ПДначисл ", "ДДначисл ") +
                   GetPortfName(allPortf(pNum),BPP), 
                   " (", Начисл, " ", ПолучитьКодФинИн(AvoirissFI.FaceValueFI, FICK_ISOSTRING), ")",
                   warn,
                   " (", Доход, " ", ПолучитьКодФинИн(AccBuf.rec.Code_Currency, FICK_ISOSTRING), ")."
                );
            end;

         else
            PrintError( 
               @ErrorNum, 
               "Ошибка при определении стоимости на лицевом счете ", 
               GetPortfName(allPortf(pNum),BPP) + ", по ",
               "выпуску " + AvoirissFI.FI_Code 
            ); 
         end;

         if( (Начисл != 0) OR (Доход != 0) )
            AvrNum = AvrNum + 1;
         end;

         pNum = pNum + 1; 
      end;

   end;

   macro ПроверитьПроблемныеДоходы( AvoirissFI, allPortf )
      var ПДДне_отн = $0.0, Доход = $0.0;

      Доход = ОстатокПоПортфелю(FD, "%Ндоход внебаланс, ц/б",  null, RevDate, null, null, 3);

      var pNum = 0;
      while( pNum < allPortf.Size() ) //перебираем портфели
         if( WRT_TotalCalc( {OperDprt},
                            AvoirissFI.FIID, 
                            {OurBank},
                            0,
                            allPortf(pNum), 
                            RevDate, time(0,0,0),
                            date(0,0,0),
                            wrtcalc,
                            true, false
                          )
           )
            ПДДне_отн = ПДДне_отн + (wrtcalc.rec.NotCarryInterest + wrtcalc.rec.NotCarryDiscount);
         else
            PrintError(@ErrorNum, "Ошибка при определении стоимости на лицевом счете, по выпуску " + AvoirissFI.FI_Code); 
         end;
         pNum = pNum + 1; 
      end;

      if( ПДДне_отн != Доход )
         PrintError( @ErrorNum, 
                     "Для выпуска <" + AvoirissFI.FI_Code + "> <" + AvoirissFI.Name + "> сумма не отнесенного на доходы ПДД" +
                     " (" + ПДДне_отн + " " + ПолучитьКодФинИн(AvoirissFI.FaceValueFI, FICK_ISOSTRING) + ")" +
                     " не равна остатку счета по категории <%Ндоход внебаланс, ц/б> <" + AccBuf.rec.Account + ">" +
                     " (" + Доход + " " + IIF(AccBuf.rec.Account != null, ПолучитьКодФинИн(AccBuf.rec.Code_Currency, FICK_ISOSTRING), "") + ")."
                   );
      end;

      if( (ПДДне_отн != 0) OR (Доход != 0) )
         AvrNum = AvrNum + 1;
      end;
   end;

   macro CheckAvoiriss(AvoirissFI)

      FD = SPFirstDocFI( DLDOC_ISSUE, AvoirissFI.FIID, AvoirissFI.FIID, -1, {OurBank}, null, null, null ); 
         
      /*2.  a)*/
      var i=0;      
      allPortf(i)    = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
      allPortf(i)    = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
      allPortf(i)    = KINDPORT_CONTR;       i=i+1;   /*ПКУ,  Портфель контрольного участия*/
      allPortf(i)    = KINDPORT_PROMISSORY;  i=i+1;   /*ПДО,  Просроченные долговые обязательства*/
      allPortf(i)    = KINDPORT_RETIRE;      i=i+1;   /*ПУДП, Портфель ДО, удерживаемые до погашения*/      

      CheckSumm(AvoirissFI, allPortf, "Наш портфель ц/б", false);

      /*    b)*/
      i=0;
      allPortf.size = 0;
      allPortf(i)    = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
      allPortf(i)    = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
      
      if(ВедениеСчетовБПППоВыпуску() == true)
        CheckSumm(AvoirissFI, allPortf, "Наш портфель ц/б", true);
      else
        CheckSumm(AvoirissFI, allPortf, "Ц/б, БПП", true);
        CheckSumm(AvoirissFI, allPortf, "Ц/б, Корзина БПП", true);
      end;
      
      /*    c)*/
      i=0;
      allPortf.size = 0;
      allPortf(i)  = KINDPORT_BACK;        i=i+1;     /*ПВО,  Портфель ц/б, полученные на возвратной основе*/
      
      CheckSumm(AvoirissFI, allPortf, "Ц/б, ПВО", false);
      CheckSumm(AvoirissFI, allPortf, "Ц/б, Корзина ПВО", false);

      i=0;
      allPortf.size = 0;
      allPortf(i)  = KINDPORT_BASICDEBT;        i=i+1;     /*ОД, Основной долг*/
      
      CheckSumm(AvoirissFI, allPortf, "Ц/б, ПВО_БПП", true);
      CheckSumm(AvoirissFI, allPortf, "Ц/б, ПВО_БПП, Корзина", true);
      
      /*    d)*/
      if( ExistNOSS(AvoirissFI.FIID, RevDate) )
      /*       i*/
         i=0;
         allPortf.size = 0;
         allPortf(i) = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
         allPortf(i) = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
         ПроверитьПереоценку(AvoirissFI, allPortf, "+Переоценка, ц/б", "-Переоценка, ц/б");
      /*       ii*/
         i=0;
         allPortf.size = 0;         
         allPortf(i) = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
         ПроверитьПереоценку(AvoirissFI, allPortf, "+ПО ДК", "-ПО ДК");
      end;
      
      if( FI_IsResponsible(AvoirissFI.FIID, RevDate) )
         /*    e)*/
         /*       i*/
         i=0;
         allPortf.size = 0;
         allPortf(i) = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
         allPortf(i) = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
         allPortf(i) = KINDPORT_RETIRE;      i=i+1;   /*ПУДП, Портфель ДО, удерживаемые до погашения*/
         ПроверитьДоходы(AvoirissFI, allPortf, true, false);

         i=0;
         allPortf.size = 0;
         allPortf(i) = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
         allPortf(i) = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
         ПроверитьДоходы(AvoirissFI, allPortf, true, true);

         /*       ii*/
         i=0;
         allPortf.size = 0;
         allPortf(i) = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
         allPortf(i) = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
         allPortf(i) = KINDPORT_RETIRE;      i=i+1;   /*ПУДП, Портфель ДО, удерживаемые до погашения*/
         ПроверитьДоходы(AvoirissFI, allPortf, false, false);

         i=0;
         allPortf.size = 0;
         allPortf(i) = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
         allPortf(i) = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
         ПроверитьДоходы(AvoirissFI, allPortf, false, true);
         /*       iii*/
      else
         i=0;
         allPortf.size = 0;
         allPortf(i) = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
         allPortf(i) = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
         allPortf(i) = KINDPORT_RETIRE;      i=i+1;   /*ПУДП, Портфель ДО, удерживаемые до погашения*/
         ПроверитьПроблемныеДоходы(AvoirissFI, allPortf);
      end;

      if( AvrNum > 0 )
         ObjectNum = ObjectNum + 1;
         AvrNum = 0;
      end;

   end;

   PrintHead( RevDate, "Проверка соответствия остатков на счетах учета балансовой стоимости остаткам на лотах" );
      
   var queryTxt, querySelect, cmd, cnt = 0;   

   queryTxt =      
      "From " +  
         "DFININSTR_DBT fininstr, davoiriss_dbt avr " +  
      "Where " + 
         "fininstr.T_FI_KIND=? " +
         " and avr.t_FIID = fininstr.t_FIID " +
         "AND ( " + 
            "fininstr.T_EXPIRYDATE = To_Date('01.01.0001','dd.mm.yyyy') " + 
            "OR fininstr.T_EXPIRYDATE>? " + 
         ") " + 
         "AND ( " + 
            "NOT ( fininstr.T_ISSUED = To_Date('01.01.0001','dd.mm.yyyy') ) " + 
            "AND fininstr.T_ISSUED <=? " + 
         ") " + 
         "AND ( ";

   if( CheckTaxDepositoryMode() == false )
      queryTxt = queryTxt + "NOT( avr.T_SPISCLOSED =  '" + SET_CHAR + "' ) ";
   else
      queryTxt = queryTxt + "NOT( fininstr.T_ISCLOSED =  '" + SET_CHAR + "' ) ";
   end;

   queryTxt = queryTxt + "AND NOT( fininstr.T_ISSYS = '" + SET_CHAR + "' ) ) ";

   queryTxt = queryTxt +
            "    and exists( select wrtsum.t_sumid                          " +                      
            "                  from dpmwrtsum_dbt wrtsum                    " +                      
            "                 where wrtsum.t_Department = ?                 " +                      
            "                   and wrtsum.t_Party = -1 "+/*только собственные (см. CheckAvoiriss)*/          
            "                   and wrtsum.t_FIID       = fininstr.t_FIID   " +
            "                   and wrtsum.t_Date <= ? "+
            "                   and (wrtsum.t_portfolio = ? or "+
            "                        wrtsum.t_portfolio = ? or "+
            "                        wrtsum.t_portfolio = ? or "+
            "                        wrtsum.t_portfolio = ? or "+
            "                        wrtsum.t_portfolio = ? or "+
            "                        wrtsum.t_portfolio = ? "+
            "                       ) "+
            "              ) ";                     

   querySelect = "Select count(1) as cnt " + queryTxt; 
   cmd = RSDCommand(querySelect);
   
   cmd.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, {OperDprt});
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, KINDPORT_TRADE);
   cmd.addParam("", RSDBP_IN, KINDPORT_SALE);
   cmd.addParam("", RSDBP_IN, KINDPORT_CONTR);
   cmd.addParam("", RSDBP_IN, KINDPORT_PROMISSORY);
   cmd.addParam("", RSDBP_IN, KINDPORT_RETIRE);
   cmd.addParam("", RSDBP_IN, KINDPORT_BACK);

   cmd.execute();

   AvoirissFI = TRsbDataSet(cmd);
   if(AvoirissFI.MoveNext())
      cnt = AvoirissFI.cnt;
   end;

   InitProgress( int(cnt), "Проверка соответствия остатков на счетах учета балансовой стоимости остаткам на лотах", "Просмотр ценных бумаг" );

   querySelect = "Select fininstr.* " + queryTxt;

   cmd = RSDCommand(querySelect);

   cmd.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, {OperDprt});
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, KINDPORT_TRADE);
   cmd.addParam("", RSDBP_IN, KINDPORT_SALE);
   cmd.addParam("", RSDBP_IN, KINDPORT_CONTR);
   cmd.addParam("", RSDBP_IN, KINDPORT_PROMISSORY);
   cmd.addParam("", RSDBP_IN, KINDPORT_RETIRE);
   cmd.addParam("", RSDBP_IN, KINDPORT_BACK);

   cmd.execute();

   AvoirissFI = TRsbDataSet(cmd);   

   while(AvoirissFI.MoveNext()) 
      InitError(); 
      CheckAvoiriss(AvoirissFI);
      UseProgress( Num = Num + 1 );
   end;

   RemProgress();

   PrintLocalFooter( ErrorNum, ObjectNum, "выпусков" );
end;

private macro ПоверитmКорректностьНахожденияБумагВпортфелях(RevDate)

   var ErrorNum = 0, ObjectNum = 0;

   macro CheckLot(AvoirissFI, Portf, allPortf, RevDate, BPP:bool)

      var pNum = 0;
      
      if(
            WRT_TotalCalc(
               {OperDprt},
               AvoirissFI.FIID, 
               {OurBank},
               0,  
               Portf, 
               RevDate, time(0,0,0), 
               date(0,0,0),
               wrtcalc,
               true, false 
            )
            AND
            (wrtcalc.rec.Amount > 0)
        )

         while(pNum<allPortf.Size()) //перебираем портфели
            if(
               WRT_TotalCalc(
                  {OperDprt},
                  AvoirissFI.FIID, 
                  {OurBank},
                  0,  
                  allPortf(pNum), 
                  RevDate, time(0,0,0), 
                  date(0,0,0),
                  wrtcalc,
                  IIF(BPP,false,true), IIF(BPP,true,false) 
               )
               AND
               (wrtcalc.rec.Amount > 0)
            )
               PrintError( 
                  @ErrorNum, 
                  "Лот выпуска <", AvoirissFI.FI_Code, ">",
                  " <",AvoirissFI.Name, "> ", 
                  " одновременно находится в ", GetPortfName(Portf,false,true), " и в ",
                  GetPortfName(allPortf(pNum),BPP,true) 
               );              
            end;
            
            pNum = pNum + 1;
            
         end;      
      end;
   end;
   
   macro CheckAvoiriss(AvoirissFI)
         
      var i=0;
   
      allPortf(i)  = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
      allPortf(i)  = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
      allPortf(i)  = KINDPORT_PROMISSORY;  i=i+1;   /*ПДО,  Просроченные долговые обязательства*/
      allPortf(i)  = KINDPORT_RETIRE;      i=i+1;   /*ПУДП, Портфель ДО, удерживаемые до погашения*/
      allPortf(i)  = KINDPORT_BACK;        i=i+1;   /*ПВО,  Портфель ц/б, полученные на возвратной основе*/
      allPortf(i)  = KINDPORT_TRUST;       i=i+1;   /*ПДУ,  Портфель ДУ*/
      allPortf(i)  = KINDPORT_BASICDEBT;   i=i+1;   /*ОД,   Основной долг*/

      CheckLot(AvoirissFI, KINDPORT_CONTR, allPortf, RevDate, false);      

      i=0;
      allPortf.size = 0;
      allPortf(i)  = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
      allPortf(i)  = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
      CheckLot(AvoirissFI, KINDPORT_CONTR, allPortf, RevDate, true);      

      i=0;
      allPortf.size = 0;
      allPortf(i)  = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
      allPortf(i)  = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
      allPortf(i)  = KINDPORT_CONTR;       i=i+1;   /*ПКУ,  Портфель контрольного участия*/
      allPortf(i)  = KINDPORT_RETIRE;      i=i+1;   /*ПУДП, Портфель ДО, удерживаемые до погашения*/
      allPortf(i)  = KINDPORT_BACK;        i=i+1;   /*ПВО,  Портфель ц/б, полученные на возвратной основе*/
      allPortf(i)  = KINDPORT_TRUST;       i=i+1;   /*ПДУ,  Портфель ДУ*/
      allPortf(i)  = KINDPORT_BASICDEBT;   i=i+1;   /*ОД,   Основной долг*/

      CheckLot(AvoirissFI, KINDPORT_PROMISSORY, allPortf, RevDate, false);     

      i=0;
      allPortf.size = 0;
      allPortf(i)  = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
      allPortf(i)  = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/
      CheckLot(AvoirissFI, KINDPORT_PROMISSORY, allPortf, RevDate, true);      

   end;

   PrintHead( RevDate, "Проверка корректности нахождения бумаг в портфелях" );
      
   var queryTxt, querySelect, cmd, cnt = 0;   
   var Num = 0;

   queryTxt =  
      "select T.T_FIID, fininstr.t_Fi_Code, fininstr.t_Name " +
      "From " +  
         "DFININSTR_DBT fininstr, davoiriss_dbt avr, v_scwrthistex t " +  
      "Where " + 
         "fininstr.T_FI_KIND=? " + 
         " and avr.t_FIID = fininstr.t_FIID " +
         "AND ( " + 
            "fininstr.T_EXPIRYDATE = To_Date('01.01.0001','dd.mm.yyyy') " + 
            "OR fininstr.T_EXPIRYDATE>? " + 
         ") " + 
         "AND ( " + 
            "NOT ( fininstr.T_ISSUED = To_Date('01.01.0001','dd.mm.yyyy') ) " + 
            "AND fininstr.T_ISSUED <=? " + 
         ") " + 
         "AND ( ";

   if( CheckTaxDepositoryMode() == false )
      queryTxt = queryTxt + "NOT( avr.T_SPISCLOSED =  '" + SET_CHAR + "' ) ";
   else
      queryTxt = queryTxt + "NOT( fininstr.T_ISCLOSED =  '" + SET_CHAR + "' ) ";
   end;

   queryTxt = queryTxt + "AND NOT( fininstr.T_ISSYS = '" + SET_CHAR + "' ) ) "+
                         " AND fininstr.t_FIID = T.T_FIID " + 
                         " AND t.t_buy_sale = ? " +  
                         " AND t.t_party = -1 " +   
                         " AND t.t_dockind in(?,?,?) " +
                         " AND t.t_dealid > 0 " +   
                         " and t.t_kind in(20,210,40,110,130,90) " +
                         " and t.t_Amount != 0 "+
                         " AND t.t_state = ? " +    
                         " and t.t_instance = (SELECT MAX (t_instance) " +
                         "                       FROM v_scwrthistex " +
                         "                      WHERE t_sumid = t.t_sumid " +
                         "                        AND t_changedate <= ?) "+
                         " and t.t_Portfolio in (?,?) "+
                         " group by T.T_FIID, fininstr.t_Fi_Code, fininstr.t_Name";

   querySelect = "Select count(*) as cnt from (" + queryTxt+")"; 
   cmd = RSDCommand(querySelect);
   
   cmd.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY);
   cmd.addParam("", RSDBP_IN, DLDOC_PAYMENT);
   cmd.addParam("", RSDBP_IN, DL_ISSUE_UNION);
   cmd.addParam("", RSDBP_IN, DL_MOVINGDOC);
   cmd.addParam("", RSDBP_IN, PM_WRTSUM_FORM);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, KINDPORT_CONTR);
   cmd.addParam("", RSDBP_IN, KINDPORT_PROMISSORY);

   cmd.execute();
                                                    
   AvoirissFI = TRsbDataSet(cmd);
   if(AvoirissFI.MoveNext())
      cnt = AvoirissFI.cnt;
   end;

   InitProgress( int(cnt), "Проверка корректности нахождения бумаг в портфелях", "Просмотр ценных бумаг" );

   querySelect = queryTxt;

   cmd = RSDCommand(querySelect);

   cmd.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY);
   cmd.addParam("", RSDBP_IN, DLDOC_PAYMENT);
   cmd.addParam("", RSDBP_IN, DL_ISSUE_UNION);
   cmd.addParam("", RSDBP_IN, DL_MOVINGDOC);
   cmd.addParam("", RSDBP_IN, PM_WRTSUM_FORM);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, KINDPORT_CONTR);
   cmd.addParam("", RSDBP_IN, KINDPORT_PROMISSORY);

   cmd.execute();

   AvoirissFI = TRsbDataSet(cmd);   

   while(AvoirissFI.MoveNext()) 
      InitError(); 
      CheckAvoiriss(AvoirissFI);
      ObjectNum = ObjectNum + 1;
      UseProgress( Num = Num + 1 );
   end;

   RemProgress();
   PrintLocalFooter( ErrorNum, ObjectNum, "выпусков" );
   
end;

private macro ПроверитьCчетаСНулевымОстатком( RevDate:Date )
   var mcaccdoc, Sql, SqlQuery, SqlNRec, SqlNRecData;
   var ErrorNum = 0, ObjectNum = 0, NumAccDoc = 0, Num = 0;

   SqlQuery  = 
             "  SELECT acc.t_Account, acc.t_Code_Currency, acc.t_Chapter, CATEG.T_CODE, "+
             "         rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, null) rest "+
             "    FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ, daccount_dbt acc "+                                                                                    
             "   WHERE CATEG.T_LEVELTYPE = 1 "+                                                                                                                           
             "     and (CATEG.T_CODE = '+За ц/б' or "+                                                                                                                    
             "          CATEG.T_CODE = '-За ц/б' or "+                                                                                                                    
             "          CATEG.T_CODE = '+Биржа' or "+                                                                                                                      
             "          CATEG.T_CODE = '-Биржа' or "+                                                                                                                     
             "          CATEG.T_CODE = 'Реализация, ц/б' or "+                                                                                                            
             "          CATEG.T_CODE = 'Торговый счет, ц/б' "+                                                                                                            
             "         ) "+                                                                                                                                               
             "     and ACCDOC.T_CATID = CATEG.T_ID "+                                                                                                                     
             "     and ACCDOC.T_ISCOMMON = 'X' "+                                                                                                                         
             "     and ACCDOC.T_ACCOUNT = ACC.T_ACCOUNT "+                                                                                                                
             "     and ACCDOC.T_CURRENCY = ACC.T_CODE_CURRENCY "+                                                                                                         
             "     and ACCDOC.T_CHAPTER = ACC.T_CHAPTER "+                                                                                                                
             "     and case when CATEG.T_CODE = 'Торговый счет, ц/б' then ACC.T_BALANCE else '30404' end = '30404' "+                                                     
             "     group by CATEG.T_CODE, acc.t_Account, acc.t_Chapter, acc.t_Code_Currency "+                                                                                          
             "     having abs(rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, null)) > 0 ";                                           

   PrintHead( RevDate, "Проверка оcтатков счетов, которые должны быть нулевыми на конец дня" );

   Sql = RSDCommand(SqlQuery);
   SqlNRec = RSDCommand("select count(1) NRec from ("+SqlQuery+")");

   Sql.addParam("", RSDBP_IN, RevDate);
   Sql.addParam("", RSDBP_IN, RevDate);
   Sql.addParam("", RSDBP_IN, RevDate);
   Sql.addParam("", RSDBP_IN, RevDate);

   SqlNRec.addParam("", RSDBP_IN, RevDate);
   SqlNRec.addParam("", RSDBP_IN, RevDate);
   SqlNRec.addParam("", RSDBP_IN, RevDate);
   SqlNRec.addParam("", RSDBP_IN, RevDate);

   Sql.execute();
   SqlNRec.execute();

   SqlNRecData = TRsbDataSet(SqlNRec);
   mcaccdoc = TRsbDataSet(Sql);

   if( SqlNRecData.MoveNext() )
      NumAccDoc = int(SqlNRecData.Nrec);
   end;

   InitError(); 
   InitProgress( NumAccDoc, "Проверка оcтатков счетов, которые должны быть нулевыми на конец дня", "Просмотр счетов" );
   while( mcaccdoc.MoveNext() )
      ObjectNum = ObjectNum + 1;
      PrintError( @ErrorNum, "Остаток счета <", mcaccdoc.Account,
                  "> по категории <", mcaccdoc.Code, 
                  "> не равен нулю ", "(", mcaccdoc.Rest, " ", 
                  ПолучитьКодФинИн( mcaccdoc.Code_Currency, FICK_ISOSTRING), ")"
                );
      UseProgress( Num = Num + 1 );
   end;
   RemProgress();

   PrintLocalFooter( ErrorNum, ObjectNum, "счетов" );
end;

private macro ПроверитьИсполнениеПереоценки( RevDate:Date )
   var ErrorNum = 0, ObjectNum = 0, Num = 0;   

   macro ПроверитьПереоценку(AvoirissFI, Portf, RevDate, IsBPP:bool)
      
      var DocumentID,
          PrevPrice = 0.0, CurPrice = 0.0, Amount = $0;

      var fininstr = TRecHandler( "fininstr" );
 
      var Oprstep;
      var queryTxt, cmd;
      var cnt;

      /*для ТП (БППтп) переоценка должна быть всегда (вне зависимости от признака НОСС)
        Для ППР (БППппр) переоценка есть только если есть признак НОСС*/
      if( Portf == KINDPORT_SALE )
         if( not ExistNOSS(AvoirissFI.FIID, RevDate) )
            return false;
         end;
      end;

      if( not ОстатокВПортфеле( AvoirissFI, RevDate, Portf, BUYGOAL_UNDEF, @Amount, null, IsBPP) )
         PrintError( @ErrorNum, "Ошибка при определении остатка ц/б ", AvoirissFI.FI_Code );
         return false;
      end;

      if( Amount != 0 )
         ObjectNum = ObjectNum + 1;

         /*Рыночная цена за предыдущую дату*/
         if( not SmartConvertSumDbl( PrevPrice, 1.0, RevDate-1, AvoirissFI.FIID, AvoirissFI.FaceValueFI, false, SP_RATETYPE_RightCost ))
            PrevPrice = 0.0;
            InitError();
         end;

         /*Рыночная цена за текущую дату*/
         if( not SmartConvertSumDbl( CurPrice, 1.0, RevDate, AvoirissFI.FIID, AvoirissFI.FaceValueFI, false, SP_RATETYPE_RightCost ) )
            PrintError( @ErrorNum, "Ошибка при получении информации о котировке ц/б ", AvoirissFI.FI_Code, " на дату ", RevDate );
            return false;
         end;        

         if( CurPrice != PrevPrice )
            /*Должна быть переоценка*/
            if(ПолучитьФинИн( AvoirissFI.rec.FIID, fininstr ) != 0)
              PrintError( @ErrorNum,"Не найдена анкета выпуска ц/б с кодом ", AvoirissFI.FI_Code);
              return false;
            end;

            DocumentID = UniID( fininstr, 0, DLDOC_ISSUE );

            cnt = 0;
            queryTxt = 
               "Select count(oprstep.T_ID_OPERATION) as cnt " +
               "From " +
                  "DOPRSTEP_DBT oprstep, " +
                  "DOPROPER_DBT oproper " +
               "Where " +
                  "oproper.t_DocKind=? " +
                  "AND oproper.t_DocumentID=? " +
    
                  "AND oprstep.t_ID_operation=oproper.t_ID_operation " +
                  "AND oprstep.t_IsExecute='" + SET_CHAR + "' " + 
                  "AND oprstep.t_Plan_date=oproper.t_Start_Date " +
                  "AND oprstep.t_ServDocKind=? " +
                  "AND oprstep.t_Fact_Date>=? ";

            cmd = RSDCommand(queryTxt);
   
            cmd.addParam("", RSDBP_IN, DLDOC_ISSUE);
            cmd.addParam("", RSDBP_IN, DocumentID);
            cmd.addParam("", RSDBP_IN, DL_OVERVALUE);
            cmd.addParam("", RSDBP_IN, RevDate);

            cmd.execute();

            Oprstep = TRsbDataSet(cmd);
            if(Oprstep.MoveNext())
               cnt = Oprstep.cnt;
            end;

            if( cnt == 0 )
               PrintError( @ErrorNum, "Для выпуска <", AvoirissFI.FI_Code, "> <", AvoirissFI.Name, "> ",
                           "изменилась ТСС ", 
                           " (", PrevPrice, " ", ПолучитьКодФинИн(AvoirissFI.FaceValueFI, FICK_ISOSTRING), 
                           " за ", RevDate-1, ")",
                           " (", CurPrice, " ", ПолучитьКодФинИн(AvoirissFI.FaceValueFI, FICK_ISOSTRING), 
                           " за ", RevDate, ")",
                           ". Должна быть выполнена операция переоценки."
                         );
               return false;
            end;
         end;
      end;

      return true;
   end;

   macro CheckAvoiriss()      

      var pNum = 0, i;

      i=0;
      allPortf.size = 0;      
      allPortf(i)  = KINDPORT_TRADE;       i=i+1;   /*ТП,   Торговый портфель*/
      allPortf(i)  = KINDPORT_SALE;        i=i+1;   /*ППР,  Портфель ц/б для продажи*/

      while( pNum < allPortf.size() )
         if(not ПроверитьПереоценку(AvoirissFI, allPortf(pNum), RevDate, false))
            break;
         end;
         pNum = pNum + 1;
      end;

      pNum = 0;
      /*проверка БПП*/
      while( pNum < allPortf.size() )
         if(not ПроверитьПереоценку(AvoirissFI, allPortf(pNum), RevDate, true))
            break;
         end;
         pNum = pNum + 1;
      end;

   end;

   PrintHead( RevDate, "Проверка корректности нахождения бумаг в портфелях" );
      
   var queryTxt, querySelect, cmd, cnt = 0;   

   queryTxt =      
      "From " +  
         "DFININSTR_DBT fininstr, davoiriss_dbt avr " +  
      "Where " + 
         "fininstr.T_FI_KIND=? " + 
         " and avr.t_FIID = fininstr.t_FIID " +
         "AND ( " + 
            "fininstr.T_EXPIRYDATE = To_Date('01.01.0001','dd.mm.yyyy') " + 
            "OR fininstr.T_EXPIRYDATE>? " + 
         ") " + 
         "AND ( " + 
            "NOT ( fininstr.T_ISSUED = To_Date('01.01.0001','dd.mm.yyyy') ) " + 
            "AND fininstr.T_ISSUED <=? " + 
         ") " + 
         "AND ( ";

   if( CheckTaxDepositoryMode() == false )
      queryTxt = queryTxt + "NOT( avr.T_SPISCLOSED =  '" + SET_CHAR + "' ) ";
   else
      queryTxt = queryTxt + "NOT( fininstr.T_ISCLOSED =  '" + SET_CHAR + "' ) ";
   end;

   queryTxt = queryTxt + "AND NOT( fininstr.T_ISSYS = '" + SET_CHAR + "' ) ) ";

   /*собственные и по нашему филиалу как в ОстатокВПортфеле*/
   queryTxt = queryTxt +
            "    and exists( select wrtsum.t_sumid                          " +                      
            "                  from dpmwrtsum_dbt wrtsum                    " +                      
            "                 where wrtsum.t_Department = ?                 " +
            "                   and wrtsum.t_Party = -1 "+          
            "                   and wrtsum.t_FIID       = fininstr.t_FIID   " +
            "                   and wrtsum.t_Date <= ? "+
            "                   and (wrtsum.t_portfolio = ? or "+
            "                        wrtsum.t_portfolio = ? "+
            "                       ) "+
            "              ) ";                     

   querySelect = "Select count(*) as cnt " + queryTxt; 
   cmd = RSDCommand(querySelect);
   
   cmd.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, {OperDprt});
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, KINDPORT_TRADE);
   cmd.addParam("", RSDBP_IN, KINDPORT_SALE);

   cmd.execute();

   AvoirissFI = TRsbDataSet(cmd);
   if(AvoirissFI.MoveNext())
      cnt = AvoirissFI.cnt;
   end;

   PrintHead( RevDate, "Проверка исполнения операций переоценки" );
   InitProgress( int(cnt), "Проверка исполнения операций переоценки", "Просмотр ценных бумаг" );

   querySelect = "Select fininstr.* " + queryTxt;

   cmd = RSDCommand(querySelect);

   cmd.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, {OperDprt});
   cmd.addParam("", RSDBP_IN, RevDate);
   cmd.addParam("", RSDBP_IN, KINDPORT_TRADE);
   cmd.addParam("", RSDBP_IN, KINDPORT_SALE);

   cmd.execute();

   AvoirissFI = TRsbDataSet(cmd);   

   while(AvoirissFI.MoveNext()) 
      InitError(); 
      CheckAvoiriss();
      UseProgress( Num = Num + 1 );
   end;

   RemProgress();

   PrintLocalFooter( ErrorNum, ObjectNum, "выпусков" );
end;

private macro ПроверитьСрочность( RevDate:Date )
   var FD, Num = 0, ErrorNum = 0, ObjectNum = 0, PartNum = "";
   var КатУчетаТреб = "+Форвард, дрейф", 
       КатУчетаОбяз = "-Форвард, дрейф";

   var pmwrtsum;
   var Period = TRecHandler( "mcperiod" );
   var СчетУчетаТреб = TRecHandler("account");
   var СчетУчетаОбяз = TRecHandler("account");

   macro CheckAccount( CategCode, Acc, FIRole, ObjName )
      var stat, TransfDate, DateBegin, ActualDate;

      /*дата актуализации счетов "Форвард". Для первой части (или сделок без обр.
        части) - дата сделки, для второй - дата учета первой части*/
      if( FD.IsBack == true ) 
         ActualDate = FD.DateArray[DATE_DEALOUTBAL_2];
      else
         ActualDate = FD.DateArray[DATE_DEALDATE];
      end;
      DateBegin = FD.GetParametr(MC_TYPE_PARAMETR_FINDATE, ActualDate, CategCode, FD.GetBasisFiRole(FIRole) );
      stat = НужноПереноситьПоСрокам( FD, CategCode, ActualDate, DateBegin, FD.ID, Acc.rec.Code_Currency, FD.GetBasisFIRole(FIRole), TransfDate, null, Period );

      if( (stat == true) AND (TransfDate <= RevDate) )
         PrintError( @ErrorNum,"Для", ObjName, PartNum, "сделки ", FD.tick.rec.DealCode, 
                     " не выполнен перенос на счет, соответствующий сроку до даты исполнения <",
                     Period.rec.Name, ">."
                   );
      end;
      InitError();
   end;

   var queryTxt, querySelect, cmd, cnt = 0;   

   queryTxt =
      "Select tick.t_DealID, rq.t_Type, rq.t_DealPart "+      
      "From DPMWRTSUM_DBT pmwrtsum, ddl_tick_dbt tick, ddlrq_dbt rq " + 
      "Where " + 
         "pmwrtsum.t_StateDate=? " + 
         "AND NOT(pmwrtsum.t_DealID=0) " + 
         "AND pmwrtsum.t_DocKind=? " +
         "AND tick.t_BofficeKind = ? "+
         "AND rq.t_ID = pmwrtsum.t_DocID "+
         "AND tick.t_BofficeKind = rq.t_DocKind "+
         "AND tick.t_DealID = rq.t_DocID "+
      " group by tick.t_DealID, rq.t_Type, rq.t_DealPart "+
      "Order by pmwrtsum.t_StateDate DESC ";

   cmd = DL_RSDCommand(queryTxt);
   
   cmd.addParam(RevDate);
   cmd.addParam(DLDOC_PAYMENT);
   cmd.addParam(DL_SECURITYDOC);

   cnt = cmd.GetCount();

   PrintHead( RevDate, "Проверка соответствия внебалансовых счетов срокам исполнения сделок" );
   InitProgress( int(cnt), "Проверка соответствия внебалансовых счетов срокам исполнения сделок", "Просмотр лотов срочных сделок" );

   pmwrtsum = cmd.execute();

   while(pmwrtsum.MoveNext())    
      
      ObjectNum = ObjectNum + 1;
      InitError();

      FD = SPFirstDoc( LEG_KIND_DL_TICK, pmwrtsum.DealID );
      if( FD.ВидСрочностиСделки() == СделкаНеРанееТретьегоДня )
         if( not FD.IsExistAccount( КатУчетаТреб, null, null, FIROLE_FIREQ, СчетУчетаТреб, null, RevDate) ) 
            PrintError( @ErrorNum,"Не создан счет по категории ", КатУчетаТреб, " по сделке ", FD.tick.rec.DealCode );
         elif( not FD.IsExistAccount( КатУчетаОбяз, null, null, FIROLE_FICOM, СчетУчетаОбяз, null, RevDate) )
            PrintError( @ErrorNum,"Не создан счет по категории ", КатУчетаОбяз, " по сделке ", FD.tick.rec.DealCode );
         else
            if( FD.ExistBack )
               if( pmwrtsum.DealPart == 1 )
                  PartNum = " по 1-й части ";
               else
                  PartNum = " по 2-й части ";
               end;
            end;

            CheckAccount( КатУчетаТреб, СчетУчетаТреб, FIROLE_FIREQ, " требования " );
            CheckAccount( КатУчетаОбяз, СчетУчетаОбяз, FIROLE_FICOM, " обязательства " );
         end;
      end;

      UseProgress( Num = Num + 1 );
   end;

   RemProgress();
   PrintLocalFooter( ErrorNum, ObjectNum, "сделок" );
end;

macro ReportRun( RevDate:date, Flag_1: bool, Flag_2: bool, Flag_3: bool, Flag_4: bool, Flag_5: bool, Flag_6: bool)

   /*Проверить обработку ТО*/
   if( Flag_1 == true ) 
      ПроверитьОбработкуТО( RevDate );
   end;

   /*Проверить остатки на счетах учета балансовой стоимости*/
   if( Flag_2 == true ) 
      ПроверитьCчетаУчетаБалСтоим( RevDate );
   end;

   /*Проверка корректности нахождения бумаг в портфелях*/
   if( Flag_3 == true ) 
      ПоверитmКорректностьНахожденияБумагВпортфелях(RevDate);
      /*ПроверитьCчетаУчетаНКД( RevDate );*/
   end;

   /*Проверить оcтатки на счетах на которых должен быть нулевой остаток на конец дня*/
   if( Flag_4 == true ) 
      ПроверитьCчетаСНулевымОстатком( RevDate );
   end;

   /*Проверить исполнение операции переоценки*/
   if( Flag_5 == true ) 
      ПроверитьИсполнениеПереоценки( RevDate );
   end;

   /*Проверить срочность внебалансовых счетов*/
   if( Flag_6 == true ) 
      ПроверитьСрочность( RevDate );
   end;

   PrintFooter();
end;
