/*
$Name:        BrokerRepRSHB_Report.mac
$Module:      Ценные бумаги
$Description: Отчет брокера РСХБ. 
              Формирование отчета.
*/

import "BrokerRepRSHB_Common.mac";

private macro GetErrMailTempl(TemplID:integer, err:@variant)
   var cmd = RSDCommand("begin RSB_BRKREP_RSHB.GetErrMailTempl(:TemplID, :Subject, :Body, :err); end;");
   cmd.AddParam("TemplID", RSDBP_IN,  TemplID);
   cmd.AddParam("Subject", RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("Body",    RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("err",     RSDBP_OUT, V_INTEGER);
   cmd.NullConversion = true;
   cmd.Execute();

   if (cmd.Value("err") == 0)
      return CBrokerRepRSHBErrMail( iif(ValType(cmd.Value("Subject")) == V_STRING, cmd.Value("Subject"), ""),
                                    iif(ValType(cmd.Value("Body")) == V_STRING, cmd.Value("Body"), ""));
   else
      err = "Не удалось получить шаблон письма для отправки сообщения об ошибке";
      return NULL;
   end;
onerror(er)
   err = GetLargeErrorMessage(er);
   return NULL;
end;

PRIVATE CLASS СBrokerRepRSHB_DlContrData(_DlContrID:integer, _BegDate:date, _EndDate:date, _ServKind:integer, _ServKindSub:integer, _MarketID:integer)
  PRIVATE VAR m_DlContrID   = _DlContrID;
  PRIVATE VAR m_BegDate     = _BegDate;
  PRIVATE VAR m_EndDate     = _EndDate;
  PRIVATE VAR m_ServKind    = IIF(_ServKind == NULL, 0, _ServKind);
  PRIVATE VAR m_ServKindSub = IIF(_ServKindSub == NULL, 0, _ServKindSub);
  PRIVATE VAR m_MarketID    = IIF(_MarketID == NULL, -1, _MarketID);
  PRIVATE VAR m_sa = TRecHandler( "settacc.dbt" );
  PRIVATE VAR m_dlcontr = TBFile("dlcontr.dbt");

  PRIVATE VAR m_IsEDP       = false;
  PRIVATE VAR m_ShortName   = "";
  PRIVATE VAR m_ClientCode  = "";
  PRIVATE VAR m_ContrDate   = date(0,0,0);
  PRIVATE VAR m_ContrNumber = "";
  PRIVATE VAR m_DepoAcc = "";
  PRIVATE VAR m_DepoPart = "";

  PRIVATE VAR m_accArr  = TArray();
  PRIVATE VAR m_ind = 0;
  
  MACRO Load()
    var cmd, query, DataSet;
    var i = 0;

    m_dlcontr.Clear();
    m_dlcontr.rec.DlContrID = m_DlContrID;
    m_dlcontr.GetEQ();

    m_DepoAcc  = readNoteForObject(OBJTYPE_BROKERCONTR_DL, UniID(m_dlcontr, OBJTYPE_BROKERCONTR_DL), 101 /*Счет Депо Владельца*/, m_EndDate );
    m_DepoAcc = IIF(ValType(m_DepoAcc)==V_UNDEF, "", m_DepoAcc);

    m_DepoPart = readNoteForObject(OBJTYPE_BROKERCONTR_DL, UniID(m_dlcontr, OBJTYPE_BROKERCONTR_DL), 105 /*Раздел счета Депо Владельца*/, m_EndDate );
    m_DepoPart = IIF(ValType(m_DepoPart)==V_UNDEF, "", m_DepoPart);

    query =   " select pt.t_ShortName, "
            + "        NVL(sf.t_DateConc, "+GetSQLDate(date(0,0,0))+") as ContrDate, "
            + "        NVL(sf.t_Number, CHR(1)) as ContrNumber, "
/*            + "        NVL((select objcode.t_Code "
            + "               from dobjcode_dbt objcode "
            + "              where objcode.t_ObjectType = " + OBJTYPE_PARTY
            + "                and objcode.t_CodeKind = " + PTCK_CONTR
            + "                and objcode.t_ObjectID = pt.t_PartyID "
            + "                and objcode.t_State = 0 "
            + "            ), CHR(1)) as ClientCode, "  */
            + "        NVL((select objcode.t_Code "
            + "               from ddlobjcode_dbt objcode "
            + "              where objcode.t_ObjectType = " + 207
            + "                and objcode.t_CodeKind = " + 1
            + "                and objcode.t_ObjectID = dlc.t_DlcontrID "
//            + "                and objcode.t_State = 0 "
            + "            ), CHR(1)) as ClientCode, "
            + "        0 as IsEDP "  //!!! Добавить определение ЕДП
            + "   from ddlcontr_dbt dlc, dsfcontr_dbt sf, dparty_dbt pt "
            + "  where dlc.t_DlContrID = ? "
            + "    and sf.t_ID = dlc.t_SfContrID "
            + "    and pt.t_PartyID = sf.t_PartyID ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_DlContrID);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())
      m_ShortName   = DataSet.ShortName;
      m_ClientCode  = DataSet.ClientCode;
      m_ContrDate   = date(DataSet.ContrDate);
      m_ContrNumber = DataSet.ContrNumber;
      m_IsEDP       = ДоговорЕДП(m_DlContrID); //IIF(DataSet.IsEDP == 0, false, true);
    end;


  END;

  MACRO DlContrID():INTEGER
    return m_DlContrID;
  END;

  MACRO ShortName():STRING
    return m_ShortName;
  END;

  MACRO ClientCode():STRING
    return m_ClientCode;
  END;

  MACRO ContrDate():DATE
    return m_ContrDate;
  END;

  MACRO ContrNumber():STRING
    return m_ContrNumber;
  END;

  MACRO ServKind():INTEGER
    return m_ServKind;
  END;

  MACRO ServKindSub():INTEGER
    return m_ServKindSub;
  END;

  MACRO MarketID():INTEGER
    return m_MarketID;
  END;

  MACRO IsEDP():BOOL
    return m_IsEDP;
  END;

  MACRO DepoAcc():STRING
    return m_DepoAcc;
  END;

  MACRO DepoPart():STRING
    return m_DepoPart;
  END;

  MACRO ExistAcc()
    var query, cmd;
    var find = false;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepacc_tmp repacc "
            + "  where 1= 1 ";

    if(m_MarketID > 0)
      query = query + " and repacc.t_MarketID = ? ";
      cmd.AddParam(m_MarketID);
    end;

    if(ServKind() == 0)
      query = query + " and repacc.t_ServKindSub <> 9 "; //Кроме внебирж
    else
      query = query + " and repacc.t_ServKind = ? "
                    + " and repacc.t_ServKindSub = ? ";

      cmd.AddParam(ServKind());
      cmd.AddParam(ServKindSub());
        end;

    if(cmd.GetCount(query) > 0)
      find = true;
    end;

    return find;
  END;

  Load();

END;

PRIVATE MACRO GetPlanName(PlanID:integer)
  var PlanName = "";

  var cmd = DL_RSDCommand("select t_Name from dsfplan_dbt where t_SfPlanID = ? ");
  cmd.AddParam(PlanID);

  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    PlanName = DataSet.Name;
  end;

  return PlanName;
END;

//Класс для формирования всех данных для отчета
PRIVATE CLASS SP_BrokerRepRSHB_CreateData(RepParams:CBrokerRepRSHBParams)
  PRIVATE VAR m_RepParams = RepParams;

  PRIVATE MACRO CreateByMode(Mode:integer)
    var sql, exec;
    var PartStr = "";

    if(Mode == BROKERREP_PART_DEALINPERIOD)
      PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С  "+string(m_RepParams.BegDate:f)+" ДО "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_REPOINPERIOD)
      PartStr = "СДЕЛКИ РЕПО, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С  "+string(m_RepParams.BegDate:f)+" ДО "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_EXECDEAL)
      PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_REPODEAL )
      PartStr = "СДЕЛКИ РЕПО, ЗАКЛЮЧЕННЫЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_CANCELDEAL)
      PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С  "+string(m_RepParams.BegDate:f)+" ДО "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_CANCELREPO)
      PartStr = "СДЕЛКИ РЕПО, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С  "+string(m_RepParams.BegDate:f)+" ДО "+string(m_RepParams.EndDate:f);
    end;

    InitProgress(-1, "Подготовка данных для разделов отчета", PartStr);

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB.CreateDealData(?, ?, ?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID );
    exec.addParam(Mode );
    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.addParam(IIF(m_RepParams.IsMarket == true, 1, 0) );
    exec.addParam(IIF(m_RepParams.IsOutMarket == true, 1, 0) );
    exec.ExecuteCMD();

    RemProgress();

  END;

  //Подготовить данные для радела АКТИВЫ и СОСТАВ ПОРТФЕЛЯ
  //Для фондового рынка сначала готовятся данные СОСТАВ ПОРТФЕЛЯ. а уже по ним порфируются АКТИВЫ
  PRIVATE MACRO CreateActiveData(IsEDP:bool)

    var sql, exec;
    var query, cmd, DataSet;

    InitProgress(-1, "Подготовка данных для раздела АКТИВЫ", "АКТИВЫ");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB.CreateActiveData(?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID );
    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.addParam(IIF(IsEDP == true, 1, 0) );
    exec.ExecuteCMD();

    RemProgress();
  
    //Подготовить плановые данные
    if(m_RepParams.ShowPlanRest == true)
      var inaccdata = NULL;
      var CheckCatArr = TArray();
      var repdataCache = RsbSQLInsert("brkrepinacc.tmp");
      var repdataArr = TArray();
      var inacc = NULL;

      CheckCatArr[CheckCatArr.size] = "ЦБ Клиента, ВУ";

      cmd = DL_RSDCommand();

      query =   " select sf.t_ID as SfContrID, sf.t_ServKind, sf.t_ServKindSub, mp.t_MarketID "
              + "   from ddlcontrmp_dbt mp, dsfcontr_dbt sf "
              + "  where mp.t_DlContrID = ? "
              + "    and sf.t_ID = mp.t_SfContrID "
              + "    and sf.t_ServKind = "+PTSK_STOCKDL;

      cmd.AddParam(m_RepParams.DlContrID);

      if((m_RepParams.IsOutMarket == false) and (m_RepParams.IsMarket == true))
        query = query + "and sf.t_ServKindSub <> 9 "; //Кроме внебиржи
      elif((m_RepParams.IsOutMarket == true) and (m_RepParams.IsMarket == false))
        query = query + "and sf.t_ServKindSub = 9 "; //Только внебиржа
      end;
      
      DataSet = cmd.Execute(query);
      while(DataSet.moveNext())
        inaccdata = NULL;
      
        SC_GetPlanInAcc(@inaccdata, 0, m_RepParams.ClientID, DataSet.SfContrID, m_RepParams.BegDate, m_RepParams.EndDate, CheckCatArr, true);

        if((ValType(inaccdata) != V_UNDEF) and (inaccdata.m_InAccArr.size > 0))

          InitProgress(inaccdata.m_InAccArr.size, "Плановые данные для раздела АКТИВЫ", "АКТИВЫ");

          var sz = 0;
          var i = 0;
          while(i < inaccdata.m_InAccArr.size)

            sz = repdataArr.size;

            inacc = inaccdata.m_InAccArr[i];

            if((inaccdata.m_GroundArr[i].State != DLRQ_STATE_REJECT) and (inacc.rec.PartyId  == m_RepParams.ClientID))

              repdataArr[sz] = TRecHandler("brkrepinacc.tmp");

              repdataArr[sz].Clear();

              repdataArr[sz].rec.ClientID    = m_RepParams.ClientID;
              repdataArr[sz].rec.ServKind    = IIF((IsEDP == true) AND (DataSet.ServKindSub != 9), 0, DataSet.ServKind);
              repdataArr[sz].rec.ServKindSub = IIF((IsEDP == true) AND (DataSet.ServKindSub != 9), 0, DataSet.ServKindSub);
              repdataArr[sz].rec.IsItog      = UNSET_CHAR;
              repdataArr[sz].rec.FIID        = inacc.rec.FIID;
              repdataArr[sz].rec.MarketID    = IIF((IsEDP == true) AND (DataSet.ServKindSub != 9), 0, DataSet.MarketID);

              if(inacc.rec.DebAcc != "")
                 repdataArr[sz].rec.A56_1 = inacc.rec.Sum; /*зачисление*/
              else
                 repdataArr[sz].rec.A57_1 = inacc.rec.Sum; /*списание*/
              end;

            end;
            
            UseProgress(i = i + 1);
          end;

          RemProgress();
        end;
      end;

      repdataCache.AddRecordArray(repdataArr);

      repdataCache.Insert();
    end;


    InitProgress(-1, "Корректировка данных для раздела АКТИВЫ", "АКТИВЫ");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB.CorrectActiveData(?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID );
    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.ExecuteCMD();

    RemProgress();

  END;

  PRIVATE MACRO CreateCasheMoveData(IsEDP:bool)

    var sql, exec;
    var query;

    InitProgress(-1, "Подготовка данных для раздела ДВИЖЕНИЕ ДЕНЕЖНЫХ СРЕДСТВ", "ДВИЖЕНИЕ ДЕНЕЖНЫХ СРЕДСТВ");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB.CreateCasheMoveData(?, ?, ?, ?, ?); "
         + "END; ";

    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID );
    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.addParam(IIF(IsEDP == true, 1, 0) );
    exec.addParam(IIF(m_RepParams.IsOutMarket == true, 1, 0) );
    exec.ExecuteCMD();

    RemProgress();
  END;
  
  PRIVATE MACRO CreateAllData(IsEDP:bool, IsValidClContr:bool)

    InitProgress(6, "Подготовка данных для разделов отчета", "Подготовка данных для разделов отчета");

    //SetUsingContr(ContrID);

    //Денежные средства
    if (IsValidClContr)
      CreateCasheMoveData(IsEDP);
    end;

    //Активы
    CreateActiveData(IsEDP);

    CreateByMode(BROKERREP_PART_DEALINPERIOD);
    UseProgress(1);

    CreateByMode(BROKERREP_PART_REPOINPERIOD);
    UseProgress(2);

    if (IsValidClContr)
      CreateByMode(BROKERREP_PART_EXECDEAL);
      UseProgress(3); 

      CreateByMode(BROKERREP_PART_REPODEAL);
      UseProgress(4);

      CreateByMode(BROKERREP_PART_CANCELDEAL);
      UseProgress(5); 

      CreateByMode(BROKERREP_PART_CANCELREPO);
      UseProgress(6);
    end;
 
    RemProgress();

  END;

  PRIVATE MACRO IsValidClientContr(DlContrData)
    var valid = true;
    var q, ds, select;
    var acc = null;

    /*dan > проверка установки на ДБО категории формировать нулевой отчет*/
    var CreateEmpty; 
        getMainObjAttr (null, 207, string(DlContrData.DlContrID:o:34), 150, null,null, CreateEmpty);//формировать нулевой отчет
        if(CreateEmpty)
          return True;
        end;
    /*< dan*/
    if((m_RepParams.IsFiMovement == true) or (m_RepParams.IsNotZeroRest == true))

      valid = false;

      select = DL_RSDCommand();

      q =   " select 1 "
          + "   from daccount_dbt acc "
          + "  where acc.t_Client = ? "
          + "    and (acc.t_Chapter = 22 or acc.t_AccountID IN (select r.t_AccountID from dbrkrepacc_tmp r)) ";

      select.AddParam(m_RepParams.ClientID);

      if(m_RepParams.IsFiMovement == true)
        q = q + " and (   rsb_account.kreditac(acc.t_Account,acc.t_Chapter,acc.t_Code_Currency,?,?, null) <> 0"
              + "      or rsb_account.debetac(acc.t_Account,acc.t_Chapter,acc.t_Code_Currency,?,?, null) <> 0";
        if(m_RepParams.IsNotZeroRest == true)
          q = q + " or rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, null) <> 0 ";
        end;


        q = q + "    ) ";
        
        select.AddParam(m_RepParams.BegDate);
        select.AddParam(m_RepParams.EndDate);
        select.AddParam(m_RepParams.BegDate);
        select.AddParam(m_RepParams.EndDate);
        if(m_RepParams.IsNotZeroRest == true)
          select.AddParam(m_RepParams.EndDate);
        end;

      end;

      if((m_RepParams.IsNotZeroRest == true) AND (m_RepParams.IsFiMovement == false))
        q = q + " and rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, null) <> 0 ";
        
        select.AddParam(m_RepParams.EndDate);
      end;

      q = q + " and ROWNUM = 1";

      ds = select.Execute(q);
      if(ds.moveNext())
        valid = true;
      end;
    end;

    return valid;
  END;

  MACRO Create()
    var DlContrData = NULL;
    var sql, exec;

    DlContrData = СBrokerRepRSHB_DlContrData(m_RepParams.DlContrID, m_RepParams.BegDate, m_RepParams.EndDate);

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB.LoadAccInTmp(?, ?, ?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID );
    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.addParam(IIF(DlContrData.IsEDP() == true, 1, 0) );
    exec.addParam(IIF(m_RepParams.IsOutMarket == true, 1, 0) );
    exec.addParam(IIF(m_RepParams.ShowPlanRest == true, 1, 0) );
    exec.ExecuteCMD();

    CreateAllData(DlContrData.IsEDP(), IsValidClientContr(DlContrData));
  END;
END;

PRIVATE CLASS СBrokerRepRSHB_PrintRep(RepParams:CBrokerRepRSHBParams)
  
  PRIVATE VAR m_rep = T_Poi_Rep();
  VAR m_RepParams = RepParams;
  var m_DlContrData = NULL;
  VAR m_CurrentRepName = "";
  PRIVATE VAR m_FullPath = "";
  PRIVATE VAR m_ItogCellColor = "E4DFEC";
  PRIVATE VAR m_TableHeadStyle = "BOR;FB;P=C;";

  PRIVATE MACRO PrintHeader(IsSvod:bool, SheetNum)
  
     var LogoTagName = String("LOGO__",/*m_repparams.repimgdata.size + 1*/SheetNum);
     m_Rep.Set_WrapText(0);

//dan>
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       //m_rep.Put_Str("Логотип", "FC=W;END;CN=LOGO;");
       m_rep.Put_Str("Логотип", "FC=W;END;CN="+LogoTagName+";");
//<dan

     m_rep.Put_Str("", "START;");
     if(m_DlContrData.MarketID == SPB_ID())
       m_rep.Put_Str("Рынок иностранных ценных бумаг (Санкт-Петербургская биржа)", "R=6;FB;FS=12;HA=L;END;");
     else
       m_rep.Put_Str("Отчет по сделкам и операциям с ценными бумагами", "R=6;FB;FS=12;HA=L;END;");
     end;
     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("(ОТЧЕТ БРОКЕРА  АО \"Россельхозбанк\")", "FB;FS=12;HA=L;R=6;END;");
     m_rep.Blank_Line();
     m_rep.Blank_Line();

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("Клиент:", "FB;FS=11;HA=L;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str(m_DlContrData.ShortName(), "HA=L;FS=10;END;");

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("Уникальный код:", "FB;FS=11;HA=L;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str(m_DlContrData.ClientCode(), "HA=L;FS=10;END;");

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("Договор на брокерское обслуживание:", "FB;FS=11;HA=L;");
     m_rep.Put_Str("", /*""*/"FB;FS=10;HA=L;");
     m_rep.Put_Str("", /*""*/"FB;FS=10;HA=L;");
     m_rep.Put_Str("", /*""*/"FB;FS=10;HA=L;");
     m_rep.Put_Str("№"+m_DlContrData.ContrNumber()+" от "+GetDateS(m_DlContrData.ContrDate()), "HA=L;FS=10;END;");

     if(IsSvod != true)
       var SubName = "";

       if(m_DlContrData.ServKindSub() == 9)
         SubName = "Внебиржа";
       elif(m_DlContrData.ServKind() == 0)
         SubName = "Единая денежная позиция (ЕДП)";
       elif(m_DlContrData.ServKind() == PTSK_STOCKDL)
         SubName = "Фондовый рынок";
       elif(m_DlContrData.ServKind() == PTSK_CM)
         SubName = "Валютный рынок";
       elif(m_DlContrData.ServKind() == PTSK_DV)
         SubName = "Срочный рынок";
       end;

//     m_rep.Blank_Line();
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("Субсчет:", "FB;FS=11;HA=L;");
       m_rep.Put_Str(SubName, "HA=L;FB;FS=10;END;");
     end;

     m_rep.Blank_Line();

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("Дата начала периода:", "R=2;FB;FS=11;HA=L;");
     m_rep.Put_Str(m_RepParams.BegDate, "HA=L;T=D;FS=10;END;");

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("Дата окончания периода:", "R=2;FB;FS=11;HA=L;");
     m_rep.Put_Str(m_RepParams.EndDate, "HA=L;T=D;FS=10;END;");
    
     if(IsSvod)
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("СВОДНЫЙ ОТЧЕТ", "FB;FS=11;HA=L;END;");
     end;

     m_rep.Blank_Line();
  END;


  PRIVATE MACRO PrintAccMoneyMoving(PrintMove:bool, IsSVOD:bool)
    var query, cmd, CurrCmd, CurrData, DataSet;
    var FirstColStyle  = "START;BOR;HA=L;R=4;";
    var SecondColStyle = "BOR;HA=R;T=M2;";
    var CCY = "";
    var cntCurr = 0;
    var i = 0, j = 0;
    var AccountIDs = TArray(), acc;
    var prevCurrency = -1;
    var stat = 0;
                                                      
    CurrCmd = DL_RSDCommand();

    query =   " select acc.t_Code_Currency, (select fin.t_Ccy from dfininstr_dbt fin where fin.t_FIID = acc.t_Code_Currency) Ccy, "
            + "        SUM(repacc.t_InRest) SumInRest, SUM(repacc.t_OutRest) SumOutRest, SUM(repacc.t_OutPlanRest) SumPlanRest "
            + "   from dbrkrepacc_tmp repacc, daccount_dbt acc "
            + "  where acc.t_AccountID = repacc.t_AccountID ";

    if(m_DlContrData.ServKind == 0)
      query = query + " and repacc.t_ServKindSub <> 9 "; //Кроме внебирж
    else
      query = query + " and repacc.t_ServKind = ? "
                    + " and repacc.t_ServKindSub = ? ";

      CurrCmd.AddParam(m_DlContrData.ServKind);
      CurrCmd.AddParam(m_DlContrData.ServKindSub);
    end;

    if(m_DlContrData.MarketID > 0)
      query = query + " and repacc.t_MarketID = ? ";

      CurrCmd.AddParam(m_DlContrData.MarketID);
    end;

    query = query + "group by acc.t_Code_Currency "
                  + "order by acc.t_Code_Currency ASC";
    
    cntCurr = CurrCmd.GetCount(query);

    if((m_RepParams.ShowEmpty) or (cntCurr > 0))
      m_Rep.Set_WrapText(1);
      m_rep.Put_Str("", "START;");
      m_rep.Put_Str("1. ДЕНЕЖНЫЕ СРЕДСТВА", "FB;FS=10;HA=L;R="+string(4)+";END;");

      m_rep.Blank_Line();

      m_Rep.Set_WrapText(1);
      m_rep.Put_Str("", "START;");
      m_rep.Put_Str("валюта",             "BOR;FB;HA=C;R=3;");
      m_rep.Put_Str("входящий остаток",   "BOR;FB;HA=C;");
      m_rep.Put_Str("исходящий остаток",  "BOR;FB;HA=C;");
      if(m_RepParams.ShowPlanRest == true)
        m_rep.Put_Str("плановый остаток",   "BOR;FB;HA=C;R=1;");
      end;
      m_rep.Put_Str("","END;");

      CurrData = CurrCmd.Execute(query);

      while(CurrData.moveNext())

        if(CurrData.Code_Currency == NATCUR)
          CCY = "Рубли";
        else
          CCY = CurrData.Ccy;
        end;

        m_rep.Put_Str("", "START;");
        m_rep.Put_Str("денежные средства ("+CCY+"):", "BOR;FB;HA=L;R=3;");
        m_rep.Put_Str(CurrData.SumInRest, "BOR;HA=R;T=M2;");
        m_rep.Put_Str(CurrData.SumOutRest, "BOR;HA=R;T=M2;");
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Str(CurrData.SumPlanRest, "BOR;HA=R;R=1;T=M2;");
        end;
        m_rep.Put_Str("","END;");
      end;

      //Распечатать движения по каждой валюте
      if(PrintMove == true)
        var Sum_InSum = $0, Sum_OutSum = $0, Sum_OutNDS = $0, Sum_Rest = $0;

        cmd = DL_RSDCommand();

        if (IsSVOD)
          // для вкладки СВОД - группируем по типам операций
          query =   " select q.t_Currency, q.t_IsItog, q.t_Date, q.t_OperName, q.t_MarketName, "
                  + "        NVL(SUM(q.t_InSum ), 0) as InSum,  "
                  + "        NVL(SUM(q.t_OutSum), 0) as OutSum, "
                  + "        NVL(SUM(q.t_OutNDS), 0) as OutNDS, "
                  + "        NVL(SUM(q.t_Rest  ), 0) as Rest  "
                  + "   from ( " 
                  + "   select t_Currency, t_IsItog, t_Date, substr(t_OperName,1, (case when instr(t_OperName, '.') > 0 then instr(t_OperName, '.')-1 else 50 end)) as t_OperName, t_MarketName, "
                  + "          t_InSum, t_OutSum, t_OutNDS, t_Rest    "
                  + "     from dbrkrepcashe_tmp "
                  + "    where t_ServKind = ? "
                  + "      and t_ServKindSub = ? "
                  + "                 ) q " 
                  + "  group by q.t_Currency, q.t_Date, q.t_IsItog, q.t_OperName, q.t_MarketName "
                  + "  order by (case when q.t_Currency = "+NATCUR+" THEN 0 ELSE 1 END) ASC, q.t_Currency ASC, q.t_Date ASC, q.t_IsItog ASC, q.t_OperName ASC, q.t_MarketName ASC";

          cmd.AddParam(m_DlContrData.ServKind());
          cmd.AddParam(m_DlContrData.ServKindSub());

        else
        query =   " select * "
                + "   from dbrkrepcashe_tmp "
                + "  where t_ServKind = ? "
                  + "    and t_ServKindSub = ? ";

        cmd.AddParam(m_DlContrData.ServKind());
        cmd.AddParam(m_DlContrData.ServKindSub());

          if(m_DlContrData.MarketID() > 0)
            query = query + " and t_MarketID = ? ";
            cmd.AddParam(m_DlContrData.MarketID()); 
          end;

          query = query
                  + "  order by (case when t_Currency = "+NATCUR+" THEN 0 ELSE 1 END) ASC, t_Currency ASC, t_Date ASC, t_IsItog ASC, t_AccTrnID ASC";
        end;

        DataSet = cmd.Execute(query);
       
        stat = DataSet.moveNext();
        while(stat)

          if(DataSet.Currency != prevCurrency)
            if(DataSet.Currency == NATCUR)
              CCY = "Рубли";
            else
              CCY = GetFinInstrCcy(DataSet.Currency,true,false);
            end;

            m_rep.Blank_Line();

            m_rep.Put_Str("", "START;");
            m_rep.Put_Str("("+CCY+")", "FB;HA=L;END;");

            m_rep.Put_Str("", "START;");
            m_rep.Put_Str("Дата",               "BOR;HA=C;");
            m_rep.Put_Str("Операция",           "BOR;HA=C;R=3;");
            m_rep.Put_Str("Торговая площадка",  "BOR;HA=C;");
            m_rep.Put_Str("Сумма зачисления",   "BOR;HA=C;");
            m_rep.Put_Str("Сумма списания",     "BOR;HA=C;");
            m_rep.Put_Str("В т.ч.НДС (руб.)",   "BOR;HA=C;");
            m_rep.Put_Str("Остаток (+/-)",      "BOR;HA=C;");
            m_rep.Put_Str("Примечание",         "BOR;HA=C;END;");
          end;
       
          if(DataSet.IsItog != SET_CHAR)
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(date(DataSet.Date),   "BOR;HA=L;T=D;");
            m_rep.Put_Str(DataSet.OperName,     "BOR;HA=L;R=3;");
            m_rep.Put_Str(DataSet.MarketName,   "BOR;HA=L;");
            m_rep.Put_Str(IIF(DataSet.InSum==0, "", money(DataSet.InSum)),  "BOR;HA=R;"+IIF(DataSet.InSum==0,"","T=M2;") );
            m_rep.Put_Str(IIF(DataSet.OutSum==0, "", money(DataSet.OutSum)),"BOR;HA=R;"+IIF(DataSet.OutSum==0,"","T=M2;"));
            m_rep.Put_Str(IIF(DataSet.OutNDS==0, "", money(DataSet.OutNDS)),"BOR;HA=R;"+IIF(DataSet.OutNDS==0,"","T=M2;"));
            m_rep.Put_Str("",                   "BOR;HA=R;");
            m_rep.Put_Str("",                   "BOR;HA=L;");
            m_rep.Put_Str("","END;");
          else
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(date(DataSet.Date),   "BOR;FB;HA=L;T=D;");
            m_rep.Put_Str("Итого:",             "BOR;FB;HA=L;R=3;");
            m_rep.Put_Str("",                   "BOR;FB;HA=L;");
            m_rep.Put_Str(IIF(DataSet.InSum==0, "", money(DataSet.InSum)),  "BOR;FB;HA=R;"+IIF(DataSet.InSum==0,"","T=M2;") );
            m_rep.Put_Str(IIF(DataSet.OutSum==0, "", money(DataSet.OutSum)),"BOR;FB;HA=R;"+IIF(DataSet.OutSum==0,"","T=M2;"));
            m_rep.Put_Str(IIF(DataSet.OutNDS==0, "", money(DataSet.OutNDS)),"BOR;FB;HA=R;"+IIF(DataSet.OutNDS==0,"","T=M2;"));
            m_rep.Put_Str(money(DataSet.Rest),  "BOR;FB;HA=R;T=M;");
            m_rep.Put_Str("",                   "BOR;FB;HA=L;END;");

            Sum_InSum  = Sum_InSum  + DataSet.InSum ;
            Sum_OutSum = Sum_OutSum + DataSet.OutSum;
            Sum_OutNDS = Sum_OutNDS + DataSet.OutNDS;
            Sum_Rest   = Sum_Rest   + DataSet.Rest  ;
          end; 
          
          prevCurrency = DataSet.Currency;

          stat = DataSet.moveNext();
          if((not stat) or (prevCurrency != DataSet.Currency))
            
            if(prevCurrency == NATCUR)
              CCY = "Рубль";
            end;
            
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str("Итого по валюте "+CCY+":", "BOR;FB;HA=L;R=5;IC="+m_ItogCellColor+";");
            m_rep.Put_Str(IIF(Sum_InSum==0, "", money(Sum_InSum)),  "BOR;FB;HA=R;IC="+m_ItogCellColor+";"+IIF(Sum_InSum==0,"","T=M2;") );
            m_rep.Put_Str(IIF(Sum_OutSum==0, "", money(Sum_OutSum)),"BOR;FB;HA=R;IC="+m_ItogCellColor+";"+IIF(Sum_OutSum==0,"","T=M2;"));
            m_rep.Put_Str(IIF(Sum_OutNDS==0, "", money(Sum_OutNDS)),"BOR;FB;HA=R;IC="+m_ItogCellColor+";"+IIF(Sum_OutNDS==0,"","T=M2;"));
            m_rep.Put_Str(money(Sum_Rest),  "BOR;FB;HA=R;T=M;IC="+m_ItogCellColor+";");
            m_rep.Put_Str("",                   "BOR;FB;HA=L;IC="+m_ItogCellColor+";END;");

            Sum_InSum  = $0; 
            Sum_OutSum = $0; 
            Sum_OutNDS = $0; 
            Sum_Rest   = $0;
          end; 

        end; 
      end;
    end;

    if((cntCurr > 0) or m_RepParams.ShowEmpty)
      m_rep.Blank_Line();
    end;

  END;

  PRIVATE MACRO PrintActive()
    var query, cmd, DataSet;
    var cnt = 0, i = 0;
    var A6 = "";  var A7 = "";

    cmd = DL_RSDCommand();

    query =   " select tmp.t_A8, tmp.t_A9, tmp.t_A10, tmp.t_A11, tmp.t_A12, tmp.t_A13, tmp.t_A11_1, tmp.t_A12_1, tmp.t_A13_1, "
            + "        fin.t_Name, avr.t_LSIN, avr.t_ISIN, '' as FIKind, 0 as OptionType "
            + "   from dbrkrepactive_tmp tmp, dfininstr_dbt fin, davoiriss_dbt avr "
            + "  where fin.t_FIID = tmp.t_FIID "
            + "    and avr.t_FIID = fin.t_FIID ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and tmp.t_ServKind = ? "
                    + " and tmp.t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and tmp.t_ServKindSub <> 9 "; //Для СВОД без внебиржи
    end;
            
    if(m_DlContrData.MarketID() > 0)
      query = query + " and tmp.t_MarketID = ? ";
      cmd.AddParam(m_DlContrData.MarketID());
    end;
            
    query = query 
            +   " UNION ALL select tmp.t_A8, tmp.t_A9, tmp.t_A10, tmp.t_A11, tmp.t_A12, tmp.t_A13, tmp.t_A11_1, tmp.t_A12_1, tmp.t_A13_1, "
            + "        fin.t_Name, '' as LSIN, '' as ISIN, "
            + "        (SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds WHERE AvrKinds.T_FI_KIND = fin.T_FI_KIND and AvrKinds.T_AVOIRKIND = fin.T_AVOIRKIND) as FIKind,   "
            + "        deriv.t_OptionType "
            + "   from dbrkrepactive_tmp tmp, dfininstr_dbt fin, dfideriv_dbt deriv "
            + "  where fin.t_FIID = tmp.t_FIID "
            + "    and deriv.t_FIID = fin.t_FIID ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and tmp.t_ServKind = ? "
                    + " and tmp.t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and tmp.t_ServKindSub <> 9 "; //Для СВОД без внебиржи
    end;
            
    if(m_DlContrData.MarketID() > 0)
      query = query + " and tmp.t_MarketID = ? ";
      cmd.AddParam(m_DlContrData.MarketID());
    end;
            
    cnt = cmd.GetCount(query);

    m_Rep.Set_WrapText(1);

    if(cnt or m_RepParams.ShowEmpty)
      m_rep.Put_Str("", "START;");
      m_rep.Put_Str("2. АКТИВЫ", "FB;HA=L;END;");
      
      m_rep.Put_Str("", "START;");
      m_rep.Put_Str("Портфель: (ценные бумаги, фьючерсы, опционы)", "BOR;FB;HA=C;R=3;");
      m_rep.Put_Str("Входящий остаток, шт.",                        "BOR;FB;HA=C;");
      m_rep.Put_Str("Исходящий остаток, шт.",                       "BOR;FB;HA=C;");
      if(m_RepParams.ShowPlanRest == true)
        m_rep.Put_Str("Плановый остаток, шт.",                        "BOR;FB;HA=C;");
      end;

      if(m_DlContrData.MarketID() == SPB_ID())
        m_rep.Put_Str("Входящий остаток, в валюте",                 "BOR;FB;HA=C;");
        m_rep.Put_Str("Исходящий остаток, в валюте",                "BOR;FB;HA=C;");
      if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Str("Плановый остаток, в валюте",               "BOR;FB;HA=C;");
      end;
      else
        m_rep.Put_Str("Входящий остаток, в рублях",                 "BOR;FB;HA=C;");
        m_rep.Put_Str("Исходящий остаток, в рублях",                "BOR;R=1;FB;HA=C;");
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Str("Плановый остаток, в рублях",               "BOR;FB;HA=C;");
        end;
      end;

      m_rep.Put_Str("Примечание",                                   "BOR;FB;HA=C;END;");
    end;

    if(cnt > 0)
      DataSet = cmd.Execute(query);

      InitProgress(cnt, "Подготовка раздела АКТИВЫ", "АКТИВЫ");

      while(DataSet.moveNext())                            //dan добавил проверку на undef
        if ((DataSet.FIKind != "") and (valtype(DataSet.FIKind) != v_Undef)) // ПИ
           A6 = DataSet.FIKind;
           if(StrUpr(DataSet.FIKind) == "ОПЦИОН")
              A6 = A6 + IIF(DataSet.OptionType == 1," - Put"," - Call");
           end;
           A7 = DataSet.Name;
        else                          // ЦБ
           A6 = DataSet.Name;
           A7 = IIF(DataSet.LSIN=="",DataSet.ISIN,DataSet.LSIN); 
        end;
        m_rep.Put_Str("", "START;");
        m_rep.Put_Str(A6,          "BOR;HA=L;R=2;");
        m_rep.Put_Str(A7,          "BOR;HA=L;");
        m_rep.Put_Val(DataSet.A8,  "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.A8)+";");
        m_rep.Put_Str(DataSet.A9,  "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.A9)+";" );
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Str(DataSet.A10, "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.A10)+";");
        end;

        if(m_DlContrData.MarketID() == SPB_ID())
          m_rep.Put_Str(DataSet.A11_1,"BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Str(DataSet.A12_1,"BOR;HA=R;VA=C;T=M2;");
          if(m_RepParams.ShowPlanRest == true)
            m_rep.Put_Str(DataSet.A13_1,"BOR;HA=R;VA=C;T=M2;");
          end;
        else
        m_rep.Put_Str(DataSet.A11,"BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Str(DataSet.A12,"BOR;R=1;HA=R;VA=C;T=M2;");
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Str(DataSet.A13,"BOR;HA=R;VA=C;T=M2;");
        end;
        end;
        m_rep.Put_Str("","BOR;END;");


        UseProgress(i = i + 1);
      end;

      RemProgress();
    end; 

    m_rep.Blank_Line();

    //Курсы валют
    var CCY = "", Sum1 = 0.0, Sum2 = 0.0;
    var HeadPrinted = false;

    cmd = DL_RSDCommand();
      
    query =   " select acc.t_Code_Currency, (select fin.t_Ccy from dfininstr_dbt fin where fin.t_FIID = acc.t_Code_Currency) Ccy, "
            + "        NVL(RSI_RSB_FIInstr.ConvSum(1, acc.t_Code_Currency, "+NATCUR+", ?), 0) as Sum1, "
            + "        NVL(RSI_RSB_FIInstr.ConvSum(1, acc.t_Code_Currency, "+NATCUR+", ?), 0) as Sum2 " 
            + "   from dbrkrepacc_tmp repacc, daccount_dbt acc "
            + "  where acc.t_AccountID = repacc.t_AccountID "
            + "    and acc.t_Code_Currency <> " + NATCUR;
      
    cmd.AddParam(m_RepParams.BegDate);
    cmd.AddParam(m_RepParams.EndDate);

    if(m_DlContrData.ServKind == 0)
      query = query + " and repacc.t_ServKindSub <> 9 "; //Кроме внебирж
    else
      query = query + " and repacc.t_ServKind = ? "
                    + " and repacc.t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind);
      cmd.AddParam(m_DlContrData.ServKindSub);
          end;

    if(m_DlContrData.MarketID() > 0)
      query = query + " and repacc.t_MarketID = ? ";
      cmd.AddParam(m_DlContrData.MarketID());
    end;

    query = query
            + "  group by acc.t_Code_Currency "
            + "  order by acc.t_Code_Currency ASC ";

    cnt = cmd.GetCount(query);
          
    if(cnt > 0)

      m_rep.Put_Str("", "START;");
      m_rep.Put_Str("Курсы валют:",      "BOR;FB;HA=L;");
      m_rep.Put_Str(m_RepParams.BegDate, "BOR;FB;T=D;HA=R;R=1;");
      m_rep.Put_Str(m_RepParams.EndDate, "BOR;FB;T=D;HA=R;R=1;END;");

      DataSet = cmd.Execute(query);
      while(DataSet.moveNext())

        CCY  = DataSet.Ccy;
            Sum1 = double(DataSet.Sum1);
        Sum2 = double(DataSet.Sum2);

          m_rep.Put_Str("", "START;");
          m_rep.Put_Str(CCY,  "BOR;HA=L;");
          m_rep.Put_Str(Sum1, "BOR;T=N4;HA=R;R=1;");
          m_rep.Put_Str(Sum2, "BOR;T=N4;HA=R;R=1;END;");
        end;

      m_rep.Blank_Line();
    end;

  END;

  PRIVATE MACRO ExistsDataForSecurDealByMode(ModeStr:string)
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepdeal_tmp "
            + "  where t_IsItog = CHR(0) "
            + "    and t_Part IN ("+ModeStr+")";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для СВОД без внебиржи
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  PRIVATE MACRO IsBasketByDealCode(deal_code : string)
    var query = "SELECT Rsb_Secur.IsBasket(Rsb_Secur.get_OperationGroup(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) IsBasket"
              + "  FROM ddl_tick_dbt tick"
              + " WHERE tick.t_DealCode = '?'";

    var cmd = DL_RSDCommand(query);
    cmd.AddParam(deal_code);

    var set = cmd.Execute();
    if (set.moveNext())
      return set.IsBasket;
    end;

    return false;
  END;

  PRIVATE MACRO PrintSecurDealsByMode(Mode)
     var query, cmd, DataSet;
     var prevPlanID = -1;
     var DealData = NULL;
     var cnt = 0;
     var i = 0;
     var PartStr = "";
     var uCMD; // для отладки

     //Напечатать итоговые строки
     MACRO PrintItogLines(PlanID:integer)
       var q, Select, ds;

       Select = DL_RSDCommand();

       q =   " select t_Direction, t_A16, t_A17, t_A18, t_A20, t_A27, t_A30 "
           + "   from dbrkrepdeal_tmp  "
           + "  where t_Part = ? "
           + "    and t_PlanID = ? "
           + "    and t_IsItog = 'X' ";
       
       Select.AddParam(Mode);
       Select.AddParam(PlanID);

       if(m_DlContrData.ServKind() != 0)
         q = q + " and t_ServKind = ? "
               + " and t_ServKindSub = ? ";

         Select.AddParam(m_DlContrData.ServKind());
         Select.AddParam(m_DlContrData.ServKindSub());
       else
         q = q + " and t_ServKindSub <> 9 "; //Для СВОД без внебиржи
       end;

       if(m_DlContrData.MarketID() > 0)
         q = q + " and t_MarketID = ? ";
         Select.AddParam(m_DlContrData.MarketID())
       end;

       q = q + " order by t_A30, t_Direction ";

       if(Select.GetCount(q))
         ds = Select.Execute(q);

         m_Rep.Set_WrapText(1);
         while(ds.moveNext())
           m_rep.Put_Str("", "START;");           
           m_rep.Put_Str("Итого "+IIF(ds.Direction == DIRECTION_BUY, "покупок", "продаж")+" в " + ds.A30, "BOR;FB;R=1;P=L;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A16, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A17, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A18, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A20, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A27, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");

           m_rep.Put_Str("","END;");
         end;
       end;
     END;

     // Печать заголовка и шапки таблицы
     MACRO PrintHeaderAndCap()
       m_Rep.Set_WrapText(0);

       var planName = "";
       if(DealData != null)
         planName = GetPlanName(DealData.PlanID);
       end;
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str(" СДЕЛКИ"+IIF(((Mode == BROKERREP_PART_REPOINPERIOD) OR (Mode == BROKERREP_PART_REPODEAL) OR (Mode == BROKERREP_PART_CANCELREPO)), " РЕПО", " НА ФОНДОВОМ РЫНКЕ")+", ЗАКЛЮЧЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА  "+planName, "HA=L;R=6;FB;END;");
       m_rep.Blank_Line();

       m_Rep.Set_WrapText(1);
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("Дата и время заключения сделки", m_TableHeadStyle);
       m_rep.Put_Str("Дата исполнения сделки",         m_TableHeadStyle);
       m_rep.Put_Str("Номер",                          m_TableHeadStyle);
       m_rep.Put_Str("Номер в ТС",                     m_TableHeadStyle);
       m_rep.Put_Str("Торговая площадка:",             m_TableHeadStyle);
       m_rep.Put_Str("Вид сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Эмитент",                        m_TableHeadStyle);
       m_rep.Put_Str("Вид ЦБ",                         m_TableHeadStyle);
       m_rep.Put_Str("Гос. рег. номер выпуска/ISIN",   m_TableHeadStyle);
       m_rep.Put_Str("Цена заявки",                    m_TableHeadStyle);
       m_rep.Put_Str("Цена сделки",                    m_TableHeadStyle);
       m_rep.Put_Str("Ставка РЕПО",                    m_TableHeadStyle);
       m_rep.Put_Str("Валюта сделки",                  m_TableHeadStyle);
       m_rep.Put_Str("Количество бумаг",               m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки",                   m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки в рублях",          m_TableHeadStyle);
       m_rep.Put_Str("Комиссия брокера",               m_TableHeadStyle);
       m_rep.Put_Str("Валюта комиссии брокера",        m_TableHeadStyle);
       m_rep.Put_Str("Комиссия, компенсирующая биржевые сборы", m_TableHeadStyle);
       m_rep.Put_Str("Тип сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Контрагент",                     m_TableHeadStyle);
       m_rep.Put_Str("Код контрагента",                m_TableHeadStyle);
       m_rep.Put_Str("Сумма НКД",                      m_TableHeadStyle);
       m_rep.Put_Str("Сумма НКД в рублях",             m_TableHeadStyle);
       m_rep.Put_Str("Обязательство по ДС",            m_TableHeadStyle);
       m_rep.Put_Str("Обязательство по ЦБ",            m_TableHeadStyle);
       m_rep.Put_Str("Примечание",                     m_TableHeadStyle);

       m_rep.Put_Str("","END;");
     END;

     cmd = DL_RSDCommand();
     
     query =   " select d.t_PlanID, "
             + "        d.t_A05_D, d.t_A05_T, d.t_A06, d.t_A07, d.t_A08, d.t_A09, d.t_A10, d.t_A11, d.t_A12, d.t_A13, d.t_A13_i, "
             + "        d.t_A14, d.t_A15, d.t_A16, d.t_A17, d.t_A18, d.t_A19, d.t_A20, d.t_A23, "
             + "        d.t_A24, d.t_A25, d.t_A26, d.t_A27, d.t_A28, d.t_A29, d.t_FIID, d.t_A95, d.t_A95_M, "
             + "        (select nvl(avrkind.t_Name, chr(1)) Name " 
             + "           from dfininstr_dbt fin, davrkinds_dbt avrkind " 
             + "          where fin.t_fiid = d.t_FIID " 
             + "            and avrkind.t_AvoirKind = fin.t_AvoirKind " 
             + "            and avrkind.t_FI_KIND   = fin.t_FI_Kind) as AvrkName "
             + "   from dbrkrepdeal_tmp  d"
             + "  where d.t_Part = ? "
             + "    and d.t_IsItog = CHR(0) ";
     
     cmd.AddParam(Mode);

     if(m_DlContrData.ServKind() != 0)
       query = query + " and d.t_ServKind = ? "
                     + " and d.t_ServKindSub = ? ";

       cmd.AddParam(m_DlContrData.ServKind());
       cmd.AddParam(m_DlContrData.ServKindSub());
     else
       query = query + " and d.t_ServKindSub <> 9 "; //Для СВОД без внебиржи
     end;

     if(m_DlContrData.MarketID() > 0)
       query = query + " and d.t_MarketID = ? ";
       cmd.AddParam(m_DlContrData.MarketID())
     end;

     query = query + " order by d.t_PlanID, d.t_A05_D, d.t_A05_T, d.t_A07, d.t_A10";


     cnt = cmd.GetCount(query);

     if(cnt)
       DealData = cmd.Execute(query);

       InitProgress(cnt, "Подготовка разделов отчета", "СДЕЛКИ"+IIF(((Mode == BROKERREP_PART_REPODEAL) or (Mode == BROKERREP_PART_CANCELREPO)), " РЕПО", "")+", ЗАКЛЮЧЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА");

       while(DealData.moveNext())

         if(prevPlanID != DealData.PlanID)
           if(prevPlanID != -1)
             PrintItogLines(prevPlanID);
             m_rep.Blank_Line();
           end;
           PrintHeaderAndCap();
         end;

         m_rep.Put_Str("", "START;");
         m_rep.Put_Str(string(date(DealData.A05_D):f) + " " + string(time(DealData.A05_T)), "BOR;P=C;");/* Дата и время заключения сделки */
         m_rep.Put_Val(date(DealData.A06), "BOR;P=C;T=D;");						/* Дата исполнения сделки */		
         m_rep.Put_Str(DealData.A07,       "BOR;P=C;");							/* Номер */
         m_rep.Put_Str(DealData.A08,       "BOR;P=C;");							/* Номер в ТС */
         m_rep.Put_Str(DealData.A09,       "BOR;P=C;");							/* Торговая площадка */
         m_rep.Put_Str(DealData.A10,       "BOR;P=C;");							/* Вид сделки */
         m_rep.Put_Str(DealData.A11,       "BOR;P=C;");							/* Эмитент */
         m_rep.Put_Str(DealData.AvrkName,  "BOR;P=C;");                                                 /* Вид ЦБ */
         m_rep.Put_Str(DealData.A12,       "BOR;P=C;");                                                 /* Гос. рег. номер выпуска/ISIN */

         // Цена заявки
         if((ValType(DealData.A95) != V_UNDEF) and (DealData.A95 != 0.0) and (DealData.A10 != "ОРЕПО 2") and (DealData.A10 != "ПРЕПО 2")) //Не заполняем по второй части РЕПО, т.к. в заявке второй цены нет
           m_rep.Put_Val(DealData.A95,     "BOR;HA=R;VA=C;T=N4;");
         else
           m_rep.Put_Str("",               "BOR;P=C;");
         end;

         // Цена сделки
         if(DealData.A13 != 0.0)
           m_rep.Put_Val(DealData.A13,     "BOR;HA=R;VA=C;T=N4;");
         else
           m_rep.Put_Str("",               "BOR;P=C;");
         end;

         // Ставка РЕПО
         if(DealData.A13_i != 0.0)
           m_rep.Put_Str(ЧислоCЗаданнойТочностью(DoubleToMoney(DealData.A13_i), 4)/* + "%"*/,    "BOR;P=C;");
         else
           m_rep.Put_Str("",               "BOR;P=C;");
         end;

         m_rep.Put_Str(DealData.A14,       "BOR;P=C;");							/* Валюта сделки */
         m_rep.Put_Val(DealData.A15,       "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A15)+";");	/* Количество бумаг */
         m_rep.Put_Val(DealData.A16,       "BOR;HA=R;VA=C;T=M2;");					/* Сумма сделки */
         m_rep.Put_Val(DealData.A17,       "BOR;HA=R;VA=C;T=M2;");					/* Сумма сделки в рублях */
         m_rep.Put_Val(DealData.A18,       "BOR;HA=R;VA=C;T=M2;");					/* Комиссия брокера */
         m_rep.Put_Str(DealData.A19,       "BOR;P=C;");							/* Валюта комиссии брокера */
         m_rep.Put_Val(DealData.A20,       "BOR;HA=R;VA=C;T=M2;");					/* Комиссия, компенсирующая биржевые сборы */
         m_rep.Put_Str(DealData.A23,       "BOR;P=C;");							/* Тип сделки */
         m_rep.Put_Str(DealData.A24,       "BOR;P=C;");							/* Контрагент */
         m_rep.Put_Str(DealData.A25,       "BOR;P=C;");							/* Код контрагента */

         // Сумма НКД
         if (IsBasketByDealCode(DealData.A07))
           m_rep.Put_Val(" ",       "BOR;P=C;");
         else
           m_rep.Put_Val(DealData.A26,     "BOR;HA=R;VA=C;T=M2;");
         end;
         m_rep.Put_Val(DealData.A27,       "BOR;HA=R;VA=C;T=M2;");					/* Сумма НКД в рублях */
         m_rep.Put_Val(DealData.A28,       "BOR;HA=R;VA=C;T=M2;");					/* Обязательство по ДС */
         m_rep.Put_Val(DealData.A29,       "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A29)+";");	/* Обязательство по ЦБ */
         m_rep.Put_Val(DealData.A95_M,     "BOR;P=C;");							/* Примечание */

         m_rep.Put_Str("","END;");

         prevPlanID = DealData.PlanID;

         UseProgress(i = i + 1);
       end;

       RemProgress();

       PrintItogLines(prevPlanID);
       m_rep.Blank_Line();
     elif(m_RepParams.ShowEmpty)
       PrintHeaderAndCap();
       m_rep.Blank_Line();
     end;
  END;

  PRIVATE MACRO PrintCurrDealsByMode(Mode)
     var query, cmd, DataSet;
     var prevPlanID = -1;
     var DealData = NULL;
     var cnt = 0;
     var i = 0;
     var PartStr = "";
     var liabilityBase = 0.0, liabilityContr = 0.0; 

    macro CurMarginCall(p_IsMarginCall)
       var s:string = "";
       if(p_IsMarginCall == SET_CHAR)
         s = "Принудительное закрытие позиций";
       end;
       return s;
    end;

    macro GetCurrDealSql(mode)
        var sql = "  SELECT dvn.t_id as DealID, " +
                  "         dvn.t_kind as OpKind, " +
                  "         dvn.t_dvkind as DvKind, " +
                  "         dvn.t_dockind as DocKind, " +
                  "         case when dvn.t_dvkind = 7 then 0 else (case when dvnfi.t_type = 0 then 1 else 2 end) end as Part, " +
                  "         case when dvn.t_dvkind = 7 then 0 else 1 end as IsSwap, " +
                  "         rsb_brkrep_rshb.GetSfPlanID(?, dvn.t_date) as PlanID, " +
                  "         dvn.t_date as A05_D, " +
                  "         dvn.t_time as A05_T, " +
                  "         dvnfi.t_execdate as A06, " +
                  "         dvn.t_code as A07, " +
                  "         case when dvn.t_sector = 'X' then dvn.t_extcode else '' end as A08, " +
                  "         case when dvn.t_sector = 'X' then nvl( (select mc.t_code from dobjcode_dbt mc where MC.T_OBJECTTYPE = 3 and MC.T_OBJECTID = dvn.T_MARKETID and MC.T_CODEKIND = 1), '' ) else '' end as A09, " +
                  "         case when dvn.t_type = 1 then 'Покупка' " +
                  "           when dvn.t_type = 2 then 'Продажа' " +
                  "           when dvn.t_type = 5 and dvnfi.t_type = 2 then 'Продажа' " +
                  "           when dvn.t_type = 6 and dvnfi.t_type = 0 then 'Продажа' " +
                  "           when dvn.t_type = 5 and dvnfi.t_type = 0 then 'Покупка' " +
                  "           when dvn.t_type = 6 and dvnfi.t_type = 2 then 'Покупка' " +
                  "           else '' " +
                  "           end as A11, " +
                  "         dvnfi.t_amount as A12, " +
                  "         dvnfi.t_price as A13, " +
                  "         dvnfi.t_point as A13_point, " +
                  "         fin.t_ccy as A14, " +
                  "         price.t_ccy as A15, " +
                  "         fin.t_fiid as BaseFiid, " +
                  "         price.t_fiid as ContrFiid, " +
                  "         dvnfi.t_amount as A16, " +
                  "         dvnfi.t_cost as A17, " +
                  "         case when fin.t_fiid = 0 " +
                  "            then dvnfi.t_amount " +
                  "            else RSI_RSB_FIInstr.ConvSum(dvnfi.t_amount, fin.t_fiid, 0, dvn.t_date, 0) " +
                  "            end as A18, " +
                  "         rsb_brkrep_rshb.GetMarketComissSum( dvn.t_dockind, dvn.t_id, case when dvn.t_dvkind = 7 then 1 else (case when dvnfi.t_type = 0 then 1 else 2 end) end, dvn.T_MARKETID, dvn.t_Date) as A21, " +
                  "         case when dvn.t_sector = 'X' then 'Безадресная' else 'Адресная' end as A24, " +
                  "         case when dvn.t_contractor > 0 then (select t_shortname from dparty_dbt pt where pt.t_partyid = dvn.t_contractor) " +
                  "           else '' " +
                  "           end as A25, " +
                  "         case when dvn.t_contractor > 0 then (select t_code from dpartcode_dbt pc where pc.t_codekind = 8 and pc.t_partyid = dvn.t_contractor) " +
                  "           else '' " +
                  "           end as A26, " +
                  "         'A27' as A27, " +
                  "         'A28' as A28, " +
                  "         nvl((select req.t_price " +
                  "                from dspground_dbt ground, dspgrdoc_dbt dealdoc, dspgrdoc_dbt reqdoc, ddl_req_dbt req " +
                  "               where dealdoc.t_sourcedocid = dvn.t_id " + 
                  "                 and dealdoc.t_sourcedockind = dvn.t_dockind " +                            
                  "                 and ground.t_spgroundid = dealdoc.t_spgroundid " +
                  "                 and ground.t_spgroundid = reqdoc.t_spgroundid " +
                  "                 and dealdoc.t_sourcedocid != reqdoc.t_sourcedocid " +
                  "                 and dealdoc.t_sourcedockind != reqdoc.t_sourcedockind " +
                  "                 and reqdoc.t_sourcedocid = req.t_id " +
                  "                 and req.t_sourcekind = dealdoc.t_sourcedockind " +
                  "                 and req.t_client = dvn.t_client " +
                  "                 and reqdoc.t_sourcedockind = req.t_kind " +   
                  "                 and rownum = 1), null) as A43, " +   
                 "         case when RSB_SECUR.GetMainObjAttr(RSB_SECUR.GetDvnObjType(dvn.t_dockind), LPAD(dvn.t_id, 34, '0'), 116, dvn.t_Date) = 1 then 'X' else CHR(0) end as IsMarginCall " +    
                  "  FROM ddvndeal_dbt dvn, ddvnfi_dbt dvnfi, dfininstr_dbt fin, dfininstr_dbt price " +
                  "   WHERE dvn.t_client      = ? " +
                  "     and dvn.t_clientcontr = ? " +
                  "     and dvn.t_dvkind in (6, 7) " +
                  "     and dvn.t_state in (1, 2) " +
                  "     and dvnfi.t_dealid = dvn.t_id " +
                  "     and dvnfi.t_fiid = fin.t_fiid " +
                  "     and fin.t_fi_kind = 1 " +
                  "     and dvnfi.t_pricefiid = price.t_fiid " +
                  "     and dvn.t_date <= ? " +
                  "     and not exists (select 1 " +
                  "                       from dpmpaym_dbt paym " +
                  "                      where paym.t_documentid = dvn.t_id " +
                  "                        and paym.t_dockind = dvn.t_dockind " +
                  "                        and paym.t_valuedate < ? " +
                  "                        and paym.t_purpose in (" + BAi + "," + CAi + "," + BRi + "," + CRi + ") " +
                  "                        and paym.t_paymstatus in (" + PM_FINISHED + "," + PM_CLOSED_W_M_MOVEMENT + ") ) ";
        if ((m_DlContrData.ServKindSub() == 8) OR (m_DlContrData.ServKindSub() == 0)) // биржа или всё кроме внебиржи т.е. снова биржа
          sql = sql + "     and dvn.t_sector = 'X' ";
        end;          

        if ( mode == BROKERREP_PART_DEALINPERIOD )
          sql = sql + "     and dvn.t_date between ? and ? " + "  ORDER BY PlanID, DealID ";
        elif ( mode == BROKERREP_PART_CANCELDEAL )
          sql = sql + "     and dvn.t_date < ? and not exists (select 1 " +
                  "                       from dpmpaym_dbt paym " +
                  "                      where paym.t_documentid = dvn.t_id " +
                  "                        and paym.t_dockind = dvn.t_dockind " +
                  "                        and paym.t_valuedate between ? and ? " +
                  "                        and paym.t_purpose in (" + BAi + "," + CAi + "," + BRi + "," + CRi + ") " +
                  "                        and paym.t_paymstatus in (" + PM_FINISHED + "," + PM_CLOSED_W_M_MOVEMENT + ") ) " +
                  "   ORDER BY PlanID, DealID ";
        elif ( mode == BROKERREP_PART_EXECDEAL )
          sql = sql + "     and dvn.t_date < ? " +
                  "         and exists (select 1 " +
                  "                       from dpmpaym_dbt paym " +
                  "                      where paym.t_documentid = dvn.t_id " +
                  "                        and paym.t_dockind = dvn.t_dockind " +
                  "                        and paym.t_valuedate between ? and ? " +
                  "                        and paym.t_purpose in (" + BAi + "," + CAi + "," + BRi + "," + CRi + ") " +
                  "                        and paym.t_paymstatus in (" + PM_FINISHED + "," + PM_CLOSED_W_M_MOVEMENT + ") ) " +
                  "   ORDER BY PlanID, DealID ";
        else
          sql = sql + "     ORDER BY PlanID, DealID ";
        end;
      return sql;
    end;


    // Получить FIID для валюты по коду
    MACRO GetFIID(ccy)
      var q = "select t_fiid fiid from dfininstr_dbt where t_ccy = ?";
      var cmd = DL_RSDCommand();
      cmd.AddParam(ccy);
      var ds = cmd.Execute(q);
      if (ds.moveNext)
        return ds.fiid;
      end;
      return -1;
    END;

    MACRO GetContrID1(DlContID)
      // var q = "select DLC.T_SFCONTRID from ddlcontr_dbt dlc where DLC.T_DLCONTRID = ? ";
      var q = "select sf.T_ID from ddlcontrmp_dbt mp, dsfcontr_dbt sf where sf.t_servkind = " + PTSK_CM + " and sf.t_id = mp.t_sfcontrid and mp.T_DLCONTRID = ? ";
      var cmd = DL_RSDCommand();
      cmd.AddParam(DlContID);
      var ds = cmd.Execute(q);
      if (ds.moveNext)
        // return ds.SFCONTRID;
        return ds.ID;
      end;
      return -1;
    END;
    MACRO GetContrID2(DlContID)
      var q = "select DLC.T_SFCONTRID from ddlcontr_dbt dlc where DLC.T_DLCONTRID = ? ";
      var cmd = DL_RSDCommand();
      cmd.AddParam(DlContID);
      var ds = cmd.Execute(q);
      if (ds.moveNext)
        return ds.SFCONTRID;
      end;
      return -1;
    END;
    MACRO GetContrID(DlContID)
      var id = GetContrID1(DlContID);
      if (id == -1)
        id = GetContrID2(DlContID);
      end;
      return id;
    END;

    // Определить название инструмента
    macro GetInstrName(DealDate:date, ExDealDate:date, IsSwap, Part, BaseCCY:string, ContrCCY:string):String
      var Instrument:string = BaseCCY + ContrCCY;

      if (IsSwap == 1)
        Instrument = Instrument + "_Спец. SWAP";
        if ( Part == 1 )
          Instrument = Instrument + " часть 1";
        else
          Instrument = Instrument + " часть 2";
        end;
      else
        if (DealDate == ExDealDate)
          Instrument = Instrument + "_TOD";
        else
          Instrument = Instrument + "_TOM";
        end;
      end;

      return Instrument;
    end;

    macro ЕстьНеисполненныеОбязательства(OpKind, DealID, Part):bool
      var qto, cmdto, rsto;

      qto = "select 1 " +
            "  from doproper_dbt op, doprstep_dbt st " +
            " where op.t_kind_operation = ? " +
            "   and op.t_documentid = lpad(?,34,'0') " +
            "   and op.t_id_operation = st.t_id_operation " +
            "   and st.t_isexecute != 'X' " +
            "   and (case when ? = 0 then (case when st.t_blockid = 273005 and st.t_symbol = 'Б' then 1 else 0 end) " +
            "             when ? = 1 then (case when st.t_blockid = 271002 and st.t_symbol = 'о' then 1 else 0 end) " +
            "             when ? = 2 then (case when st.t_blockid = 271003 and st.t_symbol = 'О' then 1 else 0 end) " +
            "             else 0 end) = 1 ";
      cmdto = DL_RSDCommand(qto);
      cmdto.addParam(OpKind);
      cmdto.addParam(DealID);
      cmdto.addParam(Part);
      cmdto.addParam(Part);
      cmdto.addParam(Part);
      rsto = cmdto.execute();
      
      if (rsto.moveNext())
        return true;
      end;
      return false;
    end;

     // Печать заголовка и шапки таблицы
     MACRO PrintHeaderAndCap()
       m_Rep.Set_WrapText(0);

       var planName = "";
       if((DealData != null) AND (DealData.PlanID != null))
         planName = GetPlanName(DealData.PlanID);
       end;
       if (m_DlContrData.ServKindSub() != 0)
        m_rep.Put_Str("", "START;");
        m_rep.Put_Str("СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА  "+planName, "HA=L;R=6;FB;END;");
       end;

       m_Rep.Set_WrapText(1);
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("Дата и время заключения сделки", m_TableHeadStyle);
       m_rep.Put_Str("Дата исполнения сделки",         m_TableHeadStyle);
       m_rep.Put_Str("Номер",                          m_TableHeadStyle);
       m_rep.Put_Str("Номер в ТС",                     m_TableHeadStyle);
       m_rep.Put_Str("Торговая площадка:",             m_TableHeadStyle);
       m_rep.Put_Str("Инструмент",                     m_TableHeadStyle);
       m_rep.Put_Str("Вид сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Объем сделки",                   m_TableHeadStyle);
       m_rep.Put_Str("Цена заявки",                    m_TableHeadStyle);
       m_rep.Put_Str("Цена сделки",                    m_TableHeadStyle);
       m_rep.Put_Str("Валюта сделки",                  m_TableHeadStyle);
       m_rep.Put_Str("Валюта расчетов",                m_TableHeadStyle);
       m_rep.Put_Str("Сумма в валюте сделки",          m_TableHeadStyle);
       m_rep.Put_Str("Сумма в валюте расчетов",        m_TableHeadStyle);
       m_rep.Put_Str("Сумма расчетов в рублях (по курсу ЦБ на дату заключения)", m_TableHeadStyle);
       m_rep.Put_Str("Комиссия брокера в валюте расчетов",              m_TableHeadStyle);
       m_rep.Put_Str("Комиссия брокера в рублях",                       m_TableHeadStyle);
       m_rep.Put_Str("Комиссия, компенсирующая биржевые сборы",          m_TableHeadStyle);
       m_rep.Put_Str("Тип сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Контрагент",                     m_TableHeadStyle);
       m_rep.Put_Str("Код контрагента",                m_TableHeadStyle);
       m_rep.Put_Str("Обязательства в валюте сделки",  m_TableHeadStyle);
       m_rep.Put_Str("Обязательства в валюте расчетов",m_TableHeadStyle);
       m_rep.Put_Str("Примечание",		       m_TableHeadStyle);
       m_rep.Put_Str("","END;");
     END;

    macro CalcBrokerCommis(DealID, DocKind, A19:@variant, A20:@variant)
      var qcom, cmdcom, rscom;
      A19 = 0.0; 
      A20 = 0.0;
      qcom = " select dlc.t_sum, dlc.t_date, sfc.t_fiid_comm as fiid " +
              "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
              "           where dlc.t_docid      = ? " +
              "             and dlc.t_dockind    = ? " +
              "             and dlc.t_feetype    = sfc.t_feetype " +
              "             and dlc.t_comnumber  = sfc.t_number " + 
              "             and sfc.t_ReceiverID = ? " +
              "             and LOWER(sfc.t_Code) not IN (LOWER('БрокерКомпенсацВ_RUR'), LOWER('БрокерКомпенсацВ_USD'), LOWER('БрокерКомпенсацВ_EUR'), LOWER('БрокерКомпенсацВ_CHF')) ";        
      cmdcom = DL_RSDCommand(qcom);
      cmdcom.addParam(DealData.DealID);
      cmdcom.addParam(DealData.DocKind);
      cmdcom.addParam({ourbank});
      rscom = cmdcom.execute();
      
      while (rscom.moveNext())
          var tmpPrice, tmpNatcur;
          DV_SmartConvertSumDbl(tmpPrice, rscom.Sum, rscom.Date, rscom.FIID, DealData.ContrFiid);
          DV_SmartConvertSumDbl(tmpNatcur, rscom.Sum, rscom.Date, rscom.FIID, NATCUR);
          A19 = A19 + tmpPrice;
          A20 = A20 + tmpNatcur;
      end;
    end;

    var Instrument = "";
    var A19 = 0.0, A20 = 0.0;
    var ContID = GetContrID(m_DlContrData.DlContrID());
    var sql = GetCurrDealSql(Mode);
    var exec = DL_RSDCommand(sql);
    exec.addParam(ContID);
    exec.addParam(m_RepParams.ClientID);
    exec.addParam(ContID);
    exec.addParam(m_RepParams.EndDate);
    exec.addParam(m_RepParams.BegDate);
    if((mode == BROKERREP_PART_CANCELDEAL) or (mode == BROKERREP_PART_EXECDEAL))
      exec.addParam(m_RepParams.BegDate);
    end;
    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);

    cnt = exec.GetCount();
    DealData = exec.execute();

     if(cnt)
       InitProgress(cnt, "Подготовка разделов отчета", "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА");

       while(DealData.moveNext())

         if(prevPlanID != DealData.PlanID)
           if(prevPlanID != -1)
            //  PrintItogLines(prevPlanID);
             m_rep.Blank_Line();
           end;
           PrintHeaderAndCap();
         end;

         CalcBrokerCommis(DealData.DealID, DealData.DocKind, @A19, @A20);
         Instrument = GetInstrName( date(DealData.A05_D), date(DealData.A06), DealData.IsSwap, DealData.Part, DealData.A14, DealData.A15);
          if (ЕстьНеисполненныеОбязательства(DealData.OpKind, DealData.DealID, DealData.Part))
            // Есть неисполненные обязательства
            if (DealData.A11 == "Покупка")
              liabilityContr = DealData.A17;
            else
              liabilityBase = DealData.A16;
            end;
          end;

         m_rep.Put_Str("", "START;");

          m_rep.Put_Str(string(date(DealData.A05_D):f) + " " + string(time(DealData.A05_T)), "BOR;P=C;");	/*Дата и время заключения сделки*/
          m_rep.Put_Str(string(date(DealData.A06):f), "BOR;P=C;T=D;");						/*Дата исполнения сделки*/
          m_rep.Put_Str(DealData.A07,       "BOR;P=C;");							/*Номер*/
          m_rep.Put_Str(DealData.A08,       "BOR;P=C;");							/*Номер в ТС*/
          m_rep.Put_Str(DealData.A09,       "BOR;P=C;");							/*Торговая площадка:*/
          m_rep.Put_Str(Instrument,         "BOR;P=C;");							/*Инструмент*/
          m_rep.Put_Str(DealData.A11,       "BOR;P=C;");							/*Вид сделки*/
          m_rep.Put_Val(DealData.A12,       "BOR;HA=R;VA=C;T=M2;");						/*Объем сделки*/

	  /*Цена заявки	*/
          if(DealData.IsMarginCall == SET_CHAR)
              m_rep.Put_Str("",                 "BOR;P=C;");
          elif( (DealData.A43 != 0.0) and (DealData.Part != 2) and (ValType(DealData.A43) != V_UNDEF)) //Не заполняем по второй части свопов, т.к. в заявке второй цены нет
              m_rep.Put_Val(DealData.A43,    "BOR;HA=R;VA=C;T=N4;");
          else 
              m_rep.Put_Str("",              "BOR;P=C;");
          end;
          m_rep.Put_Val(double(DealData.A13), "BOR;HA=R;VA=C;T=N4;");  						/*Цена сделки*/
          m_rep.Put_Str(DealData.A14,       "BOR;P=C;");							/*Валюта сделки*/
          m_rep.Put_Str(DealData.A15,       "BOR;P=C;");							/*Валюта расчетов*/
          m_rep.Put_Val(DealData.A16,       "BOR;HA=R;VA=C;T=M2;");						/*Сумма в валюте сделки*/
          m_rep.Put_Val(DealData.A17,       "BOR;HA=R;VA=C;T=M2;");						/*Сумма в валюте расчетов*/
          m_rep.Put_Val(DealData.A18,       "BOR;HA=R;VA=C;T=M2;");     					/*Сумма расчетов в рублях (по курсу ЦБ на дату заключения)*/
          m_rep.Put_Val(A19,                "BOR;HA=R;VA=C;T=M2;");						/*Комиссия брокера в валюте расчетов*/
          m_rep.Put_Val(A20,                "BOR;HA=R;VA=C;T=M2;");						/*Комиссия брокера в рублях*/
          m_rep.Put_Val(DealData.A21,       "BOR;HA=R;VA=C;T=M2;");						/*Комиссия, компенсирующая биржевые сборы*/
          m_rep.Put_Str(DealData.A24,       "BOR;P=C;");							/*Тип сделки*/
          m_rep.Put_Str(DealData.A25,       "BOR;P=C;");							/*Контрагент*/
          m_rep.Put_Str(DealData.A26,       "BOR;P=C;");							/*Код контрагента*/
          m_rep.Put_Val(liabilityBase,      "BOR;HA=R;VA=C;T=M2;");						/*Обязательства в валюте сделки*/
          m_rep.Put_Val(liabilityContr,     "BOR;HA=R;VA=C;T=M2;");						/*Обязательства в валюте расчетов*/
          m_rep.Put_Str(CurMarginCall(DealData.IsMarginCall),   "BOR;P=C;");					/*Примечание*/

         m_rep.Put_Str("","END;");

         prevPlanID = DealData.PlanID;

         UseProgress(i = i + 1);
       end;

       RemProgress();

      //  PrintItogLines(prevPlanID);
       m_rep.Blank_Line();
     elif(m_RepParams.ShowEmpty)
       PrintHeaderAndCap();
       m_rep.Blank_Line();
     end;
  END; // PrintCurrDealsByMode

  PRIVATE MACRO PrintDvDealsByMode(mode)
    var query, cmd, DataSet;
    var prevPlanID = -1;
    var DealData = NULL;
    var cnt = 0;
    var i = 0;
    var C03 = ""; var C12 = 0.0, C13 = 0.0, C14 = 0.0, C15 = 0.0;

    macro GetDvDealSql(mode)
       var sql = "  SELECT dv.t_id      as DealID, " +
                 "         dv.t_kind    as OprKind, " +
                 "         dv.t_code as C01, " +
                 "         dv.t_Date    as DealDate, " +
                 "         dv.t_Time    as DealTime, " +
                 "         fin.t_Name   as C04, " +
                 "         fin.t_ParentFI, " +
                 "         (SELECT AvrKinds.t_name FROM davrkinds_dbt AvrKinds WHERE AvrKinds.t_fi_kind = fin.t_fi_kind and AvrKinds.t_avoirkind = fin.t_avoirkind) as FIKind, " +
                 "         deriv.t_OptionType, " +
                 "         case when dv.t_type = 'B' then 'Покупка' else 'Продажа' end as C05, " +
                 "         rsb_brkrep_rshb.GetSfPlanID(?, dv.t_date) as PlanID, " +
                 "         (SELECT party.t_shortname FROM dparty_dbt party WHERE party.t_PartyID = fin.t_Issuer) as C06, " +
                 "         fin.t_Issuer as Market, " +
                 "         dv.t_date_clr as ClrDate, " +
                 "         case when fin.t_avoirkind = 1 then nvl(dv.t_price, 0) else nvl(dv.t_bonus, 0) end as C09, " +
                 "         case when fin.t_avoirkind = 2 then nvl(dv.t_price, 0) else 0 end as C10, " +
                 "         dv.t_Amount as C11, " +
                 "         case when fin.t_avoirkind = 1 then nvl(dv.t_positioncost_rur, 0) else nvl(dv.t_positionbonus, 0) end as DealSum, " +    
                 "         case when RSB_SECUR.GetMainObjAttr("+OBJTYPE_OPER_DV+", LPAD(dv.t_id, 34, '0'), 116, dv.t_Date) = 1 then 'X' else CHR(0) end as IsMarginCall " +    
                 "  FROM ddvdeal_dbt dv, dfininstr_dbt fin, dfideriv_dbt deriv " +
                 "   WHERE dv.t_client      = ? " +
                 "     and dv.t_clientcontr = ? " +
                 "     and dv.t_state in (1, 2) " +
                 "     and fin.t_fiid = dv.t_fiid " +
                 "     and deriv.t_fiid = fin.t_fiid " +
                 "     and dv.t_type IN ('B','S') ";

       if ( mode == BROKERREP_PART_DEALINPERIOD )
         sql = sql + " and dv.t_date between ? and ? and dv.t_date_clr between ? and ? ORDER BY PlanID, DealID ";
       elif ( mode == BROKERREP_PART_EXECDEAL )
         sql = sql + " and dv.t_date < ? and dv.t_date_clr between ? and ? ORDER BY PlanID, DealID ";
       else
         sql = sql + " and dv.t_date between ? and ? ORDER BY PlanID, DealID ";
       end;
       return sql;
    end;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
       m_Rep.Set_WrapText(0);

       var planName = "";
       if((DealData != null) AND (DealData.PlanID != null))
         planName = GetPlanName(DealData.PlanID);
       end;
       if (m_DlContrData.ServKindSub() != 0)
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str("СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА  "+planName, "HA=L;R=6;FB;END;");
       end;
       m_Rep.Set_WrapText(1);
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("№ сделки",                       m_TableHeadStyle);
       m_rep.Put_Str("Дата и время заключения сделки", m_TableHeadStyle);
       m_rep.Put_Str("Вид контракта",                  m_TableHeadStyle);
       m_rep.Put_Str("Контракт",                       m_TableHeadStyle);
       m_rep.Put_Str("Вид сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Место заключения сделки",        m_TableHeadStyle);
       m_rep.Put_Str("Дата расчётов по сделке",        m_TableHeadStyle);
       m_rep.Put_Str("Цена заявки",                    m_TableHeadStyle);
       m_rep.Put_Str("Цена одного фьючерсного контракта (размер премии по опциону)", m_TableHeadStyle);
       m_rep.Put_Str("Цена исполнения по опциону",     m_TableHeadStyle);
       m_rep.Put_Str("Кол-во",                         m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки, руб.",             m_TableHeadStyle);
       m_rep.Put_Str("Вариационная маржа, руб.",       m_TableHeadStyle);
       m_rep.Put_Str("Комиссия,компенсирующая биржевые сборы, руб.",                 m_TableHeadStyle);
       m_rep.Put_Str("Комиссия брокера, руб",          m_TableHeadStyle);
       m_rep.Put_Str("Примечание",                     m_TableHeadStyle);
       m_rep.Put_Str("","END;");
    END;

    macro C08(DealID)
       var q = " SELECT req.t_Price " +
               " FROM ddvdeal_dbt tk, dspground_dbt ground, dspgrdoc_dbt dealdoc, dspgrdoc_dbt reqdoc, ddl_req_dbt req " +
               " WHERE tk.t_ID = ? " +
               " AND dealdoc.t_sourcedocid = tk.t_ID " +
               " AND dealdoc.t_sourcedockind = 192 " +
               " AND ground.t_spgroundid = dealdoc.t_spgroundid " +
               " AND ground.t_spgroundid = reqdoc.t_spgroundid " +
               " AND dealdoc.t_sourcedocid != reqdoc.t_sourcedocid " +
               " AND dealdoc.t_sourcedockind != reqdoc.t_sourcedockind " +
               " AND reqdoc.t_sourcedocid = req.t_id " +
               " AND reqdoc.t_sourcedockind = req.t_kind " +
               " AND req.t_client = tk.t_client " +
               " AND rownum = 1 ";
       var cmd = DL_RSDCommand();
       cmd.AddParam(DealID);
       var ds = cmd.Execute(q);
       if (ds.moveNext)
         return ds.Price;
       end;
       return 0;
    end;

    macro MarginCall(p_IsMarginCall)
       var s:string = "";
       if(p_IsMarginCall == SET_CHAR)
         s = "Принудительное закрытие позиций";
       end;
       return s;
    end;

    MACRO GetContrID1(DlContID)
      var q = "select sf.T_ID from ddlcontrmp_dbt mp, dsfcontr_dbt sf where sf.t_servkind = " + PTSK_DV + " and sf.t_id = mp.t_sfcontrid and mp.T_DLCONTRID = ? ";
      var cmd = DL_RSDCommand();
      cmd.AddParam(DlContID);
      var ds = cmd.Execute(q);
      if (ds.moveNext)
        return ds.ID;
      end;
      return -1;
    END;
    MACRO GetContrID2(DlContID)
      var q = "select DLC.T_SFCONTRID from ddlcontr_dbt dlc where DLC.T_DLCONTRID = ? ";
      var cmd = DL_RSDCommand();
      cmd.AddParam(DlContID);
      var ds = cmd.Execute(q);
      if (ds.moveNext)
        return ds.SFCONTRID;
      end;
      return -1;
    END;
    MACRO GetContrID(DlContID)
      var id = GetContrID1(DlContID);
      if (id == -1)
        id = GetContrID2(DlContID);
      end;
      return id;
    END;

    macro CalcDealMargin(DealID)
       var q = " SELECT NVL(turn.t_Margin, 0) as Margin " +
               " FROM ddvdeal_dbt deal, ddvdlturn_dbt turn " +
               " WHERE deal.t_ID = ? " +
               " AND turn.t_DealID = deal.t_ID " +
               " AND turn.t_Date = (SELECT max(t_Date) FROM ddvdlturn_dbt WHERE t_DealID = deal.t_ID AND t_Date <= ?)  ";
       var cmd = DL_RSDCommand();
       cmd.AddParam(DealID);
       cmd.AddParam(m_RepParams.EndDate);
       var ds = cmd.Execute(q);
       if (ds.moveNext)
         return ds.Margin;
       end;
       return 0;
    end;

    macro CalcMarketComis(DealID, Market, DateCLR)
       var RetVal:money = $0.0;
       var cmd = DL_RSDCommand( " SELECT rsb_brkrep_rshb.DV_GetMarketComissSum(?,?,?) com_sum " +
                                "   FROM dual " );

       cmd.addParam(DealID);
       cmd.addParam(Market);
       cmd.addParam(DateCLR);       
       var comRec = cmd.execute();
       if( comRec.MoveNext())
          RetVal = money(comRec.com_sum);
       end;

       return RetVal;   
    end;

    macro CalcBrokerComis(DealID, DateCLR)
      var retVal = 0.0; var comTmp = 0.0;
      var q = " select dlc.t_sum, sfc.t_fiid_comm as fiid " +
              "            from ddvdlcom_dbt dlc, dsfcomiss_dbt sfc " +
              "           where dlc.t_DealID      = ? " +
              "             and dlc.t_ComissID    = sfc.t_ComissID " +
              "             and sfc.t_ReceiverID = ? " +
              "             and LOWER(sfc.t_code) not IN (LOWER('БрокерКомпенсацС')) ";
       var cmd = DL_RSDCommand();
       cmd.AddParam(DealID);
       cmd.AddParam({ourbank});
       var ds = cmd.Execute(q);
       while (ds.moveNext)
         comTmp = 0.0;
         DV_SmartConvertSumDbl(comTmp, ds.sum, DateCLR, ds.fiid, NATCUR);
         retVal = retVal + comTmp;
       end;
       return retVal;
    end;

    var ContID = GetContrID(m_DlContrData.DlContrID());
    var sql = GetDvDealSql(mode);
    var exec = DL_RSDCommand(sql);
    exec.addParam(ContID);
    exec.addParam(m_RepParams.ClientID);
    exec.addParam(ContID);
    if ( mode == BROKERREP_PART_DEALINPERIOD )
       exec.addParam(m_RepParams.BegDate);
       exec.addParam(m_RepParams.EndDate);
       exec.addParam(m_RepParams.BegDate);
       exec.addParam(m_RepParams.EndDate);
       //sql = sql + " and dv.t_date between ? and ? and dv.t_date_clr between ? and ? ORDER BY PlanID, DealID ";
    elif ( mode == BROKERREP_PART_EXECDEAL )
       exec.addParam(m_RepParams.BegDate);
       exec.addParam(m_RepParams.BegDate);
       exec.addParam(m_RepParams.EndDate);
       //sql = sql + " and dv.t_date < ? and dv.t_date_clr between ? and ? ORDER BY PlanID, DealID ";
    else
       exec.addParam(m_RepParams.BegDate);
       exec.addParam(m_RepParams.EndDate);
       //sql = sql + " and dv.t_date between ? and ? ORDER BY PlanID, DealID ";
    end;

    cnt = exec.GetCount();
    DealData = exec.execute();

    if(cnt)
       InitProgress(cnt, "Подготовка разделов отчета", "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА");

       while(DealData.moveNext())

          if(prevPlanID != DealData.PlanID)
             if(prevPlanID != -1)
                m_rep.Blank_Line();
             end;
             PrintHeaderAndCap();
          end;
          C12 = 0.0; C13 = 0.0; C14 = 0.0; C15 = 0.0;
          C03 = DealData.FIKind;
          if(StrUpr(DealData.FIKind) == "ОПЦИОН")
             C03 = C03 + IIF(DealData.OptionType == 1," - Put"," - Call");
          end;
          DV_SmartConvertSumDbl(C12, DealData.DealSum, DealData.ClrDate, DealData.ParentFI, NATCUR);
          DV_SmartConvertSumDbl(C13, CalcDealMargin(DealData.DealID), DealData.ClrDate, DealData.ParentFI, NATCUR);
          C14 = CalcMarketComis(DealData.DealID, DealData.Market, DealData.ClrDate);
          C15 = CalcBrokerComis(DealData.DealID, DealData.ClrDate); 
          m_rep.Put_Str("", "START;");

          m_rep.Put_Str(DealData.C01,           "BOR;P=C;");
          m_rep.Put_Str(string(date(DealData.DealDate):f) + " " + string(time(DealData.DealTime)), "BOR;P=C;"); // C02
          m_rep.Put_Str(C03,                    "BOR;P=C;");
          m_rep.Put_Str(DealData.C04,           "BOR;P=C;");
          m_rep.Put_Str(DealData.C05,           "BOR;P=C;");
          m_rep.Put_Str(DealData.C06,           "BOR;P=C;");
          m_rep.Put_Val(date(DealData.ClrDate), "BOR;P=C;T=D;"); // C07
          if(DealData.IsMarginCall == SET_CHAR)
              m_rep.Put_Str("",                 "BOR;P=C;");
          else 
              m_rep.Put_Val(C08(DealData.DealID),   "BOR;HA=R;VA=C;T=M4;");
          end;
          m_rep.Put_Val(DealData.C09,           "BOR;HA=R;VA=C;T=M4;");
          if(DealData.C10 != 0.0)
              m_rep.Put_Val(DealData.C10,       "BOR;HA=R;VA=C;T=N4;");
          else 
              m_rep.Put_Str("",                 "BOR;P=C;");
          end;
          m_rep.Put_Val(DealData.C11,           "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(C12,                    "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(C13,                    "BOR;HA=R;VA=C;T=N4;");
          m_rep.Put_Val(C14,                    "BOR;HA=R;VA=C;T=N4;");
          m_rep.Put_Val(C15,                    "BOR;HA=R;VA=C;T=N4;");  
          m_rep.Put_Str(MarginCall(DealData.IsMarginCall),   "BOR;P=C;");

          m_rep.Put_Str("","END;");

          prevPlanID = DealData.PlanID;

          UseProgress(i = i + 1);
       end;

       RemProgress();
       m_rep.Blank_Line();
     elif(m_RepParams.ShowEmpty)
       PrintHeaderAndCap();
       m_rep.Blank_Line();
     end;
  END; // PrintDvDeals

  PRIVATE MACRO ExistsPortfData()
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepinacc_tmp "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для СВОД без внебиржи
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  PRIVATE MACRO PrintPortfData()
     var query, cmd, DataSet;
     var InAccData = NULL;
     var prevPlaceID = NULL;
     var cnt = 0, i = 0;
     var PlaceName = "";

     PRIVATE MACRO ТекущиеПараметры(FIID, dt)
       var cmd = DL_RSDCommand(
                             " select 'купон '||case when fiwarnts.t_relativeincome = chr(88) "
                             + "                      then trim(to_char(fiwarnts.t_incomerate,'99999999999999999990.'||lpad('0',fiwarnts.t_incomepoint,'9'))) "
                             + "                      else trim(to_char(fiwarnts.t_incomevolume,'99999999999999999990.'||lpad('0',fiwarnts.t_incomepoint,'9')))||' '||nvl(fininstr.t_ccy,'?') "
                             + "                 end "

                             + "               ||case when dininstrp.t_drawingdate != to_date('01.01.0001','dd.mm.yyyy') "
                             + "                      then ' дата погашения '||to_char(dininstrp.t_drawingdate,'dd.mm.yyyy') "
                             + "                      else '' "
                             + "                 end " 

                             + "               || ' номинал '||case when RSB_FIINSTR.FI_GETNOMINALONDATE(d.t_fiid,?) > 0 then RSB_FIINSTR.FI_GETNOMINALONDATE(d.t_fiid,?) else dininstrp.t_facevalue end " /*CHVA 525951*/ 

                             + "               ||' '|| (select (select t_ccy from dfininstr_dbt where t_fiid = f.t_facevaluefi) from dfininstr_dbt f where f.t_fiid = d.t_fiid) t_cupon "
                             + "from dfiwarnts_dbt fiwarnts "
                             + "left join dfininstr_dbt fininstr on fininstr.t_fiid = fiwarnts.t_incomefi "
                             + "join (select t_fiid, t_id "
                             + "      from (select fiwarnts.t_fiid, fiwarnts.t_id "
                             + "            from dfiwarnts_dbt fiwarnts "
                             + "            where fiwarnts.t_fiid = ? and "
                             + "                  fiwarnts.t_drawingdate >= ? "
                             + "            order by fiwarnts.t_drawingdate, fiwarnts.t_id desc) "
                             + "      where rownum = 1) d on rsi_rsb_fiinstr.FI_IsCouponAvoiriss(d.t_fiid) = 1 and "
                             + "                             fiwarnts.t_id = d.t_id "
                             + "join dfininstr_dbt dininstrp on dininstrp.t_fiid = d.t_fiid"
                             + " left join dobjcode_dbt o  on t_objecttype = 9 and t_codekind = 104 and t_objectid = d.t_fiid "
                            ); 
       cmd.AddParam(dt);  /*CHVA 525951*/ 
       cmd.AddParam(dt);
       cmd.AddParam(FIID);
       cmd.AddParam(dt);
       var dataSet = cmd.Execute();
       if(dataSet.movenext())
         return dataSet.cupon;
       else
         cmd = DL_RSDCommand("select 'дата погашения '||to_char(fininstr.t_drawingdate,'dd.mm.yyyy') "
                             + "               || ' номинал '||case when RSB_FIINSTR.FI_GETNOMINALONDATE(fininstr.t_fiid,?) > 0 then RSB_FIINSTR.FI_GETNOMINALONDATE(fininstr.t_fiid,?) else fininstr.t_facevalue end " /*PNV 511546*/ 
                             + "               ||' '|| (select (select t_ccy from dfininstr_dbt where t_fiid = f.t_facevaluefi) from dfininstr_dbt f where f.t_fiid = fininstr.t_fiid) "
                             + "  t_cupon "
                           + "from dfininstr_dbt fininstr "
                           + "where fininstr.t_fiid = ? and "
                           + "      fininstr.t_drawingdate != to_date('01.01.0001','dd.mm.yyyy')");
         cmd.AddParam(dt);
         cmd.AddParam(dt);  /*PNV 511546*/ 
         cmd.AddParam(FIID);
         dataSet = cmd.Execute();
         if(dataSet.movenext())
           return dataSet.cupon;
         else
           return "";
         end;
       end;
     END;

     //Напечатать итоговые строки
     MACRO PrintItogLines()
       var q, Select, ds;
       
       Select = DL_RSDCommand();
       
       q =   " select t_A55, t_A56, t_A56_1, t_A57, t_A57_1, t_A58, t_A58_1, t_A61, t_A63 "
           + "   from dbrkrepinacc_tmp  "
           + "  where t_IsItog = 'X' ";

       if(m_DlContrData.ServKind() != 0)
         q = q + " and t_ServKind = ? "
               + " and t_ServKindSub = ? ";

         Select.AddParam(m_DlContrData.ServKind());
         Select.AddParam(m_DlContrData.ServKindSub());
       else
         q = q + " and t_ServKindSub <> 9 "; //Для СВОД без внебиржи
       end;

       if(m_DlContrData.MarketID() > 0)
         q = q + " and t_MarketID = ? ";
         Select.AddParam(m_DlContrData.MarketID())
       end;

       if(Select.GetCount(q))
         ds = Select.Execute(q);
         
         m_Rep.Set_WrapText(1);
         while(ds.moveNext())
           m_rep.Put_Str("", "START;");
           m_rep.Put_Str("Итого ", "BOR;P=C;FB;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",       "BOR;P=C;R=1;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A55,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A55)+";IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A56,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A56)+";IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A57,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A57)+";IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A58,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A58)+";IC="+m_ItogCellColor+";");
           if(m_RepParams.ShowPlanRest == true)
             m_rep.Put_Val(ds.A58_1, "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A58_1)+";IC="+m_ItogCellColor+";");
           end;
           m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
           if(m_RepParams.CourseCurVisible)
             m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
           end;
           m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A61,   "BOR;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A63,   "BOR;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");

           m_rep.Put_Str("","END;");
         end;
       end;
     END;

     // Печать заголовка и шапки таблицы
     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("Отчет/Выписка о движении по счету: Счет/Раздел счета ДЕПО: ", "HA=L;R=3;");
     m_rep.Put_Str(m_DlContrData.DepoAcc()+"/"+m_DlContrData.DepoPart(), "HA=L;END;");

     m_rep.Set_WrapText(1);
     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("Номер гос. регистрации/ISIN", m_TableHeadStyle);
     m_rep.Put_Str("Выпуск ЦБ",                   m_TableHeadStyle+"R=1;");
     m_rep.Put_Str("Текущие параметры",           m_TableHeadStyle);
     m_rep.Put_Str("Остаток входящий",            m_TableHeadStyle);
     m_rep.Put_Str("Зачислено",                   m_TableHeadStyle);
     m_rep.Put_Str("Списано",                     m_TableHeadStyle);
     m_rep.Put_Str("Остаток исходящий",           m_TableHeadStyle);
     if(m_RepParams.ShowPlanRest == true)
       m_rep.Put_Str("Остаток исходящий (ПЛАНОВЫЙ)",    m_TableHeadStyle);
     end;
     m_rep.Put_Str("Котировка",                   m_TableHeadStyle);

     if(m_RepParams.CourseCurVisible)
       m_rep.Put_Str("Валюта котировки",                   m_TableHeadStyle);
     end;

     m_rep.Put_Str("Стоимость (6*"+IIF(m_RepParams.ShowPlanRest == true, "8","7")+")",             m_TableHeadStyle);
     m_rep.Put_Str("Стоимость в рублях",          m_TableHeadStyle);
     m_rep.Put_Str("НКД",                         m_TableHeadStyle);
     m_rep.Put_Str("НКД в рублях",                m_TableHeadStyle);
     m_rep.Put_Str("","END;");

     i = 0;
     m_rep.Set_WrapText(1);
     m_rep.Put_Str("","START;");
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle+"R=1;");
     m_rep.Put_Str(string(i)+"a", m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     if(m_RepParams.ShowPlanRest == true)
       m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     end;
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     if(m_RepParams.CourseCurVisible)
       m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     end;
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str(string(i=i+1), m_TableHeadStyle);
     m_rep.Put_Str("","END;");


     cmd = DL_RSDCommand();

     query =   " select t_FIID, t_A53, t_A54, t_A55, t_A56, t_A56_1, t_A57, t_A57_1, t_A58, t_A58_1, t_A59, t_A60, t_A61, t_A62, t_A63, "
             + "   NVL((select fin59.t_CCY from dfininstr_dbt fin59 where fin59.t_FIID = t_A59_1), CHR(1)) t_A59_CCY "
             + "   from dbrkrepinacc_tmp "
             + "  where t_IsItog = CHR(0) ";

     if(m_DlContrData.ServKind() != 0)
       query = query + " and t_ServKind = ? "
                     + " and t_ServKindSub = ? ";

       cmd.AddParam(m_DlContrData.ServKind());
       cmd.AddParam(m_DlContrData.ServKindSub());
     else
       query = query + " and t_ServKindSub <> 9 "; //Для СВОД без внебиржи
     end;

     if(m_DlContrData.MarketID() > 0)
       query = query + " and t_MarketID = ? ";
       cmd.AddParam(m_DlContrData.MarketID())
     end;

     cnt = cmd.GetCount(query);

     if(cnt)

       InAccData = cmd.Execute(query);

       InitProgress(cnt, "Подготовка раздела", "Состав портфеля по итогам торгов");

       while(InAccData.moveNext())
         m_rep.Put_Str("","START;");
         m_rep.Put_Str(InAccData.A53,   "BOR;P=C;");
         m_rep.Put_Str(InAccData.A54,   "BOR;P=C;R=1;");
         m_rep.Put_Str(ТекущиеПараметры(InAccData.FIID, m_RepParams.EndDate),   "BOR;P=C;");
         m_rep.Put_Val(InAccData.A55,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A55)+";");
         m_rep.Put_Val(InAccData.A56,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A56)+";");
         m_rep.Put_Val(InAccData.A57,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A57)+";");
         m_rep.Put_Val(InAccData.A58,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A58)+";");
         if(m_RepParams.ShowPlanRest == true)
           m_rep.Put_Val(InAccData.A58_1, "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A58_1)+";");
         end;
         m_rep.Put_Val(InAccData.A59,   "BOR;HA=R;VA=C;T=M2;");
         if(m_RepParams.CourseCurVisible)
           m_rep.Put_Str(InAccData.A59_CCY, "BOR;P=C;");
         end;
         m_rep.Put_Val(InAccData.A60,   "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(InAccData.A61,   "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(InAccData.A62,   "BOR;HA=R;VA=C;T=M2;");
         m_rep.Put_Val(InAccData.A63,   "BOR;HA=R;VA=C;T=M2;");

         m_rep.Put_Str("","END;");

         UseProgress(i = i + 1);
       end;

       RemProgress();

       PrintItogLines();
       m_rep.Blank_Line();
     end;
  END;

   MACRO AddStandardFooter(mode, count: integer, notServOp:bool, SheetNum)/*CHVA 510695*/
     MACRO Операционист():string

         var cmd = DL_RSDCommand("SELECT person.t_Name " +
                                    "  FROM dperson_dbt person " +
                                    " WHERE person.t_PartyID = ? "
                                   );
            cmd.AddParam(m_repparams.SignerParty);

         var RS = cmd.Execute();
         if( RS.MoveNext() )
            return RS.Name;
         else 
            cmd = null;
            cmd = DL_RSDCommand("SELECT person.t_Name " +
                                    "  FROM dperson_dbt person " +
                                    " WHERE person.t_Oper = ? "
                                   );
            cmd.AddParam({oper});
            if( RS.MoveNext() )
               return RS.Name;
            end;
         end;
         return "";
     END;

     MACRO ДолжностьОперациониста():string
         return "Исполнитель";
     END;

     MACRO ТелефонОперациониста():string
         return "(495) 363-02-94";
         var PhoneNumber = "";
         var cmd = DL_RSDCommand("SELECT person.t_PartyID "
                                 "  FROM dperson_dbt person " +
                                 " WHERE person.t_Oper = ? "
                                );
         cmd.AddParam({oper});

         var RS = cmd.Execute();
         if( ( RS.MoveNext() ) and ( FindAdressContactValue( RS.PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber ) == 0 ) )
            return PhoneNumber;
         end;
         return "";
     END;
     
     var STAMPTagName = String("STAMP__",/*m_repparams.repimgdata.size + 1*/SheetNum);
     var SIGNTagName = String("SIGN_1__",/*m_repparams.repimgdata.size + 1*/SheetNum);
     var PostOper;

     if(valtype(mode) == V_UNDEF)
       mode = 0;
     end;

     PostOper = ДолжностьОперациониста();

     m_rep.Set_WrapText(0);

     if(mode == 0)
       m_rep.Blank_Line();

//dan>
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("Подпись1", "FC=W;END;CN="+SIGNTagName+";");
//<dan

       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   " + PostOper + ": " + Операционист(),"START;P=L;END;");
       m_rep.Put_Str("   М.П.", "START;P=L;END;");/*CHVA 515949*/

//dan>
       m_rep.Blank_Line();
       m_rep.Put_Str("", "START");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       //m_rep.Put_Str("Печать", "FC=W;END;CN=STAMP;"); 
       m_rep.Put_Str("Печать", "FC=W;END;CN="+STAMPTagName+";");
//<dan

       m_rep.Blank_Line();
       m_rep.Put_Str("Дата составления: " + GetDateS(GetCDS()), "START;P=L;END;");

       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   Отчет получен", "START;P=L;END;");
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   Клиент_________________________/_________________/Подпись", "START;P=L;END;");
       m_rep.Blank_Line();
       m_rep.Put_Str("   ""____""______________20___г.", "START;P=L;END;");
     else

       //dan>
       m_rep.Blank_Line(mode);
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("Подпись1", "FC=W;CN="+SIGNTagName+";");

       m_rep.Put_Str("", "");
       m_rep.Put_Str("Печать", "FC=W;END;CN="+STAMPTagName+";");

       //<dan

       //dan>
       m_rep.Blank_Line(mode);
       m_rep.Put_Str("", "START");
       m_rep.Put_Str("Печать", "FC=W;END;CN="+STAMPTagName+";");

       //<dan

       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();

       m_rep.Blank_Line(mode);
       m_rep.Put_Val(PostOper,"START;VA=C;HA=R;FS=8;", mode);
       m_rep.Put_Val("____________________","P=C;FB;FS=8;");
       m_rep.Put_Val("/ "+Операционист()+" /","VA=C;HA=L;FB;FS=8;END;");
       m_rep.Put_Val("","START;", mode);
       m_rep.Put_Val("М.П,","P=C;FB;FS=8;");
       m_rep.Put_Val("","END;");
       m_rep.Blank_Line(mode);
       m_rep.Put_Val("Отчет получен","START;VA=C;HA=R;FS=8;", mode);
       m_rep.Put_Val("____________________","P=C;FB;FS=8;D=1");
       m_rep.Put_Val("/____________________/","VA=C;HA=L;FB;FS=8;D=1;END;");
       m_rep.Put_Val("Клиент","START;VA=C;HA=R;FS=8;END;", mode);
       m_rep.Blank_Line(mode);
       m_rep.Put_Val("\"____\"______________20___г.","START;VA=C;HA=L;FS=8;END;", mode);
       m_rep.Blank_Line(mode);
     end;

   END;
/*~ak*/


  PRIVATE MACRO PrintReport(DlContrID:integer, notServOp : bool)
    var Num = 0;
    var sNum = 0;
    var SheetCount = 0;

    if(m_RepParams.IsMarket == true)
      //СВОД
      m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, 0, 0);

      m_rep.Print_Header("СВОД", "Arial", 9);
      SheetCount = SheetCount + 1;
      //Залоговок
      
      PrintHeader(true,SheetCount);
      //Остатки и Движение д/с
      Num = Num + 1;
      PrintAccMoneyMoving(true, true);
      //Активы
      Num = Num + 1;
      PrintActive();
      
//      m_rep.AddStandardFooter(1);
      AddStandardFooter(null, num, /*notServOp*/True, SheetCount);/*CHVA 510695*/

      UseProgress(1);
   
      //субсчет ЕДП
      if(m_DlContrData.IsEDP() == true)
        Num = 0;
        
        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, 0, 0);
        if((m_RepParams.ShowEmpty) or (m_DlContrData.ExistAcc() == true))
          m_rep.Print_Header("субсчет ЕДП", "Arial", 9, true);
          SheetCount = SheetCount + 1;
          //Залоговок
          PrintHeader(null,SheetCount);
          //Остатки и Движение д/с
          Num = Num + 1;
          PrintAccMoneyMoving(false, false);
          
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_REPOINPERIOD)))
            Num = Num + 1;

            //Сделки ФР
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
              sNum = SNum + 1;
              PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPOINPERIOD)))
              sNum = SNum + 1;
              PrintSecurDealsByMode(BROKERREP_PART_REPOINPERIOD, string(Num,".",sNum));
            end;
          end;

          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL)))  
            //Сделки ранее ФР
            sNum = sNum + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num + "." + sNum + ". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
              sNum = sNum + 1;
              PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPODEAL)))
              sNum = sNum + 1;
              PrintSecurDealsByMode(BROKERREP_PART_REPODEAL, string(Num,".",sNum));
            end;
          end;

          if (true)
            sNum = sNum + 1;
            //Сделки ВР
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(iif(Num > 1,Num + "." + sNum, Num + sNum)+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ НА ВАЛЮТНОМ РЫНКЕ", "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            PrintCurrDealsByMode(BROKERREP_PART_DEALINPERIOD);
          end;
            
          if (true)
            sNum = sNum + 1;
            //Сделки СР
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(iif(Num > 1,Num + "." + sNum, Num + sNum)+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ НА СРОЧНОМ РЫНКЕ", "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            PrintDvDealsByMode(BROKERREP_PART_DEALINPERIOD);      
          end;

          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL+","+BROKERREP_PART_CANCELREPO)))  
            //Отмена ФР
            sNum = sNum + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num + "." + sNum+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL)))
              PrintSecurDealsByMode(BROKERREP_PART_CANCELDEAL);
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELREPO)))
              PrintSecurDealsByMode(BROKERREP_PART_CANCELREPO);
            end;
          end;
          // пользовательская подпись>
          //m_rep.AddStandardFooter(1);
            AddStandardFooter(null, num, notServOp, SheetCount);/*CHVA 510695*/
          // <пользовательская подпись
        end;
      end;

      UseProgress(2);
    
      if(m_DlContrData.IsEDP() == false)

        //субсчет Фондовый Рынок
        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_STOCKDL, 8/*Биржевой рынок*/, MMVB_ID());
        if((m_RepParams.ShowEmpty) or (m_DlContrData.ExistAcc() == true))
          Num = 0;
          
          m_rep.Print_Header("субсчет Фондовый Рынок", "Arial", 9, true);
          SheetCount = SheetCount + 1;
          //Залоговок
          PrintHeader(null,SheetCount);
          //Остатки и Движение д/с
          Num = Num + 1;
          PrintAccMoneyMoving(true, false);
          //Активы
          Num = Num + 1;
          PrintActive();
          
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_REPOINPERIOD)))
            //Сделки ФР
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
              PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD);
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPOINPERIOD)))
              PrintSecurDealsByMode(BROKERREP_PART_REPOINPERIOD);
            end;
          end;
          
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL)))
            //Сделки ранее ФР
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
              PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL);
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPODEAL)))
              PrintSecurDealsByMode(BROKERREP_PART_REPODEAL);
            end;
          end;

          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL+","+BROKERREP_PART_CANCELREPO)))  
            //Отмена ФР
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL)))
              PrintSecurDealsByMode(BROKERREP_PART_CANCELDEAL);
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELREPO)))
              PrintSecurDealsByMode(BROKERREP_PART_CANCELREPO);
            end;
          end; 

          if((m_RepParams.ShowEmpty) or (ExistsPortfData()))
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СОСТАВ ПОРТФЕЛЯ ПО ИТОГАМ ТОРГОВ С "+DL_DateToStr(m_RepParams.BegDate:f)+" ПО "+DL_DateToStr(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();

            PrintPortfData();
          end;

//          m_rep.AddStandardFooter(1);
          AddStandardFooter(null, num, /*notServOp*/ True, SheetCount);/*CHVA 510695*/
        end;
        
        UseProgress(3);

        //субсчет Валютный Рынок
        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_CM, 8/*Биржевой рынок*/);
        if((m_RepParams.ShowEmpty) or (m_DlContrData.ExistAcc() == true))
          m_rep.Print_Header("субсчет Валютный Рынок", "Arial", 9, true);
          SheetCount = SheetCount + 1;
          //Залоговок
          PrintHeader(null,SheetCount);
          //Остатки и Движение д/с
          PrintAccMoneyMoving(true, false);

          //Сделки ВР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          // m_rep.Put_Str("2.4 СДЕЛКИ, ЗАКЛЮЧЕННЫЕ НА ВАЛЮТНОМ РЫНКЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Put_Str("2.4 СДЕЛКИ, ЗАКЛЮЧЕННЫЕ НА ВАЛЮТНОМ РЫНКЕ", "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          //Сделки
          PrintCurrDealsByMode(BROKERREP_PART_DEALINPERIOD);
          
          //Сделки ранее ВР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str("2.5 СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          //Сделки
          PrintCurrDealsByMode(BROKERREP_PART_EXECDEAL);

          //Отмена ВР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str("2.6 СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          //Сделки
          PrintCurrDealsByMode(BROKERREP_PART_CANCELDEAL);

//          m_rep.AddStandardFooter(1);
          AddStandardFooter(null, num, /*notServOp*/ True, SheetCount);/*CHVA 510695*/
        end;

        UseProgress(4);

        //субсчет Срочный Рынок
        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_DV, 8/*Биржевой рынок*/);
        if((m_RepParams.ShowEmpty) or (m_DlContrData.ExistAcc() == true))
          m_rep.Print_Header("субсчет Срочный Рынок", "Arial", 9, true);                                                                                                         
          SheetCount = SheetCount + 1;
          //Залоговок
          PrintHeader(null,SheetCount);
          //Остатки и Движение д/с
          PrintAccMoneyMoving(true, false);
          //Активы
          PrintActive();

          //Сделки СР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str("3. СДЕЛКИ, ЗВАКЛЮЧЕННЫЕ НА СРОЧНОМ РЫНКЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          PrintDvDealsByMode(BROKERREP_PART_DEALINPERIOD);

          //Сделки ранее СР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str("4. СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          PrintDvDealsByMode(BROKERREP_PART_EXECDEAL);
          
//          m_rep.AddStandardFooter(1);
          AddStandardFooter(null, num, /*notServOp*/True, SheetCount);/*CHVA 510695*/
        end;

        UseProgress(5);

        //субсчет ИЦБ СПБ
        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_STOCKDL, 8/*Биржевой рынок*/, SPB_ID());
        if((m_RepParams.ShowEmpty) or (m_DlContrData.ExistAcc() == true))
          Num = 0;
          
          m_rep.Print_Header("субсчет ИЦБ СПБ", "Arial", 9, true);
          SheetCount = SheetCount + 1;
          //Залоговок
          PrintHeader(null,SheetCount);
          //Остатки и Движение д/с
          Num = Num + 1;
          PrintAccMoneyMoving(true, false);
          //Активы
          Num = Num + 1;
          PrintActive();
          
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_REPOINPERIOD)))
            //Сделки ФР
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
              PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD);
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPOINPERIOD)))
              PrintSecurDealsByMode(BROKERREP_PART_REPOINPERIOD);
            end;
          end;
          
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL)))
            //Сделки ранее ФР
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
              PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL);
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPODEAL)))
              PrintSecurDealsByMode(BROKERREP_PART_REPODEAL);
            end;
          end;

          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL+","+BROKERREP_PART_CANCELREPO)))  
            //Отмена ФР
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();
            //Сделки
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL)))
              PrintSecurDealsByMode(BROKERREP_PART_CANCELDEAL);
            end;
            //РЕПО
            if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELREPO)))
              PrintSecurDealsByMode(BROKERREP_PART_CANCELREPO);
            end;
          end; 

          if((m_RepParams.ShowEmpty) or (ExistsPortfData()))
            Num = Num + 1;
            m_rep.Put_Str("", "START;");
            m_rep.Put_Str(Num+". СОСТАВ ПОРТФЕЛЯ ПО ИТОГАМ ТОРГОВ С "+DL_DateToStr(m_RepParams.BegDate:f)+" ПО "+DL_DateToStr(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
            m_rep.Blank_Line();

            PrintPortfData();
          end;

//          m_rep.AddStandardFooter(1);
          AddStandardFooter(null, num, /*notServOp*/True, SheetCount);/*CHVA 510695*/
        end;

        UseProgress(6);
      end;
    end;

    //субсчет внебирж.
    if(m_RepParams.IsOutMarket == true)
      Num = 0;
      m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_STOCKDL, 9/*Внебиржевой рынок*/);
      if((m_RepParams.ShowEmpty) or (m_DlContrData.ExistAcc() == true))
        m_rep.Print_Header("субсчет внебирж.", "Arial", 9, IIF(m_RepParams.IsMarket == true, true, false));
        SheetCount = SheetCount + 1;
        //Залоговок
        PrintHeader(null,SheetCount);
        //Остатки и Движение д/с
        Num = Num + 1;
        PrintAccMoneyMoving(true, false);
        //Активы
        Num = Num + 1;
        PrintActive();
        
        if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_REPOINPERIOD)))
          //Сделки ФР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str(Num+".  СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          //Сделки
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
            PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD);
          end;
          //РЕПО
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPOINPERIOD)))
            PrintSecurDealsByMode(BROKERREP_PART_REPOINPERIOD);
          end;
        end;
        
        if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL)))
          //Сделки ранее ФР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str(Num+".  СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          //Сделки
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
            PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL);
          end;
          //РЕПО
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPODEAL)))
            PrintSecurDealsByMode(BROKERREP_PART_REPODEAL);
          end;
        end;

        if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL+","+BROKERREP_PART_CANCELREPO)))  
          //Отмена ФР
          Num = Num + 1;
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str(Num+". СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ОТМЕНЕННЫЕ В ПЕРИОД С "+string(m_RepParams.BegDate:f)+" ПО "+string(m_RepParams.EndDate:f), "HA=L;R=6;FB;END;");
          m_rep.Blank_Line();
          //Сделки
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL)))
            PrintSecurDealsByMode(BROKERREP_PART_CANCELDEAL);
          end;
          //РЕПО
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELREPO)))
            PrintSecurDealsByMode(BROKERREP_PART_CANCELREPO);
          end;
        end;

//        m_rep.AddStandardFooter(1);
        AddStandardFooter(null, num, notServOp, SheetCount);/*CHVA 510695*/
      end;
    end;

    UseProgress(7);  

    if(m_rep.ExistDataPrint() == true)
      m_rep.Print_Bottom();
    else
      m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, 0, 0);

      m_RepParams.NoData = true;
      msgbox("Нет данных для выпуска отчета по ДБО №"+m_DlContrData.ContrNumber());
    end;

  END;

  // Поиск сделок без связанных заявок 
  PRIVATE MACRO CheckApplicationsAndAssignments() : bool
    var query = "   SELECT deals.t_A07        AS DealCode,"
              + "          sk.t_Name          AS ServKindName,"
              + "          period.t_szNameAlg AS PeriodName"
              + "     FROM (SELECT DISTINCT t.t_A07,"
              + "                  t.t_ServKind,"
              + "                  t.t_ClientID"
              + "             FROM dbrkrepdeal_tmp t"
              + "            WHERE     t.t_ClientID  = ?"
              + "                  AND t.t_ContrID   > 0"
              + "                  AND t.t_IsItog    = CHR(0)"
              + "                  AND t.t_A07      <> CHR(1)"
              + "                  AND t.t_A95      IS NULL"
              + "                  AND t.t_A95_M     = CHR(1)"
              + "                  AND t.t_Part     IN (" + BROKERREP_PART_DEALINPERIOD + ", "
                                                          + BROKERREP_PART_REPOINPERIOD + ", "
                                                          + BROKERREP_PART_EXECDEAL     + ", "
                                                          + BROKERREP_PART_REPODEAL     + ", "
                                                          + BROKERREP_PART_CANCELDEAL   + ", "
                                                          + BROKERREP_PART_CANCELREPO   + ")) deals,"
              + "          dservkind_dbt sk,"
              + "          dnamealg_dbt  period"
              + "    WHERE     sk.t_ServiseKind      = deals.t_ServKind"
              + "          AND period.t_iTypeAlg     = " + ALG_SCREPPERIODKIND
              + "          AND period.t_iNumberAlg   = ?"
              + " ORDER BY deals.t_A07,"
              + "          deals.t_ServKind";

    var cmd = DL_RSDCommand(query);
    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(m_RepParams.PeriodKind);
    
    var errMes   = null;
    var DataSet  = cmd.Execute();
    var firstStr = true;
    var errMesMail = "", errGetMailTempl = null;
    var errMailTempl;
    var clientCode:string = "";

    while (DataSet.moveNext())
      if (firstStr)
        m_RepParams.NoReq = true;
        clientCode        = ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR);
        errMes            = "Ошибка! По клиенту \"" + clientCode + "\" отсутствуют заявки-поручения по сделкам: ";
        firstStr          = false;
      else
        errMes = errMes + ", ";
        errMesMail = errMesMail + ", "; 
      end;

      errMes = errMes + "\"" + DataSet.DealCode + " (" + DataSet.ServKindName + ")\"";
      errMesMail =  errMesMail + "\"" + DataSet.DealCode + " (" + DataSet.ServKindName + ")\"";
    end;

    if (errMes != null)
      msgbox(errMes);

      if (m_RepParams.InServOp)
        errMailTempl = GetErrMailTempl(BROKERREP_ERRMAILTEMPL_NOREQ, @errGetMailTempl);
        if (ValType(errMailTempl) == V_GENOBJ)
          m_RepParams.ErrMails[m_RepParams.ErrMails.Size] = CBrokerRepRSHBErrMail(errMailTempl.Subject, 
                                                                                  StrSubst(StrSubst(errMailTempl.Body, 
                                                                                                    "<код клиента>", clientCode),
                                                                                                    "<Номера сделок>", errMesMail));
          return true;
        else
          msgbox(errGetMailTempl);
        end;
      end;

      return true;
    end;

    return true;
  END;

  //Создание файла отчета следующим образом:
  //если отчет выпускается сам по себе, т.е. из пункта меню:
  // - в двухзвенке он формируется на СП,  
  // - в трехзвенке на терминале
  //если отчет выпускается в сервисной операции отправки:
  // - в двухзвенке он формируется на СП
  // - в трехзвенке при работе с конвейерами он формируется на СП
  // - в трехзвенке без конвейеров он формируется на терминале, но затем перемещается на СП
  MACRO CreateReport()
    var err = 0;
    var query, cmd, DataSet;
    var cnt = 0;
    var resultFileName = "";
    var ShowFilePath = "";
    var CreateDate = date();
    var CreateTime = time();
    var day, mon, year;
    var hour, min, sec;
    var repeatCount: Integer = 0;
    var maxRepeatCount: Integer = 5;
    var isRepeat: Bool = false;

    if (not CheckApplicationsAndAssignments())
      return;
    end;

     macro NewList(list:@tarray, str)
      var i = 0;
      var j = 1;
      var k = index(str, "/");
      while(k > 0)
        str = substr(str,1,k-1)+"-"+substr(str,k+1);
        k = index(str, "/");
      end;
      while(i < list.size)
        if(list[i] == str)
          j = j + 1;
        end;
        i = i + 1;
      end;
      list[list.size] = str;
      if(j == 1)
        return str;
      else
        return str + " (" + j + ")";
      end;
    end;
    
    /*ak*/
    var InOneList;
    if(m_RepParams.InServOp)
      InOneList = false;
    else
      InOneList = true;
    end;
    /*~ak*/


    DateSplit(m_RepParams.EndDate/*CreateDate*/, day, mon, year);
    TimeSplit(CreateTime, hour, min, sec);

    m_CurrentRepName = "!" + ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR)
                       //+"_"+string(year)+string(mon:f)+string(day:f)
                       +"_"+string(year)+string(mon:o:2)+string(day:o:2)
                       +"_"+string(hour:f)+string(min:f)+string(sec:f);


    //dan> Переопределение имени отчета
    var v_RepName;
    var ListArr = tarray;
    var v_cmd = DL_RSDCommand(String("SELECT sfc.t_number \n",
                       "   FROM ddlcontr_dbt dlc, dsfcontr_dbt sfc  \n",
                       "  WHERE sfc.t_id = dlc.t_sfcontrid AND dlc.t_dlcontrid = ?"));
        v_cmd.AddParam( m_RepParams.dlcontrid);               
    var v_ds = v_cmd.Execute();
    while(v_ds.movenext())
      v_RepName = NewList(@ListArr, v_ds.t_NUMBER);
    end;
    if(v_RepName !="")
      //m_CurrentRepName = String(v_RepName, "_", string(year), string(mon:f), string(day:f));
      m_CurrentRepName = String(v_RepName, "_", string(year), string(mon:o:2), string(day:o:2));
    end;
    //<dan Переопределение имени отчета    

   //Поиск сделок без связанных заявок 
/*   var query1, cmd1, DataSet1, cnt1; 
   query1 =   " select DISTINCT t_A07 "
            + "   from dbrkrepdeal_tmp  "
            + "  where t_ClientID = ? "
            + "    and t_ContrID > 0 "
            + "    and t_IsItog = CHR(0) "
            + "    and t_A07 <> CHR(1) "
            + "    and t_A95 IS NULL and t_A95_M = CHR(1) " 
            + "    and t_Part IN ("+BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_NOTEXECDEAL+","+BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_REPODEAL+") " 
            + "  order by t_A07 ";
    cmd1 = DL_RSDCommand(query1);
    cmd1.AddParam(m_RepParams.ClientID);
    
    cnt1 = cmd1.GetCount();
    if(cnt1 > 0)
       m_RepParams.NoReq = true;
       DataSet1 = cmd1.Execute();

       var errMes = "Ошибка! По клиенту \""+ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR)+"\" отсутствуют заявки-поручения по сделкам: ";
       var firstStr = true;
       while(DataSet1.moveNext())
          errMes = errMes + IIF(firstStr, "", ", ") + "\"" + DataSet1.A07 + "\"";
          firstStr = false;
       end;
       msgbox(errMes);
       return;
    end; */
    
    InitProgress(7, "Формирование отчета", "Формирование отчета");

    //используем apache poi для генерации сразу xlsx (используется другой класс)
    m_rep.Init("utf8", m_RepParams.IsApp, 42);

    m_rep.Set_Column_Width(/* 1*/  26,
                           /* 2*/  74,
                           /* 3*/  82,
                           /* 4*/  49,
                           /* 5*/  98,
                           /* 6*/  114,
                           /* 7*/  124,
                           /* 8*/  80,
                           /* 9*/  103,
                           /*10*/  67,
                           /*11*/  87,
                           /*12*/  107,
                           /*13*/  65,
                           /*14*/  89,
                           /*15*/  66,
                           /*16*/  121,
                           /*17*/  65,
                           /*18*/  64,
                           /*19*/  58,
                           /*20*/  62,
                           /*21*/  53,
                           /*22*/  60,
                           /*23*/  60,
                           /*24*/  66,
                           /*25*/  67,
                           /*26*/  71,
                           /*27*/  71,
                           /*28*/  65,
                           /*29*/  71,
                           /*30*/  71,
                           /*31*/  71);

    m_rep.Set_Landscape();
    m_rep.Set_Indent(0);

    PrintReport(m_RepParams.DlContrID, InOneList);

    if(m_rep.ExistDataPrint() == true)

      //если мы сейчас работаем под wine, то используем poi для генерации excel файла
      //к этому моменту m_rep уже и так - poi, но он ещё держит файл в памяти, поэтому его остаётся только сохранить

      var brokFileManager = BrokerRepFileStatusManager(m_CurrentRepName+".xlsx", not m_RepParams.InServOp);

      m_rep.Save(brokFileManager.Get_GENERATED_REPORTS_path());

      if(m_RepParams.ExcelFormat == true)
        brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);
        if (not err)
          m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepRSHBData(brokFileManager.Get_CURRENT_filename_with_ext(), SC_SRVREPFORMAT_EXCEL_XLSX, CreateDate, CreateTime, m_RepParams.DlContrID);
        end;
        if((not err) and (m_RepParams.ShowFile == true))
          brokFileManager.ShowFile();
        end;
      end;

      if(m_RepParams.PdfFormat == true)
        brokFileManager = BrokerRepFileStatusManager(m_CurrentRepName + ".pdf", not m_RepParams.InServOp);
        err = POIAddPictureAndConvertToPDF(m_rep, brokFileManager.Get_CURRENT_path_no_file_name(), m_RepParams.SignerParty, brokFileManager.Get_CURRENT_filename_with_no_ext());

        brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);

        if (not err)
          m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepRSHBData(brokFileManager.Get_CURRENT_filename_with_ext(), SC_SRVREPFORMAT_PDF, CreateDate, CreateTime, m_RepParams.DlContrID);
        end;

        if((not err) and (m_RepParams.ShowFile == true))
          brokFileManager.ShowFile();
        end;
      end;

    end;
    
    m_rep.Delete();
    RemProgress();

  END;

END;


MACRO SC_CreateRepBrokerRSHB(params)
  var query, cmd, DataSet;
  var DlContrID = params.DlContrID;
  var err = 0;

  params.RepData.size = 0;
  params.NoData = params.NoReq = false;

  GetRegistryValue( "SECUR\\BROKER_REPORT\\COURSE_CURRENCY_COLUMN_VISIBLE", V_BOOL, params.CourseCurVisible, err );
  if(err != 0)
    params.CourseCurVisible = false;
  end;
  

  cmd = DL_RSDCommand();

  //Если в параметрах запуска не задан ДБО, то отбираем все ДБО клиента
  query =  string( " select dlc.t_DlContrID "
                  ,"   from ddlcontr_dbt dlc, dsfcontr_dbt sf "
                  ,"  where sf.t_ID = dlc.t_SfContrID "
                  ,"    and sf.t_PartyID = ? "
                  );

  cmd.AddParam(params.ClientID);

  if(params.DlContrID > 0)
    query = query + " and dlc.t_DlContrID = ? ";
    
    cmd.AddParam(params.DlContrID);
  end;
/* dan > исключаем закрытые договора */
    query = query + string(" AND sf.t_datebegin <= " + GetSQLDate(params.enddate) + " \n",
                           " AND (   sf.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') \n",
                           "      OR sf.t_dateclose >= " + GetSQLDate(params.enddate) + ") \n");
/*< dan*/

  var truncate_query = "BEGIN"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPDEAL_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPINACC_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPACTIVE_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPPOOL_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPCASHE_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPACC_TMP';"
                     + "END;";

  var delete_query = "BEGIN"
                   + "    DELETE FROM DBRKREPDEAL_TMP;"
                   + "    DELETE FROM DBRKREPINACC_TMP;"
                   + "    DELETE FROM DBRKREPACTIVE_TMP;"
                   + "    DELETE FROM DBRKREPPOOL_TMP;"
                   + "    DELETE FROM DBRKREPCASHE_TMP;"
                   + "    DELETE FROM DBRKREPACC_TMP;"
                   + "END;";

  DataSet = cmd.Execute(query);
  while(DataSet.moveNext())
    SQL_Execute(truncate_query);

    //Устанавливаем текущий ДБО в качестве параметра запуска
    params.DlContrID = DataSet.DlContrID;

    //Подготовка всех данных
    SP_BrokerRepRSHB_CreateData(params).Create();
                            
    //Печать
    СBrokerRepRSHB_PrintRep(params).CreateReport();
  end;

  params.DlContrID = DlContrID;

  SQL_Execute(delete_query);
END;