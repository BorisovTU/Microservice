/*
 $Name: nptxwrt010.mac
 $Module: Ценные бумаги
 $Description: Операция списания и зачисления денежных средств. Шаг инициализации
 */

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet;

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro CheckMaxSum(nptxop, TotalSum:@money)
   var Dt = TRsbDataSet( " select 1 from ddlcontr_dbt where t_IIS = chr(88) and t_dlcontrid = ( select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid = " + nptxop.contract + ")");
   if ( Dt.movenext())
      /*PNV 527835*/    
      if (nptxop.currency != NATCUR);          
          return 1;
      else 
         var MaxSum = 0, err;
         GetRegistryValue( "COMMON\\НДФЛ\\ПРЕДЕЛЬНАЯ СУММА ПО ИИС", V_INTEGER, MaxSum, err );

         if ((nptxop.SubKind_Operation == 10 /*DL_NPTXOP_WRTKIND_ENROL*/) and (nptxop.IIS != StrFor(88))) /*Если зачислеине и не установлен флаг "Перевод активов по ИИС"*/
              // Golovkin 10.02.2020 ID : 505058 поправил запрос + сделал проверку в разрезе ДБО, а не субдоговора
              var sql = 
                   " SELECT NVL (SUM (CASE                                                                               " +
                   "                     WHEN nptxop.t_iis = 'X'                                                         " +
                   "                     THEN nptxop.t_currentyear_sum                                                   " +
                   "                     ELSE rsb_fiinstr.convsum(nptxop.t_outsum,nptxop.t_currency,0,nptxop.t_operdate) " +
                   "                  END),                                                                              " +
                   "             0)                                                                                      " +
                   "           AS SUM                                                                                    " +
                   "   FROM dnptxop_dbt nptxop, doproper_dbt oproper                                                     " +
                   "  WHERE     nptxop.t_contract IN                                                                     " +
                   "               (SELECT t_sfcontrid                                                                   " +
                   "                  FROM ddlcontrmp_dbt                                                                " +
                   "                 WHERE t_dlcontrid = (SELECT t_dlcontrid                                             " +
                   "                                        FROM ddlcontrmp_dbt                                          " +
                   "                                       WHERE t_sfcontrid = :contract))                               " +
                   "        AND nptxop.t_kind_operation = 2037                                                           " +
                   "        AND nptxop.t_subkind_operation = 10                                                          " +
                   "        AND EXTRACT (YEAR FROM nptxop.t_operdate) = :year                                            " +
                   "        AND oproper.t_documentid = LPAD (nptxop.t_id, 34, '0')                                       " +
                   "        AND oproper.t_kind_operation = nptxop.t_kind_operation                                       " +
                   "        AND (   EXISTS                                                                               " +
                   "                   (SELECT 1                                                                         " +
                   "                      FROM ddlrq_dbt dlrq                                                            " +
                   "                     WHERE     dlrq.t_id_operation = oproper.t_id_operation                          " +
                   "                           AND dlrq.t_dockind = nptxop.t_dockind)                                    " +
                   "             OR EXISTS                                                                               " +
                   "                   (SELECT 1                                                                         " +
                   "                      FROM dpmpaym_dbt pmpaym                                                        " +
                   "                     WHERE     pmpaym.t_documentid = nptxop.t_id                                     " +
                   "                           AND pmpaym.t_dockind = nptxop.t_dockind))                                 " +
                   "       and nptxop.t_id <> :ID                                                                        ";/*PNV 510047 текущую операцию учитывать в расчете не нужно*/
             var cmd = RsdCommand(sql);
                 cmd.addParam("contractid", RSDBP_IN, nptxop.contract);
             var Year;
                 DateSplit(nptxop.OperDate, null, null, Year);
                 cmd.addParam("year", RSDBP_IN, Year);
                 cmd.addParam("ID", RSDBP_IN, nptxop.id);/*PNV 510047*/
                 Dt = RsdRecordSet(cmd);
                 if ( Dt.movenext() )
                      if (dt.value("sum") + nptxop.outsum > MaxSum)
                          TotalSum = dt.value("sum") + nptxop.outsum;
                          return 1;
                      end;
                 end;
         end;
      end;/*PNV 527835*/
   end;
   return 0;
end;



macro InitOperation( KindOpr, KindDoc, FDoc )
  record nptxop("nptxop");
  var err = 0;
  var v_MMVB_Code = "", v_MMVB_ID = -1;

  SetBuff( nptxop, FDoc );
  
  var TotalSum = $0.0;
  if (CheckMaxSum(nptxop, @TotalSum))
      if (nptxop.currency != NATCUR);
          return Error( "Пополнение договоров ИИС возможно только в рублях. | Проведение операции запрещено." );        
      else
          return Error( "Превышена сумма пополнений за текущий год.| С учетом текущей операции сумма всех пополнений равна " + string( TotalSum :a)  + ". | Проведение операции запрещено." );        
      end; 
  end;

  if( not InsertOprStatus(46071, 1)) //Установить ДО = Открыт
      return Error( "Ошибка при установке статуса вида \"Установить ДО\" операции" );        
  end;

  if(nptxop.FlagTax == SET_CHAR)
    if( not InsertOprStatus(46072, 1)) //Установить УН = Открыт
        return Error( "Ошибка при установке статуса вида \"Установить УН\" операции" );        
    end;
  else
    if( not InsertOprStatus(46073, 1)) //Установить ВН = Открыт
        return Error( "Ошибка при установке статуса вида \"Установить ВН\" операции" );        
    end;
  end;
  
  /*Проверяется необходимость планирования шага <Корректировка лимитов QUIK>*/
  if( (nptxop.SubKind_Operation != DL_NPTXOP_WRTKIND_TBSABC) and (nptxop.Contract > 0) )
    GetRegistryValue("SECUR\\MICEX_CODE", V_STRING, v_MMVB_Code, err);
    if( err!=0 )
       return Error( "Ошибка при получении значения настройки SECUR\\MICEX_CODE");
    end;
    
    v_MMVB_ID = GetCodeParty(v_MMVB_Code,PTCK_CONTR);

    var Query =  "select 1 from dsfcontr_dbt sfcontr, ddl_limitprm_dbt prm "
                +" where sfcontr.t_ID = ? "
                +"   and prm.t_MarketKind = case when sfcontr.t_ServKind = ? and sfcontr.t_ServKindSub = 8 and prm.t_MarketID = ? then ?  "
                +"                               when sfcontr.t_ServKind = ? and sfcontr.t_ServKindSub = 9 and prm.t_MarketID = 0 then ? "
                +"                               when sfcontr.t_ServKind = ? and prm.t_MarketID = ? then ? "
                +"                               when sfcontr.t_ServKind = ? and prm.t_MarketID = ? then ? "
                +"                          else 0 end "
                +"   and prm.t_IsCorrect = 'X'";

    var SqlQuery = RSDCommand(Query);
    SqlQuery.addParam("", RSDBP_IN, nptxop.Contract);
    SqlQuery.addParam("", RSDBP_IN, PTSK_STOCKDL);
    SqlQuery.addParam("", RSDBP_IN, v_MMVB_ID);
    SqlQuery.addParam("", RSDBP_IN, ALG_DL_LIMITPRM_MARKETKIND_STOCK);
    SqlQuery.addParam("", RSDBP_IN, PTSK_STOCKDL);
    SqlQuery.addParam("", RSDBP_IN, ALG_DL_LIMITPRM_MARKETKIND_STOCK);
    SqlQuery.addParam("", RSDBP_IN, PTSK_DV);
    SqlQuery.addParam("", RSDBP_IN, v_MMVB_ID);
    SqlQuery.addParam("", RSDBP_IN, ALG_DL_LIMITPRM_MARKETKIND_DERIV);
    SqlQuery.addParam("", RSDBP_IN, PTSK_CM);
    SqlQuery.addParam("", RSDBP_IN, v_MMVB_ID);
    SqlQuery.addParam("", RSDBP_IN, ALG_DL_LIMITPRM_MARKETKIND_CURRENCY);

    SqlQuery.Execute();

    var nptxcalcop = TRsbDataSet(SqlQuery);
    if(nptxcalcop.MoveNext())
       if( not InsertOprStatus(46074, 1)) //Установить КЛ = Выполнить
           return Error( "Ошибка при установке статуса вида \"Установить КЛ\" операции" );        
       end;
    end;

  end;

  return err;
end;
