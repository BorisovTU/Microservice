/*                           
$Name:             scservop.mac
$Module:           Ценные бумаги
$Description:      Сервисные операции (операции сопровождения)
 PROGRAMMED BY:   Леонов И. Е.
 CREATION DATE:   27.02.02
*/
import SfInter, "spRepFun.mac", "spRepFn2.mac", "reppercm.mac", "globals.mac", "dllog_xml.mac", "SpReserv_Report.mac";
import RsbDataSet;
import "scservop_ext.mac","conveyerfun.mac";

/* Документ сервисной операции */
record ScOprServDoc( dl_comm );
/* Структура с данными о 1 строке отчета. Заполняется в макросе выполнения шага*/
var ScOpReportLineData = TArray; 
/*Признак, что выполняется сервисная операция*/
var ScOpIsServiceOper = false;
/*Число вставленных в отчет записей */
var ScOpNumInsRecord = 0; 
var ScOpLastServDocKind = -1; 
var _OprDocKind;
private CONST CALCCOST_CATEGORY  = 27;/*Возможность надежного расчета TCC*/
var SvOpLastResKind = -1;/*подвид резерва*/
var ScOpReportNullFiwarnts = TArray; //Данные для лога по нулевым купонам/ЧП
var ScOpReportRepoIncomeIn = TArray; //Данные для лога по репо для начисления ПДД
const RepoIncomeIn_Kind = 1000;

/*Виды переоценки (деление условное, только для протокола).*/
const OVERVALUE_WRTOFF  = 0; /*Списание переоценки*/
const OVERVALUE_PAPERS  = 1; /*Ц/б в ТП или ППР*/
const OVERVALUE_VO      = 2; /*Ц/б в ПВО*/
const OVERVALUE_TO      = 3; /*Переоценка ТО*/
const OVERVALUE_RESTORE = 4; /*Восстановление убытка от обесценения по выпуску ц/б*/
const OVERVALUE_PFI     = 5; /*Признание ПФИ*/

/*номера секций отчета по операции завершения торгового дня*/
const FINALDAY_CLOSEACC  = 3; /*секция закрытых счетов*/

MACRO SvOp_AddInReport( ReportObj:OBJECT ):INTEGER
  ScOpReportLineData[ScOpReportLineData.Size] = ReportObj;
  return 0;
END;

MACRO GetSumTrnOverFromGraph(DealID:integer, DocKind:integer, TemplNum:integer, CatForward:string )
  var sum = 0;
  var RSD;
  var catID = 476;
  if (CatForward == "+Форвард, прочие")
    catID = 477;
  end;

  var cmd = RSDCommand("SELECT NVL(SUM(CASE WHEN EXISTS(SELECT 1 FROM dmcaccdoc_dbt mcacc WHERE mcacc.t_IsCommon = chr(0) AND mcacc.t_Account=acctrn.T_ACCOUNT_PAYER AND mcacc.t_DocKind = grdeal.t_DocKind AND mcacc.t_DocID = grdeal.t_DocID AND mcacc.t_CatID = " + catID + " ) " +
                       "                 THEN (-1) * acctrn.T_SUM_PAYER " + 
                       "                 WHEN EXISTS(SELECT 1 FROM dmcaccdoc_dbt mcacc WHERE mcacc.t_IsCommon = chr(0) AND mcacc.t_Account=acctrn.T_ACCOUNT_RECEIVER AND mcacc.t_DocKind = grdeal.t_DocKind AND mcacc.t_DocID = grdeal.t_DocID AND mcacc.t_CatID = " + catID + " ) " +
                       "                 THEN acctrn.T_SUM_RECEIVER END), 0) sum_acctrn " +
                       "  FROM dacctrn_dbt acctrn " +
                       "  JOIN ddlgrdoc_dbt grdoc ON grdoc.t_DocID = acctrn.t_AccTrnID AND grdoc.t_DocKind = 1 " +
                       "  JOIN ddlgrdeal_dbt grdeal ON grdeal.t_ID = grdoc.t_GrDealID AND grdeal.t_TemplNum = ? " +
                       " WHERE grdeal.t_DocKind = ? AND grdeal.t_DocID = ?");

   cmd.addParam("", RSDBP_IN, TemplNum);
   cmd.addParam("", RSDBP_IN, DocKind);
   cmd.addParam("", RSDBP_IN, DealID);
   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
     sum = DoubleToMoney(RSD.sum_acctrn);
   end;

   return abs(sum);
end;

MACRO GetSumTrnOverFromDocs(DealID:integer, DocKind:integer, OperDate:date, IsOverSecur:bool)
  var sum = 0;
  var PlusAcc:string, MinusAcc:string;
  var RSD;
  if (IsOverSecur)
    PlusAcc = "971";
	MinusAcc = "941"; 
  else
    PlusAcc = "969";
	MinusAcc = "939"; 
  end;
  var cmd = RSDCommand( "SELECT NVL (SUM (CASE WHEN SUBSTR (acctrn.T_ACCOUNT_PAYER, 1, 3) = ? " +
                        "                THEN (-1) * acctrn.T_SUM_PAYER " +
                        "                WHEN SUBSTR (acctrn.T_ACCOUNT_RECEIVER, 1, 3) = ? " +
                        "                THEN acctrn.T_SUM_RECEIVER " +
                        "                WHEN SUBSTR (acctrn.T_ACCOUNT_PAYER, 1, 3) = ? " +
                        "                THEN acctrn.T_SUM_PAYER " +
                        "                WHEN SUBSTR (acctrn.T_ACCOUNT_RECEIVER, 1, 3) = ? " +
                        "                THEN (-1) * acctrn.T_SUM_RECEIVER END), 0) sum_acctrn " +
                        "  FROM dacctrn_dbt acctrn " +
                        " WHERE ACCTRN.T_ACCTRNID IN " +
                        "          (SELECT doc.T_ACCTRNID " +
                        "             FROM DOPROPER_DBT oper, DOPRSTEP_DBT step, doprdocs_dbt doc " +
                        "            WHERE  oper.T_DOCKIND = ? " +
                        "                  AND oper.T_DOCUMENTID = LPAD(?, 34, '0') " +
                        "                  AND step.T_ID_OPERATION = oper. T_ID_OPERATION" +
                        "                  AND step.T_NUMBER_STEP = 300 " +
                        "                  AND step.T_SYMBOL = 'u' " +
                        "                  AND step.T_ISEXECUTE = CHR (88) " +
                        "                  AND step.T_PLAN_DATE <= ?"
                        "                  AND doc.T_ID_OPERATION = step.T_ID_OPERATION " +
                        "                  AND doc.T_ID_STEP = step.T_ID_STEP " +
                        "                  AND doc.T_ACCTRNID > 0) ");
   cmd.addParam("", RSDBP_IN, PlusAcc);
   cmd.addParam("", RSDBP_IN, PlusAcc);
   cmd.addParam("", RSDBP_IN, MinusAcc);
   cmd.addParam("", RSDBP_IN, MinusAcc);
   cmd.addParam("", RSDBP_IN, DocKind);
   cmd.addParam("", RSDBP_IN, DealID);
   cmd.addParam("", RSDBP_IN, OperDate);
   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
     sum = DoubleToMoney(RSD.sum_acctrn);
   end;

   return sum;
end;


Private Macro ExistORREPO(fiid, ServDate)
  var RSD;
  var cmd = RSDCommand("select /*+ index(tick DDL_TICK_DBT_IDXE ) */ 1 from ddl_tick_dbt tick where tick.t_dealstatus <> 20 and tick.t_bofficekind = 101 and tick.t_clientid = -1" +
                       "  AND tick.t_pfi = ? and tick.t_dealdate <= ?" + 
                       "  and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
                       "  AND RSB_SECUR.IsBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 "+
		               "  and rownum < 2");

   cmd.addParam("", RSDBP_IN, FIID);
   cmd.addParam("", RSDBP_IN, ServDate);
   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
      return true;
   else
      return false;
   end;


end;
/* Данные о выполнении операции переоценки (для отчета)*/
class SvOpOvervalue( _Kind, _ID, _Code, _Num, _Price, _PriceCcy,
                     _BalCost, _NewBalCost,
                     _DtAcc, _KtAcc, _Sum, _SumCcy, _Ground )
  var Kind        = _Kind,
      ID          = _ID, 
      Code        = _Code,
      Num         = _Num, 
      Price       = _Price,
      PriceCcy    = _PriceCcy,
      BalCost     = _BalCost, 
      NewBalCost  = _NewBalCost, 
      DtAcc       = _DtAcc, 
      KtAcc       = _KtAcc, 
      Sum         = _Sum,
      SumCcy      = _SumCcy,
      Ground      = _Ground;   
end;

/* Данные о выполнении операции начисления дохода/расхода (для отчета)*/
class SvOpIncome( _Kind, _ID, _Code, _Amount, _Point, _OldIncome, _NewIncome, _Sum, _SumCCY, _DtAcc, _KtAcc, _Ground )

  var Kind        = _Kind, 
      ID          = _ID, 
      Code        = _Code,
      Amount      = _Amount, 
      Point       = _Point, 
      OldIncome   = _OldIncome,
      NewIncome   = _NewIncome,
      Sum         = _Sum,
      SumCCY      = _SumCCY,
      DtAcc       = _DtAcc, 
      KtAcc       = _KtAcc, 
      Ground      = _Ground;   
end;

/* Данные о выполнении операции начисления дохода/расхода (для отчета)*/
class SvOp_AJOEB(_Code, _AmountSum, _CurrCorrValueSum, _PrevCorrValueSum, _Sum, _DtAcc, _KtAcc, _Ground)

  var Code             = _Code,
      AmountSum        = _AmountSum, 
      CurrCorrValueSum = _CurrCorrValueSum, 
      PrevCorrValueSum = _PrevCorrValueSum,
      Sum              = _Sum,
      DtAcc            = _DtAcc, 
      KtAcc            = _KtAcc, 
      Ground           = _Ground;   
end;

class SvOp_ACCEXPREVOEB(_Code, _Amount, _PrevSum, _CurrSum, _Sum, _SumCCY, _DtAcc, _KtAcc, _Ground)

  var Code    = _Code,
      Amount  = _Amount, 
      PrevSum = _PrevSum,
      CurrSum = _CurrSum, 
      Sum     = _Sum,
      SumCCY  = _SumCCY,
      DtAcc   = _DtAcc, 
      KtAcc   = _KtAcc, 
      Ground  = _Ground;
end;

class SvOp_TPA(_Code, _Amount, _Type, _Sum, _DtAcc, _KtAcc, _Ground)

  var Code    = _Code,
      Amount  = _Amount, 
      Type    = _Type,
      Sum     = _Sum,
      DtAcc   = _DtAcc, 
      KtAcc   = _KtAcc, 
      Ground  = _Ground;
end;

class SvOp_CPA(_PaymSum, _Comiss, _NDS, _DtAcc, _KtAcc, _Ground)

  var PaymSum = _PaymSum,
      Comiss  = _Comiss,
      NDS     = _NDS,
      DtAcc   = _DtAcc, 
      KtAcc   = _KtAcc, 
      Ground  = _Ground;
end;

/* Данные о выполнении операции переоценки требований и обязательств (для отчета)*/
class SvOpOvervalue_RD( _Deal, _FIID, _Kind, _Summ_RD, _Summ_RD_NEW, _Curr, _Num, _Price, _DtAcc, _KtAcc, _Summa, _NKD )
  var Deal = _Deal, 
      FIID = _FIID, 
      Kind = _Kind, 
      Summ_RD = _Summ_RD,
      Summ_RD_NEW = _Summ_RD_NEW,
      Curr = _Curr,
      Num =  _Num,
      NKD = _NKD,
      Price = _Price,
      DtAcc = _DtAcc, 
      KtAcc =_KtAcc,
      Summa = _Summa;
end;

/* Данные о выполнении операции переоценки НВПИ (для отчета)*/
class SvOpOvervalue_NVPI( _Deal, _FiCode, _Kind, _SumTO, _CurTO, _DtAcc, _KtAcc, _Summa )
  var Deal   = _Deal, 
      FiCode = _FiCode,
      Kind   = _Kind, 
      SumTO  = _SumTO,
      CurTO  = _CurTO,
      DtAcc  = _DtAcc, 
      KtAcc  = _KtAcc,
      Summa  = _Summa;
end;

/* Данные о выполнении операции резервирования(для отчета)*/
class SvOpReserve( _ObjID, _ResPc, _RiskGrp,  _BaseSum, _OldReserv, _BaseAcc, _ReservAcc, _AccDbt, _AccCred, _IsDealNtg, _CostRUR, _MarketSum, _IsBiVal, _GuarantSum, _ResKind, _CorrectSum,
                   _IsSetting, _ReqAcc,  _ResPcSec, _RiskGrpSec, _AccRest_BPP, _AccRest_OD, _KindPortf, _FIRole, _DateReserv )
   
  var ObjID         = _ObjID,
      ResPc         = _ResPc,
      RiskGrp       = _RiskGrp,
      BaseSum       = _BaseSum,
      OldReserv     = _OldReserv,
      BaseAcc       = _BaseAcc,
      ReservAcc     = _ReservAcc,
      AccDbt        = _AccDbt,
      AccCred       = _AccCred,
      IsDealNtg     = _IsDealNtg,
      CostRUR       = _CostRUR, 
      MarketSum     = _MarketSum,
      IsBiVal       = _IsBiVal,
      GuarantSum    = _GuarantSum,
      ResKind       = _ResKind,
      CorrectSum    = _CorrectSum,
      IsSetting     = _IsSetting, 
      ReqAcc        = _ReqAcc,    
      ResPcSec      = _ResPcSec,
      RiskGrpSec    = _RiskGrpSec,
      AccRest_BPP   = _AccRest_BPP,
      AccRest_OD    = _AccRest_OD,
      KindPortf     = _KindPortf,
      FIRole        = _FIRole,
      DateReserv    = _DateReserv;

end;

class SvOp_AMORTHEDGCORR(_Code, _Sum, _SumCCY, _DtAcc, _KtAcc, _Ground)

  var Code    = _Code,
      Sum     = _Sum,
      SumCCY  = _SumCCY,
      DtAcc   = _DtAcc, 
      KtAcc   = _KtAcc, 
      Ground  = _Ground;
end;

/* Данные о выполнении операции завершение торгового дня(для отчета)*/
class SvOpCloseAccByDeal( _ClientID,     
                          _ClientContrID,    
                          _DealCode,
                          _CloseAcc 
                       )

  var Kind          = FINALDAY_CLOSEACC,/*номер секция протокола*/
      ClientID      = _ClientID, 
      ClientContrID = _ClientContrID, 
      DealCode      = _DealCode, 
      CloseAcc      = _CloseAcc; 
end;

class SvOpComiss( Contr )
  var number = Contr.number;
end;

/* Данные о выполнении операции расчета СС (для отчета)*/
class SvOpCALCTSS( _FIID, _Rate, _RateFIID, _Msg )
  var FIID     = _FIID, 
      Rate     = _Rate,
      RateFIID = _RateFIID,
      Msg      = _Msg;
end;

/* Имя файла для отчетов сервисных операций */
private var  SvOpReportName = "svoprep";
private file SvOpReportFile() txt write;

private var SvOpErrorArray = TArray();
private var SvOpErrorArrayRes = TArray(); //DEF-50676 отдельный массив для резервирования
private file   f_dl_comm( dl_comm ) key 3;

/* Данные об ошибке*/
private class SvOpError( _OpCode, _ObjCode, _NumErr, _StrErr, _ObjKind )
  var OpCode  = _OpCode, 
      ObjCode = _ObjCode, 
      NumErr  = _NumErr, 
      StrErr  = _StrErr,
      ObjKind = _ObjKind;
end;

CLASS (DL_LOG_FROM_XML) OVERVALUE_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var OvervalueData:SvOpOvervalue;

     if( m_ReportVersion == 1 )
     
        if( DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, OvervalueData.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NUM", V_DOUBLE, OvervalueData.Num) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PRICE", V_DOUBLE, OvervalueData.Price) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PRICECCY", V_STRING, OvervalueData.PriceCcy) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "BALCOST", V_MONEY, OvervalueData.BalCost) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NEWBALCOST", V_MONEY, OvervalueData.NewBalCost) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, OvervalueData.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, OvervalueData.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, OvervalueData.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMCCY", V_STRING, OvervalueData.SumCcy) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, OvervalueData.Ground) == false)
        end;
       
        return SvOpOvervalue(m_ReportNumber,
                             -1,
                             OvervalueData.Code,
                             OvervalueData.Num,
                             OvervalueData.Price,
                             OvervalueData.PriceCcy,
                             OvervalueData.BalCost,
                             OvervalueData.NewBalCost,
                             OvervalueData.DtAcc,
                             OvervalueData.KtAcc,
                             OvervalueData.Sum,
                             OvervalueData.SumCcy,
                             OvervalueData.Ground
                            );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) ACCEXPREVOEB_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_ACCEXPREVOEB;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOp.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNT", V_MONEY, SvOp.Amount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PREVSUM", V_MONEY, SvOp.PrevSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURRSUM", V_MONEY, SvOp.CurrSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOp.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMCCY", V_STRING, SvOp.SumCCY) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_ACCEXPREVOEB(SvOp.Code,
                                 SvOp.Amount,
                                 SvOp.PrevSum,
                                 SvOp.CurrSum,
                                 SvOp.Sum,
                                 SvOp.SumCCY,
                                 SvOp.DtAcc,
                                 SvOp.KtAcc,
                                 SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) TPA_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_TPA;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOp.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNT", V_MONEY, SvOp.Amount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "TYPE", V_STRING, SvOp.Type) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_STRING, SvOp.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_TPA(SvOp.Code,
                        SvOp.Amount,
                        SvOp.Type,
                        SvOp.Sum,
                        SvOp.DtAcc,
                        SvOp.KtAcc,
                        SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) CPA_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_CPA;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PAYMSUM", V_MONEY, SvOp.PaymSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "COMISS", V_MONEY, SvOp.Comiss) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NDS", V_MONEY, SvOp.NDS) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_CPA(SvOp.PaymSum,
                        SvOp.Comiss,
                        SvOp.NDS,
                        SvOp.DtAcc,
                        SvOp.KtAcc,
                        SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) AJUSTVALOEB_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_AJOEB;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOp.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNTSUM", V_MONEY, SvOp.AmountSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURRCORRVALUESUM", V_MONEY, SvOp.CurrCorrValueSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PREVCORRVALUESUM", V_MONEY, SvOp.PrevCorrValueSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOp.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_AJOEB(SvOp.Code,
                          SvOp.AmountSum,
                          SvOp.CurrCorrValueSum,
                          SvOp.PrevCorrValueSum,
                          SvOp.Sum,
                          SvOp.DtAcc,
                          SvOp.KtAcc,
                          SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;


CLASS (DL_LOG_FROM_XML) OVERVALUE_RD_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var OvervalueData_RD:SvOpOvervalue_RD;
     
     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KIND", V_STRING, OvervalueData_RD.KIND) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEAL", V_STRING, OvervalueData_RD.Deal) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FIID", V_INTEGER, OvervalueData_RD.FIID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMM_RD", V_MONEY, OvervalueData_RD.Summ_RD) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMM_RD_NEW", V_MONEY, OvervalueData_RD.Summ_RD_NEW) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURR", V_STRING, OvervalueData_RD.Curr) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NUM", V_DOUBLE, OvervalueData_RD.Num) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PRICE", V_DOUBLE, OvervalueData_RD.Price) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, OvervalueData_RD.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, OvervalueData_RD.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMMA", V_MONEY, OvervalueData_RD.Summa) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NKD", V_MONEY, OvervalueData_RD.NKD) == false)
        end;
       
        return SvOpOvervalue_RD(OvervalueData_RD.Deal,       
                                OvervalueData_RD.FIID,       
                                OvervalueData_RD.Kind,       
                                OvervalueData_RD.Summ_RD,    
                                OvervalueData_RD.Summ_RD_NEW,
                                OvervalueData_RD.Curr,       
                                OvervalueData_RD.Num,        
                                OvervalueData_RD.Price,      
                                OvervalueData_RD.DtAcc,      
                                OvervalueData_RD.KtAcc,      
                                OvervalueData_RD.Summa,
                                OvervalueData_RD.NKD
                               );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) OVERVALUE_NVPI_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var OvervalueData_NVPI:SvOpOvervalue_NVPI;
     
     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEAL", V_STRING, OvervalueData_NVPI.Deal) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FICODE", V_STRING, OvervalueData_NVPI.FiCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KIND", V_STRING, OvervalueData_NVPI.Kind) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMTO", V_MONEY, OvervalueData_NVPI.SumTO) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURTO", V_STRING, OvervalueData_NVPI.CurTO) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, OvervalueData_NVPI.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, OvervalueData_NVPI.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMMA", V_MONEY, OvervalueData_NVPI.Summa) == false)
        end;
       
        return SvOpOvervalue_NVPI(OvervalueData_NVPI.Deal,       
                                  OvervalueData_NVPI.FiCode,
                                  OvervalueData_NVPI.Kind,
                                  OvervalueData_NVPI.SumTO,
                                  OvervalueData_NVPI.CurTO,      
                                  OvervalueData_NVPI.DtAcc,       
                                  OvervalueData_NVPI.KtAcc,    
                                  OvervalueData_NVPI.Summa
                                 );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) GET_INCOME_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOpIncomeData:SvOpIncome;
     
     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KIND", V_INTEGER, SvOpIncomeData.Kind) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOpIncomeData.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNT", V_DOUBLE, SvOpIncomeData.Amount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "POINT", V_INTEGER, SvOpIncomeData.Point) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OLDINCOME", V_MONEY, SvOpIncomeData.OldIncome) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NEWINCOME", V_MONEY, SvOpIncomeData.NewIncome) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOpIncomeData.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMCCY", V_STRING, SvOpIncomeData.SumCCY) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOpIncomeData.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOpIncomeData.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOpIncomeData.Ground) == false)
        end;
       
        return SvOpIncome(SvOpIncomeData.Kind,           
                          SvOpIncomeData.ID,             
                          SvOpIncomeData.Code,            
                          SvOpIncomeData.Amount,       
                          SvOpIncomeData.Point,    
                          SvOpIncomeData.OldIncome,
                          SvOpIncomeData.NewIncome,
                          SvOpIncomeData.Sum,      
                          SvOpIncomeData.SumCCY,   
                          SvOpIncomeData.DtAcc,    
                          SvOpIncomeData.KtAcc,    
                          SvOpIncomeData.Ground   
                         );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) RESERVE_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var ReserveData:SvOpReserve;

     if( m_ReportVersion == 1 )
        if( DL_ReadTagAttribut(m_child_ReportNumber, "OBJID", V_INTEGER, ReserveData.ObjID) == false)
        end;        
        if( DL_ReadTagAttribut(m_child_ReportNumber,"RESPC", V_DOUBLE, ReserveData.ResPc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RISKGRP", V_INTEGER, ReserveData.RiskGrp) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "BASESUM", V_MONEY, ReserveData.BaseSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OLDRESERV", V_MONEY, ReserveData.OldReserv) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "BASEACC", V_STRING, ReserveData.BaseAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RESERVACC", V_STRING, ReserveData.ReservAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACCDBT", V_STRING, ReserveData.AccDbt) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACCCRED", V_STRING, ReserveData.AccCred) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISDEALNTG", V_INTEGER, ReserveData.IsDealNtg) == false)
        end;        
        if(DL_ReadTagAttribut(m_child_ReportNumber, "COSTRUR", V_MONEY, ReserveData.CostRUR) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MARKETSUM", V_MONEY, ReserveData.MarketSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISBIVAL", V_INTEGER, ReserveData.IsBiVal) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GUARANTSUM", V_MONEY, ReserveData.GuarantSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RESKIND", V_INTEGER, ReserveData.ResKind) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CORRECTSUM", V_MONEY, ReserveData.CorrectSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISSETTING", V_INTEGER, ReserveData.IsSetting) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "REQACC", V_STRING, ReserveData.ReqAcc) == false)
        end;       
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RESPCSEC", V_INTEGER, ReserveData.ResPcSec) == false)
        end;         
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RISKGRPSEC", V_INTEGER, ReserveData.RiskGrpSec) == false)
        end;       
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACCREST_BPP", V_STRING, ReserveData.AccRest_BPP) == false)
        end;       
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACCREST_OD", V_STRING, ReserveData.AccRest_OD) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KINDPORTF", V_INTEGER, ReserveData.KindPortf) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FIROLE", V_INTEGER, ReserveData.FIRole) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DATERESERV", V_DATE, ReserveData.DateReserv) == false)
        end;
        

        return SvOpReserve(ReserveData.ObjID,
                           ReserveData.ResPc,
                           ReserveData.RiskGrp,
                           ReserveData.BaseSum,
                           ReserveData.OldReserv,
                           ReserveData.BaseAcc,
                           ReserveData.ReservAcc,
                           ReserveData.AccDbt,
                           ReserveData.AccCred,
                           ReserveData.IsDealNtg,
                           ReserveData.CostRUR,
                           ReserveData.MarketSum,
                           ReserveData.IsBiVal,
                           ReserveData.GuarantSum,
                           ReserveData.ResKind,
                           ReserveData.CorrectSum,
                           ReserveData.IsSetting,
                           ReserveData.ReqAcc,
                           ReserveData.ResPcSec,
                           ReserveData.RiskGrpSec,
                           ReserveData.AccRest_BPP,
                           ReserveData.AccRest_OD,
                           ReserveData.KindPortf,
                           ReserveData.FIRole,
                           ReserveData.DateReserv
                          );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) AMORTHEDGCORR_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_AMORTHEDGCORR;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOp.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOp.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMCCY", V_STRING, SvOp.SumCCY) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_AMORTHEDGCORR(SvOp.Code,
                                 SvOp.Sum,
                                 SvOp.SumCCY,
                                 SvOp.DtAcc,
                                 SvOp.KtAcc,
                                 SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;


/*лог ошибок*/
CLASS (DL_LOG_FROM_XML) SC_ERROR_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var SvOpErrorData:SvOpError;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "OPCODE", V_STRING, SvOpErrorData.OpCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OBJCODE", V_STRING, SvOpErrorData.ObjCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NUMERR", V_STRING, SvOpErrorData.NumErr) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "STRERR", V_STRING, SvOpErrorData.StrErr) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OBJKIND", V_INTEGER, SvOpErrorData.ObjKind) == false)
        end;
        
        return SvOpError(SvOpErrorData.OpCode,
                         SvOpErrorData.ObjCode,
                         SvOpErrorData.NumErr,
                         SvOpErrorData.StrErr,
                         SvOpErrorData.ObjKind);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

/*лог ошибок СО*/
CLASS (DL_LOG_DATA_XML) SC_ERROR_LOG_DATA_XML(pDocKind:integer, pDocumentID:integer, pDataParms:TArray, pType:integer, pVersion:integer)

  PRIVATE MACRO СоздатьУзелОшибок(i)
     var УзелОшибок = null;

     if( m_Version == 1 )
        УзелОшибок = CreateElement("Property",
                                   "ObjCode", m_DataParms[i].ObjCode,
                                   "NumErr",  m_DataParms[i].NumErr,                                    
                                   "StrErr",  m_DataParms[i].StrErr,
                                   "ObjKind", m_DataParms[i].ObjKind
                                  );
     else
        УзелОшибок = CreateElement("Property");
     end;
     
     return УзелОшибок;
  END;


  initDL_LOG_DATA_XML(pDocKind, pDocumentID, pDataParms, pType, pVersion);
END;

/*лог по операции расчета ТСС*/
CLASS (DL_LOG_FROM_XML) CALCTSS_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var CALCTSSData:SvOpCALCTSS;

     if( m_ReportVersion == 1 )
     
        if( DL_ReadTagAttribut(m_child_ReportNumber, "FIID", V_INTEGER, CALCTSSData.FIID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RATE", V_DOUBLE, CALCTSSData.Rate) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RATEFIID", V_INTEGER, CALCTSSData.RateFIID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MSG", V_STRING, CALCTSSData.Msg) == false)
        end;

        return SvOpCALCTSS(CALCTSSData.FIID,
                           CALCTSSData.Rate,
                           CALCTSSData.RateFIID,
                           CALCTSSData.Msg
                          );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

//класс с данными для строки протокола по ц/б с нулевыми купонами/ЧП
class CSC_NullFiwarnts(_Kind:integer,
                       _FI_Code:string,
                       _FI_Name:string,
                       _IsNullCoup:integer,
                       _IsNullPart:integer
)
  var Kind       = _Kind; //вид отчета
  var FI_Code    = _FI_Code;    //Код ц/б
  var FI_Name    = _FI_Name;    //Название ц/б
  var IsNullCoup = _IsNullCoup; //Есть нулевые купоны
  var IsNullPart = _IsNullPart; //Есть нулевые ЧП
end;

/*лог выпусков с нулевыми купонами/ЧП*/
CLASS (DL_LOG_FROM_XML) NULLFIWARNTS_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var NullFiwarnts:CSC_NullFiwarnts;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "FI_CODE", V_STRING, NullFiwarnts.FI_Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FI_NAME", V_STRING, NullFiwarnts.FI_Name) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISNULLCOUP", V_INTEGER, NullFiwarnts.IsNullCoup) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISNULLPART", V_INTEGER, NullFiwarnts.IsNullPart) == false)
        end;

        return NullFiwarnts;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);
END;

//класс с данными для строки протокола по ц/б с нулевыми купонами/ЧП
class CSC_RepoIncomeIN(_Kind:integer,
                       _FI_Code:string,
                       _FI_Name:string,
                       _DrawingDate:date
)
  var Kind       = _Kind; //вид отчета
  var FI_Code    = _FI_Code;    //Код ц/б
  var FI_Name    = _FI_Name;    //Название ц/б
  var DrawingDate = _DrawingDate; //дата погашения

end;

/*лог выпусков с нулевыми купонами/ЧП*/
CLASS (DL_LOG_FROM_XML) REPOINCOMEIN_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var RepoIncomeIN:CSC_RepoIncomeIN;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "FI_CODE", V_STRING, RepoIncomeIN.FI_Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FI_NAME", V_STRING, RepoIncomeIN.FI_Name) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DRAWING_DATE", V_DATE, RepoIncomeIN.DrawingDate) == false)
        end;

        return RepoIncomeIN;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);
END;

macro ConnectBuff( b1, b2 )
  var type = ValType(b2);

  if( (type == V_DBFFILE) or (type == V_STRUC) or (type == V_GENOBJ) ) 
    copy( b1, b2 );
  else SetBuff( b1, b2); /*Для передачи из С*/
  end;
end;

macro SC_SaveErrorForReport_XML(DocumentID:integer, DocKind:integer,  RepErr, NumErr, CommCode, SvOpDoc, OprDocKind )
   
  var RepXML = "";
  var RepErrArr= TArray();
  var ObjCode = "";
  record rContr( sfcontr );
  record rParty( party );
  record dl_comm( dl_comm );
  record Avoiriss( avoiriss );
  record Deal( dl_tick );
  record ntg( dl_nett ); 
    
  if  (valtype(RepErr) == V_STRING) 
  
     if (SvOpDoc != null)
       if( OprDocKind == DLDOC_ISSUE ) /* Анкета выпуска цб */
         ConnectBuff( Avoiriss, SvOpDoc ); 
         ObjCode = GetFICode( Avoiriss.FIID ); 
       elif( OprDocKind == DL_NTGSEC ) /* неттинг */
         ConnectBuff( ntg, SvOpDoc ); 
         ObjCode = ntg.DealNumber; 
       elif( OprDocKind == DLDOC_PARTY )
         ConnectBuff( rParty, SvOpDoc ); 
         ObjCode = rParty.ShortName; 
       elif( OprDocKind == DL_STOCKCONTR )
         ConnectBuff( rContr, SvOpDoc ); 
         ObjCode = rContr.number; 
       elif( (OprDocKind == DL_SECURITYDOC) OR (OprDocKind == DL_TRUSTDOC) OR (OprDocKind == DL_RETIREMENT) OR (OprDocKind == DL_CONVAVR) )
         ConnectBuff( Deal, SvOpDoc ); 
         ObjCode = Deal.DealCode; 
       end;
     else
        ObjCode = "";
     end; 

     RepErrArr( RepErrArr.Size ) = SvOpError( CommCode, ObjCode, NumErr, RepErr, OprDocKind );
  else
    RepErrArr = RepErr;   
  end; 

  if( RepErrArr.Size > 0 )
     RepXML = SC_ERROR_LOG_DATA_XML(DocKind,DocumentID,RepErrArr,LOG_TYPE_ERROR).GetDataXML();
  end;
  
  if( RepXML != "" )
     var Header = DL_LOG_HEADER_XML(DocKind).GetHeaderXML();
                                                                                    
     DL_InsertHeaderLog(DocumentID, DocKind, {Oper}, Header);
     DL_InsertLogXMLData( DocumentID, DocKind, LOG_TYPE_ERROR, {Oper}, RepXML);
  end;

end;


/*проверим, что протокол по данной серв опции должен формироваться в ХМЛ*/
macro ServOpByXML(DocKind:integer)
  return ((DocKind == DL_OVERVALUE) or
          (DocKind == SP_AJUSTVALOEB) or
          (DocKind == DL_OVERVALUE_RD) or
          (DocKind == DL_RESERVEDOC) or 
          (DocKind == DL_OVERVALUE_NVPI) or
          (DocKind == DL_GET_INCOME) or
          (DocKind == DL_CALCTSS) or 
          (DocKind == SP_ACCEXPREVOEB) or 
          (DocKind == SP_TRANSFERPA) or
          (DocKind == SP_COMISSION_PA) or
          (DocKind == SP_AMORTHEDGCORR)
         );
end;

MACRO GetLogDataXML( DocKind:integer, DocumentID:integer, Type:integer, OnlyLastReport:bool )
   var xml_obj = null;

   if( Type == LOG_TYPE_DATA )
      if(DocKind == DL_OVERVALUE )
         xml_obj = OVERVALUE_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_AJUSTVALOEB )
         xml_obj = AJUSTVALOEB_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_ACCEXPREVOEB)
        xml_obj = ACCEXPREVOEB_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_OVERVALUE_RD)
         xml_obj = OVERVALUE_RD_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_OVERVALUE_NVPI)
         xml_obj = OVERVALUE_NVPI_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_GET_INCOME)
         xml_obj = GET_INCOME_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_RESERVEDOC)
         xml_obj = RESERVE_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_CALCTSS)
         xml_obj = CALCTSS_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_TRANSFERPA)
         xml_obj = TPA_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_COMISSION_PA)
         xml_obj = CPA_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_AMORTHEDGCORR)
         xml_obj = AMORTHEDGCORR_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      end;
   else
      xml_obj = SC_ERROR_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
   end;

   return xml_obj;
END;

/*Печать строки отчета сервисной операции*/
macro SvOpPrintLine( str, SayMsgBox )

  if( ScOpIsServiceOper == true )
    return insert( SvOpReportFile, StrSubst( str, "|", " " ));
  elif( SayMsgBox == true )/*отчет по операции*/
    ReplaceMacro ( "msgbox", NULL );
    msgbox( str );
    ReplaceMacro ( "msgbox", "Svop_msgbox" );
  else
    [#](StrSubst( str, "|", " " ));
  end;
  return true;
end;

private macro SvOpOvervalue_RDHead()                                                               
  SvOpPrintLine( "                                    ПЕРЕОЦЕНКА СДЕЛОК НА ВНЕБАЛАНСЕ");
  SvOpPrintLine( "┌─────────────┬───────────────────────────┬─────┬───────────────────┬──────────┬──────────────┬────────────────┬───────────────────────────┬───────────────────────────┬─────────────┬───────────────────┐");
  SvOpPrintLine( "│  Сделка     │         Выпуск ц/б        │ Вид │ Сумма тр./обяз.   │ Кол-во   │     НКД      │  Справедливая  │        Счет Дт            │        Счет Кт            │   Сумма     │  Сумма Т/О        │");
  SvOpPrintLine( "│             │                           │ Т/О │                   │          │              │   стоимость    │                           │                           │             │  после переоценки │");
  SvOpPrintLine( "├─────────────┼───────────────────────────┼─────┼───────────────────┼──────────┼──────────────┼────────────────┼───────────────────────────┼───────────────────────────┼─────────────┼───────────────────┤");
end;                                                                                                                                                                                        

private macro SvOpOvervalue_NVPIHead()                                                               
  SvOpPrintLine( "                                                         ПЕРЕОЦЕНКА НВПИ");
  SvOpPrintLine( "┌─────────────┬───────────────────────────┬─────┬───────────────────┬───────────────────────────┬───────────────────────────┬─────────────┐");
  SvOpPrintLine( "│  Сделка     │         Выпуск ц/б        │ Вид │ Сумма тр./обяз.   │        Счет Дт            │        Счет Кт            │   Сумма     │");
  SvOpPrintLine( "│             │                           │ Т/О │                   │                           │                           │             │");
  SvOpPrintLine( "├─────────────┼───────────────────────────┼─────┼───────────────────┼───────────────────────────┼───────────────────────────┼─────────────┤");
end;                                                                                                                                                                                        

macro SvOpPrintHeadCalcTSS( DlComm )

  SvOpPrintLine( "ОПЕРАЦИЯ РАСЧЕТА ТЕКУЩЕЙ СПРАВЕДЛИВОЙ СТОИМОСТИ Ц/Б" );
  SvOpPrintLine( "Номер операции : " + DlComm.CommCode + "   Дата расчета: " + DlComm.CommDate );
  SvOpPrintLine( "┌─────────────────┬──────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐" );
  SvOpPrintLine( "│    Выпуск ц/б   │    Рассчитанная сумма    │    Сообщение                                                                                                                                                                                                                                             │" );
  SvOpPrintLine( "│                 │  справедливой стоимости  │                                                                                                                                                                                                                                                          │" );
  SvOpPrintLine( "├─────────────────┼──────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤" );

end;

private macro SvOpReservHead(SubDocKind )                                                               
  var Head = "\n\n";

  if( ScOprServDoc.OperationKind == KINDRES_RCB )
     Head = Head +
"Вид резерва    : Резервы по ценным бумагам \n" + 
"Номер операции : " + ScOprServDoc.CommCode + "      Дата расчета: " + ScOprServDoc.CommDate + "\n" +
"┌────────────────────────────────────────────────────────────┬──────────────┬────────────────────┬───────────────────┬────────────────┬──────────┬────────────┬───────────────────┬───────────────────┬───────────────────┬─────────────────────────────────────────────────────────────┐\n"+
"│               Наименование ц/б/код ISIN                    │   Портфель   │     № лиц. счета   │   Сумма вложений, │   Вид резерва  │   Кат.   │  % резерва │  Расчетная сумма  │  Ранее созданный  │Сумма корректировки│                          Проводки                           │\n"+
"│                                                            │    учета     │                    │         руб.      │                │ качества │            │      резерва      │       резерв      │                   ├───────────────────┬────────────────────┬────────────────────┤\n"
"│                                                            │              │                    │                   │                │          │            │                   │                   │                   │       Сумма       │      Счет Дт       │       Счет Кр      │";

  elif( ScOprServDoc.OperationKind == KINDRES_REQ )
     if( (SubDocKind != null) and (SubDocKind == KINDRES_SALEREPO2) )

        Head = Head +
"Вид резерва    : Резервы по требованиям кредитной организации по операциям с ценными бумагами\n" + 
"Номер операции : " + ScOprServDoc.CommCode + "      Дата расчета: " + ScOprServDoc.CommDate + "\n" +
"┌───────────────┬────────────────────────────────────────────────────────────┬────────────────────┬────────────────────┬──────────┬────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┐\n" +
"│ Номер сделки  │                        Контрагент                          │Счет расчетной базы │    Счет резерва    │   Кат.   │  Процент   │ Расчетная база," + {CCYNatCur} +"│  Расчетная сумма  │  Ранее созданный  │Сумма корректировки│\n" +
"│               │                                                            │                    │                    │ качества │  резерва   │                   │     резерва," + string({CCYNatCur}:5) + " │    резерв, " + string({CCYNatCur}:5) + "  │         " + string({CCYNatCur}:5) + "     │";                 
     else

     Head = Head +
"Вид резерва    : Резервы по требованиям кредитной организации по операциям с ценными бумагами\n" + 
"Номер операции : " + ScOprServDoc.CommCode + "      Дата расчета: " + ScOprServDoc.CommDate + "\n" +
"┌───────────────┬────────────────────────────────────────────────────────────┬────────────────────┬────────────────────┬──────────┬────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┐\n" +
"│ Номер сделки  │                        Контрагент                          │Счет расчетной базы │    Счет резерва    │   Кат.   │  Процент   │ Расчетная база," + {CCYNatCur} +"│  Расчетная сумма  │ Сумма обеспечения,│  Ранее созданный  │Сумма корректировки│\n" +
"│               │                                                            │                    │                    │ качества │  резерва   │                   │     резерва," + string({CCYNatCur}:5) + " │         " + string({CCYNatCur}:5) + "     │    резерв, " + string({CCYNatCur}:5) + "  │         " + string({CCYNatCur}:5) + "     │";                 
                                                                                                                                                                  

     end; 
 end;          

  SvOpPrintLine( Head );
end;

/*Заголовок отчета о сервисной операции*/
macro SvOpPrintHead( DlComm, SubDocKind )
  if( DlComm.DocKind == BofficeKindCOMM )
    SvOpProcessPeriodComm_PrintHead( SvOpReportFile, ScOpIsServiceOper );
  elif( DlComm.DocKind == DL_OVERVALUE_RD) 
    SvOpOvervalue_RDHead();
  elif( DlComm.DocKind == DL_OVERVALUE_NVPI) 
    SvOpOvervalue_NVPIHead();
  elif( DlComm.DocKind == DL_CALCTSS) 
    SvOpPrintHeadCalcTSS(DlComm);
  end;
end;

private file mes ("bank.msg");

private macro GetMsgFromFile( Number )
   mes.Number = Number;
   if (GetEQ(mes))
      return mes.Contents;
   else
      return "Сообщение №";
   end;
end;

macro ClearErrorArr()
  SvOpErrorArray.Size = 0;
end;        

macro ClearErrorArrRes()
  SvOpErrorArrayRes.Size = 0;
end;   

macro InsertErrorLog_XML(DocumentID, DocKind)
  if (SvOpErrorArray.Size>0)
    SC_SaveErrorForReport_XML( DocumentID, DocKind,  SvOpErrorArray);
  end;
end;
 
/*Запомнить ошибку
  OprDocKind - вид первичного документа
  SvOpServDoc - Документ сервисной операции 
  SvOpDoc - Первичный документ
  Num, StrErr - номер и строка ошибки*/
macro ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, Num, StrErr )

  record rContr( sfcontr );
  record rParty( party );
  record dl_comm( dl_comm );
  record Avoiriss( avoiriss );
  record Deal( dl_tick );
  record ntg( dl_nett );

  var ObjCode = "";

  if( ScOpIsServiceOper == true )
     ConnectBuff(dl_comm, SvOpServDoc);

     if( SvOpDoc != null )
        if( (OprDocKind == DLDOC_ISSUE) OR ((dl_comm.OperationKind == KINDRES_RCB) and (OprDocKind == DL_RESERVEDOC) ) ) /* Анкета выпуска цб */
          ConnectBuff( Avoiriss, SvOpDoc );
          ObjCode = GetFICode( Avoiriss.FIID );
        elif( OprDocKind == DL_NTGSEC ) /* неттинг */
          ConnectBuff( ntg, SvOpDoc );
          ObjCode = ntg.DealNumber;
        elif( OprDocKind == DLDOC_PARTY )
          ConnectBuff( rParty, SvOpDoc );
          ObjCode = rParty.ShortName;
        elif( OprDocKind == DL_STOCKCONTR )
          ConnectBuff( rContr, SvOpDoc );
          ObjCode = rContr.number;
        elif( (OprDocKind == DL_SECURITYDOC) OR (OprDocKind == DL_TRUSTDOC) OR (OprDocKind == DL_RETIREMENT) OR (OprDocKind == DL_CONVAVR)
              OR ((dl_comm.OperationKind == KINDRES_REQ) and (OprDocKind == DL_RESERVEDOC)) )
          ConnectBuff( Deal, SvOpDoc );
          ObjCode = Deal.DealCode;
        end;
     else
        ObjCode = "";
     end;
  end;

  if( (ScOpIsServiceOper == true) AND (isOprMultiExec() == true) )
     if( (StrErr == null) or (StrErr == "") )
        if( Num <= 1 )
           StrErr = "Ошибка при выполнении шага.";
        else
           StrErr = GetMsgFromFile( num );
        end;
     end;

     SvOpErrorArray( SvOpErrorArray.Size ) = SvOpError( dl_comm.CommCode, ObjCode, Num, StrErr, OprDocKind );
     SvOpErrorArrayRes( SvOpErrorArrayRes.Size ) = SvOpError( dl_comm.CommCode, ObjCode, Num, StrErr, OprDocKind );

  elif( StrErr != "" )
     SvOpErrorArray( SvOpErrorArray.Size ) = SvOpError( dl_comm.CommCode, ObjCode, Num, StrErr, OprDocKind );
     SvOpErrorArrayRes( SvOpErrorArrayRes.Size ) = SvOpError( dl_comm.CommCode, ObjCode, Num, StrErr, OprDocKind );
     if( isOprMultiExec() == true )
       SvOpPrintLine( StrErr, true ); 
     else
       if( Num > 1 )
          MsgBoxEx( StrErr, 0, 0, "Сообщение " + string(Num) ); 
       else
/*HF 47.2*/
          if( (( SvOpServDoc.OperationKind == KINDRES_RCB ) AND ( SvOpServDoc.FIID > 0 )) OR
              ((SvOpServDoc.OperationKind == KINDRES_DEAL ) AND ( SvOpServDoc.ContractID != 0)) OR
              ((dl_comm.OperationKind == KINDRES_REQ) and ((OprDocKind == DL_RESERVEDOC)or(OprDocKind == DL_SECURITYDOC))) OR
              ((dl_comm.DocKind == DL_OVERVALUE) AND (OprDocKind == DLDOC_ISSUE)) OR
              (dl_comm.DocKind == DL_CALCTSS) 
            )
            ReplaceMacro ( "msgbox", NULL );
          end;

          msgbox( StrErr );
       end;
     end;
  end;  

  return 0;
end;

private macro CheckStepInfoEx(oprstep)
  return StepInfoEx(null, oprstep )
OnError
  return false;
end;

/*На эту ф-ю заменяем msgbox при печати протокола с ошибками. См. 91025.*/
macro Svop_msgbox(StrErr)
   record oprstep(oprstep);
   record r_oproper(oproper);
   var FDoc;
   var oproper = TBFile("oproper", "r");

   if( (ScOprServDoc.DocKind == DL_CALCTSS) OR (NOT CheckStepInfoEx(oprstep)) ) 
                                                    //DEF-50411 При ошибке не из операций функция StepInfoEx может сгенерировать ошибку, нужно обрабатывать ее как false
      ScOpInsertError( _OprDocKind, ScOprServDoc, null, 1, StrErr );
   else
      oproper.Clear();
      oproper.rec.ID_Operation = oprstep.ID_Operation;

      if( not oproper.GetEQ() )
         ScOpInsertError( _OprDocKind, ScOprServDoc, null, 1, StrErr );
      else

         if( ScOprServDoc.DocKind == BofficeKindCOMM ) /*комисси*/
            FDoc = TRecHandler("sfcontr");

         elif( ScOprServDoc.DocKind == DL_RESERVEDOC ) /* резерв */
            if( _OprDocKind == DLDOC_ISSUE )
               FDoc = TRecHandler("avoiriss");

            elif( _OprDocKind == DL_NTGSEC )
               FDoc = TRecHandler("dl_nett");

            elif( _OprDocKind == DL_SECURITYDOC )
               FDoc = TRecHandler("dl_tick");

            elif( _OprDocKind == DLDOC_PARTY )
               FDoc = TRecHandler("party");
            end;

         elif( (ScOprServDoc.DocKind == DL_OVERVALUE) or 
               (ScOprServDoc.DocKind == DL_GET_INCOME) 
             ) /* переоценка или начисление ПДД*/
            if( _OprDocKind == DLDOC_ISSUE )
               FDoc = TRecHandler("avoiriss");
            else
               FDoc = TRecHandler("dl_tick");
            end;
         elif( ScOprServDoc.DocKind == DL_OVERVALUE_RD ) /*переоценка требований и обязательств*/
            FDoc = TRecHandler("dl_tick");
         elif( ScOprServDoc.DocKind == DL_OVERVALUE_NVPI ) /*переоценка НВПИ*/
            /*Неттинг учтен в сишнике, при вставке цепочки*/
            FDoc = TRecHandler("dl_tick");
         elif (ScOprServDoc.DocKind == SP_ACCEXPREVOEB)
           FDoc = TRecHandler("dl_comm");
         elif (ScOprServDoc.DocKind == SP_AJUSTVALOEB)
           FDoc = TRecHandler("dl_comm");
         elif (ScOprServDoc.DocKind == SP_TRANSFERPA)
           FDoc = TRecHandler("dl_comm");
         elif (ScOprServDoc.DocKind == SP_COMISSION_PA)
           FDoc = TRecHandler("dl_comm");
         elif (ScOprServDoc.DocKind == SP_AMORTHEDGCORR)
           FDoc = TRecHandler("dl_comm");
         end; 
         if( ПолучитьПервичныйДокументСервОпер(oproper, FDoc) == 0 )

            ScOpInsertError( _OprDocKind, ScOprServDoc, FDoc, 1, StrErr );
         end;
      end;
   end;
end;

/*Должна использоваться при сообщении о ошибках на всех шагах закрытия сделок,
  которые выполняются из сервисных операций
IsErrorArray - признак того, что нам передали массив ошибок error
*/
macro SayErrorBuySale( deal, error:variant, IsErrorArray:bool )
   var i;
   record tick( dl_tick ); 
   if( error != "" )
      if( ScOpIsServiceOper )
         copy( tick, deal );
         if( IsErrorArray and (IsErrorArray == true) )
            i = 0;
            while( i < error.Size() )
               ScOpInsertError( tick.BofficeKind, ScOprServDoc, deal, 1, error.(i) );
               i = i + 1;
            end;
         else
            ScOpInsertError( tick.BofficeKind, ScOprServDoc, deal, 1, error );
         end;
      else
         if( IsErrorArray and (IsErrorArray == true) )
            msgbox( error.(0) );
         else
            msgbox( error );
         end;
      end;
   end;
   return 1;
end;

/*сохраним данные о закрытых счетах по сделке*/
macro SaveDataCloseAccArray( deal, CloseAccArray:DL_AccCollector )
   var i = 0;
   var CloseTradeDayArr = TArray();

   if( (CloseAccArray.Size() > 0) and ScOpIsServiceOper and (ScOprServDoc.DocKind == DL_FINALTRADEDAY) )             
      CloseTradeDayArr.Size() = 0;
      while( i < CloseAccArray.Size() )
         CloseTradeDayArr[CloseTradeDayArr.Size()] = SvOpCloseAccByDeal(deal.ClientID,
                                                                        deal.ClientContrID,
                                                                        deal.DealCode,
                                                                        CloseAccArray.(i).Account
                                                                       );
         i = i + 1;
      end;
      DL_SaveDataForReport_XML(ScOprServDoc.DocumentID, ScOprServDoc.DocKind, CloseTradeDayArr, LOG_TYPE_DATA);
   end;
end;

/* Определить счета +/-Расчеты для субъекта, по которым нужно выполнять 
   резервирование по средствам на расчетных счетах (РСРС).
   Счета из  mcaccdoc, такие что
      · IsCommon == YES
      · Contractor -равен субъекту
      · категории  "+Расчеты" (точно)  по шаблону, относящемуся к параметру БОКу= БО Ц/Б
   Выборка должна возвращать Account, Chapter, Currency*/
MACRO СчетаРСРС_Расчеты( PartyID:INTEGER, Categ:STRING )
   return
      " SELECT accdoc.t_Account, accdoc.t_Chapter, accdoc.t_Currency " +
      " FROM   dmccateg_dbt categ, dmcaccdoc_dbt accdoc, dmctempl_dbt templ" +
      " WHERE " +  
           "categ.t_LevelType = 1                        AND " +/*категории (не группы)*/
           "categ.t_Code      ='"+ Categ            + "' AND " +
           "templ.t_CatID     = categ.t_ID               AND " +
           "templ.t_Value1    = 5                        AND " +/*строго БОЦБ*/
           "templ.t_IsClose   = CHR(0)                   AND " +
           "accdoc.t_IsCommon   = 'X'                    AND " +
           "accdoc.t_CatID      = categ.t_ID             AND " +
           "accdoc.t_Contractor =" + string(PartyID) + " AND " +
           "accdoc.t_TemplNum   = templ.t_Number"    ;
END;

/* Определить счета брокера, по которым нужно выполнять 
   резервирование по средствам на расчетных счетах (РСРС).
   Обрабатываются счета из СПИ по договорам нашего банка с брокерами, б/с - 30602 
   Выборка должна возвращать Account, Chapter, Currency*/
MACRO СчетаРСРС_Брокер( PartyID:INTEGER )
   return
      " SELECT settacc.t_Account, settacc.t_Chapter, settacc.t_FIID " +
      " FROM   dsfcontr_dbt sfcontr, dsfssi_dbt sfssi, dsettacc_dbt settacc " +
      " WHERE " +  
           "sfcontr.t_ContractorID = " + string(PartyID) + " AND " +
           "sfcontr.t_partyID      = " + string({OurBank}) + " AND " +
           "sfssi.t_ObjectID    = LPAD(sfcontr.t_Id,10,'0')  AND " +
           "sfssi.t_ObjectType  = 659                        AND " +
           "settacc.t_SettAccID = sfssi.t_SetAccID           AND " +
           "(" + ConvertMaskToSQLFormat( "30602*", "settacc.t_Account") + ")";
END;

/* Определить счета комиссий брокеру, по которым нужно выполнять 
   резервирование по средствам на расчетных счетах (РСРС).
   Обрабатываются счета из СПИ комиссий, навешенных на договора обслуживания нашего 
   банка с брокерами б/с - 47423.
   Выборка должна возвращать Account, Chapter, Currency*/
MACRO СчетаРСРС_КомиссииБрокеру( PartyID:INTEGER )
   return 
      " SELECT settacc.t_Account, settacc.t_Chapter, settacc.t_FIID " +
      " FROM   dsfcontr_dbt sfcontr, dsfssi_dbt sfssi, dsfconcom_dbt concom, dsfcomiss_dbt comiss, dsettacc_dbt settacc" +
      " WHERE " +  
           "sfcontr.t_ContractorID = " + string(PartyID) + " AND " + /*Договор с брокером*/
           "sfcontr.t_partyID      = " + string({OurBank}) + " AND " +
           "concom.t_ObjectID = sfcontr.t_Id                   AND " + /*Комиссия, навешенная на договор*/
           "comiss.t_feeType = concom.t_feeType              AND " +
           "comiss.t_number  = concom.t_commNumber           AND " +
                            
           "sfssi.t_ObjectID    = LPAD(comiss.t_feeType,5,'0') || LPAD(comiss.t_number,5,'0')  AND " + 
           "sfssi.t_ObjectType  = 650                        AND " + /*СПИ, навешенная на комиссии */

           "settacc.t_SettAccID = sfssi.t_SetAccID           AND " + /*Параметры СПИ*/
           "(" + ConvertMaskToSQLFormat( "47423*", "settacc.t_Account") + ")";
END;

/* Определить, что для субъекта есть счета, по которым нужно выполнять резерв
   "РСРС - По средствам на расчетных счетах"*/
private macro ЕстьСчетаДляРСРС( PartyID:INTEGER, OprDocKind, SvOpServDoc, SvOpDoc )
   var rs, Error;

   rs = ExecuteSQLCommand( СчетаРСРС_Расчеты( PartyID, "+Расчеты" ), "Определение счетов по категории \"+Расчеты\" для резервирования.", @Error );
   if( rs == NULL )
      ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, 1, Error );
      return false; /*Ошибка при выполнении запроса*/
   elif( rs.moveNext() )
      return true;  /*Есть счета для резерва*/
   end;

   rs = ExecuteSQLCommand( СчетаРСРС_Брокер( PartyID ), "Определение счетов брокера для резервирования.", @Error );
   if( rs == NULL )
      ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, 1, Error );
      return false; /*Ошибка при выполнении запроса*/
   elif( rs.moveNext() )
      return true;  /*Есть счета для резерва*/
   end;

   rs = ExecuteSQLCommand( СчетаРСРС_КомиссииБрокеру( PartyID ), "Определение счетов комиссий брокеру для резервирования.", @Error );
   if( rs == NULL )
      ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, 1, Error );
      return false; /*Ошибка при выполнении запроса*/
   elif( rs.moveNext() )
      return true;  /*Есть счета для резерва*/
   end;

   return false; /* Нет подходящих счетов*/
end;

private macro CheckExistByCreateDeal(dl_comm, Avoiriss)
   var Query, QueryS, DataSet;

   QueryS = " Select d.t_DealID as DealID " +
            "   From ddl_tick_dbt d " + 
            "  Where d.t_ClientID = -1 " +
            "  and d.t_PortfolioID in(" + string(KINDPORT_TRADE) + "," + string(KINDPORT_SALE) + "," + string(KINDPORT_BACK) + ")";

   QueryS = QueryS + " and d.t_DealDate    = ? " +
                     " and (exists ( " + 
                                     " Select l.t_DealID " + 
                                     "   From ddl_leg_dbt l " + 
                                     "  Where  l.t_DealID  = d.t_DealID " +
                                     "    and (l.t_LegKind = " + string(LEG_KIND_DL_TICK) +
                                     "    or   l.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK) + " ) " +
                                     "    and  l.t_PFI     = ? " +
                                 " ) or " +
                          " exists ( " + 
                                     " Select ens.t_DealID " + 
                                     "   From ddl_tick_ens_dbt ens " + 
                                     "  Where ens.t_DealID = d.t_DealID " +
                                     "    and ens.t_FIID   = ? " +
                                 " ) ) ";

   Query = RSDCommand(QueryS);
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext()  )
      return true;
   end; 
   return false;
end;

private macro CheckExistBySetAvoir(dl_comm, Avoiriss)
   var Query, QueryS, DataSet;

   QueryS = " Select d.t_DealID as DealID " + 
            "   From ddl_tick_dbt d " + 
            "  Where d.t_ClientID = -1 " +
            "  and d.t_PortfolioID in(" + string(KINDPORT_TRADE) + "," + string(KINDPORT_SALE) + "," + string(KINDPORT_BACK) + ")";

   QueryS = QueryS +  " and exists ( " + 
                                     " Select rq.t_ID " + 
                                     "   From ddlrq_dbt rq " + 
                                     "  Where rq.t_DocID     = d.t_DealID " +
                                     "    and rq.t_DocKind   = d.t_BofficeKind " +
                                     "    and rq.t_Type      = " + string(DLRQ_TYPE_DELIVERY) +
                                     "    and rq.t_FIID      = ? " +
                                     "    and rq.t_FactDate  = ? " +
                                     "    and (rq.t_State    = " + string(DLRQ_STATE_EXEC) +
                                     "         or rq.t_State = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                                " ) ";

   Query = RSDCommand(QueryS);
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext()  )
      return true;
   end;     
   return false;
end;

/*проверяем поставки для операции ПДД*/
private macro CheckExistBySetAvoir_Inc(dl_comm, Avoiriss)
   var Query, DataSet;
   /*проверим, были ли за дату операции поставки по сделкам, погашения цб/К/ЧП*/
   Query = RSDCommand( " Select count(1) NRec " + 
                       "   From ddlrq_dbt rq, ddl_tick_dbt d " + 
                       "  Where rq.t_Type      = " + string(DLRQ_TYPE_DELIVERY) + 
                       "    and rq.t_FIID      = ? " +
                       "    and rq.t_FactDate  = ? " +
                       "    and (rq.t_State    = " + string( DLRQ_STATE_EXEC) +
                       "         or rq.t_State = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                       "    and rq.t_DocID     = d.t_DealID " + 
                       "    and rq.t_DocKind   = d.t_BofficeKind " +
                       "    and d.t_ClientID   = -1 "); 

   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext() )
      if( DataSet.NRec > 0 )
         return true;
      end;
   end;
 
   /*проверим, были ли за дату операции операции изменения номинала*/
   Query  = RSDCommand( " select count(1) NRec " +           
                        "  from v_scwrthistex v, ddl_comm_dbt comm, doproper_dbt opr " +
                        " where comm.T_DocKind = ? " +
                        "   and opr.T_ID_OPERATION = v.T_ID_OPERATION " +
                        "   and ltrim(opr.T_DocumentID) = comm.T_DOCUMENTID " +
                        "   and opr.T_DocKind = comm.T_DocKind " +
                        "   and v.T_Buy_Sale = ? " +
                        "   and v.T_FIID = ? " +
                        "   and v.T_ChangeDate = ? " +
                        "   and v.t_state = ? " +
                        "   and v.t_Party = -1 "
                      );

   Query.addParam( "", RSDBP_IN, DL_CHGAVRNOM );
   Query.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );

   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext() )
      if( DataSet.NRec > 0 )
         return true;
      end;
   end;
                                        
   /*проверим, были ли за дату операции ГО*/
   query = RSDCommand( " select count(1) NRec " +           
                       "  from v_scwrthistex v " +
                       " where v.T_DocKind = ? " +
                       "   and ((v.T_KIND = 120 and v.T_ACTION = 10) or (v.T_KIND = 130 and v.T_ACTION = 422)) " + 
                       "   and v.T_ChangeDate = ? " +
                       "   and v.T_FIID = ? " +
                       "   and v.t_state = ? " +
                       "   and v.t_Party = -1 "
                     );

   query.addParam( "", RSDBP_IN, DL_ISSUE_UNION );
   query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   query.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );
   Query.execute();

   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext() )
      if( DataSet.NRec > 0 )
         return true;
      end;
   end;

   return false;
end;

private macro CheckExistByPaymMoney(dl_comm, Avoiriss)
   var Query, QueryS, DataSet;

   QueryS = " Select d.t_DealID as DealID " + 
           "   From ddl_tick_dbt d " + 
            "  Where d.t_ClientID    = -1 " +
            "  and d.t_PortfolioID in(" + string(KINDPORT_TRADE) + "," + string(KINDPORT_SALE) + "," + string(KINDPORT_BACK) + ")";

   QueryS = QueryS + " and (exists ( " + 
                                     " Select l.t_DealID, rq.t_DocID " + 
                                     "   From ddl_leg_dbt l, ddlrq_dbt rq " +
                                     "  Where l.t_DealID   = d.t_DealID " +
                                     "    and rq.t_DocID   = d.t_DealID " +
                                     "    and rq.t_DocKind = d.t_BofficeKind " +
                                     "    and ((    l.t_LegKind = " + string(LEG_KIND_DL_TICK) +
                                     "          and ( rq.t_Type = " + string(DLRQ_TYPE_PAYMENT) + " AND rq.t_DealPArt = 1 ) " +
                                     "         ) or " +
                                     "         (    l.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK) +
                                     "          and rq.t_Type = " + string(DLRQ_TYPE_PAYMENT) + " AND rq.t_DealPArt = 2 ) " +
                                     "        ) " +
                                     "    and l.t_PFI           = ? " +
                                     "    and rq.t_FactDate     = ? " +
                                     "    and (rq.t_State = " + string(DLRQ_STATE_EXEC) +
                                     "      or rq.t_State = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                                     " ) or " + 
                          " exists ( " + 
                                     " Select ens.t_DealID, rq.t_DocID " + 
                                     "   From ddl_tick_ens_dbt ens, ddlrq_dbt rq " +
                                     "  Where ens.t_DealID = d.t_DealID " +
                                     "    and rq.t_DocID   = d.t_DealID " +
                                     "    and rq.t_DocKind = d.t_BofficeKind " +
                                     "    and ens.t_FIID   = ? " +
                                     "    and rq.t_FactDate = ? " +
                                     "    and (rq.t_State   = " + string(DLRQ_STATE_EXEC) +
                                     "      or rq.t_State   = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                                     " ) ) "; 

   Query = RSDCommand(QueryS);
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext()  )
      return true;
   end;
   return false;
end;

private macro ПроверитьНаличиеРелевантныхЛотовДляПереоценкиТО( dl_comm, FIID ) 
  var RSD;
  var cmd = RSDCommand("select L.t_SumID" +
                       "  from dpmwrtsum_dbt L" +
                       " where     L.t_Department = ?" +
                       "       and L.t_Party = -1" +
                       "       and L.t_Contract = 0" +
                       "       and L.t_Buy_Sale in (" + PM_WRITEOFF_SUM_BUY + "," + PM_WRITEOFF_SUM_SALE + ")" +
                       "       and L.t_EnterDate <= ?" +
                       "       and L.t_FIID = ?" +
                       "       and L.t_AmountBD > 0" +
                       "       and L.t_State = " + PM_WRTSUM_NOTFORM +
                       iif(dl_comm.Flag6 == SET_CHAR,
                       "       and L.t_Date = ? ",
                       "       and L.t_Date >= ?" )
                      );
   cmd.addParam("", RSDBP_IN, dl_comm.Division);
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.addParam("", RSDBP_IN, FIID);
   if( dl_comm.Flag6 == SET_CHAR )
      cmd.addParam("", RSDBP_IN, GetDateAfterWorkDays(dl_comm.CommDate, 1) );
   else
      cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   end;
   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
      return true;
   end;
    
   cmd = RSDCommand("select /*+ leading(b) */ L.t_SumID" +
                    "  from dpmwrtsum_dbt L, dpmwrtbc_dbt B" +
                    " where     L.t_Department = ?" +
                    "       and L.t_Party = -1" +
                    "       and L.t_Contract = 0" +
                    "       and L.t_Buy_Sale in (" + PM_WRITEOFF_SUM_BUY + "," + PM_WRITEOFF_SUM_SALE + ")" +
                    "       and L.t_EnterDate <= ?" +
                    "       and L.t_ChangeDate >= ?" +
                    "       and B.t_FIID = ?" +
                    "       and B.t_SumID = L.t_SumID" +
                    "       and B.t_AmountBD > 0" +
                    "       and B.t_State = " + PM_WRTSUM_NOTFORM +
                    iif(ScOprServDoc.Flag6 == SET_CHAR, 
                    "       and B.t_Date = ? ",
                    "       and B.t_Date >= ?" ) +
                    "       and B.t_Instance = (select MAX(M.t_Instance) " +
                    "                             from dpmwrtbc_dbt M" +
                    "                            where     M.t_SumID = L.t_SumID" +
                    "                                  and M.t_ChangeDate <= ? )");

   cmd.addParam("", RSDBP_IN, dl_comm.Division);
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.addParam("", RSDBP_IN, FIID);
   if( dl_comm.Flag6 == SET_CHAR )
      cmd.addParam("", RSDBP_IN, GetDateAfterWorkDays(dl_comm.CommDate, 1) );
   else
      cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   end;
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
      return true;
   end;

   return false;
end;

macro WRTGetSaleOvervalue( Department, FIID, Party, Contract, Portfolio, CalcDate, _OverAmount)
   var Amount, OverAmount;
   var cmd;

   cmd = RsdCommand("begin\n RSB_PMWRTOFF.WRTGetSaleOvervalue(?,?,?,?,?,?,?,?);\n end; ");

   cmd.addParam("p_Department", RSDBP_IN,     Department );
   cmd.addParam("p_FIID",       RSDBP_IN,     FIID       );
   cmd.addParam("p_Party",      RSDBP_IN,     Party      );
   cmd.addParam("p_Contract",   RSDBP_IN,     Contract   );
   cmd.addParam("p_Portfolio",  RSDBP_IN,     Portfolio  );
   cmd.addParam("p_CalcDate",   RSDBP_IN,     CalcDate   );
   cmd.addParam("p_Amount",     RSDBP_OUT,    V_DOUBLE   );
   cmd.addParam("p_OverAmount", RSDBP_OUT,    V_DOUBLE   );
   cmd.execute();

   SetParm(6, cmd.value(7));

   return cmd.value(6);
end;

macro GetCourse_OVERVALUE_RD(FIID, ToFIID, CommDate, DblAmount, MarketID, CentrOffice, _Exist:Bool, _SinceDate:date)
  var Course = 0.0, SinceDate, Exist = false, sql, rsd, RateDef_FIID;

  /*Получим курс "Средневзвешенная стоимость( или Блумберг для валютных выпусков) " в валюте номинала*/
  if( SmartConvertSumDbl( Course, DblAmount, CommDate, 
                          FIID, ToFIID, false, 
                          ПолучитьВидКурса(SP_RATETYPE_RightCost), SinceDate, MarketID, CentrOffice ) == false 
    )

     /*Нет курса бумаги к валюте номинала, поищем в других валютах*/
     sql = RSDCommand(" SELECT t_FIID "
                    + "   FROM dratedef_dbt "
                    + "  WHERE t_OtherFI = ? "
                    + "    AND t_Type = ? "
                    + "  ORDER BY t_IsDominant DESC "); /* первым будет основной */

     sql.addParam( "", RSDBP_IN, FIID );
     sql.addParam( "", RSDBP_IN, ПолучитьВидКурса(SP_RATETYPE_RightCost) );
     sql.execute();

     rsd = TRsbDataSet(sql);
     while( rsd.MoveNext() and (Exist == false) )
        RateDef_FIID = rsd.FIID;

        /*Нет курса бумаги к валюте номинала, но возможно, что есть курс бумаги к RateDef_FIID*/
        if( SmartConvertSumDbl( Course, DblAmount, CommDate, 
                                FIID, RateDef_FIID, false, 
                                ПолучитьВидКурса(SP_RATETYPE_RightCost), SinceDate, MarketID, CentrOffice ) == false 
          )
           /*Не нашли рыночный курс в RateDef_FIID на дату операции*/
           Exist = false;
        else
           /*курс "Рыночная стоимость" нужен в валюте номинала*/
           if( SmartConvertSumDbl( Course, Course, CommDate, 
                                   RateDef_FIID, ToFIID, true ) == false 
             )
              Exist = false;
           else
              Exist = true;
           end;
        end;
     end;
  else
     Exist = true;
  end;

  SetParm(6, Exist);
  SetParm(7, SinceDate);
  return Course;
end;


/*Ц/б сделки имеет рыночные котировки (есть курс из настройки "рыночная цена")  
  за эту или предуд. дату  и он не равен 0, или ц/б котируемая (на дату)*/
macro MacroCheckAvr_OVERVALUE_RD(fininstr:TRecHandler, CommDate:date, _need_overvalue:Bool)
  var Course = 0.0, need_overvalue = false;

  Course = GetCourse_OVERVALUE_RD(fininstr.rec.FIID, fininstr.rec.FaceValueFI, CommDate, 1.0, null, null, need_overvalue);

  if (Course == 0.0)
     need_overvalue = false;
  end;

  SetParm(2, need_overvalue);
end;

MACRO ОстатокВПортфеле( dl_comm, KindPortf:INTEGER, FIID:INTEGER, Delivered:BOOL, WithoutAccept:BOOL, ReservAmount:@MONEY, IncomeReserv:@MONEY ):MONEY
  VAR wrtcalc = TRecHandler( "pmwrtsum.dbt" );

  if( WRT_Calc( dl_comm.Division, FIID, -1, 0, KindPortf, dl_comm.CommDate, wrtcalc, Delivered, WithoutAccept ) == true) 
     ReservAmount = wrtcalc.rec.ReservAmount;
     IncomeReserv = wrtcalc.rec.IncomeReserv;
     return wrtcalc.rec.Amount;
  end;
  return $0;
END;

private macro CheckOvervalueTPlus( Depart, FinInstr, OperDate:DATE ):BOOL
  VAR DS, cmd, 
      ExistsOvervl = false;

  cmd = RSDCommand( " SELECT /*+ leading(rq) index(rg DDLRQ_DBT_IDX5 ) */ count(1) as ExistsOvervlTPlus " +                      
                    " FROM DDL_TICK_DBT TK, DDLRQ_DBT RQ, DDL_LEG_DBT LEG " +                                                                
                    " WHERE TK.T_BOFFICEKIND =  " + DL_SECURITYDOC +/*Сделка с ц/б*/                                                         
                    " AND TK.T_DEPARTMENT = ? " + //Филиал                                                                                   
                    " AND TK.T_CLIENTID = -1 " +                                                                                             
				    //" AND TK.T_PFI = ? " +//идентификатор текущей бумаги ФИ                                                                  
				    " AND RQ.T_FIID = ? " +//идентификатор текущей бумаги ФИ                                                                  
                    " AND TK.T_PORTFOLIOID IN ( " + KINDPORT_TRADE + "," + KINDPORT_SALE + ") " + //ССПУ, СССД                                                                        
                    " AND TK.T_DEALSTATUS = " + DL_READIED + //Открыта                                                                       
                    " AND RSB_SECUR.IsBuy(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(TK.t_DealType, TK.t_BofficeKind))) = 1 " + 
                    " AND RQ.T_DOCKIND = TK.T_BOFFICEKIND " +                                                                                
                    " AND RQ.T_DOCID = TK.T_DEALID " +                                                                                       
                    " AND RQ.T_TYPE = " + DLRQ_TYPE_DELIVERY + // Поставка                                                                   
                    " AND RQ.T_FIID = TK.T_PFI " +                                                                                           
                    " AND RQ.T_FACTDATE =  TO_DATE('01-01-0001','DD-MM-YYYY') " + //Нулевая дата                                             
                    " AND RQ.T_PLANDATE > TK.T_DEALDATE " +                                                                                  
                    " AND TK.T_DEALDATE <= ? " +                                                                                  
                    " AND LEG.T_DEALID = TK.T_DEALID " +                                                                                     
                    " AND LEG.T_LEGKIND =  " +  LEG_KIND_DL_TICK +                                                                           
                    " AND LEG.T_LEGID = 0 " +                                                                                                
                    " AND LEG.T_OPERSTATE = " + DL_LEG_OUTBAL +                                                                              
                    " AND TK.T_IsPFI != 'X' and rownum < 2");                                                                                                
                    
                              
  cmd.addParam( "", RSDBP_IN, Depart );  
  cmd.addParam( "", RSDBP_IN, FinInstr );  
  cmd.addParam( "", RSDBP_IN, OperDate );  
  cmd.execute();

  DS = TRsbDataSet( cmd );
  if( DS.MoveNext() AND (DS.ExistsOvervlTPlus > 0) )
     ExistsOvervl = true;
  end;
  return ExistsOvervl;  
end;

/* Фильтр на сервисные операции. 
   Если вернет false, то по объекту сервисная опер. выполняться не будет
   OprDocKind - вид первичного документа
   SvOpServDoc - Документ сервисной операции 
   SvOpDoc - Первичный документ*/
macro ScOpFilter( OprDocKind, SvOpServDoc, SvOpDoc )       

  record dl_comm(dl_comm);
  record rContr( sfcontr );
  record Deal( dl_tick );
  record Avoiriss( avoiriss );
  record Fin(fininstr);
  var FD, need_overvalue, SaleOverAmount = $0;   
  var ReservAmount = $0, IncomeReserv = $0;    
  var NumInList = "", ValidFromDate, NeedOverValue_TO = false, NeedOverValue = false;
  var Dt;
  _OprDocKind = OprDocKind;
  SetBuff( dl_comm, SvOpServDoc );

  if( dl_comm.DocKind == BofficeKindCOMM ) /*комисси*/
    SetBuff( rContr, SvOpDoc );

    if( not SfIsExistPeriodComiss( rContr.Id, false ) )/*по договору нет периодических комиссий*/
      return false;
    end;
    return true;

  elif( dl_comm.DocKind == DL_RESERVEDOC ) /* резерв */

     if( OprDocKind == DLDOC_ISSUE )
        SetBuff( Avoiriss, SvOpDoc );
        /*Исключены просроченные выпуски под 100% */
        if (Avoiriss.FIID == 2278)
          return false;
        end; 
        if (Avoiriss.FIID == 574)
          return false;
        end;  
        if (Avoiriss.FIID == 575)
          return false;
        end;  

        if( dl_comm.FIID > 0 ) 
           return true;  
        end;

        if ( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), 13, null, null, NumInList, ValidFromDate) )
          return false; //DEF-50676 Если не задана категория качества не обрабатываем
        end;

        if( ПолучитьФинИн( Avoiriss.FIID, Fin ) ) 
           return false;  
        end; 
         
        /* Если есть ненулевой остаток за дату в одном из портфелей */
        if( (ОстатокВПортфеле( dl_comm,KINDPORT_SALE, Avoiriss.FIID, true, true ) != 0) OR         //СССД_ЦБ, БПП_СССД_ЦБ
            (ОстатокВПортфеле( dl_comm,KINDPORT_RETIRE, Avoiriss.FIID, true, true ) != 0) OR       //АС_ЦБ, БПП_АС_ЦБ
            (ОстатокВПортфеле( dl_comm,KINDPORT_PROMISSORY, Avoiriss.FIID, true, true ) != 0) OR   //ПДО
            (ОстатокВПортфеле( dl_comm,KINDPORT_CONTR, Avoiriss.FIID, true, true ) != 0) OR        //ПКУ, ПКУ_БПП
            ((ОстатокВПортфеле( dl_comm,KINDPORT_CONTR, Avoiriss.FIID, true, false ) != 0) AND (dl_comm.Flag3 == SET_CHAR) )         //ПВО  со статусом Поставлен и установлен признак формирования резерва вида РЦБННД (dl_comm.Flag3 == Да)
          )
          return true;
        end;

/*
        if( (ОстатокВПортфеле( dl_comm, KINDPORT_SALE, Avoiriss.FIID, true, true, @ReservAmount, @IncomeReserv ) != 0) AND /* ППР со статусом Поставлен или Продан БПП*/
            ( (ExistNOSS( Avoiriss, dl_comm.CommDate ) == false) OR /*не установлен признак возможности надежного определения ТСС*/
              (ReservAmount != 0) OR /*или есть ненулевой остаток резерва ReservAmount*/
              ( 
                (dl_comm.Flag2 == SET_CHAR) AND
                (IncomeReserv != 0) /*ненулевой остаток резерва ПДД*/
              )
            )
          )
           return true;
        elif( FI_IsBond( Fin ) ) /* ПУДП или ПДО со статусом Поставлен и ц/б - ДО*/
           if( (ОстатокВПортфеле( dl_comm,KINDPORT_RETIRE, Avoiriss.FIID, true, false ) != 0) OR
               (ОстатокВПортфеле( dl_comm,KINDPORT_PROMISSORY, Avoiriss.FIID, true, false ) != 0)
             )
             return true;
           end;
        elif( FI_IsShare( Fin ) ) /* ПКУ со статусом Поставлен и ц/б - Акция*/
           if( ОстатокВПортфеле( dl_comm, KINDPORT_CONTR, Avoiriss.FIID, true, false ) != 0 )
             return true;
           end;
        end;
*/
        return false;
     else
        /*Весь отбор теперь в программе, если сюда попали, то сделка подошла под условия*/
        return true;
     end;
  elif (dl_comm.DocKind == SP_AJUSTVALOEB) /* Корректировка стоимости ОЭБ*/
    return true;
  elif (dl_comm.DocKind == SP_ACCEXPREVOEB) /* Начисление расходов и доходов ОЭБ */
/*DAN*/
    ConnectBuff( Avoiriss, SvOpDoc ); 
    if(not ПолучитьФинИн( Avoiriss.FIID, Fin )) // Если нет ошибки при получении фин инстр
      if((Fin.IsClosed == "X") or (Fin.Fi_Kind != 2)) return false; end;   // если бумага закрыта или это вовсе не бумага не вставляем шаг для операции
    end;
/*DAN*/
    return true;
  elif (dl_comm.DocKind == SP_TRANSFERPA)
    return true;
  elif (dl_comm.DocKind == SP_COMISSION_PA)
    return true;
  elif(dl_comm.DocKind == SP_AMORTHEDGCORR)
    var cmd;

    SetBuff( Avoiriss, SvOpDoc );

    if( ПолучитьФинИн( Avoiriss.FIID, Fin ) ) 
       return false;  
    end;

    //в истории по выпуску есть хотя бы одни отношения хеджирования, дата завершения которых меньше или равна дате операции из панели операции
    cmd = DL_RSDCommand(  " select 1"
                        + "   from ddlhdgrelation_dbt r "
                        + "  where r.t_ObjDocKind = " + OBJTYPE_AVOIRISS
                        + "    and r.t_ObjID = ? "
                        + "    and r.t_EndDate > " + GetSQLDate(date(0,0,0))
                        + "    and r.t_EndDate <= ? "
                        + "    and ROWNUM = 1 " 
                       );

    cmd.AddParam(Avoiriss.FIID);
    cmd.AddParam(dl_comm.CommDate);

    if(cmd.GetCount() == 0)
      return false;
    end;

    //по выпуску хотя бы на одном счете корректировок от хеджирования есть остаток
    cmd = DL_RSDCommand(  " select 1"
                        + "   from dmccateg_dbt cat, dmcaccdoc_dbt accdoc "
                        + "  where cat.t_LevelType = 1 "
                        + "    and cat.t_Code IN ('+Корректировка, ц/б_Хедж','-Корректировка, ц/б_Хедж','+Корр, ОЭБ_Хедж','-Корр, ОЭБ_Хедж') "
                        + "    and accdoc.t_CatID = cat.t_ID "
                        + "    and accdoc.t_FIID = ? "
                        + "    and rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null) <> 0 "
                        + "    and ROWNUM = 1 "
                       );

    cmd.AddParam(Avoiriss.FIID);
    cmd.AddParam(dl_comm.CommDate);

    if(cmd.GetCount() == 0)
      return false;
    end;

    return true;
  elif( dl_comm.DocKind == DL_OVERVALUE ) /* переоценка*/

     if (OprDocKind == DL_SECURITYDOC)
        SetBuff( Deal, SvOpDoc );

        FD = SPFirstDoc( Deal );

        if((dl_comm.ComType == SC_FACEVALUEFITYPE_RUB) and (FD.fininstr.rec.FaceValueFI != NATCUR))
          return false;
        elif((dl_comm.ComType == SC_FACEVALUEFITYPE_CUR) and (FD.fininstr.rec.FaceValueFI == NATCUR))
          return false;
        end;

        return true; 
     end;

     SetBuff( Avoiriss, SvOpDoc );

     if( ПолучитьФинИн( Avoiriss.FIID, Fin ) ) 
        return false;  
     end;
  
        /*Исключены просроченные выпуски под 100% */
        if (Avoiriss.FIID == 2278)
          return false;
        end; 
        if (Avoiriss.FIID == 574)
          return false;
        end;  
        if (Avoiriss.FIID == 575)
          return false;
        end;  

     if((dl_comm.Flag1 == SET_CHAR) or (dl_comm.Flag7 == SET_CHAR))
       if((dl_comm.ComType == SC_FACEVALUEFITYPE_RUB) and (fin.FaceValueFI != NATCUR))
         return false;
       elif((dl_comm.ComType == SC_FACEVALUEFITYPE_CUR) and (fin.FaceValueFI == NATCUR))
         return false;
       end;
     end;

     if (dl_comm.OperSubKind == SC_OVERVALUE_WRTOFF) /*Списание результатов переоценки может выполняться:*/
        /*Если не нашли, или нашли что "да" - такая бумага не подходит. Нужны - только "нет"*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, dl_comm.CommDate, ValidFromDate) )
           return false;  
        else
           if( NumInList == "1" )
              return false;  
           end;
        end;
        /*... а предыдущее значение этой категории = "Да":*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, ValidFromDate-1) )
           return false;  
        else
           if( NumInList != "1" )
              return false;
           end;
        end;
     end;

     if (dl_comm.OperSubKind == SC_OVERVALUE_RESTORE) /*Восстановление убытка от обесценения по выпуску ц/б*/
        /*Если не нашли, или нашли что "нет" - такая бумага не подходит. Нужны - только "да"*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, dl_comm.CommDate, ValidFromDate) )
           return false;  
        else
           if( NumInList != "1" )
              return false;  
           end;
        end;
        /*... а предыдущее значение этой категории = "нет":*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, ValidFromDate-1) )
           return false;  
        else
           if( NumInList == "1" )
              return false;
           end;
        end;
     end;

     if( dl_comm.Flag5 == SET_CHAR ) /*Требования/обязательства по возврату ц/б*/
        if( ExistORREPO( Avoiriss.fiid, dl_comm.CommDate ) ) 
           NeedOverValue_TO = ПроверитьНаличиеРелевантныхЛотовДляПереоценкиТО( dl_comm, Avoiriss.FIID );
        end;

        if( NeedOverValue_TO )
           return true; /*уже подходит*/
        elif( dl_comm.Flag1 != SET_CHAR ) 
           return false;  
        end;
     end;

     if( dl_comm.Flag1 == SET_CHAR ) /*Вложения в ценные бумаги*/
        /* DEF-70977
        if( CheckExistOvervalue( Fin, dl_comm.CommDate ) )
           return false;  
        end; */
        
        if( (dl_comm.Flag2 == SET_CHAR) OR /*по событиям*/
            (dl_comm.Flag3 == SET_CHAR) OR
            (dl_comm.Flag4 == SET_CHAR)
          )

           /* переоценка по операциям по дате заключения сделки */
           if( (NeedOverValue == false) AND (dl_comm.Flag2 == SET_CHAR) )
              NeedOverValue = CheckExistByCreateDeal(dl_comm, Avoiriss);
           end;

           /* переоценка по операциям по дате оплаты */
           if( (NeedOverValue == false) AND (dl_comm.Flag3 == SET_CHAR) )
              NeedOverValue = CheckExistBySetAvoir(dl_comm, Avoiriss );
           end;

           /* переоценка по операциям по дате поставки */
           if( (NeedOverValue == false) AND (dl_comm.Flag4 == SET_CHAR) )
              NeedOverValue = CheckExistByPaymMoney(dl_comm, Avoiriss );
           end;

           if( NeedOverValue == false )
              return false;
           end;
        else
           /*a.  для всех ц/б в ТП*/
           if( (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_TRADE, -1, dl_comm.CommDate, true, false, true ) == $0) and 
               ( (WRTGetSaleOvervalue( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_TRADE, dl_comm.CommDate, SaleOverAmount) == $0) OR
                 (SaleOverAmount == 0)
               ) 
             )
              /*b. для тех ц/б в ППР, ПВО и на счетах "ОД", для которых на дату проведения операции в 
                   анкете выпуска признак "Возможность надежного определения справедливой стоимости" имеет 
                   значение "справедливая стоимость МОЖЕТ быть надежно определена".*/
              if(   (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_SALE, -1, dl_comm.CommDate, true, false, true ) == $0) and
                    (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BACK, -1, dl_comm.CommDate, true, false, true ) == $0 ) and
                    (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BASICDEBT, -1, dl_comm.CommDate, false, true, false ) == $0 ) and
                    (dl_comm.Flag7 == UNSET_CHAR)    // не не стоит флаг на 
                )
                    return false;  
              end;
           end;
        end;
     end;

     if( dl_comm.Flag7 == SET_CHAR )
        return CheckOvervalueTPlus(dl_comm.Division, Avoiriss.FIID, dl_comm.CommDate);  
     end;

     return true;
  elif( dl_comm.DocKind == DL_GET_INCOME ) /* начисление ПДД*/

     if (OprDocKind == DL_SECURITYDOC)
        return true; /*Все проверки в сишнике*/
     else
        SetBuff( Avoiriss, SvOpDoc );

           if( ПолучитьФинИн( Avoiriss.FIID, Fin ) ) 
              return false;  
           end;
        If(dl_comm.Flag1 == UNSET_CHAR)
            return false;  
        end;

        if((dl_comm.ComType == SC_FACEVALUEFITYPE_RUB) and (fin.FaceValueFI != NATCUR))
          return false;
        elif((dl_comm.ComType == SC_FACEVALUEFITYPE_CUR) and (fin.FaceValueFI == NATCUR))
          return false;
        end;

        /*if( FI_GetStatus( Avoiriss.FIID, dl_comm.EndDate ) != FI_STATE_INCIRCULATION )  //находящиеся в обращении
           // FI_GetStatus возвращает на дату погашения неопределенный статус. 
           // Чтобы не ломать ее логику, затычка для разрешения начисления ПДД в дату погашения. 
           // Нужно для средневзвешенного метода списания.
           if( GetDateAfterWorkDays(Fin.DrawingDate, 0) != dl_comm.EndDate )
              return false;  
           end;
        end;*/

/* КД. Убрано по просьбе банка. Так как всегда начисляется весь портфель.
        if( ((dl_comm.Flag1 == SET_CHAR) or (dl_comm.Flag4 == SET_CHAR)) AND (dl_comm.Flag5 == SET_CHAR) AND
            (not CheckExistBySetAvoir_Inc(dl_comm, Avoiriss ))
          ) /*только по выпускам ц/б, где были движения*/
           return false;
        end;
*/
        /*bpv скопирован блок из ветки по переоценке, чтобы отрубить бумаги СЭБ*/
           if( (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_TRADE, -1, dl_comm.CommDate, true, false, true ) == $0) and              
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_SALE, -1, dl_comm.CommDate, true, false, true ) == $0) and
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BACK, -1, dl_comm.CommDate, true, false, true ) == $0 ) and
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BASICDEBT, -1, dl_comm.CommDate, false, true, false ) == $0 ) and
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_RETIRE, -1, dl_comm.CommDate, true, false, true ) == $0 ) 
              )  
                    return false;  
           end;

        return true;
     end;

  elif( dl_comm.DocKind == DL_OVERVALUE_NVPI ) /*переоценка НВПИ*/
      return true;

  elif( dl_comm.DocKind == DL_OVERVALUE_RD ) /*переоценка требований и обязательств*/

     need_overvalue = true;
     SetBuff( Deal, SvOpDoc );

     FD = SPFirstDoc( Deal );

     /*Проверим курс, котируемость. То, что ц/б именно заданная (или заданного вида) - проверяется в сишнике*/
     /*Ц/б сделки имеет рыночные котировки (есть курс из настройки "рыночная цена")  
       за эту или предуд. дату  и он не равен 0, или ц/б котируемая (на дату)*/
     if (dl_comm.Flag1 == SET_CHAR)
        if((dl_comm.ComType == SC_FACEVALUEFITYPE_RUB) and (FD.fininstr.rec.FaceValueFI != NATCUR))
          need_overvalue = false;
        elif((dl_comm.ComType == SC_FACEVALUEFITYPE_CUR) and (FD.fininstr.rec.FaceValueFI == NATCUR))
          need_overvalue = false;
        end;

        if (need_overvalue)
          if((dl_comm.Currency != ALLFININSTR) and (FD.fininstr.rec.FaceValueFI != dl_comm.Currency))
            need_overvalue = false;
          end;
        end;
        
        if (need_overvalue)
        if (ИндивидуальныйФинИн(FD.fininstr.rec.FIID)) /*только неиндивидуальные*/
           need_overvalue = false;
        end;
        end;

        if (need_overvalue)
           if (FI_GetStatus( FD.fininstr.rec.FIID, dl_comm.CommDate ) != FI_STATE_INCIRCULATION)  /*находящиеся в обращении*/
              need_overvalue = false;
           end;
        end;

        if( CheckTaxDepositoryMode() == false )
           if (FD.avoiriss.rec.SPIsClosed == SET_CHAR) /*незакрытые*/
              need_overvalue = false;
           end;
        else
           if( FD.fininstr.rec.IsClosed == SET_CHAR ) /*незакрытые*/
              need_overvalue = false;
           end;
        end;

        /*наличие курса, котируемость*/
        if (need_overvalue)
           MacroCheckAvr_OVERVALUE_RD(FD.fininstr, dl_comm.CommDate, need_overvalue );
        end;

        if (need_overvalue)
           return true;
        end;
     end; 

     if (dl_comm.Flag2 == SET_CHAR)
        /*Проверим, что ВР == НацВ, ВН != НацВ*/
        if ((FD.GetPayFIID() == NATCUR) and (FD.fininstr.rec.FaceValueFI != NATCUR))
           return true;
        end;
     end; 

     return false;
  end;
  return false;
end;

/*Распечатать ошибки*/
macro SvOpPrintError( ObjectName )
  var i = 0;

  if( SvOpErrorArray.Size == 0 ) return; end;
  SvOpPrintLine( "\n\n Ошибки при выполнении сервисной операции:\n" );
  SvOpPrintLine( "┌────────────┬───────────────┬──────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐");
  SvOpPrintLine( "│    Код     │" + string(ObjectName:15) + "│  №   │                          Код ошибки                                                                                                                                                   │");
  SvOpPrintLine( "│  операции  │               │ошибки│                                                                                                                                                                                       │");
  SvOpPrintLine( "├────────────┼───────────────┼──────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤");

  while( i != SvOpErrorArray.Size )
     SvOpPrintLine( "│" +
                    string(SvOpErrorArray(i).OpCode:12) + "│" + 
                    string(SvOpErrorArray(i).ObjCode:15) + "│" +  
                    string(SvOpErrorArray(i).NumErr:6) + "│" +  
                    string(SvOpErrorArray(i).StrErr:183) + "│"  );
     i = i + 1;
  end;

  SvOpPrintLine( "└────────────┴───────────────┴──────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘");
end;

/*Распечатать ошибки по резервам*/
macro SvOpPrintErrorRes( ObjectName )
  var i = 0;

  if( SvOpErrorArrayRes.Size == 0 ) return; end;
  SvOpPrintLine( "\n\n Ошибки при выполнении сервисной операции резервирования:\n" );
  SvOpPrintLine( "┌────────────┬───────────────┬──────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐");
  SvOpPrintLine( "│    Код     │" + string(ObjectName:15) + "│  №   │                          Код ошибки                                                                                                                                                   │");
  SvOpPrintLine( "│  операции  │               │ошибки│                                                                                                                                                                                       │");
  SvOpPrintLine( "├────────────┼───────────────┼──────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤");

  while( i != SvOpErrorArrayRes.Size )
     SvOpPrintLine( "│" +
                    string(SvOpErrorArrayRes(i).OpCode:12) + "│" + 
                    string(SvOpErrorArrayRes(i).ObjCode:15) + "│" +  
                    string(SvOpErrorArrayRes(i).NumErr:6) + "│" +  
                    string(SvOpErrorArrayRes(i).StrErr:183) + "│"  );
     i = i + 1;
  end;

  SvOpPrintLine( "└────────────┴───────────────┴──────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘");
end;

private macro SvOpOvervalue_RDLine( Data:SvOpOvervalue_RD, Num:DOUBLE )
  if( Data.Summa != 0 )
    var FinInstr = GetFinInstr( Data.FIID, true );

    SvOpPrintLine( "│" +
                   String(Data.Deal:13)+"│"+
                   String(GetFinInstrName(Data.FIID):27) +"│"+
                   String(Data.Kind:5:c) +"│"+
                   String(Data.Summ_RD:15) +" "+
                   String(Data.Curr:3) +"│"+
                   String(ЧислоCЗаданнойТочностью(Data.Num, SetPrecisionByFractPart(Data.Num, FinInstr.SumPrecision ,0)):10) +"│"+
                   String(Data.NKD:14) +"│"+    
                   String(Data.Price:16:6) +"│"+
                   String(Data.DtAcc:27) +"│"+
                   String(Data.KtAcc:27) +"│"+
                   String(Data.Summa:13) +"│"+
                   String(Data.Summ_RD_NEW:15) +" "+
                   String(Data.Curr:3) +"│"
                 );
  end;
end;

private macro SvOpOvervalue_NVPILine( Data:SvOpOvervalue_NVPI )
  if( Data.Summa != 0 )
    SvOpPrintLine( "│" +
                   String(Data.Deal:13)+"│"+
                   String(Data.FiCode:27)+"│"+
                   String(Data.Kind:5:c) +"│"+
                   String(Data.SumTO:15)+" "+
                   String(Data.CurTO:3)+"│"+
                   String(Data.DtAcc:27) +"│"+
                   String(Data.KtAcc:27) +"│"+
                   String(Data.Summa:13) +"│"
                 );
  end;
end;

macro SvOpCALCTSSLine( Data:SvOpCALCTSS )
  SvOpPrintLine( "│" +
                 String(GetFinInstr(Data.FIID).FI_CODE:17)+"│"+
                 String(Data.Rate:21:9) +" "+
                 String(GetFICode(Data.RateFIID, null, FICK_ISOSTRING):4) +"│" +
                 String(Data.Msg:250:w) +"│"
               );
end;

private macro SvOpOvervalue_RDFoot()
   return "└─────────────┴───────────────────────────┴─────┴───────────────────┴──────────┴──────────────┴────────────────┴───────────────────────────┴───────────────────────────┴─────────────┴───────────────────┘";
end;

private macro SvOpOvervalue_NVPIFoot()
   return "└─────────────┴───────────────────────────┴─────┴───────────────────┴───────────────────────────┴───────────────────────────┴─────────────┘";
end;

macro SvOpCALCTSSFoot()
   return  "└─────────────────┴──────────────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘";
end;

class ItogReservLineByFIID()

   private var 
       m_ObjID       ,
       m_BaseSum     ,
       m_Reserv      ,
       m_OldReserv   ,
       m_ReservChange,
       m_Sum         ,
       m_ReservChangeOR,
       m_SumOR;

   macro Clear()
      m_ObjID        = -1;
      m_BaseSum      = $0;
      m_Reserv       = $0;
      m_OldReserv    = $0;
      m_ReservChange = $0;
      m_Sum          = $0;
      m_ReservChangeOR = $0;
      m_SumOR        = $0;
   end;

   macro AddItog(p_ObjID:integer,p_BaseSum:money,p_Reserv:money,p_OldReserv:money,p_ReservChange:money, p_Sum:money, p_ReservChangeOR, p_SumOR)

      if( m_ObjID != p_ObjID )
         Clear();
      end;

      m_ObjID        = p_ObjID;
      m_BaseSum      = m_BaseSum      + p_BaseSum;
      m_Reserv       = m_Reserv       + p_Reserv;
      m_OldReserv    = m_OldReserv    + p_OldReserv;
      m_ReservChange = m_ReservChange + p_ReservChange;
      m_Sum          = m_Sum          + p_Sum;
      m_ReservChangeOR = m_ReservChangeOR + p_ReservChangeOR;
      m_SumOR        = m_SumOR        + p_SumOR;

   end;

   macro ObjID()
      return m_ObjID;
   end;

   macro BaseSum()
      return m_BaseSum;
   end;

   macro Reserv()
      return m_Reserv;
   end;

   macro OldReserv()
      return m_OldReserv;
   end;

   macro ReservChange()
      return m_ReservChange;
   end;

   macro Sum()
      return m_Sum;
   end;

   macro ReservChangeOR()
      return m_ReservChangeOR;
   end;

   macro SumOR()
      return m_SumOR;
   end;

   this.Clear();
end;
private  macro SvOpResLineTxt(  Issue, KindPortfStr, Acc, RestAcc, ResKindStr, QualCat, ResPer, Reserv, OldReserv,CorrSum, Sum, DebAcc, CredAcc )

  var StrLine = "│" +
                    String(Issue:60)+"│"+
                    String(KindPortfStr:14) +"│"+
                    String(Acc:20) +"│" +
                    String(RestAcc:19)+"│"+
                    String(ResKindStr:16) +"│"+
                    String(QualCat:10) +"│"+
                    String(ResPer:12) +"│" +
                    String(Reserv:19)+"│"+
                    String(OldReserv:19) +"│" +
                    String(CorrSum:19)+"│"+
                    String(Sum:19) +"│"+
                    String(DebAcc:20) +"│"+
                    String(CredAcc:20) +"│"
                    ;

  SvOpPrintLine(StrLine);
end;
   private macro PrintCBProtocolTxt(ScOprServDoc)
      var OldIssue = -1, OldPortfolio = -1, OldResKind = -1, OldIsBPP = -1;
      var ItogReserv = 0, ItogOldReserv = 0, ItogReservChange = 0, ItogSum = 0, ItogReservOR = 0, ItogOldReservOR = 0, ItogReservChangeOR = 0, ItogSumOR = 0;
      var FirstRowNumIssue = -1, FirstRowNumPortf = -1, FirstRowNumResKind = -1;
      var CurRowNumIssue = -1, CurRowNumPortf = -1, CurRowNumResKind = -1;
      var IsExistsDate = false;

      var TmpDataQuery =   "SELECT (fininstr.t_Name || '/' || avoiriss.t_ISIN) as t_Issue,"
                         + "       reservrep.t_Portfolio, "
                         + "       reservrep.t_IsBPP, "
                         + "       reservrep.t_Acc, "
                         + "       reservrep.t_RestAcc, "
                         + "       reservrep.t_ResKind, "
                         + "       reservrep.t_QualCat, "
                         + "       reservrep.t_ResPer, "
                         + "       reservrep.t_Reserv, "
                         + "       reservrep.t_OldReserv, "
                         + "       reservrep.t_CorrSum, "
                         + "       reservrep.t_Sum, "
                         + "       reservrep.t_DebAcc, "
                         + "       reservrep.t_CredAcc "
                         + "FROM DSPRESERVREP_TMP reservrep, DFININSTR_DBT fininstr, DAVOIRISS_DBT avoiriss "
                         + "WHERE fininstr.t_FIID = reservrep.t_ObjID "
                         + "  and avoiriss.t_FIID = reservrep.t_ObjID "
                         + "ORDER BY t_Issue, t_Portfolio, t_IsBPP, t_Priority, t_ResKind ";
      var TmpDataSelect = DL_RSDCommand(TmpDataQuery);
      var TmpDataDS = TmpDataSelect.execute();
      while(TmpDataDS.MoveNext())
         var KindPortfStr = "";
         if(TmpDataDS.Portfolio != -1)
            SP_GetValueLL(1100, int(TmpDataDS.Portfolio), @KindPortfStr);
            if(TmpDataDS.IsBPP == 1)
              KindPortfStr = KindPortfStr + "_БПП" ;
            end;
         end;

         var ResKindStr = "";
         if(TmpDataDS.ResKind != OldResKind)
            if(TmpDataDS.ResKind == KINDRES_RCBUC)
              ResKindStr = "В ненадежных депозитариях";
            elif(TmpDataDS.ResKind == KINDRES_RVPCB)
              ResKindStr = "ПДД";
            elif(TmpDataDS.ResKind == KINDRES_RCB)
              ResKindStr = "Ц/б";
            elif(TmpDataDS.ResKind == KINDRES_ROCB)
              ResKindStr = "Оценочный резерв";
            end;
         end;
         var  str = ЧислоCЗаданнойТочностью(TmpDataDS.ResPer, 9);
         var точность = КоличествоЗначащихРазрядовРезерв(str);
         var ResPer  = substr ( str, 1, точность);
         if(TmpDataDS.ResKind == KINDRES_RCBUC)
            SvOpPrintLine( "├────────────────────────────────────────────────────────────┼──────────────┼────────────────────┼───────────────────┼────────────────┼──────────┼────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤");
            SvOpPrintLine( "│                                                            │              │                    │                   │ В ненадежных   │          │    50      │" + String(TmpDataDS.Reserv:19)+"│"+ String(TmpDataDS.OldReserv:19) +"│"+String(TmpDataDS.CorrSum:19)+"│"+ String(TmpDataDS.Sum:19) +"│"+ String(TmpDataDS.DebAcc:20) +"│"+ String(TmpDataDS.CredAcc:20) +"│" );
            SvOpPrintLine( "│                                                            │              │                    │                   │ депозитариях   │          │            │                   │                   │                   │                   │                    │                    │");
            SvOpPrintLine( "├────────────────────────────────────────────────────────────┼──────────────┼────────────────────┼───────────────────┼────────────────┼──────────┼────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤");

           continue;
         end;
         if( IsExistsDate == false)  //печатаем шапку отчета
           SvOpReservHead( TmpDataDS.ResKind );
         end;
         IsExistsDate = true;
         if(TmpDataDS.Issue != OldIssue)
            if(OldIssue != -1)  //зашли для другой бумаги, распечатаем итог для предыдущей

              var StrLineItog =
              "├────────────────────────────────────────────────────────────┴──────────────┴────────────────────┴───────────────────┴────────────────┴──────────┴────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤\n" +
              "│Итого резерв по выпуску без учета вложений в ненадежных депозитариях                                                                                         │" +
                    String(ItogReserv:19)         + "│" +
                    String(ItogOldReserv:19)      + "│" +
                    String(ItogReservChange:19)   + "│" +
                    String(ItogSum:19)            + "│                    │                    │\n" +
              "├────────────────────────────────────────────────────────────┴──────────────┴────────────────────┴───────────────────┴────────────────┴──────────┴────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤\n" +
              "│Итого корректировок до ОР по выпуску                                                                                                                         │" +
                    String(ItogReservOR:19)         + "│" +
                    String(ItogOldReservOR:19)      + "│" +
                    String(ItogReservChangeOR:19)   + "│" +
                    String(ItogSumOR:19)            + "│                    │                    │\n" +
              "├────────────────────────────────────────────────────────────┬──────────────┬────────────────────┬───────────────────┬────────────────┬──────────┬────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤\n" ;

            
              SvOpPrintLine( StrLineItog );
        
              ItogReserv = 0;       
              ItogOldReserv = 0;    
              ItogReservChange = 0; 
              ItogSum = 0; 
              ItogReservOR = 0;
              ItogOldReservOR = 0;
              ItogReservChangeOR = 0;
              ItogSumOR = 0;       

            end;
            CurRowNumIssue = CurRowNumIssue + 1;
            FirstRowNumIssue = CurRowNumIssue;
            CurRowNumPortf = CurRowNumIssue;
            FirstRowNumPortf = FirstRowNumIssue;
            CurRowNumResKind = CurRowNumIssue;
            FirstRowNumResKind = FirstRowNumIssue;
            SvOpPrintLine( "├────────────────────────────────────────────────────────────┼──────────────┼────────────────────┼───────────────────┼────────────────┼──────────┼────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤");

            SvOpResLineTxt( TmpDataDS.Issue,
                            KindPortfStr,
                            TmpDataDS.Acc, 
                            TmpDataDS.RestAcc,
                            ResKindStr,
                            TmpDataDS.QualCat,
                            ResPer, 
                            TmpDataDS.Reserv, 
                            TmpDataDS.OldReserv,
                            TmpDataDS.CorrSum,
                            TmpDataDS.Sum, 
                            TmpDataDS.DebAcc,
                            TmpDataDS.CredAcc  );

            ItogReserv = ItogReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Reserv);
            ItogOldReserv = ItogOldReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.OldReserv);
            ItogReservChange = ItogReservChange + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.CorrSum);
            ItogSum = ItogSum + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Sum);
            ItogReservOR = ItogReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Reserv, 0);
            ItogOldReservOR = ItogOldReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.OldReserv, 0);
            ItogReservChangeOR = ItogReservChangeOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.CorrSum, 0);
            ItogSumOR = ItogSumOR +  IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Sum, 0);
 
            OldIssue = TmpDataDS.Issue;
            OldPortfolio = TmpDataDS.Portfolio;
            OldResKind = TmpDataDS.ResKind;
            OldIsBPP   = TmpDataDS.IsBPP;
         else
            if(  (TmpDataDS.Portfolio != OldPortfolio) OR (OldIsBPP != TmpDataDS.IsBPP) )
               CurRowNumPortf = CurRowNumPortf + 1;
               FirstRowNumPortf = CurRowNumPortf;
               CurRowNumResKind = CurRowNumPortf;
               FirstRowNumResKind = CurRowNumResKind;

            SvOpPrintLine( "│                                                            ├──────────────┼────────────────────┼───────────────────┼────────────────┼──────────┼────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤");

            SvOpResLineTxt( "",
                            KindPortfStr,
                            TmpDataDS.Acc, 
                            TmpDataDS.RestAcc,
                            ResKindStr,
                            TmpDataDS.QualCat,
                            ResPer, 
                            TmpDataDS.Reserv, 
                            TmpDataDS.OldReserv,
                            TmpDataDS.CorrSum,
                            TmpDataDS.Sum, 
                            TmpDataDS.DebAcc,
                            TmpDataDS.CredAcc  );

               ItogReserv = ItogReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Reserv);
               ItogOldReserv = ItogOldReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.OldReserv);
               ItogReservChange = ItogReservChange + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.CorrSum);
               ItogSum = ItogSum + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Sum);
               ItogReservOR = ItogReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Reserv, 0);
               ItogOldReservOR = ItogOldReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.OldReserv, 0);
               ItogReservChangeOR = ItogReservChangeOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.CorrSum, 0);
               ItogSumOR = ItogSumOR +  IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Sum, 0);
   
               OldPortfolio = TmpDataDS.Portfolio;
               OldResKind = TmpDataDS.ResKind;
               OldIsBPP   = TmpDataDS.IsBPP;
            else
               if(TmpDataDS.ResKind != OldResKind)
                  CurRowNumResKind = CurRowNumResKind + 1;
                  FirstRowNumResKind = CurRowNumResKind;

            SvOpPrintLine( "│                                                            │              ├────────────────────┼───────────────────┼────────────────┼──────────┼────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤");

            SvOpResLineTxt( "",
                            "",
                            TmpDataDS.Acc, 
                            TmpDataDS.RestAcc,
                            ResKindStr,
                            TmpDataDS.QualCat,
                            ResPer, 
                            TmpDataDS.Reserv, 
                            TmpDataDS.OldReserv,
                            TmpDataDS.CorrSum,
                            TmpDataDS.Sum, 
                            TmpDataDS.DebAcc,
                            TmpDataDS.CredAcc  );
                  ItogReserv = ItogReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Reserv);
                  ItogOldReserv = ItogOldReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.OldReserv);
                  ItogReservChange = ItogReservChange + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.CorrSum);
                  ItogSum = ItogSum + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Sum);
                  ItogReservOR = ItogReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Reserv, 0);
                  ItogOldReservOR = ItogOldReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.OldReserv, 0);
                  ItogReservChangeOR = ItogReservChangeOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.CorrSum, 0);
                  ItogSumOR = ItogSumOR +  IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Sum, 0);
      
                  OldResKind = TmpDataDS.ResKind;
               else

            SvOpPrintLine( "│                                                            │              ├────────────────────┼───────────────────┤                │          │            │                   │                   │                   │                   │                    │                    │");

            SvOpResLineTxt( "",
                            "",
                            TmpDataDS.Acc, 
                            TmpDataDS.RestAcc,
                            "",
                            "",
                            "", 
                            "", 
                            "",
                            "",
                            "", 
                            "",
                            ""  );
                  CurRowNumResKind = CurRowNumResKind + 1;
               end;

               CurRowNumPortf = CurRowNumPortf + 1;
            end;

            CurRowNumIssue = CurRowNumIssue + 1;
         end;
      end;
      if(IsExistsDate == true) // итог для последнего выпуска
        var StrLineItog1 =
        "├────────────────────────────────────────────────────────────┴──────────────┴────────────────────┴───────────────────┴────────────────┴──────────┴────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤\n" +
        "│Итого резерв по выпуску без учета вложений в ненадежных депозитариях                                                                                         │" +
              String(ItogReserv:19)         + "│" +
              String(ItogOldReserv:19)      + "│" +
              String(ItogReservChange:19)   + "│" +
              String(ItogSum:19)            + "│                    │                    │\n" +
        "├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼────────────────────┼────────────────────┤\n" +
        "│Итого корректировок до ОР по выпуску                                                                                                                         │" +
              String(ItogReservOR:19)         + "│" +
              String(ItogOldReservOR:19)      + "│" +
              String(ItogReservChangeOR:19)   + "│" +
              String(ItogSumOR:19)            + "│                    │                    │\n" +
        "└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴────────────────────┴────────────────────┘\n" ;
        
        SvOpPrintLine( StrLineItog1 );

      end;
   end;

   private macro PrintReqNotRepo2ProtocolText():bool
      var IsFirstRow = true;

      var TmpReqQuery =  "select tick.t_DealCode, "
                       + "       party.t_ShortName, "
                       + "       NVL(reservrep.t_BaseAcc, chr(1)) t_BaseAcc, "
                       + "       NVL(reservrep.t_ReservAcc, chr(1)) t_ReservAcc, "
                       + "       reservrep.t_QualCat, "
                       + "       reservrep.t_ResPer, "
                       + "       reservrep.t_BaseSum, "
                       + "       reservrep.t_Reserv, "
                       + "       reservrep.t_GuarantSum, "
                       + "       reservrep.t_OldReserv, "
                       + "       reservrep.t_CorrSum, "
                       + "       reservrep.t_ResKind "
                       + "from dspreservrep_tmp reservrep, ddl_tick_dbt tick, dparty_dbt party "
                       + "where tick.t_DealID = reservrep.t_ObjID "
                       + "  and party.t_PartyID = reservrep.t_Party";

      var TmpReqSelect = DL_RSDCommand(TmpReqQuery);
      var TmpReqDS = TmpReqSelect.execute();
      while(TmpReqDS.MoveNext())
         if(TmpReqDS.ResKind != KINDRES_SALEREPO2)
            if(IsFirstRow)
               SvOpReservHead( TmpReqDS.ResKind );
               IsfirstRow = false;
            end;
        var StrLine =

             "├───────────────┼────────────────────────────────────────────────────────────┼────────────────────┼────────────────────┼──────────┼────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┤\n"
           + "│" +  String(TmpReqDS.DealCode:15)   
           + "│" +  String(TmpReqDS.ShortName:60)  
           + "│" +  String(TmpReqDS.BaseAcc:20)    
           + "│" +  String(TmpReqDS.ReservAcc:20)  
           + "│" +  String(TmpReqDS.QualCat:10)    
           + "│" +  String(TmpReqDS.ResPer:12)     
           + "│" +  String(TmpReqDS.BaseSum:19)    
           + "│" +  String(TmpReqDS.Reserv:19)     
           + "│" +  String(TmpReqDS.GuarantSum:19) 
           + "│" +  String(TmpReqDS.OldReserv:19)  
           + "│" +  String(TmpReqDS.CorrSum:19)        + "│\n";

         SvOpPrintLine( StrLine );
         else
            return false;
         end;
      end;
      if(IsFirstRow == false)
        SvOpPrintLine ( "└───────────────┴────────────────────────────────────────────────────────────┴────────────────────┴────────────────────┴──────────┴────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┘\n") ;
      end;
      return true;
   end;

   private macro PrintReqRepo2ProtocolText():bool
      var FirstRowNumber = -1, CurRowNumber = -1;
      var ReservAcc = "", BaseAcc = "";
      var ind = 0;
      var IsFirstRow = true;

      var TmpRepoQuery =  "select tick.t_DealCode, "
                        + "       party.t_ShortName, "
                        + "       NVL(reservrep.t_BaseAcc, chr(1)) t_BaseAcc, "
                        + "       NVL(reservrep.t_ReservAcc, chr(1)) t_ReservAcc, "
                        + "       reservrep.t_QualCat, "
                        + "       reservrep.t_ResPer, "
                        + "       reservrep.t_BaseSum, "
                        + "       reservrep.t_Reserv, "
                        + "       reservrep.t_GuarantSum, "
                        + "       reservrep.t_OldReserv, "
                        + "       reservrep.t_CorrSum, "
                        + "       reservrep.t_ResKind, "
                        + "       reservrep.t_ObjID as t_DealID, "
                        + "       reservrep.t_Party "
                        + "from dspreservrep_tmp reservrep, ddl_tick_dbt tick, dparty_dbt party "
                        + "where tick.t_DealID = reservrep.t_ObjID "
                        + "  and party.t_PartyID = reservrep.t_Party";

      var TmpRepoSelect = DL_RSDCommand(TmpRepoQuery);
      var TmpRepoDS = TmpRepoSelect.execute();

      var OldDealID = -1, OldPartyID = -1, OldReservAcc = "", OldQualCat = -1, OldResPer = -1, OldBaseSum = -1, Old_Reserv = -1, Old_OldReserv = -1, OldCorrSum = -1;
      
      while(TmpRepoDS.MoveNext())
         if(TmpRepoDS.ResKind == KINDRES_SALEREPO2)
            if(IsFirstRow)
               SvOpReservHead( TmpRepoDS.ResKind );
               IsFirstRow = false;
            end;
            if((TmpRepoDS.DealID == OldDealID) and (TmpRepoDS.Party == OldPartyID) and (ReservAcc == OldReservAcc) and (TmpRepoDS.Reserv == Old_Reserv) and (TmpRepoDS.OldReserv == Old_OldReserv) and (TmpRepoDS.CorrSum == OldCorrSum))
               var StrLine =

                 "│               │                                                            │                    ├────────────────────┼──────────┼────────────┼───────────────────┤                   │                   │                   │\n" +                 
                 "│               │                                                            │                    │"+String(TmpRepoDS.BaseAcc:20) +"│"+String(TmpRepoDS.QualCat:10)+  "│" +String(TmpRepoDS.ResPer:12) + "│"+ String(TmpRepoDS.BaseSum:19) +  "│                   │                   │                   │" ;                 

               SvOpPrintLine( StrLine );
               CurRowNumber = CurRowNumber + 1;

               OldQualCat = TmpRepoDS.QualCat;
               OldResPer = TmpRepoDS.ResPer;
               OldBaseSum = TmpRepoDS.BaseSum;
            else
               ReservAcc = "";
               BaseAcc = "";
               ind = index(TmpRepoDS.BaseAcc, "|");
               if(ind == 0)
                 BaseAcc = TmpRepoDS.BaseAcc;
               else
                 BaseAcc = substr(TmpRepoDS.BaseAcc, 1, ind);
                 TmpRepoDS.BaseAcc = substr(TmpRepoDS.BaseAcc, ind+1);
               end;
       
               ind = index(TmpRepoDS.ReservAcc, "|");
               if(ind == 0)
                 ReservAcc = TmpRepoDS.ReservAcc;
               else
                 ReservAcc = substr(TmpRepoDS.ReservAcc, 1, ind - 1);
                 TmpRepoDS.ReservAcc = substr(TmpRepoDS.ReservAcc, ind + 1);
               end;

               CurRowNumber = CurRowNumber + 1;
               FirstRowNumber = CurRowNumber;
               var StrLineE =
              
                   "├───────────────┼────────────────────────────────────────────────────────────┼────────────────────┼────────────────────┼──────────┼────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┤\n"
                 + "│" +  String(TmpRepoDS.DealCode:15)   
                 + "│" +  String(TmpRepoDS.ShortName:60)  
                 + "│" +  String(ReservAcc:20)    
                 + "│" +  String(BaseAcc:20)  
                 + "│" +  String(TmpRepoDS.QualCat:10)    
                 + "│" +  String(TmpRepoDS.ResPer:12)     
                 + "│" +  String(TmpRepoDS.BaseSum:19)    
                 + "│" +  String(TmpRepoDS.Reserv:19)     
                 + "│" +  String(TmpRepoDS.OldReserv:19)  
                 + "│" +  String(TmpRepoDS.CorrSum:19)        + "│";
              
               SvOpPrintLine( StrLineE );

               var ind_b = index(TmpRepoDS.BaseAcc, "|");
               var ind_r = index(TmpRepoDS.ReservAcc, "|");
               ind = IIF(ind_b>ind_r,ind_b,ind_r);
               while(ind)
       
                  if( ind_r > 0 )
                     ReservAcc = substr(TmpRepoDS.ReservAcc, 1, ind_r - 1);
                     TmpRepoDS.ReservAcc = substr(TmpRepoDS.ReservAcc, ind_r + 1);
                  else
                     ReservAcc = TmpRepoDS.ReservAcc = " ";
                  end;
       
                  if( ind_b > 0 )
                     BaseAcc = substr(TmpRepoDS.BaseAcc, 1, ind_b);
                     TmpRepoDS.BaseAcc = substr(TmpRepoDS.BaseAcc, ind_b+1);
                  else
                     BaseAcc = TmpRepoDS.BaseAcc = " ";
                  end;
                  
               var StrLineW =
             //  "┌───────────────┬────────────────────────────────────────────────────────────┬────────────────────┬────────────────────┬──────────┬────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┐\n" +

                 "│               │                                                            ├────────────────────┼────────────────────┤          │            │                   │                   │                   │                   │\n" +                 
                 "│               │                                                            │  "+String(ReservAcc:20) +"│"+String(BaseAcc:20)+  "│          │            │                   │                   │                   │                   │" ;                 

               SvOpPrintLine( StrLineW );

                  
                  ind_b = index(TmpRepoDS.BaseAcc, "|");
                  ind_r = index(TmpRepoDS.ReservAcc, "|");
                  ind = IIF(ind_b>ind_r,ind_b,ind_r);
               end;

               OldDealID = TmpRepoDS.DealID;
               OldPartyID = TmpRepoDS.Party;
               OldReservAcc = ReservAcc;
               OldQualCat = TmpRepoDS.QualCat;
               OldResPer = TmpRepoDS.ResPer;
               OldBaseSum = TmpRepoDS.BaseSum;
               Old_Reserv = TmpRepoDS.Reserv;
               Old_OldReserv = TmpRepoDS.OldReserv;
               OldCorrSum = TmpRepoDS.CorrSum;
            end;
         else
            return false;
         end;
      end;
      if(IsFirstRow == false)
        SvOpPrintLine ( "└───────────────┴────────────────────────────────────────────────────────────┴────────────────────┴────────────────────┴──────────┴────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┘\n") ;
      end;
      return true;
   end;

macro InsertDataToTmp(Data:SvOpReserve, Acc, RestAcc, Reserv, CorrSum, ReservChange, AccDbt, AccCred, PartyID, IsBPP, Priority, OldReserv)

   var ResKind = 0;
   var ResPc = Data.ResPc;
   if( (Reserv == 0) AND (CorrSum == 0) AND (ReservChange == 0))
     ResPc = 0;
   end;
   if(OldReserv == NULL)
     OldReserv = 0;
   end;
   if(Priority != NULL) //РЦБ
      if( (Priority > 0) AND (Priority <= 3))
        /*Data.*/ResKind = KINDRES_RCB;
      elif( Priority == 4)
        /*Data.*/ResKind = KINDRES_RVPCB;
      elif( (Priority >= 5) AND (Priority <= 6))
        /*Data.*/ResKind = KINDRES_ROCB;
      elif( Priority == 7 )
        /*Data.*/ResKind = KINDRES_RCBUC;
      else
        ResKind = Data.ResKind;
      end;
   else
      ResKind = Data.ResKind;
   end;

   var IsExistsAccQuery = "SELECT 1 FROM DSPRESERVREP_TMP WHERE T_ACC = ? AND T_OBJID = ? AND T_PORTFOLIO = ? AND T_ISBPP = ? AND T_SUM  = ? /*AND T_PRIORITY = ?*/";
   var IsExistsAccSelect = DL_RSDCommand(IsExistsAccQuery);
   IsExistsAccSelect.AddParam(Acc);
   IsExistsAccSelect.AddParam(Data.ObjID);
   IsExistsAccSelect.AddParam(Data.KindPortf);
   IsExistsAccSelect.AddParam(IIF(IsBPP != NULL, IsBPP, 0));
   IsExistsAccSelect.AddParam(ReservChange);
//   IsExistsAccSelect.AddParam(Priority);
   var IsExistsAccDS = IsExistsAccSelect.Execute();
   var IsExistsAcc = IsExistsAccDS.MoveNext();
   if( (not IsExistsAcc) /*OR (PartyID != NULL)*/)
      var TmpInsertQuery = "INSERT INTO DSPRESERVREP_TMP VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
   var TmpInsertSelect = RSDCommand(TmpInsertQuery);
   TmpInsertSelect.AddParam("", RSDBP_IN, Data.ObjID);
   TmpInsertSelect.AddParam("", RSDBP_IN, Data.KindPortf);

   TmpInsertSelect.AddParam("", RSDBP_IN, IIF((Acc != NULL) and (not IsExistsAcc), Acc, ""));
   TmpInsertSelect.AddParam("", RSDBP_IN, IIF((RestAcc != NULL) and (not IsExistsAcc), RestAcc, ""));

      TmpInsertSelect.AddParam("", RSDBP_IN, /*Data.*/ResKind);
   TmpInsertSelect.AddParam("", RSDBP_IN, Data.RiskGrp);
      TmpInsertSelect.AddParam("", RSDBP_IN, /*Data.*/ResPc);
   TmpInsertSelect.AddParam("", RSDBP_IN, IIF(Reserv != NULL, Reserv, 0));
      TmpInsertSelect.AddParam("", RSDBP_IN, IIF( ((AccDbt != NULL) AND (ReservChange != 0)), Data.OldReserv, OldReserv ));
   TmpInsertSelect.AddParam("", RSDBP_IN, IIF(CorrSum != NULL, CorrSum, 0));
   TmpInsertSelect.AddParam("", RSDBP_IN, IIF(ReservChange != NULL, ReservChange, 0));
      TmpInsertSelect.AddParam("", RSDBP_IN, IIF( ((AccDbt != NULL) AND (ReservChange != 0)), AccDbt, ""));
      TmpInsertSelect.AddParam("", RSDBP_IN, IIF( ((AccCred != NULL) AND (ReservChange != 0)), AccCred, ""));
   TmpInsertSelect.AddParam("", RSDBP_IN, IIF(PartyID != NULL, PartyID, 0));
   TmpInsertSelect.AddParam("", RSDBP_IN, Data.BaseAcc);
   TmpInsertSelect.AddParam("", RSDBP_IN, Data.ReservAcc);
   TmpInsertSelect.AddParam("", RSDBP_IN, Data.BaseSum);
   TmpInsertSelect.AddParam("", RSDBP_IN, Data.GuarantSum);
      TmpInsertSelect.AddParam("", RSDBP_IN, IIF(IsBPP != NULL, IsBPP, 0));
      TmpInsertSelect.AddParam("", RSDBP_IN, IIF(Priority != NULL, Priority, 0));
   TmpInsertSelect.execute();
end;                    
end;

private record LnFI(fininstr);
private record LnParty(party);
private file   LnDeal(dl_tick);
private file   LnDealNtg(dl_nett);
private record LnDl_leg(dl_leg);
var KindPortfOld = 0, KindPortfStr = "";
var ObjIDold = 0;
private macro SvOpReservLine( Data:SvOpReserve, Num:INTEGER, headIsPrinted, p_ItogReservLineByFIID:ItogReservLineByFIID )
  var Reserv, ReservChange, StrLine = "", DealCode, Contractor, ResKindStr = "", ind = 0, AccDbt = "", BaseAcc = "", RiskGrp, ResPc, BaseSum, RiskGrp2, ResPc2, BaseSum2, AccCred = "", ReservAcc = "";
  var ReservChangeOR = $0, SumOR = $0;
  var BuyCostAcc = TRecHandler("account"), BuyCostRest = $0.0, BonusAcc = TRecHandler("account"), BonusRest = $0.0, PayedNKDAcc = TRecHandler("account"), PayedNKDRest = $0.0, AccruedNKDAcc = TRecHandler("account"),
      AccruedNKDRest = $0.0, DiscountAcc = TRecHandler("account"), DiscountRest = $0.0, CorrCostAcc = TRecHandler("account"), CorrCostRest = $0.0, OverAcc = TRecHandler("account"), OverRest = $0.0;
  var PDAcc = TRecHandler("account"), DDAcc = TRecHandler("account"), PDRest = $0.0, DDRest = $0.0;
  var FD;
  var IsBPP = 0;
  var AccCateg = "", NKDCat = "", ReservAccount = "", AccCategNum = "", NKDCatNum = "";
  var ReservAccRec = TRecHandler( "account" );
  var ReservAccRecPD = TRecHandler( "account" );
  var CorReservAcc = TRecHandler( "account" );
  var IsAddRes = 1;
  var FirolePD = -1, FiroleDD = -1;
  var FIROLE_ = -1;
  var RestReserv = 0, RestReservPD = 0, RestCorReserv = 0;

  if( not ((ScOprServDoc.OperationKind == KINDRES_REQ) and (Data.ResKind == KINDRES_SALEREPO2)) )
     Reserv       = money(ABS(Data.BaseSum)*double(Data.ResPc)/100.);
     if((ValType(Data.CorrectSum) != V_UNDEF) and (Data.CorrectSum != $0))
       ReservChange = ABS(Data.CorrectSum);
     else
       ReservChange = ABS(Reserv-Data.OldReserv);
     end;
  end;

  if( ScOprServDoc.OperationKind == KINDRES_RCB )
     FD = SPFirstDocFIReserv(Data.ObjID, ScOprServDoc.OperationKind);

     if(Data.ObjID != ObjIDOld)
        KindPortfOld = 0;
     end;

     if(Data.KindPortf != NULL)
     if(Data.ResKind == KINDRES_RCBUC)
       Data.KindPortf = -1;
     elif(Data.ResKind == KINDRES_ROCB)
       ReservChangeOR = ReservChange;
       SumOR = ReservChange;
       Reserv = ABS(Data.BaseSum);
       Data.OldReserv = ABS(Data.OldReserv);
     end;
     else
        Data.KindPortf = -1;
     end;
     if(Data.KindPortf != -1)
       Data.FIRole =  GetFIRoleByPortfolio( Data.KindPortf );
     end;
     AccCred = Data.AccCred;
     AccDbt = Data.AccDbt;

     var LotStatus = 0;
     if(Data.FIRole != NULL)
     if((Data.FIRole == FIROLE_BA_PPR) or (Data.FIRole == FIROLE_BA_PUDP) or (Data.FIRole == FIROLE_BAINPROMISSORY) or (Data.FIRole == FIROLE_BAINCONTR))
        LotStatus = PM_WRTSUM_FORM;
     elif(Data.FIRole >= 0)
        LotStatus = PM_WRTSUM_SALE_BPP;
           IsBpp = 1;
     end;
     else
        Data.FIRole = -1;
     end;
     if(Data.FIRole == FIROLE_BA_PPR_BPP )
        FirolePD = FIROLE_PD_PPR_BPP;
        FiroleDD = FIROLE_DD_PPR_BPP;
     elif(Data.FIRole == FIROLE_BA_PPR )
        FirolePD = FIROLE_PD_PPR;
        FiroleDD = FIROLE_DD_PPR;
     elif(Data.FIRole == FIROLE_BA_PUDP ) //АС_ЦБ
        FirolePD = FIROLE_PD_PUDP;
        FiroleDD = FIROLE_DD_PUDP;
     elif(Data.FIRole == FIROLE_BAINPROMISSORY )   //ПДО
        FirolePD = FIROLE_PD_PDO;
        FiroleDD = FIROLE_DD_PDO;
     elif( (Data.FIRole == FIROLE_BAINCONTR) OR (Data.FIRole == FIROLE_BAINCONTR))    //ПКУ
        FirolePD = FIROLE_PD_PKU;
        FiroleDD = -1;
     elif(Data.FIRole == FIROLE_BA_ASCB_BPP )
        FirolePD = FIROLE_PD_PUDP;
        FiroleDD = FIROLE_DD_PUDP;
     end;

     if(Data.DateReserv == NULL)
        Data.DateReserv = date(0, 0, 0);
     end;

     if(Data.FIRole >= 0)
        if(IsBpp == 1)
           if( ВедениеСчетовБПППоВыпуску() == true)
              if( (Data.FIRole == FIROLE_BA_CONTR_BPP) OR ( Data.FIRole == FIROLE_PD_PKU ) )
                 AccCateg = "Наш портфель ПКУ, ц/б";
                 AccCategNum = "1253";
              else
                 AccCateg = "Наш портфель ц/б";
                 AccCategNum = "231";
              end;
              if(ОтдельныйУчетУплНКД())
                 NKDCat = "Уплаченный НКД";
                 NKDCatNum = "1207";
              else
                 NKDCat = "Наш портфель ц/б";
                 NKDCatNum = "231";
              end;
           else
              if( (Data.FIRole == FIROLE_BA_CONTR_BPP) OR ( Data.FIRole == FIROLE_PD_PKU ) )
                 AccCateg = "Ц/б, ПКУ БПП";
                 AccCategNum = "1298,1299";
              else
                 AccCateg = "Ц/б, БПП";
                 AccCategNum = "233,1237";
              end;
              if(ОтдельныйУчетУплНКД())
                 NKDCat = "Уплаченный НКД, БПП";
                 NKDCatNum = "1208,1238";
              else
                 NKDCat = "Ц/б, БПП" ;
                 NKDCatNum = "233,1237";
              end;
           end;
        end;

        
        if(FD.IsExistAccount( "Резерв ц/б", null, true, Data.FIRole, ReservAccRec, null, Data.DateReserv)) 
           ReservAccount =  ReservAccRec.rec.Account;
           RestReserv = GetRestAccount(ReservAccRec.rec, Data.DateReserv);
        end;

        if(FD.IsExistAccount( "Резерв ц/б", null, true, GetFIRoleByPortfolio( Data.KindPortf, false, true ), ReservAccRecPD, null, Data.DateReserv))
           RestReservPD = GetRestAccount(ReservAccRecPD.rec, Data.DateReserv);
        end;
        if(FD.IsExistAccount("+Кор_Резерв, ЦБ", null, true, Data.FIRole, CorReservAcc, null, Data.DateReserv))
           RestCorReserv = GetRestAccount(CorReservAcc.rec, Data.DateReserv);
        end;
        if(OverRest == $0.0)
           if(FD.IsExistAccount("-Кор_Резерв, ЦБ", null, true, Data.FIRole, CorReservAcc, null, Data.DateReserv))
              RestCorReserv= GetRestAccount(CorReservAcc.rec, Data.DateReserv);
           end;
        end;

        if(FD.IsExistAccount("Наш портфель ц/б", null, true, Data.FIRole, BuyCostAcc, null, Data.DateReserv))
           BuyCostRest = GetRestAccount(BuyCostAcc.rec, Data.DateReserv);
        end;
        if(FD.IsExistAccount("Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(Data.KindPortf, IIF(IsBpp == 1, true, false)) /*Data.FIRole*/, BonusAcc, null, Data.DateReserv))
           BonusRest = GetRestAccount(BonusAcc.rec, Data.DateReserv);
        end;
        if(FD.IsExistAccount("Уплаченный НКД", null, true, Data.FIRole, PayedNKDAcc, null, Data.DateReserv))
           PayedNKDRest = GetRestAccount(PayedNKDAcc.rec, Data.DateReserv);
        end;
        if(FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, Data.FIRole, AccruedNKDAcc, null, Data.DateReserv))
           AccruedNKDRest = GetRestAccount(AccruedNKDAcc.rec, Data.DateReserv);
        end;
        if(FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, FirolePD, PDAcc, null, Data.DateReserv))
           PDRest = GetRestAccount(PDAcc.rec, Data.DateReserv);
        end;
        if(FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, FiroleDD, DDAcc, null, Data.DateReserv))
           DDRest = GetRestAccount(DDAcc.rec, Data.DateReserv);
        end;
        if(FD.IsExistAccount("+Корректировка, ц/б", null, true, Data.FIRole, CorrCostAcc, null, Data.DateReserv))
           CorrCostRest = GetRestAccount(CorrCostAcc.rec, Data.DateReserv);
        end;
        if(CorrCostRest == $0.0)
           if(FD.IsExistAccount("-Корректировка, ц/б", null, true, Data.FIRole, CorrCostAcc, null, Data.DateReserv))
              CorrCostRest = GetRestAccount(CorrCostAcc.rec, Data.DateReserv);
           end;
        end;
        if(FD.IsExistAccount("+Переоценка, ц/б", null, true, Data.FIRole, OverAcc, null, Data.DateReserv))
           OverRest = GetRestAccount(OverAcc.rec, Data.DateReserv);
        end;
        if(OverRest == $0.0)
           if(FD.IsExistAccount("-Переоценка, ц/б", null, true, Data.FIRole, OverAcc, null, Data.DateReserv))
              OverRest = GetRestAccount(OverAcc.rec, Data.DateReserv);
           end;
        end;

     end;
     if((Data.KindPortf >= 0) and (Data.FIRole >= 0) and (Data.DateReserv != date(0, 0, 0)))
              if(IsBpp == 0) 
     if(BuyCostRest != 0)
                    InsertDataToTmp(Data, BuyCostAcc.rec.Account, BuyCostRest, IIF(Data.ResKind == KINDRES_RCB, Reserv, 0), IIF(Data.ResKind == KINDRES_RCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_RCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp,  1, RestReserv);
                 end;
                 if(PayedNKDRest != 0)
                   InsertDataToTmp(Data, PayedNKDAcc.rec.Account, PayedNKDRest, IIF(Data.ResKind == KINDRES_RCB, Reserv, 0), IIF(Data.ResKind == KINDRES_RCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_RCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp, 3, RestReserv );
                 end;
              else
                 var AttrID = UniID( ReservAccRec, OBJTYPE_ACCOUNT);
                
                 var Query = RSDCommand(  " Select DISTINCT lnk.t_ObjectID "
                                    + "   From dobjlink_dbt lnk, dmcaccdoc_dbt doc"
                                    + "  Where lnk.t_ObjectType = " + OBJTYPE_ACCOUNT
                                    + "    and lnk.t_GroupID = " + OBJROLE_ACC_RESERV137
                                    + "    and lnk.t_AttrType = " + OBJTYPE_ACCOUNT
                                    + "    and lnk.t_AttrID = ? "
                                    + "    and lnk.t_ValidToDate >= ? " 
                                    + "    and doc.t_account = SUBSTR (lnk.t_ObjectID, -20, 20) "
                                    + "    and doc.t_catnum IN ( "+ AccCategNum +") " 
                                   );
                
                 Query.addParam( "", RSDBP_IN, AttrID );
                 Query.addParam( "", RSDBP_IN, Data.DateReserv );
                 Query.execute();
                
                 var DataSet = TRsbDataSet(Query);
                
                 while(DataSet.MoveNext())
                    if( RestoreFromUniID(DataSet.ObjectID, BuyCostAcc, OBJTYPE_ACCOUNT) == true )
                       BuyCostRest = GetRestAccount(BuyCostAcc.rec, Data.DateReserv);
                       InsertDataToTmp(Data, BuyCostAcc.rec.Account, BuyCostRest, IIF(Data.ResKind == KINDRES_RCB, Reserv, 0), IIF(Data.ResKind == KINDRES_RCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_RCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp, IsBpp, 1, Reserv);
                    end;
                 end;
                
                 Query = RSDCommand(  " Select DISTINCT lnk.t_ObjectID "
                                    + "   From dobjlink_dbt lnk, dmcaccdoc_dbt doc"
                                    + "  Where lnk.t_ObjectType = " + OBJTYPE_ACCOUNT
                                    + "    and lnk.t_GroupID = " + OBJROLE_ACC_RESERV137
                                    + "    and lnk.t_AttrType = " + OBJTYPE_ACCOUNT
                                    + "    and lnk.t_AttrID = ? "
                                    + "    and lnk.t_ValidToDate >= ? " 
                                    + "    and doc.t_account = SUBSTR (lnk.t_ObjectID, -20, 20) "
                                    + "    and doc.t_catnum IN ( "+ NKDCatNum +") " 
                                   );
                
                 Query.addParam( "", RSDBP_IN, AttrID );
                 Query.addParam( "", RSDBP_IN, Data.DateReserv );
                 Query.execute();
                
                 DataSet = TRsbDataSet(Query);
                
                 while(DataSet.MoveNext())
                    if( RestoreFromUniID(DataSet.ObjectID, PayedNKDAcc, OBJTYPE_ACCOUNT) == true )
                       BuyCostRest = GetRestAccount(PayedNKDAcc.rec, Data.DateReserv);
                       InsertDataToTmp(Data, PayedNKDAcc.rec.Account, PayedNKDRest, IIF(Data.ResKind == KINDRES_RCB, Reserv, 0), IIF(Data.ResKind == KINDRES_RCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_RCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp,  3, RestReserv);
                    end;
                 end;
     end;
     if(BonusRest != 0)
                 InsertDataToTmp(Data, BonusAcc.rec.Account, BonusRest, IIF(Data.ResKind == KINDRES_RCB, Reserv, 0), IIF(Data.ResKind == KINDRES_RCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_RCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp, 2, RestReserv);
              end;
              if(PDRest != 0)
                 InsertDataToTmp(Data, PDAcc.rec.Account, PDRest, IIF(Data.ResKind == KINDRES_RVPCB, Reserv, 0), IIF(Data.ResKind == KINDRES_RVPCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_RVPCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp,  4, RestReservPD);
     end;
              if(DDRest != 0)
                 InsertDataToTmp(Data, DDAcc.rec.Account, DDRest, IIF(Data.ResKind == KINDRES_RVPCB, Reserv, 0), IIF(Data.ResKind == KINDRES_RVPCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_RVPCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp,  4 , RestReservPD);
     end;
     if(CorrCostRest != 0)
                 InsertDataToTmp(Data, CorrCostAcc.rec.Account, CorrCostRest, IIF(Data.ResKind == KINDRES_ROCB, Reserv, 0), IIF(Data.ResKind == KINDRES_ROCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_ROCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp, 5, RestCorReserv);
                 IsAddRes = 0;
     end;                                                                                                                                                                
     if(OverRest != 0)
                 InsertDataToTmp(Data,  OverAcc.rec.Account, OverRest, IIF(Data.ResKind == KINDRES_ROCB, Reserv, 0), IIF(Data.ResKind == KINDRES_ROCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_ROCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp, 6, RestCorReserv);
                 IsAddRes = 0;
              end;
              if(IsAddRes != 0)  // нет остатков на корректировке и переоценке, тогда добавим без счетов и остатков
                 InsertDataToTmp(Data, "", 0, IIF(Data.ResKind == KINDRES_RCB, Reserv, 0), IIF(Data.ResKind == KINDRES_ROCB, ABS(Reserv - Data.OldReserv), 0),  IIF(Data.ResKind == KINDRES_ROCB, ReservChange, 0), AccDbt, AccCred, NULL, IsBpp, 6, RestCorReserv);
                 IsAddRes = 0;
              end;
     else
        if(Data.ResKind == KINDRES_RCBUC)
          InsertDataToTmp(Data, "", 0, Reserv, ABS(Reserv - Data.OldReserv), ReservChange, AccDbt, AccCred, NULL, NULL, 7);
        else
          InsertDataToTmp(Data, "", 0, Reserv, ABS(Reserv - Data.OldReserv), ReservChange, AccDbt, AccCred);
        end;
     end;

  elif( ScOprServDoc.OperationKind == KINDRES_DEAL )
     ClearRecord( LnDeal );
     LnDeal.DealID = Data.ObjID;
     GetEQ( LnDeal );
     FindDL_LEG( LEG_KIND_DL_TICK, LnDeal.DealID, 0, LnDl_leg );
     ПолучитьФинИн( LnDl_leg.PFI, LnFI );
     
     StrLine = 
"├──────────────────────────────┼───────────────┼────────────────────┼────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
              "│" + String(LnDeal.DealCode:30) + "│" + 
              String(LnFI.FI_Code:15)        + "│" +
              String(Data.MarketSum:20)        + "│" +
              String(Data.CostRUR:20)        + "│" +
              String(Data.ReservAcc:26)      + "│" +
              String(Data.RiskGrp:8)         + "│" +
              String(Data.ResPc:9)           + "│" +
              String(Data.BaseSum:20)        + "│" +
              String(Reserv:20)              + "│" +
              String(Data.OldReserv:20)      + "│" +
              String(ReservChange:20)        + "│" ;

  elif( ScOprServDoc.OperationKind == KINDRES_REQ  )
     SvOpLastResKind = Data.ResKind;

     if( Data.IsDealNtg == true )
        ClearRecord( LnDealNtg );
        LnDealNtg.NettingID = Data.ObjID;
        GetEQ( LnDealNtg ); 
        DealCode   = LnDealNtg.DealNumber;
        Contractor = LnDealNtg.Contractor;
     else
           ClearRecord( LnDeal );
           LnDeal.DealID = Data.ObjID;
           GetEQ( LnDeal );
           DealCode   = LnDeal.DealCode;
           Contractor = GetContrInDeal(LnDeal);
     end;

     ПолучитьСубъекта( Contractor, LnParty );

     if( Data.ResKind == KINDRES_SALEREPO2)/*без столбца "гарантийное обеспечение", по одной сделке 2 строки*/

        if( money(Data.BaseSum) > $0.0 )/*в новой версии Data.BaseSum заполняем*/

           if( (int(Data.RiskGrpSec) == -1) and (money(Data.ResPcSec) == -1) )
              if( Data.IsSetting )
                 RiskGrp  = " ";
                 ResPc    = " ";
                 ResPc2   = money(Data.ResPc);
                 RiskGrp2 = int(Data.RiskGrp);
              else
                 ResPc   = money(Data.ResPc);
                 RiskGrp = int(Data.RiskGrp);
                 RiskGrp2 = " ";
                 ResPc2   = " ";
              end;
           else
              RiskGrp = int(Data.RiskGrpSec);
              ResPc   = money(Data.ResPcSec);
              if( Data.IsSetting )
                 ResPc2  = max(money(Data.ResPc),money(Data.ResPcSec));
                 if( ResPc2 == money(Data.ResPc))
                    RiskGrp2 = int(Data.RiskGrp);
                 else
                    RiskGrp2 = int(Data.RiskGrpSec);
                 end;
              else
                 RiskGrp2 = " ";
                 ResPc2   = " ";
              end;
           end;
         
           BaseSum2 = money(Data.AccRest_BPP);
         
           BaseSum = money(Data.AccRest_OD);
           Reserv  = money(Data.BaseSum);
           ReservChange = Reserv - money(Data.OldReserv);

        else/*старая версия*/
           if( Data.IsSetting )
              RiskGrp = int(Data.RiskGrpSec);
              ResPc   = money(Data.ResPcSec);
              BaseSum = money(Data.AccRest_OD);
           
              ResPc2  = max(money(Data.ResPc),money(Data.ResPcSec));
              if( ResPc2 == money(Data.ResPc))
                 RiskGrp2 = int(Data.RiskGrp);
              else
                 RiskGrp2 = int(Data.RiskGrpSec);
              end;
           
              BaseSum2 = money(Data.AccRest_BPP) - BaseSum;
              if( BaseSum2 < $0 )
                 BaseSum2 = $0;
                 Reserv  = money((BaseSum*ResPc)/100.);
              else
                 Reserv  = money((BaseSum*ResPc + BaseSum2*ResPc2)/100.);
              end;
           
              ReservChange = Reserv - money(Data.OldReserv);
           else
              RiskGrp = int(Data.RiskGrp);
              ResPc   = money(Data.ResPc);
              BaseSum = " ";
           
              RiskGrp2 = " ";
              ResPc2   = " ";
              BaseSum2 = money(Data.AccRest_BPP) - money(Data.AccRest_OD);
           
              if( BaseSum2 < $0 )
                 BaseSum2 = 0;
              end;
           
              Reserv  = BaseSum2*ResPc;
              ReservChange = Reserv - money(Data.OldReserv);
           end;
        end;
        
        InsertDataToTmp(Data, NULL, NULL, Reserv, ReservChange, NULL, NULL, NULL, Contractor);

        Data.RiskGrp = RiskGrp2;
        Data.ResPc = ResPc2;
        Data.BaseSum = BaseSum2;
   
        InsertDataToTmp(Data, NULL, NULL, Reserv, ReservChange, NULL, NULL, NULL, Contractor);
     else
        InsertDataToTmp(Data, NULL, NULL, Reserv, ReservChange, NULL, NULL, NULL, Contractor);
     end;
  end; 
end;                    

private macro SvOpComissLine( KindAction, Data:SvOpComiss, Num:INTEGER )
   const
      SvOp_skCalcComm   = 200,   /*расчет комиссии (в дату заключения сделки)*/ 
      SvOp_skPayComm    = 300;   /*оплата комиссии (в дату оплаты комиссий)*/
   var
      Mes = null;

   if( KindAction == SvOp_skCalcComm )
      Mes = "Расчет комиссий выполнен успешно.";
   elif( KindAction == SvOp_skPayComm )
      Mes = "Оплата комиссий выполнена успешно.";
   end;

   SvOpProcessPeriodComm_PrintLine( SvOpReportFile, ScOpIsServiceOper,
                                    Data.number, Mes );
end;

/*****************************************************************************
                    Общие ф-и для печати отчета серв. операции 
******************************************************************************/
/*Вызывается при инициализации сервисной операции*/
macro ScOpInit( )
  VAR errcode, errtext;
  ReplaceMacro ( "msgbox", NULL );
  close( SvOpReportFile ); /*На всякий случай*/
  if( not Open( SvOpReportFile, GetTxtFileName(SvOpReportName) ) )
     errcode = status(errtext);
     MsgBox( "Ошибка при создании временного файла|"+GetTxtFileName(SvOpReportName)+"|(" + errcode + ") " + errtext);
     RunError( "Ошибка при создании временного файла|"+GetTxtFileName(SvOpReportName)+"|(" + errcode + ") " + errtext );
  end;

  SvOpErrorArray.Size = 0;
  ScOpNumInsRecord = 0;
  ScOpLastServDocKind = -1;
  ScOpReportLineData.Size = 0;
  ScOpIsServiceOper  = true;
  SvOpLastResKind = -1;
  ReplaceMacro ( "msgbox", "Svop_msgbox" );
end;

private macro SvOpPrintFootLine( dl_comm, OperationKind )
  if( dl_comm.DocKind == DL_OVERVALUE_RD )
     SvOpPrintLine( SvOpOvervalue_RDFoot() );
     SvOpPrintLine( "" );
     SvOpPrintLine( "" );
  elif( dl_comm.DocKind == DL_OVERVALUE_NVPI )
     SvOpPrintLine( SvOpOvervalue_NVPIFoot() );
     SvOpPrintLine( "" );
     SvOpPrintLine( "" );
  elif( dl_comm.DocKind == BofficeKindCOMM )
     SvOpProcessPeriodComm_PrintFoot(  SvOpReportFile, ScOpIsServiceOper,
                                       IsOprMultiExec(), dl_comm );
  elif( dl_comm.DocKind == DL_CALCTSS )
     SvOpPrintLine( SvOpCALCTSSFoot() );
     SvOpPrintLine( "" );
     SvOpPrintLine( "" );
  end;
end;

/*Подвал отчета о сервисной операции*/
macro SvOpPrintFoot( dl_comm )
  var Executer = DepoExecuter( {oper} );

  if( not ((dl_comm.DocKind == DL_RESERVEDOC) or 
           (dl_comm.DocKind == DL_GET_INCOME) or
           (dl_comm.DocKind == DL_OVERVALUE)
          ) 
    )
    SvOpPrintFootLine( dl_comm, dl_comm.OperationKind );
  end;

  if(dl_comm.DocKind != DL_RESERVEDOC)
  SvOpPrintLine( 
"Составил ( " + Executer.Post + " ):\n" +
string( Executer.Name ) + "                 " + String( {curdate} ) + "\n" +
DL_StrCut( "", IIF(strlen(Executer.Name) <= 10, 10, strlen(Executer.Name) ), "─" ) + " ───────────────   дата" + "\n" +
DL_StrCut("", IIF(strlen(Executer.Name) <= 10, 0, (strlen(Executer.Name) - 10) / 2 ), " ") + "   ФИО    " + DL_StrCut("", IIF(strlen(Executer.Name) <= 10, 0, (strlen(Executer.Name) - 10) / 2), " " ) + "    подпись" );
end;
end;

/*Печать строки отчета*/
macro ScOpPrintReportLine( OprDocKind, SvOpServDoc, SvOpDoc, KindAction )

  var    i = 0;

  if( ScOpReportLineData.Size == 0 ) /*Печатать нечего*/
    return; 
  end;

  ConnectBuff( ScOprServDoc, SvOpServDoc ); 

  if( ScOprServDoc.DocKind == DL_RESERVEDOC )
    /*Это нужно для массового выполнения, т.к. в одном скроллинге сразу все 
      операции резерва, поэтому нужно при смене операции перерисовывать 
      шапку и подвал отчета*/
    if( ScOpLastServDocKind != ScOprServDoc.OperationKind )
       if( ScOpLastServDocKind != -1 )
          SvOpPrintFootLine( ScOprServDoc, ScOpLastServDocKind );
       end;
       ScOpLastServDocKind = ScOprServDoc.OperationKind;
       ScOpNumInsRecord = 0;
    end;
  end;

  if( ScOpNumInsRecord == 0 )
    if( not (((ScOprServDoc.DocKind == DL_RESERVEDOC) and 
              ((ScOprServDoc.OperationKind == KINDRES_DEAL) or   
               (ScOprServDoc.OperationKind == KINDRES_REQ)
              )
             ) or 
             (ScOprServDoc.DocKind == DL_GET_INCOME) or
             (ScOprServDoc.DocKind == DL_OVERVALUE)
            ) 
      )
       SvOpPrintHead( ScOprServDoc );
    end;
  end;

  ScOpNumInsRecord = ScOpNumInsRecord + 1;
  /*может быть несколько строк для отчета на 1 шаге*/ 
  while( i < ScOpReportLineData.Size )
     if( ScOprServDoc.DocKind == DL_RESERVEDOC )
       /*Для печати протокола РСС - вызывается Print_MemOrder. См. запросы 88651, 89070.*/
       if (ScOprServDoc.OperationKind != KINDRES_DEAL)
          SvOpReservLine( ScOpReportLineData[i], i );
       end;
     elif( ScOprServDoc.DocKind == DL_OVERVALUE_RD )
        SvOpOvervalue_RDLine( ScOpReportLineData[i], i );
     elif( ScOprServDoc.DocKind == DL_OVERVALUE_NVPI )
        SvOpOvervalue_NVPILine( ScOpReportLineData[i] );
     elif( ScOprServDoc.DocKind == BofficeKindCOMM )
       SvOpComissLine( KindAction, ScOpReportLineData[i], i );
     elif( ScOprServDoc.DocKind == DL_CALCTSS )
       SvOpCALCTSSLine( ScOpReportLineData[i], i );
     end;
     i = i + 1;
  end;

   if(ScOprServDoc.DocKind == DL_RESERVEDOC)
      if(ScOprServDoc.Flag9 == SET_CHAR) // печатать в Excel
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
        var CBReport = SP_Reserv_Report(ScOprServDoc);
        CBReport.Run();
      else
        if(ScOprServDoc.OperationKind == KINDRES_RCB)
          PrintCBProtocolTxt(ScOprServDoc);
        elif( ScOprServDoc.OperationKind == KINDRES_REQ )
          if(not PrintReqNotRepo2ProtocolText())
             PrintReqRepo2ProtocolText();
          end;
        end;
      end;
      exit(1);

      sql_execute("TRUNCATE TABLE DSPRESERVREP_TMP");
   end;

  ClearRecord( LnDeal );
  ScOpReportLineData.Size = 0;
end;

/*Печать строки отчета*/
macro SvOpPrintReportLine_XML( OprDocKind, SvOpServDoc, SvOpReportLineData_XML )

  var    i = 0, HeadPrinted = false;
  var    v_ItogReservLineByFIID = ItogReservLineByFIID(), SubDocKind = null;
  var    IsFindData = 0;
  ConnectBuff( ScOprServDoc, SvOpServDoc ); 

  /*для переоценки  НВПИ и внебаланса пока единственная форма*/
  SvOpReportLineData_XML.SetReportNumber(0);
  if(( ScOprServDoc.DocKind == DL_RESERVEDOC ) and (IsOprMultiExec())  )
    /*Это нужно для массового выполнения, т.к. в одном скроллинге сразу все 
      операции резерва, поэтому нужно при смене операции перерисовывать 
      шапку и подвал отчета*/
    if( ScOpLastServDocKind != ScOprServDoc.OperationKind )
       if( ScOpLastServDocKind != -1 )
          SvOpPrintFootLine( ScOprServDoc, ScOpLastServDocKind );
       end;
       ScOpLastServDocKind = ScOprServDoc.OperationKind;
       ScOpNumInsRecord = 0;
    end;
  else
   ScOpNumInsRecord = 0;
  end;
 
  while( SvOpReportLineData_XML.Next )
     IsFindData = 1 ;    
     if( ScOpNumInsRecord == 0 )
       if(not HeadPrinted and (not (((ScOprServDoc.DocKind == DL_RESERVEDOC) and 
              (/*(ScOprServDoc.OperationKind == KINDRES_RCB) or
               (ScOprServDoc.OperationKind == KINDRES_REQ) or */(ScOprServDoc.OperationKind == KINDRES_DEAL) 
              ))
             or 
             (ScOprServDoc.DocKind == DL_GET_INCOME) or
             (ScOprServDoc.DocKind == DL_OVERVALUE) 
               )))

          if( (ScOprServDoc.DocKind == DL_RESERVEDOC) and (ScOprServDoc.OperationKind == KINDRES_REQ) )
             SubDocKind = SvOpReportLineData_XML.GetReportLineData().ResKind;
          end;

          SvOpPrintHead( ScOprServDoc, SubDocKind );
          HeadPrinted = true;
       end;
     end;

     if( ScOprServDoc.DocKind == DL_OVERVALUE_RD )
        SvOpOvervalue_RDLine( SvOpReportLineData_XML.GetReportLineData(), i );
     elif( ScOprServDoc.DocKind == DL_OVERVALUE_NVPI )
        SvOpOvervalue_NVPILine( SvOpReportLineData_XML.GetReportLineData() );
     elif( ScOprServDoc.DocKind == DL_RESERVEDOC )
       if (ScOprServDoc.OperationKind != KINDRES_DEAL)
         SvOpReservLine( SvOpReportLineData_XML.GetReportLineData(),i,HeadPrinted,v_ItogReservLineByFIID );
       end;
     elif( ScOprServDoc.DocKind == DL_CALCTSS )
        SvOpCALCTSSLine( SvOpReportLineData_XML.GetReportLineData() );
     end;

     i = i + 1;

     ScOpNumInsRecord = ScOpNumInsRecord + 1;

  end;

   if((ScOprServDoc.DocKind == DL_RESERVEDOC) AND (IsFindData == 1) )
      if(ScOprServDoc.Flag9 == SET_CHAR) // печатать в Excel
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
        var CBReport = SP_Reserv_Report(ScOprServDoc);
        CBReport.Run();
      else
        if(ScOprServDoc.OperationKind == KINDRES_RCB)
          PrintCBProtocolTxt(ScOprServDoc);
        elif( ScOprServDoc.OperationKind == KINDRES_REQ )
          if(not PrintReqNotRepo2ProtocolText())
             PrintReqRepo2ProtocolText();
          end;
        end;
      end;
      sql_execute("TRUNCATE TABLE DSPRESERVREP_TMP");
   end;
  
  ClearRecord( LnDeal );
  HeadPrinted = false;
  return (i>0);
end;

/* Печать отчета о сервисной операции
   OprDocKind - вид первичного документа
   SvOpServDoc- документ сервисной операции
   ReportFlag - Признак, что нужно печатать отчет 
   ShowReport - показывать отчет*/
macro ScOpPrintReport( OprDocKind, SvOpServDoc, ReportFlag, ShowReport )
  record dl_comm(dl_comm);

  var ObjectName;

  ConnectBuff( dl_comm, SvOpServDoc ); 

  if( (isOprMultiExec() == false) )
     if( (ReportFlag == true) )    
        if( ((dl_comm.DocKind == DL_RESERVEDOC) and 
             (ScOpReportLineData.Size > 0) and // Golovkin 
             ( (dl_comm.OperationKind == KINDRES_DEAL) or
               (dl_comm.OperationKind == KINDRES_RCB) or
               (dl_comm.OperationKind == KINDRES_REQ)  
             ) 
            ) or 
            (dl_comm.DocKind == DL_GET_INCOME) or
            (dl_comm.DocKind == DL_OVERVALUE) or
            (dl_comm.DocKind == DL_OVERVALUE_RD) or
            (dl_comm.DocKind == DL_OVERVALUE_NVPI) or
            (dl_comm.DocKind == DL_CALCTSS) or 
            (dl_comm.DocKind == SP_AJUSTVALOEB) or 
            (dl_comm.DocKind == SP_ACCEXPREVOEB) or
            (dl_comm.DocKind == SP_TRANSFERPA) or
            (dl_comm.DocKind == SP_COMISSION_PA) or
            (dl_comm.DocKind == SP_AMORTHEDGCORR)
          )
               if(not ExecMacroFile("spordres.mac", "Print_MemOrder", SvOpServDoc, true))
                  MsgBox("Ошибка при печати протокола сервисной операции");
               end;
        end;
     end;
  end;

  if( (ReportFlag == true) and (ScOpNumInsRecord > 0) )    
     if( not (((dl_comm.DocKind == DL_RESERVEDOC) /*and 
               (dl_comm.OperationKind != KINDRES_DEAL)*/
              ) or 
              (dl_comm.DocKind == DL_GET_INCOME) or
              (dl_comm.DocKind == DL_OVERVALUE) or
              (dl_comm.DocKind == DL_OVERVALUE_RD) or
              (dl_comm.DocKind == DL_OVERVALUE_NVPI) or
              (dl_comm.DocKind == DL_CALCTSS) or 
              (dl_comm.DocKind == SP_AJUSTVALOEB) or 
              (dl_comm.DocKind == SP_ACCEXPREVOEB) or
              (dl_comm.DocKind == SP_TRANSFERPA) or
              (dl_comm.DocKind == SP_COMISSION_PA) or
              (dl_comm.DocKind == SP_AMORTHEDGCORR)
             ) 
       )
        SvOpPrintFoot( dl_comm );
     end;
  end;

  if( OprDocKind == DLDOC_ISSUE ) ObjectName = "Ц/б";
  elif( OprDocKind == DLDOC_PARTY ) ObjectName = "Субъект";
  elif( OprDocKind == DL_STOCKCONTR ) ObjectName = "Договор";
  elif( OprDocKind == DL_SECURITYDOC ) ObjectName = "Сделка";
  elif( OprDocKind == DL_TRUSTDOC ) ObjectName = "Сделка ДУ";
  elif( OprDocKind == DL_NTGSEC) ObjectName = "Неттинг";
  elif( OprDocKind == DL_RETIREMENT) ObjectName = "Погашение";
  elif( OprDocKind == DL_CONVAVR) ObjectName = "Конвертация ц/б";
  end;
   
  if( (dl_comm.DocKind != DL_RESERVEDOC) and 
      (dl_comm.OperationKind != KINDRES_DEAL) and
      (dl_comm.DocKind != DL_GET_INCOME) and
      (dl_comm.DocKind != DL_OVERVALUE) and
      (dl_comm.DocKind != DL_OVERVALUE_RD) and
      (dl_comm.DocKind != DL_OVERVALUE_NVPI) and
      (dl_comm.DocKind != DL_CALCTSS)
    )
     SvOpPrintError( ObjectName ); /* Ошибки будем печатать всегда */
  end;

  if(dl_comm.DocKind == DL_RESERVEDOC)
     SvOpPrintErrorRes( ObjectName ); /* Для резервов своя функция печати */
     ClearErrorArrRes();
  end;

  if( (ScOpNumInsRecord == 0) and (ReportFlag == true) and (SvOpErrorArray.Size == 0) )
    if( OprDocKind == DLDOC_ISSUE )
       SvOpPrintLine( "Нет подходящих для операции выпусков ценных бумаг." );
    elif( OprDocKind == DLDOC_PARTY )
       SvOpPrintLine( "Нет подходящих для операции субъектов." );
    elif( OprDocKind == DL_STOCKCONTR )
       SvOpPrintLine( "Нет подходящих для операции комиссий." );
    elif( OprDocKind == DL_SECURITYDOC )
       SvOpPrintLine( "Нет подходящих для операции сделок." );
    elif( OprDocKind == DL_TRUSTDOC )
       SvOpPrintLine( "Нет подходящих для операции сделок ДУ." );
    elif( OprDocKind == DL_NTGSEC )
       SvOpPrintLine( "Нет подходящих для операции сделок неттинга." );
    elif( OprDocKind == DL_RETIREMENT) 
       SvOpPrintLine( "Нет подходящих для операции погашений." );
    elif( OprDocKind == DL_CONVAVR) 
       SvOpPrintLine( "Нет подходящих операций конвертации ц/б." );
    end; 
    if( dl_comm.CommStatus==DL_COMM_CLOSED )
        SvOpPrintLine( "Сервисная операция закрыта." );
    end;

  end;

  ScOpIsServiceOper  = false;
  close( SvOpReportFile );
  if( (ShowReport == true) AND 
      (
        (SvOpErrorArray.Size > 0) or (ReportFlag == true) 
      )
    )
    ViewFile( SvOpReportFile );
  end;
end;

/* Установка подсказки для скролингов из макроса */
PRIVATE MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string
  //  Возможные значения ScrolStatus:
  //  DL_COMM_PREPARING = 0,  // на этапе подготовки
  //  DL_COMM_READIED,        // готовые (создана операция)
  //  DL_COMM_CLOSED,         // закрытые
  //  DL_COMM_ALL             // все


  //  Возможные значения ScrolKind:
  //  DL_COMMDOC     = 104,   // Операции расчета комиссий
  //  DL_RESERVEDOC  = 106,   // Операции резервирования средств под обесценивание ЦБ
  //  DL_OVERVALUE   = 108,   // Операции переоценки ценных бумаг
  //  DL_OVERVALUE_RD  = 123,  // Переоценка внебаланса
  //  DL_OVERVALUE_NVPI = 134,  // Переоценка НВПИ
  //  DL_GET_INCOME     = 157, // БОЦБ - начисление процентного/дисконтного дохода

  //пример
  //return "/*+FIRST_ROWS LEADING(t) INDEX(t ddl_comm_dbt_idx0)*/";

  return DefaultHint;

END;

/*установка значений в панели операции по умолчанию (преимущественно для checkbox)*/
MACRO SvOpSetInitParms(p_dl_com)
  VAR dl_comm_buf = TRecHandler( "dl_comm" );
  dl_comm_buf.SetRecordAddr( p_dl_com );

  /*пример*/
   if( dl_comm_buf.rec.DocKind == DL_GET_INCOME )
      dl_comm_buf.rec.Flag1        = SET_CHAR;/*процентный*/
      dl_comm_buf.rec.Flag4        = SET_CHAR;/*дисконтный*/
      dl_comm_buf.rec.Flag5        = UNSET_CHAR;/*только по выпускам ц/б, где были движения*/
//    dl_comm_buf.rec.Flag7        = UNSET_CHAR;/*Начисление корректировки по ЭПС*/
      dl_comm_buf.rec.Flag2        = UNSET_CHAR;/*доход, подлежащий выплате контрагентам по сделкам РЕПО/займа*/
      dl_comm_buf.rec.Flag3        = UNSET_CHAR;/*Начисление дохода (расхода) по сделкам РЕПО/займа*/
      dl_comm_buf.rec.CreateReport = SET_CHAR;/*Формировать отчет*/
   elif( dl_comm_buf.rec.DocKind == DL_OVERVALUE )
      /*выставим все галочки*/
      dl_comm_buf.rec.Flag2        = UNSET_CHAR;/*выпуски, с которыми были заключены сделки*/
      dl_comm_buf.rec.Flag3        = UNSET_CHAR;/*выпуски, по которым была поставка ц/б*/
      dl_comm_buf.rec.Flag4        = UNSET_CHAR;/*выпуски, по которым была оплата ц/б*/
      dl_comm_buf.rec.Flag6        = UNSET_CHAR;/*переоценка только Т/О, исполняемых на следующий день*/
  
  //    if( (dl_comm_buf.rec.Flag2 == SET_CHAR) or (dl_comm_buf.rec.Flag3 == SET_CHAR) or (dl_comm_buf.rec.Flag4 == SET_CHAR) )
         dl_comm_buf.rec.Flag1 = SET_CHAR;/*Вложения в ценные бумаги*/
  //    end;
  //    if( (dl_comm_buf.rec.Flag6 == SET_CHAR) )
         dl_comm_buf.rec.Flag5 = SET_CHAR;/*Требования/обязательства по возврату ц/б*/
  //    end;
  
      dl_comm_buf.rec.CreateReport = SET_CHAR;/*Формировать отчет*/
   elif( dl_comm_buf.rec.DocKind == 106 ) // Резервирование
      dl_comm_buf.rec.Flag1        = SET_CHAR;
      dl_comm_buf.rec.Flag2        = SET_CHAR;
      dl_comm_buf.rec.Flag3        = UNSET_CHAR;
      dl_comm_buf.rec.Flag4        = SET_CHAR;
   /*21.07.2020 RAS 513250*/
   elif( dl_comm_buf.rec.DocKind == DL_OVERVALUE_RD )//переоценка внебаланса
      dl_comm_buf.rec.FlagSecur    = SET_CHAR;
   /*~RAS*/
   end;

END;

private macro FindFirstDLRQbyDocKind(DocKind, DocID, DealPart, Type, buf )

   var query, ds, str_select = "";

   str_select = 
              " SELECT * "
            + "  FROM "
            + "        ddlrq_dbt rq "
            + "  WHERE     rq.t_DocKind = " + DocKind
            + "        AND rq.t_DocID = " + DocID
            + "        AND rq.t_DealPart = " + DealPart
            + "        AND rq.t_Type = " + Type
            + "        AND rownum < 2 ";

   query = RSDCommand( str_select );
   query.execute();

   ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
   if( ds.MoveNext() )
      ds.GetRecord().CopyTo( buf );
   else
      return false;
   end;
   
   return true;
end;

private CONST SCSERVOP_CNV_EXEC_BYDEAL = 1;
private CONST SCSERVOP_CNV_EXEC_BYAVR = 2;

class SpServConvData()
  var dlcomid;
  var oprdockind;
  var incometype;
  var execType;
end;

private macro UpdateDlCom(dl_comm, hasErrors)
  var stat = 0;
  var commFile = TBFile("dl_comm.dbt","W");
  commFile.rec.DocumentId = dl_comm.rec.DocumentId;
  if (commFile.GetEQ())
    var newStatus = DL_COMM_READIED;
    if (not hasErrors)
      newStatus = DL_COMM_CLOSED;
    end;

    commFile.rec.CommStatus = newStatus;
    if (not commFile.Update())
      stat = 1;
    end;
  else
    stat = 1;
  end;
  return stat;
end;

macro RunConveyerOvervalRD(dl_comm, OprDocKind)
  var stat = 0;
  
  var OperID = 27; //Операция для конвейера - Пакетная операция переоценки внебаланса ЦБ
  var ConvID = 32; //Вид конвейера Переоценка внебаланса ЦБ

  var rslObj = SpServConvData();

  var docKind = 0;

  if( dl_comm.rec.DocKind == DL_OVERVALUE_RD ) // переоценка Т/О
    if ((dl_comm.rec.Flag1 == SET_CHAR) or (dl_comm.rec.Flag2 == SET_CHAR))
      if(dl_comm.rec.FlagSecur == SET_CHAR)
        rslObj.oprdockind = DL_SECURITYDOC;
      end;

      if(dl_comm.rec.FlagSecurOwn == SET_CHAR)
        rslObj.oprdockind = DL_SECUROWN;
      end;
    end;
  end;

  rslObj.dlcomid = dl_comm.rec.DocumentId;
  
  execStoredFunc( "RSI_DLLOG.InsertDL_LOG", V_UNDEF, makeArray(SQLParam("docId", dl_comm.rec.DocumentID), SQLParam("docKind", dl_comm.rec.DocKind), SQLParam("opr", {oper})) );
  
  var cnv = RsbConveyerExec(ConvID);
  cnv.AddParamsForConveyer(ConvID, rslObj, 0);
  cnv.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
  cnv.showPanelMonitoring(1);
  cnv.Run();

  var hasConvErrors = ShowErrorFromCnvpack(cnv, true);

  stat = UpdateDlCom(dl_comm, hasConvErrors);

  return stat;
end;

macro ОтобратьОбъектыПерецВнебалЦБ(_taskID, _execID, _conveyerID, _packetSize, _Params)
  var dl_comm = TBFile("dl_comm.dbt");

  dl_comm.rec.documentid = _Params.dlcomid;
  if(not dl_comm.GetEQ())
    RunError("Не найдена операция с ID = " + _Params.dlcomid);
  end;

  var query = SpServGetQuery(dl_comm, _Params.oprdockind);
  var params = SpServGetParameters(dl_comm, _Params.oprdockind);

  query = 
    " INSERT INTO DCNVDOC_DBT(T_TASKID,T_EXECID,T_CONVTYPEID,T_PACKID,T_OBJECTTYPE,T_OBJECTID) "
  + " SELECT "+_taskID+","+_execID+","+_conveyerID+",decode("+_packetSize+", 0, 1, (TRUNC((RowNum + "+_packetSize+" - 1)/"+_packetSize+"))), 0, RECORDS.DealID "
  + "   FROM (" + query + ") RECORDS";

  var cmd = DL_RSDCommand(query);

  for (var curPrm, params)
    cmd.AddParam(curPrm);
  end;
  cmd.ExecuteCMD();

  var cnt = 0;
  
  query =   " select NVL(max(t_PackID), 0) as cnt "
          + "   from dcnvdoc_dbt "
          + "  where t_ExecID = " + _execID;
  
  var DataSet = TRsbDataSet(query);
  if(DataSet.moveNext())
    cnt = int(round(int(DataSet.cnt), 0));
  end;

  return cnt;

end;

private macro UpdateCNVPack(_execID, _conveyerID, _packetID, IsErr, ErrMsg)
  var exec = RSDCommand(  " UPDATE dcnvpack_dbt "
                        + " SET t_State = t_State + 1, t_Error = ?, T_ERRMSG = ? "
                        + " WHERE t_ExecID = ? "
                        + "   AND t_ConvTypeID = ? "
                        + "   AND t_PackID = ? ");

  exec.addParam( "", RSDBP_IN, IIF(IsErr, 1, 0) );
  exec.addParam( "", RSDBP_IN, ErrMsg );
  exec.addParam( "", RSDBP_IN, _execID );
  exec.addParam( "", RSDBP_IN, _conveyerID );
  exec.addParam( "", RSDBP_IN, _packetID );
  exec.execute();
end;


macro ExecuteOvervalRDCnv(_taskID, _execID, _conveyerID, _operationID, _packetID, _Params)
  var dl_comm = TBFile("dl_comm.dbt");
  dl_comm.rec.documentid = _Params.dlcomid;
  if(not dl_comm.GetEQ())
    RunError("Не найдена операция с ID = " + _Params.dlcomid);
  end;

  var dealsArray = TArray();

  var query = "select T_OBJECTID from DCNVDOC_DBT where t_taskId = :convtype and T_EXECID = :execid and T_PACKID = :packid";

  var cmd = DL_RSDCommand(query);
  cmd.AddParam(_taskID);
  cmd.AddParam(_execID);
  cmd.AddParam(_packetID);

  var ds = cmd.Execute();

  while (ds.MoveNext())
    dealsArray[dealsArray.size] = ds.ObjectId;
  end;

  var stat = SC_SvOpExecuteForDealByDocList(dl_comm, _Params.oprdockind, dealsArray);

  if (stat)
    RunError("Ошибка выполнения пачки "+ _packetID + " операции " + _execID + " ошибка "+ stat );
  end;
  UpdateCNVPack(_execID, _conveyerID, _packetID, false, "");
OnError(er)
  UpdateCNVPack(_execID, _conveyerID, _packetID, true, GetFullErrorMessage(er, 2000));
end;


macro RunConveyerGetIncome(dl_comm, OprDocKind)
  var stat = 0;
  
  var OperID = 28;
  var ConvID = 33;

  var avrCnvHasError = false;

  var rslObj = SpServConvData();

  execStoredFunc( "RSI_DLLOG.InsertDL_LOG", V_UNDEF, makeArray(SQLParam("docId", dl_comm.rec.DocumentID), SQLParam("docKind", dl_comm.rec.DocKind), SQLParam("opr", {oper})) );

  if ((dl_comm.rec.Flag1 == SET_CHAR) or (dl_comm.rec.Flag4 == SET_CHAR) or (dl_comm.rec.Flag6 == SET_CHAR) or (dl_comm.rec.Flag7 == SET_CHAR))

    rslObj.oprdockind = DLDOC_ISSUE;
    rslObj.dlcomid = dl_comm.rec.DocumentId;
    rslObj.incometype = INCOME_OWN_PAPERS;
    rslObj.execType = SCSERVOP_CNV_EXEC_BYAVR;

    var cnvAvr = RsbConveyerExec(ConvID);
    cnvAvr.AddParamsForConveyer(ConvID, rslObj, 0);
    cnvAvr.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
    cnvAvr.showPanelMonitoring(1);
    cnvAvr.Run();

    avrCnvHasError = ShowErrorFromCnvpack(cnvAvr, true);
  end;

  var flag2DealCnvHasError = false;

  if (dl_comm.rec.Flag2 == SET_CHAR)
    rslObj.oprdockind = DL_SECURITYDOC;
    rslObj.dlcomid = dl_comm.rec.DocumentId;
    rslObj.incometype = INCOME_BACK_KA;
    rslObj.execType = SCSERVOP_CNV_EXEC_BYDEAL;

    var flag2DealCnv = RsbConveyerExec(ConvID);
    flag2DealCnv.AddParamsForConveyer(ConvID, rslObj, 0);
    flag2DealCnv.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
    flag2DealCnv.showPanelMonitoring(1);
    flag2DealCnv.Run();

    flag2DealCnvHasError = ShowErrorFromCnvpack(flag2DealCnv, true);
  end;

  var flag3DealCnvHasError = false;

  if (dl_comm.rec.Flag3 == SET_CHAR)
    rslObj.oprdockind = DL_SECURITYDOC;
    rslObj.dlcomid = dl_comm.rec.DocumentId;
    rslObj.incometype = INCOME_REPO;
    rslObj.execType = SCSERVOP_CNV_EXEC_BYDEAL;

    var flag3DealCnv = RsbConveyerExec(ConvID);
    flag3DealCnv.AddParamsForConveyer(ConvID, rslObj, 0);
    flag3DealCnv.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
    flag3DealCnv.showPanelMonitoring(1);
    flag3DealCnv.Run();

    flag3DealCnvHasError = ShowErrorFromCnvpack(flag3DealCnv, true);
  end;

  stat = UpdateDlCom(dl_comm, (avrCnvHasError or flag2DealCnvHasError or flag3DealCnvHasError));

  return stat;
end;

macro ОтобратьОбъектыНачДохРасхЦБ(_taskID, _execID, _conveyerID, _packetSize, _Params)
  var dl_comm = TBFile("dl_comm.dbt");

  dl_comm.rec.documentid = _Params.dlcomid;
  if(not dl_comm.GetEQ())
    RunError("Не найдена операция с ID = " + _Params.dlcomid);
  end;

  var query = NULL;
  var params = NULL;
  var field = "";

  if (_Params.execType == SCSERVOP_CNV_EXEC_BYDEAL)
    query = SpServGetQuery(dl_comm, _Params.oprdockind, _Params.incometype);
    params = SpServGetParameters(dl_comm, _Params.oprdockind);
    field = "RECORDS.DealID";
  elif (_Params.execType == SCSERVOP_CNV_EXEC_BYAVR)
    query = SpServGetQueryAvr(dl_comm, _Params.oprdockind, _Params.incometype);
    params = SpServGetParametersAvr(dl_comm, _Params.oprdockind);
    field = "RECORDS.FIID";
  end;

  query = 
    " INSERT INTO DCNVDOC_DBT(T_TASKID,T_EXECID,T_CONVTYPEID,T_PACKID,T_OBJECTTYPE,T_OBJECTID) "
  + " SELECT "+_taskID+","+_execID+","+_conveyerID+",decode("+_packetSize+", 0, 1, (TRUNC((RowNum + "+_packetSize+" - 1)/"+_packetSize+"))), 0, " + field
  + "   FROM (" + query + ") RECORDS";

  var cmd = DL_RSDCommand(query);

  for (var curPrm, params)
    cmd.AddParam(curPrm);
  end;
  cmd.ExecuteCMD();

  var cnt = 0;
  
  query =   " select NVL(max(t_PackID), 0) as cnt "
          + "   from dcnvdoc_dbt "
          + "  where t_ExecID = " + _execID;
  
  var DataSet = TRsbDataSet(query);
  if(DataSet.moveNext())
    cnt = int(round(int(DataSet.cnt), 0));
  end;

  return cnt;

end;

macro ExecuteGetIncomeCnv(_taskID, _execID, _conveyerID, _operationID, _packetID, _Params)
  var dl_comm = TBFile("dl_comm.dbt");
  dl_comm.rec.documentid = _Params.dlcomid;
  if(not dl_comm.GetEQ())
    RunError("Не найдена операция с ID = " + _Params.dlcomid);
  end;

  var objarray = TArray();

  var query = "select T_OBJECTID from DCNVDOC_DBT where t_taskId = :convtype and T_EXECID = :execid and T_PACKID = :packid";

  var cmd = DL_RSDCommand(query);
  cmd.AddParam(_taskID);
  cmd.AddParam(_execID);
  cmd.AddParam(_packetID);

  var ds = cmd.Execute();

  while (ds.MoveNext())
    objarray[objarray.size] = ds.ObjectId;
  end;

  var stat = 0;
  
  if (_Params.execType == SCSERVOP_CNV_EXEC_BYDEAL)
    stat = SC_SvOpExecuteForDealByDocList(dl_comm, _Params.oprdockind, objarray, _Params.incometype);
  elif (_Params.execType == SCSERVOP_CNV_EXEC_BYAVR)
    stat = SC_SvOpExecuteForAvrByDocList(dl_comm, _Params.oprdockind, objarray, _Params.incometype);
  end;

  if (stat)
    RunError("Ошибка выполнения пачки "+ _packetID + " операции " + _execID + " ошибка "+ stat );
  end;
  UpdateCNVPack(_execID, _conveyerID, _packetID, false, "");
OnError(er)
  UpdateCNVPack(_execID, _conveyerID, _packetID, true, GetFullErrorMessage(er, 2000));
end;