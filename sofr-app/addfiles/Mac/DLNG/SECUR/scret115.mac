/*
$Name:        scret115.mac
$Module:      Ценные бумаги
$Description: Погашение. Шаг: Поступление средств от платежного агента
*/
import   InsCarryDoc, "sp_car.mac", "sp_cars.mac", "spserv.mac", "sp_catac.mac", "sp_voop.mac";

macro ExecuteStep( Doc, FDoc )
   record deal(dl_tick);
   var    FD, dat, MarketAcc = "", Amount = $0;
   var PayerAccountBuff = TRecHandler( "account" );
   var ReceiverAccountBuff = TRecHandler( "account" );
   var AccountBuff = TRecHandler("account");
   var dlrq;

   SetBuff( deal, FDoc );
   FD = SPFirstDoc ( deal, false );
  
   if( ( IsBROKER(FD.Group) ) OR (FD.tick.rec.Flag1 == SET_CHAR) )
      MsgBox("Погашение должно быть не на ОРЦБ и не через брокера");
      return 1;
   end;

   if(FD.tick.rec.CarryWrt == UNSET_CHAR)
     MsgBox("В погашении должен быть установлен признак \"Проводка зачисления средств\"");
     return 1;
   end;

   if( FD.ExistRQMoney(DLRQ_TYPE_PAYMENT) )
      if( ТОСквитовано(FD.GetRQ(DLRQ_TYPE_PAYMENT)) )
         MsgBox("ТО по оплате сквитовано. Вставка шага невозможна");
         return 1;
      end;
   end;

   dat = FD.dl_leg.rec.Maturity;

   if ( not GetDate( dat,"Введите дату получения средств") ) 
      return 1;
   end;

   if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYMENT, DLGR_ACCKIND_BACKOFFICE, dat, DLGRACC_STATE_FACTEXEC) != 0 )
     return 1;
   end;

   dlrq = FD.GetRQ(DLRQ_TYPE_PAYMENT);
   if( УстановитьСтатусТО(dlrq, DLRQ_STATE_EXEC, dat) != 0 )
      return 1;
   end;

   if( not OprReplanStepPlanDates( FD.GetKindDate(DATE_DEALEEND), dat ) )
      msgbox("Ошибка при попытке переинициализировать дату завершения сделки." );         
      return 1;
   end;

   return 0;
end;
