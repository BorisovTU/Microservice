/*
 $Name: spfinres_form.mac
 $Module: Ценные бумаги
 $Description: "Финансовый результат по операциям с ц/б"- форма ввода данных
*/

import "DlRepForm_h.mac";

CONST
      PNFLD_FINRES_Dprt       = 0, 
      PNFLD_FINRES_DprtName   = 1,
 
      PNFLD_FINRES_OurDeal    = 2, 
      PNFLD_FINRES_ByPortf    = 3, 

      PNFLD_FINRES_IsClient   = 4,
      PNFLD_FINRES_ClientCode = 5, 
      PNFLD_FINRES_ClientName = 6, 
      PNFLD_FINRES_ContrName  = 7, 

      PNFLD_FINRES_AvrKind    = 8, 
      PNFLD_FINRES_FICode     = 9, 
      PNFLD_FINRES_FIName     = 10,

      PNFLD_FINRES_DateBegin  = 11, 
      PNFLD_FINRES_DateEnd    = 12,
 
      PNFLD_FINRES_Apostr     = 13,
      PNFLD_FINRES_IsExcel    = 14;

CLASS SPFinResFormData()
   var                     
     Department = -1,      
     OurDeal = "X",        
     ByPortf = "X",        
     IsClient = "",                                          
     ClientCode = -1,      
     ContrName = -1,      
     AvrKind = -1,         
     FICode = -1,          
     DateBegin = {curdate},
     DateEnd = {curdate},  
     Apostr = "X",         
     IsExcel = "X";        
END;     
      
VAR RepFormData = SPFinResFormData();     

PRIVATE CONST
  H_OurDeal  = 101, 
  H_ByPortf  = 102,
  H_IsClient = 103;        

PRIVATE MACRO DLUSR_FldProc_Department( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
file   Department( dp_dep );

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, STR_ALLVALUE);
     else
        ClearRecord( Department );
        Department.Code = FldRealValue;
        GetGE(Department);
        FldShowValue = FldRealValue;
        pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, DL_GetDepartmentNameByCode(FldRealValue));
     end;
  end;
  
  if( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     return pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, STR_ALLVALUE );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) 
     if( ListDepartment( Department ) )
        FldRealValue = Department.Code;
        FldShowValue = FldRealValue;
        pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, DL_GetDepartmentNameByCode(FldRealValue)); 
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_OurDeal( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
 /* if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
        pThis.SetLinkedValue( H_ByPortf, "" );
        DisableFields( pThis.Data(), PNFLD_FINRES_ByPortf );
     end;

     if( FldRealValue == "X" )
        EnableFields( pThis.Data(), PNFLD_FINRES_ByPortf );
     end;

     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     if( FldRealValue != "X" )                                    
        FldShowValue = FldRealValue = "X";                        
        EnableFields( pThis.Data(), PNFLD_FINRES_ByPortf );   
     else                                                         
        FldShowValue = FldRealValue = "";                         
        pThis.SetLinkedValue( H_ByPortf, "" );
        DisableFields( pThis.Data(), PNFLD_FINRES_ByPortf );   
     end;                                                         
  end;*/
  FldRealValue = "X";
  EnableFields( pThis.Data(), PNFLD_FINRES_ByPortf );
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_IsClient( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;

     if( FldRealValue == "X" )
        EnableFields( pThis.Data(), PNFLD_FINRES_ClientCode );

        EnableFields( pThis.Data(), PNFLD_FINRES_ContrName );
     else
        pThis.SetLinkedValue( DL_PNFLD_CLIENT_NUM_OFBU, -1 );
        DisableFields( pThis.Data(), PNFLD_FINRES_ClientCode );

        pThis.SetLinkedValue( DL_PNFLD_CONTRACT_OFBU, -1 );
        DisableFields( pThis.Data(), PNFLD_FINRES_ContrName );
     end;

     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     if( FldRealValue != "X" )                                    
        FldShowValue = FldRealValue = "X";                        
        EnableFields( pThis.Data(), PNFLD_FINRES_ClientCode );   

        EnableFields( pThis.Data(), PNFLD_FINRES_ContrName );
     else                                                         
        FldShowValue = FldRealValue = "";                         
        pThis.SetLinkedValue( DL_PNFLD_CLIENT_NUM_OFBU, -1 );
        DisableFields( pThis.Data(), PNFLD_FINRES_ClientCode );   

        pThis.SetLinkedValue( DL_PNFLD_CONTRACT_OFBU, -1 );
        DisableFields( pThis.Data(), PNFLD_FINRES_ContrName );
     end;                                                         
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_Contract( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  file sfcontr(sfcontr);
  var ClientID =  -1;
  var Dep = -1;
  var ServKind = TArray();

  ClientID = pThis.GetFieldValue( PNFLD_FINRES_ClientCode );
  Dep = pThis.GetFieldValue( PNFLD_FINRES_Dprt );

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )                           
        FldShowValue = STR_ALLVALUE;
     end;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) 
     ServKind[ServKind.Size] = PTSK_STOCKDL;
     DL_ListSfContrByServKind( @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), ClientID, ServKind, null, Dep ); 

     ClearRecord(sfcontr);
     sfcontr.ID = FldRealValue;

     if( GetEQ(sfcontr) )
        pThis.SetLinkedValue( DL_PNFLD_CLIENT_NUM_OFBU, sfcontr.PartyID );
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) SP_FinResRep_Panel()

  PRIVATE MACRO Init()
     DisableFields (This.Data(), PNFLD_FINRES_IsClient);
     DisableFields (This.Data(), PNFLD_FINRES_ClientCode);
     DisableFields (This.Data(), PNFLD_FINRES_ClientName);
     DisableFields (This.Data(), PNFLD_FINRES_ContrName);     

     AddFieldProc( 0, PNFLD_FINRES_Dprt,       DL_PNFLD_DEPARTCODE,       @DLUSR_FldProc_Department,  RepFormData.Department);         
     AddFieldProc( 0, PNFLD_FINRES_DprtName,   DL_PNFLD_DEPARTMENT,       @Default,                "");

     AddFieldProc( 0, PNFLD_FINRES_OurDeal,    H_OurDeal,                 @DLUSR_FldProc_OurDeal,  RepFormData.OurDeal );
     AddFieldProc( 0, PNFLD_FINRES_ByPortf,    H_ByPortf,                 @DL_FldProc_CheckBox,    RepFormData.ByPortf );
     AddFieldProc( 0, PNFLD_FINRES_IsClient,   H_IsClient,                null,                    "" );
     AddFieldProc( 0, PNFLD_FINRES_ClientCode, DL_PNFLD_CLIENT_NUM_OFBU,  null,                    "" );         
     AddFieldProc( 0, PNFLD_FINRES_ClientName, DL_PNFLD_CLIENT_NAME_OFBU, @Default,                "" );
     AddFieldProc( 0, PNFLD_FINRES_ContrName,  DL_PNFLD_CONTRACT_OFBU,    null,                    "" );         

     AddFieldProc( 0, PNFLD_FINRES_AvrKind,    DL_PNFLD_AVRKIND,          @DL_FldProc_AvrKind,     RepFormData.AvrKind );
     AddFieldProc( 0, PNFLD_FINRES_FICode,     DL_PNFLD_FI,               @DL_FldProc_FI,          RepFormData.FICode);         
     AddFieldProc( 0, PNFLD_FINRES_FIName,     DL_PNFLD_FI_NAME,          @DL_FldProc_FI_Name,     "");         

     AddFieldProc( 0, PNFLD_FINRES_DateBegin,  DL_PNFLD_BEGINDATE,        @DL_FldProc_BeginDate,   RepFormData.DateBegin);         
     AddFieldProc( 0, PNFLD_FINRES_DateEnd,    DL_PNFLD_ENDDATE,          @DL_FldProc_EndDate,     RepFormData.DateEnd);         
     AddFieldProc( 0, PNFLD_FINRES_Apostr,     DL_PNFLD_CHECKBOX,         @DL_FldProc_CheckBox,    RepFormData.Apostr);         
     AddFieldProc( 0, PNFLD_FINRES_IsExcel,    DL_PNFLD_CHECKBOX,         @DL_FldProc_CheckBox,    RepFormData.IsExcel);         
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;
  
  initDL_CPanel( "sp_res.lbr", "FINRES" ); 
END;
