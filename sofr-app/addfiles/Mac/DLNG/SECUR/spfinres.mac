/*
$Name:        spfinres.mac
$Module:      Ценные бумаги
$Description: Отчет "Финансовый результат по операциям с ц/б"
*/
import "spRepFn2.mac", "sp_class.mac", "globals.mac", "spfinres_form.mac","sp_cars.mac", "dlmisc.mac";
import RsbDataSet;

private var Data;
private var DprtID_t;

PRIVATE var УчитыватьНесущЗатраты = false;

/* Структура с данными для отчета*/
class SourceData( _DprtID:integer, _IsOwnDeal:bool, _IsDelOnPortf:bool, _IsClientDeal:bool, 
                  _ClientID: integer, _ClientContrID: integer, _AvrKind: integer, _FICode: integer,
                  _dateMin: date,  _dateMax: date )

  var DprtID        =  _DprtID,
      IsOwnDeal     =  _IsOwnDeal,
      IsDelOnPortf =  _IsDelOnPortf,
      IsClientDeal  =  _IsClientDeal,
      ClientID      =  _ClientID,
      ClientContrID =  _ClientContrID,
      AvrKind       =  _AvrKind,
      FICode        =  _FICode,
      dateMin       =  _dateMin,      
      dateMax       =  _dateMax,      

      PrintHeadDprt = false,   
      PrintHeadClnt = false,   
      ReportRun     = false;

   var UniqStr = TUniqStrCollector;

end;

private var
   IsApp = false;

macro PrintSum( Sum )
   if( Sum )
      if( IsApp )
         return string( Sum:a );
      else
         return string( Sum );
      end;
   else
      return "";
   end;
end;

/* 
SumVal - Если ВН = не рубли - 
   Сумма затрат по операции продажи (погашения), включая предв.затраты, без НДС для банка и с НДС для клиента
SumRUR - Если ВН = рубли - 
   Сумма затрат по операции продажи (погашения), включая предв.затраты, 
   без НДС для банка и с НДС для клиента, в рублях по курсу на дату поставки сделки продажи
*/
private macro ПолучитьСуммуКомиссийПоСделке(DataSet, FIFace, DateSale, SumVal_, SumRUR_)
   var SummAgent = $0, NDSAgent = $0, SummBank = $0, NDSBank = $0, SumVal = $0, SumRUR = $0;
   var Outlay = $0;
   var Sum = $0, NDS = $0, SumWithoutNDS = $0;

   SmartConvertSum( Outlay, money(DataSet.PreOutlay), DateSale, DataSet.PreOutlayFIID, NATCUR, true );
   SumRUR = SumRUR + Outlay;

   if( FIFace != NATCUR )
      SmartConvertSum( Outlay, money(DataSet.PreOutlay), DateSale, DataSet.PreOutlayFIID, FIFace, true );
      SumVal = SumVal + Outlay;
   end;

   var FD = SPFirstDoc( DataSet.BOfficeKind, DataSet.DealID );

   Sum = NDS = SumWithoutNDS = $0;
   if( not SP_GetSumCom( Sum, NDS, SumWithoutNDS, null, 
                         FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, null, null, 1, 1,   
                         1, 1, 1, IIF(УчитыватьНесущЗатраты,0,1), DateSale, NATCUR, true,
                         IIF(not IsREPO(FD.Group), true, false),
                         IIF(IsREPO(FD.Group), true, false) )
     )
      return false;
   end;

   if (DataSet.ClientID == -1)
      SumRUR = SumRUR + SumWithoutNDS;
   else
      SumRUR = SumRUR + Sum;
   end;

   if( FIFace != NATCUR )
      Sum = NDS = SumWithoutNDS = $0;
      if( not SP_GetSumCom( Sum, NDS, SumWithoutNDS, null, 
                            FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, null, null, 1, 1,   
                            1, 1, 1, IIF(УчитыватьНесущЗатраты,0,1), DateSale, FIFace, true,
                            IIF(not IsREPO(FD.Group), true, false),
                            IIF(IsREPO(FD.Group), true, false) )
        )
         return false;
      end;

      if (DataSet.ClientID == -1)
         SumVal = SumVal + SumWithoutNDS;
      else
         SumVal = SumVal + Sum;
      end;

   end;

   ПолучитьСуммуРаспределенныхКомиссийПоСделке(
         DataSet, SummAgent, NDSAgent, SummBank, NDSBank,
         null, null, NATCUR, DateSale, 1 );

   Sum = SummAgent + SummBank;

   if (DataSet.ClientID != -1)
      Sum = Sum + NDSAgent + NDSBank;
end;

   SumRUR = SumRUR + Sum;

   if( FIFace != NATCUR )

      SummAgent = NDSAgent = SummBank = NDSBank = $0;

   ПолучитьСуммуРаспределенныхКомиссийПоСделке(
         DataSet, SummAgent, NDSAgent, SummBank, NDSBank,
         null, null, FIFace, DateSale, 1 );

      Sum = SummAgent + SummBank;
    
      if (DataSet.ClientID != -1)
         Sum = Sum + NDSAgent + NDSBank;
   end;

      SumVal = SumVal + Sum;

   end;

   SetParm(3, SumVal);
   SetParm(4, SumRUR);
end;

/*только для собственных сделок*/
// IsIncReg - учитывать рег. сбор.
private macro ПолучитьСуммуНесуществЗатрат(FD, FIFace:integer, OnDate:Date, IsIncReg:bool, CommShort_val:@money, CommShort_rur:@money)
   VAR sum_agent = $0, nds_agent = $0;                                                              

   CommShort_val = CommShort_rur = $0;

   if( not УчитыватьНесущЗатраты )
      return true;
   end;

   if( IsClientDeal(FD.tick.rec) OR (IsREPO(FD.Group) and IsSale(FD.Group)) OR (FD.tick.rec.BofficeKind == DL_AVRWRT) OR (FD.tick.rec.BofficeKind == DL_TRUSTAVRWRT) )
      return true;
   end;

   /*Оплаченные комиссии и неоплаченные (для неоплаченных передаем дату конвертации OnDate) без НДС
     переводим в рубли*/
   if( not SP_GetSumCom( null, null, CommShort_rur, null, 
                         FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, null, null, 0, 1,   
                         1, 1, 0, 1, OnDate, NATCUR, true,
                         IIF(IsIncReg, true, false) )
     )
      return false;
   end;

   if( FIFace != NATCUR )   
      /*Оплаченные комиссии и неоплаченные (для неоплаченных передаем дату конвертации OnDate) без НДС
        переводим в валюту номинала*/
      if( not SP_GetSumCom( null, null, CommShort_val, null,
                            FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, null, null, 0, 1,   
                            1, 1, 0, 1, OnDate, FIFace, true,
                            IIF(IsIncReg, true, false) )
        )
      return false;
   end;
      end;

   return true; 
end;

private macro ПолучитьСуммуНесуществЗатратПоПокупке(SumID:integer, FIFace:integer, RepDate:Date, CommShort_val:@money, CommShort_rur:@money)
   var SQLQuery, RSD, FD_Buy, Sum_val = $0, Sum_rur = $0;

   CommShort_val = CommShort_rur = $0;

   if( not УчитыватьНесущЗатраты )
      return true;
   end;

   SQLQuery = RSDCommand("select buylot.t_DealID, nvl(sum(lnk.t_Amount),0) Amount "
                         "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot " +
                         " where buylot.t_SumID  = lnk.t_BuyID " +
                         "   and buylot.t_dockind = ? " +/*берем обычные покупки - лоты ГО не берем и считаем, что комиссии по покупкам, проданным после ГО, == 0*/
                         "   and lnk.t_SaleID = ? " +
                         "   and (buylot.t_Kind = 20 or buylot.t_Kind = 180) "+/*берем только обычные покупки (исключая лоты, вернувшиеся из ПРЕПО)*/
                         "   and NVL(( select count(1) " +/*проверим, что не было изменения номинала по уже поставленному лоту покупки (комиссии по таким не ищем)*/
                         "               from dpmwrtbc_dbt b, doproper_dbt opr " +
                         "              where buylot.t_SumID = b.T_SumID " +
                         "                and b.T_State = " +PM_WRTSUM_FORM+
                         "                and opr.T_ID_OPERATION = b.T_ID_OPERATION " +
                         "                and b.T_INSTANCE < lnk.T_BUYINSTANCE " +
                         "                and opr.T_DocKind = "+DL_CHGAVRNOM+
                         "           ),0) = 0 " +
                        /*надо проверить, что по сделке не было ГО с несколькими новыми выпусками в рееестре новых выпусков, 
                          когда по сделке еще не было поставки (комиссии по таким не ищем)*/
                         "   and NVL(( select count(1) " +
                         "               from dpmwrtbc_dbt b, doproper_dbt opr " +
                         "              where buylot.t_SumID = b.T_SumID " +
                         "                and b.T_State = " +PM_WRTSUM_NOTFORM+/*непоставлен*/
                         "                and opr.T_ID_OPERATION = b.T_ID_OPERATION " +
                         "                and opr.T_DocKind = "+DL_ISSUE_UNION+
                         "                and b.T_ACTION = 422 "+
                         "                and b.T_INSTANCE < lnk.T_BUYINSTANCE " +
                         "                and NVL((select count(1) "+          
                         "                           from dscdlfi_dbt scdlfi "+  
                         "                          where SCDLFI.T_DEALID = ltrim(opr.T_DocumentID) "+
                         "                            and SCDLFI.T_DEALKIND = opr.T_DocKind "+
                         "                        ),0) > 1 "+
                         "           ),0) = 0 " +
                         " group by buylot.t_DealID ");

   SQLQuery.addParam( "", RSDBP_IN, DLDOC_PAYMENT );
   SQLQuery.addParam( "", RSDBP_IN, SumID );

   SQLQuery.execute();

   RSD = TRsbDataSet(SQLQuery);

   while(RSD.MoveNext())
       Sum_val = Sum_rur = $0;

       /*получим ПД покупки и посмотрим, сколько ц\б было изначально поставлено по этой сделке покупки, чтобы определить от этого кол-ва долю проданных*/
       FD_Buy = SPFirstDoc( LEG_KIND_DL_TICK, RSD.DealID );
       
       ПолучитьСуммуНесуществЗатрат(FD_Buy, FIFace, RepDate, true, @Sum_val, @Sum_rur);

       Sum_val = round(Sum_val*RSD.Amount/FD_Buy.dl_leg.rec.Principal,2);      
       Sum_rur = round(Sum_rur*RSD.Amount/FD_Buy.dl_leg.rec.Principal,2);      

       CommShort_val = CommShort_val + Sum_val;
       CommShort_rur = CommShort_rur + Sum_rur;
   end;

   return true; 
end;

macro ПолучитьИмяКлиента(PartyID)
  file  rParty( "party" ) ; 
  var Name;
  if( not ПолучитьСубъекта( PartyID, rParty ) )
      Name = rParty.ShortName;
      return Name;
  else RunError ("Не найден субъект с кодом", + string(PartyID));
  end;
end;

PRIVATE VAR Cap =
"Финансовый результат по операциям с ценными бумагами за период с ########## по ##########\n\n";

PRIVATE VAR Branch =
"Филиал #\n";

PRIVATE VAR ReportRunFalse =
"#";

PRIVATE VAR TableHeader_1 =
"┌────────────────┬────────────┬─────────┬──────────────────────┬──────┬───────────────┬─────────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────┬─────────────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬─────────────────────────┬─────────────────────────────────────┐\n"+
"│      Номер     │    Дата    │   Вид   │   Наименование ц/б   │  ВН  │     Кол-во    │             Цена реализации             │            Сумма реализации         │         Балансовая стоимость        │        НКД полученный       │        НКД уплаченный       │ Ранее начисленный ПД │   Доначисленный ПД   │ Всего: Начисленный ПД │ Доначисленная премия │    Остаток премии    │ Ранее начисленный ДД │   Доначисленный ДД   │ Всего: Начисленный ДД │  Ранее начисленная   │   Доначисленная      │ Всего: корректировка  │ Списанная переоценка │  Затраты на реализацию  │         Финансовый результат        │\n"+
"│    операции    │поставки ц/б│ операции│                      │      │       ц/б     │                                         │                                     │            реализуемых ц/б          │                             │                             │                      │                      │                       │                      │                      │                      │                      │                       │коррект. стоимости ц/б│коррект. стоимости ц/б│  стоимости ц/б        │                      │     (в т.ч. предв.)     │                                     │\n"+
"│                │            │         │                      │      │               ├──────────────────┬──────────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────┬──────────────────┼──────────┬──────────────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼────────────┬────────────┼──────────────────┬──────────────────┤\n"+
"│                │            │         │                      │      │               │        вал.      │          RUR.        │        вал.      │        RUR.      │        вал.      │        RUR.      │    вал.  │        RUR.      │    вал.  │        RUR.      │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │    RUR.    │        вал.      │        RUR.      │\n"+
"├────────────────┼────────────┼─────────┼──────────────────────┼──────┼───────────────┼──────────────────┼──────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────┼──────────────────┼──────────┼──────────────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼────────────┼────────────┼──────────────────┼──────────────────┤";

PRIVATE VAR TableHeader_1_2 =
"┌────────────────┬────────────┬─────────┬──────────────────────┬──────┬───────────────┬─────────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────┬─────────────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬─────────────────────────┬─────────────────────────────────────┬───────────────────────┬───────────────────────┬─────────────────────────────────────┐\n"+
"│      Номер     │    Дата    │   Вид   │   Наименование ц/б   │  ВН  │     Кол-во    │             Цена реализации             │            Сумма реализации         │         Балансовая стоимость        │        НКД полученный       │        НКД уплаченный       │ Ранее начисленный ПД │   Доначисленный ПД   │ Всего: Начисленный ПД │ Доначисленная премия │    Остаток премии    │ Ранее начисленный ДД │   Доначисленный ДД   │ Всего: Начисленный ДД │  Ранее начисленная   │   Доначисленная      │ Всего: корректировка  │ Списанная переоценка │  Затраты на реализацию  │         Финансовый результат        │Несущественные комиссии│Несущественные комиссии│ ФР с учётом несущественных комиссий │\n"+
"│    операции    │поставки ц/б│ операции│                      │      │       ц/б     │                                         │                                     │            реализуемых ц/б          │                             │                             │                      │                      │                       │                      │                      │                      │                      │                       │коррект. стоимости ц/б│коррект. стоимости ц/б│  стоимости ц/б        │                      │     (в т.ч. предв.)     │                                     │    (приобретение)     │     (реализация)      │                                     │\n"+
"│                │            │         │                      │      │               ├──────────────────┬──────────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────┬──────────────────┼──────────┬──────────────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼────────────┬────────────┼──────────────────┬──────────────────┼────────────┬──────────┼────────────┬──────────┼──────────────────┬──────────────────┤\n"+
"│                │            │         │                      │      │               │        вал.      │          RUR.        │        вал.      │        RUR.      │        вал.      │        RUR.      │    вал.  │        RUR.      │    вал.  │        RUR.      │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │    RUR.    │        вал.      │        RUR.      │     вал.   │   RUR.   │     вал.   │   RUR.   │        вал.      │        RUR.      │\n"+
"├────────────────┼────────────┼─────────┼──────────────────────┼──────┼───────────────┼──────────────────┼──────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────┼──────────────────┼──────────┼──────────────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼────────────┼────────────┼──────────────────┼──────────────────┼────────────┼──────────┼────────────┼──────────┼──────────────────┼──────────────────┤";
                                                                                                                                                                                                                                                                                                                                               
PRIVATE VAR TableHeader_2 =
"┌────────────────┬────────────┬─────────┬──────────────────────┬──────┬───────────────┬───────────────┬──────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────┬─────────────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬─────────────────────────┬─────────────────────────────────────┐\n"+
"│      Номер     │    Дата    │   Вид   │   Наименование ц/б   │  ВН  │     Кол-во    │   Портфель    │ Номер лицевого счета │             Цена реализации             │            Сумма реализации         │         Балансовая стоимость        │        НКД полученный       │        НКД уплаченный       │ Ранее начисленный ПД │   Доначисленный ПД   │ Всего: Начисленный ПД │ Доначисленная премия │    Остаток премии    │ Ранее начисленный ДД │   Доначисленный ДД   │ Всего: Начисленный ДД │  Ранее начисленная   │   Доначисленная      │ Всего: корректировка  │ Списанная переоценка │  Затраты на реализацию  │         Финансовый результат        │\n"+
"│    операции    │поставки ц/б│ операции│                      │      │       ц/б     │               │ вложений в ц/б       │                                         │                                     │            реализуемых ц/б          │                             │                             │                      │                      │                       │                      │                      │                      │                      │                       │коррект. стоимости ц/б│коррект. стоимости ц/б│  стоимости ц/б        │                      │     (в т.ч. предв.)     │                                     │\n"+
"│                │            │         │                      │      │               │               │                      ├──────────────────┬──────────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────┬──────────────────┼──────────┬──────────────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼────────────┬────────────┼──────────────────┬──────────────────┤\n"+
"│                │            │         │                      │      │               │               │                      │        вал.      │          RUR.        │        вал.      │        RUR.      │        вал.      │        RUR.      │    вал.  │        RUR.      │    вал.  │        RUR.      │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │    RUR.    │        вал.      │        RUR.      │\n"+
"├────────────────┼────────────┼─────────┼──────────────────────┼──────┼───────────────┼───────────────┼──────────────────────┼──────────────────┼──────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────┼──────────────────┼──────────┼──────────────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼────────────┼────────────┼──────────────────┼──────────────────┤";

PRIVATE VAR TableHeader_2_2 =
"┌────────────────┬────────────┬─────────┬──────────────────────┬──────┬───────────────┬───────────────┬──────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────┬─────────────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬──────────────────────┬───────────────────────┬──────────────────────┬─────────────────────────┬─────────────────────────────────────┬───────────────────────┬───────────────────────┬─────────────────────────────────────┐\n"+
"│      Номер     │    Дата    │   Вид   │   Наименование ц/б   │  ВН  │     Кол-во    │   Портфель    │ Номер лицевого счета │             Цена реализации             │            Сумма реализации         │         Балансовая стоимость        │        НКД полученный       │        НКД уплаченный       │ Ранее начисленный ПД │   Доначисленный ПД   │ Всего: Начисленный ПД │ Доначисленная премия │    Остаток премии    │ Ранее начисленный ДД │   Доначисленный ДД   │ Всего: Начисленный ДД │  Ранее начисленная   │   Доначисленная      │ Всего: корректировка  │ Списанная переоценка │  Затраты на реализацию  │         Финансовый результат        │Несущественные комиссии│Несущественные комиссии│ ФР с учётом несущественных комиссий │\n"+
"│    операции    │поставки ц/б│ операции│                      │      │       ц/б     │               │ вложений в ц/б       │                                         │                                     │            реализуемых ц/б          │                             │                             │                      │                      │                       │                      │                      │                      │                      │                       │коррект. стоимости ц/б│коррект. стоимости ц/б│  стоимости ц/б        │                      │     (в т.ч. предв.)     │                                     │    (приобретение)     │     (реализация)      │                                     │\n"+
"│                │            │         │                      │      │               │               │                      ├──────────────────┬──────────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────┬──────────────────┼──────────┬──────────────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼───────────┬──────────┼────────────┬──────────┼───────────┬──────────┼────────────┬────────────┼──────────────────┬──────────────────┼────────────┬──────────┼────────────┬──────────┼──────────────────┬──────────────────┤\n"+
"│                │            │         │                      │      │               │               │                      │        вал.      │          RUR.        │        вал.      │        RUR.      │        вал.      │        RUR.      │    вал.  │        RUR.      │    вал.  │        RUR.      │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │   RUR.   │    вал.   │   RUR.   │     вал.   │    RUR.    │        вал.      │        RUR.      │     вал.   │   RUR.   │     вал.   │   RUR.   │        вал.      │        RUR.      │\n"+
"├────────────────┼────────────┼─────────┼──────────────────────┼──────┼───────────────┼───────────────┼──────────────────────┼──────────────────┼──────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────┼──────────────────┼──────────┼──────────────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼───────────┼──────────┼────────────┼──────────┼───────────┼──────────┼────────────┼────────────┼──────────────────┼──────────────────┼────────────┼──────────┼────────────┼──────────┼──────────────────┼──────────────────┤";

PRIVATE CLASS (DL_CReportTemplate) SP_Spfinres_Report

  PRIVATE VAR flag = false, HeaderPrefix = "N1_H0", TablePrefix = "N1_A";

  PRIVATE MACRO PrintMode():INTEGER
     if( m_Form.GetFieldValue(PNFLD_FINRES_IsExcel) == SET_CHAR )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
     Dl_CallInsertStat(PrintMode());
     Data = SourceData( m_Form.GetFieldValue(PNFLD_FINRES_Dprt),      
                        m_Form.GetFieldValue(PNFLD_FINRES_OurDeal),   
                        m_Form.GetFieldValue(PNFLD_FINRES_ByPortf),   
                        m_Form.GetFieldValue(PNFLD_FINRES_IsClient),  
                        m_Form.GetFieldValue(PNFLD_FINRES_ClientCode),
                        m_Form.GetFieldValue(PNFLD_FINRES_ContrName),
                        m_Form.GetFieldValue(PNFLD_FINRES_AvrKind),   
                        m_Form.GetFieldValue(PNFLD_FINRES_FICode),    
                        m_Form.GetFieldValue(PNFLD_FINRES_DateBegin), 
                        m_Form.GetFieldValue(PNFLD_FINRES_DateEnd) ); 
                                                                      
     IsApp = m_Form.GetFieldValue(PNFLD_FINRES_Apostr);               
     DprtID_t = m_Form.GetFieldValue(PNFLD_FINRES_Dprt);              

     if( Data.IsDelOnPortf )
        HeaderPrefix = "N1_H1";
        TablePrefix = "N1_B";
     else
        HeaderPrefix = "N1_H0";
        TablePrefix  = "N1_A";
     end;

     CreateTotalBook(); 
     SetActiveSheet( "0101" );
     PrintFormatString( Cap,
                        "N1_H0_1", Data.dateMin, 
                        "N1_H0_2", Data.dateMax
                      );
     CopyAllSheetInTotalBook( NULL, false, "N1_Cap", 0 );
  END;

  PRIVATE MACRO Register_Table()
     if( Data.IsDelOnPortf )
        if( УчитыватьНесущЗатраты )
           RegisterTable( "N1_MainTable_2_2", TableHeader_2_2,
                          "N1_B1",      
                          "N1_B2",      
                          "N1_B3",      
                          "N1_B4",      
                          "N1_B5",      
                          "N1_B6",     
                          "N1_B6a",    
                          "N1_B6b",    
                          "N1_B7",      
                          "N1_B8",      
                          "N1_B9",      
                          "N1_B10",    
                          "N1_B11",    
                          "N1_B12",    
                          "N1_B13",    
                          "N1_B14",    
                          "N1_B15",    
                          "N1_B16",    
                          "N1_B17",    
                          "N1_B18",    
                          "N1_B19",    
                          "N1_B20",    
                          "N1_B20b_1", 
                          "N1_B20b_2", 
                          "N1_B19a",   
                          "N1_B20a",   
                          "N1_B31",    
                          "N1_B32",    
                          "N1_B21",    
                          "N1_B22",    
                          "N1_B23",    
                          "N1_B24",    
                          "N1_B24a_1", 
                          "N1_B24a_2", 

                          "N1_B39",
                          "N1_B40", 
                          "N1_B41", 
                          "N1_B42", 
                          "N1_B43", 
                          "N1_B44", 

                          "N1_B25",    
                          "N1_B26",    
                          "N1_B27",   
                          "N1_B28",   
                          "N1_B29",   
                          "N1_B30",   

                          "N1_B33",   
                          "N1_B34",   
                          "N1_B35",   
                          "N1_B36",   
                          "N1_B37",   
                          "N1_B38"
                         );
        else
           RegisterTable( "N1_MainTable_2", TableHeader_2,
                          "N1_B1",      
                          "N1_B2",      
                          "N1_B3",      
                          "N1_B4",      
                          "N1_B5",      
                          "N1_B6",     
                          "N1_B6a",    
                          "N1_B6b",    
                          "N1_B7",      
                          "N1_B8",      
                          "N1_B9",      
                          "N1_B10",    
                          "N1_B11",    
                          "N1_B12",    
                          "N1_B13",    
                          "N1_B14",    
                          "N1_B15",    
                          "N1_B16",    
                          "N1_B17",    
                          "N1_B18",    
                          "N1_B19",    
                          "N1_B20",    
                          "N1_B20b_1", 
                          "N1_B20b_2", 
                          "N1_B19a",   
                          "N1_B20a",   
                          "N1_B31",    
                          "N1_B32",    
                          "N1_B21",    
                          "N1_B22",    
                          "N1_B23",    
                          "N1_B24",    
                          "N1_B24a_1", 
                          "N1_B24a_2", 

                          "N1_B39",
                          "N1_B40", 
                          "N1_B41", 
                          "N1_B42", 
                          "N1_B43", 
                          "N1_B44", 

                          "N1_B25",    
                          "N1_B26",    
                          "N1_B27",   
                          "N1_B28",   
                          "N1_B29",   
                          "N1_B30"   
                         );
        end;
     else
        if( УчитыватьНесущЗатраты )
           RegisterTable( "N1_MainTable_1_2", TableHeader_1_2,
                          "N1_A1",     
                          "N1_A2",     
                          "N1_A3",     
                          "N1_A4",     
                          "N1_A5",     
                          "N1_A6",     
                          "N1_A7",     
                          "N1_A8",     
                          "N1_A9",     
                          "N1_A10",   
                          "N1_A11",   
                          "N1_A12",   
                          "N1_A13",   
                          "N1_A14",   
                          "N1_A15",   
                          "N1_A16",   
                          "N1_A17",   
                          "N1_A18",   
                          "N1_A19",   
                          "N1_A20",   
                          "N1_A20b_1",
                          "N1_A20b_2",
                          "N1_A19a",  
                          "N1_A20a",  
                          "N1_A31",   
                          "N1_A32",   
                          "N1_A21",   
                          "N1_A22",   
                          "N1_A23",   
                          "N1_A24",   
                          "N1_A24a_1",
                          "N1_A24a_2",
                          "N1_A39",   
                          "N1_A40",   
                          "N1_A41",   
                          "N1_A42",   
                          "N1_A43",   
                          "N1_A44"

                          "N1_A25",   
                          "N1_A26",   
                          "N1_A27",   
                          "N1_A28",   
                          "N1_A29",   
                          "N1_A30",  

                          "N1_A33",   
                          "N1_A34",   
                          "N1_A35",   
                          "N1_A36",   
                          "N1_A37",   
                          "N1_A38"
                         );

        else
           RegisterTable( "N1_MainTable_1", TableHeader_1,
                          "N1_A1",     
                          "N1_A2",     
                          "N1_A3",     
                          "N1_A4",     
                          "N1_A5",     
                          "N1_A6",     
                          "N1_A7",     
                          "N1_A8",     
                          "N1_A9",     
                          "N1_A10",   
                          "N1_A11",   
                          "N1_A12",   
                          "N1_A13",   
                          "N1_A14",   
                          "N1_A15",   
                          "N1_A16",   
                          "N1_A17",   
                          "N1_A18",   
                          "N1_A19",   
                          "N1_A20",   
                          "N1_A20b_1",
                          "N1_A20b_2",
                          "N1_A19a",  
                          "N1_A20a",  
                          "N1_A31",   
                          "N1_A32",   
                          "N1_A21",   
                          "N1_A22",   
                          "N1_A23",   
                          "N1_A24",   
                          "N1_A24a_1",
                          "N1_A24a_2",

                          "N1_A39",
                          "N1_A40", 
                          "N1_A41", 
                          "N1_A42", 
                          "N1_A43", 
                          "N1_A44", 

                          "N1_A25",   
                          "N1_A26",   
                          "N1_A27",   
                          "N1_A28",   
                          "N1_A29",   
                          "N1_A30"  
                         );
        end;
     end;
     flag = true;
  END;

  PRIVATE MACRO EndCopyTable()
     if(flag == true)
       EndTable();
       CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
       flag = false;
     end;
  END;

  PRIVATE MACRO PrintHeadDprt( Data )
     file Dprt( dp_dep );
     /*Название филиала*/
     if( Data.DprtID != 0 )
        ClearRecord( Dprt );
        Dprt.Code = Data.DprtID;
        if( not GetEQ( Dprt ) )
          RunError( "Не найден филиал с кодом " + string(Data.DprtID) );    
        end;
        PrintFormatString( Branch, HeaderPrefix+"_3", Dprt.name);
     end;

     if( УчитыватьНесущЗатраты )
        PrintFormatString( null,
                           HeaderPrefix+"_4",  {CCYNatCur},
                           HeaderPrefix+"_5",  {CCYNatCur}, 
                           HeaderPrefix+"_6",  {CCYNatCur},
                           HeaderPrefix+"_7",  {CCYNatCur},
                           HeaderPrefix+"_8",  {CCYNatCur},
                           HeaderPrefix+"_9",  {CCYNatCur}, 
                           HeaderPrefix+"_10", {CCYNatCur},
                           HeaderPrefix+"_10b",{CCYNatCur},
                           HeaderPrefix+"_10a",{CCYNatCur},
                           HeaderPrefix+"_16", {CCYNatCur},
                           HeaderPrefix+"_11", {CCYNatCur},
                           HeaderPrefix+"_12", {CCYNatCur},
                           HeaderPrefix+"_12a",{CCYNatCur},
                           HeaderPrefix+"_20", {CCYNatCur}, 
                           HeaderPrefix+"_21", {CCYNatCur},
                           HeaderPrefix+"_22", {CCYNatCur},
                           HeaderPrefix+"_13", {CCYNatCur}, 
                           HeaderPrefix+"_14", {CCYNatCur},
                           HeaderPrefix+"_15", {CCYNatCur},

                           HeaderPrefix+"_17", {CCYNatCur},
                           HeaderPrefix+"_18", {CCYNatCur},
                           HeaderPrefix+"_19", {CCYNatCur}
                         );
     else
        PrintFormatString( null,
                           HeaderPrefix+"_4",  {CCYNatCur},
                           HeaderPrefix+"_5",  {CCYNatCur}, 
                           HeaderPrefix+"_6",  {CCYNatCur},
                           HeaderPrefix+"_7",  {CCYNatCur},
                           HeaderPrefix+"_8",  {CCYNatCur},
                           HeaderPrefix+"_9",  {CCYNatCur}, 
                           HeaderPrefix+"_10", {CCYNatCur},
                           HeaderPrefix+"_10b",{CCYNatCur},
                           HeaderPrefix+"_10a",{CCYNatCur},
                           HeaderPrefix+"_16", {CCYNatCur},
                           HeaderPrefix+"_11", {CCYNatCur},
                           HeaderPrefix+"_12", {CCYNatCur},
                           HeaderPrefix+"_12a",{CCYNatCur},
                           HeaderPrefix+"_20", {CCYNatCur}, 
                           HeaderPrefix+"_21", {CCYNatCur},
                           HeaderPrefix+"_22", {CCYNatCur},
                           HeaderPrefix+"_13", {CCYNatCur}, 
                           HeaderPrefix+"_14", {CCYNatCur},
                           HeaderPrefix+"_15", {CCYNatCur}
                         );
     end;

     CopyAllSheetInTotalBook( NULL, false, IIF(Data.IsDelOnPortf,IIF(УчитыватьНесущЗатраты,"N1_TableHeader_2_2","N1_TableHeader_2"),IIF(УчитыватьНесущЗатраты,"N1_TableHeader_1_2","N1_TableHeader_1")), 1 ); 
     Data.ReportRun = true;
     Data.PrintHeadDprt = true;
     Register_Table();
  END;

  PRIVATE MACRO PrintHeadClnt( Data, ClientID, ClientContrID )
     record  rParty( party );
     file sfcontr(sfcontr);
     var     Title, Contract = "";

     if( not Data.PrintHeadDprt )
        PrintHeadDprt( Data );
     end;
     if( Data.PrintHeadClnt == false )
        Merge( TablePrefix+"1", TablePrefix+"2", null);
        if( ClientID <= 0 )
          PrintTableLine( TablePrefix+"1", "Собственные сделки", null);
        elif( not ПолучитьСубъекта( ClientID, rParty ) )
          ClearRecord(sfcontr);
          sfcontr.ID = ClientContrID;

          if( GetEQ(sfcontr) )
             Contract = sfcontr.Number;
          end;

          PrintTableLine( TablePrefix+"1", "Клиент " + rParty.ShortName + ", договор " + Contract, null);
        end;
     end;
     Data.PrintHeadClnt = true;
  END;

  PRIVATE MACRO PrintDeal( Data, DataSet )
   /* Конвертируем sumFrom из валюты FIFrom в валюту FIFace по курсу на дату
      Data, если FIFace != NATCUR. Иначе sumTo = $0. */
   macro ConvertToFIFace( sumTo, sumFrom, Data, FIFrom, FIFace )
      if( FIFace != NATCUR )
         SmartConvertSum( sumTo, sumFrom, Data, FIFrom, FIFace, true );
         setparm( 0, SumTo );
      else
         setparm( 0, $0 );
      end;
   end;

   /* Получаем строку с видом сделки */
   macro GetDealKind( BOfficeKind )
      if( BofficeKind == DL_SECURITYDOC ) 
         return "Продажа";
      else 
         return "Погашение";
      end;
   end;

   macro GetDealKindForItog( BOfficeKind, DealCode )
      if( BofficeKind == DL_SECURITYDOC ) 
         return "продаже "+DealCode;
      else 
         return "погашению "+DealCode;
      end;
   end;

   macro GetBalanceCostPVO(SaleSumID:integer, IsRepo:bool)
      var RSD;
      var 
         SQLQuery = RSDCommand("select NVL(sum(lnk.t_BalanceCostBuy),0) as BalanceCostBuy, NVL(sum(lnk.t_BalanceCostSale),0) as BalanceCostSale" +
                               "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot, dpmwrtsum_dbt salelot " +                             
                               " where     salelot.t_SumID = lnk.t_SaleID " +                                                         
                               "       and buylot.t_SumID  = lnk.t_BuyID " + /*(не из лота 1ч своей сделки)*/                                                         
                               "       and salelot.t_SumID = ? " +                                                                    
                               "       AND lnk.T_BUYID != salelot.T_PARENT " + 
                               "       and buylot.t_Portfolio = ? ");                                                                 
                                                                                                                        
      SQLQuery.addParam( "", RSDBP_IN, SaleSumID );                                                
      SQLQuery.addParam( "", RSDBP_IN, KINDPORT_BACK );                                                                 
      SQLQuery.execute();                                                                                               

      RSD = TRsbDataSet(SQLQuery);
      
      if( RSD.MoveNext() )                                                                                                      
         if( IsRepo )                                                                                         
            return money(RSD.BalanceCostBuy);                                                              
         else                                                                                                        
            return money(RSD.BalanceCostSale);                                                              
         end;
      end; 
      return $0;                                                                                           
   end;

   macro СписаннаяПереоценка(SumID:integer,BofficeKind:integer,DealCode:string,Portfolio_Buy:integer)
      var Portfolio = KINDPORT_SALE, OVERAMOUNTSUM = $0;

      if( (Portfolio_Buy != KINDPORT_UNDEF) AND (Portfolio_Buy != Portfolio) )
         return $0;
      end;

      if( not WRT_GetSaleFinResult_EX( SumID, Portfolio, 0,                                                                              
                                       null, null, null, null, null,                                                        
                                       null, null, null, null, null, 
                                       null, null, null, null, null, 
                                       null, null,                                                
                                       null, null, @OVERAMOUNTSUM ) )      
                                                                                                                                                 
         Data.UniqStr.AddString( "Ошибка при получении результатов списания.|Код сделки = " +DealCode );
      end;

      return OVERAMOUNTSUM;                                                                                                                                 
   end;

   macro PrintStr(Code_,DateSale_,DealKind_,AvrName_,FIFaceCcy_,SaleAmount_,Portfolio_,Account_,
                  Price_val_,Price_rur_,SaleSum_val_,SaleSum_rur_,BalCost_val_,BalCost_rur_,
                  NKDReceiv_val_,NKDReceiv_rur_,NKDPaid_val_,NKDPaid_rur_,
                  INTERESTINCOMEBUY_val_,INTERESTINCOMEBUY_rur_,INTERESTINCOMEADD_val_,INTERESTINCOMEADD_rur_,
                  TotalInterestIncome_val_,TotalInterestIncome_rur_,BONUSADD_val_,BONUSADD_rur_,BONUSREST_val_,BONUSREST_rur_,
                  DISCOUNTINCOMEBUY_val_,DISCOUNTINCOMEBUY_rur_,DISCOUNTINCOMEADD_val_,DISCOUNTINCOMEADD_rur_,
                  TotalDiscountIncome_val_,TotalDiscountIncome_rur_,
                  Correct_val_,Correct_rur_,CorrectADD_val_,CorrectADD_rur_,
                  CorrectFinRes_val_,CorrectFinRes_rur_,
                  OVERAMOUNTSUM_val_,OVERAMOUNTSUM_rur_,OutlaySale_val_,Outlaysale_rur_,
                  FinRes_val_,FinRes_rur_,InsExpCommBuy_val_,InsExpCommBuy_rur_,InsExpCommSale_val_,InsExpCommSale_rur_,InsExpFinRes_val_,InsExpFinRes_rur_
                 )
      if( Data.IsDelOnPortf )                                              
        if( УчитыватьНесущЗатраты )

           var SumPrecision = 0; 
           if( IsHaveFractPart( SaleAmount_ ) )
              SumPrecision = 6;
           end;

           PrintTableLine( "N1_B1",     Code_,                             null,
                           "N1_B2",     DateSale_,                         null,
                           "N1_B3",     DealKind_,                         null,
                           "N1_B4",     AvrName_,                          null,
                           "N1_B5",     FIFaceCcy_,                        null,
                           "N1_B6",     SaleAmount_,                       SumPrecision,
                           "N1_B6a",    DL_GetValueName( OBJTYPE_KINDPORT, Portfolio_), null,
                           "N1_B6b",    string(Account_),                  null,
                           "N1_B7",     PrintSum(Price_val_),              null,
                           "N1_B8",     PrintSum(Price_rur_),              null,
                           "N1_B9",     PrintSum(SaleSum_val_),            null,
                           "N1_B10",    PrintSum(SaleSum_rur_),            null,
                           "N1_B11",    PrintSum(BalCost_val_),            null,
                           "N1_B12",    PrintSum(BalCost_rur_),            null,
                           "N1_B13",    PrintSum(NKDReceiv_val_),          null,
                           "N1_B14",    PrintSum(NKDReceiv_rur_),          null,
                           "N1_B15",    PrintSum(NKDPaid_val_),            null,
                           "N1_B16",    PrintSum(NKDPaid_rur_),            null,
                           "N1_B17",    PrintSum(INTERESTINCOMEBUY_val_),  null,
                           "N1_B18",    PrintSum(INTERESTINCOMEBUY_rur_),  null,
                           "N1_B19",    PrintSum(INTERESTINCOMEADD_val_),  null,
                           "N1_B20",    PrintSum(INTERESTINCOMEADD_rur_),  null,
                           "N1_B20b_1", PrintSum(TotalInterestIncome_val_),null,
                           "N1_B20b_2", PrintSum(TotalInterestIncome_rur_),null,
                           "N1_B19a",   PrintSum(BONUSADD_val_),           null,
                           "N1_B20a",   PrintSum(BONUSADD_rur_),           null,
                           "N1_B31",    PrintSum(BONUSREST_val_),          null,
                           "N1_B32",    PrintSum(BONUSREST_rur_),          null,
                           "N1_B21",    PrintSum(DISCOUNTINCOMEBUY_val_),  null,
                           "N1_B22",    PrintSum(DISCOUNTINCOMEBUY_rur_),  null,
                           "N1_B23",    PrintSum(DISCOUNTINCOMEADD_val_),  null,
                           "N1_B24",    PrintSum(DISCOUNTINCOMEADD_rur_),  null,
                           "N1_B24a_1", PrintSum(TotalDiscountIncome_val_),null,
                           "N1_B24a_2", PrintSum(TotalDiscountIncome_rur_), null,

                           "N1_B39",    PrintSum(Correct_val_),            null, 
                           "N1_B40",    PrintSum(Correct_rur_),            null, 
                           "N1_B41",    PrintSum(CorrectADD_val_),         null, 
                           "N1_B42",    PrintSum(CorrectADD_rur_),         null, 
                           "N1_B43",    PrintSum(CorrectFinRes_val_),      null, 
                           "N1_B44",    PrintSum(CorrectFinRes_rur_),      null, 

                           "N1_B25",    PrintSum(OVERAMOUNTSUM_val_),      null,
                           "N1_B26",    PrintSum(OVERAMOUNTSUM_rur_),      null,
                           "N1_B27",    PrintSum(OutlaySale_val_),         null,
                           "N1_B28",    PrintSum(Outlaysale_rur_),         null,
                           "N1_B29",    PrintSum(FinRes_val_),             null,
                           "N1_B30",    PrintSum(FinRes_rur_),             null, 

                           "N1_B33",    PrintSum(InsExpCommBuy_val_),      null, 
                           "N1_B34",    PrintSum(InsExpCommBuy_rur_),      null, 
                           "N1_B35",    PrintSum(InsExpCommSale_val_),     null, 
                           "N1_B36",    PrintSum(InsExpCommSale_rur_),     null, 
                           "N1_B37",    PrintSum(InsExpFinRes_val_),       null, 
                           "N1_B38",    PrintSum(InsExpFinRes_rur_),       null 
            );                                                                 
        else
           PrintTableLine( "N1_B1",     Code_,                             null,
                           "N1_B2",     DateSale_,                         null,
                           "N1_B3",     DealKind_,                         null,
                           "N1_B4",     AvrName_,                          null,
                           "N1_B5",     FIFaceCcy_,                        null,
                           "N1_B6",     SaleAmount_,                       null,
                           "N1_B6a",    DL_GetValueName( OBJTYPE_KINDPORT, Portfolio_), null,
                           "N1_B6b",    string(Account_),                  null,
                           "N1_B7",     PrintSum(Price_val_),              null,
                           "N1_B8",     PrintSum(Price_rur_),              null,
                           "N1_B9",     PrintSum(SaleSum_val_),            null,
                           "N1_B10",    PrintSum(SaleSum_rur_),            null,
                           "N1_B11",    PrintSum(BalCost_val_),            null,
                           "N1_B12",    PrintSum(BalCost_rur_),            null,
                           "N1_B13",    PrintSum(NKDReceiv_val_),          null,
                           "N1_B14",    PrintSum(NKDReceiv_rur_),          null,
                           "N1_B15",    PrintSum(NKDPaid_val_),            null,
                           "N1_B16",    PrintSum(NKDPaid_rur_),            null,
                           "N1_B17",    PrintSum(INTERESTINCOMEBUY_val_),  null,
                           "N1_B18",    PrintSum(INTERESTINCOMEBUY_rur_),  null,
                           "N1_B19",    PrintSum(INTERESTINCOMEADD_val_),  null,
                           "N1_B20",    PrintSum(INTERESTINCOMEADD_rur_),  null,
                           "N1_B20b_1", PrintSum(TotalInterestIncome_val_),null,
                           "N1_B20b_2", PrintSum(TotalInterestIncome_rur_),null,
                           "N1_B19a",   PrintSum(BONUSADD_val_),           null,
                           "N1_B20a",   PrintSum(BONUSADD_rur_),           null,
                           "N1_B31",    PrintSum(BONUSREST_val_),          null,
                           "N1_B32",    PrintSum(BONUSREST_rur_),          null,
                           "N1_B21",    PrintSum(DISCOUNTINCOMEBUY_val_),  null,
                           "N1_B22",    PrintSum(DISCOUNTINCOMEBUY_rur_),  null,
                           "N1_B23",    PrintSum(DISCOUNTINCOMEADD_val_),  null,
                           "N1_B24",    PrintSum(DISCOUNTINCOMEADD_rur_),  null,
                           "N1_B24a_1", PrintSum(TotalDiscountIncome_val_),null,
                           "N1_B24a_2", PrintSum(TotalDiscountIncome_rur_), null,
                           "N1_B39",    PrintSum(Correct_val_),            null, 
                           "N1_B40",    PrintSum(Correct_rur_),            null, 
                           "N1_B41",    PrintSum(CorrectADD_val_),         null, 
                           "N1_B42",    PrintSum(CorrectADD_rur_),         null, 
                           "N1_B43",    PrintSum(CorrectFinRes_val_),      null, 
                           "N1_B44",    PrintSum(CorrectFinRes_rur_),      null, 
                           "N1_B25",    PrintSum(OVERAMOUNTSUM_val_),      null,
                           "N1_B26",    PrintSum(OVERAMOUNTSUM_rur_),      null,
                           "N1_B27",    PrintSum(OutlaySale_val_),         null,
                           "N1_B28",    PrintSum(Outlaysale_rur_),         null,
                           "N1_B29",    PrintSum(FinRes_val_),             null,
                           "N1_B30",    PrintSum(FinRes_rur_),             null 
            );                                                                 

        end;
     else                                                                 
        if( УчитыватьНесущЗатраты )
           PrintTableLine( "N1_A1",     Code_,                             null,
                           "N1_A2",     DateSale_,                         null,
                           "N1_A3",     DealKind_,                         null,
                           "N1_A4",     AvrName_,                          null,
                           "N1_A5",     FIFaceCcy_,                        null,
                           "N1_A6",     SaleAmount_,                       null,
                           "N1_A7",     PrintSum(Price_val_),              null,
                           "N1_A8",     PrintSum(Price_rur_),              null,
                           "N1_A9",     PrintSum(SaleSum_val_),            null,
                           "N1_A10",    PrintSum(SaleSum_rur_),            null,
                           "N1_A11",    PrintSum(BalCost_val_),            null,
                           "N1_A12",    PrintSum(BalCost_rur_),            null,
                           "N1_A13",    PrintSum(NKDReceiv_val_),          null,
                           "N1_A14",    PrintSum(NKDReceiv_rur_),          null,
                           "N1_A15",    PrintSum(NKDPaid_val_),            null,
                           "N1_A16",    PrintSum(NKDPaid_rur_),            null,
                           "N1_A17",    PrintSum(INTERESTINCOMEBUY_val_),  null,
                           "N1_A18",    PrintSum(INTERESTINCOMEBUY_rur_),  null,
                           "N1_A19",    PrintSum(INTERESTINCOMEADD_val_),  null,
                           "N1_A20",    PrintSum(INTERESTINCOMEADD_rur_),  null,
                           "N1_A20b_1", PrintSum(TotalInterestIncome_val_),null,
                           "N1_A20b_2", PrintSum(TotalInterestIncome_rur_),null,
                           "N1_A19a",   PrintSum(BONUSADD_val_),           null,
                           "N1_A20a",   PrintSum(BONUSADD_rur_),           null,
                           "N1_A31",    PrintSum(BONUSREST_val_),          null,
                           "N1_A32",    PrintSum(BONUSREST_rur_),          null,
                           "N1_A21",    PrintSum(DISCOUNTINCOMEBUY_val_),  null,
                           "N1_A22",    PrintSum(DISCOUNTINCOMEBUY_rur_),  null,
                           "N1_A23",    PrintSum(DISCOUNTINCOMEADD_val_),  null,
                           "N1_A24",    PrintSum(DISCOUNTINCOMEADD_rur_),  null,
                           "N1_A24a_1", PrintSum(TotalDiscountIncome_val_),null,
                           "N1_A24a_2", PrintSum(TotalDiscountIncome_rur_), null,

                           "N1_B39",    PrintSum(Correct_val_),            null, 
                           "N1_B40",    PrintSum(Correct_rur_),            null, 
                           "N1_B41",    PrintSum(CorrectADD_val_),         null, 
                           "N1_B42",    PrintSum(CorrectADD_rur_),         null, 
                           "N1_B43",    PrintSum(CorrectFinRes_val_),      null, 
                           "N1_B44",    PrintSum(CorrectFinRes_rur_),      null, 

                           "N1_A25",    PrintSum(OVERAMOUNTSUM_val_),      null,
                           "N1_A26",    PrintSum(OVERAMOUNTSUM_rur_),      null,
                           "N1_A27",    PrintSum(OutlaySale_val_),         null,
                           "N1_A28",    PrintSum(Outlaysale_rur_),         null,
                           "N1_A29",    PrintSum(FinRes_val_),             null,
                           "N1_A30",    PrintSum(FinRes_rur_),             null, 

                           "N1_A33",    PrintSum(InsExpCommBuy_val_),      null,
                           "N1_A34",    PrintSum(InsExpCommBuy_rur_),      null,
                           "N1_A35",    PrintSum(InsExpCommSale_val_),     null,
                           "N1_A36",    PrintSum(InsExpCommSale_rur_),     null,
                           "N1_A37",    PrintSum(InsExpFinRes_val_),       null,
                           "N1_A38",    PrintSum(InsExpFinRes_rur_),       null
            );
        else                                                                 
           PrintTableLine( "N1_A1",     Code_,                             null,
                           "N1_A2",     DateSale_,                         null,
                           "N1_A3",     DealKind_,                         null,
                           "N1_A4",     AvrName_,                          null,
                           "N1_A5",     FIFaceCcy_,                        null,
                           "N1_A6",     SaleAmount_,                       null,
                           "N1_A7",     PrintSum(Price_val_),              null,
                           "N1_A8",     PrintSum(Price_rur_),              null,
                           "N1_A9",     PrintSum(SaleSum_val_),            null,
                           "N1_A10",    PrintSum(SaleSum_rur_),            null,
                           "N1_A11",    PrintSum(BalCost_val_),            null,
                           "N1_A12",    PrintSum(BalCost_rur_),            null,
                           "N1_A13",    PrintSum(NKDReceiv_val_),          null,
                           "N1_A14",    PrintSum(NKDReceiv_rur_),          null,
                           "N1_A15",    PrintSum(NKDPaid_val_),            null,
                           "N1_A16",    PrintSum(NKDPaid_rur_),            null,
                           "N1_A17",    PrintSum(INTERESTINCOMEBUY_val_),  null,
                           "N1_A18",    PrintSum(INTERESTINCOMEBUY_rur_),  null,
                           "N1_A19",    PrintSum(INTERESTINCOMEADD_val_),  null,
                           "N1_A20",    PrintSum(INTERESTINCOMEADD_rur_),  null,
                           "N1_A20b_1", PrintSum(TotalInterestIncome_val_),null,
                           "N1_A20b_2", PrintSum(TotalInterestIncome_rur_),null,
                           "N1_A19a",   PrintSum(BONUSADD_val_),           null,
                           "N1_A20a",   PrintSum(BONUSADD_rur_),           null,
                           "N1_A31",    PrintSum(BONUSREST_val_),          null,
                           "N1_A32",    PrintSum(BONUSREST_rur_),          null,
                           "N1_A21",    PrintSum(DISCOUNTINCOMEBUY_val_),  null,
                           "N1_A22",    PrintSum(DISCOUNTINCOMEBUY_rur_),  null,
                           "N1_A23",    PrintSum(DISCOUNTINCOMEADD_val_),  null,
                           "N1_A24",    PrintSum(DISCOUNTINCOMEADD_rur_),  null,
                           "N1_A24a_1", PrintSum(TotalDiscountIncome_val_),null,
                           "N1_A24a_2", PrintSum(TotalDiscountIncome_rur_), null,

                           "N1_B39",    PrintSum(Correct_val_),            null, 
                           "N1_B40",    PrintSum(Correct_rur_),            null, 
                           "N1_B41",    PrintSum(CorrectADD_val_),         null, 
                           "N1_B42",    PrintSum(CorrectADD_rur_),         null, 
                           "N1_B43",    PrintSum(CorrectFinRes_val_),      null, 
                           "N1_B44",    PrintSum(CorrectFinRes_rur_),      null, 

                           "N1_A25",    PrintSum(OVERAMOUNTSUM_val_),      null,
                           "N1_A26",    PrintSum(OVERAMOUNTSUM_rur_),      null,
                           "N1_A27",    PrintSum(OutlaySale_val_),         null,
                           "N1_A28",    PrintSum(Outlaysale_rur_),         null,
                           "N1_A29",    PrintSum(FinRes_val_),             null,
                           "N1_A30",    PrintSum(FinRes_rur_),             null 
            );
        end;                                                                 
     end;                                                                 
  end;

  /*итог по сделке (по нескольким портфелям)*/
  var INTERESTINCOME_DEAL_val = $0, INTERESTINCOME_DEAL_rur = $0, DISCOUNTINCOME_DEAL_val = $0, DISCOUNTINCOME_DEAL_rur = $0,  
      INTERESTINCOMEADD_DEAL_val = $0, INTERESTINCOMEADD_DEAL_rur = $0, DISCOUNTINCOMEADD_DEAL_val = $0, DISCOUNTINCOMEADD_DEAL_rur = $0, 
      BONUSADD_DEAL_val = $0, BONUSADD_DEAL_rur = $0, BONUSREST_DEAL_val = $0, BONUSREST_DEAL_rur = $0, OVERAMOUNTSUM_DEAL_val = $0, OVERAMOUNTSUM_DEAL_rur = $0, 
      OutlaySale_DEAL_val = $0, OutlaySale_DEAL_rur = $0, BalCost_DEAL_val = $0, BalCost_DEAL_rur = $0, 
      TotalInterestIncome_DEAL_val = $0, TotalInterestIncome_DEAL_rur = $0, TotalDiscountIncome_DEAL_val = $0, TotalDiscountIncome_DEAL_rur = $0,
      NKDPaid_deal_val = $0, NKDPaid_deal_rur = $0, NKDReceiv_deal_val = $0, NKDReceiv_deal_rur = $0,          
      SaleSum_deal_val = $0, SaleSum_deal_rur = $0, FinRes_deal_val = $0, FinRes_deal_rur = $0, Amount_deal = 0,
      Price_val = $0, Price_rur = $0,
      InsExpCommBuy_deal_val = $0, InsExpCommBuy_deal_rur = $0, InsExpCommSale_deal_val = $0, InsExpCommSale_deal_rur = $0,
      InsExpFinRes_deal_val = $0, InsExpFinRes_deal_rur = $0,
      Correct_deal_val = $0, Correct_deal_rur = $0, CorrectADD_deal_val = $0, CorrectADD_deal_rur = $0,CorrectFinRes_deal_val= $0,CorrectFinRes_deal_rur= $0 ;                                                                                              

   macro ПечатьСделки(DataSet, FD, Portfolio:integer, PortfCount:@integer, NonPrint:bool)
      var
         DateSale    = ConvertSQLDate(DataSet.WrtSumDate),  /* дата продажи (погашения) */
         FIPrice     = DataSet.CFI,         /* валюта цены */
         FIFace      = DataSet.FaceValueFI, /* валюта номинала */
         CostBuy = $0,                                                                                                
         BalCost_val = $0, BalCost_rur = $0,                                                                     
         NKDPaid = $0, NKDPaid_val = $0, NKDPaid_rur = $0,        /* Уплаченный НКД */                           
         NKDReceiv_val = $0, NKDReceiv_rur = $0,             /* Полученный НКД */                                
         Price_valText = $0,                                                     
         SaleSum = $0, SaleSum_val = $0, SaleSum_rur = $0, SaleSumRet = $0, SaleSumRet_val = $0, SaleSumRet_rur = $0,                                                                    
         FinRes_val = $0, FinRes_rur = $0,                                                                       
         FIFaceCcy, SaleAmount = $0, 
         InsExpCommBuy_val = $0, InsExpCommBuy_rur = $0, InsExpCommSale_val = $0, InsExpCommSale_rur = $0, /*несущественные затраты*/
         InsExpFinRes_val = $0, InsExpFinRes_rur = $0 /*ФР с учетом несущественных затрат*/;                                                                                              

      var INTERESTINCOMEBUY_val = $0, INTERESTINCOMEBUY_rur = $0, INTERESTINCOMEBUY = $0,                                                      
          DISCOUNTINCOMEBUY_val = $0, DISCOUNTINCOMEBUY_rur = $0, DISCOUNTINCOMEBUY = $0,                                                      
          INTERESTINCOMEADD_val = $0, INTERESTINCOMEADD_rur = $0, INTERESTINCOMEADD = $0,                                                      
          DISCOUNTINCOMEADD_val = $0, DISCOUNTINCOMEADD_rur = $0, DISCOUNTINCOMEADD = $0,                                                      
          BONUSADD_val = $0, BONUSADD_rur = $0,          BONUSADD = $0,                                                               
          BONUSREST_val = $0, BONUSREST_rur = $0,         BONUSREST = $0,                                                               
          OVERAMOUNTSUM_val = $0, OVERAMOUNTSUM_rur = $0, OVERAMOUNTSUM = $0,                                                                  
          OutlaySale_val = $0, OutlaySale_rur, BalCost = $0, BalanceCostBD = $0,                                    
          CostSum = $0, BalanceCostBuy = $0, BalanceCostSale = $0, BalanceCostPVO = $0, BalanceCostPVO_val = $0, BalanceCostPVO_rur = $0,
          NKDSale = $0, TotalInterestIncome_val = $0, TotalInterestIncome_rur = $0, TotalDiscountIncome_val = $0, TotalDiscountIncome_rur = $0,
          OverAmountOut_rur = $0, OverAmountOut_val = $0,
          NKDPaid_PVO = $0, INTERESTINCOMEBUY_PVO = $0, DISCOUNTINCOMEBUY_PVO = $0, INTERESTINCOMEADD_PVO = $0, DISCOUNTINCOMEADD_PVO = $0,
          NKDSale_PVO = $0, CostSum_PVO = $0,
          Correct_val = $0, Correct_rur = $0, CorrectADD_val = $0, CorrectADD_rur = $0, CorrValueBuy = $0, CorrIntToEIRBuy = $0, CorrIntToEIRAdd = $0,
          CorrectFinRes_val = $0, CorrectFinRes_rur = $0, CorrectValue_val = $0, CorrectValue_rur = $0, CorrectEIR_val = $0, CorrectEIR_rur = $0;          

      var FindAccount = "", Account = "";

      var Code     = DataSet.DealCode, 
          DealKind = GetDealKind( DataSet.BOfficeKind ), 
          AvrName  = DataSet.Name;

      var sqlpvo,setpvo, pmwrtsum_buy, FD_Buy, IsFirstUse = true,sqlun, setun;

      Price_val = Price_rur = $0;

      FIFaceCcy = GetFinInstrCcy( FIFace, true );

      if( not WRT_GetSaleFinResult_EX( DataSet.SumID, Portfolio, 0,                                                                              
                                       @CostBuy, @BalanceCostBuy, @NKDPaid,                                                            
                                       @INTERESTINCOMEBUY, @DISCOUNTINCOMEBUY,                                                        
                                       null, null,                                                                                    
                                       @INTERESTINCOMEADD, @DISCOUNTINCOMEADD,                                                        
                                       null, null, null, null, null, null, null, null,                                                
                                       null, null, @OVERAMOUNTSUM, null, null, null,
                                       @BalanceCostBD, null, @NKDSale, @SaleAmount,
                                       null, null, null, @BONUSADD,
                                       @CostSum, null, null, null, null, null, @BONUSREST,
                                       null, null, null, null,
                                       @CorrValueBuy, @CorrIntToEIRBuy, @CorrIntToEIRAdd
                                       ) )      
                                                                                                                                                 
         Data.UniqStr.AddString( "Ошибка при получении результатов списания.|Код сделки = " +DataSet.DealCode );
         return false;                                                                                                                           
      end;                                                                                                                                       
      
      if( DataSet.BofficeKind != DL_RETIREMENT )
         /*проданные из ПВО*/                                                                                        
         if( (DataSet.ClientID == -1) AND (Portfolio == KINDPORT_UNDEF) )                                            
            if( not WRT_GetSaleFinResult_EX( DataSet.SumID, KINDPORT_BACK, 0,                                                                        
                                             null, null, @NKDPaid_PVO,                                                         
                                             @INTERESTINCOMEBUY_PVO, @DISCOUNTINCOMEBUY_PVO,                                                      
                                             null, null,                                                                                  
                                             @INTERESTINCOMEADD_PVO, @DISCOUNTINCOMEADD_PVO,                                                      
                                             null, null, null, null, null, null, null, null,                                              
                                             null, null, null, null, null, null, null, null,
                                             @NKDSale_PVO, null, null, null, null, null,
                                             @CostSum_PVO ) )
                                                                                                                                                 
               Data.UniqStr.AddString( "Ошибка при получении результатов списания.|Код сделки = " +DataSet.DealCode );
               return false;                                                                                                                     
            end;                                                                                                     
                                                                                                                                   
         end;                                                                                                        
      end;

      if( SaleAmount == $0. )
         return true;
      end;

      PortfCount =  PortfCount + 1;

      PrintHeadClnt( Data, DataSet.ClientID, DataSet.ClientContrID );

      ConvertToFIFace( Price_val, DataSet.Cost/DataSet.Principal, DateSale, FIPrice, FiFace );                                                       
      SmartConvertSum( Price_rur, money(DataSet.Cost/DataSet.Principal), DateSale, FIPrice, Natcur, true );

      /*для погашения SaleSum выводится без НКД*/                                                                                                          
      if( DataSet.BofficeKind == DL_RETIREMENT ) 
         ConvertToFIFace( SaleSumRet_val, DataSet.Cost*SaleAmount/DataSet.Principal, DateSale, FIPrice, FiFace );                                                       
         SmartConvertSum( SaleSumRet_rur, money(DataSet.Cost*SaleAmount/DataSet.Principal), DateSale, FIPrice, Natcur, true );                                                        
      end;

      ConvertToFIFace( SaleSum_val, DataSet.TotalCost*SaleAmount/DataSet.Principal, DateSale, FIPrice, FiFace );                                                       
      SmartConvertSum( SaleSum_rur, money(DataSet.TotalCost*SaleAmount/DataSet.Principal), DateSale, FIPrice, Natcur, true );
                                                                                                                                                                                                                                                                                                               
      if( DataSet.BofficeKind != DL_RETIREMENT )
 
         if( IsREPO(FD.Group) )/*для РЕПО будет доработано*/
           BalCost = CostSum + NKDPaid;
         else
           if( Portfolio != KINDPORT_BACK  )                      
              BalCost = CostSum + NKDPaid;                        
           end;                                                   
                                                                  
           if( DataSet.ClientID == -1 )                           
              if( Portfolio == KINDPORT_UNDEF)                    
                 if( BalCost)                                     
                    BalCost = BalCost - CostSum_PVO - NKDPaid_PVO;
                 end;                                                                                                     
              end;                                                
           end;                                                   
         end;

         ConvertToFIFace( BalCost_val, BalCost, DateSale, FIFace, FIFace );                                                                                
         SmartConvertSum( BalCost_rur, BalCost, DateSale, FIFace, NATCUR, true );                                                                          

         if( (DataSet.ClientID == -1) AND ((Portfolio == KINDPORT_UNDEF) OR (Portfolio == KINDPORT_BACK)) )                   
            /*БС по лотам ПВО, проданным не из своего лота;                                       
              при расчете ФР конвертится отдельно*/                                                                                     
            BalanceCostPVO = GetBalanceCostPVO(DataSet.SumID,IsREPO(FD.Group));                                                                             
            ConvertToFIFace( BalanceCostPVO_val, BalanceCostPVO, DateSale, FIFace, FIFace );                                                                 
            SmartConvertSum( BalanceCostPVO_rur, BalanceCostPVO, DateSale, FIFace, NATCUR, true );                                                     
                                                                                                                                                           
            BalCost_val = BalCost_val + BalanceCostPVO_val;                                                                                              
            BalCost_rur = BalCost_rur + BalanceCostPVO_rur;                                       
         end;

         if( DataSet.ClientID == -1 ) /*для продажи из ПВО ПД и ДД не выводим*/                   
            if( Portfolio == KINDPORT_UNDEF )                                                     
               if( INTERESTINCOMEBUY )                                                            
                  INTERESTINCOMEBUY = INTERESTINCOMEBUY - INTERESTINCOMEBUY_PVO;                  
               end;                                                                               
               if( DISCOUNTINCOMEBUY )                                                            
                  DISCOUNTINCOMEBUY = DISCOUNTINCOMEBUY - DISCOUNTINCOMEBUY_PVO;                  
               end;                                                                               
               if( INTERESTINCOMEADD )                                                            
                  INTERESTINCOMEADD = INTERESTINCOMEADD - INTERESTINCOMEADD_PVO;                  
               end;                                                                               
               if( DISCOUNTINCOMEADD )                                                            
                  DISCOUNTINCOMEADD = DISCOUNTINCOMEADD - DISCOUNTINCOMEADD_PVO;                  
               end;                                                                               
            elif( Portfolio == KINDPORT_BACK )                                                    
               INTERESTINCOMEBUY = DISCOUNTINCOMEBUY = INTERESTINCOMEADD = DISCOUNTINCOMEADD = $0;
            end;                                                                                  
         end;                                                                                     
      else                                                                                                                                                 
         BalCost = CostSum;                                                                                                                                
         ConvertToFIFace( BalCost_val, BalCost, DateSale, FIFace, FIFace );                                                                                
         SmartConvertSum( BalCost_rur, BalCost, DateSale, FIFace, NATCUR, true );                                                                          
      end;                                                                                                                                                 
                                                                                                                                                           
      ПолучитьСуммуКомиссийПоСделке(DataSet, FIFace, DateSale, OutlaySale_val, OutlaySale_rur);                                                            

      ПолучитьСуммуНесуществЗатрат(FD, FIFace, Data.dateMax, false, @InsExpCommSale_val, @InsExpCommSale_rur);
      ПолучитьСуммуНесуществЗатратПоПокупке(DataSet.SumID, FIFace, Data.dateMax, @InsExpCommBuy_val, @InsExpCommBuy_rur);
                                                                                                                                                           
      ConvertToFIFace( NKDReceiv_val, NKDSale, DateSale, FIFace, FIFace );                                                                                 
      SmartConvertSum( NKDReceiv_rur, NKDSale, DateSale, FIFace, NATCUR );                                                                                 

      ConvertToFIFace( NKDPaid_val, NKDPaid, DateSale, FIFace, FIFace );                                                                       
      SmartConvertSum( NKDPaid_rur, NKDPaid, DateSale, FIFace, NATCUR, true );                                                                 
                                                                                                                                                           
      ConvertToFIFace( BONUSADD_val,          BONUSADD,          DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( BONUSADD_rur,          BONUSADD,          DateSale, FIFace, NATCUR, true );                                                         

      ConvertToFIFace( BONUSREST_val,         BONUSREST,         DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( BONUSREST_rur,         BONUSREST,         DateSale, FIFace, NATCUR, true );                                                         
                                                                                                                                                           
      ConvertToFIFace( INTERESTINCOMEBUY_val, INTERESTINCOMEBUY, DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( INTERESTINCOMEBUY_rur, INTERESTINCOMEBUY, DateSale, FIFace, NATCUR, true );                                                         
                                                                                                                                                           
      ConvertToFIFace( DISCOUNTINCOMEBUY_val, DISCOUNTINCOMEBUY, DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( DISCOUNTINCOMEBUY_rur, DISCOUNTINCOMEBUY, DateSale, FIFace, NATCUR, true );                                                         
                                                                                                                                                           
      ConvertToFIFace( INTERESTINCOMEADD_val, INTERESTINCOMEADD, DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( INTERESTINCOMEADD_rur, INTERESTINCOMEADD, DateSale, FIFace, NATCUR, true );                                                         
                                                                                                                                                           
      ConvertToFIFace( DISCOUNTINCOMEADD_val, DISCOUNTINCOMEADD, DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( DISCOUNTINCOMEADD_rur, DISCOUNTINCOMEADD, DateSale, FIFace, NATCUR, true );                                                         
                                                                                                                                                           
      ConvertToFIFace( OVERAMOUNTSUM_val, OVERAMOUNTSUM, DateSale, NATCUR, FIFace );                                                                       
      OVERAMOUNTSUM_rur = OVERAMOUNTSUM;                                                                                                                   
                                                                                                                                                           
      TotalInterestIncome_val = INTERESTINCOMEBUY_val + INTERESTINCOMEADD_val;                                                                             
      TotalDiscountIncome_val = DISCOUNTINCOMEBUY_val + DISCOUNTINCOMEADD_val;                                                                             
                                                                                                                                                           
      SmartConvertSum( TotalInterestIncome_rur, INTERESTINCOMEBUY+INTERESTINCOMEADD, DateSale, FIFace, NATCUR, true );                                     
      SmartConvertSum( TotalDiscountIncome_rur, DISCOUNTINCOMEBUY+DISCOUNTINCOMEADD, DateSale, FIFace, NATCUR, true );                                     
                                                                                                                                                           
      TotalInterestIncome_rur = round(TotalInterestIncome_rur,2);                                                                                          
      TotalDiscountIncome_rur = round(TotalDiscountIncome_rur,2);                                                                                          

      OverAmountOut_rur = СписаннаяПереоценка(DataSet.SumID,DataSet.BofficeKind,DataSet.DealCode,Portfolio);
      ConvertToFIFace( OverAmountOut_val, OverAmountOut_rur, DateSale, NATCUR, FIFace ); 

      ConvertToFIFace( CorrectValue_val, CorrValueBuy, DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( CorrectValue_rur, CorrValueBuy, DateSale, FIFace, NATCUR, true );                                                         

      ConvertToFIFace( CorrectEIR_val, CorrIntToEIRBuy, DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( CorrectEIR_rur, CorrIntToEIRBuy, DateSale, FIFace, NATCUR, true );                                                         

      ConvertToFIFace( CorrectADD_val, CorrIntToEIRAdd, DateSale, FIFace, FIFace );                                                               
      SmartConvertSum( CorrectADD_rur, CorrIntToEIRAdd, DateSale, FIFace, NATCUR, true );                                                         

      Correct_val = CorrectValue_val + CorrectEIR_val;
      CorrectFinRes_val = Correct_val + CorrectADD_val;
      SmartConvertSum( Correct_rur, CorrValueBuy+CorrIntToEIRBuy, DateSale, FIFace, NATCUR, true );                                     
      SmartConvertSum( CorrectFinRes_rur, CorrValueBuy+CorrIntToEIRBuy+ CorrIntToEIRAdd, DateSale, FIFace, NATCUR, true );                                     
      CorrectFinRes_rur = round(CorrectFinRes_rur,2);                                                                                          
                                                                                                                                                           
                                                                      

      /* если включена настройка "ОТДЕЛЬНЫЙ УЧЁТ УПЛАЧЕННОГО НКД",
         то в продаже\погашении суммы Счист, НКД и\или премия конвертируются отдельно друг от друга, идут на счет "Реализация, ц/б" 
         и учитываются при расчет ФР,
         поэтому
         в отчете мы тоже должны учесть эти настройки, кот. заставляют конвертить слагаемые отдельно, накапливать ошибки округления:
         5.95 (округл 5.945) + 4.06 (округл 4.055) = 10.01 (набежала 1 копейка).

         Таким образом В полном погашении может быть получен ФР как сумма курсовой разницы, например, в 1 копейку, 
         такой же результат должен быть получен и в отчете.                       
      */                                
                                        
      if( DataSet.ClientID == -1 )                                                                                                                         
         if( DataSet.BofficeKind != DL_RETIREMENT )                                                                                                        
            FinRes_val = SaleSum_val - (BalCost_val + TotalInterestIncome_val + TotalDiscountIncome_val + CorrectFinRes_val) - OutlaySale_val - OverAmountOut_val;                           
            
            if( not(IsREPO(FD.Group) and IsSALE(FD.Group)) AND
                (Portfolio != KINDPORT_BACK) AND (Portfolio != KINDPORT_UNDEF)
              )
               CostSum = CostSum - BONUSREST;

               if( not ОтдельныйУчетУплНКД() )
                  CostSum = CostSum + NKDPaid;
               end;
              
               SmartConvertSum( BalCost, CostSum, DateSale, FIFace, NATCUR, true );                                                                          
              
               if( ОтдельныйУчетУплНКД() )
                  BalCost = BalCost + NKDPaid_rur;
               end;
              
               BalCost = BalCost + BONUSREST_rur;

               FinRes_rur = SaleSum_rur - (BalCost + BalanceCostPVO_rur + TotalInterestIncome_rur + TotalDiscountIncome_rur + CorrectFinRes_rur) - OutlaySale_rur - OverAmountOut_rur;                           
            else
               FinRes_rur = SaleSum_rur - (BalCost_rur + TotalInterestIncome_rur + TotalDiscountIncome_rur + CorrectFinRes_rur) - OutlaySale_rur - OverAmountOut_rur;                           
            end;
         else                                                                                                                                              
            FinRes_val = SaleSum_val - (BalCost_val + NKDPaid_val + TotalInterestIncome_val + TotalDiscountIncome_val + CorrectFinRes_val) - OutlaySale_val - OverAmountOut_val;

            if( (Portfolio != KINDPORT_BACK) AND (Portfolio != KINDPORT_UNDEF)
              )

               CostSum = CostSum - BONUSREST;
              
               SmartConvertSum( BalCost, CostSum, DateSale, FIFace, NATCUR, true );                                                                          
               
               /*в погашении проводка с НКДупл идет всегда отдельно*/
               BalCost = BalCost + NKDPaid_rur;
               
               BalCost = BalCost + BONUSREST_rur;

               FinRes_rur = SaleSum_rur - (BalCost + BalanceCostPVO_rur + TotalInterestIncome_rur + TotalDiscountIncome_rur + CorrectFinRes_rur) - OutlaySale_rur - OverAmountOut_rur;                  
            else
               FinRes_rur = SaleSum_rur - (BalCost + TotalInterestIncome_rur + TotalDiscountIncome_rur + CorrectFinRes_rur) - OutlaySale_rur - OverAmountOut_rur;                  
            end;

            SaleSum_val = SaleSumRet_val;
            SaleSum_rur = SaleSumRet_rur;
         end;                                                                                                                                             

         InsExpFinRes_val = FinRes_val - InsExpCommBuy_val - InsExpCommSale_val;
         InsExpFinRes_rur = FinRes_rur - InsExpCommBuy_rur - InsExpCommSale_rur;

      else                                                                                                                                                 
         FinRes_val = $0;                                                                                                                                  
         FinRes_rur = $0; 
         Portfolio = KINDPORT_UNDEF;                                                                                                                        
         InsExpCommBuy_val = InsExpCommBuy_rur = InsExpCommSale_val = InsExpCommSale_rur = InsExpFinRes_val = InsExpFinRes_rur = $0;                                                                                              
      end;                                                                                                                                                 

      if( Data.IsDelOnPortf )
         sqlpvo = RSDCommand("select wrtsum.* from dpmwrtsum_dbt wrtsum, dpmwrtlnk_dbt lnk " +                                             
                             " where lnk.t_SaleID = ? "+                                                                                   
                             "   and wrtsum.t_SumID = lnk.t_BuyID " +                                                                      
                             "   and wrtsum.t_Portfolio = ?");                                                                             
         sqlpvo.addParam("", RSDBP_IN, DataSet.SumID);                                                                                     
         sqlpvo.addParam("", RSDBP_IN, Portfolio);                                                                                     
         sqlpvo.execute();                                                                                                                 
                                                                                                                                     
         setpvo = TRsbDataSet(sqlpvo);                                                                                                     
                                                                                                                                     
         while( setpvo.movenext() )                                                                                                        
            if( not IsFirstUse )                                                                                                           
               account = account + " ";                                                                                                    
            end;                                                                                                                           

            pmwrtsum_buy = setpvo.GetRecord();                                                                                             

            if( Portfolio == KINDPORT_BACK )
               FD_Buy = SPFirstDoc( GetLegKindByLotDeal(pmwrtsum_buy, GetDealByID(  pmwrtsum_buy.DealID, true )), pmwrtsum_buy.DealID );
               FD_Buy.IsExistAccount( IIF(IsBasket(FD_Buy.Group), "Ц/б, Корзина ПВО", "Ц/б, ПВО"), FindAccount, true, FIROLE_BA_BACK, null, null, DateSale ); 
            else
               if( pmwrtsum_buy.DocKind == DL_ISSUE_UNION )/*ГО*/
                  sqlun = RSDCommand(" select scdlfi.* "+          
                                     " from dscdlfi_dbt scdlfi "+  
                                     " where SCDLFI.T_DEALID = ? "+
                                     " and SCDLFI.T_DEALKIND = ? "+
                                     " and SCDLFI.T_NEWFIID = ?");
  
                  sqlun.addParam("", RSDBP_IN, pmwrtsum_buy.Docid);                                                                                     
                  sqlun.addParam("", RSDBP_IN, pmwrtsum_buy.DocKind);                                                                                     
                  sqlun.addParam("", RSDBP_IN, pmwrtsum_buy.FIID);                                                                                     
                  sqlun.execute();                                                                                                                 
                                                                                                                                              
                  setun = TRsbDataSet(sqlun);                                                                                                     

                  if( setun.movenext() )
                     FD_Buy = SPFirstDocScdlfiByGlobalConvert(DL_SCDLFI, SQL_ConvType(setun.ID));
                     /*счет всегда должен быть:
                       либо оформлялась мена ц\б в операции ГО, либо, если галочка мены была снята, 
                       должны были открыть счет нового выпуска вручную.*/
               FD_Buy.IsExistAccount( "Наш портфель ц/б", FindAccount, true, GetFIRoleByPortfolio(Portfolio), null, null, DateSale );
            end;
               else
                  FD_Buy = SPFirstDoc( GetLegKindByLotDeal(pmwrtsum_buy, GetDealByID(  pmwrtsum_buy.DealID, true )), pmwrtsum_buy.DealID );
                  FD_Buy.IsExistAccount( "Наш портфель ц/б", FindAccount, true, GetFIRoleByPortfolio(Portfolio), null, null, DateSale );
               end;
            end;
            if( not Index(account,FindAccount) )
               account = account + FindAccount;
            end;                                                                                   
            IsFirstUse = false;                                                                                                            
         end;                                                                                                                              
      end;

      if( PortfCount > 1 )
         /*если портфелей больше одного - в строку печатаем не всё*/
          Code     = ""; 
          DateSale = ""; 
          DealKind = ""; 
          AvrName  = "";
          FIFaceCcy = "";
          Price_val = "";
          Price_rur = "";
          InsExpCommBuy_val = InsExpCommBuy_rur = InsExpCommSale_val = InsExpCommSale_rur = "";
      end;

      if( not NonPrint )
         PrintStr(Code,DateSale,DealKind,AvrName,FIFaceCcy,SaleAmount,Portfolio,Account,
                  Price_val,Price_rur,SaleSum_val,SaleSum_rur,BalCost_val,BalCost_rur,
                  NKDReceiv_val,NKDReceiv_rur,NKDPaid_val,NKDPaid_rur,
                  INTERESTINCOMEBUY_val,INTERESTINCOMEBUY_rur,INTERESTINCOMEADD_val,INTERESTINCOMEADD_rur,
                  TotalInterestIncome_val,TotalInterestIncome_rur,BONUSADD_val,BONUSADD_rur,BONUSREST_val,BONUSREST_rur,
                  DISCOUNTINCOMEBUY_val,DISCOUNTINCOMEBUY_rur,DISCOUNTINCOMEADD_val,DISCOUNTINCOMEADD_rur,
                  TotalDiscountIncome_val,TotalDiscountIncome_rur,
                  Correct_val,Correct_rur,CorrectADD_val,CorrectADD_rur,
                  CorrectFinRes_val,CorrectFinRes_rur,
                  OVERAMOUNTSUM_val,OVERAMOUNTSUM_rur,OutlaySale_val,Outlaysale_rur,
                  FinRes_val,FinRes_rur,InsExpCommBuy_val,InsExpCommBuy_rur,InsExpCommSale_val,InsExpCommSale_rur,InsExpFinRes_val,InsExpFinRes_rur
                 );
      end;

      /*собираем итог*/
      Amount_deal = Amount_deal + SaleAmount;

      INTERESTINCOME_DEAL_val    = INTERESTINCOME_DEAL_val + INTERESTINCOMEBUY_val;
      INTERESTINCOME_DEAL_rur    = INTERESTINCOME_DEAL_rur + INTERESTINCOMEBUY_rur;
      DISCOUNTINCOME_DEAL_val    = DISCOUNTINCOME_DEAL_val + DISCOUNTINCOMEBUY_val;
      DISCOUNTINCOME_DEAL_rur    = DISCOUNTINCOME_DEAL_rur + DISCOUNTINCOMEBUY_rur;
  
      INTERESTINCOMEADD_DEAL_val = INTERESTINCOMEADD_DEAL_val + INTERESTINCOMEADD_val;
      INTERESTINCOMEADD_DEAL_rur = INTERESTINCOMEADD_DEAL_rur + INTERESTINCOMEADD_rur;
      DISCOUNTINCOMEADD_DEAL_val = DISCOUNTINCOMEADD_DEAL_val + DISCOUNTINCOMEADD_val;
      DISCOUNTINCOMEADD_DEAL_rur = DISCOUNTINCOMEADD_DEAL_rur + DISCOUNTINCOMEADD_rur; 

      TotalInterestIncome_DEAL_val = TotalInterestIncome_DEAL_val + TotalInterestIncome_val; 
      TotalInterestIncome_DEAL_rur = TotalInterestIncome_DEAL_rur + TotalInterestIncome_rur;
      TotalDiscountIncome_DEAL_val = TotalDiscountIncome_DEAL_val + TotalDiscountIncome_val;
      TotalDiscountIncome_DEAL_rur = TotalDiscountIncome_DEAL_rur + TotalDiscountIncome_rur;

      BONUSADD_DEAL_val = BONUSADD_DEAL_val + BONUSADD_val; 
      BONUSADD_DEAL_rur = BONUSADD_DEAL_rur + BONUSADD_rur;
      BONUSREST_DEAL_val = BONUSREST_DEAL_val + BONUSREST_val; 
      BONUSREST_DEAL_rur = BONUSREST_DEAL_rur + BONUSREST_rur;

      OVERAMOUNTSUM_DEAL_val = OVERAMOUNTSUM_DEAL_val + OVERAMOUNTSUM_val;
      OVERAMOUNTSUM_DEAL_rur = OVERAMOUNTSUM_DEAL_rur + OVERAMOUNTSUM_rur; 

      OutlaySale_DEAL_val = OutlaySale_DEAL_val + OutlaySale_val;
      OutlaySale_DEAL_rur = OutlaySale_DEAL_rur + OutlaySale_rur;

      BalCost_DEAL_val = BalCost_DEAL_val + BalCost_val;
      BalCost_DEAL_rur = BalCost_DEAL_rur + BalCost_rur; 

      NKDPaid_deal_val = NKDPaid_deal_val + NKDPaid_val;
      NKDPaid_deal_rur = NKDPaid_deal_rur + NKDPaid_rur;

      NKDReceiv_deal_val = NKDReceiv_deal_val + NKDReceiv_val;
      NKDReceiv_deal_rur = NKDReceiv_deal_rur + NKDReceiv_rur;
          
      SaleSum_deal_val = SaleSum_deal_val + SaleSum_val;
      SaleSum_deal_rur = SaleSum_deal_rur + SaleSum_rur;
                                                                                                                                                           
      FinRes_deal_val = FinRes_deal_val + FinRes_val;
      FinRes_deal_rur = FinRes_deal_rur + FinRes_rur;

      InsExpCommBuy_deal_val = InsExpCommBuy_deal_val + InsExpCommBuy_val;
      InsExpCommBuy_deal_rur = InsExpCommBuy_deal_rur + InsExpCommBuy_rur;
      InsExpCommSale_deal_val = InsExpCommSale_deal_val + InsExpCommSale_val;
      InsExpCommSale_deal_rur = InsExpCommSale_deal_rur + InsExpCommSale_rur;
      InsExpFinRes_deal_val = InsExpFinRes_deal_val + InsExpFinRes_val;
      InsExpFinRes_deal_rur = InsExpFinRes_deal_rur + InsExpFinRes_rur;

      Correct_deal_val       =  Correct_deal_val + Correct_val;
      Correct_deal_rur       =  Correct_deal_rur + Correct_rur;
      CorrectADD_deal_val    =  CorrectADD_deal_val + CorrectADD_val;
      CorrectADD_deal_rur    =  CorrectADD_deal_rur + CorrectADD_rur;
      CorrectFinRes_deal_val =  CorrectFinRes_deal_val + CorrectFinRes_val;
      CorrectFinRes_deal_rur =  CorrectFinRes_deal_rur + CorrectFinRes_rur;

      return true;
   end;

   var Groups = TArray();
   var FD, i = 0, PortfCount = 0;

   if( IsREPO(GetOperationGroup( DataSet.DealType )) )
      FD = SPFirstDoc( LEG_KIND_DL_TICK_BACK, DataSet.DealID); 
   else
      FD = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID ); 
   end;
   ПолучитьГруппыСписания( FD, Groups );

   /*если валюта номинала != рубли или в панели указано в разрезе портфелей, то ФР собираем отдельно по каждому портфелю*/
   if( Data.IsDelOnPortf )
      while( i < Groups.Size )
         if( not ПечатьСделки(DataSet, FD, Groups[i], @PortfCount, false ) )
            return;
         end;
         i = i + 1;
      end;
      if( PortfCount > 1 )
         PrintStr("Итого по "+GetDealKindForItog(DataSet.BOfficeKind,DataSet.DealCode),"","","","",Amount_deal,"","",                  
                  "","",SaleSum_deal_val,SaleSum_deal_rur,BalCost_deal_val,BalCost_deal_rur,                    
                  NKDReceiv_deal_val,NKDReceiv_deal_rur,NKDPaid_deal_val,NKDPaid_deal_rur,                                    
                  INTERESTINCOME_deal_val,INTERESTINCOME_deal_rur,INTERESTINCOMEADD_deal_val,INTERESTINCOMEADD_deal_rur,
                  TotalInterestIncome_deal_val,TotalInterestIncome_deal_rur,BONUSADD_deal_val,BONUSADD_deal_rur,BONUSREST_deal_val,BONUSREST_deal_rur,              
                  DISCOUNTINCOME_deal_val,DISCOUNTINCOME_deal_rur,DISCOUNTINCOMEADD_deal_val,DISCOUNTINCOMEADD_deal_rur,
                  TotalDiscountIncome_deal_val,TotalDiscountIncome_deal_rur,                                        
                  Correct_deal_val,Correct_deal_rur,CorrectADD_deal_val,CorrectADD_deal_rur,
                  CorrectFinRes_deal_val,CorrectFinRes_deal_rur,
                  OVERAMOUNTSUM_deal_val,OVERAMOUNTSUM_deal_rur,OutlaySale_deal_val,Outlaysale_deal_rur,                      
                  FinRes_deal_val,FinRes_deal_rur,InsExpCommBuy_deal_val,InsExpCommBuy_deal_rur,InsExpCommSale_deal_val,InsExpCommSale_deal_rur,InsExpFinRes_deal_val,InsExpFinRes_deal_rur                                                                  
                 );                                                                                       
      end;
   elif( DataSet.FaceValueFI != NATCUR )
      while( i < Groups.Size )
         if( not ПечатьСделки(DataSet, FD, Groups[i], @PortfCount, true ) )
            return;
         end;
         i = i + 1;
      end;
      if( PortfCount > 0 )

         ConvertToFIFace( Price_val, DataSet.Cost/DataSet.Principal, ConvertSQLDate(DataSet.WrtSumDate), DataSet.CFI, DataSet.CFI );                                                       
         SmartConvertSum( Price_rur, money(DataSet.Cost/DataSet.Principal), ConvertSQLDate(DataSet.WrtSumDate), DataSet.CFI, Natcur, true );

         PrintStr(DataSet.DealCode,ConvertSQLDate(DataSet.WrtSumDate),GetDealKind( DataSet.BOfficeKind ),
                  DataSet.Name,GetFinInstrCcy( DataSet.FaceValueFI, true ),Amount_deal,-1,"",
                  Price_val,Price_rur,SaleSum_deal_val,SaleSum_deal_rur,BalCost_deal_val,BalCost_deal_rur,                    
                  NKDReceiv_deal_val,NKDReceiv_deal_rur,NKDPaid_deal_val,NKDPaid_deal_rur,                                    
                  INTERESTINCOME_deal_val,INTERESTINCOME_deal_rur,INTERESTINCOMEADD_deal_val,INTERESTINCOMEADD_deal_rur,
                  TotalInterestIncome_deal_val,TotalInterestIncome_deal_rur,BONUSADD_deal_val,BONUSADD_deal_rur,BONUSREST_deal_val,BONUSREST_deal_rur,              
                  DISCOUNTINCOME_deal_val,DISCOUNTINCOME_deal_rur,DISCOUNTINCOMEADD_deal_val,DISCOUNTINCOMEADD_deal_rur,
                  TotalDiscountIncome_deal_val,TotalDiscountIncome_deal_rur,                                        
                  Correct_deal_val,Correct_deal_rur,CorrectADD_deal_val,CorrectADD_deal_rur,
                  CorrectFinRes_deal_val,CorrectFinRes_deal_rur,
                  OVERAMOUNTSUM_deal_val,OVERAMOUNTSUM_deal_rur,OutlaySale_deal_val,Outlaysale_deal_rur,                      
                  FinRes_deal_val,FinRes_deal_rur,InsExpCommBuy_deal_val,InsExpCommBuy_deal_rur,InsExpCommSale_deal_val,InsExpCommSale_deal_rur,InsExpFinRes_deal_val,InsExpFinRes_deal_rur
                 );
      end;
   else
      if( not ПечатьСделки(DataSet, FD, KINDPORT_UNDEF, @PortfCount, false) )/*по всем портфелям*/
         return;
      end;
   end;

  END;

  private macro ПроверимНаличиеБУдляКлиента( Data, ClientID, ClientContrID )

     var ClientName, ClientInDeal, ClientForCheck, Contract;
     var cmd, CmdData, FactDateData, IsExists = false;

     ClientInDeal   = ClientID;
     ClientForCheck = ClientID;
     if( ClientInDeal  == -1 )
        ClientForCheck = {OurBank};
     end;
     Contract = ClientContrID;

     /*По ТЗ:Отчет формируется только для тех субъектов, для которых была выполнена хотя бы одна сервисная операция бухгалтерского учета за указанные даты.
       Разъяснения аналитика: можно проверять, что за каждую отчётную дату есть одна или больше СО БУ, в которой обрабатывались сделки указанного субъекта.
       Итого: проверяем, что были выполнены сервисные операции бухгалтерского учета для всех тех дат, в которые были поставки по сделкам продажи\погашения\ОРЕПО2ч данного владельца*/
     cmd = DL_RSDCommand(  " select t.t_FactDate "
                         + "   from ("
                         + "         select distinct(RSI_RsbCalendar.GetDateAfterWorkDay(rq.t_FactDate, 0)) t_FactDate "
                         + "           from ddl_tick_dbt tick, ddlrq_dbt rq "
                         + "          where ( (tick.t_BOfficeKind = ? and "
                         + "                   ( rsb_secur.IsSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))= 1 and "
                         + "                     rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))= 0 "
                         + "                   ) or "
                         + "                   ( rsb_secur.IsREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))= 1 and  "
                         + "                     rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))= 1 "
                         + "                   ) "
                         + "                  ) "
                         + "                 or tick.t_BOfficeKind = ?) "
                         + "            and tick.t_ClientID = ? "
                         + "            and tick.t_ClientContrID = ? "
                         + "            and tick.t_Department  = ? "
                         + "            and rq.t_DocKind = tick.t_BOfficeKind "
                         + "            and rq.t_DocID = tick.t_DealID "
                         + "            and rq.t_DealPart = case when rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 and "
                         + "                                          rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "
                         + "                                     then 2 else 1 end "
                         + "            and rq.t_Type = ? "
                         + "            and rq.t_Num = 0 "
                         + "            and rq.t_FactDate >= ? "
                         + "            and rq.t_FactDate <= ? "
                         + "        ) t "
                         + "  where NVL((select count(1) NREC "
                         + "               from dpmwrtgrp_dbt wrtgrp, ddl_comm_dbt comm "
                         + "              where COMM.T_DOCUMENTID = WRTGRP.T_DOCID "
                         + "                and COMM.T_DOCKIND = WRTGRP.T_DOCKIND "
                         + "                and COMM.T_COMMDATE = t.t_FactDate "
                         + "                and COMM.T_COMMSTATUS in( ?, ?, ? ) "
                         + "                and comm.t_DocKind = " + DL_SСACCOUNTING
                         + "                and WRTGRP.T_ERRSTATUS = 0 "
                         + "                and WRTGRP.T_PARTY = ? "
                         + "                and WRTGRP.T_CONTRACT = ? "
                         + "                and WRTGRP.T_DEPARTMENT = ?),0) = 0 "
                         + "  order by t.t_FactDate desc "
                           );
     
     cmd.addParam(DL_SECURITYDOC);
     cmd.addParam(DL_RETIREMENT);
     cmd.addParam(ClientInDeal);
     cmd.addParam(Contract);
     cmd.addParam(Data.DprtID);
     cmd.addParam(DLRQ_TYPE_DELIVERY);
     
     cmd.addParam(Data.dateMin);
     cmd.addParam(Data.dateMax);
     
     cmd.addParam(DL_COMM_CLOSED);
     cmd.addParam(DL_COMM_CLOSED_ERROR);
     cmd.addParam(DL_COMM_OPEN);
     cmd.addParam(ClientInDeal);
     cmd.addParam(Contract);
     cmd.addParam(Data.DprtID);
     
     FactDateData = cmd.execute();

     ClientName = GetPartyShortNameByID( ClientForCheck );
     
     if( not( FactDateData.MoveNext() ))
       
        /*проверим, что по клиенту была хотя бы одна СО БУ за отчетный период*/
        cmd = DL_RSDCommand(  " select count(1) NREC "
                            + "   from dpmwrtgrp_dbt wrtgrp, ddl_comm_dbt comm "
                            + "  where COMM.T_DOCUMENTID = WRTGRP.T_DOCID "
                            + "    and COMM.T_DOCKIND = WRTGRP.T_DOCKIND "
                            + "    and COMM.T_COMMDATE >= ? "
                            + "    and COMM.T_COMMDATE <= ? "
                            + "    and COMM.T_COMMSTATUS in( ?, ?, ? ) "
                            + "    and comm.t_DocKind = " + DL_SСACCOUNTING
                            + "    and WRTGRP.T_ERRSTATUS = 0 "
                            + "    and WRTGRP.T_PARTY = ? "
                            + "    and WRTGRP.T_CONTRACT = ? "
                            + "    and WRTGRP.T_DEPARTMENT = ? "
                              );
      
        cmd.addParam(Data.dateMin);
        cmd.addParam(Data.dateMax);
      
        cmd.addParam(DL_COMM_CLOSED);
        cmd.addParam(DL_COMM_CLOSED_ERROR);
        cmd.addParam(DL_COMM_OPEN);
        cmd.addParam(ClientInDeal);
        cmd.addParam(Contract);
        cmd.addParam(Data.DprtID);
      
        CmdData = cmd.execute();

        if( CmdData.MoveNext() and (SQL_ConvTypeInteger(CmdData.NREC) > 0) )
           IsExists = true;
        end;
     end;

     return IsExists;
  end;

  MACRO БылЗакрытТорговыйДень( CommDate, ClientID, ClientContrID )
    var
      comm  = TBFile( "dl_comm", "R", 3 );

    if( (ClientID >= 0) AND КлиентВОнлайне(ClientID, ClientContrID) )
      return true;
    end;

    comm.Clear;
    comm.AddFilter(   "t_DocKind = " + string(DL_FINALTRADEDAY)
                     + " and t_CommStatus in( " + string(DL_COMM_CLOSED) + ", " + string(DL_COMM_CLOSED_ERROR) + " )"
                     + " and t_CommDate = " + GetSQLDate(CommDate)
                     + " and (   t_ClientID = -1"
                     + "         or (t_ClientID = " + string(ClientID)
                     +               " and (t_ContractID = -1 "
                     +               "      or t_ContractID = " + string(ClientContrID)
                     + "                   )" 
                     + "            )" 
                     + "     )" );
    return comm.Next;

  END;


  PRIVATE MACRO СделкиПоДоговоруКлиента( Data, ClientID, ClientContrID )
   var
      CheckClientID, query, DataSet, stat, count, Num = 0,
      ExistSC_Accounting = ПроверимНаличиеБУдляКлиента(Data, ClientID, ClientContrID);  

      Data.PrintHeadClnt = false;
      query = RSDCommand(" SELECT deal.t_DealID, deal.t_BOfficeKind, deal.t_ClientID, deal.t_ClientContrID, " + 
                     " deal.t_DealDate, deal.t_DealStatus, deal.t_DealCode, deal.t_DealType, " +
                     " deal.t_CommDate, deal.t_PreOutlay, deal.t_PreOutlayFIID, " + 
                     " wrtsum.t_Date as WrtSumDate, wrtsum.t_SumID, " +
                     " fininstr.t_Name, fininstr.t_FaceValueFI, fininstr.t_FIID, " +
                     " leg.t_TotalCost, leg.t_Principal, leg.t_Cost, leg.t_CFI " +
     
               " FROM  ddl_tick_dbt deal, dpmwrtsum_dbt wrtsum, dfininstr_dbt fininstr, " + 
                     " ddlrq_dbt rq, ddl_leg_dbt leg" +
                     
               " WHERE "+
                     "(deal.t_BOfficeKind = " + string(DL_SECURITYDOC) +
                  " or deal.t_BOfficeKind = " + string(DL_RETIREMENT) + ")" +
                 " and deal.t_ClientID    = ? " +
                 " and (deal.t_ClientID = -1 or deal.t_ClientContrID = ?) " +
                 " and deal.t_Department  = ? " +
                 " and deal.t_DealID      = wrtsum.t_DealID " +
     
                 " and wrtsum.t_DocKind     = " + string(DLDOC_PAYMENT) +
                 " and wrtsum.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_SALE) +
                 " and (select count(*) from dpmwrtlnk_dbt where t_SaleID = wrtsum.t_SumID) > 0 " +
                 " and wrtsum.t_State >= " + string(PM_WRTSUM_FORM) +
                 " and wrtsum.t_Date  >= ? " + 
                 " and wrtsum.t_Date  <= ? " +
                 " and wrtsum.t_FIID   = fininstr.t_FIID " +
     
                 " and wrtsum.t_Kind not in (" + string(200/*PM_WRTSUM_KIND_RRWAS1*/) + ", " 
                                               + string(290/*PM_WRTSUM_KIND_RRAS1*/) + ")" +
     
                 " and leg.t_DealID = deal.t_DealID " +
                 IIF(Data.AvrKind == -1, "", " and RSB_FIInstr.FI_AvrKindsEQ( 2, " + string(Data.AvrKind) + ", fininstr.t_AvoirKind ) = 1 " ) +
                 IIF(Data.FICode  == -1, "", " and fininstr.t_FaceValueFI = " + string(Data.FICode )) +
     
                 " and wrtsum.t_DocID      = rq.t_ID " +
                 " and rq.t_DOCKIND = deal.t_BOfficeKind " +
                 " and rq.t_DOCID = deal.t_DealID " +
                 " and rq.T_TYPE = " +DLRQ_TYPE_DELIVERY+
                 "      and ((rq.T_DEALPART = 1 " + /*по 1 части - продажа*/
                 "        and leg.t_LegKind  = " + string(LEG_KIND_DL_TICK) + ")" +
                 "      or   (rq.T_DEALPART = 2 " + /*по 2 части - покупка*/
                 "      and leg.t_LegKind  = " + string(LEG_KIND_DL_TICK_BACK) + ") )" +
     
                 " ORDER BY deal.t_BOfficeKind, deal.t_ClientID, deal.t_ClientContrID, deal.t_DealDate, deal.t_DealID");  /*по 6-му ключу*/
     
      query.addParam( "", RSDBP_IN, ClientID );
      query.addParam( "", RSDBP_IN, ClientContrID );
      query.addParam( "", RSDBP_IN, Data.DprtID );
      query.addParam( "", RSDBP_IN, Data.dateMin );
      query.addParam( "", RSDBP_IN, Data.dateMax );
      query.execute();
     
      DataSet = TRsbDataSet( query, RSDVAL_CLIENT, RSDVAL_STATIC );
      DataSet.MoveLast();
      count = DataSet.GetRecCount();
      if (count > 0)
         stat = DataSet.MoveFirst(); 
     
         InitProgress( count, "Просмотр сделок", "Просмотр сделок" );
     
         while( stat )
           if( ClientID <= 0 )
             CheckClientID = {OurBank};
           else
             CheckClientID = ClientID;
           end;

           if((( DataSet.DealStatus == DL_CLOSED ) and ( БылЗакрытТорговыйДень( ConvertSQLDate(DataSet.WrtSumDate), CheckClientID, DataSet.ClientContrID )  ) )                  
              or ( ExistSC_Accounting )) 
            PrintDeal( Data, DataSet ); 
           end; 
            UseProgress(Num = Num + 1);
            stat = DataSet.MoveNext();
         end;
         RemProgress;
      end;
  END;

  PRIVATE MACRO СделкиПоКлиенту( Data, ClientID )
   var
      query, DataSet; 

   if (ClientID == -1)
      СделкиПоДоговоруКлиента( Data, ClientID, 0 );
   else
      if (Data.ClientContrID > 0)
         СделкиПоДоговоруКлиента( Data, ClientID, Data.ClientContrID );
      else
         query = RSDCommand(" SELECT * " + 
                             " FROM  dsfcontr_dbt " + 
                             " WHERE t_ServKind     = ? " +
                               " and t_PartyID      = ? " +
                               " and t_ContractorID = ? " +
                               " ORDER BY t_ID");

         query.addParam( "", RSDBP_IN, PTSK_STOCKDL );
         query.addParam( "", RSDBP_IN, ClientID );
         query.addParam( "", RSDBP_IN, {OurBank} );
         query.execute();

         DataSet = TRsbDataSet( query );
         while( DataSet.MoveNext() )
            СделкиПоДоговоруКлиента( Data, ClientID, DataSet.ID );
         end;
      end;
   end;

  END;

/*По конкретному филиалу*/
  PRIVATE MACRO СделкиПоФилиалу( Data )
   var Num = 0;
   var Query, SqlQuery, ClientSet;

   Data.PrintHeadDprt = false;
   Data.PrintHeadClnt = false;
   if( Data.IsOwnDeal == true ) /*Собственные сделки*/
      InitProgress( 1, "Просмотр клиентов", "Просмотр клиентов" );
      СделкиПоКлиенту( Data, -1 );
      UseProgress(1);
      RemProgress;
   end;

   if( Data.IsClientDeal == true ) /*Клиентские сделки*/
      Data.PrintHeadClnt = false;
      if( Data.ClientID != -1 )
         if(Data.ClientID != {OurBank})  /*наш банк не может быть клиентом у самого себя*/
            InitProgress( 1, "Просмотр клиентов", "Просмотр клиентов" );
            СделкиПоКлиенту( Data, Data.ClientID );
            UseProgress(1);
            RemProgress;
         end;
      else
         Query = "select t_PartyID " +                                           
                 "  from dclient_dbt " +                                         
                 " where t_ServiceKind = " + string(PTSK_STOCKDL) +  
                 "   and t_PartyID != " + string({OurBank}) +
                 "   and t_Department = " +string(Data.DprtID)+                   
                 "   and t_Branch = 0";                                          
         SqlQuery = RSDCommand(Query);                                           
         SqlQuery.execute();                                                     
         ClientSet = TRsbDataSet(SqlQuery);                                      

         InitProgress( SQL_GetNRecs(Query), "Просмотр клиентов", "Просмотр клиентов" );

         while( ClientSet.MoveNext() ) 
            Data.PrintHeadClnt = false;
            СделкиПоКлиенту( Data, ClientSet.PartyID );
            UseProgress(Num = Num + 1);
         end;
         RemProgress;
      end;
   end;
     EndCopyTable();
  END;

/*По всем филиалам*/
  PRIVATE MACRO СделкиПоВсемФилиалам( Data )
   var  Continue_cicle, Num = 0;
   file Department( dp_dep );

   InitProgress( NRecords(Department), "Отчет \"Финансовый результат по операциям с ц/б\"", 
                 "Просмотр сделок для филиалов" );

   ClearRecord( Department );
   Department.Code = 0;
   Continue_cicle = GetGE(Department); 
   while( Continue_cicle )
      if( Department.Code != {OperDprt} ) /*Свой уже распечатан (первый при запуске)*/
         Data.DprtID = Department.Code;
         СделкиПоФилиалу( Data );
      end;
      Continue_cicle = Next(Department); 
      Num = Num + 1;
      UseProgress( Num );
   end;
   RemProgress;
  END;

  PRIVATE MACRO EndReport()
     SaveTotalBook();
  END;

  PRIVATE MACRO Create()

     УчитыватьНесущЗатраты = ПроверятьСущественностьЗатрат();

     if( DprtID_t == -1 ) /* Не задан филиал, то сначала для себя, затем по всем 
                           оставшимся филиалам */
       Data.DprtID = {OperDprt};
       СделкиПоФилиалу( Data );
       СделкиПоВсемФилиалам( Data );
     else 
       СделкиПоФилиалу( Data );
     end;

     if( Data.ReportRun == false )
          PrintFormatString( ReportRunFalse, "N1_ReportRunFalse", "В указанный период сделок, соответствующих параметрам отчета, не проводилось" );
          CopyAllSheetInTotalBook( NULL, false, "N1_ReportRunFalse", 1 ); 
     else 
          AddStandardFooter( "N1_" );
          CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );  
     end;

     /* Печать протокола */
     var i:integer = 0;
     while( i < Data.UniqStr.Size )
       msgbox( Data.UniqStr.(i) );
       i = i + 1;
     end;

  END;

  initDL_CReportTemplate( SP_FinResRep_Panel(), "Report_TxSpfinres.xls" );
END;

SP_Spfinres_Report().Run();
exit(1);
