/*
$Name:        nptxshort.mac
$Module:      Ценные бумаги
$Description: Отчет "Краткая справка по расчету НДФЛ"
*/
IMPORT "nptxshort_form.mac", "RegistrReport.mac", "NpTxRepoReg_Data.mac", "dv_categ.mac";

PRIVATE CONST Строка_Итого                = 0,
              Строка_СтрокаДанных         = 1;

PRIVATE CONST CL_STATE_RES    = "резидент",
              CL_STATE_NOTRES = "нерезидент";

PRIVATE VAR IsExistData;

PRIVATE CONST ItogsLineName = "Всего:";              

PRIVATE CLASS (TX_RegistrReport) NPTXShort_Report()
  VAR m_BeginDate, m_PrSRub, m_AllSRub, m_AllSrub_l, m_ComBankS, m_ComExcS, m_PrBRub,
      m_AllBrub, m_AllBrub_l, m_MaterialB, m_TaxMaterialB, m_ComBankB, m_ComExcB, m_TaxFRlink, m_TaxTags,
      m_TaxFR_total, m_TaxFR_market, m_TaxFR_OTC, m_TaxFR_Open, m_ComDepo, m_CoupRubS,
      m_BaseMaterial, m_BaseSpecial, m_BaseSpecialDiv, m_DivPaySec, m_DivPaySec_1, m_BaseGeneral, m_TaxRateGeneral, m_TaxDueNow, m_BM, m_PM, m_PS, m_PD,
      m_PG,m_SumOutNow, m_SheetName, m_query, m_count, m_Qnty, m_FRrub, m_TaxLink, m_BaseDiv, m_BaseBill, m_PaidBill, m_Base0, m_DivPay_Sec, m_MinusG_618, m_Limit_618, m_Plusi, m_FR_Sec_3Y,
      m_BK, m_PK, m_DivPay_Sec_0, m_PaidGeneral_0, m_PaidSpecial_0, m_Paid35_0, m_PG0, m_PS0, m_PD0, m_PK0;

  VAR m_CurrInvestorSheetName, m_CurrInvestor, m_CurrInvestorName, m_CurrIIS;
  

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport()
    CreateTotalBook();    
    DL_CallInsertStat(PrintMode()); 
  END;
  
  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO CorrectSheetName(SheetName:string)
    return substr(SheetName, 1, 31);
  END;


  //РЕПО
  PRIVATE MACRO CreateRepoRep()
    var Sum_Qnty        = 0;
    var Sum_Tot1vp      = $0;
    var Sum_DohRub      = $0;
    var Sum_RashRub     = $0;
    var Sum_TaxPashRub  = $0;
    var Sum_Com         = $0;
    var Sum_CoupCalcVn  = $0;
    var Sum_AmortCalcVn = $0;
    var Sum_GenRub  = $0; 
    var Sum_Deal2vp  = $0;
    var Sum_Tot2vp  = $0;
    var MaxSumPrecision = 0;
    var cnt = 0, i = 0;
   
    var SheetName = "РЕПО";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);
    
    var AvrFIID = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRCODE );
    var AvrKind = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRKIND );
    var Year; DateSplit( m_EndDate, null, null, Year );

    var RepData = NPTX_RepoReg_Data(Year,
                                    date(m_BeginDate), 
                                    date(m_EndDate),
                                    m_CurrInvestor, 
                                    m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRCODE), 
                                    m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRKIND), 
                                    0, 
                                    1/*REPOREG_DEALSTATUS_CLOSE*/,
                                    m_CurrIIS);
    cnt = RepData.GetCount();
    if(cnt > 0)
      this.SetCurrentLineFont( 8, false, false );


      UseNewSheetInTotalBook();
      SetActiveSheet( SheetName );

      PrintFormatString( NULL,
                         "N3_Dbeg",   date(m_BeginDate),  //за период с
                         "N3_Dend",   this.Dend(),        //по
                         "N3_Client", this.ClientName()   // Клиент
                        );
      CopyAllSheetInTotalBook(SheetName, false, "N3_ReportHeader", 0, CurrSheetName);

      CopyAllSheetInTotalBook(SheetName, false, "N3_TableHeader", 0, CurrSheetName);
      RegisterTable( "N3_MainTable", NULL,
           /*1  */   "N3_SecCode",   
           /*2  */   "N3_SecName",   
           /*3  */   "N3_CodeR",     
           /*4  */   "N3_DZ",        
           /*5  */   "N3_Qnty",      
           /*6  */   "N3_Dir1",      
           /*7  */   "N3_DD1",       
           /*8  */   "N3_DP1",       
           /*9  */   "N3_Tot1vp",    
           /*10 */   "N3_Rate",      
           /*11 */   "N3_Dir2",      
           /*12 */   "N3_DD2",       
           /*13 */   "N3_DP2",       
           /*14 */   "N3_Deal2vp",   
           /*15 */   "N3_Tot2vp",    
           /*16 */   "N3_DohRub",    
           /*17 */   "N3_RashRub",   
           /*18 */   "N3_TaxPashRub",
           /*19 */   "N3_GenRub",
           /*20 */   "N3_Com",       
           /*21 */   "N3_CoupCalcVn",
           /*22 */   "N3_AmortCalcVn"
           );

      InitProgress( cnt, CurrSheetName, CurrSheetName );

      while(RepData.GetNext())

        PrintTableLine("N3_SecCode",       RepData.SecCode(),         null,               //1
                       "N3_SecName",       RepData.SecName(),         null,               //2
                       "N3_CodeR",         RepData.CodeR(),           null,               //3
                       "N3_DZ",            RepData.DZ(),              null,               //4
                       "N3_Qnty",          RepData.Qnty(),            SetPrecisionByFractPart(RepData.Qnty(), RepData.QntyPrecision(), 0),  //5
                       "N3_Dir1",          RepData.Dir1(),            null,               //6
                       "N3_DD1",           RepData.DD1(),             null,               //7
                       "N3_DP1",           RepData.DP1(),             null,               //8
                       "N3_Tot1vp",        RepData.Tot1vp(),          null,               //9
                       "N3_Rate",          ЧислоCЗаданнойТочностью(RepData.Rate()*100.0,RepData.Point())+"%", null,    //10       
                       "N3_Dir2",          RepData.Dir2(),            null,               //11
                       "N3_DD2",           RepData.DD2(),             null,               //12
                       "N3_DP2",           RepData.DP2(),             null,               //13
                       "N3_Deal2vp",       RepData.Deal2vp(),         null,               //14
                       "N3_Tot2vp",        RepData.Tot2vp(),          null,               //15
                       "N3_DohRub",        RepData.DohRub(),          null,               //16
                       "N3_RashRub",      - RepData.RashRub(),         null,               //17
                       "N3_TaxPashRub",   - RepData.TaxPashRub(),      null,               //18
                       "N3_GenRub",        RepData.GenRub(),          null,               //19
                       "N3_Com",           RepData.Com(),             null,               //20
                       "N3_CoupCalcVn",    RepData.CoupCalcVn(),      null,               //21
                       "N3_AmortCalcVn",   RepData.AmortCalcVn(),     null                //22
                     );

        Sum_Qnty         = Sum_Qnty        + RepData.Qnty();
        Sum_Tot1vp       = Sum_Tot1vp      + RepData.Tot1vp();
	Sum_Deal2vp     = Sum_Deal2vp	+RepData.Deal2vp();
	Sum_Tot2vp      = Sum_Tot2vp	+ 	RepData.Tot2vp();
        Sum_DohRub       = Sum_DohRub      + RepData.DohRub();     
        Sum_RashRub      = Sum_RashRub     - RepData.RashRub();    
        Sum_TaxPashRub   = Sum_TaxPashRub  - RepData.TaxPashRub();
	Sum_GenRub	 = Sum_GenRub	+ RepData.GenRub(); 
        Sum_Com          = Sum_Com         + RepData.Com();        
        Sum_CoupCalcVn   = Sum_CoupCalcVn  + RepData.CoupCalcVn(); 
        Sum_AmortCalcVn  = Sum_AmortCalcVn + RepData.AmortCalcVn();

        if(MaxSumPrecision < RepData.QntyPrecision())
          MaxSumPrecision = RepData.QntyPrecision();
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      SetCurrentLineFont( 10, true, false );
      PrintTableLine( "N3_SecCode",     ItogsLineName,   null, 
            /*5  */   "N3_Qnty",        Sum_Qnty,        SetPrecisionByFractPart(Sum_Qnty, MaxSumPrecision, 0),           
            /*9  */   "N3_Tot1vp",      Sum_Tot1vp,      null,
            /*14 */   "N3_Deal2vp",     Sum_Deal2vp,	 null,
            /*15 */   "N3_Tot2vp",      Sum_Tot2vp,	 null,
            /*16 */   "N3_DohRub",      Sum_DohRub,      null,
            /*17 */   "N3_RashRub",     Sum_RashRub,     null,
            /*18 */   "N3_TaxPashRub",  Sum_TaxPashRub,  null,
            /*19 */   "N3_GenRub",      Sum_GenRub,      null, 
            /*20 */   "N3_Com",         Sum_Com,         null,
            /*21 */   "N3_CoupCalcVn",  Sum_CoupCalcVn,  null,
            /*22 */   "N3_AmortCalcVn", Sum_AmortCalcVn, null
                     ); 


      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
    end;
  END; 

          
  PRIVATE MACRO ПечататьСтрокуТаблицыРК(Pref)
    var v_IsRET_PARTLY = IsRET_PARTLY( Int(m_RS.SaleGroup) );
    var v_IsRET_COUPON = IsRET_COUPON( Int(m_RS.SaleGroup) );
                                                
    PrintTableLine( Pref+"_SecCode",          this.SecCode(),      null,      /*1  */
                    Pref+"_SecName",          this.SecName(),      null,      /*2  */
                    Pref+"_Qnty",             this.Qnty(),         null,      /*3  */
                    Pref+"_CodeS",            this.CodeS(),        null,      /*4  */
                    Pref+"_DZS",              this.DZS(),          null,      /*5  */
                    Pref+"_DPS",              this.DPS(),          null,      /*6  */
                    Pref+"_PrSrub",           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.PrSrub()), IIF( v_IsRET_COUPON or v_IsRET_PARTLY, null,  m_RS.SPoint),      /*7  */
                    Pref+"_AllSrub",          this.AllSrub(),      null,      /*8  */
                    Pref+"_DifS",             IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DifS()),         null,      /*9  */
                    Pref+"_ComBankS",         this.ComBankS(),     null,      /*10 */
                    Pref+"_ComExcS",          this.ComExcS(),      null,      /*11 */
                    Pref+"_ComS",             IIF(v_IsRET_COUPON and(m_Rs.CouponNDFL != SET_CHAR), "", this.ComS()),         null,      /*12 */
                    Pref+"_CodeB",            IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.CodeB()),        null,      /*13 */
                    Pref+"_DZB",              IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DZB()),          null,      /*14 */
                    Pref+"_DPB",              IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DPB()),          null,      /*15 */
                    Pref+"_PrBrub",           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.PrBrub()),       IIF(v_IsRET_COUPON or v_IsRET_PARTLY, null, m_RS.BPoint),      /*16 */
                    Pref+"_AllBrub",          IIF(v_IsRET_COUPON, "", this.AllBrub()),      null,      /*17 */
                    Pref+"_MaterialB",        IIF(v_IsRET_COUPON, "", this.MaterialB()),    null,      /*18 */
                    Pref+"_TaxMaterialB",     IIF(v_IsRET_COUPON, "", this.TaxMaterialB()), null,      /*19 */
                    Pref+"_DifB",             IIF(v_IsRET_COUPON, "", this.DifB()),         null,      /*20 */
                    Pref+"_ComBankB",         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComBankB()),     null,      /*21 */
                    Pref+"_ComExcB",          IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComExcB()),      null,      /*22 */
                    Pref+"_ComB",             IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComB()),         null,      /*23 */
                    Pref+"_TaxFRlink",        this.TaxFRlink(),    null,      /*24 */
                    Pref+"_SecType",          this.SecType(),      null,      /*25 */
                    Pref+"_TaxTags",          this.TaxTags(),      null,      /*26 */
                    Pref+"_AA",               "",      null       /*27 */
        
                   );       

      
  END;

  //Короткие позиции
  PRIVATE MACRO CreateShortPosRep()
    var query, DataSet, cmd;
    var SheetName = "Короткие позиции";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);
    var cnt = 0, i = 0;
    var Sum_Qnty= $0;
    var Sum_AllSrub = $0;
    var Sum_DifS = $0;
    var Sum_ComBankS = $0;
    var Sum_ComExcS =  $0;
    var Sum_ComS =  $0;
    var Sum_AllBrub = $0;
    var Sum_MaterialB = $0;
    var Sum_TaxMaterialB = $0;
    var Sum_DifB  = $0;
    var Sum_ComBankB =  $0;
    var Sum_ComExcB = $0;
    var Sum_ComB = $0;
    var Sum_TaxFRlink =$0;


    this.SetCurrentLineFont( 8, false, false );

    cmd = DL_RSDCommand();

    query  =  " select lnk.t_ID as LinkID, "
            + "        lnk.t_Amount as Qnty, "
            + "        lnk.t_PrivAmount as PrivQnty, "
            + "        lnk.t_Type AS LnkType, "
            + "        lnk.t_Client as t_PartyID, "
            + "        av.t_TaxGroup, "
            + "        FinInstr.t_FIID, "
            + "        FinInstr.t_FI_Code as AvrCode, "
            + "        FinInstr.t_Name as AvrName, "
            + "        FinInstr.t_FaceValueFI, " 
            + "        FinInstr.t_AvoirKind, "
            + "        FinInstr.t_DrawingDate, "
            + "        FinInstr.t_Issued, "
            + "        FinInstr.t_SumPrecision, "
            + "        DealSale.t_BOfficeKind  AS SBOfficeKind, "
 
            + "        RTRIM(DECODE(DealSale.t_DealCodeTS,CHR(1),DealSale.t_DealCode,DealSale.t_DealCodeTS)) AS DealSaleCodeTS, "/*выводится номер исходной сделки продажи, если в связи в позиции продажа - виртуальная сделка*/

            + "        salelot.t_DEALDATE AS DealSaleDate, "
            + "        salelot.t_DocKind as SaleDocKind, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then salelot_real.t_DealDate else salelot_real.t_SALEDATE end) AS SaleDate, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then LegS.t_Maturity when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then salelot.t_DealDate else salecdlrq.t_FactDate end) AS SalePayDate, "
            + "        (case when salebdlrq.t_FactDate = "+GetSQLDate(date(0,0,0))+" then salebdlrq.t_Amount else lnk.t_Amount end) as t_Amount, "
            + "        salelot.t_PriceFIID AS ValS, "
            + "        salelot.t_Price AS SalePrice, "
            + "        LegS.t_LegKind AS LegKindSale, "
            + "        LegS.t_Principal AS SPrincipal, "
            + "        LegS.t_Point As SPoint, "

            + "        (case when DealSale.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_PriceFIID else salecdlrq.t_FIID end) as VpS, "
            + "        DealSale.t_DealID as DealSaleID, " 

            + "        DealBuy.t_DealID as DealBuyID, "
            + "        buylot.t_DEALCODE AS DealBuyCodeTS, "
            + "        buylot.t_DealDate as DealBuyDate, "
            + "        buylot.t_BuyDate, "
            + "        buylot.t_Price as BuyPrice, "
            + "        buylot.t_PriceFIID as ValB, "
            + "        LegB.t_Principal AS BPrincipal, "
            + "        LegB.t_LegKind AS LegKindBuy, "
            + "        LegB.t_Point As BPoint, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_RETIREMENT+" then buylot.t_DealDate else buylot.t_BuyDate end) AS BuyDate, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_PriceFIID else buycdlrq.t_FIID end) as VpB, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" then buylot.t_DealDate else buycdlrq.t_FactDate end) as PayBuyDate, "
            + "        DealBuy.t_BOfficeKind AS BBOfficeKind, "

            + "        npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

            + "        (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end) as TaxGroupType, "          

            + "        to_char(NPTO.IfMarket(FinInstr.t_FIID,salelot.t_DEALDATE)) SIfMarket, "
            
            + "        to_char(DECODE(buylot.t_DEALCODETS,chr(1),chr(1),NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DEALDATE))) BIfMarket, "
            + "        rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind)) as SaleGroup, "
            + "        NPTX.IsVirtual(salelot.t_Type) SaleIsVirtual, "
            + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
            + "        DealSale.t_CouponNDFL, "
            + "        DealSale.t_Number_Partly, "
            + "        DealSale.t_Number_Coupon, "
            + "        buylot.t_Contract "

            + "   from dnptxlnk_dbt  lnk, "
            + "        dnptxlot_dbt  buylot, "
            + "        dnptxlot_dbt  salelot, "
            + "        DDL_TICK_DBT  DealSale," 
            + "        DDL_TICK_DBT  DealBuy," 
            + "        DFININSTR_DBT FinInstr, "  
            + "        DAVOIRISS_DBT av, " 
            + "        ddl_leg_dbt   LegS, "  
            + "        ddl_leg_dbt   LegB, " 
            + "        ddlrq_dbt   salebdlrq, "
            + "        ddlrq_dbt   salecdlrq, "// оплата продажи
            + "        ddlrq_dbt   buycdlrq, " // оплата покупки

            + "        dnptxlot_dbt buylot_real, "
            + "        dnptxlot_dbt salelot_real "
            
            + "  where lnk.t_Type = ? /*1*/ "  
            + "    and salelot_real.t_ID = (case when NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_RealID else salelot.t_ID end ) " 
            + "    and buylot_real.t_ID = (case when NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_RealID else buylot.t_ID end ) "    
            + "    and lnk.t_date BETWEEN ? /*2*/ AND ? /*3*/ "
            + "    and lnk.t_Client = ? /*4*/ " 
            + "    and salelot.t_Origin NOT IN ( " + string( NPTXLOTORIGIN_GO ) + "," + string ( NPTXLOTORIGIN_IN) +" ) "  
            + "    and salelot.t_ID = lnk.t_SaleID "
            + "    and buylot.t_ID = lnk.t_BuyID "
            + "    and salelot_real.t_DocID = DealSale.t_DealID " 
            + "    and buylot_real.t_DocID  = DealBuy.t_DealID "
            + "    and FinInstr.t_FIID = lnk.t_FIID " 
            + "    and av.t_FIID = lnk.t_FIID " 
            + "    and LegS.t_DealID    = DealSale.t_DealID " 
            + "    and LegS.t_LegKind   = (case when salelot.t_Kind = "+NPTXLOTS_BACKREPO+" then 2 else 0 end) " 
            + "    and LegS.t_LegID     = 0 " 
            + "    and LegB.t_DealID    = DealBuy.t_DealID " 
            + "    and LegB.t_LegKind   = (case when buylot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
            + "    and LegB.t_LegID     = 0 "
            + "    and salebdlrq.t_ID = salelot_real.t_RQID "
            + "    and salecdlrq.t_DocID(+) = salelot_real.t_DocID "
            + "    and salecdlrq.t_DocKind(+) = salelot_real.t_DocKind "
            + "    and salecdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and salecdlrq.t_Factdate <= ? /*5*/ " 
            + "    and salecdlrq.t_DealPart(+) =  1 " 
            + "    and RSI_NPTO.CheckContrIIS(buylot.t_Contract) = " + string(m_CurrIIS)
            + "    and 1 = ( case when DealSale.t_BOfficeKind <> "+DL_RETIREMENT+" and DealSale.t_BOfficeKind <> "+DL_AVRWRT+" and (salebdlrq.t_FactDate <= ? /*6*/) then 1"
            + "                   when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then 1 "
            + "                   when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then 1 "
            + "                   else 0 end)"
            + "    and buycdlrq.t_DocID(+) = buylot_real.t_DocID "
            + "    and buycdlrq.t_DocKind(+) = buylot_real.t_DocKind "
            + "    and buycdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and buycdlrq.t_DealPart(+) = 1 ";

    cmd.AddParam(NPTXLNK_CLPOS);    /*1*/
    cmd.AddParam(m_BeginDate);      /*2*/
    cmd.AddParam(m_EndDate);        /*3*/
    cmd.AddParam(m_CurrInvestor);   /*4*/
    cmd.AddParam(m_EndDate);        /*5*/
    cmd.AddParam(m_EndDate);        /*6*/
    
    var AvrFIID = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRCODE );
    if( (AvrFIID != null) AND (AvrFIID > 0 ) ) /*задана бумага*/
       query = query + " and lnk.t_FIID = ? ";
       cmd.AddParam(AvrFIID);
    else
       var AvrKind  = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRKIND );
       if( (AvrKind != null) AND (AvrKind > 0 ) ) /*задан вид бумаги*/
         query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
         cmd.AddParam(AvrKind);
       end;
    end;

    cnt = cmd.GetCount(query);

    if(cnt > 0)
      m_Rs = cmd.Execute(query);

      UseNewSheetInTotalBook();
      SetActiveSheet( SheetName );

      PrintFormatString( NULL,
                         "N4_Dbeg",   date(m_BeginDate),  //за период с
                         "N4_Dend",   this.Dend(),        //по
                         "N4_Client", this.ClientName()   // Клиент
                        );
      CopyAllSheetInTotalBook(SheetName, false, "N4_ReportHeader", 0, CurrSheetName);

      CopyAllSheetInTotalBook(SheetName, false, "N4_TableHeader", 0, CurrSheetName);
      RegisterTable( "N4_MainTable", NULL,
           /*1  */   "N4_SecCode",     
           /*2  */   "N4_SecName",     
           /*3  */   "N4_Qnty",        
           /*4  */   "N4_CodeS",       
           /*5  */   "N4_DZS",         
           /*6  */   "N4_DPS",         
           /*7  */   "N4_PrSrub",      
           /*8  */   "N4_AllSrub",     
           /*9  */   "N4_DifS",        
           /*10 */   "N4_ComBankS",    
           /*11 */   "N4_ComExcS",     
           /*12 */   "N4_ComS",        
           /*13 */   "N4_CodeB",       
           /*14 */   "N4_DZB",         
           /*15 */   "N4_DPB",         
           /*16 */   "N4_PrBrub",      
           /*17 */   "N4_AllBrub",     
           /*18 */   "N4_MaterialB",   
           /*19 */   "N4_TaxMaterialB",
           /*20 */   "N4_DifB",        
           /*21 */   "N4_ComBankB",    
           /*22 */   "N4_ComExcB",     
           /*23 */   "N4_ComB",        
           /*24 */   "N4_TaxFRlink",   
           /*25 */   "N4_SecType",     
           /*26 */   "N4_TaxTags",     
           /*27 */   "N4_AA"      
           );

      InitProgress( cnt, CurrSheetName, CurrSheetName );
      while(m_Rs.moveNext())
          
        this.ClearCacheOneRecord();
        ПечататьСтрокуТаблицыРК("N4");

        Sum_Qnty         = Sum_Qnty         + this.Qnty();
        Sum_AllSrub      = Sum_AllSrub      + this.AllSrub();
        Sum_DifS         = Sum_DifS         + this.DifS();
        Sum_ComBankS     = Sum_ComBankS     + this.ComBankS();
        Sum_ComExcS      = Sum_ComExcS      + this.ComExcS();
        Sum_ComS         = Sum_ComS         + this.ComS();
        Sum_AllBrub      = Sum_AllBrub      + this.AllBrub();
        Sum_MaterialB    = Sum_MaterialB    + this.MaterialB();
        Sum_TaxMaterialB = Sum_TaxMaterialB + this.TaxMaterialB();
        Sum_DifB         = Sum_DifB         + this.DifB();
        Sum_ComBankB     = Sum_ComBankB     + this.ComBankB();
        Sum_ComExcB      = Sum_ComExcB      + this.ComExcB();
        Sum_ComB         = Sum_ComB         + this.ComB();
        Sum_TaxFRlink    = Sum_TaxFRlink    + this.TaxFRlink();

        UseProgress(i = i + 1);

      end;
      RemProgress();


      SetCurrentLineFont( 10, true, false );
      PrintTableLine( "N4_SecCode",      ItogsLineName,    null,           
            /*3  */   "N4_Qnty",         Sum_Qnty,         null,
            /*8  */   "N4_AllSrub",      Sum_AllSrub,      null,
            /*9  */   "N4_DifS",         Sum_DifS,         null,
            /*10 */   "N4_ComBankS",     Sum_ComBankS,     null,
            /*11 */   "N4_ComExcS",      Sum_ComExcS,      null,
            /*12 */   "N4_ComS",         Sum_ComS,         null,
            /*17 */   "N4_AllBrub",      Sum_AllBrub,      null,
            /*18 */   "N4_MaterialB",    Sum_MaterialB,    null,
            /*19 */   "N4_TaxMaterialB", Sum_TaxMaterialB, null,
            /*20 */   "N4_DifB",         Sum_DifB,         null,
            /*21 */   "N4_ComBankB",     Sum_ComBankB,     null,
            /*22 */   "N4_ComExcB",      Sum_ComExcB,      null,
            /*23 */   "N4_ComB",         Sum_ComB,         null,
            /*24 */   "N4_TaxFRlink",    Sum_TaxFRlink,    null
                     ); 

      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
    end;

  END;

  //Реализация
  PRIVATE MACRO CreateRealizRep()
    var query, DataSet, cmd;
    var SheetName = "Реализация";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);
    var cnt = 0, i = 0;
    var Sum_Qnty= $0;
    var Sum_AllSrub = $0;
    var Sum_DifS = $0;
    var Sum_ComBankS = $0;
    var Sum_ComExcS =  $0;
    var Sum_ComS =  $0;
    var Sum_AllBrub = $0;
    var Sum_MaterialB = $0;
    var Sum_TaxMaterialB = $0;
    var Sum_DifB  = $0;
    var Sum_ComBankB =  $0;
    var Sum_ComExcB = $0;
    var Sum_ComB = $0;
    var Sum_TaxFRlink =$0;                                                                     


    var AvrFIID = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRCODE );
    var AvrKind = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRKIND );

    this.SetCurrentLineFont( 8, false, false );

    cmd = DL_RSDCommand();

    query  =  " select lnk.t_ID as LinkID, "
            + "        lnk.t_Amount as Qnty, "
            + "        lnk.t_PrivAmount as PrivQnty, "
            + "        lnk.t_Type AS LnkType, "
            + "        lnk.t_Client as t_PartyID, "
            + "        av.t_TaxGroup, "
            + "        FinInstr.t_FIID, "
            + "        FinInstr.t_FI_Code as AvrCode, "
            + "        FinInstr.t_Name as AvrName, "
            + "        FinInstr.t_FaceValueFI, " 
            + "        FinInstr.t_AvoirKind, "
            + "        FinInstr.t_DrawingDate, "
            + "        FinInstr.t_Issued, "
            + "        FinInstr.t_SumPrecision, "
            + "        DealSale.t_BOfficeKind  AS SBOfficeKind, "
 
            + "        salelot.t_DEALCODE AS DealSaleCodeTS, "
            + "        salelot.t_DEALDATE AS DealSaleDate, "
            + "        salelot.t_DocKind as SaleDocKind, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then salelot.t_DealDate else salelot.t_SALEDATE end) AS SaleDate, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then LegS.t_Maturity when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then salelot.t_DealDate else salecdlrq.t_FactDate end) AS SalePayDate, "
            + "        (case when salebdlrq.t_FactDate = "+GetSQLDate(date(0,0,0))+" then salebdlrq.t_Amount else lnk.t_Amount end) as t_Amount, "
            + "        salelot.t_PriceFIID AS ValS, "
            + "        salelot.t_Price AS SalePrice, "
            + "        LegS.t_LegKind AS LegKindSale, "
            + "        LegS.t_Principal AS SPrincipal, "
            + "        LegS.t_Point As SPoint, "

            + "        (case when DealSale.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_PriceFIID else salecdlrq.t_FIID end) as VpS, "
            + "        DealSale.t_DealID as DealSaleID, " 

            + "        DealBuy.t_DealID as DealBuyID, "
            + "        buylot.t_DEALCODE AS DealBuyCodeTS, "
            + "        buylot.t_DealDate as DealBuyDate, "
            + "        buylot.t_BuyDate, "
            + "        buylot.t_Price as BuyPrice, "
            + "        buylot.t_PriceFIID as ValB, "
            + "        LegB.t_Principal AS BPrincipal, "
            + "        LegB.t_LegKind AS LegKindBuy, "
            + "        LegB.t_Point As BPoint, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_RETIREMENT+" then buylot.t_DealDate else buylot.t_BuyDate end) AS BuyDate, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_PriceFIID else buycdlrq.t_FIID end) as VpB, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" then buylot.t_DealDate else buycdlrq.t_FactDate end) as PayBuyDate, "
            + "        DealBuy.t_BOfficeKind AS BBOfficeKind, "

            + "        npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

            + "        (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end) as TaxGroupType, "          

            + "        to_char(NPTO.IfMarket(FinInstr.t_FIID,salelot.t_DEALDATE)) SIfMarket, "
            
            + "        to_char(DECODE(buylot.t_DEALCODETS,chr(1),chr(1),NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DEALDATE))) BIfMarket, "
            + "        rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind)) as SaleGroup, "
            + "        NPTX.IsVirtual(salelot.t_Type) SaleIsVirtual, "
            + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
            + "        DealSale.t_CouponNDFL, "
            + "        DealSale.t_Number_Partly, "
            + "        DealSale.t_Number_Coupon, "
            + "        buylot.t_Contract Contract, "
            + "        salelot.t_saleDate AS SaleDateOVVZ, "
            + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(FinInstr.t_FIID, salelot.t_DEALDATE ), 0.0) NominalAVROnS, "
            + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(FinInstr.t_FIID, buylot.t_DealDate ), 0.0) NominalAVROnB, "
            + "        NVL(rsb_fiinstr.ConvSum(1, FinInstr.t_FaceValueFI, " + string(NATCUR) + ", salelot.t_saleDate ), 0.0) SCourseNominal, " //??
            + "        NVL(rsb_fiinstr.ConvSum(1, FinInstr.t_FaceValueFI, " + string(NATCUR) + ", buylot.t_DealDate ), 0.0) BCourseNominal "  //??
  
            + "   from dnptxlnk_dbt  lnk, "
            + "        dnptxlot_dbt  buylot, "
            + "        dnptxlot_dbt  salelot, "
            + "        DDL_TICK_DBT  DealSale," 
            + "        DDL_TICK_DBT  DealBuy," 
            + "        DFININSTR_DBT FinInstr, "  
            + "        DAVOIRISS_DBT av, " 
            + "        ddl_leg_dbt   LegS, "  
            + "        ddl_leg_dbt   LegB, " 
            + "        ddlrq_dbt   salebdlrq, "
            + "        ddlrq_dbt   salecdlrq, "// оплата продажи
            + "        ddlrq_dbt   buycdlrq, " // оплата покупки

            + "        dnptxlot_dbt buylot_real, "
            + "        dnptxlot_dbt salelot_real "
            
            + "  where lnk.t_Type = ? /*1*/ "  
            + "    and salelot_real.t_ID = (case when NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_RealID else salelot.t_ID end ) " 
            + "    and buylot_real.t_ID = (case when NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_RealID else buylot.t_ID end ) "    
            + "    and lnk.t_date BETWEEN ? /*2*/ AND ? /*3*/ "
            + "    and lnk.t_Client = ? /*4*/ " 
            + "    and salelot.t_Origin NOT IN ( " + string( NPTXLOTORIGIN_GO ) + "," + string ( NPTXLOTORIGIN_IN) +" ) "  
            + "    and salelot.t_ID = lnk.t_SaleID "
            + "    and buylot.t_ID = lnk.t_BuyID "
            + "    and salelot_real.t_DocID = DealSale.t_DealID " 
            + "    and buylot_real.t_DocID  = DealBuy.t_DealID "
            + "    and FinInstr.t_FIID = lnk.t_FIID " 
            + "    and av.t_FIID = lnk.t_FIID " 
            + "    and LegS.t_DealID    = DealSale.t_DealID " 
            + "    and LegS.t_LegKind   = (case when salelot.t_Kind = "+NPTXLOTS_BACKREPO+" then 2 else 0 end) " 
            + "    and LegS.t_LegID     = 0 " 
            + "    and LegB.t_DealID    = DealBuy.t_DealID " 
            + "    and LegB.t_LegKind   = (case when buylot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
            + "    and LegB.t_LegID     = 0 "
            + "    and salebdlrq.t_ID = salelot_real.t_RQID "
            + "    and salecdlrq.t_DocID(+) = salelot_real.t_DocID "
            + "    and salecdlrq.t_DocKind(+) = salelot_real.t_DocKind "
            + "    and salecdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and salecdlrq.t_Factdate <= ? /*5*/ " 
            + "    and salecdlrq.t_DealPart(+) =  1 " 
            + "    and RSI_NPTO.CheckContrIIS(buylot.t_Contract) = " + string(m_CurrIIS)
            + "    and 1 = ( case when DealSale.t_BOfficeKind <> "+DL_RETIREMENT+" and DealSale.t_BOfficeKind <> "+DL_AVRWRT+" and (salebdlrq.t_FactDate <= ? /*6*/) then 1"
            + "                   when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then 1 "
            + "                   when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then 1 "
            + "                   else 0 end)"
            + "    and buycdlrq.t_DocID(+) = buylot_real.t_DocID "
            + "    and buycdlrq.t_DocKind(+) = buylot_real.t_DocKind "
            + "    and buycdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and buycdlrq.t_DealPart(+) = 1 ";

    cmd.AddParam(NPTXLNK_DELIVER);  /*1*/
    cmd.AddParam(m_BeginDate);      /*2*/
    cmd.AddParam(m_EndDate);        /*3*/
    cmd.AddParam(m_CurrInvestor);   /*4*/
    cmd.AddParam(m_EndDate);        /*5*/
    cmd.AddParam(m_EndDate);        /*6*/
    
    
    if( (AvrFIID != null) AND (AvrFIID > 0 ) ) /*задана бумага*/
       query = query + " and lnk.t_FIID = ? ";
       cmd.AddParam(AvrFIID);
    else
       if( (AvrKind != null) AND (AvrKind > 0 ) ) /*задан вид бумаги*/
         query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
         cmd.AddParam(AvrKind);
       end;
    end;

    query = query + " UNION ALL " 
                  + " SELECT 0 AS LinkID, " 
                  + "    leg.t_Principal AS Qnty,  " 
                  + "    0 AS PrivQnty,  " 
                  + "    0 AS LnkType, "
                  + "    client.t_partyID, "
                  + "    0 AS t_TaxGroup, FinInstr.t_FIID, "
                  + "    FinInstr.t_FI_Code AS AvrCode, FinInstr.t_Name AS AvrName, "
                  + "    FinInstr.t_FaceValueFI, FinInstr.t_AvoirKind, "
                  + "    FinInstr.t_DrawingDate, FinInstr.t_Issued, "
                  + "    FinInstr.t_SumPrecision,  tick.t_BOfficeKind AS SBOfficeKind,"
                  + "    tick.t_DealCode AS DealSaleCodeTS, "
                  + "    tick.t_DEALDATE AS DealSaleDate, "
                  + "    tick.t_BofficeKind as SaleDocKind, "
                  + "    tick.t_DEALDATE AS SaleDate, "
                  + "    Leg.t_Maturity AS SalePayDate,   leg.t_principal AS Amount, "
                  + "    0 AS ValS,                        leg.t_TotalCost AS SalePrice, "
                  + "    0 AS LegKindSale, 0 AS SPoint, "
                  + "    Leg.t_Principal AS SPrincipal,    Leg.t_CFI AS VpS, "
                  + "    tick.t_DealID AS DealSaleID,      0 AS DealBuyID, "
                  + "    NULL AS DealBuyCodeTS,            NULL AS DealBuyDate, "
                  + "    NULL AS t_BuyDate,                0 AS BuyPrice, "
                  + "    0 AS ValB,                        "
                  + "    0 AS BPrincipal,                  0 AS LegKindBuy, 0 AS BPoint, "
                  + "    NULL AS BuyDate,                  0 AS VpB, "
                  + "    NULL AS PayBuyDate,               tick.t_BofficeKind AS BBOfficeKind, "
                  + "    npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

                  + "    (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end)  AS TaxGroupType, "  
                  + "    TO_CHAR (NPTO.IfMarket (FinInstr.t_FIID, tick.t_DEALDATE)) SIfMarket, " 
                  + "    '' AS BIfMarket, "
                  + "    rsb_secur.get_OperationGroup ( rsb_secur.get_OperSysTypes (tick.t_DealType, tick.t_BofficeKind)) AS SaleGroup, "
                  + "    0 SaleIsVirtual, "
                  + "    0 BuyIsVirtual, "
                  + "    tick.t_CouponNDFL, "
                  + "    tick.t_Number_Partly, "
                  + "    tick.t_Number_Coupon, "
                  + "    tick.t_ClientContrID Contract, "
                  + "    TO_DATE('01.01.0001','DD.MM.YYYY') SaleDateOVVZ, "
                  + "    1 AS NominalAVROnS, "
                  + "    1 AS NominalAVROnB, "
                  + "    0 AS SCourseNominal, " 
                  + "    0 AS BCourseNominal " 


                  + " FROM ddl_tick_dbt tick, DFININSTR_DBT FinInstr, ddl_leg_dbt leg, dparty_dbt client"
                  + "   WHERE tick.t_BofficeKind = " + DL_RETIREMENT
                  + "     AND tick.t_ClientID = ? /*9*/"
                  + "     AND FinInstr.t_FIID = tick.t_PFI "
                  + "     AND t_DealDate BETWEEN ? /*10*/ AND ? /*11*/" 
                  + "     AND leg.t_DealID = tick.t_DealID "
                  + "     AND client.t_PartyID = TICK.T_CLIENTID "
                  + "     AND tick.t_DealStatus in (" +DL_READIED + ", "+ DL_CLOSED + ")" 
                  + "     AND RSI_NPTO.CheckContrIIS(tick.t_ClientContrID) = " + string(m_CurrIIS)
                  + "     AND ((rsb_secur.IsRet_Coupon (rsb_secur.get_OperationGroup ( rsb_secur.get_OperSysTypes (tick.t_DealType, tick.t_BofficeKind))) = 1) " 
                  + "           OR (rsb_secur.IsRet_Partly (rsb_secur.get_OperationGroup ( rsb_secur.get_OperSysTypes (tick.t_DealType, tick.t_BofficeKind)))=1))";

    cmd.AddParam(m_CurrInvestor); /*9*/ 
    cmd.AddParam(m_BeginDate);    /*10*/
    cmd.AddParam(m_EndDate);      /*11*/

    if( (AvrFIID != null) AND (AvrFIID > 0 ) ) /*задана бумага*/
      query = query + " and tick.t_PFI = ? ";
      cmd.AddParam(AvrFIID);
    else
      if( (AvrKind != null) AND (AvrKind > 0 ) ) /*задан вид бумаги*/
        query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
        cmd.AddParam(AvrKind);
      end;
    end;

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      m_Rs = cmd.Execute(query);

      UseNewSheetInTotalBook();
      SetActiveSheet( SheetName );

      PrintFormatString( NULL,
                         "N2_Dbeg",   date(m_BeginDate),  //за период с
                         "N2_Dend",   this.Dend(),        //по
                         "N2_Client", this.ClientName()   // Клиент
                        );
      CopyAllSheetInTotalBook(SheetName, false, "N2_ReportHeader", 0, CurrSheetName);

      CopyAllSheetInTotalBook(SheetName, false, "N2_TableHeader", 0, CurrSheetName);
      RegisterTable( "N2_MainTable", NULL,
           /*1  */   "N2_SecCode",     
           /*2  */   "N2_SecName",     
           /*3  */   "N2_Qnty",        
           /*4  */   "N2_CodeS",       
           /*5  */   "N2_DZS",         
           /*6  */   "N2_DPS",         
           /*7  */   "N2_PrSrub",      
           /*8  */   "N2_AllSrub",     
           /*9  */   "N2_DifS",        
           /*10 */   "N2_ComBankS",    
           /*11 */   "N2_ComExcS",     
           /*12 */   "N2_ComS",        
           /*13 */   "N2_CodeB",       
           /*14 */   "N2_DZB",         
           /*15 */   "N2_DPB",         
           /*16 */   "N2_PrBrub",      
           /*17 */   "N2_AllBrub",     
           /*18 */   "N2_MaterialB",   
           /*19 */   "N2_TaxMaterialB",
           /*20 */   "N2_DifB",        
           /*21 */   "N2_ComBankB",    
           /*22 */   "N2_ComExcB",     
           /*23 */   "N2_ComB",        
           /*24 */   "N2_TaxFRlink",   
           /*25 */   "N2_SecType",     
           /*26 */   "N2_TaxTags",     
           /*27 */   "N2_AA"      
           );

      InitProgress( cnt, CurrSheetName, CurrSheetName );
      while(m_Rs.moveNext())
          
        this.ClearCacheOneRecord();
        ПечататьСтрокуТаблицыРК("N2");

        Sum_Qnty         = Sum_Qnty         + this.Qnty();
        Sum_AllSrub      = Sum_AllSrub      + this.AllSrub();
        Sum_DifS         = Sum_DifS         + this.DifS();
        Sum_ComBankS     = Sum_ComBankS     + this.ComBankS();
        Sum_ComExcS      = Sum_ComExcS      + this.ComExcS();
        Sum_ComS         = Sum_ComS         + this.ComS();
        Sum_AllBrub      = Sum_AllBrub      + this.AllBrub();
        Sum_MaterialB    = Sum_MaterialB    + this.MaterialB();
        Sum_TaxMaterialB = Sum_TaxMaterialB + this.TaxMaterialB();
        Sum_DifB         = Sum_DifB         + this.DifB();
        Sum_ComBankB     = Sum_ComBankB     + this.ComBankB();
        Sum_ComExcB      = Sum_ComExcB      + this.ComExcB();
        Sum_ComB         = Sum_ComB         + this.ComB();
        Sum_TaxFRlink    = Sum_TaxFRlink    + this.TaxFRlink();

        UseProgress(i = i + 1);

      end;

      RemProgress();

      SetCurrentLineFont( 10, true, false );
      PrintTableLine( "N2_SecCode",      ItogsLineName,    null,           
            /*3  */   "N2_Qnty",         Sum_Qnty,         null,
            /*8  */   "N2_AllSrub",      Sum_AllSrub,      null,
            /*9  */   "N2_DifS",         Sum_DifS,         null,
            /*10 */   "N2_ComBankS",     Sum_ComBankS,     null,
            /*11 */   "N2_ComExcS",      Sum_ComExcS,      null,
            /*12 */   "N2_ComS",         Sum_ComS,         null,
            /*17 */   "N2_AllBrub",      Sum_AllBrub,      null,
            /*18 */   "N2_MaterialB",    Sum_MaterialB,    null,
            /*19 */   "N2_TaxMaterialB", Sum_TaxMaterialB, null,
            /*20 */   "N2_DifB",         Sum_DifB,         null,
            /*21 */   "N2_ComBankB",     Sum_ComBankB,     null,
            /*22 */   "N2_ComExcB",      Sum_ComExcB,      null,
            /*23 */   "N2_ComB",         Sum_ComB,         null,
            /*24 */   "N2_TaxFRlink",    Sum_TaxFRlink,    null
                     ); 

      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
    end;

  END;

  MACRO GetFormulaSumFR(DataCount)
    return F("Q" + string(12 + DataCount));
  END;

  MACRO CerateInvestDedRep()
    var query, DataSet, cmd;
    var SheetName = "Инвестиционный вычет";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);
    var cnt = 0, i = 0;
    var Sum_Qnty= $0;
    var Sum_AllSrub = $0;
    var Sum_ComS =  $0;
    var Sum_AllBrub = $0;
    var Sum_ComB = $0;
    var SumFR = $0;

    var AvrFIID = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRCODE );
    var AvrKind = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRKIND );

    this.SetCurrentLineFont( 8, false, false );

    cmd = DL_RSDCommand();

    query  =  " select lnk.t_ID as LinkID, "
            + "        lnk.t_Amount as Qnty, "
            + "        lnk.t_PrivAmount as PrivQnty, "
            + "        lnk.t_Type AS LnkType, "
            + "        lnk.t_Client as t_PartyID, "
            + "        av.t_TaxGroup, "
            + "        FinInstr.t_FIID, "
            + "        FinInstr.t_FI_Code as AvrCode, "
            + "        FinInstr.t_Name as AvrName, "
            + "        FinInstr.t_FaceValueFI, " 
            + "        FinInstr.t_AvoirKind, "
            + "        FinInstr.t_DrawingDate, "
            + "        FinInstr.t_Issued, "
            + "        FinInstr.t_SumPrecision, "
            + "        DealSale.t_BOfficeKind  AS SBOfficeKind, "
 
            + "        salelot.t_DEALCODE AS DealSaleCodeTS, "
            + "        salelot.t_DEALDATE AS DealSaleDate, "
            + "        salelot.t_DocKind as SaleDocKind, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then salelot.t_DealDate else salelot.t_SALEDATE end) AS SaleDate, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then LegS.t_Maturity when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then salelot.t_DealDate else salecdlrq.t_FactDate end) AS SalePayDate, "
            + "        (case when salebdlrq.t_FactDate = "+GetSQLDate(date(0,0,0))+" then salebdlrq.t_Amount else lnk.t_Amount end) as t_Amount, "
            + "        salelot.t_PriceFIID AS ValS, "
            + "        salelot.t_Price AS SalePrice, "
            + "        LegS.t_LegKind AS LegKindSale, "
            + "        LegS.t_Principal AS SPrincipal, "
            + "        LegS.t_Point As SPoint, "

            + "        (case when DealSale.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_PriceFIID else salecdlrq.t_FIID end) as VpS, "
            + "        DealSale.t_DealID as DealSaleID, " 

            + "        DealBuy.t_DealID as DealBuyID, "
            + "        buylot.t_DEALCODE AS DealBuyCodeTS, "
            + "        buylot.t_DealDate as DealBuyDate, "
            + "        buylot.t_BuyDate, "
            + "        buylot.t_Price as BuyPrice, "
            + "        buylot.t_PriceFIID as ValB, "
            + "        LegB.t_Principal AS BPrincipal, "
            + "        LegB.t_LegKind AS LegKindBuy, "
            + "        LegB.t_Point As BPoint, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_RETIREMENT+" then buylot.t_DealDate else buylot.t_BuyDate end) AS BuyDate, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_PriceFIID else buycdlrq.t_FIID end) as VpB, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" then buylot.t_DealDate else buycdlrq.t_FactDate end) as PayBuyDate, "
            + "        DealBuy.t_BOfficeKind AS BBOfficeKind, "

            + "        npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

            + "        (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end) as TaxGroupType, "          

            + "        to_char(NPTO.IfMarket(FinInstr.t_FIID,salelot.t_DEALDATE)) SIfMarket, "
            
            + "        to_char(DECODE(buylot.t_DEALCODETS,chr(1),chr(1),NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DEALDATE))) BIfMarket, "
            + "        rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind)) as SaleGroup, "
            + "        NPTX.IsVirtual(salelot.t_Type) SaleIsVirtual, "
            + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
            + "        DealSale.t_CouponNDFL, "
            + "        DealSale.t_Number_Partly, "
            + "        DealSale.t_Number_Coupon, "
            + "        buylot.t_Contract Contract, "
            + "        extract(year from saleddlrq.t_FactDate) as t_DeliveryYearSale, "
            + "        extract(year from buyddlrq.t_FactDate) as t_DeliveryYearBuy"
  
            + "   from dnptxlnk_dbt  lnk, "
            + "        dnptxlot_dbt  buylot, "
            + "        dnptxlot_dbt  salelot, "
            + "        DDL_TICK_DBT  DealSale," 
            + "        DDL_TICK_DBT  DealBuy," 
            + "        DFININSTR_DBT FinInstr, "  
            + "        DAVOIRISS_DBT av, " 
            + "        ddl_leg_dbt   LegS, "  
            + "        ddl_leg_dbt   LegB, " 
            + "        ddlrq_dbt   salebdlrq, "
            + "        ddlrq_dbt   salecdlrq, "// оплата продажи
            + "        ddlrq_dbt   buycdlrq, " // оплата покупки
            + "        ddlrq_dbt   saleddlrq, "
            + "        ddlrq_dbt   buyddlrq, "

            + "        dnptxlot_dbt buylot_real, "
            + "        dnptxlot_dbt salelot_real "
            
            + "  where lnk.t_Type = ? /*1*/ "  
            + "    and salelot_real.t_ID = (case when NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_RealID else salelot.t_ID end ) " 
            + "    and buylot_real.t_ID = (case when NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_RealID else buylot.t_ID end ) "    
            + "    and lnk.t_date BETWEEN ? /*2*/ AND ? /*3*/ "
            + "    and lnk.t_Client = ? /*4*/ " 
            + "    and salelot.t_Origin NOT IN ( " + string( NPTXLOTORIGIN_GO ) + "," + string ( NPTXLOTORIGIN_IN) +" ) "  
            + "    and salelot.t_ID = lnk.t_SaleID "
            + "    and buylot.t_ID = lnk.t_BuyID "
            + "    and salelot_real.t_DocID = DealSale.t_DealID " 
            + "    and buylot_real.t_DocID  = DealBuy.t_DealID "
            + "    and FinInstr.t_FIID = lnk.t_FIID " 
            + "    and av.t_FIID = lnk.t_FIID " 
            + "    and LegS.t_DealID    = DealSale.t_DealID " 
            + "    and LegS.t_LegKind   = (case when salelot.t_Kind = "+NPTXLOTS_BACKREPO+" then 2 else 0 end) " 
            + "    and LegS.t_LegID     = 0 " 
            + "    and LegB.t_DealID    = DealBuy.t_DealID " 
            + "    and LegB.t_LegKind   = (case when buylot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
            + "    and LegB.t_LegID     = 0 "
            + "    and salebdlrq.t_ID = salelot_real.t_RQID "
            + "    and salecdlrq.t_DocID(+) = salelot_real.t_DocID "
            + "    and salecdlrq.t_DocKind(+) = salelot_real.t_DocKind "
            + "    and salecdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and salecdlrq.t_Factdate <= ? /*5*/ " 
            + "    and salecdlrq.t_DealPart(+) =  1 " 
            + "    and RSI_NPTO.CheckContrIIS(buylot.t_Contract) = " + string(m_CurrIIS)
            + "    and 1 = ( case when DealSale.t_BOfficeKind <> "+DL_RETIREMENT+" and DealSale.t_BOfficeKind <> "+DL_AVRWRT+" and (salebdlrq.t_FactDate <= ? /*6*/) then 1"
            + "                   when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then 1 "
            + "                   when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then 1 "
            + "                   else 0 end)"
            + "    and buycdlrq.t_DocID(+) = buylot_real.t_DocID "
            + "    and buycdlrq.t_DocKind(+) = buylot_real.t_DocKind "
            + "    and buycdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and buycdlrq.t_DealPart(+) = 1 "
            + "    and saleddlrq.t_DocID = salelot_real.t_DocID"
            + "    and saleddlrq.t_DocKind = salelot_real.t_DocKind"
            + "    and saleddlrq.t_Type = " + DLRQ_TYPE_DELIVERY
            + "    and buyddlrq.t_DealPart(+) = 1"
            + "    and buyddlrq.t_DocID = buylot_real.t_DocID"
            + "    and buyddlrq.t_DocKind = buylot_real.t_DocKind"
            + "    and buyddlrq.t_Type = " + DLRQ_TYPE_DELIVERY
            + "    and buyddlrq.t_DealPart(+) = 1"
            + "    and exists("
            + "                 select 1"
            + "                 from dnptxobj_dbt nptxobj"
            + "                 where nptxobj.t_AnaliticKind2 = " + TXOBJ_KIND2010
            + "                   and nptxobj.t_Analitic2 = lnk.t_ID"
            + "                   and nptxobj.t_Kind = " + TXOBJ_FR_SEC_3Y
            + "              )";

    cmd.AddParam(NPTXLNK_DELIVER);  /*1*/
    cmd.AddParam(m_BeginDate);      /*2*/
    cmd.AddParam(m_EndDate);        /*3*/
    cmd.AddParam(m_CurrInvestor);   /*4*/
    cmd.AddParam(m_EndDate);        /*5*/
    cmd.AddParam(m_EndDate);        /*6*/
    
    
    if( (AvrFIID != null) AND (AvrFIID > 0 ) ) /*задана бумага*/
       query = query + " and lnk.t_FIID = ? ";
       cmd.AddParam(AvrFIID);
    else
       if( (AvrKind != null) AND (AvrKind > 0 ) ) /*задан вид бумаги*/
         query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
         cmd.AddParam(AvrKind);
       end;
    end;

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      m_Rs = cmd.Execute(query);

      UseNewSheetInTotalBook();
      SetActiveSheet( SheetName );

      PrintFormatString( NULL,
                         "N5_Dbeg",   date(m_BeginDate),  //за период с
                         "N5_Dend",   this.Dend(),        //по
                         "N5_Client", this.ClientName(),  // Клиент
                         "N5_SumFR",  GetFormulaSumFR(cnt),
                         "N5_MinusG_618",   this.MinusG_618(),
                         "N5_Index_618",    this.Index_618(),
                         "N5_Limit_618",    this.Limit_618()
                        );
      CopyAllSheetInTotalBook(SheetName, false, "N5_ReportHeader", 0, CurrSheetName);

      CopyAllSheetInTotalBook(SheetName, false, "N5_TableHeader", 0, CurrSheetName);
      RegisterTable( "N5_MainTable", NULL,
           /*1  */   "N5_SecCode",     
           /*2  */   "N5_SecName",     
           /*3  */   "N5_Qnty",        
           /*4  */   "N5_CodeS",       
           /*5  */   "N5_DZS",         
           /*6  */   "N5_DPS",         
           /*7  */   "N5_PrSrub",      
           /*8  */   "N5_AllSrub",     
           /*9  */   "N5_ComS",        
           /*10 */   "N5_CodeB",       
           /*11 */   "N5_DZB",         
           /*12 */   "N5_DPB",         
           /*13 */   "N5_PrBrub",      
           /*14 */   "N5_AllBrub",     
           /*15 */   "N5_ComB",        
           /*16 */   "N5_Plusi",
           /*17 */   "N5_FR_Sec_3Y",
           /*18 */   "N5_TaxTagsYears"
           );

      InitProgress( cnt, CurrSheetName, CurrSheetName );
      while(m_Rs.moveNext())
          
        this.ClearCacheOneRecord();
        
        PrintTableLine( "N5_SecCode",   this.SecCode(),     null,
                        "N5_SecName",   this.SecName(),     null,
                        "N5_Qnty",      this.Qnty(),        null,
                        "N5_CodeS",     this.CodeS(),       null,
                        "N5_DZS",       this.DZS(),         null,
                        "N5_DPS",       this.DPS(),         null,
                        "N5_PrSrub",    this.PrSrub(),      null,
                        "N5_AllSrub",   this.AllSrub(),     null,
                        "N5_ComS",      this.ComS(),        null,
                        "N5_CodeB",     this.CodeB(),       null,
                        "N5_DZB",       this.DZB(),         null,
                        "N5_DPB",       this.DPB(),         null,
                        "N5_PrBrub",    this.PrBrub(),      null,
                        "N5_AllBrub",   this.AllBrub(),     null,
                        "N5_ComB",      this.ComB(),        null,
                        "N5_Plusi",     this.Plusi(),       null,
                        "N5_FR_Sec_3Y", this.FR_Sec_3Y(),   null,
                        "N5_TaxTagsYears", m_Rs.DeliveryYearSale - m_Rs.DeliveryYearBuy, null
                      );

        Sum_Qnty         = Sum_Qnty         + this.Qnty();
        Sum_AllSrub      = Sum_AllSrub      + this.AllSrub();
        Sum_ComS         = Sum_ComS         + this.ComS();
        Sum_AllBrub      = Sum_AllBrub      + this.AllBrub();
        Sum_ComB         = Sum_ComB         + this.ComB();
        SumFR            = SumFR            + this.FR_Sec_3Y();

        UseProgress(i = i + 1);

      end;

      RemProgress();
      
      SetCurrentLineFont( 10, true, false );
      PrintTableLine( "N5_SecCode",      ItogsLineName,    null,           
            /*1  */   "N5_Qnty",         Sum_Qnty,         null,
            /*2  */   "N5_AllSrub",      Sum_AllSrub,      null,
            /*3  */   "N5_ComS",         Sum_ComS,         null,
            /*4  */   "N5_AllBrub",      Sum_AllBrub,      null,
            /*5  */   "N5_ComB",         Sum_ComB,         null,
            /*6  */   "N5_FR_Sec_3Y",    SumFR,            null
                       );

      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
    end;
  END;

  //Общая информация
  PRIVATE MACRO CreateTotalCalc()
    var SheetName = "Справка по расчету НДФЛ";
    var CurrSheetName = m_CurrInvestorSheetName;

    m_TaxFR_total    = null;
    m_TaxFR_OTC      = null;
    m_TaxFR_market   = null;
    m_TaxFR_Open     = null;
    m_BaseMaterial   = null;
    m_BaseSpecial    = null;
    m_BaseSpecialDiv = null;
    m_DivPaySec      = null;
    m_DivPaySec_1    = null;
    m_BaseGeneral    = null;
    m_TaxRateGeneral = null;
    m_ComDepo        = null;                                    
    m_CoupRubS       = null;
    m_BM             = null;
    m_PM             = null;
    m_PD             = null;
    m_PG             = null;
    m_PS             = null; 
    m_SumOutNow      = null;
    m_TaxDueNow      = null; 
    m_BaseDiv        = null;
    m_Base0          = null;
    m_DivPay_Sec     = null;
    m_MinusG_618     = null;
    m_Limit_618      = null;
    m_BK             = null;
    m_PK             = null;
    m_DivPay_Sec_0   = null;
    m_PaidGeneral_0  = null;
    m_PaidSpecial_0  = null;
    m_Paid35_0       = null;
    m_PG0            = null;
    m_PS0            = null;
    m_PD0            = null;
    m_PK0            = null;

    this.SetCurrentLineFont( 8, false, false );

    SetActiveSheet( SheetName );  
    PrintFormatString( NULL,
                       "N1_Dbeg",         date(m_BeginDate),    // за период с
                       "N1_Dend",         this.Dend(),          // по
                       "N1_Client",       this.ClientName(),    // Клиент
                       "N1_ClientStatus", this.ClientStatus(),  // Статус клиента
                       "N1_ReportType",   this.ReportTypeName() // Тип отчета
                      );
    CopyAllSheetInTotalBook(SheetName, false, "N1_ReportHeader", 0, CurrSheetName);

    PrintFormatString( NULL,
                      "N1_TaxFR_market",         this.TaxFR_market(), 
                      "N1_TaxFR_OTC",            this.TaxFR_OTC(),
                      "N1_ComDepo",              this.ComDepo(),
                      "N1_CoupRub",              this.CoupRub(),
                      "N1_TaxFR_Open",           this.TaxFR_Open(),
                      "N1_RepoFactRub",          this.RepoFactRub(),
                      "N1_RepoTaxRub",           this.RepoTaxRub(),
                      "N1_RepoTaxRach",          this.RepoTaxRach(),
                      "N1_DerivTaxRub",          this.DerivTaxRub(),
                      "N1_BaseMaterial",         this.BaseMaterial(), 
                      "N1_BaseDiv",              this.BaseDiv(),                       
                      "N1_BaseBill",             this.BaseBill(),                       
                      "N1_Base0",                this.Base0(),
                      "N1_TaxBase",              this.TaxBase(),
                      "N1_TaxBase_618",          this.TaxBase_618(),
                      "N1_Limit_618",            this.Limit_618(),
                      "N1_MinusG_618",           this.MinusG_618(),
                      "N1_TaxRateGeneral",       this.TaxRateGeneral(),
                      "N1_TaxDueYear",           round(this.TaxDueYear(),0),
                      "N1_DivPay_Sec",           round(this.DivPay_Sec(),0),
                      "N1_TaxPaid",              round(this.TaxPaid(),0),
                      "N1_TaxDueNow1",           round(this.TaxDueNow1(),0),                    
                      "N1_TaxDueNow",            round(this.TaxDueNow(),0),
                      "N1_SumOutNow",            this.SumOutNow(),
                      "N1_SumOutYear",           this.SumOutYear(),
                      "N1_SumOutAfterDeduction", this.SumOutAfterDeduction() 
                     );
    CopyAllSheetInTotalBook( SheetName, false, "N1_ReportBody", 0, CurrSheetName);
  END;

  PRIVATE MACRO CreateReportNPTXLucre()
    var SheetName = "МатВыгода";
    var CurrSheetName = m_CurrInvestorSheetName + "_" + SheetName;
    var cmd = NULL;
    var count = 0;

    var AvrFIID = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRCODE );
    var AvrKind = m_Form.GetFieldValue( PNFLD_NPTXSHORT_AVRKIND );

    var SumQnty     = 0.0;
    var SumMainBvp  = 0.0;
    var SumMainBrub = 0.0;
    var SumMaterial = 0.0;
    var SumComB     = 0.0;
    var MaxSumPrecision = 0;

    cmd = CollectDataForNPTXLucreQuery(true, true, m_BeginDate, m_EndDate, AvrFIID, AvrKind, -1, m_CurrInvestor, m_CurrIIS, @count);
    m_RS = cmd.Execute();
    var i = 0;

    if(count > 0)
       UseNewSheetInTotalBook();
       SetActiveSheet(SheetName);
   
       PrintFormatString(NULL,
                         "N6_Dbeg", string(m_BeginDate:f),
                         "N6_Dend", string(m_EndDate:f),
                         "N6_Client", this.ClientName());
   
       CopyAllSheetInTotalBook(SheetName, false, "N6_ReportHeader", 0, CurrSheetName);
   
       RegisterTable("N6_MainTable", NULL,
                     "N6_SecCode",
                     "N6_SecName",
                     "N6_VN",
                     "N6_CodeB",
                     "N6_DZB",
                     "N6_DDB",
                     "N6_DPB",
                     "N6_Qnty",
                     "N6_PrBvp",
                     "N6_ValB",
                     "N6_VpB",
                     "N6_CrBD",
                     "N6_KZB",
                     "N6_MainBvp",
                     "N6_MainBrub",
                     "N6_bMrktB",
                     "N6_PriceMrktB",
                     "N6_MrktB",
                     "N6_DMrktB",
                     "N6_Material",
                     "N6_ComB",
                     "N6_NomB",
                     "N6_ComB",
                     "N6_SecType",
                     "N6_TaxRate");

       InitProgress(count, "Печать данных по материальной выгоде для клиента " + this.ClientName());

       while(m_RS.MoveNext())

          this.ClearCacheOneRecord();

          if(m_RS.TypeBO != 0)
            FD = DVFirstDocNDeal( DL_DVNDEAL, m_Rs.DealBuyID );   
          end;
       
          PrintTableLine("N6_SecCode",    this.SecCode(),       NULL,
                         "N6_SecName",    this.SecName(),       NULL,
                         "N6_VN",         this.VN(),             NULL,
                         "N6_CodeB",      this.CodeB(),         NULL,
                         "N6_DZB",        this.DZB(),           NULL,
                         "N6_DDB",        IIF((this.DDB() == date(0, 0, 0)) or (this.DDB() > this.Dend()), "", this.DDB()),           NULL,
                         "N6_DPB",        this.DPB(),           NULL,
                         "N6_Qnty",       this.Qnty(true),      SetPrecisionByFractPart(this.Qnty(true), this.QntyPrecision(), 0),
                         "N6_PrBvp",      this.PrBvp(),         NULL,
                         "N6_ValB",       this.ValBNumber(),    NULL,
                         "N6_VpB",        this.VpBNumber(),     NULL,
                         "N6_CrBD",       this.CrBD(true),      NULL,
                         "N6_KZB",        this.KZB(),           NULL,
                         "N6_MainBvp",    this.MainBvp(true),   NULL,
                         "N6_MainBrub",   this.MainBrub(true),  NULL,
                         "N6_bMrktB",     this.bMrktB(),        NULL,
                         "N6_PriceMrktB", this.PriceMrktB(),    NULL,
                         "N6_MrktB",      this.MrktB(true),     NULL,
                         "N6_DMrktB",     this.DMrktB(true),    NULL,
                         "N6_Material",   this.Material(),      NULL,
                         "N6_ComB",       this.ComB(true),      NULL,
                         "N6_NomB",       this.NomB(),          NULL,
                         "N6_ContB",      this.ContB(),         NULL,
                         "N6_SecType",    this.SecType(true),   NULL,
                         "N6_TaxRate",    this.TaxRate(),       NULL);

          SumQnty = SumQnty + this.Qnty(true);
          SumMainBvp = SumMainBvp + this.MainBvp(true);
          SumMainBrub = SumMainBrub + this.MainBrub(true);
          SumMaterial = SumMaterial + this.Material();
          SumComB = SumComB + this.ComB(true);

          if(MaxSumPrecision < this.QntyPrecision())
            MaxSumPrecision = this.QntyPrecision();
          end;

          UseProgress(i = i + 1);
       end;

       RemProgress();

       EndTable();

       CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, CurrSheetName);

       PrintFormatString(NULL, "N6_F11", SumQnty,
                               "N6_F17", SumMainBvp,
                               "N6_F18", SumMainBrub,
                               "N6_F23", SumMaterial,
                               "N6_F24", SumComB);

       ExternalSetCellPoint("N6_F11", SetPrecisionByFractPart(SumQnty, MaxSumPrecision, 0));

       CopyAllSheetInTotalBook(SheetName, false, "N6_TableFooter", 0, CurrSheetName);
    end;
  END;

  MACRO TaxRate()
     if(m_TaxRate == NULL)
       m_TaxRate = DL_GetClientTaxRateGeneral(m_Rs.Investor, m_EndDate) * 100.0;
     end;
     return string(m_TaxRate, "%");
  END;

  MACRO ClientName()
    return m_CurrInvestorName + IIF(m_CurrIIS == 1, " ИИС", "");
  END; 

  MACRO ClientStatus():string
     var v_ClientRec = TRecHandler("party.dbt");
     var NumInList = "", v_ClientStatus = "";

     if( not ПолучитьСубъекта(m_CurrInvestor, v_ClientRec) AND 
         GetMainObjAttr(null, OBJTYPE_PARTY, UniID(v_ClientRec, OBJTYPE_PARTY), 42/*Является плательщиком НДФЛ*/, null, null, NumInList, m_EndDate) )
       if( NumInList == "1" )
          v_ClientStatus = CL_STATE_RES;
       else
          v_ClientStatus = CL_STATE_NOTRES;
       end;
     end;

     if( (v_ClientStatus == "") and (v_ClientRec.rec.PartyID > 0) )
       if( v_ClientRec.rec.NotResident == SET_CHAR )
          v_ClientStatus = CL_STATE_NOTRES; //для нерезидента
       else
          v_ClientStatus = CL_STATE_RES; //для резидента
       end;
     end;

     return v_ClientStatus;
  END;

  MACRO ReportType():integer
    return m_Form.GetFieldValue( PNFLD_NPTXSHORT_TYPE );
  END;

  MACRO ReportTypeName():string
    return DL_GetNameAlg( 7332, this.ReportType() );
  END;

    /*Сумма доходов от купли - продажи ценных бумаг*/
  MACRO TaxFR_total():money
    return this.TaxFR_market() + this.TaxFR_OTC();
  END;
 
  /*Сумма доходов от купли - продажи обращающихся  ценных бумаг*/
  MACRO TaxFR_market():money
    
    if(m_TaxFR_market == NULL)
      m_TaxFR_market = $0;

      if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        var Query, DataSet, cmd;

        Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                     "                       THEN  N.t_Sum0 " +
                     "                       ELSE -N.t_Sum0 END " +
                     "                    ) " +
                     "               ), 0 " +
                     "           ) sum"    +
                     "  from dnptxobj_dbt N " +
                     " where N.t_Client =  ? " +
                     "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC) + ", " + string(TXOBJ_PLUS_SEC) + " ) " +
                     "   and N.t_Date >=  ? " + 
                     "   and N.t_Date <=  ? " + 
                     "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                     "   and N.t_Analitic5 NOT IN  (" + string(TXGROUP_90) + ", " + string(TXGROUP_80) + ") " +
                     "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                     "   and N.t_Analitic4 = "+NPTX_FI_CIRCULATE +
                     "   and N.t_AnaliticKind4 = " + TXOBJ_KIND4010;

        cmd = DL_RSDCommand(query);
        cmd.AddParam(m_CurrInvestor);
        cmd.AddParam(m_BeginDate);
        cmd.AddParam(m_EndDate);

        DataSet = cmd.Execute();       
        if( DataSet.MoveNext())
          m_TaxFR_market = Round(DataSet.sum,2);
        end;
      end;
    end;

    return m_TaxFR_market;
  END;
  
  /*Сумма доходов от купли - продажи не обращающихся ценных бумаг*/
  MACRO TaxFR_OTC()
    
    if(m_TaxFR_OTC == NULL)
      m_TaxFR_OTC = $0;

      if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        var Query, DataSet, cmd;

        Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                     "                       THEN  N.t_Sum0 " +
                     "                       ELSE -N.t_Sum0 END " +
                     "                    ) " +
                     "               ), 0 " +
                     "           ) sum"    +
                     "  from dnptxobj_dbt N " +
                     " where N.t_Client =  ? " +
                     "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC) + ", " + string(TXOBJ_PLUS_SEC) + " ) " +
                     "   and N.t_Date >=  ? " + 
                     "   and N.t_Date <=  ? " + 
                     "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                     "   and N.t_Analitic5 NOT IN  (" + string(TXGROUP_90) + ", " + string(TXGROUP_80) + ") " +
                     "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                     "   and N.t_Analitic4 IN ("+NPTX_FI_NOCIRCULATE+", "+NPTX_FI_LOSTCIRCULATE+")" +
                     "   and N.t_AnaliticKind4 = " + TXOBJ_KIND4010;

        cmd = DL_RSDCommand(query);
        cmd.AddParam(m_CurrInvestor);
        cmd.AddParam(m_BeginDate);
        cmd.AddParam(m_EndDate);

        DataSet = cmd.Execute();       
        if( DataSet.MoveNext())
          m_TaxFR_OTC = Round(DataSet.sum,2);
        end;
      end;
    end;
    
    return m_TaxFR_OTC;
  END;

  /*Сумма расходов в виде комиссий, списанных за ведение счета депо*/
  MACRO ComDepo():money
    var SumGeneral = $0, SumGeneral_IIS = $0, SumPreviousYear = $0;
    var Year;

    DateSplit(m_BeginDate, NULL, NULL, Year);
    if( m_ComDepo == NULL )
       m_ComDepo = $0;
       if( (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) )
          if(m_CurrIIS == 0)
              DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                       string(TXOBJ_GENERAL),
                                       m_BeginDate,
                                       m_EndDate,
                                       0,
                                       null,
                                       @SumGeneral,
                                       null,
                                       m_CurrIIS,
                                       true
                                      );

              DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                       string(TXOBJ_PREVIOUSYEAR),
                                       NULL,
                                       date(1, 1, Year)-1,
                                       0,
                                       null,
                                       @SumPreviousYear,
                                       null,
                                       m_CurrIIS,
                                       true
                                      );

              m_ComDepo = SumGeneral + SumPreviousYear;
          else
              var BegDate = GetFirstDateIIS(m_CurrInvestor);
              DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                       string(TXOBJ_GENERAL),
                                       BegDate,
                                       m_EndDate,
                                       0,
                                       null,
                                       @SumGeneral,
                                       null,
                                       m_CurrIIS,
                                       true
                                      );

              DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                       string(TXOBJ_GENERAL_IIS),
                                       BegDate,
                                       m_EndDate,
                                       0,
                                       null,
                                       @SumGeneral_IIS,
                                       null,
                                       m_CurrIIS,
                                       true
                                      );
             m_ComDepo = SumGeneral + SumGeneral_IIS;
          end;
       end;
     end;
    return m_ComDepo;
  END;

  /*Суммы, полученные при погашении купонов и частичных погашениях*/
  MACRO CoupRub()
    if( m_CoupRubS == NULL )
       m_CoupRubS = $0;
       if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)

         DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                  string(TXOBJ_PROCSEC_TS)+","+string(TXOBJ_PROCSEC_TS_35),
                                  m_BeginDate,
                                  m_EndDate,
                                  null,
                                  null,
                                  @m_CoupRubS, null, m_CurrIIS, true
                                 );
       end;
     end;
    return m_CoupRubS;
 
  END;

  /*Сумма доходов от купли - продажи не обращающихся ценных бумаг*/
  MACRO TaxFR_Open():money
    
    if(m_TaxFR_Open == NULL)
      m_TaxFR_Open = $0;

      if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        var Query, DataSet, cmd;

        Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                     "                       THEN  N.t_Sum0 " +
                     "                       ELSE -N.t_Sum0 END " +
                     "                    ) " +
                     "               ), 0 " +
                     "           ) sum"    +
                     "  from dnptxobj_dbt N " +
                     " where N.t_Client =  ? " +
                     "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                     "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC_SHORT) + ", " + string(TXOBJ_PLUS_SEC_SHORT) + " ) " +
                     "   and N.t_Date >=  ? " + 
                     "   and N.t_Date <=  ? "; 

        cmd = DL_RSDCommand(query);
        cmd.AddParam(m_CurrInvestor);
        cmd.AddParam(m_BeginDate);
        cmd.AddParam(m_EndDate);

        DataSet = cmd.Execute();       
        if( DataSet.MoveNext())
          m_TaxFR_Open = DataSet.sum;
        end;
      end;
    end;
    
    return m_TaxFR_Open;
  END;

  private macro StrMaxFactDate2()
     return
     " (NVL( (SELECT max(dlrq.t_FactDate) " +
     "  FROM ddlrq_dbt dlrq " + 
     "  WHERE dlrq.t_DocKind    = tick.t_BOfficeKind " +
     "      AND dlrq.t_DocID = tick.t_DealID " +
     "      AND dlrq.t_Type    IN (" + DLRQ_TYPE_DELIVERY + "," + DLRQ_TYPE_PAYMENT + ") " +
     "      AND dlrq.t_DealPart    = " + LEG_KIND_DL_TICK_BACK + 
     "      AND dlrq.t_State = " + DLRQ_STATE_EXEC +
     "      AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
     "      ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
     " ) ";
  end;

  /*по сделкам РЕПО, у которых максимальная из дат: фактической поставки по 2 части и фактической оплаты по 2 части входит в период с <Dbeg> по <Dend>*/
  MACRO GetComRubSumByClientByCond():money
    var AddWhereCond = " (select count(1) "+
                       "    from dnptxobj_dbt obj_1 "+
                       "   where obj_1.t_AnaliticKind1 = obj.t_AnaliticKind1 "+
                       "     and obj_1.t_Analitic1 = obj.t_Analitic1 "+
                       "     and obj_1.t_Date >= "+GetSQLDate(m_BeginDate)+
                       "     and obj_1.t_Date <= "+GetSQLDate(m_EndDate)+
                       "     and obj_1.t_Client = obj.t_Client "+
                       "     and Exists(select 1 " +
                       "                  from ddl_tick_dbt Tick, doprkoper_dbt Opr " +
                       "                 where Tick.t_DealID = obj_1.t_Analitic1 " + 
                       "                   and Tick.t_BOfficeKind = " + DL_SECURITYDOC +
                       "                   and Opr.t_Kind_Operation = Tick.t_DealType " + 
                       "                   and Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(Opr.t_SysTypes)) = 1 "
                       "                   and ("+StrMaxFactDate2()+" between "+GetSQLDate(m_BeginDate)+" and "+GetSQLDate(m_EndDate)+") " +
                       "               ) " +
                       " ) > 0 ";
    /*здесь дату НДР вида TXOBJ_COM не проверяем, т.к. по процентам НДР формируется в дату второй части, а комиссия чаще всего в дату первой*/
    return GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COM), m_BeginDate /* null*/, null, TXOBJ_DIR_OUT, m_CurrIIS, null, AddWhereCond);
  END;

    /*Доходы по сделкам РЕПО/займа фактические*/
  MACRO RepoFactRub():money
    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
      return GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCFACT), m_BeginDate, m_EndDate, TXOBJ_DIR_IN, m_CurrIIS) - GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCFACT), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS) - 
             GetComRubSumByClientByCond();
    end;
    return $0;
  END;

  /*Доходы по сделкам РЕПО/займа для налогообложения*/
  MACRO RepoTaxRub():money
    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
      return GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCREPOTAX), m_BeginDate, m_EndDate, TXOBJ_DIR_IN, m_CurrIIS) - GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCREPOTAX), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS) - 
             GetComRubSumByClientByCond();
    end;
    return $0;
  END;

  /*Сумма убытка по  РЕПО и коротким позициям в уменьшение НОБ по ц/б */
  MACRO RepoTaxRach():money

    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        if (m_CurrIIS != 1)
           return  GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_222), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS)+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_223), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS)+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_214), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS);
        else
           return  GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_239), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS)+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_240), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS)+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_214_IIS), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS);
        end;
    end;
    return $0;
  END;

  /*Доходы по сделкам с ПИ*/
  MACRO DerivTaxRub()
    var DerivTaxRub = 0;

    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
      var Query, DataSet, cmd;

      Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                   "                       THEN  N.t_Sum0 " +
                   "                       ELSE -N.t_Sum0 END " +
                   "                    ) " +
                   "               ), 0 " +
                   "           ) sum"    +
                   "  from dnptxobj_dbt N " +
                   " where N.t_Client = ? " +  
                   "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC) + ", " + string(TXOBJ_PLUS_SEC) + " ) " +
                   "   and N.t_Date >= ? " + 
                   "   and N.t_Date <= ? " + 
                   "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                   "   and N.t_Analitic5 IN  (" + string(TXGROUP_90) + ", " + string(TXGROUP_80) + ") " +
                   "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010);

      cmd = DL_RSDCommand(Query);
      cmd.AddParam(m_CurrInvestor);
      cmd.AddParam(m_BeginDate);
      cmd.AddParam(m_EndDate);

      DataSet = cmd.Execute();       
      if( DataSet.MoveNext())
        DerivTaxRub = DataSet.sum;
      end; 
    end;
    return DerivTaxRub;
  END;

  /*Материальная выгода по покупкам*/
  MACRO BM():money
    if( m_BM == NULL )
       m_BM = $0;
       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(IIF(m_CurrIIS == 1, TXOBJ_BASEMATERIAL_IIS, TXOBJ_BASEMATERIAL)),
                                m_BeginDate,
                                m_EndDate,
                                null,
                                null,
                                @m_BM,
                                null,
                                null,
                                true
                               );
    end;
    return m_BM;
  END;

  MACRO BaseMaterial():money
    if( m_BaseMaterial == NULL )
       m_BaseMaterial = $0;
       if( this.ReportType() == DL_TXHOLD_OPTYPE_LUCRE )
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(IIF(m_CurrIIS == 1, TXOBJ_BASEMATERIAL_IIS, TXOBJ_BASEMATERIAL)),
                                   m_EndDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_BaseMaterial,
                                   null,
                                   null,
                                   true
                                  );
       else
          m_BaseMaterial = this.BM();
       end;
    end;

    return m_BaseMaterial;
  END;
  
  MACRO BS():money
    if( m_BaseSpecial == NULL )
       m_BaseSpecial = $0;
       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(IIF(m_CurrIIS == 1, TXOBJ_BASESPECIAL_IIS, TXOBJ_BASESPECIAL)),
                                m_BeginDate,
                                m_EndDate,
                                null,
                                null,
                                @m_BaseSpecial,
                                null,
                                null,
                                true
                               );
    end;
    return m_BaseSpecial;
  END;

  MACRO BD():money
    if( m_BaseSpecialDiv == NULL )
       m_BaseSpecialDiv = $0;
       if( m_CurrIIS != 1 )
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_BASESPECIAL_DIV),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_BaseSpecialDiv,
                                   null,
                                   m_CurrIIS,
                                   true
                                  );
       end;
    end;
    return m_BaseSpecialDiv;
  END;

  MACRO BK()
    if( m_BK == NULL )
       m_BK = $0;
       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(TXOBJ_BASE_35),
                                m_BeginDate,
                                m_EndDate,
                                null,
                                null,
                                @m_BK,
                                null,
                                null,
                                true
                               );
    end;
    return m_BK;
  END;

  MACRO BG()
    if( m_BaseGeneral == NULL )
       m_BaseGeneral = $0;
       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(IIF(m_CurrIIS == 1, TXOBJ_BASEGENERAL_IIS, TXOBJ_BASEGENERAL)),
                                m_BeginDate,
                                m_EndDate,
                                null,
                                null,
                                @m_BaseGeneral,
                                null,
                                null,
                                true
                               );
    end;
    return m_BaseGeneral;
  END;

  MACRO BB():money
    if (m_BaseBill == null)
      m_BaseBill = $0;
      if (m_CurrIIS == 0)
        DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                               string(TXOBJ_BASEBILL),
                               m_BeginDate,
                               m_EndDate,
                               null,
                               null,
                               @m_BaseBill, null, m_CurrIIS, true
                              );                                
      end;
    end;
    return m_BaseBill; 
  END;
  
  MACRO PB():money
    if (m_PaidBill == null)
      m_PaidBill = $0;
      if (m_CurrIIS == 0)
        DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                               string(TXOBJ_PAIDBILL),
                               m_BeginDate,
                               m_EndDate,
                               null,
                               null,
                               @m_PaidBill, null, m_CurrIIS, true
                               );
      end;
    end;
    return m_PaidBill;  
  END;
  
  /*Налоговая база по операциям с ценными бумагами и производными инструментами*/
  MACRO TaxBase()
    if( this.ReportType() == DL_TXHOLD_OPTYPE_LUCRE )
       return this.BaseMaterial();
    end;

    return this.BS() + this.BG() + this.BM() + this.BD() + this.BK() + this.BB();
  END;

  MACRO RG()
    if (this.ClientStatus() == "резидент") 
      return 0.13;
    else 
      var _stat = 1; 
      var _TaxRate;
      
      if (m_EndDate != NULL)
        _stat = ПолучитьЗначениеПримечанияНаДату(m_CurrInvestor, PARTY_NOTE_KIND_NPTX_RATE_NOTRES, m_EndDate, @_TaxRate);
      end;
      if (_stat != 0)
        _TaxRate = 0.3; //для нерезидента
      elif (_TaxRate!= NULL)
        _TaxRate = _TaxRate / 100; //Примечание вернёт целые проценты. Нам же нужен коэффициент
      end;
      
      return _TaxRate;
    end;
  END;

  /*Налоговая ставка - %*/
  MACRO TaxRateGeneral():STRING
    return string(this.RG()*100, "%");
  END;

  MACRO RS()
    if (this.ClientStatus() == "резидент") 
      return 0.09;
    else
      return 0.15;
    end;
  END;

  MACRO DivPaySec() //Не включая m_EndDate
    if( m_DivPaySec == null )
       m_DivPaySec = $0;
       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(TXOBJ_DIVPAY_SEC),
                                m_BeginDate,
                                m_EndDate-1, //EndDate не включается
                                null,
                                null,
                                @m_DivPaySec, null, m_CurrIIS, true
                               );
    end;
    return round(m_DivPaySec,0);
  END;

  MACRO DivPaySec_1() //Включая m_EndDate
    if( m_DivPaySec_1 == null )
       m_DivPaySec_1 = $0;
       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(TXOBJ_DIVPAY_SEC)+","+string(TXOBJ_PAID_35),
                                m_BeginDate,
                                m_EndDate, //EndDate включается
                                null,
                                null,
                                @m_DivPaySec_1, null, m_CurrIIS, true
                               );
    end;
    return round(m_DivPaySec_1,0);
  END;

  MACRO PaidBill()
    if (m_PaidBill == null)
      m_PaidBill = $0;
      DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                               string(TXOBJ_PAIDBILL),
                               m_BeginDate,
                               m_EndDate,
                               null,
                               null,
                               @m_PaidBill, null, m_CurrIIS, true
                               );
    end;
    return m_PaidBill;    
  END;

  MACRO DivPay_Sec_0()
     if(m_DivPay_Sec_0 == null)
        m_DivPay_Sec_0 = $0;
        DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                 string(TXOBJ_DIVPAY_SEC_0),
                                 m_BeginDate,
                                 m_EndDate,
                                 null,
                                 null,
                                 @m_DivPay_Sec_0, null, m_CurrIIS, true
                                 );
     end;

     return m_DivPay_Sec_0;
  END;

  MACRO PaidGeneral_0()
     if(m_PaidGeneral_0 == null)
        m_PaidGeneral_0 = $0;
        DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                 string(TXOBJ_PAIDGENERAL_0),
                                 m_BeginDate,
                                 m_EndDate,
                                 null,
                                 null,
                                 @m_PaidGeneral_0, null, m_CurrIIS, true
                                 );
     end;

     return m_PaidGeneral_0;
  END;

  MACRO PaidSpecial_0()
     if(m_PaidSpecial_0 == null)
        m_PaidSpecial_0 = $0;
        DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                 string(TXOBJ_PAIDSPECIAL_0),
                                 m_BeginDate,
                                 m_EndDate,
                                 null,
                                 null,
                                 @m_PaidSpecial_0, null, m_CurrIIS, true
                                 );
     end;

     return m_PaidSpecial_0;
  END;

  MACRO Paid35_0()
     if(m_Paid35_0 == null)
        m_Paid35_0 = $0;
        DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                 string(TXOBJ_PAID35_0),
                                 m_BeginDate,
                                 m_EndDate,
                                 null,
                                 null,
                                 @m_Paid35_0, null, m_CurrIIS, true
                                 );
     end;

     return m_Paid35_0;
  END;

  /*Сумма налога, подлежащая перечислению в бюджет налоговым агентом с начала года*/
  MACRO TaxDueYear()
    var TaxDueYear = $0;
    
    if( this.ReportType() == DL_TXHOLD_OPTYPE_LUCRE )
       TaxDueYear = this.BaseMaterial() * this.Rg();
    else
       TaxDueYear = BS() * Rs() + (BG() + BM()) *  this.RG();

       if( m_CurrIIS == 0 )
          TaxDueYear = TaxDueYear + DivPaySec_1();
          TaxDueYear = TaxDueYear + PaidBill() - DivPay_Sec_0() - PaidGeneral_0() - PaidSpecial_0() - Paid35_0();
       end;
    end;

    return round(TaxDueYear,0);
  END;

  MACRO PG()
    if(m_PG == NULL)
   
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PG = GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PG = GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
               GetRubSumByClientFromDepo(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), m_BeginDate, m_EndDate) +
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS) +
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL)), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;
    return m_PG;
  END;

  MACRO PG0()
    if(m_PG0 == NULL)
   
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PG0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PG0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
               GetRubSumByClientFromDepo(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), m_BeginDate, m_EndDate) +
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS) +
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDGENERAL_0), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;
    return m_PG0;
  END;

  MACRO PS()
    if (m_PS == NULL)
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PS = GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PS = GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
               GetRubSumByClientFromDepo(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), m_BeginDate, m_EndDate) +
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS)+
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/     
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDSPECIAL_IIS, TXOBJ_PAIDSPECIAL)), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;    
    return m_PS;
  END;

    MACRO PS0()
    if(m_PG0 == NULL)
   
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PG0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PG0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
                GetRubSumByClientFromDepo(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), m_BeginDate, m_EndDate) +
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS) +
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAIDSPECIAL_0), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;
    return m_PG0;
  END;

  MACRO PM()
    if(m_PM == NULL)
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PM = GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PM = GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
               GetRubSumByClientFromDepo(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), m_BeginDate, m_EndDate) +
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS)+
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/     
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(IIF(m_CurrIIS == 1, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;
    return m_PM;
  END;

  MACRO PD()
    if( m_PD == NULL )
       if( m_CurrIIS == 1 )
          m_PD = $0;
       else
          if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
            m_PD = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);
         
          elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
            m_PD = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
                   GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
                   GetRubSumByClientFromDepo(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), m_BeginDate, m_EndDate) +
                   GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
                   GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS)+
                   GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/     
                   GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
          end;
       end;
    end;
    return m_PD;
  END;

  MACRO PD0()
    if(m_PD0 == NULL)
   
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PD0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PD0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
                GetRubSumByClientFromDepo(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), m_BeginDate, m_EndDate) +
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS) +
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_DIVPAY_SEC_0), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;
    return m_PD0;
  END;

  MACRO PK()
    if(m_PK == NULL)
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PK = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID_35), m_BeginDate, m_EndDate - 1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PK = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID_35), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID_35), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
               GetRubSumByClientFromDepo(m_CurrInvestor, string(TXOBJ_PAID_35), m_BeginDate, m_EndDate, m_CurrIIS) +
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID_35), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID_35), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS)+
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID_35), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/     
               GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID_35), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;
    return m_PK;
  END;

  MACRO PK0()
    if(m_PK0 == NULL)
   
      if((this.ReportType() == DL_TXHOLD_OPTYPE_OUTMONEY) OR (this.ReportType() == DL_TXHOLD_OPTYPE_OUTAVOIR))
        m_PK0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID35_0), m_BeginDate, m_EndDate-1, null, null, m_CurrIIS);

      elif((this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR) OR (this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE))
        m_PK0 = GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID35_0), m_BeginDate, m_EndDate, DL_CALCNDFL, null, m_CurrIIS) + /*созданные в операциях расчета НОБ */
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID35_0), m_BeginDate, m_EndDate, DL_WRTMONEY, null, m_CurrIIS) + /*созданные в операциях списания денежных средств */
                GetRubSumByClientFromDepo(m_CurrInvestor, string(TXOBJ_PAID35_0), m_BeginDate, m_EndDate) +
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID35_0), m_BeginDate, m_EndDate, DL_RETIREMENT_OWN, null, m_CurrIIS) + // ??? созданные в операции "Погашение выпуска СЭБ"
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID35_0), m_BeginDate, m_EndDate, 0 /*только пользовательские*/, null, m_CurrIIS) +
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID35_0), null, null, DL_HOLDNDFL, IIF(m_CurrIIS==1, null, m_BeginDate), m_CurrIIS) + /*созданные в операциях удержания НДФЛ*/
                GetRubSumByClientOperDocKind(m_CurrInvestor, string(TXOBJ_PAID35_0), m_BeginDate, m_EndDate, DL_RETURN_DIVIDEND, null, m_CurrIIS); /*созданные в операциях возврата дивидиндов*/
      end;
    end;
    return m_PK0;
  END;

  /*Сумма налога, перечисленная налоговым агентом в течение года*/
  MACRO TaxPaid()
    var TaxPaid = $0;

    if( (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) and (this.ReportType() != DL_TXHOLD_OPTYPE_PREHOLD) and (this.ReportType() != DL_TXHOLD_OPTYPE_TAXREF) )
      TaxPaid = PG() + PM() + PS() + PD() + PK() + PB();
    end;

    return round(TaxPaid,0);
  END;

  PRIVATE MACRO GetOutCurrencySum(ClientId, EndDate, BegDate ):money
    var OutSum = $0;
    var query, Select, DataSet;
    var Sum = $0;

    query =   " select S.t_OutSum, S.t_Currency, S.t_OperDate "
            + "   from dnptxop_dbt S"
            + "  where S.t_DocKind = " + DL_WRTMONEY
            + "    and S.t_Client = ? " 
            + IIF(m_CurrIIS == 1, " and S.t_IIS = 'X' ", " and S.t_IIS <> 'X' ")
            + "    and S.t_Subkind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF;
  
    if(ValType(BegDate) == V_DATE)
      query = query + "    and S.t_OperDate >= ? "
                    + "    and S.t_OperDate <= ? ";
    else
      query = query + "    and S.t_OperDate = ? ";
    end;

    Select = RSDCommand(query);
    Select.addParam( "", RSDBP_IN, ClientID );
    if(ValType(BegDate) == V_DATE)      
      Select.addParam( "", RSDBP_IN, BegDate );
    end;
    Select.addParam( "", RSDBP_IN, EndDate );
     
    Select.execute();

    DataSet = TRsbDataSet(Select);
    while(DataSet.moveNext())
      if(DataSet.Currency != NATCUR)
        Sum = $0;
        //конвертируем по курсу Oper.rec.OperDate
        if(SmartConvertSum(Sum, DataSet.OutSum, DataSet.OperDate, DataSet.Currency, NATCUR, true))
          OutSum = OutSum + Sum;
        end;
      else
        OutSum = OutSum + DataSet.OutSum;
      end;
    end;

    return OutSum; 
  END; 

  /*Сумма денежных средств, выводимых клиентом*/ 
  MACRO SumOutNow()
    if (m_SumOutNow == NULL)    
      m_SumOutNow = GetOutCurrencySum( m_CurrInvestor, this.Dend() );
    end;
    return m_SumOutNow;
  END;
  
  /*Сумма денежных средств, выведенных в течении года*/
  MACRO SumOutYear()
    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
      return GetOutCurrencySum( m_CurrInvestor, this.Dend(), this.dbeg() );
    end;

    return $0;
  END;

  /*Сумма налога, подлежащая перечислению в бюджет налоговым агентом*/
  MACRO TaxDueNow()    
    var Dg = $0, Ds = $0, Dm = $0, TaxPriority;
    if( m_TaxDueNow == NULL )
      m_TaxDueNow = $0;

      if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        
        if((this.ReportType() == DL_TXHOLD_OPTYPE_CLOSE) OR (this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR))
          m_TaxDueNow = this.TaxDueNow1();
        else
          var cmd = DL_RSDCommand(  " select 1 "
                                  + "   from dnptxop_dbt "
                                  + "  where t_DocKind = " + DL_HOLDNDFL
                                  + "    and t_Client = ? "
                                  + "    and t_OperDate = ? "
                                  + IIF(m_CurrIIS == 1, " and t_IIS = 'X' ", " and t_IIS <> 'X' ")
                                  + "    and t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_OUTMONEY
                                 );

          cmd.AddParam(m_CurrInvestor);
          cmd.AddParam(this.Dend());
          if(cmd.GetCount() > 0)
            if(this.TaxDueNow1() > this.SumOutYear())
              TaxPriority = DL_GetClientTaxPriority(m_CurrInvestor); //очередность взимания налогов с клиента 
              
              Dm = min((this.Bm()*this.Rg() - this.Pm()), this.SumOutNow());
              
              
              if(TaxPriority == NPTXPRIORITYTAX_FIRST915)
                Dg = this.Rg() * min((this.SumOutNow() - Dm/this.Rg() - min((this.SumOutNow() - Dm/this.Rg()),(this.Bs() - this.Ps()/this.Rs()))), (this.Bg() - this.Pg()/this.Rg()));

                Ds = min((this.SumOutNow() - Dm/this.Rg()), (this.Bs()*this.Rg() - this.Ps()));

              elif(TaxPriority == NPTXPRIORITYTAX_FIRSTTOTAL)
                Dg = min((this.SumOutNow() - Dm/this.Rg()), (this.Bg()*this.Rg() - this.Pg() - Pg0()));

                Ds = this.Rs() * min((this.SumOutNow() - Dm/this.Rg() - min((this.SumOutNow() - Dm/this.Rg()), (this.Bg() - (this.Pg() + Pg0())/this.Rg()))), (this.Bs() - (this.Ps() + Ps0())/this.Rs()));
              end;
              
              m_TaxDueNow = Dm + Ds + Dg;
            else
              m_TaxDueNow = this.TaxDueNow1();
            end;
          end;
        end;
      end;
    end;

    m_TaxDueNow = round(m_TaxDueNow,0);

    return m_TaxDueNow;  
  END;

  MACRO TaxDueNow1()
    return round((this.TaxDueYear() - this.TaxPaid()),0);
  END;

  /*Сумма денежных средств, уплаченная клиенту */
  MACRO SumOutAfterDeduction()

   if((this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) and (this.SumOutNow() > 0))
     return IIF((this.TaxDueNow() > 0), this.SumOutNow() - this.TaxDueNow(), this.SumOutNow());
   end;
   return 0;
  END;

  MACRO BaseDiv()
    if( m_BaseDiv == null )
       m_BaseDiv = $0;
       if (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_BASESPECIAL_DIV),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_BaseDiv, null, m_CurrIIS, true
                                  );
       end;
    end;
    return m_BaseDiv;
  END;

  MACRO BaseBill()
    if (m_BaseBill == null)
      m_BaseBill = $0;
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_BASEBILL),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_BaseBill, null, m_CurrIIS, true
                                  );
    end;
    return m_BaseBill;    
  END;
  
  MACRO Base0()
    var Base0_IN = $0, Base0_OUT = $0;

    if( m_Base0 == null )
       m_Base0 = $0;
       if( this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE )
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_PLUS_SEC0) + ", " + string(TXOBJ_EXP_GROUP) + ", " + string(TXOBJ_COUP0_GROUP) + ", " + string(TXOBJ_MINUS_SEC0),
                                   m_BeginDate,
                                   m_EndDate,
                                   TXOBJ_DIR_IN,
                                   null,
                                   @Base0_IN,
                                   null,
                                   m_CurrIIS,
                                   true
                                  );
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_PLUS_SEC0) + ", " + string(TXOBJ_EXP_GROUP) + ", " + string(TXOBJ_COUP0_GROUP) + ", " + string(TXOBJ_MINUS_SEC0),
                                   m_BeginDate,
                                   m_EndDate,
                                   TXOBJ_DIR_OUT,
                                   null,
                                   @Base0_OUT,
                                   null,
                                   m_CurrIIS,
                                   true
                                  );
          /*Доход суммируем с плюсом, расход с минусом*/
          m_Base0 = abs(Base0_IN) - abs(Base0_OUT);
       end;
    end;
    return m_Base0;
  END;

  MACRO DivPay_Sec()
    if( m_DivPay_Sec == null )
       m_DivPay_Sec = $0;
       if( (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) and (m_CurrIIS != 1) )
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_DIVPAY_SEC)+","+string(TXOBJ_PAID_35),                                                           
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_DivPay_Sec,
                                   null,
                                   null,
                                   true
                                  );

          m_DivPay_Sec = m_DivPay_Sec - DivPay_Sec_0() - Paid35_0();
       end;
    end;
    return round(m_DivPay_Sec,0);
  END;

  MACRO TaxBase_618() // Налоговая база по операциям с ценными бумагами и производными инструментами без учета инвестиционного вычета
    var RetVal:money = $0;

    if( (this.ReportType() == DL_TXHOLD_OPTYPE_LUCRE) or (m_CurrIIS == 1) )
       RetVal = this.TaxBase();
    else
       RetVal = this.TaxBase() + this.MinusG_618();
    end;

    return RetVal;
  END;

  MACRO Limit_618() // Предельное значение инвестиционного вычета по ц/б в собственности более 3 лет
    if( m_Limit_618 == null )
       m_Limit_618 = $0;
       if( (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) and (m_CurrIIS != 1) )
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_LIMIT_618),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_Limit_618, null, m_CurrIIS, true
                                  );
       end;
    end;
    return m_Limit_618;
  END;

  MACRO MinusG_618() // Учтенное в НОБ значение инвестиционного вычета
    if( m_MinusG_618 == null )
      m_MinusG_618 = $0;
      if (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        if (m_CurrIIS != 1)
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_MINUSG_618),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_MinusG_618, null, m_CurrIIS, true
                                  );
        else
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_MINUSG_619),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @m_MinusG_618, null, m_CurrIIS, true
                                  );
        end;
      end;
    end;
    return m_MinusG_618;
  END;

  MACRO Index_618()
    var sum1 = $0;
    var sum2 = $0;
    var query, cmd, DataSet;

    cmd = DL_RSDCOmmand();

    query =   " select NVL(SUM(obj.t_Sum0), 0) as AllSumi, NVL(SUM(obj.t_Sum0*obj.t_Holding_Period), 0) as Sumi"
            + "   from dnptxobj_dbt obj "
            + "  where obj.t_Client = " + cmd.AddParam(m_CurrInvestor)
            + "    and obj.t_Kind = " + TXOBJ_PLUSI
            + "    and obj.t_Date between "+cmd.AddParam(m_BeginDate)+" and "+cmd.AddParam(m_EndDate)
            + "    and RSI_NPTO.CheckObjIIS ( " + TXOBJ_KIND6020 + ", obj.t_Analitic6 ) = 0 "
            + "    and " + GetForDEPOCond(false)
            + " and (obj.t_Technical = CHR(0) or obj.t_Technical is null) ";

    DataSet = cmd.Execute(query);
    if(DataSet.moveNext())
      sum1 = DataSet.Sumi;
      sum2 = DataSet.AllSumi;
    end;

    if(sum2 != 0)
      return sum1 / sum2;
    end;

    return 0;
  END;

  //Старт
  PRIVATE MACRO Create()
    var query, DataSet, cmd;
    var iter = 1;
    var stat = 0;
    var InvestorSheetName, Year;
    var cnt = 0, i = 0;

    m_BeginDate = this.Dbeg();
    m_EndDate   = this.Dend();
    var Investor = m_Form.GetFieldValue( PNFLD_NPTXSHORT_INVESTORCODE );

    cmd = DL_RSDCommand();

    query =   " SELECT q.InvestorName, q.Investor, q.KindIIS, q.InvestorSheetName "
            + "   FROM ("
            +           " SELECT pt.t_PartyID as Investor, 0 as KindIIS, "
            +           "        trim( pt.t_Name ) as InvestorName, "
            +           "        ((CASE WHEN ( (SELECT LENGTH (trim(persn.t_Name1)) FROM DUAL) > 20) "
            +           "                    THEN  SUBSTR (trim(persn.t_Name1), 1, 20) " 
            +           "               ELSE trim(persn.t_Name1) END) " 
            +           "         || case when(persn.t_Name2 = CHR(1))then '' else SUBSTR (persn.t_Name2, 1, 1) end"
            +           "         || case when(persn.t_Name3 = CHR(1))then '' else SUBSTR (persn.t_Name3, 1, 1) end) as InvestorSheetName "
            +           "   FROM dpersn_dbt persn, dparty_dbt pt "
            +           "  WHERE     pt.t_LegalForm   = " + string(legal_form_phys)
            +           "        AND persn.t_PersonID = pt.t_PartyID "
            +           "        AND (   EXISTS(SELECT 1"
            +           "                         FROM dclient_dbt cl,"
            +           "                              dnptxop_dbt nptx"
            +           "                        WHERE     cl.t_PartyID   =  pt.t_PartyID"
            +           "                              AND nptx.t_Client  =  pt.t_PartyID"
            +           "                              AND nptx.t_IIS     <> 'X'"
            +           "                              AND nptx.t_DocKind = " + string(DL_CALCNDFL)
            +           "                              AND cl.t_ServiceKind IN (" + string(PTSK_STOCKDL) + ", "
            +                                                                       string(PTSK_DV) + ", "
            +                                                                       string(PTSK_DEPOS) + ", "
            +                                                                       string(PTSK_SVO) + ") "
            +           "                              AND nptx.t_OperDate BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_EndDate)
            +           "                           ) "
            +           "             OR EXISTS(SELECT 1"
            +           "                         FROM dnptxobj_dbt obj"
            +           "                        WHERE     obj.t_Client = pt.t_PartyID "
            +           "                              AND obj.t_Kind IN (" + string(TXOBJ_BASEMATERIAL) + ", "
            +                                                                 string(TXOBJ_BASEGENERAL) + ", "
            +                                                                 string(TXOBJ_BASESPECIAL) + ", "
            +                                                                 string(TXOBJ_BASESPECIAL_DIV) + ") "
            +           "                              AND obj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_EndDate)
            +           "                ) "
            +           "             OR EXISTS(SELECT 1 val"
            +           "                     FROM dnptxobj_dbt nptxobj,                    "
            +           "                          dnptxobdc_dbt lnk,                       "
            +           "                          doproper_dbt oper,                       "
            +           "                          dparty_dbt party                         "
            +           "                        WHERE     nptxobj.t_ObjID     = lnk.t_ObjID"
            +           "                              AND oper.t_ID_Operation = lnk.t_DocID"
            +           "                              AND nptxobj.t_client    = party.t_PartyID"
            +           "                              AND nptxobj.t_kind  IN ( " + string(TXOBJ_BASE_35)
            +                                                                       string(TXOBJ_BASEBILL) + ") "
            +           "                              AND nptxobj.t_AnaliticKind1 IN ( " + string(TXOBJ_KIND1115) + ", "
            +                                                                               string(TXOBJ_KIND1120) + ", "
            +                                                                               string(TXOBJ_KIND1125) + ", "
            +                                                                               string(TXOBJ_KIND1130) + ") "
            +           "                              AND nptxobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_EndDate)
            +           "                              AND nptxobj.t_client = CASE WHEN ? != -1 THEN ? ELSE nptxobj.t_client END"
            +           "                 ) "            
            +           "        ) " 
            +           IIF(((Investor != null) AND (Investor > 0)), " AND pt.t_PartyID = ? ", "")
            + "  UNION ALL "
            +           " SELECT pt.t_PartyID as Investor, 1 as KindIIS, "
            +           "        trim( pt.t_Name ) as InvestorName, "
            +           "        'ИИС_'|| ((CASE WHEN ( (SELECT LENGTH (trim(persn.t_Name1)) FROM DUAL) > 20) "
            +           "                    THEN  SUBSTR (trim(persn.t_Name1), 1, 20) " 
            +           "               ELSE trim(persn.t_Name1) END) " 
            +           "         || case when(persn.t_Name2 = CHR(1))then '' else SUBSTR (persn.t_Name2, 1, 1) end"
            +           "         || case when(persn.t_Name3 = CHR(1))then '' else SUBSTR (persn.t_Name3, 1, 1) end) as InvestorSheetName "
            +           "   FROM dpersn_dbt persn, dparty_dbt pt"
            +           "  WHERE     pt.t_LegalForm   = " + string(legal_form_phys)
            +           "        AND persn.t_PersonID = pt.t_PartyID"
            +           "        AND (   EXISTS(SELECT 1"
            +           "                         FROM dclient_dbt cl, dnptxop_dbt nptx "
            +           "                        WHERE     cl.t_PartyID   = pt.t_PartyID"
            +           "                              AND nptx.t_Client  = pt.t_PartyID"
            +           "                              AND nptx.t_IIS     = 'X'"
            +           "                              AND nptx.t_DocKind = " + string(DL_CALCNDFL)
            +           "                              AND cl.t_ServiceKind IN (" + string(PTSK_STOCKDL) + ", "
            +                                                                       string(PTSK_DV) + ", "
            +                                                                       string(PTSK_DEPOS) + ", "
            +                                                                       string(PTSK_SVO) + ") "
            +           "                              AND nptx.t_OperDate BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_EndDate)
            +           "                      )"
            +           "             OR EXISTS(SELECT 1"
            +           "                         FROM dnptxobj_dbt obj"
            +           "                        WHERE     obj.t_Client = pt.t_PartyID"
            +           "                              AND obj.t_Kind IN (" + string(TXOBJ_BASEMATERIAL_IIS) + ", "
            +                                                                 string(TXOBJ_BASEGENERAL_IIS) + ", "
            +                                                                 string(TXOBJ_BASESPECIAL_IIS) + ") "
            +           "                              AND obj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_EndDate)
            +           "              ) "
            +           "            )"
            +           IIF(((Investor != null) AND (Investor > 0 )), " AND pt.t_PartyID = ? ", "")
            + "        ) q "
            + " ORDER BY q.InvestorName, q.Investor ASC, q.KindIIS";

    cmd.AddParam(IIF(Investor!=null,Investor,-1));
    cmd.AddParam(IIF(Investor!=null,Investor,-1));
    
    if( (Investor != null) AND (Investor > 0 ) ) /*задан клиент*/
      cmd.AddParam(Investor);
    end;

    if( (Investor != null) AND (Investor > 0 ) ) /*задан клиент*/
      cmd.AddParam(Investor);
    end;
    
    cnt = cmd.GetCount(query);
    if(cnt > 0)
      InitProgress( cnt, "Краткая справка по расчету НДФЛ", "Краткая справка по расчету НДФЛ" );

      DataSet = cmd.Execute(query);
      stat = DataSet.moveNext();
      while(stat)

        DateSplit( this.Dend(), null, null, Year );
        if ((DataSet.KindIIS == 1) and (m_Form.GetFieldValue(PNFLD_NPTXSHORT_TYPE) == 50))
          m_BeginDate = GetFirstDateIIS(int(DataSet.Investor));
        else
          m_BeginDate = Date(1,1,Year);
        end;

        m_CurrIIS = int(DataSet.KindIIS);
        m_CurrInvestor = int(DataSet.Investor);
        m_CurrInvestorName = string(DataSet.InvestorName);
        InvestorSheetName = string(DataSet.InvestorSheetName);

        m_CurrInvestorSheetName = string(InvestorSheetName);
        
        stat = DataSet.moveNext();
        if(stat and (InvestorSheetName == string(DataSet.InvestorSheetName))) //инициалы инвесторов совпадают
          m_CurrInvestorSheetName = trim(InvestorSheetName) + string (iter);
          iter = iter + 1;
        else
          if(iter > 1)
            m_CurrInvestorSheetName = trim(InvestorSheetName) + string (iter);
          end;
          iter = 1;
        end;

        //Общий расчет
        CreateTotalCalc();

        if(SET_CHAR == m_Form.GetFieldValue(PNFLD_NPTXSHORT_REALIZ))
          CreateRealizRep();
        end;

        if(SET_CHAR == m_Form.GetFieldValue(PNFLD_NPTXSHORT_SHORTPOS))
          CreateShortPosRep();
        end;
        
        if(SET_CHAR == m_Form.GetFieldValue(PNFLD_NPTXSHORT_REPO))
          CreateRepoRep();
        end;

        if((m_Form.GetFieldValue(PNFLD_NPTXSHORT_TYPE) == 10) or (m_Form.GetFieldValue(PNFLD_NPTXSHORT_TYPE) == 50))
            CerateInvestDedRep();
        end;

        if(SET_CHAR == m_Form.GetFieldValue(PNFLD_NPTXSHORT_LUCRE))
            CreateReportNPTXLucre();
        end;
        
        UseProgress(i = i + 1);
      end;

      RemProgress();
    else
      SetActiveSheet( "Справка по расчету НДФЛ" );  
      PrintFormatString( NULL,"N1_NoRepData","Нет данных, удовлетворяющих параметрам отчета");
      CopyAllSheetInTotalBook( "Справка по расчету НДФЛ", false, "N1_NoRepData", 0 );
    end;

  END;

 
  MACRO ClearCacheOneRecord()
    this.ClearCacheOneRecord();
    m_DZS         = null;
    m_PrSRub      = null;
    m_AllSrub     = null;
    m_AllSrub_l   = null;
    m_DifS        = null;
    m_ComBankS    = null;
    m_ComExcS     = null;
    m_ComS        = null;      
    m_DZB         = null;    
    m_PrBrub      = null;
    m_AllBrub     = null;
    m_AllBrub_l   = null;
    m_MaterialB   = null;
    m_TaxMaterialB= null;
    m_DifB        = null;
    m_ComBankB    = null;
    m_ComExcB     = null;
    m_ComB        = null;
    m_TaxFRlink   = null;    
    m_TaxTags     = null;
    m_Qnty        = null;
    m_FRrub       = null;
    m_TaxLink     = null;
  END;

  /*Начало отчетного периода - 1 января года отчетной даты, указанной в форме запуска отчета*/
  MACRO Dbeg()                                                                
    VAR Year;
    DateSplit( this.Dend(), null, null, Year );
    return date(1,1,Year); 
  END;
 
  /*Окончание отчетного периода*/
  MACRO Dend()
          
    m_EndDate =  m_Form.GetFieldValue( PNFLD_NPTXSHORT_DATE );
    return m_EndDate; 
  END;

  /*Количество, проданное в этой сделке продажи, из этой покупки*/
  MACRO Qnty(IsMaterial)
    if(m_Qnty == null)
      if(IsMaterial == NULL)
         IsMaterial = false;
      end;

      if(IsMaterial)
         m_Qnty = this.Qnty();
      else
         m_Qnty = m_RS.Qnty;
      end;
    end;
    return m_Qnty;
  END;

  MACRO ЭтоВиртПокупка()
     return (m_RS.BuyIsVirtual == 1);
  END;

  MACRO ЭтоВиртПродажа()
     return (m_RS.SaleIsVirtual == 1);
  END;

   /*Дата оплаты сделки продажи*/
  MACRO DPS()
    if( ЭтоВиртПродажа() )/*для виртуальных*/
       return SQL_ConvTypeDate(m_RS.SaleDate);
    end;
    return  SQL_ConvTypeDate(m_RS.SalePayDate);
  END;

  /*Цена сделки продажи*/
  MACRO PrSrub()

    if( IsRET_ISSUE( Int(m_RS.SaleGroup) ) )
       m_PrSRub = "100%";
    elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) or IsRET_COUPON( Int(m_RS.SaleGroup) ) )
       m_PrSRub = "";
    elif( ЭтоВиртПродажа() )/*для виртуальных берем из лота*/

       m_PrSRub = m_RS.SalePrice;

       if(m_RS.VpS != NATCUR)
          SmartConvertSumDbl(m_PrSRub, m_PrSRub, this.DPS(), m_RS.VpS, NATCUR, false);
       end;

    else

       if(m_RS.VpS == NATCUR)
          m_PrSRub = GetPriceByDlTickDlLeg(this.DealSale().rec, this.LegSale().rec, null, null, m_RS.SaleDate);
       else    
          SmartConvertSumDbl(m_PrSRub, GetPriceByDlTickDlLeg(this.DealSale().rec, this.LegSale().rec, null, null, m_RS.SaleDate), this.DPS(), m_RS.VpS, NATCUR, false);
       end;

    end;

    return m_PrSRub;
  END;

  /*Сумма сделки продажи включая НКД*/
  MACRO AllSrub()
    if (m_AllSrub == null)
       if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
         var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                            " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;
         m_AllSrub = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MAINS_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
       elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
          if(m_RS.VpS == NATCUR)
            m_AllSRub = m_RS.SalePrice;
          else
            SmartConvertSumDbl(m_AllSRub, m_RS.SalePrice, this.DPS(), m_RS.VpS, NATCUR, false);
          end;
       elif(m_RS.LinkID >  0)
          DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                                 string(TXOBJ_MAINS) + ", " + string(TXOBJ_NKDS) + ", "+ string(TXOBJ_MAINS_SHORT) + ", " + string(TXOBJ_NKDS_SHORT),
                                 m_BeginDate, 
                                 m_EndDate, 
                                 TXOBJ_DIR_ALL, 
                                 null, 
                                 @m_AllSrub, null, true
                                );
       else
          if(m_RS.VpS == NATCUR)
            m_AllSRub = m_RS.SalePrice;
          else
            SmartConvertSumDbl(m_AllSRub, m_RS.SalePrice, this.DPS(), m_RS.VpS, NATCUR, false);
          end;
       end;
    end;
    return m_AllSRub;
  END;

  MACRO AllSrub_L()
    if (m_AllSrub_l == null)
      if(m_RS.LinkID >  0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                               string(TXOBJ_MAINS) + ", " + string(TXOBJ_MAINS_SHORT),
                               m_BeginDate,
                               m_EndDate,
                               TXOBJ_DIR_ALL,
                               null,
                               @m_AllSrub_l, null, true
                              );
      else
        if(m_RS.VpS == NATCUR)
          m_AllSrub_l = m_RS.SalePrice;
        else
          SmartConvertSumDbl(m_AllSrub_l, m_RS.SalePrice, this.DPS(), m_RS.VpS, NATCUR, false);
        end;
      end;
    end;
    return m_AllSrub_l;
  END;

  /*Сумма отклонения от рынка сделки продажи*/
  MACRO DifS()
    if( m_DifS == null )
      if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) or IsRET_COUPON( Int(m_RS.SaleGroup) ) )
         m_DifS = $0;
      else
         DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                                string(TXOBJ_DIFS)+","+string(TXOBJ_DIFS_SHORT), 
                                m_BeginDate, 
                                m_EndDate, 
                                TXOBJ_DIR_ALL, 
                                null, 
                                @m_DifS, null, true
                               );
       end;
    end;
    return m_DifS;
  END;

  /*Комиссия банка для сделки продажи*/
  MACRO ComBankS()
    VAR pSum = $0, pNDS = $0; 
    if( m_ComBankS == null )/*если связь с виртуальной покупкой, то сумму комиссии по продаже не выводим*/ 
      m_ComBankS = $0;
      if(not ЭтоВиртПокупка())
        SP_GetSumCom( pSum, pNDS, null, null, 
                      m_RS.SBOfficeKind, m_RS.DealSaleID, null, date(0,0,0), m_EndDate, 1, 0,   
                      1, 0, 1, 1, null, 0, true );
        if (m_RS.LinkID > 0)
          m_ComBankS = pSum * m_RS.Qnty/m_RS.SPrincipal;
        else
          m_ComBankS = pSum;
        end;
      end;
    end;
     
    return m_ComBankS;
  END;

  /*Комиссия биржи  сделки продажи*/
  MACRO ComExcS()
    VAR pSum = $0, pNDS = $0; 
    if( m_ComExcS == null )/*если связь с виртуальной покупкой, то сумму комиссии по продаже не выводим*/
      m_ComExcS = $0;
      if( not ЭтоВиртПокупка() )
        SP_GetSumCom( pSum, pNDS, null, null, 
                      m_RS.SBOfficeKind, m_RS.DealSaleID, null, date(0,0,0), m_EndDate, 0, 1,   
                      1, 0, 1, 1, null, 0, true );

        if (m_RS.LinkID > 0) 
          m_ComExcS = pSum * m_RS.Qnty/m_RS.SPrincipal;
        else
          m_ComExcS = pSum;
        end;
      end;
    end;
     
    return m_ComExcS;

  END;

  /*Всего комиссий сделки продажи*/
  MACRO ComS()
    var AddWhereCond;
    if( m_ComS == null )
      if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                       " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;
        m_ComS = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COMS_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        if( m_Rs.CouponNDFL == SET_CHAR )/*тут непонятно пока, т.к. в реализации на сегодня для операции погашения купонов TXOBJ_COMS_TS не рассчитывается*/
           AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1050+" and obj.t_Analitic1 = "+m_RS.Number_Coupon +
                          " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;
           m_ComS = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COMS_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
        else
           m_ComS = $0;
        end;
      elif (m_RS.LinkID > 0)/*по связи с виртуальными покупками НДР по комиссиям по продажам создаваться не должны (поэтому дополнительные проверки на отбор комиссий не вводим)*/  
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_COMS) + ", " + string(TXOBJ_COMS_SHORT),
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_ComS, null, true
                              );
      else 
        m_ComS = this.ComExcS() + this.ComBankS();
      end; 
    end;
    return m_ComS;

  END;

  /*Дата оплаты сделки покупки*/
  MACRO DPB()
    if( ЭтоВиртПокупка() )/*для виртуальных*/
       return SQL_ConvTypeDate(m_RS.BuyDate);
    end;
    return SQL_ConvTypeDate(m_RS.PayBuyDate);
  END;

  /*Цена сделки покупки*/
  MACRO PrBrub()

    if( ЭтоВиртПокупка() )/*для виртуальных берем из лота*/

       m_PrBRub = m_RS.BuyPrice;

       if(m_RS.VpB != NATCUR)
          SmartConvertSumDbl(m_PrBRub, m_PrBRub, this.DPB(), m_RS.VpB, NATCUR, false);
       end;

    else

       if( m_PrBRub == null ) 
         m_PrBRub = $0; 
         if( m_RS.LinkID > 0 )
           if(m_RS.VpB == NATCUR)
              m_PrBRub = GetPriceByDlTickDlLeg(this.DealBuy().rec, this.LegBuy().rec, null, null, m_RS.BuyDate); 
           else    
              SmartConvertSumDbl(m_PrBRub, GetPriceByDlTickDlLeg(this.DealBuy().rec, this.LegBuy().rec, null, null, m_RS.BuyDate), this.DPB(), m_RS.VpB, NATCUR, false);  
           end;
         end;
       end;

    end;

    return m_PrBRub;
  END;
 
  /*Сумма сделки покупки включая НКД*/
  MACRO AllBrub()
    if(m_AllBrub == null)
      m_AllBrub = $0;
      if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                           " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;
        m_AllBrub = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MAINB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_AllBrub = $0;
      elif(m_RS.LinkID > 0 )
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_MAINB) + ", " + string(TXOBJ_NKDB) + ", " + string(TXOBJ_MAINB_SHORT) + ", " + string(TXOBJ_NKDB_SHORT),
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_AllBrub, null, true
                              );
      end;
    end;
    return m_AllBRub;
  END;

  MACRO Plusi()
    DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                           string(TXOBJ_PLUSI),
                           m_BeginDate,
                           m_EndDate,
                           TXOBJ_DIR_ALL,
                           @m_Plusi, null, true
                          );
    return m_Plusi;
  END;

  MACRO FR_Sec_3Y()
    DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                           string(TXOBJ_FR_SEC_3Y),
                           m_BeginDate,
                           m_EndDate,
                           TXOBJ_DIR_ALL,
                           @m_FR_Sec_3Y, null, true
                          );
    return m_FR_Sec_3Y;
  END;

  MACRO AllBrub_L()
    if(m_AllBrub_l == null)
      m_AllBrub_l = $0;
      if(m_RS.LinkID > 0 )

        DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                               string(TXOBJ_MAINB) + ", " + string(TXOBJ_MAINB_SHORT),
                               m_BeginDate,
                               m_EndDate,
                               TXOBJ_DIR_ALL,
                               null,
                               @m_AllBrub_l, null, true
                              );
      end;
    end;
    return m_AllBRub_l;
  END;

  /*Материальная выгода сделки покупки*/
  MACRO MaterialB()
    if(m_MaterialB == null )
      m_MaterialB = $0;
      if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                           " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;
        m_MaterialB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MATERIALB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_MaterialB = $0;
      elif(m_RS.LinkID > 0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_MATERIALB), 
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_MaterialB, null, true
                              );
      end;
    end;
    return m_MaterialB;

  END;

  /*Налог на матвыгоду для сделки покупки*/
  MACRO TaxMaterialB()
    if(m_TaxMaterialB == null )
      m_TaxMaterialB = $0;
      if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                           " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;
        m_TaxMaterialB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_TAXPM_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_TaxMaterialB = $0;
      elif(m_RS.LinkID > 0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_TAXPM_LINK), 
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_TaxMaterialB, null, true
                              );
      end;
    end;
    return m_TaxMaterialB;

  END;

  /*Сумма отклонения от рынка для сделки покупки*/
  MACRO DifB()
    if(m_DifB == null)
      m_DifB = $0;
      if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
         var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                            " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;
         m_DifB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_DIFB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_DifB = $0;
      elif(m_RS.LinkID > 0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_DIFB)+","+string(TXOBJ_DIFB_SHORT), 
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_DifB, null, true
                              );
      end;

    end;
    return m_DifB;

  END;

  /*Комиссия банка для сделки покупки*/
  MACRO ComBankB()
    VAR pSum = $0, pNDS = $0;
    VAR Koef = 1, Koef1 = 1;
    if( m_ComBankB == null )/*по виртуальным покупкам не выводим*/
      m_ComBankB = $0;
      if((m_RS.LinkID > 0 ) and (not ЭтоВиртПокупка()))
        if( (m_RS.AVOIRKIND == AVOIRISSKIND_BOND_OVVZ ) AND (m_RS.DealSaleDate >= date ("01.01.2019")) AND (m_RS.FaceValueFI!= natcur) )
          if ( m_RS.BCourseNominal != 0  )
            Koef = m_RS.SCourseNominal / m_RS.BCourseNominal;
          end;
          if ( (m_RS.BPrincipal * m_RS.NominalAVROnB) != 0 ) //
            Koef1 = ( m_RS.Qnty * m_RS.NominalAVROnS / (m_RS.BPrincipal * m_RS.NominalAVROnB) );
          end;

          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 1, 0,   
                        1, 0, 1, 1, null, 0, true, null, null, null,
                        Koef,Koef1, m_RS.SaleDateOVVZ); 

          m_ComBankB = pSum;
        else
          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 1, 0,   
                        1, 0, 1, 1, null, 0, true );
          
          m_ComBankB = pSum*m_RS.Qnty/m_RS.BPrincipal;
        end
      end;
    end;
     
    return m_ComBankB;

  END;

  /*Комиссия биржи для сделки покупки*/
  MACRO ComExcB()
    VAR pSum = $0, pNDS = $0;
    VAR Koef = 1, Koef1 = 1;
    if( m_ComExcB == null )/*по виртуальным покупкам не выводим*/
      m_ComExcB = $0;
      if((m_RS.LinkID > 0 ) and (not ЭтоВиртПокупка()))
        if( (m_RS.AVOIRKIND == AVOIRISSKIND_BOND_OVVZ ) AND (m_RS.DealSaleDate >= date ("01.01.2019")) AND (m_RS.FaceValueFI!= natcur) )
          if ( m_RS.BCourseNominal != 0  )
            Koef = m_RS.SCourseNominal / m_RS.BCourseNominal;
          end;
          if ( (m_RS.BPrincipal * m_RS.NominalAVROnB) != 0 ) //
            Koef1 = ( m_RS.Qnty * m_RS.NominalAVROnS / (m_RS.BPrincipal * m_RS.NominalAVROnB) );
          end;

          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 0, 1,   
                        1, 0, 1, 1, null, 0, true, null, null, null,
                        Koef, Koef1, m_RS.SaleDateOVVZ); 
          m_ComExcB = pSum;
        else
          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 0, 1,   
                        1, 0, 1, 1, null, 0, true );
        
          m_ComExcB = pSum*m_RS.Qnty/m_RS.BPrincipal;
        end
      end;
    end;
     
    return m_ComExcB;

  END;

  /*Всего комиссий по сделке покупки*/
  MACRO ComB(IsMaterial)
    if(IsMaterial == NULL)
       IsMaterial = false;
    end;

    if( m_ComB == null )/*по связи с виртуальными покупками НДР по комиссиям по покупкам создаваться не должны (поэтому дополнительные проверки на отбор комиссий не вводим)*/  
      if(IsMaterial)
        m_ComB = m_RS.ComB;
      else
        m_ComB = $0;
        if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
          m_ComB = $0;
          /*
          var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly+
                             " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID; 
          m_ComB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COMB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond);
          */
        elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
          m_ComB = $0;
        elif(m_RS.LinkID > 0)
          DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                                 string(TXOBJ_COMB) + ", " +string(TXOBJ_COMB_SHORT),
                                 m_BeginDate, 
                                 m_EndDate, 
                                 TXOBJ_DIR_ALL, 
                                 null, 
                                 @m_ComB, null, true
                                );
        end;
      end;
    end;
    return m_ComB;
  END;

  MACRO FRrub():MONEY
    var FRrubIn = 0.0, FRrubOut = 0.0;
    if(m_FRrub == NULL)
      DL_GetNPTXOBJSumByLink(m_Rs.LinkID, string(TXOBJ_FR_LINK), NULL, NULL, TXOBJ_DIR_IN, NULL, @FRrubIn);
      DL_GetNPTXOBJSumByLink(m_Rs.LinkID, string(TXOBJ_FR_LINK), NULL, NULL, TXOBJ_DIR_OUT, NULL, @FRrubOut);
      m_FRrub = FRrubIn - FRrubOut;
    end;
    return m_FRrub;
  END;

  MACRO TaxLink():MONEY
    if( m_TaxLink == NULL )
       var TaxLink_plus = $0, TaxLink_minus = $0;
       DL_GetNPTXOBJSumByLink(m_Rs.LinkID, string(TXOBJ_TAX_LINK), m_BeginDate, m_EndDate, TXOBJ_DIR_IN,  NULL, @TaxLink_plus);
       DL_GetNPTXOBJSumByLink(m_Rs.LinkID, string(TXOBJ_TAX_LINK), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, NULL, @TaxLink_minus);
       m_TaxLink = TaxLink_plus - TaxLink_minus;
    end;
    return m_TaxLink;
  END;

  /*Сумма для налогообложения*/
  MACRO TaxFRlink()
    if( m_TaxFRlink == null )
      if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )

         var AddWhereCond_FR_TS = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                                  " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID, 

             AddWhereCond_DIFB_TS = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly+
                                    " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID + 
                                    " and obj.t_AnaliticKind2 = "+TXOBJ_KIND2020+" and obj.t_Analitic2 in (select obj2.t_Analitic2 "+
                                                                                                        "    from dnptxobj_dbt obj2 "+
                                                                                                        "   where obj2.t_AnaliticKind2 = obj.t_AnaliticKind2 "+
                                                                                                        "     and obj2.t_Direction = "+string(TXOBJ_DIR_OUT)+
                                                                                                        "     and obj2.t_Client = obj.t_Client "+
                                                                                                        "     and obj2.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj2.t_Analitic3 = "+m_RS.FIID +
                                                                                                        "     and RSI_NPTO.CheckObjIIS ( " + TXOBJ_KIND6020 + ", obj2.t_Analitic6 )  = "+string(m_CurrIIS)+      
                                                                                                        " )";

         m_TaxFRlink =
            GetRubSumByClient(m_CurrInvestor, string(TXOBJ_FR_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_IN, m_CurrIIS, true, AddWhereCond_FR_TS) -
            GetRubSumByClient(m_CurrInvestor, string(TXOBJ_FR_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, true, AddWhereCond_FR_TS) - 
            GetRubSumByClient(m_CurrInvestor, string(TXOBJ_DIFB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, true, AddWhereCond_DIFB_TS);

      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        if( (m_RS.TaxGroupNPTX == 40) and (m_RS.TaxGroupNPTX == 50) )
          m_TaxFRlink = $0;
        else
          m_TaxFRlink = AllSRub();
        end;
      elif(m_RS.LinkID > 0)
         if( (m_RS.TaxGroupNPTX == 50) and (m_RS.SaleDocKind == DL_RETIREMENT) )
            m_TaxFRlink = TaxLink() - DifB() - AllSrub_L();
         else
            if( FRrub() < 0 )
               m_TaxFRlink = TaxLink() + DifS() - DifB();
            else
               m_TaxFRlink = TaxLink();
            end;
         end;
      end;
    end;
    return m_TaxFRlink;
  END;

  /*Обращаемость ц/б*/
  MACRO SecType(IsLucre)
    if(IsLucre == NULL)
       IsLucre = false;
    end;

    if(IsLucre)
       return DL_GetNPTXSecType(m_Rs.FIID);
    else
       return  IIF(m_RS.SIfMarket == SET_CHAR, "да", "нет");
    end;
  END;

  MACRO Material():MONEY
    var m_Material;
    if(m_Material == NULL)
       DL_GetNPTXOBJSumByDeal(m_Rs.DealBuyID, string(TXOBJ_MATERIAL), NULL, this.Dend(), TXOBJ_DIR_ALL, NULL, @m_Material, null, m_Rs.Investor);  
    end;
    return m_Material;
  END;

  MACRO GetPrivQntyByTS()
    var v_PrivQnty = $0;
    var cmd = DL_RSDCommand("select nvl(sum(RSI_NPTX.GetPrivAmountByTS(T.t_ID,?,?)),0) PrivQnty "+
                            "  from dnptxlot_dbt LB, dnptxts_dbt T " +
                            " where LB.t_Kind = ? " +
                            "   and T.t_BuyID  = LB.t_ID " +
                            "   and T.t_Type = ? " +
                            "   and T.t_Client = ? " +
                            "   and T.t_Contract = ? " +
                            "   and RSI_NPTO.CheckContrIIS (T.t_Contract) = ? " +
                            "   and T.t_Amount > 0 " +
                            "   and T.t_FIID = ? " +
                            "   and T.t_BegDate < ? " +
                            "   and (T.t_EndDate >= ? or T.t_EndDate = TO_DATE('01-01-0001','DD-MM-YYYY') )"
                           );

    cmd.AddParam(m_EndDate);
    cmd.AddParam(m_RS.DealSaleDate);
    cmd.AddParam(NPTXLOTS_BUY);
    cmd.AddParam(NPTXTS_REST);
    cmd.AddParam(m_CurrInvestor);
    cmd.AddParam(m_RS.Contract);
    cmd.AddParam(m_CurrIIS);
    cmd.AddParam(m_RS.FIID);
    cmd.AddParam(m_RS.DealSaleDate);
    cmd.AddParam(m_RS.DealSaleDate);
    
    var DataSet = cmd.Execute();

    if( DataSet.moveNext() )
       v_PrivQnty = SQL_ConvTypeSum(DataSet.PrivQnty);
    end;

    return v_PrivQnty;
  END;

  /*Особенности налогообложения*/
  MACRO TaxTags()
    var Group: Integer, v_PrivQnty = $0;
    Group = Int(m_RS.SaleGroup);
     
    if( m_TaxTags == NULL )

       m_TaxTags = "";

       if( m_RS.TaxGroupNPTX == 30 )
         m_TaxTags = "ипотечные";
    /*   elif( m_RS.TaxGroupNPTX == 40 )
         m_TaxTags = "0%ПКД";
       elif( m_RS.TaxGroupNPTX == 50 )
         m_TaxTags = "0% ПКД и погашения";  */  /*BIQ-6982 */
       end;
   
       if( m_RS.PrivQnty > 0 )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "льготных ц/б - " + int(m_RS.PrivQnty);/*в отчете кол-во округляется до целого (значит, здесь тоже округляем)*/
       end;

       if( (m_RS.SIfMarket != m_RS.BIfMarket ) and (m_RS.LinkID > 0))
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "изменение обращаемости";
       end;
       if( IsRET_ISSUE( Group ) )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "погашение выпуска";
       elif( IsRET_COUPON( Group ) )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "погашение купона";
       elif( IsRET_PARTLY( Group ) )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "частичное погашение";
       end;
                             
       if( IsRET_PARTLY( Group ) )
         v_PrivQnty = GetPrivQntyByTS();
         if( v_PrivQnty > $0 )
           if ( m_TaxTags != "" )
             m_TaxTags = m_TaxTags + ", ";
           end;
           m_TaxTags = m_TaxTags + "льготных ц/б - " + int(v_PrivQnty);/*в отчете кол-во округляется до целого (значит, здесь тоже округляем)*/
         end;
       end;

    end;
    
    return m_TaxTags;
  END;

  initTX_RegistrReport( NPTXShort_Panel(), "Report_NptxShort.xls" );
END;

  NPTXShort_Report().Run;

 exit(1);
