/*
$Name:             IncC_Reg_Report.mac
$Module:           АРНУ
$Description:      Отчёт "Регистры по начислению 2014" (НУ)
*/
IMPORT "IncC_Reg_Form.mac", "RegistrReport.mac";

PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

PRIVATE VAR IncC_Rep_Form;
PRIVATE VAR IncC_Rep_Report;
PRIVATE VAR WebMenuItem; // Информация о запуске отчета из веб

PRIVATE CONST OurCountryLat3 = "RUS";

PRIVATE CONST ТочностьСпецКурса = 9;

PRIVATE CONST BLUECOLOR = RGB(255,255,204);

PRIVATE CONST SHEET_1 = "0411";
PRIVATE CONST SHEET_2 = "Свод_0411";

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА = 26;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ = 29;

/*имена ячеек в шаблоне*/

PRIVATE CONST C_SecCode         = "A",
              C_SecCode2        = "C",
              C_NkdBvp          = "S",
              C_SumBRub_Amort   = "M",
              C_SumBvp          = "AQ",
              C_Qnty            = "G",
              C_Nom_DDB         = "Q",
              C_AmortVN_before  = "AJ",
              C_AmortVN_after   = "AK",
              C_AmortRub        = "L",
              C_SumBRub         = "AR",
              C_NkdRepRub       = "AE",
              C_CoupRub         = "AC",
              C_NkdPrevRub      = "AA",
              C_NkdBrepRub      = "W",
              C_DifB            = "AZ",
              C_KPNom           = "AP",
              C_AmortVNPer      = "AL",
              C_AmortVNaccPer   = "AM",
              C_CrBD            = "AO",
              C_TaxeAmort       = "BK",
              C_TaxeNKD         = "BL",
              C_NKDallRub       = "H",
              C_NKDallRub1      = "I",
              C_NKDallRub2      = "J",
              C_SumBDif         = "N",
              C_FinRes          = "BM",
              C_TaxeAll         = "BJ",
              C_SumBvp_exps     = "AS",
              C_CoupVN          = "AB",
              C_NomH01          = "BO",
              C_NomH02          = "BP",
              C_ComBRub_Amort   = "O";

PRIVATE CLASS (TX_RegistrReport) SP_IncReg_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL )
  PRIVATE VAR m_IsExistsData = false, m_CurrStrNum = 0;
  PRIVATE VAR m_ReportDate = ZeroDate, m_BeginDate = ZeroDate, m_AvrTaxGroup = TArray(), m_AvrFIID = TArray(), m_AvrName = "";
  PRIVATE VAR m_FIID,
              m_ifCoup,
              m_NkdBvp,
              m_NkdBrub,
              m_NKDrepVN,
              m_NkdRepRub,
              m_ControlCode,
              m_AmortVNPer,
              m_AmortVN_after,
              m_AmortVN_before,
              m_CoupCount,
              m_ComBRub_Amort,
              m_SCTXUseCommAsOutlay = SCTXUseCommAsOutlay(),
              m_TaxDepositoryMode = CheckTaxDepositoryMode(),
              m_CrVPr_DDB,
              m_CrSpezB,
              m_DDB;

 /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsExistsData or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END; 

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;
  
  /*macro PrintLineAutoSumma()
  end;*/

  PRIVATE MACRO BeginReport()
     SQL_Truncate( "dspprtcst_tmp" );

     m_ReportDate = IncC_Rep_Form.GetFieldValue(PNFLD_INCC_REG_ENDDATE);
     m_BeginDate = IncC_Rep_Form.GetFieldValue(PNFLD_INCC_REG_BEGINDATE);

     if( not m_IsWebService )
        var AvrTaxGroup = IncC_Rep_Form.GetFieldValue(PNFLD_INCC_REG_AVRGROUP);
        if( AvrTaxGroup > 0 )
           m_AvrTaxGroup.Size = 0;
           m_AvrTaxGroup[m_AvrTaxGroup.Size] = AvrTaxGroup;
        end;
        var AvrFIID = IncC_Rep_Form.GetFieldValue(PNFLD_INCC_REG_AVRCODE);
        if( AvrFIID != ALLFININSTR )
           m_AvrFIID.Size = 0;
           m_AvrFIID[m_AvrFIID.Size] = AvrFIID;
        end;
     else
        m_AvrTaxGroup = IncC_Rep_Form.GetFieldValue(PNFLD_INCC_REG_AVRGROUP);
        m_AvrFIID     = IncC_Rep_Form.GetFieldValue(PNFLD_INCC_REG_AVRCODE);
     end;
     m_AvrName = IncC_Rep_Form.GetFieldValue(PNFLD_INCC_REG_AVRNAME);

     m_IsExistsData = false;
  END;

  PRIVATE MACRO SetAutoFilter()
     if( ExistsSheet( SHEET_1 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:BS28", SHEET_1);
     end;

     if( ExistsSheet( SHEET_2 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:Y28", SHEET_2);
     end;
  END;

  PRIVATE MACRO EndReport()
    EndReport();
    SetAutoFilter();
    //setRecreateSheets(true);
  END;

  MACRO Операционист()
     var vRS = TRsbDataSet("SELECT person.t_Name " +
                           "  FROM dperson_dbt person " +
                           " WHERE person.t_oper = " + string({oper})
                          );

     if( vRS.MoveNext() )
        return vRS.Name;
     end;

     return "";
  END;

  MACRO PaintStr()
     this.SetCurrentLineFont( 8, true, false );
     this.SetCellFont("N1_NKDallRub", 8, true, false, null, null, DefaultBkGrColor );             
     this.SetCellFont("N1_SumBRub_Amort", 8, true, false, null, null, DefaultBkGrColor );         
     this.SetCellFont("N1_SumBDif", 8, true, false, null, null, DefaultBkGrColor );     
     this.SetCellFont("N1_AmortVN", 8, true, false, null, null, BLUECOLOR ); 
     this.SetCellFont("N1_AmortVNaccPer", 8, true, false, null, null, BLUECOLOR );     
     this.SetCellFont("N1_KPNom", 8, true, false, null, null, BLUECOLOR );
     this.SetCellFont("N1_SumBRub", 8, true, false, null, null, BLUECOLOR );
     this.SetCellFont("N1_SumBvp_exps", 8, true, false, null, null, BLUECOLOR );              
     this.SetCellFont("N1_TaxeAll",8, true, false, null, null, BLUECOLOR );             
     this.SetCellFont("N1_TaxeAmort", 8, true, false, null, null, BLUECOLOR );
     this.SetCellFont("N1_TaxeNKD",8, true, false, null, null, BLUECOLOR );
     this.SetCellFont("N1_FinRes",8, true, false, null, null, BLUECOLOR );     
  END;


  /*промежут итоги сейчас считаются только по первой вкладке (а нужно по всем)*/
  MACRO ПечататьПромежуточныеИтоги_1()
     SetSubTotalEx1( НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА, НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                    "G23",
                    "H23",
                    "I23",
                    "J23",
                    "L23",
                    "M23",
                    "N23",
                    "O23",
                    "S23",
                    "T23",
                    "U23",
                    "V23",
                    "W23",
                    "X23",
                    "Z23",
                    "AA23",
                    "AB23",
                    "AC23",
                    "AD23",
                    "AE23",
                    "AI23",
                    "AJ23",
                    "AK23",
                    "AL23",
                    "AM23",
                    "AQ23",
                    "AR23",
                    "AS23",
                    "AZ23",
                    "BJ23",
                    "BK23",
                    "BL23",
                    "BM23",
                    "BP23",
                    "BQ23",
                    "BR23"
                  );                                                                      
  END;

  /*промежут итоги сейчас считаются только по первой вкладке (а нужно по всем)*/
  MACRO ПечататьПромежуточныеИтоги_2()
     SetSubTotalEx1( НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА, НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                    "E22",
                    "F22",
                    "G22",
                    "H22",
                    "I22",
                    "J22",
                    "K22",
                    "L22",
                    "M22",
                    "N22",
                    "O22",
                    "P22",
                    "Q22",
                    "R22",
                    "S22",
                    "T22",
                    "U22",
                    "V22",
                    "W22",
                    "X22"
                  );
  END;

  PRIVATE MACRO OnAfterFirstAutoFill()
     if( m_ObjTemplateXLS.SheetName() == SHEET_1 )
        this.ПечататьПромежуточныеИтоги_1();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_2 )
        this.ПечататьПромежуточныеИтоги_2();
     end;
  END;

  macro RegisterTable_1()

     SetActiveSheet( SHEET_1 );

     PrintFormatString( "",
                        "N1_ДатаСоставления", string(Date()) + " " + string(Time()),
                        "N1_НомерОпера",      string({oper}),  /* Номер операциониста, запустившего отчет */
                        "N1_Операционист",    this.Операционист(),
                        "N1_H0_A",            this.H0_A(),
                        "N1_H0_B",            this.H0_B(),
                        "N1_H0_C",            this.H0_C(),
                        "N1_H0_1",            this.H0_1(),
                        "N1_H0_2",            this.H0_2(),
                        "N1_H0_3",            this.AvrTaxGroupName(),
                        "N1_H0_4",            this.AvrName()
                      );

     SetRowFlushCount(1000);

     RegisterTable( "N1_MainTable", "",
                    "N1_SecCode", "N1_SecName", "N1_CodeB", "N1_DZB", "N1_TypeB", "N1_DDB", "N1_Qnty", "N1_NKDallRub", "N1_NKDallRub1", "N1_NKDallRub2", "N1_StatusSec", "N1_AmortRub", "N1_SumBRub_Amort", "N1_SumBDif",
                    "N1_ComBRub_Amort", "N1_VN",
                    "N1_Nom_DDB", "N1_DR", "N1_NkdBvp", "N1_NkdBVN", "N1_NkdBrub", "N1_NkdBprevRub", "N1_NkdBrepRub", "N1_ifCoupPrev", "N1_Tprev", "N1_NkdPrevVN", "N1_NkdPrevRub", "N1_CoupVN",
                    "N1_CoupRub", "N1_NkdRepVN", "N1_NkdRepRub", "N1_CoupCount", "N1_LastCoupDate", "N1_ControlNKD", "N1_AmortVN", "N1_AmortVN_before", "N1_AmortVN_after", "N1_AmortVNPer", "N1_AmortVNaccPer",
                    "N1_VPrB", "N1_CrBD", "N1_KPNom", "N1_SumBvp", "N1_SumBRub", "N1_SumBvp_exps", "N1_PrBvp", "N1_MaxMrkt", "N1_Val_MarketB", "N1_MrktB", "N1_DMrktB","N1_QuoteValueB", "N1_DifB", "N1_RCB",
                    "N1_RFISSB", "N1_DqualB", "N1_CodeDR", "N1_DD1DR", "N1_Dlink", "N1_K_ControlB", "N1_Control_CommentB", "N1_SecType", "N1_TaxeAll", "N1_TaxeAmort", "N1_TaxeNKD", "N1_FinRes", "N1_ISIN",
                    "N1_Nom_H01", "N1_Nom_H02", "N1_PlusNom_IN", "N1_MinusNom_IN", "N1_Nom_IN_Before", "N1_DGO"
                  );

     SetCellAutoSumma( "Всего:",
                       "N1_Qnty", "N1_NKDallRub", "N1_NKDallRub1", "N1_NKDallRub2", "N1_AmortRub", "N1_SumBRub_Amort", "N1_SumBDif", "N1_ComBRub_Amort", "N1_NkdBvp", "N1_NkdBVN", "N1_NkdBrub", "N1_NkdBprevRub", 
                       "N1_NkdBrepRub", "N1_ifCoupPrev", "N1_NkdPrevVN",
                       "N1_NkdPrevRub", "N1_CoupVN", "N1_CoupRub", "N1_NkdRepVN", "N1_NkdRepRub", "N1_ControlNKD", "N1_AmortVN", "N1_AmortVN_before", "N1_AmortVN_after", "N1_AmortVNPer", "N1_AmortVNaccPer",
                       "N1_SumBvp", "N1_SumBRub", "N1_SumBvp_exps", "N1_DifB", "N1_TaxeAll", "N1_TaxeAmort", "N1_TaxeNKD", "N1_FinRes",
                       "N1_PlusNom_IN", "N1_MinusNom_IN", "N1_Nom_IN_Before"
                     );

      
     this.PaintStr();     
     PrintTableLine( "N1_SecCode", "Всего:", null );    
     this.PaintStr();
     PrintTableLine( "N1_SecCode", "В т.ч.", null );

  end;

  macro RegisterTable_2()

     SetActiveSheet( SHEET_2 );

     PrintFormatString( "",
                        "N2_ДатаСоставления", string(Date()) + " " + string(Time()),
                        "N2_НомерОпера",      string({oper}),  /* Номер операциониста, запустившего отчет */
                        "N2_Операционист",    this.Операционист(),
                        "N2_H0_A",            this.H0_A(),
                        "N2_H0_B",            this.H0_B(),
                        "N2_H0_C",            this.H0_C(),
                        "N2_H0_1",            this.H0_1(),
                        "N2_H0_2",            this.H0_2(),
                        "N2_H0_3",            this.AvrTaxGroupName(),
                        "N2_H0_4",            this.AvrName()
                      );

     SetRowFlushCount(1000);

     RegisterTable( "N2_MainTable", "",
                    "A27", "N2_SecType", "N2_SecCode", "N2_SecName", "N2_FinRes", "N2_SumBDif", "G27", "H27", "N2_TaxeAll", "N2_TaxeAmort", "N2_TaxeNKD", "N2_Qnty",
                    "N2_AmortRub", "N2_SumBRub_Amort", "O27", "N2_SumBvp_exps", "N2_NKDallRub1", "N2_NKDallRub2", "S27", "T27", "N2_NkdBvp", "N2_AmortVNaccPer", "N2_CoupVN", "N2_NkdPrevRub", "N2_ISIN"
                  );

     SetCellAutoSumma( "Всего:",
                       "N2_FinRes", "N2_SumBDif", "G27", "H27", "N2_TaxeAll", "N2_TaxeAmort", "N2_TaxeNKD", "N2_Qnty", "N2_AmortRub", "N2_SumBRub_Amort",
                       "O27", "N2_SumBvp_exps", "N2_NKDallRub1", "N2_NKDallRub2", "S27", "T27", "N2_NkdBvp", "N2_AmortVNaccPer", "N2_CoupVN", "N2_NkdPrevRub"
                     );

     SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     PrintTableLine( "N2_SecName",  "Всего:", null );
     SetCurrentLineFont( 8, false, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     PrintTableLine( "N2_SecName",  "В т.ч.", null );

  end;

  macro PrintTableLine_1()

     m_CurrStrNum = this.НомерТекущейСтроки();

     PrintTableLine( "N1_SecCode",          this.SecCode(),         null,
                     "N1_SecName",          this.SecName(),         null,
                     "N1_CodeB",            this.CodeB(),           null,
                     "N1_DZB",              this.DZB(),             null,
                     "N1_TypeB",            this.TypeB(),           null,
                     "N1_DDB",              this.DDB(),             null,
                     "N1_Qnty",             this.printQnty(),       null,
                     "N1_NKDallRub",        this.NKDallRub(),       null,
                     "N1_NKDallRub1",       this.NKDallRub1(),      null,
                     "N1_NKDallRub2",       this.NKDallRub2(),      null,
                     "N1_StatusSec",        this.StatusSec(),       null,
                     "N1_AmortRub",         this.AmortRub(),        null,
                     "N1_SumBRub_Amort",    this.SumBRub_Amort(),   null,
                     "N1_SumBDif",          this.SumBDif(),         null,
                     "N1_ComBRub_Amort",    this.ComBRub_Amort(),   null,
                     "N1_VN",               this.VN(),              null,
                     "N1_Nom_DDB",          this.printNomBDU(),     null,
                     "N1_DR",               this.DR(),              null,
                     "N1_NkdBvp",           this.NkdBvp(),          null,
                     "N1_NkdBVN",           this.NkdBvn(),          null,
                     "N1_NkdBrub",          this.NkdBrub(),         null,
                     "N1_NkdBprevRub",      this.NkdBprevRub(),     null,
                     "N1_NkdBrepRub",       this.NkdBrepRub(),      null,
                     "N1_ifCoupPrev",       this.ifCoupPrev(),      null,
                     "N1_Tprev",            this.Tprev(),           null,
                     "N1_NkdPrevVN",        this.NkdPrevVN(),       null,
                     "N1_NkdPrevRub",       this.NkdPrevRub(),      null,
                     "N1_CoupVN",           this.CoupVN(),          null,
                     "N1_CoupRub",          this.CoupRub(),         null,
                     "N1_NkdRepVN",         this.NKDrepVN(),        null,
                     "N1_NkdRepRub",        this.NkdRepRub(),       null,
                     "N1_CoupCount",        this.CoupCount(),       null,
                     "N1_LastCoupDate",     this.LastCoupDate(),    null,
                     "N1_ControlNKD",       this.ControlNKD(),      null,
                     "N1_AmortVN",          this.AmortVN(),         null,
                     "N1_AmortVN_before",   this.AmortVN_before(),  null,
                     "N1_AmortVN_after",    this.AmortVN_after(),   null,
                     "N1_AmortVNPer",       this.AmortVNPer(),      null,
                     "N1_AmortVNaccPer",    this.AmortVNaccPer(),   null,
                     "N1_VPrB",             this.VPrBNumber(),      null,
                     "N1_CrBD",             this.printCrBD_F(),     null,
                     "N1_KPNom",            this.KPNom(),           null,
                     "N1_SumBvp",           this.SumBvp(),          null,
                     "N1_SumBRub",          this.SumBrub(),         null,
                     "N1_SumBvp_exps",      this.SumBvp_exps(),     null,
                     "N1_PrBvp",            this.printPrBvp(),      null,
                     "N1_MaxMrkt",          this.printMarketPrice_New(), null,
                     "N1_Val_MarketB",      this.Val_Market_New(),  null,
                     "N1_MrktB",            this.Market_New(),      null,
                     "N1_DMrktB",           this.DateMarket_New(),  null,
                     "N1_QuoteValueB",      this.printQuoteValueB(),null,
                     "N1_DifB",             this.DifB(),            null,
                     "N1_RCB",              this.RCB(),             null,
                     "N1_RFISSB",           this.RFISSB(),          null,
                     "N1_DqualB",           this.DqualB(),          null,
                     "N1_CodeDR",           this.CodeDR(),          null,
                     "N1_DD1DR",            this.DD1DR(),           null,
                     "N1_Dlink",            this.DLink(),           null,
                     "N1_K_ControlB",       this.ControlCode(),     null,
                     "N1_Control_CommentB", this.Control_Comment(), null,
                     "N1_SecType",          this.SecType(),         null,
                     "N1_TaxeAll",          this.TaxeAll(),         null,
                     "N1_TaxeAmort",        this.TaxeAmort(),       null,
                     "N1_TaxeNKD",          this.TaxeNKD(),         null,
                     "N1_FinRes",           this.FinRes(),          null,
                     "N1_ISIN",             this.ISIN(),            null, 
                     "N1_Nom_H01",          iif(m_RS.TaxGroup == 15, this.Nom_H01(), null),         null,
                     "N1_Nom_H02",          iif(m_RS.TaxGroup == 15, this.Nom_H02(), null),         null,
                     "N1_PlusNom_IN",       iif(m_RS.TaxGroup == 15, this.PlusNom_IN(), null),      null,
                     "N1_MinusNom_IN",      iif(m_RS.TaxGroup == 15, this.MinusNom_IN(), null),     null,
                     "N1_Nom_IN_Before",    iif(m_RS.TaxGroup == 15, this.Nom_IN_Before(), null),   null,
                     "N1_DGO",              this.DGO(),             null
                   );
  end;

 macro PrintTableLine_1_Cash()

     m_CurrStrNum = this.НомерТекущейСтроки();

     PrintTableLine( "N1_SecCode",          this.SecCode(),         null,
                     "N1_SecName",          this.SecName(),         null,
                     "N1_CodeB",            this.CodeB(),           null,
                     "N1_DZB",              this.DZB(),             null,
                     "N1_TypeB",            this.TypeB(),           null,
                     "N1_DDB",              this.DDB(),             null,
                     "N1_Qnty",             this.printQnty(),       null,
                     "N1_NKDallRub",        this.NKDallRub(),       null,
                     "N1_NKDallRub1",       this.NKDallRub1(),      null,
                     "N1_NKDallRub2",       this.NKDallRub2(),      null,
                     "N1_StatusSec",        "",                     null,
                     "N1_AmortRub",         0,                      null,
                     "N1_SumBRub_Amort",    this.SumBRub_Amort(),   null,
                     "N1_SumBDif",          this.SumBDif(),         null,
                     "N1_ComBRub_Amort",    0,                      null,
                     "N1_VN",               this.VN(),              null,
                     "N1_Nom_DDB",          0,                      null,
                     "N1_DR",               "",                     null,
                     "N1_NkdBvp",           0,                      null,
                     "N1_NkdBVN",           0,                      null,
                     "N1_NkdBrub",          0,                      null,
                     "N1_NkdBprevRub",      0,                      null,
                     "N1_NkdBrepRub",       0,                      null,
                     "N1_ifCoupPrev",       0,                      null,
                     "N1_Tprev",            0,                      null,
                     "N1_NkdPrevVN",        0,                      null,
                     "N1_NkdPrevRub",       0,                      null,
                     "N1_CoupVN",           this.CoupVN_For_Cash(), null,
                     "N1_CoupRub",          this.CoupVN_For_Cash(true), null,
                     "N1_NkdRepVN",         0,                      null,
                     "N1_NkdRepRub",        0,                      null,
                     "N1_CoupCount",        0,                      null,
                     "N1_LastCoupDate",     "",                     null,
                     "N1_ControlNKD",       this.ControlNKD(),      null,
                     "N1_AmortVN",          this.AmortVN(),         null,
                     "N1_AmortVN_before",   0,                      null,
                     "N1_AmortVN_after",    0,                      null,
                     "N1_AmortVNPer",       0,                      null,
                     "N1_AmortVNaccPer",    this.AmortVNaccPer(),   null,
                     "N1_VPrB",             0,                      null,
                     "N1_CrBD",             0,                      null,
                     "N1_KPNom",            this.KPNom(),           null,
                     "N1_SumBvp",           0,                      null,
                     "N1_SumBRub",          0,                      null,
                     "N1_SumBvp_exps",      this.SumBvp_exps(),     null,
                     "N1_PrBvp",            0,                      null,
                     "N1_MaxMrkt",          0,                      null,
                     "N1_Val_MarketB",      0,                      null,
                     "N1_MrktB",            "",                     null,
                     "N1_DMrktB",           ZeroDate,               null,
                     "N1_QuoteValueB",      0,                      null,
                     "N1_DifB",             0,                      null,
                     "N1_RCB",              "",                     null,
                     "N1_RFISSB",           "",                     null,
                     "N1_DqualB",           "",                     null,
                     "N1_CodeDR",           "",                     null,
                     "N1_DD1DR",            "",                     null,
                     "N1_Dlink",            "",                     null,
                     "N1_K_ControlB",       "",                     null,
                     "N1_Control_CommentB", this.Control_Comment(), null,
                     "N1_SecType",          this.SecType(),         null,
                     "N1_TaxeAll",          this.TaxeAll(),         null,
                     "N1_TaxeAmort",        this.TaxeAmort(),       null,
                     "N1_TaxeNKD",          this.TaxeNKD(),         null,
                     "N1_FinRes",           this.FinRes(),          null,
                     "N1_ISIN",             this.ISIN(),            null
                   );
  end;

  MACRO SumWarnKind( FIID:integer, Kind:string, ToFIID:integer ):money
     var RetVal:money = $0.0;

     var exec = RSDCommand( " SELECT warn.t_ChargeDate, warn.t_IncomeVolume, warn.t_IncomeFI " +
                            "   FROM dfiflwarn_dbt warn " +
                            "  WHERE warn.t_FIID = ? " +
                            "    AND warn.t_ChargeDate >= ? " +
                            "    AND warn.t_ChargeDate <= ? " +
                            "    AND warn.t_IncomeCode = ? " );
     exec.addParam( "", RSDBP_IN, FIID );
     exec.addParam( "", RSDBP_IN, this.H0_1() );
     exec.addParam( "", RSDBP_IN, this.H0_2() );
     exec.addParam( "", RSDBP_IN, Kind );
     exec.execute();

     var rs = TRsbDataSet( exec );
     while( rs.MoveNext() )
        if( SQL_ConvTypeInteger(rs.IncomeFI) == ToFIID )
           RetVal = RetVal + SQL_ConvTypeSum(rs.IncomeVolume);
        else
           var Tmp:money = $0.0;
           if( SmartConvertSum(Tmp, SQL_ConvTypeSum(rs.IncomeVolume), SQL_ConvTypeDate(rs.ChargeDate), SQL_ConvTypeInteger(rs.IncomeFI), ToFIID, true) == true )
              RetVal = RetVal + Tmp;
           end;
        end;
     end;

     return RetVal;
  END;

  macro PrintTableLine_1_AII( FIID:integer, FI_Code:string, Name:string, TaxGroup, FaceValueFI:integer, Kind:string, ISIN: string )

     m_CurrStrNum = this.НомерТекущейСтроки();

     var CoupVN:money = $0.0;

     if( Kind == "1" )
        CoupVN = SumWarnKind(FIID, Kind, FaceValueFI);
     end;

     PrintTableLine( "N1_SecCode",          FI_Code,                null,
                     "N1_SecName",          Name,                   null,
                     "N1_CodeB",            Kind,                   null,
                     "N1_DZB",              ZeroDate,               null,
                     "N1_TypeB",            "B",                    null,
                     "N1_DDB",              ZeroDate,               null,
                     "N1_Qnty",             0,                      null,
                     "N1_NKDallRub",        this.NKDallRub(),       null,
                     "N1_NKDallRub1",       this.NKDallRub1(),      null,
                     "N1_NKDallRub2",       this.NKDallRub2(),      null,
                     "N1_StatusSec",        "",                     null,
                     "N1_AmortRub",         0,                      null,
                     "N1_SumBRub_Amort",    this.SumBRub_Amort(),   null,
                     "N1_SumBDif",          this.SumBDif(),         null,
                     "N1_ComBRub_Amort",    this.ComBRub_Amort(),   null,
                     "N1_VN",               ПолучитьКодФинИн(FaceValueFI, null, FICK_ISONUMBER), null,
                     "N1_Nom_DDB",          0,                      null,
                     "N1_DR",               ZeroDate,               null,
                     "N1_NkdBvp",           0,                      null,
                     "N1_NkdBVN",           0,                      null,
                     "N1_NkdBrub",          0,                      null,
                     "N1_NkdBprevRub",      0,                      null,
                     "N1_NkdBrepRub",       0,                      null,
                     "N1_ifCoupPrev",       0,                      null,
                     "N1_Tprev",            0,                      null,
                     "N1_NkdPrevVN",        0,                      null,
                     "N1_NkdPrevRub",       0,                      null,
                     "N1_CoupVN",           CoupVN,                 null,
                     "N1_CoupRub",          SumWarnKind(FIID, Kind, NATCUR), null,
                     "N1_NkdRepVN",         0,                      null,
                     "N1_NkdRepRub",        0,                      null,
                     "N1_CoupCount",        0,                      null,
                     "N1_LastCoupDate",     ZeroDate,               null,
                     "N1_ControlNKD",       this.ControlNKD(),      null,
                     "N1_AmortVN",          this.AmortVN(),         null,
                     "N1_AmortVN_before",   0,                      null,
                     "N1_AmortVN_after",    0,                      null,
                     "N1_AmortVNPer",       0,                      null,
                     "N1_AmortVNaccPer",    this.AmortVNaccPer(),   null,
                     "N1_VPrB",             "",                     null,
                     "N1_CrBD",             0,                      null,
                     "N1_KPNom",            this.KPNom(),           null,
                     "N1_SumBvp",           0,                      null,
                     "N1_SumBRub",          this.SumBrub(),         null,
                     "N1_SumBvp_exps",      this.SumBvp_exps(),     null,
                     "N1_PrBvp",            0,                      null,
                     "N1_MaxMrkt",          0,                      null,
                     "N1_Val_MarketB",      0,                      null,
                     "N1_MrktB",            "",                     null,
                     "N1_DMrktB",           ZeroDate,               null,
                     "N1_DifB",             0,                      null,
                     "N1_RCB",              "",                     null,
                     "N1_RFISSB",           "",                     null,
                     "N1_DqualB",           ZeroDate,               null,
                     "N1_CodeDR",           "",                     null,
                     "N1_DD1DR",            ZeroDate,               null,
                     "N1_Dlink",            ZeroDate,               null,
                     "N1_K_ControlB",       "",                     null,
                     "N1_Control_CommentB", "",                     null,
                     "N1_SecType",          TaxGroup,               null,
                     "N1_TaxeAll",          this.TaxeAll(),         null,
                     "N1_TaxeAmort",        this.TaxeAmort(),       null,
                     "N1_TaxeNKD",          this.TaxeNKD(),         null,
                     "N1_FinRes",           this.FinRes(),          null,
                     "N1_ISIN",             ISIN,                   null
                   );
  end;

  macro ТекстФормулыПоВсемСделкамДляВыпуска(CellName:string)
     VAR i = 0, NumSheet2 = 0, FormulaStr = "", BeginRow_1 = 0, BeginRow_2 = 0, SummBeginRow_1 = 0, SummBeginRow_2 = 0;

     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(SHEET_2) )
           NumSheet2 = i;
           break;
        end;
        i = i + 1;
     end;

     i = 0;
     while( i < NumSheet2 )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(SHEET_1) ) /*для первой вкладки*/
           BeginRow_1 = НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_1 = НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_1 = 1;
           SummBeginRow_1 = 2;
        end;
        
        if( StrUpr(m_UsedSheet[m_UsedSheet.size-1]) == StrUpr(SHEET_2) )/*для первой(начиная с SHEET_2) вкладки*/
           BeginRow_2 = НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_2 = НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_2 = 1;
           SummBeginRow_2 = 2;
        end;

        if( FormulaStr == "" )
           FormulaStr = FormulaSUMIF()+"('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+";\"=\"&$"+C_SecCode2+"$"+SummBeginRow_2+":$"+C_SecCode2+"$"+string(BeginRow_2+MAXROWSHEET)+";'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        else
           FormulaStr = FormulaStr + "+" + FormulaSUMIF()+"('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+";\"=\"&$"+C_SecCode2+"$"+SummBeginRow_2+":$"+C_SecCode2+"$"+string(BeginRow_2+MAXROWSHEET)+";'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        end;

        i = i + 1;
     end;

     return FormulaStr;
  end;                                                                  

  macro ФормулаПоВсемСделкамДляВыпуска(CellName:string)
     return F(ТекстФормулыПоВсемСделкамДляВыпуска(CellName));
  end;                                                                  

  macro PrintTableLine_2( TaxGroup, FI_Code:string, Name:string, ISIN:string )

     m_CurrStrNum = this.НомерТекущейСтроки();

     PrintTableLine( "A27",              "411",                                           null,
                     "N2_SecType",       TaxGroup,                                        null,
                     "N2_SecCode",       FI_Code,                                         null,
                     "N2_SecName",       Name,                                            null,
                     "N2_FinRes",        ФормулаПоВсемСделкамДляВыпуска(C_FinRes),        null,
                     "N2_SumBDif",       ФормулаПоВсемСделкамДляВыпуска(C_SumBDif),       null,
                     "G27",              0,                                               null,
                     "H27",              0,                                               null,
                     "N2_TaxeAll",       ФормулаПоВсемСделкамДляВыпуска(C_TaxeAll),       null,
                     "N2_TaxeAmort",     ФормулаПоВсемСделкамДляВыпуска(C_TaxeAmort),     null,
                     "N2_TaxeNKD",       ФормулаПоВсемСделкамДляВыпуска(C_TaxeNKD),       null,
                     "N2_Qnty",          ФормулаПоВсемСделкамДляВыпуска(C_Qnty),          null,
                     "N2_AmortRub",      ФормулаПоВсемСделкамДляВыпуска(C_AmortRub),      null,
                     "N2_SumBRub_Amort", ФормулаПоВсемСделкамДляВыпуска(C_SumBRub_Amort), null,
                     "O27",              0,                                               null,
                     "N2_SumBvp_exps",   ФормулаПоВсемСделкамДляВыпуска(C_SumBvp_exps),   null,
                     "N2_NKDallRub1",    ФормулаПоВсемСделкамДляВыпуска(C_NKDallRub1),    null,
                     "N2_NKDallRub2",    ФормулаПоВсемСделкамДляВыпуска(C_NKDallRub2),    null,
                     "S27",              0,                                               null,
                     "T27",              0,                                               null,
                     "N2_NkdBvp",        ФормулаПоВсемСделкамДляВыпуска(C_NkdBvp),        null,
                     "N2_AmortVNaccPer", ФормулаПоВсемСделкамДляВыпуска(C_AmortVNaccPer), null,
                     "N2_CoupVN",        ФормулаПоВсемСделкамДляВыпуска(C_CoupVN),        null,
                     "N2_NkdPrevRub",    ФормулаПоВсемСделкамДляВыпуска(C_NkdPrevRub),    null,
                     "N2_ISIN",          ISIN,                                            null
                   );
  end;

  macro PrintForm_2()
     var exec, DataSet;
     exec = RSDCommand(" select fin.t_FI_Code, fin.t_Name, av.t_TaxGroup, "+
                       "        (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) AS t_ISIN "+
                       "   from dspprtcst_tmp t, dfininstr_dbt fin, DAVOIRISS_DBT av "+
                       "  where fin.t_FIID = t.t_FIID "+
                       "    AND fin.t_FIID = av.t_FIID "+
                       " group by fin.t_FI_Code, fin.t_Name, av.t_TaxGroup, "+
                       "          (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) "+
                       " order by av.t_TaxGroup, fin.t_FI_Code");
     exec.execute();
     DataSet = TRsbDataSet(exec);

     while(DataSet.MoveNext())
        PrintTableLine_2(DataSet.TaxGroup, DataSet.FI_Code, DataSet.Name, DataSet.ISIN);
     end;
  end;

  MACRO SaveFIIDForForm_2( FIID:integer )
     var exec, rs;

     exec = RSDCommand(" select count(1) cnt " +
                       "   from dspprtcst_tmp " +
                       "  where T_FIID = ? ");
     exec.addParam( "", RSDBP_IN, FIID );
     exec.execute();

     rs = TRsbDataSet( exec );
     if( rs.MoveNext() and (rs.cnt <= 0) )
        exec = RSDCommand(" insert into dspprtcst_tmp ( t_FIID ) values (?) ");
        exec.addParam( "", RSDBP_IN, FIID );
        exec.execute();
     end;
  END;

  MACRO Create()

     this.RegisterTable_1();
     this.PrintForm_1();
     EndTable();
     //ПечататьПромежуточныеИтоги_1();
     this.AddStandardFooter_Reg2014( "N1_" );
     this.RegisterTable_2();
     this.PrintForm_2();
     EndTable();
     //ПечататьПромежуточныеИтоги_2();

     if( (m_IsExistsData == false) and (m_IsWebService == false) )
        msgbox("Нет данных для формирования отчета.");
     end;
  END;
 
  MACRO ClearCacheFIID()
     m_FIID      = null;
  END;

  MACRO ClearCacheOneRecord()
     this.ClearCacheOneRecord();

     m_ifCoup         = null;
     m_ifCoupPrev     = null;
     m_NkdBvp         = null;
     m_NkdBvn         = null;
     m_NkdBrub        = null;
     m_NKDrepVN       = null;
     m_NkdRepRub      = null;
     m_ControlCode    = null;
     m_AmortVNPer     = null;
     m_AmortVN_after  = null;
     m_AmortVN_before = null;
     m_CoupCount      = null;
     m_ComBRub_Amort  = null;
     m_CrVPr_DDB      = null;
     m_CrSpezB        = null;
     m_DDB            = null;

     if( m_FIID != m_RS.FIID )
        this.ClearCacheFIID();
     end;
  END;

  PRIVATE MACRO Get_str_DateRQ( Type:integer, DealPart:integer, tableName:string, sign:string )
     var sql_PlanDate:String = 
        " (NVL( (SELECT min(dlrq.t_PlanDate) " +
        "          FROM ddlrq_dbt dlrq " + 
        "         WHERE dlrq.t_DocKind    = "+tableName+".t_BOfficeKind " +
        "           AND dlrq.t_DocID = "+tableName+".t_DealID " +
        "           AND dlrq.t_Type    = " + string(Type) + 
        "           AND dlrq.t_DealPart    = " + string(DealPart) + 
        "           AND dlrq.t_FactDate "+sign+" TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "       ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     var sql_FactDate:String = 
        " (NVL( (SELECT min(dlrq.t_FactDate) " +
        "          FROM ddlrq_dbt dlrq " + 
        "         WHERE dlrq.t_DocKind    = "+tableName+".t_BOfficeKind " +
        "           AND dlrq.t_DocID = "+tableName+".t_DealID " +
        "           AND dlrq.t_Type    = " + string(Type) + 
        "           AND dlrq.t_DealPart    = " + string(DealPart) + 
        "           AND dlrq.t_State = " + string(DLRQ_STATE_EXEC) +
        "           AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "       ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     return 
        " (DECODE( " +
             sql_FactDate + ", " +                   // Выражение
        "    TO_DATE('01-01-0001','DD-MM-YYYY'), " + // search1
             sql_PlanDate + ", " +                   // result1
             sql_FactDate + ") " +                   // default
        " ) ";
  END;
  
  /* 12.02.2020 RAS:505214 */
  PRIVATE MACRO Get_str_PaymDateBuy( Type:integer, DealPart:integer )
    var sql_PlanDate:String = 
        " (NVL( (SELECT min(dlrq.t_PlanDate) " +
        "          FROM ddlrq_dbt dlrq " + 
        "         WHERE dlrq.t_DocKind    = DealBuy.t_BOfficeKind " +
        "           AND dlrq.t_DocID = DealBuy.t_DealID " +
        "           AND dlrq.t_Type    = " + string(Type) + 
        "           AND dlrq.t_DealPart    = " + string(DealPart) + 
        "           AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "       ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     var sql_FactDate:String = 
        " (NVL( (SELECT min(dlrq.t_FactDate) " +
        "          FROM ddlrq_dbt dlrq " + 
        "         WHERE dlrq.t_DocKind    = DealBuy.t_BOfficeKind " +
        "           AND dlrq.t_DocID = DealBuy.t_DealID " +
        "           AND dlrq.t_Type    = " + string(Type) + 
        "           AND dlrq.t_DealPart    = " + string(DealPart) + 
        "           AND dlrq.t_State = " + string(DLRQ_STATE_EXEC) +
        "           AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "       ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     return 
        " (DECODE( " +
             sql_FactDate + ", " +                   // Выражение
        "    TO_DATE('01-01-0001','DD-MM-YYYY'), " + // search1
             sql_PlanDate + ", " +                   // result1
             sql_FactDate + ") " +                   // default
        " ) ";
  end;
  /*~RAS*/

  MACRO ExistsWarnKind( FIID:integer, Kind:string ):bool
     var RetVal:bool = false;

     var exec = RSDCommand( " SELECT count(1) cnt " +
                            "   FROM dfiflwarn_dbt " +
                            "  WHERE t_FIID = ? " +
                            "    AND t_ChargeDate >= ? " +
                            "    AND t_ChargeDate <= ? " +
                            "    AND t_IncomeCode = ? " );
     exec.addParam( "", RSDBP_IN, FIID );
     exec.addParam( "", RSDBP_IN, this.H0_1() );
     exec.addParam( "", RSDBP_IN, this.H0_2() );
     exec.addParam( "", RSDBP_IN, Kind );
     exec.execute();

     var rs = TRsbDataSet( exec );
     if( rs.MoveNext() and (rs.cnt > 0) )
        RetVal = true;
     end;

     return RetVal;
  END;

  MACRO PrintForm_1()

     var Num = 0, WhereCond = "", AvrFIIDCount = 0, AvrFIIDAddWhere = "";
     var QueryRest, QueryRest3, QueryLnk, Head1, Head2, Head3, Body1, Body2, Body3, IsFirstUse = true;
     var ProgressValue = CTxProgressValue();

     if( (m_AvrFIID != null) AND (m_AvrFIID.Size > 0 ) ) /*задана бумага*/
       while( AvrFIIDCount < m_AvrFIID.Size )
          if( ( ValType( m_AvrFIID[AvrFIIDCount] ) == V_INTEGER )
          and ( m_AvrFIID[AvrFIIDCount] > 0 ) )
             if( AvrFIIDAddWhere == "" )
                AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
             else
                AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
             end;
             AvrFIIDAddWhere = AvrFIIDAddWhere + " Fin.t_FIID = " + String( m_AvrFIID[AvrFIIDCount] ) + " ";
          end;
          AvrFIIDCount = AvrFIIDCount + 1;
       end;
       if( AvrFIIDAddWhere != "" )
          AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
       end;
       WhereCond = WhereCond + AvrFIIDAddWhere;
     else
       if( (m_AvrTaxGroup != null) AND (m_AvrTaxGroup.Size > 0 ) ) /*задана категория бумаги*/
         while( AvrFIIDCount < m_AvrTaxGroup.Size )
            if( ( ValType( m_AvrTaxGroup[AvrFIIDCount] ) == V_INTEGER )
            and ( m_AvrTaxGroup[AvrFIIDCount] > 0 ) )
               if( AvrFIIDAddWhere == "" )
                  AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
               else
                  AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
               end;
               AvrFIIDAddWhere = AvrFIIDAddWhere + " av.t_TaxGroup = " + String( m_AvrTaxGroup[AvrFIIDCount] ) + " ";
            end;
            AvrFIIDCount = AvrFIIDCount + 1;
         end;
         if( AvrFIIDAddWhere != "" )
            AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
         end;
         WhereCond = WhereCond + AvrFIIDAddWhere;
       end;
     end;

     WhereCond = WhereCond + " AND RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", Fin.t_AvoirKind) > 0 " + 
                             " AND (Rsb_SCTX.TXIsPercentAvoir(av.t_TaxGroup) = 1 OR Rsb_SCTX.TXIsDiscountAvoir(AV.t_TaxGroup) = 1)";

     QueryRest = " SELECT NVL(TXRest.T_SourceID,0) AS SourceID, NVL(sum(TXRest.T_AMOUNT),0) AS Amount, TXRest.t_FIID "+
                 "   FROM DSCTXREST_DBT TXRest " + 
                 "  WHERE TXRest.T_AMOUNT > 0 AND " +
                 "        TXRest.t_BUYDATE <= " + GetSQLDate( m_ReportDate ) + " AND " +
                 "        TXRest.t_BUYDATE <> " + GetSQLDate( DATE(0,0,0) ) + " AND " +
                 "        ( TXRest.t_SALEDATE IS NULL  OR " +
                 "          TXRest.t_SALEDATE = " + GetSQLDate( DATE(0,0,0) ) + " OR " + 
                 "          TXRest.t_SALEDATE > " + GetSQLDate( m_ReportDate ) +
                 "        ) " +
                 " GROUP BY TXRest.t_FIID, TXRest.T_SourceID";

     QueryRest3 = " SELECT NVL(TXRest.T_SourceID,0) AS SourceID, NVL(TXRest.T_AMOUNT,0) AS Amount, TXRest.t_FIID, TXRest.t_SaleDate "+
                 "   FROM DSCTXREST_DBT TXRest " + 
                 "  WHERE TXRest.T_AMOUNT > 0 AND " +
                 "        TXRest.t_BUYDATE <= " + GetSQLDate( m_ReportDate ) + " AND " +
                 "        TXRest.t_BUYDATE <> " + GetSQLDate( DATE(0,0,0) ) + " AND " +
                 "        ( TXRest.t_SALEDATE = (SELECT MAX(ttmp.t_SaleDate) FROM DSCTXREST_DBT ttmp WHERE ttmp.T_SourceID = TXRest.T_SourceID ) " +
                 IIF( ( (this.H0_2() >= Dend) and (this.H0_2() <= Date(31, 12, DendYear)) ), " AND TXRest.t_SaleDate BETWEEN " + GetSQLDate( date("01.01.2022") ) + " AND " + GetSQLDate( date("31.12.2023") ), " AND 1 != 1 " ) +
                 "        ) ";

     QueryLnk = " SELECT aLnk.* " +
                "   FROM ( SELECT cLnk.*, NVL(cLnk.t_Amount-cLnk.t_LnAmount, 0) AS t_LnkAmount " +
                "            FROM ( SELECT /*+LEADING(FI, lnk)*/ lnk.t_Amount, lnk.t_ID, lnk.t_BuyID, lnk.t_SaleID, lnk.t_Type, lnk.t_Date, " +
                "                          FI.*, currsalelot.t_BegLotID, " +
                "                          (SELECT nvl(SUM (ls.t_short),0) " +
                "                             FROM dsctxls_dbt ls, dsctxlnk_dbt lk " +
                "                            WHERE ls.t_parentid = lnk.t_ID " +
                "                                  AND lk.t_id = ls.t_childid " +
                "                                  AND lk.t_Date <= " + GetSQLDate(m_ReportDate) + ") t_LnAmount " +
                "                     FROM dsctxlnk_dbt lnk, " +
                "                          ( SELECT fin.t_FIID, " +
                "                                   fin.t_FaceValueFI AS FaceValueFI, " +
                "                                   fin.t_FI_Code AS AvrCode, " +
                "                                   fin.t_Name AS AvrName, " +
                "                                   fin.t_DrawingDate, " +
                "                                   av.t_BegPlacementDate, " +
                "                                   fin.t_Definition, " +
                "                                   Fin.t_Issued, " +
                "                                   fin.t_AvoirKind, " +
                "                                   av.t_ISIN, " +
                "                                   av.t_LSIN, " +
                "                                   av.t_TaxGroup AS TaxGroup " +
                "                              FROM dfininstr_dbt Fin, davoiriss_dbt av " +
                "                             WHERE av.t_FIID = fin.t_FIID " + WhereCond +
                "                          ) FI, " +
                "                          dsctxlot_dbt currsalelot " +
                "                    WHERE lnk.t_Type in (" + string(TXLNK_DELREPO) + "," + string(TXLNK_SUBSTREPO) + "," + string(TXLNK_LOANPUT) + "," + string(TXLNK_SUBSTLOAN) + ") and " +
                "                          lnk.t_Date <= " + GetSQLDate( m_ReportDate ) + " and " +
                "                          (lnk.t_BegDate = to_date('01.01.0001', 'DD.MM.YYYY') or lnk.t_BegDate <= " + GetSQLDate( m_ReportDate ) + ") and " +
                "                          (lnk.t_EndDate = to_date('01.01.0001', 'DD.MM.YYYY') or lnk.t_EndDate > " + GetSQLDate( m_ReportDate ) + ") and " +
                "                          lnk.t_FIID = FI.t_FIID and " +
                "                          lnk.t_Amount > (SELECT nvl(SUM (ls.t_short),0) "
                "                                            FROM dsctxls_dbt ls, dsctxlnk_dbt lk "
                "                                           WHERE ls.t_parentid = lnk.t_ID "
                "                                             AND lk.t_id = ls.t_childid "
                "                                             AND lk.t_Date <= "  + GetSQLDate(m_ReportDate) + ") and "
                "                          currsalelot.t_ID = lnk.t_SaleID and " +
                "                          (    currsalelot.t_BuyDate = to_date('01.01.0001', 'DD.MM.YYYY') " +
                "                            or currsalelot.t_BuyDate > " + GetSQLDate( m_ReportDate ) +
                "                          ) " +
                "                 ) cLnk " +
                "        ) aLnk " +
                " WHERE aLnk.t_LnkAmount > 0 ";

     Head1 = " SELECT /*+LEADING(QueryRest)*/ fin.t_FIID, "+
             "        fin.t_FaceValueFI as FaceValueFI, "+
             "        fin.t_FI_Code as AvrCode, "+
             "        fin.t_Name as AvrName, "+
             "        ( " +
             "           case when av.t_Termless = 'X' " +
             "                then ( " +
             "                        select nvl(min(offer.t_DateRedemption), to_date('01.01.0001', 'dd.mm.yyyy')) " +
             "                        from doffers_dbt offer " +
             "                        where offer.t_FIID = fin.t_FIID " +
             "                          and offer.t_DateRedemption > " + GetSQLDate(m_ReportDate) +
             "                     ) " +
             "                else fin.t_DrawingDate "+
             "           end " +
             "        ) as t_DrawingDate, " +
             "        av.t_BegPlacementDate, "+
             "        fin.t_Definition, "+
             "        Fin.t_Issued," +
             "        fin.t_AvoirKind, "+
             "        av.t_ISIN, "+
             "        av.t_LSIN, "+
             "        av.t_TaxGroup AS TaxGroup, "+
             "        QueryRest.Amount as t_Amount, "+
             "        TXBuyLot.t_RQID, " +
             "        TXBuyLot.t_BuyDate, " +
             "        TXBuyLot.t_Type AS LotBuyType, " +
             "        TXBuyLot.t_DealCodeTS AS DealBuyCodeTS, " +
             "        TXBuyLot.T_DEALID AS DealBuyID, "+
             "        TXBuyLot.T_DEALDATE AS DealBuyDate, " +
             "        TXBuyLot.t_PriceFIID AS BuyPriceFIID, "+
             "        TXBuyLot.t_DealTime AS BuyDealTime, "+
             "        DealBuy.t_Department as DealBuyDepartment, " +
             "        DealBuy.t_BOfficeKind, "+
             "        Rsb_SCTX.TXGetBondKind(av.t_TaxGroup) TaxGroupType, "+
             "        Rsb_SCTX.TXIsPercentAvoir(AV.t_TaxGroup) as IsPercent, "+
             "        Rsb_SCTX.TXIsDiscountAvoir(AV.t_TaxGroup) as IsDiscount, "+
             "        Rsb_SCTX.TXGetComissionsSum(DealBuy.t_DealID, DealBuy.t_BofficeKind, TXBuyLot.t_BuyDATE, 0) as CommBuy, "+
             "        Rsb_SCTX.GetMarketPrice_New(TXBuyLot.t_ID) AS MarketPrice_New, " +
             "        Rsb_SCTX.GetVal_Market_New(TXBuyLot.t_ID) AS Val_Market_New, " +
             "        Rsb_SCTX.GetMarket_New(TXBuyLot.t_ID) AS Market_New, " +
             "        Rsb_SCTX.GetDateMarket_New(TXBuyLot.t_ID) AS DateMarket_New, " +
             "        Rsb_SCTX.GetQuoteValue_New(TXBuyLot.t_ID) AS BuyMarketQuoteValue, "+
             "        '' as CodeDR, " +
             "        TO_DATE('01-01-0001','DD-MM-YYYY') as SaleDate, " +
             "        TO_DATE('01-01-0001','DD-MM-YYYY') as DLink, " +
             "        LegBuy.t_CFI as VprB, "+
             "        LegBuy.t_Cost as BDealCost, " +
             "        LegBuy.t_Principal AS BuyAmount, "+
             "        LegBuy.t_RelativePrice, "+
             "        LegBuy.t_Price AS BuyPrice, "+
             "        LegBuy.t_NKD NKDBuy, "+
             "        LegBuy.t_LegKind as LegKindBuy, "+
             "        'О' as LinkType, "+
             "        TXBuyLot.t_Type as TypeB, " +
             "        DealBuy.t_BOfficeKind as DealBuyBOfficeKind, " +
             "        (case when av.t_Termless = 'X' then 1 else 0 end) as t_Termless, " +
             "        ( " +
             "           select nvl(max(comm.t_CommDate), to_date('01.01.0001', 'dd.mm.yyyy')) " +
             "           from ddl_comm_dbt comm " +
             "           where comm.t_CommDate <= " + GetSQLDate(m_ReportDate) +
             "             and comm.t_DocKind in (" + string(DL_ISSUE_UNION) + ", " + string(DL_CHGAVRNOM) + ")" +
             "             and comm.t_FIID = LegBuy.t_PFI " +
             "             and comm.t_OperSubKind in (1, 2, 3, 4) " +
             "             and comm.t_CommStatus > " + string(DL_COMM_PREPARING) +
             "             and ROWNUM < 2 " +
             "        ) as t_DGO, " +
                      Get_str_DateRQ(DLRQ_TYPE_DELIVERY, 1, "DealBuy", "=") + " as t_DeliveryDate, "+
                      Get_str_DateRQ(DLRQ_TYPE_PAYMENT, 1, "DealBuy", "=") + " as t_PaymentDate," +//;
             /* 12.02.2020 RAS:505214*/
                      Get_str_PaymDateBuy(DLRQ_TYPE_DELIVERY, 1) + " as t_DeliveryDateTO, " +
             /*~RAS*/
             "        0 as IsDUDealS, " +
             "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) as ImportDUDate, " +
             "        CASE WHEN((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) THEN 1 ELSE 0 end as IsDUDealB, " +
             "        CASE WHEN RSB_SECUR.GetMainObjAttr(12, LPAD (fin.t_FIID, 10, '0'), 131, TRIM(SYSDATE)) = 2 THEN chr(88) ELSE chr(0) end as IsCashMode ";

     Head2 = " SELECT QueryLnk.t_FIID, " +
             "        QueryLnk.FaceValueFI, " +
             "        QueryLnk.AvrCode, " +
             "        QueryLnk.AvrName, " +
             "        ( " +
             "           case when av.t_Termless = 'X' " +
             "                then ( " +
             "                        select nvl(min(offer.t_DateRedemption), to_date('01.01.0001', 'dd.mm.yyyy')) " +
             "                        from doffers_dbt offer " +
             "                        where offer.t_FIID = QueryLnk.t_FIID " +
             "                          and offer.t_DateRedemption > " + GetSQLDate(m_ReportDate) +
             "                     ) " +
             "                else QueryLnk.t_DrawingDate " +
             "           end " +
             "        ) as t_DrawingDate, " +
             "        QueryLnk.t_BegPlacementDate, " +
             "        QueryLnk.t_Definition, " +
             "        QueryLnk.t_Issued, " +
             "        QueryLnk.t_AvoirKind, " +
             "        QueryLnk.t_ISIN, " +
             "        QueryLnk.t_LSIN, " +
             "        QueryLnk.TaxGroup, " +
             "        QueryLnk.t_LnkAmount AS t_Amount, "+
             "        TXBuyLot.t_RQID, " +
             "        TXBuyLot.t_BuyDate, " +
             "        TXBuyLot.t_Type AS LotBuyType, " +
             "        TXBuyLot.t_DealCodeTS AS DealBuyCodeTS, " +
             "        TXBuyLot.T_DEALID AS DealBuyID, "+
             "        TXBuyLot.T_DEALDATE AS DealBuyDate, " +
             "        TXBuyLot.t_PriceFIID AS BuyPriceFIID, "+
             "        TXBuyLot.t_DealTime AS BuyDealTime, "+
             "        DealBuy.t_Department as DealBuyDepartment, " +
             "        DealBuy.t_BOfficeKind, "+
             "        Rsb_SCTX.TXGetBondKind(QueryLnk.TaxGroup) TaxGroupType, "+
             "        Rsb_SCTX.TXIsPercentAvoir(QueryLnk.TaxGroup) as IsPercent, "+
             "        Rsb_SCTX.TXIsDiscountAvoir(QueryLnk.TaxGroup) as IsDiscount, "+
             "        Rsb_SCTX.TXGetComissionsSum(DealBuy.t_DealID, DealBuy.t_BofficeKind, TXBuyLot.t_BuyDATE, 0) as CommBuy, "+
             "        Rsb_SCTX.GetMarketPrice_New(TXBuyLot.t_ID) AS MarketPrice_New, " +
             "        Rsb_SCTX.GetVal_Market_New(TXBuyLot.t_ID) AS Val_Market_New, " +
             "        Rsb_SCTX.GetMarket_New(TXBuyLot.t_ID) AS Market_New, " +
             "        Rsb_SCTX.GetDateMarket_New(TXBuyLot.t_ID) AS DateMarket_New, " +
             "        Rsb_SCTX.GetQuoteValue_New(TXBuyLot.t_ID) AS BuyMarketQuoteValue, "+
             "        salelot.t_DealCodeTS as CodeDR, " +
                      Get_str_DateRQ(DLRQ_TYPE_DELIVERY, 1, "DealSale", ">") + " as SaleDate, "+
             "        QueryLnk.t_Date as DLink, " +
             "        LegBuy.t_CFI as VprB, "+
             "        LegBuy.t_Cost as BDealCost, " +
             "        LegBuy.t_Principal AS BuyAmount, "+
             "        LegBuy.t_RelativePrice, "+
             "        LegBuy.t_Price AS BuyPrice, "+
             "        LegBuy.t_NKD NKDBuy, "+
             "        LegBuy.t_LegKind as LegKindBuy, "+
             "        case when (QueryLnk.t_Type = "+ string(TXLNK_DELREPO) + " or QueryLnk.t_Type = " + string(TXLNK_SUBSTREPO) +") then 'РП' else 'ЗП' end as LinkType, " +
             "        TXBuyLot.t_Type as TypeB, " +
             "        DealBuy.t_BOfficeKind as DealBuyBOfficeKind, " +
             "        (case when av.t_Termless = 'X' then 1 else 0 end) as t_Termless, " +
             "        ( " +
             "           select nvl(max(comm.t_CommDate), to_date('01.01.0001', 'dd.mm.yyyy')) " +
             "           from ddl_comm_dbt comm " +
             "           where comm.t_CommDate <= " + GetSQLDate(m_ReportDate) +
             "             and comm.t_DocKind IN (" + string(DL_ISSUE_UNION) + ", " + string(DL_CHGAVRNOM) + ")" +
             "             and comm.t_OperSubKind in (1, 2, 3, 4) " +
             "             and comm.t_FIID = LegBuy.t_PFI " +
             "             and comm.t_CommStatus > " + string(DL_COMM_PREPARING) +
             "             and ROWNUM < 2 " +
             "        ) as t_DGO, " +
                      Get_str_DateRQ(DLRQ_TYPE_DELIVERY, 1, "DealBuy", "=") + " as t_DeliveryDate, "+
                      Get_str_DateRQ(DLRQ_TYPE_PAYMENT, 1, "DealBuy", "=") + " as t_PaymentDate, " +//;
             /* 12.02.2020 RAS:505214*/
                      Get_str_PaymDateBuy(DLRQ_TYPE_DELIVERY, 1) + " as t_DeliveryDateTO, " +
             /*~RAS*/
             "        CASE WHEN(DealSale.t_DealType = 32742) THEN 1 ELSE 0 end as IsDUDealS, " +
             "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) as ImportDUDate, " +
             "        CASE WHEN((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) THEN 1 ELSE 0 end as IsDUDealB, " +
             "        CASE WHEN RSB_SECUR.GetMainObjAttr(12, LPAD (QueryLnk.t_FIID, 10, '0'), 131, TRIM(SYSDATE)) = 2 THEN chr(88) ELSE chr(0) end as IsCashMode, " +
             "        TO_DATE('01-01-0001','DD-MM-YYYY') as SaleDateCash ";

     Head3 = Head1 + ", QueryRest.t_SaleDate as SaleDateCash ";
     Head1 = Head1 + ", TO_DATE('01-01-0001','DD-MM-YYYY') as SaleDateCash ";

     Body1 = "   FROM (" + QueryRest + ") QueryRest," +
             "        DSCTXLOT_DBT currTXBuyLot, DSCTXLOT_DBT TXBuyLot, dfininstr_dbt fin, DAVOIRISS_DBT av, DDL_TICK_DBT DealBuy, DDL_LEG_DBT LegBuy " +
             "  WHERE currTXBuyLot.t_ID = QueryRest.SourceID AND " +
             "        TXBuyLot.t_ID     = currTXBuyLot.t_BegLotID AND " +
             "        fin.t_FIID        = QueryRest.t_FIID AND " +
             "        av.t_FIID         = fin.t_FIID AND " +
             "        DealBuy.t_DealID  = TXBuyLot.t_DealID AND " +
             "        LegBuy.t_DealID   = DealBuy.t_DealID AND" +
             "        LegBuy.t_LegKind  = " + LEG_KIND_DL_TICK + " AND " +
             "        ((((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) AND  " + 
             "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) <= " + GetSQLDate( m_ReportDate ) + " ) OR DealBuy.t_Ofbu <> chr(88) ) AND " +
             "        LegBuy.t_LegID    = 0 " + WhereCond;

     Body2 = "   FROM (" + QueryLnk + " ) QueryLnk, " +
             "        dsctxlot_dbt TXBuyLot, " +
             "        dsctxlot_dbt currbuylot, " +
             "        dsctxlot_dbt salelot, " +
             "        ddl_tick_dbt DealSale, " +
             "        ddl_leg_dbt  LegBuy, " +
             "        ddl_tick_dbt DealBuy, " +
             "        davoiriss_dbt av " +
             "  WHERE currbuylot.t_ID      = QueryLnk.t_BuyID and " +
             "        TXBuyLot.t_ID        = currbuylot.t_BegLotID and " +
             "        salelot.t_ID         = QueryLnk.t_BegLotID and " +
             "        DealSale.t_DealID    = salelot.t_DealID and " +
             "        DealBuy.t_DealID     = TXBuyLot.t_DealID and " +
             "        LegBuy.t_DealID      = DealBuy.t_DealID and " +
             "        LegBuy.t_LegID       = 0 and "+
             "        LegBuy.t_LegKind     = " + LEG_KIND_DL_TICK + " and " +
             "        av.t_FIID            = QueryLnk.t_FIID";

     Body3 = "   FROM (" + QueryRest3 + ") QueryRest," +
             "        DSCTXLOT_DBT currTXBuyLot, DSCTXLOT_DBT TXBuyLot, dfininstr_dbt fin, DAVOIRISS_DBT av, DDL_TICK_DBT DealBuy, DDL_LEG_DBT LegBuy " +
             "  WHERE currTXBuyLot.t_ID = QueryRest.SourceID AND " +
             "        TXBuyLot.t_ID     = currTXBuyLot.t_BegLotID AND " +
             "        fin.t_FIID        = QueryRest.t_FIID AND " +
             "        av.t_FIID         = fin.t_FIID AND " +
             "        DealBuy.t_DealID  = TXBuyLot.t_DealID AND " +
             "        LegBuy.t_DealID   = DealBuy.t_DealID AND" +
             "        LegBuy.t_LegKind  = " + LEG_KIND_DL_TICK + " AND " +
             "        ((((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) AND  " + 
             "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) <= " + GetSQLDate( m_ReportDate ) + " ) OR DealBuy.t_Ofbu <> chr(88) ) AND " +
             "        RSB_SECUR.GetMainObjAttr(12, LPAD (fin.t_FIID, 10, '0'), 131, TRIM(SYSDATE)) = 2 AND "
             "        LegBuy.t_LegID    = 0 " + WhereCond;

     var cmd = DL_RSDCommand(Head1 + Body1 + " UNION ALL " + Head2 + Body2 + " UNION ALL " + Head3 + Body3 + " ORDER BY TypeB, TaxGroup, AvrCode, T_BUYDATE, DealBuyDate, DealBuyCodeTS ");
     ProgressValue.Maximum = cmd.GetCount();
     ProgressValue.Current = 0;

     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum, HTML_StSheetName, HTML_StSheetName);
     end;

     T_Dep.ClearArray();
     m_CacheFinInstr.Clear();

     m_RS = cmd.Execute();
     while( m_RS.MoveNext() )
        if((m_RS.Termless != 1) or (m_RS.DrawingDate != date(0, 0, 0)))
          this.ClearCacheOneRecord();
          // найдём льготные/нельготные периоды
          m_TaxPeriods.Clear();
          if( m_RS.TaxGroup == 17 )
            m_TaxPeriods.Init(m_RS.FIID, MAX(this.H0_1()-1, this.DDB()), this.H0_2());
          end;

          if((m_RS.IsCashMode == "X") and (m_RS.SaleDateCash >= this.Дн1()) and (m_RS.SaleDateCash <= date("31.12.2023")) and
             (this.H0_2() >= Dend) and (this.H0_2() <= Date(31, 12, DendYear)) and
             (HasCouponWithNoOper(m_RS.t_FIID, this.Дн1(), m_RS.SaleDateCash) == true)
            )
            PrintTableLine_1_Cash();
          else
            PrintTableLine_1();
          end;

          if( m_RS.TypeB == TXLOTS_BUY  )
            SaveFIIDForForm_2(m_RS.FIID);
          end;
          m_IsExistsData = true;
          ProgressValue.Current = ProgressValue.Current + 1;
          ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); // всего 3 парамера Update(index, count, text)
        else
           MsgBox("По облигации с признаком \"бессрочная\" " + m_RS.ISIN + IIF((m_RS.ISIN != "") and (m_RS.AvrName != ""), ", ", "") + m_RS.AvrName + " нельзя определить дату погашения/оферты");
        end;
     end;

     ProgressIndicator.Stop();

     /* информация о дополнительном процентном доходе */

     var exec = " SELECT fin.t_FIID, fin.t_FI_Code, fin.t_Name, av.t_TaxGroup, av.t_ISIN, av.t_LSIN, fin.t_FaceValueFI " +
                "   FROM dspprtcst_tmp t, dfininstr_dbt fin, DAVOIRISS_DBT av " +
                "  WHERE fin.t_FIID = t.t_FIID " +
                "    AND av.t_FIID  = fin.t_FIID " +
                "    AND exists ( SELECT fiflwarn.t_AutoKey " +
                "                   FROM dfiflwarn_dbt fiflwarn " +
                "                  WHERE fiflwarn.t_FIID = fin.t_FIID " +
                "                    AND fiflwarn.t_ChargeDate >= " + GetSQLDate( this.H0_1() ) +
                "                    AND fiflwarn.t_ChargeDate <= " + GetSQLDate( this.H0_2() ) +
                "                    AND fiflwarn.t_IncomeCode in('1','2') " +
                "               ) " +
                " ORDER BY av.t_TaxGroup, fin.t_FI_Code ";

     ProgressValue.Maximum = SQL_GetNRecs( exec );
     ProgressValue.Current = 0;

     if( m_IsWebService and (WebMenuItem != null) )
       var header1 = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header1, header1);
     else
       ProgressIndicator.Start(ProgressValue.Maximum, HTML_StSheetName, HTML_StSheetName);
     end;

     var DataSet = TRsbDataSet( exec );
     while( DataSet.MoveNext() )
        var Kind = "1";
        if( ExistsWarnKind(DataSet.FIID, Kind) )
           PrintTableLine_1_AII(DataSet.FIID, DataSet.FI_Code, DataSet.Name, DataSet.TaxGroup, DataSet.FaceValueFI, Kind, IIF(DataSet.ISIN != "", DataSet.ISIN, DataSet.LSIN) );
        end;

        Kind = "2";
        if( ExistsWarnKind(DataSet.FIID, Kind) )
           PrintTableLine_1_AII(DataSet.FIID, DataSet.FI_Code, DataSet.Name, DataSet.TaxGroup, DataSet.FaceValueFI, Kind, IIF(DataSet.ISIN != "", DataSet.ISIN, DataSet.LSIN));
        end;

        m_IsExistsData = true;
        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); // всего 3 парамера Update(index, count, text)
     end;

     ProgressIndicator.Stop();
  END;

  /*Наименование нашего банка*/
  MACRO H0_A():STRING
     return ПолучитьКороткоеИмяСубъекта({OurBank});
  END;

  /*ИНН нашего банка*/
  MACRO H0_B()
     var INN, KPP;
     SplitFullINN(ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, KPP);

     return INN;
  END;

  /*КПП нашего банка*/
  MACRO H0_C()
     var INN, KPP;
     SplitFullINN(ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, KPP);

     return KPP;
  END;

  /*Конечная дата*/
  MACRO H0_2():DATE
     return m_ReportDate;
  END;

  /*Начальная дата*/
  MACRO H0_1():DATE
     return m_BeginDate;
  END;

  MACRO H0_7():DATE
     return H0_1();
  END;

  MACRO H0_8():DATE
     return H0_2();
  END;

  MACRO TypeB():STRING /*Код сделки приобретения*/
     var RetVal:string = "";
     if( m_RS.TypeB == TXLOTS_BUY )
        if(m_RS.DealBuyBOfficeKind == DL_AVRWRT)
           RetVal = "FB";
        else
           RetVal = "B";
        end;
     elif( m_RS.TypeB == TXLOTS_SALE )
        RetVal = "S";
     elif( m_RS.TypeB == TXLOTS_REPO )
        RetVal = "РП";
     elif( m_RS.TypeB == TXLOTS_BACKREPO )
        RetVal = "РО";
     elif( m_RS.TypeB == TXLOTS_LOANPUT )
        RetVal = "ЗП";
     elif( m_RS.TypeB == TXLOTS_LOANGET )
        RetVal = "ЗО";
     end;

     return RetVal;
  END;

  // Дата перехода права собств-ти при приобретении ц/б
  MACRO DDB():DATE
     if(m_DDB == NULL)
      m_DDB = SQL_ConvTypeDate(m_RS.BuyDate);

      if(this.DGO() != ZeroDate)
        var sql = "SELECT (CASE " +
                             " WHEN rq.T_FACTDATE = TO_DATE('01.01.0001','DD.MM.YYYY') THEN rq.T_PLANDATE " +
                             " ELSE rq.T_FACTDATE " +
                         " END) AS t_DeliveryDate " +
                   " FROM ddlrq_dbt rq " +
                  " WHERE rq.T_DOCKIND = " + DealBuy().rec.BofficeKind +
                    " AND rq.T_DOCID = " + m_RS.DealBuyID +
                    " AND rq.T_TYPE = " + DLRQ_TYPE_DELIVERY +
                    " AND rq.T_DEALPART = 1 ";

        var commCmd = DL_RSDCommand(sql);
        var commDS = commCmd.Execute();

        if(commDS.MoveNext())
          m_DDB = SQL_ConvTypeDate(commDS.DeliveryDate);
        end;
        end;
     end;

     return m_DDB;
  END;
  
  MACRO Дн1():DATE 
     return MAX( date("01.01.2022"), this.DDB()+1);
  END;

  macro IsDiscount() /*Дисконтная облигация*/
     return m_RS.IsDiscount == 1;
  end;

  macro IsPercent() /*Процентная облигация*/
     return m_RS.IsPercent == 1;
  end;

  macro DrawingDate() /*Дата погашения ценной бумаги*/
     return SQL_ConvTypeDate(m_RS.DrawingDate);
  end;

  macro BegPlacementDate() /*Дата размещения ценной бумаги*/
     return SQL_ConvTypeDate(m_RS.BegPlacementDate);
  end;

  macro RealtivePrice() /*Цена сделки в процентах от номинала*/
     return m_RS.RelativePrice;
  end;

  macro BuyPrice() /*Цена сделки*/
     return m_RS.BuyPrice;
  end;

  macro PrBNom() /*Цена сделки в процентах от номинала*/
     if(RealtivePrice() == SET_CHAR)
        return BuyPrice();
     else
        if(VPrB() != NATCUR)
           return BuyPrice() * 100 / NomB();
        else
           var NomBRub = 0;
           SmartConvertSum(NomBRub, NomB(), this.DDB(), m_RS.FaceValueFI, 0);
           return BuyPrice() * 100/ NomBRub;
        end;
     end;
  end;

  /*Группа налогового учета*/
  MACRO AvrTaxGroupName():STRING
     var GroupName = "", AvrTaxGroupCount = 0; 
     
     if (m_AvrTaxGroup.Size > 0)
        while( AvrTaxGroupCount < m_AvrTaxGroup.Size )
           if( ( ValType( m_AvrTaxGroup[AvrTaxGroupCount] ) == V_INTEGER )
           and ( m_AvrTaxGroup[AvrTaxGroupCount] > 0 ) )
              if( GroupName == "" )
                 GroupName = GroupName + GetLLVALname (2903, m_AvrTaxGroup[AvrTaxGroupCount]);
              else
                 GroupName = GroupName + ", " + GetLLVALname (2903, m_AvrTaxGroup[AvrTaxGroupCount]);
              end;
           end;
           AvrTaxGroupCount = AvrTaxGroupCount + 1;
        end;
     end;
     if( GroupName == "" )
        GroupName = "Все";
     end;
     return GroupName;
  END;

  /*Выпуск ц/б*/
  MACRO AvrName():STRING
     return m_AvrName;
  END;

  MACRO ISIN()
    if (m_RS.ISIN != "")
       return "" + m_RS.ISIN;
    else 
       return "" + m_RS.LSIN;
    end;
  END;

  MACRO StatusSec():STRING
     return m_RS.LinkType;
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBRub():STRING
     return (C_SumBRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdBvp():STRING
     return (C_NkdBvp+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetQnty():STRING
     return (C_Qnty+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBRub_Amort():STRING
     return (C_SumBRub_Amort+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBvp():STRING
     return (C_SumBvp+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortRub():STRING
     return (C_AmortRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortVN_before():STRING
     return (C_AmortVN_before+string(m_CurrStrNum));
  END;
 
  /*получить адрес ячейки*/
  MACRO GetAmortVN_after():STRING
     return (C_AmortVN_after+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNom_DDB():STRING
     return (C_Nom_DDB+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdRepRub():STRING
     return (C_NkdRepRub + string(m_CurrStrNum));
  END;

  MACRO GetCoupRub():STRING
     return (C_CoupRub + string(m_CurrStrNum));
  END;

  MACRO GetNkdPrevRub():STRING
     return (C_NkdPrevRub + string(m_CurrStrNum));
  END;

  MACRO GetNkdBrepRub():STRING
     return (C_NkdBrepRub + string(m_CurrStrNum));
  END;

  MACRO GetDifB():STRING
     return (C_DifB + string(m_CurrStrNum));
  END;

  MACRO GetKPNom():STRING
     return (C_KPNom + string(m_CurrStrNum));
  END;

  MACRO GetAmortVNPer():STRING
     return (C_AmortVNPer + string(m_CurrStrNum));
  END;

  MACRO GetAmortVNaccPer():STRING
     return (C_AmortVNaccPer + string(m_CurrStrNum));
  END;

  MACRO GetCrBD():STRING
     return (C_CrBD + string(m_CurrStrNum));
  END;

  MACRO GetTaxeAmort():STRING
     return (C_TaxeAmort + string(m_CurrStrNum));
  END;

  MACRO GetTaxeNKD():STRING
     return (C_TaxeNKD + string(m_CurrStrNum));
  END;

  MACRO GetNKDallRub():STRING
     return (C_NKDallRub + string(m_CurrStrNum));
  END;

  MACRO GetNKDallRub1():STRING
     return (C_NKDallRub1 + string(m_CurrStrNum));
  END;

  MACRO GetNKDallRub2():STRING
     return (C_NKDallRub2 + string(m_CurrStrNum));
  END;

  MACRO GetSumBDif():STRING
     return (C_SumBDif + string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetComBRub_Amort():STRING
     return (C_ComBRub_Amort+string(m_CurrStrNum));
  END;

  /*Стоимость приобретения, учитываемая в налоговой базе актива, руб*/
  /*Формула!*/
  MACRO SumBrub_tax():STRING
     return F(GetSumBRub()+"-"+GetSumBRub_Amort());
  END;

  /*Значение поля <Код> категории сделки <Способ определения РЦ>*/
  MACRO RCB():string
    var NumInList = "";
    if( TypeB() != "РО" )
       DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKRC, DL_GetMainObjAttr( this.DealBuy(), OBJGROUP_TICKRC, OBJTYPE_SECDEAL ), null, null, @NumInList);
    end;
    return NumInList;
  END;

  MACRO QuoteValueB()
    if( TypeB() != "РО" )
       return m_RS.BuyMarketQuoteValue;
    end;
    return "";
  END;

  /*Значение поля <Код> категории сделки <Вид ФИСС> (фьючерс, форвард, опцион)*/
  MACRO RFISSB():string
    var Name = "";
    if( TypeB() != "РО" )
       DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKFIIS, DL_GetMainObjAttr( this.DealBuy(), OBJGROUP_TICKFIIS, OBJTYPE_SECDEAL ), null, @Name);
    end;
    return Name;
  END;

  MACRO DqualB():DATE
    if(m_DqualB == NULL)
      if( TypeB() != "РО" )
         m_DqualB = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_REQUALREPO);
         if((ValType(m_DqualB) != V_UNDEF) and (m_DqualB != ""))
           m_DqualB = date(m_DqualB);
         end;
      end;
    end;
    return m_DqualB;
  END;

  /*Значение поля <Название> категории сделки <Сделка подлежит дополни-тельному контролю>*/
  MACRO GetControl()
    if( m_ControlCode == null )
       m_ControlCode = "";
       DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKCONTROL, DL_GetMainObjAttr( this.DealBuy(), OBJGROUP_TICKCONTROL, OBJTYPE_SECDEAL ), null, null, @m_ControlCode);
    end;
  END;

  MACRO ControlCode():string
    if( TypeB() != "РО" )
       this.GetControl();
       return m_ControlCode;
    else
       return "";
    end;
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Комментарий для категории <Сделка подлежит дополнительному контролю>>*/
  MACRO Control_Comment():string
    var vControl_Comment = "";
    if( TypeB() != "РО" )
       vControl_Comment = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_CONTROLCOMMENT);
       if((ValType(vControl_Comment) != V_UNDEF) and (vControl_Comment != ""))
         vControl_Comment = string(vControl_Comment);
       end;
    end;

    return vControl_Comment;
  END;

  MACRO FullName():string
     return m_RS.Definition;
  END;

  /*Значение примечания сделки "Даты в учете"*/
  MACRO DR():DATE
    var vDR:date = ZeroDate;

    if( TypeB() != "РО" )
       vDR = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_DATEIN);
       if((ValType(vDR) != V_UNDEF) and (vDR != ""))
          vDR = date(vDR);
       end;
    end;

    return vDR;
  END;

  MACRO QB():double
     return double(m_RS.BuyAmount);
  END;

  MACRO NKDrepVNOnDate( EndDate:date ):MONEY
     var RetVal = $0;
     if( (TypeB() == "B") or (TypeB() == "FB") )
        RetVal = НКД(m_RS.FIID, this.Qnty(), EndDate, null, null, null, null, null, true);
        if( RetVal < $0 )
           RetVal = $0;
        end;
     end;
     return RetVal;
  END;

  MACRO ifCoup_( dat:date ):integer
     var RetVal = 0;
     var sql = RSDCommand(" SELECT Count(fiw.t_DrawingDate) Nrec " +
                          "   FROM dfiwarnts_dbt fiw " +
                          "  WHERE fiw.t_FIID         =  ? AND " +
                          "        fiw.t_IsPartial   != 'X' AND " +
                          "        fiw.t_DrawingDate  > ? AND " +
                          "        fiw.t_DrawingDate <= ? "
                         );
     sql.addParam( "", RSDBP_IN, m_RS.FIID );
     sql.addParam( "", RSDBP_IN, iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()) );
     sql.addParam( "", RSDBP_IN, dat );
     sql.execute();

     var vRS = TRsbDataSet( sql );

     if( vRS.MoveNext() and (vRS.Nrec > 0) )
        RetVal = 1;
     end;

     return RetVal;
  END;

  /*Отметка о наличии выплат НКД от эмитента с даты покупки (1 - да, 0 - нет)*/
  MACRO ifCoup():integer
     if( m_ifCoup == null )
        m_ifCoup = ifCoup_(this.H0_2());
     end;

     return m_ifCoup;
  END;

  /*НКД, причитающ. к получению от эмитента на конец отчетного (налогового) периода - в валюте номинала*/
  MACRO NKDrepVN():MONEY
     if(IsPercent())
        if( m_NKDrepVN == NULL )
          m_NKDrepVN = $0.0;
          if( (TypeB() == "B") or (TypeB() == "FB") )
            if((m_RS.IsCashMode == "X") and ((this.H0_2() < date("01.01.2025")) and (this.H0_2() >= date("01.01.2022"))) )
              if ((this.H0_2() >= date("01.01.2022")) and (this.H0_2() <= date("31.12.2023")))
                m_NKDrepVN = $0;
              elif((this.H0_2() >= date("01.01.2024")) and (this.H0_2() <= Date(31, 12, DendYear)))
                m_NKDrepVN = НКД(m_RS.FIID, this.Qnty(), this.H0_2(), null, null, null, null, null, true);
              end;
            else
              m_NKDrepVN = NKDrepVNOnDate(this.H0_2());
            end;
          end;
        end;
        return m_NKDrepVN;
     elif(IsDiscount())
        if((m_RS.TaxGroup == 2) or (m_RS.TaxGroup == 4) or (m_RS.TaxGroup == 6) or (m_RS.TaxGroup == 8))
           if(DrawingDate() - BegPlacementDate() != 0)
              m_NKDrepVN = this.Qnty() * NomB() * (1 - 0.01 * PrAucNom()) * (this.H0_2() - iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())) 
                            / (DrawingDate() - BegPlacementDate());
           else
              m_NKDrepVN = 0;
           end;
           return m_NKDrepVN;
        elif((m_RS.TaxGroup == 10) or (m_RS.TaxGroup == 34))
          if(DrawingDate() - this.DDB() != 0)
             m_NKDrepVN = this.Qnty() * NomB() * (1 - 0.01 * PrBNom()) * (this.H0_2() - iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())) 
                           / (DrawingDate() - iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()));
          else
             m_NKDrepVN = 0;
          end;
          return m_NKDrepVN;
        end;
     end;
     return 0;
  END;

  /*НКД, причитающ. к получению от эмитента на конец отчетного (налогового) периода - в рублях*/
  MACRO NkdRepRub():MONEY
     if( m_NkdRepRub == NULL )
        m_NkdRepRub = $0;

        if( (TypeB() == "B") or (TypeB() == "FB") )
          if((m_RS.IsCashMode == "X") and (this.H0_2() <= date("31.12.2023")) and (this.H0_2() >= date("01.01.2022")))
            m_NkdRepRub = $0;
          else
            SmartConvertSum(m_NkdRepRub, this.NKDrepVN(), this.H0_2(), m_RS.FaceValueFI, NATCUR, true);
          end;
        end;
     end;

     return m_NkdRepRub;
  END;

  MACRO NkdRepRubOnDate( EndDate:date ):MONEY
     var RetVal = $0;
     if( (TypeB() == "B") or (TypeB() == "FB") )
        SmartConvertSum(RetVal, NKDrepVNOnDate(EndDate), EndDate, m_RS.FaceValueFI, NATCUR, true);
     end;
     return RetVal;
  END;

  /*Количество купонов, полученных в отчетном периоде*/
  MACRO CoupCount():INTEGER
     if( m_CoupCount == NULL )
        m_CoupCount = 0;
        if( (TypeB() == "B") or (TypeB() == "FB") )
           m_CoupCount = GetCountCouponInPeriod(m_RS.FIID, this.Дн(), this.H0_2());
        end;
     end;

     return m_CoupCount;
  END;

  /*Дата выплаты по последнему купону в отчетном периоде в соответствии со справочником*/
  MACRO LastCoupDate():DATE
     if( CoupCount() > 0 )
        return GetMaxCouponDrawingDateInPeriod(m_RS.FIID, this.Дн(), this.H0_2(), NULL, SET_CHAR);
     else
        return ZeroDate;
     end;
  END;

  /*НКД уплаченный при приобретении, в валюте сделки
    Комментарии по заполнению поля смотри в отчёте "Налоговый портфель на дату"*/
  MACRO NkdBvp():MONEY
     if( m_NkdBvp == NULL )
       m_NkdBvp = $0.0;
       if( TypeB() != "РО" )
         if( m_TaxDepositoryMode )           
           m_NkdBvp = money(this.NKDBuy()*this.Qnty()/this.QB());           
         else
           if(m_RS.FaceValueFI == this.VPrB())
             m_NkdBvp = money(this.NKDBuy()*this.Qnty()/this.QB());
           else
             if( SmartConvertSum( m_NkdBvp, this.NKDBuy()*this.Qnty()/this.QB(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), DDB()),  m_RS.FaceValueFI, VPrB(), true) == false )
               m_NkdBvp = $0.0;
             end;          
           end;
         end;  
       end;
     end; 
     return m_NkdBvp;
  END;

  /*НКД уплаченный при приобретении, учитываемый в портфеле на отчетную дату, в валюте номинала*/
  MACRO NkdBvn():money
    if( m_NkdBvn == NULL )
      m_NkdBvn = $0.0;
      if( TypeB() != "РО" )
        if( m_TaxDepositoryMode )          
          if( m_RS.FaceValueFI != VPrB() )
            if( SmartConvertSum(m_NkdBvn, NkdBvp(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), DDB()), VPrB(), m_RS.FaceValueFI, true) == false )
               m_NkdBvn = $0.0;
            end;
          else
            m_NkdBvn = NkdBvp();
          end;          
        else
          m_NkdBvn = this.NKDBuy()*this.Qnty()/this.QB();  
        end;
      end;
    end;
    return m_NkdBvn;
  END;

  MACRO ifCoupPrevOnDate( BegDate:date ):integer
     var RetVal:integer = 0;

     if( (TypeB() == "B") or (TypeB() == "FB") )
        RetVal = ifCoup_(BegDate);
     end;

     return RetVal;
  END;

  /*Отметка о наличии выплат НКД от эмитента до начала налогового периода (1 - да, 0 - нет)*/
  MACRO ifCoupPrev():integer
     if( m_ifCoupPrev == null )
        m_ifCoupPrev = ifCoupPrevOnDate(this.H0_1());
     end;
     return m_ifCoupPrev;
  END;

  MACRO NkdBrubOnDate( EndDate:date, _ifCoup ):money
     var RetVal = $0.0;
     var RegVal = 0, ConvertDate = DDB();
     var date_p = SQL_ConvTypeDate(m_RS.PaymentDate);
     var date_d = SQL_ConvTypeDate(m_RS.DeliveryDate);
     
     /* 12.02.2020 RAS:505214*/
     if( SQL_ConvTypeDate(m_RS.DeliveryDateTO) > SQL_ConvTypeDate(m_RS.DeliveryDate) )
       date_d = SQL_ConvTypeDate(m_RS.DeliveryDateTO);
     end;
     /*~RAS*/

     GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V21", V_INTEGER, RegVal, NULL);
     if(RegVal == 0)
        ConvertDate = date_d;
     elif(RegVal == 1)
        ConvertDate = IIF(date_d < date_p, date_d, date_p);
     elif(RegVal == 2)
        ConvertDate = IIF(date_d > date_p, date_d, date_p);
     end;

     if( TypeB() != "РО" )
        if( m_TaxDepositoryMode )
          if( m_RS.FaceValueFI != NATCUR )
             if( _ifCoup == 1 )
                if( VPrB() != NATCUR )
                   if( SmartConvertSum(RetVal, NkdBvn(), ConvertDate, m_RS.FaceValueFI, NATCUR, true) == false )
                      RetVal = $0.0;
                   end;
                else
                   RetVal = NkdBvp();
                end;
             else
                if( SmartConvertSum(RetVal, NkdBvn(), EndDate, m_RS.FaceValueFI, NATCUR, true) == false )
                   RetVal = $0.0;
                end;
             end;
          else
            RetVal = NkdBvp();
          end;
        else
          if( m_RS.FaceValueFI != NATCUR )
            if( _ifCoup == 1 )
              if( SmartConvertSum(RetVal, NkdBvn(), ConvertDate, m_RS.FaceValueFI, NATCUR, true) == false )
                RetVal = $0.0;
              end;
            else
              if( SmartConvertSum(RetVal, NkdBvn(), EndDate, m_RS.FaceValueFI, NATCUR, true) == false )
                RetVal = $0.0;
              end;
            end;              
          else
            RetVal = NkdBvn();           
          end;
        end;
     end;

     return RetVal;
  END;

  /*НКД, уплаченный при приобретении, в рублях*/
  MACRO NkdBrub():money
     if( m_NkdBrub == NULL )
       if(this.IsDUDealB() == 1)
         SmartConvertSum(m_NkdBrub, NkdBvn(), this.ImportDUDate(), m_RS.FaceValueFI, NATCUR, true)
       else
         m_NkdBrub = NkdBrubOnDate(H0_2(), ifCoup());
       end;
     end;
     return m_NkdBrub;
  END;

  /* НКД, уплаченный при приобретении, уменьшающий процентные доходы, руб. - прошлых налоговых периодов */
  MACRO NkdBprevRub():MONEY
     var RetVal:money = $0.0;

     if( (TypeB() == "B") or (TypeB() == "FB") )
        if( this.ifCoupPrev() == 1 )
           if( m_RS.FaceValueFI == NATCUR )
              RetVal = this.NkdBvn();
           else
              RetVal = this.NkdBrub();
           end;
        end;
     end;

     return RetVal;
  END;

  /* НКД, уплаченный при приобретении, уменьшающий процентные доходы, руб. - текущего налогового периода */
  MACRO NkdBrepRub():MONEY
     var RetVal:money = $0.0;
     var FirstCouponDate = FirstCouponWithOperStat(m_RS.t_FIID, Дн1(), H0_2());

     if( (TypeB() == "B") or (TypeB() == "FB") )
       if ( (m_RS.IsCashMode == "X") and (H0_2() <= date("31.12.2024")) )
         var NKD_2022:money = $0.0;
         var NKD_2023:money = $0.0;

         if ( (this.DDB() >= date("01.01.2021")) and (this.DDB() <= date("31.12.2022")) )
           if( this.ifCoupPrevOnDate(date("01.01.2022")) == 0 )
             if( m_RS.FaceValueFI == NATCUR )
               NKD_2022 = this.NkdBvn();
             else
               NKD_2022 = this.NkdBrub();
             end;
           end;
         end;
           
         if ( (this.DDB() >= date("01.01.2023")) and (this.DDB() <= date("31.12.2023")) )
           if( this.ifCoupPrevOnDate(date("01.01.2023")) == 0 )
             if( m_RS.FaceValueFI == NATCUR )
               NKD_2023 = this.NkdBvn();
             else
               NKD_2023 = this.NkdBrub();
             end;
           end;
         end; 

         if(FirstCouponDate != NULL)
           if( (H0_2() >= date("01.01.2022")) and (H0_2() <= date("31.12.2022")) and
               (this.DDB() >= date("01.01.2021")) and (this.DDB() <= date("31.12.2022")) and
               (FirstCouponDate >= Дн1()) and (FirstCouponDate <= H0_2()) 
              )
             RetVal = NKD_2022;
           end;

           if( (H0_2() >= date("01.01.2023")) and (H0_2() <= date("31.12.2023")) and
               (this.DDB() >= date("01.01.2021")) and (this.DDB() <= date("31.12.2022")) and 
               (FirstCouponDate >= date("01.01.2023")) and (FirstCouponDate <= date("31.12.2023"))
              )
             RetVal = NKD_2023;
           end;
           
           if( (H0_2() >= date("01.01.2023")) and (H0_2() <= date("31.12.2023")) and
               (this.DDB() >= date("01.01.2023")) and (this.DDB() <= date("31.12.2023")) and 
               (FirstCouponDate >= date("01.01.2023")) and (FirstCouponDate <= date("31.12.2023"))
              )
             RetVal = NKD_2023;
           end;
           
           if( (H0_2() >= date("01.01.2024")) and (H0_2() <= Dend - 1) )
             if( this.ifCoupPrev() == 0 )
               if( m_RS.FaceValueFI == NATCUR )
                  RetVal = this.NkdBvn();
               else
                  RetVal = this.NkdBrub();
               end;
             end;
           end;
           
           if( (H0_2() >= Dend) and (H0_2() <= date("31.12.2024")) )
             if( (this.DDB() >= date("01.01.2021")) and (this.DDB() <= date("31.12.2022")) and
                 (FirstCouponDate < date("01.01.2022")) and (FirstCouponDate > date("31.12.2022"))
                )
               RetVal = NKD_2022;
             elif( (this.DDB() >= date("01.01.2023")) and (this.DDB() <= date("31.12.2023")) and
                   (FirstCouponDate < date("01.01.2023")) and (FirstCouponDate > date("31.12.2023"))
                  )
               RetVal = NKD_2023;
             end;
           end;
         else
           if( (H0_2() >= Dend) and (H0_2() <= date("31.12.2024")) )
             if( (this.DDB() >= date("01.01.2021")) and (this.DDB() <= date("31.12.2022")) )
               RetVal = NKD_2022;
             elif( (this.DDB() >= date("01.01.2023")) and (this.DDB() <= date("31.12.2023")) )
               RetVal = NKD_2023;
             end;
           end;
         end;
       else
         if( this.ifCoupPrev() == 0 )
           if( m_RS.FaceValueFI == NATCUR )
             RetVal = this.NkdBvn();
           else
             RetVal = this.NkdBrub();
           end;
         end;
       end;
     end;
     return RetVal;
  END;

  MACRO NkdBrepRubForPeriod( BegDate:date, EndDate:date ):MONEY
     var RetVal:money = $0.0;

     if( (TypeB() == "B") or (TypeB() == "FB") )
        if( this.ifCoupPrevOnDate(BegDate) == 0 )
           if( m_RS.FaceValueFI == NATCUR )
              RetVal = this.NkdBvn();
           else
              RetVal = this.NkdBrubOnDate(EndDate, ifCoup_(EndDate));
           end;
        end;
     end;

     return RetVal;
  END;

  /*Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода - период, дней*/
  MACRO Tprev():INTEGER
     if( (TypeB() == "B") or (TypeB() == "FB") )
        return this.Tprev();
     end;
     return 0;
  END;

  /*Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода - в валюте номинала*/
  MACRO NkdPrevVN():MONEY
     if(this.DDB() < this.H0_1())
        if(IsPercent())
           if( m_NkdPrevVN == NULL )
              if( ((TypeB() == "B") or (TypeB() == "FB")) and (iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()) < this.H0_1()) )
                if ( (m_RS.IsCashMode == "X") and ((this.H0_2() < date("01.01.2025")) and (this.H0_2() >= date("01.01.2022"))) )
                  var FirstCouponDate = FirstCouponWithOperStat(m_RS.t_FIID, Дн1(), H0_2());
                  var NKD_2021 = $0.0;
                  if(this.DDB() < date("01.01.2022"))
                    if(this.ДкForPeriod(date("01.01.2022"), date("01.01.2022")) - 1 > iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()))
                      NKD_2021 = НКД( m_RS.t_FIID, this.Qnty(), date("31.12.2021"));
                    else
                      NKD_2021 = НКД( m_RS.t_FIID, this.Qnty(), date("31.12.2021")) - this.NkdBvn();
                    end;
                  end;
                  
                  if( (this.H0_2() >= date("01.01.2022")) and (this.H0_2() <= date("31.12.2022")) )
                    if(FirstCouponDate != NULL)
                      m_NkdPrevVN = NKD_2021;
                    else
                      m_NkdPrevVN = $0;
                    end;
                  end;
                  
                  if( (this.H0_2() >= date("01.01.2023")) and (this.H0_2() <= date("31.12.2023")) and (this.DDB() < date("01.01.2022")) )
                    if( (FirstCouponDate != NULL) and (FirstCouponDate >= date("01.01.2022")) and (FirstCouponDate <= date("31.12.2022")) )
                      m_NkdPrevVN = $0.0;
                    elif( (FirstCouponDate != NULL) and (FirstCouponDate >= date("01.01.2023")) and (FirstCouponDate <= date("31.12.2023")) )
                      m_NkdPrevVN = NKD_2021;
                    else
                      m_NkdPrevVN = $0.0;
                    end;
                  end;
                  
                  if( (this.H0_2() >= date("01.01.2023")) and (this.H0_2() <= Dend - 1) )
                    m_NkdPrevVN = $0;
                  end;
                  
                  if( (this.H0_2() >= Dend) and (this.H0_2() <= date("31.12.2024")) )
                    if( (this.DDB() < date("01.01.2022")) and (FirstCouponDate != NULL) and 
                        (FirstCouponDate >= date("01.01.2022")) and (FirstCouponDate <= date("31.12.2023")) 
                       )
                      m_NkdPrevVN = $0.0;
                    else
                      m_NkdPrevVN = NKD_2021;
                    end;
                  end;
                else
                  this.NkdPrevVN();
                end;
              end;
              if( m_NkdPrevVN == NULL )
                 m_NkdPrevVN = $0;
              end;
           end;
           return m_NkdPrevVN;
        elif(IsDiscount())
           if((m_RS.TaxGroup == 2) or (m_RS.TaxGroup == 4) or (m_RS.TaxGroup == 6) or (m_RS.TaxGroup == 8))
              if(DrawingDate() - BegPlacementDate() != 0)
                 m_NkdPrevVN = this.Qnty() * NomB() * (1 - 0.01 * PrAucNom()) * (this.H0_1() - 1 - iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())) 
                                / (DrawingDate() - BegPlacementDate());
              else
                 m_NkdPrevVN = 0;
              end;
              return m_NkdPrevVN;
           elif((m_RS.TaxGroup == 10) or (m_RS.TaxGroup == 34))
              if(DrawingDate() - this.DDB != 0)
                 m_NkdPrevVN = this.Qnty() * NomB() * (1 - 0.01 * PrBNom()) * (this.H0_1() - 1 - iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())) 
                                / (DrawingDate() - iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()));
              else
                 m_NkdPrevVN = 0;
              end;
              return m_NkdPrevVN;
           end;
        end;
     end;

     return 0;
  END;

  /*Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода - в рублях*/
  MACRO NkdPrevRub():MONEY
     if( m_NkdPrevRub == NULL )
        if( ((TypeB() == "B") or (TypeB() == "FB")) and (iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()) < this.H0_1()) )
          if ( (m_RS.IsCashMode == "X") and ((this.H0_2() < date("01.01.2025")) and (this.H0_2() >= date("01.01.2022"))) )
            SmartConvertSum( m_NkdPrevRub, NkdPrevVN(), date("31.12.2021"), m_RS.FaceValueFI, NATCUR, true );
          else
            SmartConvertSum( m_NkdPrevRub, NkdPrevVN(), this.H0_1()-1, m_RS.FaceValueFI, NATCUR, true );
          end;
        end;
        if( m_NkdPrevRub == NULL )
           m_NkdPrevRub = $0;
        end;
     end;

     return m_NkdPrevRub;
  END;

  MACRO NkdPrevRubForPeriod( BegDate:date, EndDate:date ):MONEY
     var RetVal:money = $0.0;
     if( ((TypeB() == "B") or (TypeB() == "FB")) and (this.DDB() < BegDate) )
        RetVal = this.NkdPrevRubForPeriod(BegDate, EndDate);
     end;
     return RetVal;
  END;

  MACRO CouponSum04_07(Amount, DataBegin, DateEnd, ToRUB):MONEY
   var v_CoupVN = $0.0;
   var DateN1 = date("01.01.2022");
   var DateK1 = date("31.12.2023");

   if ( (m_RS.IsCashMode == "X") and ((this.H0_2() < date("01.01.2025")) and (this.H0_2() >= date("01.01.2022"))) )
     if( (this.H0_2() >= DateN1) and (this.H0_2() <= DateK1))// Перепроверить после окончательной аналитики
        v_CoupVN = GetCouponSumByPeriodWithOperStat(m_RS.FIID, Amount, DataBegin, DateEnd, "", IIF(ToRUB, NATCUR, NULL), null, GetDrawingDate(), null, null, null, true);        
     elif ( (this.H0_2() >=  Date(01, 01, DendYear)) and (this.H0_2() <= Dend-1) )
        v_CoupVN = IIF(ToRUB,
                       GetCouponSumByPeriod_Rub(m_RS.FIID, Amount, DataBegin, DateEnd, null, GetDrawingDate()),
                       GetCouponSumByPeriod(m_RS.FIID, Amount, DataBegin, DateEnd, null, GetDrawingDate())
                       );
     elif ( (this.H0_2() >=  Dend) and (this.H0_2() <= Date(31, 12, DendYear)) )
        v_CoupVN = IIF(ToRUB,
                       GetCouponSumByPeriod_Rub(m_RS.FIID, Amount, DataBegin, DateEnd, null, GetDrawingDate()),
                       GetCouponSumByPeriod(m_RS.FIID, Amount, DataBegin, DateEnd, null, GetDrawingDate())
                       );
        v_CoupVN = v_CoupVN + GetCouponSumByPeriodWithOperStat(m_RS.FIID, Amount, DateN1, DateK1, "", IIF(ToRUB, NATCUR, NULL), null, GetDrawingDate(), null, null, null, false);
     end;
   else
     v_CoupVN = IIF(ToRUB,
                    GetCouponSumByPeriod_Rub(m_RS.FIID, Amount, DataBegin, DateEnd, m_RS.FaceValueFI, NULL, NULL, NULL, NULL, true ),
                    GetCouponSumByPeriod(m_RS.FIID, Amount, DataBegin, DateEnd, NULL, NULL, NULL, NULL, true )
                    );
   end;

   return v_CoupVN;
  END;

  MACRO CoupVN_For_Cash(ToRUB):MONEY
   var v_CoupVN = $0.0;

   if( (m_RS.IsCashMode == "X") and (this.DDS() < this.H0_2()) and 
       HasCouponWithNoOper(m_RS.t_FIID, Дн1(), this.DDS()) and
       (this.H0_2() >= Dend) and (this.H0_2() <= Date(31, 12, DendYear))
      )
     v_CoupVN = GetCouponSumByPeriodWithOperStat(m_RS.FIID, this.Qnty(), Дн1(), this.DDS(), "", IIF(ToRUB, NATCUR, NULL), null, GetDrawingDate(), null, null, null, false);
   end;

   return v_CoupVN;
  END;

  /*Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде - в валюте номинала*/
  MACRO CoupVN():MONEY
     var IssBankrotDate;
     var EndDate = this.H0_2();
     RECORD avoiriss ("avoiriss.dbt");

     if( m_CoupVN == NULL )
        m_CoupVN = 0;
        if( (TypeB() == "B") or (TypeB() == "FB") )
           avoiriss.FIID = m_RS.FIID;
           GetEQ(avoiriss);
           IssBankrotDate = DATE(ReadNoteForObject(OBJTYPE_AVOIRISS, UniID(avoiriss, OBJTYPE_AVOIRISS), 37));
           if((IssBankrotDate != NULL) and (IssBankrotDate != ZeroDate) and (IssBankrotDate - 1 < EndDate))
              EndDate = IssBankrotDate - 1;
           end;
           m_CoupVN = CouponSum04_07(this.Qnty(), this.Дн(), EndDate);
        end;
     end;

     return m_CoupVN;
  END;

  /*Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде - в рублях*/
  MACRO CoupRub():MONEY
     var IssBankrotDate;
     var EndDate = this.H0_2();
     RECORD avoiriss ("avoiriss.dbt");

     if( m_CoupRub == NULL )
        m_CoupRub = 0;
        if( (TypeB() == "B") or (TypeB() == "FB") )
           avoiriss.FIID = m_RS.FIID;
           GetEQ(avoiriss);
           IssBankrotDate = DATE(ReadNoteForObject(OBJTYPE_AVOIRISS, UniID(avoiriss, OBJTYPE_AVOIRISS), 37));
           if((IssBankrotDate != NULL) and (IssBankrotDate != ZeroDate) and (IssBankrotDate - 1 < EndDate))
              EndDate = IssBankrotDate - 1;
           end;
           m_CoupRub = CouponSum04_07(this.Qnty(), this.Дн(), EndDate, true);
        end;
     end;

     return m_CoupRub;
  END;

  MACRO CoupRubForPeriod( BegDate:date, EndDate:date ):MONEY
     var RetVal:money = $0.0;
     if( (TypeB() == "B") or (TypeB() == "FB") )
        RetVal = GetCouponSumByPeriod_Rub(m_RS.FIID, this.Qnty(), BegDate, EndDate, m_RS.FaceValueFI, NULL, NULL, NULL, NULL, true);
     end;
     return RetVal;
  END;

  /*По облигациям: цена по сделке <CodeB>, в % от номинала (выводится в виде числа процентов, без знака "%")
    по остальным бумагам: Цена в валюте цены по сделке <CodeB> . */
  MACRO PrBvp():double
     var vNom = 0.0, vPrBvp = 0;

     if( TypeB() != "РО" )
        vPrBvp = double(m_RS.BuyPrice);
        if( FI_IsBond(m_RS.FIID) and (this.LegBuy().rec.RelativePrice != "X") )
           vNom = GetFaceValue( m_RS.t_FIID, this.DZB() );
           if( vNom != 0.0 )
              if( m_RS.FaceValueFI != this.VPrB() )
                 if( SmartConvertSumDbl( vPrBvp, double(m_RS.BuyPrice), this.DZB(), this.VPrB(), m_RS.FaceValueFI, true ) == true )
                    vPrBvp = double(vPrBvp*100/vNom);
                 end;
              else
                 vPrBvp = double(m_RS.BuyPrice*100/vNom);
              end;
           else
              msgbox( "Не могу получить номинал фин. инстумента (FIID = "+ String(m_RS.t_FIID) + ")");
           end;
        end;
     end;

     return vPrBvp;
  END;

  /*Рыночная/расчетная цена*/
  MACRO MarketPrice_New():DOUBLE
     if( TypeB() != "РО" )
        return m_RS.MarketPrice_New;
     else
        return 0.0;
     end;
  END;

  MACRO printMarketPrice_New()
     return ВыводЧерезФормулу(this.MarketPrice_New());
  END;

  /*Ед. изм.*/
  MACRO Val_Market_New():STRING
     if( TypeB() != "РО" )
        return SQL_ConvTypeStr( m_RS.Val_Market_New );
     else
        return "";
     end;
  END;

  /*Источник информации*/
  MACRO Market_New():STRING
     if( TypeB() != "РО" )
        return SQL_ConvTypeStr( m_RS.Market_New );
     else
        return "";
     end;
  END;

  /*Дата котировки*/
  MACRO DateMarket_New():DATE
     if( TypeB() != "РО" )
        return SQL_ConvTypeDate(m_RS.DateMarket_New);
     else
        return ZeroDate;
     end;
  END;

  /*Доходы, выплаченные эмитентом при частичном погашении номинала, в валюте номинала - всего*/
  /*Формула!*/
  MACRO AmortVN():STRING
     return F(GetAmortVN_before() + "+" + GetAmortVN_after());
  END;

  /*Код валюты номинала (или  Номинал - валюта)*/
  MACRO VN():STRING
     return m_CacheFinInstr.GetISO( m_RS.FaceValueFI ).m_Number;
  END;

  /*Доходы, выплаченные эмитентом при частичном погашении номинала, в валюте номинала - до 01.01.2015г.*/
  MACRO AmortVN_before():MONEY  
     if( m_AmortVN_before == null )
        m_AmortVN_before = $0.0;
        if( TypeB() != "РО" )
           m_AmortVN_before = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1, min(this.H0_2(),DATE(31,12,2014)) );
        end;
     end;

     return m_AmortVN_before; 
  END;

  /*Доходы, выплаченные эмитентом при частичном погашении номинала, в валюте номинала - с 01.01.2015г. - всего*/
  MACRO AmortVN_after():MONEY
     if( m_AmortVN_after == null )
        m_AmortVN_after = $0.0;
        if( TypeB() != "РО" )
           m_AmortVN_after = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), max(iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1,DATE(1,1,2015)), this.H0_2() );
        end;
     end;

     return m_AmortVN_after; 
  END;

  MACRO AmortVNPer():MONEY
     if( m_AmortVNPer == null )
        m_AmortVNPer = $0.0;
        if( TypeB() != "РО" )
           m_AmortVNPer = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), max(this.DDB()+1,this.H0_1()), this.H0_2() );
        end;
     end;

     return m_AmortVNPer; 
  END;

  MACRO AmortRub():MONEY  
     var RetVal = 0.0;

     if( TypeB() != "РО" )
        if( AmortVN_before() == 0 )
           if( m_RS.FaceValueFI == NATCUR )
              RetVal = this.AmortVNPer();
           else
              RetVal = GetPartialSumByPeriod_Rub( m_RS.FIID, this.Qnty(), max(this.DDB()+1,this.H0_1()), this.H0_2() );
           end;
        end;
     end;

     return RetVal;
  END;

  /*Курс постановки на баланс (спец. Курс)*/
  MACRO CrSpezB():double
     if( m_CrSpezB == NULL )
        m_CrSpezB = ПолучитьКурсПостановкиНаБаланс(DealBuy(), SQL_ConvTypeSum(m_RS.RQID));
     end;
     return m_CrSpezB;
  END;

  /* Курс пересчета ст-ти приобретения в рублевый эквивалент */
  MACRO CrBD():DOUBLE
    if( TypeB() != "РО" )
      if (m_CrBD == NULL)
        m_CrBD = CrSpezB();
        if (m_CrBD != $0.0)
          return m_CrBD;
        else
          if (this.VprB() == NATCUR)
            m_CrBD = 1.0;
          else
            m_CrBD = GetRateOnDateCrossDbl(IIF(this.DP() != ZeroDate,
                                               min(this.DP(), this.DDB()),
                                           this.DDB()),
                                           this.VprB(),
                                           NATCUR,
                                           true);
          end;
        end;
      end;

      if (m_CrBD == NULL)
        m_CrBD = 0.0;
      end;
    else
      m_CrBD = 0.0;
    end;
    return m_CrBD;
  END;

  /*Номер сделки прямого РЕПО / Займа*/
  MACRO CodeDR():STRING
     if( TypeB() != "РО" )
        return m_RS.CodeDR;
     end;
  END;

  /*Дата поставки по 1 части прямого РЕПО / Займа*/
  MACRO DD1DR():DATE
     if( TypeB() != "РО" )
        return SQL_ConvTypeDate(m_RS.SaleDate);
     end;
  END;

  /*Дата размещения приобретения в данном прямом РЕПО / Займе*/
  MACRO DLink():DATE
     if( TypeB() != "РО" )
        return SQL_ConvTypeDate(m_RS.DLink);
     end;
  END;

  MACRO NKDallRub_17( Preferential:bool ):money
     var RetVal = $0.0, RetVal_VP = $0.0;
     var i = 0;
     while( i < m_TaxPeriods.m_Periods.Size )
        if( m_TaxPeriods.m_Periods[i].Preferential == Preferential )

           RetVal = RetVal + НКД(m_RS.t_FIID, 1, m_TaxPeriods.m_Periods[i].EndDate);

           // - (если D1 = <DDB>, то <NkdBvp>)
           if( m_TaxPeriods.m_Periods[i].BegDate == this.DDB() )
              RetVal_VP = RetVal_VP - this.NkdBvp();
           else
              RetVal = RetVal - НКД(m_RS.t_FIID, 1, m_TaxPeriods.m_Periods[i].BegDate);
           end;

           RetVal = RetVal + GetCouponSumByPeriod(m_RS.FIID, 1, m_TaxPeriods.m_Periods[i].BegDate+1, m_TaxPeriods.m_Periods[i].EndDate, NULL, NULL, NULL, NULL, true);

        end;
        i = i + 1;
     end;

     RetVal = RetVal * this.Qnty() + RetVal_VP;

     return RetVal;
  END;

  MACRO NKDallRub1()
    if (TypeB() == "РО")
      return 0;
    end;
    
    var RetVal;

    if( (m_RS.TaxGroup == 1) or (m_RS.TaxGroup == 2) or (m_RS.TaxGroup == 3) or (m_RS.TaxGroup == 4) or (m_RS.TaxGroup == 5) or (m_RS.TaxGroup == 6) or (m_RS.TaxGroup == 7) or
        (m_RS.TaxGroup == 8) or (m_RS.TaxGroup == 15) or (m_RS.TaxGroup == 21) or (m_RS.TaxGroup == 31) or (m_RS.TaxGroup == 101) )
       RetVal = F(GetNKDallRub());
    elif( (m_RS.TaxGroup == 9) or (m_RS.TaxGroup == 10) or (m_RS.TaxGroup == 18) or (m_RS.TaxGroup == 19) or (m_RS.TaxGroup == 29) or (m_RS.TaxGroup == 32) or
          (m_RS.TaxGroup == 33) or (m_RS.TaxGroup == 34) or (m_RS.TaxGroup == 43) or (m_RS.TaxGroup == 109) or (m_RS.TaxGroup == 130) )
       RetVal = $0.0;
    elif( m_RS.TaxGroup == 17 )
       RetVal = NKDallRub_17(true);
    else
       RetVal = $0.0;
    end;

    return RetVal;
  END;

  MACRO NKDallRub2()
    if (TypeB() == "РО")
      return 0;
    end;

    var RetVal;

    if( (m_RS.TaxGroup == 1) or (m_RS.TaxGroup == 2) or (m_RS.TaxGroup == 3) or (m_RS.TaxGroup == 4) or (m_RS.TaxGroup == 5) or (m_RS.TaxGroup == 6) or (m_RS.TaxGroup == 7) or
        (m_RS.TaxGroup == 8) or (m_RS.TaxGroup == 15) or (m_RS.TaxGroup == 21) or (m_RS.TaxGroup == 31) or (m_RS.TaxGroup == 101) )
       RetVal = $0.0;
    elif( (m_RS.TaxGroup == 9) or (m_RS.TaxGroup == 10) or (m_RS.TaxGroup == 18) or (m_RS.TaxGroup == 19) or (m_RS.TaxGroup == 29) or (m_RS.TaxGroup == 32) or
          (m_RS.TaxGroup == 33) or (m_RS.TaxGroup == 34) or (m_RS.TaxGroup == 43) or (m_RS.TaxGroup == 109) or (m_RS.TaxGroup == 130) )
       RetVal = F(GetNKDallRub());
    elif( m_RS.TaxGroup == 17 )
       RetVal = NKDallRub_17(false);
    else
       RetVal = $0.0;
    end;

    return RetVal;
  END;

  /*Формула!*/
  MACRO ControlNKD()
     return F(GetNKDallRub() + "-(" + GetNKDallRub1() + "+" + GetNKDallRub2() + ")");
  END;

  /*Формула!*/
  MACRO NKDallRub():STRING
    if (TypeB() == "РО")
      return 0;
    end;
    if(IsPercent())
       return F(GetNkdRepRub() + "+" + GetCoupRub() + "-" + GetNkdPrevRub() + "-" + GetNkdBrepRub());
    elif(IsDiscount())
       return F(GetNkdRepRub() + "-" + GetNkdPrevRub());
    end;

    return 0;
  END;

  /*Формула!*/
  MACRO SumBRub_Amort():STRING                                                                     
     return F(FormulaIF() + "(" + GetAmortRub() + ">0;(" + GetSumBRub() + "-" + GetDifB() + ")*" + GetKPNom() + "+" +GetComBRub_Amort()+ ";0)");
  END;

  /*Формула!*/
  MACRO SumBDif():STRING
     return F(FormulaIF() + "(" + GetAmortRub() + ">0;" + GetDifB() + "*" + GetKPNom() + ";0)");
  END;

  /*Доходы, выплаченные эмитентом при частичном погашении номинала, учитываемые в отчетном (налоговом периоде), в валюте номинала*/
  /*Формула!*/
  MACRO AmortVNaccPer():STRING
     return F(FormulaIF() + "(" + GetAmortVN_before() + ">0;0;" + FormulaIF() + "(" + GetAmortVN_after() + ">0;" + GetAmortVNPer() +";0))");
  END;

  /*Валюта цены приобретения*/
  MACRO VPrBNumber():STRING
     if( TypeB() != "РО" )
        return this.VPrBNumber();
     else
        return "";
     end;
  END;

  /*Коэф-т погашения номинала (за отчетный период)*/
  /*Формула!*/
  MACRO KPNom():STRING
     return F(FormulaIF() + "(" + GetAmortVNaccPer() + ">0;" + GetAmortVNaccPer() + "/" + GetNom_DDB() + "/" + GetQnty() + ";0)");
  END;

  /*Стоимость приобретения - в валюте цены*/
  MACRO SumBvp():MONEY
     if( TypeB() != "РО" )
       if( m_SumBvp == NULL )
         if( m_RS.BuyAmount != 0 )
           m_SumBvp = this.SumBmain()/m_RS.BuyAmount*this.Qnty();
         else
           m_SumBvp = $0.0;
         end;
       end;
     else
        m_SumBvp = $0.0;
     end;

     return m_SumBvp;
  END;

  MACRO Cr_Val_MrkBZ()
     var RetVal:money = $0.0;
     var ISO = IIF(StrIsNumber(Val_Market_New()), int(Val_Market_New()), Val_Market_New());
     if(  ISO != "" )
        if( ISO == "%" )
           RetVal = GetRateOnDateCrossDbl(this.DZB(), m_RS.FaceValueFI, NATCUR, true);
        else
           var fin = TRecHandler("fininstr.dbt");
           if( ПолучитьФинИнПоISO(ISO, fin) )
              RetVal = GetRateOnDateCrossDbl(this.DZB(), fin.rec.FIID, NATCUR, true);
           else
              MsgBox("Не найден финансовый инструмент по коду ISO: " + ISO);
           end;
        end;
     end;

     return RetVal;
  END;

  MACRO CrBZ()
     return GetRateOnDateCrossDbl(this.DZB(), this.VprB(), NATCUR, true);
  END;

  /*Курс ЦБ РФ валюты цены договора на дату поставки ценных бумаг*/
  MACRO CrVPr_DDB():DOUBLE
     if( m_CrVPr_DDB == NULL )
        m_CrVPr_DDB = GetRateOnDateCrossDbl( this.DDB(), this.VPrB(), NATCUR, true );
     end;

     if((m_CrVPr_DDB == NULL) or (m_CrVPr_DDB == 0.0))
       m_CrVPr_DDB = NULL;
       return 1.0;
     end;

     return m_CrVPr_DDB;
  END;

  MACRO DifB():money
    var RetVal:money = $0.0;

    /*если заполнено примечание*/
    if (IsFilledNoteByDeal(this.DealBuy().rec.DealID, 
                           27/*Отклонение от рыночной цены*/))
      if( this.QB() != 0 )
        var Note:double = readNoteForObject(OBJTYPE_SECDEAL, 
                                            UniID( this.DealBuy(),
                                            OBJTYPE_SECDEAL),
                                            27/*Отклонение от рыночной цены*/);
        RetVal = Note / this.QB() * this.Qnty();
      end;
    else
      if ((MarketPrice_New() == 0) or (StrUpr(Market_New()) == "ФАКТ")
         or (StrUpr(Market_New()) == "НЕКОНТРОЛИРУЕМАЯ СДЕЛКА")
         or (StrUpr(Market_New()) == "БИРЖЕВАЯ СДЕЛКА"))
        RetVal = $0.0;
      else
        var V19 = 0;
        var SumBrub:money = $0.0;
        var SumMrkt:money = $0.0;

        GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19,
                                 0);
        if (V19 == 1)
          SumBrub = (SumBvp() + NkdBvp()) * CrBD() - NkdBvp() * CrVPr_DDB();
        else 
          SumBrub = SumBvp() * CrBD();
        end;

        if (m_RS.FaceValueFI == NATCUR)
          SumMrkt = MarketPrice_New() * NomB() / 100.0 * Qnty();
          if ((SumBrub - SumMrkt) > 0)
            RetVal = SumBrub - SumMrkt;
          else
            RetVal = $0.0;
          end;
        else
          if (VPrB() == NATCUR)
            SumMrkt = MarketPrice_New() * NomB() / 100 *Qnty() * CrBZ();
            if ((SumBrub - SumMrkt) > 0)
              RetVal = SumBrub - SumMrkt;
            else
              RetVal = $0.0;
            end;
          else
            SumMrkt = MarketPrice_New() * NomB() / 100.0 * Qnty();
            if (V19 == 0)
              if ((SumBvp() - SumMrkt) > 0)
                RetVal = (SumBvp() - SumMrkt) * CrBD();
              else
                RetVal = $0.0;
              end;
            elif ((V19 == 1) and (CrSpezB() != 0.0))
              if ((SumBrub - SumMrkt * CrBZ()) > 0)
                RetVal =  max(SumBrub - SumMrkt * CrVPr_DDB(), 0);
              else
                RetVal = $0.0;
              end;
            elif ((V19 == 1) and (CrSpezB() == 0.0))
              if ((SumBvp() - SumMrkt) > 0)
                RetVal = (SumBvp() - SumMrkt) * CrVPr_DDB();
              else
                RetVal = $0.0;
              end;
            end;
          end;
        end;

      end;
    end;

    return RetVal;
  END;

  /*Стоимость приобретения (без НКД) - всего - в рублях*/
  /*Формула!*/
  MACRO SumBRub():STRING
    var V19 = 0;
    GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
    if ((V19 == 1) and (CrSpezB() != 0.0))
      return F("(" + GetSumBvp() + "+" + GetNkdBvp() + ") *" + GetCrBD()
               + "-" + GetNkdBvp() + "*" + CrVPr_DDB());
    end;
    return F(GetSumBvp() + "*" + GetCrBD());
  END;

  /*Стоимость приобретения, признанная расходами в отчетном (налоговом) периоде (до оценки "на рыночность"), в валюте сделки*/
  /*Формула!*/
  MACRO SumBvp_exps():STRING
     return F(GetSumBvp() + "*" + GetKPNom());
  END;

  /*Прибыль (+) / убыток (-) для целей налогообложения, руб. - всего (гр. Т9+гр. Т10)*/
  /*Формула!*/
  MACRO TaxeAll():STRING
     return F(GetTaxeAmort() + "+" + GetTaxeNKD());
  END;

  /*Прибыль (+) / убыток (-) для целей налогообложения, руб. - от частичного погашения номинала (гр.10-гр.11)*/
  /*Формула!*/
  MACRO TaxeAmort():STRING
     return F(GetAmortRub() + "-" + GetSumBRub_Amort());
  END;

  /*Прибыль (+) / убыток (-) для целей налогообложения, руб. - процентные доходы (гр.8)*/
  /*Формула!*/
  MACRO TaxeNKD():STRING
     return F(GetNKDallRub());
  END;

  /*Фин. Рез для выверки, руб. (гр.8+гр.10-гр.11+гр.12-гр.13)*/
  /*Формула!*/
  MACRO FinRes():STRING
     return F(GetNKDallRub() + "+" + GetAmortRub() + "-" + GetSumBRub_Amort() + "-" + GetSumBDif()+"-" +GetComBRub_Amort());
  END;

  /*получить адрес ячейки*/
  MACRO GetNomH01():STRING
     return (C_NomH01+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNomH02():STRING
     return (C_NomH02+string(m_CurrStrNum));
  END;

  MACRO Nom_H01()
    return GetFaceValue( m_RS.FIID, MAX(this.H0_7(),this.DDB()), true, false );
  END;
      
  MACRO Nom_H02()
    return GetFaceValue( m_RS.FIID, this.H0_2(), true, false );
  END;
      
  MACRO PlusNom_IN()
    return F(FormulaIF()+"("+GetNomH02()+">"+GetNomH01()+";("+GetNomH02()+"-"+GetNomH01()+")*"+GetQnty()+";"+"0)");
  END;
    
  MACRO MinusNom_IN() 
    return F(FormulaIF()+"("+GetNomH02()+"<"+GetNomH01()+";-("+GetNomH02()+"-"+GetNomH01()+")*"+GetQnty()+";"+"0)");
  END;

  MACRO Nom_IN_Before()
    if(this.DDB() < this.H0_1())
      return (GetFaceValue( m_RS.FIID, this.H0_1()-1, true, false ) - GetFaceValue( m_RS.FIID, this.DDB(), true, false )) * this.Qnty();
    end;

   return 0; 
  END;

  MACRO ComBRub_Amort():money
     if( m_ComBRub_Amort == null )
        m_ComBRub_Amort = $0;
        if( m_SCTXUseCommAsOutlay and (this.AmortRub() > 0) )
           var vKSumBvn = 0.0;
           if( (this.AmortVN_before() <= $0) and (this.AmortVN_after() > $0) and (this.AmortVNPer() > $0) )
              vKSumBvn = double(this.AmortVNPer()/this.NomB()/this.Qnty());
           end;
           m_ComBRub_Amort = vKSumBvn*(m_RS.CommBuy*this.Qnty()/this.QB());
        end;
     end;
     return m_ComBRub_Amort;
  END;

  MACRO DGO()
    return SQL_ConvTypeDate(m_RS.DGO);
  END;

  MACRO DDS():DATE // Дата перехода права собств-ти при реализации ЦБ
    if(m_RS.SaleDateCash != ZeroDate)
      return SQL_ConvTypeDate(m_RS.SaleDateCash);
    else
      return SQL_ConvTypeDate(m_RS.SaleDate);
    end;
  END;

  MACRO printNomB()
     return ВыводЧерезФормулу(this.NomB());
  END;

  /*По замечаниям ГПБ убрано наименование листа из формулы итогов*/
  MACRO GetFormulaSumm()
     GetFormulaSummREG();
  END; 

  initTX_RegistrReport( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    IncC_Rep_Form = SP_IncC_Reg_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      IncC_Rep_Form = WS_TX_IncC_Reg_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = IncC_Rep_Form.Run();
    end;

    if( stat )
      IncC_Rep_Report = SP_IncReg_Report( null, "Report_TXIncC.xlsx", true, IsWebService, ReportHashCode, POI_MODE, BIGREPORT_MODE );
      IncC_Rep_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat(IncC_Rep_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem);
        FullReportFileNames = IncC_Rep_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat(IncC_Rep_Report.PrintMode());
      end;
    end;
  end;

  return FullReportFileNames;
END;
