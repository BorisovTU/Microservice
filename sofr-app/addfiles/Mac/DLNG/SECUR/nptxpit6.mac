/*
$Name:        nptxpit6.mac
$Module:      Ценные бумаги
$Description: Форма 6-НДФЛ
*/

import DPInter, SfInter, "DLReport_h.mac", "nptxpit6_form.mac", "RepPersonalIncomeTax.mac", "nptxcalcfun.mac", "TaxReportBase.mac";

private class PersnData(p_Name1, p_Name2, p_Name3, p_Code, p_ContrNum, p_ClientINN, p_PassportNumber, p_PassportSeries, p_PassportData,
                             p_Authority, p_DateBirth, p_RegAddress, p_IsEmployee)
   var Name1 = p_Name1;
   var Name2 = p_Name2;
   var Name3 = p_Name3;
   var Code  = p_Code;
   var ContrNum = p_ContrNum;
   var ClientINN = p_ClientINN;
   var PassportNumber = p_PassportNumber;
   var PassportSeries = p_PassportSeries;
   var PassportData = p_PassportData;
   var Authority = p_Authority;
   var DateBirth = p_DateBirth;
   var RegAddress = p_RegAddress;
   var IsEmployee = p_IsEmployee;

   macro GetFullName()
      return Name1 + " " + Name2 + " " + Name3;
   end;
END;

private class (NPTXRepCalc_NPTXPIT6) NPTXRepCalc(_BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS, _RepDate)
  private var m_PrevClientID = UnknownParty;
  private var m_PersnDataArray = TArray();
  private var m_AmountEmployee = 0;
  private var m_PartyCounter = DL_ByIdxCounter();
  private var m_EmplCounter = DL_ByIdxCounter();

  macro RepDate()
    return m_RepDate2;
  end;

  macro Count()
    return Int(m_RS.Count);
  end;

  macro Amount()
    return m_Amount;
  end;

  macro GetPartyCounter()
    return m_PartyCounter;
  end;

  macro GetEmplCounter()
    return m_EmplCounter;
  end;

  macro TaxPaid()
    return m_TaxPaid;
  end;

  macro TaxDue()
    return m_TaxDue;
  end;

  macro TaxToReturnDue()
    return m_TaxToReturnDue;
  end;

  macro AmountEmployee()
     return m_AmountEmployee;
  end;

  macro PersnDataArray()
     return m_PersnDataArray;
  end;

  macro PassportNumber()
     var PNumber = "";
     PNumber = ClientPersnIdcMain().rec.PaperNumber;

     return PNumber;
  end;

  macro PassportSeries()
     var PSeries = "";
     PSeries = ClientPersnIdcMain().rec.PaperSeries;

     return PSeries;
  end;

  macro PassportData()
     var PDate = Date(0, 0, 0);
     PDate = Date(ClientPersnIdcMain().rec.PaperIssuedDate);

     return PDate;
  end;

  macro PassportAuthority()
     var PAuthority = "";
     PAuthority = ClientPersnIdcMain().rec.PaperIssuer;

     return PAuthority;
  end;

  macro ClearData()
    ClearData();
  end;

  private macro ДобавитьВсеПараметры(ContrNumbers:@String, RateIndexes:TArray)
    var sum = $0;
    var PlusSum = 0.0, MinusSum = 0.0, TaxCalculated = 0.0, TaxCalculatedDiv = 0.0, DivPlus = 0.0, DivPaySec_0 = 0.0, BaseSpecial_Div = 0.0;
    var TaxPaid = 0.0, TaxDue = 0.0, TaxOver = 0.0, TaxToReturnDue = 0.0;
    var PaidGeneral_15_1_0 = $0.0, TaxPaid15 = $0.0, TaxToReturnDue15 = $0.0, TaxDue15 = $0.0, TaxOver15 = $0.0;
    var NPTXCodeArr = TArray();
    var RateIndex = -1;
    var j = 0;

    if((m_InfoRate == INFORATE9_15)
    or (m_InfoRate == INFORATE9_NOTRES_DIV))
      if(ResidenceStatus() == 1)
        GetSum(ClientID(), "" + TXOBJ_PLUS9_1110 + ", " + TXOBJ_PLUS9_1110_IIS, m_BeginDate, m_EndDate, @PlusSum, NULL, "", @ContrNumbers);
        m_PlusSum = m_PlusSum + PlusSum;
        GetSum(ClientID(), "" + TXOBJ_MINUS9_218
                        + "," + TXOBJ_MINUS9_219
                        + "," + TXOBJ_MINUS9_233
                        + "," + TXOBJ_MINUS9_234, m_BeginDate, m_EndDate, @MinusSum, NULL, "", @ContrNumbers);
        m_MinusSum = m_MinusSum + MinusSum;
        GetSum(ClientID(), "" + TXOBJ_BASESPECIAL, m_BeginDate, m_EndDate, @sum, 0, "", @ContrNumbers);
        m_TaxCalculated = m_TaxCalculated + sum;
        GetSum(ClientID(), "" + TXOBJ_BASESPECIAL_IIS, m_BeginDate, m_EndDate, @sum, 1, "", @ContrNumbers);
        m_TaxCalculated = m_TaxCalculated + sum;
        m_TaxCalculated = m_TaxCalculated * Rate(m_InfoRate) / 100.0;
        TaxCalculated = sum * Rate(m_InfoRate) / 100.0;
        GetSum(ClientID(), "" + TXOBJ_PAIDSPECIAL_0, m_BeginDate, m_EndDate, @sum, 0, "", @ContrNumbers);
        m_TaxCalculated = m_TaxCalculated - sum;
        TaxCalculated = TaxCalculated - sum;
      else
        GetSum(ClientID(), "" + TXOBJ_PLUS15_1010, m_BeginDate, m_EndDate, @PlusSum, 0, "", @ContrNumbers);
        m_PlusSum = m_PlusSum + PlusSum;
        DivPlus = DivPlus + PlusSum;
        GetSum(ClientID(), "" + TXOBJ_MINUS15_601, m_BeginDate, m_EndDate, @MinusSum, 0, "", @ContrNumbers);
        m_MinusSum = m_MinusSum + MinusSum;
        GetSum(ClientID(), "" + TXOBJ_DIVPAY_SEC, m_BeginDate, m_EndDate, @TaxCalculated, 0, "", @ContrNumbers);
        m_TaxCalculated = m_TaxCalculated + TaxCalculated;
        TaxCalculatedDiv = TaxCalculated;
        GetSum(ClientID(), "" + TXOBJ_DIVPAY_SEC_0, m_BeginDate, m_EndDate, @sum, 0, "", @ContrNumbers);
        m_TaxCalculated = m_TaxCalculated - sum;
        TaxCalculated = TaxCalculated - sum;
        TaxCalculatedDiv = TaxCalculatedDiv - sum;
      end;
      RateIndex = AddInArrCodeParms(m_ArrCodeParms, NULL, NULL, PlusSum, NULL, MinusSum, 0.0, TaxCalculated, 0.0, 0.0, 0.0, Rate(m_InfoRate), 0.0, DivPlus, TaxCalculatedDiv);
      AddRateIndex(@RateIndexes, RateIndex);
    elif(m_InfoRate == INFORATE_35)
      if(ResidenceStatus() == 1)
        GetSum(ClientID(), "" + TXOBJ_PLUS35_3023, m_BeginDate, m_EndDate, @PlusSum, 0, "", @ContrNumbers);
        m_PlusSum = m_PlusSum + PlusSum;
      end;
      GetSum(ClientID(), "" + TXOBJ_PAID_35, m_BeginDate, m_EndDate, @TaxCalculated, 0, "", @ContrNumbers);
      m_TaxCalculated = m_TaxCalculated + TaxCalculated;
      GetSum(ClientID(), "" + TXOBJ_PAID35_0, m_BeginDate, m_EndDate, @sum, 0, "", @ContrNumbers);
      m_TaxCalculated = m_TaxCalculated - sum;
      TaxCalculated = TaxCalculated - sum;
      RateIndex = AddInArrCodeParms(m_ArrCodeParms, NULL, NULL, PlusSum, NULL, 0.0, 0.0, TaxCalculated, 0.0, 0.0, 0.0, Rate(m_InfoRate), 0.0, 0.0, 0.0);
      AddRateIndex(@RateIndexes, RateIndex);
    elif(m_InfoRate == INFORATE_TOTAL)
      var CurRate = Rate(m_InfoRate);

      if(ResidenceStatus() != 1)
         GetSum(ClientID(), "" + TXOBJ_PLUSG_1530
                      + "," + TXOBJ_PLUSG_1531
                      + "," + TXOBJ_PLUSG_1536
                      + "," + TXOBJ_PLUSG_1532
                      + "," + TXOBJ_PLUSG_1533
                      + "," + TXOBJ_PLUSG_1535
                      + "," + TXOBJ_PLUSG_1537
                      + "," + TXOBJ_PLUSG_1539
                      + "," + TXOBJ_PLUSG_2640
                      + "," + TXOBJ_PLUSG_2641
                         + "," + TXOBJ_PLUSG_2800
                         + "," + TXOBJ_BASEG1_13, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
      m_PlusSum = m_PlusSum + sum;
      PlusSum = PlusSum + sum;
 
      GetSum(ClientID(), "" + TXOBJ_PLUSG_1011_IIS
                      + "," + TXOBJ_PLUSG_1544
                      + "," + TXOBJ_PLUSG_1545
                      + "," + TXOBJ_PLUSG_1549
                      + "," + TXOBJ_PLUSG_1546
                      + "," + TXOBJ_PLUSG_1547
                      + "," + TXOBJ_PLUSG_1548
                      + "," + TXOBJ_PLUSG_1551
                      + "," + TXOBJ_PLUSG_1553
                      + "," + TXOBJ_PLUSG_2640_IIS
                         + "," + TXOBJ_PLUSG_2641_IIS, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
      m_PlusSum = m_PlusSum + sum;
      PlusSum = PlusSum + sum;
 
      if(not IsDepoClient())
           GetSum(ClientID(), "" + TXOBJ_PLUSG_1010, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
        m_PlusSum = m_PlusSum + sum;
        PlusSum = PlusSum + sum;
      end;
 
         GetSum(ClientID(), "" + TXOBJ_BASEGENERAL
                         + "," + TXOBJ_BASEMATERIAL
                         + "," + TXOBJ_BASEBILL, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
         m_TaxCalculated = m_TaxCalculated + sum * CurRate / 100.0;
         TaxCalculated = TaxCalculated + sum * CurRate / 100.0;
         GetSum(ClientID(), "" + TXOBJ_BASEGENERAL_IIS
                         + "," + TXOBJ_BASEMATERIAL_IIS, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
         TaxCalculated = TaxCalcuLated + sum * CurRate / 100.0;
         m_TaxCalculated = m_TaxCalculated + sum * CurRate / 100.0;
 
         GetSum(ClientID(), "" + TXOBJ_PAIDGENERAL_0, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
         m_TaxCalculated = m_TaxCalculated - sum;
         TaxCalculated = TaxCalculated - sum;
 
      GetSum(ClientID(), "" + TXOBJ_MINUSG_201
                      + "," + TXOBJ_MINUSG_202
                      + "," + TXOBJ_MINUSG_203
                      + "," + TXOBJ_MINUSG_206
                      + "," + TXOBJ_MINUSG_207
                      + "," + TXOBJ_MINUSG_205
                      + "," + TXOBJ_MINUSG_208
                      + "," + TXOBJ_MINUSG_209
                      + "," + TXOBJ_MINUSG_210
                      + "," + TXOBJ_MINUSG_211
                      + "," + TXOBJ_MINUSG_222
                      + "," + TXOBJ_MINUSG_213
                      + "," + TXOBJ_MINUSG_214
                      + "," + TXOBJ_MINUSG_220
                      + "," + TXOBJ_MINUSG_223
                      + "," + TXOBJ_MINUSG_224
                      + "," + TXOBJ_MINUSG_218
                      + "," + TXOBJ_MINUSG_219
                      + "," + TXOBJ_MINUSG_218_1
                      + "," + TXOBJ_MINUSG_219_1
                         + "," + TXOBJ_MINUSG_225
                      + "," + TXOBJ_MINUSG_226
                      + "," + TXOBJ_MINUSG_227
                      + "," + TXOBJ_MINUSG_228
                      + "," + TXOBJ_MINUSG_229
                      + "," + TXOBJ_MINUSG_250
                      + "," + TXOBJ_MINUSG_251
                      + "," + TXOBJ_MINUSG_252
                      + "," + TXOBJ_MINUSG_241
                      + "," + TXOBJ_MINUSG_230
                      + "," + TXOBJ_MINUSG_239
                      + "," + TXOBJ_MINUSG_231
                      + "," + TXOBJ_MINUSG_214_IIS
                      + "," + TXOBJ_MINUSG_235
                      + "," + TXOBJ_MINUSG_240
                      + "," + TXOBJ_MINUSG_236
                      + "," + TXOBJ_MINUSG_233
                      + "," + TXOBJ_MINUSG_234
                         + "," + TXOBJ_MINUSG_618
                         + "," + TXOBJ_MINUSG_619, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
      MinusSum = MinusSum + sum;
 
         GetSum(ClientID(), "" + TXOBJ_PAIDMATERIAL
                         + "," + TXOBJ_PAIDGENERAL
                         + "," + TXOBJ_PAIDSPECIAL
                         + "," + TXOBJ_PAIDMATERIAL_IIS
                         + "," + TXOBJ_PAIDGENERAL_IIS
                         + "," + TXOBJ_PAIDSPECIAL_IIS
                         + "," + TXOBJ_PAIDBILL, m_BeginDate, m_EndDate, @sum, NULL, " Obj.t_Sum > 0 ", @ContrNumbers);
         TaxPaid = TaxPaid + sum;
 
         GetSum(ClientID(), "" + TXOBJ_PAIDMATERIAL
                         + "," + TXOBJ_PAIDGENERAL
                         + "," + TXOBJ_PAIDSPECIAL
                         + "," + TXOBJ_PAIDMATERIAL_IIS
                         + "," + TXOBJ_PAIDGENERAL_IIS
                         + "," + TXOBJ_PAIDSPECIAL_IIS, m_BeginDate, m_EndDate, @sum, NULL, " Obj.t_Sum < 0 ", @ContrNumbers);
         TaxToReturnDue = TaxToReturnDue - sum;
      else
         var Plus = 0;
         var Minus = 0;
         var Доход15 = 0;
 
         //Расчитываем Доход_i и Расход_i с i = 2
         GetSum(ClientID(), "" + TXOBJ_PLUSG_1011
                         + "," + TXOBJ_PLUSG_1530
                         + "," + TXOBJ_PLUSG_1531
                         + "," + TXOBJ_PLUSG_1536
                         + "," + TXOBJ_PLUSG_1532
                         + "," + TXOBJ_PLUSG_1533
                         + "," + TXOBJ_PLUSG_1535
                         + "," + TXOBJ_PLUSG_2640
                         + "," + TXOBJ_PLUSG_2641
                         + "," + TXOBJ_BASEG1_13, m_BeginDate, m_EndDate, @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr);
 
         GetSum(ClientID(), "" + TXOBJ_MINUSG_201
                         + "," + TXOBJ_MINUSG_202
                         + "," + TXOBJ_MINUSG_203
                         + "," + TXOBJ_MINUSG_206
                         + "," + TXOBJ_MINUSG_207
                         + "," + TXOBJ_MINUSG_222
                         + "," + TXOBJ_MINUSG_223
                         + "," + TXOBJ_MINUSG_205
                         + "," + TXOBJ_MINUSG_208
                         + "," + TXOBJ_MINUSG_209
                         + "," + TXOBJ_MINUSG_210
                         + "," + TXOBJ_MINUSG_224
                         + "," + TXOBJ_MINUSG_220, m_BeginDate, m_EndDate, @Minus, NULL, "", @ContrNumbers, @NPTXCodeArr);
         Доход15 = Plus - Minus - Max15;
         Доход15 = IIF(Доход15 > 0, Доход15, 0);
         sum = Plus - Доход15;
         
         m_PlusSum = m_PlusSum + sum;
         PlusSum = PlusSum + sum;
         m_MinusSum = m_MinusSum + Minus;
         MinusSum = MinusSum + Minus;
 
         //Расчитываем Доход_i и Расход_i с i = 3
         GetSum(ClientID(), "" + TXOBJ_PLUSG_1537
                         + "," + TXOBJ_PLUSG_1539, m_BeginDate, m_EndDate, @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr);
 
         GetSum(ClientID(), "" + TXOBJ_MINUSG_211
                         + "," + TXOBJ_MINUSG_213
                         + "," + TXOBJ_MINUSG_218
                         + "," + TXOBJ_MINUSG_219
                         + "," + TXOBJ_MINUSG_214, m_BeginDate, m_EndDate, @Minus, NULL, "", @ContrNumbers, @NPTXCodeArr);
         Доход15 = Plus - Minus - Max15;
         Доход15 = IIF(Доход15 > 0, Доход15, 0);
         sum = Plus - Доход15;
         
         m_PlusSum = m_PlusSum + sum;
         PlusSum = PlusSum + sum;
         m_MinusSum = m_MinusSum + Minus;
         MinusSum = MinusSum + Minus;
 
         //Расчитываем Доход_i и Расход_i с i = 5
         GetSum(ClientID(), "" + TXOBJ_PLUSG_1011_IIS
                         + "," + TXOBJ_PLUSG_1544
                         + "," + TXOBJ_PLUSG_1545
                         + "," + TXOBJ_PLUSG_1546
                         + "," + TXOBJ_PLUSG_1547
                         + "," + TXOBJ_PLUSG_1548
                         + "," + TXOBJ_PLUSG_1549
                         + "," + TXOBJ_PLUSG_1551
                         + "," + TXOBJ_PLUSG_1553
                         + "," + TXOBJ_PLUSG_2640_IIS
                         + "," + TXOBJ_PLUSG_2641_IIS, m_BeginDate, m_EndDate, @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr);
 
         GetSum(ClientID(), "" + TXOBJ_MINUSG_225
                         + "," + TXOBJ_MINUSG_226
                         + "," + TXOBJ_MINUSG_227
                         + "," + TXOBJ_MINUSG_228
                         + "," + TXOBJ_MINUSG_229
                         + "," + TXOBJ_MINUSG_230
                         + "," + TXOBJ_MINUSG_239
                         + "," + TXOBJ_MINUSG_240
                         + "," + TXOBJ_MINUSG_231
                         + "," + TXOBJ_MINUSG_233
                         + "," + TXOBJ_MINUSG_234
                         + "," + TXOBJ_MINUSG_214_IIS
                         + "," + TXOBJ_MINUSG_250
                         + "," + TXOBJ_MINUSG_251
                         + "," + TXOBJ_MINUSG_252
                         + "," + TXOBJ_MINUSG_241
                         + "," + TXOBJ_MINUSG_236
                         + "," + TXOBJ_MINUSG_235, m_BeginDate, m_EndDate, @Minus, NULL, "", @ContrNumbers, @NPTXCodeArr);
         Доход15 = Plus - Minus - Max15;
         Доход15 = IIF(Доход15 > 0, Доход15, 0);
         sum = Plus - Доход15;
         
         m_PlusSum = m_PlusSum + sum;
         PlusSum = PlusSum + sum;
         m_MinusSum = m_MinusSum + Minus;
         MinusSum = MinusSum + Minus;
 
         GetSum(ClientID(), "" + TXOBJ_PLUSG_2800, m_BeginDate, m_EndDate, @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr);
         GetSum(ClientID(), "" + TXOBJ_MINUSG_618, m_BeginDate, m_EndDate, @Minus, NULL, "", @ContrNumbers, @NPTXCodeArr);
         Доход15 = Plus - Minus - Max15;
         Доход15 = IIF(Доход15 > 0, Доход15, 0);
         sum = Plus - Доход15;
         
         m_PlusSum = m_PlusSum + sum;
         PlusSum = PlusSum + sum;
         m_MinusSum = m_MinusSum + Minus;
         MinusSum = MinusSum + Minus;
 
         GetSum(ClientID(), "" + TXOBJ_BASEG1_13, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
         m_PlusSum = m_PlusSum + sum;
         PlusSum = PlusSum + sum;
         DivPlus = DivPlus + sum;
 
         m_TaxCalculated = m_TaxCalculated + CurRate / 100 * (PlusSum - MinusSum);
         TaxCalculated = TaxCalculated + CurRate / 100 * (PlusSum - MinusSum);
 
         GetSum(ClientID(), "" + TXOBJ_DIVPAY_SEC_0, m_BeginDate, m_EndDate, @DivPaySec_0, NULL, "");
         GetSum(ClientID(), "" + TXOBJ_PAIDGENERAL_0, m_BeginDate, m_EndDate, @PaidGeneral_0, NULL, "");
         m_TaxCalculated = m_TaxCalculated - DivPaySec_0 - PaidGeneral_0;
         TaxCalculated = TaxCalculated - DivPaySec_0 - PaidGeneral_0;
 
         GetSum(ClientID(), "" + TXOBJ_BASESPECIAL_DIV, m_BeginDate, m_EndDate, @BaseSpecial_Div, NULL, "");
         TaxCalculatedDiv = TaxCalculatedDiv + CurRate / 100 * BaseSpecial_Div - DivPaySec_0;
 
         GetSum(ClientID(), "" + TXOBJ_PAIDMATERIAL
                         + "," + TXOBJ_PAIDGENERAL
                         + "," + TXOBJ_PAIDMATERIAL_IIS
                         + "," + TXOBJ_PAIDGENERAL_IIS
                         + "," + TXOBJ_DIVPAY_SEC
                         + "," + TXOBJ_PAIDBILL, m_BeginDate, m_EndDate, @sum, NULL, " Obj.t_Sum > 0 ");
         TaxPaid = TaxPaid + sum;
 
         GetSum(ClientID(), "" + TXOBJ_PAIDMATERIAL
                         + "," + TXOBJ_PAIDGENERAL
                         + "," + TXOBJ_PAIDMATERIAL_IIS
                         + "," + TXOBJ_PAIDGENERAL_IIS
                         + "," + TXOBJ_DIVPAY_SEC, m_BeginDate, m_EndDate, @sum, NULL, " Obj.t_Sum < 0 ");
         TaxToReturnDue = TaxToReturnDue - sum;
      end;
 
      TaxDue = TaxCalculated - TaxPaid + TaxToReturnDue;
 
      if(TaxDue >= 0)
        TaxOver = 0;
      else
        TaxOver = -TaxDue;
        TaxDue = 0;
      end;

      var i = 0;
      while(i < NPTXCodeArr.Size())
         RateIndex = AddInArrCodeParms(m_ArrCodeParms, NPTXCodeArr[i].Month, NPTXCodeArr[i].PSCode, NPTXCodeArr[i].PSnnn, NULL,
                                       0.0, 0.0, 0.0, 0.0, 0.0, 0.0, CurRate, 0.0, 0.0, 0.0, 0.0, false);

         if(RateIndex >= 0)
            var index = m_ArrCodeParms[RateIndex].IndexOfCode(NPTXCodeArr[i].Month, NPTXCodeArr[i].PSCode);
            if(index >= 0)
               j = 0;
               while(j < NPTXCodeArr[i].MinusCodes.Size)
                  m_ArrCodeParms[RateIndex].NPTXCodeParmArr[index].MinusCodes[m_ArrCodeParms[RateIndex].NPTXCodeParmArr[index].MinusCodes.Size] = NPTXMinusCodeParm(NPTXCodeArr[i].MinusCodes[j].MSCode, NPTXCodeArr[i].MinusCodes[j].MSnnn);
                  j = j + 1;
               end;
            end;
         end;
         i = i + 1;
      end;
      if(RateIndex >= 0)
         m_ArrCodeParms[RateIndex].TaxCalculated = TaxCalculated;
         m_ArrCodeParms[RateIndex].TaxPaid = TaxPaid;
         m_ArrCodeParms[RateIndex].TaxToReturnDue = TaxToReturnDue;
         m_ArrCodeParms[RateIndex].TaxDue = TaxDue;
         m_ArrCodeParms[RateIndex].DivPlus = DivPlus;
         m_ArrCodeParms[RateIndex].TaxCalculatedDiv = TaxCalculatedDiv;
         m_ArrCodeParms[RateIndex].TaxOver = TaxOver;
      end;
      AddRateIndex(@RateIndexes, RateIndex);
    elif(m_InfoRate == INFORATE_HIGHRATE_15)
      if(ResidenceStatus() == 1)
         var QueryHighRate = "select (" +
                             "          case " +
                             "          when q.t_Income_2 - q.t_Out_2 - " + string(Max15) + " > 0 " +
                             "             then q.t_Income_2 - q.t_Out_2 - " + string(Max15) +
                             "          else 0" +
                             "          end" +
                             "       ) as t_Income15_2, " +
                             "       ( " +
                             "          case " +
                             "          when q.t_Income_3 - q.t_Out_3 - " + string(Max15) + " > 0 " +
                             "             then q.t_Income_3 - q.t_Out_3 - " + string(Max15) +
                             "          else 0" +
                             "          end " +
                             "       ) as t_Income15_3, " +
                             "       (" +
                             "          case " +
                             "          when q.t_Income_5 - q.t_Out_5 - " + string(Max15) + " > 0 " +
                             "             then q.t_Income_5 - q.t_Out_5 - " + string(Max15) +
                             "          else 0" +
                             "          end " +
                             "       ) as t_Income15_5, " +
                             "       (" +
                             "          case " +
                             "          when q.t_Income_9 - q.t_Out_9 - " + string(Max15) + " > 0 " +
                             "             then q.t_Income_9 - q.t_Out_9 - " + string(Max15) +
                             "          else 0" +
                             "          end " +
                             "       ) as t_Income15_9, " +
                             "       q.t_DivPlus, " +
                             "       q.t_BaseSpecial_Div_15, " +
                             "       q.t_PaidGeneral_15_1_0, " +
                             "       q.t_TaxPaid, " +
                             "       q.t_TaxToReturnDue " +
                             "from (" +
                             "        select (" +
                             "                  select nvl(sum(IncomeObj_2.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt IncomeObj_2" +
                             "                  where IncomeObj_2.t_Client = " + string(ClientID()) +
                             "                    and IncomeObj_2.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and IncomeObj_2.t_Kind in (" +
                                                                               // Доход_2
                                                                               string(TXOBJ_PLUSG_1011) + ", " +
                                                                               string(TXOBJ_PLUSG_1530) + ", " +
                                                                               string(TXOBJ_PLUSG_1531) + ", " +
                                                                               string(TXOBJ_PLUSG_1532) + ", " +
                                                                               string(TXOBJ_PLUSG_1533) + ", " +
                                                                               string(TXOBJ_PLUSG_1535) + ", " +
                                                                               string(TXOBJ_PLUSG_1536) + ", " +
                                                                               string(TXOBJ_PLUSG_2640) + ", " +
                                                                               string(TXOBJ_PLUSG_2641) +
                                                                           ")" +
                             "               ) as t_Income_2," +
                             "               (" +
                             "                  select nvl(sum(IncomeObj_3.t_Sum0), 0) " +
                             "                  from dnptxobj_dbt IncomeObj_3 " +
                             "                  where IncomeObj_3.t_Client = " + string(ClientID()) +
                             "                    and IncomeObj_3.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and IncomeObj_3.t_kind in (" +
                                                                               //Доход_3
                                                                               string(TXOBJ_PLUSG_1537) + ", " +
                                                                               string(TXOBJ_PLUSG_1539) +
                                                                           ")" +
                             "               ) as t_Income_3," +
                             "               (" +
                             "                  select nvl(sum(IncomeObj_5.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt IncomeObj_5 " +
                             "                  where IncomeObj_5.t_Client = " + string(ClientID()) +
                             "                    and IncomeObj_5.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and IncomeObj_5.t_Kind in (" +
                                                                               //Доход_5
                                                                               string(TXOBJ_PLUSG_1011_IIS) + ", " +
                                                                               string(TXOBJ_PLUSG_1544) + ", " +
                                                                               string(TXOBJ_PLUSG_1545) + ", " +
                                                                               string(TXOBJ_PLUSG_1546) + ", " +
                                                                               string(TXOBJ_PLUSG_1547) + ", " +
                                                                               string(TXOBJ_PLUSG_1548) + ", " +
                                                                               string(TXOBJ_PLUSG_1549) + ", " +
                                                                               string(TXOBJ_PLUSG_1551) + ", " +
                                                                               string(TXOBJ_PLUSG_1553) + ", " +
                                                                               string(TXOBJ_PLUSG_2640_IIS) + ", " +
                                                                               string(TXOBJ_PLUSG_2641_IIS) +
                                                                           ")" +
                             "               ) as t_Income_5," +
                             "               (" +
                             "                  select nvl(sum(IncomeObj_9.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt IncomeObj_9" +
                             "                  where IncomeObj_9.t_Client = " + string(ClientID()) +
                             "                    and IncomeObj_9.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and IncomeObj_9.t_Kind in (" +
                                                                               //Доход_9
                                                                               string(TXOBJ_PLUSG_2800) +
                                                                           ")" +
                             "               ) as t_Income_9," +
                             "               (" +
                             "                  select nvl(sum(OutObj_2.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt OutObj_2" +
                             "                  where OutObj_2.t_Client = " + string(ClientID()) +
                             "                    and OutObj_2.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and OutObj_2.t_Kind in (" +
                                                                            //Расход_2
                                                                            string(TXOBJ_MINUSG_201) + ", " +
                                                                            string(TXOBJ_MINUSG_202) + ", " +
                                                                            string(TXOBJ_MINUSG_203) + ", " +
                                                                            string(TXOBJ_MINUSG_206) + ", " +
                                                                            string(TXOBJ_MINUSG_207) + ", " +
                                                                            string(TXOBJ_MINUSG_222) + ", " +
                                                                            string(TXOBJ_MINUSG_223) + ", " +
                                                                            string(TXOBJ_MINUSG_205) + ", " +
                                                                            string(TXOBJ_MINUSG_208) + ", " +
                                                                            string(TXOBJ_MINUSG_209) + ", " +
                                                                            string(TXOBJ_MINUSG_210) + ", " +
                                                                            string(TXOBJ_MINUSG_224) + ", " +
                                                                            string(TXOBJ_MINUSG_220) +
                                                                        ")" +
                             "               ) as t_Out_2," +
                             "               (" +
                             "                  select nvl(sum(OutObj_3.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt OutObj_3" +
                             "                  where OutObj_3.t_Client = " + string(ClientID()) +
                             "                    and OutObj_3.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and OutObj_3.t_Kind in (" +
                                                                            //Расход_3
                                                                            string(TXOBJ_MINUSG_211) + ", " +
                                                                            string(TXOBJ_MINUSG_213) + ", " +
                                                                            string(TXOBJ_MINUSG_218) + ", " +
                                                                            string(TXOBJ_MINUSG_219) + ", " +
                                                                            string(TXOBJ_MINUSG_214) +
                                                                        ")" +
                             "               ) as t_Out_3,"
                             "               (" +
                             "                  select nvl(sum(OutObj_5.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt OutObj_5" +
                             "                  where OutObj_5.t_Client = " + string(ClientID()) +
                             "                    and OutObj_5.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and OutObj_5.t_Kind in (" +
                                                                            //Расход_5
                                                                            string(TXOBJ_MINUSG_225) + ", " +
                                                                            string(TXOBJ_MINUSG_226) + ", " +
                                                                            string(TXOBJ_MINUSG_227) + ", " +
                                                                            string(TXOBJ_MINUSG_228) + ", " +
                                                                            string(TXOBJ_MINUSG_229) + ", " +
                                                                            string(TXOBJ_MINUSG_230) + ", " +
                                                                            string(TXOBJ_MINUSG_239) + ", " +
                                                                            string(TXOBJ_MINUSG_240) + ", " +
                                                                            string(TXOBJ_MINUSG_231) + ", " +
                                                                            string(TXOBJ_MINUSG_233) + ", " +
                                                                            string(TXOBJ_MINUSG_234) + ", " +
                                                                            string(TXOBJ_MINUSG_214_IIS) + ", " +
                                                                            string(TXOBJ_MINUSG_250) + ", " +
                                                                            string(TXOBJ_MINUSG_251) + ", " +
                                                                            string(TXOBJ_MINUSG_252) + ", " +
                                                                            string(TXOBJ_MINUSG_241) + ", " +
                                                                            string(TXOBJ_MINUSG_236) + ", " +
                                                                            string(TXOBJ_MINUSG_235) +
                                                                        ")" +
                             "               ) as t_Out_5," +
                             "               (" +
                             "                  select nvl(sum(OutObj_9.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt OutObj_9" +
                             "                  where OutObj_9.t_Client = " + string(ClientID()) +
                             "                    and OutObj_9.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and OutObj_9.t_Kind in (" +
                                                                            //Расход_9
                                                                            string(TXOBJ_MINUSG_618) +
                                                                        ")" +
                             "               ) as t_Out_9, " +
                             "               (" +
                             "                  select nvl(sum(DivPlusObj.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt DivPlusObj" +
                             "                  where DivPlusObj.t_Kind = " + string(TXOBJ_BASEG1_15) +
                             "                    and DivPlusObj.t_Client = " + string(ClientID()) +
                             "                    and DivPlusObj.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "               ) as t_DivPlus, " +
                             "               (" +
                             "                  select nvl(sum(BaseSpecialDiv15Obj.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt BaseSpecialDiv15Obj" +
                             "                  where BaseSpecialDiv15Obj.t_Client = " + string(ClientID()) +
                             "                    and BaseSpecialDiv15Obj.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and BaseSpecialDiv15Obj.t_Kind = " + string(TXOBJ_BASESPECIAL_DIV_15) +
                             "               ) as t_BaseSpecial_Div_15, " +
                             "               (" +
                             "                  select nvl(sum(PaidGeneral_15_1_0_Obj.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt PaidGeneral_15_1_0_Obj" +
                             "                  where PaidGeneral_15_1_0_Obj.t_Client = " + string(ClientID) +
                             "                    and PaidGeneral_15_1_0_Obj.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and PaidGeneral_15_1_0_Obj.t_Kind = " + string(TXOBJ_PAIDGENERAL_15_1_0) +
                             "               ) as t_PaidGeneral_15_1_0, " +
                             "               (" +
                             "                  select nvl(sum(TaxPaidObj.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt TaxPaidObj" +
                             "                  where TaxPaidObj.t_Client = " + string(ClientID()) +
                             "                    and TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and TaxPaidObj.t_Kind in (" +
                                                                              string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                              string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                              string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                              string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                          ")" +
                             "                    and TaxPaidObj.t_Sum > 0" +
                             "               ) as t_TaxPaid, " +
                             "               (" +
                             "                  select nvl(sum(-TaxToReturnDueObj.t_Sum0), 0)" +
                             "                  from dnptxobj_dbt TaxToReturnDueObj" +
                             "                  where TaxToReturnDueObj.t_Client = " + string(ClientID()) +
                             "                    and TaxToReturnDueObj.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                             "                    and TaxToReturnDueObj.t_Kind in (" +
                                                                                     string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                                     string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                                     string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                                     string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                                 ")" +
                             "                    and TaxToReturnDueObj.t_Sum < 0" +
                             "               ) as t_TaxToReturnDue" +
                             "        from dual" +
                             "     ) q";
 
         var CmdHighRate = DL_RSDCommand(QueryHighRate);
         var DSHighRate = CmdHighRate.Execute();
         if(DSHighRate.MoveNext())
            PlusSum = DSHighRate.Income15_2 + DSHighRate.Income15_3 + DSHighRate.Income15_5 + DSHighRate.Income15_9 + DSHighRate.DivPlus;
            DivPlus = DSHighRate.DivPlus;
            MinusSum = DSHighRate.DivPlus - DSHighRate.BaseSpecial_Div_15;
            TaxCalculated = 0.15 * (PlusSum - MinusSum) - DSHighRate.t_PaidGeneral_15_1_0;
            TaxCalculatedDiv = 0.15 * DSHighRate.BaseSpecial_Div_15 - DSHighRate.PaidGeneral_15_1_0;
            TaxPaid = DSHighRate.TaxPaid;
            TaxToReturnDue = DSHighRate.TaxToReturnDue;
            TaxDue = TaxCalculated - TaxPaid + TaxToReturnDue;
            if(TaxDue >= 0)
               TaxOver = 0;
            else
               TaxOver = -TaxDue;
               TaxDue = 0;
            end;
 
            var HighRateIndex = AddInArrCodeParms(m_ArrCodeParms, NULL, NULL, PlusSum, NULL, MinusSum, 0.0, TaxCalculated, TaxPaid,
                                                  TaxToReturnDue, TaxDue, 15, 0.0, DivPlus, TaxCalculatedDiv, TaxOver, true);
            AddRateIndex(@RateIndexes, HighRateIndex);
         end;
      end;
    elif(m_InfoRate == 0)
      if(IsDepoClient() and (OTHER_CONTRACTS == SET_CHAR))
        //Для выплат дивидендов и купонов в Депозитарии ставка налога указывается в каждой операции своя, поэтому нужно брать не фиксированные ставки,
        //а смотреть ставки в каждой операции, но это только в том случае, когда клиент является депоклиентом.
        var DepoClntQuery = "select nvl(sum(q.t_PlusSum), 0) as t_PlusSum," +
                            "       nvl(sum(q.t_MinusSum), 0) as t_MinusSum," +
                            "       nvl(sum(q.t_DivPlus), 0) as t_DivPlus," +
                            "       nvl(sum(q.t_TaxCalculated), 0) as t_TaxCalculated," +
                            "       nvl(sum(q.t_TaxCalculatedDiv), 0) as t_TaxCalculatedDiv," +
                            "       q.t_Rate," +
                            "       q.t_Month" +
                            " from" +
                            "    (" +
                            "       select nvl(PlusObj.t_Sum0, 0) as t_PlusSum," +
                            "              nvl(MinusObj.t_Sum0, 0) as t_MinusSum," +
                            "              nvl(TaxPaidObj.t_Sum0, 0) as t_TaxPaid," +
                            "              nvl(DivPlusObj.t_Sum0, 0) as t_DivPlus," +
                            "              nvl(BaseObj.t_Sum0, 0) * dppmacc.t_TaxRate / 100 + nvl(TaxPaidObj.t_Sum0, 0) as t_TaxCalculated," +
                            "              nvl(TaxCalculatedDivObj.t_Sum0, 0) as t_TaxCalculatedDiv," +
                            "              dppmacc.t_TaxRate / 100 as t_Rate," +
                            "              EXTRACT(MONTH FROM dpcorpop.t_Date) as t_Month" +
                            "        from dnptxobj_dbt PlusObj," +
                            "             ddpcorpop_dbt dpcorpop," +
                            "             dparty_dbt party," +
                            "             dnptxobj_dbt MinusObj," +
                            "             ddppmacc_dbt dppmacc," +
                            "             dnptxobj_dbt TaxPaidObj," +
                            "             dnptxobj_dbt DivPlusObj," +
                            "             dnptxobj_dbt BaseObj," +
                            "             dnptxobj_dbt TaxCalculatedDivObj"
                            "        where PlusObj.t_Client(+) = ?" +
                            "          and PlusObj.t_Kind(+) in(" + string(TXOBJ_PLUSG_1010) + ", " +
                                                                    string(TXOBJ_PLUS15_1010) + ", " +
                                                                    string(TXOBJ_PLUSG_1110) + ", " +
                                                                    string(TXOBJ_PLUSG_1011) + ", " +
                                                                    string(TXOBJ_PLUS9_1110) + ", " +
                                                                    string(TXOBJ_PLUS35_3023) +
                                                              ")" +
                            "          and PlusObj.t_Date(+) between ? and ?" +
                            "          and PlusObj.t_AnaliticKind1(+) in(" +
                                                                           string(TXOBJ_KIND1095) + ", " +
                                                                           string(TXOBJ_KIND1098) +
                                                                       ")" +
                            "          and dpcorpop.t_DocumentID = PlusObj.t_Analitic1" +
                            "          and dppmacc.t_DocumentID = dpcorpop.t_DocumentID" +
                            "          and dppmacc.t_HolderID = party.t_PartyID"
                            "          and party.t_PartyID = ?" +
                            "          and MinusObj.t_Client(+) = party.t_PartyID" +
                            "          and MinusObj.t_Date(+) between ? and ?" +
                            "          and MinusObj.t_Kind(+) = " + string(TXOBJ_MINUSG_601) +
                            "          and MinusObj.t_AnaliticKind1(+) in(" +
                                                                            string(TXOBJ_KIND1095) + ", " +
                                                                            string(TXOBJ_KIND1098) +
                                                                        ")" +
                            "          and MinusObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                            "          and TaxPaidObj.t_Client(+) = party.t_PartyID" +
                            "          and TaxPaidObj.t_Kind(+) in(" +
                                                                     string(TXOBJ_DIVPAY_SEC) + ", " +
                                                                     string(TXOBJ_PAID_35) +
                                                                 ")" +
                            "          and TaxPaidObj.t_AnaliticKind1(+) in(" +
                                                                              string(TXOBJ_KIND1095) + ", " +
                                                                              string(TXOBJ_KIND1098) +
                                                                          ")" +
                            "          and TaxPaidObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                            "          and TaxPaidObj.t_Date(+) between ? and ?" +
                            "          and BaseObj.t_Client(+) = party.t_PartyID" +
                            "          and BaseObj.t_Kind(+) in(" +
                                                                  string(TXOBJ_BASEGENERAL) + ", " +
                                                                  string(TXOBJ_BASESPECIAL) +
                                                              ")" +
                            "          and BaseObj.t_AnaliticKind1(+) in(" +
                                                                           string(TXOBJ_KIND1095) + ", " +
                                                                           string(TXOBJ_KIND1098) +
                                                                       ")" +
                            "          and BaseObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                            "          and BaseObj.t_Date(+) between ? and ?" +
                            "          and DivPlusObj.t_Client(+) = party.t_PartyID" +
                            "          and DivPlusObj.t_Kind(+) in(" +
                                                                     string(TXOBJ_PLUSG_1010) + ", " +
                                                                     string(TXOBJ_PLUS15_1010) +
                                                                 ")" +
                            "          and DivPlusObj.t_AnaliticKind1(+) in(" +
                                                                              string(TXOBJ_KIND1095) + ", " +
                                                                              string(TXOBJ_KIND1098) +
                                                                          ")" +
                            "          and DivPlusObj.t_Analitic1 = dpcorpop.t_DocumentID" +
                            "          and DivPlusObj.t_Date between ? and ?" +
                            "          and TaxCalculatedDivObj.t_Client(+) = party.t_PartyID" +
                            "          and TaxCalculatedDivObj.t_Kind(+) = " + string(TXOBJ_DIVPAY_SEC) +
                            "          and TaxCalculatedDivObj.t_Date(+) between ? and ?" +
                            "          and TaxCalculatedDivObj.t_AnaliticKind1(+) in(" +
                                                                                       string(TXOBJ_KIND1095) + ", " +
                                                                                       string(TXOBJ_KIND1098) +
                                                                                   ")" +
                            "          and TaxCalculatedDivObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                            "    ) q" +
                            " group by q.t_Month, q.t_Rate";

        var DepoClntSelect = DL_RSDCommand(DepoClntQuery);
        DepoClntSelect.AddParam(this.ClientID());
        DepoClntSelect.AddParam(m_BeginDate);
        DepoClntSelect.AddParam(m_EndDate);
        DepoClntSelect.AddParam(this.ClientID());
        DepoClntSelect.AddParam(m_BeginDate);
        DepoClntSelect.AddParam(m_EndDate);
        DepoClntSelect.AddParam(m_BeginDate);
        DepoClntSelect.AddParam(m_EndDate);
        DepoClntSelect.AddParam(m_BeginDate);
        DepoClntSelect.AddParam(m_EndDate);
        DepoClntSelect.AddParam(m_BeginDate);
        DepoClntSelect.AddParam(m_EndDate);
        DepoClntSelect.AddParam(m_BeginDate);
        DepoClntSelect.AddParam(m_EndDate);
        var DepoClntDS = DepoClntSelect.execute();
        while(DepoClntDS.MoveNext())
           var DepoRateIndex = AddInArrCodeParms(m_ArrCodeParms, DepoClntDS.Month, 1010, DepoClntDS.PlusSum, 601, DepoClntDS.MinusSum, 0.0, DepoClntDS.TaxCalculated, 0.0, 0.0, 0.0, DepoClntDS.Rate, 0.0, DepoClntDS.DivPlus, DepoClntDS.TaxCalculatedDiv);
           if(DepoRateIndex < RateIndex)
              RateIndex = DepoRateIndex;
           end;
           //Заносим индекс добавленной/скорректированной ставки в отдельный массив для того, чтобы вставить/обновить только изменённые данные
           //в таблицу dnptx6calc1_dbt
           AddRateIndex(@RateIndexes, DepoRateIndex);
           m_PlusSum = m_PlusSum + DepoClntDS.PlusSum;
           m_MinusSum = m_MinusSum + DepoClntDS.MinusSum;
        end;
      end;
    end;
  end;

  private macro РассчитатьДоходыИВычеты()
    var query = "", cmd = null, set = null;
    var ContrNumbers = "";
    var RateIndexes = TArray();
    var PlusSum = 0.0, DivPlus = 0.0, MinusSum = 0.0, TaxCalculated = 0.0, TaxCalculatedDiv = 0.0;

    ДобавитьВсеПараметры(@ContrNumbers, RateIndexes);
    var i = 0;
    while(i < RateIndexes.Size)
      PlusSum = PlusSum + m_ArrCodeParms[RateIndexes[i]].PlusSum;
      DivPlus = DivPlus + m_ArrCodeParms[RateIndexes[i]].DivPlus;
      MinusSum = MinusSum + m_ArrCodeParms[RateIndexes[i]].MinusSum;
      TaxCalculated = TaxCalculated + m_ArrCodeParms[RateIndexes[i]].TaxCalculated;
      TaxCalculatedDiv = TaxCalculatedDiv + m_ArrCodeParms[RateIndexes[i]].TaxCalculatedDiv;
      i = i + 1;
    end;

    if((PlusSum != $0) or (DivPlus != $0) or (MinusSum != $0) or (TaxCalculated != $0) or (TaxCalculatedDiv != $0))
      i = 0;
      while(i < RateIndexes.Size)
        InsertNPTX6Calc1(RateIndexes[i]);
        i = i + 1;
      end;
      if(m_PrevClientID != ClientID())
        var ClientCodeQuery = "";
        var ClientCodeCmd;
        var ClientCodeDS;
        var ClientCode = "";
        var ContrNumQuery = "select sfcontr.t_Number as t_ContrNum, dlcontr.t_DlContrID " +
                              "from dsfcontr_dbt sfcontr, ddlcontr_dbt dlcontr " +
                              "where sfcontr.t_PartyID = ? " +
                              "  and sfcontr.t_DateBegin <= ? " +
                              "  and sfcontr.t_DateClose >= ? " +
                              "  and dlcontr.t_SfContrID = sfcontr.t_ID";
        var ContrNumCMD = DL_RSDCommand(ContrNumQuery);
        ContrNumCMD.AddParam(ClientID());
        ContrNumCMD.AddParam(m_EndDate);
        ContrNumCMD.AddParam(m_BeginDate);
        var ContrNumDS = ContrNumCMD.Execute();
        if(ContrNumDS.MoveNext())
           ContrNumbers = ContrNumDS.ContrNum;
           ClientCodeQuery = " select t_Code" +
                                 " from ddlobjcode_dbt " +
                                 " where t_ObjectType = " + string(OBJTYPE_BROKERCONTR_DL) +
                                 "   and t_CodeKind = " + string(DLCCK_USC) +
                                 "   and t_ObjectID = ?";

           ClientCodeCmd = DL_RSDCommand(ClientCodeQuery);
           ClientCodeCmd.AddParam(ContrNumDS.DlContrID);
           ClientCodeDS = ClientCodeCmd.Execute();
           if(ClientCodeDS.MoveNext())
              ClientCode = ClientCodeDS.Code;
           end;
        else
           ClientCodeQuery = "select t_Code " +
                             "from dobjcode_dbt " +
                             "where t_ObjectType = " + string(OBJTYPE_PARTY) +
                             "  and t_CodeKind = " + string(PTCK_MICEX) +
                             "  and t_ObjectID = ?";
           ClientCodeCmd = DL_RSDCommand(ClientCodeQuery);
           ClientCodeCmd.AddParam(ClientID());
           ClientCodeDS = ClientCodeCmd.Execute();
           if(ClientCodeDS.MoveNext())
              ClientCode = ClientCodeDS.Code;
           end;
        end;
        m_Amount = m_Amount + 1;
        m_PartyCounter.IncByIdx(Rate(m_InfoRate));
        var EmployeeQuery = "select t_AttrID " +
                            "from dobjatcor_dbt " +
                            "where t_ObjectType = " + string(OBJTYPE_PARTY) +
                            "  and t_GroupID = 92 " +
                            "  and LTRIM(t_Object, '0') = ?";

        var EmployeeCmd = DL_RSDCommand(EmployeeQuery);
        EmployeeCmd.AddParam(ClientID());
        var EmployeeDS = EmployeeCmd.Execute();
        var IsEmployee = false;
        if(EmployeeDS.MoveNext() and (EmployeeDS.AttrID == 1))
           IsEmployee = true;
           m_EmplCounter.IncByIdx(Rate(m_InfoRate));
           m_AmountEmployee = m_AmountEmployee + 1;
        end;

        m_PersnDataArray[m_PersnDataArray.Size] = PersnData(LastName(), FirstName(), MiddleName(), ClientCode, ContrNumbers, ClientINN(), PassportNumber(), PassportSeries(), PassportData(), PassportAuthority(), DateBirth(), LegalAdr().rec.Adress, IIF(IsEmployee, "Да", ""));

        m_PrevClientID = ClientID();
      end;
    end;
  end;

  macro CalcData(infoRate)
    ClearData();
    m_InfoRate = infoRate;
    РассчитатьДоходыИВычеты();
  end;

  macro РассчитатьИтоговыеЗначения()
    var sum = $0;
    var link = null;
    var query = "", cmd = null, set = null;

    GetSum(UnknownParty, "" + TXOBJ_PAIDMATERIAL
                      + "," + TXOBJ_PAIDGENERAL
                      + "," + TXOBJ_PAIDSPECIAL
                      + "," + TXOBJ_PAID_35
                      + "," + TXOBJ_DIVPAY_SEC
                      + "," + TXOBJ_PAIDBILL, m_BeginDate, m_EndDate, @sum, 0, " obj.t_Sum > 0 ");
    m_TaxPaid = m_TaxPaid + sum;
    GetSum(UnknownParty, "" + TXOBJ_PAIDMATERIAL_IIS
                      + "," + TXOBJ_PAIDGENERAL_IIS
                      + "," + TXOBJ_PAIDSPECIAL_IIS, m_BeginDate, m_EndDate, @sum, 1, " obj.t_Sum > 0 "
                                                                                + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", obj.t_Analitic6) = 1 ");
    m_TaxPaid = m_TaxPaid + sum;

    link = NPTXLink(m_BeginDate, m_EndDate, 2);
    link.Create();
    query = " SELECT "
              + " NVL(SUM(nptx6.t_Sum), 0) AS t_Sum "
          + " FROM "
              + " dnptx6_tmp nptx6 "
          + " WHERE "
              + " nptx6.t_Type = 1 ";
    cmd = RsdCommand(query);
    cmd.NullConversion = true;
    cmd.Execute();
    set = RsdRecordset(cmd);
    set.MoveNext();
    sum = set.Value("t_Sum");
    m_TaxDue = m_TaxDue + sum;

    GetSum(UnknownParty, "" + TXOBJ_PAIDMATERIAL
                      + "," + TXOBJ_PAIDGENERAL
                      + "," + TXOBJ_PAIDSPECIAL
                      + "," + TXOBJ_PAID_35
                      + "," + TXOBJ_DIVPAY_SEC
                      + "," + TXOBJ_PAIDBILL, m_BeginDate, m_EndDate, @sum, 0, " obj.t_Sum < 0 ");
    m_TaxToReturnDue = m_TaxToReturnDue + sum;
    GetSum(UnknownParty, "" + TXOBJ_PAIDMATERIAL_IIS
                      + "," + TXOBJ_PAIDGENERAL_IIS
                      + "," + TXOBJ_PAIDSPECIAL_IIS, m_BeginDate, m_EndDate, @sum, 1, " obj.t_Sum < 0 "
                                                                                + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", obj.t_Analitic6) = 1 ");
    m_TaxToReturnDue = m_TaxToReturnDue + sum;
  end;

  if(_ByCB != null)
    m_ByCB = _ByCB;
  end;

  if(_ByDepo != null)
    m_ByDepo = _ByDepo;
  end;

  if(_ByVS != null)
    m_ByVS = _ByVS;
  end;

  if(_RepDate != null)
    m_RepDate2 = _RepDate;
  end;

  InitNPTXRepCalc_NPTXPIT6(-1, _BeginDate, _EndDate, m_ByCB, m_ByDepo, m_ByVS, _RepDate);

  if(_BeginDate != null)
    m_BeginDate = _BeginDate;
  end;

  if(_EndDate != null)
    m_EndDate = _EndDate;
  end;

  SQL_Truncate("dnptx6calc1_tmp");
end;

private class NPTXPayData()
  var DatePlusFact = ZeroDate;
  var DatePaid = ZeroDate;
  var DateTransfer = ZeroDate;
  var BaseDate = $0;
  var TaxPaidDate = $0;
end;

private class (DL_XML) NPTXPit6XML()
  macro CreateXMLObj()
    CreateXML();
  end;

  macro GetXMLObj()
    return m_xml;
  end;

  macro SetFileName(fileName)
    if(fileName != null)
      m_FileName = fileName;
    end;
  end;

  macro GetFileName()
    return m_FileName;
  end;

  macro Save()
    SaveXML();
  end;

  macro CreateNode(nodeName /* attrName, attrValue, ... */)
    var node = null;
    var numParm = 2;
    var attrName = "", attrValue = "";

    node = m_xml.createNode(1, nodeName, NameSpace);
    while(GetParm(numParm, attrName))
      GetParm(numParm + 1, attrValue);
      node.setAttributeNode(CreateAttr(attrName, attrValue));
      numParm = numParm + 2;
    end;

    return node;
  end;

  initDL_XML();
  m_FileName = "NO_NDFL6_0000_0000_0000000000000000000_00000000_0";
end;

class (TaxReportBase) NPTX_Pit6_Report()
  private const PaysOnPage = 5;

  private var m_RepCalc = null;
  private var m_Link = null;
  private var m_RepCalc2 = null;
  private var m_InXML = UNSET_CHAR;
  private var m_XMLFile = null;
  private var m_DataExist = false;
  private var m_DetailSheetNameArr = null;
  private var m_RateSheetName = null;
  private var m_PersnDataArray = TArray();

  macro CReport_DataExist()
    return m_DataExist;
  end;

  macro CReport_NoDataMsg()
    MsgBox("За отчетный период нет данных");
  end;

  private macro BeginReport(numCopy:Integer)
    var partyNumber = 0;
    var yyyy = 0;

    m_RepCalc = NPTXRepCalc(m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_P1BEGDATE),
                            m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_P1ENDDATE),
                            m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_BYCB),
                            m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_BYDEPO),
                            m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_BYVS),
                            m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_REPDATE));
    m_InXML = m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_INXML);

    InitProgress(-1, "Форма 6-НДФЛ", "Форма 6-НДФЛ");

    while(m_RepCalc.Next())
      if(partyNumber == 0)
        RemProgress();
        InitProgress(m_RepCalc.Count(), "Форма 6-НДФЛ", "Форма 6-НДФЛ");
      end;

      m_RepCalc.ClearData();
      // Для ставки 9 (15)% заменяется на ставку 9% и значения примечаний
      // "Налоговая ставка для дивидендов в депозитарии" за период отчёта
      // Вначале отчитываемся по всем из m_TaxDivValArray, затем по НКРФ (15%)
      m_RepCalc.Refresh_TaxDivValArray();
      // 9% / ставке по дивидендам для нерезидентов
      if(m_RepCalc.m_TaxDivValArray.Size > 0)
        while(m_RepCalc.m_TaxDivValArrayCurIndex < m_RepCalc.m_TaxDivValArray.Size)
          m_RepCalc.CalcData(INFORATE9_NOTRES_DIV);
          m_RepCalc.m_TaxDivValArrayCurIndex = m_RepCalc.m_TaxDivValArrayCurIndex + 1;
        end;
      end;

      // Ппоследний посчитанный не обрабатывается в основном цикле
      // Причина - особенности реализации, доступа к элементу массива по индексу и т.д.
      // Последний посчитанный - будет по НКРФ
      m_RepCalc.CalcData(INFORATE9_NOTRES_DIV);

      // Справка 2 по общей ставке
      m_RepCalc.CalcData(INFORATE_TOTAL);

      // По повышенной ставке (15%)
      m_RepCalc.CalcData(INFORATE_HIGHRATE_15);

      // По ставке 35%(только для резидентов)
      m_RepCalc.CalcData(INFORATE_35);

      // По операциям расчётов выплат в Депозитарии
      if(m_RepCalc.IsDepoClient())
        m_RepCalc.CalcData(0);
      end;

      UseProgress(partyNumber = partyNumber + 1);
    end;

    RemProgress();

    m_DataExist = m_RepCalc.Rates().MoveFirst();

    m_PersnDataArray = m_RepCalc.PersnDataArray();

    DateSplit(m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_P1ENDDATE), null, null, yyyy);
    m_Link = NPTXLink(Date(1, 1, yyyy), m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_P2ENDDATE), 1);
    m_Link.Create();

    m_RepCalc.РассчитатьИтоговыеЗначения();

    m_RepCalc2 = NPTXRepCalc2_NPTXPIT6(m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_P2BEGDATE),
                                       m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_P2ENDDATE),
                                       m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_BYCB),
                                       m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_BYDEPO),
                                       m_Form.GetFieldValue(NPTX_PIT6_FLDNUM_BYVS));

    InitProgress(-1, "Форма 6-НДФЛ", "Форма 6-НДФЛ");

    m_RepCalc2.Calculate();

    RemProgress();

    m_DataExist = (m_RepCalc.Rates().MoveFirst() or m_RepCalc2.Pays().MoveFirst());

    if(m_DataExist)
      CreateTotalBook();

      m_DetailSheetNameArr = TArray();
      m_RateSheetName = TArray();

      if(m_InXML == SET_CHAR)
        m_XMLFile.CreateXMLObj();
      end;
    end;

    Dl_CallInsertStat(m_OutMode);
  end;

  private macro PrintTitle(pageCount)
    var dd = 0, mm = 0, yyyy = 0;

    DateSplit(m_RepCalc.RepDate(), dd, mm, yyyy);

    UseNewSheetInTotalBook();

    SetActiveSheet("Титульный лист");

    PrintOneRow("N1_OurInn", m_RepCalc.OurInn(), 12);
    PrintOneRow("N1_OurKPP", "770401001", 9);
    PrintOneRow("N1_PP", m_RepCalc.PP(), 2);
    PrintOneRow("N1_Year", String(m_RepCalc.CurrYear()), 4);
    PrintOneRow("N1_OurFNScode", m_RepCalc.OurFNScode(), 4);
    PrintOneRow("N1_OurName", m_RepCalc.OurName(), 160);
    PrintOneRow("N1_OurOKTMO", DL_StrCut(m_RepCalc.OurOKTMO(), 11, "-", true), 11);
    PrintOneRow("N1_OurPhone", m_RepCalc.OurPhone(), 20);
    PrintOneRow("N1_Page", L_Z(pageCount, 3), 3);
    PrintOneRow("N1_FIOperson1", m_RepCalc.FirstPersonLastName(), 20);
    PrintOneRow("N1_FIOperson2", m_RepCalc.FirstPersonFirstName(), 20);
    PrintOneRow("N1_FIOperson3", m_RepCalc.FirstPersonMiddleName(), 20);
    PrintOneRow("N1_Date", L_Z(dd, 2) + L_Z(mm, 2) + L_Z(yyyy, 4), 8);

    CopyAllSheetInTotalBook("Титульный лист", false, "N1_PrintArea", 0, "Титульный лист");
  end;

  private macro PrintPart12(numPage, needRate, needResult, payArr)
    var payNumber = 0;
    var dd = 0, mm = 0, yyyy = 0;

    UseNewSheetInTotalBook();

    SetActiveSheet("Расчет_1");

    PrintOneRow("N2_OurInn", m_RepCalc.OurInn(), 12);
    PrintOneRow("N2_OurKPP", "770401001", 9);
    PrintOneRow("N2_NumPage", L_Z(numPage, 3), 3);

    if(needRate)
      PrintOneRow("N2_Rate", String(Int(m_RepCalc.Rates().Value("t_Rate"))), 2);
      PrintOneSumRow("N2_TotalPlus", Money(m_RepCalc.Rates().Value("t_TotalPlus")), 17, true);
      PrintOneSumRow("N2_DivPlus", Money(m_RepCalc.Rates().Value("t_DivPlus")), 17, true);
      PrintOneSumRow("N2_TotalMinus", Money(m_RepCalc.Rates().Value("t_TotalMinus")), 17, true);
      PrintOneSumRow("N2_TaxCalculated", round(Money(m_RepCalc.Rates().Value("t_TaxCalculated")),0), 15, false);
      PrintOneSumRow("N2_TaxCalculatedDiv", Money(m_RepCalc.Rates().Value("t_TaxCalculatedDiv")), 15, false);

      if(needResult)
        PrintOneSumRow("N2_Amount", Int(m_RepCalc.Amount()), 7, false);
        PrintOneSumRow("N2_TaxPaid", Money(m_RepCalc.TaxPaid()), 15, false);
        PrintOneSumRow("N2_TaxDue", Money(m_RepCalc.TaxDue()), 15, false);
        PrintOneSumRow("N2_TaxToReturnDue", Money(m_RepCalc.TaxToReturnDue()), 15, false);
      end;
    end;

    while((payArr != null) and (payNumber < Min(payArr.Size, PaysOnPage)))
      DateSplit(payArr[payNumber].DatePlusFact, dd, mm, yyyy);
      PrintOneRow("N2_DatePlusFact" + (payNumber + 1), L_Z(dd, 2) + L_Z(mm, 2) + L_Z(yyyy, 4), 8);
      if(payArr[payNumber].DatePaid != ZeroDate)
        DateSplit(payArr[payNumber].DatePaid, dd, mm, yyyy);
        PrintOneRow("N2_DatePaid" + (payNumber + 1), L_Z(dd, 2) + L_Z(mm, 2) + L_Z(yyyy, 4), 8);
      end;
      DateSplit(payArr[payNumber].DateTransfer, dd, mm, yyyy);
      PrintOneRow("N2_DateTransfer" + (payNumber + 1), L_Z(dd, 2) + L_Z(mm, 2) + L_Z(yyyy, 4), 8);
      PrintOneSumRow("N2_BaseDate" + (payNumber + 1), Money(payArr[payNumber].BaseDate), 17, true);
      PrintOneSumRow("N2_TaxPaidDate" + (payNumber + 1), Money(payArr[payNumber].TaxPaidDate), 15, false);

      payNumber = payNumber + 1;
    end;

    CopyAllSheetInTotalBook("Расчет_1", false, "N2_PrintArea", 0, "Расчет_" + (numPage - 1));
  end;

  private macro PrintForm()
    var rateExists = false, payExists = false;
    var part12PageNumber = 0, part12PageCount = 0;
    var payArr = null, payNumber = 0, pay = null;

    rateExists = m_RepCalc.Rates().MoveFirst();
    payExists = m_RepCalc2.Pays().MoveFirst();
    while(rateExists or payExists)
      if(part12PageNumber == 0)
        if(rateExists and not payExists)
          part12PageCount = Int(m_RepCalc.Rates().Value("t_Count"));
        elif(not rateExists and payExists)
          part12PageCount = Int(Round(m_RepCalc2.Pays().Value("t_Count") / PaysOnPage, 0));
        else
          part12PageCount = Max(Int(Round(m_RepCalc2.Pays().Value("t_Count") / PaysOnPage, 0)), Int(m_RepCalc.Rates().Value("t_Count")));
        end;

        InitProgress(part12PageCount, "Форма 6-НДФЛ", "Форма 6-НДФЛ");

        PrintTitle(part12PageCount + 1);
      end;

      payArr = null;
      payNumber = 0;
      while(payExists and (payNumber < PaysOnPage))
        if(payNumber == 0)
          payArr = TArray();
        end;

        pay = NPTXPayData();
        pay.DatePlusFact = Date(m_RepCalc2.Pays().Value("t_DatePlusFact"));
        pay.DatePaid = Date(m_RepCalc2.Pays().Value("t_DatePaid"));
        pay.DateTransfer = Date(m_RepCalc2.Pays().Value("t_DateTransfer"));
        pay.BaseDate = Money(m_RepCalc2.Pays().Value("t_BaseDate"));
        pay.TaxPaidDate = Money(m_RepCalc2.Pays().Value("t_TaxPaidDate"));

        var IsSum = false;
        var i = 0;
        while(i < payArr.Size)
           if((pay.DatePlusFact == payArr[i].DatePlusFact) and (pay.DatePaid == payArr[i].DatePaid) and (pay.DateTransfer == payArr[i].DateTransfer))
              IsSum = true;
              payArr[i].BaseDate = payArr[i].BaseDate + pay.BaseDate;
              payArr[i].TaxPaidDate = payArr[i].TaxPaidDate + pay.TaxPaidDate;
              break;
           end;

           i = i + 1;
        end;
        if(not IsSum)
           payArr[payArr.Size] = pay;
        end;

        payExists = m_RepCalc2.Pays().MoveNext();
        payNumber = payNumber + 1;
      end;

      PrintPart12(part12PageNumber + 2, rateExists, (part12PageNumber == 0), payArr);

      if(rateExists)
        rateExists = m_RepCalc.Rates().MoveNext();
      end;

      UseProgress(part12PageNumber = part12PageNumber + 1);
    end;

    if(part12PageNumber != 0)
      RemProgress();
    end;
  end;

  private macro PrintDetails()
    var payExists = false, payNumber = 0;
    var prevModule = -1, detailSheetName = "";

    payExists = m_RepCalc2.Pays().MoveFirst();
    payNumber = 0;
    while(payExists)
      if(payNumber == 0)
        InitProgress(Int(m_RepCalc2.Pays().Value("t_Count")), "Форма 6-НДФЛ", "Форма 6-НДФЛ");
      end;

      if(prevModule != m_RepCalc2.Pays().Value("t_Module"))
        if(prevModule > 0)
          EndTable();
          CopyAllSheetInTotalBook("Расшифровка_Раздел 2", false, GetTableRange(), 0, detailSheetName);
          m_DetailSheetNameArr[m_DetailSheetNameArr.Size] = detailSheetName;
        end;

        UseNewSheetInTotalBook();
        SetActiveSheet("Расшифровка_Раздел 2");

        detailSheetName = "Расшифровка_Раздел 2 " + IIF(m_RepCalc2.Pays().Value("t_Module") == 1, "(БО)", IIF(m_RepCalc2.Pays().Value("t_Module") == 2, "(Деп)", "(СВ)"));

        PrintFormatString(null,
                          "N3_Module", IIF(m_RepCalc2.Pays().Value("t_Module") == 1, "Бэк-офис операций с ц/б и ПФИ", IIF(m_RepCalc2.Pays().Value("t_Module") == 2, "Депозитарий", "Вескеля Банка")),
                          "N3_DateT2", m_RepCalc2.BeginDate(),
                          "N3_DateT3", m_RepCalc2.EndDate());

        SetSubtotalEx(0, 7, "H4", "I4", "M4", "N4", "O4", "P4", "Q4");

        CopyAllSheetInTotalBook("Расшифровка_Раздел 2", false, "N3_Header", 0, detailSheetName);

        RegisterTable("N3_Table", null,
                      "N3_Num", "N3_TypeOper", "N3_Client", "N3_ClientCode", "N3_DatePlusFact", "N3_DatePaid",
                      "N3_DateTransfer", "N3_BaseDate", "N3_TaxPaidDate",
                      "N3_TotalPlus", "N3_TotalMinus", "N3_TaxCalculated", "N3_TaxDue", "N3_TaxToReturnDue", "N3_DateOper", "N3_NumOper", "N3_Rate");

        prevModule = m_RepCalc2.Pays().Value("t_Module");
      end;

      PrintTableLine("N3_Num", m_RepCalc2.Pays().Value("t_Num"), null,
                     "N3_TypeOper", m_RepCalc2.Pays().Value("t_TypeOper"), null,
                     "N3_Client", m_RepCalc2.Pays().Value("t_Client"), null,
                     "N3_ClientCode", m_RepCalc2.Pays().Value("t_ClientCode"), null,
                     "N3_DatePlusFact", Date(m_RepCalc2.Pays().Value("t_DatePlusFact")), null,
                     "N3_DatePaid", IIF(m_RepCalc2.Pays().Value("t_DatePaid") != ZeroDate, Date(m_RepCalc2.Pays().Value("t_DatePaid")), ""), null,
                     "N3_DateTransfer", Date(m_RepCalc2.Pays().Value("t_DateTransfer")), null,
                     "N3_BaseDate", m_RepCalc2.Pays().Value("t_BaseDate"), null,
                     "N3_TaxPaidDate", round(m_RepCalc2.Pays().Value("t_TaxPaidDate"), 0), null,
                     "N3_TotalPlus", m_RepCalc2.Pays().Value("t_TotalPlus"), null,
                     "N3_TotalMinus", m_RepCalc2.Pays().Value("t_TotalMinus"), null,
                     "N3_TaxCalculated", round(m_RepCalc2.Pays().Value("t_TaxCalculated"), 0), null,
                     "N3_TaxDue", round(m_RepCalc2.Pays().Value("t_TaxDue"), 0), null,
                     "N3_TaxToReturnDue", m_RepCalc2.Pays().Value("t_TaxToReturnDue"), null,
                     "N3_DateOper", Date(m_RepCalc2.Pays().Value("t_DateOper")), null,
                     "N3_NumOper", m_RepCalc2.Pays().Value("t_NumOper"), null,
                     "N3_Rate", m_RepCalc2.Pays().Value("t_Rate"), null);

      payExists = m_RepCalc2.Pays().MoveNext();
      UseProgress(payNumber = payNumber + 1);
    end;

    if(payNumber != 0)
      EndTable();
      CopyAllSheetInTotalBook("Расшифровка_Раздел 2", false, GetTableRange(), 0, detailSheetName);
      m_DetailSheetNameArr[m_DetailSheetNameArr.Size] = detailSheetName;

      RemProgress();
    end;
  end;

  private macro PrintRates()
    var rateExists = false, rateNumber = 0;
    var prevRate = 1.7e-308, rateSheetName = "";

    rateExists = m_RepCalc2.Rates().MoveFirst();
    rateNumber = 0;
    while(rateExists)
      if(rateNumber == 0)
        InitProgress(Int(m_RepCalc2.Rates().Value("t_Count")), "Форма 6-НДФЛ", "Форма 6-НДФЛ");
      end;

      if(prevRate != m_RepCalc2.Rates().Value("t_Rate"))
        if(prevRate != 1.7e-308)
          EndTable();
          CopyAllSheetInTotalBook("Раздел 2", false, GetTableRange(), 0, rateSheetName);
          m_RateSheetName[m_RateSheetName.Size] = rateSheetName;
        end;

        UseNewSheetInTotalBook();
        SetActiveSheet("Раздел 2");

        rateSheetName = "Раздел 2 (" + Int(m_RepCalc2.Rates().Value("t_Rate")) + "%)";

        CopyAllSheetInTotalBook("Раздел 2", false, "N4_Header", 0, rateSheetName);

        RegisterTable("N4_Table", null,
                      "N4_OurInn", "N4_OurKPP", "N4_OurOKTMO", "N4_Rate", "N4_Year", "N4_P", "N4_DatePlusFact", "N4_DatePaid",
                      "N4_DateTransfer", "N4_BaseDate", "N4_TaxPaidDate", "N4_TotalMinus", "N4_TaxCalculated", "N4_TaxDue",
                      "N4_TaxToReturnDue", "N4_TaxOver");

        prevRate = m_RepCalc2.Rates().Value("t_Rate");
      end;

      PrintTableLine("N4_OurInn", m_RepCalc.OurInn(), null,
                     "N4_OurKPP", "770401001", null,
                     "N4_OurOKTMO", m_RepCalc.OurOKTMO(), null,
                     "N4_Rate", m_RepCalc2.Rates().Value("t_Rate"), null,
                     "N4_Year", m_RepCalc.CurrYear(), null,
                     "N4_P", m_RepCalc.P(), null,
                     "N4_DatePlusFact", Date(m_RepCalc2.Rates().Value("t_DatePlusFact")), null,
                     "N4_DatePaid", Date(m_RepCalc2.Rates().Value("t_DatePaid")), null,
                     "N4_DateTransfer", Date(m_RepCalc2.Rates().Value("t_DateTransfer")), null,
                     "N4_BaseDate", m_RepCalc2.Rates().Value("t_TotalPlus"), null,
                     "N4_TaxPaidDate", m_RepCalc2.Rates().Value("t_TaxPaidDate"), null,
                     "N4_TotalMinus", m_RepCalc2.Rates().Value("t_TotalMinus"), null,
                     "N4_TaxCalculated", round(m_RepCalc2.Rates().Value("t_TaxCalculated"),0), null,
                     "N4_TaxDue", round(m_RepCalc2.Rates().Value("t_TaxDue"),0), null,
                     "N4_TaxToReturnDue", round(m_RepCalc2.Rates().Value("t_TaxToReturnDue"), 0), null,
                     "N4_TaxOver", round(m_RepCalc2.Rates().Value("t_TaxOver"), 0), null);

      rateExists = m_RepCalc2.Rates().MoveNext();
      UseProgress(rateNumber = rateNumber + 1);
    end;

    if(rateNumber != 0)
      EndTable();
      CopyAllSheetInTotalBook("Раздел 2", false, GetTableRange(), 0, rateSheetName);
      m_RateSheetName[m_RateSheetName.Size] = rateSheetName;

      RemProgress();
    end;
  end;

  private macro PrintResult()
    UseNewSheetInTotalBook();

    SetActiveSheet("Раздел 1");

    CopyAllSheetInTotalBook("Раздел 1", false, "N5_Header", 0, "Раздел 1");

    RegisterTable("N5_Table", null, "N5_OurInn","N5_OurKPP","N5_OurOKTMO","N5_Year","N5_Rate","N5_P","N5_Amount","N5_AmountEmployee");
    var i = -1;
    var partyCountArr = m_RepCalc.GetPartyCounter().GetCounterArr();
    while((i=i+1) < partyCountArr.Size)
       PrintTableLine(
                      "N5_OurInn",         m_RepCalc.OurInn(),                                             NULL,
                      "N5_OurKPP",         "770401001",                                                            NULL,
                      "N5_OurOKTMO",       m_RepCalc.OurOKTMO(),                                           NULL,
                      "N5_Year",           m_RepCalc.CurrYear(),                                           NULL,
                      "N5_Rate",           String(Int(partyCountArr[i].Key)),                              NULL,
                      "N5_P",              m_RepCalc.P() * 3,                                              NULL,
                      "N5_Amount",         partyCountArr[i].Value,                                         NULL,
                      "N5_AmountEmployee", m_RepCalc.GetEmplCounter().GetCountByIdx(partyCountArr[i].Key), NULL
                     );
    end;
    EndTable();
    CopyAllSheetInTotalBook("Раздел 1", false, GetTableRange(), 0, "Раздел 1");

    SetActiveSheet("Расшифровка_Раздел 1");
    CopyAllSheetInTotalBook("Расшифровка_Раздел 1", false, "N6_Header", 0, "Расшифровка_Раздел 1");
    RegisterTable("N6_Table", null, "N6_FIO", "N6_Code", "N6_Contract");

    m_PersnDataArray = m_RepCalc.PersnDataArray();
    i = 0;
    while(i < m_PersnDataArray.Size)
       PrintTableLine("N6_FIO",            m_PersnDataArray[i].GetFullName(),          NULL,
                      "N6_Code",           m_PersnDataArray[i].Code,                   NULL,
                      "N6_Contract",       m_PersnDataArray[i].ContrNum,               NULL,
                      "N6_ClientINN",      m_PersnDataArray[i].ClientINN,              NULL,
                      "N6_PassportNumber", m_PersnDataArray[i].PassportNumber,         NULL,
                      "N6_PassportSeries", m_PersnDataArray[i].PassportSeries,         NULL,
                      "N6_PassportData",   string(m_PersnDataArray[i].PassportData:f), NULL,
                      "N6_Authority",      m_PersnDataArray[i].Authority,              NULL,
                      "N6_DateBirth",      string(m_PersnDataArray[i].DateBirth:f),    NULL,
                      "N6_RegAddress",     m_PersnDataArray[i].RegAddress,             NULL,
                      "N6_IsEmployee",     m_PersnDataArray[i].IsEmployee,             NULL,
                      "N6_DismissalDate",  "",                                         NULL
                     );
   
       i = i + 1;
    end;

    EndTable();
    CopyAllSheetInTotalBook("Расшифровка_Раздел 1", false, GetTableRange(), 0, "Расшифровка_Раздел 1");
  end;

  private macro CreateXML()
    var dd = 0, mm = 0, yyyy = 0;
    var refID = 0, num = "";
    var nodeFile = null, nodeDocument = null, nodeSvNP = null, nodeNPUL = null, nodeSigner = null;
    var nodeFIO = null, nodeNDFL6 = null, nodeSummaryInfo = null, nodeSumRate = null, nodeIncomeTaxes = null;
    var nodeSumDate = null;
    var rateExists = false, rateNumber = 0;
    var payExists = false, payNumber = 0;

    DateSplit(m_RepCalc.RepDate(), dd, mm, yyyy);
    GetReferenceIDByType(134, 1, refID);
    GenerateReference(refID, num);

    m_XMLFile.SetFileName("NO_NDFL6_" + SubStr(m_RepCalc.OurFNScode(), 1, 4)
                                + "_" + SubStr(m_RepCalc.OurFNScode(), 1, 4)
                                + "_" + SubStr(m_RepCalc.OurInn(), 1, 10) + SubStr(m_RepCalc.OurKPP(), 1, 9)
                                + "_" + L_Z(yyyy, 4) + L_Z(mm, 2) + L_Z(dd, 2)
                                + "_" + num);

    nodeFile = m_XMLFile.CreateNode("Файл",
                                    "ИдФайл", m_XMLFile.GetFileName(),
                                    "ВерсПрог", "RS-Bank",
                                    "ВерсФорм", "5.02");

    nodeDocument = m_XMLFile.CreateNode("Документ",
                                        "КНД", "1151099",
                                        "ДатаДок", date_as_string(1, m_RepCalc.EndDate(), false),
                                        "Период", m_RepCalc.PP(),
                                        "ОтчетГод", String(m_RepCalc.CurrYear()),
                                        "КодНО", SubStr(m_RepCalc.OurFNScode(), 1, 4),
                                        "НомКорр", "0",
                                        "ПоМесту", "214");

    nodeSvNP = m_XMLFile.CreateNode("СвНП",
                                    "ОКТМО", SubStr(m_RepCalc.OurOKTMO(), 1, 11),
                                    "Тлф", SubStr(m_RepCalc.OurPhone(), 1, 20));

    nodeNPUL = m_XMLFile.CreateNode("НПЮЛ",
                                    "НаимОрг", SubStr(m_RepCalc.OurName(), 1, 1000),
                                    "ИННЮЛ", SubStr(m_RepCalc.OurInn(), 1, 10),
                                    "КПП",  "770401001", 1, 9);

    nodeSvNP.appendChild(nodeNPUL);

    nodeDocument.appendChild(nodeSvNP);

    nodeSigner = m_XMLFile.CreateNode("Подписант",
                                      "ПрПодп", "1");

    nodeFIO = m_XMLFile.CreateNode("ФИО",
                                   "Фамилия", SubStr(m_RepCalc.FirstPersonLastName(), 1, 60),
                                   "Имя", SubStr(m_RepCalc.FirstPersonFirstName(), 1, 60),
                                   "Отчество", SubStr(m_RepCalc.FirstPersonMiddleName(), 1, 60));

    nodeSigner.appendChild(nodeFIO);

    nodeDocument.appendChild(nodeSigner);

    nodeNDFL6 = m_XMLFile.CreateNode("НДФЛ6");

    nodeSummaryInfo = m_XMLFile.CreateNode("ОбобщПоказ",
                                           "КолФЛДоход", SubStr(String(m_RepCalc.Amount():0:0), 1, 7),
                                           "УдержНалИт", SubStr(String(m_RepCalc.TaxPaid():0:0), 1, 15),
                                           "НеУдержНалИт", SubStr(String(m_RepCalc.TaxDue():0:0), 1, 15),
                                           "ВозврНалИт", SubStr(String(m_RepCalc.TaxToReturnDue():0:0), 1, 15));

    rateExists = m_RepCalc.Rates().MoveFirst();
    rateNumber = 0;
    while(rateExists)
      if(rateNumber == 0)
        InitProgress(m_RepCalc.Rates().Value("t_Count"), "Форма 6-НДФЛ", "Форма 6-НДФЛ");
      end;

      nodeSumRate = m_XMLFile.CreateNode("СумСтавка",
                                         "Ставка", SubStr(String(m_RepCalc.Rates().Value("t_Rate"):0:0), 1, 2),
                                         "НачислДох", SubStr(String(m_RepCalc.Rates().Value("t_TotalPlus"):0:2), 1, 17),
                                         "НачислДохДив", SubStr(String(m_RepCalc.Rates().Value("t_DivPlus"):0:2), 1, 17),
                                         "ВычетНал", SubStr(String(m_RepCalc.Rates().Value("t_TotalMinus"):0:2), 1, 17),
                                         "ИсчислНал", SubStr(String(m_RepCalc.Rates().Value("t_TaxCalculated"):0:0), 1, 15),
                                         "ИсчислНалДив", SubStr(String(m_RepCalc.Rates().Value("t_TaxCalculatedDiv"):0:0), 1, 15),
                                         "АвансПлат", "0");

      nodeSummaryInfo.appendChild(nodeSumRate);

      rateExists = m_RepCalc.Rates().MoveNext();
      UseProgress(rateNumber = rateNumber + 1);
    end;

    if(rateNumber != 0)
      RemProgress();
    end;

    nodeNDFL6.appendChild(nodeSummaryInfo);

    payExists = m_RepCalc2.Pays().MoveFirst();
    payNumber = 0;
    while(payExists)
      if(payNumber == 0)
        nodeIncomeTaxes = m_XMLFile.CreateNode("ДохНал");

        InitProgress(Int(m_RepCalc2.Pays().Value("t_Count")), "Форма 6-НДФЛ", "Форма 6-НДФЛ");
      end;

      nodeSumDate = m_XMLFile.CreateNode("СумДата",
                                         "ДатаФактДох", date_as_string(1, Date(m_RepCalc2.Pays().Value("t_DatePlusFact")), false),
                                         "ДатаУдержНал", date_as_string(1, Date(m_RepCalc2.Pays().Value("t_DatePaid")), false),
                                         "ДатаУдержНал", IIF(m_RepCalc2.Pays().Value("t_DatePaid") != ZeroDate, date_as_string(1, Date(m_RepCalc2.Pays().Value("t_DatePaid")), false), "00.00.0000"),
                                         "СрокПрчслНал", date_as_string(1, Date(m_RepCalc2.Pays().Value("t_DateTransfer")), false),
                                         "ФактДоход", SubStr(String(m_RepCalc2.Pays().Value("t_BaseDate"):0:2), 1, 17),
                                         "УдержНал", SubStr(String(m_RepCalc2.Pays().Value("t_TaxPaidDate"):0:0), 1, 15));

      nodeIncomeTaxes.appendChild(nodeSumDate);

      payExists = m_RepCalc2.Pays().MoveNext();
      UseProgress(payNumber = payNumber + 1);
    end;

    if(payNumber != 0)
      nodeNDFL6.appendChild(nodeIncomeTaxes);

      RemProgress();
    end;

    nodeDocument.appendChild(nodeNDFL6);

    nodeFile.appendChild(nodeDocument);

    m_XMLFile.GetXMLObj().appendChild(nodeFile);
  end;

  private macro Create(numCopy:Integer)
    if(m_DataExist)
      PrintResult();

      PrintRates();

      PrintDetails();

      PrintForm();

      if(m_InXML == SET_CHAR)
        CreateXML();
      end;
    end;
  end;

  private macro EndReport(numCopy:Integer)
    var detailSheetName = "", rateSheetName = "";

    if(m_DataExist)
      SaveTotalBook();

      for(detailSheetName, m_DetailSheetNameArr)
        m_ObjTemplateXLS.SetAutoFilter("A6:R6", detailSheetName);
      end;

      for(rateSheetName, m_RateSheetName)
        m_ObjTemplateXLS.SetAutoFilter("A1:O1", rateSheetName);
      end;

      if(m_InXML == SET_CHAR)
        m_XMLFile.Save();
        MsgBox("Сформирован файл " + m_XMLFile.GetFileName() + ".xml");
      end;
    end;
  end;

  initDL_CReportTemplate(NPTX_Pit6_Form(), "Report_NPTXPit6.xls");
  SetPrintMode(DL_OUTREPORT_EXCEL);
  m_XMLFile = NPTXPit6XML();
end;

IIS_CONTRACTS = SET_CHAR;
OTHER_CONTRACTS = SET_CHAR;
NPTX_Pit6_Report.Run();
Exit(1);

