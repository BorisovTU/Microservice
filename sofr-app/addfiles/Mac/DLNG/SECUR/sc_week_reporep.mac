/*                                                                                                                                                    
$Name: sc_week_reporep.mac
$Module: ÅéñÅ
$Description: é‚Á•‚Î / ê•£´†¨•≠‚®‡Æ¢†≠≠Î• / é‚Á•‚Î §´Ô „ØÆ´≠Æ¨ÆÁ•≠≠ÎÂ Ø‡•§·‚†¢®‚•´•© Åê / Ö¶•≠•§•´Ï≠Î© Æ‚Á•‚ ØÆ ·§•´™†¨ êÖèé
*/
import "sc_week_reporep_form.mac", "dldlngfun.mac", "bnk_dttmfrmt.mac", "scsrvrepfun.mac";

PRIVATE FILE TextProtocol() txt write;

PRIVATE VAR ReportHeader = 
"                                                                                 Ö¶•≠•§•´Ï≠Î© Æ‚Á•‚ ØÆ ·§•´™†¨ êÖèé\n" +
"                                                                                 #\n\n";  

private var Table =
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
"≥                         ≥                         ≥                         ≥                         ≥                         ≥      ·„¨¨†     ≥      ·„¨¨†     ≥      ·„¨¨†     ≥      ·„¨¨†     ≥\n" +
"≥                         ≥                         ≥                         ≥                         ≥                         ≥  Ø‡®¢´./‡†ß¨.  ≥  Ø‡®¢´./‡†ß¨.  ≥  Ø‡®¢´./‡†ß¨.  ≥  Ø‡®¢´./‡†ß¨.  ≥\n" +
"≥       í®Ø ·§•´™®        ≥äÆ≠‚‡†£•≠‚ ØÆ ·§•´™• êÖèé≥      Ç†´Ó‚† ·§•´™®      ≥  ç†®¨•≠Æ¢†≠®• Ì¨®‚•≠‚†  ≥      çÆ¨•‡ ·§•´™®       ≥ ·‡•§·‚¢ ≠† ≠†Á.≥ ·‡•§·‚¢ ≠† ≠†Á.≥·‡•§·‚¢ ≠† ™Æ≠•Ê≥·‡•§·‚¢ ≠† ™Æ≠•Ê≥\n" +
"≥                         ≥                         ≥                         ≥                         ≥                         ≥     Ø•‡®Æ§†    ≥     Ø•‡®Æ§†    ≥     Ø•‡®Æ§†    ≥     Ø•‡®Æ§†    ≥\n" +
"≥                         ≥                         ≥                         ≥                         ≥                         ≥   (¢ ¢†´Ó‚•)   ≥   (¢ ‡„°´ÔÂ)   ≥   (¢ ¢†´Ó‚•)   ≥   (¢ ‡„°´ÔÂ)   ≥\n" +
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n" +
"≥           1             ≥            2            ≥            3            ≥            4            ≥            5            ≥        6       ≥        7       ≥        8       ≥        9       ≥\n" +
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";


PRIVATE CONST POI_MODE = TRUE;

PRIVATE VAR WRepoRep_Form;

PRIVATE VAR m_BegDate = Date(0,0,0), 
             m_EndDate = Date(0,0,0), 
             m_DepartmentID = 0,
             IsApostr,
             IsExcel;

PRIVATE CLASS (DL_CReportTemplate) WRepoRep_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )

   PRIVATE VAR m_IsExistsData = false,
               m_RepID  = 0,
               m_Err = 0,
               m_ProtocolFileName,
               m_ProtocolFilePath;

   PRIVATE VAR m_ResBegSum = 0, m_ResBegSumRur = 0, m_ResEndSum = 0, m_ResEndSumRur = 0;
   PRIVATE VAR m_prevDealType = "", m_prevParty = "", m_prevDealCur = ""; 
               
   PRIVATE VAR m_NumStr = 30;
   PRIVATE VAR m_RS;


   /*PRIVATE MACRO PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   END;*/ 
   
   PRIVATE MACRO PrintMode():INTEGER
        if (IsExcel == SET_CHAR)
          return DL_OUTREPORT_EXCEL;
        end;
        return DL_OUTREPORT_STD;
    END;

   PRIVATE MACRO BeginReport( NumCopy:INTEGER )
      SetActiveSheet( "ã®·‚1" );
   END;
                                                                    

   PRIVATE MACRO PrintReportHead()
     PrintFormatString( ReportHeader,
                        "N0_B2",  "ß† Ø•‡®Æ§ · " + string(m_BegDate) + " ØÆ " + string(m_EndDate)
                      );
     RegisterTable( "N0_MAINTABLE", Table,
                    "N0_A1", 
                    "N0_A2", 
                    "N0_A3", 
                    "N0_A4", 
                    "N0_A5", 
                    "N0_A6", 
                    "N0_A7", 
                    "N0_A8", 
                    "N0_A9"
                     );
   END;

   PRIVATE MACRO PrintTableLine_()
      PrintTableLine( "N1_A1", m_RS.DealType, null,
                      "N1_A2", m_RS.PartyName, null, 
                      "N1_A3", m_RS.DealCur, null, 
                      "N1_A4", m_RS.IssuerName, null, 
                      "N1_A5", m_RS.DealCode, null,
                      "N1_A6", m_RS.BegDealSum, null,
                      "N1_A7", m_RS.BegDealSumRur, null,
                      "N1_A8", m_RS.EndDealSum, null,
                      "N1_A9", m_RS.EndDealSumRur, null
                    );
      m_NumStr = m_NumStr + 1;

      m_ResBegSum    = m_ResBegSum + m_RS.BegDealSum;
      m_ResBegSumRur = m_ResBegSumRur + m_RS.BegDealSumRur;
      m_ResEndSum    = m_ResEndSum + m_RS.EndDealSum;
      m_ResEndSumRur = m_ResEndSumRur + m_RS.EndDealSumRur;
   END;

   PRIVATE MACRO PrintResTableLine_()
      SetCurrentLineFont( 11, true, false, null, null, RGB(153, 255, 204) );

      PrintTableLine( "N1_A1", m_prevDealType, null,
                      "N1_A2", m_prevParty, null, 
                      "N1_A3", m_prevDealCur, null, 
                      "N1_A4", "àíéÉé:", null, 
                      "N1_A5", "", null,
                      "N1_A6", m_ResBegSum, null,
                      "N1_A7", m_ResBegSumRur, null,
                      "N1_A8", m_ResEndSum, null,
                      "N1_A9", m_ResEndSumRur, null
                    );
      m_NumStr = m_NumStr + 1;

      m_ResBegSum    = 0;
      m_ResBegSumRur = 0;
      m_ResEndSum    = 0;
      m_ResEndSumRur = 0;
   END;

   macro CreateTextProtocol()
      var sysdate, systime, errtext, errcode;
      m_ProtocolFileName = "wreporep_" + m_RepID + "_" + m_EndDate + ".txt"; 
      m_ProtocolFilePath = "..\\txtfile\\" +  m_ProtocolFileName;

      if( not Open( TextProtocol, m_ProtocolFilePath, "rsoem" ) )
         errcode = status(errtext);
         RunError( "éË®°™† Ø‡® Æ‚™‡Î‚®® ‰†©´† Ø‡Æ‚Æ™Æ´† |"+m_ProtocolFilePath+"|(" + errcode + ") " + errtext );
         return false;
      end;

      var Query = "select t_sysdate, t_systime from DDL_REPORT_REPO_DBT where t_id = " + m_RepID;
      var Select = DL_RSDCommand(Query);
      var DS = Select.Execute();
      if(DS.MoveNext())
          sysdate = DS.SysDate;
          systime = DS.SysTime;
      end;

      insert(TextProtocol, "îÆ‡¨®‡Æ¢†≠®• Æ‚Á•‚† 'Ö¶•≠•§•´Ï≠Î© Æ‚Á•‚ ØÆ ·§•´™†¨ êÖèé' (BIQ-14847)");
      insert(TextProtocol, "Ñ†‚† ¢ÎØÆ´≠•≠®Ô: " + Date(sysdate));
      insert(TextProtocol, "Ç‡•¨Ô ¢ÎØÆ´≠•≠®Ô: " + strSubst(String(Time(systime)), " ", "0"));

      insert(TextProtocol, "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø"); 


      Query = "select 1 from DWREPOREP_TMP";
 
      var Select2 = DL_RSDCommand(Query);
      var DS2 = Select2.Execute();
      if(DS2.MoveNext())
          insert(TextProtocol, "≥ 1           ≥ èÆ®·™ ·§•´Æ™ ß† Ø•‡®Æ§       ≥ ç†©§•≠Î                      ≥");
      else
          insert(TextProtocol, "≥ 1           ≥ èÆ®·™ ·§•´Æ™ ß† Ø•‡®Æ§       ≥ ç• ≠†©§•≠Î                   ≥");
      end;

      insert(TextProtocol, "¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ");

      close( TextProtocol );

      var file_name_term = "$" + SC_GetFullPath(true) + "\\week_repo_reports\\" + m_ProtocolFileName;
      if (not copyFile(m_ProtocolFileName,file_name_term,true,"äÆØ®‡Æ¢†≠®• ≠† ‚•‡¨®≠†´"))
         msgbox("éË®°™† Ø‡® ™ÆØ®‡Æ¢†≠®® " + m_ProtocolFileName + " ≠† ‚•‡¨®≠†´");
      end;

      ViewFile( TextProtocol );

      return true;
   end;

   MACRO CreateData()
      var sql, exec;
      InitProgress(-1, "îÆ‡¨®‡Æ¢†≠®• •¶•≠•§•´Ï≠Æ£Æ Æ‚Á•‚† ØÆ ·§•´™†¨ êÖèé ß† Ø•‡®Æ§ " + m_BegDate + " - " + m_EndDate);
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlwreporep.CreateData(?,?,?,?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, m_DepartmentID );
      exec.AddParam( "", RSDBP_IN, m_BegDate);
      exec.AddParam( "", RSDBP_IN, m_EndDate);
      exec.AddParam( "", RSDBP_IN, {oper});
      exec.AddParam( "RepID", RSDBP_OUT, V_INTEGER);
      exec.AddParam( "Err",   RSDBP_OUT, V_INTEGER);
      exec.execute();

      m_RepID = int(exec.value("RepID"));
      m_Err   = int(exec.value("Err"));

      RemProgress();
   END;

   MACRO PrintData()
      var query, cnt = 0;
           
      var ProgressIndicator = TProgressBar();
      var cmd = DL_RSDCommand();
      query = "select * from DWREPOREP_TMP order by t_dealtype, t_partyname, t_dealcur, t_issuername, t_dealcode";
      cnt = cmd.GetCount(query);
      if( cnt > 0 )
         ProgressIndicator.init(cnt, "ÇÎ¢Æ§ §†≠≠ÎÂ ¢ Æ‚Á•‚", "ÇÎ¢Æ§ §†≠≠ÎÂ ¢ Æ‚Á•‚");
         PrintReportHead();
         m_IsExistsData = true;
         m_RS = cmd.execute(query);
     
         while( m_RS.MoveNext() )
            if (((m_prevDealType != m_RS.DealType) and (m_prevDealType != ""))
               or ((m_prevParty != m_RS.PartyName) and (m_prevParty != ""))
               or ((m_prevDealCur != m_RS.DealCur) and (m_prevDealCur != "")))
               PrintResTableLine_();
            end;

            PrintTableLine_();

            m_prevDealType = m_RS.DealType;
            m_prevParty    = m_RS.PartyName; 
            m_prevDealCur  = m_RS.DealCur; 

            ProgressIndicator.Use;
         end;
         PrintResTableLine_();
     
         ProgressIndicator.Remove;
      end;
   END;
 
   MACRO Create()
      m_IsExistsData = false;
      SQL_Truncate( "DWREPOREP_TMP" );
      CreateData();
      PrintData();
      CreateTextProtocol();
   END;

   MACRO EndReport()
      if( m_IsExistsData )
         EndTable();
      else
         msgbox("ç•‚ §†≠≠ÎÂ §´Ô ‰Æ‡¨®‡Æ¢†≠®Ô Æ‚Á•‚†.");
      end;
   END;

   initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI );  

END;

MACRO RunReport()

  var stat = true;

  WRepoRep_Form = WRR_Panel();
   
  while(stat)
     stat = WRepoRep_Form.Run();
   
     // è‡Æ¢•‡Ô•¨ ¨Æ¶•¨ ´® ¨Î §•´†‚Ï Æ‚Á•‚ ØÆ Ø‡•§Æ·‚†¢´•≠≠Î¨ §†≠≠Î¨
     if (not stat)
        break;
     else
        m_DepartmentID  = WRepoRep_Form.GetFieldValue( PNFLD_WREPOREP_DEPARTCODE );
        m_BegDate       = WRepoRep_Form.GetFieldValue( PNFLD_WREPOREP_BEGDATE );
        m_EndDate       = WRepoRep_Form.GetFieldValue( PNFLD_WREPOREP_ENDDATE );
        IsApostr        = WRepoRep_Form.GetFieldValue( PNFLD_WREPOREP_ISAPOSTR );
        IsExcel         = WRepoRep_Form.GetFieldValue( PNFLD_WREPOREP_EXCEL );
     end;
   
     if( stat )
        var WRepoRep = WRepoRep_Report( null, "Report_WeekRepo.xlsx", null, null, null, POI_MODE );      
        WRepoRep.Run();
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
     end;
  end;

END;

RunReport();
exit(1); 