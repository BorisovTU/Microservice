/*
$Name:             ws_avoirrep.mac
$Module:           АРНУ
$Description:      WEB. АРНУ. Макрос сервиса панели "Отчет по справочнику ценных бумаг"
*/
import globals;
import rsexts;
import ws_file;
import "spissues.mac";

class CTxAvoirRep()
  var DepoServiceState  : Integer;  // Состояние ц/б на обслуживании в <Депозитарии>
  var Emissive          : Bool;     // Включать в отчет эмиссионные ц/б
  var NonEmissive       : Bool;     // Включать в отчет НЕэмиссионные ц/б
  var AvoirKindList     = TArray(); // Вид ц/б
  var IssuerList        = TArray(); // Эмитент
  var Date              : Date;     // Дата отчета
  var ToExcel           : Bool;     // Признак вывода отчета в MS Excel
end;

macro TxAvoirRepInit(
) : CTxAvoirRep // Параметры отчета
  var _FormData = CTxAvoirRep();

  _FormData.DepoServiceState  = 0;
  _FormData.Emissive          = true;
  _FormData.NonEmissive       = true;
  _FormData.AvoirKindList     = TArray();
  _FormData.IssuerList        = TArray();
  _FormData.Date              = {curdate};
  _FormData.ToExcel           = true;

  return _FormData;
end;

macro WebIsStandAlone(
):Bool
  return true;
end;

macro TxAvoirRepRun(
  FormData /*: CTxAvoirRep */ // Параметры отчета
 ,menuItem      //: WsMenuItem
) : FileContainer

   var FullReportFileNames;
   var _FormData = FormData;
   var EmissiveCode : Integer = 0;
   var IssuerCount : Integer = 0;
   var IssuerList = TArray();
   var FullReportFileName : String = "";
   var ReportFile = null;
 
   if((_FormData.Emissive == true) and (FormData.NonEmissive == true))
     EmissiveCode = 0; // Все
   elif((_FormData.Emissive == true) and (FormData.NonEmissive == false))
     EmissiveCode = 1; // Эмиссионнные
   elif((_FormData.Emissive == false) and (FormData.NonEmissive == true))
     EmissiveCode = 2; // Неэмиссионные
   end;
 
   IssuerCount = 0;
   if((_FormData.IssuerList != null) and (_FormData.IssuerList.Size > 0))
     while(IssuerCount < _FormData.IssuerList.Size)
       if((Valtype(_FormData.IssuerList[IssuerCount]) != V_UNDEF)
       and (Valtype(_FormData.IssuerList[IssuerCount].PartyID) == V_INTEGER)
       and (_FormData.IssuerList[IssuerCount].PartyID > 0))
         IssuerList[IssuerList.Size] = _FormData.IssuerList[IssuerCount].PartyID;
       end;
 
       IssuerCount = IssuerCount + 1;
     end;
   end;
 
   ReplaceMacro("isStandAlone", "WebIsStandAlone");
   FullReportFileName = issues(EmissiveCode, _FormData.AvoirKindList, IssuerList, _FormData.Date, _FormData.ToExcel, _FormData.DepoServiceState, 0/*QualifiedKind_ALL*/, true, menuItem);
   ReplaceMacro("isStandAlone", NULL);
 
   if( FullReportFileName != null )
     FullReportFileNames = CreateLargeFileContainer(FullReportFileName);
   end;

   return FullReportFileNames;
end;