/*
$Name:        conv200.mac
$Module:      Ценные бумаги
$Description: Операция конвертации ц/б. Шаг списания лота
*/
import "sp_categ.mac", "scservop.mac", "sp_carrl.mac", "sp_car.mac";

/*группа списания для операции*/
VAR    WriteOffGroups = TArray;   /*данные в массиве используются программой при выполнении шага*/      

macro ExecuteStep( doc, FDoc)
  record deal(dl_tick);
  var    FD, dat;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc( deal );/*списание*/
  GetOprDate( DATE_CONVAVR_OUT, dat );

  
  /*обработка лота и установка статуса "Поставлен"*/
  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_DELIVERY, dat, FD ) )
     msgbox("Ошибка при обновлении лота"); 
     return 1;
  end;

  if( FD.pmwrtsum.rec.State != PM_WRTSUM_FORM )
     return SayErrorBuySale( deal, "При списании лот должен иметь статус поставлен" );
  end; 

  if( ПолучитьГруппыСписания( FD, WriteOffGroups ) == false )
     return SayErrorBuySale( deal, "Ошибка при определении групп списания" );
  end;

  if(FD.tick.rec.ClientID > 0)
    WRTSetClientLot(FD.dl_leg.rec.PFI, FD.tick.rec.Department, FD.tick.rec.ClientID, FD.tick.rec.ClientContrID, -FD.dl_leg.rec.Principal, dat, true);
  end;  
  
  /*непосредственно списание (и проверка на готовность лота) выполняется программой на этом шаге*/ 
  return 0;
end;
