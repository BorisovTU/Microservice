/* Операция займа.
   Шаг "актуализации счетов для учета сделки". Вставляется из панели расчетов, первый
   шаг цепочки "Получение ц/б*/
import InsCarryDoc, "sp_class.mac", "sp_catac.mac", "sp_carrl.mac", "sp_car.mac", "sp_cars.mac";

private record SpChangeDates("spchdate.str");/*глобальная структура с данными для расчетов*/

macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);
  var     FD, 
          dat = SpChangeDates.FactDate; /*дата подписания договора*/ 

  if( SpChangeDates.Action <= 0 )
     msgbox("Шаг актуализации счетов для учета сделки из списка шагов выполнять запрещено."); 
     return 1;
  end; 

  SetBuff( deal, FDoc );
  FD = SPFirstDoc( deal );
  if( ПлатежЗакрыт( FD.pm_avoir.rec ) ) 
     msgbox("Получение ц/б уже выполнено."); 
     return 1;
  end;

  if( not IsClientDeal(FD.tick.rec) ) /*наша сделка*/
     if( (not FD.OpenAccount( "Ц/б, договор", null, null, null, null, dat ) ) OR
         (not FD.OpenAccount( "ОД", null, null, null, null, dat ))
       )
       return 1;
     end;

     if( FI_IsCouponAvoiriss( FD.fininstr ) )
        if( (not FD.OpenAccount( "-НКД, договор", null, null, null, null, dat ) ) OR
            (not FD.OpenAccount( "+%ДЦ/б", null, null, null, null, dat) ) OR
            (not FD.OpenAccount( "Реализация, ц/б", null, null, null, null, dat) ) OR
            (not FD.OpenAccount( "Реализация, ц/б", null, null, null, null, dat) )
          )
           return 1;
        end;

        if( deal.Flag3 == SET_CHAR ) /* установлен признак возврата доходов */
           if( (not FD.OpenAccount( "Прочие доходы", null, null, null, null, dat ) ) OR
               (not FD.OpenAccount( "+Маржа, ц/б", null, null, null, null, dat)) OR
               (not FD.OpenAccount( "-Маржа, ц/б", null, null, null, null, dat)) 
             )
              return 1;
           end;
        end;
     end;
  end;

  if( not OprReplanStepPlanDates( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat ) )
     msgbox("Ошибка при попытке переинициализировать дату получения ц/б." );         
     return 1;
  end;

  return 0;
end;
