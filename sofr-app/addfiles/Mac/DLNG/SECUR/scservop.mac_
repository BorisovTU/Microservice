/*                           
$Name:             scservop.mac
$Module:           Ценные бумаги
$Description:      Сервисные операции (операции сопровождения)
 PROGRAMMED BY:   Леонов И. Е.
 CREATION DATE:   27.02.02
*/
import SfInter, "spRepFun.mac", "spRepFn2.mac", "reppercm.mac", "globals.mac", "dllog_xml.mac";
import RsbDataSet;

/* Документ сервисной операции */
record ScOprServDoc( dl_comm );
/* Структура с данными о 1 строке отчета. Заполняется в макросе выполнения шага*/
var ScOpReportLineData = TArray; 
/*Признак, что выполняется сервисная операция*/
var ScOpIsServiceOper = false;
/*Число вставленных в отчет записей */
var ScOpNumInsRecord = 0; 
var ScOpLastServDocKind = -1; 
var _OprDocKind;
private CONST CALCCOST_CATEGORY  = 27;/*Возможность надежного расчета TCC*/
var SvOpLastResKind = -1;/*подвид резерва*/

/*Виды блока операции начисления дохода. Всего одна операция может вставить блоки 4 видов.*/
const INCOME_OWN_PAPERS_PD = 1;
const INCOME_OWN_PAPERS_DD = 2;
const INCOME_BACK_KA       = 3;
const INCOME_REPO          = 4;
const INCOME_OWN_PAPERS    = 5; 

/*Виды переоценки (деление условное, только для протокола).*/
const OVERVALUE_WRTOFF  = 0; /*Списание переоценки*/
const OVERVALUE_PAPERS  = 1; /*Ц/б в ТП или ППР*/
const OVERVALUE_VO      = 2; /*Ц/б в ПВО*/
const OVERVALUE_TO      = 3; /*Переоценка ТО*/
const OVERVALUE_RESTORE = 4; /*Восстановление убытка от обесценения по выпуску ц/б*/

/*номера секций отчета по операции завершения торгового дня*/
const FINALDAY_CLOSEACC  = 3; /*секция закрытых счетов*/

MACRO SvOp_AddInReport( ReportObj:OBJECT ):INTEGER
  ScOpReportLineData[ScOpReportLineData.Size] = ReportObj;
  return 0;
END;

/* Данные о выполнении операции переоценки (для отчета)*/
class SvOpOvervalue( _Kind, _ID, _Code, _Num, _Price, _PriceCcy,
                     _BalCost, _NewBalCost,
                     _DtAcc, _KtAcc, _Sum, _SumCcy, _Ground )
  var Kind        = _Kind,
      ID          = _ID, 
      Code        = _Code,
      Num         = _Num, 
      Price       = _Price,
      PriceCcy    = _PriceCcy,
      BalCost     = _BalCost, 
      NewBalCost  = _NewBalCost, 
      DtAcc       = _DtAcc, 
      KtAcc       = _KtAcc, 
      Sum         = _Sum,
      SumCcy      = _SumCcy,
      Ground      = _Ground;   
end;

/* Данные о выполнении операции начисления дохода/расхода (для отчета)*/
class SvOpIncome( _Kind, _ID, _Code, _Amount, _Point, _OldIncome, _NewIncome, _Sum, _SumCCY, _DtAcc, _KtAcc, _Ground )

  var Kind        = _Kind, 
      ID          = _ID, 
      Code        = _Code,
      Amount      = _Amount, 
      Point       = _Point, 
      OldIncome   = _OldIncome,
      NewIncome   = _NewIncome,
      Sum         = _Sum,
      SumCCY      = _SumCCY,
      DtAcc       = _DtAcc, 
      KtAcc       = _KtAcc, 
      Ground      = _Ground;   
end;

/* Данные о выполнении операции начисления дохода/расхода (для отчета)*/
class SvOp_AJOEB(_Code, _AmountSum, _CurrCorrValueSum, _PrevCorrValueSum, _Sum, _DtAcc, _KtAcc, _Ground)

  var Code             = _Code,
      AmountSum        = _AmountSum, 
      CurrCorrValueSum = _CurrCorrValueSum, 
      PrevCorrValueSum = _PrevCorrValueSum,
      Sum              = _Sum,
      DtAcc            = _DtAcc, 
      KtAcc            = _KtAcc, 
      Ground           = _Ground;   
end;

class SvOp_ACCEXPREVOEB(_Code, _Amount, _PrevSum, _CurrSum, _Sum, _DtAcc, _KtAcc, _Ground)

  var Code    = _Code,
      Amount  = _Amount, 
      PrevSum = _PrevSum,
      CurrSum = _CurrSum, 
      Sum     = _Sum,
      DtAcc   = _DtAcc, 
      KtAcc   = _KtAcc, 
      Ground  = _Ground;
end;

class SvOp_TPA(_Code, _Amount, _Type, _Sum, _DtAcc, _KtAcc, _Ground)

  var Code    = _Code,
      Amount  = _Amount, 
      Type    = _Type,
      Sum     = _Sum,
      DtAcc   = _DtAcc, 
      KtAcc   = _KtAcc, 
      Ground  = _Ground;
end;

class SvOp_CPA(_PaymSum, _Comiss, _NDS, _DtAcc, _KtAcc, _Ground)

  var PaymSum = _PaymSum,
      Comiss  = _Comiss,
      NDS     = _NDS,
      DtAcc   = _DtAcc, 
      KtAcc   = _KtAcc, 
      Ground  = _Ground;
end;

/* Данные о выполнении операции переоценки требований и обязательств (для отчета)*/
class SvOpOvervalue_RD( _Deal, _FIID, _Kind, _Summ_RD, _Summ_RD_NEW, _Curr, _Num, _Price, _DtAcc, _KtAcc, _Summa, _NKD )
  var Deal = _Deal, 
      FIID = _FIID, 
      Kind = _Kind, 
      Summ_RD = _Summ_RD,
      Summ_RD_NEW = _Summ_RD_NEW,
      Curr = _Curr,
      Num =  _Num,
      NKD = _NKD,
      Price = _Price,
      DtAcc = _DtAcc, 
      KtAcc =_KtAcc,
      Summa = _Summa;
end;

/* Данные о выполнении операции переоценки НВПИ (для отчета)*/
class SvOpOvervalue_NVPI( _Deal, _FiCode, _Kind, _SumTO, _CurTO, _DtAcc, _KtAcc, _Summa )
  var Deal   = _Deal, 
      FiCode = _FiCode,
      Kind   = _Kind, 
      SumTO  = _SumTO,
      CurTO  = _CurTO,
      DtAcc  = _DtAcc, 
      KtAcc  = _KtAcc,
      Summa  = _Summa;
end;

/* Данные о выполнении операции резервирования(для отчета)*/
class SvOpReserve( _ObjID, _ResPc, _RiskGrp,  _BaseSum, _OldReserv, _BaseAcc, _ReservAcc, _IsDealNtg, _CostRUR, _MarketSum, _IsBiVal, _GuarantSum, _ResKind, _CorrectSum,
                   _IsSetting, _ReqAcc,  _ResPcSec, _RiskGrpSec, _AccRest_BPP, _AccRest_OD )
   
  var ObjID         = _ObjID,
      ResPc         = _ResPc,
      RiskGrp       = _RiskGrp,
      BaseSum       = _BaseSum,
      OldReserv     = _OldReserv,
      BaseAcc       = _BaseAcc,
      ReservAcc     = _ReservAcc,
      IsDealNtg     = _IsDealNtg,
      CostRUR       = _CostRUR, 
      MarketSum     = _MarketSum,
      IsBiVal       = _IsBiVal,
      GuarantSum    = _GuarantSum,
      ResKind       = _ResKind,
      CorrectSum    = _CorrectSum,
      IsSetting     = _IsSetting, 
      ReqAcc        = _ReqAcc,    
      ResPcSec      = _ResPcSec,
      RiskGrpSec    = _RiskGrpSec,
      AccRest_BPP   = _AccRest_BPP,
      AccRest_OD    = _AccRest_OD; 

end;

/* Данные о выполнении операции завершение торгового дня(для отчета)*/
class SvOpCloseAccByDeal( _ClientID,     
                          _ClientContrID,    
                          _DealCode,
                          _CloseAcc 
                       )

  var Kind          = FINALDAY_CLOSEACC,/*номер секция протокола*/
      ClientID      = _ClientID, 
      ClientContrID = _ClientContrID, 
      DealCode      = _DealCode, 
      CloseAcc      = _CloseAcc; 
end;

class SvOpComiss( Contr )
  var number = Contr.number;
end;

/* Данные о выполнении операции расчета СС (для отчета)*/
class SvOpCALCTSS( _FIID, _Rate, _RateFIID, _Msg )
  var FIID     = _FIID, 
      Rate     = _Rate,
      RateFIID = _RateFIID,
      Msg      = _Msg;
end;

/* Имя файла для отчетов сервисных операций */
private var  SvOpReportName = "svoprep";
private file SvOpReportFile() txt write;

private var SvOpErrorArray = TArray();
private file   f_dl_comm( dl_comm ) key 3;

/* Данные об ошибке*/
private class SvOpError( _OpCode, _ObjCode, _NumErr, _StrErr, _ObjKind )
  var OpCode  = _OpCode, 
      ObjCode = _ObjCode, 
      NumErr  = _NumErr, 
      StrErr  = _StrErr,
      ObjKind = _ObjKind;
end;

CLASS (DL_LOG_FROM_XML) OVERVALUE_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var OvervalueData:SvOpOvervalue;

     if( m_ReportVersion == 1 )
     
        if( DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, OvervalueData.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NUM", V_DOUBLE, OvervalueData.Num) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PRICE", V_DOUBLE, OvervalueData.Price) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PRICECCY", V_STRING, OvervalueData.PriceCcy) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "BALCOST", V_MONEY, OvervalueData.BalCost) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NEWBALCOST", V_MONEY, OvervalueData.NewBalCost) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, OvervalueData.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, OvervalueData.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, OvervalueData.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMCCY", V_STRING, OvervalueData.SumCcy) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, OvervalueData.Ground) == false)
        end;
       
        return SvOpOvervalue(m_ReportNumber,
                             -1,
                             OvervalueData.Code,
                             OvervalueData.Num,
                             OvervalueData.Price,
                             OvervalueData.PriceCcy,
                             OvervalueData.BalCost,
                             OvervalueData.NewBalCost,
                             OvervalueData.DtAcc,
                             OvervalueData.KtAcc,
                             OvervalueData.Sum,
                             OvervalueData.SumCcy,
                             OvervalueData.Ground
                            );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) ACCEXPREVOEB_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_ACCEXPREVOEB;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOp.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNT", V_MONEY, SvOp.Amount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PREVSUM", V_MONEY, SvOp.PrevSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURRSUM", V_MONEY, SvOp.CurrSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOp.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_ACCEXPREVOEB(SvOp.Code,
                                 SvOp.Amount,
                                 SvOp.PrevSum,
                                 SvOp.CurrSum,
                                 SvOp.Sum,
                                 SvOp.DtAcc,
                                 SvOp.KtAcc,
                                 SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) TPA_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_TPA;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOp.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNT", V_MONEY, SvOp.Amount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "TYPE", V_STRING, SvOp.Type) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOp.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_TPA(SvOp.Code,
                        SvOp.Amount,
                        SvOp.Type,
                        SvOp.Sum,
                        SvOp.DtAcc,
                        SvOp.KtAcc,
                        SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) CPA_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_CPA;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PAYMSUM", V_MONEY, SvOp.PaymSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "COMISS", V_MONEY, SvOp.Comiss) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NDS", V_MONEY, SvOp.NDS) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_CPA(SvOp.PaymSum,
                        SvOp.Comiss,
                        SvOp.NDS,
                        SvOp.DtAcc,
                        SvOp.KtAcc,
                        SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) AJUSTVALOEB_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOp:SvOp_AJOEB;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOp.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNTSUM", V_MONEY, SvOp.AmountSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURRCORRVALUESUM", V_MONEY, SvOp.CurrCorrValueSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PREVCORRVALUESUM", V_MONEY, SvOp.PrevCorrValueSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOp.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOp.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOp.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOp.Ground) == false)
        end;
       
        return SvOp_AJOEB(SvOp.Code,
                          SvOp.AmountSum,
                          SvOp.CurrCorrValueSum,
                          SvOp.PrevCorrValueSum,
                          SvOp.Sum,
                          SvOp.DtAcc,
                          SvOp.KtAcc,
                          SvOp.Ground);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;


CLASS (DL_LOG_FROM_XML) OVERVALUE_RD_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var OvervalueData_RD:SvOpOvervalue_RD;
     
     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KIND", V_STRING, OvervalueData_RD.KIND) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEAL", V_STRING, OvervalueData_RD.Deal) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FIID", V_INTEGER, OvervalueData_RD.FIID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMM_RD", V_MONEY, OvervalueData_RD.Summ_RD) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMM_RD_NEW", V_MONEY, OvervalueData_RD.Summ_RD_NEW) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURR", V_STRING, OvervalueData_RD.Curr) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NUM", V_DOUBLE, OvervalueData_RD.Num) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "PRICE", V_DOUBLE, OvervalueData_RD.Price) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, OvervalueData_RD.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, OvervalueData_RD.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMMA", V_MONEY, OvervalueData_RD.Summa) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NKD", V_MONEY, OvervalueData_RD.NKD) == false)
        end;
       
        return SvOpOvervalue_RD(OvervalueData_RD.Deal,       
                                OvervalueData_RD.FIID,       
                                OvervalueData_RD.Kind,       
                                OvervalueData_RD.Summ_RD,    
                                OvervalueData_RD.Summ_RD_NEW,
                                OvervalueData_RD.Curr,       
                                OvervalueData_RD.Num,        
                                OvervalueData_RD.Price,      
                                OvervalueData_RD.DtAcc,      
                                OvervalueData_RD.KtAcc,      
                                OvervalueData_RD.Summa,
                                OvervalueData_RD.NKD
                               );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) OVERVALUE_NVPI_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var OvervalueData_NVPI:SvOpOvervalue_NVPI;
     
     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEAL", V_STRING, OvervalueData_NVPI.Deal) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FICODE", V_STRING, OvervalueData_NVPI.FiCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KIND", V_STRING, OvervalueData_NVPI.Kind) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMTO", V_MONEY, OvervalueData_NVPI.SumTO) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURTO", V_STRING, OvervalueData_NVPI.CurTO) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, OvervalueData_NVPI.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, OvervalueData_NVPI.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMMA", V_MONEY, OvervalueData_NVPI.Summa) == false)
        end;
       
        return SvOpOvervalue_NVPI(OvervalueData_NVPI.Deal,       
                                  OvervalueData_NVPI.FiCode,
                                  OvervalueData_NVPI.Kind,
                                  OvervalueData_NVPI.SumTO,
                                  OvervalueData_NVPI.CurTO,      
                                  OvervalueData_NVPI.DtAcc,       
                                  OvervalueData_NVPI.KtAcc,    
                                  OvervalueData_NVPI.Summa
                                 );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) GET_INCOME_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var SvOpIncomeData:SvOpIncome;
     
     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KIND", V_INTEGER, SvOpIncomeData.Kind) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CODE", V_STRING, SvOpIncomeData.Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNT", V_DOUBLE, SvOpIncomeData.Amount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "POINT", V_INTEGER, SvOpIncomeData.Point) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OLDINCOME", V_MONEY, SvOpIncomeData.OldIncome) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NEWINCOME", V_MONEY, SvOpIncomeData.NewIncome) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUM", V_MONEY, SvOpIncomeData.Sum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SUMCCY", V_STRING, SvOpIncomeData.SumCCY) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DTACC", V_STRING, SvOpIncomeData.DtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "KTACC", V_STRING, SvOpIncomeData.KtAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GROUND", V_STRING, SvOpIncomeData.Ground) == false)
        end;
       
        return SvOpIncome(SvOpIncomeData.Kind,           
                          SvOpIncomeData.ID,             
                          SvOpIncomeData.Code,            
                          SvOpIncomeData.Amount,       
                          SvOpIncomeData.Point,    
                          SvOpIncomeData.OldIncome,
                          SvOpIncomeData.NewIncome,
                          SvOpIncomeData.Sum,      
                          SvOpIncomeData.SumCCY,   
                          SvOpIncomeData.DtAcc,    
                          SvOpIncomeData.KtAcc,    
                          SvOpIncomeData.Ground   
                         );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

CLASS (DL_LOG_FROM_XML) RESERVE_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var ReserveData:SvOpReserve;

     if( m_ReportVersion == 1 )
        if( DL_ReadTagAttribut(m_child_ReportNumber, "OBJID", V_INTEGER, ReserveData.ObjID) == false)
        end;        
        if( DL_ReadTagAttribut(m_child_ReportNumber,"RESPC", V_DOUBLE, ReserveData.ResPc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RISKGRP", V_STRING, ReserveData.RiskGrp) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "BASESUM", V_MONEY, ReserveData.BaseSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OLDRESERV", V_MONEY, ReserveData.OldReserv) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "BASEACC", V_STRING, ReserveData.BaseAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RESERVACC", V_STRING, ReserveData.ReservAcc) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISDEALNTG", V_INTEGER, ReserveData.IsDealNtg) == false)
        end;        
        if(DL_ReadTagAttribut(m_child_ReportNumber, "COSTRUR", V_MONEY, ReserveData.CostRUR) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MARKETSUM", V_MONEY, ReserveData.MarketSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISBIVAL", V_INTEGER, ReserveData.IsBiVal) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "GUARANTSUM", V_MONEY, ReserveData.GuarantSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RESKIND", V_INTEGER, ReserveData.ResKind) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CORRECTSUM", V_MONEY, ReserveData.CorrectSum) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ISSETTING", V_INTEGER, ReserveData.IsSetting) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "REQACC", V_STRING, ReserveData.ReqAcc) == false)
        end;       
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RESPCSEC", V_INTEGER, ReserveData.ResPcSec) == false)
        end;         
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RISKGRPSEC", V_INTEGER, ReserveData.RiskGrpSec) == false)
        end;       
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACCREST_BPP", V_STRING, ReserveData.AccRest_BPP) == false)
        end;       
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ACCREST_OD", V_STRING, ReserveData.AccRest_OD) == false)
        end;
        

        return SvOpReserve(ReserveData.ObjID,
                           ReserveData.ResPc,
                           ReserveData.RiskGrp,
                           ReserveData.BaseSum,
                           ReserveData.OldReserv,
                           ReserveData.BaseAcc,
                           ReserveData.ReservAcc,
                           ReserveData.IsDealNtg,
                           ReserveData.CostRUR,
                           ReserveData.MarketSum,
                           ReserveData.IsBiVal,
                           ReserveData.GuarantSum,
                           ReserveData.ResKind,
                           ReserveData.CorrectSum,
                           ReserveData.IsSetting,
                           ReserveData.ReqAcc,
                           ReserveData.ResPcSec,
                           ReserveData.RiskGrpSec,
                           ReserveData.AccRest_BPP,
                           ReserveData.AccRest_OD
                          );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;


/*лог ошибок*/
CLASS (DL_LOG_FROM_XML) SC_ERROR_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var SvOpErrorData:SvOpError;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "OPCODE", V_STRING, SvOpErrorData.OpCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OBJCODE", V_STRING, SvOpErrorData.ObjCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NUMERR", V_STRING, SvOpErrorData.NumErr) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "STRERR", V_STRING, SvOpErrorData.StrErr) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "OBJKIND", V_INTEGER, SvOpErrorData.ObjKind) == false)
        end;
        
        return SvOpError(SvOpErrorData.OpCode,
                         SvOpErrorData.ObjCode,
                         SvOpErrorData.NumErr,
                         SvOpErrorData.StrErr,
                         SvOpErrorData.ObjKind);
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

/*лог ошибок СО*/
CLASS (DL_LOG_DATA_XML) SC_ERROR_LOG_DATA_XML(pDocKind:integer, pDocumentID:integer, pDataParms:TArray, pType:integer, pVersion:integer)

  PRIVATE MACRO СоздатьУзелОшибок(i)
     var УзелОшибок = null;

     if( m_Version == 1 )
        УзелОшибок = CreateElement("Property",
                                   "ObjCode", m_DataParms[i].ObjCode,
                                   "NumErr",  m_DataParms[i].NumErr,                                    
                                   "StrErr",  m_DataParms[i].StrErr,
                                   "ObjKind", m_DataParms[i].ObjKind
                                  );
     else
        УзелОшибок = CreateElement("Property");
     end;
     
     return УзелОшибок;
  END;


  initDL_LOG_DATA_XML(pDocKind, pDocumentID, pDataParms, pType, pVersion);
END;

/*лог по операции расчета ТСС*/
CLASS (DL_LOG_FROM_XML) CALCTSS_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var CALCTSSData:SvOpCALCTSS;

     if( m_ReportVersion == 1 )
     
        if( DL_ReadTagAttribut(m_child_ReportNumber, "FIID", V_INTEGER, CALCTSSData.FIID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RATE", V_DOUBLE, CALCTSSData.Rate) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "RATEFIID", V_INTEGER, CALCTSSData.RateFIID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "MSG", V_STRING, CALCTSSData.Msg) == false)
        end;

        return SvOpCALCTSS(CALCTSSData.FIID,
                           CALCTSSData.Rate,
                           CALCTSSData.RateFIID,
                           CALCTSSData.Msg
                          );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

macro ConnectBuff( b1, b2 )
  var type = ValType(b2);

  if( (type == V_DBFFILE) or (type == V_STRUC) or (type == V_GENOBJ) ) 
    copy( b1, b2 );
  else SetBuff( b1, b2); /*Для передачи из С*/
  end;
end;

macro SC_SaveErrorForReport_XML(DocumentID:integer, DocKind:integer,  RepErr, NumErr, CommCode, SvOpDoc, OprDocKind )
   
  var RepXML = "";
  var RepErrArr= TArray();
  var ObjCode = "";
  record rContr( sfcontr );
  record rParty( party );
  record dl_comm( dl_comm );
  record Avoiriss( avoiriss );
  record Deal( dl_tick );
  record ntg( dl_nett ); 
    
  if  (valtype(RepErr) == V_STRING) 
  
     if (SvOpDoc != null)
       if( OprDocKind == DLDOC_ISSUE ) /* Анкета выпуска цб */
         ConnectBuff( Avoiriss, SvOpDoc ); 
         ObjCode = GetFICode( Avoiriss.FIID ); 
       elif( OprDocKind == DL_NTGSEC ) /* неттинг */
         ConnectBuff( ntg, SvOpDoc ); 
         ObjCode = ntg.DealNumber; 
       elif( OprDocKind == DLDOC_PARTY )
         ConnectBuff( rParty, SvOpDoc ); 
         ObjCode = rParty.ShortName; 
       elif( OprDocKind == DL_STOCKCONTR )
         ConnectBuff( rContr, SvOpDoc ); 
         ObjCode = rContr.number; 
       elif( (OprDocKind == DL_SECURITYDOC) OR (OprDocKind == DL_TRUSTDOC) OR (OprDocKind == DL_RETIREMENT) OR (OprDocKind == DL_CONVAVR) )
         ConnectBuff( Deal, SvOpDoc ); 
         ObjCode = Deal.DealCode; 
       end;
     else
        ObjCode = "";
     end; 

     RepErrArr( RepErrArr.Size ) = SvOpError( CommCode, ObjCode, NumErr, RepErr, OprDocKind );
  else
    RepErrArr = RepErr;   
  end; 

  if( RepErrArr.Size > 0 )
     RepXML = SC_ERROR_LOG_DATA_XML(DocKind,DocumentID,RepErrArr,LOG_TYPE_ERROR).GetDataXML();
  end;
  
  if( RepXML != "" )
     var Header = DL_LOG_HEADER_XML(DocKind).GetHeaderXML();
                                                                                    
     DL_InsertHeaderLog(DocumentID, DocKind, {Oper}, Header);
     DL_InsertLogXMLData( DocumentID, DocKind, LOG_TYPE_ERROR, {Oper}, RepXML);
  end;

end;


/*проверим, что протокол по данной серв опции должен формироваться в ХМЛ*/
macro ServOpByXML(DocKind:integer)
  return ((DocKind == DL_OVERVALUE) or
          (DocKind == SP_AJUSTVALOEB) or
          (DocKind == DL_OVERVALUE_RD) or
          (DocKind == DL_RESERVEDOC) or 
          (DocKind == DL_OVERVALUE_NVPI) or
          (DocKind == DL_GET_INCOME) or
          (DocKind == DL_CALCTSS) or 
          (DocKind == SP_ACCEXPREVOEB) or 
          (DocKind == SP_TRANSFERPA) or
          (DocKind == SP_COMISSION_PA)
         );
end;

MACRO GetLogDataXML( DocKind:integer, DocumentID:integer, Type:integer, OnlyLastReport:bool )
   var xml_obj = null;

   if( Type == LOG_TYPE_DATA )
      if(DocKind == DL_OVERVALUE )
         xml_obj = OVERVALUE_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_AJUSTVALOEB )
         xml_obj = AJUSTVALOEB_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_ACCEXPREVOEB)
        xml_obj = ACCEXPREVOEB_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_OVERVALUE_RD)
         xml_obj = OVERVALUE_RD_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_OVERVALUE_NVPI)
         xml_obj = OVERVALUE_NVPI_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_GET_INCOME)
         xml_obj = GET_INCOME_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_RESERVEDOC)
         xml_obj = RESERVE_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == DL_CALCTSS)
         xml_obj = CALCTSS_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_TRANSFERPA)
         xml_obj = TPA_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif(DocKind == SP_COMISSION_PA)
         xml_obj = CPA_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      end;
   else
      xml_obj = SC_ERROR_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
   end;

   return xml_obj;
END;

/*Печать строки отчета сервисной операции*/
macro SvOpPrintLine( str, SayMsgBox )

  if( ScOpIsServiceOper == true )
    return insert( SvOpReportFile, StrSubst( str, "|", " " ));
  elif( SayMsgBox == true )/*отчет по операции*/
    ReplaceMacro ( "msgbox", NULL );
    msgbox( str );
    ReplaceMacro ( "msgbox", "Svop_msgbox" );
  else
    [#](StrSubst( str, "|", " " ));
  end;
  return true;
end;

private macro SvOpOvervalue_RDHead()                                                               
  SvOpPrintLine( "                                    ПЕРЕОЦЕНКА СДЕЛОК НА ВНЕБАЛАНСЕ");
  SvOpPrintLine( "┌─────────────┬───────────────────────────┬─────┬───────────────────┬──────────┬──────────────┬─────────────┬───────────────────────────┬───────────────────────────┬─────────────┬───────────────────┐");
  SvOpPrintLine( "│  Сделка     │         Выпуск ц/б        │ Вид │ Сумма тр./обяз.   │ Кол-во   │     НКД      │  Рын. цена  │        Счет Дт            │        Счет Кт            │   Сумма     │  Сумма Т/О        │");
  SvOpPrintLine( "│             │                           │ Т/О │                   │          │              │             │                           │                           │             │  после переоценки │");
  SvOpPrintLine( "├─────────────┼───────────────────────────┼─────┼───────────────────┼──────────┼──────────────┼─────────────┼───────────────────────────┼───────────────────────────┼─────────────┼───────────────────┤");
end;                                                                                                                                                                                        

private macro SvOpOvervalue_NVPIHead()                                                               
  SvOpPrintLine( "                                                         ПЕРЕОЦЕНКА НВПИ");
  SvOpPrintLine( "┌─────────────┬───────────────────────────┬─────┬───────────────────┬───────────────────────────┬───────────────────────────┬─────────────┐");
  SvOpPrintLine( "│  Сделка     │         Выпуск ц/б        │ Вид │ Сумма тр./обяз.   │        Счет Дт            │        Счет Кт            │   Сумма     │");
  SvOpPrintLine( "│             │                           │ Т/О │                   │                           │                           │             │");
  SvOpPrintLine( "├─────────────┼───────────────────────────┼─────┼───────────────────┼───────────────────────────┼───────────────────────────┼─────────────┤");
end;                                                                                                                                                                                        


private macro SvOpReservHead( ServDocKind, SubDocKind )                                                               
  var Head = "\n\n";

  if( ScOprServDoc.OperationKind == KINDRES_RCB )
     Head = Head +
"Вид резерва    : Резервы по вложениям в ценные бумаги\n" + 
"Номер операции : " + ScOprServDoc.CommCode + "      Дата расчета: " + ScOprServDoc.CommDate + "\n" +
"┌────────────────┬─────────┬──────────────────────────┬──────────────────────────┬────────┬─────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┐\n" +
"│    Выпуск ц/б  │   Вид   │     Счет расчетной базы  │        Счет резерва      │  Кат.  │ Процент │ Расчетная база, " + {CCYNatCur} + "│   Расчетная сумма  │   Ранее созданный  │Сумма корректировки,│\n" +
"│                │ резерва │                          │                          │качества│ резерва │                    │     резерва, " + string({CCYNatCur}:5) + " │     резерв, " + string({CCYNatCur}:5) + "  │         " + string({CCYNatCur}:5) +"      │";                 
  elif( ScOprServDoc.OperationKind == KINDRES_REQ )
     if( (SubDocKind != null) and (SubDocKind == KINDRES_SALEREPO2) )

        Head = Head +
"Вид резерва    : Резервы по требованиям кредитной организации по операциям с ценными бумагами (по требованиям сделок)\n" + 
"Номер операции : " + ScOprServDoc.CommCode + "      Дата расчета: " + ScOprServDoc.CommDate + "\n" +
"┌──────────────────────────────┬───────────────┬──────────────────────────┬──────────────────────────┬────────┬─────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┐\n" +
"│      Номер сделки            │   Контрагент  │        Счет резерва      │     Счет расчетной базы  │  Кат.  │ Процент │ Расчетная база, " + {CCYNatCur} +"│   Расчетная сумма  │   Ранее созданный  │Сумма корректировки,│\n" +
"│                              │               │                          │                          │качества│ резерва │                    │     резерва, " + string({CCYNatCur}:5) + " │     резерв, " + string({CCYNatCur}:5) + "  │          " + string({CCYNatCur}:5) + "     │";                 
     else

     Head = Head +
"Вид резерва    : Резервы по требованиям кредитной организации по операциям с ценными бумагами (по требованиям сделок)\n" + 
"Номер операции : " + ScOprServDoc.CommCode + "      Дата расчета: " + ScOprServDoc.CommDate + "\n" +
"┌──────────────────────────────┬───────────────┬──────────────────────────┬──────────────────────────┬────────┬─────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┐\n" +
"│      Номер сделки            │   Контрагент  │     Счет расчетной базы  │        Счет резерва      │  Кат.  │ Процент │ Расчетная база, " + {CCYNatCur} +"│   Расчетная сумма  │ Сумма обеспечения, │   Ранее созданный  │Сумма корректировки,│\n" +
"│                              │               │                          │                          │качества│ резерва │                    │     резерва, " + string({CCYNatCur}:5) + " │          " + string({CCYNatCur}:5) + "     │     резерв, " + string({CCYNatCur}:5) + "  │          " + string({CCYNatCur}:5) + "     │";                 
     end; 
  elif( ScOprServDoc.OperationKind == KINDRES_DEAL )
     Head = Head +
"Вид резерва    : Резервы по срочным сделкам\n" + 
"Номер операции : " + ScOprServDoc.CommCode + "      Дата расчета: " + ScOprServDoc.CommDate + "\n" +
"┌──────────────────────────────┬───────────────┬────────────────────┬────────────────────┬──────────────────────────┬────────┬─────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┐\n" +
"│      Номер сделки            │   Выпуск ц/б  │      Рыночная      │    Контрактная     │        Счет резерва      │  Кат.  │ Процент │ Расчетная база, " + {CCYNatCur} + "│   Расчетная сумма  │   Ранее созданный  │Сумма корректировки,│\n" +
"│                              │               │      стоимость     │     стоимость      │                          │качества│ резерва │                    │     резерва, " + string({CCYNatCur}:5) + " │     резерв, " + string({CCYNatCur}:5) + "  │          " + string({CCYNatCur}:5) + "     │";                 
  end;          

  SvOpPrintLine( Head );
end;

macro SvOpPrintHeadCalcTSS( DlComm )

  SvOpPrintLine( "ОПЕРАЦИЯ РАСЧЕТА ТЕКУЩЕЙ СПРАВЕДЛИВОЙ СТОИМОСТИ Ц/Б" );
  SvOpPrintLine( "Номер операции : " + DlComm.CommCode + "   Дата расчета: " + DlComm.CommDate );
  SvOpPrintLine( "┌─────────────────┬──────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐" );
  SvOpPrintLine( "│    Выпуск ц/б   │    Рассчитанная сумма    │    Сообщение                                                                                                                                                                                                                                             │" );
  SvOpPrintLine( "│                 │  справедливой стоимости  │                                                                                                                                                                                                                                                          │" );
  SvOpPrintLine( "├─────────────────┼──────────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤" );

end;

/*Заголовок отчета о сервисной операции*/
macro SvOpPrintHead( DlComm, SubDocKind )
  if( DlComm.DocKind == BofficeKindCOMM )
    SvOpProcessPeriodComm_PrintHead( SvOpReportFile, ScOpIsServiceOper );
  elif( DlComm.DocKind == DL_RESERVEDOC )
    SvOpReservHead(DlComm.DocKind, SubDocKind);
  elif( DlComm.DocKind == DL_OVERVALUE_RD) 
    SvOpOvervalue_RDHead();
  elif( DlComm.DocKind == DL_OVERVALUE_NVPI) 
    SvOpOvervalue_NVPIHead();
  elif( DlComm.DocKind == DL_CALCTSS) 
    SvOpPrintHeadCalcTSS(DlComm);
  end;
end;

private file mes ("bank.msg");

private macro GetMsgFromFile( Number )
   mes.Number = Number;
   if (GetEQ(mes))
      return mes.Contents;
   else
      return "Сообщение №";
   end;
end;

macro ClearErrorArr()
  SvOpErrorArray.Size = 0;
end;        

macro InsertErrorLog_XML(DocumentID, DocKind)
  if (SvOpErrorArray.Size>0)
    SC_SaveErrorForReport_XML( DocumentID, DocKind,  SvOpErrorArray);
  end;
end;
 
/*Запомнить ошибку
  OprDocKind - вид первичного документа
  SvOpServDoc - Документ сервисной операции 
  SvOpDoc - Первичный документ
  Num, StrErr - номер и строка ошибки*/
macro ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, Num, StrErr )

  record rContr( sfcontr );
  record rParty( party );
  record dl_comm( dl_comm );
  record Avoiriss( avoiriss );
  record Deal( dl_tick );
  record ntg( dl_nett );

  var ObjCode = "";

  if( ScOpIsServiceOper == true )
     ConnectBuff(dl_comm, SvOpServDoc);

     if( SvOpDoc != null )
        if( (OprDocKind == DLDOC_ISSUE) OR ((dl_comm.OperationKind == KINDRES_RCB) and (OprDocKind == DL_RESERVEDOC) ) ) /* Анкета выпуска цб */
          ConnectBuff( Avoiriss, SvOpDoc );
          ObjCode = GetFICode( Avoiriss.FIID );
        elif( OprDocKind == DL_NTGSEC ) /* неттинг */
          ConnectBuff( ntg, SvOpDoc );
          ObjCode = ntg.DealNumber;
        elif( OprDocKind == DLDOC_PARTY )
          ConnectBuff( rParty, SvOpDoc );
          ObjCode = rParty.ShortName;
        elif( OprDocKind == DL_STOCKCONTR )
          ConnectBuff( rContr, SvOpDoc );
          ObjCode = rContr.number;
        elif( (OprDocKind == DL_SECURITYDOC) OR (OprDocKind == DL_TRUSTDOC) OR (OprDocKind == DL_RETIREMENT) OR (OprDocKind == DL_CONVAVR)
              OR ((dl_comm.OperationKind == KINDRES_REQ) and (OprDocKind == DL_RESERVEDOC)) )
          ConnectBuff( Deal, SvOpDoc );
          ObjCode = Deal.DealCode;
        end;
     else
        ObjCode = "";
     end;
  end;

  if( (ScOpIsServiceOper == true) AND (isOprMultiExec() == true) )
     if( (StrErr == null) or (StrErr == "") )
        if( Num <= 1 )
           StrErr = "Ошибка при выполнении шага.";
        else
           StrErr = GetMsgFromFile( num );
        end;
     end;

     SvOpErrorArray( SvOpErrorArray.Size ) = SvOpError( dl_comm.CommCode, ObjCode, Num, StrErr, OprDocKind );

  elif( StrErr != "" )
     SvOpErrorArray( SvOpErrorArray.Size ) = SvOpError( dl_comm.CommCode, ObjCode, Num, StrErr, OprDocKind );
     if( isOprMultiExec() == true )
       SvOpPrintLine( StrErr, true ); 
     else
       if( Num > 1 )
          MsgBoxEx( StrErr, 0, 0, "Сообщение " + string(Num) ); 
       else

          if( (( SvOpServDoc.OperationKind == KINDRES_RCB ) AND ( SvOpServDoc.FIID != 0 )) OR
              ((SvOpServDoc.OperationKind == KINDRES_DEAL ) AND ( SvOpServDoc.ContractID != 0)) OR
              ((dl_comm.OperationKind == KINDRES_REQ) and ((OprDocKind == DL_RESERVEDOC)or(OprDocKind == DL_SECURITYDOC))) OR
              ((dl_comm.DocKind == DL_OVERVALUE) AND (OprDocKind == DLDOC_ISSUE)) OR
              (dl_comm.DocKind == DL_CALCTSS) 
            )
            ReplaceMacro ( "msgbox", NULL );
          end;

          msgbox( StrErr );
       end;
     end;
  end;  

  return 0;
end;

/*На эту ф-ю заменяем msgbox при печати протокола с ошибками. См. 91025.*/
macro Svop_msgbox(StrErr)
   record oprstep(oprstep);
   record r_oproper(oproper);
   var FDoc;
   var oproper = TBFile("oproper", "r");

   if( (ScOprServDoc.DocKind == DL_CALCTSS) OR (NOT StepInfoEx(null, oprstep )) )
      ScOpInsertError( _OprDocKind, ScOprServDoc, null, 1, StrErr );
   else
      oproper.Clear();
      oproper.rec.ID_Operation = oprstep.ID_Operation;

      if( not oproper.GetEQ() )
         ScOpInsertError( _OprDocKind, ScOprServDoc, null, 1, StrErr );
      else

         if( ScOprServDoc.DocKind == BofficeKindCOMM ) /*комисси*/
            FDoc = TRecHandler("sfcontr");

         elif( ScOprServDoc.DocKind == DL_RESERVEDOC ) /* резерв */
            if( _OprDocKind == DLDOC_ISSUE )
               FDoc = TRecHandler("avoiriss");

            elif( _OprDocKind == DL_NTGSEC )
               FDoc = TRecHandler("dl_nett");

            elif( _OprDocKind == DL_SECURITYDOC )
               FDoc = TRecHandler("dl_tick");

            elif( _OprDocKind == DLDOC_PARTY )
               FDoc = TRecHandler("party");
            end;

         elif( (ScOprServDoc.DocKind == DL_OVERVALUE) or 
               (ScOprServDoc.DocKind == DL_GET_INCOME) 
             ) /* переоценка или начисление ПДД*/
            if( _OprDocKind == DLDOC_ISSUE )
               FDoc = TRecHandler("avoiriss");
            else
               FDoc = TRecHandler("dl_tick");
            end;
         elif( ScOprServDoc.DocKind == DL_OVERVALUE_RD ) /*переоценка требований и обязательств*/
            FDoc = TRecHandler("dl_tick");
         elif( ScOprServDoc.DocKind == DL_OVERVALUE_NVPI ) /*переоценка НВПИ*/
            /*Неттинг учтен в сишнике, при вставке цепочки*/
            FDoc = TRecHandler("dl_tick");
         elif (ScOprServDoc.DocKind == SP_ACCEXPREVOEB)
           FDoc = TRecHandler("dl_comm");
         elif (ScOprServDoc.DocKind == SP_AJUSTVALOEB)
           FDoc = TRecHandler("dl_comm");
         elif (ScOprServDoc.DocKind == SP_TRANSFERPA)
           FDoc = TRecHandler("dl_comm");
         elif (ScOprServDoc.DocKind == SP_COMISSION_PA)
           FDoc = TRecHandler("dl_comm");
         end; 

         if( ПолучитьПервичныйДокументСервОпер(oproper, FDoc) == 0 )

            ScOpInsertError( _OprDocKind, ScOprServDoc, FDoc, 1, StrErr );
         end;
      end;
   end;
end;

/*Должна использоваться при сообщении о ошибках на всех шагах закрытия сделок,
  которые выполняются из сервисных операций
IsErrorArray - признак того, что нам передали массив ошибок error
*/
macro SayErrorBuySale( deal, error:variant, IsErrorArray:bool )
   var i;
   record tick( dl_tick ); 
   if( error != "" )
      if( ScOpIsServiceOper )
         copy( tick, deal );
         if( IsErrorArray and (IsErrorArray == true) )
            i = 0;
            while( i < error.Size() )
               ScOpInsertError( tick.BofficeKind, ScOprServDoc, deal, 1, error.(i) );
               i = i + 1;
            end;
         else
            ScOpInsertError( tick.BofficeKind, ScOprServDoc, deal, 1, error );
         end;
      else
         if( IsErrorArray and (IsErrorArray == true) )
            msgbox( error.(0) );
         else
            msgbox( error );
         end;
      end;
   end;
   return 1;
end;

/*сохраним данные о закрытых счетах по сделке*/
macro SaveDataCloseAccArray( deal, CloseAccArray:DL_AccCollector )
   var i = 0;
   var CloseTradeDayArr = TArray();

   if( (CloseAccArray.Size() > 0) and ScOpIsServiceOper and (ScOprServDoc.DocKind == DL_FINALTRADEDAY) )             
      CloseTradeDayArr.Size() = 0;
      while( i < CloseAccArray.Size() )
         CloseTradeDayArr[CloseTradeDayArr.Size()] = SvOpCloseAccByDeal(deal.ClientID,
                                                                        deal.ClientContrID,
                                                                        deal.DealCode,
                                                                        CloseAccArray.(i).Account
                                                                       );
         i = i + 1;
      end;
      DL_SaveDataForReport_XML(ScOprServDoc.DocumentID, ScOprServDoc.DocKind, CloseTradeDayArr, LOG_TYPE_DATA);
   end;
end;

/* Определить счета +/-Расчеты для субъекта, по которым нужно выполнять 
   резервирование по средствам на расчетных счетах (РСРС).
   Счета из  mcaccdoc, такие что
      · IsCommon == YES
      · Contractor -равен субъекту
      · категории  "+Расчеты" (точно)  по шаблону, относящемуся к параметру БОКу= БО Ц/Б
   Выборка должна возвращать Account, Chapter, Currency*/
MACRO СчетаРСРС_Расчеты( PartyID:INTEGER, Categ:STRING )
   return
      " SELECT accdoc.t_Account, accdoc.t_Chapter, accdoc.t_Currency " +
      " FROM   dmccateg_dbt categ, dmcaccdoc_dbt accdoc, dmctempl_dbt templ" +
      " WHERE " +  
           "categ.t_LevelType = 1                        AND " +/*категории (не группы)*/
           "categ.t_Code      ='"+ Categ            + "' AND " +
           "templ.t_CatID     = categ.t_ID               AND " +
           "templ.t_Value1    = 5                        AND " +/*строго БОЦБ*/
           "templ.t_IsClose   = CHR(0)                   AND " +
           "accdoc.t_IsCommon   = 'X'                    AND " +
           "accdoc.t_CatID      = categ.t_ID             AND " +
           "accdoc.t_Contractor =" + string(PartyID) + " AND " +
           "accdoc.t_TemplNum   = templ.t_Number"    ;
END;

/* Определить счета брокера, по которым нужно выполнять 
   резервирование по средствам на расчетных счетах (РСРС).
   Обрабатываются счета из СПИ по договорам нашего банка с брокерами, б/с - 30602 
   Выборка должна возвращать Account, Chapter, Currency*/
MACRO СчетаРСРС_Брокер( PartyID:INTEGER )
   return
      " SELECT settacc.t_Account, settacc.t_Chapter, settacc.t_FIID " +
      " FROM   dsfcontr_dbt sfcontr, dsfssi_dbt sfssi, dsettacc_dbt settacc " +
      " WHERE " +  
           "sfcontr.t_ContractorID = " + string(PartyID) + " AND " +
           "sfcontr.t_partyID      = " + string({OurBank}) + " AND " +
           "sfssi.t_ObjectID    = LPAD(sfcontr.t_Id,10,'0')  AND " +
           "sfssi.t_ObjectType  = 659                        AND " +
           "settacc.t_SettAccID = sfssi.t_SetAccID           AND " +
           "(" + ConvertMaskToSQLFormat( "30602*", "settacc.t_Account") + ")";
END;

/* Определить счета комиссий брокеру, по которым нужно выполнять 
   резервирование по средствам на расчетных счетах (РСРС).
   Обрабатываются счета из СПИ комиссий, навешенных на договора обслуживания нашего 
   банка с брокерами б/с - 47423.
   Выборка должна возвращать Account, Chapter, Currency*/
MACRO СчетаРСРС_КомиссииБрокеру( PartyID:INTEGER )
   return 
      " SELECT settacc.t_Account, settacc.t_Chapter, settacc.t_FIID " +
      " FROM   dsfcontr_dbt sfcontr, dsfssi_dbt sfssi, dsfconcom_dbt concom, dsfcomiss_dbt comiss, dsettacc_dbt settacc" +
      " WHERE " +  
           "sfcontr.t_ContractorID = " + string(PartyID) + " AND " + /*Договор с брокером*/
           "sfcontr.t_partyID      = " + string({OurBank}) + " AND " +
           "concom.t_ObjectID = sfcontr.t_Id                   AND " + /*Комиссия, навешенная на договор*/
           "comiss.t_feeType = concom.t_feeType              AND " +
           "comiss.t_number  = concom.t_commNumber           AND " +
                            
           "sfssi.t_ObjectID    = LPAD(comiss.t_feeType,5,'0') || LPAD(comiss.t_number,5,'0')  AND " + 
           "sfssi.t_ObjectType  = 650                        AND " + /*СПИ, навешенная на комиссии */

           "settacc.t_SettAccID = sfssi.t_SetAccID           AND " + /*Параметры СПИ*/
           "(" + ConvertMaskToSQLFormat( "47423*", "settacc.t_Account") + ")";
END;

/* Определить, что для субъекта есть счета, по которым нужно выполнять резерв
   "РСРС - По средствам на расчетных счетах"*/
private macro ЕстьСчетаДляРСРС( PartyID:INTEGER, OprDocKind, SvOpServDoc, SvOpDoc )
   var rs, Error;

   rs = ExecuteSQLCommand( СчетаРСРС_Расчеты( PartyID, "+Расчеты" ), "Определение счетов по категории \"+Расчеты\" для резервирования.", @Error );
   if( rs == NULL )
      ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, 1, Error );
      return false; /*Ошибка при выполнении запроса*/
   elif( rs.moveNext() )
      return true;  /*Есть счета для резерва*/
   end;

   rs = ExecuteSQLCommand( СчетаРСРС_Брокер( PartyID ), "Определение счетов брокера для резервирования.", @Error );
   if( rs == NULL )
      ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, 1, Error );
      return false; /*Ошибка при выполнении запроса*/
   elif( rs.moveNext() )
      return true;  /*Есть счета для резерва*/
   end;

   rs = ExecuteSQLCommand( СчетаРСРС_КомиссииБрокеру( PartyID ), "Определение счетов комиссий брокеру для резервирования.", @Error );
   if( rs == NULL )
      ScOpInsertError( OprDocKind, SvOpServDoc, SvOpDoc, 1, Error );
      return false; /*Ошибка при выполнении запроса*/
   elif( rs.moveNext() )
      return true;  /*Есть счета для резерва*/
   end;

   return false; /* Нет подходящих счетов*/
end;

private macro CheckExistByCreateDeal(dl_comm, Avoiriss)
   var Query, QueryS, DataSet;

   QueryS = " Select d.t_DealID as DealID " +
            "   From ddl_tick_dbt d " + 
            "  Where d.t_ClientID = -1 " +
            "  and d.t_PortfolioID in(" + string(KINDPORT_TRADE) + "," + string(KINDPORT_SALE) + "," + string(KINDPORT_BACK) + ")";

   QueryS = QueryS + " and d.t_DealDate    = ? " +
                     " and (exists ( " + 
                                     " Select l.t_DealID " + 
                                     "   From ddl_leg_dbt l " + 
                                     "  Where  l.t_DealID  = d.t_DealID " +
                                     "    and (l.t_LegKind = " + string(LEG_KIND_DL_TICK) +
                                     "    or   l.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK) + " ) " +
                                     "    and  l.t_PFI     = ? " +
                                 " ) or " +
                          " exists ( " + 
                                     " Select ens.t_DealID " + 
                                     "   From ddl_tick_ens_dbt ens " + 
                                     "  Where ens.t_DealID = d.t_DealID " +
                                     "    and ens.t_FIID   = ? " +
                                 " ) ) ";

   Query = RSDCommand(QueryS);
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext()  )
      return true;
   end; 
   return false;
end;

private macro CheckExistBySetAvoir(dl_comm, Avoiriss)
   var Query, QueryS, DataSet;

   QueryS = " Select d.t_DealID as DealID " + 
            "   From ddl_tick_dbt d " + 
            "  Where d.t_ClientID = -1 " +
            "  and d.t_PortfolioID in(" + string(KINDPORT_TRADE) + "," + string(KINDPORT_SALE) + "," + string(KINDPORT_BACK) + ")";

   QueryS = QueryS +  " and exists ( " + 
                                     " Select rq.t_ID " + 
                                     "   From ddlrq_dbt rq " + 
                                     "  Where rq.t_DocID     = d.t_DealID " +
                                     "    and rq.t_DocKind   = d.t_BofficeKind " +
                                     "    and rq.t_Type      = " + string(DLRQ_TYPE_DELIVERY) +
                                     "    and rq.t_FIID      = ? " +
                                     "    and rq.t_FactDate  = ? " +
                                     "    and (rq.t_State    = " + string(DLRQ_STATE_EXEC) +
                                     "         or rq.t_State = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                                " ) ";

   Query = RSDCommand(QueryS);
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext()  )
      return true;
   end;     
   return false;
end;

/*проверяем поставки для операции ПДД*/
private macro CheckExistBySetAvoir_Inc(dl_comm, Avoiriss)
   var Query, DataSet;
   /*проверим, были ли за дату операции поставки по сделкам, погашения цб/К/ЧП*/
   Query = RSDCommand( " Select count(1) NRec " + 
                       "   From ddlrq_dbt rq, ddl_tick_dbt d " + 
                       "  Where rq.t_Type      = " + string(DLRQ_TYPE_DELIVERY) + 
                       "    and rq.t_FIID      = ? " +
                       "    and rq.t_FactDate  = ? " +
                       "    and (rq.t_State    = " + string( DLRQ_STATE_EXEC) +
                       "         or rq.t_State = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                       "    and rq.t_DocID     = d.t_DealID " + 
                       "    and rq.t_DocKind   = d.t_BofficeKind " +
                       "    and d.t_ClientID   = -1 "); 

   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext() )
      if( DataSet.NRec > 0 )
         return true;
      end;
   end;
 
   /*проверим, были ли за дату операции операции изменения номинала*/
   Query  = RSDCommand( " select count(1) NRec " +           
                        "  from v_scwrthistex v, ddl_comm_dbt comm, doproper_dbt opr " +
                        " where comm.T_DocKind = ? " +
                        "   and opr.T_ID_OPERATION = v.T_ID_OPERATION " +
                        "   and ltrim(opr.T_DocumentID) = comm.T_DOCUMENTID " +
                        "   and opr.T_DocKind = comm.T_DocKind " +
                        "   and v.T_Buy_Sale = ? " +
                        "   and v.T_FIID = ? " +
                        "   and v.T_ChangeDate = ? " +
                        "   and v.t_state = ? " +
                        "   and v.t_Party = -1 "
                      );

   Query.addParam( "", RSDBP_IN, DL_CHGAVRNOM );
   Query.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );

   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext() )
      if( DataSet.NRec > 0 )
         return true;
      end;
   end;
                                        
   /*проверим, были ли за дату операции ГО*/
   query = RSDCommand( " select count(1) NRec " +           
                       "  from v_scwrthistex v " +
                       " where v.T_DocKind = ? " +
                       "   and ((v.T_KIND = 120 and v.T_ACTION = 10) or (v.T_KIND = 130 and v.T_ACTION = 422)) " + 
                       "   and v.T_ChangeDate = ? " +
                       "   and v.T_FIID = ? " +
                       "   and v.t_state = ? " +
                       "   and v.t_Party = -1 "
                     );

   query.addParam( "", RSDBP_IN, DL_ISSUE_UNION );
   query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   query.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );
   Query.execute();

   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext() )
      if( DataSet.NRec > 0 )
         return true;
      end;
   end;

   return false;
end;

private macro CheckExistByPaymMoney(dl_comm, Avoiriss)
   var Query, QueryS, DataSet;

   QueryS = " Select d.t_DealID as DealID " + 
           "   From ddl_tick_dbt d " + 
            "  Where d.t_ClientID    = -1 " +
            "  and d.t_PortfolioID in(" + string(KINDPORT_TRADE) + "," + string(KINDPORT_SALE) + "," + string(KINDPORT_BACK) + ")";

   QueryS = QueryS + " and (exists ( " + 
                                     " Select l.t_DealID, rq.t_DocID " + 
                                     "   From ddl_leg_dbt l, ddlrq_dbt rq " +
                                     "  Where l.t_DealID   = d.t_DealID " +
                                     "    and rq.t_DocID   = d.t_DealID " +
                                     "    and rq.t_DocKind = d.t_BofficeKind " +
                                     "    and ((    l.t_LegKind = " + string(LEG_KIND_DL_TICK) +
                                     "          and ( rq.t_Type = " + string(DLRQ_TYPE_PAYMENT) + " AND rq.t_DealPArt = 1 ) " +
                                     "         ) or " +
                                     "         (    l.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK) +
                                     "          and rq.t_Type = " + string(DLRQ_TYPE_PAYMENT) + " AND rq.t_DealPArt = 2 ) " +
                                     "        ) " +
                                     "    and l.t_PFI           = ? " +
                                     "    and rq.t_FactDate     = ? " +
                                     "    and (rq.t_State = " + string(DLRQ_STATE_EXEC) +
                                     "      or rq.t_State = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                                     " ) or " + 
                          " exists ( " + 
                                     " Select ens.t_DealID, rq.t_DocID " + 
                                     "   From ddl_tick_ens_dbt ens, ddlrq_dbt rq " +
                                     "  Where ens.t_DealID = d.t_DealID " +
                                     "    and rq.t_DocID   = d.t_DealID " +
                                     "    and rq.t_DocKind = d.t_BofficeKind " +
                                     "    and ens.t_FIID   = ? " +
                                     "    and rq.t_FactDate = ? " +
                                     "    and (rq.t_State   = " + string(DLRQ_STATE_EXEC) +
                                     "      or rq.t_State   = " + string(DLRQ_STATE_GO_CLOSE) + " ) " +
                                     " ) ) "; 

   Query = RSDCommand(QueryS);
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.addParam( "", RSDBP_IN, Avoiriss.FIID );
   Query.addParam( "", RSDBP_IN, dl_comm.CommDate );
   Query.execute();
   DataSet = TRsbDataSet( Query );
   if( DataSet.MoveNext()  )
      return true;
   end;
   return false;
end;

private macro ПроверитьНаличиеРелевантныхЛотовДляПереоценкиТО( dl_comm, FIID ) 
  var RSD;
  var cmd = RSDCommand("select L.t_SumID" +
                       "  from dpmwrtsum_dbt L" +
                       " where     L.t_Department = ?" +
                       "       and L.t_Party = -1" +
                       "       and L.t_Contract = 0" +
                       "       and L.t_Buy_Sale in (" + PM_WRITEOFF_SUM_BUY + "," + PM_WRITEOFF_SUM_SALE + ")" +
                       "       and L.t_EnterDate <= ?" +
                       "       and L.t_FIID = ?" +
                       "       and L.t_AmountBD > 0" +
                       "       and L.t_State = " + PM_WRTSUM_NOTFORM +
                       iif(dl_comm.Flag6 == SET_CHAR,
                       "       and L.t_Date = ? ",
                       "       and L.t_Date >= ?" )
                      );
   cmd.addParam("", RSDBP_IN, dl_comm.Division);
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.addParam("", RSDBP_IN, FIID);
   if( dl_comm.Flag6 == SET_CHAR )
      cmd.addParam("", RSDBP_IN, GetDateAfterWorkDays(dl_comm.CommDate, 1) );
   else
      cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   end;
   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
      return true;
   end;
    
   cmd = RSDCommand("select L.t_SumID" +
                    "  from dpmwrtsum_dbt L, dpmwrtbc_dbt B" +
                    " where     L.t_Department = ?" +
                    "       and L.t_Party = -1" +
                    "       and L.t_Contract = 0" +
                    "       and L.t_Buy_Sale in (" + PM_WRITEOFF_SUM_BUY + "," + PM_WRITEOFF_SUM_SALE + ")" +
                    "       and L.t_EnterDate <= ?" +
                    "       and L.t_ChangeDate >= ?" +
                    "       and B.t_FIID = ?" +
                    "       and B.t_SumID = L.t_SumID" +
                    "       and B.t_AmountBD > 0" +
                    "       and B.t_State = " + PM_WRTSUM_NOTFORM +
                    iif(ScOprServDoc.Flag6 == SET_CHAR, 
                    "       and B.t_Date = ? ",
                    "       and B.t_Date >= ?" ) +
                    "       and B.t_Instance = (select MAX(M.t_Instance) " +
                    "                             from dpmwrtbc_dbt M" +
                    "                            where     M.t_SumID = L.t_SumID" +
                    "                                  and M.t_ChangeDate <= ? )");

   cmd.addParam("", RSDBP_IN, dl_comm.Division);
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.addParam("", RSDBP_IN, FIID);
   if( dl_comm.Flag6 == SET_CHAR )
      cmd.addParam("", RSDBP_IN, GetDateAfterWorkDays(dl_comm.CommDate, 1) );
   else
      cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   end;
   cmd.addParam("", RSDBP_IN, dl_comm.CommDate);
   cmd.execute();

   RSD = TRsbDataSet(cmd);

   if( RSD.MoveNext() )
      return true;
   end;

   return false;
end;

macro WRTGetSaleOvervalue( Department, FIID, Party, Contract, Portfolio, CalcDate, _OverAmount)
   var Amount, OverAmount;
   var cmd;

   cmd = RsdCommand("begin\n RSB_PMWRTOFF.WRTGetSaleOvervalue(?,?,?,?,?,?,?,?);\n end; ");

   cmd.addParam("p_Department", RSDBP_IN,     Department );
   cmd.addParam("p_FIID",       RSDBP_IN,     FIID       );
   cmd.addParam("p_Party",      RSDBP_IN,     Party      );
   cmd.addParam("p_Contract",   RSDBP_IN,     Contract   );
   cmd.addParam("p_Portfolio",  RSDBP_IN,     Portfolio  );
   cmd.addParam("p_CalcDate",   RSDBP_IN,     CalcDate   );
   cmd.addParam("p_Amount",     RSDBP_OUT,    V_DOUBLE   );
   cmd.addParam("p_OverAmount", RSDBP_OUT,    V_DOUBLE   );
   cmd.execute();

   SetParm(6, cmd.value(7));

   return cmd.value(6);
end;

macro GetCourse_OVERVALUE_RD(FIID, ToFIID, CommDate, DblAmount, MarketID, CentrOffice, _Exist:Bool, _SinceDate:date)
  var Course = 0.0, SinceDate, Exist = false, sql, rsd, RateDef_FIID;

  /*Получим курс "Рыночная стоимость" в валюте номинала*/
  if( SmartConvertSumDbl( Course, DblAmount, CommDate, 
                          FIID, ToFIID, false, 
                          ПолучитьВидКурса(SP_RATETYPE_MarketCost), SinceDate, MarketID, CentrOffice ) == false 
    )
      if( SmartConvertSumDbl( Course, DblAmount, CommDate, 
                              FIID, ToFIID, false, 
                              /*ПолучитьВидКурса(23)*/23, SinceDate, MarketID, CentrOffice ) == false 
        )

            /*Нет курса бумаги к валюте номинала, поищем в других валютах*/
            sql = RSDCommand(" SELECT t_FIID "
                           + "   FROM dratedef_dbt "
                           + "  WHERE t_OtherFI = ? "
                           + "    AND t_Type = ? "
                           + "  ORDER BY t_IsDominant DESC "); /* первым будет основной */

            sql.addParam( "", RSDBP_IN, FIID );
            sql.addParam( "", RSDBP_IN, ПолучитьВидКурса(SP_RATETYPE_MarketCost) );
            sql.execute();

            rsd = TRsbDataSet(sql);
            while( rsd.MoveNext() and (Exist == false) )
               RateDef_FIID = rsd.FIID;

               /*Нет курса бумаги к валюте номинала, но возможно, что есть курс бумаги к RateDef_FIID*/
               if( SmartConvertSumDbl( Course, DblAmount, CommDate, 
                                       FIID, RateDef_FIID, false, 
                                       ПолучитьВидКурса(SP_RATETYPE_MarketCost), SinceDate, MarketID, CentrOffice ) == false 
                 )
                  /*Не нашли рыночный курс в RateDef_FIID на дату операции*/
                  Exist = false;
               else
                  /*курс "Рыночная стоимость" нужен в валюте номинала*/
                  if( SmartConvertSumDbl( Course, Course, CommDate, 
                                          RateDef_FIID, ToFIID, true ) == false 
                    )
                     Exist = false;
                  else
                     Exist = true;
                  end;
               end;
            end;
      else
         Exist = true;
      end;
  else
     Exist = true;
  end;

  SetParm(6, Exist);
  SetParm(7, SinceDate);
  return Course;
end;


/*Ц/б сделки имеет рыночные котировки (есть курс из настройки "рыночная цена")  
  за эту или предуд. дату  и он не равен 0, или ц/б котируемая (на дату)*/
macro MacroCheckAvr_OVERVALUE_RD(fininstr:TRecHandler, CommDate:date, _need_overvalue:Bool)
  var Course = 0.0, need_overvalue = false;

  Course = GetCourse_OVERVALUE_RD(fininstr.rec.FIID, fininstr.rec.FaceValueFI, CommDate, 1.0, null, null, need_overvalue);

  if (Course == 0.0)
     need_overvalue = false;
  end;

  SetParm(2, need_overvalue);
end;

MACRO ОстатокВПортфеле( dl_comm, KindPortf:INTEGER, FIID:INTEGER, Delivered:BOOL, WithoutAccept:BOOL, ReservAmount:@MONEY, IncomeReserv:@MONEY ):MONEY
  VAR wrtcalc = TRecHandler( "pmwrtsum.dbt" );

  if( WRT_Calc( dl_comm.Division, FIID, -1, 0, KindPortf, dl_comm.CommDate, wrtcalc, Delivered, WithoutAccept ) == true) 
     ReservAmount = wrtcalc.rec.ReservAmount;
     IncomeReserv = wrtcalc.rec.IncomeReserv;
     return wrtcalc.rec.Amount;
  end;
  return $0;
END;

private macro CheckExistOvervalue( FinInstr, OperDate:DATE ):BOOL

  VAR DS, cmd, 
      ExistsOvervl = false, 
      DocumentID = UniID( FinInstr, 0, DLDOC_ISSUE );

  cmd = RSDCommand( " SELECT count(1) as ExistsOvervl "+
                    " FROM DOPRSTEP_DBT oprstep, DOPROPER_DBT oproper, DDL_COMM_DBT comm "+
                    " WHERE     oproper.t_DocKind=5"+
                    "       AND oproper.t_DocumentID = ? "+
                    "       AND oprstep.t_ID_operation=oproper.t_ID_operation"+
                    "       AND oprstep.t_IsExecute='X'"+
                    "       AND oprstep.t_ServDocKind=108"+
                    "       AND oprstep.t_ServDocKind=comm.t_DocKind"+
                    "       AND oprstep.t_ServDocID=comm.t_DocumentID"+
                    "       AND comm.t_CommDate >= ?"
                  );
  cmd.addParam( "", RSDBP_IN, DocumentID );  
  cmd.addParam( "", RSDBP_IN, OperDate );  
  cmd.execute();
  DS = TRsbDataSet( cmd );
  if( DS.MoveNext() AND (DS.ExistsOvervl > 0) )
     ExistsOvervl = true;
  end;
  return ExistsOvervl;  
end;

private macro CheckOvervalueTPlus( Depart, FinInstr, OperDate:DATE ):BOOL
  VAR DS, cmd, 
      ExistsOvervl = false;

  cmd = RSDCommand( " SELECT count(1) as ExistsOvervlTPlus " +                      
                    " FROM DDL_TICK_DBT TK, DDLRQ_DBT RQ, DDL_LEG_DBT LEG " +                                                                
                    " WHERE TK.T_BOFFICEKIND =  " + DL_SECURITYDOC +/*Сделка с ц/б*/                                                         
                    " AND TK.T_DEPARTMENT = ? " + //Филиал                                                                                   
                    " AND TK.T_CLIENTID = -1 " +                                                                                             
                    " AND TK.T_PFI = ? " +//идентификатор текущей бумаги ФИ                                                                  
                    " AND TK.T_PORTFOLIOID IN ( " + KINDPORT_TRADE + "," + KINDPORT_SALE + ") " + //ССПУ, СССД                                                                        
                    " AND TK.T_DEALSTATUS = " + DL_READIED + //Открыта                                                                       
                    " AND RSB_SECUR.IsBuy(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(TK.t_DealType, TK.t_BofficeKind))) = 1 " + 
                    " AND RQ.T_DOCKIND = TK.T_BOFFICEKIND " +                                                                                
                    " AND RQ.T_DOCID = TK.T_DEALID " +                                                                                       
                    " AND RQ.T_TYPE = " + DLRQ_TYPE_DELIVERY + // Поставка                                                                   
                    " AND RQ.T_FIID = TK.T_PFI " +                                                                                           
                    " AND RQ.T_FACTDATE =  TO_DATE('01-01-0001','DD-MM-YYYY') " + //Нулевая дата                                             
                    " AND RQ.T_PLANDATE > TK.T_DEALDATE " +                                                                                  
                    " AND TK.T_DEALDATE <= ? " +                                                                                  
                    " AND LEG.T_DEALID = TK.T_DEALID " +                                                                                     
                    " AND LEG.T_LEGKIND =  " +  LEG_KIND_DL_TICK +                                                                           
                    " AND LEG.T_LEGID = 0 " +                                                                                                
                    " AND LEG.T_OPERSTATE = " + DL_LEG_OUTBAL +                                                                              
                    " AND RSB_PMWRTOFF.RSI_DealAttrDvExe(TK.T_DEALID) = 0 ");                                                                                                
                    
                              
  cmd.addParam( "", RSDBP_IN, Depart );  
  cmd.addParam( "", RSDBP_IN, FinInstr );  
  cmd.addParam( "", RSDBP_IN, OperDate );  
  cmd.execute();

  DS = TRsbDataSet( cmd );
  if( DS.MoveNext() AND (DS.ExistsOvervlTPlus > 0) )
     ExistsOvervl = true;
  end;
  return ExistsOvervl;  
end;

/* Фильтр на сервисные операции. 
   Если вернет false, то по объекту сервисная опер. выполняться не будет
   OprDocKind - вид первичного документа
   SvOpServDoc - Документ сервисной операции 
   SvOpDoc - Первичный документ*/
macro ScOpFilter( OprDocKind, SvOpServDoc, SvOpDoc )       

  record dl_comm(dl_comm);
  record rContr( sfcontr );
  record Deal( dl_tick );
  record Avoiriss( avoiriss );
  record Fin(fininstr);
  var FD, need_overvalue, SaleOverAmount = $0;   
  var ReservAmount = $0, IncomeReserv = $0;    
  var NumInList = "", ValidFromDate, NeedOverValue_TO = false, NeedOverValue = false;
  var Dt;
  _OprDocKind = OprDocKind;
  SetBuff( dl_comm, SvOpServDoc );

  if( dl_comm.DocKind == BofficeKindCOMM ) /*комисси*/
    SetBuff( rContr, SvOpDoc );

    if( not SfIsExistPeriodComiss( rContr.Id, false ) )/*по договору нет периодических комиссий*/
      return false;
    end;
    return true;

  elif( dl_comm.DocKind == DL_RESERVEDOC ) /* резерв */

     if( OprDocKind == DLDOC_ISSUE )
        SetBuff( Avoiriss, SvOpDoc );

        if( dl_comm.FIID > 0 ) 
           return true;  
        end;

        if( ПолучитьФинИн( Avoiriss.FIID, Fin ) ) 
           return false;  
        end; 
         
        /* Если есть ненулевой остаток за дату в одном из портфелей */
        if( (ОстатокВПортфеле( dl_comm,KINDPORT_SALE, Avoiriss.FIID, true, true ) != 0) /*  OR         //СССД_ЦБ, БПП_СССД_ЦБ
             (ОстатокВПортфеле( dl_comm,KINDPORT_RETIRE, Avoiriss.FIID, true, true ) != 0) OR       //АС_ЦБ, БПП_АС_ЦБ
            (ОстатокВПортфеле( dl_comm,KINDPORT_PROMISSORY, Avoiriss.FIID, true, true ) != 0) OR   //ПДО
            (ОстатокВПортфеле( dl_comm,KINDPORT_CONTR, Avoiriss.FIID, true, true ) != 0) OR        //ПКУ, ПКУ_БПП
            ((ОстатокВПортфеле( dl_comm,KINDPORT_CONTR, Avoiriss.FIID, true, false ) != 0) AND (dl_comm.Flag3 == SET_CHAR) )         //ПВО  со статусом Поставлен и установлен признак формирования резерва вида РЦБННД (dl_comm.Flag3 == Да)
         */ )
          return true;
        end;

/*
        if( (ОстатокВПортфеле( dl_comm, KINDPORT_SALE, Avoiriss.FIID, true, true, @ReservAmount, @IncomeReserv ) != 0) AND /* ППР со статусом Поставлен или Продан БПП*/
            ( (ExistNOSS( Avoiriss, dl_comm.CommDate ) == false) OR /*не установлен признак возможности надежного определения ТСС*/
              (ReservAmount != 0) OR /*или есть ненулевой остаток резерва ReservAmount*/
              ( 
                (dl_comm.Flag2 == SET_CHAR) AND
                (IncomeReserv != 0) /*ненулевой остаток резерва ПДД*/
              )
            )
          )
           return true;
        elif( FI_IsBond( Fin ) ) /* ПУДП или ПДО со статусом Поставлен и ц/б - ДО*/
           if( (ОстатокВПортфеле( dl_comm,KINDPORT_RETIRE, Avoiriss.FIID, true, false ) != 0) OR
               (ОстатокВПортфеле( dl_comm,KINDPORT_PROMISSORY, Avoiriss.FIID, true, false ) != 0)
             )
             return true;
           end;
        elif( FI_IsShare( Fin ) ) /* ПКУ со статусом Поставлен и ц/б - Акция*/
           if( ОстатокВПортфеле( dl_comm, KINDPORT_CONTR, Avoiriss.FIID, true, false ) != 0 )
             return true;
           end;
        end;
*/
        return false;
     else
        /*Весь отбор теперь в программе, если сюда попали, то сделка подошла под условия*/
        return true;
     end;
  elif (dl_comm.DocKind == SP_AJUSTVALOEB) /* Корректировка стоимости ОЭБ*/
    return true;
  elif (dl_comm.DocKind == SP_ACCEXPREVOEB) /* Начисление расходов и доходов ОЭБ */
    return true;
  elif (dl_comm.DocKind == SP_TRANSFERPA)
    return true;
  elif (dl_comm.DocKind == SP_COMISSION_PA)
    return true;
  elif( dl_comm.DocKind == DL_OVERVALUE ) /* переоценка*/

     SetBuff( Avoiriss, SvOpDoc );

     if( ПолучитьФинИн( Avoiriss.FIID, Fin ) ) 
        return false;  
     end;

     if (dl_comm.OperSubKind == SC_OVERVALUE_WRTOFF) /*Списание результатов переоценки может выполняться:*/
        /*Если не нашли, или нашли что "да" - такая бумага не подходит. Нужны - только "нет"*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, dl_comm.CommDate, ValidFromDate) )
           return false;  
        else
           if( NumInList == "1" )
              return false;  
           end;
        end;
        /*... а предыдущее значение этой категории = "Да":*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, ValidFromDate-1) )
           return false;  
        else
           if( NumInList != "1" )
              return false;
           end;
        end;
     end;

     if (dl_comm.OperSubKind == SC_OVERVALUE_RESTORE) /*Восстановление убытка от обесценения по выпуску ц/б*/
        /*Если не нашли, или нашли что "нет" - такая бумага не подходит. Нужны - только "да"*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, dl_comm.CommDate, ValidFromDate) )
           return false;  
        else
           if( NumInList != "1" )
              return false;  
           end;
        end;
        /*... а предыдущее значение этой категории = "нет":*/
        if( not GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), CALCCOST_CATEGORY, null, null, NumInList, ValidFromDate-1) )
           return false;  
        else
           if( NumInList == "1" )
              return false;
           end;
        end;
     end;

     if( dl_comm.Flag5 == SET_CHAR ) /*Требования/обязательства по возврату ц/б*/
        if( ExistNOSS( Avoiriss, dl_comm.CommDate ) ) 
           NeedOverValue_TO = ПроверитьНаличиеРелевантныхЛотовДляПереоценкиТО( dl_comm, Avoiriss.FIID );
        end;

        if( NeedOverValue_TO )
           return true; /*уже подходит*/
        elif( dl_comm.Flag1 != SET_CHAR ) 
           return false;  
        end;
     end;

     if( dl_comm.Flag1 == SET_CHAR ) /*Вложения в ценные бумаги*/

        if( CheckExistOvervalue( Fin, dl_comm.CommDate ) )
           return false;  
        end;

        /*>>KD переоценка только по евробондам*/

          Dt = TRsbDataSet(" select t_facevaluefi from dfininstr_dbt where t_fiid = " + Avoiriss.Fiid);
         if (Dt.movenext())
           if (Dt.facevaluefi == 0)
              return false;
           end;
         end;

        if( (dl_comm.Flag2 == SET_CHAR) OR /*по событиям*/
            (dl_comm.Flag3 == SET_CHAR) OR
            (dl_comm.Flag4 == SET_CHAR)
          )

           /* переоценка по операциям по дате заключения сделки */
           if( (NeedOverValue == false) AND (dl_comm.Flag2 == SET_CHAR) )
              NeedOverValue = CheckExistByCreateDeal(dl_comm, Avoiriss);
           end;

           /* переоценка по операциям по дате оплаты */
           if( (NeedOverValue == false) AND (dl_comm.Flag3 == SET_CHAR) )
              NeedOverValue = CheckExistBySetAvoir(dl_comm, Avoiriss );
           end;

           /* переоценка по операциям по дате поставки */
           if( (NeedOverValue == false) AND (dl_comm.Flag4 == SET_CHAR) )
              NeedOverValue = CheckExistByPaymMoney(dl_comm, Avoiriss );
           end;

           if( NeedOverValue == false )
              return false;
           end;
        else
           /*a.  для всех ц/б в ТП*/
           if( (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_TRADE, -1, dl_comm.CommDate, true, false, true ) == $0) and 
               ( (WRTGetSaleOvervalue( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_TRADE, dl_comm.CommDate, SaleOverAmount) == $0) OR
                 (SaleOverAmount == 0)
               ) 
             )
              /*b. для тех ц/б в ППР, ПВО и на счетах "ОД", для которых на дату проведения операции в 
                   анкете выпуска признак "Возможность надежного определения справедливой стоимости" имеет 
                   значение "справедливая стоимость МОЖЕТ быть надежно определена".*/
              if(   (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_SALE, -1, dl_comm.CommDate, true, false, true ) == $0) and
                    (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BACK, -1, dl_comm.CommDate, true, false, true ) == $0 ) and
                    (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BASICDEBT, -1, dl_comm.CommDate, false, true, false ) == $0 ) and
                    (dl_comm.Flag7 == UNSET_CHAR)    // не не стоит флаг на 
                )
                    return false;  
              end;
           end;
        end;
     end;

     if( dl_comm.Flag7 == SET_CHAR )
        return CheckOvervalueTPlus(dl_comm.Division, Avoiriss.FIID, dl_comm.CommDate);  
     end;

     return true;
  elif( dl_comm.DocKind == DL_GET_INCOME ) /* начисление ПДД*/

     if (OprDocKind == DL_SECURITYDOC)
        return true; /*Все проверки в сишнике*/
     else
        SetBuff( Avoiriss, SvOpDoc );
        If(dl_comm.Flag1 == UNSET_CHAR)
            return false;  
        end;

        if( FI_GetStatus( Avoiriss.FIID, dl_comm.EndDate ) != FI_STATE_INCIRCULATION )  /*находящиеся в обращении*/
           if( ПолучитьФинИн( Avoiriss.FIID, Fin ) ) 
              return false;  
           end;

           // FI_GetStatus возвращает на дату погашения неопределенный статус. 
           // Чтобы не ломать ее логику, затычка для разрешения начисления ПДД в дату погашения. 
           // Нужно для средневзвешенного метода списания.
           if( Fin.DrawingDate != dl_comm.EndDate )
              return false;  
           end;
        end;

        if( ((dl_comm.Flag1 == SET_CHAR) or (dl_comm.Flag4 == SET_CHAR)) AND (dl_comm.Flag5 == SET_CHAR) AND
            (not CheckExistBySetAvoir_Inc(dl_comm, Avoiriss ))
          ) /*только по выпускам ц/б, где были движения*/
           return false;
        end;
        /*bpv скопирован блок из ветки по переоценке, чтобы отрубить бумаги СЭБ*/
           if( (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_TRADE, -1, dl_comm.CommDate, true, false, true ) == $0) and              
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_SALE, -1, dl_comm.CommDate, true, false, true ) == $0) and
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BACK, -1, dl_comm.CommDate, true, false, true ) == $0 ) and
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_BASICDEBT, -1, dl_comm.CommDate, false, true, false ) == $0 ) and
               (WRTGetPortfolioAmount( dl_comm.Division, Avoiriss.FIID, -1, 0, KINDPORT_RETIRE, -1, dl_comm.CommDate, true, false, false ) == $0 ) 
              )  
                    return false;  
           end;
        /*>>KD начисление только по евробондам*/

         Dt = TRsbDataSet(" select t_facevaluefi from dfininstr_dbt where t_fiid = " + Avoiriss.Fiid);
         if (Dt.movenext())
           if (Dt.facevaluefi == 0)
              return false;
            end;
         end;

        return true;
     end;

  elif( dl_comm.DocKind == DL_OVERVALUE_NVPI ) /*переоценка НВПИ*/
      return true;

  elif( dl_comm.DocKind == DL_OVERVALUE_RD ) /*переоценка требований и обязательств*/

     need_overvalue = true;
     SetBuff( Deal, SvOpDoc );

     FD = SPFirstDoc( Deal );

     /*Проверим курс, котируемость. То, что ц/б именно заданная (или заданного вида) - проверяется в сишнике*/
     /*Ц/б сделки имеет рыночные котировки (есть курс из настройки "рыночная цена")  
       за эту или предуд. дату  и он не равен 0, или ц/б котируемая (на дату)*/
     if (dl_comm.Flag1 == SET_CHAR)
        if (ИндивидуальныйФинИн(FD.fininstr.rec.FIID)) /*только неиндивидуальные*/
           need_overvalue = false;
        end;

        if (need_overvalue)
           if (FI_GetStatus( FD.fininstr.rec.FIID, dl_comm.CommDate ) != FI_STATE_INCIRCULATION)  /*находящиеся в обращении*/
              need_overvalue = false;
           end;
        end;

        if( CheckTaxDepositoryMode() == false )
           if (FD.avoiriss.rec.SPIsClosed == SET_CHAR) /*незакрытые*/
              need_overvalue = false;
           end;
        else
           if( FD.fininstr.rec.IsClosed == SET_CHAR ) /*незакрытые*/
              need_overvalue = false;
           end;
        end;

        /*наличие курса, котируемость*/
        if (need_overvalue)
           MacroCheckAvr_OVERVALUE_RD(FD.fininstr, dl_comm.CommDate, need_overvalue );
        end;

        if (need_overvalue)
           return true;
        end;
     end; 

     if (dl_comm.Flag2 == SET_CHAR)
        /*Проверим, что ВР == НацВ, ВН == НацВ*/
        if ((FD.GetPayFIID() == NATCUR) and (FD.fininstr.rec.FaceValueFI == NATCUR))
           return true;
        end;
     end; 

        /*>>KD Переоценка ТО только по евробондам*/

          Dt = TRsbDataSet(" select t_facevaluefi from dfininstr_dbt where t_fiid = " + Avoiriss.Fiid);
         if (Dt.movenext())
           if (Dt.facevaluefi == 0)
              return false;
           end;
         end;


     return false;
  end;
  return false;
end;

/*Распечатать ошибки*/
macro SvOpPrintError( ObjectName )
  var i = 0;

  if( SvOpErrorArray.Size == 0 ) return; end;
  SvOpPrintLine( "\n\n Ошибки при выполнении сервисной операции:\n" );
  SvOpPrintLine( "┌────────────┬───────────────┬──────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐");
  SvOpPrintLine( "│    Код     │" + string(ObjectName:15) + "│  №   │                          Код ошибки                                                                                                                                                   │");
  SvOpPrintLine( "│  операции  │               │ошибки│                                                                                                                                                                                       │");
  SvOpPrintLine( "├────────────┼───────────────┼──────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤");

  while( i != SvOpErrorArray.Size )
     SvOpPrintLine( "│" +
                    string(SvOpErrorArray(i).OpCode:12) + "│" + 
                    string(SvOpErrorArray(i).ObjCode:15) + "│" +  
                    string(SvOpErrorArray(i).NumErr:6) + "│" +  
                    string(SvOpErrorArray(i).StrErr:183) + "│"  );
     i = i + 1;
  end;

  SvOpPrintLine( "└────────────┴───────────────┴──────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘");
end;

private macro SvOpOvervalue_RDLine( Data:SvOpOvervalue_RD, Num:DOUBLE )
  if( Data.Summa != 0 )
    var FinInstr = GetFinInstr( Data.FIID, true );

    SvOpPrintLine( "│" +
                   String(Data.Deal:13)+"│"+
                   String(GetFinInstrName(Data.FIID):27) +"│"+
                   String(Data.Kind:5:c) +"│"+
                   String(Data.Summ_RD:15) +" "+
                   String(Data.Curr:3) +"│"+
                   String(ЧислоCЗаданнойТочностью(Data.Num, SetPrecisionByFractPart(Data.Num, FinInstr.SumPrecision ,0)):10) +"│"+
                   String(Data.NKD:14) +"│"+    
                   String(Data.Price:13:6) +"│"+
                   String(Data.DtAcc:27) +"│"+
                   String(Data.KtAcc:27) +"│"+
                   String(Data.Summa:13) +"│"+
                   String(Data.Summ_RD_NEW:15) +" "+
                   String(Data.Curr:3) +"│"
                 );
  end;
end;

private macro SvOpOvervalue_NVPILine( Data:SvOpOvervalue_NVPI )
  if( Data.Summa != 0 )
    SvOpPrintLine( "│" +
                   String(Data.Deal:13)+"│"+
                   String(Data.FiCode:27)+"│"+
                   String(Data.Kind:5:c) +"│"+
                   String(Data.SumTO:15)+" "+
                   String(Data.CurTO:3)+"│"+
                   String(Data.DtAcc:27) +"│"+
                   String(Data.KtAcc:27) +"│"+
                   String(Data.Summa:13) +"│"
                 );
  end;
end;

macro SvOpCALCTSSLine( Data:SvOpCALCTSS )
  SvOpPrintLine( "│" +
                 String(GetFinInstr(Data.FIID).FI_CODE:17)+"│"+
                 String(Data.Rate:21:9) +" "+
                 String(GetFICode(Data.RateFIID, null, FICK_ISOSTRING):4) +"│" +
                 String(Data.Msg:250:w) +"│"
               );
end;

private macro SvOpOvervalue_RDFoot()
   return "└─────────────┴───────────────────────────┴─────┴───────────────────┴──────────┴──────────────┴─────────────┴───────────────────────────┴───────────────────────────┴─────────────┴───────────────────┘";
end;

private macro SvOpOvervalue_NVPIFoot()
   return "└─────────────┴───────────────────────────┴─────┴───────────────────┴───────────────────────────┴───────────────────────────┴─────────────┘";
end;

private macro SvOpReservFoot( OperationKind )
  if( OperationKind == KINDRES_RCB )
     return
"└────────────────┴─────────┴──────────────────────────┴──────────────────────────┴────────┴─────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┘";
  elif( OperationKind == KINDRES_DEAL )
     return
"└──────────────────────────────┴───────────────┴────────────────────┴────────────────────┴──────────────────────────┴────────┴─────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┘";
  elif( OperationKind == KINDRES_REQ )
     if( SvOpLastResKind == KINDRES_SALEREPO2 )
        return
"└──────────────────────────────┴───────────────┴──────────────────────────┴──────────────────────────┴────────┴─────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┘";
     else
        return
"└──────────────────────────────┴───────────────┴──────────────────────────┴──────────────────────────┴────────┴─────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┘";
     end;
  end;
end;

macro SvOpCALCTSSFoot()
   return  "└─────────────────┴──────────────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘";
end;

class ItogReservLineByFIID()

   private var 
       m_ObjID       ,
       m_BaseSum     ,
       m_Reserv      ,
       m_OldReserv   ,
       m_ReservChange;

   macro Clear()
      m_ObjID        = -1;
      m_BaseSum      = $0;
      m_Reserv       = $0;
      m_OldReserv    = $0;
      m_ReservChange = $0;
   end;

   macro AddItog(p_ObjID:integer,p_BaseSum:money,p_Reserv:money,p_OldReserv:money,p_ReservChange:money)

      if( m_ObjID != p_ObjID )
         Clear();
      end;

      m_ObjID        = p_ObjID;
      m_BaseSum      = m_BaseSum      + p_BaseSum;
      m_Reserv       = m_Reserv       + p_Reserv;
      m_OldReserv    = m_OldReserv    + p_OldReserv;
      m_ReservChange = m_ReservChange + p_ReservChange;

   end;

   macro ObjID()
      return m_ObjID;
   end;

   macro BaseSum()
      return m_BaseSum;
   end;

   macro Reserv()
      return m_Reserv;
   end;

   macro OldReserv()
      return m_OldReserv;
   end;

   macro ReservChange()
      return m_ReservChange;
   end;

   this.Clear();
end;

private macro SvOpPrintItogLineByReserv(p_ItogReservLineByFIID:ItogReservLineByFIID)
  var StrLine;

  if (ScOprServDoc.OperationKind == KINDRES_RCB)

     if( p_ItogReservLineByFIID.ObjID != -1 )
        StrLine =
"├────────────────┼─────────┼──────────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
"│Итого по выпуску│         │                          │                          │        │         │"+
        String(p_ItogReservLineByFIID.BaseSum:20)         + "│" +
        String(p_ItogReservLineByFIID.Reserv:20)         + "│" +
        String(p_ItogReservLineByFIID.OldReserv:20) + "│" +
        String(p_ItogReservLineByFIID.ReservChange:20)   + "│" ;

        SvOpPrintLine( StrLine );
     end;
  end;

end;                    

private record LnFI(fininstr);
private record LnParty(party);
private file   LnDeal(dl_tick);
private file   LnDealNtg(dl_nett);
private record LnDl_leg(dl_leg);
private macro SvOpReservLine( Data:SvOpReserve, Num:INTEGER, headIsPrinted, p_ItogReservLineByFIID:ItogReservLineByFIID )
  var Reserv, ReservChange, StrLine = "", DealCode, Contractor, ResKindStr = "", ind = 0, BaseAcc = "", RiskGrp, ResPc, BaseSum, RiskGrp2, ResPc2, BaseSum2, ReservAcc = "";
  var ind_r = 0, ind_b = 0, ПечататьЦБ = false, ПечататьСделку = false;

  if( not ((ScOprServDoc.OperationKind == KINDRES_REQ) and (Data.ResKind == KINDRES_SALEREPO2)) )
     Reserv       = money(ABS(Data.BaseSum)*double(Data.ResPc)/100.);
     if((ValType(Data.CorrectSum) != V_UNDEF) and (Data.CorrectSum != $0))
       ReservChange = ABS(Data.CorrectSum);
     else
       ReservChange = ABS(Reserv-Data.OldReserv);
     end;
  end;

  if( ScOprServDoc.OperationKind == KINDRES_RCB )

     if(Data.ResKind == KINDRES_RCBUC)
       ResKindStr = "2732-У";
     elif(Data.ResKind == KINDRES_RVPCB)
       ResKindStr = "ПДД";
     elif(Data.ResKind == KINDRES_RCB)
       ResKindStr = "Ц/б";
     end;

     if( (Num > 0 ) and (p_ItogReservLineByFIID != NULL) and (p_ItogReservLineByFIID.ObjID != Data.ObjID) )
        SvOpPrintItogLineByReserv(p_ItogReservLineByFIID);
        ПечататьЦБ = true;
     end;

     if( (Num == 0) or ПечататьЦБ ) /*Первая строка*/
        ПолучитьФинИн( Data.ObjID, LnFI );
        StrLine =    
"├────────────────┼─────────┼──────────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤" +
        "\n" + "│" + String(LnFI.FI_Code:16) + "│";
     else
        StrLine = "│" + String(" ":16) + "│";
     end;          

     ind = index(Data.BaseAcc, "|");
     if(ind == 0)
       BaseAcc = Data.BaseAcc;
     else
       BaseAcc = substr(Data.BaseAcc, 1, ind);
       Data.BaseAcc = substr(Data.BaseAcc, ind+1);
     end;

     StrLine = StrLine +
               String(ResKindStr:9)      + "│" +
               String(BaseAcc:26)   + "│" + 
               String(Data.ReservAcc:26) + "│" +
               String(Data.RiskGrp:8)    + "│" +
               String(Data.ResPc:9)      + "│" +
               String(Data.BaseSum:20)   + "│" +
               String(Reserv:20)         + "│" +
               String(Data.OldReserv:20) + "│" +
               String(ReservChange:20)   + "│" ;

     ind = index(Data.BaseAcc, "|");
     while(ind)
       BaseAcc = substr(Data.BaseAcc, 1, ind);
       Data.BaseAcc = substr(Data.BaseAcc, ind+1);

       StrLine = StrLine + "\n" + "│" + String(" ":16) + "│"+
               String(" ":9)      + "│" +
               String(BaseAcc:26) + "│" + 
               String(" ":26)     + "│" +
               String(" ":8)      + "│" +
               String(" ":9)      + "│" +
               String(" ":20)     + "│" +
               String(" ":20)     + "│" +
               String(" ":20)     + "│" +
               String(" ":20)     + "│" ;

       ind = index(Data.BaseAcc, "|");
     end;

     if( Num < ScOpReportLineData.Size-1 ) /*Не последняя строка по бумаге, будет еще*/
        StrLine = StrLine + "\n" +
"│                ├─────────┼──────────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤";
     end;                                                                                                                                                                

     if( p_ItogReservLineByFIID != NULL )
        p_ItogReservLineByFIID.AddItog(Data.ObjID,Data.BaseSum,Reserv,Data.OldReserv,ReservChange);
     end;

  elif( ScOprServDoc.OperationKind == KINDRES_DEAL )
     ClearRecord( LnDeal );
     LnDeal.DealID = Data.ObjID;
     GetEQ( LnDeal );
     FindDL_LEG( LEG_KIND_DL_TICK, LnDeal.DealID, 0, LnDl_leg );
     ПолучитьФинИн( LnDl_leg.PFI, LnFI );
     
     StrLine = 
"├──────────────────────────────┼───────────────┼────────────────────┼────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
              "│" + String(LnDeal.DealCode:30) + "│" + 
              String(LnFI.FI_Code:15)        + "│" +
              String(Data.MarketSum:20)        + "│" +
              String(Data.CostRUR:20)        + "│" +
              String(Data.ReservAcc:26)      + "│" +
              String(Data.RiskGrp:8)         + "│" +
              String(Data.ResPc:9)           + "│" +
              String(Data.BaseSum:20)        + "│" +
              String(Reserv:20)              + "│" +
              String(Data.OldReserv:20)      + "│" +
              String(ReservChange:20)        + "│" ;

  elif( ScOprServDoc.OperationKind == KINDRES_REQ  )

     if( (SvOpLastResKind == -1) or ((SvOpLastResKind != Data.ResKind) and ((SvOpLastResKind == KINDRES_SALEREPO2) or (Data.ResKind == KINDRES_SALEREPO2))) )
        if( Data.ResKind == KINDRES_SALEREPO2 )
           if( SvOpLastResKind != -1 ) 
              SvOpPrintLine(SvOpReservFoot( ScOprServDoc.OperationKind ));
           end;
           if (not HeadIsPrinted )
           SvOpReservHead( ScOprServDoc.OperationKind, KINDRES_SALEREPO2 );
           end;
        else
           if( SvOpLastResKind != -1 ) 
              SvOpPrintLine(SvOpReservFoot( ScOprServDoc.OperationKind ));
           end;
           if (not HeadIsPrinted )
            SvOpReservHead( ScOprServDoc.OperationKind );
           end;
        end;
     end;
     SvOpLastResKind = Data.ResKind;

     if( Data.IsDealNtg == true )
        ClearRecord( LnDealNtg );
        LnDealNtg.NettingID = Data.ObjID;
        GetEQ( LnDealNtg ); 
        DealCode   = LnDealNtg.DealNumber;
        Contractor = LnDealNtg.Contractor;
     else

        ПечататьСделку = IIF(LnDeal.DealID == Data.ObjID,false,true);

        if( ПечататьСделку )
           ClearRecord( LnDeal );
           LnDeal.DealID = Data.ObjID;
           GetEQ( LnDeal );
           DealCode   = LnDeal.DealCode;
           Contractor = GetContrInDeal(LnDeal);
        else
           DealCode   = "";
           Contractor = -1;
           ClearRecord(LnParty);
        end;

     end;

     ПолучитьСубъекта( Contractor, LnParty );

     if( Data.ResKind == KINDRES_SALEREPO2)/*без столбца "гарантийное обеспечение", по одной сделке 2 строки*/

        if( money(Data.BaseSum) > $0.0 )/*в новой версии Data.BaseSum заполняем*/

           if( (int(Data.RiskGrpSec) == -1) and (money(Data.ResPcSec) == -1) )
              if( Data.IsSetting )
                 RiskGrp  = " ";
                 ResPc    = " ";
                 ResPc2   = money(Data.ResPc);
                 RiskGrp2 = int(Data.RiskGrp);
              else
                 ResPc   = money(Data.ResPc);
                 RiskGrp = int(Data.RiskGrp);
                 RiskGrp2 = " ";
                 ResPc2   = " ";
              end;
           else
              RiskGrp = int(Data.RiskGrpSec);
              ResPc   = money(Data.ResPcSec);
              if( Data.IsSetting )
                 ResPc2  = max(money(Data.ResPc),money(Data.ResPcSec));
                 if( ResPc2 == money(Data.ResPc))
                    RiskGrp2 = int(Data.RiskGrp);
                 else
                    RiskGrp2 = int(Data.RiskGrpSec);
                 end;
              else
                 RiskGrp2 = " ";
                 ResPc2   = " ";
              end;
           end;
         
           BaseSum2 = money(Data.AccRest_BPP);
         
           BaseSum = money(Data.AccRest_OD);
           Reserv  = money(Data.BaseSum);
           ReservChange = Reserv - money(Data.OldReserv);

        else/*старая версия*/
           if( Data.IsSetting )
              RiskGrp = int(Data.RiskGrpSec);
              ResPc   = money(Data.ResPcSec);
              BaseSum = money(Data.AccRest_OD);
           
              ResPc2  = max(money(Data.ResPc),money(Data.ResPcSec));
              if( ResPc2 == money(Data.ResPc))
                 RiskGrp2 = int(Data.RiskGrp);
              else
                 RiskGrp2 = int(Data.RiskGrpSec);
              end;
           
              BaseSum2 = money(Data.AccRest_BPP) - BaseSum;
              if( BaseSum2 < $0 )
                 BaseSum2 = $0;
                 Reserv  = money((BaseSum*ResPc)/100.);
              else
                 Reserv  = money((BaseSum*ResPc + BaseSum2*ResPc2)/100.);
              end;
           
              ReservChange = Reserv - money(Data.OldReserv);
           else
              RiskGrp = int(Data.RiskGrp);
              ResPc   = money(Data.ResPc);
              BaseSum = " ";
           
              RiskGrp2 = " ";
              ResPc2   = " ";
              BaseSum2 = money(Data.AccRest_BPP) - money(Data.AccRest_OD);
           
              if( BaseSum2 < $0 )
                 BaseSum2 = 0;
              end;
           
              Reserv  = BaseSum2*ResPc;
              ReservChange = Reserv - money(Data.OldReserv);
           end;
        end;
        
        ind = index(Data.BaseAcc, "|");
        if(ind == 0)
          BaseAcc = Data.BaseAcc;
        else
          BaseAcc = substr(Data.BaseAcc, 1, ind);
          Data.BaseAcc = substr(Data.BaseAcc, ind+1);
        end;

        ind = index(Data.ReservAcc, "|");
        if(ind == 0)
          ReservAcc = Data.ReservAcc;
        else
          ReservAcc = substr(Data.ReservAcc, 1, ind);
          Data.ReservAcc = substr(Data.ReservAcc, ind+1);
        end;

        if( not ПечататьСделку )
           StrLine = 
"│                              │               ├──────────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
               "│" +  String(" ":30)   + "│" + 
               String(" ":15) + "│" + 
               String(ReservAcc:26)           + "│" +
               String(BaseAcc:26)    + "│" +
               String(RiskGrp:8)       + "│" +
               String(ResPc:9)         + "│" +
               String(BaseSum:20)      + "│" +
               String(Reserv:20)            + "│" +
               String(Data.OldReserv:20)    + "│" +
               String(ReservChange:20)      + "│" ;
        else
           StrLine = 
"├──────────────────────────────┼───────────────┼──────────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
               "│" +  String(DealCode:30)   + "│" + 
               String(LnParty.ShortName:15) + "│" + 
               String(ReservAcc:26)           + "│" +
               String(BaseAcc:26)    + "│" +
               String(RiskGrp:8)       + "│" +
               String(ResPc:9)         + "│" +
               String(BaseSum:20)      + "│" +
               String(Reserv:20)            + "│" +
               String(Data.OldReserv:20)    + "│" +
               String(ReservChange:20)      + "│" ;
        end;

        ind_b = index(Data.BaseAcc, "|");
        ind_r = index(Data.ReservAcc, "|");
        ind = IIF(ind_b>ind_r,ind_b,ind_r);
        while(ind)

           if( ind_r > 0 )
              ReservAcc = substr(Data.ReservAcc, 1, ind_r);
              Data.ReservAcc = substr(Data.ReservAcc, ind_r+1);
           else
              ReservAcc = Data.ReservAcc = " ";
           end;

           if( ind_b > 0 )
              BaseAcc = substr(Data.BaseAcc, 1, ind_b);
              Data.BaseAcc = substr(Data.BaseAcc, ind_b+1);
           else
              BaseAcc = Data.BaseAcc = " ";
           end;
           
           StrLine = StrLine + "\n" + "│" + String(" ":30) + "│"+
                   String(" ":15)      + "│" +
                   String(ReservAcc:26) + "│" + 
                   String(BaseAcc:26)     + "│" +
                   String(" ":8)      + "│" +
                   String(" ":9)      + "│" +
                   String(" ":20)     + "│" +
                   String(" ":20)     + "│" +
                   String(" ":20)     + "│" +
                   String(" ":20)     + "│" ;
           
           ind_b = index(Data.BaseAcc, "|");
           ind_r = index(Data.ReservAcc, "|");
           ind = IIF(ind_b>ind_r,ind_b,ind_r);
        end;

        if( Data.IsSetting )
           StrLine = StrLine +  "\n" +                                                                                                                                                                                      
"│                              │               │                          ├──────────────────────────┼────────┼─────────┼────────────────────┤                    │                    │                    │\n";
        else                                                                                                                                                                                                 
           StrLine = StrLine + "\n" +
"│                              │               │                          ├──────────────────────────┤        │         │                    │                    │                    │                    │\n";
        end;

        StrLine = StrLine +
               "│" +  String(" ":30)   + "│" + 
               String(" ":15) + "│" + 
               String(" ":26)           + "│" +
               String(Data.ReqAcc:26)    + "│" +
               String(RiskGrp2:8)       + "│" +
               String(ResPc2:9)         + "│" +
               String(BaseSum2:20)      + "│" +
               String(" ":20)            + "│" +
               String(" ":20)    + "│" +
               String(" ":20)      + "│" ;
   
     else
        StrLine = 
"├──────────────────────────────┼───────────────┼──────────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
               "│" +  String(DealCode:30)   + "│" + 
               String(LnParty.ShortName:15) + "│" + 
               String(Data.BaseAcc:26)      + "│" +
               String(Data.ReservAcc:26)    + "│" +
               String(Data.RiskGrp:8)       + "│" +
               String(Data.ResPc:9)         + "│" +
               String(Data.BaseSum:20)      + "│" +
               String(Reserv:20)            + "│" +
               String(IIF(Data.GuarantSum==null,$0,Data.GuarantSum):20)   + "│" +
               String(Data.OldReserv:20)    + "│" +
               String(ReservChange:20)      + "│" ;
     end;

  end;

  SvOpPrintLine( StrLine );
end;

private macro SvOpPrintItogLine()
  var i = 0, Reserv = $0, ItogReserv = $0, ItogOldReserv = $0, ItogReservChange = $0, StrLine, Data;

  if( ScOpReportLineData.Size <= 0 )  return;  end;

  if( ScOprServDoc.DocKind == DL_RESERVEDOC )
     if( ScOprServDoc.OperationKind == KINDRES_RCB )
        while( i < ScOpReportLineData.Size )
           Data = ScOpReportLineData[i];
           Reserv        = money(ABS(Data.BaseSum)*double(Data.ResPc)/100.);
           ItogReserv    = ItogReserv + Reserv; 
           ItogOldReserv = ItogOldReserv + Data.OldReserv; 
           if((ValType(Data.CorrectSum) != V_UNDEF) and (Data.CorrectSum != $0))
             ItogReservChange = ItogReservChange + ABS(Data.CorrectSum);
           else
             ItogReservChange = ItogReservChange + ABS(Reserv-Data.OldReserv);
           end;

           i = i + 1;
        end;

        StrLine =
"├────────────────┼─────────┼──────────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
"│Итого по выпуску│         │                          │                          │        │         │                    │"+
        String(ItogReserv:20)         + "│" +
        String(ItogOldReserv:20) + "│" +
        String(ItogReservChange:20)   + "│" ;

        SvOpPrintLine( StrLine );
     end;
  end; 
end;                    

private macro SvOpComissLine( KindAction, Data:SvOpComiss, Num:INTEGER )
   const
      SvOp_skCalcComm   = 200,   /*расчет комиссии (в дату заключения сделки)*/ 
      SvOp_skPayComm    = 300;   /*оплата комиссии (в дату оплаты комиссий)*/
   var
      Mes = null;

   if( KindAction == SvOp_skCalcComm )
      Mes = "Расчет комиссий выполнен успешно.";
   elif( KindAction == SvOp_skPayComm )
      Mes = "Оплата комиссий выполнена успешно.";
   end;

   SvOpProcessPeriodComm_PrintLine( SvOpReportFile, ScOpIsServiceOper,
                                    Data.number, Mes );
end;

/*****************************************************************************
                    Общие ф-и для печати отчета серв. операции 
******************************************************************************/
/*Вызывается при инициализации сервисной операции*/
macro ScOpInit( )
  VAR errcode, errtext;
  ReplaceMacro ( "msgbox", NULL );
  close( SvOpReportFile ); /*На всякий случай*/
  if( not Open( SvOpReportFile, GetTxtFileName(SvOpReportName) ) )
     errcode = status(errtext);
     MsgBox( "Ошибка при создании временного файла|"+GetTxtFileName(SvOpReportName)+"|(" + errcode + ") " + errtext);
     RunError( "Ошибка при создании временного файла|"+GetTxtFileName(SvOpReportName)+"|(" + errcode + ") " + errtext );
  end;

  SvOpErrorArray.Size = 0;
  ScOpNumInsRecord = 0;
  ScOpLastServDocKind = -1;
  ScOpReportLineData.Size = 0;
  ScOpIsServiceOper  = true;
  SvOpLastResKind = -1;
  ReplaceMacro ( "msgbox", "Svop_msgbox" );
end;

private macro SvOpPrintFootLine( dl_comm, OperationKind )

  if( dl_comm.DocKind == DL_RESERVEDOC )
     SvOpPrintLine( SvOpReservFoot( OperationKind ) );
     SvOpPrintLine( "" );
     SvOpPrintLine( "" );
  elif( dl_comm.DocKind == DL_OVERVALUE_RD )
     SvOpPrintLine( SvOpOvervalue_RDFoot() );
     SvOpPrintLine( "" );
     SvOpPrintLine( "" );
  elif( dl_comm.DocKind == DL_OVERVALUE_NVPI )
     SvOpPrintLine( SvOpOvervalue_NVPIFoot() );
     SvOpPrintLine( "" );
     SvOpPrintLine( "" );
  elif( dl_comm.DocKind == BofficeKindCOMM )
     SvOpProcessPeriodComm_PrintFoot(  SvOpReportFile, ScOpIsServiceOper,
                                       IsOprMultiExec(), dl_comm );
  elif( dl_comm.DocKind == DL_CALCTSS )
     SvOpPrintLine( SvOpCALCTSSFoot() );
     SvOpPrintLine( "" );
     SvOpPrintLine( "" );
  end;
end;

/*Подвал отчета о сервисной операции*/
macro SvOpPrintFoot( dl_comm )
  var Executer = DepoExecuter( {oper} );

  if( not (((dl_comm.DocKind == DL_RESERVEDOC) and 
            (dl_comm.OperationKind == KINDRES_DEAL)
           ) or 
           (dl_comm.DocKind == DL_GET_INCOME) or
           (dl_comm.DocKind == DL_OVERVALUE)
          ) 
    )
    SvOpPrintFootLine( dl_comm, dl_comm.OperationKind );
  end;

  SvOpPrintLine( 
"Составил ( " + Executer.Post + " ):\n" +
string( Executer.Name ) + "                 " + String( {curdate} ) + "\n" +
DL_StrCut( "", IIF(strlen(Executer.Name) <= 10, 10, strlen(Executer.Name) ), "─" ) + " ───────────────   дата" + "\n" +
DL_StrCut("", IIF(strlen(Executer.Name) <= 10, 0, (strlen(Executer.Name) - 10) / 2 ), " ") + "   ФИО    " + DL_StrCut("", IIF(strlen(Executer.Name) <= 10, 0, (strlen(Executer.Name) - 10) / 2), " " ) + "    подпись" );
end;

/*Печать строки отчета*/
macro ScOpPrintReportLine( OprDocKind, SvOpServDoc, SvOpDoc, KindAction )

  var    i = 0;

  if( ScOpReportLineData.Size == 0 ) /*Печатать нечего*/
    return; 
  end;

  ConnectBuff( ScOprServDoc, SvOpServDoc ); 

  if( ScOprServDoc.DocKind == DL_RESERVEDOC )
    /*Это нужно для массового выполнения, т.к. в одном скроллинге сразу все 
      операции резерва, поэтому нужно при смене операции перерисовывать 
      шапку и подвал отчета*/
    if( ScOpLastServDocKind != ScOprServDoc.OperationKind )
       if( ScOpLastServDocKind != -1 )
          SvOpPrintFootLine( ScOprServDoc, ScOpLastServDocKind );
       end;
       ScOpLastServDocKind = ScOprServDoc.OperationKind;
       ScOpNumInsRecord = 0;
    end;
  end;

  if( ScOpNumInsRecord == 0 )
    if( not (((ScOprServDoc.DocKind == DL_RESERVEDOC) and 
              ((ScOprServDoc.OperationKind == KINDRES_DEAL) or   
               (ScOprServDoc.OperationKind == KINDRES_REQ)
              )
             ) or 
             (ScOprServDoc.DocKind == DL_GET_INCOME) or
             (ScOprServDoc.DocKind == DL_OVERVALUE)
            ) 
      )
       SvOpPrintHead( ScOprServDoc );
    end;
  end;

  ScOpNumInsRecord = ScOpNumInsRecord + 1;
  /*может быть несколько строк для отчета на 1 шаге*/ 
  while( i < ScOpReportLineData.Size )
     if( ScOprServDoc.DocKind == DL_RESERVEDOC )
       /*Для печати протокола РСС - вызывается Print_MemOrder. См. запросы 88651, 89070.*/
       if (ScOprServDoc.OperationKind != KINDRES_DEAL)
          SvOpReservLine( ScOpReportLineData[i], i );
       end;
     elif( ScOprServDoc.DocKind == DL_OVERVALUE_RD )
        SvOpOvervalue_RDLine( ScOpReportLineData[i], i );
     elif( ScOprServDoc.DocKind == DL_OVERVALUE_NVPI )
        SvOpOvervalue_NVPILine( ScOpReportLineData[i] );
     elif( ScOprServDoc.DocKind == BofficeKindCOMM )
       SvOpComissLine( KindAction, ScOpReportLineData[i], i );
     elif( ScOprServDoc.DocKind == DL_CALCTSS )
       SvOpCALCTSSLine( ScOpReportLineData[i], i );
     end;
     i = i + 1;
  end;

  /*Для некоторых операций нужна итоговая строка, если на одном шаге несколько строк отчета*/
  SvOpPrintItogLine();
  ClearRecord( LnDeal );
  ScOpReportLineData.Size = 0;
end;

/*Печать строки отчета*/
macro SvOpPrintReportLine_XML( OprDocKind, SvOpServDoc, SvOpReportLineData_XML )

  var    i = 0, HeadPrinted = false;
  var    v_ItogReservLineByFIID = ItogReservLineByFIID(), SubDocKind = null;

  ConnectBuff( ScOprServDoc, SvOpServDoc ); 

  /*для переоценки  НВПИ и внебаланса пока единственная форма*/
  SvOpReportLineData_XML.SetReportNumber(0);
  if(( ScOprServDoc.DocKind == DL_RESERVEDOC ) and (IsOprMultiExec())  )
    /*Это нужно для массового выполнения, т.к. в одном скроллинге сразу все 
      операции резерва, поэтому нужно при смене операции перерисовывать 
      шапку и подвал отчета*/
    if( ScOpLastServDocKind != ScOprServDoc.OperationKind )
       if( ScOpLastServDocKind != -1 )
          SvOpPrintFootLine( ScOprServDoc, ScOpLastServDocKind );
       end;
       ScOpLastServDocKind = ScOprServDoc.OperationKind;
       ScOpNumInsRecord = 0;
    end;
  else
   ScOpNumInsRecord = 0;
  end;
 
  while( SvOpReportLineData_XML.Next )
     
     if( ScOpNumInsRecord == 0 )
       if(not HeadPrinted and (not (((ScOprServDoc.DocKind == DL_RESERVEDOC) and 
              (/*(ScOprServDoc.OperationKind == KINDRES_RCB) or
               (ScOprServDoc.OperationKind == KINDRES_REQ)*/ (ScOprServDoc.OperationKind == KINDRES_DEAL) 
              ))
             or 
             (ScOprServDoc.DocKind == DL_GET_INCOME) or
             (ScOprServDoc.DocKind == DL_OVERVALUE) 
               )))

          if( (ScOprServDoc.DocKind == DL_RESERVEDOC) and (ScOprServDoc.OperationKind == KINDRES_REQ) )
             SubDocKind = SvOpReportLineData_XML.GetReportLineData().ResKind;
          end;

          SvOpPrintHead( ScOprServDoc, SubDocKind );
          HeadPrinted = true;
       end;
     end;

     if( ScOprServDoc.DocKind == DL_OVERVALUE_RD )
        SvOpOvervalue_RDLine( SvOpReportLineData_XML.GetReportLineData(), i );
     elif( ScOprServDoc.DocKind == DL_OVERVALUE_NVPI )
        SvOpOvervalue_NVPILine( SvOpReportLineData_XML.GetReportLineData() );
     elif( ScOprServDoc.DocKind == DL_RESERVEDOC )
       if (ScOprServDoc.OperationKind != KINDRES_DEAL)
         SvOpReservLine( SvOpReportLineData_XML.GetReportLineData(),i,HeadPrinted,v_ItogReservLineByFIID );
       end;
     elif( ScOprServDoc.DocKind == DL_CALCTSS )
        SvOpCALCTSSLine( SvOpReportLineData_XML.GetReportLineData() );
     end;

  //HeadPrinted = true;

     i = i + 1;

     ScOpNumInsRecord = ScOpNumInsRecord + 1;

  end;

  if( HeadPrinted )
    if( ScOprServDoc.DocKind == DL_RESERVEDOC )
       SvOpPrintItogLineByReserv(v_ItogReservLineByFIID);
    end;
  end;
  ClearRecord( LnDeal );
  HeadPrinted = false;
  return (i>0);
end;

/* Печать отчета о сервисной операции
   OprDocKind - вид первичного документа
   SvOpServDoc- документ сервисной операции
   ReportFlag - Признак, что нужно печатать отчет 
   ShowReport - показывать отчет*/
macro ScOpPrintReport( OprDocKind, SvOpServDoc, ReportFlag, ShowReport )
  record dl_comm(dl_comm);

  var ObjectName;

  ConnectBuff( dl_comm, SvOpServDoc ); 

  if( (isOprMultiExec() == false) )
     if( (ReportFlag == true) )    
        if( ((dl_comm.DocKind == DL_RESERVEDOC) and 
             ( (dl_comm.OperationKind == KINDRES_DEAL) or
               (dl_comm.OperationKind == KINDRES_RCB) or
               (dl_comm.OperationKind == KINDRES_REQ)  
             ) 
            ) or 
            (dl_comm.DocKind == DL_GET_INCOME) or
            (dl_comm.DocKind == DL_OVERVALUE) or
            (dl_comm.DocKind == DL_OVERVALUE_RD) or
            (dl_comm.DocKind == DL_OVERVALUE_NVPI) or
            (dl_comm.DocKind == DL_CALCTSS) or 
            (dl_comm.DocKind == SP_AJUSTVALOEB) or 
            (dl_comm.DocKind == SP_ACCEXPREVOEB) or
            (dl_comm.DocKind == SP_TRANSFERPA) or
            (dl_comm.DocKind == SP_COMISSION_PA)
          )
           if(not ExecMacroFile("spordres.mac", "Print_MemOrder", SvOpServDoc, true))
              MsgBox("Ошибка при печати протокола сервисной операции");
           end;
        end;
     end;
  end;

  if( (ReportFlag == true) and (ScOpNumInsRecord > 0) )    
     if( not (((dl_comm.DocKind == DL_RESERVEDOC) /*and 
               (dl_comm.OperationKind != KINDRES_DEAL)*/
              ) or 
              (dl_comm.DocKind == DL_GET_INCOME) or
              (dl_comm.DocKind == DL_OVERVALUE) or
              (dl_comm.DocKind == DL_OVERVALUE_RD) or
              (dl_comm.DocKind == DL_OVERVALUE_NVPI) or
              (dl_comm.DocKind == DL_CALCTSS) or 
              (dl_comm.DocKind == SP_AJUSTVALOEB) or 
              (dl_comm.DocKind == SP_ACCEXPREVOEB) or
              (dl_comm.DocKind == SP_TRANSFERPA) or
              (dl_comm.DocKind == SP_COMISSION_PA)
             ) 
       )
        SvOpPrintFoot( dl_comm );
     end;
  end;

  if( OprDocKind == DLDOC_ISSUE ) ObjectName = "Ц/б";
  elif( OprDocKind == DLDOC_PARTY ) ObjectName = "Субъект";
  elif( OprDocKind == DL_STOCKCONTR ) ObjectName = "Договор";
  elif( OprDocKind == DL_SECURITYDOC ) ObjectName = "Сделка";
  elif( OprDocKind == DL_TRUSTDOC ) ObjectName = "Сделка ДУ";
  elif( OprDocKind == DL_NTGSEC) ObjectName = "Неттинг";
  elif( OprDocKind == DL_RETIREMENT) ObjectName = "Погашение";
  elif( OprDocKind == DL_CONVAVR) ObjectName = "Конвертация ц/б";
  end;
   
  if( (dl_comm.DocKind != DL_RESERVEDOC) and 
      (dl_comm.OperationKind != KINDRES_DEAL) and
      (dl_comm.DocKind != DL_GET_INCOME) and
      (dl_comm.DocKind != DL_OVERVALUE) and
      (dl_comm.DocKind != DL_OVERVALUE_RD) and
      (dl_comm.DocKind != DL_OVERVALUE_NVPI) and
      (dl_comm.DocKind != DL_CALCTSS)
    )
     SvOpPrintError( ObjectName ); /* Ошибки будем печатать всегда */
  end;

  if( (ScOpNumInsRecord == 0) and (ReportFlag == true) and (SvOpErrorArray.Size == 0) )
    if( OprDocKind == DLDOC_ISSUE )
       SvOpPrintLine( "Нет подходящих для операции выпусков ценных бумаг." );
    elif( OprDocKind == DLDOC_PARTY )
       SvOpPrintLine( "Нет подходящих для операции субъектов." );
    elif( OprDocKind == DL_STOCKCONTR )
       SvOpPrintLine( "Нет подходящих для операции комиссий." );
    elif( OprDocKind == DL_SECURITYDOC )
       SvOpPrintLine( "Нет подходящих для операции сделок." );
    elif( OprDocKind == DL_TRUSTDOC )
       SvOpPrintLine( "Нет подходящих для операции сделок ДУ." );
    elif( OprDocKind == DL_NTGSEC )
       SvOpPrintLine( "Нет подходящих для операции сделок неттинга." );
    elif( OprDocKind == DL_RETIREMENT) 
       SvOpPrintLine( "Нет подходящих для операции погашений." );
    elif( OprDocKind == DL_CONVAVR) 
       SvOpPrintLine( "Нет подходящих операций конвертации ц/б." );
    end; 
    if( dl_comm.CommStatus==DL_COMM_CLOSED )
        SvOpPrintLine( "Сервисная операция закрыта." );
    end;

  end;

  ScOpIsServiceOper  = false;
  close( SvOpReportFile );
  if( (ShowReport == true) AND 
      (
        (SvOpErrorArray.Size > 0) or (ReportFlag == true) 
      )
    )
    ViewFile( SvOpReportFile );
  end;
end;

/* Установка подсказки для скролингов из макроса */
PRIVATE MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string
  //  Возможные значения ScrolStatus:
  //  DL_COMM_PREPARING = 0,  // на этапе подготовки
  //  DL_COMM_READIED,        // готовые (создана операция)
  //  DL_COMM_CLOSED,         // закрытые
  //  DL_COMM_ALL             // все


  //  Возможные значения ScrolKind:
  //  DL_COMMDOC     = 104,   // Операции расчета комиссий
  //  DL_RESERVEDOC  = 106,   // Операции резервирования средств под обесценивание ЦБ
  //  DL_OVERVALUE   = 108,   // Операции переоценки ценных бумаг
  //  DL_OVERVALUE_RD  = 123,  // Переоценка внебаланса
  //  DL_OVERVALUE_NVPI = 134,  // Переоценка НВПИ
  //  DL_GET_INCOME     = 157, // БОЦБ - начисление процентного/дисконтного дохода

  //пример
  //return "/*+FIRST_ROWS LEADING(t) INDEX(t ddl_comm_dbt_idx0)*/";

  return DefaultHint;

END;

/*установка значений в панели операции по умолчанию (преимущественно для checkbox)*/
MACRO SvOpSetInitParms(p_dl_com)
  VAR dl_comm_buf = TRecHandler( "dl_comm" );
  dl_comm_buf.SetRecordAddr( p_dl_com );

  /*пример*/
  // if( dl_comm_buf.rec.DocKind == DL_GET_INCOME )
  //    dl_comm_buf.rec.Flag1        = SET_CHAR;/*процентный*/
  //    dl_comm_buf.rec.Flag4        = UNSET_CHAR;/*дисконтный*/
  //    dl_comm_buf.rec.Flag5        = UNSET_CHAR;/*только по выпускам ц/б, где были движения*/
  //    dl_comm_buf.rec.Flag2        = SET_CHAR;/*доход, подлежащий выплате контрагентам по сделкам РЕПО/займа*/
  //    dl_comm_buf.rec.Flag3        = SET_CHAR;/*Начисление дохода (расхода) по сделкам РЕПО/займа*/
  //    dl_comm_buf.rec.CreateReport = SET_CHAR;/*Формировать отчет*/
  // elif( dl_comm_buf.rec.DocKind == DL_OVERVALUE )
  //    /*выставим все галочки*/
  //    dl_comm_buf.rec.Flag2        = SET_CHAR;/*выпуски, с которыми были заключены сделки*/
  //    dl_comm_buf.rec.Flag3        = SET_CHAR;/*выпуски, по которым была поставка ц/б*/
  //    dl_comm_buf.rec.Flag4        = SET_CHAR;/*выпуски, по которым была оплата ц/б*/
  //    dl_comm_buf.rec.Flag6        = SET_CHAR;/*переоценка только Т/О, исполняемых на следующий день*/
  //
  //    if( (dl_comm_buf.rec.Flag2 == SET_CHAR) or (dl_comm_buf.rec.Flag3 == SET_CHAR) or (dl_comm_buf.rec.Flag4 == SET_CHAR) )
  //       dl_comm_buf.rec.Flag1 = SET_CHAR;/*Вложения в ценные бумаги*/
  //    end;
  //    if( (dl_comm_buf.rec.Flag6 == SET_CHAR) )
  //       dl_comm_buf.rec.Flag5 = SET_CHAR;/*Требования/обязательства по возврату ц/б*/
  //    end;
  //
  //    dl_comm_buf.rec.CreateReport = SET_CHAR;/*Формировать отчет*/
  // end;

END;

private macro FindFirstDLRQbyDocKind(DocKind, DocID, DealPart, Type, buf )

   var query, ds, str_select = "";

   str_select = 
              " SELECT * "
            + "  FROM "
            + "        ddlrq_dbt rq "
            + "  WHERE     rq.t_DocKind = " + DocKind
            + "        AND rq.t_DocID = " + DocID
            + "        AND rq.t_DealPart = " + DealPart
            + "        AND rq.t_Type = " + Type
            + "        AND rownum < 2 ";

   query = RSDCommand( str_select );
   query.execute();

   ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
   if( ds.MoveNext() )
      ds.GetRecord().CopyTo( buf );
   else
      return false;
   end;
   
   return true;
end;
