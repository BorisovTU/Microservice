/*
$Name:         spretownfun.mac 
$Module:       Ценные бумаги
$Description:  Операция погашения выпуска/купона ОЭБ. Функции
*/
import "sp_car.mac", "SCPeriodComm.mac";

macro ОЭБ_ВычислитьНалогиПоКупону(FIID:integer, Number_Coupon:string, dat:date, PayFIID:integer, СуммаНалогаЮЛН:@money, СуммаНалогаФЛН:@money, СуммаНалогаФЛР:@money)
  var DataSet, cmd, query;
  var СуммаВыплаты = $0, СуммаВыплатыРуб = $0;
  var СуммаНалога  = $0;
  var Circulate = 0, TaxGroupNPTX = 0, TaxGroupNUTX = 0;
  var onwtaxCache = RsbSQLInsert("scowntax.tmp");
  var owntaxArr = TArray();
  var fin = TBfile("fininstr.dbt");
  var fiw = TBFile("fiwarnts.dbt");
  var party = TRecHandler("party.dbt");
  var FactReceiverID = -1;
  var Rate = 0;
  var err = 0;

  СуммаНалогаЮЛН = $0; 
  СуммаНалогаФЛН = $0; 
  СуммаНалогаФЛР = $0;

  SQL_Execute("DELETE FROM DSCOWNTAX_TMP", "", false );

  fin.Clear();
  fin.rec.FIID = FIID;
  
  if(not fin.GetEQ())
    msgbox("Не найдена ц/б с идентификатором " + FIID);
    return 1;
  end;

  fiw.Clear();
  fiw.rec.FIID      = FIID;
  fiw.rec.IsPartial = UNSET_CHAR;
  fiw.rec.Number    = Number_Coupon;

  if(not fiw.GetEQ())
    msgbox("Не найден купон с номером " + Number_Coupon);
    return 1;
  end;

  query =  " select NPTO.Market1date(?, ?) t_Circulate, "
         + "        NPTO.GetPaperTaxGroupNPTX(?) t_TaxGroupNPTX, "
         + "        RSI_NUTX.GetNUTaxGroup(?, ?) t_TaxGroupNUTX"
         + "   from dual";

  cmd = Dl_RSDCommand(query);

  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(dat);
  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    Circulate    = int(DataSet.Circulate);
    TaxGroupNPTX = int(DataSet.TaxGroupNPTX);
    TaxGroupNUTX = int(DataSet.TaxGroupNUTX);
  end;

  query =   " select sh.t_ID as SHID, sh.t_OwnerID as Party, "
          + "        (sh.t_Total+ (CASE WHEN sh.t_Denominator != 0 THEN sh.t_Numerator/sh.t_Denominator ELSE 0 END)) as Amount, "
          + "        pt.t_LegalForm, "
          + "        (CASE WHEN pt.t_LegalForm = "+PTLEGF_PERSN+" THEN sh.t_OwnerID "
          + "              WHEN pt.t_LegalForm = "+PTLEGF_INST+" AND RSB_SECUR.IsTaxResident(sh.t_OwnerID, ?) = 0 THEN RSI_NUTX.GetFactReceiverForNUTX(sh.t_OwnerID) "
          + "              ELSE -1 END) as FactReceiverID "
          + "   from dscownlist_dbt ls, dscownhist_dbt sh, dparty_dbt pt "
          + "  where ls.t_FIID = ? "
          + "    and ls.t_Number_Coupon = ? "
          + "    and sh.t_ListID = ls.t_ListID "
          + "    and (sh.t_AccType = '01' or sh.t_IsFullOpen = CHR(0)) "
          + "    and (sh.t_ExcludeDate = "+GetSQLDate(date(0,0,0))+" or sh.t_ExcludeDate > ?)"
          + "    and pt.t_PartyID = sh.t_OwnerID ";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(dat);
  cmd.AddParam(fin.rec.FIID);
  cmd.AddParam(Number_Coupon);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
   
  while((not err) and (DataSet.moveNext())) //для каждого владельца

    Rate = 0.0;
    СуммаНалога = $0;
    FactReceiverID = int(DataSet.FactReceiverID);

    if(FactReceiverID == -1)
      continue;
    end;

    if(ПолучитьСубъекта(DataSet.Party, party) != 0 )
      msgbox("Не найден субъект с идентификатором " + DataSet.Party);
      return 1;
    end;

    if(ПолучитьСубъекта(FactReceiverID, party) != 0 )
      msgbox("Не найден субъект с идентификатором " + FactReceiverID);
      return 1;
    end;

    СуммаВыплаты = СуммаКупона(fin.rec.FIID, int(DataSet.Amount), fiw.rec.DrawingDate);
    if(fin.rec.FaceValueFI != PayFIID)
      if( not SmartConvertSum(СуммаВыплаты, СуммаВыплаты, dat, fin.rec.FaceValueFI, PayFIID, true))
        return 1;
      end;
    end;
    if(fin.rec.FaceValueFI != NATCUR)
      if( not SmartConvertSum(СуммаВыплатыРуб, СуммаВыплаты, dat, fin.rec.FaceValueFI, NATCUR, true))
        return 1;
      end;
    else
      СуммаВыплатыРуб = СуммаВыплаты;
    end;

    СуммаВыплаты    = round(СуммаВыплаты, 2);
    СуммаВыплатыРуб = round(СуммаВыплатыРуб, 2);

    if(party.rec.LegalForm == PTLEGF_PERSN)

      if(party.rec.NotResident == SET_CHAR)
        if(ПолучитьЗначениеПримечанияНаДату(party, PARTY_NOTE_KIND_NPTX_RATE_NOTRES, dat, @Rate) != 0) //если нет примечания
          Rate = NPTXGENTAXRATE_NOTRESIDENT;       
        end;

        СуммаНалога = round(СуммаВыплатыРуб * Rate, 2);
        СуммаНалогаФЛН = СуммаНалогаФЛН + СуммаНалога;
      else
        Rate = NPTXGENTAXRATE_RESIDENT;

        СуммаНалога = round(СуммаВыплатыРуб * Rate, 2);
        СуммаНалогаФЛР = СуммаНалогаФЛР + СуммаНалога;
      end;

    elif((party.rec.LegalForm == PTLEGF_INST) and (IsNeresidentForNUTX(party.rec.PartyID, dat)))
      if(TaxGroupNUTX == NUTAXGROUP_20)
        Rate = GetTaxRateNUTX(INCOME_KIND_PERC, dat, FactReceiverID);
      elif(TaxGroupNUTX == NUTAXGROUP_15)
        var IfMarket = FIIfMarketNUTX(fin.rec.FIID, dat);
        if(IfMarket)
          Rate = GetTaxRateNUTX(INCOME_KIND_PRIVPERC, dat, FactReceiverID);
        else
          Rate = GetTaxRateNUTX(INCOME_KIND_PERC, dat, FactReceiverID);
        end;
      end;

      СуммаНалога = round(СуммаВыплатыРуб * Rate, 2);
      СуммаНалогаЮЛН = СуммаНалогаЮЛН + СуммаНалога;
    end;

    var sz = owntaxArr.size;
    owntaxArr[sz] = TRecHandler("scowntax.tmp");

    owntaxArr[sz].Clear();
    owntaxArr[sz].rec.SHID           = DataSet.SHID;
    owntaxArr[sz].rec.FactReceiverID = FactReceiverID;
    owntaxArr[sz].rec.PaySum         = СуммаВыплаты;
    owntaxArr[sz].rec.PayCur         = fin.rec.FaceValueFI;
    owntaxArr[sz].rec.TaxRate        = Rate * 100.0;
    owntaxArr[sz].rec.TaxSum         = СуммаНалога;
  end;
   
  if((not err) and (owntaxArr.size > 0))
    onwtaxCache.AddRecordArray(owntaxArr);

    if(not onwtaxCache.Insert())
      err = 1;
    end;
  end;
  
  return err;
end;

macro ОЭБ_РассчитатьНалогиПоКупону(FD, dat:date)
  var TaxSum = 1;
  var DataSet, cmd, query;
  var rRqAcc = TRecHandler("dlrqacc.dbt");
  var rSA    = TRecHandler("settacc.dbt");
  var DlRq   = TRecHandler("dlrq.dbt");
  var party  = TRecHandler("party.dbt");
  var TaxReceiverID = -1, FactReceiverID = -1;
  var err = 0;   
  var СуммаНалогаЮЛН = $0, СуммаНалогаФЛН = $0, СуммаНалогаФЛР = $0;
  var TmpRqAccID = 0;
  var Rate = 0;
  
  err = ОЭБ_ВычислитьНалогиПоКупону(FD.tick.rec.PFI, FD.tick.rec.Number_Coupon, dat, FD.dl_leg.rec.PayFIID, @СуммаНалогаЮЛН, @СуммаНалогаФЛН, @СуммаНалогаФЛР);

  if(not err)
    if(ПолучитьСубъекта({OurBank}, party) == 0 )
      TaxReceiverID = party.rec.TaxInstitution;
    else
      msgbox("Не найден субъект с идентификатором " + {OurBank});
      err = 1;
    end;
  end;

  if((not err) and (TaxReceiverID == -1))
    msgbox("Для банка не указана налоговая инспекция");
    err = 1;
  end;
  
  if((not err) and (СуммаНалогаЮЛН > 0))
    СуммаНалогаЮЛН = round(СуммаНалогаЮЛН, 0); /*DAN округление расчитанной суммы налога*/
    rRqAcc.Clear();
    if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, TaxReceiverID, DLRQ_SUBKIND_CURRENCY, NATCUR, DLRQ_TYPE_TAX_ULN, rRqAcc) != 0) //нет подходящих платежных реквизитов
      rSA.Clear();
      if(SP_GetPartySETTACC(TaxReceiverID, 0, NATCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType, PM_PURP_TAXINCOME_NJ) == 0)
        //создать новые платежные реквизиты
        rRqAcc.rec.ID               = 0;     
        rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
        rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
        rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
        rRqAcc.rec.Type             = DLRQ_TYPE_TAX_ULN;     
        rRqAcc.rec.Party            = TaxReceiverID;     
        rRqAcc.rec.FIID             = rSA.rec.FIID;                 
        rRqAcc.rec.BankID           = rSA.rec.BankID;               
        rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
        rRqAcc.rec.Account          = rSA.rec.Account;         
        rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
        rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
        rRqAcc.rec.BankName         = rSA.rec.BankName;        
        rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
        rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
        rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
        rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
        rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

        TmpRqAccID = TmpRqAccID - 1;

        if( DL_InsertDLRQACC(rRqAcc) )
          msgbox( "Ошибка вставки платежных реквизитов для налога с кодом \""+DataSet.Code+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
          err = 1;
        end;
      else
        msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+TaxReceiverID);
        err = 1;
      end;
    end;

    if(not err)
      DlRq.Clear();
      DlRq.rec.DocKind  = FD.tick.rec.BofficeKind;
      DlRq.rec.DocID    = FD.tick.rec.DealID;     
      DlRq.rec.DealPart = 1;
      DlRq.rec.Kind     = DLRQ_KIND_COMMIT;
      DlRq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
      DlRq.rec.Type     = DLRQ_TYPE_TAX_ULN;
      DlRq.rec.Amount   = СуммаНалогаЮЛН;
      DlRq.rec.FIID     = NATCUR;
      DlRq.rec.Party    = TaxReceiverID;
      DlRq.rec.RqAccID  = iif(rRqAcc.rec.ID > 0, rRqAcc.rec.ID, TmpRqAccID);
      DlRq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0, rRqAcc.rec.BANKCORRID, rRqAcc.rec.BANKID);
      DlRq.rec.State    = DLRQ_STATE_PLAN;
      DlRq.rec.PlanDate = FD.dl_leg.rec.Expiry;
      DlRq.rec.FactDate = date(0,0,0);
     
      if( DL_CreateDLRQ(DlRq, dat, DLRQ_ACTION_CREATE) != 0 )
         msgbox( "Ошибка при создании ТО по налогу с кодом \""+DataSet.Code+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
         err = 1;
      end;
    end;

  end;

  if((not err) and (СуммаНалогаФЛН > 0))
    СуммаНалогаФЛН = round(СуммаНалогаФЛН, 0); /*DAN округление расчитанной суммы налога*/
    rRqAcc.Clear();
    if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, TaxReceiverID, DLRQ_SUBKIND_CURRENCY, NATCUR, DLRQ_TYPE_TAX_FLN, rRqAcc) != 0) //нет подходящих платежных реквизитов
      rSA.Clear();
      if(SP_GetPartySETTACC(TaxReceiverID, 0, NATCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType, PM_PURP_TAXINCOME_IND) == 0)
        //создать новые платежные реквизиты
        rRqAcc.rec.ID               = 0;     
        rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
        rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
        rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
        rRqAcc.rec.Type             = DLRQ_TYPE_TAX_FLN;     
        rRqAcc.rec.Party            = TaxReceiverID;     
        rRqAcc.rec.FIID             = rSA.rec.FIID;                 
        rRqAcc.rec.BankID           = rSA.rec.BankID;               
        rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
        rRqAcc.rec.Account          = rSA.rec.Account;         
        rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
        rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
        rRqAcc.rec.BankName         = rSA.rec.BankName;        
        rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
        rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
        rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
        rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
        rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

        TmpRqAccID = TmpRqAccID - 1;

        if( DL_InsertDLRQACC(rRqAcc) )
          msgbox( "Ошибка вставки платежных реквизитов для налога с кодом \""+DataSet.Code+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
          err = 1;
        end;
      else
        msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+TaxReceiverID);
        err = 1;
      end;
    end;

    if(not err)
      DlRq.Clear();
      DlRq.rec.DocKind  = FD.tick.rec.BofficeKind;
      DlRq.rec.DocID    = FD.tick.rec.DealID;     
      DlRq.rec.DealPart = 1;
      DlRq.rec.Kind     = DLRQ_KIND_COMMIT;
      DlRq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
      DlRq.rec.Type     = DLRQ_TYPE_TAX_FLN;
      DlRq.rec.Amount   = СуммаНалогаФЛН;
      DlRq.rec.FIID     = NATCUR;
      DlRq.rec.Party    = TaxReceiverID;
      DlRq.rec.RqAccID  = iif(rRqAcc.rec.ID > 0, rRqAcc.rec.ID, TmpRqAccID);
      DlRq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0, rRqAcc.rec.BANKCORRID, rRqAcc.rec.BANKID);
      DlRq.rec.State    = DLRQ_STATE_PLAN;
      DlRq.rec.PlanDate = FD.dl_leg.rec.Expiry;
      DlRq.rec.FactDate = date(0,0,0);
     
      if( DL_CreateDLRQ(DlRq, dat, DLRQ_ACTION_CREATE) != 0 )
         msgbox( "Ошибка при создании ТО по налогу с кодом \""+DataSet.Code+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
         err = 1;
      end;
    end;

  end;

  if((not err) and (СуммаНалогаФЛР > 0))
    СуммаНалогаФЛР = round(СуммаНалогаФЛР, 0); /*DAN округление расчитанной суммы налога*/
    rRqAcc.Clear();
    if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, TaxReceiverID, DLRQ_SUBKIND_CURRENCY, NATCUR, DLRQ_TYPE_TAX_FLR, rRqAcc) != 0) //нет подходящих платежных реквизитов
      rSA.Clear();
      if(SP_GetPartySETTACC(TaxReceiverID, 0, NATCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType, PM_PURP_TAXINCOME_IND) == 0)
        //создать новые платежные реквизиты
        rRqAcc.rec.ID               = 0;     
        rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
        rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
        rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
        rRqAcc.rec.Type             = DLRQ_TYPE_TAX_FLR;     
        rRqAcc.rec.Party            = TaxReceiverID;     
        rRqAcc.rec.FIID             = rSA.rec.FIID;                 
        rRqAcc.rec.BankID           = rSA.rec.BankID;               
        rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
        rRqAcc.rec.Account          = rSA.rec.Account;         
        rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
        rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
        rRqAcc.rec.BankName         = rSA.rec.BankName;        
        rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
        rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
        rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
        rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
        rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

        TmpRqAccID = TmpRqAccID - 1;

        if( DL_InsertDLRQACC(rRqAcc) )
          msgbox( "Ошибка вставки платежных реквизитов для налога с кодом \""+DataSet.Code+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
          err = 1;
        end;
      else
        msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+TaxReceiverID);
        err = 1;
      end;
    end;

    if(not err)
      DlRq.Clear();
      DlRq.rec.DocKind  = FD.tick.rec.BofficeKind;
      DlRq.rec.DocID    = FD.tick.rec.DealID;     
      DlRq.rec.DealPart = 1;
      DlRq.rec.Kind     = DLRQ_KIND_COMMIT;
      DlRq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
      DlRq.rec.Type     = DLRQ_TYPE_TAX_FLR;
      DlRq.rec.Amount   = СуммаНалогаФЛР;
      DlRq.rec.FIID     = NATCUR;
      DlRq.rec.Party    = TaxReceiverID;
      DlRq.rec.RqAccID  = iif(rRqAcc.rec.ID > 0, rRqAcc.rec.ID, TmpRqAccID);
      DlRq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0, rRqAcc.rec.BANKCORRID, rRqAcc.rec.BANKID);
      DlRq.rec.State    = DLRQ_STATE_PLAN;
      DlRq.rec.PlanDate = FD.dl_leg.rec.Expiry;
      DlRq.rec.FactDate = date(0,0,0);
     
      if( DL_CreateDLRQ(DlRq, dat, DLRQ_ACTION_CREATE) != 0 )
         msgbox( "Ошибка при создании ТО по налогу с кодом \""+DataSet.Code+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg() );
         err = 1;
      end;
    end;

  end;

  if(not err)
    var PayImcome = FD.GetRQ(DLRQ_TYPE_PAYINCOME).rec.Amount - СуммаНалогаЮЛН - СуммаНалогаФЛН - СуммаНалогаФЛР;
    
    FD.GetRQ(DLRQ_TYPE_PAYINCOME).rec.Amount = PayImcome;
  end;

  if(not err)
    err = SC_SaveOwnTaxFromTMP();
  end;

  return err;
end;

macro ПолучитьКодКомиссииОЭБ_ПГКУП()
  return "ПГ_КУП";
end;

macro ПолучитьКодКомиссииОЭБ_ПГВЫП()
  return "ПГ_ВЫП";
end;

//Рассчитать комиссию платежному агенту при погашении ц/б или купона ОЭБ
macro ОЭБ_РассчитатьКомиссиюПАПриПогашении(FD, CommCode:string, dat:date, Sum:@money, NDS:@money)
  var err = 0, errMes = "";
  var ArrComSums = TArray();
  var query, cmd, DataSet;
  var rRqAcc = TRecHandler("dlrqacc.dbt");
  var rSA    = TRecHandler("settacc.dbt");
  var dlcomis= TRecHandler("dlcomis.dbt");
  var SfContrID = 0;

  Sum = $0;
  NDS = $0;

  if((FD.avrserv() == NULL) or (FD.avrserv().rec.PartyContrP <= 0))
    msgbox("В параметрах обслуживания выпуска ц/б не указан договор с платежным агентом");
    return 1;
  end;
  
  SfContrID = FD.avrserv().rec.PartyContrP;


  query =   " select contr.t_ContractorID, concom.t_ID as ConComID, concom.t_CommNumber, cm.t_FIID_COMM, cm.t_PayNDS"
          + "   from dsfcontr_dbt contr, dsfconcom_dbt concom, dsfcomiss_dbt cm "
          + "  where contr.t_ID = ? "
          + "    and concom.t_ObjectType = " + OBJTYPE_SFCONTR
          + "    and concom.t_ObjectID = contr.t_ID " 
          + "    and concom.t_FeeType = " + SF_FEE_TYPE_SINGLE
          + "    and concom.t_DateBegin = "+GetSQLDate(date(0,0,0))+" or concom.t_DateBegin <= ? "
          + "    and cm.t_FeeType = concom.t_FeeType "
          + "    and cm.t_Number = concom.t_CommNumber "
          + "    and cm.t_Code = ? ";

  cmd = DL_RSdCommand(query);

  cmd.AddParam(SfContrID);
  cmd.AddParam(dat);
  cmd.AddParam(CommCode);

  DataSet = cmd.Execute();
  
  if(DataSet.MoveNext())
    if(SfCalcOprSfCom(SfContrID, DataSet.CommNumber, FD.tick, FD.tick.rec.BOfficeKind, $0, -1, NULL, NULL, Sum, NDS) == false)
      Sum = $0;
      NDS = $0;
      msgbox( "Ошибка расчета сумм периодической комиссии с номером "+DataSet.CommNumber+".\n" + errMes) ;
      err = 1;
    end;

    if((not err) and (Sum > 0))
      rRqAcc.Clear();
      if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, DataSet.ContractorID, DLRQ_SUBKIND_CURRENCY, DataSet.t_FIID_COMM, DLRQ_TYPE_COMISS, rRqAcc) != 0) //нет подходящих платежных реквизитов
        rSA.Clear();
        if(SP_GetPartySETTACC(DataSet.ContractorID, 0, DataSet.FIID_COMM, FIKIND_CURRENCY, 0, rSA) == 0)
          //создать новые платежные реквизиты
          rRqAcc.rec.ID               = 0;     
          rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
          rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
          rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
          rRqAcc.rec.Type             = DLRQ_TYPE_COMISS;     
          rRqAcc.rec.Party            = DataSet.ContractorID;     
          rRqAcc.rec.FIID             = rSA.rec.FIID;                 
          rRqAcc.rec.BankID           = rSA.rec.BankID;               
          rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
          rRqAcc.rec.Account          = rSA.rec.Account;         
          rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
          rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
          rRqAcc.rec.BankName         = rSA.rec.BankName;        
          rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
          rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
          rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
          rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
          rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

          if( DL_InsertDLRQACC(rRqAcc) )
            msgbox("Ошибка вставки платежных реквизитов для комиссии с номером \""+DataSet.CommNumber+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg());
            err = 1;
          end;
        else
          msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+DataSet.ContractorID);
          err = 1;
        end;
      end;

      if(not err)
        dlcomis.Clear();
        dlcomis.rec.DOCKIND     = FD.tick.rec.BofficeKind;
        dlcomis.rec.DOCID       = FD.tick.rec.DealID;
        dlcomis.rec.CONTRACT    = SfContrID;
        dlcomis.rec.FEETYPE     = SF_FEE_TYPE_SINGLE;
        dlcomis.rec.COMNUMBER   = DataSet.CommNumber;

        if(DataSet.PayNDS == SF_NOT_ADD_TAX)
          dlcomis.rec.SUM = Sum + NDS;
        else 
          dlcomis.rec.SUM = Sum; 
        end;
        
        dlcomis.rec.NDS         = NDS;
        dlcomis.rec.DATE        =
        dlcomis.rec.PLANPAYDATE = 
        dlcomis.rec.FACTPAYDATE = dat;
        dlcomis.rec.INPUTMEDIUM = GetInputMedium(INPUTMEDIUM_CALC);

        dlcomis.rec.IMMATERIAL  = UNSET_CHAR;
                    
        if( not OprInsertDLCOMIS( dlcomis ) )
          msgbox(GetErrMsg());
          err = 1;
        end;
      end;
    end;
  end;

  return err;
end;


macro ОЭБ_НДРПриПогашКупона(FD, dat:date, ID_Operation:integer, ID_Step:integer)
  var query, cmd, DataSet;
  var err = 0;
  var СуммаВыплаты = $0, СуммаВыплатыРуб = $0;
  var СуммаНалога  = $0;
  var Circulate = 0, TaxGroupNPTX = 0, TaxGroupNUTX = 0;
  var Kind = 0;
  var СуммаНалогаЮЛН = $0, СуммаНалогаФЛН = $0, СуммаНалогаФЛР = $0;
  var TaxReceiverID = -1, FactReceiverID = -1, OwnerID = -1;
  var TmpRqAccID = 0;
  var ContractID = 0;
  var IsIIS = false;
  var party = TRecHandler("party.dbt");

  query =  " select NPTO.Market1date(?, ?) t_Circulate, "
         + "        NPTO.GetPaperTaxGroupNPTX(?) t_TaxGroupNPTX, "
         + "        RSI_NUTX.GetNUTaxGroup(?, ?) t_TaxGroupNUTX"
         + "   from dual";

  cmd = Dl_RSDCommand(query);

  cmd.AddParam(FD.tick.rec.PFI);
  cmd.AddParam(dat);
  cmd.AddParam(FD.tick.rec.PFI);
  cmd.AddParam(FD.tick.rec.PFI);
  cmd.AddParam(dat);
  
  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    Circulate    = int(DataSet.Circulate);
    TaxGroupNPTX = int(DataSet.TaxGroupNPTX);
    TaxGroupNUTX = int(DataSet.TaxGroupNUTX);

    query =   " select sh.t_OwnerID, tx.t_FactReceiverID, tx.t_PaySum, tx.t_PayCur, tx.t_TaxSum, tx.t_TaxRate, "
            + "        NVL((select sf.t_ID "
            + "               from dsfcontr_dbt sf "
            + "              where sf.t_ServKind = " + PTSK_STOCKDL
            + "                and sf.t_PartyID = sh.t_OwnerID "
            + "                and sf.t_DateBegin <= ? "
            + "                and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ?) "
            + "                and rsi_npto.CheckContrIIS(sf.t_ID) = 0 "
            + "                and rownum = 1"
            + "            ), 0) as NotIISSfContrID, "
            + "        NVL((select sf.t_ID "
            + "               from dsfcontr_dbt sf "
            + "              where sf.t_ServKind = " + PTSK_STOCKDL
            + "                and sf.t_PartyID = sh.t_OwnerID "
            + "                and sf.t_DateBegin <= ? "
            + "                and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ?) "
            + "                and rsi_npto.CheckContrIIS(sf.t_ID) = 1 "
            + "                and rownum = 1"
            + "            ), 0) as IISSfContrID "
            + "   from dscownlist_dbt ls, dscownhist_dbt sh, dscowntax_dbt tx "
            + "  where ls.t_FIID = ? "
            + "    and ls.t_Number_Coupon = ? "
            + "    and sh.t_ListID = ls.t_ListID "
            + "    and tx.t_SHID = sh.t_ID "
            + "    and tx.t_TaxSum > 0";
 
    cmd = DL_RSDCommand(query);

    cmd.AddParam(dat);
    cmd.AddParam(dat);
    cmd.AddParam(dat);
    cmd.AddParam(dat);
    cmd.AddParam(FD.tick.rec.PFI);
    cmd.AddParam(FD.tick.rec.Number_Coupon);

    DataSet = cmd.Execute();

    while((not err) and (DataSet.moveNext())) //для каждого владельца

      OwnerID = DataSet.OwnerID;

      if(ПолучитьСубъекта(OwnerID, party) != 0 )
        msgbox("Не найден субъект с идентификатором " + OwnerID);
        return 1;
      end;

      FactReceiverID = DataSet.FactReceiverID;

      if(FactReceiverID == -1)
        continue;
      end;

      if(ПолучитьСубъекта(FactReceiverID, party) != 0 )
        msgbox("Не найден субъект с идентификатором " + FactReceiverID);
        return 1;
      end;

      ContractID = int(DataSet.NotIISSfContrID);
      isIIS = false;
      if(ContractID == 0)
        ContractID = int(DataSet.IISSfContrID);
        if(ContractID > 0)
        isIIS = true;
        else
           isIIS = false;
        end;
      end;

      СуммаВыплаты = DataSet.PaySum;
      if(DataSet.PayCur != FD.dl_leg.rec.PayFIID)
        if( not SmartConvertSum(СуммаВыплаты, СуммаВыплаты, dat, DataSet.PayCur, FD.dl_leg.rec.PayFIID, true))
          return 1;
        end;
      end;
      if(DataSet.PayCur != NATCUR)
        if( not SmartConvertSum(СуммаВыплатыРуб, СуммаВыплаты, dat, DataSet.PayCur, NATCUR, true))
          return 1;
        end;
      else
        СуммаВыплатыРуб = СуммаВыплаты;
      end;

      СуммаВыплаты    = round(СуммаВыплаты, 2);
      СуммаВыплатыРуб = round(СуммаВыплатыРуб, 2);

      СуммаНалога = DataSet.TaxSum;

      if(party.rec.LegalForm == PTLEGF_PERSN)

        err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                      ,FactReceiverID        // Клиент
                                      ,TXOBJ_DIR_IN          // Направление
                                      ,2                     // Уровень
                                      ,""                    // Признак "Пользовательский"
                                      ,TXOBJ_PROCSEC_TS      // Вид НДР
                                      ,СуммаВыплаты          // Сумма дохода/расхода
                                      ,FD.dl_leg.rec.PayFIID // Валюта дохода/расхода
                                      ,TXOBJ_KIND1020        // Вид аналитики 1
                                      ,FD.tick.rec.DealID    // Аналитика 1
                                      ,0                     // Вид аналитики 2
                                      ,-1                    // Аналитика 2
                                      ,TXOBJ_KIND3010        // Вид аналитики 3
                                      ,FD.tick.rec.PFI       // Аналитика 3
                                      ,TXOBJ_KIND4010        // Вид аналитики 4
                                      ,Circulate             // Аналитика 4
                                      ,TXOBJ_KIND5010        // Вид аналитики 5
                                      ,TaxGroupNPTX          // Аналитика 5
                                      ,TXOBJ_KIND6020        // Вид аналитики 6
                                      ,ContractID            // Аналитика 6
                                      ,""                    // Комментарий
                                      ,ID_Operation          // ID операции
                                      ,ID_Step               // ID шага операции
                                      ,1 );                  // Признак вызова не из операции расчета НОБ
        if(not err)
          Kind = IIF(IsIIS == true, TXOBJ_PLUSG_1011_IIS, TXOBJ_PLUSG_1011);
          
          err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                        ,FactReceiverID        // Клиент
                                        ,TXOBJ_DIR_IN          // Направление
                                        ,5                     // Уровень
                                        ,""                    // Признак "Пользовательский"
                                        ,Kind                  // Вид НДР
                                        ,СуммаВыплатыРуб       // Сумма дохода/расхода
                                        ,NATCUR                // Валюта дохода/расхода
                                        ,TXOBJ_KIND1020        // Вид аналитики 1
                                        ,FD.tick.rec.DealID    // Аналитика 1
                                        ,0                     // Вид аналитики 2
                                        ,-1                    // Аналитика 2
                                        ,TXOBJ_KIND3010        // Вид аналитики 3
                                        ,FD.tick.rec.PFI       // Аналитика 3
                                        ,TXOBJ_KIND4010        // Вид аналитики 4
                                        ,Circulate             // Аналитика 4
                                        ,TXOBJ_KIND5010        // Вид аналитики 5
                                        ,TaxGroupNPTX          // Аналитика 5
                                        ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                        ,ContractID            // Аналитика 6
                                        ,""                    // Комментарий
                                        ,ID_Operation          // ID операции
                                        ,ID_Step               // ID шага операции
                                        ,1 );                  // Признак вызова не из операции расчета НОБ
        end;
        
        if(not err)
          Kind = IIF(IsIIS == true, TXOBJ_BASEGENERAL_IIS, TXOBJ_BASEGENERAL);
          
          err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                        ,FactReceiverID        // Клиент
                                        ,TXOBJ_DIR_IN          // Направление
                                        ,7                     // Уровень
                                        ,""                    // Признак "Пользовательский"
                                        ,Kind                  // Вид НДР
                                        ,СуммаВыплатыРуб       // Сумма дохода/расхода
                                        ,NATCUR                // Валюта дохода/расхода
                                        ,TXOBJ_KIND1020        // Вид аналитики 1
                                        ,FD.tick.rec.DealID    // Аналитика 1
                                        ,0                     // Вид аналитики 2
                                        ,-1                    // Аналитика 2
                                        ,TXOBJ_KIND3010        // Вид аналитики 3
                                        ,FD.tick.rec.PFI       // Аналитика 3
                                        ,TXOBJ_KIND4010        // Вид аналитики 4
                                        ,Circulate             // Аналитика 4
                                        ,TXOBJ_KIND5010        // Вид аналитики 5
                                        ,TaxGroupNPTX          // Аналитика 5
                                        ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                        ,ContractID            // Аналитика 6
                                        ,""                    // Комментарий
                                        ,ID_Operation          // ID операции
                                        ,ID_Step               // ID шага операции
                                        ,1 );                  // Признак вызова не из операции расчета НОБ
        end;
        
        if((not err) and (СуммаНалога > 0))
          
          Kind = IIF(IsIIS == true, TXOBJ_PAIDGENERAL_IIS, TXOBJ_PAIDGENERAL);
          
          err = DL_NPTX_InsertTaxObject( dat                   // Дата НДР
                                        ,FactReceiverID        // Клиент
                                        ,TXOBJ_DIR_OUT         // Направление
                                        ,8                     // Уровень
                                        ,""                    // Признак "Пользовательский"
                                        ,Kind                  // Вид НДР
                                        ,СуммаНалога           // Сумма дохода/расхода
                                        ,NATCUR                // Валюта дохода/расхода
                                        ,TXOBJ_KIND1020        // Вид аналитики 1
                                        ,FD.tick.rec.DealID    // Аналитика 1
                                        ,0                     // Вид аналитики 2
                                        ,-1                    // Аналитика 2
                                        ,TXOBJ_KIND3010        // Вид аналитики 3
                                        ,FD.tick.rec.PFI       // Аналитика 3
                                        ,TXOBJ_KIND4010        // Вид аналитики 4
                                        ,Circulate             // Аналитика 4
                                        ,TXOBJ_KIND5010        // Вид аналитики 5
                                        ,TaxGroupNPTX          // Аналитика 5
                                        ,IIF(ContractID > 0, TXOBJ_KIND6020, 0) // Вид аналитики 6
                                        ,ContractID            // Аналитика 6
                                        ,""                    // Комментарий
                                        ,ID_Operation          // ID операции
                                        ,ID_Step               // ID шага операции
                                        ,1 );                  // Признак вызова не из операции расчета НОБ
        end;

      elif(party.rec.LegalForm == PTLEGF_INST)
             
        if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                              ,OwnerID               // Клиент
                                              ,FactReceiverID        // Фактический получатель дохода
                                              ,NUTXOBJ_DIR_IN        // Направление
                                              ,2                     // Уровень
                                              ,""                    // Признак "Пользовательский"
                                              ,NUTXOBJ_PLUS_11       // Вид НДР
                                              ,СуммаВыплаты          // Сумма дохода/расхода
                                              ,FD.dl_leg.rec.PayFIID // Валюта дохода/расхода
                                              ,TXOBJ_KIND1020        // Вид аналитики 1
                                              ,FD.tick.rec.DealID    // Аналитика 1
                                              ,0                     // Вид аналитики 2
                                              ,-1                    // Аналитика 2
                                              ,TXOBJ_KIND3010        // Вид аналитики 3
                                              ,FD.tick.rec.PFI       // Аналитика 3
                                              ,TXOBJ_KIND4010        // Вид аналитики 4
                                              ,Circulate             // Аналитика 4
                                              ,TXOBJ_KIND5010        // Вид аналитики 5
                                              ,TaxGroupNUTX          // Аналитика 5
                                              ,TXOBJ_KIND6020        // Вид аналитики 6
                                              ,ContractID            // Аналитика 6
                                              ,"" )                  // Комментарий
         )
           err = 1;
        end;

        if(not err)
          var sum = round(СуммаВыплатыРуб * DataSet.TaxRate / 100.0, 2);

          if(sum > 0)
            if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                                  ,OwnerID               // Клиент
                                                  ,FactReceiverID        // Фактический получатель дохода
                                                  ,NUTXOBJ_DIR_OUT       // Направление
                                                  ,5                     // Уровень
                                                  ,""                    // Признак "Пользовательский"
                                                  ,NUTXOBJ_DUETAX        // Вид НДР
                                                  ,sum                   // Сумма дохода/расхода
                                                  ,NATCUR                // Валюта дохода/расхода
                                                  ,TXOBJ_KIND1020        // Вид аналитики 1
                                                  ,FD.tick.rec.DealID    // Аналитика 1
                                                  ,0                     // Вид аналитики 2
                                                  ,-1                    // Аналитика 2
                                                  ,TXOBJ_KIND3010        // Вид аналитики 3
                                                  ,FD.tick.rec.PFI       // Аналитика 3
                                                  ,TXOBJ_KIND4010        // Вид аналитики 4
                                                  ,Circulate             // Аналитика 4
                                                  ,TXOBJ_KIND5010        // Вид аналитики 5
                                                  ,TaxGroupNUTX          // Аналитика 5
                                                  ,TXOBJ_KIND6020        // Вид аналитики 6
                                                  ,ContractID            // Аналитика 6
                                                  ,"" )                  // Комментарий
             )
               err = 1;
            end;
          end;
        end;

        if(not err)
          if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                                ,OwnerID               // Клиент
                                                ,FactReceiverID        // Фактический получатель дохода
                                                ,NUTXOBJ_DIR_OUT       // Направление
                                                ,8                     // Уровень
                                                ,""                    // Признак "Пользовательский"
                                                ,NUTXOBJ_PAIDTAX       // Вид НДР
                                                ,СуммаНалога           // Сумма дохода/расхода
                                                ,NATCUR                // Валюта дохода/расхода
                                                ,TXOBJ_KIND1020        // Вид аналитики 1
                                                ,FD.tick.rec.DealID    // Аналитика 1
                                                ,0                     // Вид аналитики 2
                                                ,-1                    // Аналитика 2
                                                ,TXOBJ_KIND3010        // Вид аналитики 3
                                                ,FD.tick.rec.PFI       // Аналитика 3
                                                ,TXOBJ_KIND4010        // Вид аналитики 4
                                                ,Circulate             // Аналитика 4
                                                ,TXOBJ_KIND5010        // Вид аналитики 5
                                                ,TaxGroupNUTX          // Аналитика 5
                                                ,TXOBJ_KIND6020        // Вид аналитики 6
                                                ,ContractID            // Аналитика 6
                                                ,"" )                  // Комментарий
           )
             err = 1;
          end;
        end;

      end;


    end;
  end;

  return err;
end;

macro ПолучитьОснованиеПроводкиПоКомиссииОЭБ_ПА(ID)
    macro set_template(s, t, v)
        var i = 1;
        while (i <= strlen(s))
            if (substr(s,i,strlen(t)) == t)
                return substr(s,1,i-1) + v + substr(s, i + strlen(t));
            end;
            i = i + 1;
        end;
        return s;
    end;


    var dlcomis = TRecHandler("DLCOMIS.dbt");
    var sfcomis = TRecHandler("SFCOMISS.dbt");

    var RS = TRsbDataSet("SELECT * FROM DDLCOMIS_DBT DLCOMIS " +
                         " WHERE T_ID = " + string(ID));
    if (RS.MoveNext())
        RS.GetRecord().CopyTo(dlcomis.rec);
    else
        return "";
    end;

    RS = TRsbDataSet("SELECT * FROM DSFCOMISS_DBT SFCM " +
                     " WHERE SFCM.T_FEETYPE = " + DLCOMIS.rec.FEETYPE +
                     " AND SFCM.T_NUMBER = " + DLCOMIS.rec.COMNUMBER);
    if (RS.MoveNext())
        RS.GetRecord().CopyTo(sfcomis.rec);
    else
        return "";
    end;

    var GroudStr = readNoteForObject(OBJTYPE_SFCOMISS, MakeObjectID(OBJTYPE_SFCOMISS, NULL, sfcomis), 1);

    if (GroudStr == "")
        if (sfcomis.rec.code == ПолучитьКодКомиссииОЭБ_ПГКУП())
            GroudStr = "Оплата комиссии за выплату дохода по купону № *№ купона* неконв. проц. докум. обл. *банк* (№ гос.рег.*выпуск*)";
        elif (sfcomis.rec.code == ПолучитьКодКомиссииОЭБ_ПГВЫП())
            GroudStr = "Оплата комиссии за выплату номинала неконв. проц. докум. обл. *банк* (№ гос.рег.*выпуск*)";
        end;
    end;

    var avr = "";
    var bank_name = "";
    var coupon = "";
    var exp_date = zerodate;

    RS = TRsbDataSet("select avr.T_LSIN av from DAVOIRISS_DBT avr, DDL_TICK_DBT tick where avr.T_FIID = tick.T_PFI and tick.T_BOFFICEKIND = " + DLCOMIS.rec.DOCKIND + " and tick.T_DEALID = " + DLCOMIS.rec.DOCID);
    if (RS.MoveNext())
        avr = rs.av;
    end;

    RS = TRsbDataSet("select pt.T_shortname name from DPARTY_DBT pt where pt.t_partyid = " + {OurBank});
    if (RS.MoveNext())
        bank_name = rs.name;
    end;

    RS = TRsbDataSet("select DDL_TICK_DBT.T_NUMBER_COUPON coupon from DDL_TICK_DBT where T_BOFFICEKIND = " + DLCOMIS.rec.DOCKIND + " AND T_DEALID = " + DLCOMIS.rec.DOCID);
    if (RS.MoveNext())
        coupon = rs.coupon;
    end;

    RS = TRsbDataSet("select leg.T_EXPIRY exp_date from DDL_LEG_DBT leg, DDL_TICK_DBT tick where tick.T_BOFFICEKIND = " + DLCOMIS.rec.DOCKIND + " and tick.T_DEALID = " + DLCOMIS.rec.DOCID + " AND  leg.T_DEALID = tick.T_DEALID and leg.T_LEGKIND = 0 and leg.T_LEGID = 0 ");
    if (RS.MoveNext())
        exp_date = rs.exp_date;
    end;

    GroudStr = set_template(GroudStr, "*выпуск*", avr);
    GroudStr = set_template(GroudStr, "*банк*", bank_name);
    GroudStr = set_template(GroudStr, "*№ купона*", coupon);
    GroudStr = set_template(GroudStr, "*дата погашения*", exp_date);
    
    return GroudStr;
end;