/*
$Name:        scpayag10.mac
$Module:      Ценные бумаги
$Description: Перечисление средств платежному агенту
*/
import "spserv.mac", "scincfun.mac", "DealsInter", "sccrpayms.mac";


private record dl_comm(dl_comm);

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)

  private macro SayError(num, errmsg)
    ScOpInsertError( DLDOC_ISSUE, dl_comm, dl_comm, num, errmsg );
    return 1;
  end;

  var dlrq = TRecHandler("dlrq");
  var FD;
  var fin = TRecHandler("fininstr.dbt");

  SetBuff(dl_comm, FDoc);

  var dl_commStep = TBFile("dl_comm.dbt");
  var stat = 0;

  dl_commStep.rec.DocumentID = dl_comm.DocumentID;
  if(not dl_commStep.GetEQ())
    msgbox("Ошибка поиска операции");
    return 1;
  end;


  FD = SPFirstDocDLCOMM(dl_comm.DocKind, dl_comm.DocumentID);

  if( (dl_comm.FIID > 0) and (ПолучитьФинИн(dl_comm.FIID, fin) != 0) ) 
    return SayError(1, "Не найдена ц/б с индентификатором " + dl_comm.FIID);
  end;
/*DAN*/
 var BondName, BondRegN;
 var sqlFI = "select fi.t_definition, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " + fd.comm.rec.fiid;
 var cmdFI = DL_RSDCommand();
 var dsFI = cmdFI.Execute(sqlFI);
 if(dsFI.moveNext())
  BondName = dsFi.value("t_definition"); 
  BondRegN = dsFi.value("t_LSIN");
 end;
/*DAN*/

  var cmd = DL_RSDCommand();

  var q =
    "SELECT RQ.*, LEG.T_PRINCIPAL, " +
    "       RSB_SECUR.IsRet_ADDINCOME(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TK.t_DealType, TK.t_BofficeKind))) as IsRet_ADDINCOME " + 
    "  FROM DDLRQ_DBT RQ, DDL_TICK_DBT TK, DDL_LEG_DBT LEG WHERE" +
    "     RQ.T_DOCKIND = " + DL_RETIREMENT_OWN +
    " AND RQ.T_SUBKIND = 0 "    +
    " AND RQ.T_PLANDATE = ? " +
    " AND RQ.T_FACTDATE = ? " +
    " AND RQ.T_STATE = " +  DLRQ_STATE_FORPROCESSING +
    " AND RQ.T_PARTY = ? " +
    " AND TK.T_DEALID = RQ.T_DOCID" +
    " AND LEG.T_DEALID = TK.T_DEALID " +
    " AND LEG.T_LEGKIND = " + LEG_KIND_DL_TICK + 
    " AND LEG.T_LEGID = 0";

  cmd.AddParam(dl_comm.CommDate);
  cmd.AddParam(ZeroDate);
  cmd.AddParam(dl_comm.PartyID);
  
  if (dl_comm.fiid != ALLFININSTR)
    q = q + " AND TK.T_PFI = ? ";
    cmd.AddParam(dl_comm.FIID);
  end;

  if(dl_comm.NUMBER_COUPON != "")
    q = q + " AND TK.T_NUMBER_COUPON = ? ";
    cmd.AddParam(dl_comm.Number_Coupon);
  end;

  q = q + " AND 1 = (CASE WHEN ? = CHR(88) AND RQ.T_TYPE = "+DLRQ_TYPE_PAYMENT+" THEN 1 "
        + "               WHEN ? = CHR(88) AND RQ.T_TYPE = "+DLRQ_TYPE_PAYINCOME+" AND RSB_SECUR.IsRet_ADDINCOME(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TK.t_DealType, TK.t_BofficeKind))) = 0 THEN 1 "
        + "               WHEN ? = CHR(88) AND RQ.T_TYPE = "+DLRQ_TYPE_PAYINCOME+" AND RSB_SECUR.IsRet_ADDINCOME(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TK.t_DealType, TK.t_BofficeKind))) <> 0 THEN 1 "
        + "               ELSE 0 END )";

  cmd.AddParam(dl_comm.Flag4);
  cmd.AddParam(dl_comm.Flag5); 
  cmd.AddParam(dl_comm.Flag6); 

  var ds = cmd.Execute(q);

  var cur, DebAccNumber="", CredAccNumber = "", sum, ground, svodground;

  var rqacc = TRecHandler("dlrqacc.dbt");
  var accbuf = TRecHandler("account.dbt");

  while (ds.moveNext())
    ds.GetRecord().CopyTo(dlrq.rec);

    if (ПолучитПлатежныеРеквизитыПоТО(dlrq, rqacc))
      return SayError(1, "Ошибка при получении реквизитов");
    end;
    if (ПолучитьСчетПоПлатежнымРеквизитам(rqacc, accbuf))
      return SayError(1, "Ошибка при получении счета");
    end;

    if (dlrq.rec.type == DLRQ_TYPE_PAYMENT)
      ground = "Перевод платежному агенту номинальной стоимости облигаций по выпуску " + fin.rec.FI_Code;
    elif (dlrq.rec.type == DLRQ_TYPE_PAYINCOME)
      if(ds.IsRet_ADDINCOME != 0)
        ground = "Перевод платежному агенту суммы дополнительного дохода  по выпуску " + fin.rec.FI_Code;
      else

        var pSQL, pCMD, pRS, isTaxAgent = False;
        pSQL = "select * from davrserv_dbt where t_fiid = ? and t_taxagent = chr(88)";
        pCMD = RSDCommand(pSQL);
        pCMD.AddParam("", rsdbp_in, dlrq.rec.fiid);
        pRS = RSDRecordset(pCMD,rsdval_client, rsdval_static);
  
        if(pRS.movenext())
           isTaxAgent = True; 
        end; 
        ground = "Денежные средства для выплаты купонного дохода владельцам облигаций АО Россельхозбанк серия " + BondName;
 
        if(isTaxAgent)
           ground = ground + ", госрег " + BondRegN + ". Договор платежного агента №Д-04-11-681 от 26 ноября 2004 г.";
        else 
           ground = ground + ", госрег " + BondRegN + ". Договор эмиссионного счета депо №Д-04-11-683 от 26 ноября 2004 г.";
        end;
      end;  
//               ", госрег " + BondRegN + ". Договор эмиссионного счета депо №Д-04-11-683 от 26 ноября 2004 г.";
//		 ", госрег " + BondRegN + ". Договор платежного агента №Д-04-11-681 от 26 ноября 2004 г.";
    end;

    var TransferSum;
    TransferSum = dlrq.rec.Amount;
    if (dlrq.rec.FIID != natcur)
       if (not SmartConvertSum(TransferSum, TransferSum, dl_comm.CommDate, dlrq.rec.FIID, natcur, true))
         return SayError(1, "Ошибка при выполнении проводки ");
       end;   
    end;

       if (not ПроводкаПоКатегориямУчета(FD, "ДС в КО", accbuf,
                                         dl_comm.CommDate,
                                         1,
                                         natcur, //   dlrq.rec.FIID,
                                         TransferSum, //   dlrq.rec.Amount,
                                         doc, INPCARRY, " 1", dl_comm.CommCode, ground,
                                         null, null, 0,
                                         NATCUR, null, null, null,
                                         null, null, null, null, null,
                                         @DebAccNumber, @CredAccNumber))
         return SayError(1, "Ошибка при выполнении проводки " + SC_GetCarryError());
       end;

    ScOpReportLineData[ScOpReportLineData.Size] = SvOp_TPA(iif(dl_comm.fiid != ALLFININSTR, GetFICode(dl_comm.FIID), "Все"),
                                                           ds.Principal,
                                                           iif(dlrq.rec.type == DLRQ_TYPE_PAYMENT, "Номинал", IIF(ds.IsRet_ADDINCOME != 0, "Доп. доход", "Купон")),
                                                           string(dlrq.rec.Amount) + " " + GetFinInstrCcy(dlrq.rec.FIID, true, false),
                                                           DebAccNumber,
                                                           CredAccNumber,
                                                           ground);

    if(УстановитьСтатусТО(dlrq, DLRQ_STATE_EXEC, dl_comm.CommDate) != 0)
      return 1;
    end;

     var REPO2_Own_1  = ЕдиныйПлатежПо2ЧастиСобРЕПО();
     var FD_tick = SPFirstDoc(LEG_KIND_DL_TICK, dlrq.rec.DocID);
     CreatePaymByRQ(dl_commStep, dlrq, FD_tick, REPO2_Own_1, 0, -1, 0, 0, "", NULL/*GAA:515638, old: true*/);


  end;

/* UPG 62.1
  if ((dl_comm.Flag6 == SET_CHAR) and (dl_comm.AddSum > 0))
    var rRqAcc  = TRecHandler( "dlrqacc.dbt" );
    
    if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(dl_comm.DocKind, dl_comm.DocumentID, dl_comm.PartyID, DLRQ_SUBKIND_CURRENCY, dl_comm.ADDCUR, DLRQ_TYPE_PAYINCOME, rRqAcc) != 0) //нет подходящих платежных реквизитов
      
      var rSA = TRecHandler("settacc.dbt");
      if (SP_GetPartySETTACC(dl_comm.PARTYID, 0, dl_comm.ADDCUR, FIKIND_CURRENCY, PTSK_STOCKDL, rSA))
        return SayError(1, "Не найдено СПИ для платежного агента");
      end;

      rRqAcc.Clear();

      rRqAcc.rec.ID               = 0;
      rRqAcc.rec.DocKind          = dl_comm.DocKind;
      rRqAcc.rec.DocID            = dl_comm.DocumentID;
      rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;
      rRqAcc.rec.Type             = DLRQ_TYPE_PAYINCOME;
      rRqAcc.rec.Party            = dl_comm.PartyID;
      rRqAcc.rec.FIID             = rSA.rec.FIID;
      rRqAcc.rec.BankID           = rSA.rec.BankID;
      rRqAcc.rec.Chapter          = rSA.rec.Chapter;
      rRqAcc.rec.Account          = rSA.rec.Account;
      rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;
      rRqAcc.rec.BankCode         = rSA.rec.BankCode;
      rRqAcc.rec.BankName         = rSA.rec.BankName;
      rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;
      rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;
      rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;
      rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;
      rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;

      if (DL_InsertDLRQACC(rRqAcc))
        return SayError(1,"Ошибка вставки платежных реквизитов для операции");
      end;

      //Т.к. платежные реквизиты вставляются сразу, то можем их найти
      if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(dl_comm.DocKind, dl_comm.DocumentID, dl_comm.PartyID, DLRQ_SUBKIND_CURRENCY, dl_comm.ADDCUR, DLRQ_TYPE_PAYINCOME, rRqAcc) != 0) //нет подходящих платежных реквизитов
        return SayError(1,"Не найдены платежные реквизиты для операции");
      end;
    end;

    var Rq = TRecHandler("dlrq");

    Rq.Clear();
    Rq.rec.ID       = 0;
    Rq.rec.DocKind  = dl_comm.DocKind;
    Rq.rec.DocID    = dl_comm.DocumentID;
    Rq.rec.DealPart = 1;
    Rq.rec.Kind     = DLRQ_KIND_REQUEST;
    Rq.rec.SubKind  = DLRQ_SUBKIND_CURRENCY;
    Rq.rec.Type     = DLRQ_TYPE_PAYINCOME;
    Rq.rec.Amount   = dl_comm.AddSum;
    Rq.rec.FIID     = dl_comm.AddCur;
    Rq.rec.Party    = dl_comm.PartyID;
    Rq.rec.RqAccID  = rRqAcc.rec.ID;
    Rq.rec.PlaceID  = iif(rRqAcc.rec.BANKCORRID > 0,   rRqAcc.rec.BANKCORRID , rRqAcc.rec.BANKID);
    Rq.rec.State    = DLRQ_STATE_EXEC;
    Rq.rec.PlanDate = dl_comm.CommDate;
    Rq.rec.FactDate = dl_comm.CommDate;

    if( DL_CreateDLRQ(Rq, dl_comm.CommDate, DLRQ_ACTION_CREATE) != 0 )
      return SayError(1, "Ошибка при создании ТО");
    end;

     var REPO2_Own  = ЕдиныйПлатежПо2ЧастиСобРЕПО();
     CreatePaymByRQ(dl_commStep, Rq, FD, REPO2_Own, 0, -1, 0, 0, "", true);



    var q2 = "SELECT * FROM DACCOUNT_DBT WHERE t_account = ? and t_Chapter = ? and t_Code_Currency = ?";
    var cmd2 = DL_RSDCommand(q2);
    cmd2.AddParam(rRqAcc.rec.Account);
    cmd2.AddParam(rRqAcc.rec.Chapter);
    cmd2.AddParam(rRqAcc.rec.FIID);
    var ds2 = cmd2.Execute();
    var accbuf2 = TRecHandler("account.dbt");
    if (ds2.moveNext())
      ds2.GetRecord().CopyTo(accbuf2.rec);
     else 
      return SayError(2, "Ошибка при выполнении проводки " + SC_GetCarryError());
    end;

    ground = "Перевод платежному агенту суммы дополнительного дохода  по выпуску " + fin.rec.FI_Code;

    if (not ПроводкаПоКатегориямУчета(FD, "ДС в КО", accbuf2,
                                      dl_comm.CommDate,
                                      1,
                                      dl_comm.AddCur,
                                      dl_comm.AddSum,
                                      doc, INPCARRY, " 1", dl_comm.CommCode, ground,
                                      null, FIROLE_ADDINCOME, 0,
                                      dl_comm.AddCur, null, null, null,
                                      null, null, null, null, null,
                                      @DebAccNumber, @CredAccNumber))
      return SayError(1, "Ошибка при выполнении проводки " + SC_GetCarryError());
    end;
      ScOpReportLineData[ScOpReportLineData.Size] = SvOp_TPA(iif(dl_comm.fiid != ALLFININSTR, GetFICode(dl_comm.FIID), "Все"),
                                                             0,
                                                             "Доп. доход",
                                                             string(dl_comm.AddSum) + " " + GetFinInstrCcy(dl_comm.AddCur, true, false),
                                                             DebAccNumber,
                                                             CredAccNumber,
                                                             ground);

  end;*/

  if (ScOpReportLineData.size > 0)
    DL_SaveDataForReport_XML(dl_comm.DocumentID, dl_comm.DocKind, ScOpReportLineData, LOG_TYPE_DATA, ID_Operation, ID_Step);
  end;

  return 0;
end;

/* Макрос постобработки */
MACRO PostStep( CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,           /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,         /* Указатель на первичный документ */
                ID_Operation,     /* Номер экземпляра операции */
                Num_Step,         /* Номер шага операции(из настроек) */
                Kind_Operation,   /* Вид операции */
                KindDoc,          /* Вид первичного документа */
                KindStep,         /* Вид шага операции */
                ID_Step )         /* Номер шага операции */
  if (CommitOrRollback == 2)
    SetBuff(dl_comm, FirstDoc);
    var cmd = RSDCommand("DELETE FROM ddlrqacc_dbt WHERE t_docid = ? ");
    cmd.addParam("", RSDBP_IN, dl_comm.DocumentID);
    cmd.Execute();
  end;
  return 0;
END;
