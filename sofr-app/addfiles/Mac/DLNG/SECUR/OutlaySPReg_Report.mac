/*
$Name:             OutlaySPReg_Report.mac
$Module:           АРНУ
$Description:      Отчет "Регистры по начислению расходов по коротким позициям"
*/

IMPORT "OutlaySPReg_Form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "sprepfun.mac", "spCache.mac", "ws_txreportform.mac";

/*Здесь можно через "," в апострофах указать код (FININSTR.FI_Code) ценных бумаг, которые будут исключаться из отчета.
  Например: 
    ИсключаемыеИзОтчетаЦБ = "'1','2','3'"
*/
PRIVATE CONST ИсключаемыеИзОтчетаЦБ = "";

PRIVATE CONST Строка_Итого                = 0,
              Строка_СтрокаДанных         = 1;

PRIVATE CONST SHEET_0701  = "0701";
PRIVATE CONST SHEET_0702  = "0702";
PRIVATE CONST SHEET_0703  = "0703";
PRIVATE CONST SHEET_0704  = "0704";

PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR   Outlay_SPReg_Form;
PRIVATE VAR   Outlay_SPReg_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб

PRIVATE CONST H012 = "PP",
              H01  = "07",                                                                                                                                                                                                                                                                                                   
              H02  = "XXX",                                                                                                                                                                                                                                                                                                  
              ItogsLineName = "Всего:";                                                                                                                                                                                                                                                                                       

PRIVATE VAR ReportHeader =
"\n\n##############################  ###########################\n" +
"Приложение № ##.## \n" +
"Аналитический регистр налогового учета № 1-02-#####-###-##-000-##-210302-##-##-70102000000000000000\n" +
"                ┌──────────────────────┬─────────────────────────────────────────────────┐\n" +
"                │                    1 │Наименование налоговой базы                      │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   02 │Лист декларации                                  │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                ##### │Номер приложения синтетического регистра         │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                  ### │Код строки в синтетическом регистре              │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │Номер аналитического регистра                    │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                  000 │Код филиала                                      │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │                                                 │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │               210302 │Код структурного подразделения внутри филиала    │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │Номер месяца (последний в отчетном периоде)      │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │Две последние цифры года                         │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │ 70102000000000000000 │Номер лиц. счета по учету доходов/расходов банка │\n" +
"                └──────────────────────┴─────────────────────────────────────────────────┘\n" +
"#######################################################################################################################################################\n" +
"за период с ########## по ##########\n" +
"Группа налогового учета: #################################################################\n" +
"Вид ц/б:                 #################################################################\n" +
"Выпуск ц/б:              #################################################################\n";

/*Таблица нужна для того чтобы заготовить классы для форм 702 и 704*/
PRIVATE VAR DummyTable = "┌────────────────┬────────────────┬────────────────┬────────────────┬────────────────┬────────────────┬────────────────┬────────────────┬────────────────┬────────────────┐\n"
                         "│                │                │                │                │                │                │                │                │                │                │\n"
                         "├────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤"; 

PRIVATE VAR TableHeader_0701 =                                                                                                                                                                                                        
"┌───────────────┬───────────────┬────────────────┬──────────┬──────────┬─────────────┬────────────┬──────────────┬──────────────┬───────────────┬────────────────┬────────────────┬────────────────┬────────────────┬──────────────────┬────────────────────┬──────────────────┬─────────────┬────────────┬──────────┬─────────┐\n"+
"│   Код бумаги  │ Выпуск ценной │  Номер сделки  │   Дата   │   Дата   │ Количество  │    НКД     │     НКД,     │     НКД,     │Сумма купонов, │ Сумма купонов, │   Процентный   │   Процентный   │   Процентный   │ Справочно: Сумма │Количество купонов, │ Дата выплаты по  │Дата переква-│ Контрагент │ГО/филиал │Налоговая│\n"+
"│               │    бумаги     │   реализации   │заключения│реализации│ бумаг, шт.  │ полученный │ причитающ. к │ причитающ. к │  выплаченных  │  выплаченных   │   расход по    │     расход,    │    расход,     │    частичного    │подлежащих получению│последнему купону │  лификация  │ по сделке  │по сделке │ группа  │\n"+
"│               │               │                │  сделки  │  (дата   │             │    при     │ получению от │ получению от │ эмитентом до  │   эмитентом    │   операции,    │  учтенный для  │  учитываемый   │погашения номинала│ в отчетном периоде │в отчетном периоде│   сделки    │ реализации │реализации│         │\n"+
"│               │               │                │    на    │ открытия │             │ реализации │ эмитента на  │ эмитента на  │начала текущего│   в текущем    │   связанной    │     целей      │   для целей    │   , выплаченная  │                    │в соответствии со │РЕПО / Займа │            │          │         │\n"+
"│               │               │                │реализацию│ короткой │             │(НКД на дату│    конец     │    конец     │   отчетного   │    отчетном    │   с открытием  │ налогообложения│налогообложения │   эмитентом за   │                    │   справочником   │             │            │          │         │\n"+
"│               │               │                │    ЦБ    │ позиции) │             │  открытия  │  отчетного   │ предыдущего  │ (налогового)  │  (налоговом)   │    короткой    │    до начала   │   в текущем    │  период от даты  │                    │                  │             │            │          │         │\n"+
"│               │               │                │          │          │             │  короткой  │ (налогового) │  налогового  │ периода, руб. │ периоде, руб.  │позиции ─ всего,│    текущего    │    отчетном    │    открытия по   │                    │                  │             │            │          │         │\n"+
"│               │               │                │          │          │             │ позиции),  │периода, руб. │периода, руб. │               │                │      руб.      │    отчетного   │  (налоговом)   │отчетную дату, руб│                    │                  │             │            │          │         │\n"+
"│               │               │                │          │          │             │    руб.    │              │              │               │                │                │  (налогового)  │ периоде, руб.  │                  │                    │                  │             │            │          │         │\n"+
"│               │               │                │          │          │             │            │              │              │               │                │                │  периода, руб. │                │                  │                    │                  │             │            │          │         │\n"+
"├───────────────┼───────────────┼────────────────┼──────────┼──────────┼─────────────┼────────────┼──────────────┼──────────────┼───────────────┼────────────────┼────────────────┼────────────────┼────────────────┼──────────────────┼────────────────────┼──────────────────┼─────────────┼────────────┼──────────┼─────────┤\n"+
"│       1       │       2       │       3        │     4    │     5    │      6      │     7      │      8       │      9       │      10       │       11       │       12       │       13       │       14       │        Т1        │         Т2         │        Т3        │      Т4     │     Т5     │    Т6    │    Т7   │\n"+
"├───────────────┼───────────────┼────────────────┼──────────┼──────────┼─────────────┼────────────┼──────────────┼──────────────┼───────────────┼────────────────┼────────────────┼────────────────┼────────────────┼──────────────────┼────────────────────┼──────────────────┼─────────────┼────────────┼──────────┼─────────┤";

PRIVATE VAR TableHeader_0702 = 
"┌───────────────┬───────────────┬────────────────┬──────────┬──────────┬─────────────┬────────────┬──────────┬──────────┬────────────────┬───────────────┬────────────────┬────────────────┬────────────────┬─────────────┬────────────┬──────────┬─────────┐\n"+
"│   Код бумаги  │ Выпуск ценной │  Номер сделки  │   Дата   │   Дата   │ Количество  │  Номинал   │   Дата   │   Дата   │Средневзвешенная│Цена реализации│  Процентный    │   Процентный   │   Процентный   │Дата переква-│ Контрагент │ГО/филиал │Налоговая│\n"+
"│               │    бумаги     │   реализации   │заключения│реализации│ бумаг, шт.  │            │размещения│погашения │цена размещения,│(цена открытия │   расход по    │     расход,    │    расход,     │  лификация  │ по сделке  │по сделке │ группа  │\n"+
"│               │               │                │  сделки  │  (дата   │             │            │          │          │% от номинала   │   короткой    │   операции,    │  учтенный для  │  учитываемый   │   сделки    │ реализации │реализации│         │\n"+
"│               │               │                │    на    │ открытия │             │            │          │          │                │   позиции),   │  связанной с   │     целей      │   для целей    │РЕПО / Займа │            │          │         │\n"+
"│               │               │                │реализацию│ короткой │             │            │          │          │                │ % от номинала │   открытием    │ налогообложения│налогообложения │             │            │          │         │\n"+
"│               │               │                │    ЦБ    │ позиции) │             │            │          │          │                │               │короткой позиции│    до начала   │   в текущем    │             │            │          │         │\n"+
"│               │               │                │          │          │             │            │          │          │                │               │  - всего, руб. │    текущего    │    отчетном    │             │            │          │         │\n"+
"│               │               │                │          │          │             │            │          │          │                │               │                │    отчетного   │  (налоговом)   │             │            │          │         │\n"+
"│               │               │                │          │          │             │            │          │          │                │               │                │  (налогового)  │ периоде, руб.  │             │            │          │         │\n"+
"│               │               │                │          │          │             │            │          │          │                │               │                │  периода, руб. │                │             │            │          │         │\n"+
"├───────────────┼───────────────┼────────────────┼──────────┼──────────┼─────────────┼────────────┼──────────┼──────────┼────────────────┼───────────────┼────────────────┼────────────────┼────────────────┼─────────────┼────────────┼──────────┼─────────┤\n"+
"│       1       │       2       │       3        │     4    │     5    │      6      │     7      │     8    │     9    │       10       │      11       │       12       │       13       │       14       │      Т1     │     Т2     │    Т3    │    Т4   │\n"+
"├───────────────┼───────────────┼────────────────┼──────────┼──────────┼─────────────┼────────────┼──────────┼──────────┼────────────────┼───────────────┼────────────────┼────────────────┼────────────────┼─────────────┼────────────┼──────────┼─────────┤";

PRIVATE VAR TableHeader_0703 =
"┌────────────┬─────────────┬──────────────┬──────────┬──────────┬────────┬────────────────┬─────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────────────────┬─────────────────┬─────────────────┬─────────────────┬─────────────────┬─────────────────┬───────────┬─────────┐\n"+
"│ Код бумаги │Выпуск ценной│ Номер сделки │   Дата   │   Дата   │  Код   │   Количество   │  НКД полученный при реализации  │ НКД, причитающ. к получению от  │  НКД, причитающ. к получению от │    Сумма купонов, выплаченных   │   Сумма купонов, выплаченных    │Процентный расход │Процентный расход,│Процентный расход,│  Справочно:Сумма частичного  │    Код валюты   │   Количество    │Дата выплаты по  │ Дата переквали- │  Контрагент по  │ ГО/филиал │Налоговая│\n"+
"│            │   бумаги    │  реализации  │заключения│реализации│ валюты │   бумаг, шт.   │  (НКД на дату открытия короткой │   эмитента на конец отчетного   │  эмитента на конец предыдущего  │   эмитентом до начала текущего  │  эмитентом в текущем отчетном   │   по операции,   │учтенный для целей│ учитываемый для  │погашения номинала,выплаченная│ цены реализации │    купонов,     │последнему купону│ фикация сделки  │сделке реализации│           │ группа  │\n"+
"│            │             │              │  сделки  │  (дата   │номинала│                │              позиции)           │      (налогового) периода       │  отчетного (налогового) периода │  отчетного (налогового) периода │      (налоговом) периоде        │   связанной с    │ налогообложения  │      целей       │  эмитентом за период от даты │                 │   подлежащих    │  в отчетном     │  РЕПО / Займа   │                 │           │         │\n"+
"│            │             │              │    на    │ открытия │        │                │                                 │                                 │                                 │                                 │                                 │открытием короткой│до начала текущего│ налогообложения  │  открытия по отчетную дату в │                 │    получению    │    периоде      │                 │                 │           │         │\n"+
"│            │             │              │реализацию│ короткой │        │                │                                 │                                 │                                 │                                 │                                 │ позиции - всего, │    отчетного     │в текущем отчетном│       валюте номинала        │                 │   в отчетном    │ в соответствии  │                 │                 │           │         │\n"+
"│            │             │              │    ЦБ    │ позиции) │        │                │                                 │                                 │                                 │                                 │                                 │       руб.       │   (налогового)   │   (налоговом)    │                              │                 │     периоде     │ со справочником │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │                │                                 │                                 │                                 │                                 │                                 │                  │   периода,руб.   │  периоде, руб.   │                              │                 │                 │                 │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │                ├────────────────┬────────────────┼────────────────┬────────────────┼────────────────┬────────────────┼────────────────┬────────────────┼────────────────┬────────────────┤                  │                  │                  │                              │                 │                 │                 │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │                │    в валюте    │    в рублях    │    в валюте    │    в рублях    │    в валюте    │    в рублях    │    в валюте    │    в рублях    │    в валюте    │    в рублях    │                  │                  │                  │                              │                 │                 │                 │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │                │    номинала    │                │    номинала    │                │    номинала    │                │    номинала    │                │    номинала    │                │                  │                  │                  │                              │                 │                 │                 │                 │                 │           │         │\n"+
"├────────────┼─────────────┼──────────────┼──────────┼──────────┼────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────────────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼───────────┼─────────┤\n"+
"│      1     │      2      │       3      │    4     │    5     │    6   │       7        │       8        │        9       │       10       │       11       │       12       │       13       │       14       │       15       │       14       │       15       │        18        │        19        │        20        │           Т1                 │        Т2       │        Т3       │        Т4       │        Т5       │        Т6       │     Т7    │   Т8    │\n"+
"├────────────┼─────────────┼──────────────┼──────────┼──────────┼────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────────────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼───────────┼─────────┤";

PRIVATE VAR TableHeader_0704 = 
"┌────────────┬─────────────┬──────────────┬──────────┬──────────┬────────┬────────┬──────────┬──────────┬────────────────┬────────────────┬────────────────┬─────────────────────────────────┬─────────────────────────────────┬──────────────────┬─────────────────┬─────────────────┬───────────┬─────────┐\n"+
"│ Код бумаги │Выпуск ценной│ Номер сделки │   Дата   │   Дата   │Номинал,│  Код   │   Дата   │   Дата   │Средневзвешенная│   Количество   │Цена реализации │       Процентный расход,        │ Процентный расход по операции,  │Процентный расход,│ Дата переквали- │  Контрагент по  │ ГО/филиал │Налоговая│\n"+
"│            │   бумаги    │  реализации  │заключения│реализации│  руб.  │ валюты │размещения│погашения │цена размещения,│   бумаг, шт.   │(цена открытия  │       учтенный для целей        │ связанной с открытием короткой  │ учитываемый для  │ фикация сделки  │сделке реализации│           │ группа  │\n"+
"│            │             │              │  сделки  │  (дата   │        │номинала│          │          │ % от номинала  │                │   короткой     │   налогообложения до начала     │         позиции - всего         │      целей       │  РЕПО / Займа   │                 │           │         │\n"+
"│            │             │              │    на    │ открытия │        │        │          │          │                │                │   позиции),    │ текущего отчетного (налогового) │                                 │ налогообложения  │                 │                 │           │         │\n"+
"│            │             │              │реализацию│ короткой │        │        │          │          │                │                │ % от номинала  │                                 │                                 │в текущем отчетном│                 │                 │           │         │\n"+
"│            │             │              │    ЦБ    │ позиции) │        │        │          │          │                │                │                │                                 │                                 │   (налоговом)    │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │        │          │          │                │                │                │                                 │                                 │  периоде, руб.   │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │        │          │          │                │                │                ├────────────────┬────────────────┼────────────────┬────────────────┤                  │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │        │          │          │                │                │                │    в валюте    │    в рублях    │    в валюте    │    в рублях    │                  │                 │                 │           │         │\n"+
"│            │             │              │          │          │        │        │          │          │                │                │                │    номинала    │                │    номинала    │                │                  │                 │                 │           │         │\n"+
"├────────────┼─────────────┼──────────────┼──────────┼──────────┼────────┼────────┼──────────┼──────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼──────────────────┼─────────────────┼─────────────────┼───────────┼─────────┤\n"+
"│      1     │      2      │       3      │    4     │    5     │    6   │    7   │    8     │    9     │       10       │       11       │       12       │       13       │       14       │       15       │       16       │        17        │        Т1       │        Т2       │     Т3    │   Т4    │\n"+
"├────────────┼─────────────┼──────────────┼──────────┼──────────┼────────┼────────┼──────────┼──────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼──────────────────┼─────────────────┼─────────────────┼───────────┼─────────┤";


PRIVATE CLASS FormReg_0701( Report:OBJECT )
  VAR m_Report = Report;

  MACRO Where():STRING
     /*0701 - отбираются облигации процентные с номиналом в рублях*/
     return " and FI.t_FaceValueFI = 0 and Rsb_SCTX.TXIsPercentAvoir(av.t_TaxGroup) = 1 ";
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( SHEET_0701 );

     m_Report.PrintHeader("N1_");

     m_Report.RegisterTable( "N1_MainTable", TableHeader_0701,
               /*1  */       "N1_SecCode",       
               /*2  */       "N1_SecName",       
               /*3  */       "N1_CodeS",         
               /*4  */       "N1_DZS",           
               /*5  */       "N1_DDS",           
               /*6  */       "N1_QntyOpen",          
               /*7  */       "N1_NkdSvn",          
               /*8  */       "N1_NkdEndVn",         
               /*9  */       "N1_NkdPrevVn",        
               /*10 */       "N1_CoupPrevVN",        
               /*11 */       "N1_CoupVN",       
               /*12 */       "N1_ProcAllRub",       
               /*13 */       "N1_ProcPrevRub",          
               /*14 */       "N1_ProcRepRub",          
               /*Т1 */       "N1_AmortVN",
               /*Т2 */       "N1_CoupCount",      
               /*Т3 */       "N1_LastCoupDate",  
               /*Т4 */       "N1_RegS",          
               /*Т5 */       "N1_ContS",          
               /*Т6 */       "N1_FilS",          
               /*Т7 */       "N1_SecType" );      


     m_Report.SetCellAutoSummaPoint( "Всего:",
                                          "N1_QntyOpen",6,   
                                          "N1_NkdSvn",2,
                                          "N1_NkdEndVn",2,
                                          "N1_NkdPrevVn",2,
                                          "N1_CoupPrevVN",2,
                                          "N1_CoupVN",2,     
                                          "N1_ProcAllRub",2, 
                                          "N1_ProcPrevRub",2,
                                          "N1_ProcRepRub",2,
                                          "N1_AmortVN",2
                              );


  END;

  MACRO ПечататьПромежуточныеИтоги()
     
     m_Report.SetSubtotal(28, 26 + MAXROWSHEET,
                          "F23",
                          "G23",
                          "H23",
                          "I23", 
                          "J23",
                          "K23",
                          "L23",
                          "M23",
                          "N23",
                          "O23" 
                         );
  END;

  MACRO EndReport();
     m_Report.EndTable();
     ПечататьПромежуточныеИтоги();
     m_Report.AddStandardFooter( "N1_" );
  END;         

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     if( LineType == Строка_СтрокаДанных )
        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine( "N1_SecCode",       m_Report.SecCode(),     null,   /*1  */
                                 "N1_SecName",       m_Report.SecName(),     null,   /*2  */
                                 "N1_CodeS",         m_Report.CodeS(),       null,   /*3  */
                                 "N1_DZS",           m_Report.DZS(),         null,   /*4  */
                                 "N1_DDS",           m_Report.DDS(),         null,   /*5  */
                                 "N1_QntyOpen",      m_Report.QntyOpen(),    SetPrecisionByFractPart(m_Report.QntyOpen(), m_Report.QntyPrecision(), 0),   /*6  */
                                 "N1_NkdSvn",        m_Report.NkdSvn(),      null,   /*7  */
                                 "N1_NkdEndVn",      m_Report.NkdEndVn(),    null,   /*8  */
                                 "N1_NkdPrevVn",     m_Report.NkdPrevVn(),   null,   /*9  */
                                 "N1_CoupPrevVN",    m_Report.CoupPrevVN(),  null,   /*10 */
                                 "N1_CoupVN",        m_Report.CoupVN(),      null,   /*11 */
                                 "N1_ProcAllRub",    m_Report.ProcAllRub(),  null,   /*12 */
                                 "N1_ProcPrevRub",   m_Report.ProcPrevRub(), null,   /*13 */
                                 "N1_ProcRepRub",    m_Report.ProcRepRub(),  null,   /*14 */
                                 "N1_AmortVN",       m_Report.AmortVN(),     null,   /*Т1 */
                                 "N1_CoupCount",     m_Report.CoupCount(),   null,   /*Т2 */
                                 "N1_LastCoupDate",  m_Report.LastCoupDate(),null,   /*Т3 */
                                 "N1_RegS",          m_Report.RegS(),        null,   /*Т4 */
                                 "N1_ContS",         m_Report.ContS(),       null,   /*Т5 */
                                 "N1_FilS",          m_Report.FilS(),        null,   /*Т6 */
                                 "N1_SecType",       m_Report.SecType(),     null    /*Т7 */
                               );
                               
     elif( LineType == Строка_Итого )
     
        m_Report.SetCurrentLineFont( 10, true, false );
        m_Report.PrintTableLine( "N1_SecCode",  "Всего:", null );
        
        m_Report.SetCurrentLineFont( 10, false, false );
        m_Report.PrintTableLine( "N1_SecCode",  "в том числе", null );

     end;
  END;         

END;

PRIVATE CLASS FormReg_0702( Report:OBJECT )
  VAR m_Report = Report;

  MACRO Where():STRING
     /*0702 - отбираются облигации дисконтные с номиналом в рублях*/
     return " and FI.t_FaceValueFI = 0 and Rsb_SCTX.TXIsDiscountAvoir(av.t_TaxGroup) = 1 ";
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( SHEET_0702 );

     m_Report.PrintHeader("N2_");

     m_Report.RegisterTable( "N2_MainTable", TableHeader_0702,
                  /*1  */    "N2_SecCode", 
                  /*2  */    "N2_SecName",       
                  /*3  */    "N2_CodeS", 
                  /*4  */    "N2_DZS",   
                  /*5  */    "N2_DDS",   
                  /*6  */    "N2_QntyOpen",      
                  /*7  */    "N2_Nom",   
                  /*8  */    "N2_Dauc",  
                  /*9  */    "N2_Dexp",  
                  /*10 */    "N2_PrAucNom",      
                  /*11 */    "N2_PrSNom",        
                  /*12 */    "N2_ProcAllRub",    
                  /*13 */    "N2_ProcPrevRub",   
                  /*14 */    "N2_ProcRepRub",    
                  /*Т1 */    "N2_RegS",  
                  /*Т2 */    "N2_ContS", 
                  /*Т3 */    "N2_FilS",  
                  /*Т4 */    "N2_SecType"
                           );      

     m_Report.SetCellAutoSummaPoint( "Всего:",
                                 "N2_QntyOpen",6,   
                                 "N2_Nom",2,
                                 "N2_ProcAllRub",2,
                                 "N2_ProcPrevRub",2,
                                 "N2_ProcRepRub",2
                              );

  END;

  MACRO ПечататьПромежуточныеИтоги()
     
     m_Report.SetSubtotal(27, 25 + MAXROWSHEET,
                          "F23",   
                          "G23",        
                          "L23", 
                          "M23", 
                          "N23"  
                         );
  END;

  MACRO EndReport();
     m_Report.EndTable();
     ПечататьПромежуточныеИтоги();
     m_Report.AddStandardFooter( "N2_" );
  END;         

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     if( LineType == Строка_СтрокаДанных )
        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine( "N2_SecCode",       m_Report.SecCode(),     null,   /*1  */ 
                                 "N2_SecName",       m_Report.SecName(),     null,   /*2  */ 
                                 "N2_CodeS",         m_Report.CodeS(),       null,   /*3  */   
                                 "N2_DZS",           m_Report.DZS(),         null,   /*4  */     
                                 "N2_DDS",           m_Report.DDS(),         null,   /*5  */     
                                 "N2_QntyOpen",      m_Report.QntyOpen(),    SetPrecisionByFractPart(m_Report.QntyOpen(), m_Report.QntyPrecision(), 0),   /*6  */
                                 "N2_Nom",           m_Report.Nom(),         null,   /*7  */     
                                 "N2_Dauc",          m_Report.Dauc(),        null,   /*8  */    
                                 "N2_Dexp",          m_Report.Dexp(),        null,   /*9  */    
                                 "N2_PrAucNom",      m_Report.PrAucNom(),    null,   /*10 */
                                 "N2_PrSNom",        m_Report.PrSNom(),      null,   /*11 */  
                                 "N2_ProcAllRub",    m_Report.ProcAllRub(),  null,   /*12 */
                                 "N2_ProcPrevRub",   m_Report.ProcPrevRub(), null,   /*13 */
                                 "N2_ProcRepRub",    m_Report.ProcRepRub(),  null,   /*14 */
                                 "N2_RegS",          m_Report.RegS(),        null,   /*Т1 */    
                                 "N2_ContS",         m_Report.ContS(),       null,   /*Т2 */   
                                 "N2_FilS",          m_Report.FilS(),        null,   /*Т3 */    
                                 "N2_SecType",       m_Report.SecType(),     null    /*Т4 */ 
                               );
                               
     elif( LineType == Строка_Итого )
     
        m_Report.SetCurrentLineFont( 10, true, false );
        m_Report.PrintTableLine( "N2_SecCode",  "Всего:", null );
        
        m_Report.SetCurrentLineFont( 10, false, false );
        m_Report.PrintTableLine( "N2_SecCode",  "в том числе", null );

     end;
  END;         

END;


PRIVATE CLASS FormReg_0703( Report:OBJECT )
  VAR m_Report = Report;

  MACRO Where():STRING
     /*0703 - отбираются облигации процентные с номиналом не в рублях*/
    return " and FI.t_FaceValueFI <> 0 and Rsb_SCTX.TXIsPercentAvoir(av.t_TaxGroup) = 1 ";
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( SHEET_0703 );

     m_Report.PrintHeader("N3_");

     m_Report.RegisterTable( "N3_MainTable", TableHeader_0703,
               /*1  */       "N3_SecCode",       
               /*2  */       "N3_SecName",       
               /*3  */       "N3_CodeS",         
               /*4  */       "N3_DZS",           
               /*5  */       "N3_DDS",
               /*6  */       "N3_VN",
               /*7  */       "N3_QntyOpen",          
               /*8  */       "N3_NkdSvn",          
               /*9  */       "N3_NkdSrub",
               /*10 */       "N3_NkdEndVn",
               /*11 */       "N3_NkdEndRub",
               /*12 */       "N3_NkdPrevVN",        
               /*13 */       "N3_NkdPrevRub",
               /*14 */       "N3_CoupPrevVN",
               /*15 */       "N3_CoupPrevRub",
               /*16 */       "N3_CoupVN",
               /*17 */       "N3_CoupRub",
               /*18 */       "N3_ProcAllRub",       
               /*19 */       "N3_ProcPrevRub",          
               /*20 */       "N3_ProcRepRub",          
               /*Т1 */       "N3_AmortVN",          
               /*Т2 */       "N3_VPrS",   
               /*Т3 */       "N3_CoupCount",     
               /*Т4 */       "N3_LastCoupDate",  
               /*Т5 */       "N3_RegS",
               /*Т6 */       "N3_ContS",          
               /*Т7 */       "N3_FilS",          
               /*Т8 */       "N3_SecType"        );      


     m_Report.SetCellAutoSummaPoint( "Всего:",
                                          "N3_QntyOpen",6,   
                                          "N3_NkdSvn",2,
                                          "N3_NkdSrub",2,
                                          "N3_NkdEndVn",2,
                                          "N3_NkdEndRub",2,
                                          "N3_NkdPrevVn",2,
                                          "N3_NkdPrevRub",2,
                                          "N3_CoupPrevVN",2,
                                          "N3_CoupPrevRub", 2,
                                          "N3_CoupVN",2,
                                          "N3_CoupRub",2,
                                          "N3_ProcAllRub",2,
                                          "N3_ProcPrevRub",2,
                                          "N3_ProcRepRub",2,
                                          "N3_AmortVN",2
                              );

  END;

  MACRO ПечататьПромежуточныеИтоги()
     
     m_Report.SetSubtotal(28, 26 + MAXROWSHEET,
                          "G23",   
                          "H23",     
                          "I23",    
                          "J23",   
                          "K23",  
                          "L23", 
                          "M23", 
                          "N23",
                          "O23",     
                          "P23",    
                          "Q23", 
                          "R23",
                          "S23", 
                          "T23",
                          "U23"     
                         );
  END;

  MACRO EndReport();
     m_Report.EndTable();
     ПечататьПромежуточныеИтоги();
     m_Report.AddStandardFooter( "N3_" );
  END;         

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     if( LineType == Строка_СтрокаДанных )
        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine( "N3_SecCode",       m_Report.SecCode(),     null,   /*1  */
                                 "N3_SecName",       m_Report.SecName(),     null,   /*2  */
                                 "N3_CodeS",         m_Report.CodeS(),       null,   /*3  */
                                 "N3_DZS",           m_Report.DZS(),         null,   /*4  */
                                 "N3_DDS",           m_Report.DDS(),         null,   /*5  */
                                 "N3_VN",            m_Report.VN(),          null,   /*6  */
                                 "N3_QntyOpen",      m_Report.QntyOpen(),    SetPrecisionByFractPart(m_Report.QntyOpen(), m_Report.QntyPrecision(), 0),   /*7  */
                                 "N3_NkdSvn",        m_Report.NkdSvn(),      null,   /*8  */
                                 "N3_NkdSrub",       m_Report.NkdSrub(),     null,   /*9  */
                                 "N3_NkdEndVn",      m_Report.NkdEndVn(),    null,   /*10 */
                                 "N3_NkdEndRub",     m_Report.NkdEndRub(),   null,   /*11 */
                                 "N3_NkdPrevVn",     m_Report.NkdPrevVn(),   null,   /*12 */
                                 "N3_NkdPrevRub",    m_Report.NkdPrevRub(),  null,   /*13 */
                                 "N3_CoupPrevVN",    m_Report.CoupPrevVN(),  null,   /*14 */
                                 "N3_CoupPrevRub",   m_Report.CoupPrevRub(), null,   /*15 */
                                 "N3_CoupVN",        m_Report.CoupVN(),      null,   /*16 */
                                 "N3_CoupRub",       m_Report.CoupRub(),     null,   /*17 */
                                 "N3_ProcAllRub",    m_Report.ProcAllRub(),  null,   /*18 */
                                 "N3_ProcPrevRub",   m_Report.ProcPrevRub(), null,   /*19 */
                                 "N3_ProcRepRub",    m_Report.ProcRepRub(),  null,   /*20 */
                                 "N3_AmortVN",       m_Report.AmortVN(),     null,   /*Т1 */
                                 "N3_VPrS",          m_Report.VPrSNumber(),  null,   /*Т2 */
                                 "N3_CoupCount",     m_Report.CoupCount(),   null,   /*Т3 */
                                 "N3_LastCoupDate",  m_Report.LastCoupDate(),null,   /*Т4 */
                                 "N3_RegS",          m_Report.RegS(),        null,   /*Т5 */
                                 "N3_ContS",         m_Report.ContS(),       null,   /*Т6 */
                                 "N3_FilS",          m_Report.FilS(),        null,   /*Т7 */
                                 "N3_SecType",       m_Report.SecType(),     null    /*Т8 */
                               );
                               
     elif( LineType == Строка_Итого )
     
        m_Report.SetCurrentLineFont( 10, true, false );
        m_Report.PrintTableLine( "N3_SecCode",  "Всего:", null );
        
        m_Report.SetCurrentLineFont( 10, false, false );
        m_Report.PrintTableLine( "N3_SecCode",  "в том числе", null );

     end;
  END;         

END;

PRIVATE CLASS FormReg_0704( Report:OBJECT )
  VAR m_Report = Report;

  MACRO Where():STRING
     /*0703 - отбираются облигации процентные с номиналом не в рублях*/
    return " and FI.t_FaceValueFI <> 0 and Rsb_SCTX.TXIsDiscountAvoir(av.t_TaxGroup) = 1 ";
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( SHEET_0704 );

     m_Report.PrintHeader("N4_");

     m_Report.RegisterTable( "N4_MainTable", TableHeader_0704,
                       /*1  */      "N4_SecCode",  
                       /*2  */      "N4_SecName",       
                       /*3  */      "N4_CodeS", 
                       /*4  */      "N4_DZS",   
                       /*5  */      "N4_DDS",   
                       /*6  */      "N4_Nom",   
                       /*7  */      "N4_VN",    
                       /*8  */      "N4_Dauc",  
                       /*9  */      "N4_Dexp",  
                       /*10 */      "N4_PrAucNom",      
                       /*11 */      "N4_QntyOpen",      
                       /*12 */      "N4_PrSnom",       
                       /*13 */      "N4_ProcPrevVN",    
                       /*14 */      "N4_ProcPrevRub",   
                       /*15 */      "N4_ProcAllVN",     
                       /*16 */      "N4_ProcAllRub",    
                       /*17 */      "N4_ProcRepRub",    
                       /*Т1 */      "N4_RegS",
                       /*Т2 */      "N4_ContS",
                       /*Т3 */      "N4_FilS",
                       /*Т4 */      "N4_SecType"
                                );      


     m_Report.SetCellAutoSummaPoint( "Всего:",
                                "N4_QntyOpen",6,          
                                "N4_ProcPrevVN",2,           
                                "N4_ProcPrevRub",2,          
                                "N4_ProcAllVN",2,            
                                "N4_ProcAllRub",2,           
                                "N4_ProcRepRub",2            
                              );

  END;

  MACRO ПечататьПромежуточныеИтоги()
     
     m_Report.SetSubtotal(28, 26 + MAXROWSHEET,
                          "K23",   
                          "M23", 
                          "N23",
                          "O23",  
                          "P23", 
                          "Q23"  
                         );
  END;

  MACRO EndReport();
     m_Report.EndTable();
     ПечататьПромежуточныеИтоги();
     m_Report.AddStandardFooter( "N4_" );
  END;         

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     if( LineType == Строка_СтрокаДанных )
        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine( "N4_SecCode",         m_Report.SecCode(),        null,   /*1  */
                                 "N4_SecName",         m_Report.SecName(),        null,   /*2  */
                                 "N4_CodeS",           m_Report.CodeS(),          null,   /*3  */
                                 "N4_DZS",             m_Report.DZS(),            null,   /*4  */
                                 "N4_DDS",             m_Report.DDS(),            null,   /*5  */
                                 "N4_Nom",             m_Report.Nom(),            null,   /*6  */
                                 "N4_VN",              m_Report.VN(),             null,   /*7  */
                                 "N4_Dauc",            m_Report.Dauc(),           null,   /*8  */
                                 "N4_Dexp",            m_Report.Dexp(),           null,   /*9  */
                                 "N4_PrAucNom",        m_Report.PrAucNom(),       null,   /*10 */
                                 "N4_QntyOpen",        m_Report.QntyOpen(),       SetPrecisionByFractPart(m_Report.QntyOpen(), m_Report.QntyPrecision(), 0),   /*11 */
                                 "N4_PrSnom",          m_Report.PrSnom(),         null,   /*12 */
                                 "N4_ProcPrevVN",      m_Report.ProcPrevVN(),     null,   /*13 */
                                 "N4_ProcPrevRub",     m_Report.ProcPrevRub(),    null,   /*14 */
                                 "N4_ProcAllVN",       m_Report.ProcAllVN(),      null,   /*15 */
                                 "N4_ProcAllRub",      m_Report.ProcAllRub(),     null,   /*16 */
                                 "N4_ProcRepRub",      m_Report.ProcRepRub(),     null,   /*17 */
                                 "N4_RegS",            m_Report.RegS(),           null,   /*Т1 */
                                 "N4_ContS",           m_Report.ContS(),          null,   /*Т2 */
                                 "N4_FilS",            m_Report.FilS(),           null,   /*Т3 */
                                 "N4_SecType",         m_Report.SecType(),        null    /*Т4 */
                               );
                               
     elif( LineType == Строка_Итого )
     
        m_Report.SetCurrentLineFont( 10, true, false );
        m_Report.PrintTableLine( "N4_SecCode",  "Всего:", null );
        
        m_Report.SetCurrentLineFont( 10, false, false );
        m_Report.PrintTableLine( "N4_SecCode",  "в том числе", null );

     end;
  END;         

END;


PRIVATE CLASS (DL_CReportTemplate) SP_OutlaySPReg_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  
  PRIVATE VAR m_H07, m_H08, m_ReportKind, m_RS;
  PRIVATE VAR m_CacheFinInstr = TX_CacheFinInstr();
  PRIVATE VAR m_dl_leg   = TRecHandler( "dl_leg.dbt" );

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/

 /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END; 

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  MACRO PrintHeader( FldPref:STRING )

     PrintFormatString( ReportHeader,
            FldPref+"H0_A:l" , this.H0_A(),  // Банк
            FldPref+"H0_B:l" , this.H0_B(),  // Инн/КПП
            FldPref+"H0_1"   , this.H0_1(),  // Приложение №
            FldPref+"H0_3"   , this.H0_3(),
            FldPref+"H0_12"  , this.H0_12(), // Аналитический регистр налогового учета №
            FldPref+"H0_2"   , this.H0_2(),
            FldPref+"H0_3"   , this.H0_3(),
            FldPref+"H0_1"   , this.H0_1(),
            FldPref+"H0_4"   , this.H0_4(),
            FldPref+"H0_5"   , this.H0_5(),
            FldPref+"H0_12"  , this.H0_12(), // Номер приложения синтетического регистра
            FldPref+"H0_2"   , this.H0_2(),  // Код строки в синтетическом регистре
            FldPref+"H0_3"   , this.H0_3(),  // Номер аналитического регистра
            FldPref+"H0_1"   , this.H0_1(),
            FldPref+"H0_4"   , this.H0_4(),  // Номер месяца (последний в отчетном периоде)
            FldPref+"H0_5"   , this.H0_5(),  // Две последние цифры года
            FldPref+"H0_6"   , this.H0_6(),  // Имя отчета
            FldPref+"H0_7"   , this.H0_7(),  // за период с
            FldPref+"H0_8"   , this.H0_8(),  // по
            FldPref+"H0_9"   , this.H0_9(),  // Группа налогового учета
            FldPref+"H0_10"  , this.H0_10(), // Вид ц/б
            FldPref+"H0_11"  , this.H0_11()  // Выпуск ц/б
          );
  END;

  PRIVATE MACRO SetAutoFilter()
     if( ExistsSheet( SHEET_0701 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:U28", SHEET_0701);
     end;

     if( ExistsSheet( SHEET_0702 ) )
        m_ObjTemplateXLS.SetAutoFilter("A27:R27", SHEET_0702);
     end;

     if( ExistsSheet( SHEET_0703 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:AB28", SHEET_0703);
     end;

     if( ExistsSheet( SHEET_0704 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:U28", SHEET_0704);
     end;
  END;

  PRIVATE MACRO EndReport()
    EndReport();
    SetAutoFilter();
  END;


  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
    VAR DataSubQuery, DataQuery, AvrFIID, AvrKind, AvrGroup, AddWhere = "", OK,
        AvrFIIDList = null,
        AvrFIIDCount : Integer = 0,
        AvrFIIDAddWhere : String = "",
        WasSetSecurity : Bool = false,

        AvrKindList = null,
        AvrKindAddWhere : String = "",
        AvrKindCount : Integer = 0,
         
        GNUList = null,
        GNUAddWhere : String = "",
        GNUCount : Integer = 0;
    VAR ProgressValue = CTxProgressValue();

     T_Dep.ClearArray();
     ObjReport.BeginReport();

     /*ценные бумаги в соединенных сделках  должны удовлетворять условиям, заданным панели подготовки отчета*/
     if( not m_IsWebService )
        AvrFIIDList = TArray();
        AvrFIIDList[AvrFIIDList.Size] = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRCODE );
     else
        AvrFIIDList = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRCODE );
     end;
     if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
        while( AvrFIIDCount < AvrFIIDList.Size )
           if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
           and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
              if( AvrFIIDAddWhere == "" )
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
              else
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
              end;
              AvrFIIDAddWhere = AvrFIIDAddWhere + " FI.t_FIID = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
           end;
           AvrFIIDCount = AvrFIIDCount + 1;
        end;
        if( AvrFIIDAddWhere != "" )
           AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
           WasSetSecurity = true;
        end;
        AddWhere = AddWhere + AvrFIIDAddWhere;
     end;

     /*если не задана бумага*/
     if( not WasSetSecurity )
        if( not m_IsWebService )
           AvrKindList = TArray();
           AvrKindList[AvrKindList.Size] = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRKIND );
        else
           AvrKindList = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRKIND );
        end;
        /*задан вид бумаги*/
        if( ( ValType( AvrKindList ) != V_UNDEF ) and ( AvrKindList.Size > 0 ) )
           while( AvrKindCount < AvrKindList.Size )
              if( ( ValType( AvrKindList[AvrKindCount] ) == V_INTEGER )
              and ( AvrKindList[AvrKindCount] > 0 ) )
                 if( AvrKindAddWhere == "" )
                    AvrKindAddWhere = AvrKindAddWhere + " AND ( ";
                 else
                    AvrKindAddWhere = AvrKindAddWhere + " OR ";
                 end;
                 AvrKindAddWhere = AvrKindAddWhere + " RSB_FIInstr.FI_AvrKindsEQ(2, " + String( AvrKindList[AvrKindCount] ) + ", FI.t_AvoirKind) = 1 ";
              end;
              AvrKindCount = AvrKindCount + 1;
           end;
           if( AvrKindAddWhere != "" )
              AvrKindAddWhere = AvrKindAddWhere + " ) ";
           end;
           AddWhere = AddWhere + AvrKindAddWhere;      
        end;

        if( not m_IsWebService )
           GNUList = TArray();
           GNUList[GNUList.Size] = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRGROUP );
        else
           GNUList = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRGROUP );
        end;
        /*задана категория бумаги*/
        if( ( ValType( GNUList ) != V_UNDEF ) and ( GNUList.Size > 0 ) )
           while( GNUCount < GNUList.Size )
              if( ( ValType( GNUList[GNUCount] ) == V_INTEGER )
              and ( GNUList[GNUCount] > 0 ) )
               if( GNUAddWhere == "" )
                    GNUAddWhere = GNUAddWhere + " AND ( ";
                 else
                    GNUAddWhere = GNUAddWhere + " OR ";
                 end;
                 GNUAddWhere = GNUAddWhere + " av.t_TaxGroup = " + String( GNUList[GNUCount] ) + " ";
              end;
              GNUCount = GNUCount + 1;
           end;
           if( GNUAddWhere != "" )
              GNUAddWhere = GNUAddWhere + " ) ";
           end;
           AddWhere = AddWhere + GNUAddWhere;
        end;
     end;

     DataSubQuery = "select Rest.T_SOURCEID as SourceID, Rest.T_SALEID as SaleID, Rest.T_FIID as FIID, sum(Rest.T_AMOUNT) as Amount " +
                    "  from dsctxrest_dbt Rest, " +
                    "       dfininstr_dbt FI " +
                    " where Rest.T_TYPE in ("+TXREST_Open+","+TXREST_Closed+") and "+
                    "       (Rest.T_BUYDATE > " + GetSQLDate(Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_ENDDATE )) + " or " +
                    "        Rest.T_BUYDATE = TO_DATE('01.01.0001','DD.MM.YYYY')) and "
                    "       Rest.T_SALEDATE <= " + GetSQLDate(Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_ENDDATE )) + " and "
                    "       Rest.T_AMOUNT > 0 and " +
                    "       FI.T_FIID = Rest.T_FIID "
                    " group by Rest.T_FIID, Rest.T_SOURCEID, Rest.T_SALEID";

     DataQuery = "select FI.t_FI_Code           as SecCode, " +
                 "       FI.t_Name              as SecName, " +
                 "       FI.t_FaceValueFI       as FaceValueFI, " +
                 "       FI.t_FIID              as FIID, " +
                 "       FI.t_SumPrecision      as SumPrecision, " +
                 "       av.t_TaxGroup          as TaxGroup, " +
                 "       SaleLot.t_DealCodeTS   as CodeS, " +
                 "       SaleLot.t_ID           as SaleID, " +
                 "       SaleLot.t_VirtualType  as VirtualType, " +
                 "       SaleLot.t_DealID       as SaleDealID, " +
                 "       SaleLot.t_Amount       as SaleAmount, " +
                 "       DataSale.DealSaleGroup as DealSaleGroup, " +
                 "       DealSale.t_DealID      as DealSaleID, " +
                 "       DECODE(SaleLot.t_VirtualType, 1, DealSale.t_PartyID, 0) as SalePartyID, " +
                 "       DECODE(SaleLot.t_VirtualType, 1, DealSale.t_Department, 0) as DealSaleDepartment, " +
                 "       NVL((select t_BOfficeKind from ddl_tick_dbt where t_DealID = SaleLot.t_DealID), 0) as SaleBOfficeKind, " +
                 "       SaleLot.t_DealDate     as SaleDealDate, " +
                 "       SaleLot.t_SaleDate     as SaleDate, " +
                 "       Rest.Amount            as QntyOpen, " +
                 "       LegS.t_CFI             as VPrS, " +
                 "       LegS.t_Price           as SalePrice, " +

                 Get_PartyName_Query( "DealSale", "PartyNameSale" ) + ", " +/*PartyNameSale*/

                 IIF ( ((m_ReportKind == OUTSPREG_0702) or (m_ReportKind == OUTSPREG_0704)),
                           "       Rsb_SCTX.TXGetBondKind(av.t_TaxGroup) TaxGroupType, ", ""
                        ) +


                 "       RSB_FIInstr.CalcNKD_Ex( FI.t_FIID, SaleLot.t_SaleDate, Rest.Amount, 0 ) as NkdEndVN, " +
                 "       SourceLot.t_ID         as SourceID, " +
                 "       FI.t_DrawingDate, FI.t_SumPrecision, FI.t_Issued, FI.t_FI_Code as AvrCode " +
                 "  from dsctxlot_dbt currSaleLot, dsctxlot_dbt SaleLot, dsctxlot_dbt SourceLot, (" + DataSubQuery + ") Rest," +
                 "       dfininstr_dbt FI, ddl_tick_dbt DealSale, davoiriss_dbt av, ddl_leg_dbt LegS, " +

                 "        ( Select SaleOper.t_Kind_Operation, SaleOper.t_DocKind, " +
                 "                 rsb_secur.get_OperationGroup(SaleOper.t_SysTypes) as DealSaleGroup, " +
                 "                 (CASE WHEN " +
                 "                            ((Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsAvrWrtIn(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                            ) " +
                 "                       THEN 2 " +
                 "                       ELSE 0 END " +
                 "                 ) as LegKindSale " +
                 "            From " +
                 "                 doprkoper_dbt SaleOper " + 
                 "        ) DataSale " +

                 " where FI.t_FIID                 = Rest.FIID and " +
                 "       FI.t_FIID                 = av.t_FIID and " +
                 "       currSaleLot.t_ID          = Rest.SaleID and" +
                 "       SaleLot.t_ID              = currSaleLot.t_BegLotID and " +
                 "       SourceLot.t_ID            = Rest.SourceID and " +
                 "       SaleLot.t_VirtualType     in ( 1, 2 ) and " +
                 "       DealSale.t_DealID         = DECODE( SaleLot.t_VirtualType, 1, SaleLot.t_DealID, (select t_DealID from dsctxlot_dbt where t_ID = SaleLot.t_RealID) ) and " +
                 "       DataSale.t_Kind_Operation = DealSale.t_DealType AND " +
                 "       DataSale.t_DocKind        = DealSale.t_BOfficeKind AND " +
                 "       LegS.t_DealID             = SaleLot.t_DealID AND " +
                 "       LegS.t_LegKind            = DataSale.LegKindSale AND " +
                 "       LegS.t_LegID              = 0 " + AddWhere + ObjReport.Where();

     //msgbox(DataQuery);
     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Current = 0;

     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum, HTML_StSheetName, HTML_StSheetName);
     end;

     m_RS = TRsbDataSet( DataQuery );

     m_CacheFinInstr.Clear();

     OK = m_RS.MoveNext();

     if( OK )
        ObjReport.ПечататьСтрокуТаблицы( Строка_Итого );
     end;

     while( OK == true )

        this.ClearCacheOneRecord();
        m_IsDataExist = true;
        ObjReport.ПечататьСтрокуТаблицы( Строка_СтрокаДанных );

        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); // всего 3 парамера Update(index, count, text)
        OK = m_RS.MoveNext();
     end;

     ObjReport.EndReport();
     ProgressIndicator.Stop();
 
  END;

  PRIVATE MACRO CreateReportByKind( Kind:INTEGER )
     m_ReportKind = Kind;
     if( Kind == OUTSPREG_0701 )
        ExecuteReport( FormReg_0701(this) );
     elif( Kind == OUTSPREG_0702 )
        ExecuteReport( FormReg_0702(this) );
     elif( Kind == OUTSPREG_0703 )
        ExecuteReport( FormReg_0703(this) );
     elif( Kind == OUTSPREG_0704 )
        ExecuteReport( FormReg_0704(this) );
     end;
  END;

  PRIVATE MACRO Create()
     var SubKindList = null;
     var SubKindCount : Integer = 0;
     if( not m_IsWebService )
        SubKindList = TArray();
        SubKindList[SubKindList.Size] = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_TYPE );
     else
        SubKindList = Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_TYPE );
     end;

     if( ( ValType( SubKindList ) != V_UNDEF )
     and ( SubKindList.Size > 0 )
     and ( ValType( SubKindList[SubKindCount] ) == V_INTEGER )
     and ( SubKindList[SubKindCount] != OUTSPREG_ALL ) )
        while( SubKindCount < SubKindList.Size )
           CreateReportByKind( SubKindList[SubKindCount] );
           SubKindCount = SubKindCount + 1;
        end;
     else
        CreateReportByKind( OUTSPREG_0701 );
        CreateReportByKind( OUTSPREG_0702 );
        CreateReportByKind( OUTSPREG_0703 );
        CreateReportByKind( OUTSPREG_0704 );
     end;
  END;

  PRIVATE VAR m_DZS,
              m_DDS,
              m_VN,
              m_QntyOpen,
              m_CrSD,
              m_NkdSvn,
              m_NkdSrub,
              m_NkdEndVN,
              m_NkdEndRub,
              m_NkdPrevVN,
              m_NkdPrevRub,
              m_CoupPrevVN,
              m_CoupPrevRub,
              m_CoupVN,
              m_CoupRub,
              m_ProcAllRub,
              m_ProcPrevRub,
              m_ProcRepRub,
              m_AmortVN,
              m_ContS,
              m_FilS,
              m_SecType,
              m_ProcAllVN,
              m_ProcPrevVN,
              m_RegS,
              m_PrAucNom,
              m_PrSNom,
              m_DealSale = TBFile( "dl_tick.dbt", "R", 0 );

  /*Методы для получения данных*/
  MACRO ClearCacheOneRecord()
    m_DZS         = null;
    m_DDS         = null;
    m_QntyOpen    = null;
    m_CrSD        = null;
    m_NkdSvn      = null;
    m_NkdSrub     = null;
    m_NkdEndVN    = null;
    m_NkdEndRub   = null;
    m_NkdPrevVN   = null;
    m_NkdPrevRub  = null;
    m_CoupPrevVN  = null;
    m_CoupPrevRub = null;
    m_CoupVN      = null;
    m_CoupRub     = null;
    m_ProcAllRub  = null;
    m_ProcPrevRub = null;
    m_ProcRepRub  = null;
    m_AmortVN     = null;
    m_ContS       = null;
    m_FilS        = null;
    m_SecType     = null;
    m_ProcAllVN   = null; 
    m_ProcPrevVN  = null;
    m_RegS        = null;
    m_PrAucNom    = null;
    m_PrSNom      = null;    
    m_DealSale.Clear();
  END;

  PRIVATE MACRO GetDeal( Deal:TBFile, DealID:INTEGER ):BOOL
     Deal.Clear();
     Deal.rec.DealID = DealID;
     return Deal.GetEQ();
  END;

  MACRO DealSale():TBFile
     if( m_DealSale.rec.DealID == 0 )
        if( GetDeal( m_DealSale, m_RS.DealSaleID ) == false )
           MsgBox( "Не найдена сделка по лоту налогового учета DSCTXLOT_DBT.t_DealID = " + string(m_RS.DealSaleID)  );
           m_DealSale.Clear();
        end;
     end;
     return m_DealSale;
  END;

  PRIVATE MACRO SaleIsBack():BOOL
     return ( IsBUY( int(m_RS.DealSaleGroup) ) OR IsAVRWRTIN( int(m_RS.DealSaleGroup) ) );
  END;

  PRIVATE MACRO BuyIsBack():BOOL
     return ( IsSale( int(m_RS.DealBuyGroup) ) OR IsAVRWRTOUT( int(m_RS.DealBuyGroup) ) );
  END;

  /*Наименование нашего банка*/
  MACRO H0_A():STRING
     return ПолучитьКороткоеИмяСубъекта( {OurBank} );
  END;

  /*ИНН / КПП нашего банка*/
  MACRO H0_B()
     VAR INN, KPP;

     SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, KPP );
     return INN + "/" + KPP;
  END;

  /*Константа, задаваемая в макросе формировании отчета. Значение константы - текст "07"*/
  MACRO H0_1():STRING
     return "07";
  END;

  /*Константа, задаваемая в макросе формировании отчета.  Значение константы - текст  "XXX"*/
  MACRO H0_2():STRING
     return "XXX";
  END;

  /*Константа, задаваемая в макросе формировании отчета. Значение константы -текст
       "01" - для подвида 0301
       "02" - для подвида 0302  */
  MACRO H0_3():STRING
     if( m_ReportKind == OUTSPREG_0701 )
        return "01";
     elif( m_ReportKind == OUTSPREG_0702 )
        return "02";
     elif( m_ReportKind == OUTSPREG_0703 )
        return "03";
     elif( m_ReportKind == OUTSPREG_0704 )
        return "04";
     end;
  END;

  /*Номер месяца из даты <H0_.8>*/
  MACRO H0_4():STRING
     VAR Month;
     DateSplit( this.H0_8(), null, Month, null );

     return string(Month:2:o);
  END;

  /*Две последние цифры года из даты <H0_.8>*/
  MACRO H0_5():STRING
     VAR Year;
     DateSplit( this.H0_8(), null, null, Year );

     return SubStr( string(Year), strlen(string(Year))-1 );
  END;

  /*Название подвида регистра:*/
  MACRO H0_6():STRING
     if( m_ReportKind == OUTSPREG_0701 )
        return "Расчет суммы процентного расхода по открытым на конец отчетного (налогового) периода коротким позициям по купонным облигациям (номинированным в валюте РФ).";
     elif( m_ReportKind == OUTSPREG_0702 )
        return "Расчет суммы процентного расхода по открытым на конец отчетного (налогового) периода коротким позициям по дисконтным облигациям (номинированным в валюте РФ)";
     elif( m_ReportKind == OUTSPREG_0703 )
        return "Расчет суммы процентного расхода по открытым на конец отчетного (налогового) периода коротким позициям по купонным облигациям (номинированным в иностранной валюте).";
     elif( m_ReportKind == OUTSPREG_0704 )
        return "Расчет суммы процентного расхода по открытым на конец отчетного (налогового) периода коротким позициям по дисконтным облигациям (номинированным в иностранной валюте)";
     end;
  END;

  /*Начальная дата*/
  MACRO H0_7():DATE
     VAR Year;
     DateSplit( this.H0_8(), null, null, Year );
     return Date(1,1,Year);
  END;

  /*Конечная дата*/
  MACRO H0_8():DATE
     return Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_ENDDATE );
  END;

  /*Группа налогового учета*/
  MACRO H0_9():STRING
     var GroupName = "";
     Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRGROUP, @GroupName );
     return GroupName;
  END;

  /*Вид ц/б*/
  MACRO H0_10():STRING
     var AvrKindShowValue = "";
     Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRKIND, @AvrKindShowValue );
     return AvrKindShowValue;
  END;

  /*Выпуск ц/б*/
  MACRO H0_11():STRING
     return Outlay_SPReg_Form.GetFieldValue( PNFLD_OUTSPREG_AVRNAME );
  END;

  /*Константа, задаваемая в макросе формировании отчета.  Значение константы - текст  "РР"*/
  MACRO H0_12():STRING
     return "PP";
  END;

  MACRO Дн():DATE // максимальная из двух дат: (<H0.7>; <DDS>+1)
     return MAX( this.H0_7(), this.DDS()+1 );
  END;

  MACRO SecCode()
    return m_RS.SecCode;
  END;

  MACRO SecName()
    return m_RS.SecName;
  END;

  MACRO CodeS()
    return m_RS.CodeS;
  END;

  MACRO DZS():DATE /* Дата заключения сделки на реализацию ЦБ*/
     if( m_DZS == NULL )
       m_DZS = SQL_ConvTypeDate(m_RS.SaleDealDate);
     end;
     return m_DZS;
  END;

  MACRO DDS():DATE /* Дата перехода права собств-ти при реализации ЦБ*/
     return SQL_ConvTypeDate(m_RS.SaleDate);
  END;

  MACRO QntyOpen()
     /*bug WinRep: точность денег всегда 2? приходится через double ...*/
     return double(m_RS.QntyOpen);
  END;

  MACRO QntyPrecision():INTEGER //  точность кол-ва
     return m_RS.SumPrecision;
  END;

  MACRO VN():STRING /* Код валюты номинала (или  Номинал - валюта)*/
     return m_CacheFinInstr.GetISO( m_RS.FaceValueFI ).m_Number;
  END;

  MACRO CrSD():DOUBLE //  Для подвида 201: Курс пересчета цены/ст-ти реализации в рублевый эквивалент Для подвида 0204; 0205;0206:Курс ЦБ РФ на дату реализации
     if( m_CrSD == NULL )
        m_CrSD = GetRateOnDateCrossDbl( DDS(), m_RS.FaceValueFI, NATCUR, true );
     end;
     return m_CrSD;
  END;

  MACRO NkdSvn():MONEY //  НКД полученный при реализации (погашении)
     var N = 0;
     var rate = 0;
     if( m_NkdSvn == NULL )

        if( FindDL_LEG( GetLegKindByBackFlag( SaleIsBack() ), m_RS.DealSaleID, 0, m_dl_leg ) == 0 )
           if(this.VPrS() == m_RS.FaceValueFI)
             N = m_dl_leg.rec.NKD;
           elif((this.VPrS() == NATCUR) and (m_RS.FaceValueFI != NATCUR))
             if(this.CrSD() != 0.0)
               N = m_dl_leg.rec.NKD/this.CrSD();
             end;
           end;
           
           if( m_RS.VirtualType == TXVDEAL_REAL)
              m_NkdSvn = N*(this.QntyOpen()/m_dl_leg.rec.Principal);
           else
              m_NkdSvn = НКД( m_RS.FIID, QntyOpen(), DDS() );
           end;
        else
           m_NkdSvn = $0;
        end;                  
     end;
     return m_NkdSvn;
  END;

  MACRO NkdSrub():MONEY // НКД полученный при реализации (погашении) - Сумма, руб.
      return NkdSvn() * this.CrSD();
  END;

  MACRO NkdEndVN():MONEY // НКД, причитающ. к получению от эмитента на конец отчетного (налогового) периода:
     if( m_NkdEndVN == NULL )
        m_NkdEndVN = НКД( m_RS.FIID, QntyOpen(), this.H0_8());
     end;
     return m_NkdEndVN;
  END;

  MACRO NkdEndrub():MONEY // НКД, причитающ. к получению от эмитента на конец отчетного (налогового) периода в рублях
     if( m_NkdEndRub == NULL )
        SmartConvertSum( m_NkdEndRub, NkdEndVN(), this.H0_8(), m_RS.FaceValueFI, NATCUR, true );
     end;
     return m_NkdEndRub;
  END;

  MACRO NkdPrevVN():MONEY // Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода  :
     if( m_NkdPrevVN == NULL )
        if( this.DDS() < this.H0_7() )
           m_NkdPrevVN = НКД( m_RS.FIID, QntyOpen(), this.H0_7()-1);
        else
           m_NkdPrevVN = 0.0;
        end;
     end;
     return m_NkdPrevVN;
  END;

  MACRO NkdPrevRub() //  Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода - Сумма, руб
     if( m_NkdPrevRub == NULL )
        if( this.DDS() < this.H0_7() )
           SmartConvertSum( m_NkdPrevRub, NkdPrevVN(), this.H0_7()-1, m_RS.FaceValueFI, NATCUR, true );
        else
           m_NkdPrevRub = 0.0;
        end;
     end;
     return m_NkdPrevRub;
  END;

  MACRO CoupVN():MONEY //  Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде (кроме купона, полученного при погашении бумаги) :
     if( m_CoupVN == NULL )
        m_CoupVN = GetCouponSumByPeriod( m_RS.FIID, QntyOpen(), Дн(), this.H0_8() );
     end;
     return m_CoupVN;
  END;

  MACRO CoupRub():MONEY // Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде (кроме купона, полученного при погашении бумаги) - сумма, руб
     if( m_CoupRub == NULL )
        m_CoupRub = GetCouponSumByPeriod_Rub( m_RS.FIID, QntyOpen(), Дн(), this.H0_8(), m_RS.FaceValueFI );
     end;
     return m_CoupRub;
  END;

  MACRO CoupPrevVN():MONEY // Сумма купонов, выплаченных эмитентом до начала текущего отчетного (налогового) периода
     if( m_CoupPrevVN == NULL )
        if( DDS() < this.H0_7() ) 
           m_CoupPrevVN = GetCouponSumByPeriod( m_RS.FIID, QntyOpen(), DDS()+1, this.H0_7()-1 );
        else
           m_CoupPrevVN = $0;
        end;
     end;
     return m_CoupPrevVN;
  END;

  MACRO CoupPrevRub():MONEY // Сумма купонов, выплаченных эмитентом до начала текущего отчетного (налогового) периода-в рублях
     if( m_CoupPrevRub == NULL )
        if( DDS() < this.H0_7() ) 
           m_CoupPrevRub = GetCouponSumByPeriod_Rub( m_RS.FIID, QntyOpen(), DDS()+1, this.H0_7()-1, m_RS.FaceValueFI );
        else
           m_CoupPrevRub = $0;
        end;
     end;
     return m_CoupPrevRub;
  END;

  MACRO ProcAllVN():MONEY // Процентный расход по операции, связанной с открытием короткой позиции - всего, в валюте
    if(m_ProcAllVN == NULL)
      if(ЛьготнаяОблигация( m_RS.TaxGroupType ))
        m_ProcAllVN = this.QntyOpen()*this.Nom()*(100.0 - this.PrAucNom())*(this.H0_8()-this.DDS()) /(this.Dexp()-this.Dauc())/100.0;
      else
        m_ProcAllVN = this.QntyOpen()*this.Nom()*(100.0 - this.PrSNom())*(this.H0_8()-this.DDS()) /(this.Dexp()-this.DDS())/100.0;
      end;
    end;

    return m_ProcAllVN;
  END;

  MACRO ProcAllRub():MONEY // Процентный расход по операции, связанной с открытием короткой позиции - всего, руб.
    var K1;
     if( m_ProcAllRub == NULL )
        if( m_ReportKind == OUTSPREG_0701 )
           m_ProcAllRub = NkdEndVN() + CoupPrevVN() + CoupVN() - NkdSvn();
        elif( m_ReportKind == OUTSPREG_0702 )
           m_ProcAllRub =  this.ProcAllVN();
        elif( m_ReportKind == OUTSPREG_0703 )
             if( CoupPrevVN() + CoupVN() > 0 )
                K1 = CrSD();
             else
                K1 = GetRateOnDateCrossDbl( this.H0_8(), m_RS.FaceValueFI, NATCUR, true );
             end;
             m_ProcAllRub = NkdEndRub() + CoupPrevRub() + CoupRub() - NkdSvn() * K1;
        elif( m_ReportKind == OUTSPREG_0704 )
           K1 = GetRateOnDateCrossDbl( this.H0_8(), m_RS.FaceValueFI, NATCUR, true );
           m_ProcAllRub =  this.ProcAllVN() * K1;
        end;
     end;
     return m_ProcAllRub;
  END;

  MACRO ProcPrevVN():MONEY //Процентный расход, учтенный для целей налогообложения до начала текущего отчетного (налогового) периода - в валюте
   if(m_ProcPrevVN == NULL)
     if(this.DDS() >= this.H0_7())
       m_ProcPrevVN = 0;
     else
       if(ЛьготнаяОблигация( m_RS.TaxGroupType ))
         m_ProcPrevVN = this.QntyOpen()*this.Nom()*(100.0 - this.PrAucNom())*(this.H0_7()-1-this.DDS()) /(this.Dexp()-this.Dauc())/100.0;
       else
         m_ProcPrevVN = this.QntyOpen()*this.Nom()*(100.0 - this.PrSNom())*(this.H0_7()-1-this.DDS()) /(this.Dexp()-this.DDS())/100.0;
       end;
     end;
   end;

   return m_ProcPrevVN;
  END;

  MACRO ProcPrevRub():MONEY //Процентный расход, учтенный для целей налогообложения до начала текущего отчетного (нало-гового) периода, руб
    var K2;
     if( m_ProcPrevRub == NULL )
        if( DDS() >= this.H0_7() )
           m_ProcPrevRub = $0;
        else
           if( m_ReportKind == OUTSPREG_0701 )
              m_ProcPrevRub = NkdPrevVN() + CoupPrevVN() - NkdSvn();
           elif( m_ReportKind == OUTSPREG_0702 )
              m_ProcPrevRub = this.ProcPrevVN();
           elif( m_ReportKind == OUTSPREG_0703 )
                if( CoupPrevVN() > 0 )
                   K2 = CrSD();
                else
                   K2 = GetRateOnDateCrossDbl( this.H0_7()-1, m_RS.FaceValueFI, NATCUR, true );
                end;
                m_ProcPrevRub = NkdPrevRub() + CoupPrevRub() - NkdSvn() * K2;
           elif( m_ReportKind == OUTSPREG_0704 )
             K2 = GetRateOnDateCrossDbl( this.H0_7()-1, m_RS.FaceValueFI, NATCUR, true );
             m_ProcPrevRub = this.ProcPrevVN() * K2;
           end;
        end;
     end;
     return m_ProcPrevRub;
  END;

  MACRO ProcRepRub()
     if( m_ProcRepRub == NULL )
        m_ProcRepRub = ProcAllRub() - ProcPrevRub();
     end;
     return m_ProcRepRub;
  END;
  
  /*MACRO AmortVN():MONEY
    var NomDDS, NomH08, Res;
     if( m_AmortVN == NULL )
        Res = SP_GetNominal( m_RS.FIID, DDS(), NomDDS );
        Res = SP_GetNominal( m_RS.FIID, this.H0_8(), NomH08 );
        m_AmortVN = (NomDDS - NomH08) * QntyOpen();
     end;
     return m_AmortVN;
  END;*/

  MACRO AmortVN():MONEY // Доходы, полученные при частичном погашении номинала :
     if( m_AmortVN == NULL )
        m_AmortVN = GetPartialSumByPeriod( m_RS.FIID, this.QntyOpen(), this.DDS()+1, this.H0_8(), null );
     end;
     return m_AmortVN;
  END;

  MACRO ContS():STRING // Контрагент по сделке реализации 
     return m_RS.PartyNameSale;
  END;

  MACRO FilS():STRING //  Номер сделки реализации - ГО/филиал
     return T_Dep.Get_Dep(Int(m_RS.DealSaleDepartment));
  END;

  MACRO SecType() // Налоговая группа
     return m_RS.TaxGroup;
  END;

  MACRO VprS():INTEGER
     return m_RS.VprS;
  END;

  MACRO VPrSNumber():STRING //  Код валюты цены реализации
     return m_CacheFinInstr.GetISO( this.VprS() ).m_Number;
  END;

  MACRO RegS():DATE
    if(m_RegS == NULL)
      m_RegS = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealSale(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_REQUALREPO);
      if((ValType(m_RegS) != V_UNDEF) and (m_RegS != ""))
        m_RegS = date(m_RegS);
      end;
    end;
    return m_RegS;
  END;

  MACRO LastCoupDate():DATE
    return GetMaxCouponDrawingDateInPeriod(m_RS.FIID, this.Дн(), this.H0_8());
  END;

  MACRO CoupCount():INTEGER
    return GetCountCouponInPeriod(m_RS.FIID, this.Дн(), this.H0_8());
  END;

  MACRO Nom():MONEY
     return m_CacheFinInstr.GetNominal( m_RS.FIID ).m_Value;
  END;

  MACRO Dexp():DATE //  Дата погашения ц/б
     return SQL_ConvTypeDate( m_RS.t_DrawingDate );
  END;  

  MACRO Dauc():DATE //  Дата размещения ц/б
     return SQL_ConvTypeDate( m_RS.t_Issued );
  END;

  MACRO PrAucNom():DOUBLE //  Цена размещения в % от номинала
     if( m_PrAucNom == NULL )
        /*10 - Цена первичного размещения*/
        if( ЛьготнаяОблигация( m_RS.TaxGroupType ) )
          m_PrAucNom = readNoteForObject( OBJTYPE_AVOIRISS, L_Z( m_RS.FIID, 10 ), 10 );
          if( m_PrAucNom <= 0 )
             MsgBox( "Для ц/б \"" + m_RS.AvrCode + "\" не задано примечание \"" + ИмяПримечания( OBJTYPE_AVOIRISS, 10 ) + "\"" );
             m_PrAucNom = 0.0;
          end;
        end;
     end;
     return m_PrAucNom;
  END;

  MACRO PrSNom():DOUBLE //  Цена реализации, % от номинала (из сделки)
     if( m_PrSNom == NULL )
       m_PrSNom = m_RS.SalePrice;
     end;
     return m_PrSNom;
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    Outlay_SPReg_Form = SP_OutlaySPReg_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      Outlay_SPReg_Form = WS_TX_OutlaySPReg_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = Outlay_SPReg_Form.Run();
    end;

    if( stat )
      Outlay_SPReg_Report = SP_OutlaySPReg_Report( null, "report_txoutlay.xls", null, IsWebService, ReportHashCode );
      Outlay_SPReg_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( Outlay_SPReg_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = Outlay_SPReg_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( Outlay_SPReg_Report.PrintMode() );
      end;
    end;
  end;
   
  return FullReportFileNames;
END;
