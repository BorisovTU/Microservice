/*
$Name:        sp_doc_comm.mac
$Module:      Ценные бумаги
$Description: 
*/
import OprInter, "sp_grfun.mac", "oprmassexec.mac", "BankInter";

MACRO InitOperation( KindOpr, KindDoc, FDoc )
    RECORD comm(dl_comm);
    
    SetBuff( comm, FDoc );

    return 0;
END;

MACRO PrepMassInitOperation()
   
    return 0;
END;

// ! Макрос инициализации вызываемый в транзакции.
// ! Вызов выполняется один раз для каждого вида операции, по которой будет выполнен массовый старт.
MACRO ExecMassInitOperation()
  var sql, cmd, DataSet;

  cmd = DL_RSDCommand(  " select comm.t_DocKind, comm.t_DocumentID, comm.t_CommDate, comm.t_CommTime, comm.t_FIID, comm.t_clientID "
                      + "   from doprtemp_tmp oprtemp, "
                      + "        ddl_comm_dbt comm "
                      + "  where oprtemp.t_SkipDocument = 0 "
                      + "    and lpad(comm.t_DocumentID, 34, '0') = oprtemp.t_DocumentID "
                      + "    and comm.t_DocKind = oprtemp.t_DocKind "
                     );

  DataSet = cmd.Execute();

  var PrevDocumentID:integer = -1;
  while(DataSet.moveNext())

    if( PrevDocumentID == DataSet.DocumentID )
       continue;
    end;

    SetGrDeal(DataSet.DocKind, DataSet.DocumentID, DataSet.FIID, DLGR_TEMPL_DEPODRAFT, date(DataSet.CommDate), time(DataSet.CommTime));
    if (int(DataSet.clientID) != -1)
      SetGrDeal(DataSet.DocKind, DataSet.DocumentID, DataSet.FIID, DLGR_TEMPL_DELIVERY, date(DataSet.CommDate), time(DataSet.CommTime));
    end;

    PrevDocumentID = DataSet.DocumentID;
  end;

  InsertAllGrDeal();

  DataSet = cmd.Execute();
  PrevDocumentID = -1;

  while (DataSet.moveNext())
    if( PrevDocumentID == DataSet.DocumentID )
       continue;
    end;
    if (int(DataSet.clientID) != -1)
      var Query = "";
      var cmd_update;
      Query = " UPDATE "
                + " ddlgracc_dbt gracc "
            + " SET "
                + " gracc.t_State = " + String(DLGRACC_STATE_NOTNEED) + " "
            + " WHERE "
                + " gracc.t_GrDealID IN (SELECT "
                                         + " grdeal.t_ID "
                                     + " FROM "
                                         + " ddlgrdeal_dbt grdeal "
                                        + " ,ddl_comm_dbt comm "
                                     + " WHERE "
                                         + " grdeal.t_DocID = comm.t_DocumentID "
                                     + " AND grdeal.t_DocKind = comm.t_DocKind "
                                     + " AND grdeal.t_TemplNum = " + String(DLGR_TEMPL_DELIVERY) + " "
                                     + " AND comm.t_DocumentID = " + DataSet.DocumentID + ")"
            + " AND gracc.t_AccNum in (" + String(DLGR_ACCKIND_BACKOFFICE) + ","
                                         + String(DLGR_ACCKIND_ACCOUNTING) + ")";

      cmd_update = RSDCommand(Query);
      cmd_update.Execute();
    end;
    PrevDocumentID = DataSet.DocumentID;
  end;

  return 0;

OnError( RslErrObj )
  RemProgress();
  CreateErrMsg( 8029, "ExecMassInitOperation. "+RslErrObj.Message);
  runerror();
END;