/*
$Name:        ownmsgrep.mac
$Module:      Ценные бумаги (ОЭБ)
$Description: Макрос подготовки печатной формы сообщения по раскрытию информации
*/
import DealsInter, SPInter, PTInter, CTInter, globals, scsrvrepfun, dlwreps, sptagfl, sprepfun, spretownfun;
import RsbDataSet;
/*DAN Дата фиксации*/
const DateFix = -5;
const NotPayAgentDate = Date(1,1,2012);
/*Константы для решения теущих проблем реализации*/
const Bank_Full_Name_const  = "Акционерное общество \"Российский Сельскохозяйственный Банк\"";
const Bank_short_Name_const = "АО \"Россельхозбанк\"";
const AuthPos_const  = "Руководитель Аппарата корпоративного секретаря"; 
const AuthName_const = "А.М.Коваленко";

private macro RemoveLastComma(str)
 if(substr(str,strlen(str)) == ",")
   return substr(str,1,strlen(str)-1); 
 end;
  return str;
end;

private macro IsMarketBond(fiid)
 var dl_sql =  "SELECT 1 " +
               "  FROM dobjatcor_dbt atcor, dobjattr_dbt attr " +
               " WHERE     ATCOR.T_OBJECTTYPE = ATTR.T_OBJECTTYPE " +
               "       AND ATCOR.T_GROUPID = ATTR.T_GROUPID " +
               "       AND ATCOR.T_ATTRID = ATTR.T_ATTRID " +
               "       AND ATTR.T_NAME = 'Да' " +
               "       AND atcor.t_object = ? " +
               "       AND atcor.t_groupid = ? " + //111
               "       AND atcor.t_objecttype = ?; " ; //12
  var dl_cmd = dl_RSDCommand(dl_sql);             
  dl_cmd.AddParam(fiid);
  dl_cmd.AddParam(111);
  dl_cmd.AddParam(12);
  var dl_rs = dl_cmd.execute();
  if(dl_rs.movenext())
    return 1;
  end;
   return 0;  
end;

private macro GetPlacedAmountOnDate(FIID:INTEGER, OnDate:DATE):NUMERIC
   var Amount = 0;
   var query = "select RSB_PMWRTOFF.WRTGetAmountOwn( ?, ?, ?, ?, ? ) Amount from dual ";
   var cmd = DL_RSDCommand(query);
   cmd.AddParam(-1);
   cmd.AddParam(FIID);
   cmd.AddParam(OnDate);
   cmd.AddParam(1);
   cmd.AddParam(0);

   var DataSet = cmd.Execute();

   if(DataSet.moveNext())
     Amount = DataSet.Amount;
   end;

   return Amount;
end;

private macro GetRedemptionAmountOnDate(FIID:INTEGER, OnDate:DATE):NUMERIC
   var Amount = 0;
   var query = "select RSB_PMWRTOFF.WRTGetAmountOwn( ?, ?, ?, ?, ? ) Amount from dual ";
   var cmd = DL_RSDCommand(query);
   cmd.AddParam(-1);
   cmd.AddParam(FIID);
   cmd.AddParam(OnDate);
   cmd.AddParam(0);
   cmd.AddParam(1);
   
   var DataSet = cmd.Execute();

   if(DataSet.moveNext())
     Amount = DataSet.Amount;
   end;

   return Amount;
end;

private macro GetAmountOnDate(FIID:INTEGER, OnDate:DATE, IsPlacement:integer, IsREdemption:integer):NUMERIC
   var Amount = 0;
   var query = "select RSB_PMWRTOFF.WRTGetAmountOwn( ?, ?, ?, ?, ? ) Amount from dual ";
   var cmd = DL_RSDCommand(query);
   cmd.AddParam(-1);
   cmd.AddParam(FIID);
   cmd.AddParam(OnDate);
   //cmd.AddParam(0);
   //cmd.AddParam(1);
   cmd.AddParam(IsPlacement);
   cmd.AddParam(IsREdemption);

   var DataSet = cmd.Execute();

   if(DataSet.moveNext())
     Amount = DataSet.Amount;
   end;

   return Amount;
end;



private macro GetRepaymentAmount(FIID:integer, Number_Coupon:string)
  var query, cmd, DataSet;
  var RepaymentAmount = 0;

  query =   " select Nvl(Sum(lnk.t_Amount), 0) as RepaymentAmount "
          + "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt saleLot, ddl_tick_dbt tk "
          + "  where lnk.t_Kind IN ("+PMWRTLINK_KIND_RETISSUE+", "+PMWRTLINK_KIND_RETCOUPON+") "
          + "    and saleLot.t_SumID = lnk.t_SaleID "
          + "    and saleLot.t_FIID = ? "
          + "    and tk.t_DealID = saleLot.t_DealID "
          + "    and tk.t_BOfficeKind = " + DL_RETIREMENT_OWN
          + "    and tk.t_PFI = saleLot.t_FIID "
          + "    and tk.t_Number_Coupon = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FIID);
  cmd.AddParam(Number_Coupon);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    RepaymentAmount = DataSet.RepaymentAmount;
  end;

  return RepaymentAmount;
end;

private macro GetOwnListNumStr(FIID:integer, Number_Coupon:string)
  var query, cmd, DataSet;
  var OwnListNumStr = "";

  query =   " select ls.t_ListNum "
          + "   from dscownlist_dbt ls "
          + "  where ls.t_FIID = ? "
          + "    and ls.t_Number_Coupon = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FIID);
  cmd.AddParam(Number_Coupon);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    OwnListNumStr = "№"+DataSet.ListNum;
    while(DataSet.moveNext())
      OwnListNumStr = OwnListNumStr + ", №"+DataSet.ListNum;
    end;
  end;

  return OwnListNumStr;
end;

private macro GetForeignLE_Name(FIID:integer, Number_Coupon:string)
  var query, cmd, DataSet;
  var ForeignLE_Name = "";

  query =   " select tx.t_TaxSum, pt.t_ShortName "
          + "   from dscowntax_tmp tx, dscownhist_dbt hs, dscownlist_dbt ls, dparty_dbt pt "
          + "  where tx.t_TaxSum > 0 "
          + "    and hs.t_ID = tx.t_SHID "
          + "    and pt.t_PartyID = hs.t_OwnerID "
          + "    and pt.t_LegalForm = " + PTLEGF_INST
          + "    and RSB_SECUR.IsTaxResident(hs.t_OwnerID, ls.t_ListDate) = 0 "
          + "    and ls.t_ListID = hs.t_ListID "
          + "    and ls.t_FIID = ? "
          + "    and ls.t_Number_Coupon = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FIID);
  cmd.AddParam(Number_Coupon);
  
  if(cmd.GetCount() > 0)
    ForeignLE_Name = "(в том числе удержан налог на доходы иностранной организации";
    
    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      ForeignLE_Name = ForeignLE_Name + " " + DataSet.ShortName+ " в сумме " + DataSet.TaxSum + " руб.";
    end;

    ForeignLE_Name = ForeignLE_Name + ")";
  end;

  return ForeignLE_Name;
end;

private var DefaultParamStr = "ХХХХХХХ";
private var UseNULLParams = false;

private macro GetStrParam(param_str)
  if(param_str == "")
    return DefaultParamStr;
  end;
  return param_str;
end;

private macro PrintParam(param_str)
  if((param_str == NULL) or (UseNULLParams == true))
    println("");
  elif(param_str == "")
    println(DefaultParamStr);
  else
    println(param_str);
  end;
end;

private macro SetUseNULLParams(_UseNULLParams:bool)
  UseNULLParams = _UseNULLParams;
end;

private macro ПолучитьНаименованиеВалюты(Amount:money, Currency:integer)
  var CurrencyName = "";
  var AmountStr = "";
  var str = CurToStrAlt(Amount, AmountStr, null, DL_GetISOCode(Currency));

  str = trim(StrSubst(str, AmountStr, ""));

  var ind = Index(str, " ");
  if(ind < 0)
    CurrencyName = str;
  else
    CurrencyName = substr(str, 1, ind);
  end;

  return CurrencyName;
end;

private macro GetLastIndex(str:string, findstr:string)
  var ind = Index(str, findstr);
  var prev_ind = ind;

  while(ind > 0)
    prev_ind = ind;

    ind = Index(str, findstr, ind+1);
  end;

  return prev_ind;
end;


//!!!работает только до 10000
//возвращает строкой номер купона в падеже: 1 - в именительноммуж. рода, иначе в родительном сред. рода
private macro ПолучитьНомерКупонаВПадеже(Number_Coupon:string, type:integer)

  if(StrIsNumber(Number_Coupon) == false)
    return Number_Coupon;
  end;

  var num_str = trim(NumToStr(Number_Coupon, null, null, null, true));
  var ind = GetLastIndex(num_str, " ");
  var end_str = "", result_str = "";

  if(ind == 0)
    end_str    = num_str;
    result_str = "";
  else
    end_str    = trim(substr(num_str, ind));
    result_str = trim(substr(num_str, 1, ind));
  end;

  if(num_str == "одна тысяча")     result_str = IIF(type==1, "тысячный",       "тысячного");
  elif(num_str == "две тысячи")    result_str = IIF(type==1, "двухтысячный",   "двухтысячного");
  elif(num_str == "три тысячи")    result_str = IIF(type==1, "трехтысячный",   "трехтысячного");   
  elif(num_str == "четыре тысячи") result_str = IIF(type==1, "четырехтысячный","четырехтысячного");
  elif(num_str == "пять тысяч")    result_str = IIF(type==1, "пятитысячный",   "пятитысячного");   
  elif(num_str == "шесть тысяч")   result_str = IIF(type==1, "шеститысячный",  "шеститысячного");  
  elif(num_str == "семь тысяч")    result_str = IIF(type==1, "семитысячный",   "семитысячного");   
  elif(num_str == "восемь тысяч")  result_str = IIF(type==1, "восьмитысячный", "восьмитысячного"); 
  elif(num_str == "девять тысяч")  result_str = IIF(type==1, "девятитысячный", "девятитысячного"); 
  elif(num_str == "десять тысяч")  result_str = IIF(type==1, "десятитысячный", "десятитысячного"); 
  else                                                                                           
    if(end_str != "")                                                                            
      if(end_str == "один")           end_str = IIF(type==1, "первый",         "первого");         
      elif(end_str == "два")          end_str = IIF(type==1, "второй",         "второго");         
      elif(end_str == "три")          end_str = IIF(type==1, "третий",         "третьего");         
      elif(end_str == "четыре")       end_str = IIF(type==1, "четвертый",      "четвертого");      
      elif(end_str == "пять")         end_str = IIF(type==1, "пятый",          "пятого");          
      elif(end_str == "шесть")        end_str = IIF(type==1, "шестой",         "шестого");         
      elif(end_str == "семь")         end_str = IIF(type==1, "седьмой",        "седьмого");        
      elif(end_str == "восемь")       end_str = IIF(type==1, "восьмой",        "восьмого");        
      elif(end_str == "девять")       end_str = IIF(type==1, "девятый",        "девятого");        
      elif(end_str == "десять")       end_str = IIF(type==1, "десятый",        "десятого");        
      elif(end_str == "одиннадцать")  end_str = IIF(type==1, "одиннадцатый",   "одиннадцатого");   
      elif(end_str == "двенадцать")   end_str = IIF(type==1, "двенадцатый",    "двенадцатого");    
      elif(end_str == "тринадцать")   end_str = IIF(type==1, "тринадцатый",    "тринадцатого");    
      elif(end_str == "четырнадцать") end_str = IIF(type==1, "четырнадцатый",  "четырнадцатого");  
      elif(end_str == "пятнадцатьь")  end_str = IIF(type==1, "пятнадцатый",    "пятнадцатого");    
      elif(end_str == "шестнадцать")  end_str = IIF(type==1, "шестнадцатый",   "шестнадцатого");   
      elif(end_str == "семнадцать")   end_str = IIF(type==1, "семнадцатый",    "семнадцатого");    
      elif(end_str == "восемнадцать") end_str = IIF(type==1, "восемнадцатый",  "восемнадцатого");  
      elif(end_str == "девятнадцать") end_str = IIF(type==1, "девятнадцатый",  "девятнадцатого");  
      elif(end_str == "двадцать")     end_str = IIF(type==1, "двадцатый",      "двадцатого");      
      elif(end_str == "тридцать")     end_str = IIF(type==1, "тридцатый",      "тридцатого");      
      elif(end_str == "сорок")        end_str = IIF(type==1, "сороковой",      "сорокового");      
      elif(end_str == "пятьдесят")    end_str = IIF(type==1, "пятидесятый",    "пятидесятого");    
      elif(end_str == "шестьдесят")   end_str = IIF(type==1, "шестидесятый",   "шестидесятого");   
      elif(end_str == "семьдесят")    end_str = IIF(type==1, "семидесятый",    "семидесятого");    
      elif(end_str == "восемьдесят")  end_str = IIF(type==1, "восьмидесятый",  "восьмидесятого");  
      elif(end_str == "девяносто")    end_str = IIF(type==1, "девяностый",     "девяностого");     
      elif(end_str == "сто")          end_str = IIF(type==1, "сотый",          "сотого");          
      elif(end_str == "двести")       end_str = IIF(type==1, "двухсотый",      "двухсотого");      
      elif(end_str == "триста")       end_str = IIF(type==1, "трехсотый",      "трехсотого");      
      elif(end_str == "четыреста")    end_str = IIF(type==1, "четырехсотый",   "четырехсотого");   
      elif(end_str == "пятьсот")      end_str = IIF(type==1, "пятисотый",      "пятисотого");      
      elif(end_str == "шестьсот")     end_str = IIF(type==1, "шестисотый",     "шестисотого");     
      elif(end_str == "семьсот")      end_str = IIF(type==1, "семисотый",      "семисотого");      
      elif(end_str == "восемьсот")    end_str = IIF(type==1, "восьмисотый",    "восьмисотого");    
      elif(end_str == "девятьсот")    end_str = IIF(type==1, "девятисотый",    "девятисотого");    
      end;
    end;

    if(result_str == "")
      result_str = end_str;
    else
      result_str = result_str + " " + end_str;
    end;
  end;

  return result_str;
end;

//Точка входа
macro CreateRepOwnMsg(buff)
  record rec_ownmsg("scownmsg");
  var ownmsg = TRecHandler("scownmsg");
  var templ = TBFile("dlgrtemp.dbt");
  var fiw = TBFile("fiwarnts.dbt");
  var pt = TBFile("party.dbt");
  var avrserv = TBFile("avrserv.dbt");
  var fin = TRecHandler("fininstr.dbt");
  var avr = TRecHandler("avoiriss.dbt");
  var address_fact = TRecHandler("adress.dbt");
  var biofrval = TRecHandler("biofrval.dbt");
  var RepPath = "", RealFileName = "";
  var OurBankName = "", INN = "", KPP = "";
  var NoteDescr = "", NoteTerm = "", NotePaymentForm = "", NoteRegOrg = "", NotePaymAgent = "";
  var ListDate = date(0,0,0);
  var Nominal = $0, НКД = $0, PlacedAmount = 0, RedemptionAmount = 0, Amount2 = 0, Amount25 = 0, Amount42 = 0, Amount44 = 0, RepaymentAmount = 0;
  var НомерКупИмПадеж = "", НомерКупРодПадеж = "";
  var FileMainName = "";
  var PaymType     = "";
  var err = 0, val = "";
  var query, cmd, DataSet;

  SetBuff(rec_ownmsg, buff);
  copy(ownmsg, rec_ownmsg);
  if((not err) and (ownmsg.rec.TemplNum > 0))
    templ.Clear();
    templ.rec.DocLog = LLCLASS_KINDDOC_AVOIRISS;
    templ.rec.Num    = ownmsg.rec.TemplNum;
    if(not templ.GetEQ())
      err = 1;
      msgbox("Шаблон не найден");
    end;
  end;

  if(not err)
    if(ПолучитьФинИн(ownmsg.rec.FIID, fin, avr) != 0)
      err = 1;
      msgbox("Не найдена ц/б с идентификатором " + ownmsg.rec.FIID);
    end;

    if(not err)
      ListDate = avr.rec.ListDate;

      if(ownmsg.rec.Number_Coupon != "")
        fiw.Clear();
        fiw.rec.FIID      = ownmsg.rec.FIID;
        fiw.rec.IsPartial = UNSET_CHAR;
        fiw.rec.Number    = ownmsg.rec.Number_Coupon;

        if(fiw.GetEQ())
          ListDate = fiw.rec.ListDate;
        else
          err = 1;
          msgbox("Не найден купон с номером " + ownmsg.rec.Number_Coupon);
        end;
      end;
    end;

    if(not err)
      if( not FI_GetCurrentNominal(ownmsg.rec.FIID, ListDate, Nominal) )
        err = 1;
        msgbox( "Не могу получить номинал фин. инструмента с идентификатором "+ ownmsg.rec.FIID  );
      end;
    end;

    if(not err)
      avrserv.Clear();

      avrserv.rec.FIID = ownmsg.rec.FIID;
      if(not avrserv.GetEQ())
        err = 1;
        msgbox( "Не найдена информация об обслуживании выпуска" );
      end;
    end;
  end;

  if(not err)
    pt.Clear();
    pt.rec.PartyID = {OurBank};
    if(not pt.GetEQ())
      err = 1;
      msgbox("Не найден субъект с идентификатором " + {OurBank});
    end;
  end;

  if(not err)
    biofrval.Clear();

    query =   " select * "
            + "   from dbiofrval_dbt "
            + "  where t_FIID = ? "
            + "    and t_Date <= ? "
            + "  order by t_Date DESC ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(fin.rec.FIID);
    cmd.AddParam(fin.rec.DrawingDate);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo(biofrval.rec);
    end;
  end;

  if(not err)
    SplitFullINN(ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, KPP);

    var NoteDocumentID = L_Z(ownmsg.rec.FIID, 10);

    NoteDescr       = readNoteForObject(OBJTYPE_AVOIRISS, NoteDocumentID, NOTEKIND_AVOIR_BONDIDENTSIGNS);
    NoteTerm        = readNoteForObject(OBJTYPE_AVOIRISS, NoteDocumentID, NOTEKIND_AVOIR_BONDTERMDESCRIPTION);
    NotePaymentForm = readNoteForObject(OBJTYPE_AVOIRISS, NoteDocumentID, NOTEKIND_AVOIR_BONDFORMPAYMENT);
    if (NotePaymentForm == "") // значение по умолчанию для способа выплаты доходов
      NotePaymentForm = "в безналичном порядке денежными средствами в валюте Российской Федерации";
    end;
    NoteRegOrg      = readNoteForObject(OBJTYPE_AVOIRISS, NoteDocumentID, NOTEKIND_AVOIR_REGISTRATIONORG);
    NotePaymAgent   = readNoteForObject(OBJTYPE_AVOIRISS, NoteDocumentID, NOTEKIND_AVOIR_PAYMENTAGENT);

    if(ownmsg.rec.Number_Coupon != "")
      НКД = СуммаКупона(ownmsg.rec.FIID, 1, fiw.rec.DrawingDate);
      НомерКупИмПадеж  = ПолучитьНомерКупонаВПадеже(ownmsg.rec.Number_Coupon, 1);
      НомерКупРодПадеж = ПолучитьНомерКупонаВПадеже(ownmsg.rec.Number_Coupon, 0);
    end;

    PlacedAmount    = GetPlacedAmountOnDate(ownmsg.rec.FIID, ListDate);
    RepaymentAmount = GetRepaymentAmount(ownmsg.rec.FIID, ownmsg.rec.Number_Coupon);

    if (ownmsg.rec.Event == SC_OWNMSG_EVENT_RETISSUE)
      PaymType = "Погашение облигаций";
      Amount42 = PlacedAmount    * НКД + PlacedAmount    * Nominal;
      Amount44 = RepaymentAmount * НКД + RepaymentAmount * Nominal + RepaymentAmount * biofrval.rec.OneItemFv;
    elif (ownmsg.rec.Event == SC_OWNMSG_EVENT_RETCOUPON)
      PaymType = "Выплата процентного (купонного) дохода по облигациям за период";
      Amount42 = PlacedAmount    * НКД;
      Amount44 = RepaymentAmount * НКД;
    elif (ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
      PaymType = "Выплата процентного (дополнительного) дохода по облигациям за период";
      Amount42 = PlacedAmount    * biofrval.rec.OneItemFv; 
      Amount44 = RepaymentAmount * biofrval.rec.OneItemFv;
    else
      Amount42 = NULL;
      Amount44 = NULL;
    end;

    if(ownmsg.rec.TemplNum > 0)
      FileMainName = templ.rec.ShortName;
      
      println(templ.rec.File_Name);
      println("ownmsgrep.docx");

      if((ownmsg.rec.TemplNum == 1) or (ownmsg.rec.TemplNum == 2))
        
        //////////////////////
        //Общая часть
        //////////////////////
        [~DocNumb4];
        PrintParam(ownmsg.rec.ExtNum);

        [~PrepDate4];
        PrintParam(string(ownmsg.rec.PrepareDate:f));

        [~IssuerFullName4];
        PrintParam(pt.rec.Name);

        [~INN4];
        PrintParam(INN);

        // @NOTE: В первой очереди реализации значения этого параметров хранятся в шаблоне:
        //        ТЗ: http://uran/svn/analytic_v6/main/securities/bank%20securities/документы_раскрытие%20информации%20эмитентом.docx
        [~ExecSM];
        PrintParam();

        [~FormNumb4];
        PrintParam(IIF(ownmsg.rec.TemplNum == 1, "14.2", "14.4"));
      
        //////////////////////
        //14.2
        //////////////////////
        [~PrepDate42];
        PrintParam(string(ownmsg.rec.PrepareDate:f));
        
        [~NoteDescr42];
        PrintParam(string(NoteDescr));

        [~Note_Term42];
        PrintParam(string(NoteTerm));

        [~Ser42];
        PrintParam(string(avr.rec.Series));

        [~StateRegNumb42];
        PrintParam(string(avr.rec.LSIN));

        [~RegistrationOrg42];
        PrintParam(NoteRegOrg);

        [~Nominal42];
        PrintParam(Nominal);

        [~NominalCurr42];
        PrintParam(ПолучитьНаименованиеВалюты(Nominal, fin.rec.FaceValueFI));

        [~NumberOfBonds42];
        PrintParam(PlacedAmount);

        [~PaymType42];
        PrintParam(PaymType);

        [~IncDate42];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(string(avr.rec.BegPlacementDate:f)+"-"+string(fin.rec.DrawingDate:f));
        else
          if(ownmsg.rec.Number_Coupon != "")
            PrintParam(string(fiw.rec.FirstDate:f)+"-"+string(fiw.rec.DrawingDate:f));
          else
            PrintParam(NULL);
          end;
        end;

        [~Amount42];
        PrintParam(Amount42);

        [~AmountCurr42];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(ПолучитьНаименованиеВалюты(Amount42, biofrval.rec.Currency));
        else
          PrintParam(ПолучитьНаименованиеВалюты(Amount42, fin.rec.FaceValueFI));
        end;

        [~AmountType421];
        if(ownmsg.rec.Number_Coupon != "")
          PrintParam("Сумма купона");
        else
          PrintParam(NULL);
        end;

        [~CoupAmount42];
        if(ownmsg.rec.Number_Coupon != "")
          PrintParam(НКД);
        else
          PrintParam(NULL);
        end;
        
        [~CoupAmountCurr42];
        if(ownmsg.rec.Number_Coupon != "")
          PrintParam(ПолучитьНаименованиеВалюты(НКД, fiw.rec.IncomeFI));
        else
          PrintParam(NULL);
        end;

        [~AmountType422];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_RETISSUE)
          PrintParam("Сумма номинальной стоимости");
        else
          PrintParam(NULL);
        end;

        [~NominalAmount42];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_RETISSUE)
          PrintParam(Nominal);
        elif((ownmsg.rec.Event == SC_OWNMSG_EVENT_RETCOUPON) or (ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME))
          PrintParam(NULL);
        else
          PrintParam("");
        end;

        [~NominalAmountCurr42];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_RETISSUE)
          PrintParam(ПолучитьНаименованиеВалюты(Nominal, fin.rec.FaceValueFI));
        elif((ownmsg.rec.Event == SC_OWNMSG_EVENT_RETCOUPON) or (ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME))
          PrintParam(NULL);
        else
          PrintParam("");
        end;
      
        [~AmountType423];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam("Сумма дополнительного дохода");
        else
          PrintParam(NULL);
        end;

        [~DdAmount42];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(biofrval.rec.OneItemFv);
        else
          PrintParam(NULL);
        end;

        [~DdAmountCurr42];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(ПолучитьНаименованиеВалюты(biofrval.rec.OneItemFv, biofrval.rec.Currency));
        else
          PrintParam(NULL);
        end;
      
        [~ListDate42];
        PrintParam(string(ListDate:f));

        [~PaymentDate42];
        PrintParam(string(ownmsg.rec.PayDate:f));

        [~PaymentAgent42];
        PrintParam(NotePaymAgent);

        //////////////////////
        //14.4
        //////////////////////
        if(ownmsg.rec.TemplNum < 2)
          SetUseNULLParams(true);
        end;

          [~PrepDate44];
          PrintParam(string(ownmsg.rec.PrepareDate:f));
          
          [~NoteDescr44];
          PrintParam(string(NoteDescr));

          [~Note_Term44];
          PrintParam(string(NoteTerm));

          [~Ser44];
          PrintParam(string(avr.rec.Series));

          [~StateRegNumb44];
          PrintParam(string(avr.rec.LSIN));

          [~Nominal44];
          PrintParam(Nominal);

          [~NominalCurr44];
          PrintParam(ПолучитьНаименованиеВалюты(Nominal, fin.rec.FaceValueFI));

          [~NumberOfBonds44];
          PrintParam(string(RepaymentAmount)+" шт.");

          [~PaymType44];
          PrintParam(PaymType);

          [~IncDate44];
          if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
            PrintParam(string(avr.rec.BegPlacementDate:f)+"-"+string(fin.rec.DrawingDate:f));
          else
            if(ownmsg.rec.Number_Coupon != "")
              PrintParam(string(fiw.rec.FirstDate:f)+"-"+string(fiw.rec.DrawingDate:f));
            else
              PrintParam(NULL);
            end;
          end;

          [~Amount44];
          PrintParam(Amount44);

          [~AmountCurr44];
          if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
            PrintParam(ПолучитьНаименованиеВалюты(Amount44, biofrval.rec.Currency)+".");
          else
            PrintParam(ПолучитьНаименованиеВалюты(Amount44, fin.rec.FaceValueFI)+".");
          end;

          [~AmountType441];
          if(ownmsg.rec.Number_Coupon != "")
            PrintParam("Сумма купона");
          else
            PrintParam(NULL);
          end;

          [~CoupAmount44];
          if(ownmsg.rec.Number_Coupon != "")
            PrintParam(НКД);
          else
            PrintParam(NULL);
          end;
          
          [~CoupAmountCurr44];
          if(ownmsg.rec.Number_Coupon != "")
            PrintParam(ПолучитьНаименованиеВалюты(НКД, fiw.rec.IncomeFI));
          else
            PrintParam(NULL);
          end;

          [~AmountType442];
          if(ownmsg.rec.Event == SC_OWNMSG_EVENT_RETISSUE)
            PrintParam("Сумма номинальной стоимости");
          else
            PrintParam(NULL);
          end;

          [~NominalAmount44];
          if(ownmsg.rec.Event == SC_OWNMSG_EVENT_RETISSUE)
            PrintParam(Nominal);
        elif((ownmsg.rec.Event == SC_OWNMSG_EVENT_RETCOUPON) or (ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME))
            PrintParam(NULL);
          else
            PrintParam("");
          end;

          [~NominalAmountCurr44];
          if(ownmsg.rec.Event == SC_OWNMSG_EVENT_RETISSUE)
            PrintParam(ПолучитьНаименованиеВалюты(Nominal, fin.rec.FaceValueFI));
        elif((ownmsg.rec.Event == SC_OWNMSG_EVENT_RETCOUPON) or (ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME))
            PrintParam(NULL);
          else
            PrintParam("");
          end;
        
        [~AmountType443];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam("Сумма дополнительного дохода");
        else
          PrintParam(NULL);
        end;

        [~DdAmount44];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(biofrval.rec.OneItemFv);
        else
          PrintParam(NULL);
        end;

        [~DdAmountCurr44];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(ПолучитьНаименованиеВалюты(biofrval.rec.OneItemFv, biofrval.rec.Currency));
        else
          PrintParam(NULL);
        end;
      
        SetUseNULLParams(false);

      elif(ownmsg.rec.TemplNum == 4) //Сведения о дате составления списка владельцев облигаций
        [~IssuerFullName];
//      PrintParam(pt.rec.Name);
        PrintParam(Bank_Full_Name_const);

        [~IssuerShortName];
//      PrintParam(pt.rec.ShortName);
        PrintParam(Bank_short_Name_const);

        НайтиАдресСубъекта({OurBank}, PTADDR_REAL, address_fact);
        [~IssuerAddr];
        PrintParam(address_fact.rec.Adress);

        [~INN];
        PrintParam(INN);

        [~OGRN];
        PrintParam(ПолучитьКодСубъекта({OurBank}, PTCK_OGRN));

        [~IssuerCode];
        PrintParam(ПолучитьКодСубъекта({OurBank}, PTCK_ISSUER));
        [~ListDate];
        PrintParam(string(ListDate:f)); 
        /*[~ListDate];
        if(fin.rec.issued < NotPayAgentDate)
          PrintParam(string(GetDateAfterWorkDays(fiw.rec.drawingdate,DateFix):f));
        else
          PrintParam(string("На начало операционного дня ", fiw.rec.drawingdate):f);
        end;*/

        [~NoteDescr];
        PrintParam(RemoveLastComma(NoteDescr));

        [~Note_Term];
        PrintParam(RemoveLastComma(NoteTerm));

        [~Ser];
        PrintParam(avr.rec.Series);

        [~Ser1];
        PrintParam(avr.rec.Series);
        
        [~TypeRegNum];

        if(isMarketBond(avr.rec.fiid))
          PrintParam("Идентификационный номер выпуска ценных бумаг эмитента: ");
        else
          PrintParam("Государственный регистрационный номер выпуска ценных бумаг эмитента: ");
        end;  

        [~StateRegNum];
        PrintParam(avr.rec.LSIN);

        [~TypeDateReg];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Дата его присвоения: ");
        else
          PrintParam("Дата государственной регистрации: ");
        end;

        [~IssueParty];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Публичное акционерное общество \"Московская Биржа ММВБ-РТС\". ");
        else
          PrintParam(" Центральный банк Российской Федерации.");
        end;

        [~IssueRegDate];
        PrintParam(string(avr.rec.RegDate:f));

        [~ISIN];
        PrintParam(avr.rec.ISIN);

        [~IncomeText];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam("получение дополнительного дохода по Облигациям серии "+avr.rec.Series+" при  погашении в  срок - "+string(ownmsg.rec.DrawingDate:f));
        else
          PrintParam("получение купонного дохода по Облигациям серии "+avr.rec.Series+" по окончании "+ownmsg.rec.Number_Coupon+" ("+НомерКупРодПадеж+") купонного периода - "+string(ownmsg.rec.DrawingDate:f));
        end;

        [~ListDate12];
        PrintParam(string(ListDate:f));

        [~AuthPos];
     //   PrintParam(ownmsg.rec.PostTitle);
        PrintParam("XXXXX "/*AuthPos_const*/);

        [~IssuerShortName12];
        PrintParam(AuthPos_const +" " + pt.rec.ShortName);
        

        [~AuthName];
        //PrintParam(GetOperRecByID(ownmsg.rec.SignerID).Name);
        PrintParam(AuthName_const);

        [~PA_Date];
        if(ownmsg.rec.ByProxy == SET_CHAR)
          PrintParam("(на основании доверенности от " + string(ownmsg.rec.ProxyDate:f));
        else
          PrintParam(NULL);
        end;

        [~PA_Number];
        if(ownmsg.rec.ByProxy == SET_CHAR)
          PrintParam("№"+ownmsg.rec.ProxyNumber+")");
        else
          PrintParam(NULL);
        end;

        [~PrepDate];
        PrintParam(string(ownmsg.rec.PrepareDate:f));
        /*if(fin.rec.issued < NotPayAgentDate)
          PrintParam(string(GetDateAfterWorkDays(fiw.rec.drawingdate,DateFix):f));
        else
          PrintParam(string("На начало операционного дня ", fiw.rec.drawingdate):f);
        end;*/

      elif(ownmsg.rec.TemplNum == 5) //Сведения о выплаченных доходах по эмиссионным ценным бумагам эмитента

        [~IssuerFullName2];
        //PrintParam(pt.rec.Name);
        PrintParam(Bank_Full_Name_const);

        [~IssuerShortName2];
        //PrintParam(pt.rec.ShortName);
        PrintParam(Bank_short_Name_const);

        НайтиАдресСубъекта({OurBank}, PTADDR_REAL, address_fact);
        [~IssuerAddr2];
        PrintParam(address_fact.rec.Adress);

        [~INN2];
        PrintParam(INN);

        [~OGRN2];
        PrintParam(ПолучитьКодСубъекта({OurBank}, PTCK_OGRN));

        [~IssuerCode2];
        PrintParam(ПолучитьКодСубъекта({OurBank}, PTCK_ISSUER));

        [~EventDate2];
//        PrintParam(string(ownmsg.rec.PayDate:f));
        if(fin.rec.issued < NotPayAgentDate)
          PrintParam(string(GetDateAfterWorkDays(fiw.rec.drawingdate,DateFix):f));
        else
          PrintParam(string(/*"На начало операционного дня ",*/ fiw.rec.drawingdate:f));
        end;

        [~TypeAvr];
        if(isMarketBond(avr.rec.fiid))
          PrintParam(" Биржевые облигации; ");
        else
          PrintParam(" Облигации;");
        end;

        [~AvrSeries];
        PrintParam(avr.rec.Series);        

        [~NoteDescr2];
        PrintParam(RemoveLastComma(NoteDescr));

        [~Note_Term2];
        PrintParam(RemoveLastComma(NoteTerm));

        [~Ser21];
        PrintParam(avr.rec.Series);

        [~TypeAvr2];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Биржевые облигации");
        else
          PrintParam("Облигации");
        end;

        [~Ser22];
        PrintParam(avr.rec.Series);

        [~ISIN2];
        PrintParam(avr.rec.ISIN);
        
        [~TypeRegNum2];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Идентификационный номер выпуска ценных бумаг эмитента: ");
        else
          PrintParam("Государственный регистрационный номер выпуска ценных бумаг эмитента: ");
        end;  

        [~StateRegNum2];
        PrintParam(avr.rec.LSIN);

        [~TypeDateRegNum2];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Дата его присвоения: ");
        else
          PrintParam("Дата государственной регистрации: ");
        end;

        [~IssueRegDate2];
        PrintParam(string(avr.rec.RegDate:f));

/*UPG 62
        [~CoupNumb21];
        PrintParam(ownmsg.rec.Number_Coupon);

        [~CoupNumb_Text21];
        PrintParam(НомерКупИмПадеж);
        [~CoupBegDate];
        if(ownmsg.rec.Number_Coupon != "")
          PrintParam(string((fiw.rec.FirstDate-1):f));
        else
          PrintParam(NULL);
        end;

        [~CoupEndDate];
        if(ownmsg.rec.Number_Coupon != "")
          PrintParam(string(fiw.rec.DrawingDate:f));
        else
          PrintParam(NULL);
        end;
        Amount2 = НКД*avr.rec.Qty;
*/
        [~IncomeText23];                                                     
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam("Для дополнительного дохода: с "+string(avr.rec.BegPlacementDate:f)+" по "+string(fin.rec.DrawingDate:f));
        else
          PrintParam(ownmsg.rec.Number_Coupon+" ("+НомерКупИмПадеж+") купонный период с "+IIF(ownmsg.rec.Number_Coupon != "", string((fiw.rec.FirstDate-1):f), "")+" по "+IIF(ownmsg.rec.Number_Coupon != "", string(fiw.rec.DrawingDate:f), ""));/*UG62 "-1" было в пользовательском макросе*/
        end;

        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          Amount2 = biofrval.rec.OneItemFv*avr.rec.Qty;
        else
          Amount2 = НКД*avr.rec.Qty;
        end;
        [~Amount2];
        PrintParam(StrSubst(string(Amount2:a),"'"," "));

        [~AmountCurr2];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(ПолучитьНаименованиеВалюты(Amount2, biofrval.rec.Currency));
        else
          if(ownmsg.rec.Number_Coupon != "")
            //PrintParam(ПолучитьНаименованиеВалюты(Amount2, fiw.rec.IncomeFI));
            //fin.rec.facevaluefi
            PrintParam(ПолучитьНаименованиеВалюты(Amount2, fin.rec.facevaluefi));
          else
            PrintParam(NULL);
          end;
        end;

        [~AmountText2];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(CurToStrAlt(Amount2, null, null, biofrval.rec.Currency));
        else
          if(ownmsg.rec.Number_Coupon != "")
            //PrintParam(CurToStrAlt(Amount2, null, null, DL_GetISOCode(fiw.rec.IncomeFI)));
            PrintParam(CurToStrAlt(Amount2, null, null, DL_GetISOCode(fin.rec.facevaluefi)));
          else
            PrintParam(NULL);
          end;
        end;

        [~TypeAvr3];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Биржевым облигациям");
        else
          PrintParam("Облигацииям");
        end;


        [~Ser23];
        PrintParam(avr.rec.Series);

        [~IncomeText24_1];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam("период с "+string(avr.rec.BegPlacementDate:f)+" по "+string(fin.rec.DrawingDate:f));
        else
          PrintParam(ownmsg.rec.Number_Coupon+" ("+НомерКупИмПадеж+") купонный период");
        end;

        [~IncAmount2];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(biofrval.rec.OneItemFv);
        else
          if(ownmsg.rec.Number_Coupon != "")
            PrintParam(StrSubst(string(НКД:a),"'"," "));
          else
            PrintParam(NULL);
          end;
        end;
        
        [~IncAmountCurr2];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(ПолучитьНаименованиеВалюты(biofrval.rec.OneItemFv, biofrval.rec.Currency));
        else
        if(ownmsg.rec.Number_Coupon != "")
          //PrintParam(ПолучитьНаименованиеВалюты(НКД, fiw.rec.IncomeFI));
          PrintParam(ПолучитьНаименованиеВалюты(НКД, fin.rec.facevaluefi));
        else
          PrintParam(NULL);
        end;
        end;

        [~IncAmount_Text2];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(CurToStrAlt(biofrval.rec.OneItemFv, null, null, DL_GetISOCode(biofrval.rec.Currency)));
        else
          if(ownmsg.rec.Number_Coupon != "")
            //PrintParam(CurToStrAlt(НКД, null, null, DL_GetISOCode(fiw.rec.IncomeFI)));
            PrintParam(CurToStrAlt(НКД, null, null, DL_GetISOCode(fin.rec.facevaluefi)));
          else
            PrintParam(NULL);
          end;
        end;

        [~TypeAvr4];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Биржевой облигации");
        else
          PrintParam("Облигации");
        end;


        [~Ser24];
        PrintParam(avr.rec.Series);

        [~IncomeText24_2];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam("период с "+string(avr.rec.BegPlacementDate:f)+" по "+string(fin.rec.DrawingDate:f));
        else
          PrintParam(ownmsg.rec.Number_Coupon+" ("+НомерКупИмПадеж+") купонный период");
        end;

        RedemptionAmount = GetRedemptionAmountOnDate(ownmsg.rec.FIID, ListDate);
        [~Extension];
        if(RedemptionAmount > 0)
          var ExtentionStr =   "Общее количество облигаций серии "+avr.rec.Series+", по которым производится выплата - " + GetAmountOnDate(ownmsg.rec.FIID, ListDate,1,0)/*avr.rec.Qty*/ + " штук.\n"
                             + "В соответствии с Решением о выпуске ценных бумаг и проспектом ценных бумаг Эмитентом были выкуплены Облигации серии "+avr.rec.Series+" в количестве "+RedemptionAmount+" штук. Доход по выкупленным облигациям серии "+avr.rec.Series+" не начисляется и не выплачивается";
          PrintParam(ExtentionStr);
        else
          PrintParam(NULL);
        end;

        [~NumberOfBonds];
        PrintParam(StrSubst(string(GetAmountOnDate(ownmsg.rec.FIID, ListDate,1,0):a),"'"," "));

        [~NumberOfBonds_Text];
        PrintParam(NumToStr(avr.rec.Qty));

        [~PaymentForm];
        PrintParam(NotePaymentForm);

        [~ListDate22];
     //   PrintParam(string(ListDate:f));
        if(fin.rec.issued < NotPayAgentDate)
          PrintParam(string(GetDateAfterWorkDays(fiw.rec.drawingdate,DateFix):f));
        else
          PrintParam(string("На начало операционного дня ", fiw.rec.drawingdate):f);
        end;


        [~PaymDate2];
        PrintParam(string(ownmsg.rec.DrawingDate:f));

        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          Amount25 = RepaymentAmount*biofrval.rec.OneItemFv;
        else
          Amount25 = RepaymentAmount*НКД;
        end;
        [~Amount25];
        PrintParam(StrSubst(string(Amount25:a),"'"," "));

        [~AmountCurr25];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(ПолучитьНаименованиеВалюты(Amount25, biofrval.rec.Currency));
        else
          if(ownmsg.rec.Number_Coupon != "")
            //PrintParam(ПолучитьНаименованиеВалюты(Amount25, fiw.rec.IncomeFI));
            PrintParam(ПолучитьНаименованиеВалюты(Amount25, fin.rec.facevaluefi));
          else
            PrintParam(NULL);
          end;
        end;

        [~Amount_Text25];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam(CurToStrAlt(Amount25, null, null, DL_GetISOCode(biofrval.rec.Currency)));
        else
          if(ownmsg.rec.Number_Coupon != "")
           //PrintParam(CurToStrAlt(Amount25, null, null, DL_GetISOCode(fiw.rec.IncomeFI)));
            PrintParam(CurToStrAlt(Amount25, null, null, DL_GetISOCode(fin.rec.facevaluefi)));
          else
            PrintParam(NULL);
          end;
        end;

        [~TypeAvr5];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Биржевым облигациям");
        else
          PrintParam("Облигациям");
        end;

        [~Ser25];
        PrintParam(avr.rec.Series);

        [~IncomeText29];
        if(ownmsg.rec.Event == SC_OWNMSG_EVENT_ADDINCOME)
          PrintParam("период с "+string(avr.rec.BegPlacementDate:f)+" по "+string(fin.rec.DrawingDate:f));
        else
          PrintParam(ownmsg.rec.Number_Coupon+" ("+НомерКупИмПадеж+") купонный период");
        end;

        [~AuthPos2];
//      PrintParam(ownmsg.rec.PostTitle);
        PrintParam(AuthPos_const);

        [~IssuerShortName22];
        PrintParam(pt.rec.ShortName);

        [~AuthName2];
        //PrintParam(GetOperRecByID(ownmsg.rec.SignerID).Name);
        PrintParam(AuthName_const);

        [~PA_Date2];
        if(ownmsg.rec.ByProxy == SET_CHAR)
          PrintParam("(на основании доверенности от " + string(ownmsg.rec.ProxyDate:f));
        else
          PrintParam(NULL);
        end;

        [~PA_Number2];
        if(ownmsg.rec.ByProxy == SET_CHAR)
          PrintParam("№"+ownmsg.rec.ProxyNumber+")");
        else
          PrintParam(NULL);
        end;

        [~PrepDate22];
      //  PrintParam(string(ownmsg.rec.PrepareDate:f));
        if(fin.rec.issued < NotPayAgentDate)
          PrintParam(string(GetDateAfterWorkDays(fiw.rec.drawingdate,DateFix):f));
        else
          PrintParam(string(/*"На начало операционного дня ",*/ fiw.rec.drawingdate:f));
        end;

      elif(ownmsg.rec.TemplNum == 6) //Сведения о погашении облигаций и иных эмиссионных ценных бумаг эмитента

        [~IssuerFullName3];
        PrintParam(pt.rec.Name);

        [~IssuerShortName3];
        PrintParam(pt.rec.ShortName);

        НайтиАдресСубъекта({OurBank}, PTADDR_REAL, address_fact);
        [~IssuerAddr3];
        PrintParam(address_fact.rec.Adress);

        [~INN3];
        PrintParam(INN);

        [~OGRN3];
        PrintParam(ПолучитьКодСубъекта({OurBank}, PTCK_OGRN));

        [~IssuerCode3];
        PrintParam(ПолучитьКодСубъекта({OurBank}, PTCK_ISSUER));

        [~EventDate3];
        PrintParam(string(ownmsg.rec.PayDate:f));

        [~NoteDescr3];
        PrintParam(RemoveLastComma(NoteDescr));

        [~Note_Term3];
        PrintParam(RemoveLastComma(NoteTerm));

        [~Ser31];
        PrintParam(avr.rec.Series);

        [~Ser32];
        PrintParam(avr.rec.Series);

        [~ISIN3];
        PrintParam(avr.rec.ISIN);

        [~TypeRegNum3];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Идентификационный номер выпуска ценных бумаг эмитента: ");
        else
          PrintParam("Государственный регистрационный номер выпуска ценных бумаг эмитента: ");
        end;  

        [~StateRegNum3];
        PrintParam(avr.rec.LSIN);

        [~DateRegNum3];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Дата его присвоения: ");
        else
          PrintParam("Дата государственной регистрации: ");
        end;

        [~IssueRegDate3];
        PrintParam(string(avr.rec.RegDate:f));

        [~Registrator];
        if(isMarketBond(avr.rec.fiid))
          PrintParam("Публичное акционерное общество \"Московская Биржа ММВБ-РТС\". ");
        else
          PrintParam(" Центральный банк Российской Федерации.");
        end;

        [~NumberOfBonds3];
        PrintParam(StrSubst(string(int(avr.rec.Qty):a),"'"," "));

        [~NumberOfBonds_Text3];
        PrintParam(NumToStr(avr.rec.Qty));

        [~Ser33];
        PrintParam(avr.rec.Series);

        [~PrIssueDate];
        PrintParam(string(avrserv.rec.DateShareIssue:f));

        [~PaymDate31];
        PrintParam(string(ownmsg.rec.DrawingDate:f));

        [~AuthPos3];
        PrintParam(ownmsg.rec.PostTitle);

        [~IssuerShortName32];
        PrintParam(pt.rec.ShortName);

        [~AuthName3];
        PrintParam(GetOperRecByID(ownmsg.rec.SignerID).Name);

        [~PA_Date3];
        if(ownmsg.rec.ByProxy == SET_CHAR)
          PrintParam("(на основании доверенности от " + string(ownmsg.rec.ProxyDate:f));
        else
          PrintParam(NULL);
        end;

        [~PA_Number3];
        if(ownmsg.rec.ByProxy == SET_CHAR)
          PrintParam("№"+ownmsg.rec.ProxyNumber+")");
        else
          PrintParam(NULL);
        end;

        [~PrepDate3];
        PrintParam(string(ownmsg.rec.PrepareDate:f));

      end;
    
    elif(ownmsg.rec.Kind == DOCKIND_OWNBOND_PAYINSTR) //Поручение на проведение Выплат по Облигациям
      var day, month, year, month_name;
      var Amount = $0, TotalTax = $0;
      var СуммаНалогаЮЛН = $0, СуммаНалогаФЛН = $0, СуммаНалогаФЛР = $0, СуммаНалогаФЛР15 = $0;
      
      DefaultParamStr = "";
      
      FileMainName = "instrpaymbond";
      
      println("instrpaymbond.dotx");
      println("instrpaymrep.docx");

      [~IssuerFullName];
      PrintParam(pt.rec.Name);

      [~DocNumb];
      PrintParam(ownmsg.rec.ExtNum);
      
      [~PrepDate1];
      PrintParam(string(ownmsg.rec.PrepareDate:f));
      
      [~PrepDate2];
      PrintParam(string(ownmsg.rec.PrepareDate:f));

      [~IssuerShortName1];
      PrintParam(pt.rec.ShortName);

      [~IssuerShortName2];
      PrintParam(pt.rec.ShortName);

      [~Note_Descr];
      PrintParam(NoteDescr);

      [~Note_Term];
      PrintParam(NoteTerm);

      [~Ser1];
      PrintParam(avr.rec.Series);

      [~Ser2];
      PrintParam(avr.rec.Series);
      [~TypeRegNum];
      PrintParam("Идентификационный номер выпуска ценных бумаг эмитента:");

      [~StateRegNum];
      PrintParam(avr.rec.LSIN);

      [~PaymentType];
      PrintParam(DL_GetNameAlg(ALG_OWNINSTR_PAYTYPE, ownmsg.rec.Event ));


      DateSplit(ownmsg.rec.PayDate, day, month, year);
      month_name = trim(string(ownmsg.rec.PayDate:m));
      month_name = trim(substr(month_name, Index(month_name, " ")));
      month_name = trim(substr(month_name, 1, Index(month_name, " ")));

      [~PaymentDate];
      PrintParam(string(day + " " + month_name));

      [~Year];
      PrintParam(year);

      [~Rate];
      if(ownmsg.rec.Number_Coupon != "")
        PrintParam(fiwarnts_GetIncomePercent(fiw.rec, Nominal));
      else
        PrintParam(NULL);
      end;

      [~NumberOfBonds];
      PrintParam(ЧислоCЗаданнойТочностью(PlacedAmount, IIF(IsHaveFractPart(PlacedAmount) == true, fin.rec.SumPrecision, 0)));

      if(ownmsg.rec.Number_Coupon != "")
        Amount = НКД;
      else
        Amount = Nominal;
      end; 
      [~Amount];
      PrintParam(money(Amount));

      if(ownmsg.rec.Number_Coupon != "")
        ОЭБ_ВычислитьВыплатыПоПогашению(ownmsg.rec.FIID, ownmsg.rec.Number_Coupon, ListDate, NATCUR, @СуммаНалогаЮЛН, @СуммаНалогаФЛН, @СуммаНалогаФЛР, false, @СуммаНалогаФЛР15);
        TotalTax = СуммаНалогаЮЛН+СуммаНалогаФЛН+СуммаНалогаФЛР+СуммаНалогаФЛР15;
      end;
      [~TotalAmount];
      PrintParam(money(Amount*PlacedAmount - TotalTax));
      
      [~TotalTax];
      if(ownmsg.rec.Number_Coupon != "")
        PrintParam(TotalTax);
      else
        PrintParam(NULL);
      end;

      [~ForeignLE_Taxes];
      if(ownmsg.rec.Number_Coupon != "")
        PrintParam(GetForeignLE_Name(ownmsg.rec.FIID, ownmsg.rec.Number_Coupon));
      else
        PrintParam(NULL);
      end;

      [~ListNumb];
      PrintParam(GetOwnListNumStr(ownmsg.rec.FIID, ownmsg.rec.Number_Coupon));

      [~ListDate];
      PrintParam(string(ListDate:f));

    end;

  end;

  if(not err)
    DLWREPS_PrintReportFromTagFile(SetOutput(CreateFileName), @RealFileName, false, true);
    
    RepPath = SC_GetFullPath(false) + FileMainName+"_"+StrSubst(StrSubst(ownmsg.rec.ExtNum, "/", "_"), "-", "_")+".docx";
  
    if(IsStandAlone) /*Двухзвенка*/
      if(not CopyFile(RealFileName, RepPath))
        err = 1;
        msgbox("Ошибка при копировании файла|" + RealFileName + "|в |" + RepPath);
      end;
    else /*Трехзвенка*/
      if(not CopyFile("$" + RealFileName, RepPath))
        err = 1;
        msgbox("Ошибка при копировании файла|" + RealFileName + "|в |" + RepPath);
      end;
    end;
    
    SetOutput(NULL, false);
  end;

  return RepPath;
end;