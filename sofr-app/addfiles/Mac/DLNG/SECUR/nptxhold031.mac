/*
$Name:        nptxhold031.mac
$Module:      Ценные бумаги
$Description: Операция удержания НДФЛ. Шаг "Формирование записи в хранилище"
*/

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac", "nptxreqfun.mac";

private macro Error( err, ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  if(err)
    MsgBox( ErrStr );
  end;
  return err;
end;

private macro isUseCorrForAddKBK(NpTxOpID)
  var query =   " select msg.t_Message "
              + "   from dnptxmes_dbt msg"
              + "  where msg.t_DocID = ? "
              + "    and msg.t_Type in (205) "
              + "    and msg.t_Message = 'X' "
              + " order by msg.t_ID ASC";

  var cmd = DL_RSDCommand(query);
  cmd.AddParam(NpTxOpID);
  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    return true;
  end;
  
  return false;
end;

private macro GetSumNOB(arr)
  var i = 0;
  var sum = $0;

  while(i < arr.size)
    sum = sum + arr[i].НОБ;
    i = i + 1;
  end;
  return sum;
end;

macro ExecuteStep( kind_oper, FDoc, DocumentKind, ID_Operation, ID_Step )
  record nptxop("nptxop");
  var ErrStr = "";
  var Year = 0;
  var err = 0;
  var TxArr = TArray();
  var CorrTxArr = TArray();
  var HoldTxArr = TArray();
  var НОБ_опер = $0;
  var EndDate = date(0,0,0);
  var HoldEndYearNpTxOpID = 0;
  var HoldEndYearNpTxOp = TBFile("nptxop.dbt");
  var taxe = $0, taxe15 = $0;
  var DocKind = 0;
  var DocID   = 0;
  var TaxBaseKind = NULL;
  var K = 1;
  var i = 0;

  SetBuff( nptxop, FDoc );

  DocKind = nptxop.DocKind;
  DocID   = nptxop.ID;
  
  DateSplit(nptxop.OperDate, null, null, Year);

  var TaxTeriodToLucre = CheckTaxTeriodToLucre(Year);

  if(nptxop.SubKind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY)
    
    if(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT)
      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT*100),
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_13), 
                                          $0);

      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_15), 
                                          $0);
    else
      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_NOTRESIDENT*100),
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_30), 
                                          $0);
    end;

    GetLastOpSTBVal(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_Oper, @НОБ_опер);

    STB_GetTxArrFromMsg(nptxop.ID, @CorrTxArr);
    
    if(isUseCorrForAddKBK(nptxop.ID) and (CorrTxArr.size))
      НОБ_опер = НОБ_опер + GetSumNOB(CorrTxArr);
      var iCorr = 0;
      while(iCorr < CorrTxArr.size)
        TxArr[TxArr.size] = STB_TaxRateParm(CorrTxArr[iCorr].Ставка,
                                            CorrTxArr[iCorr].НОБ, 
                                            CorrTxArr[iCorr].Налог,
                                            CorrTxArr[iCorr].КБК,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            "C");
        iCorr = iCorr + 1;
      end;
      CorrTxArr.size = 0;
    end;

    err = STB_ExecuteCreateSTBOnStep(TxArr,
                                     НОБ_опер, 
                                     nptxop.DocKind, 
                                     nptxop.ID, 
                                     nptxop.Client, 
                                     nptxop.OperDate, 
                                     IIF(nptxop.IIS == SET_CHAR, true, false), 
                                     Year, 
                                     ID_Operation, 
                                     ID_Step, 
                                     @ErrStr,
                                     NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
                                     IIF(nptxop.IIS == SET_CHAR, "Закрытие договора ИИС", "Вывод денежных средств"),
                                     1 /*Выплата дохода*/
                                    );

    if(ErrStr)
      err = Error(err, ErrStr);
    end;

    if(not err)

      if(CorrTxArr.size)
        err = STB_ExecuteCreateSTBOnStep(CorrTxArr,
                                         $0, 
                                         nptxop.DocKind, 
                                         nptxop.ID, 
                                         nptxop.Client, 
                                         nptxop.OperDate, 
                                         IIF(nptxop.IIS == SET_CHAR, true, false), 
                                         Year, 
                                         ID_Operation, 
                                         ID_Step, 
                                         @ErrStr,
                                         NULL,
                                         NULL,
                                         $0);
        if(ErrStr)
          err = Error(err, ErrStr);
        end;
      end;
    end;
  elif((nptxop.SubKind_Operation == DL_TXHOLD_OPTYPE_LUCRE) and (TaxTeriodToLucre == true))
    
    STB_GetHoldArrFromMsg(nptxop.ID, @HoldTxArr);

    TxArr.size = 0;
    i = 0;
    
    while( i < HoldTxArr.size)
      if(HoldTxArr[i].Symbol != "Д") // на шаге nptxhold020.mac в поле Symbol записывается признак ДЕПО/СОФР
        TxArr[TxArr.size] = STB_TaxRateParm(HoldTxArr[i].Ставка, 
                                            $0, 
                                            HoldTxArr[i].Налог, 
                                            HoldTxArr[i].КБК, 
                                            HoldTxArr[i].ВидНБ,
                                            NULL,
                                            NULL,
                                            NULL,
                                            $0,
                                            NULL,
                                            "H",
                                            HoldTxArr[i].SpecialTag);
      end;
      i = i + 1;
    end;
    
    err = STB_ExecuteCreateSTBOnStep(TxArr,
                                     0, 
                                     nptxop.DocKind, 
                                     nptxop.ID, 
                                     nptxop.Client, 
                                     nptxop.OperDate, 
                                     IIF(nptxop.IIS == SET_CHAR, true, false), 
                                     Year, 
                                     ID_Operation, 
                                     ID_Step, 
                                     @ErrStr,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL
                                    );

    if(ErrStr)
      err = Error(err, ErrStr);
    end;

    if(not err)
      STB_GetTxArrFromMsg(nptxop.ID, @CorrTxArr);

      if(CorrTxArr.size)
        err = STB_ExecuteCreateSTBOnStep(CorrTxArr,
                                         $0, 
                                         nptxop.DocKind, 
                                         nptxop.ID, 
                                         nptxop.Client, 
                                         nptxop.OperDate, 
                                         IIF(nptxop.IIS == SET_CHAR, true, false), 
                                         Year, 
                                         ID_Operation, 
                                         ID_Step, 
                                         @ErrStr,
                                         NULL,
                                         NULL,
                                         $0);
        if(ErrStr)
          err = Error(err, ErrStr);
        end;
      end;
    end;
  end;

  if((not err) and (nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR) and (Year >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981()))
    STB_GetHoldArrFromMsg(nptxop.ID, @HoldTxArr);

    TxArr.size = 0;
    i = 0;
    
    while( i < HoldTxArr.size)
      if(HoldTxArr[i].Symbol != "Д") // на шаге nptxhold020.mac в поле Symbol записывается признак ДЕПО/СОФР
        TxArr[TxArr.size] = STB_TaxRateParm(HoldTxArr[i].Ставка, 
                                            $0, 
                                            HoldTxArr[i].Налог, 
                                            HoldTxArr[i].КБК, 
                                            HoldTxArr[i].ВидНБ,
                                            NULL,
                                            NULL,
                                            NULL,
                                            $0,
                                            NULL,
                                            "H",
                                            HoldTxArr[i].SpecialTag);
      end;
      i = i + 1;
    end;

    if(TxArr.size > 0)
      err = STB_ExecuteCreateSTBOnStep(TxArr,
                                       0, 
                                       nptxop.DocKind, 
                                       nptxop.ID, 
                                       nptxop.Client, 
                                       nptxop.OperDate, 
                                       false, 
                                       Year, 
                                       ID_Operation, 
                                       ID_Step, 
                                       @ErrStr,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       "Удержание НДФЛ"
                                       );
      if(ErrStr)
        err = Error(err, ErrStr);
      end;
    end;
    

    if(not err)
      TxArr.size = 0;
      i = 0;
      while( i < HoldTxArr.size)
        if(HoldTxArr[i].Symbol == "Д") // на шаге nptxhold020.mac в поле Symbol записывается признак ДЕПО/СОФР
          TxArr[TxArr.size] = STB_TaxRateParm(HoldTxArr[i].Ставка, 
                                              $0, 
                                              HoldTxArr[i].Налог, 
                                              HoldTxArr[i].КБК, 
                                              HoldTxArr[i].ВидНБ,
                                              NULL,
                                              NULL,
                                              NULL,
                                              $0,
                                              NULL,
                                              "H",
                                              HoldTxArr[i].SpecialTag);
        end;
        i = i + 1;
      end;
    end;

    if(TxArr.size > 0)
      err = STB_ExecuteCreateSTBOnStep(TxArr,
                                       0, 
                                       nptxop.DocKind, 
                                       nptxop.ID, 
                                       nptxop.Client, 
                                       nptxop.OperDate, 
                                       false, 
                                       Year, 
                                       ID_Operation, 
                                       ID_Step, 
                                       @ErrStr,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       "Диасофт. Удержание НДФЛ"
                                       );
      if(ErrStr)
        err = Error(err, ErrStr);
      end;
    end;
  elif((not err) and ((nptxop.SubKind_Operation != DL_TXHOLD_OPTYPE_LUCRE) or (TaxTeriodToLucre == false)))
    TxArr.size = 0;

    HoldEndYearNpTxOp.Clear();
    
    DateSplit(nptxop.PrevDate, null, null, Year);

    if(nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF)
      ExistsReqByEndYear(nptxop.Client, Year, @HoldEndYearNpTxOpID);
    end;

    if((nptxop.DocKind == DL_HOLDNDFL) and (((nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF) and (HoldEndYearNpTxOpID > 0)) or (nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR))) 
      if(nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF)
        HoldEndYearNpTxOp.rec.ID = HoldEndYearNpTxOpID;
        if(not HoldEndYearNpTxOp.GetEQ())
          return Error("Не найдена операция удержания НДФЛ с идентификатором " + HoldEndYearNpTxOpID);
        end;

        if(HoldEndYearNpTxOp.rec.ID > 0)
          DocKind = HoldEndYearNpTxOp.rec.DocKind; 
          DocID   = HoldEndYearNpTxOp.rec.ID;
        end;
      end;

      taxe   = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0201);
      taxe15 = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0208);

      TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_BROK;
    else
      if(nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF)
        K = -1;
      end;
      
      taxe   = K*STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TAXE);
      taxe15 = K*STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TAXE_15);
    end;

    TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                        0, 
                                        taxe);

    if(taxe15 != 0)
      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                          0, 
                                          taxe15);
    end;

    err = STB_ExecuteCreateSTBOnStep(TxArr,
                                     0, 
                                     nptxop.DocKind, 
                                     nptxop.ID, 
                                     nptxop.Client, 
                                     nptxop.OperDate, 
                                     IIF(nptxop.IIS == SET_CHAR, true, false), 
                                     Year, 
                                     ID_Operation, 
                                     ID_Step, 
                                     @ErrStr,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     TaxBaseKind
                                    );


    if(ErrStr)
      err = Error(err, ErrStr);
    end;

    if(not err)
      TxArr.size = 0;

      taxe   = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0201_IIS);
      taxe15 = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0208_IIS);

      if(taxe != 0)
        TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                            0, 
                                            taxe);
      end;

      if(taxe15 != 0)
        TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                            0, 
                                            taxe15);
      end;

      if(TxArr.size > 0)
        err = STB_ExecuteCreateSTBOnStep(TxArr,
                                         0, 
                                         nptxop.DocKind, 
                                         nptxop.ID, 
                                         nptxop.Client, 
                                         nptxop.OperDate, 
                                         IIF(nptxop.IIS == SET_CHAR, true, false), 
                                         Year, 
                                         ID_Operation, 
                                         ID_Step, 
                                         @ErrStr,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NPTXTOTALBASE_TAXBASEKIND_IIS
                                        );


        if(ErrStr)
          err = Error(err, ErrStr);
        end;
      end;
    end;

    if(not err)
      if((nptxop.DocKind == DL_HOLDNDFL) and ((nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR) or ((nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF) and (HoldEndYearNpTxOp.rec.ID > 0)))) //окончание года или (возврат налога и есть заявление из операции окончания года)
        //Если <TypeOper> = "окончание года" ИЛИ <TypeOper> = "возврат налога" и есть заявление клиента, сформированное в операции с типом "окончание года", 
        //то дополнительно формируем записи по доудержанному/ возвращенному налогу за Депозитарий
        var taxeDEPO201 = $0;
        var taxeDEPO207 = $0;
        var taxeDEPO208 = $0;

        TxArr.size = 0;

        if(HoldEndYearNpTxOp.rec.ID > 0)
          DocKind = HoldEndYearNpTxOp.rec.DocKind; 
          DocID   = HoldEndYearNpTxOp.rec.ID;
        end;

        taxeDEPO201 = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0201);
        taxeDEPO207 = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0207);
        taxeDEPO208 = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0208);

        if(taxeDEPO201 != 0)
          TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                            0, 
                                            taxeDEPO201,
                                            NPTXKBK_MAIN);
        end;
        if(taxeDEPO207 != 0)
          TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                            0, 
                                            taxeDEPO207,
                                            NPTXKBK_PROC);
        end;
        if(taxeDEPO208 != 0)
          TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                              0, 
                                              taxeDEPO208,
                                              NPTXKBK_15);
        end;

        if(TxArr.size > 0)
          err = STB_ExecuteCreateSTBOnStep(TxArr,
                                           0, 
                                           nptxop.DocKind, 
                                           nptxop.ID, 
                                           nptxop.Client, 
                                           nptxop.OperDate, 
                                           false, 
                                           Year, 
                                           ID_Operation, 
                                           ID_Step, 
                                           @ErrStr,
                                           NULL,
                                           NULL,
                                           NULL,
                                           NULL,
                                           NULL,
                                           NULL,
                                           NULL,
                                           NULL,
                                           NPTXTOTALBASE_TAXBASEKIND_BROK,
                                           "Диасофт. "+IIF((nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR), "Удержание НДФЛ", "Возврат НДФЛ")
                                          );


          if(ErrStr)
            err = Error(err, ErrStr);
          end;
        end;

        if(not err)
          TxArr.size = 0;

          if(HoldEndYearNpTxOp.rec.ID > 0)
            taxeDEPO201 = STB_GetSavedNptxval(HoldEndYearNpTxOp.rec.DocKind, HoldEndYearNpTxOp.rec.ID, NPTXVAL_KIND_DEPO_TAXE0201_IIS);
            taxeDEPO207 = STB_GetSavedNptxval(HoldEndYearNpTxOp.rec.DocKind, HoldEndYearNpTxOp.rec.ID, NPTXVAL_KIND_DEPO_TAXE0207_IIS);
            taxeDEPO208 = STB_GetSavedNptxval(HoldEndYearNpTxOp.rec.DocKind, HoldEndYearNpTxOp.rec.ID, NPTXVAL_KIND_DEPO_TAXE0208_IIS);
          else
            taxeDEPO201 = STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_DEPO_TAXE0201_IIS);
            taxeDEPO207 = STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_DEPO_TAXE0207_IIS);
            taxeDEPO208 = STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_DEPO_TAXE0208_IIS);
          end;

          if(taxeDEPO201 != 0)
            TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                              0, 
                                              taxeDEPO201,
                                              NPTXKBK_MAIN);
          end;
          if(taxeDEPO207 != 0)
            TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                              0, 
                                              taxeDEPO207,
                                              NPTXKBK_PROC);
          end;
          if(taxeDEPO208 != 0)
            TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                                0, 
                                                taxeDEPO208,
                                                NPTXKBK_15);
          end;

          if(TxArr.size > 0)
            err = STB_ExecuteCreateSTBOnStep(TxArr,
                                             0, 
                                             nptxop.DocKind, 
                                             nptxop.ID, 
                                             nptxop.Client, 
                                             nptxop.OperDate, 
                                             true,  
                                             Year, 
                                             ID_Operation, 
                                             ID_Step, 
                                             @ErrStr,
                                             NULL,
                                             NULL,
                                             NULL,
                                             NULL,
                                             NULL,
                                             NULL,
                                             NULL,
                                             NULL,
                                             NPTXTOTALBASE_TAXBASEKIND_IIS,
                                             "Диасофт. "+IIF((nptxop.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR), "Удержание НДФЛ", "Возврат НДФЛ")
                                            );


            if(ErrStr)
              err = Error(err, ErrStr);
            end;
          end;
        end;

      end;
    end;
  end;
  
  if(not err)
    if(nptxop.OperDate >= GetStartSTBDate())
      if( not InsertOprStatus(46081, 8)) //Документооборот = Передача записи в хранилище
        return Error( "Ошибка при установке статуса вида \"Документооборот\" операции" );        
      end;
    else
      if( not InsertOprStatus(46081, 6)) //Документооборот = Формирование НДР
        return Error( "Ошибка при установке статуса вида \"Документооборот\" операции" );        
      end;
    end;
  end;

  DL_NPTX_SaveOperLog( nptxop.ID, 31 );

  return err;
end;

