/* 
$Name:        nptxcalc120.mac
$Module:      Ценные бумаги
$Description: Операция расчета НОБ для НДФЛ  для НДФЛ. Шаг закрытия
*/

import PrnFrm;
IMPORT "secinter.mac", "nptxfun.mac", "SpRepFun.mac", "nptxcalc_rep.mac";

PRIVATE VAR Oper = TRecHandler( "nptxop.dbt" );

/*Общие переменные для всех расчетов*/
//private var pBegDate, pEndDate, pClient, Query, QueryCond, pIIS ;
//private var DataSet, S, Rg, Rs, Bg, vIIS, Bm, Bs;

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;


MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR Stat = 0;
  VAR TaxPeriod = 0;

  Oper.SetRecordAddr( FDoc );

  DateSplit(Oper.rec.OperDate, null, null, TaxPeriod);

  var TaxTeriodToLucre = CheckTaxTeriodToLucre(TaxPeriod);

  stat = DL_NPTX_PutMsg( "Закрытие операции", 40 );
  if( not stat )

     if(Oper.rec.Recalc != SET_CHAR)
        stat = DL_SetCalcPeriodDate( NPTXCALC_CALCNDFL, Oper.rec.Client, Oper.rec.OperDate, 1, Oper.rec.IIS, Oper.rec.SubKind_Operation, Oper.rec.Contract);
     end;

     if((not stat) and (Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_LUCRE) and (TaxTeriodToLucre == true))
       stat = CreateAllDueMaterialObjects8(Oper, ID_Step);
       if(not stat)
         stat = DL_NPTX_StartInsertTaxObject(Oper.rec.ID, ID_Step);
       end;
     end;

     DL_NPTX_SaveOperLog( Oper.rec.ID, 120 );

  end;

  return stat;
END;


/* Макрос постобработки */
MACRO PostStep (CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,          /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */


  if (errTrn OR (CommitOrRollback != 1)) 
      /* Произошла ошибка или происходит откат */
      return 0;
  end;

  PrintReport( FDoc, ID_Operation ); 
  
  return 0;

END;
