/*                           
$Name:             sp_carsd.mac
$Module:           Ценные бумаги
$Description:      Выполнение сводных проводок ДЕПО
*/
IMPORT "sp_car.mac", "insdpdr.mac";

/*Настройка в регистре*/
PRIVATE CONST DEPO_TRANSIT_ACCOUNT = "DEPO\\ENROLOPRTRANSACC";
PRIVATE CONST ENROLOPRTRANSBLOCK = "DEPO\\ENROLOPRTRANSBLOCK";

PRIVATE VAR  DepParm = TRecHandler( "dldepset" ); /*Параметры депозитарного учета*/
/*
PRIVATE FILE DocOffTMP( "docoffdp.tmp" ) key 0 write;
PRIVATE FILE DocOffTMPAcc( "docoffdp.tmp" ) key 1 write;
PRIVATE FILE DocOffTMPState( "docoffdp.tmp" ) key 2 write;
PRIVATE FILE DocOffTMPFind( "docoffdp.tmp" ) key 2;
*/
/*Виды сводных депозитарных операций (docoffdp.Kind)*/
PRIVATE CONST DEPO_KIND_SUMMARY    = 0, /*сводная*/
              DEPO_KIND_TRANS_CLNT = 1, /*Транзитная по клиентским*/
              DEPO_KIND_TRANS_OWN  = 2; /*Транзитная по собственным*/

/*Типы сводных депозитарных операций (docoffdp.Type)*/
PRIVATE CONST DEPO_TYPE_IN  = 0, /*Зачисление*/
              DEPO_TYPE_OUT = 1; /*Списание*/
/*
PRIVATE MACRO SayError( RslErrObj )
   MsgBox( RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message);
   return 1;
END;

PRIVATE MACRO ДобавитьДепозитарнуюОперацию( FIID:INTEGER, Account:STRING, 
                                            Kind:INTEGER, Type:INTEGER, 
                                            Summa:MONEY, Deponent:INTEGER,
                                            State:INTEGER, Blocked:INTEGER, 
                                            DocOffID:INTEGER )
   ClearRecord( DocOffTMPAcc );
   DocOffTMPAcc.FIID     = FIID;
   DocOffTMPAcc.Account  = Account;
   DocOffTMPAcc.Kind     = Kind;
   DocOffTMPAcc.Type     = Type;
   DocOffTMPAcc.Deponent = Deponent;
   DocOffTMPAcc.State    = State;
   DocOffTMPAcc.Blocked  = Blocked;
   DocOffTMPAcc.DocOffID = DocOffID;

   if( GetEQ( DocOffTMPAcc ) )                        
      DocOffTMPAcc.Summa = DocOffTMPAcc.Summa + Summa;
      Update( DocOffTMPAcc, null, true );
   else
      DocOffTMPAcc.Summa = Summa;
      Insert( DocOffTMPAcc, null, true );
   end;
   return 0;

   OnError( RslErrObj )
      return SayError( RslErrObj );

END;

/*Закачать во временный файл проводку. 
  Если там уже есть проводка с такими же параметрами, то просуммировать */
PRIVATE MACRO ДобавитьСводнуюДепозитарнуюОперацию( spdocoff, IsClient:BOOL )
   var Type, Account, State, AccountDeponent, Owner;
   var Consolidate = iif( IsClient, DepParm.rec.ClientConsolidate, DepParm.rec.Consolidate );
   var cmd, DataSet;

   if( spdocoff.Direction == DEAL_TYPE_SALE )
      Type     = DEPO_TYPE_OUT;
      Account  = spdocoff.Account_Payer;
   else
      Type     = DEPO_TYPE_IN;
      Account  = spdocoff.Account_Receiver;
   end;

   //if( DL_CustodyAccounting == DL_CUSTODYACCOUNTING_CUSTODY ) 
      AccountDeponent = TBFile( "depoacnt", "R", 2 );
      AccountDeponent.Clear();
      AccountDeponent.rec.BriefCode  = Account;   
      AccountDeponent.rec.Department = {OperDprt}; /*филиала пока нет в параметрах св. проводок*/
      if( AccountDeponent.GetEQ() )
         Owner = AccountDeponent.rec.Owner;
      else
         cmd = DL_RSDCommand(  " select tk.* "
                             + "   from ddl_tick_dbt tk, doproper_dbt opr, doprdocs_dbt odoc "
                             + "  where odoc.t_DocKind = ? " 
                             + "    and odoc.t_DocumentID = LPAD(to_char(?), 10, '0') "
                             + "    and opr.t_ID_Operation = odoc.t_ID_Operation "
                             + "    and tk.t_BOfficeKind = opr.t_DocKind "
                             + "    and LPAD(to_char(tk.t_DealID), 34, '0') = opr.t_DocumentID ");
         cmd.AddParam(136/*DLDOC_SPDOCOFF*/);
         cmd.AddParam(spdocoff.ID);

         DataSet = cmd.Execute();
         if(DataSet.moveNext())
           Owner = DataSet.ClientID;
           if(Owner == -1)
             Owner = {OurBank};
           end;
         end;



         //Owner = spdocoff.PartyID;
         //MsgBox( "Не найден счет " + Account + " в депозитарии." );
         //return 1;
      end;
   //else /*суррогатный счет ДЕПО*/
   //   AccountDeponent = TRecHandler( "account" );
   //   if( GetAccount( 5, spdocoff.Currency_Payer, Account, AccountDeponent ) == false )
   //      return 1;
   //   end;
  //    Owner = AccountDeponent.rec.Client;
  // end;

   if( (IsClient and (Owner == {OurBank})) or
       ((not IsClient) and (Owner != {OurBank})) )
      return 0;
   end;


   if( Consolidate == DEPSET_CONSOLIDATE_ONE ) /*одно св. поручение*/
      State = STATE_COMPARE;
   else
      State = STATE_EXECUTE;
   end;

   return ДобавитьДепозитарнуюОперацию( spdocoff.Currency_Payer, Account, 
                                        DEPO_KIND_SUMMARY, Type, 
                                        spdocoff.Sum_Payer, Owner,
                                        State, spdocoff.Blocked, 
                                        spdocoff.ID);
END;                      

PRIVATE MACRO GetNextDocOffTMPState( State:INTEGER )
   ClearRecord( DocOffTMPState );
   DocOffTMPState.State = State;
   return (GetGE(DocOffTMPState) AND (DocOffTMPState.State == State) );
END;

PRIVATE MACRO DeleteDocOffTMPByID( Id:INTEGER )
   ClearRecord( DocOffTMP );
   DocOffTMP.Id = Id;
   if( GetEQ( DocOffTMP ) )
      Delete( DocOffTMP );
   end;
END;

PRIVATE MACRO UpdateDocOffTMPByID( DocOff:VARIANT )
   ClearRecord( DocOffTMP );
   DocOffTMP.Id = DocOff.Id;
   if( GetEQ( DocOffTMP ) )
      copy( DocOffTMP, DocOff );
      update( DocOffTMP, null, true );
   end;
END;

PRIVATE MACRO FindDocOffTMPAcc( Kind:INTEGER, Type:INTEGER, FIID:INTEGER, Account:STRING, Blocked:INTEGER, State:INTEGER )
  var cmd, DataSet;

  KeyNum(DocOffTMPAcc, 0);

  cmd = RSDCommand(   " select t_ID from ddocoffdp_tmp "
                    + "  where t_FIID = ? " 
                    + "    and t_Account = "+iif(Account=="", "CHR(1)", " '"+Account+"' ")+" "
                    + "    and t_Kind = ? " 
                    + "    and t_Type = ? "
                    + "    and t_Blocked = ? "
                    + "    and t_State = ? " 
        );
  cmd.addParam( "", RSDBP_IN, FIID );
  cmd.addParam( "", RSDBP_IN, Kind );
  cmd.addParam( "", RSDBP_IN, Type );
  cmd.addParam( "", RSDBP_IN, Blocked );
  cmd.addParam( "", RSDBP_IN, State );
  cmd.execute();
  DataSet = TRsbDataSet(cmd);

  if(DataSet.moveNext())
    ClearRecord( DocOffTMPAcc );
    DocOffTMPAcc.ID = DataSet.ID;
    if(GetEQ(DocOffTMPAcc))
      KeyNum(DocOffTMPAcc, 1);
         return DocOffTMPAcc;
      end;
   end;

  KeyNum(DocOffTMPAcc, 1);

   return null;
END;

PRIVATE MACRO СформироватьСальдовуюОперациюДЕПО( A:VARIANT, B:VARIANT )
   if( A.Summa == B.Summa )
      DeleteDocOffTMPByID( A.Id );
      DeleteDocOffTMPByID( B.Id );
   elif( A.Summa > B.Summa )
      A.Summa = A.Summa - B.Summa;
      A.State = STATE_EXECUTE; 
      UpdateDocOffTMPByID( A );
      DeleteDocOffTMPByID( B.Id );
   else /*B.Summa > A.Summa*/
      B.Summa = B.Summa - A.Summa;
      B.State = STATE_EXECUTE; 
      UpdateDocOffTMPByID( B );
      DeleteDocOffTMPByID( A.Id );
   end;
END; 

PRIVATE MACRO СверткаПротивоположныхОперацийДЕПО(Kind)
   var RecA, Type, NumCarry = 0;
   InitProgress( -1, "Выполнение сводных проводок ...", "Свертка противоположных операций ДЕПО" );

   /*Изменяем ключевую последовательность (State), поэтому всегда GetGE*/
   while( GetNextDocOffTMPState( STATE_COMPARE ) )
      if( DocOffTMPState.Type == DEPO_TYPE_IN )
         Type = DEPO_TYPE_OUT
      else
         Type = DEPO_TYPE_IN
      end;

        RecA = FindDocOffTMPAcc( Kind, Type,
                                    DocOffTMPState.FIID, DocOffTMPState.Account, DocOffTMPState.Blocked,
                                    STATE_COMPARE
                                  );

      if( RecA != NULL )
         СформироватьСальдовуюОперациюДЕПО( RecA, DocOffTMPState );
      else
         DocOffTMPState.State = STATE_EXECUTE; 
         UpdateDocOffTMPByID( DocOffTMPState );
      end;

      UseProgress( NumCarry = NumCarry + 1 );
   end;

   RemProgress();
   return 0;

   OnError( RslErrObj )
      RemProgress();
      return SayError( RslErrObj );
END;

PRIVATE MACRO ПоручениеПоНаполнениюТранзитногоСчетаДЕПО( IsClient:BOOL )
   var Continue_cicle, Kind;
   var Consolidate = iif( IsClient, DepParm.rec.ClientConsolidate, DepParm.rec.Consolidate );
   var SetState = iif(Consolidate == DEPSET_CONSOLIDATE_ONE, STATE_COMPARE, STATE_EXECUTE);

   ClearRecord( DocOffTMPFind );
   DocOffTMPFind.State = STATE_EXECUTE;

   Continue_cicle = GetGE(DocOffTMPFind);

   while( Continue_cicle AND
          (DocOffTMPFind.State == STATE_EXECUTE)
        )
      if( DocOffTMPFind.Kind == DEPO_KIND_SUMMARY )
         if( DocOffTMPFind.Deponent == {OurBank} )
            Kind = DEPO_KIND_TRANS_OWN;
         else
            Kind = DEPO_KIND_TRANS_CLNT;
         end;

           ДобавитьДепозитарнуюОперацию( DocOffTMPFind.FIID, "", 
                                         Kind, DocOffTMPFind.Type, 
                                         DocOffTMPFind.Summa, -1,
                                         SetState, DocOffTMPFind.Blocked, 
                                         DocOffTMPFind.DocOffID );

         if( Consolidate == DEPSET_CONSOLIDATE_NO ) /*Не формировать св. поручения*/
           DeleteDocOffTMPByID( DocOffTMPFind.Id );
         end;
      end;
      Continue_cicle = Next( DocOffTMPFind );
   end;

   if( Consolidate == DEPSET_CONSOLIDATE_ONE) /*одно св. поручение*/
     СверткаПротивоположныхОперацийДЕПО(iif(IsClient, DEPO_KIND_TRANS_CLNT, DEPO_KIND_TRANS_OWN));
   end;

   return 0;
END;
*/

MACRO GetSubjByDocOff( DocOffTMP_DEPO:VARIANT, MarketID:INTEGER, Payer:@variant, Receiver:@variant )
   var Error = 0;

   if( DocOffTMP_DEPO.Blocked == 0 ) /*Нет блокировки*/
      if( DocOffTMP_DEPO.Type == DEPO_TYPE_IN ) /*зачисление*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = MarketID; 
            Receiver = DocOffTMP_DEPO.Deponent;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         end;
      else /*списание*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = DocOffTMP_DEPO.Deponent; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         end;
      end;
   else /*Блокировка*/
      if( DocOffTMP_DEPO.Type == DEPO_TYPE_IN )/*зачисление*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = MarketID; 
            Receiver = DocOffTMP_DEPO.Deponent;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = MarketID; 
            Receiver = {OurBank};
         end;
      else /*списание*/
         if( DocOffTMP_DEPO.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
            Payer    = DocOffTMP_DEPO.Deponent; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_OWN  ) /*Транз. по собств. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         elif( DocOffTMP_DEPO.Kind == DEPO_KIND_TRANS_CLNT ) /*Транз. по клиент. сделкам*/
            Payer    = {OurBank}; 
            Receiver = MarketID;
         end;
      end;
   end;

   return Error;
END;

PRIVATE MACRO СчетНашегоБанка()
   var depoacnt = TBFile( "depoacnt", "R" ),
       DepoAccID, ErrCode, Account = "";
   
   //if( DL_CustodyAccounting == DL_CUSTODYACCOUNTING_CUSTODY ) 

      GetRegistryValue( DEPO_TRANSIT_ACCOUNT, V_INTEGER, DepoAccID, ErrCode );
      if( ErrCode != 0 )
         MsgBox( "Ошибка при чтении настройки \"" + DEPO_TRANSIT_ACCOUNT + "\".");
      else
         if( DepoAccID <= 0 )
            MsgBox( "Не задано значение настройки \"" + DEPO_TRANSIT_ACCOUNT + "\".");
         else
            depoacnt.Clear();
            depoacnt.rec.AutoKey = DepoAccID;
            if( depoacnt.GetEQ() )
               Account = depoacnt.rec.BriefCode;
            else
               MsgBox( "Не найден счет ДЕПО, заданный в настройке \"" + DEPO_TRANSIT_ACCOUNT + "\"." );
            end;
         end;
      end;
   //end;

   return Account;
END;

/* Импортировать из БОЦБ сводное поручение в депозитарий.
   Вызывается при выполнении св. проводок ДЕПО в операции Расчеты на ОРЦБ.
   Параметры :
      DocOff        - 
      MarketID      - биржа
      MarketOfficeID- сектор биржи*/
MACRO InsertDepoDraftSummary( DocOff, Comm:VARIANT, IsClient )

   var  Kind_Oper, MarketCode, DealType, OperDate, /*pm_obj,*/ FCorschem, ErrCode, DepoBlock = -1,
        IsClientPayment, CorrID=-1, CorrAcc="", OurCorrID=-1, OurCorrAcc="", InOurBalance=UNSET_CHAR;
   VAR  MarketID       = comm.PartyID, 
        MarketOfficeID = comm.PartyOfficeID;
   var  Payer=-1, Receiver=-1, PayerBankID=-1, ReceiverBankID=-1, PayerAccount="", ReceiverAccount="";
   var  sa = TRecHandler("settacc");
   var  rq = TRecHandler("dlrq");
   var  corschem = TBFile( "corschem", "R", 4 );

   GetSubjByDocOff( DocOff, MarketID, @Payer, @Receiver);
   sa.Clear();
   rq.Clear();

   if( DocOff.Type == DEPO_TYPE_IN ) /*зачисление*/
      DealType      = DEAL_TYPE_BUY;
      Kind_Oper     = SP_DEPOPER_ENROLMENT; /* "Зачислении безналичных ц/б" */

      if(SP_GetPartySETTACC(Payer, 0, DocOff.FIID, FIKIND_AVOIRISS, 0, sa) == 0)
        PayerAccount = sa.rec.Account;
        PayerBankID  = sa.rec.BankID;
      end;
   else 
      DealType      = DEAL_TYPE_SALE;
      Kind_Oper     = SP_DEPOPER_TRANSFERORDER; /* Поручение на междепозитарный перевод*/

      if(SP_GetPartySETTACC(Receiver, 0, DocOff.FIID, FIKIND_AVOIRISS, 0, sa) == 0)
        ReceiverAccount = sa.rec.Account;
        ReceiverBankID  = sa.rec.BankID;
      end; 
   end;

   if(sa.rec.SettAccID)
     OurCorrID = sa.rec.BankCorrID;
     if (sa.rec.BankCorrID != {OurBank})
        CorrAcc      = sa.rec.CorrAcc;
        CorrID       = sa.rec.BankCorrID;
        if(sa.rec.CorrAcc != "")
          KeyNum(corschem, 4);
          ClearRecord(corschem);
          corschem.rec.CorrID     = sa.rec.BankCorrID;
          corschem.rec.CorAccount = sa.rec.CorrAcc;
          if( getEQ(corschem) )
             OurCorrAcc = corschem.rec.Account;
             OurCorrId  = corschem.rec.CorrID;
             InOurBalance  = SET_CHAR;
          end;
        end;
      else
        OurCorrAcc = sa.rec.CorrAcc;
      end;
   end;

   if( DocOff.Kind == DEPO_KIND_SUMMARY ) /*Сводная*/
      if( (Payer == comm.PartyID) /*Отправитель == биржа*/ and 
          (Receiver != {OurBank}) and
          (Receiver == DocOff.Deponent ) and (DocOff.Account != "")
        )
          ReceiverAccount = DocOff.Account;
      elif( (Receiver == comm.PartyID) /*Получатель == биржа*/ and 
            (Payer != {OurBank}) and
            (Payer == DocOff.Deponent ) and (DocOff.Account != "")
          )
          PayerAccount = DocOff.Account;
      end;
   end; 

   if((Payer == {OurBank}) AND ((DocOff.Kind == DEPO_KIND_TRANS_OWN) OR (DocOff.Kind == DEPO_KIND_TRANS_CLNT)))
     PayerAccount = СчетНашегоБанка();
   elif((Receiver == {OurBank}) AND ((DocOff.Kind == DEPO_KIND_TRANS_OWN) OR (DocOff.Kind == DEPO_KIND_TRANS_CLNT)))
     ReceiverAccount = СчетНашегоБанка();
   end;

   if( ReceiverBankID <= 0 )
      ReceiverBankID = {OurBank};
   end;
   if( PayerBankID <= 0 )
      PayerBankID = {OurBank};
   end;


   OperDate   = Comm.CommDate;
   MarketCode = ПолучитьКодГруппыБиржи( MarketID );
   if( (Payer != {OurBank}) AND (Receiver != {OurBank}) )
      IsClientPayment = true;
   else
      IsClientPayment = false;
   end;

   if( ПолучитьПараметрыДУ( DepParm, MarketID, comm.MarketSchemeID ) )
     if(IsClientPayment)
       if(DepParm.rec.DPCorrNodeCln)
         if(GetCorrNodeInfo(DepParm.rec.DPCorrNodeCln, @OurCorrAcc, @OurCorrId, @DepoBlock))
           InOurBalance = SET_CHAR;
         else
           return 1;
         end;
       end;
     else
       if(DepParm.rec.DPCorrNodeOur)
         if(GetCorrNodeInfo(DepParm.rec.DPCorrNodeOur, @OurCorrAcc, @OurCorrId, @DepoBlock))
           InOurBalance = SET_CHAR;
         else
           return 1;
         end;
       end;
     end;
   else
     return 1;
   end;

   ClearRecord(DepoDraftParm);
   DepoDraftParm.Kind         = Kind_Oper;
   DepoDraftParm.SignedDate   = OperDate;
   DepoDraftParm.RegisterDate = OperDate;
   DepoDraftParm.RegisterTime = Time();
   DepoDraftParm.DwPartyID    = Payer;  

   DepoDraftParm.DwAccCode   = PayerAccount;
   DepoDraftParm.DwCustodyID = PayerBankID;
   
   if( DealType == DEAL_TYPE_BUY ) /* покупка - распоряжение на зачисление */ 
      DepoDraftParm.DwCustodyAgentID = CorrID;
      DepoDraftParm.DwCorAcc         = CorrAcc;
      DepoDraftParm.DwOurCustAgentID = OurCorrID;
      DepoDraftParm.DwOurCorAcc      = OurCorrAcc;
      if(DepoBlock != -1)
        DepoDraftParm.Unblock = DepoBlock;
      end;
      DepoDraftParm.BnAccPurp = OBJTYPE_DEPOKINDTYPE_DEPONENT; 
   else
      DepoDraftParm.DwAccPurp = OBJTYPE_DEPOKINDTYPE_DEPONENT; 

      DepoDraftParm.BnCustodyAgentID = CorrID;
      DepoDraftParm.BnCorAcc         = CorrAcc;

      if( OurCorrAcc != "" )
         if( InOurBalance == SET_CHAR )
            DepoDraftParm.BnOurCorAcc = OurCorrAcc;
            if(DepoBlock != -1)
              DepoDraftParm.Block = DepoBlock;
            end;
         else
            FCorschem = TBFile( "corschem", "R", 4 );
            FCorschem.Clear();
            FCorschem.rec.CorrID     = CorrID;
            FCorschem.rec.CorAccount = OurCorrAcc;
            if( FCorschem.GetEQ() )
               DepoDraftParm.BnOurCorAcc = FCorschem.rec.Account;
               if(DepoBlock != -1)
                 DepoDraftParm.Block = DepoBlock;
               end;
            end;
         end;
      end;
   end;

   if( (MarketCode == MICEX_CODE) OR             
       ( (MarketCode == RTS_CODE) AND ( MarketOfficeID == СекторСГК ) )
     ) 
     DepoDraftParm.IsDVP = UNSET_CHAR;   /*Убрал установку флага DVP по запросу 183721*/
   end;    

   DepoDraftParm.BnPartyID   = Receiver;
   DepoDraftParm.BnAccCode   = ReceiverAccount;
   DepoDraftParm.BnCustodyID = ReceiverBankID;
   DepoDraftParm.Amount      = DocOff.Summa;
   DepoDraftParm.ValueDate   = OperDate;

   DepoDraftFillDealData(Comm);

   DepoDraftParm.Product     = 1; /* Купля - продажа */
   DepoDraftParm.Oper        = {oper};
   DepoDraftParm.PaymentID   = 0;
   DepoDraftParm.Initiator   = -1; /* инициатор */
   DepoDraftParm.GeneralizedFIID = DocOff.FIID;
   DepoDraftFillFIID_2( DocOff.FIID );

   if( (DocOff.Kind == DEPO_KIND_TRANS_OWN) OR 
       (DocOff.Kind == DEPO_KIND_TRANS_CLNT) )
      DepoDraftParm.FromTransitAccount = UNSET_CHAR;
      GetRegistryValue( ENROLOPRTRANSBLOCK, V_INTEGER, DepoBlock, ErrCode );
      if( ErrCode != 0 )
         MsgBox( "Ошибка при чтении настройки \"" + ENROLOPRTRANSBLOCK + "\".");
         return false;
      end;

      if( DealType == DEAL_TYPE_BUY )
         DepoDraftParm.Block = DepoBlock; /*Блокировка по счету получателя*/
      else
         DepoDraftParm.Unblock = DepoBlock; /*Блокировка по счету отправителя*/
      end;
   elif( DocOff.Kind == DEPO_KIND_SUMMARY)
      DepoDraftParm.FromTransitAccount = iif( IsClient, DepParm.rec.OverTransAccCln, DepParm.rec.OverTransAcc );

      if( DealType == DEAL_TYPE_BUY )
         if( DocOff.Type == DEPO_TYPE_IN )
            DepoDraftParm.Block = OBJTYPE_DEPOACC_BLOCK_INMARKETS; /*Блокировка по счету получателя - на торгах*/
         else
            DepoDraftParm.Block = OBJTYPE_DEPOACC_BLOCK_REPO; /*Блокировка по счету получателя - РЕПО*/
         end;
      else
         if( DocOff.Type == DEPO_TYPE_IN )
            DepoDraftParm.Unblock = OBJTYPE_DEPOACC_BLOCK_INMARKETS; /*Блокировка по счету отправителя на торгах*/
         else
            DepoDraftParm.Unblock = OBJTYPE_DEPOACC_BLOCK_REPO; /*Блокировка по счету получателя - РЕПО*/
         end;
      end;
   end;

   DepoDraftParm.SettlementDate = Comm.CommDate;
   DepoDraftParm.LateDeliveryDate = Comm.CommDate;

   DepoDraftParm.DealCurrency = NATCUR;

   return InsertDraftParm(DepoDraftParm, rq, null, Comm.DocKind, Comm.DocumentID );
END;
/*
PRIVATE MACRO СформироватьПорученияДЕПО( FD:SPFirstDocDLCOMM, MarketID:INTEGER, Blocked, Kind, Type, IsClient )
   var continue_cicle, Error = 0, NumCarry = 0, Ground = "", Payer = -1, Receiver = -1, dp_type, dp_purpose;

   InitProgress( -1, "Выполнение сводных проводок по сделкам ...", "Формирование депозитарных платежей" );
   ClearRecord( DocOffTMPState );
   DocOffTMPState.State = STATE_EXECUTE;
   continue_cicle = GetGE( DocOffTMPState );
   while( continue_cicle AND (DocOffTMPState.State == STATE_EXECUTE) )

        if((DocOffTMPState.Blocked == Blocked) AND (DocOffTMPState.Type == Type) AND (DocOffTMPState.Kind == Kind))
          //if( DL_CustodyAccounting == DL_CUSTODYACCOUNTING_CUSTODY ) 
             if( InsertDepoDraftSummary( DocOffTMPState, FD.comm.rec, IsClient ) == false)
                Error = 1;
             end;
          //end;
        end;

        if( Error == 0 )
           continue_cicle = Next( DocOffTMPState );
        else
           continue_cicle = false;
        end;
        UseProgress( NumCarry = NumCarry + 1 );
   end;
   RemProgress();
   return Error;
END;

MACRO ВыполнитьОтложенныеОперацииДЕПО( FD:SPFirstDocDLCOMM, Doc:VARIANT, PartyID:INTEGER, DateCarry:DATE, IsClient:BOOL )
   FILE spdocoff(spdocoff) key 1;
   var errcode, errtext, MarketID;
   var continue_cicle, Error = 0;
   var Consolidate = 0, AddTransAcc = "";

   if( not ПолучитьПараметрыДУ( DepParm, PartyID, FD.GetMarketSchemeID() ) )
      return 1;
   end;

   Consolidate = iif( IsClient, DepParm.rec.ClientConsolidate, DepParm.rec.Consolidate );
   AddTransAcc = iif( IsClient, DepParm.rec.AddTransAccCln, DepParm.rec.AddTransAcc );

   if( (not Open( DocOffTMP ) ) OR /*Global temporary space table*/
       (not Open( DocOffTMPAcc ) ) OR /*Global temporary space table*/
       (not Open( DocOffTMPState ) ) OR /*Global temporary space table*/
       (not Clone( DocOffTMP ))
     )
      errcode = status( errtext );
      MsgBox( "Ошибка при создании временного файла|"+"|(" + errcode + ") " + errtext);
      return 1;
   end;

   /* В spdocoff хранится код ведущей биржи (см. запрос #64477). */
   MarketID = GetLeaderMarketID( PartyID, DateCarry );

   /*Заполнение временного файла */
   ClearRecord(spdocoff);
   spdocoff.PartyID        = MarketID;
   spdocoff.OfficeID       = FD.GetParametr(MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE);
   spdocoff.State          = SPDOCOFF_STATE_PREPARED;
   spdocoff.Date_Carry     = DateCarry;
   continue_cicle = GetGE( spdocoff );
   while( continue_cicle AND
          (spdocoff.PartyID        == MarketID ) AND
          (spdocoff.OfficeID       == FD.GetParametr(MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE) ) AND
          (spdocoff.State          == SPDOCOFF_STATE_PREPARED) AND
          (spdocoff.Date_Carry     == DateCarry) 
        )
      if( spdocoff.Chapter == 5 ) /*ДЕПО*/
         Error = ДобавитьСводнуюДепозитарнуюОперацию( spdocoff, IsClient );
      end;
      if( Error == 0 )   
         continue_cicle = Next( spdocoff );
      else
         continue_cicle = false;
      end;
   end;

   if( (Error == 0) AND 
       (Consolidate == DEPSET_CONSOLIDATE_ONE) /*одно св. поручение*/
     ) 
      Error = СверткаПротивоположныхОперацийДЕПО(DEPO_KIND_SUMMARY);
   end;

   if( (Error == 0) AND
       (AddTransAcc == SET_CHAR) /*Поручение по наполнению транзитного счета*/
     )
      Error = ПоручениеПоНаполнениюТранзитногоСчетаДЕПО( IsClient );
   end;

   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 0, DEPO_KIND_TRANS_OWN,  DEPO_TYPE_IN, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 1, DEPO_KIND_TRANS_OWN,  DEPO_TYPE_IN, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 0, DEPO_KIND_TRANS_CLNT, DEPO_TYPE_IN, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 1, DEPO_KIND_TRANS_CLNT, DEPO_TYPE_IN, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 0, DEPO_KIND_SUMMARY,    DEPO_TYPE_IN, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 1, DEPO_KIND_SUMMARY,    DEPO_TYPE_IN, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 0, DEPO_KIND_SUMMARY,    DEPO_TYPE_OUT, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 1, DEPO_KIND_SUMMARY,    DEPO_TYPE_OUT, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 0, DEPO_KIND_TRANS_OWN,  DEPO_TYPE_OUT, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 1, DEPO_KIND_TRANS_OWN,  DEPO_TYPE_OUT, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 0, DEPO_KIND_TRANS_CLNT, DEPO_TYPE_OUT, IsClient );
   end;
   if( Error == 0 )
      Error = СформироватьПорученияДЕПО( FD, PartyID, 1, DEPO_KIND_TRANS_CLNT, DEPO_TYPE_OUT, IsClient );
   end;

   return Error;
END;
*/