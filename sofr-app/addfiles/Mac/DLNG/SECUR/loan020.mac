 /*
$Name:         loan020.mac 
$Module:       Ценные бумаги
$Description:  Операция займ. Шаг подтверждения сделки
*/

import InsCarryDoc, "sp_class.mac", "sp_car.mac", "sprconf.mac";

record Deal_Tick (dl_tick);

macro ExecuteStep( doc, FDoc)

   var  FD, dat;

   SetBuff( Deal_Tick, FDoc ); 
   
   FD = SPFirstDoc( Deal_Tick );

   GetOprDate( FD.GetKindDate(DATE_DEALDATE), dat );
   if( dat > {curdate} )
     MsgBox ("Преждевременное выполнение шага запрещено.");
     return 1;
   end;

   if(IsOprMultiExec() == false)
      if( GetTrue( true, "Формировать подтверждение?" ) == true )  
        message("Идет формирование подтверждения...");
        PrintConfirmation(Deal_Tick.DealID, not FD.IsBack );
      end;
   end;

   /*ставим признак - Сделка подтверждена*/ 
   if( not ОбновитьФлагиЧастиСделки( FD.dl_leg, DL_LEG_CONFIRM_DEAL ) )
      msgbox("Ошибка при обновлении статуса в лоте"); 
      return 1;
   end;  

   return 0;
end;

/* Макрос постобработки */
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    
    SetBuff(Deal_Tick, FDoc ); 

    if (errTrn OR (CommitOrRollback == 2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    return 0;
END;

/* Макрос печати */
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */
    
    message("Идет формирование подтверждения...");
    PrintConfirmation( Deal_Tick.DealID, false );

    exit(1); /*Для того, чтобы не выводился пустой файл */
END;
