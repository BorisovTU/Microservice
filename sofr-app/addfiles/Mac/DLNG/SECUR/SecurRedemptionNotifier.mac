//SecurRedemptionNotifier.mac

import "u_common_email_utils.mac", "SecurRedemptionLinkService.mac", "SecurRedemptionService.mac";
import oralib, "MailReceiverGroups.mac";

class SecurRedemptionNotifier

    private macro GetClientCftCode(clientId:integer):string
        var query = 
              "select party_read.get_party_code ( "
            + "         p_party_id  => :partyId, "
            + "         p_code_kind => 101 "
            + "       ) cft_code "
            + "  from dual ";
        var sql = ExecSQLselectPrmDyn(query, clientId);

        if (sql.MoveNext())
            return sql.value("cft_code");
        end;

        return "";
    end;

    macro BalancesIsNotEqual(link:SecurRedemptionLink, redemption:SecurRedemptionStruct)
        var topic = string("Найдено расхождение по остаткам ВУ/ДУ по клиенту", GetClientCftCode(link.clientId),
            " по ц/б ",  redemption.isin,
            " в рамках предстоящего КД Погашения ", link.dealCode
        );

        var body = string(
            "Остаток ц/б по данным Внутреннего учёта - ", link.amount, " шт.\n",
            "Остаток ц/б по данным Депозитарного учёта - ", link.diasoftRest, " шт.\n",
            "Просьба разобраться в причинах расхождения и провести необходимые действия для его устранения"
        );

        var mailProcessor = c_email_proc_env();
        mailProcessor.m_set_msg_head(topic);
        mailProcessor.m_add_row_to_msg_text(body);
        mailProcessor.m_save_to_submit_grp(MailReceiverGroups.OPERATION_DEPARTMENT, true);
    end;
end;