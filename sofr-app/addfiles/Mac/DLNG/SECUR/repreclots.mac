/*
$Name:        repreclots.mac
$Module:      Ценные бумаги
$Description: Отчет "Сверка параметров лотов с данными бухгалтерского учета"
*/
import "repreclots_form.mac", "spRepFn2.mac", "globals.mac","dlmisc.mac";

file TempFile( "repporst.tmp" ) write;

private macro date_as_string( form_num, _date, ShortYFormat )
     var day,mon,year,sep_ch,res = "";
     _date = SQL_ConvTypeDate(_date);
     if(( ValType(_date) != V_UNDEF ) AND (_date != date(0,0,0)))
        datesplit( date(_date), day, mon, year );
        if ( form_num == 1 ) sep_ch = ".";
        elif ( form_num = 2 ) sep_ch = "/";
        else sep_ch = "-";
        end;
        if ( day != 0 )
             res = L_Z(string(day:2),2) + sep_ch;
        else
             res = "  " + sep_ch;
        end;

        if ( mon != 0 )
             res = res + L_Z(string(mon:2),2) + sep_ch;
        else
             res = res + "  " + sep_ch;
        end;

        if( valtype(ShortYFormat) != v_undef )
             ShortYFormat = true;
        end;

        if ( year != 0 )
             if( ShortYFormat )
                  year = year - Int( year / 100 ) * 100;
                  res = res + L_Z(string(year:2),2);
             else
                  res = res + L_Z(string(year:4),4);
             end;
        else
             res = res + IIF( ShortYFormat, "  ", "    " );
        end;
     end;
     return res;
end;


private const
   /* Идентификаторы учетных портфелей. */
   PortfID_Undef         = 0,
   PortfID_SSPU          = 1,  /* ССПУ_ЦБ */                    
   PortfID_SSSD          = 2,  /* СССД_ЦБ */
   PortfID_Contr         = 3,  /* ПКУ */
   PortfID_Promissory    = 4,  /* ПДО */
   PortfID_ASCB          = 5,  /* АС_ЦБ */
   PortfID_Back          = 6,  /* ПВО */
   PortfID_Unadmitted    = 7;  /* БПП */

PRIVATE CLASS RecLOtsData
   var
      RepDate        = Date(0,0,0),       
      SSPU           = "X",            
      SSSD           = "X",           
      ASCB           = "X",          
      BPP            = "X",           
      PVO            = "X",           
      PKU            = "X",           
      PDO            = "X",           
      AvrCode        = -1,       
      IsUseApostrofs = "X";

   var
      WasCollectedData  = false,
      UniqStr           = TUniqStrCollector,
      PortfNameArray    = TArray;

   PortfNameArray[PortfID_Undef]       = "Undefined";
   PortfNameArray[PortfID_SSPU]        = SSPUPORTFNAME;
   PortfNameArray[PortfID_SSSD]        = SSSDPORTFNAME;
   PortfNameArray[PortfID_ASCB]        = ASCBPORTFNAME;
   PortfNameArray[PortfID_Unadmitted]  = UNADMITEDPORTFNAME;
   PortfNameArray[PortfID_Back]        = BACKPORTFNAME;
   PortfNameArray[PortfID_Contr]       = CONTRPORTFNAME;
   PortfNameArray[PortfID_Promissory]  = PROMISSPORTFNAME;

END;

PRIVATE VAR Data   = RecLOtsData();
PRIVATE VAR m_Form = DL_RecLOts_Panel();

PRIVATE MACRO UpdateFormFields():INTEGER
  Data.RepDate         = m_Form.GetFieldValue( PNFLD_REPRECLOTS_DATE ) - 1; /*будем брать данные на конец предшествующей даты*/
  Data.SSPU            = m_Form.GetFieldValue( PNFLD_REPRECLOTS_SSPU );
  Data.SSSD            = m_Form.GetFieldValue( PNFLD_REPRECLOTS_SSSD );
  Data.ASCB            = m_Form.GetFieldValue( PNFLD_REPRECLOTS_ASCB );
  Data.BPP             = m_Form.GetFieldValue( PNFLD_REPRECLOTS_BPP );
  Data.PVO             = m_Form.GetFieldValue( PNFLD_REPRECLOTS_PVO );
  Data.PKU             = m_Form.GetFieldValue( PNFLD_REPRECLOTS_PKU );
  Data.PDO             = m_Form.GetFieldValue( PNFLD_REPRECLOTS_PDO );
  Data.AvrCode         = m_Form.GetFieldValue( PNFLD_REPRECLOTS_AVRCODE );
  Data.IsUseApostrofs  = m_Form.GetFieldValue( PNFLD_REPRECLOTS_WITH_APOSTROFS );
END;

private const StatLine = "Выпуск отчета \"Сверка параметров лотов с данными бухгалтерского учета\"";

/* Данные одной строки отчета. */
class TLineSummary
   var
      FIID,                 
      Issuer,               
      AvrName,              
      AvrType,              
      LSIN,                 
      ISIN,                 
      Issued,               
      DrawDate,             
      CoupDrawDate,         
      FaceValue,            
      FaceValCcy,           
      Amount,
      Portfolio,
      IncomeRate,             
      BuyCostCUR,           
      BuyCostNMN,           
      OutLay,               
      NKDBuy,               
      CostIn,               
      CostInAcc,            
      CostInAccRest,        
      CostInAccRestRUB,
      OverAmount,           
      OverAmountAcc,        
      OverAmountAccRest,    
      OverAmountAccRestRUB,    
      OverAmountAcc_P,
      OverAmountAccRest_P,
      OverAmountAccRest_PRUB,
      OverAmountAcc_M,
      OverAmountAccRest_M,
      OverAmountAccRest_MRUB,
      Income,               
      IncomeAcc,            
      IncomeAccRest,        
      IncomeAccRestRUB,        
      BonusRest,            
      BonusRestAcc,         
      BonusRestAccRest,     
      BonusRestAccRestRUB,     
      Discount,             
      DiscountAcc,          
      DiscountAccRest,      
      DiscountAccRestRUB,      
      QCategory,            
      ReserveSum,           
      ReserveSumAcc,        
      ReserveSumAccRest,    
      ReserveSumAccRestRUB,
      PDD_ReserveSum,       
      PDD_ReserveSumAcc,    
      PDD_ReserveSumAccRest,
      PDD_ReserveSumAccRestRUB,
      SumPrecision,
      FaceValueFI,
      CorrSum,
      CorrAcc,
      CorrAccRest,
      CorrAccRestRUB,
      CorrAcc_M,
      CorrAccRest_M,
      CorrAccRest_MRUB,
      CorrAcc_P,
      CorrAccRest_P,
      CorrAccRest_PRUB,
      CorrDelta,
      CorrEstReserveSum,
      CorrEstReserveAcc,
      CorrEstReserveAccRest,
      CorrEstReserveAccRestRUB,
      CorrEstReserveAcc_M,
      CorrEstReserveAccRest_M,
      CorrEstReserveAccRest_MRUB,
      CorrEstReserveAcc_P,
      CorrEstReserveAccRest_P,
      CorrEstReserveAccRest_PRUB,
      CorrEstReserveDelta,
      UNKDSum,
      UNKDAcc,
      UNKDAccRest,
      UNKDAccRestRUB, 
      CourseCBRF, 
      DateCourseCBRF,
      BPP_OverAmount,
      BPP_CorrSum,
      BPP_CorrEstReserveSum;

      record AccBuff(account);



   macro ClearSum()
      Amount                  = 0.;
      BuyCostCUR              = "";
      BuyCostNMN              = "";
      OutLay                  = $0;
      NKDBuy                  = $0;
          
      CostIn                  = $0;
      CostInAcc               = "";
      CostInAccRest           = $0;
          
      OverAmount              = $0;
      OverAmountAcc           = null;
      OverAmountAccRest       = $0;
      OverAmountAcc_P         = null;
      OverAmountAccRest_P     = $0;
      OverAmountAcc_M         = null;
      OverAmountAccRest_M     = $0;
          
      Income                  = $0;
      IncomeAcc               = null;
      IncomeAccRest           = $0;
          
      BonusRest               = $0;
      BonusRestAcc            = null;
      BonusRestAccRest        = $0;
          
      Discount                = $0;
      DiscountAcc             = null;
      DiscountAccRest         = $0;

      ReserveSum              = $0;
      ReserveSumAcc           = null;
      ReserveSumAccRest       = $0;

      PDD_ReserveSum          = $0;
      PDD_ReserveSumAcc       = null;
      PDD_ReserveSumAccRest   = $0;

      CorrSum                 = $0;
      CorrAcc                 = null;
      CorrAccRest             = $0;
      CorrAcc_M               = null;
      CorrAccRest_M           = $0;
      CorrAcc_P               = null;
      CorrAccRest_P           = $0;
           
      CorrEstReserveSum       = $0;
      CorrEstReserveAcc       = null;
      CorrEstReserveAccRest   = $0;
      CorrEstReserveAcc_M     = null;
      CorrEstReserveAccRest_M = $0;
      CorrEstReserveAcc_P     = null;
      CorrEstReserveAccRest_P = $0;  
      UNKDSum 		      = $0;
      UNKDAcc 		      = null;
      UNKDAccRest 	      = $0;

      BPP_OverAmount        = $0;
      BPP_CorrSum           = $0;
      BPP_CorrEstReserveSum = $0;

   end;

   macro ClearAvrInfo()
      FIID                   = -1;     
      Issuer                 = "";                       
      AvrName                = "";          
      AvrType                = "";          
      LSIN                   = "";          
      ISIN                   = "";          
      Issued                 = "";          
      IncomeRate             = $0;          
      DrawDate               = "";          
      CoupDrawDate           = "";          
      FaceValue              = "";          
      FaceValCcy             = $0;          
      QCategory              = "";                                           
      SumPrecision           = 0;//точность вывода кол-ва
      FaceValueFI            = 0;
      CourseCBRF             = 0.0;
      DateCourseCBRF         = Date(0,0,0);
      Portfolio              = 0;
   end;

   /* Конструктор */
   ClearAvrInfo();
   ClearSum();
end;

PRIVATE CLASS CRecLOts( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()
     m_Report.PrintFormatString( "#", "N1_H0", string(Data.RepDate + 1) );
     m_Report.PrintFormatString( "#", "N1_H1", m_Report.H1() );
     m_Report.PrintFormatString( "#", "N1_H2", m_Report.H2() );
     
     m_Report.RegisterTable( "N1_MainTable", "",
                             "N1_A1", 
                             "N1_A2", 
                             "N1_A3",  
                             "N1_A4", 
                             "N1_A5", 
                             "N1_A6", 
                             "N1_A7", 
                             "N1_A8", 
                             "N1_A9", 
                             "N1_A10",
                             "N1_A11",
                             "N1_A12",
                             "N1_A13",
                             "N1_A14",
                             "N1_A15", 
                             "N1_A16",  
                             "N1_A17",
                             "N1_A18",
                             "N1_A19",
                             "N1_A19_1",
                             "N1_A20",
                             "N1_A21",
                             "N1_A22",
                             "N1_A23",
                             "N1_A23_1",
                             "N1_A24",
                             "N1_A25",
                             "N1_A26",
                             "N1_A27",
                             "N1_A27_1",
                             "N1_A28",
                             "N1_A51",
                             "N1_A52",
                             "N1_A53",
                             "N1_A53_1",
                             "N1_A54",
                             "N1_A31",
                             "N1_A32",
                             "N1_A33",
                             "N1_A33_1",
                             "N1_A34",
                             "N1_A56",
                             "N1_A57",
                             "N1_A58",
                             "N1_A58_1",
                             "N1_A59",
                             "N1_A39",
                             "N1_A40",
                             "N1_A41",
                             "N1_A42",
                             "N1_A42_1",
                             "N1_A43",
                             "N1_A44",
                             "N1_A45",
                             "N1_A46",
                             "N1_A46_1",
                             "N1_A47",
                             "N1_A60",
                             "N1_A61",
                             "N1_A62",
                             "N1_A62_1",
                             "N1_A63",
                             "N1_A64",
                             "N1_A65",
                             "N1_A66",
                             "N1_A66_1",
                             "N1_A67"
                          );
         
  END;

  MACRO PrintTableLine()
      m_Report.PrintTableLine( "N1_A1",  m_Report.Issuer(),                null,
                               "N1_A2",  m_Report.AvrName(),               null,
                               "N1_A3",  m_Report.AvrType(),               null,
                               "N1_A4",  m_Report.LSIN(),                  null,
                               "N1_A5",  m_Report.ISIN(),                  null,
                               "N1_A6",  m_Report.Issued(),                null,
                               "N1_A7",  m_Report.DrawDate(),              null,
                               "N1_A8",  m_Report.CoupDrawDate(),          null,
                               "N1_A9",  m_Report.FaceValue(),             null,
                               "N1_A10", m_Report.FaceValCcy(),            null,
                               "N1_A11", m_Report.Amount(),                m_Report.SumPrecision(),
                               "N1_A12", m_Report.IncomeRate(),            null,
                               "N1_A13", m_Report.BuyCostCUR(),            null,
                               "N1_A14", m_Report.BuyCostNMN(),            null,
                               "N1_A15", m_Report.OutLay(),                null,
                               "N1_A16", m_Report.NKDBuy(),                null,
                               "N1_A17", m_Report.CostIn(),                null,
                               "N1_A18", m_Report.CostInAcc(),             null,
                               "N1_A19", m_Report.CostInAccRest(),         null,
                               "N1_A19_1", m_Report.CostInAccRestRUB(),         null,
                               "N1_A20", m_Report.CostInDelta(),           null,
                               "N1_A21", m_Report.OverAmount(),            null,
                               "N1_A22", m_Report.OverAmountAcc(),         null,
                               "N1_A23", m_Report.OverAmountAccRest(),     null,
                               "N1_A23_1", m_Report.OverAmountAccRestRUB(),     null,
                               "N1_A24", m_Report.OverAmountDelta(),       null,
                               "N1_A25", m_Report.Income(),                null,
                               "N1_A26", m_Report.IncomeAcc(),             null,
                               "N1_A27", m_Report.IncomeAccRest(),         null,
                               "N1_A27_1", m_Report.IncomeAccRestRUB(),         null,
                               "N1_A28", m_Report.IncomeDelta(),           null,
                               "N1_A51", m_Report.BonusRest(),             null,
                               "N1_A52", m_Report.BonusRestAcc(),          null,
                               "N1_A53", m_Report.BonusRestAccRest(),      null,
                               "N1_A53_1", m_Report.BonusRestAccRestRUB(),      null,
                               "N1_A54", m_Report.BonusRestDelta(),        null,
                               "N1_A31", m_Report.Discount(),              null,
                               "N1_A32", m_Report.DiscountAcc(),           null,
                               "N1_A33", m_Report.DiscountAccRest(),       null,
                               "N1_A33_1", m_Report.DiscountAccRestRUB(),       null,
                               "N1_A34", m_Report.DiscountDelta(),         null,
                               "N1_A56", m_Report.CorrSum(),               null,
                               "N1_A57", m_Report.CorrAcc(),               null,
                               "N1_A58", m_Report.CorrAccRest(),           null,
                               "N1_A58_1", m_Report.CorrAccRestRUB(),           null,
                               "N1_A59", m_Report.CorrDelta(),             null,
                               "N1_A39", m_Report.QCategory(),             null,
                               "N1_A40", m_Report.ReserveSum(),            null,
                               "N1_A41", m_Report.ReserveSumAcc(),         null,
                               "N1_A42", m_Report.ReserveSumAccRest(),     null,
                               "N1_A42_1", m_Report.ReserveSumAccRestRUB(),     null,
                               "N1_A43", m_Report.ReserveSumDelta(),       null,
                               "N1_A44", m_Report.PDD_ReserveSum(),        null,
                               "N1_A45", m_Report.PDD_ReserveSumAcc(),     null,
                               "N1_A46", m_Report.PDD_ReserveSumAccRest(), null,
                               "N1_A46_1", m_Report.PDD_ReserveSumAccRestRUB(), null,
                               "N1_A47", m_Report.PDD_ReserveSumDelta(),   null,
                               "N1_A60", m_Report.CorrEstReserveSum(),     null,
                               "N1_A61", m_Report.CorrEstReserveAcc(),     null,
                               "N1_A62", m_Report.CorrEstReserveAccRest(), null,
                               "N1_A62_1", m_Report.CorrEstReserveAccRestRUB(), null,
                               "N1_A63", m_Report.CorrEstReserveDelta(),   null,
                               "N1_A64", m_Report.UNKDSum(),     null,
                               "N1_A65", m_Report.UNKDAcc(),     null,
                               "N1_A66", m_Report.UNKDAccRest(), null,
                               "N1_A66_1", m_Report.UNKDAccRestRUB(), null,
                               "N1_A67", m_Report.UNKDDelta(),   null, 
                               "N1_A68", m_Report.CourseCBRF(),            null,
                               "N1_A69", m_Report.DateCourseCBRF(),        null
                             );
  END;                                                                                                                                                                         

  MACRO PrintHeadLine(HeadLine:string)
      m_Report.merge( "N1_A1", "N1_A54" );
      m_Report.PrintTableLine( "N1_A1",  HeadLine, null)
  END;                                                                                                                                                                         

  MACRO EndReport();
     m_Report.EndTable();
//     m_Report.AddStandardFooter( "N1_" );
  END;         

END;

PRIVATE MACRO GetSessionID():Integer
  var id:Integer = -1;
  var sql = "SELECT SYS_CONTEXT('USERENV','SESSIONID') SessionID FROM DUAL";
  var cmd = DL_RSDCommand(sql);
  var ds = cmd.execute();
  if( ds.MoveNext() )
     id = int(ds.SessionID);
  end;
  return id;
END;

PRIVATE CLASS (DL_CReportTemplate) SP_RecLOts_Report
  var fininstr    = TRecHandler( "fininstr" );
  var WasCollectedData = false;
  var LineSumm = TLineSummary();
  var m_PrevPortf, m_PrevIsQouted, m_PrevFiid, m_PrevAccount;
  var m_H1, m_H2;
  private var m_SessionID = GetSessionID();

  PRIVATE MACRO PrintMode():INTEGER/*печатаем только в Excel, тк выбора нет*/
     return DL_OUTREPORT_EXCEL;
  END;                                                                                                                                                                         

  PRIVATE MACRO CollectData()
     var Select = "", Point = false, Num = 0, cmd;
     var ParallelLevel = 8;
     var cnt = 0;
     var i = 0;

     cnt = cnt + IIF(Data.SSPU == "X", 1, 0);
     cnt = cnt + IIF(Data.SSSD == "X", 1, 0);
     cnt = cnt + IIF(Data.ASCB == "X", 1, 0);
     cnt = cnt + IIF(Data.BPP == "X", 1, 0); 
     cnt = cnt + IIF(Data.PVO == "X", 1, 0); 
     cnt = cnt + IIF(Data.PKU == "X", 1, 0); 
     cnt = cnt + IIF(Data.PDO == "X", 1, 0); 

     //Будем готовить данные для каждого портфеля отдельно, чтобы показывать индикатор
     InitProgress(cnt, "Идет подготовка данных...", "Подготовка данных");

     if(Data.SSPU == "X")
       InitProgress(-1, "Идет подготовка данных...", "Подготовка данных ССПУ_ЦБ");
       
       cmd = DL_RSDCommand("CALL RSB_REPRECLOTS.CreateAllData(?,?,1,0,0,0,0,0,0,?,?)");

       cmd.addParam(Data.RepDate );
       cmd.addParam(Data.AvrCode );
       cmd.addParam(m_SessionID );
       cmd.addParam(ParallelLevel);

       cmd.executeCMD();

       RemProgressBar;

       UseProgress(i = i + 1);
     end;

     if(Data.SSSD == "X")
       InitProgress(-1, "Идет подготовка данных...", "Подготовка данных СССД_ЦБ");
       
       cmd = DL_RSDCommand("CALL RSB_REPRECLOTS.CreateAllData(?,?,0,1,0,0,0,0,0,?,?)");

       cmd.addParam(Data.RepDate );
       cmd.addParam(Data.AvrCode );
       cmd.addParam(m_SessionID );
       cmd.addParam(ParallelLevel);

       cmd.executeCMD();

       RemProgressBar;

       UseProgress(i = i + 1);
     end;

     if(Data.ASCB == "X")
       InitProgress(-1, "Идет подготовка данных...", "Подготовка данных АС_ЦБ");
       
       cmd = DL_RSDCommand("CALL RSB_REPRECLOTS.CreateAllData(?,?,0,0,1,0,0,0,0,?,?)");

       cmd.addParam(Data.RepDate );
       cmd.addParam(Data.AvrCode );
       cmd.addParam(m_SessionID );
       cmd.addParam(ParallelLevel);

       cmd.executeCMD();

       RemProgressBar;

       UseProgress(i = i + 1);
     end;

     if(Data.BPP == "X")
       InitProgress(-1, "Идет подготовка данных...", "Подготовка данных БПП");
       
       cmd = DL_RSDCommand("CALL RSB_REPRECLOTS.CreateAllData(?,?,0,0,0,1,0,0,0,?,?)");

       cmd.addParam(Data.RepDate );
       cmd.addParam(Data.AvrCode );
       cmd.addParam(m_SessionID );
       cmd.addParam(ParallelLevel);

       cmd.executeCMD();

       RemProgressBar;

       UseProgress(i = i + 1);
     end;

     if(Data.PVO == "X")
       InitProgress(-1, "Идет подготовка данных...", "Подготовка данных ПВО");
       
       cmd = DL_RSDCommand("CALL RSB_REPRECLOTS.CreateAllData(?,?,0,0,0,0,1,0,0,?,?)");

       cmd.addParam(Data.RepDate );
       cmd.addParam(Data.AvrCode );
       cmd.addParam(m_SessionID );
       cmd.addParam(ParallelLevel);

       cmd.executeCMD();

       RemProgressBar;

       UseProgress(i = i + 1);
     end;

     if(Data.PKU == "X")
       InitProgress(-1, "Идет подготовка данных...", "Подготовка данных ПКУ");
       
       cmd = DL_RSDCommand("CALL RSB_REPRECLOTS.CreateAllData(?,?,0,0,0,0,0,1,0,?,?)");

       cmd.addParam(Data.RepDate );
       cmd.addParam(Data.AvrCode );
       cmd.addParam(m_SessionID );
       cmd.addParam(ParallelLevel);

       cmd.executeCMD();

       RemProgressBar;

       UseProgress(i = i + 1);
     end;

     if(Data.PDO == "X")
       InitProgress(-1, "Идет подготовка данных...", "Подготовка данных ПДО");
       
       cmd = DL_RSDCommand("CALL RSB_REPRECLOTS.CreateAllData(?,?,0,0,0,0,0,0,1,?,?)");

       cmd.addParam(Data.RepDate );
       cmd.addParam(Data.AvrCode );
       cmd.addParam(m_SessionID );
       cmd.addParam(ParallelLevel);

       cmd.executeCMD();

       RemProgressBar;

       UseProgress(i = i + 1);
     end;

     RemProgressBar;

     return true;
  END;

  PRIVATE macro GetSetBppDate(SumID)

    var Select, pmw;

    Select = DL_RSDCommand( " SELECT T.t_changedate " +
                            "   FROM (SELECT V.* FROM v_scwrthistex V " +
                            "          WHERE V.t_SumID = ?) T " +
                            "  WHERE T.t_instance = (SELECT Min (Vi.t_instance) " +
                            "                        FROM v_scwrthistex Vi " +
                            "                       WHERE Vi.t_sumid = T.t_sumid " +
                            "                         AND Vi.t_action = 50) "
                          );

    Select.addParam(SumID);
    pmw = Select.execute();

    if( pmw.MoveNext() )
        return SQL_ConvTypeDate(pmw.changedate);
    end;

    return date(0,0,0);

  end;

  /*заполнение данных по самой ц\б (части данных в LineSumm)*/
  PRIVATE MACRO FillAvrInfo(DataSet)
     var  avoir       = TRecHandler( "avoiriss" ),
          fiwarnt     = TBFile( "fiwarnts", "R", 1 );
     VAR  CoupDrawDate = "", DaysInYear, DaysInCoupon;

     LineSumm.ClearAvrInfo();
     LineSumm.FIID = DataSet.fiid;

     if( ПолучитьФинИн(LineSumm.FIID, fininstr, avoir) )
        InformUser( "Не могу получить ценную бумагу с кодом (FIID = " + string(LineSumm.FIID) + ")", true );
        return;
     end;

     /* Дата погашения купона
        Плановая дата погашения последнего купона выпуска ц/б сделки,
        максимальная из всех дат погашения купонов данного выпуска, но не
        превышающая отчетную дату (выводится только для облигаций) */
     /* Валюта номинала
        Букв. код валюты номинала */
     LineSumm.FaceValCcy = GetFinInstrCcy( fininstr.rec.FaceValueFI, true );
     
     /* Номинал за ед.
        Номинал ц/б в валюте номинала */
     LineSumm.FaceValue = ЧислоCЗаданнойТочностью( DoubleToMoney( GetFaceValue(fininstr.rec.FIID, Data.RepDate) ), 2);
     
     if(( FI_IsBond(fininstr.rec.FIID) ) AND ( FI_IsCouponAvoiriss(fininstr.rec.FIID) ))
        LineSumm.CoupDrawDate = GetCoupon_MaxDrDateOnFrDate( fininstr.rec.FIID, Data.RepDate );
        if( LineSumm.CoupDrawDate != ZeroDate )
           /*ставка дохода по купону*/
           fiwarnt.Clear();
           fiwarnt.rec.IsPartial   = UNSET_CHAR;
           fiwarnt.rec.FIID        = fininstr.rec.FIID;
           fiwarnt.rec.DrawingDate = LineSumm.CoupDrawDate;
           if( fiwarnt.GetLE() and 
               (fiwarnt.rec.IsPartial == UNSET_CHAR) and
               (fiwarnt.rec.FIID == fininstr.rec.FIID) and
               (fiwarnt.rec.DrawingDate == LineSumm.CoupDrawDate)
             ) 
              if(fiwarnt.rec.IncomeRate != 0) 
                 LineSumm.IncomeRate = fiwarnt.rec.IncomeRate;
              else
                /*Заполняется только для купонных облигаций - ставка по купону, действующему на отчетную дату. 
                  Если для купона, действующего на отчетную дату ставка  указана в справочнике, то выводится именно она. 
                  Если ставка не указана, то вычисляется ставка по купону в % годовых по формуле: 100%*B*C/(N*T), 
                  где B- количество дней в году, C - сумма купона, N -сумма номинала, действующего на дату погашения купона, 
                  T - длительность купона. Величины T и B вычисляются в соответствии с методом, указанным в справочнике ценных бумаг, 
                  в поле "Базис расчета НКД". Длительность купона = дата погашения купона - дата начала действия купона + 1*/
                 ПолучитьПараметрыБазисаРасчетаКупона(avoir.rec.NKDBase_Kind, fiwarnt.rec, Data.RepDate, DaysInYear, DaysInCoupon);

                 var FaceValue = DoubleToMoney(GetFaceValue(fininstr.rec.FIID,fiwarnt.rec.DrawingDate));
                 if( (FaceValue*DaysInCoupon) != 0  )
                    LineSumm.IncomeRate = 100.0 * DaysInYear * fiwarnt.rec.IncomeVolume / (FaceValue*DaysInCoupon);
                 else
                    LineSumm.IncomeRate = 0;
                 end;
                 LineSumm.IncomeRate = ЧислоCЗаданнойТочностью( DoubleToMoney( LineSumm.IncomeRate), 4);
              end;
           else
              LineSumm.IncomeRate   = "";
           end;
           LineSumm.CoupDrawDate = date_as_string(1, LineSumm.CoupDrawDate);
        else
           LineSumm.CoupDrawDate = "";
           LineSumm.IncomeRate   = "";
        end;
     else
        LineSumm.CoupDrawDate = "";
        LineSumm.IncomeRate   = "";
     end;      
     /* Дата погашения облигации
        Плановая дата погашения выпуска (выводится только для облигаций) */
     if( FI_IsBond(fininstr.rec.FIID) )
        LineSumm.DrawDate = date_as_string(1,fininstr.rec.DrawingDate);
        LineSumm.Issued = date_as_string(1,fininstr.rec.Issued);
     end;

     LineSumm.Issuer  = DataSet.IssShName;
     LineSumm.AvrType = DataSet.AvKindShName;
     LineSumm.AvrName = fininstr.rec.Name;
     LineSumm.LSIN    = avoir.rec.LSIN;
     LineSumm.ISIN    = avoir.rec.ISIN;       

     LineSumm.SumPrecision  = fininstr.rec.SumPrecision;
     LineSumm.FaceValueFI   = fininstr.rec.FaceValueFI;

     DL_GetObjAttrName( OBJTYPE_AVOIRISS, 13, DL_GetMainObjAttr(fininstr, 13, OBJTYPE_AVOIRISS), null, null, @LineSumm.QCategory );

  END;

  PRIVATE MACRO FillLineSumm(DataSet)
    LineSumm.Amount                   = DataSet.Amount;
    LineSumm.BuyCostCUR               = DataSet.BuyCostCUR;
    LineSumm.BuyCostNMN               = DataSet.BuyCostNMN;
    LineSumm.OutLay                   = DataSet.Outlay;
    LineSumm.NKDBuy                   = DataSet.NKDBuy;
    
    LineSumm.CostIn                   = DataSet.CostIn;
    LineSumm.CostInAcc                = DataSet.Account;
    LineSumm.CostInAccRest            = DataSet.CostInAccRest;
    LineSumm.CostInAccRestRUB         = DataSet.CostInAccRestRUB;

    LineSumm.OverAmount               = DataSet.OverAmount;
    LineSumm.OverAmountAcc            = DataSet.OverAmountAcc;
    LineSumm.OverAmountAccRest        = DataSet.OverAmountAccRest;
    LineSumm.OverAmountAccRestRUB     = DataSet.OverAmountAccRestRUB;

    LineSumm.Income                   = DataSet.Income;
    LineSumm.IncomeAcc                = DataSet.IncomeAcc;
    LineSumm.IncomeAccRest            = DataSet.IncomeAccRest;
    LineSumm.IncomeAccRestRUB         = DataSet.IncomeAccRestRUB;
    
    LineSumm.Discount                 = DataSet.Discount;
    LineSumm.DiscountAcc              = DataSet.DiscountAcc;
    LineSumm.DiscountAccRest          = DataSet.DiscountAccRest;
    LineSumm.DiscountAccRestRUB       = DataSet.DiscountAccRestRUB;

    LineSumm.BonusRest                = DataSet.BonusRest;
    LineSumm.BonusRestAcc             = DataSet.BonusRestAcc;
    LineSumm.BonusRestAccRest         = DataSet.BonusRestAccRest;
    LineSumm.BonusRestAccRestRUB      = DataSet.BonusRestAccRestRUB;

    LineSumm.ReserveSum               = DataSet.ReserveSum;
    LineSumm.ReserveSumAcc            = DataSet.ReserveSumAcc;
    LineSumm.ReserveSumAccRest        = DataSet.ReserveSumAccRest;
    LineSumm.ReserveSumAccRestRUB     = DataSet.ReserveSumAccRestRUB;

    LineSumm.PDD_ReserveSum           = DataSet.PDD_ReserveSum;
    LineSumm.PDD_ReserveSumAcc        = DataSet.PDD_ReserveSumAcc;
    LineSumm.PDD_ReserveSumAccRest    = DataSet.PDD_ReserveSumAccRest;
    LineSumm.PDD_ReserveSumAccRestRUB = DataSet.PDD_ReserveSumAccRestRUB;

    LineSumm.CorrSum                  = DataSet.CorrSum;       
    LineSumm.CorrAcc                  = DataSet.CorrAcc;       
    LineSumm.CorrAccRest              = DataSet.CorrAccRest;   
    LineSumm.CorrAccRestRUB           = DataSet.CorrAccRestRUB;

    LineSumm.CorrEstReserveSum        = DataSet.CorrEstReserveSum;       
    LineSumm.CorrEstReserveAcc        = DataSet.CorrEstReserveAcc;       
    LineSumm.CorrEstReserveAccRest    = DataSet.CorrEstReserveAccRest;   
    LineSumm.CorrEstReserveAccRestRUB = DataSet.CorrEstReserveAccRestRUB;

    LineSumm.UNKDSum                  = DataSet.UNKDSum;       
    LineSumm.UNKDAcc                  = DataSet.UNKDAcc;       
    LineSumm.UNKDAccRest              = DataSet.UNKDAccRest;   
    LineSumm.UNKDAccRestRUB           = DataSet.UNKDAccRestRUB;

    LineSumm.CourseCBRF               = DataSet.CourseCBRF;    
    LineSumm.DateCourseCBRF           = date(DataSet.DateCourseCBRF);

    LineSumm.BPP_OverAmount           = DataSet.BPP_OverAmount;
    LineSumm.BPP_CorrSum              = DataSet.BPP_CorrSum;
    LineSumm.BPP_CorrEstReserveSum    = DataSet.BPP_CorrEstReserveSum;
    LineSumm.Portfolio                = DataSet.PortfID;
  END;                                                                                                                                                                  

  PRIVATE MACRO PrintData(ObjReport:OBJECT)
     var Query, Select, DataSet, Nrec, count, IsLinePrint = false;

     SetActiveSheet( "Сверка лотов и БУ" );
     ObjReport.BeginReport();

     InitProgress(-1, StatLine, "Выборка данных");

     Query =   " select q.*, "
             + "        (case when q.t_PortfID = "+PortfID_Back+" THEN 'на основном' ELSE NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_OverAmountAccID), CHR(1)) END) as OverAmountAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_IncomeAccID), CHR(1))         as IncomeAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_BonusRestAccID), CHR(1))      as BonusRestAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_DiscountAccID), CHR(1))       as DiscountAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_CorrAccID), CHR(1))           as CorrAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_ReserveSumAccID), CHR(1))     as ReserveSumAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_PDD_ReserveSumAccID), CHR(1)) as PDD_ReserveSumAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_CorrEstReserveAccID), CHR(1)) as CorrEstReserveAcc, "
             + "        NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = q.t_UNKDAccID), CHR(1))           as UNKDAcc "
             + "   from (select rep.*, "
             + "                pt.t_ShortName as IssShName, "
             + "                avrk.t_ShortName as AvKindShName, "
             + "                NVL((select acc.t_Account from daccount_dbt acc where acc.t_AccountID = rep.t_CostInAccID), CHR(1))  as t_Account "
             + "           from drepreclots_dbt rep, dfininstr_dbt fin, davrkinds_dbt avrk, dparty_dbt pt "
             + "          where rep.t_SessionID = ? "
             + "            and fin.t_FIID       = rep.t_FIID "
             + "            and avrk.t_FI_Kind   = fin.t_FI_Kind "
             + "            and avrk.t_AvoirKind = fin.t_AvoirKind "
             + "            and pt.t_PartyID     = RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) "
             + "        ) q "
             + "  order by q.t_PortfID, q.IssShName, q.AvKindShName, q.t_FIID, q.t_account";

     Select = DL_RSDCommand(Query);

     Select.AddParam(m_SessionID);
     Select.AddParam(Data.RepDate);
     
     Nrec = Select.GetCount();

     RemProgress();
     if(Nrec > 0)
       InitProgressBar( ToInt(Nrec), StatLine, "Обработка отобранных данных" );

       DataSet = Select.Execute();

       LineSumm.ClearAvrInfo();
       LineSumm.ClearSum();
       while(DataSet.MoveNext() )
          UseProgressBar;
          if( m_PrevPortf != DataSet.PortfID )
             if( IsLinePrint )
                ObjReport.PrintTableLine();
             end;
             ObjReport.PrintHeadLine(Data.PortfNameArray[DataSet.PortfID]);
             LineSumm.ClearSum();
          elif( (LineSumm.FIID != DataSet.FIID) or (m_PrevAccount != DataSet.Account ) )
             if( IsLinePrint )
                ObjReport.PrintTableLine();
             end;
             LineSumm.ClearSum();
          end;

          if( LineSumm.FIID != DataSet.fiid )
             FillAvrInfo(DataSet);
          end;

          FillLineSumm(DataSet);

          m_PrevFiid     = DataSet.FIID;
          m_PrevPortf    = DataSet.PortfID;
          m_PrevAccount  = DataSet.Account;

          IsLinePrint = true;
       end;
       RemProgressBar;

       if( IsLinePrint )
          ObjReport.PrintTableLine();
          ObjReport.EndReport();
       end;
     end;
  END;                                                                                                                                                                         

  PRIVATE MACRO ExecuteReport(ObjReport:OBJECT)
     m_H1 = m_H2 = null;

     if( not CollectData() )
        msgbox("Нет данных для формирования отчета");
        return;
     end;

     PrintData(ObjReport);

     var i:integer = 0;
     while( i < Data.UniqStr.Size )
       msgbox( Data.UniqStr.(i) );
       i = i + 1;
     end;


     var ProtocolSelect = DL_RSDCommand("SELECT DISTINCT t_Message FROM DARNUREPERR_DBT WHERE t_SessionID = ? ");
     ProtocolSelect.AddParam(m_SessionID);
     var ProtocolDS = ProtocolSelect.execute();
     while(ProtocolDS.MoveNext())
       msgbox(ProtocolDS.Message);
     end;

  END;

  PRIVATE MACRO Create()
     var cmd = DL_RSDCommand("DELETE FROM DARNUREPERR_DBT WHERE t_SessionID = ?");
     cmd.AddParam(m_SessionID);
     cmd.executeCMD();

     cmd = DL_RSDCommand("DELETE FROM DREPRECLOTS_DBT WHERE t_SessionID = ?");
     cmd.AddParam(m_SessionID);
     cmd.executeCMD();

     ExecuteReport(CRecLOts(this));

     cmd = DL_RSDCommand("DELETE FROM DARNUREPERR_DBT WHERE t_SessionID = ?");
     cmd.AddParam(m_SessionID);
     cmd.executeCMD();

     cmd = DL_RSDCommand("DELETE FROM DREPRECLOTS_DBT WHERE t_SessionID = ?");
     cmd.AddParam(m_SessionID);
     cmd.executeCMD();
  END;

  MACRO H1()
     if( Data.AvrCode <= 0 )
        return "Все";
     end;
                                  
     if( m_H1 == null )
       m_H1 = m_H2 = "";
       if( ПолучитьФинИн(Data.AvrCode, fininstr) == 0 )
          m_H1 = fininstr.rec.FI_CODE;
          m_H2 = fininstr.rec.NAME;
       end;
     end;
     return m_H1;
  END;

  MACRO H2()
     if( Data.AvrCode <= 0 )
        return "";
     end;

     if( m_H2 == null )
       m_H1 = m_H2 = "";
       if( ПолучитьФинИн(Data.AvrCode, fininstr) == 0 )
          m_H1 = fininstr.rec.FI_CODE;
          m_H2 = fininstr.rec.NAME;
       end;
     end;
     return m_H2;
  END;

  MACRO Issuer()
     return LineSumm.Issuer;
  END;

  MACRO AvrName()
     return LineSumm.AvrName;
  END;

  MACRO AvrType()
     return LineSumm.AvrType;
  END;

  MACRO LSIN()
     return LineSumm.LSIN;
  END;

  MACRO ISIN()
     return LineSumm.ISIN;
  END;

  MACRO Issued()
     return LineSumm.Issued;
  END;

  MACRO DrawDate()
     return LineSumm.DrawDate;
  END;

  MACRO CoupDrawDate()
     return LineSumm.CoupDrawDate;
  END;

  MACRO FaceValue()
     return LineSumm.FaceValue;
  END;

  MACRO FaceValCcy()
     return LineSumm.FaceValCcy;
  END;

  MACRO Amount()
     return LineSumm.Amount;
  END;

  MACRO SumPrecision():integer
     return LineSumm.SumPrecision;
  end;

  MACRO IncomeRate()
     return LineSumm.IncomeRate;
  END;

  MACRO BuyCostCUR()
    if(LineSumm.BuyCostCUR)
      return LineSumm.BuyCostCUR;
    end;
    return "";
  END;

  MACRO BuyCostNMN()
    if(LineSumm.BuyCostNMN)
      return LineSumm.BuyCostNMN;
    end;
    return "";
  END;

  MACRO Outlay()
     if( LineSumm.OutLay )
        return LineSumm.OutLay;
     end;
     return "";
  END;

  MACRO NKDBuy()
     if( LineSumm.NKDBuy )
        return LineSumm.NKDBuy;
     end;
     return "";
  END;

  MACRO CostIn()
     return LineSumm.CostIn;
  END;

  MACRO CostInAcc():string
     return LineSumm.CostInAcc;
  END;

  MACRO CostInAccRest()
     if( CostInAcc() == "" )
        return 0;
     end;
     return LineSumm.CostInAccRest;
  END;

  MACRO CostInAccRestRUB()
     return LineSumm.CostInAccRestRUB;
  END;

  MACRO CostInDelta()
     if( CostInAcc() == "" )
        return "";
     end;
     return CostIn() - CostInAccRest();
  END;

  MACRO OverAmount()
     if( LineSumm.OverAmount )
        return LineSumm.OverAmount;
     end;
     return "";
  END;

  MACRO OverAmountAcc():string
     if( LineSumm.OverAmountAcc == null )
        return "";
     end;
     return LineSumm.OverAmountAcc;
  END;

  MACRO OverAmountAccRest()
     if( (OverAmountAcc() == "") OR (OverAmountAcc() == "на основном") )
        return "";
     end;

     if(LineSumm.Portfolio == PortfID_Unadmitted) // Для БПП выводим данные по лотам
        return abs(OverAmount());
     end;

     return double(LineSumm.OverAmountAccRest) - abs(LineSumm.BPP_OverAmount);
  END;

  MACRO OverAmountAccRestRUB()
     return OverAmountAccRest(); // переоценка в рублях, поэтому не конвертируем
  END;

  MACRO OverAmountDelta()
     if( (OverAmount() == "") AND (OverAmountAccRest() == "") )
        return "";
     end;

     if(LineSumm.Portfolio == KINDPORT_BACK)
        return 0;
     end;

     return abs(LineSumm.OverAmount) - abs(double(OverAmountAccRest()));
  END;

  MACRO Income()
     if( LineSumm.Income )
        return LineSumm.Income;
     end;
     return "";
  END;

  MACRO IncomeAcc():string
     if( LineSumm.IncomeAcc == null )
        return "";
     end;
     return LineSumm.IncomeAcc;
  END;

  MACRO IncomeAccRest()
     if( IncomeAcc() == "" )
        return "";
     end;
     return LineSumm.IncomeAccRest;
  END;

  MACRO IncomeAccRestRUB()
     if( IncomeAcc() == "" )
        return "";
     end;
     return LineSumm.IncomeAccRestRUB;
  END;

  MACRO IncomeDelta()
     if( (Income() == "") AND (IncomeAccRest() == "") )
        return "";
     end;
     return LineSumm.Income - LineSumm.IncomeAccRest;
  END;

  MACRO BonusRest()
     if( LineSumm.BonusRest )
        return LineSumm.BonusRest;
     end;
     return "";
  END;

  MACRO BonusRestAcc():string
     if( LineSumm.BonusRestAcc == null )
        return "";
     end;
     return LineSumm.BonusRestAcc;
  END;

  MACRO BonusRestAccRest()
     if( BonusRestAcc() == "" )
        return "";
     end;
     return LineSumm.BonusRestAccRest;
  END;

  MACRO BonusRestAccRestRUB()
     if( BonusRestAcc() == "" )
        return "";
     end;
     return LineSumm.BonusRestAccRestRUB;
  END;

  MACRO BonusRestDelta()
     var _BonusRest = 0, _BonusRestAccRest = 0;

     if( BonusRest() != "" )
        _BonusRest = BonusRest();
     end;

     if( BonusRestAccRest() != "" )
        _BonusRestAccRest = BonusRestAccRest();
     end;

     if( (BonusRest() == "") and (BonusRestAccRest() == "") )
        return "";
     end;

     return _BonusRest - _BonusRestAccRest;
  END;

  MACRO Discount()
     if( LineSumm.Discount )
        return LineSumm.Discount;
     end;
     return "";
  END;

  MACRO DiscountAcc():string
     if( LineSumm.DiscountAcc == null )
        return "";
     end;
     return LineSumm.DiscountAcc;
  END;

  MACRO DiscountAccRest()
     if( DiscountAcc() == "" )
        return "";
     end;
     return LineSumm.DiscountAccRest;
  END;

  MACRO DiscountAccRestRUB()
     if( DiscountAcc() == "" )
        return "";
     end;
     return LineSumm.DiscountAccRestRUB;
  END;

  MACRO DiscountDelta()
     if( (Discount() == "") AND (DiscountAccRest() == "") )
        return "";
     end;
     return LineSumm.Discount - LineSumm.DiscountAccRest;
  END;

  MACRO QCategory():string
     return LineSumm.QCategory;
  END;

  MACRO ReserveSum()
     if( LineSumm.ReserveSum )
        return LineSumm.ReserveSum;
     end;
     return "";
  END;

  MACRO ReserveSumAcc():string
     if( LineSumm.ReserveSumAcc == null )
        return "";
     end;
     return LineSumm.ReserveSumAcc;
  END;

  MACRO ReserveSumAccRest()
     if( ReserveSumAcc() == "" )
        return "";
     end;
     return LineSumm.ReserveSumAccRest;
  END;

  MACRO ReserveSumAccRestRUB()
     if( ReserveSumAcc() == "" )
        return "";
     end;
     return LineSumm.ReserveSumAccRestRUB;
  END;

  MACRO ReserveSumDelta()
     if( (ReserveSum() == "") AND (ReserveSumAccRest() == "") )
        return "";
     end;
     return LineSumm.ReserveSum - LineSumm.ReserveSumAccRest;
  END;

  MACRO PDD_ReserveSum()
     if( LineSumm.PDD_ReserveSum )
        return LineSumm.PDD_ReserveSum;
     end;
     return "";
  END;

  MACRO PDD_ReserveSumAcc():string
     if( LineSumm.PDD_ReserveSumAcc == null )
        return "";
     end;
     return LineSumm.PDD_ReserveSumAcc;
  END;

  MACRO PDD_ReserveSumAccRest()
     if( PDD_ReserveSumAcc() == "" )
        return "";
     end;
     return LineSumm.PDD_ReserveSumAccRest;
  END;

  MACRO PDD_ReserveSumAccRestRUB()
     if( PDD_ReserveSumAcc() == "" )
        return "";
     end;
     return LineSumm.PDD_ReserveSumAccRestRUB;
  END;


  MACRO PDD_ReserveSumDelta()
     if( (PDD_ReserveSum() == "") AND (PDD_ReserveSumAccRest() == "") )
        return "";
     end;
     return LineSumm.PDD_ReserveSum - LineSumm.PDD_ReserveSumAccRest;
  END;

  MACRO CorrSum()
     if( LineSumm.CorrSum )
        return LineSumm.CorrSum;
     end;
     return "";
  END;

  MACRO CorrAcc():string
     if( LineSumm.CorrAcc == null )
        return "";
     end;
     return LineSumm.CorrAcc;
  END;

  MACRO CorrAccRest()
     if( CorrAcc() == "" )
        return "";
     end;

     if(LineSumm.Portfolio == PortfID_Unadmitted) // Для БПП выводим данные по лотам
        return abs(CorrSum());
     end;

     return LineSumm.CorrAccRest - abs(LineSumm.BPP_CorrSum);
  END;

  MACRO CorrAccRestRUB()
     return CorrAccRest();  // корректировка в рублях, поэтому не конвертируем
  END;

  MACRO CorrDelta()
     if( (CorrSum() == "") AND (CorrAccRest() == "") )
        return "";
     end;
     return abs(LineSumm.CorrSum) - CorrAccRest();
  END;

  MACRO CorrEstReserveSum()
     if( LineSumm.CorrEstReserveSum )
        return LineSumm.CorrEstReserveSum;
     end;
     return "";
  END;

  MACRO CorrEstReserveAcc():string
     if( LineSumm.CorrEstReserveAcc == null )
        return "";
     end;
     return LineSumm.CorrEstReserveAcc;
  END;

  MACRO CorrEstReserveAccRest()
     if( CorrEstReserveAcc() == "" )
        return "";
     end;

     if(LineSumm.Portfolio == PortfID_Unadmitted)
        return abs(CorrEstReserveSum());
     end;

     return LineSumm.CorrEstReserveAccRest - abs(LineSumm.BPP_CorrEstReserveSum);
  END;

  MACRO CorrEstReserveAccRestRUB()
     return CorrEstReserveAccRest();  // корректировка в рублях, поэтому не конвертируем
  END;

  MACRO CorrEstReserveDelta()
     if( (CorrEstReserveSum() == "") AND (CorrEstReserveAccRest() == "") )
        return "";
     end;
     return abs(LineSumm.CorrEstReserveSum) - CorrEstReserveAccRest();
  END;

  MACRO CourseCBRF()
     return double(LineSumm.CourseCBRF);
  END;

  MACRO DateCourseCBRF()
    if(date(LineSumm.DateCourseCBRF) > date(0,0,0))
      return date(LineSumm.DateCourseCBRF);
    end;
    return "";
  END;

  MACRO UNKDSum()
    return NKDBuy;
  END;

  MACRO UNKDAcc():string
     if( LineSumm.UNKDAcc == "")
        return "";
     end;
     return LineSumm.UNKDAcc;
  END;

  MACRO UNKDAccRest()
     if (( LineSumm.UNKDAccRest == "") OR ( LineSumm.UNKDAccRest == 0))
        return "";
     end;
     return LineSumm.UNKDAccRest;
  END;

  MACRO UNKDAccRestRUB()
     if (( LineSumm.UNKDAccRestRUB == "") OR ( LineSumm.UNKDAccRestRUB == 0))
        return "";
     end;
     return LineSumm.UNKDAccRestRUB;
  END;

  MACRO UNKDDelta()
     var clop = abs(LineSumm.NKDBuy) - LineSumm.UNKDAccRest;

     if(LineSumm.Portfolio == KINDPORT_BACK)
        clop = 0;
     end;
     
     if( clop == 0 )
        return 0;
     end;
     return clop;
  END;
  
  initDL_CReportTemplate( NULL, "Report_reclots.xls" );
END;

macro MakeReports()
  Dl_CallInsertStat(DL_OUTREPORT_EXCEL);
  while(m_Form.Run())
     UpdateFormFields();
     if( (not Data.SSPU) AND  
         (not Data.SSSD) AND  
         (not Data.ASCB) AND
         (not Data.BPP) AND 
         (not Data.PVO) AND 
         (not Data.PKU) AND 
         (not Data.PDO)
       )
       msgbox("В параметрах фильтра отчета не выбран ни один из портфелей");
       continue;
     end;
     SP_RecLOts_Report().Run();
  end;
end; 

MakeReports();
exit(1);
