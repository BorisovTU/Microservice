/*
 $Name: nptxcrnset008.mac
 $Module: Ценные бумаги
 $Description: Соглашение об урегулировании претензий. Шаг "Пересчет СНОБ"
 */
import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(nptxop, ID_Operation, ID_Step)
  var nptxop_new = TRecHandler( "nptxop" );
  var RefID;
  var err = 0;

  nptxop_new.Clear();

  GenerateNumberByReference( OBJTYPE_NPTXRECALCTB, 1 /*REFOBJ_RECALCTBOP*/, @RefID, @nptxop_new.rec.Code );
    
  nptxop_new.rec.DocKind           = DL_NPTXRECALCTB;
  nptxop_new.rec.OperDate          = nptxop.rec.OperDate;
  nptxop_new.rec.Department        = {OperDprt};
  nptxop_new.rec.Oper              = nptxop.rec.Oper;
  nptxop_new.rec.Status            = 0/*DL_TXOP_Prep*/;
  nptxop_new.rec.Recalc            = UNSET_CHAR;
  nptxop_new.rec.FIID              = ALLFININSTR;
  nptxop_new.rec.Client            = nptxop.rec.Client;

  nptxop_new.rec.Kind_Operation    = 2043;//Пересчет СНОБ

  if ( not CreateNptxOpStep(nptxop_new, true))
    err = 1;
  end;

  if(not err)
    var StartSTBDate = GetStartSTBDate();
    if((nptxop.rec.CalcNDFL == SET_CHAR) and (РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ()) and (StartSTBDate > date(0,0,0)) and (nptxop.rec.OperDate >= StartSTBDate))
       if( not InsertOprStatus(46481, 8)) //Запрос СНОБ
         return Error( "Ошибка при установке статуса вида \"Запрос СНОБ\" операции" );        
       end;
    else
      if(nptxop.rec.CalcNDFL == SET_CHAR)
        if( not InsertOprStatus(46481, 2)) //Расчет НДФЛ
          return Error( "Ошибка при установке статуса вида \"Расчет НДФЛ\" операции" );        
        end;
      else
        if( not InsertOprStatus(46481, 4)) //Формирование проводок
          return Error( "Ошибка при установке статуса вида \"Формирование проводок\" операции" );        
        end;
      end;
    end;
  end;

  return err;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  var nptxop = TRecHandler("nptxop.dbt");
  var err = 0;

  SetBuff( nptxop, FDoc );

  err = RunAction(nptxop, ID_Operation, ID_Step);

  DL_NPTX_SaveOperLog(nptxop.rec.ID, 8);

  return err;
end;