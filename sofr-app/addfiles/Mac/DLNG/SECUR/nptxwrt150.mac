/**
  @file: 		mac\dlng\secur\nptxwrt150.mac
  @brief: 		Шаг 1: Проверка суммы зачисления, блок 203712
    # menu 
  - БО ЦБ\Сервисные операции\Операция списания и зачисления денежных средств

  # changelog
  |date       |author         |tasks                                       |note                                                        
  |-----------|---------------|--------------------------------------------|-------------------------------------------------------------
  |2025.10.10 |Васильев Н.А.  |AVT_BOSS-104                                | 
*/

import oralib, "dlquery.mac", "mmlib.mac";

private macro getId(ID_Operation, FDoc)
         var cmd = DL_RSDCommand("SELECT to_number(TRIM(t_documentid)) as id FROM doproper_dbt p  JOIN dnptxop_dbt n " +
                                 "ON n.t_id = TO_NUMBER(TRIM(p.t_documentid)) "+
                                 "WHERE p.t_id_operation = ?  AND p.t_dockind = ?;");
         cmd.AddParam(ID_Operation);
         cmd.AddParam(FDoc);
         var DataSet = cmd.Execute();
         while (DataSet.moveNext())
          return SQL_ConvTypeInteger(DataSet.id);
         end;
    return 0;
end;

private macro getValue(path)
  var rs, cmd, str;
    str = "SELECT IT_RS_INTERFACE.GET_PARM_NUMBER_PATH(?) AS t_val FROM dual";
    cmd = RSDCommand(str);
    cmd.AddParam("1", RSDBP_IN, path);
    rs = RSdRecordSet(cmd);
    if(rs.Movenext)
      return rs.value("t_val");
    end;
end;

MACRO ExecuteStep(kind_oper, DocKind, FDoc, ID_Operation, ID_Step )
  var err = "";
  var MaxSum = 0;

    if( {oper} == 9997) 
          MaxSum = getValue("РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\Контрольная сумма по РК");
          var cmd = DL_RSDCommand("SELECT n.t_outsum as sum FROM doproper_dbt p  JOIN dnptxop_dbt n " +
                                  "ON n.t_id = TO_NUMBER(TRIM(p.t_documentid)) "+
                                  "WHERE p.t_id_operation = ?  AND p.t_dockind = ?;");
          cmd.AddParam(ID_Operation);
          cmd.AddParam(FDoc);
          var DataSet = cmd.Execute();
          if (DataSet.MoveNext())
              if (DataSet.sum > MaxSum)
                    MsgBox("Сумма зачисления " + DataSet.sum + "в операции '" + getId(ID_Operation, FDoc) + "' превышает контрольную сумму " + MaxSum + ".");
                    return 1; 
              end;
          end;
          return 0;  
    end;   
  return 0;
end;