/*
$Name:        clopord.mac
$Module:      Ÿ¤à® Securities
$Description: Žâç¥âë ¯® ®¯¥à æ¨ï¬ ª«¨¥­â 
*/
import "spRepFn2.mac", "dl_class.mac", "DLReport_h.mac", "DLRepForm_h.mac", "dldlngfun.mac", "dlquery.mac";
import RsbDataSet;

private var clopord;

private var CLOPERORDER = 0,        /*Žâç¥â ¯® ®¯¥à æ¨ï¬ ª«¨¥­â */
            CLSTATUSACCOUNTORD = 1, /*Žâç¥âë ® á®áâ®ï­¨¨ áç¥â®¢ ª«¨¥­â */
            CLSTATUSACCOUNTORD_SMPL = 2;  /*ˆ­ä®à¬ æ¨ï ®¡ ®áâ âª å áç¥â®¢ ª«¨¥­â (ã¯à®é¥­­ë© ¢¨¤)*/
private var REP_PERIOD = -1,  /*‡  ¯¥à¨®¤*/
            REP_MONTH = 1,    /*Žâç¥â §  ¬¥áïæ*/
            REP_QUARTAL = 2;  /*Žâç¥â §  ª¢ àâ «*/

private var STAT_ALL         = -1, /*‚á¥ áâ âãáë*/
            STAT_FINISHED    = 1,  /*‡ ¢¥àè¥­­ë¥*/
            STAT_NOTFINISHED = 2,  /*¥§ ¢¥àè¥­­ë¥*/
            STAT_CONCLUSION  = 3,  /*‡ ª«îç¥­­ë¥*/
            STAT_NOTACC = 5;  

private var KA_BEGIN_SECOND_PART = 315;  /*‚¨¤ è £  ¨­¨æ¨ «¨§ æ¨ï 2-®© ç áâ¨*/
private const
   StatLine = "Žâç¥â ¯® ®¯¥à æ¨ï¬ ª«¨¥­â ";

private const OUTMARKETPLACE = "‚­¥¡¨à¦¥¢®© àë­®ª";

private const Œ…‘’Ž_ƒŽ_ˆ = "";
private const PLACE_GO = 999999;

private var {OperDprt};

class SourceData( _DprtID: integer, _ClientID: integer,
                  _IsFormID:integer, _FormSubID:integer, _IsVidID:integer, _VidSubID:integer, _NoResident:bool,
                  _SfContrID:integer, _PeriodNum:integer, _IsPrognos:bool,
                  _DateBegin: date, _DateEnd: date, _IsSeparatelyDate: bool,
                  _OrdClntAccount: bool, _OrdClntAccSmpl: bool, _OrdClntOper: bool,
                  _OperState:integer, _IncGO_IN, _Totals, _IsApp: bool, _IsExcel: bool )


  var DprtID         = _DprtID,        /*”¨«¨ «*/
      ClientID       = _ClientID,      /*Š«¨¥­â*/
      IsFormID       = _IsFormID, 
      FormSubID      = _FormSubID,
      IsVidID        = _IsVidID,
      VidSubID       = _VidSubID,
      NoResident     = _NoResident,
      ContrID        = _SfContrID,     /*„®£®¢®à ®¡á«ã¦¨¢ ­¨ï ª«¨¥­â */
      PeriodNum      = _PeriodNum,     /*‚¨¤ ¯¥à¨®¤  ¢ë¯ãáª  ®âç¥â */
      DateBegin      = _DateBegin,     /*¨¦­ïï ¤ â */
      DateEnd        = _DateEnd,       /*‚¥àå­ïï ¤ â */
      IsSeparatelyDate = _IsSeparatelyDate, /*Žâ¤¥«ì­® §  ª ¦¤ãî ¤ âã*/
      OrdClntOper    = _OrdClntOper,   /*”« £ ¢ë¯ãáª  ®âç¥â  ¯® ®¯¥à æ¨ï¬ ª«¨¥­â  */
      OrdClntAccount = _OrdClntAccount,/*”« £ ¢ë¯ãáª  ®âç¥â  ¯® áç¥â ¬ ª«¨¥­â */
      OrdClntAccSmpl = _OrdClntAccSmpl,/*”« £ ¢ë¯ãáª  ®âç¥â  ¯® áç¥â ¬ ª«¨¥­â (ã¯à®é¥­­ë© ¢¨¤)*/
      OperState      = _OperState,     /*‘â âãá ®¯¥à æ¨¨*/
      IncGO_IN       = _IncGO_IN,      /*¯à¨§­ ª ®â¡®à  ƒŽ ¨ ˆ*/
      Totals         = _Totals,        /*‚ë¢®¤¨âì ¨â®£¨ ¯® ®¯¥à æ¨ï¬ */
      IsApp          = _IsApp,         /*‘  ¯®áâà®ä ¬¨*/
      IsExcel        = _IsExcel,       /*¢ excel?*/
      FirstSheet,
      IsPrognos      = _IsPrognos;     // à®£­®§

  var ReportRun    = false;

    var
      ShowDealChange = GetOption_ShowDealChange;

end;

var TableHead1 = "ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                 "³          ³          ³       ³               ³               ³                ³       ³              ³             ³              ³             ³               ³               ³        ³       ³         ³        ³          ³          ³ áå®¤ë  ³               ³                ³              ³\n"+
                 "³     ü    ³   „ â    ³       ³      ‚¨¤      ³       ü       ³                ³       ³  ISIN/ü      ³             ³              ³             ³               ³               ³        ³       ³         ³ ‚ «îâ  ³Ž¯« ç¥­­ ï³Ž¯« ç¥­­ ï³¡ ­ª  ª  ³ „ â  ¯®áâ ¢ª¨ ³      „ â       ³     Žâª §    ³\n"+
                 "³ ®¯¥à æ¨¨ ³á®¢¥àè¥­¨ï³ ‚à¥¬ï ³    ®¯¥à æ¨¨   ³   ¯®àãç¥­¨ï   ³     ¬¨â¥­â    ³‚¨¤ æ/¡³£®áà¥£¨áâà æ¨¨³    C¥à¨ï    ³    ‚ë¯ãáª    ³    ’à ­è    ³      –¥­      ³  ‚ «îâ  æ¥­ë  ³ Š®«-¢® ³ ‘ã¬¬  ³   Š„   ³  Š„   ³ª®¬¨áá¨ï  ³ª®¬¨áá¨ï  ³¢®§¬¥é¥  ³       æ/¡     ³     ®¯« âë     ³              ³\n"+
                 "³          ³          ³       ³               ³               ³                ³       ³              ³             ³              ³             ³               ³               ³        ³  ¢ ‚– ³         ³        ³¡¨à¦¨/    ³¡ ­ª      ³­¨î      ³   ¯« ­/ä ªâ   ³    ¯« ­/ä ªâ   ³              ³\n"+
                 "³          ³          ³       ³               ³               ³                ³       ³              ³             ³              ³             ³               ³               ³        ³       ³         ³        ³¡à®ª¥à    ³          ³ª«¨¥­â®¬ ³               ³                ³              ³\n"+
                 "ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

var TableHeadProg1 = "ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                     "³          ³à®£­®§³          ³       ³               ³               ³                ³       ³              ³             ³              ³             ³               ³               ³        ³       ³         ³        ³          ³          ³ áå®¤ë  ³               ³                ³              ³\n"+
                     "³     ü    ³       ³   „ â    ³       ³      ‚¨¤      ³       ü       ³                ³       ³  ISIN/ü      ³             ³              ³             ³               ³               ³        ³       ³         ³ ‚ «îâ  ³Ž¯« ç¥­­ ï³Ž¯« ç¥­­ ï³¡ ­ª  ª  ³ „ â  ¯®áâ ¢ª¨ ³      „ â       ³     Žâª §    ³\n"+
                     "³ ®¯¥à æ¨¨ ³       ³á®¢¥àè¥­¨ï³ ‚à¥¬ï ³    ®¯¥à æ¨¨   ³   ¯®àãç¥­¨ï   ³     ¬¨â¥­â    ³‚¨¤ æ/¡³£®áà¥£¨áâà æ¨¨³    C¥à¨ï    ³    ‚ë¯ãáª    ³    ’à ­è    ³      –¥­      ³  ‚ «îâ  æ¥­ë  ³ Š®«-¢® ³ ‘ã¬¬  ³   Š„   ³  Š„   ³ª®¬¨áá¨ï  ³ª®¬¨áá¨ï  ³¢®§¬¥é¥  ³       æ/¡     ³     ®¯« âë     ³              ³\n"+
                     "³          ³       ³          ³       ³               ³               ³                ³       ³              ³             ³              ³             ³               ³               ³        ³  ¢ ‚– ³         ³        ³¡¨à¦¨/    ³¡ ­ª      ³­¨î      ³   ¯« ­/ä ªâ   ³    ¯« ­/ä ªâ   ³              ³\n"+
                     "³          ³       ³          ³       ³               ³               ³                ³       ³              ³             ³              ³             ³               ³               ³        ³       ³         ³        ³¡à®ª¥à    ³          ³ª«¨¥­â®¬ ³               ³                ³              ³\n"+
                     "ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

var TableHead2 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                 "³    „ â     ³             ¨¬¥­®¢ ­¨¥            ³        ‚¨¤        ³  ü á¤¥«ª¨/        ³           ³           ³\n"+
                 "³  à áç¥â­®© ³            à áç¥â­®©               ³      ®¯¥à æ¨¨     ³   ®¯¥à æ¨¨ á æ/¡  ³ ‡ ç¨á«¥­¨¥³ ‘¯¨á ­¨¥  ³\n"+
                 "³  ®¯¥à æ¨¨  ³            ®¯¥à æ¨¨                ³                   ³                   ³    (èâ.)  ³  (èâ.)    ³\n"+
                 "ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´";
var TableHeadProg2 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                     "³    „ â     ³à®£­®§³             ¨¬¥­®¢ ­¨¥            ³        ‚¨¤        ³  ü á¤¥«ª¨/        ³           ³           ³\n"+
                     "³  à áç¥â­®© ³       ³            à áç¥â­®©               ³      ®¯¥à æ¨¨     ³   ®¯¥à æ¨¨ á æ/¡  ³ ‡ ç¨á«¥­¨¥³ ‘¯¨á ­¨¥  ³\n"+
                     "³  ®¯¥à æ¨¨  ³       ³            ®¯¥à æ¨¨                ³                   ³                   ³    (èâ.)  ³  (èâ.)    ³\n"+
                     "ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´";

var TableHead3 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                 "³    „ â     ³             ¨¬¥­®¢ ­¨¥            ³        ‚¨¤        ³  ü á¤¥«ª¨/        ³           ³           ³\n"+
                 "³  à áç¥â­®© ³            à áç¥â­®©               ³      ®¯¥à æ¨¨     ³   ®¯¥à æ¨¨ á æ/¡  ³ ‡ ç¨á«¥­¨¥³ ‘¯¨á ­¨¥  ³\n"+
                 "³  ®¯¥à æ¨¨  ³            ®¯¥à æ¨¨                ³                   ³                   ³           ³           ³\n"+
                 "ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´";

var TableHeadProg3 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                     "³    „ â     ³à®£­®§³             ¨¬¥­®¢ ­¨¥            ³        ‚¨¤        ³  ü á¤¥«ª¨/        ³           ³           ³\n"+
                     "³  à áç¥â­®© ³       ³            à áç¥â­®©               ³      ®¯¥à æ¨¨     ³   ®¯¥à æ¨¨ á æ/¡  ³ ‡ ç¨á«¥­¨¥³ ‘¯¨á ­¨¥  ³\n"+
                     "³  ®¯¥à æ¨¨  ³       ³            ®¯¥à æ¨¨                ³                   ³                   ³           ³           ³\n"+
                     "ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´";

var TableHead4 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                 "³            ³                ³       ISIN/ü     ³             ³              ³              ³              ‘ç¥â              ³‚å®¤ïé¨©  ³ ˆáå®¤ïé¨© ³\n"+
                 "³  ‚¨¤ æ/¡   ³     ¬¨â¥­â    ³   £®áà¥£¨áâà æ¨¨ ³    C¥à¨ï    ³    ‚ë¯ãáª    ³    ’à ­è     ³                                ³ ®áâ â®ª  ³  ®áâ â®ª  ³\n"+
                 "³            ³                ³                  ³             ³              ³              ³                                ³          ³           ³\n"+
                 "ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´";
var TableHeadProg4 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                     "³            ³                ³       ISIN/ü     ³             ³              ³              ³              ‘ç¥â              ³‚å®¤ïé¨©  ³ ˆáå®¤ïé¨© ³‚å®¤ïé¨©  ³ « ­®¢ë©  ³\n"+
                     "³  ‚¨¤ æ/¡   ³     ¬¨â¥­â    ³   £®áà¥£¨áâà æ¨¨ ³    C¥à¨ï    ³    ‚ë¯ãáª    ³    ’à ­è     ³                                ³ ®áâ â®ª  ³  ®áâ â®ª  ³ ®áâ â®ª  ³ ¨áå®¤ïé¨© ³\n"+
                     "³            ³                ³                  ³             ³              ³              ³                                ³          ³           ³(¯à®£­®§) ³  ®áâ â®ª  ³\n"+
                     "³            ³                ³                  ³             ³              ³              ³                                ³          ³           ³          ³ (¯à®£­®§) ³\n"+
                     "ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄ´";

var TableHead5 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                 "³              ‘ç¥â              ³ ‚ «îâ  áç¥â  ³    ‚å®¤ïé¨©    ³   ˆáå®¤ïé¨©   ³\n"+
                 "³                                ³              ³     ®áâ â®ª    ³    ®áâ â®ª    ³\n"+
                 "³                                ³              ³                ³               ³\n"+
                 "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";
var TableHeadProg5 = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                     "³              ‘ç¥â              ³ ‚ «îâ  áç¥â  ³    ‚å®¤ïé¨©    ³   ˆáå®¤ïé¨©   ³    ‚å®¤ïé¨©    ³   « ­®¢ë©    ³\n"+
                     "³                                ³              ³     ®áâ â®ª    ³    ®áâ â®ª    ³     ®áâ â®ª    ³   ¨áå®¤ïé¨©   ³\n"+
                     "³                                ³              ³                ³               ³    (¯à®£­®§)   ³    ®áâ â®ª    ³\n"+
                     "³                                ³              ³                ³               ³                ³   (¯à®£­®§)   ³\n"+
                     "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";


private var t_RepHeader =  "”¨«¨ «: #\n"
     "Žâç¥â ® á®áâ®ï­¨¨ áç¥â®¢ ª«¨¥­â  ¯® á¤¥«ª ¬ ¨ ®¯¥à æ¨ï¬ á æ¥­­ë¬¨ ¡ã¬ £ ¬¨\n",
                   t_RepPer1 = "Žâç¥â­ë© ¯¥à¨®¤ c ########## ¯® ##########\n",
                   t_RepPer2 = "Žâç¥â­ë© ¯¥à¨®¤ ##########\n",
                   t_Client = "Š«¨¥­â: ##############################\n",
                   t_Contr = "„®£®¢®à ü ######### ®â ############\n",
                   t_SecHeader = "    ˆ­ä®à¬ æ¨ï ® ¤¢¨¦¥­¨¨ æ¥­­ëå ¡ã¬ £ ¢ ®âç¥â­ë© ¯¥à¨®¤\n\n",
                   t_Sec= "\n–¥­­ ï ¡ã¬ £ : ¢¨¤ #######, í¬¨â¥­â  ####################\n"+
                                  "ISIN/ü £®áà¥£¨áâà æ¨¨ #######################\n",
                   t_SecAcc = "Œ¥áâ® ãç¥â : ####### ‘ç¥â: #################### ‚å®¤ïé¨© ®áâ â®ª: #################################",
                   t_SecOut = "ˆáå®¤ïé¨© ®áâ â®ª: #############################\n",
                   t_SecOutPrognos = "ˆáå®¤ïé¨© ®áâ â®ª: ############################\n"+
                                     "« ­®¢ë© ¨áå®¤ïé¨© ®áâ â®ª:############################\n",
                   t_CurrHeader = "     ˆ­ä®à¬ æ¨ï ® ¤¢¨¦¥­¨¨ ¤¥­¥¦­ëå áà¥¤áâ¢\n\n",
                   t_CurrAcc = "‘ç¥â: #################### ‚å®¤ïé¨© ®áâ â®ª: ############# ###",
                   t_CurrAccPrognos = "‘ç¥â: #################### ‚å®¤ïé¨© ®áâ â®ª: ############################ ###",
                   t_CurrOut = "ˆáå®¤ïé¨© ®áâ â®ª: ############# ###\n",
                   t_CurrOutPrognos = "ˆáå®¤ïé¨© ®áâ â®ª: ############################ ###\n « ­®¢ë© ¨áå®¤ïé¨© ®áâ â®ª:############################ ###\n",
                   t_CommFooter = "‘ã¬¬  ª®¬¨áá¨¨ ¡ ­ª , ã¤¥à¦ ­­ ï á ª«¨¥­â            ############ ###\n"+
                                  "‘ã¬¬  ª®¬¨áá¨© ¯®áà¥¤­¨ª ¬, ®¯« ç¥­­ëå ª«¨¥­â®¬      ############ ###\n"+
                                  "‘ã¬¬  à áå®¤®¢ ¡ ­ª , ¯®¤«¥¦ é¨å ¢®§¬¥é¥­¨î ª«¨¥­â®¬ ############ ###\n",
                   t_CommFooterPrognos = "‘ã¬¬  ª®¬¨áá¨¨ ¡ ­ª , ã¤¥à¦ ­­ ï á ª«¨¥­â            ############ ### (############)\n"+
                                         "‘ã¬¬  ª®¬¨áá¨© ¯®áà¥¤­¨ª ¬, ®¯« ç¥­­ëå ª«¨¥­â®¬      ############ ### (############)\n"+
                                         "‘ã¬¬  à áå®¤®¢ ¡ ­ª , ¯®¤«¥¦ é¨å ¢®§¬¥é¥­¨î ª«¨¥­â®¬ ############ ### (############)\n",
                   t_N3_H4 = "#\n",
                   t_AccFooter = "Cç¥â #################### ‚ «îâ  áç¥â  ###\n"+
                                 "‚å®¤ïé¨© ®áâ â®ª                                      ############\n"+
                                 "®¯®«­¥­¨¥ áç¥â                                       ############\n"+
                                 "¥à¥ç¨á«¥­­® ª â®à£ ¬                                 ############\n"+
                                 "‘ã¬¬  ¯® á¤¥«ª ¬ ¯®ªã¯ª¨ (¢ â®¬ ç¨á«¥ Š„ ã¯« ç¥­­ë©) ############\n"+
                                 "‘ã¬¬  ¯® á¤¥«ª ¬ ¯à®¤ ¦¨ (¢ â®¬ ç¨á«¥ Š„ ¯®«ãç¥­­ë©) ############\n"+
                                 "®£ è¥­¨¥ ªã¯®­®¢/ç áâ¨ç­.¯®£ è¥­¨¥                   ############\n"+
                                 "Ž¯« â  ª®¬¨áá¨¨ ¡¨à¦¥/¡à®ª¥à ¬                        ############\n"+
                                 "          ¢ â®¬ ç¨á«¥ „‘                             ############\n"+
                                 "Ž¯« â  ª®¬¨áá¨¨ ¡ ­ª                                  ############\n"+
                                 "          ¢ â®¬ ç¨á«¥ „‘                             ############\n"+
                                 "‘ «ì¤® à áç¥â®¢                                       ############\n"+
                                 "‚®§¢à â áà¥¤áâ¢ ª«¨¥­âã                               ############\n"+
                                 "‘­ïâ® á® áç¥â  ª«¨¥­â®¬                               ############\n"+
                                 "ˆáå®¤ïé¨© ®áâ â®ª                                     ############\n",
                   t_AccFooterPrognos = "Cç¥â #################### ‚ «îâ  áç¥â  ###\n"+
                                        "‚å®¤ïé¨© ®áâ â®ª                                      ############ (############)\n"+
                                        "®¯®«­¥­¨¥ áç¥â                                       ############ (############)\n"+
                                        "¥à¥ç¨á«¥­­® ª â®à£ ¬                                 ############ #\n"+
                                        "‘ã¬¬  ¯® á¤¥«ª ¬ ¯®ªã¯ª¨ (¢ â®¬ ç¨á«¥ Š„ ã¯« ç¥­­ë©) ############ (############)\n"+
                                        "‘ã¬¬  ¯® á¤¥«ª ¬ ¯à®¤ ¦¨ (¢ â®¬ ç¨á«¥ Š„ ¯®«ãç¥­­ë©) ############ (############)\n"+
                                        "®£ è¥­¨¥ ªã¯®­®¢/ç áâ¨ç­.¯®£ è¥­¨¥                   ############ #\n"+
                                        "Ž¯« â  ª®¬¨áá¨¨ ¡¨à¦¥/¡à®ª¥à ¬                        ############ (############)\n"+
                                        "          ¢ â®¬ ç¨á«¥ „‘                             ############ (############)\n"+
                                        "Ž¯« â  ª®¬¨áá¨¨ ¡ ­ª                                  ############ (############)\n"+
                                        "          ¢ â®¬ ç¨á«¥ „‘                             ############ (############)\n"+
                                        "‘ «ì¤® à áç¥â®¢                                       ############ (############)\n"+
                                        "‚®§¢à â áà¥¤áâ¢ ª«¨¥­âã                               ############ #\n"+
                                        "‘­ïâ® á® áç¥â  ª«¨¥­â®¬                               ############ (############)\n"+
                                        "ˆáå®¤ïé¨© ®áâ â®ª                                     ############ \n"+
                                        "« ­®¢ë© ¨áå®¤ïé¨© ®áâ â®ª                            ############ \n";


var RepData;

/* ®«ãç ¥¬ ¨­ä®à¬ æ¨î ® á¥à¨¨, ¢ë¯ãáª¥, âà ­è¥ ¡ã¬ £¨
      Avoir    -  ¡ãä¥à ¡ã¬ £¨ */
private macro GetSeriesIssueTrancheInfo( Avoir, Series:@string, Issue:@string, Tranche:@string )

   var
      Result;

   /* A7,   A12    - ‘¥à¨ï, ¢ë¯ãáª, âà ­è = ‘¥à¨ï æ/¡
      A7.1, A12.1  = ‡ ¯®«­ï¥âáï â®«ìª® ¯à¨ ãª § ­¨¨ ¢ë¯ãáª  ¢  ­ª¥â¥ æ/¡
                     ’¥ªáâ "¢." + ¢ë¯ãáª ¨§  ­ª¥âë æ/¡.
      A7.2, A12.2  = ‡ ¯®«­ï¥âáï â®«ìª® ¯à¨ ãª § ­¨¨ âà ­è  ¢  ­ª¥â¥ æ/¡
                     ’¥ªáâ "â." + âà ­è  ¨§  ­ª¥âë æ/¡ (¢â®à ï ®ç¥à¥¤ì) */

   Result  = "";

   if( Avoir.Series != "" )
      Result = "á." + Avoir.Series;
      Series = "á." + Avoir.Series;
   end;

   if( Avoir.Issue != "" )
      Result = Result + IIF( Result != "", ", ", "" );
      Result = "¢." + Avoir.Issue;
      Issue = "¢." + Avoir.Issue;
   end;

   if( Avoir.Tranche != "" )
      Result = Result + IIF( Result != "", ", ", "" );
      Result = Result + "â." + Avoir.Tranche;
      Tranche = "â." + Avoir.Tranche;
   end;

   Result = IIF( Result != "", ",", "" ) + Result;
   Result = string(Avoir.Series) + Result;

   return Result;

end;

macro ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealID, IsBack, status, BofficeKind, DealDate, DealTime, PlaceID,
                              ClientID, ContrID, Account, Currency, FIID, Amount, IsPrognos, IsPartyClient
                            )
   var errcode, errname;
   clearrecord(clopord);
   clopord.rec.DealID = DealID;
   if (IsBack)
      clopord.rec.IsBack = SET_CHAR;
   else
      clopord.rec.IsBack = UNSET_CHAR;
   end;
   clopord.rec.Status = status;

   if (IsPrognos)
      clopord.rec.Prognos = IsPrognos;
   end;

   if (IsPartyClient)
      clopord.rec.IsPartyClient = IsPartyClient;
   end;

   clopord.rec.BofficeKind = BofficeKind;
   clopord.rec.DealDate    = DealDate;
   clopord.rec.DealTime    = DealTime;
   clopord.rec.PlaceID     = PlaceID;
   clopord.rec.ClientID    = ClientID;
   clopord.rec.ContrID     = ContrID;
   clopord.rec.Account     = Account;
   clopord.rec.Currency    = Currency;
   clopord.rec.FIID        = FIID;
   clopord.rec.ClientComm  = Amount;

   if( not clopord.insert() )
      errcode = status(errname);
      RunError("Žè¨¡ª  ¯à¨ ¢áâ ¢ª¥ ¤ ­­ëå ¢® ¢à¥¬¥­­ë© ä ©« (" + errcode + ") " + errname);
   else
      RepData.ReportRun == true;
   end;
end;


private macro Žâ®¡à âì‘¤¥«ª¨Š«¨¥­â®¢„«ïŽâçñâ ( IsPartyClient)

  var res;
  res = " select tick.t_Department Department, " +
        "          tick.t_DealID DealId,  tick.t_DealDate DealDate, tick.t_DealTime DealTime, " +
        "          tick.t_BofficeKind BofficeKind, ";
        if (IsPartyClient)
        res = res + 
        "          TICK.T_PARTYCONTRID ContrID, TICK.T_PARTYID ClientID,   /*tick.t_CloseDate, */ ";
        else
          res = res + 
        "          tick.t_ClientContrID ContrID, tick.t_ClientID ClientID, /*tick.t_CloseDate, */ " ;
        end;
          res = res + 
        "        tick.t_Prognos isPrognos /*CHR(88)*/  " +  // ­ ¤® ¡ë ¨ ­¥§ ¢¥àè¥­­ë¥ á¤¥«ª¨ :(

        "   , tick.t_DealStatus " ;
        res = res + IIF(IsPartyClient, " , tick.t_IsPartyClient  IsPartyClient" , " , CHR (0) IsPartyClient ");

        res = res + 
        "   , (CASE WHEN ( (tick.t_BOfficeKind = 127 OR tick.t_BOfficeKind = 138) AND TICK.T_DEALSTATUS = 20  )THEN  tick.t_DealDate  ELSE tick.t_CloseDate END) as CloseDate " +

        "   from ddl_tick_dbt tick, dsfcontr_dbt contr  , dparty_dbt Pt ";
        
        res = res +
        "   where tick.t_BOfficeKind in (101,155,117,127,138)  ";
        res = res + IIF (IsPartyClient," AND TICK.T_ISPARTYCLIENT = 'X' AND TICK.T_PARTYID > 0 and TICK.T_PARTYID  = Pt.T_PARTYID (+) ", "  and tick.T_ClientID > 0  and tick.T_ClientID  = Pt.T_PARTYID (+) " );

  if (RepData.IsPrognos)        
    res = res + " AND ( tick.t_Prognos = chr(88) or tick.t_DealStatus >= 10)";
  else
    res = res + " AND tick.t_DealStatus >= 10";
  end;

  if( RepData.ClientID >= 0 )
    res = res + IIF (IsPartyClient, " and TICK.T_PARTYID = ? ", " and tick.T_ClientID = ? ");
  end;

  
   if( (RepData.IsFormID > 0) and (RepData.FormSubID != 0) )
      if(RepData.IsFormID == 1)
        res = res + "   and    Pt.T_LEGALFORM = ?  ";
      end;
      if(RepData.IsFormID == 2)            	
        res = res + "   and    Pt.T_LEGALFORM != ?  ";
      end;
   end;

   if( (RepData.IsVidID > 0) and (RepData.VidSubID != 0) )
      if(RepData.IsVidID == 1)
        res = res + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
      end;
      if(RepData.IsVidID == 2)            	
        res = res + "   and    NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
      end;
   end;

   if(RepData.NoResident)
      res = res + "  and   Pt.T_NOTRESIDENT = 'X'  ";
   end;

  
  if(IsPartyClient)
     res = res +
           "    and contr.T_PARTYID = tick.T_PARTYID " +
           "    and contr.T_ID = tick.T_PARTYCONTRID " +
           "    and contr.T_SERVKIND = ? " +
           "    and (contr.T_DATECLOSE = '01.01.0001' or " +
           "         ( contr.T_DATECLOSE <= ? and contr.T_DATECLOSE >= ? )) ";
   else
     res = res +
           "    and contr.T_PARTYID = tick.t_CLIENTID " +
           "    and contr.T_ID = tick.t_ClientContrID " +
           "    and contr.T_SERVKIND = ? " +
           "    and (contr.T_DATECLOSE = '01.01.0001' or " +
           "         ( contr.T_DATECLOSE <= ? and contr.T_DATECLOSE >= ? )) ";

   end;

  if(RepData.ContrID > 0)
    res = res + IIF (IsPartyClient, " and TICK.T_PARTYCONTRID = ? ", " and tick.t_ClientContrID = ? ");
  end;

  if( RepData.DprtID != -1 )
    res = res + "    and tick.t_Department = ? ";
  end;

  if(RepData.OperState == STAT_ALL)/*‡ ¢¥àè¥­­ë¥\¥§ ¢¥àè¥­­ë¥*/
     res = res + "    and ( (tick.t_CloseDate >= ? and tick.t_CloseDate <= ?)  OR " +
                 "             (tick.t_CloseDate > ? or tick.t_CloseDate = '01.01.0001' )" +
                 "        ) ";
  elif(RepData.OperState == STAT_FINISHED) /*‡ ¢¥àè¥­­ë¥*/
     res = res + "    and tick.t_CloseDate >= ? and tick.t_CloseDate <= ? ";
  elif(RepData.OperState == STAT_NOTFINISHED) /*¥§ ¢¥àè¥­­ë¥*/
     res = res + "    and (tick.t_CloseDate > ? or tick.t_CloseDate = '01.01.0001' ) ";
  else /*§ ª«îç¥­­ë¥*/
     res = res + "    and tick.t_DealDate >= ? " +
                 "    and tick.t_DealDate <= ? ";
  end;

  return res;
end;


private macro Žâ®¡à âì‘¤¥«ª¨„«ïŽâçñâ ( )
  var res;
  res = Žâ®¡à âì‘¤¥«ª¨Š«¨¥­â®¢„«ïŽâçñâ ( false );  // Š«¨¥­âë
  res = res + " UNION ALL ";
  res = res + Žâ®¡à âì‘¤¥«ª¨Š«¨¥­â®¢„«ïŽâçñâ ( true );  // Š«¨¥­âë-ª®­âà £¥­âë    
  res = res + " order by Department, ClientID, ContrID, BofficeKind, DealDate, DealTime, DealID, CloseDate, isPrognos ";

  return res;
end;

private macro Žâ®¡à âì‘ç¥â „«ïŽâçñâ ()

  var res;
  res = " select distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Place, client.T_PARTYID, contr.T_ID, accdoc.t_Chapter, contr.t_Number NumConc " +
        " from dmcaccdoc_dbt accdoc, dsfcontr_dbt contr, dclient_dbt client , dparty_dbt Pt " +
        " where  client.T_SERVICEKIND = ? " +
        "    and client.T_PARTYID  = Pt.T_PARTYID (+) " +
        "    and client.T_PARTYID != ? ";

  if( RepData.ClientID >= 0 )
    res = res + "    and client.T_PARTYID = ? ";
  end;

  if( (RepData.IsFormID > 0) and (RepData.FormSubID != 0) )
     if(RepData.IsFormID == 1)
       res = res + "    and   Pt.T_LEGALFORM = ?  ";
     end;
     if(RepData.IsFormID == 2)            	
       res = res + "    and   Pt.T_LEGALFORM != ?  ";
     end;
  end;

  if( (RepData.IsVidID > 0) and (RepData.VidSubID != 0) )
     if(RepData.IsVidID == 1)
       res = res + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
     end;
     if(RepData.IsVidID == 2)            	
       res = res + "   and    NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
     end;
  end;

   if(RepData.NoResident)
      res = res + " and   Pt.T_NOTRESIDENT = 'X'  ";
   end;


  if(RepData.ContrID > 0)
    res = res + "    and contr.T_ID = ? ";
  end;

  res = res + "    and contr.T_PARTYID = client.T_PARTYID " +
              "    and contr.T_SERVKIND = ? " +
              "    and accdoc.t_Chapter in(22,21) " +
           //MZ   "    and (case when accdoc.t_Chapter = 22 then 560 else 533 end) = accdoc.t_CatNum " +
              "    and (case when accdoc.t_Chapter = 22 then 364 else 349 end) = accdoc.t_CatID " +
              "    and accdoc.t_Owner = client.T_PARTYID " +
              "    and accdoc.t_ClientContrID = contr.T_ID ";

  if( RepData.DprtID != -1 )
    res = res + "    and accdoc.t_DepartmentID = ? ";
  end;

  res = res + " order by client.T_PARTYID, contr.T_ID, accdoc.t_Chapter desc, accdoc.t_currency, accdoc.t_Account, accdoc.t_Place ";

  return res;
end;

PRIVATE CLASS (DL_CReportTemplate) SP_Clopord_Report
  private var m_SheetName, m_KindRep, m_Prefix, m_curdate = Date(0,0,0);
  private var m_ClientID = -1, m_ContrID = -1, m_FIID = -1, m_Account = NULL, m_Place = 0, m_Chapter = -1;
  private var m_RegisterTable = false, m_IsExistsCarry = false, m_IsRepPrint = false, m_IsPrintByAcc = false,
              IsFirstPrint = true, m_IsExistsClAcc = false, m_IsExistsClOper = false,
              m_IsExistsClAccGlobal = false, m_IsExistsClOperGlobal = false;

  private var sumprecision = 6;

  private var IsPrintRepHeader = false,
              IsPrintClient    = false,
              IsPrintContr     = false,
              IsPrintSection   = false,
              IsPrintSec       = false,
              IsPrintSecOut    = false,
              IsPrintAcc       = false;

  private var PrevDep          = "",
              PrevClient       = "",
              PrevContr        = "",
              PrevFI           = "",
              PrevAcc          = "",
              PrevChapter      = "";


  private var m_InRest      = $0,
              m_OutRest     = $0,
              m_IncSum      = $0,
              m_WrtSum      = $0,
              m_ItogIn      = $0,
              m_ItogOut     = $0,
              m_BankCommSum = $0,
              m_BankCommNDS = $0,
              m_AgentCommSum= $0,
              m_AgentSumNDS = $0,
              m_NKDBuy      = $0,
              m_NKDSale     = $0,
              m_AmountCup   = $0,
              m_SumBuy      = $0,
              m_SumSale     = $0,
              m_RetFac      = $0,
              m_WrtSumCl    = $0,
              m_InRestVirt      = $0, // ¢å®¤ïé¨© ®áâ â®ª á ¢¨àâã «ì­ë¬¨ áã¬¬ ¬¨
              m_OutRestVirt     = $0, // ¨áå®¤ïé¨© ®áâ â®ª á ¢¨àâã «ì­ë¬¨ áã¬¬ ¬¨
              //m_IncSumVirt      = $0,
              m_ItogInVirt      = $0,
              m_ItogOutVirt     = $0,
              //m_WrtSumVirt      = $0,
              m_BankCommSumVirt = $0,
              m_BankCommNDSVirt = $0,
              m_AgentCommSumVirt= $0,
              m_AgentSumNDSVirt = $0,
              //m_AmountCupVirt   = $0,
              m_SumBuyVirt      = $0,
              m_SumSaleVirt     = $0,
              m_RetFacVirt      = $0,
              m_WrtSumClVirt    = $0;

  var IsNotFirstUse = false;
  var PrevStatus = -1;

  macro ClearData()
      m_InRest      = $0;
      m_OutRest     = $0;
      m_InRestVirt  = $0;
      m_OutRestVirt = $0;
      m_IncSum      = $0;
      m_WrtSum      = $0;
      m_ItogIn      = $0;
      m_ItogOut     = $0;
      m_ItogInVirt  = $0;
      m_ItogOutVirt = $0;
      m_BankCommSum = $0;
      m_BankCommNDS = $0;
      m_AgentCommSum= $0;
      m_AgentSumNDS = $0;
      m_NKDBuy      = $0;
      m_NKDSale     = $0;
      m_AmountCup   = $0;
      m_SumBuy      = $0;
      m_SumSale     = $0;
      m_RetFac      = $0;
      m_WrtSumCl    = $0;
      //m_IncSumVirt      = $0;
      //m_WrtSumVirt      = $0;
      m_BankCommSumVirt = $0;
      m_BankCommNDSVirt = $0;
      m_AgentCommSumVirt= $0;
      m_AgentSumNDSVirt = $0;
      //m_AmountCupVirt   = $0;
      m_SumBuyVirt      = $0;
      m_SumSaleVirt     = $0;
      m_RetFacVirt      = $0;
      m_WrtSumClVirt    = $0;
      m_FIID        = -1;
      m_Account     = NULL;
      m_Place       = 0;
  end;

  macro ClearPrevData()
      PrevDep          = "";
      PrevClient       = "";
      PrevContr        = "";
      PrevFI           = "";
      PrevAcc          = "";
      PrevChapter      = "";
  end;

  MACRO EndReportTab()
     if(m_RegisterTable)
       EndTable();
       CopyAllSheetInTotalBook( m_SheetName, false, GetTableRange(), 0 );
       m_RegisterTable = false;
     end;
  END;

  PRIVATE MACRO PrintMode():INTEGER
     if(RepData.IsExcel)
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
    CreateTotalBook();
    SetUseApp(RepData.IsApp);
  END;

  MACRO PrintRepFooter()
     EndReportTab();
     AddStandardFooter( m_Prefix );
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Footer", 1 );
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  private macro DigitIsApp(Digit, SumPrec:Integer, IsPrintNul:bool)
    if(Digit AND (not RepData.IsExcel))
      if(RepData.IsApp)
        return —¨á«®C‡ ¤ ­­®©’®ç­®áâìî(Digit, SumPrec, "a");
      else
        return —¨á«®C‡ ¤ ­­®©’®ç­®áâìî(Digit,SumPrec);
      end;
    elif(not Digit)
      if(IsPrintNul)
         return $0;
      else
         return "";
      end;
    end;

    return Digit;
  end;

  macro ‘ã¬¬ ‚®§¬¥é¥­¨ïŠ«¨¥­â®¬()
     var deal, SummClient = $0;

     var StartDate, StopDate;
     var Sql;

     if( RepData.IsSeparatelyDate == false )
       StartDate = RepData.DateBegin;
       StopDate = RepData.DateEnd;
     else
       StartDate = m_CurDate;
       StopDate = m_CurDate;
     end;

     Sql = RSdCommand(" select * " +
                      "   from ddl_tick_dbt " +
                      "  where t_ClientID = ? " +
                      "    and t_ClientContrID = ? " +
                      "    and t_DealDate >= ? " +
                      "    and t_DealDate <= ? " +
                      "    and t_DealStatus = ? " +
                      "    and t_Department = ? " +
                      "    and t_BOfficeKind in (?,?,?,?)");

     Sql.addParam( "", RSDBP_IN, m_ClientID );
     Sql.addParam( "", RSDBP_IN, m_ContrID );
     Sql.addParam( "", RSDBP_IN, StartDate );
     Sql.addParam( "", RSDBP_IN, StopDate );
     Sql.addParam( "", RSDBP_IN, DL_READIED );
     Sql.addParam( "", RSDBP_IN, RepData.DprtID );
     Sql.addParam( "", RSDBP_IN, DL_SECURITYDOC );
     Sql.addParam( "", RSDBP_IN, DL_RETIREMENT );
     Sql.addParam( "", RSDBP_IN, DL_CONVAVR );
     Sql.addParam( "", RSDBP_IN, DL_AVRWRT );

     Sql.execute();

     deal = TRsbDataSet(Sql);

     while( deal.MoveNext() )
           SummClient =   SummClient
                          + ®«ãç¨âì‘ã¬¬ã á¯à¥¤¥«¥­­ëåŠ®¬¨áá¨©®‘¤¥«ª¥(
                                deal.rec, null, null, null, null, null, null,
                                m_FIID );
     end;

     return SummClient;
  end;

  MACRO DL_GetDepartmentFullNameByCode(code)
        var ds, select;

        if (valtype(code) != V_UNDEF)
                select = String("select dep.t_code, party.t_name ",
                        "from ddp_dep_dbt dep, dparty_dbt party ",
                        "where dep.t_code = ", code,
                        " and dep.t_partyid = party.t_partyid");
                ds = TRsbDataset(select);
                if (ds.next())
                        return ds.t_name;
                end;
        end;

        return "";
   END;


  macro PrintRepHeader()
     var CurMonth, CurYear, CurQuartal, month;

     PrintFormatString( t_RepHeader, m_Prefix+"H0_1", DL_GetDepartmentFullNameByCode(RepData.DprtID) );
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"RepHeader", IIF(IsFirstPrint == true,0,1) );
     IsFirstPrint = false;
     if( RepData.IsSeparatelyDate == false )
        datesplit({CurDate}, null, CurMonth, CurYear);
        CurQuartal = (CurMonth - 1)/3 + 1;
        if(RepData.PeriodNum == REP_MONTH)
          month = DL_GetNameAlg(1005, CurMonth);
          PrintFormatString( t_RepPer2, m_Prefix+"H1_3", month + " " + string(CurYear) + " £®¤ " );
          CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"RepPer_2", 1 );
        elif(RepData.PeriodNum == REP_QUARTAL)
          PrintFormatString( t_RepPer2, m_Prefix+"H1_3", string(CurQuartal) + " ª¢ àâ « "  + string(CurYear) + " £®¤ " );
          CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"RepPer_2", 1 );
        else
          if((RepData.DateEnd - RepData.DateBegin) != 0)
             PrintFormatString( t_RepPer1, m_Prefix+"H1_1", RepData.DateBegin,
                                       m_Prefix+"H1_2", RepData.DateEnd );
             CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"RepPer_1", 1 );
          else
             PrintFormatString( t_RepPer2, m_Prefix+"H1_3", RepData.DateBegin );
             CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"RepPer_2", 1 );
          end;
        end;
     else
        PrintFormatString( t_RepPer2, m_Prefix+"H1_3", m_CurDate );
        CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"RepPer_2", 1 );
     end;

     IsPrintRepHeader = false;
  end;

  macro PrintClient()
     PrintFormatString( t_Client, m_Prefix+"H1_4", ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ (m_ClientID) );
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Client", 1 );
     IsPrintClient = false;
  end;

  macro PrintContr()
     record sfcontr( sfcontr );
     if(SfGetContr(m_ContrID, sfcontr) == false)
        Msgbox("¥ ¯®«ãç¥­ ¤®£®¢®à ¯® á¤¥«ª¥");
     end;

     PrintFormatString( t_Contr, m_Prefix+"H2_1", sfcontr.Number,
                               m_Prefix+"H2_2", sfcontr.DateBegin );
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Contr", 1 );

     IsPrintContr = false;
  end;

  macro PrintSecHeader()
     PrintFormatString( t_SecHeader );
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"SecHeader", 1 );
     IsPrintSection = false;
  end;

  macro PrintMonHeader()
     PrintFormatString( t_CurrHeader );
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"CurrHeader", 1 );
     IsPrintSection = false;
  end;

  macro PrintSec()
    record rFi(fininstr);
    record rAv(avoiriss);
    var ISIN = "", AvrKind = "", SerIssTranche = "";
    var Series = "", Issue = "", Tranche = "";

    if( ®«ãç¨âì”¨­ˆ­(m_FIID, rFi, rAv) == 0 )
       /*‚¨¤ –*/
       AvoirKindName( ToINT(rFi.AvoirKind), AvrKind );

       /* A7, A7.1, A7.2 */
       SerIssTranche = GetSeriesIssueTrancheInfo( rAv, @Series, @Issue, @Tranche );

       if( rAv.ISIN )
          ISIN = rAv.ISIN;
       else
          ISIN = rAv.LSIN;
       end;
    end;

    PrintFormatString( t_Sec, m_Prefix+"H3_1", AvrKind,
                              m_Prefix+"H3_2", ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ( FI_GetIssuerOnDate(rFi, RepData.DateEnd )),
                              m_Prefix+"H3_3", ISIN + " " +  SerIssTranche );
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Sec", 1 );

    IsPrintSec       = false;
  end;

  macro PrintSecOut()
     if(RepData.IsPrognos)
     PrintFormatString( IIF(RepData.IsPrognos, t_SecOutPrognos, t_SecOut),
                        m_Prefix+"H4_4", String(DigitIsApp(—¨á«®C‡ ¤ ­­®©’®ç­®áâìî(Abs(m_OutRest),SumPrecision),SumPrecision,true)),
                        m_Prefix+"H4_5", String(DigitIsApp(—¨á«®C‡ ¤ ­­®©’®ç­®áâìî(m_OutRestVirt,SumPrecision), SumPrecision, true) ));
     else
     PrintFormatString( t_SecOut,
                        m_Prefix+"H4_4", String(DigitIsApp(—¨á«®C‡ ¤ ­­®©’®ç­®áâìî(Abs(m_OutRest),SumPrecision),SumPrecision,true)));
     end;
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"SecOut", 0 );
  end;

  macro PrintSecAcc()
    PrintFormatString( t_SecAcc,
                       m_Prefix+"H4_1", ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ (m_Place),
                       m_Prefix+"H4_2", m_Account,
                       m_Prefix+"H4_3", String(DigitIsApp(—¨á«®C‡ ¤ ­­®©’®ç­®áâìî(Abs(m_InRest),SumPrecision), SumPrecision, true))+
                                        IIF(RepData.IsPrognos, "("+DigitIsApp(—¨á«®C‡ ¤ ­­®©’®ç­®áâìî(m_InRestVirt,SumPrecision), SumPrecision, true)+")", "") );
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"SecAcc", 1 );

    if( not m_IsExistsCarry)
       PrintSecOut();
    end;
    IsPrintAcc    = false;
  end;

  macro PrintMonOut()
     if(RepData.IsPrognos)
     PrintFormatString( t_CurrOutPrognos,
                        m_Prefix+"H5_4", String(DigitIsApp(Abs(m_OutRest), 2, true)),
                        m_Prefix+"H5_5", GetFinInstrCcy(m_FIID,true,false),
//                        m_Prefix+"H5_6_0","« ­®¢ë© ¨áå®¤ïé¨© ®áâ â®ª",
                        m_Prefix+"H5_6", String( DigitIsApp(—¨á«®C‡ ¤ ­­®©’®ç­®áâìî(m_OutRestVirt,2))),
                        m_Prefix+"H5_7",  GetFinInstrCcy(m_FIID,true,false) );
     else
     PrintFormatString( t_CurrOut,
                        m_Prefix+"H5_4", String(DigitIsApp(Abs(m_OutRest), 2, true)),
                        m_Prefix+"H5_5", GetFinInstrCcy(m_FIID,true,false) );

     end;
     CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"CurrOut", 0 );
  end;

  macro PrintMonAcc()
    PrintFormatString( IIF(RepData.IsPrognos,t_CurrAccPrognos,t_CurrAcc),
                       m_Prefix+"H5_1", m_Account,
                       m_Prefix+"H5_2", String(DigitIsApp(Abs(m_InRest), 2, true))+
                                        IIF(RepData.IsPrognos, "("+DigitIsApp(—¨á«®C‡ ¤ ­­®©’®ç­®áâìî(m_InRestVirt,2), 2, true)+")", ""),
                       m_Prefix+"H5_3", GetFinInstrCcy(m_FIID,true,false) );
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"CurrAcc", 1 );

    if( not m_IsExistsCarry)
       PrintMonOut();
    end;
    IsPrintAcc    = false;
  end;

  macro RegisterTableAcc()
     if( m_Chapter==22 )
        CopyAllSheetInTotalBook( m_SheetName, false, "N1_TableHeader_1", 0 );
        if (RepData.IsPrognos)
          RegisterTable( "N1_MainTable_1", TableHeadProg2,
                         "N1_€0",
                         "N1_€01",
                         "N1_€1",
                         "N1_€2",
                         "N1_€3",
                         "N1_€4",
                         "N1_€5"
                      );
        else
          RegisterTable( "N1_MainTable_1", TableHead2,
                         "N1_€0",
                         "N1_€1",
                         "N1_€2",
                         "N1_€3",
                         "N1_€4",
                         "N1_€5"
                      );
        end;
     else
        CopyAllSheetInTotalBook( m_SheetName, false, "N1_TableHeader_2", 0 );
        if (RepData.IsPrognos)
          RegisterTable( "N1_MainTable_2", TableHeadProg3,
                         "N1_€0_1",
                         "N1_€01_1",
                         "N1_€1_1",
                         "N1_€2_1",
                         "N1_€3_1",
                         "N1_€4_1",
                         "N1_€5_1"
                      );
        else
          RegisterTable( "N1_MainTable_2", TableHead3,
                         "N1_€0_1",
                         "N1_€1_1",
                         "N1_€2_1",
                         "N1_€3_1",
                         "N1_€4_1",
                         "N1_€5_1"
                      );
        end;
     end;
  end;

  macro PrintTableLineAcc(Operdate,OperName,OperKind,OperCode,In,Out,IsPrognos)
     var sumPrIn;
     var sumPrOut;
     if( not m_RegisterTable )
        RegisterTableAcc();
        m_RegisterTable = true;
     end;
     sumPrIn = SetPrecisionByFractPart( In, SumPrecision, 0 );
     sumPrOut = SetPrecisionByFractPart( Out, SumPrecision, 0 );
     if( m_Chapter==22 )
        if (RepData.IsPrognos)
           PrintTableLine( "N1_€0", Operdate, null,
                           "N1_€01",IsPrognos,null,
                           "N1_€1", OperName, null,
                           "N1_€2", OperKind, null,
                           "N1_€3", OperCode, null,
                           "N1_€4", DigitIsApp(Abs(In ), sumPrIn, true), sumPrIn,
                           "N1_€5", DigitIsApp(Abs(Out), sumPrOut, true), sumPrOut
                         );
        else
           PrintTableLine( "N1_€0", Operdate, null,
                           "N1_€1", OperName, null,
                           "N1_€2", OperKind, null,
                           "N1_€3", OperCode, null,
                           "N1_€4", DigitIsApp(Abs(In ), sumPrIn, true), sumPrIn,
                           "N1_€5", DigitIsApp(Abs(Out), sumPrOut, true), sumPrOut
                         );
        end;
     else
        if (RepData.IsPrognos)
           PrintTableLine( "N1_€0_1", Operdate, null,
                           "N1_€01_1",IsPrognos,null,
                           "N1_€1_1", OperName, null,
                           "N1_€2_1", OperKind, null,
                           "N1_€3_1", OperCode, null,
                           "N1_€4_1", DigitIsApp(Abs(In ), sumPrIn, true), sumPrIn,
                           "N1_€5_1", DigitIsApp(Abs(Out), sumPrOut, true), sumPrOut
                         );
        else
           PrintTableLine( "N1_€0_1", Operdate, null,
                           "N1_€1_1", OperName, null,
                           "N1_€2_1", OperKind, null,
                           "N1_€3_1", OperCode, null,
                           "N1_€4_1", DigitIsApp(Abs(In ), sumPrIn, true), sumPrIn,
                           "N1_€5_1", DigitIsApp(Abs(Out), sumPrOut, true), sumPrOut
                         );
        end;
     end;
  end;

  macro PrintItog()
     var sumPrIn, sumPrOut;
     if( m_chapter == 22 )
        m_OutRest = m_InRest + m_ItogIn - m_ItogOut;
        m_OutRestVirt = m_InRestVirt + m_ItogInVirt - m_ItogOutVirt;
        Merge( "N1_€0", "N1_€3", null);
        sumPrIn = SetPrecisionByFractPart(m_ItogIn, SumPrecision, 0);
        sumPrOut = SetPrecisionByFractPart(m_ItogOut, SumPrecision, 0);
        PrintTableLine( "N1_€0", "ˆ’ŽƒŽ", null,
                        "N1_€4", DigitIsApp(m_ItogIn, sumPrIn, true), sumPrIn,
                        "N1_€5", DigitIsApp(m_ItogOut, sumPrOut, true), sumPrOut
                       );

        Merge( "N1_€0", "N1_€3", null);
        sumPrIn = SetPrecisionByFractPart(m_ItogInVirt, SumPrecision, 0);
        sumPrOut = SetPrecisionByFractPart(m_ItogOutVirt, SumPrecision, 0);
        if(RepData.IsPrognos)
          PrintTableLine( "N1_€0", "ˆ’ŽƒŽ (¯à®£­®§)", null,
                          "N1_€4", DigitIsApp(m_ItogInVirt, sumPrIn, true), sumPrIn,
                          "N1_€5", DigitIsApp(m_ItogOutVirt, sumPrOut, true), sumPrOut
                         );
        end;
        EndReportTab();
        PrintSecOut();
     else
        m_OutRest = m_InRest - m_ItogIn + m_ItogOut;
        m_OutRestVirt = m_InRestVirt - m_ItogInVirt + m_ItogOutVirt;
        Merge( "N1_€0_1", "N1_€3_1", null);
        sumPrIn = SetPrecisionByFractPart(m_ItogIn, SumPrecision, 0);
        sumPrOut = SetPrecisionByFractPart(m_ItogOut, SumPrecision, 0);
        PrintTableLine( "N1_€0_1", "ˆ’ŽƒŽ", null,
                        "N1_€4_1", DigitIsApp(m_ItogIn,sumPrIn,  true), sumPrIn,
                        "N1_€5_1", DigitIsApp(m_ItogOut, sumPrOut, true), sumPrOut
                      );

        Merge( "N1_€0_1", "N1_€3_1", null);
        sumPrIn = SetPrecisionByFractPart(m_ItogInVirt, SumPrecision, 0);
        sumPrOut = SetPrecisionByFractPart(m_ItogOutVirt, SumPrecision, 0);
        if(RepData.IsPrognos)
          PrintTableLine( "N1_€0_1", "ˆ’ŽƒŽ (¯à®£­®§)", null,
                          "N1_€4_1", DigitIsApp(m_ItogInVirt,sumPrIn,  true), sumPrIn,
                          "N1_€5_1", DigitIsApp(m_ItogOutVirt, sumPrOut, true), sumPrOut
                        );
        end;
        EndReportTab();
        PrintMonOut();
     end;
  end;

  macro RegisterTableSecSmpl()
     PrintFormatString( "     ˆ­ä®à¬ æ¨ï ®¡ ®áâ âª å æ¥­­ëå ¡ã¬ £  \n" );
     CopyAllSheetInTotalBook( m_SheetName, false, "N2_TableHeader_1", 1 );
     if (RepData.IsPrognos)
        RegisterTable( "N2_MainTable_1", TableHeadProg4,
                       "N2_A1",
                       "N2_A2",
                       "N2_A3",
                       "N2_A4",
                       "N2_A5",
                       "N2_A6",
                       "N2_N0",
                       "N2_N1",
                       "N2_N2",
                       "N2_N3",
                       "N2_N4"
                     );
     else
        RegisterTable( "N2_MainTable_1", TableHead4,
                       "N2_A1",
                       "N2_A2",
                       "N2_A3",
                       "N2_A4",
                       "N2_A5",
                       "N2_A6",
                       "N2_N0",
                       "N2_N1",
                       "N2_N2"
                     );
     end;
  end;

  macro RegisterTableMonSmpl()
     CopyAllSheetInTotalBook( m_SheetName, false, "N2_TableHeader_2", 1 );
     if (RepData.IsPrognos)
        RegisterTable( "N2_MainTable_2", TableHeadProg5,
                               "N2_B1",
                               "N2_‚2",
                               "N2_M1",
                               "N2_M2",
                               "N2_M3",
                               "N2_M4"
                     );
     else
        RegisterTable( "N2_MainTable_2", TableHead5,
                               "N2_B1",
                               "N2_‚2",
                               "N2_M1",
                               "N2_M2"
                     );
     end;
  end;

  macro PrintTableLineSecSmpl()
     record rFi(fininstr);
     record rAv(avoiriss);
     var ISIN = "", AvrKind = "", SerIssTranche = "";
     var Series = "", Issue = "", Tranche = "";
     var sumPrIn,sumPrOut;
     if( not m_RegisterTable )
        RegisterTableSecSmpl();
        m_RegisterTable = true;
     end;

     if( ®«ãç¨âì”¨­ˆ­(m_FIID, rFi, rAv) == 0 )
        /*‚¨¤ –*/
        AvoirKindName( ToINT(rFi.AvoirKind), AvrKind );

        /* A7, A7.1, A7.2 */
        SerIssTranche = GetSeriesIssueTrancheInfo( rAv, @Series, @Issue, @Tranche );

        if( rAv.ISIN )
           ISIN = rAv.ISIN;
        else
           ISIN = rAv.LSIN;
        end;
     end;
     sumPrIn = SetPrecisionByFractPart(m_InRest, SumPrecision, 2);
     sumPrOut = SetPrecisionByFractPart(m_OutRest, SumPrecision, 2);

     if (RepData.IsPrognos)
        PrintTableLine( "N2_A1", AvrKind, null,
                        "N2_A2", ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ (FI_GetIssuerOnDate(rFi, RepData.DateEnd )), null,
                        "N2_A3", ISIN, null,
                        "N2_A4", Series, null,
                        "N2_A5", Issue, null,
                        "N2_A6", Tranche, null,
                        "N2_N0", m_Account, null,
                        "N2_N1", DigitIsApp(m_InRest,sumPrIn, true), sumPrIn,
                        "N2_N2", DigitIsApp(m_OutRest,sumPrOut, true), sumPrOut,
                        "N2_N3", DigitIsApp(m_InRestVirt,sumPrIn, true), sumPrIn,
                        "N2_N4", DigitIsApp(m_OutRestVirt,sumPrOut, true), sumPrOut
                      );
     else
        PrintTableLine( "N2_A1", AvrKind, null,
                        "N2_A2", ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ (FI_GetIssuerOnDate(rFi, RepData.DateEnd )), null,
                        "N2_A3", ISIN, null,
                        "N2_A4", Series, null,
                        "N2_A5", Issue, null,
                        "N2_A6", Tranche, null,
                        "N2_N0", m_Account, null,
                        "N2_N1", DigitIsApp(m_InRest,sumPrIn, true), sumPrIn,
                        "N2_N2", DigitIsApp(m_OutRest,sumPrOut, true), sumPrOut
                      );
     end;
  end;

  macro PrintTableMonSmpl()
     var sumPrIn,sumPrOut;
     if( not m_RegisterTable )
        RegisterTableMonSmpl();
        m_RegisterTable = true;
     end;
     sumPrIn = SetPrecisionByFractPart(m_InRest, SumPrecision, 2);
     sumPrOut = SetPrecisionByFractPart(m_OutRest, SumPrecision, 2);
     if (RepData.IsPrognos)
        PrintTableLine( "N2_B1", m_Account, null,
                        "N2_‚2", GetFinInstrCcy(m_FIID,true,false), null,
                        "N2_M1", DigitIsApp(Abs(m_InRest), sumPrIn,true), sumPrIn,
                        "N2_M2", DigitIsApp(Abs(m_OutRest), sumPrOut, true), sumPrOut,
                        "N2_M3", DigitIsApp(Abs(m_InRestVirt), sumPrIn,true), sumPrIn,
                        "N2_M4", DigitIsApp(Abs(m_OutRestVirt), sumPrOut, true), sumPrOut
                      );
     else
        PrintTableLine( "N2_B1", m_Account, null,
                        "N2_‚2", GetFinInstrCcy(m_FIID,true,false), null,
                        "N2_M1", DigitIsApp(Abs(m_InRest), sumPrIn,true), sumPrIn,
                        "N2_M2", DigitIsApp(Abs(m_OutRest), sumPrOut, true), sumPrOut
                      );
     end;
  end;

  macro PrintCommFooter()
    EndReportTab();
    if (RepData.IsPrognos)
       PrintFormatString( t_CommFooterPrognos, 
                          m_Prefix+"2_1",  DigitIsApp(m_BankCommSum, SumPrecision,true),
                          m_Prefix+"2_2", GetFinInstrCcy(m_FIID,true,false),
                          m_Prefix+"02_1",DigitIsApp(m_BankCommSumVirt, SumPrecision,true),
                          m_Prefix+"2_3", DigitIsApp(m_AgentCommSum, SumPrecision, true),
                          m_Prefix+"2_4", GetFinInstrCcy(m_FIID,true,false),
                          m_Prefix+"02_3",DigitIsApp(m_AgentCommSumVirt, SumPrecision,true),
                          m_Prefix+"2_5", DigitIsApp(‘ã¬¬ ‚®§¬¥é¥­¨ïŠ«¨¥­â®¬(), SumPrecision, true),
                          m_Prefix+"2_6", GetFinInstrCcy(m_FIID,true,false),
                          m_Prefix+"02_5",DigitIsApp($0.0, SumPrecision,true)
                        );
    else
       PrintFormatString( t_CommFooter, m_Prefix+"2_1",  DigitIsApp(m_BankCommSum, SumPrecision,true),
                                 m_Prefix+"2_2", GetFinInstrCcy(m_FIID,true,false),
                                 m_Prefix+"2_3", DigitIsApp(m_AgentCommSum, SumPrecision, true),
                                 m_Prefix+"2_4", GetFinInstrCcy(m_FIID,true,false),
                                 m_Prefix+"2_5", DigitIsApp(‘ã¬¬ ‚®§¬¥é¥­¨ïŠ«¨¥­â®¬(), SumPrecision, true),
                                 m_Prefix+"2_6", GetFinInstrCcy(m_FIID,true,false)
                        );
    end;
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"CommFooter", 1 );
  end;

  macro RegisterTableOper()
     CopyAllSheetInTotalBook( m_SheetName, false, "N3_TableHeader", 0 );
     if (RepData.IsPrognos)
        RegisterTable( "N3_MainTable", TableHeadProg1,
                       "N3_C1",
                       "N3_C1_P",
                       "N3_C2",
                       "N3_C3",
                       "N3_C4",
                       "N3_C5",
                       "N3_C6",
                       "N3_C7",
                       "N3_C8",
                       "N3_C9",
                       "N3_C10",
                       "N3_C11",
                       "N3_C12",
                       "N3_C13",
                       "N3_C14",
                       "N3_C15",
                       "N3_C16",
                       "N3_C17",
                       "N3_C18",
                       "N3_C19",
                       "N3_C20",
                       "N3_C21",
                       "N3_C22",
                       "N3_C23"
                     );
     else
        RegisterTable( "N3_MainTable", TableHead1,
                       "N3_C1",
                       "N3_C2",
                       "N3_C3",
                       "N3_C4",
                       "N3_C5",
                       "N3_C6",
                       "N3_C7",
                       "N3_C8",
                       "N3_C9",
                       "N3_C10",
                       "N3_C11",
                       "N3_C12",
                       "N3_C13",
                       "N3_C14",
                       "N3_C15",
                       "N3_C16",
                       "N3_C17",
                       "N3_C18",
                       "N3_C19",
                       "N3_C20",
                       "N3_C21",
                       "N3_C22",
                       "N3_C23"
                     );
     end;
  end;

  macro PrintTableLineOper(DealCode:string, DealDateInfo:string, DealTime:string, DealType:string,
                          OrderNumber:string, Issuer:string, ISIN:string, AvrKind:string, Series:string, Issue:string, Tranche:string,
                          Price, Currency:string, Amount, Summ, NKD, Cur_NKD, AgentComm, BankComm,
                          SumClient, AvrDate:string, MoneyDate:string, RejectInfo:string, IsPrognos:string)
     var sumPr;
     if( not m_RegisterTable )
        RegisterTableOper();
        m_RegisterTable = true;
     end;
     if( PrintMode() == DL_OUTREPORT_EXCEL )
        Amount = DL_GetPrintNumber(Amount,SumPrecision);
     end;
     sumPr = SetPrecisionByFractPart(Amount, SumPrecision, 0);

     if (RepData.IsPrognos)
        PrintTableLine("N3_C1", DealCode,                                null,
                       "N3_C1_P", IsPrognos,                             null,
                       "N3_C2", DealDateInfo,                            null,
                       "N3_C3", DealTime,                                null,
                       "N3_C4", DealType,                                null,
                       "N3_C5", OrderNumber,                             null,
                       "N3_C6", Issuer,                                  null,
                       "N3_C7", AvrKind,                                 null,
                       "N3_C8", ISIN,                                    null,
                       "N3_C9", Series,                                  null,
                       "N3_C10",Issue,                                   null,
                       "N3_C11",Tranche,                                 null,
                       "N3_C12",DigitIsApp(Price,4),                     4,
                       "N3_C13",Currency,                                null,
                       "N3_C14",DigitIsApp(Amount, sumPr, true),         sumPr,
                       "N3_C15",DigitIsApp(Summ, 2),                     2,
                       "N3_C16",DigitIsApp(NKD,2),                       2,
                       "N3_C17",Cur_NKD,                                 null,
                       "N3_C18",DigitIsApp(AgentComm,2),                 2,
                       "N3_C19",DigitIsApp(BankComm,2),                  2,
                       "N3_C20",DigitIsApp(SumClient,2),                 2,
                       "N3_C21",AvrDate,                                 null,
                       "N3_C22",MoneyDate,                               null,
                       "N3_C23",RejectInfo,                              null
                      );
     else
        PrintTableLine("N3_C1", DealCode,                                null,
                       "N3_C2", DealDateInfo,                            null,
                       "N3_C3", DealTime,                                null,
                       "N3_C4", DealType,                                null,
                       "N3_C5", OrderNumber,                             null,
                       "N3_C6", Issuer,                                  null,
                       "N3_C7", AvrKind,                                 null,
                       "N3_C8", ISIN,                                    null,
                       "N3_C9", Series,                                  null,
                       "N3_C10",Issue,                                   null,
                       "N3_C11",Tranche,                                 null,
                       "N3_C12",DigitIsApp(Price,4),                     4,
                       "N3_C13",Currency,                                null,
                       "N3_C14",DigitIsApp(Amount, sumPr, true),         sumPr,
                       "N3_C15",DigitIsApp(Summ, 2),                     2,
                       "N3_C16",DigitIsApp(NKD,2),                       2,
                       "N3_C17",Cur_NKD,                                 null,
                       "N3_C18",DigitIsApp(AgentComm,2),                 2,
                       "N3_C19",DigitIsApp(BankComm,2),                  2,
                       "N3_C20",DigitIsApp(SumClient,2),                 2,
                       "N3_C21",AvrDate,                                 null,
                       "N3_C22",MoneyDate,                               null,
                       "N3_C23",RejectInfo,                              null
                      );
     end;
  end;

  private macro PrintPlace(Market)
     EndReportTab();
     PrintFormatString( "Œ¥áâ® á®¢¥àè¥­¨ï ®¯¥à æ¨©:#\n", "N3_H3_1", Market );
     CopyAllSheetInTotalBook( m_SheetName, false, "N3_Place", 1 );
  end;

  private macro PrintOperKind(Kind)
     EndReportTab();
     PrintFormatString( "#\n", "N3_H4", Kind );
     CopyAllSheetInTotalBook( m_SheetName, false, "N3_H4", 1 );
  end;

  // ¯®«ãç¨âì ¢å®¤ ‚ˆ’“€‹œ›‰ ®áâ â®ª
  private macro GetVirtualInSum()
    // ¢ëç¨á«¥­¨¥ ¢å®¤ïé¥© ¢¨àâã «ì­®© áã¬¬ë 
    // (¯®¨áª áã¬¬ ­¥¨á¯®«­¥­­ëå ’Ž ¯® ¯®¤å®¤ïé¨¬ á¤¥«ª ¬). 
    var sql = "SELECT NVL(Sum(rq.t_Amount*DECODE (rq.t_Kind, 0, -1, 1)), 0) VirtSum" +
              "  FROM ddl_tick_dbt tick, ddlrq_dbt rq" +
              " WHERE tick.t_BOfficeKind in (101,117,127)" +  // DL_SECURITYDOC, DL_RETIREMENT, DL_AVRWRT
              "   AND ( (tick.t_DealStatus = 0 and tick.t_Prognos = chr(88)) or (tick.t_DealStatus <= 10)) " +
              "   AND tick.t_Department = ?" +
              "   AND tick.t_ClientContrID = ?" +
              "   AND tick.T_ClientID = ?" +
              "   AND rq.t_DocID = tick.t_DealID " +
              "   AND rq.t_DocKind = tick.t_BOfficeKind " +
              "   AND rq.t_state = 0 " + // ­¥§ ¢¥à¥è¥­­ë¥
              "   AND rq.t_FIID = ? " +
              "   AND rq.t_PlanDate < ?"; //to_date('22.11.2014', 'DD.MM.YYYY')    
    
    var cmd = DL_RSDCommand(sql);

    cmd.addParam(RepData.DprtID);
    cmd.addParam(RepData.ContrID);
    cmd.addParam(RepData.ClientID);
    cmd.addParam(m_FIID);
    if(RepData.IsSeparatelyDate == false)
       cmd.addParam(RepData.DateBegin);
    else
       cmd.addParam(m_CurDate);
    end;
    var dataSet = cmd.Execute();
    if (dataSet.MoveNext())
      m_InRestVirt = SQL_ConvTypeSum(dataSet.VirtSum);
    end;
  end;

  macro PrintOperFooter()
    var BalansCalc = $0, OutRem = $0, sumPrec = 2;
    var BalansCalcVirt = $0, OutRemVirt = $0;
    record AccBuf(account);
    ClearRecord( AccBuf );
    if( GetAccount( 21, m_FIID, m_Account, AccBuf ) )
       if(RepData.IsSeparatelyDate == false)
          m_InRest = GetRestAccount( AccBuf, RepData.DateBegin-1 );
       else
          m_InRest = GetRestAccount( AccBuf, m_CurDate-1 );
       end;
       // ¢å®¤. ¢¨àâã «ì­ë© ®áâ â®ª ¯® áç¥âã
       if (RepData.IsPrognos)
          GetVirtualInSum();
          m_InRestVirt = m_InRest + m_InRestVirt; // ¢¨àâã «ì­ë© ®áâ â®ª = à¥ «ì­®¬ã + ¢¨àâã «ì­®¬ã
       end;
    end;
    
    BalansCalc = m_SumSale + m_AmountCup - m_SumBuy - m_AgentCommSum - m_BankCommSum;
    OutRem = m_InRest + m_RetFac - m_WrtSum + m_IncSum - BalansCalc - m_WrtSumCl;

    if((RepData.Totals) and (m_IsExistsClOper == true))
       if (RepData.IsPrognos)

          BalansCalcVirt = (m_SumSale+m_SumSaleVirt) + m_AmountCup - (m_SumBuy+m_SumBuyVirt) - (m_AgentCommSum+m_AgentCommSumVirt) - (m_BankCommSum+m_BankCommSumVirt);
          OutRemVirt = m_InRestVirt + m_RetFacVirt - m_WrtSum - BalansCalcVirt - m_WrtSumClVirt;    
         
          PrintFormatString( t_AccFooterPrognos, 
                                    "N3_F1", m_Account,                            /*F3.1*/
                                    "N3_F2",   GetFinInstrCcy(m_FIID,true,false),  /*F3.2*/
                                    "N3_F3",   DigitIsApp(m_InRest,sumPrec,true),  /*F3.3*/
                                    "N3_F3_P", DigitIsApp(m_InRestVirt,sumPrec,true),/*P2*/
                                    "N3_F4",   DigitIsApp(m_RetFac,sumPrec,true),   /*F3.4*/
                                    "N3_F4_P", DigitIsApp(m_RetFacVirt,sumPrec,true), /*P3*/
                                    "N3_F5",   DigitIsApp(m_WrtSum,sumPrec,true),   /*F3.5*/
                                    "N3_F5_P", "",
                                    "N3_F6",   DigitIsApp(m_SumBuy,sumPrec,true),   /*F3.6*/
                                    "N3_F6_P", DigitIsApp(m_SumBuy+m_SumBuyVirt,sumPrec,true), /*P4*/
                                    "N3_F7",   DigitIsApp(m_SumSale,sumPrec,true),             /*F3.8*/
                                    "N3_F7_P", DigitIsApp(m_SumSale+m_SumSaleVirt,sumPrec,true), /*P5*/
                                    "N3_F8",   DigitIsApp(m_AmountCup,sumPrec,true),        /*F3.10*/
                                    "N3_F8_P", "",
                                    "N3_F9",   DigitIsApp(m_AgentCommSum,sumPrec,true),      /*F3.11*/
                                    "N3_F9_P", DigitIsApp(m_AgentCommSum+m_AgentCommSumVirt,sumPrec,true), /*P6*/
                                    "N3_F10",  DigitIsApp(m_AgentSumNDS,sumPrec,true),      /*F3.12*/
                                    "N3_F10_P",DigitIsApp(m_AgentSumNDS+m_AgentSumNDSVirt,sumPrec,true),   /*P7*/
                                    "N3_F11",  DigitIsApp(m_BankCommSum,sumPrec,true),       /*F3.13*/
                                    "N3_F11_P",DigitIsApp(m_BankCommSum+m_BankCommSumVirt,sumPrec,true),   /*P8*/
                                    "N3_F12",  DigitIsApp(m_BankCommNDS,sumPrec,true),         /*F3.14*/
                                    "N3_F12_P",DigitIsApp(m_BankCommNDS+m_BankCommNDSVirt,sumPrec,true),   /*P9*/
                                    "N3_F13",  DigitIsApp(BalansCalc,sumPrec,true),           /*F3.15*/
                                    "N3_F13_P",DigitIsApp(BalansCalcVirt,sumPrec,true),                    /*P10*/
                                    "N3_F14",  DigitIsApp(m_IncSum,sumPrec,true),      /*F3.16*/
                                    "N3_F14_P","",
                                    "N3_F15",  DigitIsApp(m_WrtSumCl,sumPrec,true),    /*F3.17*/
                                    "N3_F15_P",DigitIsApp(m_WrtSumClVirt,sumPrec,true),         /*P11*/
                                    "N3_F16",  DigitIsApp(OutRem,sumPrec,true),        /*F3.18*/
                                    "N3_F17",  DigitIsApp(OutRemVirt,sumPrec,true)     /*P12*/
                           );
       else
          PrintFormatString( t_AccFooter, "N3_F1", m_Account,
                                    "N3_F2", GetFinInstrCcy(m_FIID,true,false),
                                    "N3_F3", DigitIsApp(m_InRest,sumPrec,true),
                                    "N3_F4", DigitIsApp(m_RetFac,sumPrec,true),
                                    "N3_F5", DigitIsApp(m_WrtSum,sumPrec,true),
                                    "N3_F6", DigitIsApp(m_SumBuy,sumPrec,true),
                                    "N3_F7", DigitIsApp(m_SumSale,sumPrec,true),
                                    "N3_F8", DigitIsApp(m_AmountCup,sumPrec,true),
                                    "N3_F9", DigitIsApp(m_AgentCommSum,sumPrec,true),
                                    "N3_F10",DigitIsApp(m_AgentSumNDS,sumPrec,true),
                                    "N3_F11",DigitIsApp(m_BankCommSum,sumPrec,true),
                                    "N3_F12",DigitIsApp(m_BankCommNDS,sumPrec,true),
                                    "N3_F13",DigitIsApp(BalansCalc,sumPrec,true),
                                    "N3_F14",DigitIsApp(m_IncSum,sumPrec,true),
                                    "N3_F15",DigitIsApp(m_WrtSumCl,sumPrec,true),
                                    "N3_F16",DigitIsApp(OutRem,sumPrec,true)
                           );
       end;
       CopyAllSheetInTotalBook( m_SheetName, false, "N3_AccFooter", 1 );
    end;
  end;

  private macro ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©(Opertype:string,IsOut:bool)
        var DataSelect;
        var Select = RSDCommand(" SELECT NVL(Sum(inacc.t_Sum),0) OperSum " +
                                " FROM   ddlinacc_dbt inacc  " +
                                " WHERE " + IIF(IsOut," inacc.t_KredAcc = ? "," inacc.t_DebAcc = ? ") +
                                "   AND inacc.t_Department = ? " +
                                "   AND inacc.t_Opertype in(" + Opertype + ")"+
                                "   AND inacc.t_FIID = ? " +
                                "   AND inacc.t_Date <= ? " +
                                "   AND inacc.t_Date >= ? " +
                                "   AND inacc.t_AccTrnID > 0 ");

         Select.addParam("", RSDBP_IN, m_Account);
         Select.addParam("", RSDBP_IN, RepData.DprtID);
         Select.addParam("", RSDBP_IN, m_FIID);
         if(RepData.IsSeparatelyDate == false)
           Select.addParam("", RSDBP_IN, RepData.DateEnd);
           Select.addParam("", RSDBP_IN, RepData.DateBegin);
         else
           Select.addParam("", RSDBP_IN, m_CurDate);
           Select.addParam("", RSDBP_IN, m_CurDate);
         end;

         Select.execute();

         DataSelect = TRsbDataSet(Select);
         if( DataSelect.MoveNext() )
           return DataSelect.OperSum;
         else
           return $0;
         end;
  end;

  private macro ˆâ®£¨®‘ç¥âã()

     EndReportTab();

     m_RetFac       = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("6",false);
     m_WrtSum       = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("2,3",true);
     m_SumBuy       = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("20,21",true);
     m_SumSale      = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("20,21",false);
     m_AmountCup    = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("22,23",false);
     m_AgentCommSum = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("9,10,11,12",true);
     m_BankCommSum  = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("8",true);
     m_IncSum       = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("4,5",false);
     m_WrtSumCl     = ‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("7",true);

     PrintOperFooter();
     ClearData();
  end;                                                                                   

  private macro ¥ç âì‘âà®ª¨Žâç¥â (OperName, OperKind, OperCode, Operdate, Sum, IsOut, IsPrognos)
      var In = 0, Out = 0;
      if( PrevDep != RepData.DprtID )
         IsPrintRepHeader = true;
         PrevClient       = "";
         PrevContr        = "";
         PrevAcc          = "";
      end;

      if( (m_KindRep == CLSTATUSACCOUNTORD_SMPL) AND m_IsExistsClAcc AND (PrevChapter == 22) AND
          ((PrevClient != m_ClientID) OR (PrevContr != m_ContrID) OR (PrevChapter != m_CHapter))
        )
         EndReportTab();
      end;

      if( PrevClient != m_ClientID )
         if( RepData.IsExcel )
            if( (PrevClient != "") AND (PrevClient != null) )
               PrintRepFooter();
            end;

            IsPrintRepHeader = true;
         end;
         IsPrintClient = true;
         PrevContr     = "";
         PrevAcc       = "";
      end;

      if( PrevContr != m_ContrID )
         IsPrintContr     = true;
         IsPrintSection   = true;
         PrevAcc          = "";
      end;

      if( m_KindRep == CLSTATUSACCOUNTORD )
         if( PrevChapter != m_CHapter )
            IsPrintSection   = true;
            PrevFI           = "";
            PrevAcc          = "";
         end;
         if( (m_Chapter == 22) AND (PrevFI != m_FIID) )
            IsPrintSec       = true;
            PrevAcc          = "";
         end;

         if( PrevAcc != m_Account )
            IsPrintAcc    = true;
         end;
      end;

      if( IsPrintRepHeader )
         PrintRepHeader();
         PrevDep          = RepData.DprtID;
      end;

      if( IsPrintClient )
         PrintClient();
         PrevClient    = m_ClientID;
      end;

      if( IsPrintContr )
         PrintContr();
         PrevContr        = m_ContrID;
      end;

      if( m_KindRep == CLSTATUSACCOUNTORD )

         if( IsPrintSection )
           if( m_Chapter == 22 )
              PrintSecHeader();
           else
              PrintMonHeader();
           end;
         end;

         if( (m_Chapter == 22) AND IsPrintSec )
            PrintSec();
            PrevFI = m_FIID;
         end;

         if( IsPrintAcc )
           if(m_Chapter == 22)
              PrintSecAcc();
           else
              PrintMonAcc();
           end;
           PrevAcc = m_Account;
         end;
      end;
      if((m_KindRep == CLSTATUSACCOUNTORD) and (m_IsExistsCarry == true))
         if(IsOut == 0) /*‡ ç¨á«¥­¨¥*/
            In = Sum;
         else /*á¯¨á ­¨¥*/
            Out = Sum;
         end;
         PrintTableLineAcc(Operdate,OperName,OperKind,OperCode,In,Out, IsPrognos);
      elif(m_KindRep == CLSTATUSACCOUNTORD_SMPL)
         if(m_Chapter == 22)
            PrintTableLineSecSmpl();
         else
            if(PrevChapter != m_CHapter)
               PrintFormatString( "     ˆ­ä®à¬ æ¨ï ®¡ ®áâ âª å ¤¥­¥¦­ëå áà¥¤áâ¢  \n" );
               CopyAllSheetInTotalBook( m_SheetName, false, "N2_MonHeader", 1 );
            end;
            PrintTableMonSmpl();
         end;
      end;

      PrevChapter = m_CHapter;
      m_IsRepPrint = true;

      if(m_KindRep == CLOPERORDER)
         m_IsExistsClOper = true;
         m_IsExistsClOperGlobal = true;
      else
         m_IsExistsClAcc = true;
         m_IsExistsClAccGlobal = true;
         m_IsPrintByAcc = true;
      end;
  end;

  macro ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã®Ž¯¥à æ¨ï¬Š«¨¥­â ( DealInfo, IsBack, DealIsREPO, Place, Account, Currency, Status )
    var StartDate, StopDate;
    if(RepData.IsSeparatelyDate == false)
      StartDate = RepData.DateBegin;
      StopDate = RepData.DateEnd;
    else
      StartDate = m_CurDate;
      StopDate = m_CurDate;
    end;    

    /*15.6.  …á«¨ ¢ ä®à¬¥ § ¯ãáª  ãáâ ­®¢«¥­ ¯à¨§­ ª "à®£­®§", 
             â® ¢ ®âç¥â, ¢­¥ § ¢¨á¨¬®áâ¨ ®â â®£®, ª ª®© ¢ à¨ ­â ä®à¬¨à®¢ ­¨ï ®âç¥â  ¢ë¡à ­,
             ªà®¬¥ á¤¥«®ª, ã¤®¢«¥â¢®àïîé¨å ãá«®¢¨ï¬ ®â¡®à  ¢ë¡à ­­®£® ¢¨¤  ®âç¥â ,
             ®â¡¨à îâáï ®â«®¦¥­­ë¥ á¤¥«ª¨ á ãáâ ­®¢«¥­­ë¬ ¯à¨§­ ª®¬ "à®£­®§", 
               â ª ¦¥ ¢á¥ ­¥ § ªàëâë¥ á¤¥«ª¨ ¤«ï ª®â®àëå ¯« ­®¢ë¥ ¤ âë ¨á¯®«­¥­¨ï <= „ â  ®ª®­ç ­¨ï ®âç¥â­®£® ¯¥à¨®¤ .
             „«ï ®âç¥â  ¯® ¤¥­¥¦­ë¬ áà¥¤áâ¢ ¬ ¯à®¢¥àïîâáï ¤ âë ®¯« âë, ¤«ï ®âç¥â  ¯® æ¥­­ë¬ ¡ã¬ £ ¬ - ¤ âë ¯®áâ ¢ª¨*/
   if( (DealInfo.IsPrognos == SET_CHAR) and (DealInfo.DealStatus == DL_PREPARING) )
     if(DealIsREPO == true)
       ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, false, IIF(Account != "", STAT_CONCLUSION, STAT_NOTACC),
                               DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                               DealInfo.ClientID, DealInfo.ContrID,
                               Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
     end;
     ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, IsBack, IIF(Account != "", STAT_CONCLUSION, STAT_NOTACC),
                             DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                             DealInfo.ClientID, DealInfo.ContrID,
                             Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
   else
    if(RepData.OperState == STAT_ALL)
          /*‡ ¢¥àè¥­­ë¥*/
          if((DealInfo.CloseDate >= StartDate) AND
             (DealInfo.CloseDate <= StopDate))
             /*¥á«¨ á¤¥«ª  …Ž, â® § ­®á¨¬ á­ ç «  ¯¥à¢ãî ç áâì, § â¥¬ ¢â®àãî.
               â¨ ç áâ¨ ®¡¥ ¤®«¦­ë ¯®¯ áâì ¢ ®¤¨­ à §¤¥« ®âç¥â */
             if(DealIsREPO == true)
               ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, false, IIF(Account != "", STAT_FINISHED, STAT_NOTACC),
                                       DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                       DealInfo.ClientID, DealInfo.ContrID,
                                       Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
             end;
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, IsBack, IIF(Account != "", STAT_FINISHED, STAT_NOTACC),
                                     DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                     DealInfo.ClientID, DealInfo.ContrID,
                                     Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );

          elif(((DealInfo.DealDate >= StartDate) AND (DealInfo.DealDate <= StopDate)) AND
               ((DealInfo.CloseDate > StopDate) OR (DealInfo.CloseDate == Date(0,0,0))))  /*¥§ ¢¥àè¥­­ë¥*/
             if(DealIsREPO == true)
               ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, false, IIF(Account != "", STAT_NOTFINISHED, STAT_NOTACC),
                                       DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                       DealInfo.ClientID, DealInfo.ContrID,
                                       Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
             end;
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, IsBack, IIF(Account != "", STAT_NOTFINISHED, STAT_NOTACC),
                                     DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                     DealInfo.ClientID, DealInfo.ContrID,
                                     Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
          end;

        elif(RepData.OperState == STAT_FINISHED) /*‡ ¢¥àè¥­­ë¥*/
          if((DealInfo.CloseDate >= StartDate) AND
             (DealInfo.CloseDate <= StopDate))
             if(DealIsREPO == true)
               ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, false, IIF(Account != "", STAT_FINISHED, STAT_NOTACC),
                                       DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                       DealInfo.ClientID, DealInfo.ContrID,
                                       Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
             end;
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, IsBack, IIF(Account != "", STAT_FINISHED, STAT_NOTACC),
                                     DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                     DealInfo.ClientID, DealInfo.ContrID,
                                     Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
          end;

        elif(RepData.OperState == STAT_NOTFINISHED) /*¥§ ¢¥àè¥­­ë¥*/
          if(((DealInfo.DealDate >= StartDate) AND (DealInfo.DealDate <= StopDate)) AND
             ((DealInfo.CloseDate > StopDate) OR (DealInfo.CloseDate == Date(0,0,0))))  /*¥§ ¢¥àè¥­­ë¥*/
             if(DealIsREPO == true)
               ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, false, IIF(Account != "", STAT_NOTFINISHED, STAT_NOTACC),
                                       DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                       DealInfo.ClientID, DealInfo.ContrID,
                                       Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
             end;
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, IsBack, IIF(Account != "", STAT_NOTFINISHED, STAT_NOTACC),
                                     DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                     DealInfo.ClientID, DealInfo.ContrID,
                                     Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
          end;

        else /*§ ª«îç¥­­ë¥*/
          if((DealInfo.DealDate >= StartDate) AND
             (DealInfo.DealDate <= StopDate))
             if(DealIsREPO == true)
               ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, false, IIF(Account != "", STAT_CONCLUSION, STAT_NOTACC),
                                       DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                       DealInfo.ClientID, DealInfo.ContrID,
                                       Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
             end;
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( DealInfo.DealID, IsBack, IIF(Account != "", STAT_CONCLUSION, STAT_NOTACC),
                                     DealInfo.BofficeKind, DealInfo.DealDate, DealInfo.DealTime, Place,
                                     DealInfo.ClientID, DealInfo.ContrID,
                                     Account, Currency, -1, 0, DealInfo.IsPrognos, DealInfo.IsPartyClient );
          end;
        end;
    end;

  end;

  // ®«ãç¨âì ¢¨àãâ «ì­ë¥ áã¬¬ë ¯® á¤¥«ª¥
  private macro GetVirtualSumForTick(tick)
    // ¨é¥¬ áã¬¬ë ¯® ’Ž
    // ¢¨àâã «ì­ë¥ ¯à®¢®¤ª¨ á ¢¨¤®¬ à áç¥â­®© ®¯¥à æ¨¨ = "Ž¯« â  æ/¡" ¨«¨ "Ž¯« â   ¢ ­á /§ ¤ âª ". 
    var sql = "SELECT NVL(SUM(rq.t_amount),0) as t_SumAmount " + 
              "  FROM ddlrq_dbt rq " +
              " WHERE rq.t_DocID = ?" +
              "   AND rq.t_DocKind = ?" +
              "   AND rq.t_FIID = ?" +
              "   AND rq.t_type IN (0,1,2) " + // DLRQ_TYPE_AVANCE, DLRQ_TYPE_DEPOSIT, DLRQ_TYPE_PAYMENT
              "   AND rq.t_state = 0" + // ­¥§ ¢¥àè¥­­ë¥ (¢¨àâã «ì­ë¥)
              "   AND rq.t_PlanDate BETWEEN ? AND ?";
        
    var cmd = DL_RSDCommand(sql);
    cmd.addParam(tick.rec.DealID);
    cmd.addParam(tick.rec.BOfficeKind);
    cmd.addParam(m_FIID);
    if(RepData.IsSeparatelyDate == false)
       cmd.addParam(RepData.DateBegin);
       cmd.addParam(RepData.DateEnd);
    else
       cmd.addParam(m_CurDate);
       cmd.addParam(m_CurDate);
    end;
    var dataSet = cmd.Execute();
    if (dataSet.MoveNext())
      m_SumBuyVirt = m_SumBuyVirt + dataSet.SumAmount;
      m_SumSaleVirt = m_SumBuyVirt;
    end;
  end;
  /* ¥ç â ¥¬ ¨­ä®à¬ æ¨î ® ®¤­®¬ á®áâ®ï­¨¨ á¤¥«ª¨.
        FD          -  FD ¯® á®®â¢¥âáâ¢ãîé¥© ç áâ¨ á¤¥«ª¨
        DealCh      -  ãá«®¢¨ï á¤¥«ª¨
        RejectInfo  -  ¨­ä®à¬ æ¨ï ®¡ ®âª §¥
        OrderNumber -  ­®¬¥à ¯®àãç¥­¨ï */
  macro PrintDealCondition( FD, DealCh, RejectInfo, OrderNumber, Principal2, IsPrognos, IsPartyClient )
     record rFi(fininstr);
     var
        DealTime, DealType, Issuer, ISIN,
        AvrKind, SerIssTranche, Price, Amount, Sum_v, Currency, Summ, NKD = "", Cur_NKD = "",
        PlanAvrDate, PlanMoneyDate, FactAvrDate, FactMoneyDate, DateNKD,
        DealTypeGr, DealDateInfo, Deal, CFI, Cost, TempDate;
    var BankComm = $0, BankContrComm = $0, AgentComm = $0, SumClient = $0, AmountCup = $0;
     Deal        = FD.tick.rec;
     CFI         = IIF( FD.IsBack, DealCh.OldCFI2, DealCh.OldCFI1 );
     Cost   = IIF( FD.IsBack, DealCh.OldCost2, DealCh.OldCost1 );
    var Series = "", Issue = "", Tranche = "";

     /*   Š®«¨ç¥áâ¢® æ/¡ */
     if((FD.tick.rec.BOfficeKind == DL_CONVAVR) AND (FD.IsBack == true))
        Amount = Principal2;
     else
        Amount = DealCh.OldPrincipal;
     end;

     /* D1 - „ â  á®¢¥àè¥­¨ï
        „ â  § ª«îç¥­¨ï á¤¥«ª¨ (¢ë¯®«­¥­¨ï ®¯¥à æ¨¨). „«ï ¢ª«îç¥­­®©
        ­ áâà®©ª¨ "Žâ®¡à ¦ âì ¨§¬¥­¥­¨¥ ãá«®¢¨© á¤¥«®ª ¢ ®âç¥â å" ¤«ï ¢á¥å
        ¢ à¨ ­â®¢ ãá«®¢¨© á¤¥«ª¨ ¯®á«¥ ¯¥à¢®­ ç «ì­®£® - ¤ â  ¨§¬¥­¥­¨ï
        ãá«®¢¨© á¤¥«ª¨. ‘¬. "€«£®à¨â¬ ä®à¬¨à®¢ ­¨ï ®âç¥â ". */
     if( RepData.ShowDealChange )
        if( DealCh.OldChangeDate != ZeroDate )
           /* ‚ª«îç¥­  ­ áâà®©ª  ¨ íâ® ­¥ ¯¥à¢®­ ç «ì­ë¥ ãá«®¢¨ï. */
           DealDateInfo = DateToStr( DealCh.OldChangeDate ) + "/" + "¨§¬¥­¥­.";
        else
           DealDateInfo = DateToStr( FD.tick.rec.DealDate ) + "/" + "§ ª«îç.";
        end;
     else
        DealDateInfo = DateToStr( FD.tick.rec.DealDate );
     end;

     if (FD.tick.rec.BOfficeKind == DL_CONVAVR)
        DealDateInfo = DateToStr( FD.tick.rec.DealDate );
     end;

     /* A1.1 = ‡ ¯®«­ï¥âáï, â®«ìª® ¥á«¨ ¢ª«îç¥­  ­ áâà®©ª  "Žâ®¡à ¦ âì
        ¨§¬¥­¥­¨¥ ãá«®¢¨© á¤¥«®ª ¢ ®âç¥â å". „«ï ¯¥à¢®­ ç «ì­®£® ¢ à¨ ­â 
        ãá«®¢¨© á¤¥«ª¨ -  â¥ªáâ "§ ª«îç." „«ï  ­®¢ëå ãá«®¢¨© á¤¥«®ª,
        § ¬¥­ïîé¨å áâ àë¥ - â¥ªáâ "¨§¬¥­¥­." */

      /*‚à¥¬ï § ª«îç¥­¨ï (¡¥§ á¥ªã­¤)*/
      DealTime = SPTimeSplit(FD.tick.rec.DealTime);

     /* A3.1 - ‚¨¤ ®¯¥à æ¨¨
         ¨¬¥­®¢ ­¨¥ ¢¨¤  ®¯¥à æ¨¨ (¯¥à¥ç¥­ì ¢¨¤®¢ ®¯¥à æ¨© á¬. ¢ ¯.€«£®à¨â¬
        ä®à¬¨à®¢ ­¨ï ®âç¥â )*/

     if( IsPartyClient == SET_CHAR)
       DealType = ®«ãç¨âì‚¨¤‘¤¥«ª¨Š®­âà £¥­â „(FD.Group, FD.IsBack, true);
     else
       DealType = ®«ãç¨âì‚¨¤Ž¯¥à æ¨¨( FD.Group, FD.IsBack, true, true );
     end;

      /*®¤¢¨¤*/
      if(IsRET_COUPON(FD.Group))
        DealTypeGr = "ªã¯.ü "+ string(FD.tick.rec.Number_Coupon);
      elif(IsAVRWRTIN(FD.Group) OR IsAVRWRTOUT(FD.Group))
        /*Œ¥áâ® ãç¥â  æ/¡*/
        DealTypeGr = GetPartyShortNameByID( FD.pm_avoir.rec.ReceiverBankID );
        if( DealTypeGr != "" )
          DealTypeGr = "ãç¥â ¢ " + DealTypeGr;
        end;
      else
        DealTypeGr = "";
      end;

      if( FD.tick.rec.BOfficeKind == DL_CONVAVR )
        if(FD.IsBack)
          DealTypeGr = "§ ç¨á«¥­¨¥";
        else
          DealTypeGr = "á¯¨á ­¨¥";
        end;
      end;

      if( FD.tick.rec.BOfficeKind == DL_INVESTSHARE )
         DealType = "¯®«ãç¥­¨¥ ¯ ¥¢ ¯à¨ ¢ë¤ ç¥";
      end;

      /*í¬¨â¥­â*/
     Issuer = GetPartyShortNameByID( FI_GetIssuerOnDate(FD.fininstr, RepData.DateEnd ) );

     /*‚¨¤ –*/
     AvoirKindName( FD.fininstr.rec.AvoirKind, AvrKind );

     /* A12, A12.1, A12.2 */
     SerIssTranche = GetSeriesIssueTrancheInfo( FD.avoiriss.rec, @Series, @Issue, @Tranche );

     /* Œ1 - –¥­ 
        „«ï ¢á¥å á¤¥«®ª, ªà®¬¥ …Ž ¢ë¢®¤¨âáï æ¥­  ®¤­®© æ/¡ ¢ ¢ «îâ¥ æ¥­ë
        á¤¥«ª¨, ¤«ï 2 ç áâ¨ á¤¥«ª¨ …Ž ¢ë¢®¤¨âáï â¥ªáâ "áâ ¢ª " + áâ ¢ª 
        …Ž + "%", ¤«ï ®¯¥à æ¨© ¯®£ è¥­¨ï ¢ë¯ãáª  ¢ë¢®¤¨âáï ­®¬¨­ « +
        ¯à®æ¥­â­ë©/ªã¯®­­ë© ¤®å®¤ ¯® ®¤­®© æ/¡, ¤«ï ®¯¥à æ¨© ¯®£ è¥­¨ï
        ªã¯®­®¢ ¢ë¢®¤¨âáï â¥ªáâ "ªã¯. ¤®å." + áã¬¬  Š„ ¯® ®¤­®© æ/¡,
        ¤«ï ®¯¥à æ¨© á¯¨á ­¨ï/§ ç¨á«¥­¨ï ¯®«¥ ­¥ § ¯®«­ï¥âáï */
     if(IsAVRWRTIN(FD.Group) OR IsAVRWRTOUT(FD.Group))
        Price = "";
        Currency = "";
     elif(IsREPO(FD.Group) AND (FD.IsBack == true)) /*¥¯® 2 ç áâì*/
        Price = "áâ ¢ª  " + DigitIsApp(DoubleToMoney(DealCh.OldIncomeRate),4) + " %";
        Currency = GetFinInstrCcy( CFI );
     elif(IsRET_ISSUE(FD.Group))  /*¯®£ è¥­¨¥ ¢ë¯ãáª */
        Price = DigitIsApp(FD.FaceValueMoney + ‘ã¬¬ Šã¯®­  ( FD.fininstr.rec.FIID, $1, FD.tick.rec.DealDate),4);
        Currency = GetFinInstrCcy( FD.fininstr.rec.FaceValueFI );
     elif( IsRET_COUPON(FD.Group) )
        Price = "ªã¯. ¤®å. " + —¨á«®C‡ ¤ ­­®©’®ç­®áâìî(DoubleToMoney(FD.dl_leg.rec.NKD/FD.dl_leg.rec.Principal),4);
        Currency = GetFinInstrCcy( FD.fininstr.rec.FaceValueFI );
     elif(FD.tick.rec.BOfficeKind == DL_CONVAVR)
        Price = "";
        Currency = "";
     else
        Price = GetPriceByDlTickDlLeg( Deal, FD.dl_leg.rec, false, DealCh );
        Price = DigitIsApp( DoubleToMoney(Price), 4 );
        Currency = GetFinInstrCcy( CFI );
     end;

     /*‘ã¬¬  á¤¥«ª¨ ¢ ¢ «îâ¥ æ¥­ë*/
     /* ConvSum(¥§ã«ìâ â, ‘ª®«ìª®, „ â , ¨§”ˆ, ¢”ˆ, 0); */
     if(IsRET_ISSUE(FD.Group) OR IsRET_COUPON(FD.Group))
       ConvSum( Sum_v, FD.dl_leg.rec.Cost, FD.tick.rec.DealDate, FD.dl_leg.rec.CFI, FD.fininstr.rec.FaceValueFI, 0);
       Summ = Sum_v;
       m_AmountCup = ‘ã¬¬ Šã¯®­ (FD.fininstr.rec.FIID, $1, FD.tick.rec.DealDate);
     elif(IsAVRWRTIN(FD.Group) OR IsAVRWRTOUT(FD.Group))
       Summ = "";
       NKD = "";
       Cur_NKD = "";
     else
       Summ = Cost;
     end;

     PlanAvrDate = "";
     FactAvrDate = "";
     PlanMoneyDate = "";
     FactMoneyDate = "";

     /* D2.1 - „ â  ¯®áâ ¢ª¨ æ/¡
        « ­®¢ ï ¤ â  ¯®áâ ¢ª¨ æ/¡ (¤«ï ®¯¥à æ¨© ¯®£ è¥­¨ï ªã¯®­®¢ ­¥
        § ¯®«­ï¥âáï) */
     /* D2.2 = ” ªâ¨ç¥áª ï ¤ â  ¯®áâ ¢ª¨ æ/¡ - § ¯®«­ï¥âáï â®«ìª® ¤«ï
        ¨á¯®«­¥­­ëå ¯®áâ ¢®ª (¤«ï ®¯¥à æ¨© ¯®£ è¥­¨ï ªã¯®­®¢ ­¥
        § ¯®«­ï¥âáï) */
     PlanAvrDate = GetDealSetAvPlanDate( FD.dl_leg.rec, DealCh );

     if( (FD.pm_avoir != null) and (FD.pm_avoir.dlreq != NULL) )
       if(’Ž‡ ªàëâ®( FD.pm_avoir.dlreq ))
          FactAvrDate = GetDateAfterWorkDays(FD.pm_avoir.rec.ValueDate, 0, FD.®«ãç¨âìŠ «¥­¤‘¢ï§ ­­ë©());
       end;
     end;

     /* M3 - „«ï á¤¥«®ª ¯®ªã¯ª¨-¯à®¤ ¦¨ - Š„ ¢ ¢ «îâ¥ ­®¬¨­ «  æ/¡
            ¯® á¤¥«ª¥ ­  ¤ âã ¯®áâ ¢ª¨ ä ªâ¨ç¥áªãî,   ¥á«¨ ­¥â - â® ¯« ­®¢ãî. */

     if(FI_IsAvrKindCoupon(FD.fininstr.rec.AvoirKind))
        if((IsSALE(FD.Group)) or (IsBUY(FD.Group)))

           DateNKD = IIF(’Ž‡ ªàëâ®(FD.pm_avoir.dlreq),
                         FactAvrDate,
                         PlanAvrDate
                        );
           AmountCup = Š„(FD.fininstr.rec.FIID, FD.dl_leg.rec.Principal, DateNKD);

        elif(FD.tick.rec.BofficeKind == DL_RETIREMENT)
           AmountCup = FD.dl_leg.rec.NKD;
        end;

        if((FD.tick.rec.BofficeKind != DL_AVRWRT) AND (FD.tick.rec.BofficeKind != DL_CONVAVR))
           NKD = AmountCup;
           Cur_NKD = GetFinInstrCcy( FD.fininstr.rec.FaceValueFI );
        end;
     end;

     var StartDate, StopDate;
     if(RepData.IsSeparatelyDate == false)
       StartDate = RepData.DateBegin;
       StopDate = RepData.DateEnd;
     else
       StartDate = m_CurDate;
       StopDate = m_CurDate;
     end;

     VAR sum_agent = $0, sum_bank = $0, nds_agent = $0, nds_bank = $0;

     /*Ž¯« ç¥­­ ï ª®¬¨áá¨ï ¡ ­ª */
     if(IsREPO(FD.Group) AND (FD.IsBack == false)) /*ã¡¨à ¥¬ § ¤¢ ¨¢ ­¨¥ à¥§ã«ìâ â®¢ ¤«ï …Ž, */

        /*…á«¨ ¯® áç¥âã ­¥ ¡ë«¨ ­ ©¤¥­ë ª®¬¨áá¨¨, §­ ç¨â „‘ ­¥ áç¨â ¥¬ ¤«ï ¤ ­­®£® áç¥â */
        if(‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("8",true) > 0) /*m_BankCommSum*/
           SP_GetSumCom( sum_bank, nds_bank, null, null,
                         FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, StartDate, StopDate, 1, 0,
                         1, 0, 1, 1, null, m_FIID, true, null, null, null,
                         null,null,null, false
                        );
           BankComm = sum_bank;
           if (IsPrognos == SET_CHAR)
             m_BankCommSumVirt = m_BankCommSumVirt + sum_bank;
             m_BankCommNDSVirt = m_BankCommNDSVirt + nds_bank;
           else
             m_BankCommNDS  = m_BankCommNDS  + nds_bank;
           end;
        end;   

         /*Ž¯« ç¥­­ ï ª®¬¨áá¨ï ¡¨à¦¥/¡à®ª¥à ¬*/
         if(‘ã¬¬ë‡ ç¨á«¥­¨©‘¯¨á ­¨©("9,10,11,12",true) > 0)   /*m_AgentCommSum*/
            SP_GetSumCom( sum_agent, nds_agent, null, null,
                          FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, StartDate, StopDate, 0, 1,
                          1, 0, 1, 1, null, m_FIID, true, null, null, null,
                          null,null,null, false
                         );
            AgentComm = sum_agent;
            if (IsPrognos == SET_CHAR)
              m_AgentCommSumVirt = m_AgentCommSumVirt + sum_agent;
              m_AgentSumNDSVirt  = m_AgentSumNDSVirt + nds_agent;
            else
              m_AgentSumNDS  = m_AgentSumNDS + nds_agent;
            end;
         end;

         SumClient = ®«ãç¨âì‘ã¬¬ã á¯à¥¤¥«¥­­ëåŠ®¬¨áá¨©®‘¤¥«ª¥( FD.tick.rec,null, null, null, null, null, m_Account,
                                                                  m_FIID, FD.pmwrtsum.rec.Date);
    end;

    if( (not IsRET_COUPON(FD.Group)) AND (not IsRET_PARTLY(FD.Group)) )

        if( FD.tick.rec.BofficeKind != DL_RETIREMENT )
           if( PlanAvrDate != ZeroDate )
              PlanAvrDate = DateToStr( PlanAvrDate );
           end;

           if( FactAvrDate != ZeroDate )
              FactAvrDate = DateToStr( FactAvrDate );
           end;
        end;
     else
        PlanAvrDate = FactAvrDate = "";
     end;

     /* D3.1 - „ â  ®¯« âë
        « ­®¢ ï ¤ â  ¯« â¥¦  ¯® ®¯« â¥ æ/¡ (¤«ï ®¯¥à æ¨©
        á¯¨á ­¨ï/§ ç¨á«¥­¨ï æ/¡ ­¥ § ¯®«­ï¥âáï) */

     /* D3.2 - ” ªâ¨ç¥áª ï ¤ â  ¯« â¥¦  ¯® ®¯« â¥ æ/¡ - § ¯®«­ï¥âáï â®«ìª®
        ¤«ï ¨á¯®«­¥­­ëå ¯« â¥¦¥© (¤«ï ®¯¥à æ¨© á¯¨á ­¨ï/§ ç¨á«¥­¨ï æ/¡ ­¥
        § ¯®«­ï¥âáï) */
     if( (not IsAVRWRTIN(FD.Group)) and (not IsAVRWRTOUT(FD.Group)) )

        if( FD.tick.rec.BofficeKind != DL_RETIREMENT )
           TempDate = GetDealPayPlanDate( FD.dl_leg.rec, DealCh );
           if( TempDate != ZeroDate )
              PlanMoneyDate = DateToStr( TempDate );
           end;
        end;
       var stat = 0;
       var valuedate = date(0,0,0);
       if(FD.Kind == 138)
         stat = ’Ž‡ ªàëâ®( FD.pm_avoir.dlreq);
         valuedate = FD.pm_avoir.rec.ValueDate;
       else
         stat = ’Ž‡ ªàëâ®(FD.pm_money_.dlreq);
         valuedate = FD.pm_money_.rec.ValueDate;
       end;
       /*” ªâ¨ç¥áª ï ¤ â  ¯« â¥¦  ¯® ®¯« â¥ æ/¡*/
       if( stat )
          FactMoneyDate = DateToStr(GetDateAfterWorkDays(valuedate, 0, FD.®«ãç¨âìŠ «¥­¤‘¢ï§ ­­ë©()));
       end;
     end;

     if( FD.tick.rec.BOfficeKind == DL_CONVAVR )
        PlanAvrDate   = "";
        PlanMoneyDate = "";
        FactMoneyDate = "";
     end;
     if( FD.avoiriss.rec.ISIN )
        ISIN = FD.avoiriss.rec.ISIN;
     else
        ISIN = FD.avoiriss.rec.LSIN;
     end;
     if( FD.tick.rec.BOfficeKind == DL_INVESTSHARE )

        if( ®«ãç¨âì”¨­ˆ­(FD.dl_leg.rec.pfi, rFi) == 0 )
           sumprecision = rFi.sumprecision;
        else
           sumprecision = 0;
        end;

        if(Price == "")
           Currency = "";
        end;

        PlanAvrDate   = "";
        PlanMoneyDate = "";
        FactAvrDate   = "";
        FactMoneyDate = "";
     else
        if( ®«ãç¨âì”¨­ˆ­(FD.dl_leg.rec.pfi, rFi) == 0 )
           sumprecision = rFi.sumprecision;
        else
           sumprecision = 0;
        end;
     end;

     if( DealTypeGr != "" )
        DealType = DealType + "/" + DealTypeGr;
     end;

     if( FactAvrDate != "" )
        PlanAvrDate = PlanAvrDate + "/" + FactAvrDate;
     end;

     if( FactMoneyDate != "" )
        PlanMoneyDate = PlanMoneyDate + "/" + FactMoneyDate;
     end;

     // áã¬¬ë ¯® ¢¨àãâ «ì­ë¬ ®áâ âª ¬
     if (IsPrognos == SET_CHAR)
        GetVirtualSumForTick(FD.tick);
     end;

     PrintTableLineOper( FD.tick.rec.DealCode, DealDateInfo, DealTime, DealType, OrderNumber,
                 Issuer, ISIN, AvrKind, Series, Issue, Tranche, Price, Currency, Amount, Summ,
                 NKD, Cur_NKD, AgentComm, BankComm, SumClient, PlanAvrDate, PlanMoneyDate, RejectInfo, IsPrognos);

  end;

  /*¤«ï ƒŽ*/
  macro PrintDealCondition_UN( ClopData )
     record rFi(fininstr);
     record rAv(avoiriss);
     var dl_comm = TRecHandler( "dl_comm" );
     var DealType = "", CommCode = "",
         Issuer = "",
         ISIN = "",
         AvrKind = "",
         Series = "",
         Issue = "",
         Tranche = "", SerIssTranche = "";

     sumprecision = 0;
     /*á¯¨á ­¨¥*/
     if (®«ãç¨âì”¨­ˆ­( int(ClopData.FIID), rFi, rAv ) == 0)
        /*í¬¨â¥­â*/
        Issuer = GetPartyShortNameByID(FI_GetIssuerOnDate(rFi, RepData.DateEnd) );

        /*‚¨¤ –*/
        AvoirKindName( rFi.AvoirKind, AvrKind );

        if( rAv.ISIN )
           ISIN = rAv.ISIN;
        else
           ISIN = rAv.LSIN;
        end;

        /* A12, A12.1, A12.2 */
        SerIssTranche = GetSeriesIssueTrancheInfo( rAv, @Series, @Issue, @Tranche );

        /*¤«ï ¯ ï á â®ç­®áâìî ¨§  ­ª¥âë ¯ ï*/
        /*¯® ƒŽ Š®«¨ç¥áâ¢® ¢ë¢®¤¨âì ­ã¦­® â ª, ª ª ¥áâì, ¡¥§ ¯®â¥à¨ â®ç­®áâ¨ (¤à®¡­®¥ ª®«-¢® ¢ë¢®¤¨¬ á å¢®áâ®¬)*/

        if( FI_AvrKindsEQ(FIKIND_AVOIRISS, AVOIRISSKIND_INVESTMENT_SHARE, rFi.AvoirKind) )
           sumprecision = rFi.sumprecision;
        else
           sumprecision = DL_MeanSignAfterPoint(ClopData.ClientComm,12);
        end;
     else
        msgbox("¥ ¬®£ã ¯®«ãç¨âì  ­ª¥âã ¢ë¯ãáª  á FIID = "+string(int(ClopData.FIID)));
     end;

     if( DL_GetRecHandler(dl_comm,"select * from ddl_comm_dbt where t_DocumentID = "+string(ClopData.DealID)) )
        if( ClopData.BofficeKind == DL_ISSUE_UNION )
           DealType = "(£«®¡ «ì­ ï ®¯¥à æ¨ï)";
           if( dl_comm.rec.OperSubKind == 1 )
              DealType = "ª®­¢¥àâ æ¨ï æ/¡ "+DealType;
           elif( dl_comm.rec.OperSubKind == 4 )
              DealType = "®¡ê¥¤¨­¥­¨¥ ¢ë¯ãáª®¢ "+DealType;
           end;
        else
           DealType = "(¨§¬¥­¥­¨¥ ­®¬¨­ « )";
           if( dl_comm.rec.OperSubKind == 1 )
              DealType = "¤à®¡«¥­¨¥ æ/¡ "+DealType;
           elif( dl_comm.rec.OperSubKind == 2 )
              DealType = "ª®­á®«¨¤ æ¨ï æ/¡ "+DealType;
           end;
        end;
        CommCode = dl_comm.rec.CommCode;

     else
        msgbox("¥ ¬®£ã ¯®«ãç¨âì ®¯¥à æ¨î ƒŽ/ˆ á ID = "+string(ClopData.DealID));
     end;

     if( ClopData.BofficeKind == DL_ISSUE_UNION )
        DealType = DealType + IIF(ClopData.IsBack,"/§ ç¨á«¥­¨¥","/á¯¨á ­¨¥");
     end;

     PrintTableLineOper( CommCode, SQL_ConvTypeDate(ClopData.DealDate), "", DealType, "",
                         Issuer, ISIN, AvrKind, Series, Issue, Tranche, "", "", ClopData.ClientComm, "",
                         "", "", "", "", "", "", "", "", "");
  end;

  macro PrintDealConditionByOperGrup( ClopData )
   var
     DealChange  = TRecHandler( "sptkchng" ),
     DealChnCur  = TRecHandler( "sptkchng" ),
     Progress    = TProgressBar,
     ArrDateChange, ChngCounter, Order1, Order2,
     continue_cicle, Deal, DealID,
     Leg1 = TRecHandler( "dl_leg" ), Leg2 = TRecHandler( "dl_leg" ),
     RejectInfo, OrderNumber,
     BOKind, Num = 0, â®ƒŽ_ˆ = ((ClopData.BofficeKind==DL_ISSUE_UNION) or (ClopData.BofficeKind==DL_CHGAVRNOM));

     var FD;

     if( (PrevClient != m_ClientID) or (PrevContr != m_ContrID) or (ClopData.PlaceID != m_Place) or (ClopData.Account != m_Account ) )
        if( IsNotFirstUse == true )
           if( m_Account != "" )
              ˆâ®£¨®‘ç¥âã();
           else
              EndReportTab();
              ClearData();
           end;
        else
           IsNotFirstUse = true;
        end;
     end;

     ¥ç âì‘âà®ª¨Žâç¥â ();

     if( (ClopData.PlaceID != m_Place) or (ClopData.Account != m_Account) )

        if( ClopData.PlaceID != m_Place )
          if( ClopData.PlaceID == PLACE_GO )
             PrintPlace( Œ…‘’Ž_ƒŽ_ˆ);
          elif(ClopData.PlaceID <= 0 )
             PrintPlace(OUTMARKETPLACE);
          else
             PrintPlace(GetPartyShortNameByID(ClopData.PlaceID));
          end;
        end;

        m_Place   = ClopData.PlaceID;
        m_Account = ClopData.Account;
        m_FIID  = ClopData.Currency;
        PrevStatus = -1;
     end;

     if( PrevStatus != int(ClopData.Status) )
        if( ClopData.Status == STAT_FINISHED )
           PrintOperKind("ˆ­ä®à¬ æ¨ï ® § ¢¥àè¥­­ëå á¤¥«ª å ¨ ®¯¥à æ¨ïå");
        elif(ClopData.Status == STAT_NOTFINISHED)
           PrintOperKind("ˆ­ä®à¬ æ¨ï ® ­¥§ ¢¥àè¥­­ëå á¤¥«ª å ¨ ®¯¥à æ¨ïå");
        elif(ClopData.Status == STAT_NOTACC)
           PrintOperKind("ˆ­ä®à¬ æ¨ï ® ­¥§ ¢¥àè¥­­ëå ¨ ­¥ ãçâ¥­­ëå ¢® ¢­ãâà¥­­¥¬ ãç¥â  á¤¥«ª å ¨ ®¯¥à æ¨ïå");
        elif(ClopData.Status == STAT_CONCLUSION)
           if(RepData.DateBegin == RepData.DateEnd)
             PrintOperKind("ˆ­ä®à¬ æ¨ï ® á¤¥«ª å ¨ ®¯¥à æ¨ïå, á®¢¥àè¥­­ëå ¢ â¥ç¥­¨¥ ¤­ï");
           else
             PrintOperKind("ˆ­ä®à¬ æ¨ï ® § ª«îç¥­­ëå á¤¥«ª å ¨ á®¢¥àè¥­­ëå ®¯¥à æ¨ïå");
           end;
        end;
        PrevStatus = int(ClopData.Status);
     end;

     if( â®ƒŽ_ˆ )
        PrintDealCondition_UN( ClopData );
        return;
     end;

     if (ClopData.IsBack == SET_CHAR)
        FD = SPFirstDoc( LEG_KIND_DL_TICK_BACK, ClopData.DealID );
     else
        FD = SPFirstDoc( LEG_KIND_DL_TICK, ClopData.DealID );
     end;

     Deal     = FD.tick.rec;
     DealID   = Deal.DealID;
     BOKind   = Deal.BOfficeKind;

     GetDlLegByDealID( Deal.DealID, LEG_KIND_DL_TICK, true, false, Leg1 );
     if( FD.ExistBack )
        GetDlLegByDealID( Deal.DealID, LEG_KIND_DL_TICK_BACK, true, false, Leg2 );
     end;

     /* ®«ãç ¥¬ â¥ªãé¨¥ ãá«®¢¨ï á¤¥«ª¨. */
     SP_GetDealParmsByDate( FD.tick, Deal.DealDate, DealChnCur, false, true );
     FD.dl_leg.rec.pfi = DealChnCur.rec.oldpfi1;

     /* D4 - Žâª §
        …á«¨ ¯® á¤¥«ª¥ ¡ë« ¢ë¯®«­¥­ ®âª § ®â ¢â®à®© ç áâ¨, â® ¢ë¢®¤¨âáï
        ¤ â  ä ªâ¨ç¥áª®£® ¢ë¯®«­¥­¨ï è £  á¤¥«ª¨ "Žâª § ®â ¨á¯®«­¥­¨ï 2
        ç áâ¨". …á«¨ ¡ë« ¢ë¯®«­¥­ ®âª § á¤¥«ª¨, â® ¢ë¢®¤¨âáï ¤ â 
        ä ªâ¨ç¥áª®£® ¢ë¯®«­¥­¨ï è £  á¤¥«ª¨ "Žâª § ®â á¤¥«ª¨" */
     /* A14 = …á«¨ ¯® á¤¥«ª¥ ¡ë« ¢ë¯®«­¥­ ®âª § ®â ¢â®à®© ç áâ¨, â®
        ¢ë¢®¤¨âáï â¥ªáâ "®âª. ®â  2ç". …á«¨ ¡ë« ¢ë¯®«­¥­ ®âª § á¤¥«ª¨, â®
        ¢ë¢®¤¨âáï â¥ªáâ "®âª. ®â á¤¥«ª¨" */
     RejectInfo = "";
     if( Leg1.rec.RejectDate != ZeroDate )
        RejectInfo  = DateToStr( Leg1.rec.RejectDate ) + "/" + "®âª. ®â á¤¥«ª¨";
     elif( FD.ExistBack and (Leg2.rec.RejectDate != ZeroDate) )
        if( Leg2.rec.RejectDate != ZeroDate )
           RejectInfo = DateToStr( Leg2.rec.RejectDate ) + "/" + "®âª. ®â 2ç";
        end;
     end;

     /* A6 - ü ¯®àãç¥­¨ï
        ü ¯®àãç¥­¨ï ª«¨¥­â . …á«¨ ¤«ï á¤¥«ª¨ á ®¡à â­®© ¯à®¤ ¦¥©/¯®ªã¯ª®© ¢
        "„®ªã¬¥­â å ¯® á¤¥«ª¥" ¯®«ì§®¢ â¥«¥¬ § ¤ ­ë ¯ à ¬¥âàë ¤¢ãå ¯®àãç¥­¨©,
        â® ¤«ï ¯¥à¢®© ç áâ¨ ¢ë¢®¤¨âì ¯®àãç¥­¨¥ á ¡®«¥¥ à ­­¥© ¤ â®© ¨ ¢à¥¬¥­¥¬
        ¯à¨¥¬ ,   ¤«ï ¢â®à®© - á ¡®«¥¥ ¯®§¤­¥© ¤ â®© ¨ ¢à¥¬¥­¥¬ ¯à¨¥¬ . */
     Order1 = GetSPGroundRecByDeal( DealID, DOCKIND_ORD_CLIENTOP, 1, BOKind );
     OrderNumber = Order1.Xld;
     if( IsREPO(FD.Group) )
        Order2 = GetSPGroundRecByDeal( DealID, DOCKIND_ORD_CLIENTOP, 2, BOKind );
        if( Order2.SPGroundID > 0 )
           /* …áâì ¤¢  ¯®àãç¥­¨ï ¯® á¤¥«ª¥.  ¤® ¢ § ¢¨á¨¬®áâ¨ ®â ç áâ¨ á¤¥«ª¨
              ¢ë¡à âì ®¤­® ¨§ ­¨å. */
           if( CompareTwoDateTime( Order2.RegistrDate, Order2.RegistrTime,
                                   Order1.RegistrDate, Order1.RegistrTime
                                   ) > 0 )
              /* ‚â®à®¥ ¯®àãç¥­¨¥ ¯®§¤­¥¥ ¯à¨­ïâ®. */
              OrderNumber = IIF( FD.IsBack, Order2.Xld, Order1.Xld );
           else
              OrderNumber = IIF( FD.IsBack, Order1.Xld, Order2.Xld );
           end;
        end;
     end;

     /* ˆ§¬¥­¥­¨ï á¤¥«®ª ®âà ¦ îâáï ¢ § ¢¨á¨¬®áâ¨ ®â §­ ç¥­¨ï ­ áâà®©ª¨
        "Žâ®¡à ¦ âì ¨§¬¥­¥­¨¥ ãá«®¢¨© á¤¥«®ª ¢ ®âç¥â å" ¬®¤ã«ï Ž æ/¡. */
     if( RepData.ShowDealChange )

        /* …á«¨ ­ áâà®©ª  ¢ª«îç¥­ , â® ¯® ª ¦¤®© á¤¥«ª¥ §  ¤ âã
           § ª«îç¥­¨ï,   â ª¦¥ ª ¦¤ãî ¤ âã ¨§¬¥­¥­¨ï ãá«®¢¨© ¢ë¢®¤¨âáï
           ®â¤¥«ì­ ï áâà®ª , â.¥. ®¤­  á¤¥«ª  ¬®¦¥â ¡ëâì ¯à¥¤áâ ¢«¥­ 
           ­¥áª®«ìª¨¬¨ áâà®ª ¬¨, ¯à¨ç¥¬ ¢ ª ¦¤®© â ª®© áâà®ª¥ ¢ë¢®¤¨âáï
           â®â ¢ à¨ ­â ãá«®¢¨©, ª®â®àë© ­ ç « ¤¥©áâ¢®¢ âì á ¤ âë
           § ª«îç¥­¨ï (¨§¬¥­¥­¨ï). */

        /* ®«ãç¨¬ ¬ áá¨¢ ¤ â ¨§¬¥­¥­¨ï ãá«®¢¨© á¤¥«ª¨. */
        ArrDateChange = GetArrayDateDealChange( FD.tick.rec );

        /* ®«ãç ¥¬ ¨ á®åà ­ï¥¬ ¨áå®¤­ë¥ ãá«®¢¨ï. */
        SP_GetDealParmsByDate( FD.tick, Deal.DealDate, DealChange, false, false );
        if((FD.tick.rec.BOfficeKind == DL_CONVAVR) AND (FD.IsBack == true))                                      
           PrintDealCondition( FD, DealChange.rec, RejectInfo, OrderNumber, Leg2.rec.Principal, ClopData.Prognos, ClopData.IsPartyClient );
        else
           PrintDealCondition( FD, DealChange.rec, RejectInfo, OrderNumber, 0, ClopData.Prognos, ClopData.IsPartyClient );
        end;

        /* ‘®åà ­ï¥¬ ¨§¬¥­¥­­ë¥ ãá«®¢¨ï. */
        ChngCounter = 0;
        while( ChngCounter < ArrDateChange.Size )

           SP_GetDealParmsByDate( FD.tick, ArrDateChange[ChngCounter], DealChange, false, false );
                                                                                          
           PrintDealCondition( FD, DealChange.rec, RejectInfo, OrderNumber, 0, ClopData.Prognos, ClopData.IsPartyClient );

           inc( ChngCounter );
        end;
     else
        /* ®ª §ë¢ âì ¨§¬¥­¥­¨¥ ãá«®¢¨© ­¥ ­ ¤®.
           ®ª ¦¥¬ â¥ªãé¨¥ ãá«®¢¨ï. */
        if((FD.tick.rec.BOfficeKind == DL_CONVAVR) AND (FD.IsBack == true))
           PrintDealCondition( FD, DealChnCur.rec, RejectInfo, OrderNumber, Leg2.rec.Principal, ClopData.Prognos, ClopData.IsPartyClient );
        else
           PrintDealCondition( FD, DealChnCur.rec, RejectInfo, OrderNumber, 0, ClopData.Prognos, ClopData.IsPartyClient );
        end;
     end;
  end;

  private macro Žâ®¡à âì‘¤¥«ª¨(StartDate,StopDate)
     var
        Progress = TProgressBar,
        FD, DealIsREPO, Num = 0;

     var Qu, Select, SelectData;
     VAR NRecQuery, NRecSelect, NRecData, NRec =0;

       Select = RSDCommand( Žâ®¡à âì‘¤¥«ª¨„«ïŽâçñâ () );

       NRecSelect = RSDCommand( "SELECT COUNT(*) nRecs FROM (" + Žâ®¡à âì‘¤¥«ª¨„«ïŽâçñâ () + ")" );

       var NumberSelectQuery = 2;  /*¤¢  á¥«¥ªâ , á¢ï§ ­­ëå ç¥à¥§ Union all ¢ Žâ®¡à âì‘¤¥«ª¨„«ïŽâçñâ ()*/
       while (NumberSelectQuery > 0)
   
         if( RepData.ClientID >= 0 )
             Select.addParam( "", RSDBP_IN, RepData.ClientID );
             NRecSelect.addParam( "", RSDBP_IN, RepData.ClientID );
          end;

         if( (RepData.IsFormID > 0) and (RepData.FormSubID !=0) )
           Select.addParam( "", RSDBP_IN, RepData.FormSubID);
           NRecSelect.addParam( "", RSDBP_IN, RepData.FormSubID);
         end;
         if( (RepData.IsVidID > 0) and (RepData.VidSubID !=0) )
           Select.addParam( "", RSDBP_IN, RepData.VidSubID);
           NRecSelect.addParam( "", RSDBP_IN, RepData.VidSubID);
         end;



          Select.addParam( "", RSDBP_IN, PTSK_STOCKDL );
          NRecSelect.addParam( "", RSDBP_IN, PTSK_STOCKDL );

          Select.addParam( "", RSDBP_IN, StopDate );
          NRecSelect.addParam( "", RSDBP_IN, StopDate );

          Select.addParam( "", RSDBP_IN, StartDate );
          NRecSelect.addParam( "", RSDBP_IN, StartDate );

          if(RepData.ContrID > 0)
             Select.addParam( "", RSDBP_IN, RepData.ContrID );
             NRecSelect.addParam( "", RSDBP_IN, RepData.ContrID );
          end;

          if( RepData.DprtID != -1 )
             Select.addParam( "", RSDBP_IN, RepData.DprtID );
             NRecSelect.addParam( "", RSDBP_IN, RepData.DprtID );
          end;

          if(RepData.OperState == STAT_ALL)/*‡ ¢¥àè¥­­ë¥\¥§ ¢¥àè¥­­ë¥*/

            Select.addParam( "", RSDBP_IN, StartDate );
            Select.addParam( "", RSDBP_IN, StopDate );
            Select.addParam( "", RSDBP_IN, StopDate );

            NRecSelect.addParam( "", RSDBP_IN, StartDate );
            NRecSelect.addParam( "", RSDBP_IN, StopDate );
            NRecSelect.addParam( "", RSDBP_IN, StopDate );

          elif(RepData.OperState == STAT_FINISHED) /*‡ ¢¥àè¥­­ë¥*/

            Select.addParam( "", RSDBP_IN, StartDate );
            Select.addParam( "", RSDBP_IN, StopDate );

            NRecSelect.addParam( "", RSDBP_IN, StartDate );
            NRecSelect.addParam( "", RSDBP_IN, StopDate );

          elif(RepData.OperState == STAT_NOTFINISHED) /*¥§ ¢¥àè¥­­ë¥*/

            Select.addParam( "", RSDBP_IN, StopDate );

            NRecSelect.addParam( "", RSDBP_IN, StopDate );

          else /*§ ª«îç¥­­ë¥*/
            Select.addParam( "", RSDBP_IN, StartDate );
            Select.addParam( "", RSDBP_IN, StopDate );

            NRecSelect.addParam( "", RSDBP_IN, StartDate );
            NRecSelect.addParam( "", RSDBP_IN, StopDate );

          end;

        NumberSelectQuery = NumberSelectQuery - 1;
       end;

       Select.execute();
       NRecSelect.execute();

       NRecData = TRsbDataSet(NRecSelect);
       SelectData = TRsbDataSet(Select);

       if( NRecData.MoveNext() )
          NRec = Int(NRecData.nRecs);
       end;

       Progress.Init(NRec, StatLine, "à®á¬®âà á¤¥«®ª"+IIF(RepData.IsSeparatelyDate == false," c "+string(RepData.DateBegin)+" ¯® "+string(RepData.DateEnd)," §  "+string(m_CurDate)));

       while( SelectData.MoveNext() )
          var Place:integer = -1, Account:string = "", Currency:integer = ALLFININSTR;

          FD = SPFirstDoc(LEG_KIND_DL_TICK, SelectData.DealID);
          DealIsREPO = IsREPO(FD.Group);

          var Sql = " SELECT mc.t_Place, mc.t_Account, mc.t_Currency " +
                    "   FROM dmcaccdoc_dbt mc " +
                    "  WHERE mc.t_Chapter = 21 " +
                    "    and mc.t_CatNum = 531 " +
                    "    and ? = (case when (? = 138) then ? else " +
                    "        (case when (mc.t_DocKind != 176) then mc.t_DocID else " +
                    "        NVL((select leg.t_dealid from ddl_leg_dbt leg where leg.t_ID = mc.t_DocID ),0) end) end)" +
                    "    and mc.t_Owner = ? " +
                    "    and mc.t_ClientContrID = ? " +
                    "    and mc.t_DocKind in(101,155,117,127,138,122,176) " +
                    "    and mc.t_DepartmentID = ? " +
                    "    and mc.t_DocID = (case when ? = 138 then ? else mc.t_DocID end)";
          var Query = RSDCommand(Sql);
          Query.NullConversion = true;
          Query.addParam("", RSDBP_IN, FD.tick.rec.DealID);
          Query.addParam("", RSDBP_IN, FD.tick.rec.BOfficeKind);
          Query.addParam("", RSDBP_IN, FD.tick.rec.DealID);
          Query.addParam("", RSDBP_IN, IIF( (FD.tick.rec.IsPartyClient == SET_CHAR ), FD.tick.rec.PartyID , FD.tick.rec.ClientID ) );
          Query.addParam("", RSDBP_IN, IIF( (FD.tick.rec.IsPartyClient == SET_CHAR ), FD.tick.rec.PARTYCONTRID, FD.tick.rec.ClientContrID ) );
          Query.addParam("", RSDBP_IN, FD.tick.rec.Department);
          Query.addParam("", RSDBP_IN, FD.tick.rec.BOfficeKind);
          Query.addParam("", RSDBP_IN, IIF( (FD.tick.rec.IsPartyClient == SET_CHAR ), FD.tick.rec.PARTYCONTRID, FD.tick.rec.ClientContrID ) );
          Query.execute();

          var Data = TRsbDataSet(Query);
          if( Data.MoveNext() )
             if( IsEXCHANGE(FD.Group) or IsBROKER(FD.Group) )
                Place = SQL_ConvTypeInteger(Data.rec.Place);
             end;
             Account  = SQL_ConvTypeStr(Data.rec.Account);
             Currency = SQL_ConvTypeInteger(Data.rec.Currency);
          else /*­¥§ ¢¥àè¥­­ë¥ ¨ ­¥ ãçâ¥­­ë¥ ¢® ¢­ãâà¥­­¥¬ ãç¥â¥*/
             if( (FD.tick.rec.BOfficeKind == 127) or (FD.tick.rec.BOfficeKind == 138) )
                Place = FD.Œ¥áâ®•à ­¥­¨ï(FIROLE_BA, true);
             else
                Place = FD.Œ¥áâ®•à ­¥­¨ï(FIROLE_CA, true);
             end;

             if( Place == {OurBank} )
                Place = -1;
             end;
          end;

          /*á¤¥«ª¨ …Ž ®â¡¨à îâáï ¢ ®âç¥â ¯® ®¡à â­®© ç áâ¨*/
          if( DealIsREPO == false )
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã®Ž¯¥à æ¨ï¬Š«¨¥­â (SelectData, false, DealIsREPO, Place, Account, Currency);
          end;

          if( FD.ExistBack )
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã®Ž¯¥à æ¨ï¬Š«¨¥­â (SelectData, true, DealIsREPO, Place, Account, Currency);
          end;

          Progress.Use;
       end;
       Progress.Remove;
  end;

  macro ®«ãç¨âì„ âã‡ ¢¥àè¥­¨ïƒŽ(SelectData)
    var cmd, DataSet;

    if( SelectData.IsBack )/*§­ ç¨â § ç¨á«¥­¨¥ - §­ ç¨â ¤ âã ¨áª âì ­¥ ­ ¤® */
       return SQL_ConvTypeDate(SelectData.DealDate);
    end;

    cmd = RSDCommand( " SELECT NVL (CL.T_BegDATE, TO_DATE ('01.01.0001', 'dd.mm.yyyy')) end_date   "+
                      "   FROM dscdlpmwr_dbt scdl, ddl_comm_dbt comm, dpmwrtcl_dbt cl  "+
                      "  WHERE comm.t_DocumentID = ?  "+ /* DEALID*/
                      "    AND COMM.T_DOCKIND = ?  "+ /*DocKind*/
                      "    AND comm.t_DocumentID = scdl.T_DEALID  "+
                      "    AND COMM.T_COMMSTATUS > 0  "+
                      "    AND scdl.T_PARTY = ? "+ /*CLIENTID*/
                      "    AND cl.t_Department = ? "+   /*Department*/
                      "    AND CL.T_FIID = COMM.T_FIID   "+
                      "    AND CL.T_PARTY = scdl.T_PARTY "+
                      "    AND CL.T_CONTRACT = ? "+    /*ContrID*/
                      "    AND CL.T_ENDDATE > COMM.T_BEGINDATE "+
                      "    AND CL.T_AMOUNT = 0  ");

    cmd.addParam( "", RSDBP_IN, SelectData.DealID );
    cmd.addParam( "", RSDBP_IN, DL_ISSUE_UNION );  
    cmd.addParam( "", RSDBP_IN, SelectData.ClientID );
    cmd.addParam( "", RSDBP_IN, SelectData.Department );
    cmd.addParam( "", RSDBP_IN, SelectData.ContrID );

    cmd.execute();

    DataSet = TRsbDataSet(cmd);

    if( DataSet.MoveNext() )
       return SQL_ConvTypeDate(DataSet.end_date);
    end;

    return ZeroDate;
  end;

  macro Žâ®¡à âìƒŽ_ˆ(DocKind,StartDate,StopDate)
     var Progress = TProgressBar;
     var Qu, Select, SelectData;
     VAR NRecQuery, NRecSelect, NRecData, NRec =0, CloseDate = ZeroDate, DealDate = ZeroDate;
     var â®ƒŽ = (DocKind==DL_ISSUE_UNION), ZTime = time(0);
     var „ â ‡ ¢¥àè¥­¨ï = "", „ â ‡ ª«îç¥­¨ï = "";

    /*¢á¥ á¯¨á ­¨ï ¤«ï ª«¨¥­â  
      à®¢¥àª  ä ªâ  çâ® á¯¨á ­¨¥ ¢ ƒŽ ¢ë¯®«­¥­® - 
      Ž¯¥à æ¨ï ¨¬¥¥â áâ âãá (®âªàëâ  ¨«¨ § ªàëâ ) ¨ (¢ ­¥© ¥áâì scdlpmwr ¯® íâ®¬ã ª«¨¥­âã) 
      ¨ ­¥â ª«¨¥­âáª¨å «®â®¢ pmwrtcl áâ à®£® ¢ë¯ãáª (dl_comm.FIID) £¤¥ (pmwrtcl.t_fiid == dl_comm.FIID ¨ pmwrtcl.t_Party - ¢ë¢®¤¨¬ë© ª«¨¥­â
      ¨ pmwrtcl.t_endDate > dl_comm.BeginDate ¨ pmwrtcl.t_Amount >0). */      
      Qu = " SELECT cl1.t_Department, " +
           "       comm.t_DocumentID DealID, "+
           "       999999 AS t_Place, "+
           "       CL1.T_PARTY ClientID, " +
           "       CL1.T_CONTRACT ContrID, " +
           "       ''  Account, "+
           "       0   Currency, "+
           "       COMM.t_commdate AS DealDate, "+
           "       COMM.T_FIID FIID, "+
           "       comm.T_BEGINDATE T_BEG_DATE, "+
           "       0 AS IsBack, " /*‘¯¨á ­¨¥*/   +
           "       SCDL.T_OLDAMOUNT Amount"+
           "  FROM dscdlpmwr_dbt scdl, "+
           "       ddl_comm_dbt comm, "+
           "       dpmwrtcl_dbt cl1, "+
           "        dsfcontr_dbt contr "+
           "       ,dparty_dbt Pt " +
           "  WHERE comm.t_DocumentID = scdl.T_DEALID "+
           "   AND COMM.T_DOCKIND = " +string(DocKind)+ 
           "  AND scdl.T_PARTY  = Pt.T_PARTYID (+) " +
           "   AND COMM.T_COMMSTATUS > 0 "+
           "   AND CL1.T_ID = SCDL.T_SUMID ";
           if( RepData.ClientID >= 0 )
             Qu = Qu + "   AND scdl.T_PARTY = ? ";
           end; 

           if( (RepData.IsFormID > 0) and (RepData.FormSubID != 0) )
              if(RepData.IsFormID == 1)
                Qu = Qu + "    and   Pt.T_LEGALFORM = ?  ";
              end;
              if(RepData.IsFormID == 2)            	
                Qu = Qu + "    and   Pt.T_LEGALFORM != ?  ";
              end;
           end;
         
           if( (RepData.IsVidID > 0) and (RepData.VidSubID != 0) )
              if(RepData.IsVidID == 1)
                Qu = Qu + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
              end;
              if(RepData.IsVidID == 2)            	
                Qu = Qu + "   and    NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
              end;
           end;
         
           if(RepData.NoResident)
              Qu = Qu + "     and   Pt.T_NOTRESIDENT = 'X' ";
           end;
             
           /* ¤®£®¢®à*/
           Qu = Qu + 
           "    AND contr.T_PARTYID = CL1.T_PARTY "
           "    AND contr.T_ID = CL1.T_CONTRACT "+
           "    and contr.T_SERVKIND = ? " +
           "    and (contr.T_DATECLOSE = '01.01.0001' or " +
           "         ( contr.T_DATECLOSE <= ? and contr.T_DATECLOSE >= ? )) ";
           if( RepData.DprtID != -1 )
             Qu = Qu + "    and cl1.t_Department = ? ";
           end;                                   
          if (â®ƒŽ)
              Qu = Qu + " AND NOT EXISTS "+
                     "     (SELECT CL.T_ID "+
                     "        FROM dpmwrtcl_dbt cl "+
                     "       WHERE CL.T_FIID = COMM.T_FIID "+
                     "         AND CL.T_PARTY = scdl.T_PARTY  ";          
              if( RepData.ContrID > 0 )
                Qu = Qu + "       AND CL.T_CONTRACT = ? ";
              end;                                   
              Qu = Qu + "         AND CL.T_ENDDATE > COMM.T_BEGINDATE "+
                        "         AND CL.T_AMOUNT > 0) ";
          else
              Qu = Qu + " AND EXISTS "+
                     "     (SELECT CL.T_ID "+
                     "        FROM dpmwrtcl_dbt cl "+
                     "       WHERE CL.T_FIID = COMM.T_FIID "+
                     "         AND CL.T_PARTY = scdl.T_PARTY  ";          
              if( RepData.ContrID > 0 )
                Qu = Qu + "       AND CL.T_CONTRACT = ? ";
              end;                                   
              Qu = Qu + "         AND CL.T_ENDDATE > COMM.T_BEGINDATE "+
                        "         AND CL.T_AMOUNT > 0) ";
          end;  

          Qu = Qu + " UNION ALL ";    

          /*§ ç¨á«¥­¨ï ¤«ï ª«¨¥­â 
            à®¢¥àª  ä ªâ  çâ® § ç¨á«¥­¨¥ ¢ ƒŽ ¢ë¯®«­¥­® - 
            Ž¯¥à æ¨ï ¨¬¥¥â áâ âãá (®âªàëâ  ¨«¨ § ªàëâ ) ¨ (¢ ­¥© ¥áâì scdlpmwr ¯® íâ®¬ã ª«¨¥­âã)
            ¨ ¢ë¯®«­¥­ è £ § ç¨á«¥­¨ï ¡ã¬ £ (oprstep.t_IsExecute = 'X'), ¤«ï íâ®£® ­ã¦­® ¯®«ãç¨âì ®¯¥à æ¨î ­ã ¨ è £¨ ¯® ­¥©.
          */     
          Qu = Qu + 
                 " SELECT cl1.t_Department, "+
                 " comm.t_DocumentID DealID,"+
                 " 999999 AS t_Place, "+
            "       CL1.T_PARTY ClientID, " +
            "       CL1.T_CONTRACT ContrID, " +
            "       ''  Account, "+
            "       0   Currency, "+
            "     COMM.t_commdate AS DealDate, " +
            IIF (â®ƒŽ, " SCDL.T_NEWFIID FIID, ", " COMM.T_FIID FIID, " ) +
            "     cl1.T_BEGDATE T_BEG_DATE, "+
            "     1 AS IsBack, " /*§ ç¨á«¥­¨¥*/
            "     SCDL.T_NEWAMOUNT Amount"
            " FROM dscdlpmwr_dbt scdl, "+
            "     ddl_comm_dbt comm, ";
            if (â®ƒŽ)
              Qu = Qu +
              "     doprstep_dbt oprstep, "+
              "     doproper_dbt opr, ";
            end;
            Qu = Qu +
            "     dpmwrtcl_dbt cl1, "+
            "     dsfcontr_dbt contr "+
            "       ,dparty_dbt Pt " +
            " WHERE comm.t_DocumentID = scdl.T_DEALID "
            "   AND COMM.T_DOCKIND = " +string(DocKind)+ 
           "  AND scdl.T_PARTY  = Pt.T_PARTYID (+) " +

            "   AND COMM.T_COMMSTATUS > 0 "+
            IIF (â®ƒŽ, "   AND CL1.T_FIID = SCDL.T_NEWFIID ", " AND CL1.T_ID = SCDL.T_SUMID " );
            if( RepData.ClientID >= 0 )
              Qu = Qu + "   AND scdl.T_PARTY = ? ";
            end;              

           if( (RepData.IsFormID > 0) and (RepData.FormSubID != 0) )
              if(RepData.IsFormID == 1)
                Qu = Qu + "    and   Pt.T_LEGALFORM = ?  ";
              end;
              if(RepData.IsFormID == 2)            	
                Qu = Qu + "    and   Pt.T_LEGALFORM != ?  ";
              end;
           end;
         
           if( (RepData.IsVidID > 0) and (RepData.VidSubID != 0) )
              if(RepData.IsVidID == 1)
                Qu = Qu + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
              end;
              if(RepData.IsVidID == 2)            	
                Qu = Qu + "   and    NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
              end;
           end;
         
           if(RepData.NoResident)
              Qu = Qu + "     and   Pt.T_NOTRESIDENT = 'X' ";
           end;
            /*¤®£®¢®à*/
           Qu = Qu + 
           "    AND contr.T_PARTYID = CL1.T_PARTY "
           "    AND contr.T_ID = CL1.T_CONTRACT "+
           "    AND CL1.T_DEPARTMENT = CONTR.T_DEPARTMENT " +
           "    and contr.T_SERVKIND = ? " +
           "    and (contr.T_DATECLOSE = '01.01.0001' or " +
           "         ( contr.T_DATECLOSE <= ? and contr.T_DATECLOSE >= ? )) ";
           if( RepData.DprtID != -1 )
             Qu = Qu + "    and CL1.t_Department = ? ";
           end;  

           if( RepData.ContrID > 0 )
             Qu = Qu + "       AND CL1.T_CONTRACT = ? ";
           end;                                   
          
           if(â®ƒŽ)               
            /*®¯¥à æ¨ï*/
             Qu = Qu + 
             " AND OPR.T_DOCKIND = COMM.T_DOCKIND "+
             " AND LTRIM (OPR.T_DOCUMENTID) = COMM.T_DOCUMENTID "+
             " AND OPR.T_ID_OPERATION = OPRSTEP.T_ID_OPERATION "+
             " AND OPRSTEP.T_NUMBER_STEP(+) = 40"+
             " AND OPRSTEP.T_ISEXECUTE(+) = 'X' ";
           end;

     if( â®ƒŽ )
       „ â ‡ ¢¥àè¥­¨ï = " NVL( CL1.T_BEGDATE, to_date('01.01.0001','DD.MM.YYYY') ) ";
       „ â ‡ ª«îç¥­¨ï = " comm.t_commDate ";
     else
       „ â ‡ ¢¥àè¥­¨ï = „ â ‡ ª«îç¥­¨ï = " comm.t_commDate ";
     end;

     if(RepData.OperState == STAT_ALL)/*‡ ¢¥àè¥­­ë¥ ¢ ®âç¥â­®¬ ¯¥à¨®¤¥\¥§ ¢¥àè¥­­ë¥ ª ®ª®­ç ­¨î ¯¥à¨®¤ */
         Qu = Qu + " and ("+„ â ‡ ¢¥àè¥­¨ï+" >= ? or "+„ â ‡ ¢¥àè¥­¨ï+" = to_date('01.01.0001','DD.MM.YYYY') ) ";
     elif(RepData.OperState == STAT_FINISHED) /*‡ ¢¥àè¥­­ë¥ ¢ ®âç¥â­®¬ ¯¥à¨®¤¥*/
         Qu = Qu +" and "+„ â ‡ ¢¥àè¥­¨ï+" BETWEEN ? and ? ";
     elif(RepData.OperState == STAT_NOTFINISHED) /*¥§ ¢¥àè¥­­ë¥  ª ®ª®­ç ­¨î ¯¥à¨®¤  */
         Qu = Qu + " and ("+„ â ‡ ¢¥àè¥­¨ï+" > ? or "+„ â ‡ ¢¥àè¥­¨ï+" = to_date('01.01.0001','DD.MM.YYYY') )";
     else /*§ ª«îç¥­­ë¥ ¢ ®âç¥â­®¬ ¯¥à¨®¤¥ (¤ â  á¯¨á ­¨ï ¢ ®âç¥â­®¬ ¯¥à¨®¤¥)*/
         Qu = Qu +" and "+„ â ‡ ª«îç¥­¨ï+" BETWEEN ? and ? ";
     end;

     Select = RSDCommand(Qu);

     NRecSelect = RSDCommand( "SELECT COUNT(*) nRecs FROM (" + Qu + ")" );

     var queryInUnion = 2;
     while (queryInUnion > 0)

       if( RepData.ClientID >= 0 )
          Select.addParam( "", RSDBP_IN, RepData.ClientID );
          NRecSelect.addParam( "", RSDBP_IN, RepData.ClientID );
       end;

       if( (RepData.IsFormID > 0) and (RepData.FormSubID !=0) )
         Select.addParam( "", RSDBP_IN, RepData.FormSubID);
         NRecSelect.addParam( "", RSDBP_IN, RepData.FormSubID);
       end;
       if( (RepData.IsVidID > 0) and (RepData.VidSubID !=0) )
         Select.addParam( "", RSDBP_IN, RepData.VidSubID);
         NRecSelect.addParam( "", RSDBP_IN, RepData.VidSubID);
       end;

       Select.addParam( "", RSDBP_IN, PTSK_STOCKDL );
       NRecSelect.addParam( "", RSDBP_IN, PTSK_STOCKDL );

       Select.addParam( "", RSDBP_IN, StopDate );
       NRecSelect.addParam( "", RSDBP_IN, StopDate );

       Select.addParam( "", RSDBP_IN, StartDate );
       NRecSelect.addParam( "", RSDBP_IN, StartDate );

       if( RepData.DprtID != -1 )
          Select.addParam( "", RSDBP_IN, RepData.DprtID );
          NRecSelect.addParam( "", RSDBP_IN, RepData.DprtID );
       end;

       if(RepData.ContrID > 0)
          Select.addParam( "", RSDBP_IN, RepData.ContrID );
          NRecSelect.addParam( "", RSDBP_IN, RepData.ContrID );
       end;

       queryInUnion = queryInUnion - 1;
     end;

     /*¨§¬¥­¥­ ®â¡®à ¯® ¤ â¥ ¢ á®®â¢¥âáâ¢¨¨ á ’‡ "Žâç¥âë_Žâç¥â ¯® ®¯¥à æ¨ï¬ ª«¨¥­â " ¯.12.1*/
     if(RepData.OperState == STAT_ALL)/*‡ ¢¥àè¥­­ë¥\¥§ ¢¥àè¥­­ë¥*/
       Select.addParam( "", RSDBP_IN, StartDate );
       NRecSelect.addParam( "", RSDBP_IN, StartDate );
     elif(RepData.OperState == STAT_FINISHED) /*‡ ¢¥àè¥­­ë¥*/
       Select.addParam( "", RSDBP_IN, StartDate );
       Select.addParam( "", RSDBP_IN, StopDate );
       NRecSelect.addParam( "", RSDBP_IN, StartDate );
       NRecSelect.addParam( "", RSDBP_IN, StopDate );
     elif(RepData.OperState == STAT_NOTFINISHED) /*¥§ ¢¥àè¥­­ë¥*/
       Select.addParam( "", RSDBP_IN, StopDate );
       NRecSelect.addParam( "", RSDBP_IN, StopDate );
     else /*§ ª«îç¥­­ë¥*/
       Select.addParam( "", RSDBP_IN, StartDate );
       Select.addParam( "", RSDBP_IN, StopDate );
       NRecSelect.addParam( "", RSDBP_IN, StartDate );
       NRecSelect.addParam( "", RSDBP_IN, StopDate );
     end;

     Select.execute();
     NRecSelect.execute();

     NRecData = TRsbDataSet(NRecSelect);
     SelectData = TRsbDataSet(Select);

     if( NRecData.MoveNext() )
        NRec = Int(NRecData.nRecs);
     end;

     Progress.Init( NRec, StatLine, "à®á¬®âà ®¯¥à æ¨© ƒŽ ¨ ˆ"+IIF(RepData.IsSeparatelyDate == false," c "+string(RepData.DateBegin)+" ¯® "+
                     string(RepData.DateEnd)," §  "+string(StartDate)) );

     while( SelectData.MoveNext() )

        if( â®ƒŽ )
           CloseDate = ®«ãç¨âì„ âã‡ ¢¥àè¥­¨ïƒŽ(SelectData);
        else
           CloseDate = SQL_ConvTypeDate(SelectData.DealDate);
        end;

        DealDate = SQL_ConvTypeDate(SelectData.Beg_Date);

        if(RepData.OperState == STAT_ALL)
          /*‡ ¢¥àè¥­­ë¥*/
          if( (CloseDate >= StartDate) AND (CloseDate <= StopDate) )

             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( SelectData.DealID, SelectData.IsBack, STAT_FINISHED, DocKind, SQL_ConvTypeDate(SelectData.DealDate),
                                     ZTime, SelectData.Place, SelectData.ClientID, SelectData.ContrID,
                                     "", SelectData.Currency, SelectData.FIID, SelectData.Amount );
          else  /*¥§ ¢¥àè¥­­ë¥*/

             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( SelectData.DealID, SelectData.IsBack, STAT_NOTFINISHED, DocKind, SQL_ConvTypeDate(SelectData.DealDate),              
                                     ZTime, SelectData.Place, SelectData.ClientID, SelectData.ContrID,
                                     "", SelectData.Currency, SelectData.FIID, SelectData.Amount );
          end;
        elif(RepData.OperState == STAT_FINISHED) /*‡ ¢¥àè¥­­ë¥*/
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( SelectData.DealID, SelectData.IsBack, STAT_FINISHED, DocKind, SQL_ConvTypeDate(SelectData.DealDate),                 
                                     ZTime, SelectData.Place, SelectData.ClientID, SelectData.ContrID,
                                     "", SelectData.Currency, SelectData.FIID, SelectData.Amount );
        elif(RepData.OperState == STAT_NOTFINISHED) /*¥§ ¢¥àè¥­­ë¥*/
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( SelectData.DealID, SelectData.IsBack, STAT_NOTFINISHED, DocKind, SQL_ConvTypeDate(SelectData.DealDate),             
                                     ZTime, SelectData.Place, SelectData.ClientID, SelectData.ContrID,
                                     "", SelectData.Currency, SelectData.FIID, SelectData.Amount );
        else /*§ ª«îç¥­­ë¥*/
             ‚áâ ¢¨âì‡ ¯¨áì‚’ ¡«¨æã( SelectData.DealID, SelectData.IsBack, STAT_CONCLUSION, DocKind, SQL_ConvTypeDate(SelectData.DealDate),               
                                     ZTime, SelectData.Place, SelectData.ClientID, SelectData.ContrID,
                                     "", SelectData.Currency, SelectData.FIID, SelectData.Amount );
        end;
        Progress.Use;
     end;
     Progress.Remove;
  end;

  macro ‘¤¥«ª¨®„®£®¢®à ¬()
     var
        Progress = TProgressBar,
        continue_cicle, FD, Num = 0;                                                               
     var Qu, Select, SelectData;
     VAR NRecQuery, NRecSelect, NRecData, NRec =0;
     var StartDate, StopDate;

     m_CurDate = RepData.DateBegin;
     while( m_CurDate <= RepData.DateEnd )

       clearrecord(clopord);
       ClearGlobalTmp( "dclopord_tmp" );

       m_IsRepPrint = false;

       if(RepData.IsSeparatelyDate == false)
          m_CurDate = RepData.DateEnd;
       end;

       if(RepData.IsSeparatelyDate == false)
         StartDate = RepData.DateBegin;
         StopDate = RepData.DateEnd;
       else
         StartDate = m_CurDate;
         StopDate = m_CurDate;
       end;

       Žâ®¡à âì‘¤¥«ª¨(StartDate,StopDate);

       if( RepData.IncGO_IN )
          Žâ®¡à âìƒŽ_ˆ(DL_ISSUE_UNION,StartDate,StopDate);
          Žâ®¡à âìƒŽ_ˆ(DL_CHGAVRNOM,StartDate,StopDate);
       end;

       Qu = " select * "+
            "   from dclopord_tmp "+
            " order by t_ClientID, t_ContrID, t_PlaceID, t_Account, t_Currency, t_Status, t_DealDate, " +
             "          DECODE(t_BofficeKind,117,1,0), t_DealTime, t_DealID, t_IsBack";

       Select = RSDCommand( Qu );
       NRecSelect = RSDCommand( "SELECT COUNT(*) nRecs FROM (" + Qu + ")" );

       Select.execute();
       NRecSelect.execute();

       NRecData = TRsbDataSet(NRecSelect);
       SelectData = TRsbDataSet(Select);

       NRec = 0;
       if( NRecData.MoveNext() )
          NRec = Int(NRecData.nRecs);
       end;

       Progress.Init(NRec, StatLine, "¥ç âì ®âç¥â  ¯® ®¯¥à æ¨ï¬ ª«¨¥­â "+IIF(RepData.IsSeparatelyDate == false," c "+string(RepData.DateBegin)+" ¯® "+string(RepData.DateEnd)," §  "+string(m_CurDate)));

       PrevStatus = -1;
       IsNotFirstUse = false;
       m_Place = 0;
       m_ClientID = -1;
       m_ContrID = -1;

       while( SelectData.MoveNext() )
          m_ClientID = SelectData.ClientID;
          m_ContrID = SelectData.ContrID;

          PrintDealConditionByOperGrup(SelectData);

          Progress.Use;
       end;
       Progress.Remove;

       if( IsNotFirstUse )
          if( m_Account != "" )
             ˆâ®£¨®‘ç¥âã();
          else
             EndReportTab();
             ClearData();
          end;
          IsNotFirstUse = false;
       end;

       ClearPrevData();

       if( m_IsRepPrint )
          PrintRepFooter();
       end;

       m_CurDate = m_CurDate + 1;

     end;

  end;

  private macro GetComisReceiverID(sourceObjID)
     var receiverID = -1;
     var cmd = DL_RSDCommand();

     var query =   " select sfcom.t_ReceiverID as ReceiverID "
                 + "   from ddlcomis_dbt dlc, dsfcomiss_dbt sfcom "
                 + "  where dlc.t_ID = ? "
                 + "    and sfcom.t_FeeType = dlc.t_FeeType " 
                 + "    and sfcom.t_Number = dlc.t_ComNumber ";

     cmd.AddParam(sourceObjID);
     /*if(DataSet.TemplNum == DLGR_TEMPL_PAYCOMCONTR)
       query = query + " and sfcontr.t_PartyID = ? ";
       cmd2.AddParam(FD.tick.rec.PartyID);
     elif(FD.tick.rec.ClientID != -1) 
       query = query + " and sfcontr.t_PartyID = ? ";
       cmd2.AddParam(FD.tick.rec.ClientID);
     end;*/

     var comis = cmd.Execute(query);
     if(comis.moveNext())
        receiverID = comis.ReceiverID;
     end;
     return receiverID;
  end;
  // ®«ãç¨âì ‚¨¤Ž (¢ë¤à ­® ¨§ sc_inacc.mac)
  private macro GetKindOperat(type, isOut, rqID, FD)
     var kind = 0;

     if ((type == DLRQ_TYPE_AVANCE) or (type == DLRQ_TYPE_DEPOSIT)) // ¢ ­á, § ¤ â®ª
        kind = 21;
     elif (type == DLRQ_TYPE_PAYMENT)
        if (not FD.IsBack)
           kind = 20; // Ž¯« â  æ¥­­ëå ¡ã¬ £  
        else 
           kind = 19; //2- ï ç áâì
        end;
     elif (type == DLRQ_TYPE_DELIVERY)
        kind = 55; // ®áâ ¢ª  æ¥­­ëå ¡ã¬ £
     elif (type == DLRQ_TYPE_COMISS)
        var rq = TRecHandler("dlrq.dbt");
        if (®«ãç¨âì’Ž(rqID, rq))
           var comRecieverID = GetComisReceiverID(rq.rec.SourceObjID);

           if(rq.rec.Party == {OurBank}) // ®«ãç â¥«ì ª®¬¨áá¨¨ =  è ­ª
             kind = 8; // Ž¯« â  ª®¬¨áá¨¨ ¡ ­ª 
           elif ((FD.tick.rec.Flag1 == SET_CHAR) and (rq.rec.Party == comRecieverID) and (‚¨¤‘ã¡ê¥ªâ (rq.rec.Party, PTK_MARKETPLASE))) // à¨­ ¤«¥¦­®áâì áã¡ê¥ªâ  - ¡¨à¦  ˆ ¯à¨§­ ª Ž–
             kind = 9; // Ž¯« â  ª®¬¨áá¨¨ ¡¨à¦¨
           elif ((FD.tick.rec.Flag1 == UNSET_CHAR) and (rq.rec.Party == comRecieverID) and (‚¨¤‘ã¡ê¥ªâ (rq.rec.Party, PTK_BROKER))) // à¨­ ¤«¥¦­®áâì áã¡ê¥ªâ  - ¡à®ª¥à ˆ ­¥â ¯à¨§­ ª  Ž–
             kind = 10; // Ž¯« â  ª®¬¨áá¨¨ ¡à®ª¥à 
           elif ((FD.tick.rec.BrokerID > 0) and (comRecieverID == FD.tick.rec.BrokerID)) // ‚ á¤¥«ª¥ ãª § ­ ¯®áà¥¤­¨ª
             kind = 12; // Ž¯« â  ª®¬¨áá¨¨ ¯®áà¥¤­¨ª 
           elif ( ((not IsExchange(FD.Group)) or (IsREPO(FD.Group))) and (FD.dl_leg.rec.PayRegTax == SET_CHAR))
             kind = 11; // Ž¯« â  ¤¥¯®§¨â à­®© ª®¬¨áá¨¨
           end; 
        end;
     elif (type == DLRQ_TYPE_COMPPAYM)
        if( IsBUY(FD.Group) ) // ®¡à â­®¥ …Ž
           if ( isOut == 0 ) // DLRQ_KIND_COMMIT
              kind = 44; // ®«ãç¥­¨¥ ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           else
              kind = 43; // ‚ë¯« â  ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           end;
        else // ¯àï¬®¥ …Ž
           if( isOut == 1 ) // DLRQ_KIND_REQUEST
              kind = 43; // ‚ë¯« â  ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           else // ã¬¥­ìè¥­¨¥
              kind = 44; // ®«ãç¥­¨¥ ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           end;
        end;
     elif (type == DLRQ_TYPE_COMPDELIVERY) //ª®¬¯¥­á æ¨®­­ ï ¯®áâ ¢ª  (®«ãç¥­¨¥ ª®¬¯¥­á æ¨®­­®£® ¢§­®á )
        if( IsBUY(FD.Group) ) // ®¡à â­®¥ …Ž
           if( isOut == 1 ) // DLRQ_KIND_REQUEST
              kind = 44; // ®«ãç¥­¨¥ ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           else
              kind = 43; // ‚ë¯« â  ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           end;
        else // ¯àï¬®¥ …Ž
           if( isOut == 0 ) // DLRQ_KIND_COMMIT
              kind = 43; // ‚ë¯« â  ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           else
              kind = 44; // ®«ãç¥­¨¥ ª®¬¯¥­á æ¨®­­®£® ¢§­®á 
           end;
        end;
     elif (type == DLRQ_TYPE_INCREPO)  // ¯à®æ¥­âë ¯® …Ž
        kind = 19;
     elif (type == DLRQ_TYPE_PAYMREPOCOUP) // ¢ë¯« â  ¯® …Ž (ªã¯®­)
        if (IsBUY(FD.Group))
           kind = 25; // ‚®§¢à â ªã¯®­­®£® ¤®å®¤ 
        else
           kind = 22; // ®«ãç¥­¨¥ ªã¯®­­®£® ¤®å®¤ 
        end;
     elif (DLRQ_TYPE_PAYMREPOPART) // ¢ë¯« â  ¯® …Ž (—)
       if (IsBUY(FD.Group))
         kind = 40; // ‚®§¢à â áã¬¬ë ç áâ¨ç­®£® ¯®£ è¥­¨ï æ/¡ ª®­âà £¥­âã
       else
         kind = 41; // ®«ãç¥­¨¥ áã¬¬ë ç áâ¨ç­®£® ¯®£ è¥­¨ï ¯® æ/¡ ®â ª®­âà £¥­â 
       end;
     end;
     return kind;
  end;

  private macro ®Cç¥â ¬Š«¨¥­â®¢()
     var NRec = 0;
     var FD, Leg;
     Var Progress = TProgressBar;
     var ClientAccount, InnerCarry;
     var AccSelect, CarrySelect;
     VAR NRecQuery, NRecSelect, NRecData;
     var OperKind = "";
     var OperCode = "";
     var beginDatePeriod = RepData.DateBegin;
     record AccBuf(account);
     m_CurDate = RepData.DateBegin;
     while( m_CurDate <= RepData.DateEnd )
      BegAction(1, "Žâ¡®à áç¥â®¢ ¤«ï ®âçñâ . †¤¨â¥..."); //MZ

       m_IsRepPrint = false;
       if(RepData.IsSeparatelyDate == false)
          m_CurDate = RepData.DateEnd;
       end;

       AccSelect = RSDCommand( Žâ®¡à âì‘ç¥â „«ïŽâçñâ () );
       NRecSelect = RSDCommand("SELECT COUNT(*) nRecs FROM (" + Žâ®¡à âì‘ç¥â „«ïŽâçñâ () + ")");

       AccSelect.addParam( "", RSDBP_IN, PTSK_STOCKDL );
       NRecSelect.addParam( "", RSDBP_IN, PTSK_STOCKDL );

       AccSelect.addParam( "", RSDBP_IN, {OurBank} );
       NRecSelect.addParam( "", RSDBP_IN, {OurBank} );

       if( RepData.ClientID >= 0 )
          AccSelect.addParam( "", RSDBP_IN, RepData.ClientID );
          NRecSelect.addParam( "", RSDBP_IN, RepData.ClientID );
       end;

       if( (RepData.IsFormID > 0) and (RepData.FormSubID !=0) )
         AccSelect.addParam( "", RSDBP_IN, RepData.FormSubID);
         NRecSelect.addParam( "", RSDBP_IN, RepData.FormSubID);
       end;
       if( (RepData.IsVidID > 0) and (RepData.VidSubID !=0) )
         AccSelect.addParam( "", RSDBP_IN, RepData.VidSubID);
         NRecSelect.addParam( "", RSDBP_IN, RepData.VidSubID);
       end;

       if(RepData.ContrID > 0)
          AccSelect.addParam( "", RSDBP_IN, RepData.ContrID );
          NRecSelect.addParam( "", RSDBP_IN, RepData.ContrID );
       end;

       AccSelect.addParam( "", RSDBP_IN, PTSK_STOCKDL );
       NRecSelect.addParam( "", RSDBP_IN, PTSK_STOCKDL );

       if( RepData.DprtID != -1 )
          AccSelect.addParam( "", RSDBP_IN, RepData.DprtID );
          NRecSelect.addParam( "", RSDBP_IN, RepData.DprtID );
       end;

       AccSelect.execute();
       NRecSelect.execute();

       NRecData = TRsbDataSet(NRecSelect);

       if( (NRecData.MoveNext()) and (NRec != null) )
          NRec = ToInt(NRecData.nRecs);
       end;

       ClientAccount = TRsbDataSet(AccSelect);
       EndAction(); //MZ
       
	   if( NRec > 0 )
         Progress.Init( NRec, StatLine,
                      "à®á¬®âà áç¥â®¢ ª«¨¥­â  ¯® ¤®£®¢®àã"+IIF(RepData.IsSeparatelyDate == false," c "+string(RepData.DateBegin)+" ¯® "+
                       string(RepData.DateEnd)," §  "+string(m_CurDate)) );
       end;

       while( ClientAccount.MoveNext() )
         /*¯®«ãç¨âì ®áâ âª¨ ­  áç¥â¥ ­  ­ ç «®\ª®­¥æ ¯¥à¨®¤ */
         ClearRecord( AccBuf );
         ClearData();

         if( GetAccount( ClientAccount.Chapter, ClientAccount.Currency, ClientAccount.Account, AccBuf ) )
           if(RepData.IsSeparatelyDate == false)
              m_InRest = m_InRestVirt = Abs(GetRestAccount( AccBuf, RepData.DateBegin - 1 ));
              m_OutRest = m_OutRestVirt = Abs(GetRestAccount( AccBuf, RepData.DateEnd ));
           else
              m_InRest = m_InRestVirt= Abs(GetRestAccount( AccBuf, m_CurDate - 1 ));
              m_OutRest = m_OutRestVirt = Abs(GetRestAccount( AccBuf, m_CurDate ));
           end;
         end;

         m_FIID     = ClientAccount.Currency;
         m_Account  = ClientAccount.Account;
         m_Place    = ClientAccount.Place;
         m_ClientID = ClientAccount.PARTYID;
         m_ContrID  = ClientAccount.ID;
         m_Chapter  = ClientAccount.Chapter;

         var querySelect = "(SELECT inacc.t_Opertype Opertype, inacc.t_DealKind DealKind, inacc.t_Date OperDate, " +
                           "        inacc.t_DocumentKind DocKind, inacc.t_DocumentID DocID, inacc.t_Sum Sum, " +
                           "        DECODE(inacc.t_DebAcc,?,0,1) IsOut, " +/*§ ç¨á«¥­¨¥ - 0, á¯¨á ­¨¥ - 1*/
                           "        lvalues.T_NAME OperationName, /*inacc.t_Chapter,*/ " +
                           "        utl_raw.cast_to_varchar2(dbms_lob.substr(inacc.t_FmtBlobData_XXXX,2000)) DealNumber, " +
                           "        chr(0) isPrognos, " +
                           "        0 DealPart, 0 rqID  " +
                           "   FROM ddlinacc_dbt inacc, dllvalues_dbt lvalues " +
                           "  WHERE ((inacc.t_DebAcc = ?) or (inacc.t_KredAcc = ?)) " +
                           "   AND inacc.t_Department = ? " +
                           "   AND inacc.t_FIID = ? " +
                           "   AND lvalues.T_LIST = ? " +
                           "   AND lvalues.T_ELEMENT = inacc.t_Opertype " +
                           "   AND inacc.t_Date <= ? " +
                           "   AND inacc.t_Date >= ? " +
                           /*¥á«¨ AcctrnID ­¥ § ¯®«­¥­ë - íâ® §­ ç¨â, çâ® à¥ «ì­® ¯à®¢®¤ª  ‚“ ¡ã¤¥â áä®à¬¨à®¢ ­ 
                             ¢ ®¯¥à æ¨¨ à áç¥â®¢ ­  Ž– (¯® ­ áâà®©ª®¥),   âª âà¥¡ã¥âáï, çâ®¡ë ¢ ®¯¥à æ¨¨ à áç¥â®¢ ­  Ž– ¯à®¢®¤ª¨ ‚“ è«¨ ¯®á¤¥«®ç­®, â® ¯à¨
                             ¢ë¯®«­¥­¨¨ á¤¥«ª¨ Ž– ¢ dlinacc_dbt § ­®á¨âáï § ¯¨áì ¢ á ¯ãáâë¬¨ AcctrnID,
                             ª®â. § ¯®«­ïîâáï ¯à¨ ¢ë¯®«­¥­¨¨ íâ®© ¯à®¢®¤ª¨ ‚“ ¢ ®¯¥à æ¨¨ à áç¥âë ­  Ž–.
                           */
                           "   AND inacc.t_AccTrnID > 0 )" ;//+
                           //" order by inacc.t_Date, inacc.t_Id )";

         // à®£­®§
         if (RepData.IsPrognos)
            querySelect = querySelect +
                        " UNION ALL ( " +
                        " SELECT rq.t_Type  Opertype, " + // ‚­¨¬ ­¨¥, Type!!!
                        "        tick.t_BOfficeKind  DealKind," +
                        "        DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate, rq.t_FactDate)  OperDate, " +
                        "        0 DocKind, " +
                        "        tick.t_DealID DocID, " +
                        "        rq.t_Amount Sum, " +
                        "        DECODE (rq.t_Kind, 1, 1, 0) IsOut, " + // âà¥¡®¢ ­¨¥ - ¬¨­ãá
                        "        CHR(1) OperationName, " +
                        "        tick.t_DealCode DealNumber," +
                        "        chr(88) isPrognos, " +
                        "        DECODE(rq.t_DealPart, 1, 0, 2) DealPart, rq.t_ID rqID " +
                        "   FROM ddl_tick_dbt tick, ddlrq_dbt rq" +
                        "  WHERE tick.t_BOfficeKind in (101,117,127) " + // DL_SECURITYDOC, DL_RETIREMENT, DL_AVRWRT
                        "    AND ( (tick.t_DealStatus = 0 and tick.t_Prognos = chr(88)) or (tick.t_DealStatus <= 10)) " +
                        "    AND tick.t_Department = ?" +
                        "    AND tick.t_ClientContrID = ? " +
                        "    AND tick.T_ClientID = ? " +
                        "    AND rq.t_DocID = tick.t_DealID " +
                        "    AND rq.t_DocKind = tick.t_BOfficeKind" +
                        "    AND rq.t_FIID = ? " +
                        //   ­¥§ ¢¥àè¥­­ë¥
                        "    AND tick.t_DealDate <= ? " + // ¤ â  ®ª®­ç ­¨ï çâ®¡ë ­¥ ¢ë¡¨à âì á¤¥«ª¨ áâ àè¥
                        //"    AND (rq.t_FactDate = TO_DATE ('01.01.0001', 'DD.MM.YYYY') or rq.t_FactDate <= ? ) )" ; // ¤ â  ®ª®­ç ­¨ï
                        "    AND DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate, rq.t_FactDate) <= ?)";
//                        "  ORDER BY Operdate, DealNumber )";
         end;
         querySelect = querySelect + " ORDER BY Operdate, DealNumber";

         CarrySelect = RSDCommand(querySelect);

         CarrySelect.addParam("", RSDBP_IN, ClientAccount.Account);
         CarrySelect.addParam("", RSDBP_IN, ClientAccount.Account);
         CarrySelect.addParam("", RSDBP_IN, ClientAccount.Account);
         CarrySelect.addParam("", RSDBP_IN, RepData.DprtID);
         CarrySelect.addParam("", RSDBP_IN, ClientAccount.Currency);
         CarrySelect.addParam("", RSDBP_IN, OBJTYPE_CALCOPKIND);
         if(RepData.IsSeparatelyDate == false)
            CarrySelect.addParam("", RSDBP_IN, RepData.DateEnd);
            CarrySelect.addParam("", RSDBP_IN, RepData.DateBegin);
         else
            CarrySelect.addParam("", RSDBP_IN, m_CurDate);
            CarrySelect.addParam("", RSDBP_IN, m_CurDate);
         end;

         if (RepData.IsPrognos)
            CarrySelect.addParam("", RSDBP_IN, RepData.DprtID);
            CarrySelect.addParam("", RSDBP_IN, m_ContrID);
            CarrySelect.addParam("", RSDBP_IN, m_ClientID);
            CarrySelect.addParam("", RSDBP_IN, m_FIID);
            if(RepData.IsSeparatelyDate == false)
               CarrySelect.addParam("", RSDBP_IN, RepData.DateEnd);
               CarrySelect.addParam("", RSDBP_IN, RepData.DateEnd);
            else
               CarrySelect.addParam("", RSDBP_IN, m_CurDate);
               CarrySelect.addParam("", RSDBP_IN, m_CurDate);
            end;
         end;

         CarrySelect.execute();

         InnerCarry = TRsbDataSet(CarrySelect);

         m_IsExistsCarry = false;
         m_IsPrintByAcc = false;
         if(RepData.IsSeparatelyDate == false)
            beginDatePeriod = RepData.DateBegin;
         else
            beginDatePeriod = m_CurDate;
         end;

         m_InRestVirt = m_OutRestVirt = 0;

         while( InnerCarry.MoveNext() )
            if (RepData.IsPrognos and (InnerCarry.OperDate < beginDatePeriod))
              // ‘®¡¨à ¥¬ ¢å®¤ïé¨© ®áâ â®ª
              m_InRestVirt = m_InRestVirt + IIF(InnerCarry.IsOut == 1, -1, 1)*InnerCarry.Sum;
              m_OutRestVirt = m_InRestVirt;
            else // ¥ç â¥¬ ®âç¥â
               if( InnerCarry.DocID != 0 )
                  /*¥à¢¨ç­ë© ¤®ªã¬¥­â*/
                  if( (InnerCarry.DealKind == DL_CALCOPER) or (InnerCarry.DocKind == DL_CALCOPER) ) //159
                     FD = DLFirstDocDL_ACC( 0, InnerCarry.DocID );
                  elif( (InnerCarry.DealKind == DL_SECURLEG) or (InnerCarry.DocKind == DL_SECURLEG) )
                     Leg = GetDlLegByID( InnerCarry.DocID, true, false );
                     FD = SPFirstDoc( Leg.LegKind, Leg.DealID );
                  elif( InnerCarry.DealKind == DL_STOCKCONTR)
                     FD = "";
                     OperKind = "Ž¯« â  ¯® ¤®£®¢®àã";
                     OperCode = ClientAccount.NumConc;
                  elif( InnerCarry.DealKind == DL_ISSUE_UNION )
                     FD = "";
                     OperKind = "ƒ«®¡ «ì­ ï ®¯¥à æ¨ï á æ/¡";
                     OperCode = InnerCarry.DealNumber;
                  elif( InnerCarry.DealKind == DL_CHGAVRNOM )
                     FD = "";
                     OperKind = "Ž¯¥à æ¨ï ¨§¬¥­¥­¨ï ­®¬¨­ «  æ/¡";
                     OperCode = InnerCarry.DealNumber;
                  elif( InnerCarry.DealKind == DL_WRTMONEY )
                     FD = "";
                     OperKind = "Ž¯¥à æ¨ï § ç¨á«¥­¨ï/á¯¨á ­¨ï ¤¥­¥¦­ëå áà¥¤áâ¢";
                     OperCode = InnerCarry.DealNumber;
                  else
                     FD = SPFirstDoc( Int(InnerCarry.DealPart), InnerCarry.DocID );
                  end;

                  if( FD != "" )
                  /*®¬¥à ®¯¥à æ¨¨*/
                     if( FD.Kind == DL_CALCOPER )
                        /*…á«¨ Ž‚“ ¯à¨¢ï§ ­  ª á¤¥«ª¥ - ¢ë¢¥áâ¨ ­®¬¥à á¤¥«ª¨*/
                        if( InnerCarry.DealKind != DL_CALCOPER )
                           OperKind = ®«ãç¨âì‚¨¤Ž¯¥à æ¨¨(GetOperationGroup(FD.dl_acc.rec.DealType), false, false, true, false, false, true);
                           OperCode = InnerCarry.DealNumber;
                        else
                           OperKind = " áç¥â­ ï ®¯¥à æ¨ï ‚“";
                           OperCode = FD.dl_acc.rec.Code;
                        end;
                     else

                        if((FD.tick.rec.IsPartyClient == SET_CHAR) and ( (FD.tick.rec.PartyId == ClientAccount.PartyId) and (FD.tick.rec.PARTYCONTRID == ClientAccount.Id) ) )  
                           OperKind = ®«ãç¨âì‚¨¤‘¤¥«ª¨Š®­âà £¥­â „(FD.Group, FD.IsBack, true);
                        else
                           OperKind = ®«ãç¨âì‚¨¤Ž¯¥à æ¨¨(FD.Group, FD.IsBack, true, true, false, false, true);
                        end;
                        OperCode = FD.tick.rec.DealCode;
                     end;
                  end;
               end;

               m_IsExistsCarry = true;

               var OperationName = InnerCarry.OperationName;
               if (InnerCarry.IsPrognos)
                  if( InnerCarry.IsOut == 0 )
                     m_ItogInVirt = m_ItogInVirt + InnerCarry.Sum;
                  else
                     m_ItogOutVirt = m_ItogOutVirt + InnerCarry.Sum;
                  end;
                  var kind = GetKindOperat(InnerCarry.Opertype, InnerCarry.IsOut, InnerCarry.RqID, FD);
                  if( m_Chapter == 21 )
                     if( kind == 8 )
                        m_BankCommSumVirt = m_BankCommSumVirt + InnerCarry.Sum;
                     elif( (kind == 9) or
                           (kind == 10) or
                           (kind == 12)
                         )
                        m_AgentCommSumVirt = m_AgentCommSumVirt + InnerCarry.Sum;
                     end;
                  end;
                  DL_GetValueName(OBJTYPE_CALCOPKIND, kind, OperationName); 
                  // ‘®¡¨à ¥¬ ¨áå®¤ïé¨© ®áâ â®ª
                  m_OutRestVirt = m_OutRestVirt + IIF(InnerCarry.IsOut == 1, -1, 1)*InnerCarry.Sum;
               else
                  if( InnerCarry.IsOut == 0 )
                     m_ItogIn = m_ItogIn + InnerCarry.Sum;
                  else
                     m_ItogOut = m_ItogOut + InnerCarry.Sum;
                  end;

                  if( m_Chapter == 21 )
                     if( InnerCarry.Opertype == 8 )
                        m_BankCommSum = m_BankCommSum + InnerCarry.Sum;
                     elif( (InnerCarry.Opertype == 9) or
                           (InnerCarry.Opertype == 10) or
                           (InnerCarry.Opertype == 12)
                         )
                        m_AgentCommSum = m_AgentCommSum + InnerCarry.Sum;
                     end;
                  end;
               end;
               
               if( m_KindRep != CLSTATUSACCOUNTORD_SMPL )
                  ¥ç âì‘âà®ª¨Žâç¥â ( OperationName, OperKind, OperCode,
                                      Date(InnerCarry.OperDate), InnerCarry.Sum, InnerCarry.IsOut, InnerCarry.isPrognos );
               end;
            end;
         end;
         if( ((m_KindRep == CLSTATUSACCOUNTORD) AND (not m_IsExistsCarry) and ((m_InRest != $0) or (m_OutRest != $0))) OR
             ((m_KindRep == CLSTATUSACCOUNTORD_SMPL) AND (m_IsExistsCarry or (m_InRest != $0) or (m_OutRest != $0)))
           )
            /*…á«¨ ¯® ®â®¡à ­­®¬ã áç¥âã ¯à®¢®¤®ª ­¥ ¡ë«®, â® ä®à¬¨àã¥âáï â®«ìª® ®¤­  áâà®ª , £¤¥ § ¯®«­ïîâáï ¢å®¤ïé¨© ¨ ¨áå®¤ïé¨© ®áâ âª¨*/
             ¥ç âì‘âà®ª¨Žâç¥â ();
         end;

         if( m_IsPrintByAcc AND (m_IsExistsCarry OR (m_KindRep == CLSTATUSACCOUNTORD_SMPL)) ) /*¯¥ç âì ¨â®£®¢*/
            if( m_KindRep == CLSTATUSACCOUNTORD )
               PrintItog();
            end;
            if( m_Chapter == 21 )
               PrintCommFooter();
            end;
         end;

         ClearData();
         m_ClientID = "";
         m_ContrID  = "";
         m_Chapter  = "";
         m_Place    = 0;

         Progress.Use;
       end;
       Progress.Remove;
       ClearPrevData();
       if( m_IsRepPrint )
          PrintRepFooter();
       end;

       m_CurDate = m_CurDate + 1;
     end;

  end;

  private macro ‘¤¥«ª¨®”¨«¨ «ã()

    m_IsExistsClAcc = false;
    m_IsExistsClOper = false;

    if(m_KindRep == CLOPERORDER)
      ‘¤¥«ª¨®„®£®¢®à ¬();
    else
      ®Cç¥â ¬Š«¨¥­â®¢();
    end;
  end;

  private macro ‘¤¥«ª¨®‚á¥¬”¨«¨ « ¬()
     var Department;
     var sql = RSDCommand(" SELECT t_Code"
               + " FROM  ddp_dep_dbt "
               + " start with t_Code = ? connect by prior t_Code = t_ParentCode order siblings by t_Code ");

     Sql.addParam( "", RSDBP_IN, {OperDprt} );

     sql.execute();
     Department = TRsbDataSet( sql );

     while( Department.MoveNext() )
        RepData.DprtID = Department.Code;
        ‘¤¥«ª¨®”¨«¨ «ã();
     end;
  end;

  private macro ExecuteReport(Department:integer)

     UseNewSheetInTotalBook();
     SetActiveSheet( m_SheetName );
     if( Department == -1 )
         ‘¤¥«ª¨®‚á¥¬”¨«¨ « ¬();
     else
         ‘¤¥«ª¨®”¨«¨ «ã();
     end;
  end;

  PRIVATE MACRO Create()
     var Department = RepData.DprtID;

     if((RepData.OrdClntAccount == true) AND (RepData.OrdClntAccSmpl != true))
       m_SheetName = IIF(RepData.IsPrognos, "® á®áâ®ï­¨¨ áç¥â®¢, ¯à®£­®§", "® á®áâ®ï­¨¨ áç¥â®¢");
       m_KindRep = CLSTATUSACCOUNTORD;
       m_Prefix = "N1_";
       ExecuteReport(Department);
     end;

     if((RepData.OrdClntAccount == true) AND (RepData.OrdClntAccSmpl == true))
       m_SheetName = IIF(RepData.IsPrognos, "á®áâ.áç¥â®¢,¯à®£­(ã¯à®é.¢¨¤)", "® á®áâ®ï­.áç¥â®¢(ã¯à®é.¢¨¤)");
       m_KindRep = CLSTATUSACCOUNTORD_SMPL;
       m_Prefix = "N2_";
       ExecuteReport(Department);
     end;

     /*Žâç¥â ¯® ®¯¥à æ¨ï¬ ª«¨¥­â */
     if(RepData.OrdClntOper == true)
       m_SheetName = IIF(RepData.IsPrognos, "¯® á¤¥«ª ¬ ¨ ®¯¥à æ,¯à®£­®§", "¯® á¤¥«ª ¬ ¨ ®¯¥à æ¨ï¬");
       m_KindRep = CLOPERORDER;
       m_Prefix = "N3_";
       IsFirstPrint = true;
       ExecuteReport(Department);
     end;

     if( (not m_IsExistsClAccGlobal) AND (not m_IsExistsClOperGlobal) )
        SetActiveSheet( "® á®áâ®ï­¨¨ áç¥â®¢" );
        PrintFormatString( "#\n", "N1_NoRepData", "¥â ¤ ­­ëå, ã¤®¢«¥â¢®àïîé¨å ¯ à ¬¥âà ¬ ®âç¥â " );
       CopyAllSheetInTotalBook( "® á®áâ®ï­¨¨ áç¥â®¢", false, "N1_NoRepData", 0 );
     end;
  END;
  initDL_CReportTemplate( null, "Report_clopord.xls", null, null, null, true );
END;

macro ReportRun ( DprtID: integer, ClientID: integer,
                  _IsFormID:integer, _FormSubID:integer, _IsVidID:integer, _VidSubID:integer, _NoResident:bool,
                  SfContrID:integer, PeriodNum:integer, IsPrognos:bool,
                  DateBegin: date, DateEnd: date, IsSeparatelyDate: bool,
                  OrdClntAccount: bool, OrdClntAccSmpl: bool, OrdClntOper: bool,
                  OperState:integer, IncGO_IN:bool,_Totals:bool, _IsApp: bool, IsExcel:bool )

   Dl_CallInsertStat( IIF( IsExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
   RepData = SourceData(DprtID, ClientID,
                  _IsFormID, _FormSubID, _IsVidID, _VidSubID,_NoResident,
                  SfContrID, PeriodNum, IsPrognos,
                  DateBegin, DateEnd, IsSeparatelyDate, OrdClntAccount,OrdClntAccSmpl, OrdClntOper, OperState, IncGO_IN, _Totals, _IsApp, IsExcel );
   var errcode, errtext;
   var TmpFName = GetWorkFileName("clopord");

   clopord = TBFile( "clopord.tmp", "W", 0 );

   ClearGlobalTmp( "dclopord_tmp" );
   SP_Clopord_Report().Run();
end;