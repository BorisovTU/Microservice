/* Операция списания/зачисления ц/б
   Шаг отказа */

import InsCarryDoc, "sp_categ.mac", "sp_car.mac";


/**
  @brief it_log - сохранение в лог текстового сообщения
  @param[in] text - текстовое сообщение
*/
private macro it_log(text)
  var sql = "begin it_log.log(:1); end;";
  var cmd = RSDCommand(sql);
  cmd.AddParam("",RSDBP_IN,text);
  cmd.execute;
end;

macro ExecuteStep( Doc, ticket, DocKind, OperationID )

  record deal(dl_tick);
  var    FD, dat;

  SetBuff( deal, ticket );
  FD = SPFirstDoc( deal );
  GetOprDate( 0, dat );

  //установка статуса ТО в "Отвергнуто"
  //var DlRq = TRecHandler("dlrq");
  //DlRq = FD.GetRQ(DLRQ_TYPE_DELIVERY);
  if( УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_DELIVERY), DLRQ_STATE_REJECT, dat) != 0 )
    MsgBox("Не удалось установить статус ТО в \"Отвергнут\"");
    return 1;
  end;

  if( SetRejectGrDeal(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, dat, true) != 0 )
    MsgBox("Не удалось отменить операцию");
    return 1;
  end;

  it_log("Шан Операции выполнен wrtavr27PKO.mac");

  return 0;

end;


/* Массовое исполнение */
MACRO MassExecuteStep()
  MsgBox("test test test");
  it_log("MassExecuteStep wrtavr27PKO.mac");
  return 0;
END;
