/*
$Name:        mvcb30.mac
$Module:      Ценные бумаги
$Description: Операция "Перевод ценных бумаг". Шаг "Перевод стоимости ц/б"
*/
import InsCarryDoc, DealsInter, SecInter, "dlcarry.inc", "sp_categ.mac", "sp_cartr.mac", "sp_cars.mac";

record dl_comm_trans("dlcomsum.str"); 
private record fi(fininstr);


PRIVATE MACRO ВыполнитьПереводИз_ПКУ(FD, d, comm, opid)
  var accOld = TRecHandler("account.dbt");
  var accNew = TRecHandler("account.dbt");
  var CarrySum = $0;
  var CatCode = "";
  var query, cmd, DataSet;
  var FD_Deal = NULL;

  if( FD.IsExistAccount("Наш портфель ПКУ, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, null, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Наш портфель ц/б", accOld, 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перемещение б/ст. в целевой портфель", /* Ground */
                                        null, 
                                        GetFIRoleByPortfolio(comm.DestPortofolio),
                                        null,
                                        FD.GetAccFIID("Наш портфель ц/б"), accOld.rec.Code_Currency
                                       ))
          return 1;
      end;
    end;
  end;

  if(comm.Currency_Sum > 0)

    query =   " SELECT LOT.T_DEALID "
            + "  FROM V_SCWRTHISTEX A, DPMWRTSUM_DBT LOT "
            + " WHERE A.T_ID_OPERATION = ? "
            + "   AND A.T_ACTION       = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
            + "   AND A.T_STATE        = " + PM_WRTSUM_SALE_BPP
            + "   AND LOT.T_SUMID      = A.T_PARENT";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(opid);

    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

      if(ВедениеСчетовБПППоВыпуску() == true)
        CatCode = "Наш портфель ПКУ, ц/б";
      else
        CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина ПКУ БПП", "Ц/б, ПКУ БПП");
      end;

      if( FD_Deal.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, null, null, true), accOld, null, comm.CommDate) )
        CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

        if(CarrySum > 0)
          if(ВедениеСчетовБПППоВыпуску() == true)
            CatCode = "Наш портфель ц/б";
          else
            CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
          end;

          if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                            CatCode, accOld, 
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            accOld.rec.Code_Currency,    /* Валюта */
                                            CarrySum,                    /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перемещение б/ст. в целевой портфель БПП", /* Ground */
                                            null, 
                                            GetFIRoleByPortfolio(comm.DestPortofolio, null, null, true),
                                            null,
                                            FD_Deal.GetAccFIID(CatCode), accOld.rec.Code_Currency
                                           ))
              return 1;
          end;
        end;
      end;
    end;
  end;

  if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        accOld, "+РС, д/с", 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Восстановление резерва",    /* Ground */
                                        null,
                                        null,
                                        GetFIRoleByPortfolio(comm.SrcPortfolio)
                                       ))
          return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
    
    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        accOld, "+РС, д/с", 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Восстановление резерва",    /* Ground */
                                        null,
                                        null,
                                        GetFIRoleByPortfolio(comm.SrcPortfolio, false, true)
                                       ))
          return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "-КОР_РС, д/с", accOld,   
                                        comm.CommDate,                /* Дата */
                                        1,                            /* Глава */
                                        accOld.rec.Code_Currency,     /* Валюта */
                                        CarrySum,                     /* Сумма */
                                        d,                            /* Документ */
                                        INPCARRY,                     /* Result_Carry */
                                        " 1",                         /* Kind_Oper */
                                        comm.CommCode,                /* Numb_Document */
                                        "Восстановление оценочного резерва",/* Ground */
                                        null,
                                        GetFIRoleByPortfolio(comm.SrcPortfolio)
                                       ))
          return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        accOld, "+КОР_РС, д/с", 
                                        comm.CommDate,                /* Дата */
                                        1,                            /* Глава */
                                        accOld.rec.Code_Currency,     /* Валюта */
                                        CarrySum,                     /* Сумма */
                                        d,                            /* Документ */
                                        INPCARRY,                     /* Result_Carry */
                                        " 1",                         /* Kind_Oper */
                                        comm.CommCode,                /* Numb_Document */
                                        "Восстановление оценочного резерва",/* Ground */
                                        null,
                                        null,
                                        GetFIRoleByPortfolio(comm.SrcPortfolio)
                                       ))
          return 1;
      end;
    end;
  end;

  return 0;
END;


PRIVATE MACRO ВыполнитьПереводВ_ПКУ(FD, d, comm, opid)
  var accOld = TRecHandler("account.dbt");
  var accNew = TRecHandler("account.dbt");
  var CarrySum = $0;
  var CatCode = "";
  var query, cmd, DataSet;
  var AcCurSec = УЧЕТ_ВАЛЮТНЫХ_ДОЛЕВЫХ_ЦБ();
  var SumEquivalentCarry = null;
  var FD_Deal = NULL;
  var err = 0;
  var OptValue = 0;
  var Rest = $0, FiRole = 0;
                                                        
  GetRegistryValue( "SECUR\\РЕКЛАСС.В ПКУ. КОРРЕКТ.СТ-ТИ", V_INTEGER, OptValue, err );
  if( err != 0 )
     msgbox("Ошибка при получении значения настройки SECUR\\РЕКЛАСС.В ПКУ. КОРРЕКТ.СТ-ТИ");
     return 1;
  elif((OptValue != 1) and (OptValue != 2))
     msgbox("Неверное значения настройки SECUR\\РЕКЛАСС.В ПКУ. КОРРЕКТ.СТ-ТИ");
     return 1;
  end;

  if( FD.IsExistAccount("Наш портфель ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, null, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

    if((AcCurSec != 0) and (not FI_IsBond(comm.FIID)) and (FD.FaceFIID() != NATCUR))
      SumEquivalentCarry = abs(GetRestAByID(accOld.rec.AccountID, comm.CommDate, NATCUR));
    end; 

    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Наш портфель ПКУ, ц/б", accOld, 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перемещение б/ст. в целевой портфель", /* Ground */
                                        null, 
                                        GetFIRoleByPortfolio(comm.DestPortofolio),
                                        null,
                                        NATCUR, accOld.rec.Code_Currency,
                                        null,null,null,null,null,null,
                                        null,null,null,null,null,null,
                                        SumEquivalentCarry 
                                       ))
          return 1;
      end;
    end;
  end;

  //По счетам БПП
  if(comm.Currency_Sum > 0)

    query =   " SELECT LOT.T_DEALID, B.T_CORRVALUE "
            + "  FROM V_SCWRTHISTEX A, DPMWRTSUM_DBT LOT, V_SCWRTHISTEX B "
            + " WHERE A.T_ID_OPERATION = ? "
            + "   AND A.T_ACTION       = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
            + "   AND A.T_STATE        = " + PM_WRTSUM_SALE_BPP
            + "   AND LOT.T_SUMID      = A.T_PARENT"
            + "   AND B.T_SUMID        = A.T_SUMID "
            + "   AND B.T_INSTANCE     = A.T_INSTANCE - 1 ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(opid);

    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

      if(ВедениеСчетовБПППоВыпуску() == true)
        CatCode = "Наш портфель ц/б";
      else
        CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
      end;

      if( FD_Deal.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, null, null, true), accOld, null, comm.CommDate) )
        CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

        if(CarrySum > 0)
          if((AcCurSec != 0) and (not FI_IsBond(comm.FIID)) and (FD_Deal.FaceFIID() != NATCUR))
            SumEquivalentCarry = abs(GetRestAByID(accOld.rec.AccountID, comm.CommDate, NATCUR));
          end;

          if(ВедениеСчетовБПППоВыпуску() == true)
            CatCode = "Наш портфель ПКУ, ц/б";
          else
            CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина ПКУ БПП", "Ц/б, ПКУ БПП");
          end;

          if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                            CatCode, accOld, 
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            accOld.rec.Code_Currency,    /* Валюта */
                                            CarrySum,                    /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перемещение б/ст. в целевой портфель БПП", /* Ground */
                                            null, 
                                            GetFIRoleByPortfolio(comm.DestPortofolio, null, null, true),
                                            null,
                                            NATCUR, accOld.rec.Code_Currency,
                                            null,null,null,null,null,null,
                                            null,null,null,null,null,null,
                                            SumEquivalentCarry
                                           ))
              return 1;
          end;
        end;
      end;

      CarrySum = abs(DataSet.CorrValue);

      if((OptValue == 2) and (CarrySum > 0)) //Корректировку переносим на тело БПП
        
        if( FD.IsExistAccount("+Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
          Rest = abs(GetRestAccount(accOld.rec, comm.CommDate));

          if((Rest > 0) and (Rest > CarrySum))

            if(ВедениеСчетовБПППоВыпуску() == true)
              CatCode = "Наш портфель ПКУ, ц/б";
            else
              CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина ПКУ БПП", "Ц/б, ПКУ БПП");
            end;

            if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                              CatCode, accOld,  
                                              comm.CommDate,               /* Дата */
                                              1,                           /* Глава */
                                              accOld.rec.Code_Currency,    /* Валюта */
                                              CarrySum,                    /* Сумма */
                                              d,                           /* Документ */
                                              INPCARRY,                    /* Result_Carry */
                                              " 1",                        /* Kind_Oper */
                                              comm.CommCode,               /* Numb_Document */
                                              "Списание корректировок",    /* Ground */
                                              null,
                                              GetFIRoleByPortfolio(comm.DestPortofolio, null, null, true)
                                             ))
                return 1;
            end;

            CarrySum = $0;

          end;
        end;

        if(CarrySum > 0)
          if( FD.IsExistAccount("-Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
             Rest = abs(GetRestAccount(accOld.rec, comm.CommDate));

             if((Rest > 0) and (Rest > CarrySum))
               if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                                 accOld, CatCode, 
                                                 comm.CommDate,               /* Дата */
                                                 1,                           /* Глава */
                                                 accOld.rec.Code_Currency,    /* Валюта */
                                                 CarrySum,                    /* Сумма */
                                                 d,                           /* Документ */
                                                 INPCARRY,                    /* Result_Carry */
                                                 " 1",                        /* Kind_Oper */
                                                 comm.CommCode,               /* Numb_Document */
                                                 "Списание корректировок",    /* Ground */
                                                 null,
                                                 null,
                                                 GetFIRoleByPortfolio(comm.DestPortofolio, null, null, true)
                                                ))
                   return 1;
               end;
             end;
          end;
        end;

      end;
    end;
  end;

  if( FD.IsExistAccount("+Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
     CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

     if(CarrySum > 0)
       if(not ПроводкаПоКатегориямУчета( FD, 
                                         IIF(OptValue == 2, "Наш портфель ПКУ, ц/б", "-Маржа, ц/б"), accOld,  
                                         comm.CommDate,               /* Дата */
                                         1,                           /* Глава */
                                         accOld.rec.Code_Currency,    /* Валюта */
                                         CarrySum,                    /* Сумма */
                                         d,                           /* Документ */
                                         INPCARRY,                    /* Result_Carry */
                                         " 1",                        /* Kind_Oper */
                                         comm.CommCode,               /* Numb_Document */
                                         "Списание корректировок",    /* Ground */
                                         null,
                                         GetFIRoleByPortfolio(IIF(OptValue == 2, comm.DestPortofolio, comm.SrcPortfolio))
                                        ))
           return 1;
       end;
     end;
  end;

  if( FD.IsExistAccount("-Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
     CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

     if(CarrySum > 0)
       if(not ПроводкаПоКатегориямУчета( FD, 
                                         accOld, IIF(OptValue == 2, "Наш портфель ПКУ, ц/б", "+Маржа, ц/б"), 
                                         comm.CommDate,               /* Дата */
                                         1,                           /* Глава */
                                         accOld.rec.Code_Currency,    /* Валюта */
                                         CarrySum,                    /* Сумма */
                                         d,                           /* Документ */
                                         INPCARRY,                    /* Result_Carry */
                                         " 1",                        /* Kind_Oper */
                                         comm.CommCode,               /* Numb_Document */
                                         "Списание корректировок",    /* Ground */
                                         null,
                                         null,
                                         GetFIRoleByPortfolio(IIF(OptValue == 2, comm.DestPortofolio, comm.SrcPortfolio))
                                        ))
           return 1;
       end;
     end;
  end;

  if(comm.SrcPortfolio == KINDPORT_SSSD)
    CatCode = IIF(ПарностьСчетовПереоценки(), "-Переоценка, ц/б СССД_ЦБ", "-Переоценка, ц/б");
    if(FD.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "-ПО ДК 2014",  
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание переоценки"        /* Ground */
                                         ))
            return 1;
        end;
      end;
    end;

    CatCode = IIF(ПарностьСчетовПереоценки(), "+Переоценка, ц/б СССД_ЦБ", "+Переоценка, ц/б");
    if(FD.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "+ПО ДК 2014", accOld, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание переоценки"        /* Ground */
                                         ))
            return 1;
        end;
      end;
    end;
  elif(comm.SrcPortfolio == KINDPORT_SSPU)

    CatCode = "-Переоценка, ц/б ССПУ_ЦБ";
    if(FD.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "-МаржаП, ц/б",  
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание переоценки"        /* Ground */
                                         ))
            return 1;
        end;
      end;
    end;

    CatCode = "+Переоценка, ц/б ССПУ_ЦБ";
    if(FD.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "+МаржаП, ц/б", accOld, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание переоценки"        /* Ground */
                                         ))
            return 1;
        end;
      end;
    end;
  end;

  if(comm.SrcPortfolio == KINDPORT_SSSD)
    if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "Резерв ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос резерва",           /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "Резерв ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос резерва",          /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio, false, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "-КОР_РС, д/с", accOld,   
                                          comm.CommDate,                /* Дата */
                                          1,                            /* Глава */
                                          accOld.rec.Code_Currency,     /* Валюта */
                                          CarrySum,                     /* Сумма */
                                          d,                            /* Документ */
                                          INPCARRY,                     /* Result_Carry */
                                          " 1",                         /* Kind_Oper */
                                          comm.CommCode,                /* Numb_Document */
                                          "Перенос оценочного резерва", /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "+КОР_РС, д/с", 
                                          comm.CommDate,                /* Дата */
                                          1,                            /* Глава */
                                          accOld.rec.Code_Currency,     /* Валюта */
                                          CarrySum,                     /* Сумма */
                                          d,                            /* Документ */
                                          INPCARRY,                     /* Result_Carry */
                                          " 1",                         /* Kind_Oper */
                                          comm.CommCode,                /* Numb_Document */
                                          "Перенос оценочного резерва",/* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;
  end;

  return 0;
END;


PRIVATE MACRO ВыполнитьПереводВ_ПДО(FD, d, comm, opid)
  var accOld = TRecHandler("account.dbt");
  var accNew = TRecHandler("account.dbt");
  var CarrySum = $0;
  var CatCode = "", CatOverOldAcc = "";

  if( FD.IsExistAccount("Наш портфель ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, null, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Наш портфель ц/б", accOld, 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перемещение б/ст. в целевой портфель", /* Ground */
                                        null, 
                                        GetFIRoleByPortfolio(comm.DestPortofolio)
                                       ))
          return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("Уплаченный НКД", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, null, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Наш портфель ц/б", accOld, 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перевод уплаченного НКД",   /* Ground */
                                        null, 
                                        GetFIRoleByPortfolio(comm.DestPortofolio)
                                       ))
          return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true), accOld, null, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Наш портфель ц/б", accOld, 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перевод начисленных процентов", /* Ground */
                                        null, 
                                        GetFIRoleByPortfolio(comm.DestPortofolio)
                                       ))
          return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, true), accOld, null, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Наш портфель ц/б", accOld, 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перевод дисконта",          /* Ground */
                                        null, 
                                        GetFIRoleByPortfolio(comm.DestPortofolio)
                                       ))
          return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(comm.SrcPortfolio), accOld, null, comm.CommDate) )
    CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
    if(CarrySum > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Наш портфель ц/б", accOld, 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        accOld.rec.Code_Currency,    /* Валюта */
                                        CarrySum,                    /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перевод остатка премии",          /* Ground */
                                        null, 
                                        GetFIRoleByPortfolio(comm.DestPortofolio)
                                       ))
          return 1;
      end;
    end;
  end;


  if( FD.IsExistAccount("+Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
     CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

     if(CarrySum > 0)
       if( not FD.OpenAccount("-КорЭПС_%, ц/б", null, null, GetFIRoleByPortfolio(comm.SrcPortfolio), accNew, comm.CommDate) )
          return 1;
       end;

       if(not ПроводкаПоКатегориямУчета( FD, 
                                         accNew, accOld,  
                                         comm.CommDate,               /* Дата */
                                         1,                           /* Глава */
                                         accOld.rec.Code_Currency,    /* Валюта */
                                         CarrySum,                    /* Сумма */
                                         d,                           /* Документ */
                                         INPCARRY,                    /* Result_Carry */
                                         " 1",                        /* Kind_Oper */
                                         comm.CommCode,               /* Numb_Document */
                                         "Списание корректировок"     /* Ground */
                                        ))
           return 1;
       end;
     end;
  end;

  if( FD.IsExistAccount("-Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
     CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

     if(CarrySum > 0)
       if( not FD.OpenAccount("+КорЭПС_%, ц/б", null, null, GetFIRoleByPortfolio(comm.SrcPortfolio), accNew, comm.CommDate) )
          return 1;
       end;

       if(not ПроводкаПоКатегориямУчета( FD, 
                                         accOld, accNew, 
                                         comm.CommDate,               /* Дата */
                                         1,                           /* Глава */
                                         accOld.rec.Code_Currency,    /* Валюта */
                                         CarrySum,                    /* Сумма */
                                         d,                           /* Документ */
                                         INPCARRY,                    /* Result_Carry */
                                         " 1",                        /* Kind_Oper */
                                         comm.CommCode,               /* Numb_Document */
                                         "Списание корректировок"     /* Ground */
                                        ))
           return 1;
       end;
     end;
  end;

  if((comm.SrcPortfolio == KINDPORT_SSPU) or (comm.SrcPortfolio == KINDPORT_SSSD))
    if(comm.SrcPortfolio == KINDPORT_SSPU)
      CatOverOldAcc = "-Переоценка, ц/б ССПУ_ЦБ";
    else
      CatOverOldAcc = IIF(ПарностьСчетовПереоценки(), "-Переоценка, ц/б СССД_ЦБ", "-Переоценка, ц/б");
    end;
    if( FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
       CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
       if(CarrySum > 0)
         CatCode = IIF(comm.SrcPortfolio == KINDPORT_SSPU, "-МаржаП, ц/б", "-ПО ДК 2014");

         if(not ПроводкаПоКатегориямУчета( FD, 
                                           accOld, CatCode, 
                                           comm.CommDate,               /* Дата */
                                           1,                           /* Глава */
                                           accOld.rec.Code_Currency,    /* Валюта */
                                           CarrySum,                    /* Сумма */
                                           d,                           /* Документ */
                                           INPCARRY,                    /* Result_Carry */
                                           " 1",                        /* Kind_Oper */
                                           comm.CommCode,               /* Numb_Document */
                                           "Списание переоценки",       /* Ground */
                                           null,
                                           null,
                                           GetFIRoleByPortfolio(comm.DestPortofolio)
                                          ))
             return 1;
         end;
       end;
    end;

    if(comm.SrcPortfolio == KINDPORT_SSPU)
      CatOverOldAcc = "+Переоценка, ц/б ССПУ_ЦБ";
    else
      CatOverOldAcc = IIF(ПарностьСчетовПереоценки(), "+Переоценка, ц/б СССД_ЦБ", "+Переоценка, ц/б");
    end;
    if( FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      if(CarrySum > 0)
        CatCode = IIF(comm.SrcPortfolio == KINDPORT_SSPU, "+МаржаП, ц/б", "+ПО ДК 2014");

        if(not ПроводкаПоКатегориямУчета( FD, 
                                          CatCode, accOld,
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание переоценки",       /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;


    if(comm.SrcPortfolio == KINDPORT_SSSD)
      if( FD.IsExistAccount("-ПО ДК 2014", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
         CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

         if(CarrySum > 0)
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             "-Маржа, ц/б", accOld,  
                                             comm.CommDate,               /* Дата */
                                             1,                           /* Глава */
                                             accOld.rec.Code_Currency,    /* Валюта */
                                             CarrySum,                    /* Сумма */
                                             d,                           /* Документ */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             comm.CommCode,               /* Numb_Document */
                                             "Списание переоценки",       /* Ground */
                                             null,
                                             GetFIRoleByPortfolio(comm.SrcPortfolio)
                                            ))
               return 1;
           end;
         end;
      end;

      if( FD.IsExistAccount("+ПО ДК 2014", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
         CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

         if(CarrySum > 0)
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             accOld, "+Маржа, ц/б", 
                                             comm.CommDate,               /* Дата */
                                             1,                           /* Глава */
                                             accOld.rec.Code_Currency,    /* Валюта */
                                             CarrySum,                    /* Сумма */
                                             d,                           /* Документ */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             comm.CommCode,               /* Numb_Document */
                                             "Списание переоценки",       /* Ground */
                                             null,
                                             null,
                                             GetFIRoleByPortfolio(comm.SrcPortfolio)
                                            ))
               return 1;
           end;
         end;
      end;
    end;
  end;

  
  if(comm.SrcPortfolio == KINDPORT_SSSD)

    if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "+РС,ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание резерва",          /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "+РС,ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание резерва",          /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio, false, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "-КорОР_ЦБ", accOld,   
                                          comm.CommDate,                /* Дата */
                                          1,                            /* Глава */
                                          accOld.rec.Code_Currency,     /* Валюта */
                                          CarrySum,                     /* Сумма */
                                          d,                            /* Документ */
                                          INPCARRY,                     /* Result_Carry */
                                          " 1",                         /* Kind_Oper */
                                          comm.CommCode,                /* Numb_Document */
                                          "Списание оценочного резерва",/* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "+КорОР_ЦБ", 
                                          comm.CommDate,                /* Дата */
                                          1,                            /* Глава */
                                          accOld.rec.Code_Currency,     /* Валюта */
                                          CarrySum,                     /* Сумма */
                                          d,                            /* Документ */
                                          INPCARRY,                     /* Result_Carry */
                                          " 1",                         /* Kind_Oper */
                                          comm.CommCode,                /* Numb_Document */
                                          "Списание оценочного резерва",/* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;
  elif(comm.SrcPortfolio == KINDPORT_ASCB)
    if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "+РС,ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос резерва",           /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));
      
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "+РС,ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос резерва",          /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio, false, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "-КорОР_ЦБ", accOld,   
                                          comm.CommDate,                /* Дата */
                                          1,                            /* Глава */
                                          accOld.rec.Code_Currency,     /* Валюта */
                                          CarrySum,                     /* Сумма */
                                          d,                            /* Документ */
                                          INPCARRY,                     /* Result_Carry */
                                          " 1",                         /* Kind_Oper */
                                          comm.CommCode,                /* Numb_Document */
                                          "Перенос оценочного резерва", /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
      CarrySum = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOld, "+КорОР_ЦБ", 
                                          comm.CommDate,                /* Дата */
                                          1,                            /* Глава */
                                          accOld.rec.Code_Currency,     /* Валюта */
                                          CarrySum,                     /* Сумма */
                                          d,                            /* Документ */
                                          INPCARRY,                     /* Result_Carry */
                                          " 1",                         /* Kind_Oper */
                                          comm.CommCode,                /* Numb_Document */
                                          "Перенос оценочного резерва",/* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;
  end;

  return 0;
END;

PRIVATE MACRO ВыполнитьПеревод(FD, d, comm, opid)
  var RestBonusSum = $0, CarrySum = $0, NKDSum = $0, InterestIncomeSum = $0, DiscountIncomeSum = $0, OverAmountSum = $0, CorrSum = $0;
  var BegBonusSumOld = $0, BegBonusSumNew = $0, ReservSum = $0, IncomeReservSum = $0, CorrEstReserv = $0;
  var OldBalanceCostSum = $0, NewBalanceCostSum = $0, CostBuyNatSum = $0;
  var WrtOverAmountSum = $0;
  var CarryBonus = $0;
  var DataSet, query, cmd;
  var Rest = $0;
  var accReservOld = TRecHandler("account.dbt");
  var accReservNew = TRecHandler("account.dbt");
  var accOverOld = TRecHandler("account.dbt");
  var accCorrOld = TRecHandler("account.dbt");
  var accCorrNew = TRecHandler("account.dbt");
  var accOld     = TRecHandler("account.dbt");
  var CatOverOldAcc = "", CatOverNewAcc = "", CatCode = "";
  var FiRole;
  var SaleID = 0;
  var FD_Deal = NULL;
  
  query =   " select t_SumID "
          + "   from dpmwrtsum_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_Buy_Sale = " + PM_WRITEOFF_SUM_SALE
          + "    and t_PartNum = 0 ";

  cmd = DL_RSDCommand(query);
  
  cmd.AddParam(comm.DocKind); 
  cmd.AddParam(comm.DocumentID);

  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
     SaleID = DataSet.SumID;
  else
     SaleID = 0; //Такое может быть, если есть только лоты БПП - по списание не проводится, а меняются сами лоты
  end;

  if(SaleID > 0)
    query =   " select NVL(SUM(t_CostBuy), 0) as SumCost, "
            + "        NVL(SUM(t_BegBonusChange), 0) as SumBegBonusOld,  "
            + "        NVL(SUM(t_BegBonusChange - t_BonusBuy), 0) as SumRestBonus,  "
            + "        NVL(SUM(t_CostPFIBuy), 0) as SumCostPFI, "
            + "        NVL(SUM(t_NKDBuyAmount), 0) as SumNKDAmount, "
            + "        NVL(SUM(t_InterestIncomeBuy), 0) as SumInterestIncome, "
            + "        NVL(SUM(t_DiscountIncomeBuy), 0) as SumDiscountIncome, "
            + "        NVL(SUM(t_CorrValueChange + t_CorrIntToEIRChange), 0) as SumCorr, "
            + "        NVL(SUM(t_ReservChange), 0) as SumReserv, "
            + "        NVL(SUM(t_IncomeReservChange), 0) as SumIncomeReserv, "
            + "        NVL(SUM(t_EstReservChange + t_CorrEstReservChange), 0) as SumCorrEstReserv, "
            + "        NVL(SUM(t_BalanceCostBuy), 0) as SumOldBalanceCost, "
            + "        NVL(SUM(t_OverChange), 0) as SumWrtOverAmount, "
            + "        NVL(SUM(t_CostBuyNat), 0) as SumCostBuyNat"
            + "   from dpmwrtlnk_dbt "
            + "  where t_SaleID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(SaleID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      RestBonusSum      = money(DataSet.SumRestBonus);
      CarrySum          = money(DataSet.SumCost - RestBonusSum + DataSet.SumCostPFI);
      NKDSum            = money(DataSet.SumNKDAmount);
      InterestIncomeSum = money(DataSet.SumInterestIncome);
      DiscountIncomeSum = money(DataSet.SumDiscountIncome);
      CorrSum           = money(DataSet.SumCorr);
      BegBonusSumOld    = money(DataSet.SumBegBonusOld);
      ReservSum         = money(DataSet.SumReserv);
      IncomeReservSum   = money(DataSet.SumIncomeReserv);
      CorrEstReserv     = money(DataSet.SumCorrEstReserv);
      OldBalanceCostSum = money(DataSet.SumOldBalanceCost);
      WrtOverAmountSum  = money(DataSet.SumWrtOverAmount);
      CostBuyNatSum     = money(DataSet.SumCostBuyNat);
                    
      if(not ОтдельныйУчетУплНКД())
        CarrySum = CarrySum + NKDSum;
      end;
    end;
  end;

  query =   " select NVL(SUM(t_BalanceCost), 0) as SumNewBalanceCost, "
          + "        NVL(SUM(t_BegBonus), 0) as SumNewBegBonus "
          + "   from dpmwrtsum_dbt "
          + "  where t_DocKind  = ? "
          + "    and t_DocID    = ? "
          + "    and t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY
          + "    and t_State    = " + PM_WRTSUM_FORM;

  cmd = DL_RSDCommand(query);

  cmd.AddParam(comm.DocKind); 
  cmd.AddParam(comm.DocumentID);

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    BegBonusSumNew = money(DataSet.SumNewBegBonus);
    NewBalanceCostSum = money(DataSet.SumNewBalanceCost);
  end;

  ///////////////////////////////////
  //Общие проводки для всех портфелей
  ///////////////////////////////////
  if(CarrySum > 0)
    var AcCurSec = УЧЕТ_ВАЛЮТНЫХ_ДОЛЕВЫХ_ЦБ();
    var SumEquivalentCarry = null;

    if((AcCurSec != 0) and (not FI_IsBond(comm.FIID)) and (FD.FaceFIID() != NATCUR))
      SumEquivalentCarry = CostBuyNatSum;
    end;
      
    if(not ПроводкаПоКатегориямУчета( FD, 
                                      "Наш портфель ц/б", "Наш портфель ц/б", 
                                      comm.CommDate,               /* Дата */
                                      1,                           /* Глава */
                                      FD.FaceFIID(),               /* Валюта */
                                      CarrySum,                    /* Сумма */
                                      d,                           /* Документ */
                                      INPCARRY,                    /* Result_Carry */
                                      " 1",                        /* Kind_Oper */
                                      comm.CommCode,               /* Numb_Document */
                                      "Перемещение б/ст. в целевой портфель", /* Ground */
                                      null, 
                                      GetFIRoleByPortfolio(comm.DestPortofolio), 
                                      GetFIRoleByPortfolio(comm.SrcPortfolio),
                                      null, null,
                                      null,null,null,null,null,null,
                                      null,null,null,null,null,null,
                                      SumEquivalentCarry, null, null
                                     ))
        return 1;
    end;
  end;

  if((ОтдельныйУчетУплНКД()) and (NKDSum > 0))
    if(not ПроводкаПоКатегориямУчета( FD, 
                                      "Уплаченный НКД", "Уплаченный НКД", 
                                      comm.CommDate,               /* Дата */
                                      1,                           /* Глава */
                                      FD.FaceFIID(),               /* Валюта */
                                      NKDSum,                      /* Сумма */
                                      d,                           /* Документ */
                                      INPCARRY,                    /* Result_Carry */
                                      " 1",                        /* Kind_Oper */
                                      comm.CommCode,               /* Numb_Document */
                                      "Перевод НКД",               /* Ground */
                                      null, 
                                      GetFIRoleByPortfolio(comm.DestPortofolio), 
                                      GetFIRoleByPortfolio(comm.SrcPortfolio)
                                     ))
        return 1;
    end;
  end;

  if(InterestIncomeSum > 0)
    if(not ПроводкаПоКатегориямУчета( FD, 
                                      "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б", 
                                      comm.CommDate,               /* Дата */
                                      1,                           /* Глава */
                                      FD.FaceFIID(),               /* Валюта */
                                      InterestIncomeSum,           /* Сумма */
                                      d,                           /* Документ */
                                      INPCARRY,                    /* Result_Carry */
                                      " 1",                        /* Kind_Oper */
                                      comm.CommCode,               /* Numb_Document */
                                      "Перевод начисленных процентов", /* Ground */
                                      null, 
                                      GetFIRoleByPortfolio(comm.DestPortofolio, false, true), 
                                      GetFIRoleByPortfolio(comm.SrcPortfolio, false, true)
                                     ))
        return 1;
    end;
  end;

  //стоимость БПП и проценты
  if(comm.Currency_Sum > 0)

    query =   " SELECT LOT.T_DEALID "
            + "  FROM V_SCWRTHISTEX A, DPMWRTSUM_DBT LOT "
            + " WHERE A.T_ID_OPERATION = ? "
            + "   AND A.T_ACTION       = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
            + "   AND A.T_STATE        = " + PM_WRTSUM_SALE_BPP
            + "   AND LOT.T_SUMID      = A.T_PARENT";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(opid);

    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

      if(ВедениеСчетовБПППоВыпуску() == true)
        CatCode = "Наш портфель ц/б";
      else
        CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
      end;

      if( FD_Deal.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, null, null, true), accOld, NULL, comm.CommDate) )
        Rest = abs(GetRestAccount(accOld.rec, comm.CommDate));
        if(Rest > 0)
          if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                            CatCode, accOld, 
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            accOld.rec.Code_Currency,    /* Валюта */
                                            Rest,                        /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перемещение б/ст. БПП", /* Ground */
                                            null, 
                                            GetFIRoleByPortfolio(comm.DestPortofolio, null, null, true) 
                                           ))
              return 1;
          end;
        end;
      end;

      if(ВедениеСчетовБПППоВыпуску() == true)
        CatCode = "Уплаченный НКД";
      else
        CatCode = IIF(IsBasket(FD_Deal.Group), "Уплач. НКД, Корзина БПП", "Уплаченный НКД, БПП");
      end;

      if( FD_Deal.IsExistAccount(CatCode, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, null, null, true), accOld, NULL, comm.CommDate) )
        Rest = abs(GetRestAccount(accOld.rec, comm.CommDate));
        if(Rest > 0)
          if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                            CatCode, accOld, 
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            accOld.rec.Code_Currency,    /* Валюта */
                                            Rest,                        /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перевод НКД БПП", /* Ground */
                                            null, 
                                            GetFIRoleByPortfolio(comm.DestPortofolio, null, null, true) 
                                           ))
              return 1;
          end;
        end;
      end;
    end;

    if( FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true, true), accOld, NULL, comm.CommDate) )
      Rest = abs(GetRestAccount(accOld.rec, comm.CommDate));
      if(Rest > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "Начисл.ПДД, ц/б", accOld, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          accOld.rec.Code_Currency,    /* Валюта */
                                          Rest,                        /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перевод начисленных процентов БПП", /* Ground */
                                          null, 
                                          GetFIRoleByPortfolio(comm.DestPortofolio, false, true, true) 
                                         ))
            return 1;
        end;
      end;
    end;
  end;

  if(DiscountIncomeSum > 0)
    CatCode = "";
    if((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_ASCB))
      CatCode = "Наш портфель ц/б";
      FiRole  = GetFIRoleByPortfolio(comm.DestPortofolio);

    elif(((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSPU)) or
         ((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSSD)) or
         ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_ASCB)) or
         ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_SSPU)) or
         ((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_SSSD))
        )  
      CatCode = "Начисл.ПДД, ц/б";
      FiRole  = GetFIRoleByPortfolio(comm.DestPortofolio, true);
    end;

    if(CatCode != "")
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        CatCode, "Начисл.ПДД, ц/б", 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        FD.FaceFIID(),               /* Валюта */
                                        DiscountIncomeSum,           /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перевод начисленного дисконта", /* Ground */
                                        null, 
                                        FiRole, 
                                        GetFIRoleByPortfolio(comm.SrcPortfolio, true)
                                       ))
          return 1;
      end;
    end;
  end;

  if(comm.Currency_Sum > 0) //Дисконт БПП
    if( FD.IsExistAccount("Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, true, null, true), accOld, NULL, comm.CommDate) )
      Rest = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(Rest > 0)

        if((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_ASCB))
          //посделочные проводки

          query =   " SELECT LOT.T_DEALID, B.T_DISCOUNTINCOME "
                  + "  FROM V_SCWRTHISTEX A, V_SCWRTHISTEX B, DPMWRTSUM_DBT LOT "
                  + " WHERE A.T_ID_OPERATION   = ? "
                  + "   AND A.T_ACTION         = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
                  + "   AND A.T_STATE          = " + PM_WRTSUM_SALE_BPP
                  + "   AND LOT.T_SUMID        = A.T_PARENT"
                  + "   AND B.T_SUMID          = A.T_SUMID "
                  + "   AND B.T_INSTANCE       = A.T_INSTANCE - 1"
                  + "   AND B.T_DISCOUNTINCOME > 0 ";

          cmd = DL_RSDCommand(query);

          cmd.AddParam(opid);

          DataSet = cmd.Execute();
          while(DataSet.moveNext())
            FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

            if(ВедениеСчетовБПППоВыпуску() == true)
              CatCode = "Наш портфель ц/б";
            else
              CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
            end;

            if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                              CatCode, accOld, 
                                              comm.CommDate,               /* Дата */
                                              1,                           /* Глава */
                                              FD_Deal.FaceFIID(),          /* Валюта */
                                              DataSet.DiscountIncome,      /* Сумма */
                                              d,                           /* Документ */
                                              INPCARRY,                    /* Result_Carry */
                                              " 1",                        /* Kind_Oper */
                                              comm.CommCode,               /* Numb_Document */
                                              "Перевод начисленного дисконта БПП", /* Ground */
                                              null, 
                                              GetFIRoleByPortfolio(comm.DestPortofolio, true, null, true) 
                                             ))
                return 1;
            end;
          end;

        elif(((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSPU)) or
             ((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSSD)) or
             ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_ASCB)) or
             ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_SSPU)) or
             ((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_SSSD))
            )
          //проводка на остаток
          if(not ПроводкаПоКатегориямУчета( FD, 
                                            "Начисл.ПДД, ц/б", accOld, 
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            accOld.rec.Code_Currency,    /* Валюта */
                                            Rest,                        /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перевод начисленного дисконта БПП", /* Ground */
                                            null, 
                                            GetFIRoleByPortfolio(comm.DestPortofolio, true, null, true) 
                                           ))
              return 1;
          end;
        end;
      end;
    end;
  end;

  //Премия
  if(RestBonusSum > 0)
    CatCode = "";
    if((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_ASCB))
      CatCode = "Наш портфель ц/б";
      FiRole  = GetFIRoleByPortfolio(comm.DestPortofolio);

    elif(((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSPU)) or
         ((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSSD)) or
         ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_ASCB)) or
         ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_SSPU)) or
         ((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_SSSD))
        )  
      CatCode = "Премия, ц/б";
      FiRole  = GetFIRoleByPortfolioBonus(comm.DestPortofolio);
    end;

    if(CatCode != "")
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        CatCode, "Премия, ц/б", 
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        FD.FaceFIID(),               /* Валюта */
                                        RestBonusSum,                /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Перевод остатка премии",    /* Ground */
                                        null, 
                                        FiRole, 
                                        GetFIRoleByPortfolioBonus(comm.SrcPortfolio)
                                       ))
          return 1;
      end;
    end;
  end;

  if(comm.Currency_Sum > 0) //Премия БПП
    if( FD.IsExistAccount("Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(comm.SrcPortfolio, true), accOld, NULL, comm.CommDate) )
      Rest = abs(GetRestAccount(accOld.rec, comm.CommDate));

      if(Rest > 0)
        if((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_ASCB))
          //посделочные проводки

          query =   " SELECT LOT.T_DEALID, B.T_BONUS "
                  + "  FROM V_SCWRTHISTEX A, V_SCWRTHISTEX B, DPMWRTSUM_DBT LOT "
                  + " WHERE A.T_ID_OPERATION = ? "
                  + "   AND A.T_ACTION       = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
                  + "   AND A.T_STATE        = " + PM_WRTSUM_SALE_BPP
                  + "   AND LOT.T_SUMID      = A.T_PARENT"
                  + "   AND B.T_SUMID        = A.T_SUMID "
                  + "   AND B.T_INSTANCE     = A.T_INSTANCE - 1"
                  + "   AND B.T_BONUS        > 0 ";

          cmd = DL_RSDCommand(query);

          cmd.AddParam(opid);

          DataSet = cmd.Execute();
          while(DataSet.moveNext())
            FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

            if(ВедениеСчетовБПППоВыпуску() == true)
              CatCode = "Наш портфель ц/б";
            else
              CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
            end;

            if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                              CatCode, accOld, 
                                              comm.CommDate,               /* Дата */
                                              1,                           /* Глава */
                                              FD_Deal.FaceFIID(),          /* Валюта */
                                              DataSet.Bonus,               /* Сумма */
                                              d,                           /* Документ */
                                              INPCARRY,                    /* Result_Carry */
                                              " 1",                        /* Kind_Oper */
                                              comm.CommCode,               /* Numb_Document */
                                              "Перевод остатка премии БПП", /* Ground */
                                              null, 
                                              GetFIRoleByPortfolio(comm.DestPortofolio, true, null, true) 
                                             ))
                return 1;
            end;
          end;

        elif(((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSPU)) or
             ((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSSD)) or
             ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_ASCB)) or
             ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_SSPU)) or
             ((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_SSSD))
            )  
          //проводка на остаток
          if(not ПроводкаПоКатегориямУчета( FD, 
                                            "Премия, ц/б", accOld, 
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            accOld.rec.Code_Currency,    /* Валюта */
                                            Rest,                        /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перевод остатка премии БПП", /* Ground */
                                            null, 
                                            GetFIRoleByPortfolioBonus(comm.DestPortofolio, true) 
                                           ))
              return 1;
          end;
        end;
      end;
    end;
  end;

  if( FD.IsExistAccount("+Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accCorrOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
     Rest = abs(GetRestAccount(accCorrOld.rec, comm.CommDate));

     if(Rest > 0)
       CarrySum = abs(CorrSum);
       if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
         CarrySum = Rest;
       end;

       if( not FD.OpenAccount("+Корректировка, ц/б", null, null, GetFIRoleByPortfolio(comm.DestPortofolio), accCorrNew, comm.CommDate, null, null, null, MC_PAIRACCMODE_MANUAL) )
          return 1;
       end;

       if(not ПроводкаПоКатегориямУчета( FD, 
                                         accCorrNew, accCorrOld,  
                                         comm.CommDate,               /* Дата */
                                         1,                           /* Глава */
                                         NATCUR,                      /* Валюта */
                                         CarrySum,                    /* Сумма */
                                         d,                           /* Документ */
                                         INPCARRY,                    /* Result_Carry */
                                         " 1",                        /* Kind_Oper */
                                         comm.CommCode,               /* Numb_Document */
                                         "Перенос корректировок"      /* Ground */
                                        ))
           return 1;
       end;
     end;
  end;

  if( FD.IsExistAccount("-Корректировка, ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accCorrOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
     Rest = abs(GetRestAccount(accCorrOld.rec, comm.CommDate));

     if(Rest > 0)
       CarrySum = abs(CorrSum);
       if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
         CarrySum = Rest;
       end;
       
       if( not FD.OpenAccount("-Корректировка, ц/б", null, null, GetFIRoleByPortfolio(comm.DestPortofolio), accCorrNew, comm.CommDate, null, null, null, MC_PAIRACCMODE_MANUAL) )
          return 1;
       end;

       if(not ПроводкаПоКатегориямУчета( FD, 
                                         accCorrOld, accCorrNew, 
                                         comm.CommDate,               /* Дата */
                                         1,                           /* Глава */
                                         NATCUR,                      /* Валюта */
                                         CarrySum,                    /* Сумма */
                                         d,                           /* Документ */
                                         INPCARRY,                    /* Result_Carry */
                                         " 1",                        /* Kind_Oper */
                                         comm.CommCode,               /* Numb_Document */
                                         "Перенос корректировок"      /* Ground */
                                        ))
           return 1;
       end;
     end;
  end;
  

  ///////////////////////////////////
  //Индивидуальные проводки для комбинаций портфелей
  ///////////////////////////////////

  //Переоценка

  if((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_ASCB))
    //Списание переоценки
    CatOverOldAcc = IIF(ПарностьСчетовПереоценки(), "-Переоценка, ц/б СССД_ЦБ", "-Переоценка, ц/б");
    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        CarrySum = abs(WrtOverAmountSum);
        if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
          CarrySum = Rest;
        end;
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOverOld, "-ПО ДК 2014",  
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание переоценки",       /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    CatOverOldAcc = IIF(ПарностьСчетовПереоценки(), "+Переоценка, ц/б СССД_ЦБ", "+Переоценка, ц/б");
    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        CarrySum = abs(WrtOverAmountSum);
        if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
          CarrySum = Rest;
        end;
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "+ПО ДК 2014", accOverOld, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание переоценки",       /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;                                                     
  end;

  if((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_SSPU))
    //Перенос переоценки
    CatOverOldAcc = IIF(ПарностьСчетовПереоценки(), "-Переоценка, ц/б СССД_ЦБ", "-Переоценка, ц/б");
    CatOverNewAcc = "-Переоценка, ц/б ССПУ_ЦБ";

    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        CarrySum = abs(WrtOverAmountSum);
        if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
          CarrySum = Rest;
        end;

        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOverOld, CatOverNewAcc,  
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос переоценки",        /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;

        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "-Маржа, ц/б", "-ПО ДК 2014",  
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос переоценки",        /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio),
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    CatOverOldAcc = IIF(ПарностьСчетовПереоценки(), "+Переоценка, ц/б СССД_ЦБ", "+Переоценка, ц/б");
    CatOverNewAcc = "+Переоценка, ц/б ССПУ_ЦБ";

    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        CarrySum = abs(WrtOverAmountSum);
        if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
          CarrySum = Rest;
        end;

        if(not ПроводкаПоКатегориямУчета( FD, 
                                          CatOverNewAcc, accOverOld, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос переоценки",        /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;

        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "+ПО ДК 2014", "+Маржа, ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос переоценки",        /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio),
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;                                                     
  end;
  
  if((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_ASCB))
    //перенос переоценки 
    
    CatOverOldAcc = "+Переоценка, ц/б ССПУ_ЦБ";

    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        if(WrtOverAmountSum != 0)
          if(not ПроводкаПоКатегориямУчета( FD, 
                                            "Наш портфель ц/б", accOverOld,
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            NATCUR,                      /* Валюта */
                                            abs(WrtOverAmountSum),       /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перенос переоценки",        /* Ground */
                                            null,
                                            GetFIRoleByPortfolio(comm.DestPortofolio)
                                           ))
              return 1;
          end;
        end;

        if(comm.Currency_Sum > 0) //Для БПП
          //посделочные проводки
          query =   " SELECT LOT.T_DEALID, B.T_OVERAMOUNT AS OverAmountSum "
                  + "  FROM V_SCWRTHISTEX A, V_SCWRTHISTEX B, DPMWRTSUM_DBT LOT "
                  + " WHERE A.T_ID_OPERATION = ? "
                  + "   AND A.T_ACTION       = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
                  + "   AND A.T_STATE        = " + PM_WRTSUM_SALE_BPP
                  + "   AND LOT.T_SUMID      = A.T_PARENT"
                  + "   AND B.T_SUMID        = A.T_SUMID "
                  + "   AND B.T_INSTANCE     = A.T_INSTANCE - 1";

          cmd = DL_RSDCommand(query);

          cmd.AddParam(opid);

          DataSet = cmd.Execute();
          while(DataSet.moveNext())
            FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

            if(DataSet.OverAmountSum != 0)
              if(ВедениеСчетовБПППоВыпуску() == true)
                CatCode = "Наш портфель ц/б";
              else
                CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
              end;

              if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                                CatCode, accOverOld,   
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                NATCUR,                      /* Валюта */
                                                abs(DataSet.OverAmountSum),  /* Сумма */
                                                d,                           /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос переоценки БПП",    /* Ground */
                                                null,
                                                GetFIRoleByPortfolio(comm.DestPortofolio, false, false, true)
                                               ))
                  return 1;
              end;
            end;

          end;
        end;
      end;
    end;


    CatOverOldAcc = "-Переоценка, ц/б ССПУ_ЦБ";

    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        if(WrtOverAmountSum != 0)
          if(not ПроводкаПоКатегориямУчета( FD, 
                                            accOverOld, "Наш портфель ц/б",  
                                            comm.CommDate,               /* Дата */
                                            1,                           /* Глава */
                                            NATCUR,                      /* Валюта */
                                            abs(WrtOverAmountSum),       /* Сумма */
                                            d,                           /* Документ */
                                            INPCARRY,                    /* Result_Carry */
                                            " 1",                        /* Kind_Oper */
                                            comm.CommCode,               /* Numb_Document */
                                            "Перенос переоценки",        /* Ground */
                                            null,
                                            null,
                                            GetFIRoleByPortfolio(comm.DestPortofolio)
                                           ))
              return 1;
          end;
        end;

        if(comm.Currency_Sum > 0) //Для БПП
          //посделочные проводки
          query =   " SELECT LOT.T_DEALID, B.T_OVERAMOUNT AS OverAmountSum "
                  + "  FROM V_SCWRTHISTEX A, V_SCWRTHISTEX B, DPMWRTSUM_DBT LOT "
                  + " WHERE A.T_ID_OPERATION = ? "
                  + "   AND A.T_ACTION       = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
                  + "   AND A.T_STATE        = " + PM_WRTSUM_SALE_BPP
                  + "   AND LOT.T_SUMID      = A.T_PARENT"
                  + "   AND B.T_SUMID        = A.T_SUMID "
                  + "   AND B.T_INSTANCE     = A.T_INSTANCE - 1";

          cmd = DL_RSDCommand(query);

          cmd.AddParam(opid);

          DataSet = cmd.Execute();
          while(DataSet.moveNext())
            FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

            if(DataSet.OverAmountSum != 0)
              if(ВедениеСчетовБПППоВыпуску() == true)
                CatCode = "Наш портфель ц/б";
              else
                CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
              end;

              if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                                accOverOld, CatCode,  
                                                comm.CommDate,               /* Дата */
                                                1,                           /* Глава */
                                                NATCUR,                      /* Валюта */
                                                abs(DataSet.OverAmountSum),  /* Сумма */
                                                d,                           /* Документ */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                comm.CommCode,               /* Numb_Document */
                                                "Перенос переоценки БПП",    /* Ground */
                                                null,
                                                null,
                                                GetFIRoleByPortfolio(comm.DestPortofolio, false, false, true)
                                               ))
                  return 1;
              end;
            end;

          end;
        end;
      end;
    end;
  end;

  if((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_SSSD))
    //Перенос переоценки
    CatOverOldAcc = "-Переоценка, ц/б ССПУ_ЦБ";
    CatOverNewAcc = IIF(ПарностьСчетовПереоценки(), "-Переоценка, ц/б СССД_ЦБ", "-Переоценка, ц/б");

    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        CarrySum = abs(WrtOverAmountSum);
        if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
          CarrySum = Rest;
        end;
        
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accOverOld, CatOverNewAcc,  
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос переоценки",        /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;

    CatOverOldAcc = "+Переоценка, ц/б ССПУ_ЦБ";
    CatOverNewAcc = IIF(ПарностьСчетовПереоценки(), "+Переоценка, ц/б СССД_ЦБ", "+Переоценка, ц/б");

    if(FD.IsExistAccount(CatOverOldAcc, null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accOverOld, MC_PAIRACCMODE_MANUAL, comm.CommDate))
      Rest = abs(GetRestAccount(accOverOld.rec, comm.CommDate));
      if(Rest > 0)
        CarrySum = abs(WrtOverAmountSum);
        if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
          CarrySum = Rest;
        end;
        
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          CatOverNewAcc, accOverOld, 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос переоценки",        /* Ground */
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;                                                     
  end;

  //если из дисконта возникла премия
  if((comm.SrcPortfolio == KINDPORT_SSPU) and (comm.DestPortofolio == KINDPORT_ASCB))
    
    //не БПП
    CarryBonus = BegBonusSumNew - BegBonusSumOld;
    if(CarryBonus > 0)
      if(not ПроводкаПоКатегориямУчета( FD, 
                                        "Премия, ц/б", "Наш портфель ц/б",  
                                        comm.CommDate,               /* Дата */
                                        1,                           /* Глава */
                                        FD.FaceFIID(),               /* Валюта */
                                        abs(CarryBonus),             /* Сумма */
                                        d,                           /* Документ */
                                        INPCARRY,                    /* Result_Carry */
                                        " 1",                        /* Kind_Oper */
                                        comm.CommCode,               /* Numb_Document */
                                        "Отражение премии",          /* Ground */
                                        null, 
                                        GetFIRoleByPortfolioBonus(comm.DestPortofolio),
                                        GetFIRoleByPortfolio(comm.DestPortofolio)
                                       ))
          return 1;
      end;
    end;

    //БПП
    query =   " SELECT LOT.T_DEALID, (A.T_BEGBONUS - B.T_BEGBONUS) as ChangeBegBonus "
            + "  FROM V_SCWRTHISTEX A, V_SCWRTHISTEX B, DPMWRTSUM_DBT LOT "
            + " WHERE A.T_ID_OPERATION = ? "
            + "   AND A.T_ACTION       = " + PM_WRTSUM_UPDTMODE_PORTFOLIO
            + "   AND A.T_STATE        = " + PM_WRTSUM_SALE_BPP
            + "   AND A.T_BEGBONUS     > 0 "
            + "   AND LOT.T_SUMID      = A.T_PARENT"
            + "   AND B.T_SUMID        = A.T_SUMID "
            + "   AND B.T_INSTANCE     = A.T_INSTANCE - 1";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(opid);

    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      if(DataSet.ChangeBegBonus > 0)
        FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );

        if(ВедениеСчетовБПППоВыпуску() == true)
          CatCode = "Наш портфель ц/б";
        else
          CatCode = IIF(IsBasket(FD_Deal.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
        end;

        if(not ПроводкаПоКатегориямУчета( FD_Deal, 
                                          "Премия, ц/б", CatCode,  
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          DataSet.ChangeBegBonus,      /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Отражение премии БПП",      /* Ground */
                                          null,
                                          GetFIRoleByPortfolioBonus(comm.DestPortofolio, true),
                                          GetFIRoleByPortfolio(comm.DestPortofolio, false, false, true)
                                         ))
            return 1;
        end;
      end;
    end;
  end;

  //Резервы
  if(((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSSD)) or
     ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_ASCB))
    )
    
    if(FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accReservOld, NULL, comm.CommDate))
      CarrySum = ReservSum;
      if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
        CarrySum = abs(GetRestAccount(accReservOld.rec, comm.CommDate));
      end;
      
      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accReservOld, "Резерв ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос резерва",           /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio)
                                         ))
            return 1;
        end;
      end;
    end;


    if(FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true), accReservOld, NULL, comm.CommDate))
      CarrySum = IncomeReservSum;
      if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
        CarrySum = abs(GetRestAccount(accReservOld.rec, comm.CommDate));
      end;

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accReservOld, "Резерв ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Перенос резерва",           /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.DestPortofolio, false, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accReservOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
       Rest = abs(GetRestAccount(accReservOld.rec, comm.CommDate));

       if(Rest > 0)
         CarrySum = abs(CorrEstReserv);
         if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
           CarrySum = Rest;
         end;

         if(CarrySum > 0)
           if( not FD.OpenAccount("+Кор_Резерв, ЦБ", null, null, GetFIRoleByPortfolio(comm.DestPortofolio), accReservNew, comm.CommDate, null, null, null, MC_PAIRACCMODE_MANUAL) )
              return 1;
           end;
         
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             accReservNew, accReservOld,   
                                             comm.CommDate,                /* Дата */
                                             1,                            /* Глава */
                                             NATCUR,                       /* Валюта */
                                             CarrySum,                     /* Сумма */
                                             d,                            /* Документ */
                                             INPCARRY,                     /* Result_Carry */
                                             " 1",                         /* Kind_Oper */
                                             comm.CommCode,                /* Numb_Document */
                                             "Перенос оценочного резерва"  /* Ground */
                                            ))
               return 1;
           end;
         end;
       end;
    end;
    
    if( FD.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accReservOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
       Rest = abs(GetRestAccount(accReservOld.rec, comm.CommDate));
       
       if(Rest > 0)
         CarrySum = abs(CorrEstReserv);
         if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
           CarrySum = Rest;
         end;
         
         if(CarrySum > 0)
           if( not FD.OpenAccount("-Кор_Резерв, ЦБ", null, null, GetFIRoleByPortfolio(comm.DestPortofolio), accReservNew, comm.CommDate, null, null, null, MC_PAIRACCMODE_MANUAL) )
              return 1;
           end;
           
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             accReservOld, accReservNew, 
                                             comm.CommDate,                /* Дата */
                                             1,                            /* Глава */
                                             NATCUR,                       /* Валюта */
                                             CarrySum,                     /* Сумма */
                                             d,                            /* Документ */
                                             INPCARRY,                     /* Result_Carry */
                                             " 1",                         /* Kind_Oper */
                                             comm.CommCode,                /* Numb_Document */
                                             "Перенос оценочного резерва"  /* Ground */
                                            ))
               return 1;
           end;
         end;
       end;  
    end;
  
  elif(((comm.SrcPortfolio == KINDPORT_ASCB) and (comm.DestPortofolio == KINDPORT_SSPU)) or
       ((comm.SrcPortfolio == KINDPORT_SSSD) and (comm.DestPortofolio == KINDPORT_SSPU))
      )

    if(FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accReservOld, NULL, comm.CommDate))
      CarrySum = ReservSum;
      if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
        CarrySum = abs(GetRestAccount(accReservOld.rec, comm.CommDate));
      end;

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accReservOld, "+РС,ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание резерва",          /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio)
                                         ))
            return 1;
        end;
      end;
    end;

    if(FD.IsExistAccount("Резерв ц/б", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio, false, true), accReservOld, NULL, comm.CommDate))
      CarrySum = IncomeReservSum;
      if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
        CarrySum = abs(GetRestAccount(accReservOld.rec, comm.CommDate));
      end;

      if(CarrySum > 0)
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          accReservOld, "+РС,ц/б", 
                                          comm.CommDate,               /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          CarrySum,                    /* Сумма */
                                          d,                           /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          comm.CommCode,               /* Numb_Document */
                                          "Списание резерва",          /* Ground */
                                          null,
                                          null,
                                          GetFIRoleByPortfolio(comm.SrcPortfolio, false, true)
                                         ))
            return 1;
        end;
      end;
    end;

    if( FD.IsExistAccount("+Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accReservOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
       Rest = abs(GetRestAccount(accReservOld.rec, comm.CommDate));
       if(Rest > 0)
         CarrySum = abs(CorrEstReserv);
         if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
           CarrySum = Rest;
         end;

         if(CarrySum > 0)
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             "-КорОР_ЦБ", accReservOld,   
                                             comm.CommDate,                /* Дата */
                                             1,                            /* Глава */
                                             NATCUR,                       /* Валюта */
                                             CarrySum,                     /* Сумма */
                                             d,                            /* Документ */
                                             INPCARRY,                     /* Result_Carry */
                                             " 1",                         /* Kind_Oper */
                                             comm.CommCode,                /* Numb_Document */
                                             "Списание оценочного резерва",/* Ground */
                                             null,
                                             GetFIRoleByPortfolio(comm.SrcPortfolio)
                                            ))
               return 1;
           end;
         end;
       end;
    end;

    if( FD.IsExistAccount("-Кор_Резерв, ЦБ", null, true, GetFIRoleByPortfolio(comm.SrcPortfolio), accReservOld, MC_PAIRACCMODE_MANUAL, comm.CommDate) )
       Rest = abs(GetRestAccount(accReservOld.rec, comm.CommDate));
       if(Rest > 0)
         CarrySum = abs(CorrEstReserv);
         if(comm.Currency_Sum > 0) //Переводим в т.ч. и БПП, тогда проводка на остаток, т.к. в этом случае переводим всё
           CarrySum = Rest;
         end;

         if(CarrySum > 0)
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             accReservOld, "+КорОР_ЦБ", 
                                             comm.CommDate,                /* Дата */
                                             1,                            /* Глава */
                                             NATCUR,                       /* Валюта */
                                             CarrySum,                     /* Сумма */
                                             d,                            /* Документ */
                                             INPCARRY,                     /* Result_Carry */
                                             " 1",                         /* Kind_Oper */
                                             comm.CommCode,                /* Numb_Document */
                                             "Списание оценочного резерва",/* Ground */
                                             null,
                                             null,
                                             GetFIRoleByPortfolio(comm.SrcPortfolio)
                                            ))
               return 1;
           end;
         end;
       end;
    end;
  end;

  return 0;
END;


MACRO ExecuteStep( d, adr, dockind, opid, stepid )
  record comm (dl_comm);
  record avoir(avoiriss);
  record fi(fininstr);
  var FD = "", SaleID = -1;
  var err = 0;

  SetBuff( comm, adr );

  if(comm.OperSubKind > 0)
    msgbox("Исполнение данного вида операции больше не поддерживается");
    return 1;
  end;

  if( ПолучитьФинИн( comm.FIID, fi, avoir ) != 0 )
      MsgBox("Не найдена ценная бумага с FIID = " + string(comm.FIID) );
      return 1;
  end; 

  if( ПолучитьПервичныйДокументДляПеревода( comm, dl_comm_trans, FD ) == false )
     return 1;
  end;
 
  if(comm.DestPortofolio == KINDPORT_PROMISSORY) //Перевод в ПДО
    err = ВыполнитьПереводВ_ПДО(FD, d, comm, opid);
  elif(comm.DestPortofolio == KINDPORT_CONTR) //Перевод в ПКУ
    err = ВыполнитьПереводВ_ПКУ(FD, d, comm, opid);
  elif(comm.SrcPortfolio == KINDPORT_CONTR) //Перевод из ПКУ
    err = ВыполнитьПереводИз_ПКУ(FD, d, comm, opid);
  else //Прочие переводы
    err = ВыполнитьПеревод(FD, d, comm, opid);
  end;

  if(not err)
    if(SetOverRegistrValue(FD, FD.fininstr.rec.FIID, comm.CommDate) != 0)
      msgbox("Ошибка при сохранении сумм в регистре переоценки");
      return 1;
    end;
  end;

  return err;
END;
