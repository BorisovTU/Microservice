/*
 $Name: nptxret010.mac
 $Module: Ценные бумаги
 $Description: Операция обработки заявлений на возврат налога. Шаг инициализации
 */

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet;

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

macro ExecuteStep( doc, FDoc )
  var err = 0;
  var nptxop = TRecHandler("nptxop.dbt");
  var stateVal = 2;

  SetBuff( nptxop, FDoc );

  var cmd = DL_RSDCommand();

  var query = 
    " SELECT * "
   +"   FROM DUAL "
   +"  WHERE EXISTS "
   +"            (SELECT 1 "
   +"               FROM dnptxop_dbt "
   +"              WHERE T_STATUS IN ("+DLNPTXRETREQ_CHECKED+", "+DLNPTXRETREQ_PARTEXECUTED+") "
   +"                AND t_OperDate <= ? ";

  cmd.AddParam(nptxop.rec.OperDate);


  if(nptxop.rec.Client > 0)
    query = query + "AND T_CLIENT = ? ";
    cmd.AddParam(nptxop.rec.Client);
  end;

  query = query +"  AND T_DocKind = "+DL_RETREQ+")";
  
  var ds = cmd.execute(query);

  if( not ds.MoveNext() )
    MsgBox("Не найдено заявлений на возврат налога");
    stateVal = 3; //состояние для взятия налога "не выполнять"
  end;

  if( not InsertOprStatus(46422, stateVal)) //Установить ВН
    err = Error( "Ошибка при установке статуса вида \"Установить ВН\" операции" );        
  end;
  
  return err;
end;
