/*
$Name:         rtcpown010.mac 
$Module:       Ценные бумаги
$Description:  Операция погашения купона СЭБ. Шаг настройки операции
*/
import "spRetire.mac";

macro executeParamStep( kind_oper, BOf_kind, adr, ID_Operation, ID_Step )

  record  deal( dl_tick );
  file    fiw( fiwarnts );
  var     Group, FD, TaxDepositoryMode;

  SetBuff( deal, adr ); 
  FD = SPFirstDoc( deal, null, true );

  Group = SP_GetOperationGroup (deal); 
  TaxDepositoryMode = CheckTaxDepositoryMode();

  ClearRecord( fiw );
  fiw.IsPartial = UNSET_CHAR;
  fiw.FIID      = FD.dl_leg.rec.PFI;
  fiw.Number    = deal.Number_Coupon;

  if( GetEQ(fiw) AND ( ((TaxDepositoryMode == false) and (fiw.SPIsClosed == SET_CHAR)) or
                       ((TaxDepositoryMode == true)  and (fiw.IsClosed == SET_CHAR)) ) )
    MsgBox ("Купон уже погашен.");
    return 1;
  end;

  DefineOprDate( FD.GetKindDate(DATE_DEALDATE),        FD.DateArray[DATE_DEALDATE]   );
  DefineOprDate( FD.GetKindDate(DATE_DEALTRANSFER),    FD.DateArray[DATE_DEALTRANSFER]   );  // Дки (Дата переноса на счета "к исполнению")
  DefineOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), FD.DateArray[DATE_DEALSETAVOIRISS] ); // Дп (Дата погашения факт.)
  DefineOprDate( FD.GetKindDate(DATE_DEALPAY),         FD.DateArray[DATE_DEALPAY]  );        // До (Дата платежа)
  DefineOprDate( FD.GetKindDate(DATE_DEALEEND),        maxDate(FD.DateArray[DATE_DEALPAY], FD.DateArray[DATE_DEALSETAVOIRISS]));

  if( ИнициализироватьОперациюПогашения( FD ) != 0 )
     return 1;
  end;

  return 0;
end;

