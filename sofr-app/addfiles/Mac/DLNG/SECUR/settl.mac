/*
$Name:        settl.mac
$Module:      Ценные бумаги
$Description: Операция Расчеты на ОРЦБ. Общие функции.
*/
import "sp_car.mac", RsbDataSet, "cb_sql.mac";

PRIVATE VAR MoneySourceBase:Integer; // Источник средств в первоначальной операции, при создании (не при изменении на шаге)


PRIVATE MACRO ВыполнитьПереводСредствНаКлирСчетСКорСчета( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER ):BOOL

  var CTAccountBuf = TRecHandler("account.dbt" );
  var FiRole;

  GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);

  if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.comm.rec.DocKind, FD.comm.rec.DocumentID, FD.comm.rec.PartyID, FIID, CTAccountBuf) != 0)
    return false;
  end;

  if( not ПроводкаПоКатегориямУчета( FD, 
                                     "Клиринговый счет", CTAccountBuf,
                                     FD.comm.rec.CommDate, 
                                     1, 
                                     FIID, 
                                     Summa, 
                                     Doc,
                                     INPCARRY, 
                                     " 1", 
                                     FD.comm.rec.CommCode, 
                                     "Перевод средств на клиринговый счет с корсчета.",
                                     null, FiRole, null,
                                     FIID, CTAccountBuf.rec.Code_Currency 
                                   )
    )
     return false;
  end;

  if( not СохранитьСуммуКомиссии( FD.comm.rec.DocKind, FD.comm.rec.DocumentID, IIF(FIID == FD.comm.rec.Currency, DLSUM_KIND_DLCOMM_IN_CLIRINGACC_NATCUR, DLSUM_KIND_DLCOMM_IN_CLIRINGACC_CUR), 
                                  FD.comm.rec.CommDate, Summa, $0, FIID ) )
     return false;
  end; 
/*
  if( not ВУ_ВыполнитьПереводСредствНаБиржу(FD, Doc, Summa, FIID) )
     return false;
  end;
*/
  return true;
END;


PRIVATE MACRO GetSumFromLastRQ( TorgAccData:TRecHandler, FIID:INTEGER, Party:INTEGER, RqKind:INTEGER ):MONEY

   VAR sql, RS, Sum = $0;

   sql = DL_RSDCommand( " SELECT Lastrq.t_Amount " +
                        "   FROM ddlrq_dbt LastRq" +
                        "  WHERE Lastrq.t_ID = "+
                             "                 (SELECT max(rq.t_ID)"
                        "                         FROM ddlrq_dbt rq, doprstep_dbt step" +
                             "                   WHERE     rq.t_DocID   = ? " +
                             "                         AND rq.t_DocKind = ? " +
                             "                         AND rq.t_Type    = ? " +
                             "                         AND rq.t_Kind    = ? " +
                             "                         AND rq.t_FIID    = ? " +
                        "                              AND rq.t_Party          = ? " +
                        "                              AND STEP.T_ID_OPERATION = RQ.T_ID_OPERATION " +
                        "                              AND STEP.T_ID_STEP      = RQ.T_ID_STEP " +
                        "                              AND STEP.T_NUMBER_STEP  = 40 ) "/*В поле <Сумма> по умолчанию подставляется сумма по-следнего пополнения счёта на бирже, выполненного на шаге 40 <Пополне-ние торгового счета>. */
                      );

   sql.addParam( TorgAccData.rec.DocumentID );
   sql.addParam( TorgAccData.rec.DocKind );
   sql.addParam( DLRQ_TYPE_PAYMENT );
   sql.addParam( RqKind );
   sql.addParam( FIID );
   sql.addParam( Party );

   RS = sql.execute();
   if( RS.MoveNext() )
      Sum = SQL_ConvTypeSum( RS.Amount );
   end;

   return Sum;
END;

MACRO СуммаПоследнегоПополненияСчётаНаБирже( TorgAccData:TRecHandler, FIID:INTEGER ):MONEY
   return GetSumFromLastRq( TorgAccData, FIID, TorgAccData.rec.PartyID, DLRQ_KIND_COMMIT);
END;

/*делаем проводки на остаток Остаток счёта ДС Клиента, ВУ МУ = РЦ биржи/брокер*/
PRIVATE MACRO ВУ_ПереводСредствСКлирСчетаКлиента( FD:SPFirstDocDLCOMM, Doc:MEMADDR, FIID:INTEGER ):BOOL
  record DebAcc(account); 
  record KredAcc(account);
  var sql, DataSql, FD_Contr, KredAccRest = $0, ВидРО = 4, NumCarry = 0, cnt = 0;

  /*по всем счетам клиентов делаем перевод на счета банка*/
  sql = DL_RSDCommand( " select ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                                               " +
                       "   from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dsfcontr_dbt sfcontr                         " +
                       "  where ACCDOC.T_CHAPTER = ?                                                                   " +
                       "    and ACCDOC.T_CURRENCY = ?                                                                  " +
                       "    and ACCDOC.T_CATID = CATEG.T_ID                                                            " +
                       "    and CATEG.T_CODE   = ?                                                                     " +
                       "    and CATEG.T_LEVELTYPE = 1                                                                  " +
                       "    and ACCDOC.T_PLACE                 = ACCDOC.T_MARKETPLACEID                                " +
                       "    and ACCDOC.T_MARKETPLACEID         = ?                                                     " +
                       "    and ACCDOC.T_MARKETPLACEOFFICEID   = ?                                                     " +
                       "    and ACCDOC.T_CLIENTCONTRID > 0                                                             " +
                       "    and sfcontr.t_ID = ACCDOC.T_CLIENTCONTRID                                                  " +
                       "    and sfcontr.t_servkind = ?                                                                 " +
                       "    and sfcontr.t_DateBegin <= ?                                                               " +
                       "    and (sfcontr.t_DateClose >= ? or sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
                       " group by ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                                             "
                     );

   sql.addParam( 21 );
   sql.addParam( FIID );
   sql.addParam( "ДС Клиента, ВУ" );
   sql.addParam( FD.comm.rec.TraderID);
   sql.addParam( FD.comm.rec.PartyOfficeID);
   sql.addParam( PTSK_STOCKDL );
   sql.addParam( FD.comm.rec.CommDate );
   sql.addParam( FD.comm.rec.CommDate );

   cnt = sql.GetCount();

   if( cnt > 0 )
      DataSql = sql.execute();
      InitProgress( cnt, "Просмотр клиентов по сделкам на бирже ...", "Проводки по клиентам на остаток по счету" );

      while( DataSql.MoveNext() )

         ClearRecord( KredAcc );
         if( GetAccount(21, FIID, DataSql.Account, KredAcc, true) ) 

            /*берем остаток только если он отрицательный, т.к. счет активный*/
            KredAccRest = max(0,-GetRestAccount( KredAcc, GetDateAfterWorkDays(FD.comm.rec.CommDate, 0, FD.ПолучитьКалендСвязанный()) ));

            if( KredAccRest != 0 )
               FD_Contr = SPFirstDocContract( DL_STOCKCONTR, DataSql.CLIENTCONTRID );
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_FIID, FIID );

               ClearRecord( DebAcc );
               if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, FD.comm.rec.CommDate, null, FIID ) )
                  if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, null, null, DebAcc, FD.comm.rec.CommDate, FIID ) )
                     return false;
                  end;
               end;
/*
               if( not ПроводкаПоКатегориямВнутреннегоУчета( ВидРО,
                                                             FD,
                                                             Doc,
                                                             FD.comm.rec.CommDate,
                                                             FIID,
                                                             KredAccRest,
                                                             null, null, null, null,
                                                             DebAcc, KredAcc
                                                           )
                 )
                  return false;
               end;
*/
            end;
         end;

         UseProgress( NumCarry = NumCarry + 1 );
      end;

      RemProgress();
   end;

   return true;
END;

MACRO SC_GetSumIn( CommDate:date, FIID:INTEGER ):money
  var RetVal:money = $0.0;
  record Acc(account);
  var sql, DataSql;

  sql = DL_RSDCommand( " select accoun.T_ACCOUNT " +
                       "   from daccount_dbt accoun " +
                       "  where accoun.T_CHAPTER = 1 " +
                       "    and (accoun.T_BALANCE = '30601' or accoun.T_BALANCE = '30606') " +
                       "    and accoun.T_CODE_CURRENCY = ? " +
                       "    and accoun.T_OPEN_DATE <= ? " +
                       "    and (accoun.T_CLOSE_DATE >= ? or accoun.T_OPEN_CLOSE != 'X') "
                     );
   sql.addParam( FIID );
   sql.addParam( CommDate );
   sql.addParam( CommDate );

  DataSql = sql.execute();
  while( DataSql.MoveNext() )
     ClearRecord( Acc );
     if( GetAccount(1, FIID, DataSql.Account, Acc, true ) ) 
        /*берем остаток только если он положительный, т.к. счет пассивный*/
        RetVal = RetVal + max(0,GetRestAccount(Acc, GetDateAfterWorkDays(CommDate, -1)));
     end;
  end;

  return RetVal;
END;

/*делаем проводки на остаток Остаток счёта ДС Клиента, ВУ МУ = банк*/
PRIVATE MACRO ВУ_ПереводСредствНаКлирСчетКлиенту( FD:SPFirstDocDLCOMM, Doc:MEMADDR, FIID:INTEGER ):BOOL
  record DebAcc(account); 
  record KredAcc(account);
  var sql, DataSql, FD_Contr, KredAccRest = $0, ВидРО = 2, NumCarry = 0, cnt = 0;

  /*по всем счетам клиентов делаем перевод на счета биржи*/
  sql = DL_RSDCommand( " select ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                                             "+
                       "   from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dsfcontr_dbt sfcontr                       "+
                       "  where ACCDOC.T_CHAPTER = ?                                                                 "+
                       "    and ACCDOC.T_CURRENCY = ?                                                                "+
                       "    and ACCDOC.T_CATID = CATEG.T_ID                                                          "+
                       "    and CATEG.T_CODE   = ?                                                                   "+
                       "    and CATEG.T_LEVELTYPE = 1                                                                "+
                       "    and ACCDOC.T_PLACE   = ?                                                                 "+
                       "    and ACCDOC.T_CLIENTCONTRID > 0                                                           "+
                       "    and sfcontr.t_ID = ACCDOC.T_CLIENTCONTRID                                                "+
                       "    and sfcontr.t_servkind = ?                                                               "+
                       "    and sfcontr.t_DateBegin <= ? " +
                       "    and (sfcontr.t_DateClose >= ? or sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
                       " group by ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                                           "
                     );             
                  
   sql.addParam( 21 );
   sql.addParam( FIID );
   sql.addParam( "ДС Клиента, ВУ" );
   sql.addParam( {OurBank} );
   sql.addParam( PTSK_STOCKDL );

   sql.addParam( FD.comm.rec.CommDate );
   sql.addParam( FD.comm.rec.CommDate );

   cnt = sql.GetCount();

   if( cnt > 0 )
      DataSql = sql.execute();
      InitProgress( cnt, "Просмотр клиентов по сделкам на бирже ...", "Проводки по клиентам на остаток по счету" );
      
      while( DataSql.MoveNext() )

         ClearRecord( KredAcc );
         if( GetAccount( 21, FIID, DataSql.Account, KredAcc, true ) ) 

            /*берем остаток только если он отрицательный, т.к. счет активный*/
            KredAccRest = max(0,-GetRestAccount( KredAcc, GetDateAfterWorkDays(FD.comm.rec.CommDate, -1, FD.ПолучитьКалендСвязанный()) ));

            if( KredAccRest != 0 )
               FD_Contr = SPFirstDocContract( DL_STOCKCONTR, DataSql.CLIENTCONTRID );
              
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_PLACE, FD.comm.rec.TraderID );
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_PARTY, FD.comm.rec.PartyID );
              
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_MARKET_PLACE, FD.comm.rec.TraderID );
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE, FD.comm.rec.PartyOfficeID );
               
               ClearRecord( DebAcc );
               if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, FD.comm.rec.CommDate, null, FIID ) )
                  if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, null, null, DebAcc, FD.comm.rec.CommDate, FIID ) )
                     return false;
                  end;
               end;
/*
               if( not ПроводкаПоКатегориямВнутреннегоУчета( ВидРО,
                                                             FD,
                                                             Doc,
                                                             FD.comm.rec.CommDate,
                                                             FIID,
                                                             KredAccRest,
                                                             null, null, null, null,
                                                             DebAcc, KredAcc
                                                           )
                 )
                  return false;
               end;
*/
            end;
         end;
      
         UseProgress( NumCarry = NumCarry + 1 );
      
      end;
      
      RemProgress();
   end;

   return true;
END;

PRIVATE MACRO ВУ_ВыполнитьПереводСредствНаБиржу( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER ):BOOL

  if( FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_OWN )
     if( ВестиВнутреннийУчет() )
/*
        if( not ПроводкаПоКатегориямВнутреннегоУчета( 2 /*Вид РО*/,
                                                      FD,
                                                      Doc,
                                                      FD.comm.rec.CommDate,
                                                      FIID,
                                                      Summa
                                                    )
          )
           return false;
        end;
*/
     end;
  elif( FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_CLIENT )
     if( ВестиВнутреннийУчет() and ((ВУ_БОЦБПроводкиВводаВыводаДСНаОРЦБ() == 1) or (ВУ_БОЦБПроводкиВводаВыводаДСНаОРЦБ() == 3)) )
/*
        if( not ВУ_ПереводСредствНаКлирСчетКлиенту(FD, Doc, FIID) )
           return false;
        end;
*/
     end;  
  end;

  return true;
END;

PRIVATE MACRO ВыполнитьПереводСредствНаТорговыйСчет( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER ):BOOL
  var  DTAccountNum, FiRole, 
       DTAccountBuf = TRecHandler("account.dbt" ),
       CTAccountBuf = TRecHandler("account.dbt" );
  var DlRq = TRecHandler("dlrq");
  VAR DLMarket = TRecHandler( "dlmarket.dbt" );
  var НеФормироватьПроводкиПоТО = false;

  GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);

  if( not FD.IsExistAccount( "Торговый счет", DTAccountNum, false, FiRole, DTAccountBuf, null, FD.comm.rec.CommDate, FIID ) )
     return false;
  end;

  if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.comm.rec.DocKind, FD.comm.rec.DocumentID, FD.comm.rec.PartyID, FIID, CTAccountBuf) != 0)
    return false;
  end;

  DlRq.Clear();
  DlRq.rec.DocKind  = FD.comm.rec.DocKind;
  DlRq.rec.DocID    = FD.comm.rec.DocumentID;
  DlRq.rec.DealPart = 1;
  
  DlRq.rec.Kind = DLRQ_KIND_COMMIT;

  DlRq.rec.SubKind = DLRQ_SUBKIND_CURRENCY;
  DlRq.rec.Type    = DLRQ_TYPE_PAYMENT;
  DlRq.rec.Amount  = Summa;
  DlRq.rec.FIID    = FIID;

  DlRq.rec.Party = FD.comm.rec.PartyID;

  DlRq.rec.RqAccID  = 0; //заполнится автоматически
  if( FindDLMARKET(FD.comm.rec.MarketSchemeID,DLMarket) == 0 )
     DlRq.rec.PlaceID = DLMarket.rec.Centr;
  end;
  DlRq.rec.State    = DLRQ_STATE_EXEC;
  DlRq.rec.PlanDate = FD.comm.rec.CommDate;
  DlRq.rec.FactDate = FD.comm.rec.CommDate;


  if( DL_CreateDLRQ(DlRq, FD.comm.rec.CommDate, DLRQ_ACTION_CREATE) != 0)
    return false;
  end;


  if(ИнтегрированныйРежим())
    var rqacc = TRecHandler("dlrqacc.dbt");

    ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.comm.rec.DocKind, FD.comm.rec.DocumentID, FD.comm.rec.PartyID, DLRQ_SUBKIND_CURRENCY, FIID, DLRQ_TYPE_UNKNOWN, rqacc);

    if((rqacc.rec.BankID > 0) and (rqacc.rec.BankID > {OurBank}))
//      НеФормироватьПроводкиПоТО = true;
    end;

  end;
  

  if(НеФормироватьПроводкиПоТО == false)
    /*делаем проводку на сумму платежа*/ 
    if( not ПроводкаПоКатегориямУчета( FD, 
                                       DTAccountBuf, CTAccountBuf, /* КатегДеб , КатегКредит*/
                                       FD.comm.rec.CommDate,       /* Дата */
                                       1,                          /* Глава */
                                       DlRq.rec.FIID,              /* Валюта */
                                       DlRq.rec.Amount,            /* Сумма  */
                                       Doc,                        /* Документ */
                                       INPCARRY,                   /* Result_Carry */
                                       " 1",                       /* Kind_Oper */
                                       "",                         /* Numb_Document */
                                       "Перевод средств в РЦ ОРЦБ для обеспечения участия в торгах.", null,null,null,
                                       DTAccountBuf.rec.Code_Currency, CTAccountBuf.rec.Code_Currency     /* валюты счетов: Дт - Кт */ 
                                     )
      )
       return false;
    end;
/*ak*/
    /*Проводка на корсчет*/
    if(index(CTAccountBuf.rec.Type_Account,"К"))
      var errmsg;
      var err = ExecMacroFile("paymutil", "CreatingPaym", null, DLRq, @errmsg, true/*InStepOp*/, true/*IsSWIFT*/);
      if(err < 0)
        msgboxex("Ошибка при создании платежа по ТО\n" + errmsg);
        return false;
      elif(err > 0)
        //msgboxex("По ТО созданы платежи (" + err + ")");
      end;
    end;
/*~ak*/
  end;

  if(УстановитьСтатусТО(DlRq, DLRQ_STATE_EXEC, FD.comm.rec.CommDate) != 0)
     return false;
  end;

  if( not СохранитьСуммуКомиссии( FD.comm.rec.DocKind, FD.comm.rec.DocumentID, IIF(FIID == FD.comm.rec.Currency, DLSUM_KIND_DLCOMM_IN_CLIRINGACC_NATCUR, DLSUM_KIND_DLCOMM_IN_CLIRINGACC_CUR), 
                                  FD.comm.rec.CommDate, Summa, $0, FIID ) )
     return false;
  end; 
/*
  if( not ВУ_ВыполнитьПереводСредствНаБиржу(FD, Doc, Summa, FIID) )
     return false;
  end;
*/
  return true;
END;

PRIVATE MACRO ВыполнитьПереводСредствНаКлиринговыйСчет( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER ):BOOL
  var FiRole;

  GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);

  if( not ПроводкаПоКатегориямУчета( FD, 
                                     "Клиринговый счет", "Торговый счет",
                                     FD.comm.rec.CommDate, 
                                     1, 
                                     FIID, 
                                     Summa, 
                                     Doc,
                                     INPCARRY, 
                                     " 1", 
                                     FD.comm.rec.CommCode, 
                                     "Перевод средств на клиринговый счет",
                                     null, FiRole, FiRole,
                                     FIID, FIID 
                                   )
    )
     return false;
  end;

  return true;
END;

macro ПереводСредствНаТорговыйСчет( Doc:MEMADDR, TorgAccData:TRecHandler ):BOOL
  VAR FD = SPFirstDocDLCOMM( TorgAccData );
  if( TorgAccData.rec.hidden_sum != 0 )
     if( not ВыполнитьПереводСредствНаТорговыйСчет( FD, Doc, TorgAccData.rec.hidden_sum, TorgAccData.rec.Currency ) )
        return false;
     end;
  end;

  if( TorgAccData.rec.Currency_sum != 0 )
    if( not ВыполнитьПереводСредствНаТорговыйСчет( FD, Doc, TorgAccData.rec.Currency_sum, TorgAccData.rec.FIID ) )
       return false;
    end;
  end;

  return true;
end;

macro ПополнитьКлиринговыйСчет( Doc:MEMADDR, TorgAccData:TRecHandler ):BOOL

  VAR FD = SPFirstDocDLCOMM( TorgAccData );

  if( TorgAccData.rec.hidden_sum != 0 )
/*KD*/
     If(GetTrue(false, "Выполнить пополнение с Корр счета?"))
        if( not ВыполнитьПереводСредствНаКлирСчетСКорСчета( FD, Doc, TorgAccData.rec.hidden_sum, TorgAccData.rec.Currency ) )
           return false;
        end;
     else
        if( not ВыполнитьПереводСредствНаКлиринговыйСчет( FD, Doc, TorgAccData.rec.hidden_sum, TorgAccData.rec.Currency ) )
           return false;
        end;
     end;
  end;

  if( TorgAccData.rec.Currency_sum != 0 )
    if( not ВыполнитьПереводСредствНаКлиринговыйСчет( FD, Doc, TorgAccData.rec.Currency_sum, TorgAccData.rec.FIID ) )
       return false;
    end;
  end;

  return true;
end;

macro ПополнитьКлиринговыйСчетСКорСчета( Doc:MEMADDR, ClirAccData:TRecHandler ):BOOL

  VAR FD = SPFirstDocDLCOMM( ClirAccData );

  if( ClirAccData.rec.hidden_sum != 0 )
     if( not ВыполнитьПереводСредствНаКлирСчетСКорСчета( FD, Doc, ClirAccData.rec.hidden_sum, ClirAccData.rec.Currency ) )
        return false;
     end;
  end;

  if( ClirAccData.rec.Currency_sum != 0 )
    if( not ВыполнитьПереводСредствНаКлирСчетСКорСчета( FD, Doc, ClirAccData.rec.Currency_sum, ClirAccData.rec.FIID ) )
       return false;
    end;
  end;

  return true;
end;

macro ВыполнитьПереводСредствСКлирСчетаНаКорСчет( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER ):BOOL
    var CTAccountBuf = TRecHandler("account.dbt" );
    var FiRole;
  
    GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);

    if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.comm.rec.DocKind, FD.comm.rec.DocumentID, FD.comm.rec.PartyID, FIID, CTAccountBuf) != 0)
      return false;
    end;

    if( not ПроводкаПоКатегориямУчета( FD, 
                                     CTAccountBuf, "Клиринговый счет",
                                     FD.comm.rec.CommDate, 
                                     1, 
                                     FIID, 
                                     Summa, 
                                     Doc,
                                     INPCARRY, 
                                     " 1", 
                                     FD.comm.rec.CommCode, 
                                     "Перевод средств с клирингового счета на корсчет.",
                                     null, FiRole, null,
                                     FIID, CTAccountBuf.rec.Code_Currency 
                                   )
    )
       return false;
    end;

    if( not СохранитьСуммуКомиссии( FD.comm.rec.DocKind, FD.comm.rec.DocumentID, IIF(FIID == FD.comm.rec.Currency, DLSUM_KIND_DLCOMM_OUT_CLIRINGACC_NATCUR, DLSUM_KIND_DLCOMM_OUT_CLIRINGACC_CUR), 
                                    FD.comm.rec.CommDate, Summa, $0, FIID ) )
       return false;
    end; 
  
    return true;
end;

macro ВозвратСКлирСчетаНаКорсчет( Doc:MEMADDR, CorAccData:TRecHandler ):BOOL
    VAR FD = SPFirstDocDLCOMM( CorAccData );

    if(CorAccData.rec.hidden_sum != 0)
        if(not ВыполнитьПереводСредствСКлирСчетаНаКорСчет(FD, Doc, CorAccData.hidden_sum, CorAccData.rec.Currency))
            return false;
        end;
    end;

    if(CorAccData.rec.hidden_sum != 0)
        if(not ВыполнитьПереводСредствСКлирСчетаНаКорСчет(FD, Doc, CorAccData.Currency_sum, CorAccData.rec.FIID))
            return false;
        end;
    end;
end;

PRIVATE MACRO ВыполнитьПереводСОдногоКлирСчетаНаДругой( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER, pFillToCurClirAcc:bool, pMoneySourceBase:Integer ):BOOL
  var  CurClirAccBuf = TRecHandler("account.dbt" ),
       OtherClirAccBuf = TRecHandler("account.dbt" );
  var  Ground = "", FillToCurClirAcc = false, CredFiid, DebFiid;
  var  ВидРО, DLSUM_KIND;
  var  FiRole, FiRole_Other;

  if( pMoneySourceBase == FD.comm.rec.OperSubKind ) // перевод между клиринговыми счетами только собственных ИЛИ только клиентских средств
     GetSettlFiRoleByOperSubKind(pMoneySourceBase,@FiRole,@FiRole_Other);
  else // перевод между клиринговыми счетами собственных И клиентских средств
     GetSettlFiRoleByOperSubKind(pMoneySourceBase,@FiRole);
     GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,null,@FiRole_Other);
  end;

  if( pFillToCurClirAcc != null )
     FillToCurClirAcc = pFillToCurClirAcc;
  end;

  if( not FD.IsExistAccount( "Клиринговый счет", null, false, FiRole, CurClirAccBuf, null, FD.comm.rec.CommDate, FIID ) )
     return false;
  end;

  if( not FD.IsExistAccount( "Клиринговый счет", null, false, FiRole_Other, OtherClirAccBuf, null, FD.comm.rec.CommDate, FIID ) )
     return false;
  end;

  if( FillToCurClirAcc )
     Ground = "Зачисление на текущий клиринговый счет с другого клирингового счета.";
     CredFiid = OtherClirAccBuf.rec.Code_Currency;
     DebFiid  = CurClirAccBuf.rec.Code_Currency;
  else
     Ground = "Перевод с текущего клирингового счета на другой.";
     CredFiid = CurClirAccBuf.rec.Code_Currency;
     DebFiid  = OtherClirAccBuf.rec.Code_Currency;
  end;

  /*делаем проводку на сумму платежа*/ 
  if( not ПроводкаПоКатегориямУчета( FD, 
                                     IIF(FillToCurClirAcc,CurClirAccBuf,OtherClirAccBuf), IIF(FillToCurClirAcc,OtherClirAccBuf,CurClirAccBuf), /* КатегДеб , КатегКредит*/
                                     FD.comm.rec.CommDate, /* Дата */
                                     1,                    /* Глава */
                                     FIID,                 /* Валюта */
                                     Summa,                /* Сумма  */
                                     Doc,                  /* Документ */
                                     INPCARRY,             /* Result_Carry */
                                     " 1",                 /* Kind_Oper */
                                     "",                   /* Numb_Document */
                                     Ground, null,null,null,
                                     DebFiid, CredFiid     /* валюты счетов: Дт - Кт */ 
                                   )
    )
     return false;
  end;

  if( FIID == FD.comm.rec.Currency )
    if( FillToCurClirAcc )
       DLSUM_KIND = DLSUM_KIND_DLCOMM_FROM_OTHER_CLIRACC_NATCUR;
    else
       DLSUM_KIND = DLSUM_KIND_DLCOMM_TO_OTHER_CLIRACC_NATCUR;
    end;
  else
    if( FillToCurClirAcc )
       DLSUM_KIND = DLSUM_KIND_DLCOMM_FROM_OTHER_CLIRACC_CUR;
    else
       DLSUM_KIND = DLSUM_KIND_DLCOMM_TO_OTHER_CLIRACC_CUR;
    end;
  end;

  /*сохраним сумму с указанием ID схемы расчетов*/
  if( not СохранитьСуммуКомиссии( FD.comm.rec.DocKind, FD.comm.rec.DocumentID, DLSUM_KIND, 
                                  FD.comm.rec.CommDate, Summa, $0, FIID, null, FD.GetMarketSchemeIDOther() ) )
     return false;
  end; 
/*
  /*проводки ВУ перевода с другого и обратно только для собственных*/
  if( ВестиВнутреннийУчет() and (FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_OWN) )
     /*т.к. в дистрибутиве на сегодня только 2 схемы расчетов с одной биржей ФБ ММВБ с одним РЦ, но разными скторами, то 
       возможен перевод только между секторами, поэтому вид РО = 47 - так поясняют аналитики, хотя нам никто не запрещает ввести схемы рачетов с разными РЦ*/
     ВидРО = 47;
     if( not ПроводкаПоКатегориямВнутреннегоУчета( ВидРО,
                                                   FD,
                                                   Doc,
                                                   FD.comm.rec.CommDate,
                                                   FIID,
                                                   Summa,
                                                   null, null, null, null, null, null,
                                                   IIF(FillToCurClirAcc, FIROLE_SETTL_AGENT, FIROLE_ORCB_OTHCLIRACC),
                                                   IIF(FillToCurClirAcc, FIROLE_ORCB_OTHCLIRACC, FIROLE_SETTL_AGENT)
                                                 )
       )
        return false;
     end;
  end;
*/
  return true;
END;

macro ПереводСредствСТекущНаДругойКлирСчет( Doc:MEMADDR, ClirAccData:TRecHandler, MarketSchemOther:TRecHandler, pMoneySourceBase:Integer ):BOOL

  VAR FD = SPFirstDocDLCOMM( ClirAccData );
  
  FD.SetDlMarketOther(MarketSchemOther);

  if( ClirAccData.rec.hidden_sum != 0 )
     if( not ВыполнитьПереводСОдногоКлирСчетаНаДругой( FD, Doc, ClirAccData.rec.hidden_sum, ClirAccData.rec.Currency, null, pMoneySourceBase ) )
        return false;
     end;
  end;

  if( ClirAccData.rec.Currency_sum != 0 )
    if( not ВыполнитьПереводСОдногоКлирСчетаНаДругой( FD, Doc, ClirAccData.rec.Currency_sum, ClirAccData.rec.FIID, null, pMoneySourceBase ) )
       return false;
    end;
  end;

  return true;
end;

macro ПереводСредствСДругогоНаТекущКлирСчет( Doc:MEMADDR, ClirAccData:TRecHandler, MarketSchemOther:TRecHandler, pMoneySourceBase:Integer ):BOOL

  VAR FD = SPFirstDocDLCOMM( ClirAccData );
  
  FD.SetDlMarketOther(MarketSchemOther);

  if( ClirAccData.rec.hidden_sum != 0 )
     if( not ВыполнитьПереводСОдногоКлирСчетаНаДругой( FD, Doc, ClirAccData.rec.hidden_sum, ClirAccData.rec.Currency, true, pMoneySourceBase ) )
        return false;
     end;
  end;

  if( ClirAccData.rec.Currency_sum != 0 )
    if( not ВыполнитьПереводСОдногоКлирСчетаНаДругой( FD, Doc, ClirAccData.rec.Currency_sum, ClirAccData.rec.FIID, true, pMoneySourceBase ) )
       return false;
    end;
  end;

  return true;
end;

PRIVATE MACRO ВыполнитьВыводСредствКлиринговогоСчета( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER ):BOOL
  var  DTAccountNum = "", CTAccountNum = "",
       DTAccountBuf = TRecHandler("account.dbt" ),
       CTAccountBuf = TRecHandler("account.dbt" );
  var FiRole;

  GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);

  if( not FD.IsExistAccount( "Торговый счет", DTAccountNum, false, FiRole, DTAccountBuf, null, FD.comm.rec.CommDate, FIID ) )
     return false;
  end;

  if( not FD.IsExistAccount( "Клиринговый счет", CTAccountNum, false, FiRole, CTAccountBuf, null, FD.comm.rec.CommDate, FIID ) )
     return false;
  end;

  if( not ПроводкаПоКатегориямУчета( FD, 
                                     DTAccountBuf, CTAccountBuf, 
                                     FD.comm.rec.CommDate, 
                                     1, 
                                     FIID, 
                                     Summa, 
                                     Doc,
                                     INPCARRY, 
                                     " 1", 
                                     FD.comm.rec.CommCode, 
                                     "Перевод средств с клирингового счета ",
                                     null, null, null,
                                     FIID, FIID
                                   )
    )
     return false;
  end;   

  return true;
END;

MACRO ВыводСредствКлиринговогоСчета( Doc:MEMADDR, TorgAccData:TRecHandler ):BOOL
  var FD = SPFirstDocDLCOMM( TorgAccData );

  if( TorgAccData.rec.hidden_sum != 0 )
     if( not ВыполнитьВыводСредствКлиринговогоСчета( FD, Doc, TorgAccData.rec.hidden_sum, TorgAccData.rec.Currency ) )
        return false;
     end;
  end;

  if( TorgAccData.rec.Currency_sum != 0 )
    if( not ВыполнитьВыводСредствКлиринговогоСчета( FD, Doc, TorgAccData.rec.Currency_sum, TorgAccData.rec.FIID ) )
       return false;
    end;
  end;

  return true;

END;

PRIVATE MACRO ВыполнитьВыводСредствСТорговогоСчета( FD:SPFirstDocDLCOMM, Doc:MEMADDR, Summa:MONEY, FIID:INTEGER ):BOOL
  var  CTAccountNum,
       CTAccountBuf = TRecHandler("account.dbt" ), DTAccountBuf = TRecHandler("account.dbt" );
  var DlRq = TRecHandler("dlrq");
  VAR DLMarket = TRecHandler( "dlmarket.dbt" );
  var FiRole;

  GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);

  if( not FD.IsExistAccount( "Торговый счет", CTAccountNum, false, FiRole, CTAccountBuf, null, FD.comm.rec.CommDate, FIID ) )
     return false;
  end;

  if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.comm.rec.DocKind, FD.comm.rec.DocumentID, FD.comm.rec.PartyID, FIID, DTAccountBuf) != 0)
    return false;
  end;

  DlRq.Clear();
  DlRq.rec.DocKind  = FD.comm.rec.DocKind;
  DlRq.rec.DocID    = FD.comm.rec.DocumentID;
  DlRq.rec.DealPart = 1;
  
  DlRq.rec.Kind = DLRQ_KIND_REQUEST;

  DlRq.rec.SubKind = DLRQ_SUBKIND_CURRENCY;
  DlRq.rec.Type    = DLRQ_TYPE_PAYMENT;
  DlRq.rec.Amount  = Summa;
  DlRq.rec.FIID    = FIID;

  DlRq.rec.Party = FD.comm.rec.PartyID;

  DlRq.rec.RqAccID  = 0; //заполнится автоматически

  if( FindDLMARKET(FD.comm.rec.MarketSchemeID,DLMarket) == 0 )
     DlRq.rec.PlaceID = DLMarket.rec.Centr;
  end;

  DlRq.rec.State    = DLRQ_STATE_EXEC;
  DlRq.rec.PlanDate = FD.comm.rec.CommDate;
  DlRq.rec.FactDate = FD.comm.rec.CommDate;

  if( DL_CreateDLRQ(DlRq, FD.comm.rec.CommDate, DLRQ_ACTION_CREATE) != 0)
    return false;
  end;
 
  /*делаем проводку на сумму платежа*/ 
  if( not ПроводкаПоКатегориямУчета( FD, 
                                     DTAccountBuf, CTAccountBuf, /* КатегДеб , КатегКредит*/
                                     FD.comm.rec.CommDate,       /* Дата */
                                     1,                          /* Глава */
                                     DlRq.rec.FIID,              /* Валюта */
                                     DlRq.rec.Amount,            /* Сумма  */
                                     Doc,                        /* Документ */
                                     INPCARRY,                   /* Result_Carry */
                                     " 1",                       /* Kind_Oper */
                                     "",                         /* Numb_Document */
                                     "Вывод средств из РЦ ОРЦБ.", null,null,null,
                                     DTAccountBuf.rec.Code_Currency, CTAccountBuf.rec.Code_Currency  /* валюты счетов: Дт - Кт */ 
                                   )
    )
     return false;
  end;
 
  if(УстановитьСтатусТО(DlRq, DLRQ_STATE_EXEC, FD.comm.rec.CommDate) != 0)
     return false;
  end;

  if( not СохранитьСуммуКомиссии( FD.comm.rec.DocKind, FD.comm.rec.DocumentID, IIF(FIID == FD.comm.rec.Currency, DLSUM_KIND_DLCOMM_OUT_CLIRINGACC_NATCUR, DLSUM_KIND_DLCOMM_OUT_CLIRINGACC_CUR), 
                                  FD.comm.rec.CommDate, Summa, $0, FIID ) )
     return false;
  end; 
/*
  if( (FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_OWN) and ВестиВнутреннийУчет() )
     if( not ПроводкаПоКатегориямВнутреннегоУчета( 4 /*Вид РО*/, 
                                                   FD, 
                                                   Doc, 
                                                   FD.comm.rec.CommDate, 
                                                   FIID,
                                                   Summa
                                                 ) )
        return false;
     end;
  elif( (FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_CLIENT) and ВестиВнутреннийУчет() and (ВУ_БОЦБПроводкиВводаВыводаДСНаОРЦБ() == 3) )
     if( not ВУ_ПереводСредствСКлирСчетаКлиента(FD, Doc, FIID) )
        return false;
     end;
  end;
*/
  return true;
END;

MACRO ВыводСредствСТорговогоСчета( Doc:MEMADDR, TorgAccData:TRecHandler, ID_Operation:INTEGER, ID_Step:INTEGER ):BOOL
  var FD = SPFirstDocDLCOMM( TorgAccData );

  if( TorgAccData.rec.hidden_sum != 0 )
     if( not ВыполнитьВыводСредствСТорговогоСчета( FD, Doc, TorgAccData.rec.hidden_sum, TorgAccData.rec.Currency ) )
        return false;
     end;
  end;

  if( TorgAccData.rec.Currency_sum != 0 )
    if( not ВыполнитьВыводСредствСТорговогоСчета( FD, Doc, TorgAccData.rec.Currency_sum, TorgAccData.rec.FIID ) )
       return false;
    end;
  end;
  return true;

END;

MACRO ПроверитьОстаткиНаКлирСчетахСКотВыпПеревод(ClirAccData:TRecHandler, MarketSchemOther:TRecHandler, pFromOtherClirAcc:bool, pMoneySourceBase:Integer)

  RECORD Account(account);

  var FD = SPFirstDocDLCOMM( ClirAccData );
  var hidden_sum = $0, Currency_sum = $0;
  var FromOtherClirAcc = false;
  var FiRole = null, FiRole_Other = null;

  if( pMoneySourceBase == FD.comm.rec.OperSubKind ) // перевод между клиринговыми счетами только собственных ИЛИ только клиентских средств
     GetSettlFiRoleByOperSubKind(pMoneySourceBase,@FiRole,@FiRole_Other);
  else // перевод между клиринговыми счетами собственных И клиентских средств
     GetSettlFiRoleByOperSubKind(pMoneySourceBase,@FiRole);
     GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,null,@FiRole_Other);
  end;

  if( pFromOtherClirAcc != null )
     FromOtherClirAcc = pFromOtherClirAcc;
     if( pFromOtherClirAcc == true )
        FD.SetDlMarketOther(MarketSchemOther);
        FiRole = FiRole_Other;
     end;
  end;

  if( FD.IsExistAccount( "Клиринговый счет", null, true, FiRole, Account, null, FD.comm.rec.CommDate, FD.comm.rec.Currency ) )
     hidden_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
  end; 

  if( ClirAccData.rec.hidden_sum > hidden_sum )
//     msgbox("Заданная сумма в рублях превышает остаток "+string(hidden_sum)+" на клиринговом счете "+string(Account.Account)+", с которого выполняется перевод.");
//     return false;
  end;

  if( FD.comm.rec.FIID > 0 )
    if( FD.IsExistAccount( "Клиринговый счет", null, true, FiRole, Account, null, FD.comm.rec.CommDate, ClirAccData.rec.FIID ) )
       Currency_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
    end; 
    if( ClirAccData.rec.Currency_sum > Currency_sum )
//       msgbox("Заданная сумма в валюте превышает остаток "+string(Currency_sum)+" на клиринговом счете "+string(Account.Account)+", с которого выполняется перевод.");
//       return false;
    end;
  end;

  return true;
END;
