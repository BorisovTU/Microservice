/*
 $Name: nptxcrnset010.mac
 $Module: Ценные бумаги
 $Description: Соглашение об урегулировании претензий. Шаг "Расчет НДФЛ"
 */
import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(nptxop, ID_Operation, ID_Step)
  var НОБ_опер = $0, НОБ_30 = $0, НОБ_13 = $0, НОБ_15 = $0, taxe = $0, taxe15 = $0;
  var СНОБ = $0, STBDate, STBTime;
  var err = 0;
  var nptxopFile = TRecHandLer("nptxop.dbt");
  var CompSumNat = $0;
  var Year, BegDate, EndDate;

  nptxopFile.Clear();
  Copy(nptxopFile, nptxop); 

  EndDate = nptxop.rec.OperDate;

  datesplit(nptxop.rec.OperDate, NULL, NULL, Year);

  BegDate = date(1,1,Year);

  SmartConvertSum(CompSumNat, nptxop.rec.OutSum, nptxop.rec.OperDate, nptxop.rec.Currency, NATCUR);

  НОБ_опер = CompSumNat;
  
  var StartSTBDate = GetStartSTBDate();
  if((StartSTBDate > date(0,0,0)) and (nptxop.rec.OperDate >= StartSTBDate))
    GetLastOpSTBVal(nptxop.rec.DocKind, nptxop.rec.ID, NPTXVAL_KIND_STB, @СНОБ, @STBDate, @STBTime);

    CalcSTBTaxeByNOBOper(nptxop, false, BegDate, EndDate, STB_GetTaxBaseKindByDocKind(nptxop.rec.DocKind, false), СНОБ, НОБ_опер, @НОБ_30, @НОБ_13, @НОБ_15, @taxe, @taxe15);
  else
    var ClientResident = false;
    var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";

    if( DL_GetPartyResident(nptxop.rec.Client) == NPTXPARTY_RESIDENT )
      ClientResident = true;
    end;

    var Bg9 = GetRubSumByClient(nptxop.rec.Client, string(TXOBJ_BASEG9), BegDate, EndDate, null, 0);

    if(ClientResident == false)
      НОБ_30 = НОБ_опер;

      taxe   = NPTXGENTAXRATE_NOTRESIDENT * (Bg9 + НОБ_30) - GetP(nptxop.rec.Client, 0, TXOBJ_PAIDCOMP+","+TXOBJ_PAIDBILL, BegDate, EndDate, AddWhereNotOut);
    else
      НОБ_13 = MAX(0, MIN((Bg9 + НОБ_опер), NPTX_LIMINCOME_MAX15) - Bg9);
      НОБ_15 = НОБ_опер - НОБ_13;

      var НОБ = Bg9 + НОБ_опер;

      taxe   = NPTXGENTAXRATE_RESIDENT * MIN(НОБ, NPTX_LIMINCOME_MAX15) - GetP(nptxop.rec.Client, 0, TXOBJ_PAIDCOMP+","+TXOBJ_PAIDBILL, BegDate, EndDate, AddWhereNotOut);
      taxe15 = NPTXGENTAXRATE_RESIDENT_15 * (НОБ - MIN(НОБ, NPTX_LIMINCOME_MAX15)) - GetP(nptxop.rec.Client, 0, TXOBJ_PAIDCOMP_15+","+TXOBJ_PAIDGENERAL_15_9, BegDate, EndDate, AddWhereNotOut);
    end;
  end;

  //Создать объекты НДР
  var TaxObj = TInsertTaxObject();

  if(CompSumNat != 0)
    TaxObj.Add( 1
               ,nptxop.rec.OperDate// Дата НДР
               ,nptxop.rec.Client  // Клиент
               ,TXOBJ_DIR_IN       // Направление
               ,5                  // Уровень
               ,""                 // Признак "Пользовательский"
               ,TXOBJ_PLUSG_4800   // Вид НДР
               ,CompSumNat         // Сумма дохода/расхода
               ,NATCUR             // Валюта дохода/расхода
               ,TXOBJ_KIND1135     // Вид аналитики 1
               ,nptxop.rec.ID      // Аналитика 1
               ,0                  // Вид аналитики 2
               ,-1                 // Аналитика 2
               ,0                  // Вид аналитики 3
               ,-1                 // Аналитика 3
               ,0                  // Вид аналитики 4
               ,-1                 // Аналитика 4
               ,0                  // Вид аналитики 5
               ,-1                 // Аналитика 5
               ,TXOBJ_KIND6020     // Вид аналитики 6
               ,nptxop.rec.Contract// Аналитика 6
               ,"Доход, полученный по операции компенсации" // Комментарий
               ,nptxop.rec.ID      // ID операции
               ,ID_Step            // ID шага операции
               ,1
              );

    TaxObj.Add( 1
               ,nptxop.rec.OperDate// Дата НДР
               ,nptxop.rec.Client  // Клиент
               ,TXOBJ_DIR_IN       // Направление
               ,7                  // Уровень
               ,""                 // Признак "Пользовательский"
               ,TXOBJ_BASEG9       // Вид НДР
               ,CompSumNat         // Сумма дохода/расхода
               ,NATCUR             // Валюта дохода/расхода
               ,TXOBJ_KIND1135     // Вид аналитики 1
               ,nptxop.rec.ID      // Аналитика 1
               ,0                  // Вид аналитики 2
               ,-1                 // Аналитика 2
               ,0                  // Вид аналитики 3
               ,-1                 // Аналитика 3
               ,0                  // Вид аналитики 4
               ,-1                 // Аналитика 4
               ,0                  // Вид аналитики 5
               ,-1                 // Аналитика 5
               ,TXOBJ_KIND6020     // Вид аналитики 6
               ,nptxop.rec.Contract// Аналитика 6
               ,"Налоговая база по операции компенсации" // Комментарий
               ,nptxop.rec.ID      // ID операции
               ,ID_Step            // ID шага операции
               ,1
              );


    if(taxe != 0)
      TaxObj.Add( 1
                 ,nptxop.rec.OperDate// Дата НДР
                 ,nptxop.rec.Client  // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,TXOBJ_PAIDCOMP     // Вид НДР
                 ,taxe               // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,TXOBJ_KIND1135     // Вид аналитики 1
                 ,nptxop.rec.ID      // Аналитика 1
                 ,0                  // Вид аналитики 2
                 ,-1                 // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,TXOBJ_KIND6020     // Вид аналитики 6
                 ,nptxop.rec.Contract// Аналитика 6
                 ,"Налог по общей ставке в операции компенсации" // Комментарий
                 ,nptxop.rec.ID      // ID операции
                 ,ID_Step            // ID шага операции
                 ,1
                );
    end;

    if(taxe15 != 0)
      TaxObj.Add( 1
                 ,nptxop.rec.OperDate// Дата НДР
                 ,nptxop.rec.Client  // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,TXOBJ_PAIDCOMP_15  // Вид НДР
                 ,taxe15             // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,TXOBJ_KIND1135     // Вид аналитики 1
                 ,nptxop.rec.ID      // Аналитика 1
                 ,0                  // Вид аналитики 2
                 ,-1                 // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,TXOBJ_KIND6020     // Вид аналитики 6
                 ,nptxop.rec.Contract// Аналитика 6
                 ,"Налог по ставке 15% в операции компенсации" // Комментарий
                 ,nptxop.rec.ID      // ID операции
                 ,ID_Step            // ID шага операции
                 ,1
                );
    end;

    TaxObj.Save();

    err = DL_NPTX_StartInsertTaxObject(nptxop.rec.ID, ID_Step);
  end;

  if(not err)
    nptxopFile.rec.Tax   = taxe + taxe15;
    nptxopFile.rec.TaxDp = taxe15;

    if( DL_NPTX_UpdateSumm( nptxopFile ) != 0 )
      return Error( "Ошибка при обновлении сумм в dnptxop_dbt" );
    end;

    if(DL_InsertNPTXVAL(nptxop.rec.DocKind, nptxop.rec.ID, NPTXVAL_KIND_TB_Oper, date(0,0,0), time(0), НОБ_опер, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if(DL_InsertNPTXVAL(nptxop.rec.DocKind, nptxop.rec.ID, NPTXVAL_KIND_TB_30, date(0,0,0), time(0), НОБ_30, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if(DL_InsertNPTXVAL(nptxop.rec.DocKind, nptxop.rec.ID, NPTXVAL_KIND_TB_13, date(0,0,0), time(0), НОБ_13, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if(DL_InsertNPTXVAL(nptxop.rec.DocKind, nptxop.rec.ID, NPTXVAL_KIND_TB_15, date(0,0,0), time(0), НОБ_15, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if(DL_InsertNPTXVAL(nptxop.rec.DocKind, nptxop.rec.ID, NPTXVAL_KIND_TAXE, date(0,0,0), time(0), taxe, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if(DL_InsertNPTXVAL(nptxop.rec.DocKind, nptxop.rec.ID, NPTXVAL_KIND_TAXE_15, date(0,0,0), time(0), taxe15, 0) != 0)
      return Error( "Ошибка при сохранении значения СНОБ" );
    end;

    if((nptxop.rec.CalcNDFL == SET_CHAR) and (РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ()) and (StartSTBDate > date(0,0,0)) and (nptxop.rec.OperDate >= StartSTBDate))
       if( not InsertOprStatus(46481, 3)) //Формирование записей и отправка в Хранилище
         return Error( "Ошибка при установке статуса вида \"Формирование и отправка в Хранилище\" операции" );        
       end;
    else
       if( not InsertOprStatus(46481, 4)) //Формирование проводок
         return Error( "Ошибка при установке статуса вида \"Формирование проводок\" операции" );        
       end;
    end;
  end;

  return err;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  var nptxop = TRecHandler("nptxop.dbt");
  var err = 0;

  SetBuff( nptxop, FDoc );

  err = RunAction(nptxop, ID_Operation, ID_Step);

  DL_NPTX_SaveOperLog(nptxop.rec.ID, 10);

  return err;
end;