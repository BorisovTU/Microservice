/*
$Name:        loan420.mac
$Module:      Ценные бумаги
$Description: Займ. Шаг "Поставка по 2 ч"
*/

import InsCarryDoc, "sp_car.mac", "sp_car2.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  record  deal(dl_tick);
  var FD, FD1, dat, i = 0, Dknext;
  var rq_avoir = TRecHandler("dlrq.dbt");

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, true );
  FD1 = SPFirstDoc( deal, false );

  if( FD.БылОтказОтИсполнения() != false )
     return 0;
  end;

  if( FD1.БылОтказОтИсполнения() != false )
     return 0;
  end;

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat );

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага \"Поставка по 2 ч\" запрещено.");
    return 1;
  end;

  if(ПроверитьПорученияДепо(FD) == false)
    return 1;
  end;

  rq_avoir = FD.GetRQ(DLRQ_TYPE_DELIVERY);
/*
  if( FD.tick.rec.BofficeKind != DL_INVESTSHARE ) /*у паев нет просрочек и НКД*/
    if( ПроверитьТОНаПросроченность( rq_avoir, "поставке" ) == false )
       return 1;
    end;
  end;
*/
  /*Установить дату расчётов на ТО %% */
  if(FD.ExistPC and (not ТОСквитовано(FD.GetRQ(DLRQ_TYPE_INCREPO))))
    if( УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_INCREPO), DLRQ_STATE_EXEC, dat) != 0 )
      return 1;
    end;
  end;


  if( ВыполнитьНатуральныйУчетЦенныхБумаг( FD, Doc, dat, NULL ) != 0 )
     return 1;
  end; 

  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERY2, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;
 
  if(FD.tick.rec.IsPartyClient == SET_CHAR)
    if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERYCONTR2, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
      return 1;
    end;
  end;

  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYPC, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;


  return 0;
end;
