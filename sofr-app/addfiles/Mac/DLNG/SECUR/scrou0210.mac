/*
$Name:         scrou0210.mac
$Module:       Ценные бумаги
$Description:  Операция РЕПО без признания ц/б (не ОРЦБ), Оплата по 1 ч
*/

import InsCarryDoc, "sp_class.mac", "sp_car.mac", "sp_cars.mac", "sp_carb.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  record  deal(dl_tick);
  var FD, dat;
  var Dc, Di, Da, Dp, Dp2, Dknext;
  var rq_money = TRecHandler("dlrq.dbt");

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, false );

  GetOprDate( FD.GetKindDate(DATE_DEALPAY), dat );

  if( FD.БылОтказОтИсполнения() != false )
     return 0;
  end;

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага \"Оплата по 1 ч\" запрещено.");
    return 1;
  end;

  if( FD.ПроверитьОплаченностьАвансаЗадатка() == false ) 
     return 1;
  end; 

  rq_money = FD.GetRQ(DLRQ_TYPE_PAYMENT);

  if( ОбработатьТОПоОплате( FD, dat ) != 0)
    return 1;
  end;

  if( DL_WRTCreateCurrParmREPO( FD.tick.rec.DealID ) != 0 )
     return 1;
  end;

  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYMENT, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;

  if( FD.IsOldDeal() )
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_O1, SP_OPERSTATUS_SECURDEALS_O1_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оплата по 1 ч> операции" );
        return 1;
     end;
  end;

  return 0;
end;
