/*
 $Name: nptxrectb005.mac
 $Module: Ценные бумаги
 $Description: Операция пересчета СНОБ. Шаг "Инициализация"
 */

import DealsInter, "nptxstbfun.mac";

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  var err = 0;
  var nptxop = TRecHandler("nptxop.dbt");
  var query, cmd;

  SetBuff( nptxop, FDoc );

  cmd = DL_RSDCommand();

  query =   " select 1 "
          + "   from dnptxtbbuf_dbt "
          + "  where t_Status = " + NPTXTBBUF_STATUS_NOTPROCESSED;

  if(nptxop.rec.Client > 0)
    query = query + " and t_ClientID = ? ";
    cmd.addParam(nptxop.rec.Client);
  end;

  query = query + " and ROWNUM = 1 ";

  var cnt = cmd.GetCount(query);

  if(cnt > 0)
    if( not InsertOprStatus(46461, 4)) //Установить ДО = Пересчет
       err = Error( "Ошибка при установке статуса вида \"Документооборот\" операции" );        
    end;
  else
    DL_NPTX_PutMsg( "Нет записей для пересчета", 50 );
  end;

  DL_NPTX_SaveOperLog( nptxop.rec.ID, ID_Step );

  return err;
end;
