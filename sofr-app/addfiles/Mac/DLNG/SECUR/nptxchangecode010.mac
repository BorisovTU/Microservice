import DealsInter, "nptxstbfun.mac";

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

private macro clearCodeChangeTable(ID)
  var sql, exec;
  sql =   " DELETE FROM dnptxcodechange_dbt "
        + "  WHERE t_OPERATIONID = ? ";
                
  exec = DL_RSDCommand(sql);

  exec.AddParam(ID);

  exec.ExecuteCMD();
end;

private macro delChangeCodeNDR(ID)
  var sql, exec;
  sql =   " DELETE FROM dnptxobj_dbt "
        + "  WHERE t_objid in (select t_objid from DNPTXOBDC_DBT where t_docid = ? ) ";
                
  exec = DL_RSDCommand(sql);
  exec.AddParam(ID);
  exec.ExecuteCMD();
  
  sql =   " DELETE FROM DNPTXOBDC_DBT "
        + "  WHERE t_docid = ? ";
                
  exec = DL_RSDCommand(sql);
  exec.AddParam(ID);
  exec.ExecuteCMD();
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  var err = 0;
  var nptxop = TRecHandler("nptxop.dbt");
  var query, cmd;

  SetBuff( nptxop, FDoc );

  clearCodeChangeTable(nptxop.rec.ID);
  delChangeCodeNDR(nptxop.rec.ID);

  return err;
end;
