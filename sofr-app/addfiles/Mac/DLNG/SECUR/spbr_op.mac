/*
$Name:        spbr_op.mac
$Module:      ñ•≠≠Î• °„¨†£®
$Description: ÜìêçÄã ìóÖíÄ ÅêéäÖêëäàï éèÖêÄñàâ
*/

/*----------------------------------------
 è•‡•¢•§•≠ ≠† ≠Æ¢Î• ·Á•‚† §•ØÆ
 17 May 2000, VSH
------------------------------------------*/
import CurrInter, DealsInter, "sccomiss.mac", "sp_class.mac", "spRepFun.mac", "DLReport_h.mac","dlmisc.mac";

const sign = money(-1),  /*á≠†™ - §´Ô äÆ¨®··®Ô · ä´®•≠‚† ® äÆ¨®··®Ô ååÇÅ*/
      synt_chapter = 5,
      ≠†´Æ£_≠†_ÆØ•‡†Ê®® = 4,  /*≠†´Æ£ ≠† ÆØ•‡†Ê®® ¢ Ø‡ÆÊ•≠‚†Â! ‚.•. ·•©Á†· 4%*/
      ‰®ß®Á•·™Æ•_´®ÊÆ = 2;    /*§´Ô ØÆ´Ô LegalForm ®ß party.dbt*/

var BankName;

file deals(dl_tick);
file dl_leg(dl_leg);
file coupons(fiwarnts) key 1;
file persn(persn) key 0;
file sfcontr(sfcontr) ;

/* ®¨Ô ¢‡•¨•≠≠Æ£Æ ‰†©´†, ‰†©´ §´Ô ß†Ø®·® ® ‰†©´ §´Ô Á‚•≠®Ô */
var  brokopersFName;
file brokopers("brokops.tmp") key 0 write;
file repbrokopers("brokops.tmp") key 2;

record fin(fininstr);
record avr(avoiriss);
record depoacc(depoacnt);
record party1("party");

class ReportData( _EmiID:integer, _DprtID:integer, 
                  _BegDate: date, _EndDate: date, 
                  _FIID:integer, _AvoirKind:integer, _IDSort:integer,
                  _CFI:integer, _IsApp: bool)
   
   var EmiID = _EmiID,
       DprtID = _DprtID,
       BegDate = _BegDate,
       EndDate = _EndDate,
       FIID = _FIID,
       AvoirKind = _AvoirKind,
       IDSort = _IDSort,
       CFI = _CFI;

   var ReportRun = false,
       PrintHead = false,
       PrintTableHead = false;
   var UniqStr   = TUniqStrCollector;

  macro AuditMsg():String
    var msg:string = "";
    var dep_name:string = "Ç·•";
    var CFI_name:string = "Ç·•";
    var avr_name:string = "Ç·•";
    var emitent_name:string = "Ç·•";

    if (DprtID != 0) CB_GetDepartmentCodeAndName (DprtID, NULL, dep_name); end;
    if (CFI != -1) CFI_name = GetFinInstrName(CFI); end;
    if (EmiID != -1) emitent_name = GetPartyShortNameByID(EmiID); end;
    if (AvoirKind != 0) avr_name = GetAvoirKindRec(AvoirKind).name; end;

    msg = "é‚Á•‚:              Ü„‡≠†´ „Á•‚† °‡Æ™•‡·™®Â ÆØ•‡†Ê®©\n\n" +
          "î®´®†´:             " + dep_name + "\n" +
          "Ç†´Ó‚† ‡†·Á•‚Æ¢:    " + CFI_name + "\n" +
          "Ç®§ ñÅ:             " + avr_name + "\n" +
          "ù¨®‚•≠‚:            " + emitent_name + "\n" +
          "ç†Á†´Æ Ø•‡®Æ§†:     " + BegDate + "\n" +
          "äÆ≠•Ê Ø•‡®Æ§†:      " + EndDate + "\n" + 
          "\n----------------------------------------\n";

    return msg;
  end;

end;

var IsApp = true;

macro ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„( sum )
   if( IsApp == true )
     return String(sum:a);
   else  
     return String(sum);   
   end;  
end; 


macro î®ßã®ÊÆ(_ClientID) /*î®ß®Á•·™Æ• ´®ÊÆ ® ≠• Á†·‚≠Î© Ø‡•§Ø‡®≠®¨†‚•´Ï*/
     if (èÆ´„Á®‚Ïë„°Í•™‚†  (_ClientID, party1) != 0)
          RunError ("ç• ¨Æ£„ ØÆ´„Á®‚Ï Ø‡®ß≠†™ ™´®•≠‚†: ‰®ß®Á•·™Æ• ´®ÊÆ / Æ‡£†≠®ß†Ê®Ô");
     end;                          
     if(party1.LegalForm == ‰®ß®Á•·™Æ•_´®ÊÆ)
       persn.PersonID = party1.partyID;
       if( getEQ(persn) )
         return persn.IsEmployer != "X";
       else
         RunError ("ç• ¨Æ£„ ÆØ‡•§•´®‚Ï, Ô¢´Ô•‚·Ô ´® ™´®•≠‚ Á†·‚≠Î¨ Ø‡•§Ø‡•≠®¨†‚•´•¨.");
       end;
     end;
     return false;
end;

macro CheckDeal(FD, Data)

  var TypeOper; 

  TypeOper = GetDealBuySale( FD.tick.rec );
  if((TypeOper != DEAL_TYPE_SALE) AND (TypeOper != DEAL_TYPE_BUY) AND (TypeOper != DEAL_TYPE_RET_COUPON) AND (TypeOper != DEAL_TYPE_RET_PARTLY))
    return false;
  end;

  if ( èÆ´„Á®‚Ïî®≠à≠ ( FD.dl_leg.rec.PFI, fin, avr ) != 0 )
    runerror( "ç• ¨Æ£„ ≠†©‚® ®≠‰Æ‡¨†Ê®Ó Æ ‰®≠†≠·Æ¢Æ¨ ®≠·‚‡„¨•≠‚• ‰®£„‡®‡„ÓÈ•¨ ¢ ·§•´™•");
  end;

  return true;

end;

private macro GetNumContr(FD, IsPartyClient)
  if (IsPartyClient)
     /*ÑÆ£Æ¢Æ‡ · ™Æ≠‚‡†£•≠‚Æ¨*/
     if( FD.tick.rec.PartyID > 0 )
        /*çÆ¨•‡ §Æ£Æ¢Æ‡†*/
        ClearRecord( sfcontr );
        sfcontr.Id = FD.tick.rec.PartyContrID;
        if( GetEQ(sfcontr) )  
           return sfcontr.Number;
        else 
           return "";
        end;
     else 
        return "";
     end;
  else
     /*ÑÆ£Æ¢Æ‡ · ™´®•≠‚Æ¨*/
     if( FD.tick.rec.ClientID > 0 )
        /*çÆ¨•‡ §Æ£Æ¢Æ‡†*/
        ClearRecord( sfcontr );
        sfcontr.Id = FD.tick.rec.ClientContrID;
        if( GetEQ(sfcontr) )  
           return sfcontr.Number;
        else 
           return "";
        end;
     else 
        return "";
     end;
  end;
end;

private macro Ç™´ÓÁ®‚Ïë§•´™„Çé‚ÁÒ‚ (brokopers, Data, deals, FD, fin, IsBack, IsPartyClient)
  var continue_cicle, i = 0, err_string, nominal:moneyl, TypeOper, BondKind, AgentCode;

  clearrecord(brokopers);
  brokopers.op_date = FD.DateArray[DATE_DEALPAY];
  brokopers.Department = FD.tick.rec.Department;
  brokopers.CFI = FD.dl_leg.rec.CFI;

  èÆ´„Á®‚Ïî®≠à≠ ( FD.dl_leg.rec.PFI, fin, avr);
  brokopers.AvoirKind = fin.AvoirKind;
  BondKind = èÆ´„Á®‚ÏÇ®§é°´®£†Ê®®( avr );
  brokopers.BondKind = BondKind;

  brokopers.FIID = FD.dl_leg.rec.PFI;
  brokopers.lsin = avr.LSIN;

  if (IsPartyClient)
     brokopers.client_code = SP_èÆ´„Á®‚ÏÖää(FD.tick.rec.PartyID, FD.tick.rec.PartyContrID);
     if (NOT brokopers.client_code)
        brokopers.client_code = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(FD.tick.rec.PartyID, PTCK_MICEX);
        if (NOT brokopers.client_code)
           brokopers.client_code = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(FD.tick.rec.PartyID, PTCK_CONTR);
        end;
     end;

     /*¸ ØÆ‡„Á•≠®Ô ≠† ·§•´™„*/
     èÆ´„Á®‚ÏÑÆ™„¨•≠‚èÆë§•´™•( deals.BofficeKind, deals.DealID,
                               DOCKIND_ORD_CLIENTOP, brokopers.indoc_id );
     if (NOT brokopers.indoc_id)
        brokopers.indoc_id = "ÑÆ£.¸"+GetNumContr(FD, true);
     end;
  else
     brokopers.client_code = SP_èÆ´„Á®‚ÏÖää(FD.tick.rec.ClientID, FD.tick.rec.ClientContrID);
     if (NOT brokopers.client_code)
        brokopers.client_code = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(FD.tick.rec.ClientID, PTCK_MICEX);
        if (NOT brokopers.client_code)
           brokopers.client_code = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(FD.tick.rec.ClientID, PTCK_CONTR);
        end;
     end;

     /*¸ ØÆ‡„Á•≠®Ô ≠† ·§•´™„*/
     èÆ´„Á®‚ÏÑÆ™„¨•≠‚èÆë§•´™•( deals.BofficeKind, deals.DealID,
                               DOCKIND_ORD_CLIENTOP, brokopers.indoc_id );
     if (NOT brokopers.indoc_id)
        brokopers.indoc_id = "ÑÆ£.¸"+GetNumContr(FD, false);
     end;
  end;

  brokopers.deal_id = FD.tick.rec.DealID;

  if((deals.BofficeKind == DL_SECURITYDOC) OR (deals.BofficeKind == DL_INVESTSHARE)) 
     brokopers.amount = FD.dl_leg.rec.Principal;
     brokopers.sum = FD.dl_leg.rec.Cost;
     brokopers.price = FD.dl_leg.rec.Price;

     if((brokopers.avoirkind != AVOIRISSKIND_INVESTMENT_SHARE)  and (brokopers.amount > 0))
        if (FI_IsBond(FD.dl_leg.rec.PFI))
           SmartConvertSum(nominal, FD.FaceValueMoney, FD.pm_avoir.ValueDate, fin.FaceValueFI, brokopers.CFI, true);
           /* ñ•≠† ¢ Ø‡ÆÊ•≠‚†Â Æ‚ ≠Æ¨®≠†´† */
           brokopers.price = brokopers.sum/(brokopers.amount*nominal)*100;
        else
           brokopers.price = brokopers.sum/(brokopers.amount)*1;
        end;
     end;
  else
     /*ØÆ£†Ë•≠®• ™„ØÆ≠Æ¢*/
     if( IsRET_COUPON(FD.Group) AND (NOT IsRet_Partly(FD.Group)) )
     /* èÆ£†Ë•≠®• ¢ÎØ„·™† */
     elif( IsRET_ISSUE(FD.Group) )
        brokopers.amount = FD.dl_leg.rec.Principal;
        brokopers.price = 100;
        brokopers.sum = FD.dl_leg.rec.Cost;

     /* ó†·‚®Á≠Æ• ØÆ£†Ë•≠®• */
     elif( IsRET_PARTLY(FD.Group) )
/*
        SmartConvertSum(nominal, FD.FaceValueMoney, FD.pm_avoir.ValueDate, fin.FaceValueFI, brokopers.CFI, true);
*/        
        brokopers.Price = FD.dl_leg.rec.TotalCost/(FD.dl_leg.rec.Principal*FD.FaceValueMoney)*100;
        brokopers.sum = FD.dl_leg.rec.TotalCost;
     end;
  end;
  brokopers.Point = FD.dl_leg.rec.Point;

  /*Ö·´® ≠• ß†§†≠ ≠Æ¨®≠†´ - Ì‚Æ ≠• ÂÆ‡ÆËÆ!!!*/
  if((FD.FaceValueMoney == 0) AND (brokopers.avoirkind != AVOIRISSKIND_INVESTMENT_SHARE))
     brokopers.Price = 0;
     Data.UniqStr.AddString( "ç• ß†§†≠ ≠Æ¨®≠†´ Ê/° · ™Æ§Æ¨ : " + string(fin.FI_Code) );
  end;

  VAR sum_agent = $0, sum_bank = $0;                                                              

  /*éØ´†Á•≠≠†Ô ™Æ¨®··®Ô °†≠™†*/
  SP_GetSumCom( sum_bank, null, null, null, 
                FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, brokopers.op_date, brokopers.op_date, 1, 0,   
                1, 0, 1, 1, null, brokopers.CFI, true        
               );
  brokopers.client_comm = sum_bank;                                                                                             
      
  /*éØ´†Á•≠≠†Ô ™Æ¨®··®Ô °®‡¶•/°‡Æ™•‡†¨*/
  SP_GetSumCom( sum_agent, null, null, null, 
                FD.tick.rec.BofficeKind, FD.tick.rec.DealID, null, brokopers.op_date, brokopers.op_date, 0, 1,   
                1, 0, 1, 1, null, brokopers.CFI, true,
                IIF(not IsBack, true, false),
                IIF(IsBack, true, false)
               );
  brokopers.micex_comm = sum_agent;                                                                                          

  if( FD.pm_avoir == null )
     SmartConvertSum(brokopers.nkd, FD.dl_leg.rec.NKD, FD.tick.rec.DealDate, fin.FaceValueFI, brokopers.CFI, true);
  else
     SmartConvertSum(brokopers.nkd, FD.dl_leg.rec.NKD, FD.pm_avoir.ValueDate, fin.FaceValueFI, brokopers.CFI, true);
  end;

  TypeOper = GetDealBuySale( deals, IsBack );

  if(brokopers.avoirkind != AVOIRISSKIND_INVESTMENT_SHARE)
     if ( ((TypeOper == DEAL_TYPE_BUY ) AND (IsPartyClient == false)) OR
          ((TypeOper == DEAL_TYPE_SALE) AND (IsPartyClient == true ))
        )     
        brokopers.sum = /*-*/ brokopers.sum; 
        brokopers.nkd = /*-*/ brokopers.nkd;
     else
        brokopers.amount = /*-*/ brokopers.amount;
     end;
  end;

  if ( not insert(brokopers) )
     status(err_string);
     runerror(err_string);
  end;
end;

macro fill_deals(Data)
  var continue_cicle, i = 0, err_string, nominal:moneyl, TypeOper, BondKind, IsBack, FD, AgentCode, FD_Back;
  var DealChnCur  = TRecHandler( "sptkchng" );

  /* ØÆ´„Á†•¨ ®¨Ô ¢‡•¨•≠≠Æ£Æ ‰†©´†, ·Æß§†•¨ ® Æ‚™‡Î¢†•¨ •£Æ */
  brokopersFName = GetWorkFileName("brokops");

  var str_cmd = " select deals.t_DealID, dl_leg.T_LEGKIND, fin.T_AvoirKind                              " +
                " from   ddl_tick_dbt deals, ddl_leg_dbt dl_leg, ddlrq_dbt rq, dfininstr_dbt fin      " +
                " where  deals.t_DealID = dl_leg.t_DealID                              " +
                "    and dl_leg.t_LegKind in( ?, ? )                                   " +
                "    and dl_leg.t_LegID   = 0                                          " +
                "    and deals.t_BofficeKind in( 101, 117, 155 )                       " +
                "    and ( (deals.t_ClientID != ? and deals.t_ClientID >= 0 )          " +
                "        or deals.t_PartyContrID     = 0                               " +
                "        or deals.t_IsPartyClient = ? )                                " +
                "    and rq.t_DOCKIND = deals.t_BOfficeKind                            " +
                "    and rq.t_DOCID = deals.t_DealID                                   " +
                "    and rq.T_TYPE = " +DLRQ_TYPE_PAYMENT+
                "    and rq.T_DEALPART = CASE WHEN (dl_leg.t_LegKind = 0)          " +
                "                        THEN 1                                    " +
                "                        ELSE 2                                    " +
                "                            END                                       " +
                "    and rq.T_FACTDATE  <= ?                                        " +
                "    and rq.T_FACTDATE  >= ?                                        " +
                "    and (rq.T_State = "+DLRQ_STATE_EXEC+" or rq.T_State = "+DLRQ_STATE_GO_CLOSE+" or rq.T_State = "+DLRQ_STATE_REJECT+" ) " + 
                "    and fin.t_FIID = dl_leg.t_PFI                                     " ;
  
  if( Data.DprtID > 0 )
    str_cmd = str_cmd +   "    and deals.t_Department = ?                                        ";
  end;
  if( Data.CFI >= 0 )
    str_cmd = str_cmd +   "    and dl_leg.t_CFI = ?                                              ";
  end;
  if( Data.FIID > 0 )
    str_cmd = str_cmd +   "    and dl_leg.t_PFI = ?                                              ";
  end;

  if( Data.IDSort != -1 )
    str_cmd = str_cmd +   "    and fin.t_AvoirKind = ?                                           ";
  end;
  if( Data.AvoirKind != 0 )
    str_cmd = str_cmd  +   "    and RSB_FIInstr.FI_AvrKindsEQ( 2, ?, fin.T_AvoirKind) = 1           ";
  end;
  if( Data.EmiID > 0 )
    str_cmd = str_cmd +   "    and fin.t_Issuer = ?                                              ";
  end;

  var cmd, select;
  cmd = RSDCommand( str_cmd );

  cmd.addParam("", RSDBP_IN, LEG_KIND_DL_TICK_BACK);//2
  cmd.addParam("", RSDBP_IN, LEG_KIND_DL_TICK);//0
  cmd.addParam("", RSDBP_IN, {OurBank});
  cmd.addParam("", RSDBP_IN, SET_CHAR);
  cmd.addParam("", RSDBP_IN, Data.EndDate);
  cmd.addParam("", RSDBP_IN, Data.BegDate);
  if( Data.DprtID > 0 )
    cmd.addParam("", RSDBP_IN, Data.DprtID);    
  end;
  if( Data.CFI >= 0 )
    cmd.addParam("", RSDBP_IN, Data.CFI);    
  end;
  if( Data.FIID > 0 )
    cmd.addParam("", RSDBP_IN, Data.FIID);    
  end;
  if( Data.IDSort != -1 )
    cmd.addParam("", RSDBP_IN, Data.IDSort);    
  end;
  if( Data.AvoirKind != 0 )
    cmd.addParam("", RSDBP_IN, Data.AvoirKind);
  end;
  if( Data.EmiID > 0 )
    cmd.addParam("", RSDBP_IN, Data.EmiID);    
  end;
  cmd.execute();
  select = TRsbDataSet(cmd);

  //™Æ´®Á•·‚¢Æ ß†Ø®·•©
  var cmdQ, selectQ;
  var nRecs = 0;
  cmdQ = RSDCommand(" select COUNT(1) nRecs " +
                    " from (" + str_cmd + ")"  );
  cmdQ.addParam("", RSDBP_IN, LEG_KIND_DL_TICK_BACK);
  cmdQ.addParam("", RSDBP_IN, LEG_KIND_DL_TICK);
  cmdQ.addParam("", RSDBP_IN, {OurBank});
  cmdQ.addParam("", RSDBP_IN, SET_CHAR);
  cmdQ.addParam("", RSDBP_IN, Data.EndDate);
  cmdQ.addParam("", RSDBP_IN, Data.BegDate);
  if( Data.DprtID > 0 )
    cmdQ.addParam("", RSDBP_IN, Data.DprtID);    
  end;
  if( Data.CFI >= 0 )
    cmdQ.addParam("", RSDBP_IN, Data.CFI);    
  end;
  if( Data.FIID > 0 )
    cmdQ.addParam("", RSDBP_IN, Data.FIID);    
  end;
  if( Data.IDSort != -1 )
    cmdQ.addParam("", RSDBP_IN, Data.IDSort);    
  end;
  if( Data.AvoirKind != 0 )
    cmdQ.addParam("", RSDBP_IN, Data.AvoirKind);
  end;
  if( Data.EmiID > 0 )
    cmdQ.addParam("", RSDBP_IN, Data.EmiID);    
  end;
  cmdQ.execute();
  selectQ = TRsbDataSet(cmdQ);
  if ( selectQ.moveNext() ) 
        nRecs = Int(selectQ.nRecs);
  end;

  InitProgress(nRecs, "è‡Æ·¨Æ‚‡ ‚‡†≠Ë•© ·§•´Æ™", "è‡Æ·¨Æ‚‡ ‚‡†≠Ë•© ·§•´Æ™");

  while(select.MoveNext())
  
     if(select.LEGKIND == LEG_KIND_DL_TICK) /*Ø•‡¢†Ô Á†·‚Ï ·§•´™®*/
       IsBack = false;
     elif(select.LEGKIND == LEG_KIND_DL_TICK_BACK)
       IsBack = true;
     end;
     /*ØÆ§™†Á®¢†•¨ ·§•´™„*/
     clearrecord(deals);
     deals.DealID = select.DealID;
     if( GetEQ(deals) )

        /*è•‡¢®Á≠Î© §Æ™„¨•≠‚*/
        FD = SPFirstDoc(deals, IsBack);
        // = SPFirstDoc(select.LEGKIND, select.DealID);
      
        SP_GetDealParmsByDate( deals, deals.DealDate, DealChnCur, false, true );
        FD.dl_leg.rec.pfi = DealChnCur.rec.oldpfi1; 
      
        if(CheckDeal(FD, Data) == true)

           if(not ((FD.tick.rec.ClientID == {OurBank}) OR (FD.tick.rec.ClientID < 0)) )
              Ç™´ÓÁ®‚Ïë§•´™„Çé‚ÁÒ‚ (brokopers, Data, deals, FD, fin, false, false);
           end;
           if ((deals.IsPartyClient == SET_CHAR) AND (deals.PartyContrID != 0))
               Ç™´ÓÁ®‚Ïë§•´™„Çé‚ÁÒ‚ (brokopers, Data, deals, FD, fin, false, true);
           end;
           if (IsREPO (FD.Group) OR IsBACKSALE (FD.Group))
              FD_Back = SPFirstDoc(deals, true);
              if(CheckDeal(FD_Back, Data) == true)
                 if(not ((FD_Back.tick.rec.ClientID == {OurBank}) OR (FD_Back.tick.rec.ClientID < 0)) )
                    Ç™´ÓÁ®‚Ïë§•´™„Çé‚ÁÒ‚ (brokopers, Data, deals, FD_Back, fin, true, false);
                 end;
                 if ((deals.IsPartyClient == SET_CHAR) AND (deals.PartyContrID != 0))
                    Ç™´ÓÁ®‚Ïë§•´™„Çé‚ÁÒ‚ (brokopers, Data, deals, FD_Back, fin, true, true);
                 end;
              end;
           end;
        end;
     end;
     i = i + 1;
     useprogress(i);
  end;
  remprogress();
end;

private macro DL_GetDepartmentNameByCode(code)
  var ds, select;
  if (valtype(code) != V_UNDEF)
     select = String("select dep.t_code, party.t_name ",
                     "from ddp_dep_dbt dep, dparty_dbt party ",
                     "where dep.t_code = ", code,
                     " and dep.t_partyid = party.t_partyid");
     ds = TRsbDataset(select);
     if (ds.next())
       return ds.t_name;
     end;
  end;
  return "";
END;

private macro GetDprtName(DprtID)
   file Dprt( dp_dep );
   if( DprtID > 0 )
      ClearRecord( Dprt );
      Dprt.Code = DprtID;
      if( not GetEQ( Dprt ) )
        RunError( "ç• ≠†©§•≠ ‰®´®†´ · ™Æ§Æ¨ " + string(DprtID) );    
      else
        BankName = DL_GetDepartmentNameByCode(DprtID); 
      end;
      return Dprt.name;
    end;
    return "";
end;

macro report_rec(Data)
     var continue_cicle, i = 0, NewRep = false,
         last_date = date(0,0,0), Date_Changed = false,
         last_DprtID = -10, DprtID_Changed = false,
         last_CFI = 0, CFI_changed = false,
         last_AvoirKind = 0, AvoirKind_changed = false,
         last_BondKind = 0, BondKind_changed = false,
         last_FIID, FIID_changed,
         ValName, ValCode, AvrKindName, BondKindName, äÆ¨®··®Ô, DprtName, Parm,
         tot_sum, tot_nkd, tot_bank_comm, tot_micex_comm, tot_tax;

     var PrnAmount, PrnPrice, PrnNkd, prn_tot_sum;
     file _fininstr(fininstr) key 0;

     tot_sum = tot_nkd = tot_bank_comm = tot_micex_comm = tot_tax = $0;

     initprogress(NRecords(repbrokopers),"ÇÎØ„·™ Æ‚Á•‚†","ÇÎØ„·™ Æ‚Á•‚†");
     while (next(repbrokopers))
         NewRep = false;

         Date_Changed = (repbrokopers.op_date != last_date);
         DprtID_Changed = (repbrokopers.Department != last_DprtID);
         CFI_Changed = (repbrokopers.CFI != last_CFI);
         AvoirKind_Changed = (repbrokopers.AvoirKind != last_AvoirKind);
         BondKind_Changed = (repbrokopers.BondKind != last_BondKind);

         last_date = repbrokopers.op_date;
         last_DprtID = repbrokopers.Department;
         last_CFI = repbrokopers.CFI;
         last_AvoirKind = repbrokopers.AvoirKind;
         last_BondKind = repbrokopers.BondKind;

         if ( Date_Changed OR DprtID_Changed OR CFI_Changed OR AvoirKind_Changed OR BondKind_Changed)

            NewRep = true;
            last_FIID = -1;

            DprtName = GetDprtName(repbrokopers.Department);
            èÆ´„Á®‚Ïî®≠à≠ ( repbrokopers.CFI, fin );
            ValName = fin.Name;
            if ( FI_IsBond(repbrokopers.FIID) )
               BondKindName = AvoirKindName(repbrokopers.AvoirKind);
               AvrKindName = GetNameBondKind( repbrokopers.BondKind );
               ValCode = "(%)";
            else
               BondKindName = "";
               ValCode = "("+fin.Ccy+")";
               AvrKindName = AvoirKindName(repbrokopers.AvoirKind);
            end;

            äÆ¨®··®Ô = "°®‡¶•/°‡Æ™•‡„";

            if ( i != 0 )
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
 ≥Ç·•£Æ ß† §•≠Ï                                               ≥###############≥####################≥##################≥#############≥
 ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
](ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_sum):r:w, ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_nkd):r:w, ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_bank_comm)):r:w,
  ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_micex_comm)):r:w);

                after_44_footer();
[


];
               tot_sum = 0;
               tot_nkd = 0;
               tot_bank_comm = 0;
               tot_micex_comm = 0;
               tot_tax = 0;   
            end;

[          ÜìêçÄã ìóÖíÄ ÅêéäÖêëäàï éèÖêÄñàâ

    ç†®¨•≠Æ¢†≠®• Æ‡£†≠®ß†Ê®®: #
    î®´®†´: #
    Ç†´Ó‚† ‡†·Á•‚Æ¢: #
    Ç®§ Ê/°: #
    Ç®§ Æ°´®£†Ê®®: #
 ⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
 ≥çÆ¨•‡ ™´®•≠‚†≥çÆ¨•‡ ØÆ‡„Á•≠®Ô ≥  äÆ´®Á•·‚¢Æ  ≥     ñ•≠†     ≥   ë‚Æ®¨Æ·‚Ï   ≥ç†™ÆØ´•≠≠Î© ™„ØÆ≠≠Î©≥äÆ¨®··®Ô · ™´®•≠‚†≥  äÆ¨®··®Ô   ≥
 ≥             ≥                ≥    (Ë‚.)     ≥              ≥               ≥        §ÆÂÆ§       ≥                  ≥#############≥
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
 ≥      #                                                                                                                           ≥
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
 ≥                                                                 #                                                                ≥
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
](BankName, DprtName, ValName, AvrKindName, BondKindName, äÆ¨®··®Ô:c, 
  date_as_string(1,repbrokopers.op_date):c, repbrokopers.lsin:c);
         end;

         FIID_changed = (repbrokopers.FIID != last_FIID);
         last_FIID = repbrokopers.FIID;

         if( FIID_changed AND (NOT NewRep) )
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
 ≥                                                                 #                                                                ≥
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
](repbrokopers.lsin:c);
         end;
         if ( NOT FIID_changed )
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
         end;

         useprogress(i);

         èÆ´„Á®‚Ïî®≠à≠ ( repbrokopers.CFI, fin );
         if ( FI_IsBond(repbrokopers.FIID) )
            ValCode = "%";
         else
            ValCode = fin.Ccy;
         end;

         if( IsApp == true )
           Parm = "a";
         else  
           Parm = "";
         end;  

        PrnPrice = ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(repbrokopers.Price,repbrokopers.Point,Parm);
        PrnNkd = ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(repbrokopers.nkd);

        if( repbrokopers.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE )
           _fininstr.fiid = repbrokopers.fiid;
           PrnNkd = "";
           if (repbrokopers.Price == 0) 
              PrnPrice = "";
              ValCode = "";
           end;
           if (repbrokopers.amount == 0)
              PrnAmount = "";
           else
              if(GetEQ(_fininstr))
                 if( IsApp == true ) 
                    PrnAmount = String(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ( repbrokopers.amount, _fininstr.sumprecision, "a"));
                 else  
                    PrnAmount = String(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ( repbrokopers.amount, _fininstr.sumprecision, ""));   
                 end;  
              else
                 PrnAmount = String( Floor_Money( repbrokopers.amount:a ) );
              end;
           end;
        else
           if( IsApp == true )
              PrnAmount = String( Floor_Money( repbrokopers.amount:a ) );
           else  
              PrnAmount = String( Floor_Money( repbrokopers.amount) );   
           end;  
        end;

[≥#############≥################≥##############≥########## ###≥###############≥####################≥##################≥#############≥]
(repbrokopers.client_code:w,repbrokopers.indoc_id:w,
 PrnAmount:r:w, PrnPrice:r:w, ValCode:w, 
 ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(repbrokopers.sum):r:w, PrnNkd:r:w,
 ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*repbrokopers.client_comm)):r:w,
 ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*repbrokopers.micex_comm)):r:w );

          tot_sum = tot_sum + repbrokopers.sum;
          tot_nkd = tot_nkd + repbrokopers.nkd;
          tot_bank_comm = tot_bank_comm + repbrokopers.client_comm;
          tot_micex_comm = tot_micex_comm + repbrokopers.micex_comm;
          tot_tax = tot_tax + repbrokopers.client_tax;   
          i = i + 1;
     end;

     if ( i == 0 )
          println("\n\nç•‚ §†≠≠ÎÂ, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†.");
          return;
     else
        if(brokopers.avoirkind == AVOIRISSKIND_INVESTMENT_SHARE)
           prn_tot_sum = "";
        else
           prn_tot_sum = ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_nkd);
        end;
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
 ≥Ç·•£Æ ß† §•≠Ï                                               ≥###############≥####################≥##################≥#############≥
 ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
](ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_sum):r:w, prn_tot_sum:r:w, ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_bank_comm)):r:w,
  ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_micex_comm)):r:w);

         /* è•Á†‚†•¨ Ø‡Æ‚Æ™Æ´. */
         if( Data.UniqStr.Size > 0 )
            [ ];
            [è‡Æ‚Æ™Æ´ Æ‚Á•‚†:];
            [ ];
            Data.UniqStr.PrintArray;
            [ ];
         end;
         after_44_footer();
     end;
  remprogress();
end;


var Data;

PRIVATE CLASS (DL_CReportTemplate) SP_SpbrOp_Report

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;                                                                                                                                                                         
  
  PRIVATE MACRO BeginReport()
     CreateTotalBook();     
     SetActiveSheet( "0101" );
  END;

  PRIVATE MACRO EndReport()
     SaveTotalBook();
  END;

  PRIVATE MACRO PrintArray( Data )
     var Counter = 0;
     CopyAllSheetInTotalBook( NULL, false, "N1_HeadReport", 1 );
     while( Counter < Data.UniqStr.Size )
         PrintFormatString( null, "N1_H0_7", Data.UniqStr.(Counter) );
         CopyAllSheetInTotalBook( NULL, false, "N1_H0_7", 0 );
         Counter = Counter + 1;
     end;
  END;

  PRIVATE MACRO report_rec(Data)
     var continue_cicle, i = 0, NewRep = false,
         last_date = date(0,0,0), Date_Changed = false,
         last_DprtID = -10, DprtID_Changed = false,
         last_CFI = 0, CFI_changed = false,
         last_AvoirKind = 0, AvoirKind_changed = false,
         last_BondKind = 0, BondKind_changed = false,
         last_FIID, FIID_changed,
         ValName, ValCode, AvrKindName, BondKindName, äÆ¨®··®Ô, DprtName, Parm,
         tot_sum, tot_nkd, tot_bank_comm, tot_micex_comm, tot_tax;

     var PrnAmount, PrnPrice, PrnNkd, prn_tot_sum;
     file _fininstr(fininstr) key 0;

     tot_sum = tot_nkd = tot_bank_comm = tot_micex_comm = tot_tax = $0;

     initprogress(NRecords(repbrokopers),"ÇÎØ„·™ Æ‚Á•‚†","ÇÎØ„·™ Æ‚Á•‚†");
     while (next(repbrokopers))
         NewRep = false;

         Date_Changed = (repbrokopers.op_date != last_date);
         DprtID_Changed = (repbrokopers.Department != last_DprtID);
         CFI_Changed = (repbrokopers.CFI != last_CFI);
         AvoirKind_Changed = (repbrokopers.AvoirKind != last_AvoirKind);
         BondKind_Changed = (repbrokopers.BondKind != last_BondKind);

         last_date = repbrokopers.op_date;
         last_DprtID = repbrokopers.Department;
         last_CFI = repbrokopers.CFI;
         last_AvoirKind = repbrokopers.AvoirKind;
         last_BondKind = repbrokopers.BondKind;

         if ( Date_Changed OR DprtID_Changed OR CFI_Changed OR AvoirKind_Changed OR BondKind_Changed)

            NewRep = true;
            last_FIID = -1;

            DprtName = GetDprtName(repbrokopers.Department);
            èÆ´„Á®‚Ïî®≠à≠ ( repbrokopers.CFI, fin );
            ValName = fin.Name;
            if ( FI_IsBond(repbrokopers.FIID) )
               BondKindName= AvoirKindName(repbrokopers.AvoirKind);
               AvrKindName = GetNameBondKind( repbrokopers.BondKind );
               ValCode = "(%)";
            else
               BondKindName = "";
               ValCode = "("+fin.Ccy+")";
               AvrKindName = AvoirKindName(repbrokopers.AvoirKind);
            end;

            äÆ¨®··®Ô = "°®‡¶•/°‡Æ™•‡„";

            if ( i != 0 )
               Merge( "N1_A1", "N1_A4", null);
               PrintTableLine( "N1_A1", "Ç·•£Æ ß† §•≠Ï",                               null,
                               "N1_A5", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_sum),                    null,
                               "N1_A6", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_nkd),                    null,
                               "N1_A7", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_bank_comm)),  null,
                               "N1_A8", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_micex_comm)), null
                             );
               EndTable();
               CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
               AddStandardFooter( "N1_" );
               CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );

               tot_sum = 0;
               tot_nkd = 0;
               tot_bank_comm = 0;
               tot_micex_comm = 0;
               tot_tax = 0;   
            end;

           PrintFormatString( null,
                              "N1_H0_1", BankName, 
                              "N1_H0_2", DprtName,
                              "N1_H0_3", ValName, 
                              "N1_H0_4", AvrKindName,
                              "N1_H0_5", BondKindName, 
                              "N1_H0_6", "äÆ¨®··®Ô" + " " + äÆ¨®··®Ô
                            );
           CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader", 0 );

           RegisterTable( "N1_MainTable", null,
                    "N1_A1",
                    "N1_A2",
                    "N1_A3",
                    "N1_A4",
                    "N1_A5",
                    "N1_A6",
                    "N1_A7",
                    "N1_A8"
                  );

           Merge( "N1_A1", "N1_A8", null);
           PrintTableLine( "N1_A1", date_as_string(1,repbrokopers.op_date), null );
           Merge( "N1_A1", "N1_A8", null);
           PrintTableLine( "N1_A1", repbrokopers.lsin, null );
         end;

         FIID_changed = (repbrokopers.FIID != last_FIID);
         last_FIID = repbrokopers.FIID;

         if( FIID_changed AND (NOT NewRep) )
           Merge( "N1_A1", "N1_A8", null);
           PrintTableLine( "N1_A1", repbrokopers.lsin, null );
         end;

         useprogress(i);

         èÆ´„Á®‚Ïî®≠à≠ ( repbrokopers.CFI, fin );
         if ( FI_IsBond(repbrokopers.FIID) )
            ValCode = "%";
         else
            ValCode = fin.Ccy;
         end;

         if( IsApp == true )
           Parm = "a";
         else  
           Parm = "";
         end;  

        PrnPrice = ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(repbrokopers.Price,repbrokopers.Point,Parm);
        PrnNkd = ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(repbrokopers.nkd);

        if( repbrokopers.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE )
           _fininstr.fiid = repbrokopers.fiid;
           PrnNkd = "";
           if (repbrokopers.Price == 0) 
              PrnPrice = "";
              ValCode = "";
           end;
           if (repbrokopers.amount == 0)
              PrnAmount = "";
           else
              if(GetEQ(_fininstr))
                 if( IsApp == true ) 
                    PrnAmount = String(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ( repbrokopers.amount, _fininstr.sumprecision, "a"));
                 else  
                    PrnAmount = String(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ( repbrokopers.amount, _fininstr.sumprecision, ""));   
                 end;  
              else
                 PrnAmount = String( Floor_Money( repbrokopers.amount:a ) );
              end;
           end;
        else
           if( IsApp == true )
              PrnAmount = String( Floor_Money( repbrokopers.amount:a ) );
           else  
              PrnAmount = String( Floor_Money( repbrokopers.amount) );   
           end;  
        end;

        PrintTableLine( "N1_A1", repbrokopers.client_code,                                null,
                        "N1_A2", repbrokopers.indoc_id,                                   null,
                        "N1_A3", PrnAmount,                                               null,
                        "N1_A4", PrnPrice + ValCode,                                      null,
                        "N1_A5", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(repbrokopers.sum),                     null,
                        "N1_A6", PrnNkd,                                                  null,
                        "N1_A7", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*repbrokopers.client_comm)), null,
                        "N1_A8", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*repbrokopers.micex_comm)),  null
                      );

        tot_sum = tot_sum + repbrokopers.sum;
        tot_nkd = tot_nkd + repbrokopers.nkd;
        tot_bank_comm = tot_bank_comm + repbrokopers.client_comm;
        tot_micex_comm = tot_micex_comm + repbrokopers.micex_comm;
        tot_tax = tot_tax + repbrokopers.client_tax;   
        i = i + 1;
     end;

     if ( i == 0 )
          PrintFormatString( null, "N1_ReportRunFalse", "ç•‚ §†≠≠ÎÂ, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†." );
          CopyAllSheetInTotalBook( NULL, false, "N1_ReportRunFalse", 1 );
          return;
     else
        if(brokopers.avoirkind == AVOIRISSKIND_INVESTMENT_SHARE)
           prn_tot_sum = "";
        else
           prn_tot_sum = ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_nkd);
        end;

     Merge( "N1_A1", "N1_A4", null);
     PrintTableLine( "N1_A1", "Ç·•£Æ ß† §•≠Ï",                               null,
                     "N1_A5", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(tot_sum),                    null,
                     "N1_A6", prn_tot_sum,                                   null,
                     "N1_A7", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_bank_comm)),  null,
                     "N1_A8", ë‰Æ‡¨®‡Æ¢†‚Ïë„¨¨„(money(sign*tot_micex_comm)), null
                   );
     EndTable();
     CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );

         /* è•Á†‚†•¨ Ø‡Æ‚Æ™Æ´. */
         if( Data.UniqStr.Size > 0 )
            PrintArray( Data );
         end;
         AddStandardFooter( "N1_" );
         CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );
     end;
     remprogress();
  END;

  PRIVATE MACRO Create()
     report_rec(Data);
  END;

  initDL_CReportTemplate( NULL, "Report_SpbrOp.xls" );
END;

macro brokops (EmiID,     /* ID Ì¨®‚•≠‚†        */
               DprtID,    /* ID ‰®´®†´†         */
               BegDate,
               EndDate,
               FIID,      /*ID Ê•≠≠Æ© °„¨†£®    */
               AvoirKind, /*¢®§ Ê•≠≠Æ© °„¨†£®   */
               IDSort,    /*ID ¢®§† Æ°´®£†Ê®®   */ 
               CFI,       /*ID ¢†´Ó‚Î ‡†·Á•‚Æ¢  */
               _IsApp,
               IsExcel
              )

     Data = ReportData( EmiID, DprtID, BegDate, EndDate,
                            FIID, AvoirKind, IDSort, CFI
                          );
     Dl_CallInsertStat(IIF(IsExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD));
     ClearGlobalTmp( "dbrokops_tmp" );
     
     if (BegDate > EndDate)
          runerror("ç•¢•‡≠Æ ß†§†≠ ®≠‚•‡¢†´ §†‚");
     end;         
     
     IsApp = _IsApp;

     fill_deals(Data);
     if(IsExcel)
        SP_SpbrOp_Report().Run(null, Data.AuditMsg());
        exit(1);
     else
     report_rec(Data);
end;

end; 

OnError
     DepoSubAcc_FindClose;
     DepoAcc_FindClose;
     RunError;
end;
