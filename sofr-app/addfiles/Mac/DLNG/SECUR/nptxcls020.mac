/* 
$Name:        nptxcls020.mac
$Module:      Ценные бумаги
$Description: Операция закрытия налоговых периодов для НДФЛ. Шаг закрытия
*/

IMPORT "secinter.mac", "nptxfun.mac", "SpRepFun.mac";


macro ExecuteStep( Doc, FDoc, DocKind, OperationID )
  record nptxop("nptxop");
  var stat = 0;

  SetBuff( nptxop, FDoc );

  if (nptxop.Client > 0)

    stat = DL_SetCalcPeriodDate(NPTXCALC_CLOSE, nptxop.Client, nptxop.OperDate, 0, UNSET_CHAR);

    if(not stat)
      stat = DL_SetCalcPeriodDate(NPTXCALC_CLOSE, nptxop.Client, nptxop.OperDate, 0, SET_CHAR);
    end;

  else

    var Query = DL_RSDCommand();

    var DataSet = Query.Execute("SELECT DISTINCT T_CLIENT FROM DNPTXOP_dbt WHERE T_DOCKIND = 4605");

    while (DataSet.moveNext())

      stat = DL_SetCalcPeriodDate(NPTXCALC_CLOSE, DataSet.Client, nptxop.OperDate, 0, UNSET_CHAR);

      if(not stat)
        stat = DL_SetCalcPeriodDate(NPTXCALC_CLOSE, DataSet.Client, nptxop.OperDate, 0, SET_CHAR);
      end;

    end;

  stat = 0;

  end;

  return stat;
end;