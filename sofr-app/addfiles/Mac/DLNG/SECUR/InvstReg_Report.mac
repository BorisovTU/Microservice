/*
$Name:             InvstReg_Report.mac
$Module:           Äêçì
$Description:      é‚Á•‚ "ê†ß¨•È•≠≠Î• Ê•≠≠Î• °„¨†£®"
*/

IMPORT "InvstReg_Form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "sprepfun.mac", "spCache.mac", "cb_sql.mac", "oralib", "ws_txreportform.mac";

PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR   InvstReg_Form;
PRIVATE VAR   InvstReg_Report;
PRIVATE VAR   WebMenuItem; // à≠‰Æ‡¨†Ê®Ô Æ ß†Ø„·™• Æ‚Á•‚† ®ß ¢•°

PRIVATE VAR ReportHeader =
"ñ•≠≠Î• °„¨†£®, ‡†ß¨•È•≠≠Î• ≠† Æ‚Á•‚≠„Ó §†‚„\n" +
"Ç®§ ·§•´™® ‡†ß¨•È•≠®Ô:   ####################\n" +
"ë§•´™† ‡†ß¨•È•≠®Ô:       ####################\n" +
"Ñ†‚†:                    ##########\n" +
"É‡„ØØ† ≠†´Æ£Æ¢Æ£Æ „Á•‚†: #################################################################\n" +
"Ç®§ Ê/°:                 #################################################################\n" +
"ÇÎØ„·™ Ê/°:              #################################################################\n";

PRIVATE VAR TableHeader =                                                                                                                                                                                                        
"⁄ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
"≥ ç†´Æ£Æ¢†Ô ≥  äÆ§ Ê•≠≠Æ©  ≥  ÇÎØ„·™ Ê•≠≠Æ©  ≥    çÆ¨•‡ ·§•´™®    ≥  äÆ§  ≥  è‡®ß≠†™   ≥   Ñ†‚†    ≥   Ñ†‚†    ≥ äÆ´®Á•·‚¢Æ ≥  äÆ§   ≥  äÆ§   ≥     ñ•≠†     ≥    ë‚Æ®¨Æ·‚Ï   ≥çäÑ „Ø´†Á•≠≠Î©≥   äÆ¨®··®Ô,  ≥    çÆ¨•‡ ·§•´™®    ≥  äÆ§  ≥ Ñ†‚† 1©  ≥   Ñ†‚†   ≥ Ñ†‚† 2©  ≥ êÎ≠ÆÁ≠†Ô ™Æ‚®‡Æ¢™† ≠† Æ‚Á•‚≠„Ó §†‚„, ≥é‚¨•‚™† Æ   ≥  Éé/‰®´®´†´(§´Ô    ≥  ISIN (≠Æ¨•‡    ≥\n"+
"≥   £‡„ØØ†  ≥    °„¨†£®    ≥     °„¨†£®      ≥    Ø‡®Æ°‡•‚•≠®Ô    ≥·§•´™® ≥ ·‡ÆÁ≠Æ·‚®  ≥ ß†™´ÓÁ•≠®Ô≥ Ø•‡•ÂÆ§†  ≥   Ê•≠≠ÎÂ   ≥ ¢†´Ó‚Î ≥ ¢†´Ó‚Î ≥ Ø‡®Æ°‡•‚•≠®Ô ≥  Ø‡®Æ°‡•‚•≠®Ô  ≥      Ø‡®     ≥  „Ø´†Á•≠≠†Ô  ≥     ‡†ß¨•È•≠®Ô     ≥·§•´™® ≥  Á†·‚®   ≥‡†ß¨•È•≠®Ô≥  Á†·‚®   ≥       ·´Æ¶®¢Ë. ≠† éêñÅ               ≥¢Æß¨Æ¶≠Æ·‚® ≥·§•´™® Ø‡®Æ°‡•‚•≠®Ô)≥ £Æ·„§†‡·‚¢•≠≠Æ© ≥\n"+
"≥           ≥              ≥                 ≥      (ØÆ´≠Î©)      ≥Ø‡®Æ°‡.≥   ·§•´™®   ≥  ·§•´™®   ≥ ·Æ°·‚¢-‚® ≥   °„¨†£,   ≥≠Æ¨®≠†´†≥  Ê•≠Î  ≥              ≥                ≥ Ø‡®Æ°‡•‚•≠®® ≥Ø‡® Ø‡®Æ°‡•‚•-≥                    ≥ ‡†ß¨. ≥(ØÆ ØÆ·‚.)≥Ø‡®Æ°‡•‚•≠≥(ØÆ ØÆ·‚.)≥                                      ≥¢ÎØ´†‚ ØÆ   ≥                    ≥ ‡•£®·‚‡†Ê®®)    ≥\n"+
"≥           ≥              ≥                 ≥                    ≥       ≥            ≥    ≠†     ≥    Ø‡®    ≥     Ë‚.    ≥        ≥        ≥              ≥                ≥              ≥  ≠®®, ‡„°.   ≥                    ≥(êè,áé)≥          ≥ ¢ ·§•´™• ≥          √ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¥†¨Æ‡‚®ß†Ê®® ≥                    ≥                 ≥\n"+
"≥           ≥              ≥                 ≥                    ≥       ≥            ≥Ø‡®Æ°‡•‚•- ≥Ø‡®Æ°‡•‚•≠.≥            ≥        ≥        ≥              ≥                ≥              ≥ (≠• ¢™´ÓÁ†Ô  ≥                    ≥       ≥          ≥          ≥          ≥   ñ•≠†    ≥   à·‚ÆÁ≠®™  ≥    Ñ†‚†    ≥§Æ´£†       ≥                    ≥                 ≥\n"+
"≥           ≥              ≥                 ≥                    ≥       ≥            ≥  ≠®• ñÅ   ≥    ñÅ     ≥            ≥        ≥        ≥              ≥                ≥              ≥     çÑë)     ≥                    ≥       ≥          ≥          ≥          ≥           ≥  ®≠‰Æ‡¨†Ê®® ≥  ™Æ‚®‡Æ¢™® ≥(1-§†,0-≠•‚)≥                    ≥                 ≥\n"+
"√ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n"+
"≥     1     ≥      2       ≥        3        ≥          4         ≥   5   ≥      6     ≥     7     ≥     8     ≥      9     ≥   10   ≥   11   ≥      12      ≥       13       ≥      14      ≥      15      ≥         16         ≥   17  ≥    18    ≥    19    ≥    20    ≥     21    ≥     22      ≥     23     ≥     24     ≥         25         ≥         26      ≥\n"+
"√ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

PRIVATE CLASS (DL_CReportTemplate) SP_InvstReg_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )

  PRIVATE VAR m_LastGetRezMrkt_Result = false, m_LastGetRezMrkt_FIID = -1, m_LastGetRezMrkt_CalcDate = DATE(0,0,0);
  PRIVATE VAR m_DMrktRez, m_RezMrkt, m_MrktRez;
  VAR m_CacheFinInstr = TX_CacheFinInstr();
  var m_RetVal;
  var Qnty = 0;

  PRIVATE VAR m_IsDataExist = false; /*§´Ô Web, •·´® ≠•‚ §†≠≠ÎÂ, ‚Æ ≠®Á•£Æ ≠• ØÆ™†ßÎ¢†•¨*/
/* ≠• ØÆ™†ßÎ¢†‚Ï Ø„·‚Î• Æ‚Á•‚ ¢ Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*¢ EW ØÆ™†ßÎ¢†•¨ ´®·‚Î ¢·•£§†*/
    end;
  END; 

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintLine( P1,P2,P3,P4,P5,P6,P7,P8,P9,SumPrecision,P10,P11,P12,P13,P14,P15,P16,P17,P18,P19,P20,P21,P22,P23,P24,P25,P26 )
     this.SetCurrentLineFont( 8, false, false );
     this.PrintTableLine( "N1_SecType",   P1,                     null,
                          "N1_SecCode",   P2,                     null,
                          "N1_SecName",   P3,                     null,
                          "N1_CodeB",     P4,                     null,
                          "N1_TypeB",     P5,                     null,
                          "N1_isTime",    P6,                     null,
                          "N1_DZB",       P7,                     null,
                          "N1_DDB",       P8,                     null,
                          "N1_Qnty",      double(P9),             Int(SumPrecision),
                          "N1_VN",        P10,                    null,
                          "N1_VPrB",      P11,                    null,
                          "N1_PrBvpr",    P12,                    null,
                          "N1_SumBvpr",   P13,                    null,
                          "N1_NkdBvp",    IIF(P14 > 0, P14, " "), null,
                          "N1_ComB",      P15,                    null,
                          "N1_CodeDR",    P16,                    null,
                          "N1_TypeDR",    P17,                    null,
                          "N1_DD1DR",     P18,                    null,
                          "N1_Dlink",     P19,                    null,
                          "N1_DD2DR",     P20,                    null,
                          "N1_RezMrkt",   P21,                    null, 
                          "N1_MrktRez",   P22,                    null,
                          "N1_DMrktRez",  P23,                    null,
                          "N1_ifAmort",   P24,                    null,
                          "N1_FilB",      P25,                    null,
                          "N1_ISIN",      P26,                    null
                        );
  END;

  PRIVATE MACRO BeginReport()
     VAR Month, Year, INN, KPP,
         GroupNameShowValue = "",
         InvstKindShowValue = "",
         DealCodeShowValue = "",
         AvrKindShowValue = "";
     InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_INVSTKIND, @InvstKindShowValue );
     InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_INVSTDEAL, @DealCodeShowValue );
     InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRGROUP, @GroupNameShowValue );
     InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRKIND, @AvrKindShowValue );

     this.SetActiveSheet( "ê†ß¨•È•≠®•" );

     this.PrintFormatString( ReportHeader,
                     "N1_H0_1", InvstKindShowValue,
                     "N1_H0_2", DealCodeShowValue,
                     "N1_H0_3", InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_ENDDATE ),
                     "N1_H0_4", GroupNameShowValue,
                     "N1_H0_5", AvrKindShowValue,
                     "N1_H0_6", InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRNAME )
                   );

     this.RegisterTable( "N1_MainTable", TableHeader,
             /*1  */     "N1_SecType",
             /*2  */     "N1_SecCode",
             /*3  */     "N1_SecName",
             /*4  */     "N1_CodeB",
             /*5  */     "N1_TypeB",
             /*6  */     "N1_isTime",
             /*7  */     "N1_DZB",
             /*8  */     "N1_DDB",
             /*9  */     "N1_Qnty",
             /*10 */     "N1_VN",
             /*11 */     "N1_VPrB",
             /*12 */     "N1_PrBvpr",
             /*13 */     "N1_SumBvpr",
             /*14 */     "N1_NkdBvp",
             /*15 */     "N1_ComB",
             /*16 */     "N1_CodeDR",
             /*17 */     "N1_TypeDR",
             /*18 */     "N1_DD1DR",
             /*19 */     "N1_Dlink",
             /*20 */     "N1_DD2DR",
             /*21 */     "N1_RezMrkt",
             /*22 */     "N1_MrktRez",
             /*23 */     "N1_DMrktRez",
             /*24 */     "N1_ifAmort",
             /*25 */     "N1_FilB",
             /*26 */     "N1_ISIN"
                       );      

  END;

  MACRO è•Á†‚†‚Ïè‡Æ¨•¶„‚ÆÁ≠Î•à‚Æ£®()

     SetSubtotal(12, 11 + MAXROWSHEET,
                 "I8",      
                 "M8",    
                 "N8",      
                 "O8"
                 );
  END;


  PRIVATE MACRO EndReport()
     this.EndTable();
     è•Á†‚†‚Ïè‡Æ¨•¶„‚ÆÁ≠Î•à‚Æ£®();
     this.AddStandardFooter( "N1_" );
  END;

  PRIVATE MACRO GetRezMrkt():BOOL
     VAR DataSet, CurrentNominal, MinCourse, SPParams:TArray = TArray();
     VAR ValidFromDate = DATE(0,0,0), NumInList;
     var IsBond = false;
     var Select;
     VAR EndDate = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_ENDDATE );

     if( (m_LastGetRezMrkt_Result   == true) AND 
         (m_LastGetRezMrkt_FIID     == m_RetVal.FIID) AND 
         (m_LastGetRezMrkt_CalcDate == EndDate) 
       )
        return m_LastGetRezMrkt_Result;
     end;

     IsBond = FI_IsBond(m_RetVal.t_FIID);
     
     /*¨®≠®¨†´Ï≠Æ• ß≠†Á•≠®• ®ß ¢·•Â ™„‡·Æ¢ ¢®§† "·‡•§≠•¢ß¢•Ë•≠≠†Ô Ê•≠†" ≠† §†‚„ <DRez>, ≠Æ Ì‚† §†‚† §Æ´¶≠† °Î‚Ï ≠• ‡†≠••, Á•¨ ß† Æ§®≠ £Æ§ §Æ <DRez>.*/
     SPParams[0] = SQLParam( "pFromFI"   , m_RetVal.t_FIID            );
     SPParams[1] = SQLParam( "pToFI"     , m_RetVal.t_FaceValueFI     );
     SPParams[2] = SQLParam( "pType"     , 4                    );
     SPParams[3] = SQLParam( "pDate"     , EndDate              );
     SPParams[5] = SQLParam( "pRateID"   , V_INTEGER, RSDBP_OUT );
     SPParams[6] = SQLParam( "pSinceDate", V_DATE,    RSDBP_OUT );
     SPParams[7] = SQLParam( "pMarketCountry", "" ); //≠† ´Ó°ÎÂ °®‡¶†Â
     SPParams[8] = SQLParam( "pIsForeignMarket", 0); //≠† ´Ó°ÎÂ °®‡¶†Â

     if(EndDate <= date(31,12,2009))
       SPParams[4] = SQLParam( "pNMonths", 12);
     else
       SPParams[4] = SQLParam( "pNMonths", 3);
     end;

     if(IsBond)
       SPParams[9] = SQLParam( "pOnlyRate", 1);
     else
       SPParams[9] = SQLParam( "pOnlyRate", 0);
     end;

     MinCourse   = execStoredFunc( "RSB_FIInstr.FI_GetMinRateMonth", V_DOUBLE, SPParams );

     if( (EndDate > date(31,12,2009)) and (not ((MinCourse != NULL) and (MinCourse > 0))) ) //•·´® ≠† ‡Æ··®©·™Æ© °®‡¶• ™„‡·† ≠• ≠†Ë´®
       //‚Æ Ø‡Æ¢Æ§®‚·Ô ØÆ®·™ ·‡•§® ™„‡·Æ¢ "Ê•≠† ß†™‡Î‚®Ô" ®≠Æ·‚‡†≠≠ÎÂ °®‡¶ ß† ‚Æ‚ ¶• Ø•‡®Æ§
       SPParams.size = 0;
       SPParams[0] = SQLParam( "pFromFI"   , m_RetVal.t_FIID            );
       SPParams[1] = SQLParam( "pToFI"     , m_RetVal.t_FaceValueFI     );
       SPParams[2] = SQLParam( "pType", 18); //"Ê•≠† ß†™‡Î‚®Ô"
       SPParams[3] = SQLParam( "pDate"     , EndDate     );
       SPParams[5] = SQLParam( "pRateID"   , V_INTEGER, RSDBP_OUT );
       SPParams[6] = SQLParam( "pSinceDate", V_DATE,    RSDBP_OUT );
       SPParams[7] = SQLParam( "pMarketCountry", "" ); //≠† ´Ó°ÎÂ °®‡¶†Â
       SPParams[8] = SQLParam( "pIsForeignMarket", 0); //≠† ´Ó°ÎÂ °®‡¶†Â

       if(EndDate <= date(31,12,2009))
         SPParams[4] = SQLParam( "pNMonths", 12);
       else
         SPParams[4] = SQLParam( "pNMonths", 3);
       end;

       if(IsBond)
         SPParams[9] = SQLParam( "pOnlyRate", 1);
       else
         SPParams[9] = SQLParam( "pOnlyRate", 0);
       end;

       MinCourse   = execStoredFunc( "RSB_FIInstr.FI_GetMinRateMonth", V_DOUBLE, SPParams );
     end;

     if( MinCourse != NULL and (MinCourse > 0) )
          
          Select = RSDCommand(" SELECT rate.t_IsRelative, " +
                              "        (CASE WHEN rate.t_Market_Place > 0 THEN (SELECT pt.t_ShortName FROM dparty_dbt pt WHERE pt.t_PartyID = rate.t_Market_Place) ELSE CHR(1) END) as Market_Place_ShortName " +
                              "   FROM dratedef_dbt rate " +
                              "  WHERE rate.t_RateID = ? "
                             );
          
          Select.addParam( "", RSDBP_IN, string(SPParams.value(5).value) );
          Select.execute();
          
          DataSet = TRsbDataSet( Select );
          if( DataSet.MoveNext() )
             m_DMrktRez = SQL_ConvTypeDate( SPParams.value(6).value );
             m_MrktRez  = DataSet.Market_Place_ShortName;
             m_RezMrkt  = MinCourse;

             m_LastGetRezMrkt_Result   = true;
             m_LastGetRezMrkt_FIID     = m_RetVal.t_FIID;
             m_LastGetRezMrkt_CalcDate = EndDate;

             return m_LastGetRezMrkt_Result;
          end;
       end;

     /*≠•‚ ØÆ§ÂÆ§ÔÈ•£Æ ™„‡·† */
     m_DMrktRez = DATE(0,0,0);
     m_RezMrkt  = 0; 
     m_MrktRez  = "";

     m_LastGetRezMrkt_Result = false;

     return m_LastGetRezMrkt_Result;
  END;

  MACRO RezMrkt():MONEY
    return m_RezMrkt;
  END;
 
  MACRO MrktRez():STRING
    return m_MrktRez;
  END;
 
  MACRO DMrktRez():DATE
    return m_DMrktRez;
  END;

  PRIVATE MACRO GetSumSCTXLSOnDate(LnkID)
    var Select, DataSet;
    var Sum = 0;

    Select = RSDCommand( "SELECT rsb_sctx.TXGetSumSCTXLSOnDate(?, ?) as SumOnDate FROM DUAL" );

    Select.AddParam("",   RSDBP_IN, LnkID );  /*1*/
    Select.AddParam("",   RSDBP_IN, InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_ENDDATE ) );  /*1*/

    Select.Execute();

    DataSet = TRsbDataSet(Select);
    if(DataSet.moveNext())
      Sum = DataSet.SumOnDate;
    end;

    return Sum;
  END;

  PRIVATE MACRO Get_str_PaymDateBuy(Type, DealPart)
     var sql_PlanDate:String = 
        " (NVL( (SELECT min(dlrq.t_PlanDate) " +
        "  FROM ddlrq_dbt dlrq " + 
        "  WHERE dlrq.t_DocKind    = tick.t_BOfficeKind " +
        "     AND dlrq.t_DocID = tick.t_DealID " +
        "     AND dlrq.t_Type    = " + string(Type) + 
        "     AND dlrq.t_DealPart    = " + string(DealPart) + 
        "     AND dlrq.t_FactDate = TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "     ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     var sql_FactDate:String = 
        " (NVL( (SELECT min(dlrq.t_FactDate) " +
        "  FROM ddlrq_dbt dlrq " + 
        "  WHERE dlrq.t_DocKind    = tick.t_BOfficeKind " +
        "     AND dlrq.t_DocID = tick.t_DealID " +
        "     AND dlrq.t_Type    = " + string(Type) + 
        "     AND dlrq.t_DealPart    = " + string(DealPart) + 
        "     AND dlrq.t_State = " + string(DLRQ_STATE_EXEC) +
        "     AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "     ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     return 
        " (DECODE( " +
             sql_FactDate + ", " +                   // ÇÎ‡†¶•≠®•
        "    TO_DATE('01-01-0001','DD-MM-YYYY'), " + // search1
             sql_PlanDate + ", " +                   // result1
             sql_FactDate + ") " +                   // default
        " ) ";
  END;

  PRIVATE MACRO Create()
     macro GetSQLQuery()
       var AvoirKindList = null;
       var AvoirKindAddWhere : String = "";
       var AvoirKindCount : Integer = 0;
       var FIIDList = null;
       var FIIDCount : Integer = 0;
       var FIIDAddWhere : String = "";
       var AvrGroupList = null;
       var AvrGroupCount : Integer = 0;
       var AvrGroupAddWhere : String = "";
       var DealsType = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_INVSTKIND );
       var DealIDList = null;
       var DealIDCount : Integer = 0;
       var DealIDAddWhere : String = "";
       var EndDate = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_ENDDATE );
       var sqlQuery : String = "";

       if( not m_IsWebService )
          AvoirKindList = TArray();
          AvoirKindList[AvoirKindList.Size] = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRKIND );
       else
          AvoirKindList = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRKIND );
       end;
       if( ( ValType( AvoirKindList ) != V_UNDEF ) and ( AvoirKindList.Size > 0 ) )
          while( AvoirKindCount < AvoirKindList.Size )
             if( ( ValType( AvoirKindList[AvoirKindCount] ) == V_INTEGER )
             and ( AvoirKindList[AvoirKindCount] > 0 ) )
                if( AvoirKindAddWhere == "" )
                   AvoirKindAddWhere = AvoirKindAddWhere + " ( ";
                else
                   AvoirKindAddWhere = AvoirKindAddWhere + " OR ";
                end;
                AvoirKindAddWhere = AvoirKindAddWhere + " RSB_FIInstr.FI_AvrKindsEQ(2, " + String( AvoirKindList[AvoirKindCount] ) + ", fi.t_AvoirKind) = 1 ";
             end;
             AvoirKindCount = AvoirKindCount + 1;
          end;
          if( AvoirKindAddWhere != "" )
             AvoirKindAddWhere = AvoirKindAddWhere + " ) AND ";
          end;
       end;

       if( not m_IsWebService )
          FIIDList = TArray();
          FIIDList[FIIDList.Size] = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRCODE );
       else
          FIIDList = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRCODE );
       end;
       if( ( ValType( FIIDList ) != V_UNDEF ) and ( FIIDList.Size > 0 ) )
          while( FIIDCount < FIIDList.Size )
             if( ( ValType( FIIDList[FIIDCount] ) == V_INTEGER )
             and ( FIIDList[FIIDCount] > 0 ) )
                if( FIIDAddWhere == "" )
                   FIIDAddWhere = FIIDAddWhere + " ( ";
                else
                   FIIDAddWhere = FIIDAddWhere + " OR ";
                end;
                FIIDAddWhere = FIIDAddWhere + " fi.t_FIID = " + String( FIIDList[FIIDCount] ) + " ";
             end;
             FIIDCount = FIIDCount + 1;
          end;
          if( FIIDAddWhere != "" )
             FIIDAddWhere = FIIDAddWhere + " ) AND ";
          end;
       end;

       if( not m_IsWebService )
          DealIDList = TArray();
          DealIDList[DealIDList.Size] = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_INVSTDEAL );
       else
          DealIDList = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_INVSTDEAL );
       end;
       if( ( ValType( DealIDList ) != V_UNDEF ) and ( DealIDList.Size > 0 ) )
          while( DealIDCount < DealIDList.Size )
             if( ( ValType( DealIDList[DealIDCount] ) == V_INTEGER )
             and ( DealIDList[DealIDCount] > 0 ) )
                if( DealIDAddWhere == "" )
                   DealIDAddWhere = DealIDAddWhere + " ( ";
                else
                   DealIDAddWhere = DealIDAddWhere + " OR ";
                end;
                DealIDAddWhere = DealIDAddWhere + " " + String( DealIDList[DealIDCount] ) + " in ( lnk.t_BuyID, lnk.t_SourceID, lnk.t_SaleID, lnk.t_DestID, lnk.t_Lot1ID, lnk.t_Lot2ID ) ";
             end;
             DealIDCount = DealIDCount + 1;
          end;
          if( DealIDAddWhere != "" )
             DealIDAddWhere = DealIDAddWhere + " ) AND ";
          end;
       end;

       if( not m_IsWebService )
          AvrGroupList = TArray();
          AvrGroupList[AvrGroupList.Size] = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRGROUP );
       else
          AvrGroupList = InvstReg_Form.GetFieldValue( PNFLD_INVSTREG_AVRGROUP );
       end;
       if( ( ValType( AvrGroupList ) != V_UNDEF ) and ( AvrGroupList.Size > 0 ) )
          while( AvrGroupCount < AvrGroupList.Size )
             if( ( ValType( AvrGroupList[AvrGroupCount] ) == V_INTEGER )
             and ( AvrGroupList[AvrGroupCount] > 0 ) )
                if( AvrGroupAddWhere == "" )
                   AvrGroupAddWhere = AvrGroupAddWhere + " ( ";
                else
                   AvrGroupAddWhere = AvrGroupAddWhere + " OR ";
                end;
                AvrGroupAddWhere = AvrGroupAddWhere + " av.t_TaxGroup = " + String( AvrGroupList[AvrGroupCount] ) + " ";
             end;
             AvrGroupCount = AvrGroupCount + 1;
          end;
          if( AvrGroupAddWhere != "" )
             AvrGroupAddWhere = AvrGroupAddWhere + " ) AND ";
          end;
       end;

           sqlQuery = "select fi.t_FI_Code, fi.t_Name, fi.t_SumPrecision, fi.t_FIID, av.t_TaxGroup, " +
                      "       (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) AS t_ISIN, " +
                      "       buylot.t_DealCodeTS as CodeB, " + 
                      "       buylot.t_Type as TypeB," +
                      "       DECODE (currbuylot.t_type, "+TXLOTS_SALE+", currbuylot.t_begsaledate, "+
                                                           TXLOTS_LOANPUT+", currbuylot.t_begsaledate, "+
                                                           TXLOTS_REPO+", currbuylot.t_begsaledate, currbuylot.t_begbuydate ) as DDB, " +  //èÆ´• "§†‚† §´Ô ·Æ‡‚®‡Æ¢™®" ´Æ‚† ØÆ™„Ø™® ®ß ·¢Ôß® (≠• Ø„‚†‚Ï · ´Æ‚Æ¨ <CodeB>) - †≠†´Æ£®Á≠Æ dv_sctxdeal.t_SortDate"
                      "       buylot.t_DEALDATE as DZB, " +
                      "       lnk.t_Amount as Amount, lnk.t_ID as LnkID,"
                      "       buylot.t_PriceFIID as PriceFIID, " +
                      "       leg.t_Price as PrBvpr, " +
                      "       leg.t_Cost as DealCost, " +
                      "       leg.t_Principal as BuyQ, " +
                      "       salelot.t_DealCodeTS as CodeDR, " +
                      "       salelot.t_Type as TypeDR, " +
                      "       salelot.t_SaleDate as DD1DR, " +
                      "       lnk.t_Date as DLink, " +
                      "       (case when "+Get_str_PaymDateBuy(DLRQ_TYPE_DELIVERY, 2)+" > TO_DATE ('01.01.0001', 'DD.MM.YYYY') then "+Get_str_PaymDateBuy(DLRQ_TYPE_DELIVERY, 2)+" else DECODE(bleg.t_MaturityIsPrincipal, chr(88), bleg.t_Maturity, bleg.t_Expiry) end) AS DD2DR, " +
                      "       buytick.t_Department FilB, " +
                      "       buytick.t_BOfficeKind, " +
                      "       buytick.t_DealID, " +
                      "       fi.t_FIID, " +
                      "       fi.t_FaceValueFI, " +
                      "       leg.t_NKD as NkdBvp, " +

                      "       (CASE WHEN buylot.t_Type = " + string(TXLOTS_BUY)+ " AND rsb_sctx.DealIsTerm(buylot.t_DealID, buylot.t_FIID, buylot.t_BUYDATE) = 1 THEN 'ë' "+
                      "             ELSE CHR(0) END) as isTime, "+
                      
                   
                      "       Rsb_SCTX.TXGetComissionsSum(buytick.t_DealID,  buytick.t_BOfficeKind,  buylot.t_BuyDATE, 0) as CommBuy, " +

                      "       (CASE WHEN     RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", fi.t_AvoirKind) > 0 " +
                      "                  AND Exists(SELECT fiw.t_FIID " +
                      "                           FROM dfiwarnts_dbt fiw " +
                      "                          WHERE fiw.t_FIID         =  buylot.t_FIID AND " +
                      "                                fiw.t_IsPartial    = 'X'" +
                      "                         ) THEN 1 " +
                      "             ELSE 0 END) as ifAmort "

                      "  from dsctxlnk_dbt lnk, " +
                      "       dsctxlot_dbt buylot, " +
                      "       dsctxlot_dbt currbuylot, " +
                      "       ddl_tick_dbt tick, " +
                      "       ddl_leg_dbt leg, " +
                      "       ddl_leg_dbt bleg, " +
                      "       dsctxlot_dbt currsalelot, " +
                      "       dsctxlot_dbt salelot, " + 
                      "       ddl_tick_dbt buytick, " +
                      "       dfininstr_dbt fi, " +
                      "       davoiriss_dbt av " +
                      " where lnk.t_Type in (" + IIF( (DealsType == DL_INVST_ALL) or (DealsType == DL_INVST_REPO), string(TXLNK_DELREPO) + "," + string(TXLNK_SUBSTREPO), "0" ) + "," +
                                                  IIF( (DealsType == DL_INVST_ALL) or (DealsType == DL_INVST_LOAN), string(TXLNK_LOANPUT) + "," + string(TXLNK_SUBSTLOAN), "0" ) + ") and " +
                      DealIDAddWhere +
                      "       currbuylot.t_ID = lnk.t_BuyID and " +
                      "       buylot.t_ID = currbuylot.t_BegLotID and " +
                      "       currsalelot.t_ID = lnk.t_SaleID and " +
                      "       salelot.t_ID = currsalelot.t_BegLotID and " +
                      "       fi.t_FIID = buylot.t_FIID and " +
                      "       av.t_FIID = fi.t_FIID and " +
                      "       buytick.t_DealID = buylot.t_DealID and " +
                      "       tick.t_DealID = salelot.t_DealID and " +
                      "       leg.t_DealID = buytick.t_DealID and " +
                      "       leg.t_LegID = 0 and "                              
                      "       leg.t_LegKind = "+LEG_KIND_DL_TICK+" and " +
                      "       bleg.t_DealID = tick.t_DealID and " +
                      "       bleg.t_LegID = 0 and "
                      "       bleg.t_LegKind = decode(Rsb_Secur.IsLoan(Rsb_Secur.get_OperationGroup(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))), 1, "+LEG_KIND_DL_TICK+", "+LEG_KIND_DL_TICK_BACK+") and " +
                      AvoirKindAddWhere +
                      FIIDAddWhere +
                      AvrGroupAddWhere +
                      "       lnk.t_Date <= " + GetSQLDate( EndDate ) + " and " +
                      "       (lnk.t_BegDate = to_date('01.01.0001', 'DD.MM.YYYY') or lnk.t_BegDate <= " + GetSQLDate( EndDate ) + ") and " +
                      "       (lnk.t_EndDate = to_date('01.01.0001', 'DD.MM.YYYY') or lnk.t_EndDate > " + GetSQLDate( EndDate ) + ") and " +
                      "       (    currsalelot.t_BuyDate = to_date('01.01.0001', 'DD.MM.YYYY') " +
                      "         or currsalelot.t_BuyDate > " + GetSQLDate( EndDate ) + 
                      "       ) " +
                      " order by buylot.t_FIID, lnk.t_Date";
                  
           return sqlQuery;
     end;

     private macro GetTypeB( Type )
           if( Type == TXLOTS_BUY )
              return "B";
           elif( Type == TXLOTS_BACKREPO )
              return "PO";
           elif( Type == TXLOTS_LOANGET )
              return "áé";
           else
              return "";
           end;
     end;

     private macro GetTypeDR( Type )
           if( Type == TXLOTS_REPO )
              return "êè";
           elif( Type == TXLOTS_LOANPUT )
              return "áè";
           else
              return "";
           end;
     end;

     m_CacheFinInstr.Clear();
     T_Dep.ClearArray();

     var Paym;
     var SqlQuery = GetSQLQuery();
     var ProgressValue = CTxProgressValue();

     ProgressValue.Maximum = SQL_GetNRecs( SqlQuery );
     ProgressValue.Current = 0;

     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header = "îÆ‡¨®‡Æ¢†≠®• Æ‚Á•‚† " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum, HTML_StSheetName, HTML_StSheetName);
     end;

     m_RetVal = TRsbDataSet( SqlQuery );
     while( m_RetVal.MoveNext() )
         Qnty = m_RetVal.Amount - GetSumSCTXLSOnDate(m_RetVal.LnkID);
         
         if(Qnty > 0)
           Paym = RsbPayment( m_RetVal.BOfficeKind, m_RetVal.DealID, CAi, 0 );

           //êÎ≠ÆÁ≠†Ô ™Æ‚®‡Æ¢™†
           GetRezMrkt();

           m_IsDataExist = true;
           PrintLine(
                 /*1  */     m_RetVal.TaxGroup, //+
                 /*2  */     m_RetVal.FI_Code,  //+
                 /*3  */     m_RetVal.Name,     //+
                 /*4  */     m_RetVal.CodeB,    //+
                 /*5  */     GetTypeB(m_RetVal.TypeB), //+
                 /*6  */     m_RetVal.isTime,    //+
                 /*7  */     Date(m_RetVal.DZB), //+
                 /*8  */     Date(m_RetVal.DDB), //+
                 /*9  */     Qnty,      //+
                             m_RetVal.SumPrecision, 
                 /*10 */     m_CacheFinInstr.GetISO( m_RetVal.t_FaceValueFI ).m_Number,      //+
                 /*11 */     m_CacheFinInstr.GetISO( m_RetVal.PriceFIID ).m_Number, //+
                 /*12 */     m_RetVal.PrBvpr, //+
                 /*13 */     m_RetVal.DealCost * Qnty / m_RetVal.BuyQ, //+
                 /*14 */     Money(m_RetVal.NkdBvp * Qnty / m_RetVal.BuyQ), //+
                 /*15 */     Money(m_RetVal.CommBuy * Qnty / m_RetVal.BuyQ), //+
                 /*16 */     m_RetVal.CodeDR,         //+   
                 /*17 */     GetTypeDR(m_RetVal.TypeDR), //+
                 /*18 */     Date(m_RetVal.DD1DR),       //+
                 /*19 */     Date(m_RetVal.DLink),       //+
                 /*20 */     Date(m_RetVal.DD2DR),       //+
                 /*21 */     this.RezMrkt(),             //+
                 /*22 */     this.MrktRez(),             //+
                 /*23 */     this.DMrktRez(),            //+
                 /*24 */     m_RetVal.ifAmort,           //+
                 /*25 */     T_Dep.Get_Dep(m_RetVal.FilB),//+
                 /*26 */     m_RetVal.ISIN      //+

                       );
         end;
         ProgressValue.Current = ProgressValue.Current + 1;
         ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); // ¢·•£Æ 3 Ø†‡†¨•‡† Update(index, count, text)
     end;
     ProgressIndicator.Stop();
  END;
  
  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData     // : CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    InvstReg_Form = SP_InvstReg_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      InvstReg_Form = WS_TX_InvstReg_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = InvstReg_Form.Run();
    end;

    if( stat )
      InvstReg_Report = SP_InvstReg_Report( null , "report_txinvst.xls", true, IsWebService, ReportHashCode );
      InvstReg_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( InvstReg_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = InvstReg_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( InvstReg_Report.PrintMode() );
      end;
    end;
  end;

  return FullReportFileNames;
END;
