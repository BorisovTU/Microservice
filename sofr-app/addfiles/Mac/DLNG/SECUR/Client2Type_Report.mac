/*
$Name:        Client2Type_Report.mac
$Module:      Ценные бумаги
$Description: Базовый стандарт - Отчет о клиентах 2-го типа. Подготовка отчета
*/
import "Client2Type_Form.mac", "sprepfun.mac", "sqlconv.mac", "CbReport_h.mac", "scsrvrepfun.mac", "func_lib.mac";

PRIVATE CONST SQL_MAXDATE: String = GetSQLDate(date(31,12,9999));
PRIVATE CONST START_ROW_POS = 5;
PRIVATE CONST FORMULA = "formula=";

PRIVATE CLASS (DL_CReportTemplate) TRepCl2Type_Report(RepDate:date)
  private var m_RepDate = RepDate;

  PRIVATE MACRO BeginReport()
    SetActiveSheet("Отчет о клиентах 2-го типа");
  END;

  MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintRepHeader()
     PrintFormatString( NULL, "N1_RepDate", m_RepDate
                      );
  END;

  PRIVATE MACRO RegistrTable()
     RegisterTable( "N1_MainTable", "",
                    "N1_OprType",   
                    "N1_Client",    
                    "N1_ClientType",    
                    "N1_ContrNumber",   
                    "N1_DepoDoc", 
                    "N1_DepoAcc", 
                    "N1_DateConc",
                    "N1_DateChange",
                    "N1_TKS_Number",    
                    "N1_CFT_ID"
                  );
  END;

  PRIVATE MACRO FormulaCONCAT():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "CONCATENATE";
     else
        RetVal = "СЦЕПИТЬ";
     end;

     return RetVal;
  END;

  PRIVATE MACRO FormulaCHAR( num:integer ):string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "CHAR";
     else
        RetVal = "СИМВОЛ";
     end;

     return RetVal;
  END;

  PRIVATE MACRO EndReport()
    ReplaceAndCalculate( FORMULA, "=" );
  END;

  PRIVATE MACRO Create()
    var query, cmd, DataSet;
    var OperTypeName = "";
    var cnt = 0;
	var depoAccStr;
    var i = 0;
    
    query =   " select sf.t_Number as ContrNumber, sf.t_DateConc, pt.t_LegalForm, pt.t_Name as ClientName, "
            + "        rsb_secur.SC_GetObjCodeOnDate("+OBJTYPE_PARTY+","+PARTY_CODEKIND_ABS+", sf.t_PartyID) as CFT_ID, "
            + "        NVL((select dllp.t_DepoAcc "
            + "              from ddl_limitprm_dbt dllp "
            + "             where t_ID = (CASE WHEN mp.t_MarketID = "+MMVB_ID()+" THEN 6 ELSE 7 END) "
            + "             ), CHR(1)) as TKS_Number, "
            + "        NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote(" + OBJTYPE_BROKERCONTR_DL + ", LPAD(dlc.t_DlContrID, 34, '0'), 102, "+SQL_MAXDATE+")), CHR(1)) as DepoDoc, "
            + "        NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote(" + OBJTYPE_BROKERCONTR_DL + ", LPAD(dlc.t_DlContrID, 34, '0'), 104, "+SQL_MAXDATE+")), CHR(1)) as DepoAcc, "
            + "        NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote(" + OBJTYPE_BROKERCONTR_DL + ", LPAD(dlc.t_DlContrID, 34, '0'), (CASE WHEN mp.t_MarketID = "+MMVB_ID()+" THEN 106 ELSE 115 END), "+SQL_MAXDATE+")), CHR(1)) as DepoPart, "
            + "        NVL(DlcStat.t_AttrID, 0) as OperType_NewDBO, "
            + "        NVL((select 1 "
            + "              from dpmwrtcl_dbt wrtcl "
            + "             where wrtcl.t_Party = sf.t_PartyID "
            + "               and wrtcl.t_Contract = sf.t_ID "
            + "               and wrtcl.t_EndDate = " + SQL_MAXDATE
            + "               and wrtcl.t_Amount > 0 "
            + "               and ROWNUM = 1 " 
            + "            ), 0) as IsHaveSecurities, "
            + "        NVL(RCor.t_ValidFromDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')) as DateChange, "
            + "        NVL(RCor.t_AttrID, 0) as IsRCor "
            + "   from dsfcontr_dbt sf "
            + "        inner join ddlcontrmp_dbt mp on mp.t_SfContrID = sf.t_ID "
            + "        inner join ddlcontr_dbt dlc on dlc.t_DlContrID = mp.t_DlContrID "
            + "        inner join dparty_dbt pt on pt.t_PartyID = sf.t_PartyID "
            + "        left join dobjatcor_dbt DlcStat on    DlcStat.t_ObjectType  = " + OBJTYPE_BROKERCONTR_DL
            + "                                          and DlcStat.t_GroupID     = 101 " //Статус договора
            + "                                          and DlcStat.t_Object      = LPAD(dlc.t_DlContrID, 34, '0') " 
            + "                                          and DlcStat.t_General     = 'X' "
            + "                                          and DlcStat.t_AttrID      = 1 " //Да
            + "                                          and DlcStat.t_ValidFromDate = (select MAX(t.t_ValidFromDate) "
            + "                                                                           from dobjatcor_dbt t "
            + "                                                                          where t.t_ObjectType     = DlcStat.t_ObjectType "
            + "                                                                            and t.t_GroupID        = DlcStat.t_GroupID "
            + "                                                                            and t.t_Object         = DlcStat.t_Object "
            + "                                                                            and t.t_General        = 'X' "
            + "                                                                        ) "
            + "        left  join dobjatcor_dbt RCor on     RCor.t_ObjectType  = " + OBJTYPE_SFCONTR
            + "                                         and RCor.t_GroupID     = 6 " //Предоставлять брокеру право использования ценных бумаг в его интересах
            + "                                         and RCor.t_Object      = LPAD(sf.t_ID, 10, '0') " 
            + "                                         and RCor.t_ValidFromDate = (select MAX(t.t_ValidFromDate) "
            + "                                                                       from dobjatcor_dbt t "
            + "                                                                      where t.t_ObjectType     = " + OBJTYPE_SFCONTR
            + "                                                                        and t.t_GroupID        = 6 "
            + "                                                                        and t.t_Object         = LPAD(sf.t_ID, 10, '0') "
            + "                                                                     ) "
            + "        left  join dobjatcor_dbt AtCor1 on    AtCor1.t_ObjectType  = " + OBJTYPE_SFCONTR
            + "                                          and AtCor1.t_GroupID     = 7 " //Перевод активов на новый номер ТКС произведен
            + "                                          and AtCor1.t_Object      = LPAD(sf.t_ID, 10, '0') " 
            + "                                          and AtCor1.t_ValidFromDate = (select MAX(t2.t_ValidFromDate) "
            + "                                                                          from dobjatcor_dbt t2 "
            + "                                                                         where t2.t_ObjectType     = " + OBJTYPE_SFCONTR
            + "                                                                           and t2.t_GroupID        = 7 "
            + "                                                                           and t2.t_Object         = LPAD(sf.t_ID, 10, '0') "
            + "                                                                       ) "
            + "        left  join dobjatcor_dbt AtCor2 on    AtCor2.t_ObjectType  = " + OBJTYPE_SFCONTR
            + "                                          and AtCor2.t_GroupID     = 8 " //Заявление клиента о переводе на обособленный учет
            + "                                          and AtCor2.t_Object      = LPAD(sf.t_ID, 10, '0') " 
            + "                                          and AtCor2.t_ValidFromDate = (select MAX(t3.t_ValidFromDate) "
            + "                                                                          from dobjatcor_dbt t3 "
            + "                                                                         where t3.t_ObjectType     = " + OBJTYPE_SFCONTR
            + "                                                                           and t3.t_GroupID        = 8 "
            + "                                                                           and t3.t_Object         = LPAD(sf.t_ID, 10, '0') "
            + "                                                                       ) "
            + "  where sf.t_ServKind = " + PTSK_STOCKDL
            + "    and sf.t_ServKindSub = 8 " //Биржевой рынок
            + "    and ((AtCor2.t_AttrID = 1 /*Да*/ and RCor.t_AttrID = 2 /*Нет*/ and AtCor1.t_AttrID = 2 /*Нет*/) or (AtCor2.t_AttrID = 2 /*Нет*/ and RCor.t_AttrID = 1 /*Да*/ and AtCor1.t_AttrID = 1 /*Да*/))";


    cmd = DL_RSDCommand(query);
    
    cnt = cmd.GetCount();

    PrintRepHeader();
    RegistrTable();
    if(cnt > 0)
      InitProgress(cnt, "Подготовка отчета", "Подготовка отчета");

      DataSet = cmd.Execute();
      while(DataSet.moveNext())

        OperTypeName = "";
        if(DataSet.OperType_NewDBO != 0)
          OperTypeName = "Открытие нового ДБО";
        elif((DataSet.IsRCor != 0) and (DataSet.IsHaveSecurities == 0))
          OperTypeName = "Изменение ДБО и нет остатков ценных бумаг";
        elif((DataSet.IsRCor != 0) and (DataSet.IsHaveSecurities != 0))
          OperTypeName = "Изменение ДБО и есть ценные бумаги";
        end;

        SetRowHeight(START_ROW_POS + i, 73);
		
		if((String(DataSet.DepoAcc) == "") and (String(DataSet.DepoPart) == ""))
			depoAccStr = "";
		else
			depoAccStr = FORMULA+FormulaCONCAT()+"(\""+String(DataSet.DepoAcc)+"\";"+FormulaCHAR+"(10);\""+String(DataSet.DepoPart)+"\")";
		end;

        PrintTableLine("N1_OprType",     OperTypeName,            null,
                       "N1_Client",      DataSet.ClientName,      null,      
                       "N1_ClientType",  IIF(DataSet.LegalForm != 1, "Физическое лицо", "Юридическое лицо"),  null,   
                       "N1_ContrNumber", DataSet.ContrNumber,     null,
                       "N1_DepoDoc",     DataSet.DepoDoc,         null,
                       "N1_DepoAcc",     depoAccStr,  null,
                       "N1_DateConc",    date(DataSet.DateConc),  null,
                       "N1_DateChange",  date(DataSet.DateChange), null,
                       "N1_TKS_Number",  DataSet.TKS_Number,      null,
                       "N1_CFT_ID",      DataSet.CFT_ID,          null
                      );

        UseProgress(i = i + 1);
      end;

      RemProgress();
    end;

    EndTable();

  END;
  initDL_CReportTemplate( NULL, "Report_Cl2Type.xlsx", false, null, null, true, true, WINREP_FORMAT_XLSX ); 
END;


PRIVATE MACRO ReportRun()
  
  var Form = TRepCl2Type_Panel();

  while(Form.Run())
    TRepCl2Type_Report(Form.m_RepDate).Run();    
  end;
END;


ReportRun();
exit(1);