/*
 $Name: nptxcrnset005.mac
 $Module: Ценные бумаги
 $Description: Соглашение об урегулировании претензий. Шаг "Инициализация"
 */


private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(nptxop, ID_Operation, ID_Step)
  var err = 0;

  DefineOprDate( 0 /*Дата операции*/,   nptxop.rec.OperDate );
  //DefineOprDate( 2 /*Дата соглашения*/, spgr.rec.SignedDate );

  var StartSTBDate = GetStartSTBDate();
  if((nptxop.rec.CalcNDFL == SET_CHAR) and (РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ()) and (StartSTBDate > date(0,0,0)) and (nptxop.rec.OperDate >= StartSTBDate))
    var CurrYear = 0;

    datesplit(nptxop.rec.OperDate, NULL, NULL, CurrYear);
    
    if(STB_ClientNeedRecalc(nptxop.rec.Client, CurrYear))
      if( not InsertOprStatus(46481, 7)) //Пересчет СНОБ 
        return Error( "Ошибка при установке статуса вида \"Пересчет СНОБ\" операции" );        
      end;
    else
      if( not InsertOprStatus(46481, 8)) //Запрос СНОБ 
        return Error( "Ошибка при установке статуса вида \"Запрос СНОБ\" операции" );        
      end;
    end;
  else
    if(nptxop.rec.CalcNDFL == SET_CHAR)
      if( not InsertOprStatus(46481, 2)) //Расчет НДФЛ
        return Error( "Ошибка при установке статуса вида \"Расчет НДФЛ\" операции" );        
      end;
    else
      if( not InsertOprStatus(46481, 4)) //Формирование проводок
        return Error( "Ошибка при установке статуса вида \"Формирование проводок\" операции" );        
      end;
    end;
  end;

  return err;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  var nptxop = TRecHandler("nptxop.dbt");
  var err = 0;

  SetBuff( nptxop, FDoc );

  err = RunAction(nptxop, ID_Operation, ID_Step);

  DL_NPTX_SaveOperLog(nptxop.rec.ID, 5);

  return err;
end;