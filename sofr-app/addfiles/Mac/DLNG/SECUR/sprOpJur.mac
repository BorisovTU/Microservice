/*******************************************************************************
 FILE         :   SPROPJUR.MAC

 COPYRIGHT    :   R-Style, 1998

 DESCRIPTION  :   RS-Bank,  –, ®âç¥â "†ãà­ « ®¯¥à æ¨©"

 PROGRAMMED BY:   Alex Kormukhin

 CREATION DATE:   15.09.1998

*******************************************************************************/

 import spReport, FIInter, BankInter, Globals, SecInter, dpstdrep, cb_sql;

 private const CHAPT5 = 5;

 var daysum = 0;
 var maxt_point = 0;
 var form_str = "";

 var HeadTable ="ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                "³„ â  ¤®ª. ³‚O³ ­ ¨¬¥­®¢ ­¨¥ ®¯¥à æ¨¨ ³ N ¤®ª. ³       ‘ç¥â ¤¥¡¥â         ³       ‘ç¥â ªà¥¤¨â        ³      ‘ã¬¬       ³      –¥­­ ï ã¬ £       ³\n"+
                "ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

 var Rep = CMakeReport(HeadTable);
 const RepFontStyleTitel =  "ex_FS(b)";
 const OBJTYPE_TRANSACTION = 1200;



 macro IsDepoDraft( DocKind )

   if(   ( DocKind == SP_DEPOPER_BOOKORDER )
      or ( DocKind == SP_DEPOPER_TRANSFERORDER )
      or ( DocKind == SP_DEPOPER_ENROLMENT )
      or ( DocKind == SP_DEPOPER_RECORDER )
      or ( DocKind == SP_DEPOPER_WITHDRORDER )
     )
     return true;
   end;

   return false;
 end;

 macro IsDepoGlobop( DocKind )

  if(   ( DocKind == DP_DEPOPER_CONVERT )
     or ( DocKind == DP_DEPOPER_REPAY )
     or ( DocKind == DP_DEPOPER_BONEMISS )
    )
    return true;
  end;

  return false;
 end;



 macro PrintTable(DataSet)
   while(DataSet.MoveNext())
      if( DataSet.SumPrecision > maxt_point)
        maxt_point = DataSet.SumPrecision;
      end;
      DP_AddPrintCell( Rep, date(DataSet.Date_Carry), 0, 0, "l:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DataSet.Shifr_Oper, 0, 0, "r:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DataSet.transactionName, 0, 0, "l:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DataSet.Numb_Document, 0, 0, "r:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DataSet.Account_Payer, 0, 0, "l:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DataSet.Account_Receiver, 0, 0, "l:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DataSet.Sum_Payer, 0, DP_GetPrecision(DataSet.Sum_Payer, DataSet.SumPrecision), "r:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DataSet.Name, 0, 0, "l:" + RepFontStyleTitel );
      Rep.AddStr();
      daysum = daysum + DataSet.Sum_Payer;
   end;
 end;

 MACRO operjour(iDepart:integer,dateMin:date,dateMax:date,ToExcel:bool, ApostrSum:bool)

   var DataSet, query;
   var ChapterName;
   var iCount = 0;
   var prnrep = false;
 
   FILE cChapter(obchaptr) sort 0; /* by Chapter */
   Dl_CallInsertStat( IIF( ToExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
   DP_BeginProtocol();  //­ ç âì ¯à®â®ª®«¨à®¢ ­¨¥ - ¯®¤¬¥­  MsgBox

   cChapter.Chapter=CHAPT5;
   if(GetEq(cChapter) == true)
     ChapterName = cChapter.Name;
   else
     ChapterName = "???"; 
   end;
   if(dateMin == date(0,0,0))
     dateMin = date(2,2,2);
   end;

   DP_StdHeaderLO_Ex( Rep, RepFontStyleTitel, "†ãà­ « ®¯¥à æ¨©", 0, 0, false, IIF((dateMin == date(2,2,2)),date(0,0,0),dateMin), dateMax );
   DP_AddPrintCell( Rep, "ƒ« ¢  " + CHAPT5 + ". " + ChapterName, 100, 0, "l:" + RepFontStyleTitel,ApostrSum, REP_ELEM_STR );
   Rep.AddStr();

   query = RSDCommand("select count(arh.t_Shifr_Oper) as val" +
           "  from dacctrn_dbt arh, dfininstr_dbt fin" +
           "  where fin.t_fiid = arh.t_FIID_Payer" +
           "  and arh.t_Chapter = ? " +
           "  and arh.t_Department = ? "  +
           "  and arh.t_Date_Carry >= ? " +
           "  and arh.t_Date_Carry <= ? " );
   query.addParam( "", RSDBP_IN, int(CHAPT5) );
   query.addParam( "", RSDBP_IN, int(iDepart) );
   query.addParam( "", RSDBP_IN, date(dateMin) );
   query.addParam( "", RSDBP_IN, date(dateMax) );
   query.Execute();
   DataSet = TRsbDataSet(query);
   DataSet.MoveNext();
   iCount = DataSet.Val;

   if(iCount > 0)
     prnrep = true;

     query = RSDCommand("select arh.t_Date_Carry, arh.t_Shifr_Oper, arh.t_Numb_Document, arh.t_Account_Payer," +
             "  arh.t_Account_Receiver, arh.t_Sum_Payer, fin.t_Name, fin.t_SumPrecision, " +
             "  NVL((select llval.t_Name " +
             "     from dspdraft_dbt dr, dpmdocs_dbt pd, dspdrmove_dbt mv, dllvalues_dbt llval " +
             "    where pd.t_acctrnid = arh.t_acctrnid " +
             "      and pd.t_paymentid = mv.t_paymentid " +
             "      and mv.t_draftid = dr.t_autokey " +
             "      and (dr.t_kind = " + string(SP_DEPOPER_BOOKORDER) +
             "           or dr.t_kind = " + string(SP_DEPOPER_TRANSFERORDER) + 
             "           or dr.t_kind = " + string(SP_DEPOPER_ENROLMENT) + 
             "           or dr.t_kind = " + string(SP_DEPOPER_RECORDER) + 
             "           or dr.t_kind = " + string(SP_DEPOPER_WITHDRORDER) + ")"+
             "      and llval.t_list =  " + string(OBJTYPE_TRANSACTION) +
             "      and llval.t_element = dr.t_product " +
             "  ),'-') as transactionName " +
             "  from dacctrn_dbt arh, dfininstr_dbt fin" +
             "  where fin.t_fiid = arh.t_FIID_Payer" +
             "  and arh.t_Chapter = ? " +
             "  and arh.t_Department = ? " +
             "  and arh.t_Date_Carry >= ? " +
             "  and arh.t_Date_Carry <= ? ");
     query.addParam( "", RSDBP_IN, int(CHAPT5) );
     query.addParam( "", RSDBP_IN, int(iDepart) );
     query.addParam( "", RSDBP_IN, date(dateMin) );
     query.addParam( "", RSDBP_IN, date(dateMax) );
     query.Execute();
     DataSet = TRsbDataSet(query);
     PrintTable(DataSet);
   end;

   daysum = —¨á«®C‡ ¤ ­­®©’®ç­®áâìî(double(daysum), maxt_point, form_str);

   DP_AddPrintCell( Rep, " ˆâ®£ §  ¯¥à¨®¤: " + daysum, 100, maxt_point, "l:" + RepFontStyleTitel,ApostrSum, REP_ELEM_STR );
   Rep.AddStr();
   Rep.AddEmptyStr();
   
   if(prnrep)
     DP_StdFooter_Ex(Rep, RepFontStyleTitel);

     DP_AddProtocol(Rep, "protocol");  //¤®¡ ¢¨¬ ¯à®â®ª®« ª ã¦¥ áä®à¬¨à®¢ ­­®¬ã ®âç¥âã
     DP_EndProtocol();                 //§ ª®­ç¨âì ¯à®â®ª®«¨à®¢ ­¨¥

     if( ToExcel )
       Rep.PrintWinRep();
       Rep.ShowWinRep();
     else
       Rep.PrintRep();
     end;
   else
     if(not DP_ProtocolIsEmpty())
       DP_AddPrintCell(Rep, "¥â ®¯¥à æ¨© §  § ¤ ­­ë© ¯¥à¨®¤", 31, 0, "l:" + RepFontStyleTitel, false, REP_ELEM_STR);
       Rep.AddStr();

       DP_AddProtocol(Rep, "protocol");  //¤®¡ ¢¨¬ ¯à®â®ª®« ª ã¦¥ áä®à¬¨à®¢ ­­®¬ã ®âç¥âã
       DP_EndProtocol();                 //§ ª®­ç¨âì ¯à®â®ª®«¨à®¢ ­¨¥

       if( ToExcel )
         Rep.PrintWinRep();
         Rep.ShowWinRep();
       else
         Rep.PrintRep();
       end;
     else
       DP_EndProtocol();                 //§ ª®­ç¨âì ¯à®â®ª®«¨à®¢ ­¨¥
     end;

     MsgBox("¥â ®¯¥à æ¨© §  § ¤ ­­ë© ¯¥à¨®¤");
   end;
 END;
