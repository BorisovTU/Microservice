/*
$Name: ConfParamMAS.mac
$Module: Ценные бумаги
$Description: Квитовка сообщений из планировщика
*/

import InsCarryDoc, "sp_class.mac", "sp_car.mac", "sprconf.mac", "boswift.mac";
macro ConfParamMAS()
  var query, Select;
  var queryStr, DataSet, cmd;
  var queryType, DataSetType, cmdType;
  var stat, ConfNumber, FactValueDate, InstrStatus, TypeIN ;       
  queryStr = "Select * From ddlinfmsg_dbt Where t_Confirm = 1";
  cmd = DL_RSDCommand(queryStr);
  DataSet = cmd.Execute();

  while( DataSet.moveNext() )
    var queryStrObj, DataSetObj, cmdObj;
    queryStr = "Select * From ddlinfmsgobj_dbt Where t_MesID = ? And ROWNUM = 1";
    cmdObj = DL_RSDCommand(queryStr);
    cmdObj.AddParam(DataSet.ID);
    DataSetObj = cmdObj.Execute();

    if(DataSetObj.moveNext())

      if(DataSetObj.DocKind == 101)               //сделки
        query = "begin\n ? := RSP_SECURITY.GetConfirmParamsSEC(?,?,?,?,?);\n end; ";
      elif(DataSetObj.DocKind == 154)           //неттинг
        query = "begin\n ? := RSP_SECURITY.GETCONFIRMPARAMSSECNETT(?,?,?,?,?);\n end; ";

      elif((DataSetObj.DocKind == 805) or (DataSetObj.DocKind == 810))           //депозитарные
        query = "begin\n ? := RSP_SECURITY.GetConfirmParams(1,?,?,?,?,?);\n end; ";        // 1 -PaymKind (для Payments)
      end;

      Select = RSDCommand( query );
      
      Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );
      
      Select.AddParam("p_DraftID", RSDBP_IN, DataSetObj.DocID );
      
      Select.AddParam("p_Number", RSDBP_OUT, V_STRING );
      Select.AddParam("p_Date", RSDBP_OUT, V_STRING );
      Select.AddParam("p_TypeIN", RSDBP_OUT, V_STRING );
      Select.AddParam("p_Status", RSDBP_OUT, V_INTEGER );
      
      Select.Execute();
    
      stat          = SQL_ConvTypeInteger(Select.value("p_Stat"));
      ConfNumber    = SQL_ConvTypeStr(Select.value("p_Number"));
      FactValueDate = SQL_ConvTypeStr(Select.value("p_Date"));
      InstrStatus   = SQL_ConvTypeStr(Select.value("p_Status"));
      TypeIN        = SQL_ConvTypeInteger(Select.value("p_TypeIN"));
      if(stat == 0)
        var queryIns, DataSetIns, cmdIns;
    
        if(InstrStatus == 0)
          InstrStatus = 11;
        elif(InstrStatus == 1)
          InstrStatus = 12;
        end;
        var dat:string;
        dat = substr(FactValueDate, 1, 10);
        var Typ = 0;
      
        if(TypeIN)
           queryType = " Select * From dnamealg_dbt Where t_ITypeAlg = 3280 and t_SZNameAlg = ? ";
           cmdType = DL_RSDCommand(queryType);
           cmdType.AddParam(TypeIN, RSDBP_IN, V_STRING );
//           cmdType.AddParam("", RSDBP_IN, TypeIN );
           DataSetType = cmdType.Execute();
           if( DataSetType.moveNext() )
             Typ = DataSetType.INumberAlg;
           end;
        end;
    
        queryIns = " UPDATE ddlinfmsg_dbt inf";
        queryIns = queryIns + " SET inf.t_Confirm = 0, inf.t_Status = ?, inf.t_Confirmnum = ?, inf.t_ConfirmDate = TO_DATE(?, 'DD.MM.YYYY'), inf.t_format = ? ";
        queryIns = queryIns + " WHERE inf.t_ID IN(Select distinct infobj.t_mesID from ddlinfmsgobj_dbt infobj Where infobj.t_DocID = ? And infobj.t_DocKind =  ?)";
        cmdIns = RSDCommand( queryIns );
    
        cmdIns.AddParam("", RSDBP_IN, InstrStatus );
        cmdIns.AddParam("", RSDBP_IN, ConfNumber );
        cmdIns.AddParam("", RSDBP_IN, dat );
        cmdIns.AddParam("", RSDBP_IN, Typ );
        cmdIns.AddParam("", RSDBP_IN, DataSetObj.DocID );
        cmdIns.AddParam("", RSDBP_IN, DataSetObj.DocKind );
        cmdIns.Execute();
      end;
    end;
  end;
end;

ConfParamMAS();
















