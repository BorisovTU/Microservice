import DealsInter, "nptxstbfun.mac";

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

private macro CheckObjAttr(OperationID, GroupId)
  var query = "SELECT PM_COMMON.CheckObjAttrPresence(188, LPAD(?, 34, '0'), ?, 1) t_Has FROM DUAL";

  var cmd = DL_RSDCommand(query);  
      cmd.AddParam(OperationID);
      cmd.AddParam(GroupId);
      
  var DataSet = cmd.Execute();;
    
  if( DataSet.MoveNext() )
    return (DataSet.Has == 1);
  end;
END;

private macro AddObjChangeCode(ObjID:integer)
  var query, Upd;

  query = "update DNPTXOBJ_DBT set T_CHANGECODE = chr(88) where t_ObjId = ? ";
  Upd = DL_RSDCommand(query);
  Upd.AddParam(ObjID);

  Upd.ExecuteCMD();
end;

private macro CreateNDRChangeCode (nptxop)

  private macro CreateNDR(DataSet, kind, sign, err:@integer)
    var ObjID = 0; 
    var ErrStr = "";
    if((0 != DL_NPTX_InsertTaxObjectRetID( DataSet.DateNDR                         // Дата НДР
                                          ,DataSet.ClientID                        // Клиент
                                          ,1                                       // Направление
                                          ,5                                       // Уровень
                                          ,UNSET_CHAR                              // Признак "Пользовательский"
                                          ,kind                                    // Вид НДР
                                          ,((DataSet.SUM_FOR_CHANGE - DataSet.sumNkdB) * IIF(sign == "+", 1, -1))  // Сумма дохода/расхода
                                          ,NATCUR                                  // Валюта дохода/расхода
                                          ,1                                       // Вид аналитики 1
                                          ,-1                                      // Аналитика 1
                                          ,0                                       // Вид аналитики 2
                                          ,-1                                      // Аналитика 2
                                          ,10                                      // Вид аналитики 3
                                          ,-1                                      // Аналитика 3
                                          ,1                                       // Вид аналитики 4
                                          ,-1                                      // Аналитика 4
                                          ,1                                       // Вид аналитики 5
                                          ,-1                                      // Аналитика 5
                                          ,1                                       // Вид аналитики 6
                                          ,-1                                      // Аналитика 6    
                                          ,"Объект НДР по замене кода дохода "     // Комментарий
                                          ,nptxop.rec.ID                           // ID операции
                                          ,4                                       // ID шага операции
                                          ,1                                       // Признак вызова не из операции расчета НОБ
                                          ,ObjID                                   // Возвращаемый идентификатор созданного объекта
                                          ,UNSET_CHAR                              // Признак внешней системы
                                          ,"ДЕПО"                                  // Код внешней системы
                                          ,string(DataSet.RECORDPAYMENTID)         // Идентификатор во внешней системе
                                         )) or (ObjID <= 0))

      ErrStr = GetErrMsg();
      err = 1;
    else
      AddObjChangeCode(ObjID);
    end;
    return ObjID;
  end;

  var err = 0;
  var ObjID = 0;
  var query, cmd, DataSet;
  
  query = "select ch.*, (select NVL(sum(t_sum0),0) from dnptxobj_dbt obj where obj.t_client = ch.t_clientid and obj.t_kind = "+TXOBJ_NKDB_TS+" and obj.t_Analitic2 = cd.t_couponnumber and obj.t_Analitic3 = ch.t_fiid and (obj.t_OutSystCode = CHR(1) or obj.t_OutSystCode IS NULL)) as sumNkdB " +
          "  from dnptxcodechange_dbt ch left join DCDRECORDS_DBT cd on ch.T_IDDCDRECORDS = to_CHAR(cd.T_ID) " +
          " where ch.t_OPERATIONID = ? AND ch.T_ISCHANGEFLAG = chr(88) AND ch.T_DATENDR > TO_DATE ('01.01.0001', 'DD.MM.YYYY') AND " +
          "       (select sum(ch2.T_SUM_FOR_CHANGE) from DNPTXCODECHANGE_DBT ch2 where ch2.T_RECORDPAYMENTID = ch.T_RECORDPAYMENTID) > 0 AND " +
          "       ch.T_ACCOUNTNUMBER LIKE '306%' AND cd.T_ISGETTAX <> chr(88) ORDER BY ch.T_CLIENTID, ch.T_PAYMENTDATE  ";
          
  cmd = DL_RSDCommand(query);
  cmd.AddParam(nptxop.rec.ID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    if(DataSet.GROUP == 1)
      CreateNDR(DataSet, TXOBJ_PLUSG_3023, "-",@err );
      CreateNDR(DataSet, TXOBJ_PLUSG_1530, "+",@err );
    elif(DataSet.GROUP == 2)
      CreateNDR(DataSet, TXOBJ_PLUSG_1011, "-",@err );
      CreateNDR(DataSet, TXOBJ_PLUSG_1011_1, "-",@err );
      CreateNDR(DataSet, TXOBJ_PLUSG_1530, "+",@err );
    elif(DataSet.GROUP == 3)
      CreateNDR(DataSet, TXOBJ_PLUSG_1011, "-",@err );
      CreateNDR(DataSet, TXOBJ_PLUSG_1011_3, "-",@err );
      CreateNDR(DataSet, TXOBJ_PLUSG_1531, "+",@err );
    elif(DataSet.GROUP == 4)
      CreateNDR(DataSet, TXOBJ_PLUSG_1011, "-",@err );
      CreateNDR(DataSet, TXOBJ_PLUSG_1011_2, "-",@err );
      CreateNDR(DataSet, TXOBJ_PLUSG_1536, "+",@err );
    end;

    if(err != 0)
      err = Error( " Не удалось сформировать НДР " ); 
      return err;
    end;
  end;

  return err;
end;

private macro CreateNDRPayDiasoft (nptxop)

  private macro CreateNDR(DataSet, kind, sign, err:@integer)
    var ObjID = 0;
    var ErrStr = "";
    if((0 != DL_NPTX_InsertTaxObjectRetID( DataSet.DateNDR                         // Дата НДР
                                          ,DataSet.ClientID                        // Клиент
                                          ,1                                       // Направление
                                          ,5                                       // Уровень
                                          ,UNSET_CHAR                              // Признак "Пользовательский"
                                          ,kind                                    // Вид НДР
                                          ,(DataSet.SUM_FOR_CHANGE * IIF(sign == "+", 1, -1))   // Сумма дохода/расхода
                                          ,NATCUR                                  // Валюта дохода/расхода
                                          ,1                                       // Вид аналитики 1
                                          ,-1                                      // Аналитика 1
                                          ,0                                       // Вид аналитики 2
                                          ,-1                                      // Аналитика 2
                                          ,0                                       // Вид аналитики 3
                                          ,-1                                      // Аналитика 3
                                          ,0                                       // Вид аналитики 4
                                          ,-1                                      // Аналитика 4
                                          ,0                                       // Вид аналитики 5
                                          ,-1                                      // Аналитика 5
                                          ,0                                       // Вид аналитики 6
                                          ,-1                                      // Аналитика 6    
                                          ,"Объект НДР по замене кода дохода"      // Комментарий
                                          ,nptxop.rec.ID                           // ID операции
                                          ,4                                       // ID шага операции
                                          ,1                                       // Признак вызова не из операции расчета НОБ
                                          ,ObjID                                   // Возвращаемый идентификатор созданного объекта
                                          ,SET_CHAR                                // Признак внешней системы
                                          ,"ДЕПО"                                  // Код внешней системы
                                          ,string(DataSet.RECORDPAYMENTID)         // Идентификатор во внешней системе
                                         )) or (ObjID <= 0))

      ErrStr = GetErrMsg();
      err = 1;
    else
      AddObjChangeCode(ObjID);
    end;
    return ObjID;
  end;
  
  var err = 0;
  var ObjID = 0;
  var query, cmd, DataSet;
  
  query = "select ch.*, NPTO.GetPaperTaxGroupNPTX(ch.t_FIID ) t_TaxGroupNPTX " +
          "  from dnptxcodechange_dbt ch left join DCDRECORDS_DBT cd on ch.T_IDDCDRECORDS = to_CHAR(cd.T_ID)  " +
          " where ch.t_OPERATIONID = ? AND ((T_ERRORTEXT is null) or (T_ERRORTEXT = chr(0)) or (T_ERRORTEXT = 'Требуется пересчет')) AND ch.T_ISCHANGEFLAG = chr(88) AND " +
          "       ch.T_DATENDR > TO_DATE ('01.01.0001', 'DD.MM.YYYY') AND ch.T_SUM_FOR_CHANGE > 0 " +
          "       ORDER BY ch.T_CLIENTID, ch.T_PAYMENTDATE ";
          
  cmd = DL_RSDCommand(query);
  cmd.AddParam(nptxop.rec.ID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())

    if(DataSet.GROUP == 1)
      CreateNDR(DataSet, TXOBJ_PLUSG_1530, "+",@err );
    elif(DataSet.GROUP == 2)
      CreateNDR(DataSet, TXOBJ_PLUSG_1530, "+",@err );
    elif(DataSet.GROUP == 3)
      CreateNDR(DataSet, TXOBJ_PLUSG_1531, "+",@err );
    elif(DataSet.GROUP == 4)
      CreateNDR(DataSet, TXOBJ_PLUSG_1536, "+",@err );
    end;

    if((0 != DL_NPTX_InsertTaxObjectRetID( DataSet.DateNDR                         // Дата НДР
                                          ,DataSet.ClientID                        // Клиент
                                          ,1                                       // Направление
                                          ,4                                       // Уровень
                                          ,UNSET_CHAR                              // Признак "Пользовательский"
                                          ,TXOBJ_PROCSEC_CHANGE                    // Вид НДР
                                          ,DataSet.SUM_FOR_CHANGE                         // Сумма дохода/расхода
                                          ,NATCUR                                  // Валюта дохода/расхода
                                          ,1                                       // Вид аналитики 1
                                          ,-1                                      // Аналитика 1
                                          ,0                                       // Вид аналитики 2
                                          ,-1                                      // Аналитика 2
                                          ,TXOBJ_KIND3010                          // Вид аналитики 3
                                          ,DataSet.FIID                            // Аналитика 3
                                          ,TXOBJ_KIND4010                          // Вид аналитики 4
                                          ,DataSet.ISCIRC                          // Аналитика 4
                                          ,TXOBJ_KIND5010                          // Вид аналитики 5
                                          ,DataSet.TaxGroupNPTX                    // Аналитика 5
                                          ,1                                       // Вид аналитики 6
                                          ,-1                                      // Аналитика 6    
                                          ,"Объект НДР по замене кода дохода"      // Комментарий
                                          ,nptxop.rec.ID                           // ID операции
                                          ,4                                       // ID шага операции
                                          ,1                                       // Признак вызова не из операции расчета НОБ
                                          ,ObjID                                   // Возвращаемый идентификатор созданного объекта
                                          ,UNSET_CHAR                              // Признак внешней системы
                                          ,"ДЕПО"                                  // Код внешней системы
                                          ,string(DataSet.RECORDPAYMENTID)         // Идентификатор во внешней системе
                                         )) or (ObjID <= 0))

      var ErrStr = GetErrMsg();
      err = 1;
    else
      AddObjChangeCode(ObjID);
    end;

    if(err != 0)
      err = Error( " Не удалось сформировать НДР " ); 
      return err;
    end;

  end;

  return err;
end;

private macro CheckNDRbyPay(ID)
  var sql, exec;
  sql =   " BEGIN " +
          "     FOR cData IN (SELECT T_RECORDPAYMENTID, T_OPERATIONID, T_CLIENTID " +
          "                      FROM DNPTXCODECHANGE_DBT ch " +
          "                      WHERE EXISTS (SELECT t_objid FROM dnptxobj_dbt " +
          "                                 WHERE T_KIND = 1185 AND T_CHANGECODE = CHR (88) AND T_OUTOBJID = ch.T_RECORDPAYMENTID) " +
          "                            AND EXISTS (SELECT * FROM dnptxobj_dbt " +
          "                                     WHERE     T_KIND IN (610, 620, 630) " +
          "                                           AND T_CHANGECODE = CHR (88) " +
          "                                           AND T_FROMOUTSYST = CHR (88) " +
          "                                           AND T_OUTOBJID = ch.T_RECORDPAYMENTID)  " +
          "                            AND T_OPERATIONID = ?) " +
          "     LOOP " +
          "       RSB_NPTXREPLACECODE. deleteNDRbyPay  (cData.T_OPERATIONID, cData.T_RECORDPAYMENTID, cData.T_CLIENTID); " +
          "     END LOOP; " +
          " END; ";
                
  exec = DL_RSDCommand(sql);
  exec.AddParam(ID);
  exec.ExecuteCMD();
end;

private macro setDateNDR(ID)
  var sql, exec;
  sql =   " UPDATE /*+ parallel(4) enable_parallel_dml */ DNPTXCODECHANGE_DBT ch " +
          "    SET T_DATENDR = (SELECT " +
          "   CASE WHEN OutMoneyDateNDR > TO_DATE ('01.01.0001', 'DD.MM.YYYY') THEN OutMoneyDateNDR " +
          "        WHEN EndYearDateNDR > TO_DATE ('01.01.0001', 'DD.MM.YYYY') THEN EndYearDateNDR " +
          "        ELSE TO_DATE ('01.01.0001', 'DD.MM.YYYY') END " +
          "   FROM (SELECT (SELECT NVL (MIN (t_OperDate), TO_DATE ('01.01.0001', 'DD.MM.YYYY')) " +
          "                   FROM dnptxop_dbt " +
          "                  WHERE     t_DocKind = 4605 " +
          "                        AND t_Client = CH.T_CLIENTID " +
          "                        AND t_OperDate >= CH.T_PAYMENTDATE " +
          "                        AND t_status = 2 " +
          "                        AND t_recalc <> chr(88) " +
          "                        AND RSB_SECUR.GetMainObjAttr(132 /*OBJTYPE_NPTXCALC*/, LPAD(t_ID, 34, '0'), 1, t_OperDate) = 0 " +
          "                        AND EXTRACT(YEAR FROM t_OperDate) = CH.T_TAXPERIOD " +
          "                        AND t_SubKind_Operation = 20) " +
          "                   AS OutMoneyDateNDR, " +
          "                (SELECT NVL (MIN (t_OperDate), TO_DATE ('01.01.0001', 'DD.MM.YYYY')) " +
          "                   FROM dnptxop_dbt " +
          "                  WHERE     t_DocKind = 4605 " +
          "                        AND t_Client = CH.T_CLIENTID " +
          "                        AND t_status = 2 " +
          "                        AND t_recalc <> chr(88) " +
          "                        AND t_OperDate >= CH.T_PAYMENTDATE " +
          "                        AND EXTRACT(YEAR FROM t_OperDate) = CH.T_TAXPERIOD " +
          "                        AND t_SubKind_Operation = 10) " +
          "                   AS EndYearDateNDR " +
          "           FROM DUAL)) " +
          "  WHERE T_OPERATIONID = ? ";
                
  exec = DL_RSDCommand(sql);
  exec.AddParam(ID);
  exec.ExecuteCMD();
end;

private macro delChangeCodeNDR(ID)
  var sql, exec;
  sql =   " DELETE FROM dnptxobj_dbt "
        + "  WHERE t_objid in (select t_objid from DNPTXOBDC_DBT where t_docid = ? ) ";
                
  exec = DL_RSDCommand(sql);
  exec.AddParam(ID);
  exec.ExecuteCMD();
  
  sql =   " DELETE FROM DNPTXOBDC_DBT "
        + "  WHERE t_docid = ? ";
                
  exec = DL_RSDCommand(sql);
  exec.AddParam(ID);
  exec.ExecuteCMD();
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  var err = 0;
  var nptxop = TRecHandler("nptxop.dbt");

  SetBuff( nptxop, FDoc );

  if((nptxop.rec.SubKind_Operation == 20) and (MsgBoxEx("Сформировать объекты НДР по операции", MB_ERROR + MB_YES + MB_NO, IND_NO) == IND_NO)) 
    return 1;
  end;

  if(CheckObjAttr(nptxop.rec.ID, 2) AND (nptxop.rec.SubKind_Operation == 10))
    setDateNDR(nptxop.rec.ID);
    err = CreateNDRChangeCode (nptxop);
  end;
  
  if((err == 0) AND (nptxop.rec.SubKind_Operation == 20))
    CheckNDRbyPay(nptxop.rec.ID);
    setDateNDR(nptxop.rec.ID);
    err = CreateNDRPayDiasoft (nptxop);
  end;

  DL_NPTX_SaveOperLog( nptxop.rec.ID, ID_Step );

  return err;
end;

/* Макрос постобработки */
MACRO PostStep (CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,          /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

  var nptxop = TRecHandler("nptxop.dbt");
  var ErrStr = "";
  var err = 0;

  SetBuff( nptxop, FDoc );

  if(CommitOrRollback == 2)
    delChangeCodeNDR(nptxop.rec.ID);
  end;
  
  return err;
END;