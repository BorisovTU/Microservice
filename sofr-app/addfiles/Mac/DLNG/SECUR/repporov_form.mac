/*
$Name: repporov_form.mac
$Module: Ценные бумаги
$Description: Отчет " Оценка портфеля ценных бумаг Банка " - форма ввода данных (Б/О)
PROGRAMMED BY:   Nikolskaya V.
CREATION DATE:   05/05/2008
*/

import "DlRepForm_h.mac";

// Номера полей в форме отчета
CONST
      PNFLD_REPPOROV_Dprt            = 0,
      PNFLD_REPPOROV_DprtName        = 1,
      PNFLD_REPPOROV_DATE            = 2,
      PNFLD_REPPOROV_ASCB            = 3,
      PNFLD_REPPOROV_SSPU            = 4,
      PNFLD_REPPOROV_SSSD            = 5,
      PNFLD_REPPOROV_BPP_SSPU        = 6,
      PNFLD_REPPOROV_BPP_SSSD        = 7,
      PNFLD_REPPOROV_BPP_ASCB        = 8,
      PNFLD_REPPOROV_BPP_CONTR       = 9,
      PNFLD_REPPOROV_PVO             = 10,
      PNFLD_REPPOROV_OD_             = 11,
      PNFLD_REPPOROV_OD              = 12,
      PNFLD_REPPOROV_PKU             = 13,
      PNFLD_REPPOROV_PDO             = 14,
      PNFLD_REPPOROV_BACK_KSU        = 15,
      PNFLD_REPPOROV_BACK_BPP_KSU    = 16,
      PNFLD_REPPOROV_TO_EXEL         = 17,
      PNFLD_REPPOROV_WITH_APOSTROFS  = 18;


 
CLASS DlPorOvFormData()
  VAR 
  Department,
  RepDate,
  SSPU,
  SSSD,
  ASCB,
  BPP_SSPU,
  BPP_SSSD,
  BPP_ASCB,
  BPP_CONTR,
  PVO,
  OD_,
  OD,
  PKU,
  PDO,
  Back_KSU,    
  Back_BPP_KSU,
  IsUseApostrofs,
  IsExportToExel,
  lastParam;
  
  // Значение по умолчанию
  Department     = -1;
  RepDate        = {curdate};
  ASCB           = "X";
  SSPU           = "X";
  SSSD           = "X";
  BPP_SSPU       = "X";
  BPP_SSSD       = "X";
  BPP_ASCB       = "X";
  BPP_CONTR      = "X";
  PVO            = "X";
  OD_            = "X";
  OD             = "X";
  PKU            = "X";
  PDO            = "X";
  Back_KSU       = "X";
  Back_BPP_KSU   = "X";

  IsExportToExel = "X"; 
  IsUseApostrofs = "";

END;

VAR DlRepFormData = DlPorOvFormData();

PRIVATE CONST
  H_PNFLD_DATE      = 100,
  H_PNFLD_CHECKBOX1 = 101,
  H_PNFLD_CHECKBOX2 = 102;

PRIVATE MACRO FldProc_Department( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  file   Department( dp_dep );

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, STR_ALLVALUE);
     else
        ClearRecord( Department );
        Department.Code = FldRealValue;
        GetGE(Department);
        FldShowValue = FldRealValue;
        pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, DL_GetDepartmentNameByCode(FldRealValue));
     end;
  end;
  
  if( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
     return pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, STR_ALLVALUE );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) 
     if( ListDepartment( Department ) )
        FldRealValue = Department.Code;
        FldShowValue = FldRealValue;
        pThis.SetLinkedValue( DL_PNFLD_DEPARTMENT, DL_GetDepartmentNameByCode(FldRealValue)); 
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Date( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) 
     if( FldRealValue == null ) 
        FldRealValue = {curdate};
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     FldRealValue = GetDateByCalendar( FldRealValue );
     FldShowValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_CheckBox1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( (Cmd == DLG_KEY) and ( Key == KEY_SPACE ) )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
        end;
  end;
 if( FldRealValue == "X" )
    pThis.SetLinkedValue( H_PNFLD_CHECKBOX2, "" );
    DisableFields(pThis.Data(), PNFLD_REPPOROV_WITH_APOSTROFS);
 else
    EnableFields(pThis.Data(), PNFLD_REPPOROV_WITH_APOSTROFS);
 end;

  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_CheckBox2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;                                                                                       
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) and ( Key == KEY_SPACE ) )
        if( FldRealValue != "X" )
            FldShowValue = FldRealValue;
            if( pThis.GetFieldValue( PNFLD_REPPOROV_TO_EXEL ) == "X" )
               return CM_IGNORE;;
            else
               FldShowValue = FldRealValue = "X";;      
            end;
        else
           FldShowValue = FldRealValue = "";
        end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) DL_PorOv_Panel()  

  PRIVATE MACRO Init()
     AddFieldProc( 0, PNFLD_REPPOROV_Dprt,            DL_PNFLD_DEPARTCODE, @FldProc_Department,       DlRepFormData.Department);
     AddFieldProc( 0, PNFLD_REPPOROV_DprtName,        DL_PNFLD_DEPARTMENT, @Default,                  "");

     AddFieldProc( 0, PNFLD_REPPOROV_DATE,            H_PNFLD_DATE,        @FldProc_Date,             DlRepFormData.RepDate);

     AddFieldProc( 0, PNFLD_REPPOROV_ASCB,            DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.ASCB);                 
     AddFieldProc( 0, PNFLD_REPPOROV_SSPU,            DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.SSPU );                 
     AddFieldProc( 0, PNFLD_REPPOROV_SSSD,            DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.SSSD);
     AddFieldProc( 0, PNFLD_REPPOROV_BPP_SSPU,        DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.BPP_SSPU);
     AddFieldProc( 0, PNFLD_REPPOROV_BPP_SSSD,        DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.BPP_SSSD);
     AddFieldProc( 0, PNFLD_REPPOROV_BPP_ASCB,        DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.BPP_ASCB);
     AddFieldProc( 0, PNFLD_REPPOROV_BPP_CONTR,       DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.BPP_CONTR);
     AddFieldProc( 0, PNFLD_REPPOROV_PVO,             DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.PVO);
     AddFieldProc( 0, PNFLD_REPPOROV_OD_,             DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.OD_);
     AddFieldProc( 0, PNFLD_REPPOROV_OD,              DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.OD);
     AddFieldProc( 0, PNFLD_REPPOROV_PKU,             DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.PKU);
     AddFieldProc( 0, PNFLD_REPPOROV_PDO,             DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.PDO);
     AddFieldProc( 0, PNFLD_REPPOROV_BACK_KSU,        DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.Back_KSU);
     AddFieldProc( 0, PNFLD_REPPOROV_BACK_BPP_KSU,    DL_PNFLD_CHECKBOX,   @DL_FldProc_CheckBox,      DlRepFormData.Back_BPP_KSU);

     AddFieldProc( 0, PNFLD_REPPOROV_TO_EXEL,         H_PNFLD_CHECKBOX1,   @FldProc_CheckBox1,        DlRepFormData.IsExportToExel);
     AddFieldProc( 0, PNFLD_REPPOROV_WITH_APOSTROFS,  H_PNFLD_CHECKBOX2,   @FldProc_CheckBox2,        DlRepFormData.IsUseApostrofs);

  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;
  
  initDL_CPanel( "sp_res.lbr", "REPPOROV" );
 
END;