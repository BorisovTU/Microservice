/*
$Name:        StAppRetTax_Form.mac
$Module:      БО ЦБ
$Description: Форма для отчета о состоянии заявлений на возврат налога на дату
*/
import "DlRepForm_h.mac";

const ALG_NPTX_RETREQSTATE   = 7338;    // Статусы заявлений

CONST PNFLD_CLBOREP_PERIOD_BEGIN = 0,
      PNFLD_CLBOREP_PERIOD_END   = 1;

CONST H_PNFLD_BEGINDATE  = 100,
      H_PNFLD_ENDDATE    = 101;

CONST PNFLD_APP_RET_TAX_DATE  = 0,
      PNFLD_APP_RET_TAX_STATE = 1;

CONST H_PNFLD_DATE  = 100,
      H_PNFLD_STATE = 101;

/*Виды сделок*/
CONST STATUS_ALL         = 0; /*Все*/
PRIVATE VAR STATUS_NAME_ALL = "Все";

PRIVATE MACRO FldProc_Date( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = {curdate};
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_State( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = STATUS_ALL;
        FldShowValue = STATUS_NAME_ALL;
     else
        FldShowValue = DL_GetNameAlg(ALG_NPTX_RETREQSTATE, FldRealValue );
     end;
  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
  
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     DL_ListNA( ALG_NPTX_RETREQSTATE, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) ) 
     FldRealValue = STATUS_ALL;
     FldShowValue = STATUS_NAME_ALL;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) StAppRetTax_Panel()
  var BeginDate:date;
  var State;

  PRIVATE MACRO Init()        
    AddFieldProc( 0, PNFLD_APP_RET_TAX_DATE,  H_PNFLD_DATE,  @FldProc_Date);
    AddFieldProc( 0, PNFLD_APP_RET_TAX_STATE, H_PNFLD_STATE, @FldProc_State, State, 21, 5);
  END;

  PRIVATE MACRO GetFieldValue(fldNum:integer):variant
    var showValue:variant, fldValue:variant;

    GetFieldValue(fldNum, @showValue, @fldValue);
    return fldValue;
  END;

  MACRO Run()
    var stat = Run();

    BeginDate = GetFieldValue(PNFLD_APP_RET_TAX_DATE);
    State     = GetFieldValue(PNFLD_APP_RET_TAX_STATE);

    return stat;
  END;

  initDL_CPanel("sp_rep.lbr", "RTAXREP");
END;