/*
$Name:        settl044.mac
$Module:      Ценные бумаги
$Description: Операция Расчеты на ОРЦБ. Шаг - Зачисление с другого клирингового счета
*/
import "settl.mac";

/* Глобальные структуры с данными для переводов с одного клир счета на другой (то, что вводится в панели поплнения счета))*/
PRIVATE VAR TorgAccData = TRecHandler( "dl_comm.dbt");
PRIVATE VAR MarketSchemOther = TRecHandler( "dlmarket.dbt");
PRIVATE VAR MoneySourceBase:Integer; // Источник средств в первоначальной операции, при создании (не при изменении на шаге)

PRIVATE RECORD Account(account);

/*заполнение суммы "по умолчанию" в форме ввода параметров, вызываемой на данном шаге
  по умолчанию 0, т.к. клиринг счет, с которого выполняется перевод, еще не введен юзером*/
PRIVATE MACRO CalcRestOnMarketAccounts()
  var FD = SPFirstDocDLCOMM( TorgAccData );
  var FiRole;

  FD.SetDlMarketOther(MarketSchemOther);

  if( MoneySourceBase == FD.comm.rec.OperSubKind ) // перевод между клиринговыми счетами только собственных ИЛИ только клиентских средств
     GetSettlFiRoleByOperSubKind(MoneySourceBase,null,@FiRole);
  else // перевод между клиринговыми счетами собственных И клиентских средств
     GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,null,@FiRole);
  end;

  if( FD.IsExistAccount( "Клиринговый счет", null, true, FiRole, Account, null, FD.comm.rec.CommDate, TorgAccData.rec.Currency ) )
     TorgAccData.rec.hidden_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
  end; 

  if( FD.comm.rec.FIID > 0 )
    if( FD.IsExistAccount( "Клиринговый счет", null, true, FiRole, Account, null, FD.comm.rec.CommDate, TorgAccData.rec.FIID ) )
       TorgAccData.rec.Currency_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
    end; 
  end; 
END;

PRIVATE MACRO CheckRestOnClirAccounts()
  return ПроверитьОстаткиНаКлирСчетахСКотВыпПеревод(TorgAccData,MarketSchemOther,true, MoneySourceBase);
END;

macro ExecuteStep( Doc, adr )

  if( not ПереводСредствСДругогоНаТекущКлирСчет( Doc, TorgAccData, MarketSchemOther, MoneySourceBase ) )
     return 1;
  end;

  return 0;
end;

