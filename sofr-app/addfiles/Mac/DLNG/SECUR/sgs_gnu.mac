import FIInter, RSD, "loadRUData.mac";

//var fininstr = TRecHandler("fininstr.dbt");
//var Avoir = TRecHandler("Avoiriss.dbt");
avrinvst = TBFile("avrinvst");
var stat, cmd, rs, query, lfiid, gnu, rep1=0, rep2=0;
var cmd2;

macro correct_gnu
	query = "select * from dfininstr_Dbt where  t_fi_kind=2 and t_avoirkind<>5 and t_fiid>10 and t_fiid in (select t_fiid from davoiriss_Dbt where t_taxgroup = 0 ) ";
	cmd = RSDCommand(query);
	rs = RSDRecordSet(cmd);
       while (rs.movenext)
	    lfiid = rs.value("t_fiid");
	    rep1 = rep1 + 1;
  	    ПолучитьФинИн( lfiid, fininstr, Avoiriss );
	    avrinvst.rec.FIID = lfiid;
            if( not avrinvst.GetEQ() )
               stat = 1;
            end;

            gnu = ОпределитьГНУ_2( fininstr, Avoiriss, avrinvst);
	    if (gnu > 0 )
		rep2 = rep2 + 1;
		cmd2 = RSDCommand("update davoiriss_Dbt set t_taxgroup=? where t_fiid=?");
	    	cmd2.AddParam("", RSDBP_IN, gnu);
	    	cmd2.AddParam("", RSDBP_IN, lfiid);
		cmd2.execute();
	    end;	
        end;
        [Общее число бумаг с нулевой группой НУ = ####] (rep1);
        [Исправлено бумаг = ####] (rep2);

end;            

correct_gnu();