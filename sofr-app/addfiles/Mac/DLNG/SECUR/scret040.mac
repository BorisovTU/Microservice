/*
$Name:         scret040.mac
$Module:       Ценные бумаги
$Description:  Операция Погашение облигаций Шаг - Зачисление средств владельцу
*/
import   InsCarryDoc, "sp_car.mac", "sp_cars.mac", "spserv.mac", "sp_catac.mac", "sp_voop.mac";

macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step )
   record deal(dl_tick);
   var    FD, dat, MarketAcc = "", Amount = $0;
   var PayerAccountBuff = TRecHandler( "account" );
   var ReceiverAccountBuff = TRecHandler( "account" );
   var ReceiverAccount, ReceiverFIID;

   SetBuff( deal, FDoc );
   FD = SPFirstDoc ( deal, false );
  
   GetOprDate( FD.GetKindDate(DATE_DEALPAY), dat );

   if( dat > {curdate} )
     MsgBox ("Преждевременное выполнение шага запрещено.");
     return 1;
   end;

   if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERY, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
     return 1;
   end;

   if(УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_DELIVERY), DLRQ_STATE_EXEC, dat) != 0)
     return 1;
   end;

   if( ( IsBROKER(FD.Group) ) OR (FD.СделкаОРЦБ()) OR (FD.tick.rec.CarryWrt == UNSET_CHAR))
     if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYMENT, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
       return 1;
     end;

     if(FD.ExistRQMoney(DLRQ_TYPE_PAYMENT))
     if(УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_PAYMENT), DLRQ_STATE_EXEC, dat) != 0)
       return 1;
     end;
   end;
   end;

   return 0;
end;