/**
 @file cat_tickexternalop_check.mac
 
  # tag
 - functional_block:
 - code_type:Event_handler
 - Категории
 
  # changeLog
 |date       |author       |tasks                                                     |note                                                        
 |-----------|-------------|----------------------------------------------------------|-------------------------------------------------------------
 |17.06.2025 |Сенников И.В.|BOSS-3444                                                 | Создание
 */
var AcceptedActionCategory;

import SecInter, oralib, "nptxfun.mac";

private macro GetContrIdFromTick(objid)
  var sql =  
    " SELECT T_CLIENTCONTRID "
   +"   FROM DDL_TICK_DBT "
   +"  WHERE     T_DEALID = ? ";
  var ds = execSqlSelect(sql, makeArray(sqlParam("objid", objid)));
  if (ds.MoveNext())
    return SQL_ConvTypeInteger(ds.value("T_CLIENTCONTRID"));
  end;
  return 0;
end;


private macro GetCurValueIsOn(objid)
  var sql =  
    " SELECT 1 "
   +"   FROM dobjatcor_dbt "
   +"  WHERE     t_objecttype = 101 "
   +"        AND t_groupid = 111 "
   +"        AND t_attrid = 2 "
   +"        AND t_object = :obj ";
  var ds = execSqlSelect(sql, makeArray(sqlParam("obj", objid)));
  return ds.MoveNext();
end;

/**
@brief Функция проверки категории на доступность редактирования
@param[in] ObjectType Тип объекта
@param[in] GroupID ID группы из таблицы dobjgroup_dbt
@param[in] AttrID ID устанавливаемого значения категории объекта
@param[in] ObjectID ID объекта
@return V_BOOL true - редактирование категории возможно (по умолчанию), false - запрещено редактирование категории
*/
private macro CheckCategoryAcception(ObjectType, GroupID, AttrID, ObjectID, messageText:@string): Bool
  return true;
end;

/**
@brief Функция проверки признака при установке категории по F2
@param[in] ObjectType Тип объекта
@param[in] GroupID ID группы из таблицы dobjgroup_dbt
@param[in] AttrID ID атрибута
@return V_BOOL true в случае успешной проверки

Отрабатывает после CheckCategoryManual
*/
macro CheckAttributeManual(ObjectType: Integer, GroupID: Integer, AttrID: Integer)
  return false;
end;

/**
@brief Функция проверки признака при установке категории выбором по F9 из списка категорий объекта
@param[in] ObjectType Тип объекта
@param[in] GroupID ID группы из таблицы dobjgroup_dbt
@param[in] AttrID ID атрибута
@return V_BOOL true в случае успешной проверки

Отрабатывает после CheckCategorySet
*/
macro CheckAttribute(ObjectType: Integer, GroupID: Integer, AttrID: Integer)
  return true;
end;

/**
@brief Функция для проверок возможности ручной установке признака по F2
@param[?] param1 Необходимо дополнить
@param[in] GroupID ID группы из таблицы dobjgroup_dbt
@param[in] ObjectType Тип объекта
@param[in] ObjectID ID объекта
@param[in] param2 Необходимо дополнить
@param[in] AttrID_new ID атрибута
*/
macro CheckCategoryManual(param1, GroupID, ObjectType, ObjectID, param2, AttrID_new)
  return false;
end;

/**
@brief Функция для проверок возможности установки признака выбором по F9 из списка категорий объекта
@param[?] param1 Необходимо дополнить
@param[in] GroupID ID группы из таблицы dobjgroup_dbt
@param[in] ObjectType Тип объекта
@param[in] ObjectID ID объекта
@param[in] param2 Необходимо дополнить
@param[in] AttrID_new ID атрибута
*/
macro CheckCategorySet(param1, GroupID, ObjectType, ObjectID, param2, AttrID_new) 
  if (not DL_CheckContrIIS(GetContrIdFromTick(int(ObjectID))))
    if (GetCurValueIsOn(ObjectID) != (AttrID_new == 2))
      setparm(0, 3);
      return "Внимание! При изменении категории изменится значение признака \"Ц/б не учитывались на ИИС\" и право на ЛВД. Продолжить?";
    end;
  end;
  return true;
end;

/*удаление признака категории для объекта*/
macro CheckCategoryDelete(param1, GroupID, ObjectType, ObjectID, param2, AttrID_new, param3)
  if (not DL_CheckContrIIS(GetContrIdFromTick(int(ObjectID))))
    if (AttrID_new == 2)
      setparm(0, 3);
      return "Внимание! При изменении категории изменится значение признака \"Ц/б не учитывались на ИИС\" и право на ЛВД. Продолжить?";
    end;
  end;
  return true;
end;