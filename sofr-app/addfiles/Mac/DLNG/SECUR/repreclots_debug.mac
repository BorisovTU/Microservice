/*
$Name:        repreclots.mac
$Module:      Ценные бумаги
$Description: Отчет "Сверка параметров лотов с данными бухгалтерского учета"
*/
import "repreclots_form.mac", "spRepFn2.mac", "globals.mac","dlmisc.mac";

file TempFile( "repporst.tmp" ) write;

private const
   /* Идентификаторы учетных портфелей. */
   PortfID_Undef         = 0,
   PortfID_SSPU          = 1,  /* ССПУ_ЦБ */                    
   PortfID_SSSD          = 2,  /* СССД_ЦБ */
   PortfID_Contr         = 3,  /* ПКУ */
   PortfID_Promissory    = 4,  /* ПДО */
   PortfID_ASCB          = 5,  /* АС_ЦБ */
   PortfID_Back          = 6,  /* ПВО */
   PortfID_Unadmitted    = 7;  /* БПП */

PRIVATE CLASS RecLOtsData
   var
      RepDate        = Date(0,0,0),       
      SSPU           = "X",            
      SSSD           = "X",           
      ASCB           = "X",          
      BPP            = "X",           
      PVO            = "X",           
      PKU            = "X",           
      PDO            = "X",           
      AvrCode        = -1,       
      IsUseApostrofs = "X";

   var
      WasCollectedData  = false,
      UniqStr           = TUniqStrCollector,
      PortfNameArray    = TArray;

   PortfNameArray[PortfID_Undef]       = "Undefined";
   PortfNameArray[PortfID_SSPU]        = SSPUPORTFNAME;
   PortfNameArray[PortfID_SSSD]        = SSSDPORTFNAME;
   PortfNameArray[PortfID_ASCB]        = ASCBPORTFNAME;
   PortfNameArray[PortfID_Unadmitted]  = UNADMITEDPORTFNAME;
   PortfNameArray[PortfID_Back]        = BACKPORTFNAME;
   PortfNameArray[PortfID_Contr]       = CONTRPORTFNAME;
   PortfNameArray[PortfID_Promissory]  = PROMISSPORTFNAME;

END;

PRIVATE VAR Data   = RecLOtsData();
PRIVATE VAR m_Form = DL_RecLOts_Panel();

PRIVATE MACRO UpdateFormFields():INTEGER
  Data.RepDate  =  m_Form.GetFieldValue( PNFLD_REPRECLOTS_DATE ) - 1; /*будем брать данные на конец предшествующей даты*/
  Data.SSPU     = m_Form.GetFieldValue( PNFLD_REPRECLOTS_SSPU );
  Data.SSSD     = m_Form.GetFieldValue( PNFLD_REPRECLOTS_SSSD );
  Data.ASCB     = m_Form.GetFieldValue( PNFLD_REPRECLOTS_ASCB );
  Data.BPP      = m_Form.GetFieldValue( PNFLD_REPRECLOTS_BPP );
  Data.PVO      = m_Form.GetFieldValue( PNFLD_REPRECLOTS_PVO );
  Data.PKU      = m_Form.GetFieldValue( PNFLD_REPRECLOTS_PKU );
  Data.PDO      = m_Form.GetFieldValue( PNFLD_REPRECLOTS_PDO );
  Data.AvrCode  = m_Form.GetFieldValue( PNFLD_REPRECLOTS_AVRCODE );
  Data.IsUseApostrofs  = m_Form.GetFieldValue( PNFLD_REPRECLOTS_WITH_APOSTROFS );
END;

private const StatLine = "Выпуск отчета \"Сверка параметров лотов с данными бухгалтерского учета\"";

/* Данные одной строки отчета. */
class TLineSummary
   var
      FIID,                 
      Issuer,               
      AvrName,              
      AvrType,              
      LSIN,                 
      ISIN,                 
      Issued,               
      DrawDate,             
      CoupDrawDate,         
      FaceValue,            
      FaceValCcy,           
      Amount,               
      IncomeRate,             
      BuyCostCUR,           
      BuyCostNMN,           
      OutLay,               
      NKDBuy,               
      CostIn,               
      CostInAcc,            
      CostInAccRest,        
      CostInAccRestRUB,
      OverAmount,           
      OverAmountAcc,        
      OverAmountAccRest,    
      OverAmountAccRestRUB,    
      OverAmountAcc_P,
      OverAmountAccRest_P,
      OverAmountAccRest_PRUB,
      OverAmountAcc_M,
      OverAmountAccRest_M,
      OverAmountAccRest_MRUB,
      Income,               
      IncomeAcc,            
      IncomeAccRest,        
      IncomeAccRestRUB,        
      BonusRest,            
      BonusRestAcc,         
      BonusRestAccRest,     
      BonusRestAccRestRUB,     
      Discount,             
      DiscountAcc,          
      DiscountAccRest,      
      DiscountAccRestRUB,      
      QCategory,            
      ReserveSum,           
      ReserveSumAcc,        
      ReserveSumAccRest,    
      ReserveSumAccRestRUB,
      PDD_ReserveSum,       
      PDD_ReserveSumAcc,    
      PDD_ReserveSumAccRest,
      PDD_ReserveSumAccRestRUB,
      SumPrecision,
      FaceValueFI,
      CorrSum,
      CorrAcc,
      CorrAccRest,
      CorrAccRestRUB,
      CorrAcc_M,
      CorrAccRest_M,
      CorrAccRest_MRUB,
      CorrAcc_P,
      CorrAccRest_P,
      CorrAccRest_PRUB,
      CorrDelta,
      CorrEstReserveSum,
      CorrEstReserveAcc,
      CorrEstReserveAccRest,
      CorrEstReserveAccRestRUB,
      CorrEstReserveAcc_M,
      CorrEstReserveAccRest_M,
      CorrEstReserveAccRest_MRUB,
      CorrEstReserveAcc_P,
      CorrEstReserveAccRest_P,
      CorrEstReserveAccRest_PRUB,
      CorrEstReserveDelta,
      UNKDSum,
      UNKDAcc,
      UNKDAccRest;

      record AccBuff(account);



   macro ClearSum()
      Amount                  = 0.;
      BuyCostCUR              = "";
      BuyCostNMN              = "";
      OutLay                  = $0;
      NKDBuy                  = $0;
          
      CostIn                  = $0;
      CostInAcc               = "";
      CostInAccRest           = $0;
          
      OverAmount              = $0;
      OverAmountAcc           = null;
      OverAmountAccRest       = $0;
      OverAmountAcc_P         = null;
      OverAmountAccRest_P     = $0;
      OverAmountAcc_M         = null;
      OverAmountAccRest_M     = $0;
          
      Income                  = $0;
      IncomeAcc               = null;
      IncomeAccRest           = $0;
          
      BonusRest               = $0;
      BonusRestAcc            = null;
      BonusRestAccRest        = $0;
          
      Discount                = $0;
      DiscountAcc             = null;
      DiscountAccRest         = $0;

      ReserveSum              = $0;
      ReserveSumAcc           = null;
      ReserveSumAccRest       = $0;

      PDD_ReserveSum          = $0;
      PDD_ReserveSumAcc       = null;
      PDD_ReserveSumAccRest   = $0;

      CorrSum                 = $0;
      CorrAcc                 = null;
      CorrAccRest             = $0;
      CorrAcc_M               = null;
      CorrAccRest_M           = $0;
      CorrAcc_P               = null;
      CorrAccRest_P           = $0;
           
      CorrEstReserveSum       = $0;
      CorrEstReserveAcc       = null;
      CorrEstReserveAccRest   = $0;
      CorrEstReserveAcc_M     = null;
      CorrEstReserveAccRest_M = $0;
      CorrEstReserveAcc_P     = null;
      CorrEstReserveAccRest_P = $0;  
      UNKDSum 		      = $0;
      UNKDAcc 		      = null;
      UNKDAccRest 	      = $0;
   end;

   macro ClearAvrInfo()
      FIID                   = -1;     
      Issuer                 = "";                       
      AvrName                = "";          
      AvrType                = "";          
      LSIN                   = "";          
      ISIN                   = "";          
      Issued                 = "";          
      IncomeRate             = $0;          
      DrawDate               = "";          
      CoupDrawDate           = "";          
      FaceValue              = "";          
      FaceValCcy             = $0;          
      QCategory              = "";                                           
      SumPrecision           = 0;//точность вывода кол-ва
      FaceValueFI            = 0;
   end;

   /* Конструктор */
   ClearAvrInfo();
   ClearSum();
end;

PRIVATE CLASS CRecLOts( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()
     m_Report.PrintFormatString( "#", "N1_H0", string(Data.RepDate + 1) );
     m_Report.PrintFormatString( "#", "N1_H1", m_Report.H1() );
     m_Report.PrintFormatString( "#", "N1_H2", m_Report.H2() );
     
     m_Report.RegisterTable( "N1_MainTable", "",
                             "N1_A1", 
                             "N1_A2", 
                             "N1_A3",  
                             "N1_A4", 
                             "N1_A5", 
                             "N1_A6", 
                             "N1_A7", 
                             "N1_A8", 
                             "N1_A9", 
                             "N1_A10",
                             "N1_A11",
                             "N1_A12",
                             "N1_A13",
                             "N1_A14",
                             "N1_A15", 
                             "N1_A16",  
                             "N1_A17",
                             "N1_A18",
                             "N1_A19",
                             "N1_A19_1",
                             "N1_A20",
                             "N1_A21",
                             "N1_A22",
                             "N1_A23",
                             "N1_A23_1",
                             "N1_A24",
                             "N1_A25",
                             "N1_A26",
                             "N1_A27",
                             "N1_A27_1",
                             "N1_A28",
                             "N1_A51",
                             "N1_A52",
                             "N1_A53",
                             "N1_A53_1",
                             "N1_A54",
                             "N1_A31",
                             "N1_A32",
                             "N1_A33",
                             "N1_A33_1",
                             "N1_A34",
                             "N1_A56",
                             "N1_A57",
                             "N1_A58",
                             "N1_A58_1",
                             "N1_A59",
                             "N1_A39",
                             "N1_A40",
                             "N1_A41",
                             "N1_A42",
                             "N1_A42_1",
                             "N1_A43",
                             "N1_A44",
                             "N1_A45",
                             "N1_A46",
                             "N1_A46_1",
                             "N1_A47",
                             "N1_A60",
                             "N1_A61",
                             "N1_A62",
                             "N1_A62_1",
                             "N1_A63",
                             "N1_A64",
                             "N1_A65",
                             "N1_A66",
                             "N1_A66_1",
                             "N1_A67"
                          );
         
  END;

  MACRO PrintTableLine()
      m_Report.PrintTableLine( "N1_A1",  m_Report.Issuer(),                null,
                               "N1_A2",  m_Report.AvrName(),               null,
                               "N1_A3",  m_Report.AvrType(),               null,
                               "N1_A4",  m_Report.LSIN(),                  null,
                               "N1_A5",  m_Report.ISIN(),                  null,
                               "N1_A6",  m_Report.Issued(),                null,
                               "N1_A7",  m_Report.DrawDate(),              null,
                               "N1_A8",  m_Report.CoupDrawDate(),          null,
                               "N1_A9",  m_Report.FaceValue(),             null,
                               "N1_A10", m_Report.FaceValCcy(),            null,
                               "N1_A11", m_Report.Amount(),                m_Report.SumPrecision(),
                               "N1_A12", m_Report.IncomeRate(),            null,
                               "N1_A13", m_Report.BuyCostCUR(),            null,
                               "N1_A14", m_Report.BuyCostNMN(),            null,
                               "N1_A15", m_Report.OutLay(),                null,
                               "N1_A16", m_Report.NKDBuy(),                null,
                               "N1_A17", m_Report.CostIn(),                null,
                               "N1_A18", m_Report.CostInAcc(),             null,
                               "N1_A19", m_Report.CostInAccRest(),         null,
                               "N1_A19_1", m_Report.CostInAccRestRUB(),         null,
                               "N1_A20", m_Report.CostInDelta(),           null,
                               "N1_A21", m_Report.OverAmount(),            null,
                               "N1_A22", m_Report.OverAmountAcc(),         null,
                               "N1_A23", m_Report.OverAmountAccRest(),     null,
                               "N1_A23_1", m_Report.OverAmountAccRestRUB(),     null,
                               "N1_A24", m_Report.OverAmountDelta(),       null,
                               "N1_A25", m_Report.Income(),                null,
                               "N1_A26", m_Report.IncomeAcc(),             null,
                               "N1_A27", m_Report.IncomeAccRest(),         null,
                               "N1_A27_1", m_Report.IncomeAccRestRUB(),         null,
                               "N1_A28", m_Report.IncomeDelta(),           null,
                               "N1_A51", m_Report.BonusRest(),             null,
                               "N1_A52", m_Report.BonusRestAcc(),          null,
                               "N1_A53", m_Report.BonusRestAccRest(),      null,
                               "N1_A53_1", m_Report.BonusRestAccRestRUB(),      null,
                               "N1_A54", m_Report.BonusRestDelta(),        null,
                               "N1_A31", m_Report.Discount(),              null,
                               "N1_A32", m_Report.DiscountAcc(),           null,
                               "N1_A33", m_Report.DiscountAccRest(),       null,
                               "N1_A33_1", m_Report.DiscountAccRestRUB(),       null,
                               "N1_A34", m_Report.DiscountDelta(),         null,
                               "N1_A56", m_Report.CorrSum(),               null,
                               "N1_A57", m_Report.CorrAcc(),               null,
                               "N1_A58", m_Report.CorrAccRest(),           null,
                               "N1_A58_1", m_Report.CorrAccRestRUB(),           null,
                               "N1_A59", m_Report.CorrDelta(),             null,
                               "N1_A39", m_Report.QCategory(),             null,
                               "N1_A40", m_Report.ReserveSum(),            null,
                               "N1_A41", m_Report.ReserveSumAcc(),         null,
                               "N1_A42", m_Report.ReserveSumAccRest(),     null,
                               "N1_A42_1", m_Report.ReserveSumAccRestRUB(),     null,
                               "N1_A43", m_Report.ReserveSumDelta(),       null,
                               "N1_A44", m_Report.PDD_ReserveSum(),        null,
                               "N1_A45", m_Report.PDD_ReserveSumAcc(),     null,
                               "N1_A46", m_Report.PDD_ReserveSumAccRest(), null,
                               "N1_A46_1", m_Report.PDD_ReserveSumAccRestRUB(), null,
                               "N1_A47", m_Report.PDD_ReserveSumDelta(),   null,
                               "N1_A60", m_Report.CorrEstReserveSum(),     null,
                               "N1_A61", m_Report.CorrEstReserveAcc(),     null,
                               "N1_A62", m_Report.CorrEstReserveAccRest(), null,
                               "N1_A62_1", m_Report.CorrEstReserveAccRestRUB(), null,
                               "N1_A63", m_Report.CorrEstReserveDelta(),   null,
                               "N1_A64", m_Report.UNKDSum(),     null,
                               "N1_A65", m_Report.UNKDAcc(),     null,
                               "N1_A66", m_Report.UNKDAccRest(), null,
                               "N1_A66_1", m_Report.UNKDAccRestRUB(), null,
                               "N1_A67", m_Report.UNKDDelta(),   null
                             );
  END;                                                                                                                                                                         

  MACRO PrintHeadLine(HeadLine:string)
      m_Report.merge( "N1_A1", "N1_A54" );
      m_Report.PrintTableLine( "N1_A1",  HeadLine, null)
  END;                                                                                                                                                                         

  MACRO EndReport();
     m_Report.EndTable();
//     m_Report.AddStandardFooter( "N1_" );
  END;         

END;

PRIVATE CLASS (DL_CReportTemplate) SP_RecLOts_Report
  var fininstr    = TRecHandler( "fininstr" );
  var WasCollectedData = false;
  var LineSumm = TLineSummary();
  var m_PrevPortf, m_PrevIsQouted, m_PrevFiid, m_PrevAccount;
  var m_H1, m_H2;

  PRIVATE MACRO PrintMode():INTEGER/*печатаем только в Excel, тк выбора нет*/
     return DL_OUTREPORT_EXCEL;
  END;                                                                                                                                                                         

  PRIVATE MACRO DefinePortf( LotBuy, Group )
     if( (Data.SSPU) and
         (LotBuy.Portfolio == KINDPORT_SSPU) and (LotBuy.State == PM_WRTSUM_FORM) )
        return PortfID_SSPU;

     elif( (Data.SSSD) and
           (LotBuy.Portfolio == KINDPORT_SSSD) and (LotBuy.State == PM_WRTSUM_FORM) )
        return PortfID_SSSD;

     elif( (Data.ASCB) and
           (LotBuy.Portfolio == KINDPORT_ASCB) and (LotBuy.State == PM_WRTSUM_FORM) )
        return PortfID_ASCB;

     elif( (Data.PKU) and
           (LotBuy.Portfolio == KINDPORT_CONTR) and (LotBuy.State == PM_WRTSUM_FORM) )
        return PortfID_Contr;

     /*В портфель ПВО отбираются лоты, изначально купленные по сделкам обратного РЕПО БПП, 
       не проданные впоследствии*/
     elif( (Data.PVO) and ((IsREPO(Group) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY_BO)) OR IsAVRWRTIN(Group)) and
           ((LotBuy.Portfolio == KINDPORT_BACK) and (LotBuy.State == PM_WRTSUM_FORM) 
             and (LotBuy.Amount != 0) and (LotBuy.AmountBD == 0) ) 
         )
        return PortfID_Back;
     /*Для портфеля БПП в отчет отбираются лоты, которые проданы из портфелей "ССПУ_ЦБ", "СССД_ЦБ", "АС_ЦБ", "ПКУ" и имеют признак "БПП"*/
     elif( (Data.BPP) and
           ( (LotBuy.Portfolio == KINDPORT_SSPU) OR (LotBuy.Portfolio == KINDPORT_SSSD) OR (LotBuy.Portfolio == KINDPORT_ASCB) OR (LotBuy.Portfolio == KINDPORT_CONTR) ) and
            (LotBuy.State == PM_WRTSUM_SALE_BPP)
         )
        return PortfID_Unadmitted;
     elif( (Data.PDO) and
           (LotBuy.Portfolio == KINDPORT_PROMISSORY) and (LotBuy.State == PM_WRTSUM_FORM) )
        return PortfID_Promissory;
     end;

     return PortfID_Undef;
  END;                                                                                                                                                                         

   macro ОбработатьВыборкуЛотов( Select:string, PortfStr:string )

      var dl_tick  = TRecHandler( "dl_tick" ),
          account  = TRecHandler( "account" );
      var Group, IsBack, LegKind;
      var selectbpp, pmwbpp;
      var pmwrtsum, Query;
      var FD, PortfID, AccountNum, AccountChapter, IssShName, AvKindShName;
      var prevPortfID = 0, prevFIID = -1, prevAccountNum = "", prevAccountChapter = 0;
      var cnt = 0;

      InitProgress(-1, StatLine, "Отбор лотов (" + PortfStr + ")");

      var q =   " select q.*, "
              + "        pt.t_ShortName as IssShName, "
              + "        avrk.t_ShortName as AvKindShName"
              + "   from ("+Select+") q, dfininstr_dbt fin, davrkinds_dbt avrk, dparty_dbt pt "
              + "  where fin.t_FIID = q.t_FIID "
              + "    and avrk.t_FI_Kind = fin.t_FI_Kind "
              + "    and avrk.t_AvoirKind = fin.t_AvoirKind "
              + "    and pt.t_PartyID = RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) "
              + " order by q.t_FIID, q.t_Portfolio, q.t_State";

      Query = DL_RSDCommand(q);
      
      Query.AddParam(Data.RepDate);

      cnt = Query.GetCount();

      RemProgress();

      if(cnt > 0)
        var repdataCache = RsbSQLInsert("repporst.tmp");
        var repdataArr = TArray();
        var sz = 0;

        InitProgress(cnt, StatLine, "Перебор лотов (" + PortfStr + ")" );

        pmwrtsum = Query.execute();
        var i = 0;
        while( pmwrtsum.Next() )
        
           if( ПолучитьСделкуПоЛоту( pmwrtsum, dl_tick, true, true ) )
              Group = GetOperationGroup(dl_tick.rec.DealType);
       
              /* Получим учетный портфель. */
              PortfID = DefinePortf(pmwrtsum, Group);
              if( PortfID != PortfID_Undef )

                 FD = NULL;

                 if(((PortfID == KINDPORT_SSPU) or
                     (PortfID == KINDPORT_SSSD) or
                     (PortfID == KINDPORT_ASCB) or
                     (PortfID == KINDPORT_CONTR) or
                     (PortfID == KINDPORT_PROMISSORY)
                    ) and
                    (prevPortfID == PortfID) and
                    (prevFIID == pmwrtsum.FIID)
                   )
                   AccountNum     = prevAccountNum;
                   AccountChapter = prevAccountChapter;
                 else
                   /*для БПП вытаскиваем исходную покупку и смотрим счет БПП по ней*/
                   if( PortfID == PortfID_Unadmitted )
               
                      selectbpp = DL_RSDCommand("select * from dpmwrtsum_dbt where t_SumID = ?");  
                      selectbpp.addParam(pmwrtsum.Parent);
                      pmwbpp = selectbpp.execute();
               
                      if( pmwbpp.movenext() )
                         if( ПолучитьСделкуПоЛоту( pmwbpp, dl_tick, true, true ) )
                            FD = repSPFirstDoc( dl_tick, false, pmwbpp.SumID );
                         end;
                      end;
                   end;

                   if( FD == NULL )
                      LegKind = GetLegKindByLotDeal(pmwrtsum, dl_tick.rec);
                      IsBack  = (LegKind == LEG_KIND_DL_TICK_BACK);
                      FD = repSPFirstDoc( dl_tick, IsBack, pmwrtsum.SumID );
                   end;

                   account = ЛСчетНаКоторомУчитываетсяЛот( pmwrtsum, Data.RepDate, FD );

                   AccountNum     = account.Account;
                   AccountChapter = account.Chapter
                 end;
       
                 sz = repdataArr.size;
                 repdataArr[sz] = TRecHandler("repporst.tmp");

                 repdataArr[sz].Clear();

                 repdataArr[sz].rec.PortfID        = PortfID;
                 repdataArr[sz].rec.IsQuoted       = 1;
                 repdataArr[sz].rec.DealID         = 0;//FD.tick.rec.DealID;
                 repdataArr[sz].rec.LegKind        = 0;//FD.dl_leg.rec.LegKind;
                 repdataArr[sz].rec.FIID           = pmwrtsum.FIID;
                 repdataArr[sz].rec.LotAmount      = pmwrtsum.Amount;
                 repdataArr[sz].rec.IssShName      = pmwrtsum.IssShName;
                 repdataArr[sz].rec.AvKindShName   = pmwrtsum.AvKindShName;
                 repdataArr[sz].rec.Account        = AccountNum;
                 /*в docID сохраним SumID лота*/
                 repdataArr[sz].rec.DocID          = pmwrtsum.SumID;
                 /*в PartNum сохраним главу счета вложений*/
                 repdataArr[sz].rec.PartNum        = AccountChapter;

                 WasCollectedData = true;

                 prevPortfID        = PortfID;
                 prevFIID           = pmwrtsum.FIID;
                 prevAccountNum     = AccountNum;
                 prevAccountChapter = AccountChapter;

              end;
           end;
           UseProgress(i = i + 1);
        end;

        repdataCache.AddRecordArray(repdataArr);

        repdataCache.Insert();

        RemProgress();
      end;
   end;

  PRIVATE MACRO CollectData()

     var Select = "", Point = false, Num = 0;

     WasCollectedData = false;

     InitProgress(3, StatLine, "Перебор набора портфелей");

     /*БПП*/
     if( Data.BPP )
        Select = " SELECT T1.* " +
                 "   FROM (SELECT /*+LEADING(wrtsum)*/ V1.* FROM v_scwrthistex V1, dpmwrtsum_dbt wrtsum " +   
                 "          WHERE wrtsum.t_SumID = V1.t_SumID " +
                 "            AND wrtsum.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +  
                 "            AND wrtsum.t_party = -1 " +   
                 "            AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +  
                 "            AND wrtsum.t_kind = 210 " +
                 "            AND V1.t_state = " + string(PM_WRTSUM_SALE_BPP) +
                 "            AND V1.t_portfolio in( " + string(KINDPORT_SSPU) + "," + string(KINDPORT_SSSD) + "," + string(KINDPORT_ASCB) + "," + string(KINDPORT_CONTR) + ") ";

        if( Data.AvrCode > 0 )
           Select = Select + " AND wrtsum.t_FIID = " + Data.AvrCode;
        end;

        Select = Select + " ) T1 " +
                          " WHERE T1.t_instance = (SELECT MAX (V11.t_instance) " +
                          "                          FROM v_scwrthistex V11 " +
                          "                         WHERE V11.t_sumid = T1.t_sumid " +
                          "                           AND V11.t_changedate <= " + GetSQLDate(Data.RepDate) + ") ";

        ОбработатьВыборкуЛотов(Select, "БПП");
     end;
     UseProgress(Num = Num + 1);

     /*"ССПУ_ЦБ" /"СССД_ЦБ" / "АС_ЦБ" / "ПДО" / "ПКУ"*/
     if( Data.SSPU or Data.SSSD or Data.ASCB or Data.PKU or Data.PDO )

        /*по kind = 210 отберем лоты, вернувшиеся из БПП
                    20 обычные покупки
                    40,110, 130 зачисления, зачисления при конвертации, зачисления в глоб. опции
                    90 зачисления при перемещении
        */

        Select = " SELECT T2.* " +
                 "   FROM (SELECT /*+LEADING(wrtsum)*/ V2.* FROM v_scwrthistex V2, dpmwrtsum_dbt wrtsum " +
                 "          WHERE wrtsum.t_SumID = V2.t_SumID " +
                 "            AND wrtsum.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
                 "            AND wrtsum.t_party = -1 " +
                 "            AND wrtsum.t_dockind in(" + string(DLDOC_PAYMENT) + ", " +
                                                          string(DL_ISSUE_UNION) + ", " +
                                                          string(DL_MOVINGDOC)  + ") " +
                 "            AND wrtsum.t_dealid > 0 " +
                 "            AND wrtsum.t_kind in(20,210,40,110,130,90) " +
                 "            AND V2.t_Amount != 0 " +
                 "            AND V2.t_state = " + string(PM_WRTSUM_FORM);

        if( Data.AvrCode > 0 )
           Select = Select + " AND wrtsum.t_FIID = "+Data.AvrCode;
        end;

        Select = Select + " AND V2.t_Portfolio in ( ";
        if( Data.SSPU )
           Select = Select + string(KINDPORT_SSPU);
           Point = true;
        end;
        if( Data.SSSD )
           if(Point)
              Select = Select + ",";
           end;
           Select = Select + string(KINDPORT_SSSD);
           Point = true;
        end;
        if( Data.PKU )
           if(Point)
              Select = Select + ",";
           end;
           Select = Select + string(KINDPORT_CONTR);
           Point = true;
        end;
        if( Data.ASCB )
           if(Point)
              Select = Select + ",";
           end;
           Select = Select + string(KINDPORT_ASCB);
           Point = true;
        end;
        if( Data.PDO )
           if(Point)
              Select = Select + ",";
           end;
           Select = Select + string(KINDPORT_PROMISSORY);
        end;

        Select = Select + " )) T2 " +
                          " WHERE T2.t_instance = (SELECT MAX (V22.t_instance) " +
                          "                          FROM v_scwrthistex V22 " +
                          "                         WHERE V22.t_sumid = T2.t_sumid " +
                          "                           AND V22.t_changedate <= " + GetSQLDate(Data.RepDate) + ") ";
        Point = false;

        ОбработатьВыборкуЛотов(Select, "ССПУ_ЦБ, СССД_ЦБ, АС_ЦБ, ПДО, ПКУ");
     end;
     UseProgress(Num = Num + 1);

     /* ПВО (РЕПО/зачисления) */
     if( Data.PVO )

        Select = " SELECT T3.* " +
                 "   FROM (SELECT /*+LEADING(wrtsum)*/ V3.* FROM v_scwrthistex V3, dpmwrtsum_dbt wrtsum " +
                 "          WHERE wrtsum.t_SumID = V3.t_SumID " +
                 "            AND wrtsum.t_Party = -1 " +
                 "            AND wrtsum.t_dockind in(" + string(DLDOC_PAYMENT) + ", " + string(DL_ISSUE_UNION) + ") " +   
                 "            AND ( (V3.t_State = " + string(PM_WRTSUM_FORM) + " and " +
                 "                   wrtsum.t_DealID = (select tick.t_DealID " +
                 "                                        from ddl_tick_dbt tick " +
                 "                                       where tick.t_DealID = wrtsum.t_DealID " +
                 "                                         and rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                 "                                         and ( tick.t_DealStatus < 20 or " +
                 "                                               (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(Data.RepDate) + ") " +
                 "                                             ) " +
                 "                                     ) and " +
                 "                   V3.t_Amount != 0 and " +
                 "                   V3.t_AmountBD = 0 and " +
                 "                   wrtsum.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_BUY_BO) +
                 "                  ) " +
                 "                  OR " +
                 "                  wrtsum.t_kind in(40,110,130) " +
                 "                ) " +
                 "            AND V3.t_Portfolio = " + string(KINDPORT_BACK);

        if( Data.AvrCode > 0 )
           Select = Select + " AND wrtsum.t_FIID = " + Data.AvrCode;
        end;

        Select = Select + " ) T3 " +
                          " WHERE T3.t_instance = (SELECT MAX (V33.t_instance) " +
                          "                          FROM v_scwrthistex V33 " +
                          "                         WHERE V33.t_sumid = T3.t_sumid " +
                          "                           AND V33.t_changedate <= " + GetSQLDate(Data.RepDate) + ") ";

        ОбработатьВыборкуЛотов(Select, "ПВО");
     end;

     RemProgressBar;

     return WasCollectedData;
  END;

  PRIVATE macro GetSetBppDate(SumID)

    var Select, pmw;

    Select = DL_RSDCommand( " SELECT T.t_changedate " +
                            "   FROM (SELECT V.* FROM v_scwrthistex V " +
                            "          WHERE V.t_SumID = ?) T " +
                            "  WHERE T.t_instance = (SELECT Min (Vi.t_instance) " +
                            "                        FROM v_scwrthistex Vi " +
                            "                       WHERE Vi.t_sumid = T.t_sumid " +
                            "                         AND Vi.t_action = 50) "
                          );

    Select.addParam(SumID);
    pmw = Select.execute();

    if( pmw.MoveNext() )
        return SQL_ConvTypeDate(pmw.changedate);
    end;

    return date(0,0,0);

  end;

   macro ConvertToRUB(p_account, p_rest)
       var rs, cmd, query, SumInNatCur, valstr, valnum;
       if (strlen(p_account) == 20 )
			valstr = substr(p_account, 6,3);
			if (valstr == "810") 
				return p_rest;
			elif  (valstr == "840") 
				valnum = 7;
			elif  (valstr == "978") 
				valnum = 8;
		 	else msgbox(valstr);
			end;
			SmartConvertSum(SumInNatCur, money(p_rest), Data.RepDate, valnum, NATCUR, true);
			return SumInNatCur;
       end;
       onerror 
       return "";
   end;



  PRIVATE MACRO FillLineSumm(pmwrtsum)

      record AccBuff(account);
      record acnt_ov_negative(account);
      record acnt_ov_positive(account);
      record acnt_corr_negative(account);
      record acnt_corr_positive(account);
      record acnt_unkd(account);

      var SetDate = Date(0,0,0), FiRole_OV, FiRole_PD, FiRole_DD, FiRoleBon, FIRoleR, FiRolePDD;
      
      var FDFin = SPFirstDocFI(DLDOC_ISSUE, pmwrtsum.FIID, pmwrtsum.FIID, pmwrtsum.PortfID, {OurBank}, null, null, null);

      LineSumm.Amount = LineSumm.Amount + pmwrtsum.Amount;

      /*Заполняется только для УП БПП и ПВО: стоимость покупки данного лота*/
      if( (pmwrtsum.PortfID == PortfID_Unadmitted) OR (pmwrtsum.PortfID == PortfID_Back) )
         LineSumm.BuyCostCUR = LineSumm.BuyCostNMN = pmwrtsum.Sum;

         if( pmwrtsum.PortfID == PortfID_Unadmitted ) /*для БПП ищем дату поставки БПП*/
            SetDate = GetSetBppDate(pmwrtsum.SumID);
         else
            SetDate = SQL_ConvTypeDate(pmwrtsum.Date);
         end;

         /*в валюту номинала по курсу на дату поставки*/
         if( pmwrtsum.Currency != LineSumm.FaceValueFI )
            if( not SmartConvertSumDbl(LineSumm.BuyCostNMN, LineSumm.BuyCostNMN, SetDate, pmwrtsum.Currency, LineSumm.FaceValueFI) )
                Data.UniqStr.AddString(GetCurrencyConvertErrorMsg( pmwrtsum.Currency, LineSumm.FaceValueFI, SetDate) );
            end;
         end;
      end;

      LineSumm.OutLay = LineSumm.OutLay + pmwrtsum.Outlay;
      LineSumm.NKDBuy = LineSumm.NKDBuy + pmwrtsum.NKDAMOUNT;

      if( pmwrtsum.PortfID != PortfID_Back )
         var cost;

         if( (pmwrtsum.PortfID == PortfID_Contr) or
             ((pmwrtsum.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_CONTR))
           )
            if( not SmartConvertSumDbl(cost, pmwrtsum.Cost, Data.RepDate, NATCUR, LineSumm.FaceValueFI) )
               Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(NATCUR, LineSumm.FaceValueFI, Data.RepDate));
            end;
         else
            cost = pmwrtsum.Cost;
         end;

         LineSumm.CostIn = LineSumm.CostIn + cost + pmwrtsum.NKDAmount - (pmwrtsum.BegBonus - pmwrtsum.Bonus + pmwrtsum.OldBonus);
      else
         LineSumm.CostIn = pmwrtsum.BalanceCost;
      end;

      LineSumm.OverAmount        = LineSumm.OverAmount        + pmwrtsum.OverAmount;
      LineSumm.Income            = LineSumm.Income            + pmwrtsum.InterestIncome;
      LineSumm.Discount          = LineSumm.Discount          + pmwrtsum.DiscountIncome;
      LineSumm.ReserveSum        = LineSumm.ReserveSum        + pmwrtsum.ReservAmount;
      LineSumm.PDD_ReserveSum    = LineSumm.PDD_ReserveSum    + pmwrtsum.INCOMERESERV;
      LineSumm.CorrSum           = LineSumm.CorrSum           + pmwrtsum.CorrValue + pmwrtsum.CorrIntToEIR;
      LineSumm.CorrEstReserveSum = LineSumm.CorrEstReserveSum + pmwrtsum.CorrEstReserve;

      if( LineSumm.CostInAcc != pmwrtsum.Account )
         LineSumm.CostInAcc = pmwrtsum.Account;

         var CurNATCUR:bool = false;

         if( ((pmwrtsum.PortfID == PortfID_Contr) or ((pmwrtsum.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_CONTR))) and
             (Data.RepDate >= date(1,11,2014))
           )
            CurNATCUR = true;
         end;

         if( GetAccount(pmwrtsum.AccChapter, IIF(CurNATCUR, NATCUR, LineSumm.FaceValueFI), pmwrtsum.Account, AccBuff, true) )
            LineSumm.CostInAccRest = abs(GetRestAccount(AccBuff, Data.RepDate));
            if( CurNATCUR )
               if( not SmartConvertSumDbl(LineSumm.CostInAccRest, LineSumm.CostInAccRest, Data.RepDate, NATCUR, LineSumm.FaceValueFI) )
                  Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(NATCUR, LineSumm.FaceValueFI, Data.RepDate));
               end;
            end;            
         else
            Data.UniqStr.AddString("Счет " + pmwrtsum.Account + " не найден.");
         end;
      end;

      if(  (pmwrtsum.PortfID == PortfID_Back) or 
           (pmwrtsum.PortfID == PortfID_Unadmitted) or 
           (pmwrtsum.PortfID == PortfID_SSSD) or
           (pmwrtsum.PortfID == PortfID_SSPU)
         )
         if( LineSumm.OverAmountAcc == null )
            if( pmwrtsum.PortfID != PortfID_Back )
               var CatCode = "";
               FiRole_OV = GetFIRoleByPortfolio( pmwrtsum.Portfolio );
             
               if( LineSumm.OverAmountAcc_M == null )
                  CatCode = "-Переоценка, ц/б";
                  if(ПарностьСчетовПереоценки())
                    if(pmwrtsum.PortfID == PortfID_SSPU)
                      CatCode = "-Переоценка, ц/б ССПУ_ЦБ";
                    elif(pmwrtsum.PortfID == PortfID_SSSD)
                      CatCode = "-Переоценка, ц/б СССД_ЦБ";
                    end;
                  end;
                  
                  if( FDfin.IsExistAccount(CatCode, null, true, FiRole_OV, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
                     LineSumm.OverAmountAcc_M     = acnt_ov_negative.Account;
                     LineSumm.OverAmountAccRest_M = abs(GetRestAccount(acnt_ov_negative, Data.RepDate));
                  end;
               end;

               if( LineSumm.OverAmountAcc_P == null )
                  CatCode = "+Переоценка, ц/б";
                  if(ПарностьСчетовПереоценки())
                    if(pmwrtsum.PortfID == PortfID_SSPU)
                      CatCode = "+Переоценка, ц/б ССПУ_ЦБ";
                    elif(pmwrtsum.PortfID == PortfID_SSSD)
                      CatCode = "+Переоценка, ц/б СССД_ЦБ";
                    end;
                  end;
                  
                  if( FDfin.IsExistAccount(CatCode, null, true, FiRole_OV, acnt_ov_positive, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
                     LineSumm.OverAmountAcc_P     = acnt_ov_positive.Account;
                     LineSumm.OverAmountAccRest_P = abs(GetRestAccount(acnt_ov_positive, Data.RepDate));
                  end;
               end;
            else
               LineSumm.OverAmountAcc = "на основном";
            end;
         end;
      end;

      if( FI_IsBond(LineSumm.FIID) and
          ((pmwrtsum.PortfID == PortfID_SSPU) or (pmwrtsum.PortfID == PortfID_SSSD) or
           (pmwrtsum.PortfID == PortfID_ASCB) or ((pmwrtsum.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio != KINDPORT_CONTR)) )
        )
         if( (pmwrtsum.PortfID == PortfID_SSPU) or (pmwrtsum.PortfID == PortfID_SSSD) or
             (pmwrtsum.PortfID == PortfID_ASCB) )  

             FiRole_PD = GetFIRoleByPortfolio(pmwrtsum.Portfolio,false,true,false);
             FiRole_DD = GetFIRoleByPortfolio(pmwrtsum.Portfolio,true,false,false);

         elif( pmwrtsum.PortfID == PortfID_Unadmitted )

             FiRole_PD = GetFIRoleByPortfolio(pmwrtsum.Portfolio,false,true,true);
             FiRole_DD = GetFIRoleByPortfolio(pmwrtsum.Portfolio,true,false,true);

         else
             FiRole_PD = GetFIRoleByPortfolio(pmwrtsum.Portfolio,false,true,false);
         end;

         if( LineSumm.IncomeAcc == null )
            if( FDFin.IsExistAccount( "Начисл.ПДД, ц/б", null, true, FiRole_PD, AccBuff, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
               LineSumm.IncomeAcc = AccBuff.Account;
               LineSumm.IncomeAccRest = abs(GetRestAccount( AccBuff, Data.RepDate ));          
            end;
         end;

         if( LineSumm.DiscountAcc == null )
            if( FDFin.IsExistAccount( "Начисл.ПДД, ц/б", null, true, FiRole_DD, AccBuff, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
               LineSumm.DiscountAcc = AccBuff.Account;
               LineSumm.DiscountAccRest = abs(GetRestAccount( AccBuff, Data.RepDate ));                                   
            end;
         end;

         LineSumm.BonusRest = LineSumm.BonusRest + pmwrtsum.BegBonus - pmwrtsum.Bonus + pmwrtsum.OldBonus;

         if( pmwrtsum.PortfID == PortfID_Unadmitted )
            FiRolePDD = GetFIRoleByPortfolio(pmwrtsum.Portfolio, false, false, true, false, true);
            FiRoleBon = GetFIRoleByPortfolioBonus(pmwrtsum.Portfolio, true);
         else
            FiRolePDD = GetFIRoleByPortfolio(pmwrtsum.Portfolio, false, false, false, false, true);
            FiRoleBon = GetFIRoleByPortfolioBonus(pmwrtsum.Portfolio);
         end;

         if( LineSumm.BonusRestAcc == null )
            if( FDFin.IsExistAccount( "Премия, ц/б", null, true, FiRoleBon, AccBuff, MC_PAIRACCMODE_MANUAL, Data.RepDate ) )
               LineSumm.BonusRestAcc = AccBuff.Account;
               LineSumm.BonusRestAccRest = abs(GetRestAccount( AccBuff, Data.RepDate ));
            end;
         end;
      end;
    
      if( ((pmwrtsum.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_SSSD)) OR
          ((pmwrtsum.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_CONTR)) OR
          (pmwrtsum.PortfID == PortfID_SSSD) OR (pmwrtsum.PortfID == PortfID_ASCB) OR
          (pmwrtsum.PortfID == PortfID_Promissory) OR (pmwrtsum.PortfID == PortfID_Contr)
        )

         if( (pmwrtsum.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_SSSD) )
            FIRoleR   = FIROLE_BA_PPR_BPP;
            FiRole_PD = FIROLE_PD_PPR;
         elif( pmwrtsum.PortfID == PortfID_SSSD )
            FIRoleR   = FIROLE_BA_PPR;
            FiRole_PD = FIROLE_PD_PPR;
         elif( pmwrtsum.PortfID == PortfID_ASCB )
            FIRoleR   = FIROLE_BA_PUDP;
            FiRole_PD = FIROLE_PD_PUDP;
         elif( pmwrtsum.PortfID == PortfID_Promissory )
            FIRoleR   = FIROLE_BAINPROMISSORY;
            FiRole_PD = FIROLE_PD_PDO;
         elif( (pmwrtsum.PortfID == PortfID_Contr) OR
               ((pmwrtsum.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_CONTR))
             )
            FIRoleR   = FIROLE_BAINCONTR;
            FiRole_PD = FIROLE_PD_PKU;
         end;

         if( LineSumm.ReserveSumAcc == null )
            if(FDFin.IsExistAccount( "Резерв ц/б", null, true, FIRoleR, AccBuff, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
               LineSumm.ReserveSumAcc = AccBuff.Account;
               LineSumm.ReserveSumAccRest = abs(GetRestAccount( AccBuff, Data.RepDate ));
            end;
         end;
            
         if( LineSumm.PDD_ReserveSumAcc == null )
            if(FDFin.IsExistAccount( "Резерв ц/б", null, true, FiRole_PD, AccBuff, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
               LineSumm.PDD_ReserveSumAcc     = AccBuff.Account;
               LineSumm.PDD_ReserveSumAccRest = abs(GetRestAccount( AccBuff, Data.RepDate ));
            end;
         end;

      end;

      var FiRole = GetFIRoleByPortfolio( pmwrtsum.Portfolio );

      if( LineSumm.CorrAcc_M == null )
         if( FDFin.IsExistAccount("-Корректировка, ц/б", null, true, FiRole, acnt_corr_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
            LineSumm.CorrAcc_M     = acnt_corr_negative.Account;
            LineSumm.CorrAccRest_M = abs(GetRestAccount(acnt_corr_negative, Data.RepDate));
         else
            LineSumm.CorrAcc_M = "";
            LineSumm.CorrAccRest_M = $0;
         end;
      end;

      if( LineSumm.CorrAcc_P == null )
         if( FDFin.IsExistAccount("+Корректировка, ц/б", null, true, FiRole, acnt_corr_positive, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
            LineSumm.CorrAcc_P     = acnt_corr_positive.Account;
            LineSumm.CorrAccRest_P = abs(GetRestAccount(acnt_corr_positive, Data.RepDate));
         else
            LineSumm.CorrAcc_P = "";
            LineSumm.CorrAccRest_P = $0;
         end;
      end;

      if( LineSumm.CorrEstReserveAcc_M == null )
         if( FDFin.IsExistAccount("-Кор_Резерв, ЦБ", null, true, FiRole, acnt_corr_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
            LineSumm.CorrEstReserveAcc_M     = acnt_corr_negative.Account;
            LineSumm.CorrEstReserveAccRest_M = abs(GetRestAccount(acnt_corr_negative, Data.RepDate));
         else
            LineSumm.CorrEstReserveAcc_M     = "";
            LineSumm.CorrEstReserveAccRest_M = $0;
         end;
      end;

      if( LineSumm.CorrEstReserveAcc_P == null )
         if( FDFin.IsExistAccount("+Кор_Резерв, ЦБ", null, true, FiRole, acnt_corr_positive, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
            LineSumm.CorrEstReserveAcc_P     = acnt_corr_positive.Account;
            LineSumm.CorrEstReserveAccRest_P = abs(GetRestAccount(acnt_corr_positive, Data.RepDate));
         else
            LineSumm.CorrEstReserveAcc_P     = "";
            LineSumm.CorrEstReserveAccRest_P = $0;
         end;
      end;

      if( LineSumm.UNKDAcc == null )
         if( FDFin.IsExistAccount("Уплаченный НКД", null, true, FiRole, acnt_unkd, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
            LineSumm.UNKDAcc     = acnt_unkd.Account;
            LineSumm.UNKDAccRest = abs(GetRestAccount(acnt_unkd, Data.RepDate));
         else
            LineSumm.UNKDAcc     = "";
            LineSumm.UNKDAccRest = $0;
         end;
      end;

  END;                                                                                                                                                                         

  PRIVATE MACRO FillOverAmountAcc()
     if( LineSumm.OverAmountAcc == null )
        if( (LineSumm.OverAmountAcc_M != null) and (LineSumm.OverAmount < 0) )
           LineSumm.OverAmountAcc     = LineSumm.OverAmountAcc_M;
           LineSumm.OverAmountAccRest = LineSumm.OverAmountAccRest_M;
        elif( (LineSumm.OverAmountAcc_P != null) and (LineSumm.OverAmount > 0) )
           LineSumm.OverAmountAcc     = LineSumm.OverAmountAcc_P;
           LineSumm.OverAmountAccRest = LineSumm.OverAmountAccRest_P;
        end;
     end;
  END;

  PRIVATE MACRO FillCorrAcc()
     if( LineSumm.CorrAcc == null )
        if( (LineSumm.CorrAcc_M != null) and (LineSumm.CorrSum < 0) )
           LineSumm.CorrAcc     = LineSumm.CorrAcc_M;
           LineSumm.CorrAccRest = LineSumm.CorrAccRest_M;
        elif( (LineSumm.CorrAcc_P != null) and (LineSumm.CorrSum > 0) )
           LineSumm.CorrAcc     = LineSumm.CorrAcc_P;
           LineSumm.CorrAccRest = LineSumm.CorrAccRest_P;
        end;
     end;
  END;

  PRIVATE MACRO FillCorrEstReserveAcc()
     if( LineSumm.CorrEstReserveAcc == null )
        if( (LineSumm.CorrEstReserveAcc_M != null) and (LineSumm.CorrEstReserveSum > 0) )
           LineSumm.CorrEstReserveAcc     = LineSumm.CorrEstReserveAcc_M;
           LineSumm.CorrEstReserveAccRest = LineSumm.CorrEstReserveAccRest_M;
        elif( (LineSumm.CorrEstReserveAcc_P != null) and (LineSumm.CorrEstReserveSum < 0) )
           LineSumm.CorrEstReserveAcc     = LineSumm.CorrEstReserveAcc_P;
           LineSumm.CorrEstReserveAccRest = LineSumm.CorrEstReserveAccRest_P;
        end;
     end;
  END;

  /*заполнение данных по самой ц\б (части данных в LineSumm)*/
  PRIVATE MACRO FillAvrInfo(pmwrtsum)
     var  avoir       = TRecHandler( "avoiriss" ),
          fiwarnt     = TBFile( "fiwarnts", "R", 1 );
     VAR  CoupDrawDate = "", DaysInYear, DaysInCoupon;

     LineSumm.ClearAvrInfo();
     LineSumm.FIID = pmwrtsum.fiid;

     if( ПолучитьФинИн(LineSumm.FIID, fininstr, avoir) )
        InformUser( "Не могу получить ценную бумагу с кодом (FIID = " + string(LineSumm.FIID) + ")", true );
        return;
     end;

     /* Дата погашения купона
        Плановая дата погашения последнего купона выпуска ц/б сделки,
        максимальная из всех дат погашения купонов данного выпуска, но не
        превышающая отчетную дату (выводится только для облигаций) */
     /* Валюта номинала
        Букв. код валюты номинала */
     LineSumm.FaceValCcy = GetFinInstrCcy( fininstr.rec.FaceValueFI, true );
     
     /* Номинал за ед.
        Номинал ц/б в валюте номинала */
     LineSumm.FaceValue = ЧислоCЗаданнойТочностью( DoubleToMoney( GetFaceValue(fininstr.rec.FIID, Data.RepDate) ), 2);
     
     if(( FI_IsBond(fininstr.rec.FIID) ) AND ( FI_IsCouponAvoiriss(fininstr.rec.FIID) ))
        LineSumm.CoupDrawDate = GetCoupon_MaxDrDateOnFrDate( fininstr.rec.FIID, Data.RepDate );
        if( LineSumm.CoupDrawDate != ZeroDate )
           /*ставка дохода по купону*/
           fiwarnt.Clear();
           fiwarnt.rec.IsPartial   = UNSET_CHAR;
           fiwarnt.rec.FIID        = fininstr.rec.FIID;
           fiwarnt.rec.DrawingDate = LineSumm.CoupDrawDate;
           if( fiwarnt.GetLE() and 
               (fiwarnt.rec.IsPartial == UNSET_CHAR) and
               (fiwarnt.rec.FIID == fininstr.rec.FIID) and
               (fiwarnt.rec.DrawingDate == LineSumm.CoupDrawDate)
             ) 
              if(fiwarnt.rec.IncomeRate != 0) 
                 LineSumm.IncomeRate = fiwarnt.rec.IncomeRate;
              else
                /*Заполняется только для купонных облигаций - ставка по купону, действующему на отчетную дату. 
                  Если для купона, действующего на отчетную дату ставка  указана в справочнике, то выводится именно она. 
                  Если ставка не указана, то вычисляется ставка по купону в % годовых по формуле: 100%*B*C/(N*T), 
                  где B- количество дней в году, C - сумма купона, N -сумма номинала, действующего на дату погашения купона, 
                  T - длительность купона. Величины T и B вычисляются в соответствии с методом, указанным в справочнике ценных бумаг, 
                  в поле "Базис расчета НКД". Длительность купона = дата погашения купона - дата начала действия купона + 1*/
                 ПолучитьПараметрыБазисаРасчетаКупона(avoir.rec.NKDBase_Kind, fiwarnt.rec, Data.RepDate, DaysInYear, DaysInCoupon);

                 var FaceValue = DoubleToMoney(GetFaceValue(fininstr.rec.FIID,fiwarnt.rec.DrawingDate));
                 if( (FaceValue*DaysInCoupon) != 0  )
                    LineSumm.IncomeRate = 100.0 * DaysInYear * fiwarnt.rec.IncomeVolume / (FaceValue*DaysInCoupon);
                 else
                    LineSumm.IncomeRate = 0;
                 end;
                 LineSumm.IncomeRate = ЧислоCЗаданнойТочностью( DoubleToMoney( LineSumm.IncomeRate), 4);
              end;
           else
              LineSumm.IncomeRate   = "";
           end;
           LineSumm.CoupDrawDate = date_as_string(1, LineSumm.CoupDrawDate);
        else
           LineSumm.CoupDrawDate = "";
           LineSumm.IncomeRate   = "";
        end;
     else
        LineSumm.CoupDrawDate = "";
        LineSumm.IncomeRate   = "";
     end;      
     /* Дата погашения облигации
        Плановая дата погашения выпуска (выводится только для облигаций) */
     if( FI_IsBond(fininstr.rec.FIID) )
        LineSumm.DrawDate = date_as_string(1,fininstr.rec.DrawingDate);
        LineSumm.Issued = date_as_string(1,fininstr.rec.Issued);
     end;

     LineSumm.Issuer  = pmwrtsum.IssShName;
     LineSumm.AvrType = pmwrtsum.AvKindShName;
     LineSumm.AvrName = fininstr.rec.Name;
     LineSumm.LSIN    = avoir.rec.LSIN;
     LineSumm.ISIN    = avoir.rec.ISIN;       

     LineSumm.SumPrecision  = fininstr.rec.SumPrecision;
     LineSumm.FaceValueFI   = fininstr.rec.FaceValueFI;

     DL_GetObjAttrName( OBJTYPE_AVOIRISS, 13, DL_GetMainObjAttr(fininstr, 13, OBJTYPE_AVOIRISS), null, null, @LineSumm.QCategory );
  END;                                                                                                                                                                         

  PRIVATE MACRO PrintData(ObjReport:OBJECT)
     var Query, Select, pmwrtsum, Nrec, count, IsLinePrint = false;

     SetActiveSheet( "Сверка лотов и БУ" );
     ObjReport.BeginReport();

     InitProgress(-1, StatLine, "Выборка данных");

     Query =   " select repporst.t_portfid, repporst.t_IssShName, repporst.t_AvKindShName, repporst.t_Account, repporst.t_LegKind, repporst.t_PartNum AccChapter, V.* "
             + "   from drepporst_tmp repporst, v_scwrthistex V "
             + "  where V.t_SumID = repporst.t_DocID "
             + "    and V.t_Instance = (select MAX (VV.t_Instance) "
             + "                          from v_scwrthistex VV"
             + "                         where VV.t_SumID = V.t_SumID "
             + "                           and VV.t_ChangeDate <= ? "
             + "                       ) "
             + "  order by repporst.t_portfid, repporst.t_IssShName, repporst.t_AvKindShName, V.t_fiid, repporst.t_account";

     Select = DL_RSDCommand(Query);

     Select.AddParam(Data.RepDate);
     
     Nrec = Select.GetCount();

     RemProgress();
     if(Nrec > 0)
       InitProgressBar( ToInt(Nrec), StatLine, "Обработка отобранных данных" );

       pmwrtsum = Select.Execute();

       LineSumm.ClearAvrInfo();
       LineSumm.ClearSum();
       while( pmwrtsum.MoveNext() )
          UseProgressBar;
          if( m_PrevPortf != pmwrtsum.portfid )
             if( IsLinePrint )
                FillOverAmountAcc();
                FillCorrAcc();
                FillCorrEstReserveAcc();
                ObjReport.PrintTableLine();
             end;
            // ObjReport.PrintHeadLine(Data.PortfNameArray[pmwrtsum.portfid]);		/*PDV убрано разделение групп вывода отчета по просьбе пользователя 200919 */
             LineSumm.ClearSum();
          elif( (LineSumm.FIID != pmwrtsum.fiid) or ( m_PrevAccount != pmwrtsum.Account ) )
             if( IsLinePrint )
                FillOverAmountAcc();
                FillCorrAcc();
                FillCorrEstReserveAcc();
                ObjReport.PrintTableLine();
             end;
             LineSumm.ClearSum();
          end;

          if( LineSumm.FIID != pmwrtsum.fiid )
             FillAvrInfo(pmwrtsum);
          end;

          FillLineSumm(pmwrtsum);

          m_PrevFiid     = pmwrtsum.fiid;
          m_PrevPortf    = pmwrtsum.portfid;
          m_PrevAccount  = pmwrtsum.Account;

          IsLinePrint = true;
       end;
       RemProgressBar;

       if( IsLinePrint )
          FillOverAmountAcc();
          FillCorrAcc();
          FillCorrEstReserveAcc();
          ObjReport.PrintTableLine();
          ObjReport.EndReport();
       end;
     end;
  END;                                                                                                                                                                         

  PRIVATE MACRO ExecuteReport(ObjReport:OBJECT)
     m_H1 = m_H2 = null;

     if( not CollectData() )
        msgbox("Нет данных для формирования отчета");
        return;
     end;

     PrintData(ObjReport);

     var i:integer = 0;
     while( i < Data.UniqStr.Size )
       msgbox( Data.UniqStr.(i) );
       i = i + 1;
     end;

  END;

  PRIVATE MACRO Create()
     ClearGlobalTmp( "drepporst_tmp" );
     ExecuteReport(CRecLOts(this));
  END;

  MACRO H1()
     if( Data.AvrCode <= 0 )
        return "Все";
     end;
                                  
     if( m_H1 == null )
       m_H1 = m_H2 = "";
       if( ПолучитьФинИн(Data.AvrCode, fininstr) == 0 )
          m_H1 = fininstr.rec.FI_CODE;
          m_H2 = fininstr.rec.NAME;
       end;
     end;
     return m_H1;
  END;

  MACRO H2()
     if( Data.AvrCode <= 0 )
        return "";
     end;

     if( m_H2 == null )
       m_H1 = m_H2 = "";
       if( ПолучитьФинИн(Data.AvrCode, fininstr) == 0 )
          m_H1 = fininstr.rec.FI_CODE;
          m_H2 = fininstr.rec.NAME;
       end;
     end;
     return m_H2;
  END;

  MACRO Issuer()
     return LineSumm.Issuer;
  END;

  MACRO AvrName()
     return LineSumm.AvrName;
  END;

  MACRO AvrType()
     return LineSumm.AvrType;
  END;

  MACRO LSIN()
     return LineSumm.LSIN;
  END;

  MACRO ISIN()
     return LineSumm.ISIN;
  END;

  MACRO Issued()
     return LineSumm.Issued;
  END;

  MACRO DrawDate()
     return LineSumm.DrawDate;
  END;

  MACRO CoupDrawDate()
     return LineSumm.CoupDrawDate;
  END;

  MACRO FaceValue()
     return LineSumm.FaceValue;
  END;

  MACRO FaceValCcy()
     return LineSumm.FaceValCcy;
  END;

  MACRO Amount()
     return LineSumm.Amount;
  END;

  MACRO SumPrecision():integer
     return LineSumm.SumPrecision;
  end;

  MACRO IncomeRate()
     return LineSumm.IncomeRate;
  END;

  MACRO BuyCostCUR()
     return LineSumm.BuyCostCUR;
  END;

  MACRO BuyCostNMN()
     return LineSumm.BuyCostNMN;
  END;

  MACRO Outlay()
     if( LineSumm.OutLay )
        return LineSumm.OutLay;
     end;
     return "";
  END;

  MACRO NKDBuy()
     if( LineSumm.NKDBuy )
        return LineSumm.NKDBuy;
     end;
     return "";
  END;

  MACRO CostIn()
     return LineSumm.CostIn;
  END;

  MACRO CostInAcc():string
     return LineSumm.CostInAcc;
  END;

  MACRO CostInAccRest()
     if( CostInAcc() == "" )
        return "";
     end;
     return LineSumm.CostInAccRest;
  END;

  MACRO CostInAccRestRUB()
     return ConvertToRUB(CostInAcc, CostInAccRest);
  END;

  MACRO CostInDelta()
     if( CostInAcc() == "" )
        return "";
     end;
     return CostIn() - CostInAccRest();
  END;

  MACRO OverAmount()
     if( LineSumm.OverAmount )
        return LineSumm.OverAmount;
     end;
     return "";
  END;

  MACRO OverAmountAcc():string
     if( LineSumm.OverAmountAcc == null )
        return "";
     end;
     return LineSumm.OverAmountAcc;
  END;

  MACRO OverAmountAccRest()
     if( (OverAmountAcc() == "") OR (OverAmountAcc() == "на основном") )
        return "";
     end;
     return LineSumm.OverAmountAccRest;
  END;

  MACRO OverAmountAccRestRUB()
     return ConvertToRUB(OverAmountAcc, OverAmountAccRest);
  END;

  MACRO OverAmountDelta()
     if( (OverAmount() == "") AND (OverAmountAccRest() == "") )
        return "";
     end;
     return abs(LineSumm.OverAmount) - LineSumm.OverAmountAccRest;
  END;

  MACRO Income()
     if( LineSumm.Income )
        return LineSumm.Income;
     end;
     return "";
  END;

  MACRO IncomeAcc():string
     if( LineSumm.IncomeAcc == null )
        return "";
     end;
     return LineSumm.IncomeAcc;
  END;

  MACRO IncomeAccRest()
     if( IncomeAcc() == "" )
        return "";
     end;
     return LineSumm.IncomeAccRest;
  END;

  MACRO IncomeAccRestRUB()
     return ConvertToRUB(IncomeAcc, IncomeAccRest);
  END;

  MACRO IncomeDelta()
     if( (Income() == "") AND (IncomeAccRest() == "") )
        return "";
     end;
     return LineSumm.Income - LineSumm.IncomeAccRest;
  END;

  MACRO BonusRest()
     if( LineSumm.BonusRest )
        return LineSumm.BonusRest;
     end;
     return "";
  END;

  MACRO BonusRestAcc():string
     if( LineSumm.BonusRestAcc == null )
        return "";
     end;
     return LineSumm.BonusRestAcc;
  END;

  MACRO BonusRestAccRest()
     if( BonusRestAcc() == "" )
        return "";
     end;
     return LineSumm.BonusRestAccRest;
  END;

  MACRO BonusRestAccRestRUB()
     return ConvertToRUB(BonusRestAcc, BonusRestAccRest);
  END;

  MACRO BonusRestDelta()
     var _BonusRest = 0, _BonusRestAccRest = 0;

     if( BonusRest() != "" )
        _BonusRest = BonusRest();
     end;

     if( BonusRestAccRest() != "" )
        _BonusRestAccRest = BonusRestAccRest();
     end;

     if( (BonusRest() == "") and (BonusRestAccRest() == "") )
        return "";
     end;

     return _BonusRest - _BonusRestAccRest;
  END;

  MACRO Discount()
     if( LineSumm.Discount )
        return LineSumm.Discount;
     end;
     return "";
  END;

  MACRO DiscountAcc():string
     if( LineSumm.DiscountAcc == null )
        return "";
     end;
     return LineSumm.DiscountAcc;
  END;

  MACRO DiscountAccRest()
     if( DiscountAcc() == "" )
        return "";
     end;
     return LineSumm.DiscountAccRest;
  END;

  MACRO DiscountAccRestRUB()   /*PDV 200919*/
      if( DiscountAcc() == "" )
        return "";
     end;

     return ConvertToRUB(DiscountAcc, DiscountAccRest);
  END;

  MACRO DiscountDelta()
     if( (Discount() == "") AND (DiscountAccRest() == "") )
        return "";
     end;
     return LineSumm.Discount - LineSumm.DiscountAccRest;
  END;

  MACRO QCategory():string
     return LineSumm.QCategory;
  END;

  MACRO ReserveSum()
     if( LineSumm.ReserveSum )
        return LineSumm.ReserveSum;
     end;
     return "";
  END;

  MACRO ReserveSumAcc():string
     if( LineSumm.ReserveSumAcc == null )
        return "";
     end;
     return LineSumm.ReserveSumAcc;
  END;

  MACRO ReserveSumAccRest()
     if( ReserveSumAcc() == "" )
        return "";
     end;
     return LineSumm.ReserveSumAccRest;
  END;

  MACRO ReserveSumAccRestRUB()
     return ConvertToRUB(ReserveSumAcc, ReserveSumAccRest);
  END;

  MACRO ReserveSumDelta()
     if( (ReserveSum() == "") AND (ReserveSumAccRest() == "") )
        return "";
     end;
     return LineSumm.ReserveSum - LineSumm.ReserveSumAccRest;
  END;

  MACRO PDD_ReserveSum()
     if( LineSumm.PDD_ReserveSum )
        return LineSumm.PDD_ReserveSum;
     end;
     return "";
  END;

  MACRO PDD_ReserveSumAcc():string
     if( LineSumm.PDD_ReserveSumAcc == null )
        return "";
     end;
     return LineSumm.PDD_ReserveSumAcc;
  END;

  MACRO PDD_ReserveSumAccRest()
     if( PDD_ReserveSumAcc() == "" )
        return "";
     end;
     return LineSumm.PDD_ReserveSumAccRest;
  END;

  MACRO PDD_ReserveSumAccRestRUB()
     return ConvertToRUB(PDD_ReserveSumAcc, PDD_ReserveSumAccRest);
  END;


  MACRO PDD_ReserveSumDelta()
     if( (PDD_ReserveSum() == "") AND (PDD_ReserveSumAccRest() == "") )
        return "";
     end;
     return LineSumm.PDD_ReserveSum - LineSumm.PDD_ReserveSumAccRest;
  END;

  MACRO CorrSum()
     if( LineSumm.CorrSum )
        return LineSumm.CorrSum;
     end;
     return "";
  END;

  MACRO CorrAcc():string
     if( LineSumm.CorrAcc == null )
        return "";
     end;
     return LineSumm.CorrAcc;
  END;

  MACRO CorrAccRest()
     if( CorrAcc() == "" )
        return "";
     end;
     return LineSumm.CorrAccRest;
  END;

  MACRO CorrAccRestRUB()
     return ConvertToRUB(CorrAcc, CorrAccRest);
  END;

  MACRO CorrDelta()
     if( (CorrSum() == "") AND (CorrAccRest() == "") )
        return "";
     end;
     return abs(LineSumm.CorrSum) - LineSumm.CorrAccRest;
  END;

  MACRO CorrEstReserveSum()
     if( LineSumm.CorrEstReserveSum )
        return LineSumm.CorrEstReserveSum;
     end;
     return "";
  END;

  MACRO CorrEstReserveAcc():string
     if( LineSumm.CorrEstReserveAcc == null )
        return "";
     end;
     return LineSumm.CorrEstReserveAcc;
  END;

  MACRO CorrEstReserveAccRest()
     if( CorrEstReserveAcc() == "" )
        return "";
     end;
     return LineSumm.CorrEstReserveAccRest;
  END;

  MACRO CorrEstReserveAccRestRUB()
     return ConvertToRUB(CorrEstReserveAcc, CorrEstReserveAccRest);
  END;

  MACRO CorrEstReserveDelta()
     if( (CorrEstReserveSum() == "") AND (CorrEstReserveAccRest() == "") )
        return "";
     end;
     return abs(LineSumm.CorrEstReserveSum) - LineSumm.CorrEstReserveAccRest;
  END;

  MACRO UNKDSum()
	return NKDBuy;
  END;

  MACRO UNKDAcc():string
     if( LineSumm.UNKDAcc == "")
     	return "";
     end;
     return LineSumm.UNKDAcc;
  END;

  MACRO UNKDAccRest()
     if (( LineSumm.UNKDAccRest == "") OR ( LineSumm.UNKDAccRest == 0))
     	return "";
     end;
     return LineSumm.UNKDAccRest;
  END;

  MACRO UNKDAccRestRUB()
     return ConvertToRUB(UNKDAcc, UNKDAccRest);
  END;

  MACRO UNKDDelta()
     var clop = abs(LineSumm.NKDBuy) - LineSumm.UNKDAccRest;

     if( clop == 0 )
        return "";
     end;
     return clop;
  END;
  
  initDL_CReportTemplate( NULL, "Report_reclots_usr.xls" );
END;

macro MakeReports()
  Dl_CallInsertStat(DL_OUTREPORT_EXCEL);
  while(m_Form.Run())
     UpdateFormFields();
     if( (not Data.SSPU) AND  
         (not Data.SSSD) AND  
         (not Data.ASCB) AND
         (not Data.BPP) AND 
         (not Data.PVO) AND 
         (not Data.PKU) AND 
         (not Data.PDO)
       )
       msgbox("В параметрах фильтра отчета не выбран ни один из портфелей");
       continue;
     end; 
     SP_RecLOts_Report().Run();
  end;
end; 

MakeReports();
exit(1);
