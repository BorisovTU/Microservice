/*
$Name:        sp_calc.mac
$Module:      Ценные бумаги
$Description: подсчет\проверка чего-либо по сделкам
*/
/*************************************************/
/* подсчет\проверка чего-либо по сделкам         */
/* //AV 15.04.02                                 */
/*************************************************/
import "secinter.mac", "sccomiss.mac", "sp_car.mac";

CONST DEALCALC_CALC = 1;

MACRO CalculatorByDeals( sum, Mode, Kind, DealStatus, DealDate, DealType, MarketID, MarketSchemeID, RqKind, DealPart, BrokerID,
                         IsClientOper, FIID, Portfolio, ЭтоДУ, WhereCond:string )
   var Calc = $0;
   var rq;

   var cmd = DL_RSDCommand();

   var sqlQuery = "select NVL(SUM( rq.t_Amount - CASE WHEN rq.t_Type =  " + DLRQ_TYPE_INCREPO +
                  "                              THEN 0 " +
                  "                              ELSE Rsb_FIInstr.ConvSum( dl_leg.t_TotalCost-dl_leg.t_Cost, dl_leg.t_CFI, rq.t_FIID , rq.t_FactDate) END ), 0) CalculatorByDeals " +
                  "  from ddlrq_dbt rq, ddl_tick_dbt deal, ddl_leg_dbt dl_leg" +
                  " where " +
                  "       rq.t_DocKind = ? /*1*/ and " +
                  "       rq.t_FactDate = ? /*2*/ and " +
                  //проверка на то что ТО закрыто
                  "       rq.t_State = " + DLRQ_STATE_EXEC + " and " +
                  //если подходит или первая или вторая часть сделки 
                  "       ( (rq.t_Type = " + DLRQ_TYPE_PAYMENT + " and rq.t_DealPart = 1 and Rsb_Secur.GetDealBuySale(deal.t_DealType, deal.t_BofficeKind, 0) = ? /*3*/) or " +
                  "         (rq.t_Type = " + DLRQ_TYPE_PAYMENT + " and rq.t_DealPart = 2 and Rsb_Secur.GetDealBuySale(deal.t_DealType, deal.t_BofficeKind, 1) = ? /*4*/) or " +
                  "         (rq.t_Type = " + DLRQ_TYPE_INCREPO + " and Rsb_Secur.GetDealBuySale(deal.t_DealType, deal.t_BofficeKind, case when dl_leg.T_INCOMERATE < 0 then 0 else 1 end) = ? /*5*/) ) and " +
                  "       rq.t_FIID = ? /*6*/ and " +
                  //!!! цепляем dl_tick.dbt. !!!
                  "       deal.t_DealID = rq.t_DocID and " +
                  "       deal.t_BofficeKind = rq.t_DocKind and " +
                  //!!! цепляем dl_leg.dbt. !!!
                  "       dl_leg.t_DealID = deal.t_DealID and " +
                  "       dl_leg.t_LegID = 0 and " +
                  "       dl_leg.t_LegKind = ( CASE WHEN rq.t_Type = " + DLRQ_TYPE_PAYMENT + " AND rq.t_DealPart = 2 THEN " + LEG_KIND_DL_TICK_BACK + " ELSE " + LEG_KIND_DL_TICK + " END) and " +
  //---------------------------Замена функции IsDeal-----------------------------------
                  "       deal.t_DealStatus != " + DL_PREPARING + " and " +
                  "       deal.t_Flag1 = '" + SET_CHAR + "' ";

   cmd.AddParam(Kind);     /*1*/
   cmd.AddParam(DealDate); /*2*/
   cmd.AddParam(DealType); /*3*/
   cmd.AddParam(DealType); /*4*/
   cmd.AddParam(DealType); /*5*/
   cmd.AddParam(FIID);     /*6*/
   

   if( MarketID != null )
      sqlQuery = sqlQuery + " and  deal.t_MarketID = ? ";
      cmd.AddParam(MarketID);
   end;         

   if( MarketSchemeID != null )
      sqlQuery = sqlQuery + " and  deal.t_MarketSchemeID = ? ";
      cmd.AddParam(MarketSchemeID);
   end;

   if( BrokerID != null )
      sqlQuery = sqlQuery + " and  deal.t_BrokerID = ? ";
      cmd.AddParam(BrokerID);
   end;

   if( not ЭтоДУ )/*для ДУ игнорируем условие deal.t_ClientID*/
      if( IsClientOper )
         sqlQuery = sqlQuery + " and  deal.t_ClientID <> -1 ";
      else
         sqlQuery = sqlQuery + " and  deal.t_ClientID = -1 ";
      end;
   end;

   if( Portfolio != null )
      sqlQuery = sqlQuery + " and  deal.t_PortfolioID = ? ";
      cmd.AddParam(Portfolio);
   end;

   if( WhereCond != null )
      sqlQuery = sqlQuery + WhereCond;
   end;
  /*----------------------------------------------------------------------------------------*/
   
   if( Mode != DEALCALC_CALC )
      msgbox("Неизвестный режим обработки сделок\погашений");
      return false;
   end;


   rq = cmd.Execute(sqlQuery);
   if (rq.MoveNext())
      sum = sum + Money(rq.CalculatorByDeals);
   end;
   SetParm( 0, sum );
   return true;
END;

MACRO CalculatorNKDByDeals( sum, Mode, Kind, DealStatus, DealDate, DealType, MarketID, MarketSchemeID, BrokerID, IsClientOper, FIID, Portfolio, ЭтоДУ, WhereCond:string )
   var Calc = $0;
   var rq;

   var cmd = DL_RSDCommand();

   var sqlQuery = "select NVL( DECODE( ? /*1*/, " + DEAL_TYPE_RET_COUPON +
                  "                    , SUM( rq.t_Amount ) " +
                  "                    , SUM( CASE WHEN rq.t_Type = " + DLRQ_TYPE_INCREPO +
                  "                           THEN 0 " +
                  "                           ELSE Rsb_FIInstr.ConvSum( dl_leg.t_TotalCost-dl_leg.t_Cost, dl_leg.t_CFI, rq.t_FIID , rq.t_FactDate) END ) "
                  "                  ), 0) CalculatorByDeals " +
                  "  from ddlrq_dbt rq, ddl_tick_dbt deal, ddl_leg_dbt dl_leg" +
                  " where " +
                  "       rq.t_DocKind = ? /*2*/ and " +
                  "       rq.t_FactDate = ? /*3*/ and " +
                  //проверка на то что ТО закрыто
                  "       rq.t_State = " + DLRQ_STATE_EXEC + " and " +
                  //если подходит или первая или вторая часть сделки 
                  "       ( (rq.t_Type = " + DLRQ_TYPE_PAYMENT + " and rq.t_DealPart = 1 and Rsb_Secur.GetDealBuySale(deal.t_DealType, deal.t_BofficeKind, 0) = ? /*4*/) or " +
                  "         (rq.t_Type = " + DLRQ_TYPE_PAYMENT + " and rq.t_DealPart = 2 and Rsb_Secur.GetDealBuySale(deal.t_DealType, deal.t_BofficeKind, 1) = ? /*5*/) or " +
                  "         (rq.t_Type = " + DLRQ_TYPE_INCREPO + " and Rsb_Secur.GetDealBuySale(deal.t_DealType, deal.t_BofficeKind, case when dl_leg.T_INCOMERATE < 0 then 0 else 1 end) = ? /*6*/) ) and " +
                  "       rq.t_FIID = ? /*7*/ and " +
                  //!!! цепляем dl_tick.dbt. !!!
                  "       deal.t_DealID = rq.t_DocID and " +
                  "       deal.t_BofficeKind = rq.t_DocKind and " +
                  //!!! цепляем dl_leg.dbt. !!!
                  "       dl_leg.t_DealID = deal.t_DealID and " +
                  "       dl_leg.t_LegID = 0 and " +
                  "       dl_leg.t_LegKind = ( CASE WHEN rq.t_Type = " + DLRQ_TYPE_PAYMENT + " AND rq.t_DealPart = 2 THEN " + LEG_KIND_DL_TICK_BACK + " ELSE " + LEG_KIND_DL_TICK + " END) and " +
  //---------------------------Замена функции IsDeal-----------------------------------
                  "       deal.t_DealStatus != " + DL_PREPARING + " and " +
                  "       deal.t_Flag1 = '" + SET_CHAR + "' ";

   cmd.AddParam(DealType); /*1*/
   cmd.AddParam(Kind);     /*2*/
   cmd.AddParam(DealDate); /*3*/
   cmd.AddParam(DealType); /*4*/
   cmd.AddParam(DealType); /*5*/
   cmd.AddParam(DealType); /*6*/
   cmd.AddParam(FIID);     /*7*/

   if( MarketID != null )
      sqlQuery = sqlQuery + " and  deal.t_MarketID = ? ";
      cmd.AddParam(MarketID);
   end;         

   if( MarketSchemeID != null )
      sqlQuery = sqlQuery + " and  deal.t_MarketSchemeID = ? ";
      cmd.AddParam(MarketSchemeID);
   end;

   if( BrokerID != null )
      sqlQuery = sqlQuery + " and  deal.t_BrokerID = ? ";
      cmd.AddParam(BrokerID);
   end;

   if( not ЭтоДУ )
      if( IsClientOper )
         sqlQuery = sqlQuery + " and  deal.t_ClientID <> -1 ";
      else
         sqlQuery = sqlQuery + " and  deal.t_ClientID = -1 ";
      end;
   end;

   if( Portfolio != null )
      sqlQuery = sqlQuery + " and  deal.t_PortfolioID = ? ";
      cmd.AddParam(Portfolio);
   end;

   if( WhereCond != null )
      sqlQuery = sqlQuery + WhereCond;
   end;
  /*----------------------------------------------------------------------------------------*/
   
   if( Mode != DEALCALC_CALC )
      msgbox("Неизвестный режим обработки сделок\погашений");
      return false;
   end;

   rq = cmd.Execute( sqlQuery );
   if (rq.MoveNext())
      sum = sum + Money(rq.CalculatorByDeals);
   end;
   SetParm( 0, sum );
   return true;
END;

/*Аналог CalculatorByDeals, но только для ТО типа компенсационного и др.*/
MACRO CalculatorByRq( sum, Mode, Kind, DealStatus, DealDate, DealType, MarketID, MarketSchemeID, RqType, DealPart, BrokerID, IsClientOper, FIID, Portfolio, ЭтоДУ, WhereCond:string )
   var Calc = $0;
   var rq;
   var cmd = DL_RSDCommand();

/*****************************************************************************/
   var sqlQuery = "select NVL(SUM( rq.t_Amount ), 0) CalculatorByRq " +
                  "  from ddlrq_dbt rq, ddl_tick_dbt deal" +
                  " where " +
                  "       rq.t_DocKind = ? /*1*/ and " +
                  "       rq.t_PlanDate = ? /*2*/ and " +
                  "       rq.t_Type = ? /*3*/ and " +
                  "       rq.t_DealPart = ? /*4*/ and " +
                  /*проверка на то что ТО закрыто*/
                  "       rq.t_State = " + DLRQ_STATE_EXEC + " and " +
                  "       rq.t_FIID  = " + FIID + " and " +
                  /*!!! цепляем dl_tick.dbt. !!!*/
                  "       deal.t_DealID = rq.t_DocID and " +
                  "       deal.t_BofficeKind = rq.t_DocKind and " +
  /*---------------------------Замена функции IsDeal-----------------------------------*/
                  "       deal.t_Flag1 = '" + SET_CHAR + "' and " +
                  "       ( Rsb_Secur.GetDealBuySale(deal.t_DealType, deal.t_BofficeKind, 0) = ? /*5*/) ";

   cmd.AddParam(Kind);     /*1*/
   cmd.AddParam(DealDate); /*2*/
   cmd.AddParam(RqType);   /*3*/
   cmd.AddParam(DealPart); /*4*/
   cmd.AddParam(DealType); /*5*/

   if( MarketID != null )
      sqlQuery = sqlQuery + " and  deal.t_MarketID = ? ";
      cmd.AddParam(MarketID);
   end;         

   if( MarketSchemeID != null )
      sqlQuery = sqlQuery + " and  deal.t_MarketSchemeID = ? ";
      cmd.AddParam(MarketSchemeID);
   end;

   if( BrokerID != null )
      sqlQuery = sqlQuery + " and  deal.t_BrokerID = ? ";
      cmd.AddParam(BrokerID);
   end;

   if( not ЭтоДУ )
      if( IsClientOper )
         sqlQuery = sqlQuery + " and  deal.t_ClientID <> -1 ";
      else
         sqlQuery = sqlQuery + " and  deal.t_ClientID = -1 ";
      end;
   end;

   if( Portfolio != null )
      sqlQuery = sqlQuery + " and  deal.t_PortfolioID = ? ";
      cmd.AddParam(Portfolio);
   end;

   if( WhereCond != null )
      sqlQuery = sqlQuery + WhereCond;
   end;
  /*----------------------------------------------------------------------------------------*/
   
   if( Mode != DEALCALC_CALC )
      msgbox("Неизвестный режим обработки сделок\погашений");
      return false;
   end;

   rq = cmd.Execute( sqlQuery );
   if (rq.MoveNext())
      sum = sum + Money(rq.CalculatorByRq);
   end;
   SetParm( 0, sum );
   return true;
END;

/*берем сумму всех комиссий по сделкам (суммы прошли по кредиту счета "-Биржа")*/
MACRO CalcComissByDeals( sum, comm, FIID:integer, IsClientOper, WhereCond:string )

   var Select, DataSet, sqlQuery;
/*
   sqlQuery = " Select NVL(Sum(ABS(v.t_Sum)),0) Sum " +
                       "   From ddl_value_dbt v, ddl_tick_dbt deal " +
                       "  Where v.t_DocKind = deal.t_BOfficeKind " +
                       "    and v.t_DocID   = deal.t_DealID " +
                       "    and v.t_Kind    = ? " +
                       "    and v.t_SumFIID = ? " +
                       "    and v.t_Date = ? " + 
                       "    and deal.t_Flag1  = 'X' AND deal.t_marketschemeid = ?";
*/

   sqlQuery = "     Select NVL(Sum(ABS(comm.t_Sum)),0) Sum " +
                       "    From ddlcomis_dbt comm, ddl_tick_dbt deal, dsfcomiss_dbt sf  " +
                       "     Where comm.t_DocKind = deal.t_BOfficeKind " +
                       "     and deal.t_BOfficeKind in (101, 4830)  " +
                       "     and comm.t_DocID   = deal.t_DealID  " +
                       //"     and comm.t_comnumber in (60, 61, 62, 83, 84, 85)  " +
                       "     and (    comm.t_comnumber IN (60, 61, 62, 83, 84, 85) " +
                       "           or sf.t_code IN ('СПбБиржКлир', 'СПбБирж')) " +
                       "     and sf.t_number =comm.t_comnumber " +
                       "     and sf.t_feetype = 1  " +
                       "     and decode(deal.t_CommDate, to_date('01.01.0001','DD.MM.YYYY'), deal.t_DealDate, deal.t_CommDate) = ?  " +
                       "     and deal.t_Flag1  = 'X'  " +
                       "     and deal.t_dealstatus  <> 0 " +
                       "     AND deal.t_marketschemeid = ? " +
/*Biq-11055*/			  "     AND sf.t_code != decode(RSB_SECUR.GetGeneralMainObjAttr(101,LPAD (deal.t_DealId , 34, '0'),115,deal.t_Dealdate), 1, 'СПбБиржКлир', chr(1)) " +  
                       "     and sf.t_fiid_comm = ? ";

   if( IsClientOper )
      sqlQuery = sqlQuery + " and deal.t_ClientID <> -1 ";
   else
      sqlQuery = sqlQuery + " and deal.t_ClientID = -1 ";
   end;

   if( WhereCond != null )
      sqlQuery = sqlQuery + WhereCond;
   end;

   Select = DL_RSDCommand( sqlQuery ); 

   Select.addParam(comm.CommDate );
   Select.addParam(comm.MarketSchemeID);
   Select.addParam(FIID);
   
DataSet = Select.execute();
   if (DataSet.MoveNext())
      sum =  sum + DataSet.Sum;/*сумма комиссий с НДС*/
   end;

   SetParm( 0, sum );      
   return true;

END;


/*Biq-11055*/ /*Сбор комиссий за клиринг СПБ не в дату заключения сделок, а в дату расчета комиссии*/
MACRO CalcComissByDealsKlirSPB( sum, comm, FIID:integer, IsClientOper, WhereCond:string )

   var Select, DataSet, sqlQuery;


   sqlQuery = "     Select NVL(Sum(ABS(comm.t_Sum)),0) Sum " +
                       "    From ddlcomis_dbt comm, ddl_tick_dbt deal, dsfcomiss_dbt sf  " +
                       "     Where comm.t_DocKind = deal.t_BOfficeKind " +
                       "     and deal.t_BOfficeKind in (101, 4830)  " +
                       "     and comm.t_DocID   = deal.t_DealID  " +
                       "     and sf.t_code  = 'СПбБиржКлир'      " +
                       "     and sf.t_number =comm.t_comnumber " +
                       "     and sf.t_feetype = 1  " +
                       "     and comm.t_date = ?  " +
                       "     and deal.t_Flag1  = 'X'  " +
                       "     and deal.t_dealstatus  <> 0 " +
                       "     AND deal.t_marketschemeid = ? " +
/*Biq-11055*/			  "     and ( select t_attrid from dobjatcor_dbt where t_objecttype = deal.t_BOfficeKind  and t_groupid = 115 and t_object = LPAD (deal.t_DealId , 34, '0')) = 1 " +  
                       "     and sf.t_fiid_comm = ? ";

   if( IsClientOper )
      sqlQuery = sqlQuery + " and deal.t_ClientID <> -1 ";
   else
      sqlQuery = sqlQuery + " and deal.t_ClientID = -1 ";
   end;

   if( WhereCond != null )
      sqlQuery = sqlQuery + WhereCond;
   end;

   Select = DL_RSDCommand( sqlQuery ); 

   Select.addParam(comm.CommDate );
   Select.addParam(comm.MarketSchemeID);
   Select.addParam(FIID);
   
DataSet = Select.execute();
   if (DataSet.MoveNext())
      sum =  sum + DataSet.Sum;/*сумма комиссий с НДС*/
   end;

   SetParm( 0, sum );      
   return true;

END;


macro WRTGetAmountFromRetire( Department:integer,
                              FIID:integer,      
                              Party:integer,     
                              Contract:integer,  
                              Coupon:string,     
                              Partly:string,     
                              DealID:integer,
                              Registrar:integer,
                              OnlyExecAcc:bool
                            )

  var cmd, DataSet, v_Registrar = 0;
  var v_OnlyExecAcc = 0;

  if( Registrar != null )
     v_Registrar = Registrar;
  end;

  if(OnlyExecAcc == true)
    v_OnlyExecAcc = 1;
  end;

  cmd = DL_RSDCommand("select RSB_PMWRTOFF.WRTGetAmountFromRetire(?,?,?,?,?,?,?,?,?) as Amount from dual "); 

  cmd.AddParam(Department );
  cmd.AddParam(FIID       );
  cmd.AddParam(Party      );
  cmd.AddParam(Contract   );
  cmd.AddParam(Coupon     );
  cmd.AddParam(Partly     );
  cmd.AddParam(DealID     );
  cmd.AddParam(v_Registrar);
  cmd.AddParam(v_OnlyExecAcc);

  DataSet = cmd.execute();

  if(DataSet.MoveNext())
     return ToMoney(DataSet.Amount);
  end;
   
  return $0;
end;

macro WRTGetAmountFromRetireOwn( Department:integer,
                                 FIID:integer,      
                                 Coupon:string,     
                                 DealID:integer,
                                 OnlyExecAcc:bool
                               )

  var cmd, DataSet;
  var v_OnlyExecAcc = 0;

  if(OnlyExecAcc == true)
    v_OnlyExecAcc = 1;
  end;

  cmd = DL_RSDCommand("select RSB_PMWRTOFF.WRTGetAmountFromRetireOwn(?,?,?,?,?) as Amount from dual "); 

  cmd.AddParam(Department   );
  cmd.AddParam(FIID         );
  cmd.AddParam(Coupon       );
  cmd.AddParam(DealID       );
  cmd.AddParam(v_OnlyExecAcc);

  DataSet = cmd.execute();

  if(DataSet.MoveNext())
     return ToMoney(DataSet.Amount);
  end;
   
  return $0;
end;

macro WRTGetAmountOwn( Department:integer,
                       FIID:integer,      
                       CalcDate:date,
                       Placed:bool,
                       Redeemed:bool
                     )

  var cmd, DataSet;
  var v_Placed = 0, v_Redeemed = 0;

  if(Placed == true)
    v_Placed = 1;
  end;

  if(Redeemed == true)
    v_Redeemed = 1;
  end;

  cmd = DL_RSDCommand("select RSB_PMWRTOFF.WRTGetAmountOwn(?,?,?,?,?) as Amount from dual "); 

  cmd.AddParam(Department );
  cmd.AddParam(FIID       );
  cmd.AddParam(CalcDate   );
  cmd.AddParam(v_Placed   );
  cmd.AddParam(v_Redeemed );

  DataSet = cmd.execute();

  if(DataSet.MoveNext())
     return ToMoney(DataSet.Amount);
  end;
   
  return $0;
end;

private macro SP_GetAccRestByCateg(CategCode:string,Chapter:integer,FIID:integer,Place:integer,Department:integer,Client:integer,ClientContrID:integer,OnDate:Date/*,Err:@string*/):money
   var DataSet, Rest = $0;
   record acc1( account );
   var query = DL_RSDCommand();

   var SqlText = "SELECT distinct accdoc.t_Account " +
                 "  FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ " +
                 " WHERE accdoc.t_Account       != chr(1) " +
                 "   AND accdoc.t_IsCommon       =  chr(0)"+ 
                 "   AND accdoc.t_IsUsable       = 'X' " + 
                 "   AND accdoc.t_Chapter        = ? " +
                 "   AND accdoc.t_FIID           = ? " +
                 "   AND accdoc.t_Place          = ? " +
                 "   AND accdoc.t_DepartmentID   = ? " +
                 "   AND categ.t_ID              = accdoc.t_CatID "+
                 "   AND categ.t_Code            = ? " +
                 "   AND categ.t_LevelType       = 1 " +
                 "   AND accdoc.t_ActivateDate  <= ? ";

   Query.addParam( Chapter );
   Query.addParam( FIID );
   Query.addParam( Place );
   Query.addParam( Department );
   Query.addParam( CategCode );
   Query.addParam( OnDate );

   if( Client > 0 )/*здесь только по конкретному клиенту*/
      SqlText = SqlText +
                 "   AND accdoc.t_Owner          = ? " +
                 "   AND accdoc.t_ClientContrID  = ? ";
      Query.addParam( Client );
      Query.addParam( ClientContrID );      
   end;

   DataSet = Query.execute(SqlText);

   while( DataSet.MoveNext() )
      if( GetAccount( Chapter, FIID, DataSet.Account, acc1, true ) )
         if( (acc1.Open_Date <= OnDate) and (acc1.Open_Close != "З") )
            Rest = Rest + abs(GetRestAccount(acc1, OnDate));
         end;
      end;     
   end;

   return Rest;
end;                                               

/*ф-я подсчета возможного кол-ва ц\б для погашения (по остаткам на счетах), зовем в сишнике*/
macro SP_GetWrtAmountByInAcc(tick,leg,Client:integer,ClientContrID:integer)
   var Amount = $0, v_CalcDate = date(0,0,0);

   VAR tick_buf = TRecHandler( "dl_tick" ),
       leg_buf  = TRecHandler( "dl_leg" );
  
   tick_buf.SetRecordAddr( tick );
   leg_buf.SetRecordAddr( leg );

   if( leg_buf.rec.Start == date(0,0,0) )
      v_CalcDate = tick_buf.rec.DealDate;
   else
      v_CalcDate = leg_buf.rec.Start;
   end;
                                                                    
   if( Client == -1 )/*здесь только собственные счета*/
      Amount = SP_GetAccRestByCateg("ЦБ Банка, ВУ",22,leg_buf.rec.PFI,leg_buf.rec.Registrar,tick_buf.rec.Department,-1,-1,v_CalcDate);
   elif( Client == 0 )/*здесь по всем клиентам*/
      Amount = SP_GetAccRestByCateg("ЦБ Банка, ВУ",22,leg_buf.rec.PFI,leg_buf.rec.Registrar,tick_buf.rec.Department,-1,-1,v_CalcDate) +
               SP_GetAccRestByCateg("ЦБ Клиента, ВУ",22,leg_buf.rec.PFI,leg_buf.rec.Registrar,tick_buf.rec.Department,0,-1,v_CalcDate);/*по всем (по собственным и по клиентским)*/
   else/*здесь только по конкретному клиенту*/
      Amount = SP_GetAccRestByCateg("ЦБ Клиента, ВУ",22,leg_buf.rec.PFI,leg_buf.rec.Registrar,tick_buf.rec.Department,Client,ClientContrID,v_CalcDate);
   end;

   Amount = Amount - WRTGetAmountFromRetire(tick_buf.rec.Department,
                                            leg_buf.rec.PFI,
                                            Client,
                                            ClientContrID,
                                            tick_buf.rec.Number_Coupon,
                                            tick_buf.rec.Number_Partly,
                                            tick_buf.rec.DealID,
                                            leg_buf.rec.Registrar
                                           );
   if( Amount < $0 )
      Amount = $0;
   end;

   return Amount;
end;

macro SP_GetAffiliationByTradAcc( TradAcc:string ):integer
   var RetVal:integer = 0;
   var FS:string = StrUpr(SubStr(TradAcc, 1, 1));

   if( FS == "S" )
      RetVal = ALG_SP_MONEY_SOURCE_OWN;
   elif( FS == "L" )
      RetVal = ALG_SP_MONEY_SOURCE_CLIENT;
   elif( FS == "D" )
      RetVal = ALG_SP_MONEY_SOURCE_TRUST;
   end;

   return RetVal;
end;

//Скорректировать сумму НКД в операции погашения для ФЛ с учетом НДФЛ
macro SP_CorrectRetNKDbyNDFL(ClientID, ClientContrID, FIID, Number_Coupon, NKD, NKDFIID)
  var fiw  = TRecHandler("fiwarnts.dbt");
  var NKDRub = $0;
  var Rate13 = 0.13, Rate15 = 0.15;
  var query, cmd, DataSet;
  var DrawingDate = date(0,0,0), Year;
  var TaxBase = $0;
  var IsIIS = 0;
  
  if((ClientID > 0) and (NKD > 0))
    if(ПолучитьКупон( FIID, Number_Coupon, UNSET_CHAR, fiw ) == true)
      if(fiw.rec.DrawingDate <= date(1,1,2021))
        NKD = NKD - NKD*Rate13;
      else
        datesplit(date(fiw.rec.DrawingDate), NULL, NULL, Year);

        SmartConvertSum(NKDRub, NKD, date(fiw.rec.DrawingDate), NKDFIID, NATCUR, false);

        if(ClientContrID > 0)
          query = "select RSI_NPTO.CheckContrIIS(?) as IsIIS from dual";

          cmd = DL_RSDCommand(query);
          cmd.AddParam(CLientContrID);

          DataSet = cmd.Execute();
          if(DataSet.moveNext())
            IsIIS = IIF(DataSet.IsIIS > 0, 1, 0);
          end;
        end;
      
        TaxBase = GetRubSumByClient(ClientID, string(IIF(IsIIS, TXOBJ_BASEG5, TXOBJ_BASEG2)), date(1,1,Year), fiw.rec.DrawingDate, null, IsIIS, null, null);

        if(TaxBase > NPTX_LIMINCOME_MAX15)
          NKD = NKD - NKD*Rate15;
        elif((TaxBase+NKDRub) <= NPTX_LIMINCOME_MAX15)
          NKD = NKD - NKD*Rate13;
        elif((TaxBase+NKDRub) > NPTX_LIMINCOME_MAX15)
          NKDRub = NKDRub - (NPTX_LIMINCOME_MAX15-TaxBase)*Rate13 - (TaxBase + NKDRub - NPTX_LIMINCOME_MAX15)*Rate15;

          SmartConvertSum(NKD, NKDRub, date(fiw.rec.DrawingDate), NATCUR, NKDFIID, false);
        end;
      end;
    end;
  end;
  return round(NKD, 2);
end;