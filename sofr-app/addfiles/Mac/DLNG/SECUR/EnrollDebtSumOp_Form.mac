/**                                                                                                             
 @file  EnrollDebtSumOp_Form.mac                                                                                           
 @brief Форма ввода параметров для сервисной операции Автоматического выноса задолженности на просрочку из пункта меню                                                                         
                                                                                                                
 #menu 
  - БО ЦБ\Сервисные операции\Автоматический вынос задолженности на просрочку                                                                         
                                                                                                                
 #tag                                                                                                          
 - functional_block:СО                                                                             
 - code_type:GUI 
                                                                                                                
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2025.03.13 |Жиц М.В.       |BOSS-2183           |Создание макроса для обработки формы                                                                                                                                                 
*/ 

import "DlRepForm_h.mac", "EnrollDebtSumHist.mac", SFInter;

PRIVATE CONST PNFLD_ENROLLDEBTSUMOP_PROCDATE = 0,   
              PNFLD_ENROLLDEBTSUMOP_CLNTCODE = 1,
              PNFLD_ENROLLDEBTSUMOP_CLNTNAME = 2,    
              PNFLD_ENROLLDEBTSUMOP_CONTRACT = 3;   

PRIVATE CONST H_PNFLD_PROCDATE = 100,
              H_PNFLD_CONTRACT = 101;

/**
 @brief Класс параметров запуска сервисной операции Автоматического выноса задолженности на просрочку
*/                    
CLASS EnrollDebtSumOpParams()
  var ProcDate:date = {curdate}, //Дата процедуры
      ClientID:integer = -1,     //Индентификатор клиента
      DlContrID:integer = -1,    //Идентификатор ДБО
      Oper:integer = {oper},     //Операционист
      OpID:integer = 0,          //Идентификатор операции
      SysDateStr:string = "";    //Дата и время создания операции в строковом формате
END;

/**
 @brief Обработчик поля "Дата"
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO FldProc_ProcDate(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  if(Cmd == DLG_INIT) /*Установка значения в поле*/
    if(FldRealValue == null) /*инициализация по умолчанию*/
      FldRealValue = {curdate};
    end;
    FldShowValue = FldRealValue;
  elif(Cmd == DLG_CHANGEVALUE) 
    FldRealValue = FldShowValue;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

/**
 @brief Обработчик поля по-умолчанию
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO Default(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null) /*инициализация по умолчанию*/
      FldRealValue = "";
    end;
    FldShowValue = FldRealValue;
  elif(Cmd == DLG_CHANGEVALUE) /*значение поля было изменено*/
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

/**
 @brief Поиск субъекта по его коду
 @param[in] CodeKind вид кода
 @param[in] Code код субъекта
 @return идентификатор субъекта
*/                    
PRIVATE MACRO ПолучитьСубъектаПоКоду(CodeKind:integer, Code:string):integer
  var cmd, DataSet;
  var PartyID:integer = -1;
  
  cmd = DL_RSDCommand(" select objcode.t_ObjectID " +
                      "   from dobjcode_dbt objcode " +
                      "  where objcode.t_ObjectType = " + OBJTYPE_PARTY +
                      "    and objcode.t_CodeKind = ? " +
                      "    and objcode.t_State = 0 " +
                      "    and objcode.t_Code = ? ");
  cmd.AddParam(CodeKind);
  cmd.AddParam(Code);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    PartyID = DataSet.ObjectID;
  end;

  return PartyID;
END;

/**
 @brief Обработчик поля "Клиент"
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO FldProc_Client(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  var Party    = TRecHandler("party.dbt");
  var partcode = TBFile("partcode.dbt", "R", 0);
  var saveFldRealValue = FldRealValue;
  var PartyID:integer = -1;

  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
    end;
    if(FldRealValue <= 0)
      FldShowValue = STR_ALLVALUE;
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
    else
      partcode.Clear();
      partcode.rec.PartyID  = FldRealValue;
      partcode.rec.CodeKind = PTCK_CONTR;
      if(partcode.GetEQ())
        FldShowValue = partcode.rec.Code;
        if(ПолучитьСубъекта(FldRealValue, Party) == 0)
          pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, Party.rec.ShortName);
        end;
      end;
    end;
  elif(Cmd == DLG_CHANGEVALUE) /*значение поля было изменено*/
    if((FldShowValue == STR_ALLVALUE) OR (FldShowValue == ""))
      FldRealValue = -1;
      FldShowValue = STR_ALLVALUE;
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
    else
      PartyID = ПолучитьСубъектаПоКоду(PTCK_CONTR, FldShowValue); 
      if(PartyID > -1)
        FldRealValue = PartyID;
        if(ПолучитьСубъекта(FldRealValue, Party) == 0)
          pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, Party.rec.ShortName);
        end;
      else
        FldRealValue = -1;
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
      end;
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = STR_ALLVALUE;
    pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3)) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
    Party = TRecHandler("party.dbt");
    if(ListPT(Party, PTCK_CONTR, "", PTLIST_STOCKDLCLIENT, PTCK_ALL) == true) 
      FldRealValue = Party.rec.PartyID;
      partcode.Clear();
      partcode.rec.PartyID  = Party.rec.PartyID;
      partcode.rec.CodeKind = PTCK_CONTR;
      if(partcode.GetEQ())
        FldShowValue = partcode.rec.Code;
      end;
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, Party.rec.ShortName);
    end;
  end;

  if(saveFldRealValue != FldRealValue)
    if(pThis.GetLinkedValue(H_PNFLD_CONTRACT) != -1)
      pThis.SetLinkedValue(H_PNFLD_CONTRACT, -1);
    end;
  end;

  return CM_DEFAULT;
END;

/**
 @brief Листалка ДБО
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @param[in] X координата левого верхнего угла отображения листалки по горизонтали
 @param[in] Y координата левого верхнего угла отображения листалки по вертикали
 @param[in/out] PartyID идентификатор клиента
 @param[in] Department подразделение банка
 @param[in] BegDate дата начала расчета
*/                    
PRIVATE MACRO ListDlContr(FldShowValue:@VARIANT, FldRealValue:@VARIANT, X:INTEGER, Y:INTEGER, PartyID:@INTEGER, Department:integer, BegDate:date)
  var Choice, i = 0, flag = false; 
  var Select;
  Select = "select sfc.t_id, sfc.t_DateBegin, sfc.t_DateClose, sfc.t_Number, prt1.t_ShortName ClientName, prt1.t_PartyID as t_PartyID, sfc.t_Department as t_Department, " + 
           "   (CASE WHEN sfc.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sfc.t_DateClose > "+GetSQLDate(BegDate)+" THEN 'Открыт' ELSE 'Закрыт' END) as t_StatusName, " +
           "   dlc.t_IIS, dlc.t_DlContrID, " +
           "   (CASE WHEN dlc.t_UseSubAcc = 'X' THEN CHR(0) ELSE 'X' END) EDP "
           "  from ddlcontr_dbt dlc, dsfcontr_dbt sfc, dparty_dbt prt1 "+
           " where sfc.t_ID = dlc.t_SfContrID " +
           "   and prt1.t_PartyID = sfc.t_partyID " ;

  if(PartyID > 0)
    Select = Select + " and sfc.T_PARTYID = " + PartyID;
  end;

  if((Department != null) and (Department > 0))
    Select = Select + "   and sfc.t_Department = "+string(Department)+
                      "   and sfc.t_Branch = 0";
  end;

  Choice = DL_Scroll(Select,
                     "Договора брокерского обслуживания", X, Y,
                     "t_Number",     "№ договора",
                     "ClientName",   "Клиент",
                     "t_DateBegin",  "Дата открытия",
                     "t_DateClose",  "Дата закрытия",
                     "t_StatusName", "Статус",
                     "t_IIS",        "ИИС",
                     "EDP",          "ЕДП"
                    );

  if(Choice != NULL)
    FldRealValue = Choice.Value("t_DlContrID"); 
    FldShowValue = Choice.Value("t_Number");
    PartyID      = Choice.Value("t_PartyID");
  end;
END;

/**
 @brief Обработчик поля "№ договора"
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO FldProc_Contract_BO_Dep(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var ClientID = pThis.GetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE);
  var ProcDate  = pThis.GetLinkedValue(H_PNFLD_PROCDATE);

  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
    end;
    if(FldRealValue <= 0)
      FldShowValue = STR_ALLVALUE;
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = STR_ALLVALUE;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    ListDlContr(@FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), @ClientID, {OperDprt}, ProcDate);
    pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, ClientID);
  end;

  return CM_DEFAULT;
END;

/**
 @brief Класс формы для сервисной операции Автоматического выноса задолженности на просрочку
*/                    
CLASS (DL_CPanel) EnrollDebtSumOp_Panel()
  private var m_FormData = EnrollDebtSumOpParams(); //Параметры запуска сервисной операции

  /**
   @brief Инициализация параметров формы, назначения обработчиков полей
  */                    
  PRIVATE MACRO Init()
    AddFieldProc(0, PNFLD_ENROLLDEBTSUMOP_PROCDATE,  H_PNFLD_PROCDATE,             @FldProc_ProcDate,        m_FormData.ProcDate);                 
    AddFieldProc(0, PNFLD_ENROLLDEBTSUMOP_CLNTCODE,  DL_PNFLD_CLIENT_STOCKDL_CODE, @FldProc_Client,          m_FormData.ClientID);
    AddFieldProc(0, PNFLD_ENROLLDEBTSUMOP_CLNTNAME,  DL_PNFLD_CLIENT_STOCKDL_NAME, @Default,                 m_FormData.ClientID);
    AddFieldProc(0, PNFLD_ENROLLDEBTSUMOP_CONTRACT,  H_PNFLD_CONTRACT,             @FldProc_Contract_BO_Dep, m_FormData.DlContrID);
  END;

  /**
   @brief Переопределение обработчика нажатия клавиш
   @param[in] Pan объект панели
   @param[in] Cmd код действия
   @param[in] FldId идентификатор поля
   @param[in] _Key код клавиши
   @return код дальнейшего действия
  */                    
  MACRO KeyProc(Pan:Variant, Cmd:INTEGER, FldId:INTEGER, _Key:INTEGER)
    var RetKey = KeyProc(Pan, Cmd, FldId, _Key);

    if((Cmd == DLG_KEY) AND (RetKey == CM_DEFAULT))
      if(_Key == 320/*F6*/)  
        ShowEnrollDebtSumOpHist(); //Вызов скроллинга истории запусков
      end;
    end;

    return RetKey;
  END;

  /**
   @brief Проверка параметров формы
   @return true, если проверка пройдена успешно
   @return false, если в процессе проверки были обнаружены ошибки
  */                    
  PRIVATE MACRO Check():BOOL
    return true;
  END;

  /**
   @brief Получение параметров панели
   @return параметры панели 
  */ 
  MACRO GetParams()
    return m_FormData;
  END;

  /**
   @brief Запуск формы с последующей записью полученных параметров
   @return true, если форма отработала успешно и была подтверждена по F2
   @return false, если в процессе работы формы возникли ошибки или из нее вышли по Esc
  */                    
  MACRO Run()
    var stat = Run();

    m_FormData.ProcDate  = GetFieldValue(PNFLD_ENROLLDEBTSUMOP_PROCDATE);
    m_FormData.ClientID  = GetFieldValue(PNFLD_ENROLLDEBTSUMOP_CLNTCODE);
    m_FormData.DlContrID = GetFieldValue(PNFLD_ENROLLDEBTSUMOP_CONTRACT);

    return stat;
  END;
  
  initDL_CPanel("sp_res.lbr", "ENRDEBT"); 
END;
                                                                                                             