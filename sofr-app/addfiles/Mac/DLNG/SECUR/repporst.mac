/*
$Name:        repporst.mac
$Module:      –¥­­ë¥ ¡ã¬ £¨
$Description: âç¥â "‘âàãªâãà  ¨ áâ®¨¬®áâì ¯®àâä¥«ï æ/¡"
*/
import "spserv.mac", "spRepFn2.mac", "globals.mac", "DLReport_h.mac","dlmisc.mac", "mccatacc.mac";

private const StatLine = "‚ë¯ãáª ®âç¥â  \"‘âàãªâãà  ¨ áâ®¨¬®áâì ¯®àâä¥«ï æ/¡\"";
private var lot = TRecHandler( "pmwrtsum" );
private const SP_RATETYPE_TSS_reqcom = 14;

private var
  Total_8700 = $0,
  Total_8704 = $0,
  Total_8924 = $0,
  Total_8961 = $0,
  Total_8972 = $0,
  Total_8989e = $0,
  Total_8989n = $0,
  Total_8995 = $0,
  Total_8998 = $0,
  Total_9060 = $0;

  
  
  
  
//®¯à¥¤¥«ï¥¬ ç¨á«®¢®© ª®¤ áâà ­ë í¬¨â¥­â 
private macro _GetCountryCodeNum3(IssuerID)
  var query = "";
  var rs;
  var params : TArray;
  var CodeNum3 = "";

  query = query + "SELECT c.t_CodeNum3 FROM dcountry_dbt c, dparty_dbt p WHERE p.t_partyid = :IssuerID and c.t_CodeLat3 = p.t_nrcountry ";


  params = makeArray(SQLParam("IssuerID", IssuerID)
                     );
  rs = execSQLselect(query, params, true);
  if(rs and rs.moveNext())
    CodeNum3 = rs.value(0);
  end;

  return CodeNum3;
end;

// type - ¯à®¨§¢®«ì­ë© ¨¤¥­â¨ä¨ª â®à, ¯® ª®â®à®¬ã ¯à®¨§¢®¤¨âáï £àã¯¯¨à®¢ª , ­ §­ ç¥­¨¥ áç¥â 
// acc - á®¡áâ¢¥­­®, áç¥â
// portf - ¯®àâä¥«ì.
macro SGS_Clear()
   var cmd;
   cmd = RsdCommand("delete from sgs_repporst_tmp");
   cmd.execute;
end;

macro SGS_AddAcc(type, acc, portf, level)
   var cmd;
   if (acc == "") return;
   end;
   cmd = RsdCommand("insert into sgs_repporst_tmp(t_type, t_acc, t_port) values(?,?,?)");
   cmd.AddParam("", RSDBP_IN, type);
   cmd.AddParam("", RSDBP_IN, acc);
   cmd.AddParam("", RSDBP_IN, portf);
   cmd.execute;
onerror
   cmd = RsdCommand("begin execute immediate('create global temporary table sgs_repporst_tmp(t_type varchar2(50), t_acc varchar2(20), t_port integer) on commit preserve rows'); end;");
//   cmd = RsdCommand("begin execute immediate('create table sgs_repporst_tmp(t_type varchar2(50), t_acc varchar2(20), t_port integer) '); end;");
   cmd.execute;
   if (level > 1)
   	SGS_AddAcc(type, acc, portf, level+1);  // à¥ªãàá¨¢­¥­ìª®.
   else
	msgbox("®è¨¡ª  ¢áâ ¢ª¨ ¢® ¢à¥¬¥­­ãî â ¡«¨æã");
   end;
end;


// ®«ãç¥­¨¥ áã¬¬ë ®áâ âª®¢ ¯® áç¥â ¬ ¨§ ¢à¥¬¥­­®© â ¡«¨æë ¢ ­ æ.¢ «îâ¥
// …á«¨ ¯®àâä¥«ì ­¥ § ¤ ­, ¡¥à¥¬ ¯® ¢á¥¬ áç¥â ¬ - íâ® ¤«ï à §¤¥«  ®¡é¥© áã¬¬ë
macro SGS_GetRest(type, ddt, portf)
   var cmd, rs;
   if (portf == 0)
	   cmd = RsdCommand("SELECT SUM(RSI_RSB_ACCOUNT.RESTALL(ACC,1,CUR,?, 0)) value from (select distinct T_ACC ACC, t_code_currency CUR from sgs_repporst_tmp a, daccount_dbt b where a.t_acc=b.t_account and a.t_type = ?)");
	   cmd.AddParam("", RSDBP_IN, ddt);   // „ â , ­  ª®â®àãî ¡¥à¥¬ ®áâ â®ª
	   cmd.AddParam("", RSDBP_IN, type);  // ’¨¯ áç¥â 
   else
	   cmd = RsdCommand("SELECT SUM(RSI_RSB_ACCOUNT.RESTALL(ACC,1,CUR,?, 0)) value from (select distinct T_ACC ACC, t_code_currency CUR from sgs_repporst_tmp a, daccount_dbt b where a.t_acc=b.t_account and a.t_type = ? and a.t_port=?)");
	   cmd.AddParam("", RSDBP_IN, ddt);   // „ â , ­  ª®â®àãî ¡¥à¥¬ ®áâ â®ª
	   cmd.AddParam("", RSDBP_IN, type);  // ’¨¯ áç¥â 
	   cmd.AddParam("", RSDBP_IN, portf);  // ’¨¯ áç¥â 
   end;
   cmd.execute;
   rs = TRsbDataSet(cmd);
   rs.movenext();
   return abs(rs.value);
end;


private const
   /* ˆ¤¥­â¨ä¨ª â®àë áâà®ª */
   LineID_None    = null,
   LineID_Head1   = 1,
   LineID_Head2   = 2,
   LineID_Data    = 3,
   LineID_Foot1   = 4,
   LineID_Foot2   = 5,
   LineID_Summ    = 6;

private const
   /* ˆ¤¥­â¨ä¨ª â®àë ãç¥â­ëå ¯®àâä¥«¥©. */
   PortfID_Undef       = 0,
   PortfID_Trade       = 1,  /* ’ */
   PortfID_Sale        = 2,  /*  */
   PortfID_Retire      = 5,  /* “„ */
   PortfID_Unadmitted  = 7,  /*  */
   PortfID_Back        = 6,  /* ‚ */
   PortfID_OD_req      = 8,  /* +„ */
   PortfID_Contr       = 3,  /* Š“ */
   PortfID_Promissory  = 4,  /* „ */
   PortfID_OD_com      = 9,  /* -„ */
   PortfID_Back_KSU    = 10, /* ‚_Š‘“ */
   PortfID_Back_BPP_KSU= 11;  /* ‚__Š‘“ */

private const //¢ëà ¢­¨¢ ­¨¥ ¢ ïç¥©ª å
         l="l",
         r="r",
         f="f",
         c="c";

PRIVATE VAR Cap = " ‘âàãªâãà  ¨ áâ®¨¬®áâì ¯®àâä¥«ï æ/¡ á®áâ®ï­¨î ­  ¤ âã: ########";

PRIVATE VAR ReportRunFalse = "#";

PRIVATE VAR TableHeader =
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ \n"+
"³          ¬¨â¥­â             ³   ®¬¥à «¨æ¥¢®£®   ³        ¨¬¥­®¢ ­¨¥      ³ ’¨¯ æ¥­­®© ³       ü £®á.     ³       ISIN       ³  „ â    ³  „ â    ³  „ â    ³ ‚ «îâ  ³   ®¬¨­ «   ³    Š®«-¢® èâ.  ³  ‘â ¢ª    ³                                       ³                                        ³    ®ªã¯­ ï      ³     ‡ âà âë     ³   Š„    ³    ‘ã¬¬        ³      ‘ç¥â ãç¥â     ³           ç¨á«¥­­ë©        ³     ‘ç¥â ãç¥â      ³           ç¨á«¥­­ë©        ³     ‘ç¥â ãç¥â      ³     ç¨á«¥­­ ï ¯à¥¬¨ï,      ³     ‘ç¥â ãç¥â      ³            áâ â®ª          ³     ‘ç¥â ãç¥â      ³   % ®â   ³ ˆáâ®ç­¨ª ³ ë­®ç­ ï æ¥­  ³ Š â¥£®à¨ï³ ‘ã¬¬  à¥§¥à¢ , ³        ®¬¥à       ³ ‘ã¬¬  à¥§¥à¢   ³        ®¬¥à       ³        Š‚„       ³        Š€’       ³         BON        ³ \n"+
"³                              ³        áç¥â        ³       æ¥­­®© ¡ã¬ £¨     ³   ¡ã¬ £¨   ³    à¥£¨áâà æ¨¨   ³                  ³¯®£ è¥­¨ï³ ¢ë¯ãáª  ³¯®£ è¥­¨ï³­®¬¨­ « ³    §  ¥¤.   ³                ³ ¤®å®¤  ¯® ³            « ­á®¢ ï áâ®¨¬®áâì        ³          ‘â®¨¬®áâì ¢«®¦¥­¨©            ³ áâ®¨¬®áâì ¢ àã¡. ³                 ³          ³  ¯¥à¥®æ¥­ª¨,   ³      ¯¥à¥®æ¥­ª¨    ³       ¯à®æ¥­â­ë© ¤®å®¤      ³    ¯à®æ¥­â­®£®     ³       ¤¨áª®­â­ë© ¤®å®¤      ³     ¤¨áª®­â­®£®    ³  ­¥ á¯¨á ­­ ï ­  à áå®¤ë    ³       ¯à¥¬¨¨,      ³             ¯à¥¬¨ï          ³        ¯à¥¬¨¨      ³  ®¡ê¥¬   ³ ª®â¨à®¢ª¨³    (302-)    ³ ª ç¥áâ¢  ³ á®§¤ ­­®£® ­   ³    «¨æ¥¢®£® áç¥â   ³     2732-“     ³    «¨æ¥¢®£® áç¥â   ³                    ³                    ³                    ³ \n"+
"³                              ³   ¢«®¦¥­¨© ¢ æ/¡   ³                         ³            ³                  ³                  ³ ªã¯®­   ³®¡«¨£ æ¨¨³®¡«¨£ æ¨¨³        ³             ³                ³  ªã¯®­ã   ³                                       ³                                        ³                  ³                 ³          ³     àã¡.       ³                    ³                             ³       ¤®å®¤        ³                             ³       ¤®å®¤        ³                             ³    ­¥ á¯¨á ­­®©    ³                             ³                    ³  í¬¨áá¨¨ ³(àë­.æ¥­ )³               ³          ³ ¡ « ­á¥ ¡ ­ª , ³       (à¥§¥à¢)     ³                ³      à¥§¥à¢  ¯®    ³                    ³                    ³                    ³ \n"+
"³                              ³                    ³                         ³            ³                  ³                  ³         ³         ³         ³        ³             ³                ³           ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                  ³                 ³          ³('+' - ¯®«®¦¨â. ³                    ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´     ­  à áå®¤ë     ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                    ³          ³          ³               ³          ³     àã¡.       ³                    ³                ³        2732-“      ³                    ³                    ³                    ³ \n"+
"³                              ³                    ³                         ³            ³                  ³                  ³         ³         ³         ³        ³             ³                ³           ³                   ³                   ³                    ³                   ³                  ³                 ³          ³ '-' - ®âà¨æ â.)³                    ³              ³              ³                    ³              ³              ³                    ³              ³              ³                    ³              ³              ³                    ³          ³          ³               ³          ³                ³                    ³                ³                    ³                    ³                    ³                    ³ \n"+
"³                              ³                    ³                         ³            ³                  ³                  ³         ³         ³         ³        ³             ³                ³           ³        ¢ «.       ³        àã¡.       ³       ¢ «.         ³       àã¡.        ³                  ³                 ³          ³                ³                    ³     ¢ «.     ³     àã¡.     ³                    ³     ¢ «.     ³     àã¡.     ³                    ³     ¢ «.     ³     àã¡.     ³                    ³     ¢ «.     ³     àã¡.     ³                    ³          ³          ³               ³          ³                ³                    ³                ³                    ³                    ³                    ³                    ³ \n"+
"³                              ³                    ³                         ³            ³                  ³                  ³         ³         ³         ³        ³             ³                ³           ³                   ³                   ³                    ³                   ³                  ³                 ³          ³                ³                    ³              ³              ³                    ³              ³              ³                    ³              ³              ³                    ³              ³              ³                    ³          ³          ³               ³          ³                ³                    ³                ³                    ³                    ³                    ³                    ³ \n"+
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ \n"+
"³             1                ³          2         ³            3            ³     4      ³        5         ³        6         ³    7    ³    7€   ³    8    ³   9    ³      10     ³        11      ³    12     ³        13€        ³        13        ³       14A          ³       14         ³        15        ³      16         ³    17    ³       18       ³       19           ³     20€      ³     20      ³        21          ³     22€      ³     22      ³         23         ³     24€      ³     24      ³         25         ³     26€      ³     26      ³         27         ³    28    ³    29    ³      30       ³    31    ³       32       ³       33           ³       34       ³       35           ³         36         ³          37        ³         38         ³ \n"+
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ ";

private var Excel;
private var Data;
private var Report;

 // ª« áá ¯® â¥¬¥ 450414
private	class MYARRAY  
		var A30 = TArray,	A1 = TArray,	A3 = TArray,	A4 = TArray,	A5 = TArray,	A6 = TArray,	A7 = TArray,	A7_1 = TArray,	A8 = TArray,	A9 = TArray,	A10 = TArray,
		A11 = TArray,	A12 = TArray,	A13¡ = TArray,	A14  = TArray,	A14¡ = TArray,	A15 = TArray,	A16 = TArray,	A17a = TArray,	A17b = TArray,	A18a = TArray,	A18b = TArray,
		A19 = TArray,	A20  = TArray,	A20¡ = TArray,	A21 = TArray,	A22  = TArray,	A22¡ = TArray,	A23 = TArray,	26  = TArray,	26¡ = TArray,	27 = TArray,	A25 = TArray,	
		A27 = TArray,	A28 = TArray,	A29 = TArray,	A31 = TArray,	A32 = TArray,	A33 = TArray,	A40 = TArray,	A34 = TArray,	C8700 = TArray,	C8704 = TArray,	C8924 = TArray,
		C8961 = TArray,	C8972 = TArray,	C8989¥ = TArray,	C8989­ = TArray,	C8995 = TArray,	C8998 = TArray,	C9060 = TArray, ident = TArray;
	
	macro insertin(i, A30_,	A1_, A3_, A4_, A5_, A6_, A7_, A7_1_, A8_, A9_, A10_, A11_, A12_ , A13¡_, A14 _, A14¡_, A15_, A16_, A17a_,	A17b_, A18a_, A18b_, A19_, A20 _, A20¡_, A21_, A22 _, A22¡_, A23_, 	26 _, 	26¡_, 27_, A25_, 	A27_, A28_, A29_, A31_, A32_, A33_, A40_, A34_, C8700_, C8704_, C8924_, C8961_, C8972_, C8989¥_, C8989­_, C8995_, C8998_,	C9060_, ident_)
		
       A30(i) = A30_;
	   A1 (i) = A1_;
	   A3 (i) = A3_;
	   A4 (i) = A4_;
	   A5 (i) = A5_;
	   A6 (i) = A6_;
	   A7 (i) = A7_;
	   A7_1 (i) = A7_1_;
	   A8 (i) = A8_;
	   A9 (i) = A9_;
	   A10 (i) = A10_;
	   A11 (i) = A11_;
	   A12 (i) = A12_;
	   A13¡ (i) = A13¡_;
	   A14  (i) = A14 _;
	   A14¡ (i) = A14¡_;
	   A15 (i) = A15_;
	   A16 (i) = A16_;
	   A17a (i) = A17a_;
	   A17b (i) = A17b_;
	   A18a (i) = A18a_;
	   A18b (i) = A18b_;
	   A19 (i) = A19_;
	   A20  (i) = A20 _;
	   A20¡ (i) = A20¡_;
	   A21(i) = A21_;
	   A22  (i) = A22 _;
	   A22¡ (i) = A22¡_;
	   A23 (i) = A23_;
	   26  (i) = 26 _;
	   26¡ (i) = 26¡_;
	   27 (i) = 27_;
	   A25 (i) = A25_;
	   A27 (i) = A27_;
	   A28 (i) = A28_;
	   A29 (i) = A29_;
	   A31 (i) = A31_;
	   A32 (i) = A32_;
	   A33  (i) = A33_;
	   A40 (i) = A40_;
	   A34 (i) = A34_ ;
	   C8700 (i) = C8700_;
	   C8704 (i) = C8704_;
	   C8924 (i) = C8924_;
	   C8961  (i) = C8961_;
	   C8972 (i) = C8972_;
	   C8989¥ (i) = C8989¥_;
	   C8989­ (i) =C8989­_; 
	   C8995 (i) =C8995_ ;
	   C8998 (i) =	C8998_;
	   C9060 (i) =C9060_;
	   ident (i) = ident_;

    end;
		
		
	macro printline(a, AvoirAmountStr, AmountPoint)
	
	for(var i, 0 , a , 1)
		if (ident (i)==1)
			Report.merge( "N1_A1", "N1_A31" );
		end;
   
		Report.PrintTableLine( "N1_A30",   A30(i) ,                         null,
                             "N1_A1",   A1 (i),                                    null,
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A2",   Data.NumToStr(LineSumm.Account),                       null,
                             "N1_A3",   A3 (i),                                      null,
                             //"N1_A4",   LineSumm.AvKindShName,                                 null,
                             "N1_A4",   A4 (i),                               null,
                             "N1_A5",   A5 (i),                                        null,
                             "N1_A6",   A6 (i),                                        null,
                             "N1_A7",   A7 (i) ,                                          null,
                             "N1_A7_1",  A7_1 (i) ,                                         null,
                             "N1_A8",   A8 (i),                                           null,
                             "N1_A9",   A9 (i),                                            null,
                             "N1_A10",   A10 (i),                              null,
                             "N1_A11",   A11 (i), SetPrecisionByFractPart(AvoirAmountStr, AmountPoint, 0),
                             "N1_A12",  A12 (i),  null,
//                             "N1_A12",  IncomeRate,                                            int(SGS_point(fininstr.fiid, Data.RepDate)),
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A13a", Data.NumToStr(LineSumm.BalCostCUR, null, true),        null,
                             "N1_A13b", A13¡ (i) ,                                   null,
                             /*
                             "N1_A14a", Data.NumToStr(LineSumm.CostInCUR, null, true),         null,
                             "N1_A14b", LineSumm.CostInRUR,                                    null,
                             "N1_A15",  LineSumm.BuyCostRUR,                                   null,
                             */
                             "N1_A14a",  A14  (i),           null,
                             "N1_A14b", A14¡ (i),        null,
                             "N1_A15",  A15 (i),                       null,
                             "N1_A16",  A16 (i),         null,
                             "N1_A17a", A17a (i),               null,
                             "N1_A17b", A17b (i),           null,
                             "N1_A18a",  iif(A18a(i)!="",A18a(i),0) ,     null,
                             "N1_A18b",  iif(A18b(i)!="",A18b(i),0),     null,
                             "N1_A19",   A19 (i),                                null,
                             "N1_A20a", A20  (i), null,
                             "N1_A20b", A20¡ (i), null,
                             "N1_A21",  A21(i),                                        null,
                             "N1_A22a", A22 (i), null,
                             "N1_A22b", A22¡ (i) , null,
                             "N1_A23",   A23 (i) ,                                        null,
                             /* ã¤ «¥­ë ¢ è ¡«®­¥
                             "N1_B24a", Data.NumToStr(LineSumm.BonusCUR, null, true),          null,
                             "N1_B24b", Data.NumToStr(LineSumm.BonusRUR, null, true),          null,
                             "N1_B25",  LineSumm.AccPDBon,                                     null,
                             */
                             "N1_B26a", 26  (i) ,      null,
                             "N1_B26b", 26¡ (i),      null,
                             "N1_B27",  27 (i),                                       null,
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A24",  Data.NumToStr(AvoirPerc, 2, true),                     null,
                             "N1_A25",   A25 (i),                                          null,
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A26",  Price_MPrice,                                          null,
                             "N1_A27",   A27 (i),                                                 null,
                             "N1_A28",  A28 (i) ,                        null,
                             "N1_A29",  A29 (i) ,                              null,

                             "N1_A31",  A31 (i),                              null,
                             "N1_A32",   A32 (i) ,       null,
                             "N1_A33",   A33  (i),       null,
                             "N1_A40",   A40 (i),                       null,
                             "N1_A34",   A34 (i) ,                      null,
                             "N1_C8700",  C8700 (i),                      null,
                             "N1_C8704",  C8704 (i) ,                      null,
                             "N1_C8924",  C8924 (i),                      null,
                             "N1_C8961",  C8961  (i),                      null,
                             "N1_C8972",  C8972 (i),                      null,
                             "N1_C8989e", C8989¥ (i) ,                      null,
                             "N1_C8989n", C8989­ (i) ,                      null,
                             "N1_C8995",  C8995 (i),                      null,
                             "N1_C8998",   C8998 (i) ,                      null,
                             "N1_C9060",  C9060 (i) ,                      null
       );
	end;
	end;
end;		
/* „ ­­ë¥ ®âç¥â  */
private class (TBaseReportData) ReportData(
                           _DprtNum, _RepDate, _PortfTrade, _PortfSale,
                           _PortfRetire, _PortfUnadmitted, _PortfBack, _PortfODcom, _PortfODreq,
                           _PortfContr, _PortfPromissory, _PortfBack_KSU, _PortfBack_BPP_KSU, _Apostr )

   /* ˆáå®¤­ë¥ ¤ ­­ë¥ */
   var
      DprtNum          = _DprtNum,     /* ”¨«¨ « */
      RepDate          = _RepDate - 1, /*­ ç «® ®âç¥â­®© ¤ âë*/
      PortfTrade       = _PortfTrade,       /* ’ */
      PortfSale        = _PortfSale,        /*  */
      PortfRetire      = _PortfRetire,      /* “„ */
      PortfUnadmitted  = _PortfUnadmitted,  /*  */
      PortfBack        = _PortfBack,        /* ‚ */
      PortfOD_req      = _PortfODreq,       /* +„ */
      PortfOD_com      = _PortfODcom,       /* -„ */
      PortfContr       = _PortfContr,       /* Š“ */
      PortfPromissory  = _PortfPromissory,  /* „ */
      PortfBack_KSU    = _PortfBack_KSU,    /* ‚_Š‘“ */
      PortfBack_BPP_KSU= _PortfBack_BPP_KSU;/* ‚__Š‘“ */

   var
      WasExistsDepData  = false,
      WasCollectedData  = false,
      UniqStr           = TUniqStrCollector,
      PortfNameArray    = TArray,
      CategNameArray    = TArray,
      CategFootArray    = TArray;

   /* Š®­áâàãªâ®à */
   initTBaseReportData( _Apostr );

    var DelimPrinter = TDelimLinePrinter;

   /* ‡ £àã§ª  à §¤¥«¨â¥«¥©. */
                                                            //              1                               2                            3                        4                 5                  6             7        7A        8         9          10             11              12             13A                 13B                  14A                 14B                 15                 16            17             18               19                 20A            20B              21                 22A           22B                23              24         25             26          27            28                 29
   DelimPrinter.LoadDelimiter( LineID_None,  LineID_Head1, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Head1, LineID_Data,  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Data,  LineID_Data,  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Data,  LineID_Foot1, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Foot1, LineID_Head1, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Head1, LineID_Head2, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Head2, LineID_Data,  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Data,  LineID_Foot2, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Foot2, LineID_Head2, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Foot2, LineID_Foot1, "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );
   DelimPrinter.LoadDelimiter( LineID_Foot1, LineID_Summ,  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ " );


   /*  §¢ ­¨ï ¯®àâä¥«¥©. */
   PortfNameArray[PortfID_Undef]       = "Undefined";
   PortfNameArray[PortfID_Trade]       = TRADEPORTFNAME;
   PortfNameArray[PortfID_Sale]        = SALEPORTFNAME;
   PortfNameArray[PortfID_Retire]      = RETIREPORTFNAME;
   PortfNameArray[PortfID_Unadmitted]  = UNADMITEDPORTFNAME;
   PortfNameArray[PortfID_Back]        = BACKPORTFNAME;
   PortfNameArray[PortfID_OD_com]      = ODCOMPORTFNAME; /* -„!!!*/
   PortfNameArray[PortfID_OD_req]      = ODREQPORTFNAME; /* +„*/
   PortfNameArray[PortfID_Contr]       = CONTRPORTFNAME;
   PortfNameArray[PortfID_Promissory]  = PROMISSPORTFNAME;
   PortfNameArray[PortfID_Back_KSU]    = BACKKSUPORTFNAME;
   PortfNameArray[PortfID_Back_BPP_KSU]= BACKBPPKSUPORTFNAME;

   /*  §¢ ­¨ï ¯®¤à §¤¥« , ¯®¤¢ «  ¯®¤à §¤¥« . */
   CategNameArray[0] = "ã¬ £¨, á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì ª®â®àëå … ¬®¦¥â ¡ëâì ­ ¤¥¦­® ®¯à¥¤¥«¥­ ";
   CategNameArray[1] = "ã¬ £¨, á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì ª®â®àëå ¬®¦¥â ¡ëâì ­ ¤¥¦­® ®¯à¥¤¥«¥­ ";
   CategFootArray[0] = "ˆâ®£® ¯® æ/¡ á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì ª®â®àëå … ¬®¦¥â ¡ëâì ­ ¤¥¦­® ®¯à¥¤¥«¥­ ";
   CategFootArray[1] = "ˆâ®£® ¯® æ/¡ á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì ª®â®àëå ¬®¦¥â ¡ëâì ­ ¤¥¦­® ®¯à¥¤¥«¥­ ";

end;

/*ª®¤ ¡ã¬ £¨*/
private macro usr_gr4(fiid):STRING
   var rs = TRsbDataSet("" +
			" select attr.t_name "
			"   from dobjatcor_dbt objatcor, dobjattr_dbt attr "
			"  where     objatcor.t_objecttype = " + string(OBJTYPE_AVOIRISS) +
			"        and objatcor.t_groupid = 33 " + // Š®¤ ¨­áâàã¬¥­â  ¤«ï ä®à¬ë 405
			"        and objatcor.t_object = lpad (" + string(fiid) + ", 10, '0') " +
			"        and objatcor.t_attrid = attr.t_attrid " +
			"        and objatcor.t_objecttype = attr.t_objecttype " +
			"        and objatcor.t_groupid = attr.t_groupid "
                       );


   if (rs.movenext())
      return rs.name;
   end;

   return "";
end;

/*®ç¥­ì áâà ­­ë¥ §­ ç¥­¨ï ¢ £à12, ¯®íâ®¬ã § ¬¥­¨«¨ ¯® ¯à®áì¡¥ ¡ ­ª */
private macro usr_gr12(fiid, income_date):STRING
   sql_execute("select rsi_rsb_fiinstr.calcnkd_ex (" + string(fiid) + "," + getsqldate(income_date) + ",1,1,0) FROM dual");

   var rs = TRsbDataSet("" +
			" SELECT RSI_RSB_FIInstr.FI_ReturnIncomeRate() income FROM dual "
                       );


   if (rs.movenext())
      return rs.income;
   end;

   return 0;
end;

macro SGS_point(fiid, ddt)
	var cmd = RSDCommand("select t_incomepoint point from dfiwarnts_dbt where t_ispartial=chr(0) and ? between t_firstdate and t_drawingdate and t_fiid = ?");
	cmd.AddParam("", RSDBP_IN, date(ddt));
	cmd.AddParam("", RSDBP_IN, fiid);
	var rs = RSDRecordSet(cmd);
	if (rs.movenext())
		return  rs.value(0);
	else
		return 3;
	end;
end;



/*%% à¥§¥à¢ */
/*…á«¨ ª â¥®£à¨ï ¯¥à¢ ï - 0*/
/*¨­ ç¥ á¬®âà¨¬ ¯à¨¬¥ç ­¨¥*/
private macro usr_gr32(fiid, Categ):integer
   if( Categ == "¥à¢ ï" )
      return 0;
   end;

   var rs = TRsbDataSet("" +
                         " select rsb_struct.getstring (t_text) rezerv "
                         " from dnotetext_dbt" +
                         " where t_DocumentID = LPAD (" + string(fiid) + ", 10, '0') " +
                         " and t_ObjectType = 12 " + // ¡ã¬ £ 
                         " and t_NoteKind = 3 " //à®æ¥­â à¥§¥à¢¨à®¢ ­¨ï
                        );

   if( rs.movenext() )
      return rs.rezerv;
   end;
end;

/*¥à¨®¤¨ç­®áâì ¢ë¯« â ªã¯®­­®£® ¤®å®¤ */
/*ª®«-¢® ªã¯®­®¢ ®âç¥â­®¬ £®¤ã*/
private macro usr_gr33(fiid):integer
   var reportYear;
   dateSplit( data.RepDate, null, null, reportYear );

   var rs = TRsbDataSet("" +
                        " select count(1) count from dfiwarnts_dbt "
                        "          where t_ispartial != chr(88) "
                                   " and t_drawingdate >= " + getsqldate(date( 1, 1,reportYear)) +
                                   " and t_drawingdate <= " + getsqldate(date(31,12,reportYear)) +
                                   " and t_fiid = " + string(fiid)
                        );

   if( rs.movenext() )
      return rs.count;
   end;
end;

/*®¬¥­à áç¥â  ¢â®à®£® ¯®àï¤ª */
private macro usr_gr34(account):STRING
   return substr(account,1,5);
end;

/*‹®¬¡ à¤­ë© á¯¨á®ª*/
private macro usr_gr35(fiid):STRING
   var Q_ObjAttr, D_ObjAttr;

   Q_ObjAttr = " Select t_AttrID " +
               "   From dobjatcor_dbt " +
               "  Where t_ObjectType      = " + string(OBJTYPE_AVOIRISS) +
               "    and t_GroupID         = 101 " + // ‹®¬¡ à¤
               "    and t_Object          = LPAD( " + string(fiid) + ", 10, '0' ) ";

   D_ObjAttr = TRsbDataSet(Q_ObjAttr);

   if (D_ObjAttr.MoveNext())
      return "„ ";
   end;

   return "¥â";
end;

PRIVATE VAR tss_prev_FIID = -1, tss_prev_NumInList = 0;
private macro ‚®§¬®¦­®áâì¯à¥¤¥«¥­¨ï’‘‘ „ âã(iss, ADate)
  VAR NumInList = 0;

  if( tss_prev_FIID == iss.rec.FIID )
     return tss_prev_NumInList;
  end;
  tss_prev_FIID = iss.rec.FIID;
  tss_prev_NumInList = 0;

  if( GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(iss, OBJTYPE_AVOIRISS), 27, null, null, NumInList, ADate) )
     tss_prev_NumInList = NumInList;
     return NumInList;
  end;
  return 0;
end;

PRIVATE MACRO A_36(Curp, dealid, fiid):string  // Š‚„
    var cmd, rs, sbor;

    if (Curp != 7)  // ¯®àâä¥«ì , ¡¥à¥¬ ª®¤ ¨§ ¯à¨¬¥ç ­¨ï ª ¡ã¬ £¥

   	    rs = TRsbDataSet("" +
                         " select rsb_struct.getstring (t_text) code "
                         " from dnotetext_dbt" +
                         " where t_DocumentID = LPAD (" + string(fiid) + ", 10, '0') " +
                         " and t_ObjectType = 12 " + // ¡ã¬ £ 
                         " and t_NoteKind = 101 " //Š‚„
                        );

	    if( rs.movenext() )
	    	return rs.code;
	    else
		return "";
	    end;


    else  // ¯®àâä¥«ì 
	    cmd = RSDCommand("select t_partyid party from ddl_Tick_Dbt a where t_dealid = ?");
	    cmd.AddParam("", RSDBP_IN, dealid);
	    rs = RSDRecordSet(cmd);
	    rs.movenext();

    	    cmd = RSDCommand("select b.t_nameobject name from dobjatcor_dbt a, dobjattr_Dbt b where a.t_objecttype=? and a.t_groupid=? and t_object = lpad(to_char(?),10,'0') and a.t_attrid=B.T_ATTRID and a.t_objecttype=b.t_objecttype and a.t_groupid=b.t_groupid");
    	    cmd.AddParam("", RSDBP_IN, 3);    // ObjectType
    	    cmd.AddParam("", RSDBP_IN, 17);   // Group
    	    cmd.AddParam("", RSDBP_IN, rs.value("PARTY"));
    	    rs = RSDRecordSet(cmd);
    	    sbor = "";
    	    while (rs.movenext())
    	    	sbor = sbor + "," + rs.value(0);
	    end;
            sbor = substr(sbor,2,200) + ",";
            if (strlen(sbor)==1) sbor = "";
            end;
            return sbor;
    end;
END;

PRIVATE MACRO A_37(Curp, dealid, fiid):string  // Š€’
    var cmd, rs, typ, id, sbor, group;
    if (Curp != 7)  // ¯®àâä¥«ì , ¡¥à¥¬ ¨§ ¯à¨¬¥ç ­¨ï ª ¡ã¬ £¥

   	    rs = TRsbDataSet("" +
                         " select rsb_struct.getstring (t_text) code "
                         " from dnotetext_dbt" +
                         " where t_DocumentID = LPAD (" + string(fiid) + ", 10, '0') " +
                         " and t_ObjectType = 12 " + // ¡ã¬ £ 
                         " and t_NoteKind = 102 " //Š‚„
                        );

	    if( rs.movenext() )
	    	return rs.code;
	    else
	 	return "";
	    end;

    else  // ¯®àâä¥«ì 
	    cmd = RSDCommand("select t_partyid party from ddl_Tick_Dbt a where t_dealid = ?");
	    cmd.AddParam("", RSDBP_IN, dealid);
	    rs = RSDRecordSet(cmd);
	    rs.movenext();

	    cmd = RSDCommand("select b.t_nameobject name from dobjatcor_dbt a, dobjattr_Dbt b where a.t_objecttype=? and a.t_groupid=? and t_object = lpad(to_char(?),10,'0') and a.t_attrid=B.T_ATTRID and a.t_objecttype=b.t_objecttype and a.t_groupid=b.t_groupid");
    	    cmd.AddParam("", RSDBP_IN, 3);    // ObjectType
    	    cmd.AddParam("", RSDBP_IN, 12);   // Group
    	    cmd.AddParam("", RSDBP_IN, rs.value("PARTY"));    rs = RSDRecordSet(cmd);
	    if (rs.movenext())
	      	return rs.value(0);
	    else
		return "";
	    end;
    end;
END;

PRIVATE MACRO A_38(fiid)  // BON
    var cmd, rs, typ, id, sbor, group;
    cmd = RSDCommand("select b.t_name name from dobjatcor_dbt a, dobjattr_Dbt b where a.t_objecttype=12 and a.t_groupid=102 and t_object = lpad(to_char(?),10,'0') and a.t_attrid=B.T_ATTRID and a.t_objecttype=b.t_objecttype and a.t_groupid=b.t_groupid");
    cmd.AddParam("", RSDBP_IN, fiid);
    rs = RSDRecordSet(cmd);
    if (rs.movenext())
      	return rs.value(0);
    else
	return "";
    end;
END;


/***********************************************************
COPYRIGHT    : Makhov.Aleksey.S
DESCRIPTION  :
CREATION DATE: .2017
************************************************************/
private macro ‘¯à ¢¥¤«¨¢ ï‘â®¨¬®áâì„«ïŠ®¤®¢(LineSumm)
   return LineSumm.BuyCostRUR + LineSumm.OutlayRUR + (LineSumm.OverAmountRURa-abs(LineSumm.OverAmountRURb)) + LineSumm.InterestIncomeRUR + LineSumm.DiscountIncomeRUR + LineSumm.BonusRestRUR + LineSumm.NKD_RUR;
end;

/***********************************************************/
// Makhov.Aleksey.S
// 29.10.2017
// Š®¤ 8700 ¢ª«îç ¥âáï á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì æ¥­­ëå ¡ã¬ £ ­¥ ¢ … ( áâ®¨¬®áâì ¡ã¬ £ ­  áç¥â å 50110,50106,50104)
private macro C_8700(LineSumm)
   var acc = SubStr(LineSumm.Account, 1, 5);
   var Sum = $0;
   if (acc != "50118")
      sum = ‘¯à ¢¥¤«¨¢ ï‘â®¨¬®áâì„«ïŠ®¤®¢(LineSumm);
   end;
   Total_8700 = Total_8700 + Sum;
   return sum;
end;

/***********************************************************/
// Makhov.Aleksey.S
// 29.10.2017
// 8704 â®«ìª® ®âà¨æ â¥«ì­ ï ¯¥à¥®æ¥­ª  ¯® ¡ã¬ £ ¬ ­  50118
private macro C_8704(LineSumm)
   var acc = SubStr(LineSumm.Account, 1, 5);
   var Sum = $0;
   if (acc == "50118")
      Sum = abs(LineSumm.OverAmountRURb);
   end;
   Total_8704 = Total_8704 + Sum;
   return Sum;
end;

/***********************************************************/
// Makhov.Aleksey.S
// 29.10.2017
// 8924  5% á¯à ¢¥¤«¨¢®© áâ®¨¬®áâ¨ ¡ã¬ £, ­ å®¤ïé¨åáï ­  50118
private macro C_8924(LineSumm)
   var acc = SubStr(LineSumm.Account, 1, 5);
   var Sum = $0;
   if (acc == "50118")
      Sum = ‘¯à ¢¥¤«¨¢ ï‘â®¨¬®áâì„«ïŠ®¤®¢(LineSumm);
      Sum = money(Sum / 100 * 5);
   end;
   Total_8924 = Total_8924 + Sum;
   return Sum;
end;

/***********************************************************/
// Makhov.Aleksey.S
// 31.10.2017
// 8961 ­ ç¨á«¥­­ë© ªã¯®­ ¢ àã¡«ïå ¯«îá ¤¨áª®­â ¯® ¢á¥¬ ¡ã¬ £ ¬
private macro C_8961(LineSumm)
   var Sum = $0;

   Sum = LineSumm.InterestIncomeRUR + LineSumm.DiscountIncomeRUR;

   Total_8961 = Total_8961 + Sum;
   return Sum;
end;

/***********************************************************/
// Makhov.Aleksey.S
// 31.10.2017
// 8972 á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì ”‡ (50104)
private macro C_8972(LineSumm)
   var acc = SubStr(LineSumm.Account, 1, 5);
   var Sum = $0;
   if ((acc == "50104")OR(acc == "50116"))
      Sum = ‘¯à ¢¥¤«¨¢ ï‘â®¨¬®áâì„«ïŠ®¤®¢(LineSumm);
   end;

   Total_8972 = Total_8972 + Sum;
   return Sum;
end;

/***********************************************************/
// Makhov.Aleksey.S
// 31.10.2017
// 8989 ¯ã­ªâ ¥  ¥á«¨ ¡ã¬ £¨ ¢å®¤ïâ ¢ ‹®¬¡ à¤­ë© á¯¨á®ª  ­ª  ®áá¨¨ , ¨ ­ å®¤ïâáï ­  áç¥â å 50106,50110 ,â® á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì íâ¨å ¡ã¬ £ ,¢å®¤¨â ¢ íâ®â ª®¤
private macro C_8989e(LineSumm, avoir)
   var acc3 = SubStr(LineSumm.Account, 1, 3);
   var acc5 = SubStr(LineSumm.Account, 1, 5);
   var Sum = $0;
   if (((acc5 == "50106")OR(acc5 == "50107")OR(acc5 == "50110")OR(acc3 == "506")) AND
       (StrUpr(usr_gr35(avoir.rec.fiid)) == "„€")
      )
      Sum = ‘¯à ¢¥¤«¨¢ ï‘â®¨¬®áâì„«ïŠ®¤®¢(LineSumm);
   end;

   Total_8989e = Total_8989e + Sum;
   return Sum;
end;

private macro C_8989n(LineSumm)
   var Sum = $0;

   Total_8989n = Total_8989n + Sum;
   return Sum;
end;

private macro C_8995(LineSumm)
   var Sum = $0;

   Total_8995 = Total_8995 + Sum;
   return Sum;
end;

/***********************************************************/
// Makhov.Aleksey.S
// 31.10.2017
// 8998  á¯à ¢¥¤«¨¢ ï áâ®¨¬®áâì ¬¨­ãá ­ ç¨á«¥­­ë© ªã¯®­
private macro C_8998(LineSumm)
   var Sum = $0;

   Sum = ‘¯à ¢¥¤«¨¢ ï‘â®¨¬®áâì„«ïŠ®¤®¢(LineSumm) - LineSumm.InterestIncomeRUR;

   Total_8998 = Total_8998 + Sum;
   return Sum;

end;

private macro C_9060(LineSumm)
   var Sum = $0;

   Total_9060 = Total_9060 + Sum;
   return Sum;

end;



PRIVATE VAR cc_prev_FIID = -1, cc_prev_Name = 0;
private macro ®«ãç¨âìŠ â¥£®à¨îŠ ç¥áâ¢ (iss, ADate)
  Var AttrID, Select, Data;

  if( cc_prev_FIID == iss.rec.FIID )
     return cc_prev_Name;
  end;
  cc_prev_FIID = iss.rec.FIID;
  cc_prev_Name = "";

  if( GetMainObjAttr( null, OBJTYPE_AVOIRISS, UniID( iss, OBJTYPE_AVOIRISS), 13, AttrID, null, null, ADate ) )
      Select = RSDCommand("select t_Name " +
                          "from dobjattr_dbt " +
                          "where t_ObjectType = ?" +
                          "   and t_GroupID = ?" +
                          "   and t_AttrID = ?");

      Select.addParam("ObjectType", RSDBP_IN, OBJTYPE_AVOIRISS);
      Select.addParam("GroupID", RSDBP_IN, 13);
      Select.addParam("AttrID", RSDBP_IN, AttrID);
      Select.execute();

      Data = TRsbDataSet(Select);
      if( Data.MoveNext() )
         cc_prev_Name = Data.Name;
         return Data.Name;
      end;
  end;

  return "";
end;

/* ‘¡®à ¤ ­­ëå ¢® ¢à¥¬¥­­ë© ä ©«. */
private macro CollectData( Data, TempFile,Department:integer )

   /* ‚®§¢à é ¥¬ ­®¬¥à ãç¥â­®£® ¯®àâä¥«ï ¤«ï «®â  ­  ¤ âã ¨ ­®¬¥à
      «¨æ¥¢®£® áç¥â , ­  ª®â®à®¬ ãç¨âë¢ îâáï ¡ã¬ £¨.
         LotBuy      - «®â ¯®ªã¯ª¨. ¥ ¬®¦¥¬ ¡à âì ¨§ FD, â.ª. ¤«ï «®â 
                       á®§¤ ­­®£® ®¯¥à æ¨¥© ¯¥à¥¬¥é¥­¨ï ¯®¤ª ç¨¢ ¥âáï
                       ¯¥à¢®­ ç «ì­ë© «®â ¯®ªã¯ª¨.
         FD          - FD ¯®ªã¯ª¨
         IsQuoted    - ª®â¨àã¥¬ ï æ/¡
         AccountNum  - ®¬¥à «/áç¥â . ‚®§¢à é ¥¬ */
   Data.WasExistsDepData = false;
   record acnt(account);
   macro ®«ãç¨âì“ç¥â­ë©®àâä¥«ì( LotBuy, Group )

         if( (Data.PortfTrade) and
             ((LotBuy.Portfolio == KINDPORT_TRADE) and (LotBuy.State == PM_WRTSUM_FORM)
               and (LotBuy.Amount != 0) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
            return PortfID_Trade;

         elif( (Data.PortfSale) and
               ((LotBuy.Portfolio == KINDPORT_SALE) and (LotBuy.State == PM_WRTSUM_FORM)
                 and (LotBuy.Amount != 0) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
            return PortfID_Sale;

         elif( (Data.PortfRetire) and
               ((LotBuy.Portfolio == KINDPORT_RETIRE) and (LotBuy.State == PM_WRTSUM_FORM)
                and (LotBuy.Amount != 0) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
            return PortfID_Retire;

         elif( (Data.PortfContr) and
               ((LotBuy.Portfolio == KINDPORT_CONTR) and (LotBuy.State == PM_WRTSUM_FORM)
                and (LotBuy.Amount != 0) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
            return PortfID_Contr;

         elif( (Data.PortfPromissory) and
               ((LotBuy.Portfolio == KINDPORT_PROMISSORY) and (LotBuy.State == PM_WRTSUM_FORM)
                and (LotBuy.Amount != 0) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
            return PortfID_Promissory;
         /*‚ ¯®àâä¥«ì ‚ ®â¡¨à îâáï «®âë, ¨§­ ç «ì­® ªã¯«¥­­ë¥ ¯® á¤¥«ª ¬ ®¡à â­®£® … ,
           ­¥ ¯à®¤ ­­ë¥ ¢¯®á«¥¤áâ¢¨¨*/
         elif( (Data.PortfBack) and ((IsREPO(Group) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY_BO)) OR IsAVRWRTIN(Group)) and
               ((LotBuy.Portfolio == KINDPORT_BACK) and (LotBuy.State == PM_WRTSUM_FORM)
                 and (LotBuy.Amount != 0) and (LotBuy.AmountBD == 0) )
             )
            return PortfID_Back;
         /*„«ï ¯®àâä¥«ï  ¢ ®âç¥â ®â¡¨à îâáï «®âë, ª®â®àë¥ ¯à®¤ ­ë ¨§ ¯®àâä¥«¥© "’", "", "“„", "Š“" ¨ ¨¬¥îâ ¯à¨§­ ª ""*/
         elif( (Data.PortfUnadmitted) and
               (((LotBuy.Portfolio == KINDPORT_SALE) or (LotBuy.Portfolio == KINDPORT_TRADE) or (LotBuy.Portfolio == KINDPORT_RETIRE) or (LotBuy.Portfolio == KINDPORT_CONTR)
                ) and
                (LotBuy.State == PM_WRTSUM_SALE_BPP) )
             )
            return PortfID_Unadmitted;
         /*„«ï ¯®àâä¥«ï „ ¢ ®âç¥â ®â¡¨à îâáï «®âë, ª®â®àë¥ ¯à®¤ ­ë ¨§ ¯®àâä¥«ï ‚ ¨ ¯à¥¤áâ ¢«ïîé¨¥
           á®¡®© âà¥¡®¢ ­¨ï/®¡ï§ â¥«ìáâ¢  ¯® ¢®§¢à âã æ/¡:
           a. ãçâ¥­­ë¥ ­  áç¥â å "- „" (¨«¨ "¡ï§.á­.á.") ®¡ï§ â¥«ìáâ¢  ¯® ®¡à â­®© ¯®áâ ¢ª¥ æ/¡ 2 ç áâ¥© á¤¥«®ª
              ®¡à â­®£® …, ¢®§­¨ª îé¨¥ ¢ à¥§ã«ìâ â¥ ¯à®¤ ¦¨ æ¥­­ëå ¡ã¬ £, ¯®«ãç¥­­ëå ¯® 1 ç áâ¨ á¤¥«ª¨ ®¡à. … ¨«¨
              ¯à¨¢«¥ç¥­¨ï § ©¬  (¯®àâä¥«ì ‚);
           b. ãçâ¥­­ë¥ ­  áç¥â å "+„" (¨«¨ "’à¥¡.á­.á) âà¥¡®¢ ­¨ï ¯® ¯®áâ ¢ª¥ æ/¡ 2 ç áâ¥© á¤¥«®ª ¯àï¬®£® … ¨«¨
              2 ç áâ¥© à §¬¥é¥­¨ï § ©¬ , ¢®§­¨ªè¨¥ ¯à¨ ¯à®¤ ¦¥ ¢ íâ¨å á¤¥«ª å æ/¡, ¯®«ãç¥­­ëå ¢ 1-å ç áâïå á¤¥«®ª
              ®¡à â­®£® … ¨«¨ ¯à¨¢«¥ç¥­¨ï § ©¬ .*/
         elif( (Data.PortfOD_com) AND
               (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_SALE) and (LotBuy.AmountBD != 0) and (IsREPO(Group) and (LotBuy.State == PM_WRTSUM_NOTFORM))
             )
            return PortfID_OD_com; /* -„*/
         elif( (Data.PortfOD_req) AND
                 ( (LotBuy.Portfolio == KINDPORT_BASICDEBT) and (LotBuy.AmountBD != 0)
                    and (LotBuy.State == PM_WRTSUM_NOTFORM) )
             )
            return PortfID_OD_req;  /*+„*/
         elif( (Data.PortfBack_KSU) and ((IsREPO(Group) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY_BO)) OR IsAVRWRTIN(Group)) and
               ((LotBuy.Portfolio == KINDPORT_BACK_KSU) and (LotBuy.State == PM_WRTSUM_FORM)
                 and (LotBuy.Amount != 0) and (LotBuy.AmountBD == 0) )
             )
            return PortfID_Back_KSU;
         elif( (Data.PortfBack_BPP_KSU) AND
                 ( (LotBuy.Portfolio == KINDPORT_BACK_BPP_KSU) and (LotBuy.State == PM_WRTSUM_NOTFORM) )
             )
            return PortfID_Back_BPP_KSU;
         end;
      return PortfID_Undef;
   end;

   var Group, IsBack, LegKind,
       dl_leg   = TRecHandler( "dl_leg" ),
       dl_tick  = TRecHandler( "dl_tick" );

   var
      account   = TRecHandler( "account" ),
      pmwrtsum,
      LotState, LotAmount, PortfID, FD, IsQuoted, IssShName, Nrec, count, IsTrue = false,
      AvKindShName, AccountNum, Amount, Select = "", Query, Point = false, IsData = false, selectbpp, pmwbpp;
   var fininstr = Trechandler( "fininstr.dbt" ), /* ä¨­. ¨­áâàã¬¥­â*/
       avoiriss = Trechandler( "avoiriss.dbt" ); /* ¡ã¬ £ */

   macro ‚áâ ¢¨âì‡ ¯¨áì()
      ClearRecord(TempFile);
      TempFile.PortfID        = PortfID;
      TempFile.IsQuoted       = IsQuoted;
      TempFile.DealID         = FD.tick.rec.DealID;
      TempFile.LegKind        = FD.dl_leg.rec.LegKind;
      TempFile.FIID           = fininstr.rec.FIID;
      TempFile.LotAmount      = Amount;
      TempFile.IssShName      = IssShName;
      TempFile.AvKindShName   = AvKindShName;
      TempFile.Account        = AccountNum;
      TempFile.DocKind        = pmwrtsum.DocKind;
      TempFile.DocID          = pmwrtsum.DocID;
      TempFile.PartNum        = pmwrtsum.PartNum;

      InsertRecTempFile( TempFile );
      Data.WasCollectedData = true;
      Data.WasExistsDepData = true;
   end;

   MACRO GetPortfolio()
      VAR pSelect = " and s.t_Portfolio in ( " ,
          pPoint = false;

      if( Data.PortfTrade )
         pSelect = pSelect + string(KINDPORT_TRADE);
         pPoint = true;
      end;
      if( Data.PortfSale )
         if(pPoint)
            pSelect = pSelect + ",";
         end;
         pSelect = pSelect + string(KINDPORT_SALE);
         pPoint = true;
      end;
      if( Data.PortfContr )
         if(pPoint)
            pSelect = pSelect + ",";
         end;
         pSelect = pSelect + string(KINDPORT_CONTR);
         pPoint = true;
      end;
      if( Data.PortfRetire )
         if(pPoint)
            pSelect = pSelect + ",";
         end;
         pSelect = pSelect + string(KINDPORT_RETIRE);
         pPoint = true;
      end;
      if( Data.PortfPromissory )
         if(pPoint)
            pSelect = pSelect + ",";
         end;
         pSelect = pSelect + string(KINDPORT_PROMISSORY);
      end;

      return ( pSelect + ") " );
   end;

   /*â¡¨à îâáï :
       ) ­¥ ¯à®¤ ­­ë¥ ¯® á®áâ®ï­¨î ­  ­ ç «® ®âç¥â­®© ¤ âë «®âë ®¡ëç­ëå ¯®ªã¯®ª ¨ ®¯¥à æ¨© § ç¨á«¥­¨ï,
         áâ âãá ª®â®àëå à ¢¥­ "¯®áâ ¢«¥­", ®â­®áïé¨¥áï ª ¤ ­­®¬ã "ãç¥â­®¬ã ¯®àâä¥«î".
      ¡) ¯® ­¥§ ªàëâë¬ ­  ¤ âã ®âç¥â  á¤¥«ª ¬ … ®â¡¨à îâáï «®âë áâ âãá®¬ "¯®áâ ¢«¥­" ¨«¨ "­¥ ¯®-áâ ¢«¥­".
   */
   var SelectDprt = " s.t_Department = " + string(Department) + "  AND ";

   /**/
   if(Data.PortfUnadmitted)
       Select = Select +
            " SELECT   *  " +
            " FROM (SELECT s.t_fiid, s.t_dealid, s.t_buy_sale, s.t_parent, s.t_sumid, s.t_instance, " +
            "              s.t_amount, s.t_amountbd, s.t_changedate, s.t_portfolio, s.t_state, s.t_enterdate, " +
            "              s.t_docid, s.t_dockind, s.t_partnum, s.t_kind " +
            "       FROM dpmwrtsum_dbt s " +
            "       WHERE  " + SelectDprt + " s.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
            "              AND s.t_party = -1 " +
            "              AND s.t_dockind = " + string(DLDOC_PAYMENT) +
            "              AND s.t_kind = 210 " +
            "              AND s.t_portfolio in( " + string(KINDPORT_TRADE) + ", " + string(KINDPORT_SALE) + ", " + string(KINDPORT_RETIRE) + ", " + string(KINDPORT_CONTR) + ") " +
            "              AND s.t_state = " + string(PM_WRTSUM_SALE_BPP) +
            "              AND s.t_changedate <= " + GetSQLDate(Data.RepDate) +
            "     UNION   " +
            "       SELECT m.t_fiid, m.t_dealid, m.t_buy_sale, m.t_parent, t.t_sumid, t.t_instance, " +
            "              t.t_amount, t.t_amountbd, t.t_changedate, m.t_portfolio, t.t_state, m.t_enterdate, " +
            "              m.t_docid, m.t_dockind, m.t_partnum, m.t_kind " +
            "       FROM dpmwrtbc_dbt t, dpmwrtsum_dbt m " +
            "       WHERE t.t_sumid IN ( " +
            "                      SELECT s.t_sumid " +
            "                        FROM dpmwrtsum_dbt s " +
            "                       WHERE " + SelectDprt + " s.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
            "                              AND s.t_party = -1 " +
            "                              AND s.t_dockind = " + string(DLDOC_PAYMENT) +
            "                              AND s.t_kind = 210 " +
            "                              AND s.t_portfolio in( " + string(KINDPORT_TRADE) + ", " + string(KINDPORT_SALE) + ", " + string(KINDPORT_RETIRE) + ", " + string(KINDPORT_CONTR) + ") "+
            "                              AND s.t_changedate > " + GetSQLDate(Data.RepDate) +
            "                          ) "
            "             and t.t_state = " + string(PM_WRTSUM_SALE_BPP) +
            "             AND t.t_instance = " +
            "                            (SELECT MAX (v.t_instance) " +
            "                               FROM dpmwrtbc_dbt v " +
            "                              WHERE v.t_sumid = t.t_sumid " +
            "                                AND v.t_changedate <= " + GetSQLDate(Data.RepDate) + ") " +
            "             AND m.t_sumid = t.t_sumid )";

       IsData = true;
   end;

   /*"’" /"" / "“„" / "„" / "Š“"*/
   if( Data.PortfTrade or Data.PortfSale or Data.PortfRetire or Data.PortfContr or Data.PortfPromissory )

       if( IsData != false )
         Select = Select + " Union ";
       end;
       /*¯® kind = 210 ®â¡¥à¥¬ «®âë, ¢¥à­ã¢è¨¥áï ¨§ 
                   20 ®¡ëç­ë¥ ¯®ªã¯ª¨
                   40,110, 130 § ç¨á«¥­¨ï, § ç¨á«¥­¨ï ¯à¨ ª®­¢¥àâ æ¨¨, § ç¨á«¥­¨ï ¢ £«®¡. ®¯æ¨¨
                   90  ¯¥à¥¬¥é¥­¨ï ¢ ¯®àâä¥«ì*/
       Select = Select +
            " SELECT   *  " +
            " FROM (SELECT s.t_fiid, s.t_dealid, s.t_buy_sale, s.t_parent, s.t_sumid, s.t_instance, " +
            "              s.t_amount, s.t_amountbd, s.t_changedate, s.t_portfolio, s.t_state, s.t_enterdate, " +
            "              s.t_docid, s.t_dockind, s.t_partnum, s.t_kind " +
            "       FROM dpmwrtsum_dbt s " +
            "       WHERE " + SelectDprt + " s.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
            "             AND s.t_party = -1 " +
            "             AND s.t_dockind in(" + string(DLDOC_PAYMENT) + ", " + string(DL_ISSUE_UNION) + ", " +string(DL_MOVINGDOC) + ") " +
            "             AND s.t_dealid > 0 " +
            "             AND s.t_kind in(20,210,40,110,130,90) " +
            GetPortfolio() +
            "             AND s.t_state = " + string(PM_WRTSUM_FORM) +
            "             AND s.t_Amount != 0 " +
            "             AND s.t_changedate <= " + GetSQLDate(Data.RepDate) +
            "     UNION   " +
            "       SELECT m.t_fiid, m.t_dealid, m.t_buy_sale, m.t_parent, t.t_sumid, t.t_instance, " +
            "              t.t_amount, t.t_amountbd, t.t_changedate, m.t_portfolio, t.t_state, m.t_enterdate, " +
            "              m.t_docid, m.t_dockind, m.t_partnum, m.t_kind " +
            "       FROM dpmwrtbc_dbt t, dpmwrtsum_dbt m " +
            "       WHERE t.t_sumid IN ( " +
            "                      SELECT s.t_sumid " +
            "                        FROM dpmwrtsum_dbt s " +
            "                       WHERE " + SelectDprt + "  s.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
            "                             AND s.t_party = -1 " +
            "                             AND s.t_dockind in(" + string(DLDOC_PAYMENT) + ", " + string(DL_ISSUE_UNION) + ", " +string(DL_MOVINGDOC) + ") " +
            "                             AND s.t_dealid > 0 " +
            "                             AND s.t_kind in(20,210,40,110,130,90) " +
            GetPortfolio() +
            "                             AND s.t_changedate > " + GetSQLDate(Data.RepDate) +
            "                           ) " +
            "             AND t.t_state = " + string(PM_WRTSUM_FORM) +
            "             AND t.t_Amount != 0 " +
            "             AND t.t_instance = (SELECT MAX (v.t_instance) " +
            "                                   FROM dpmwrtbc_dbt v " +
            "                                  WHERE v.t_sumid = t.t_sumid " +
            "                                    AND v.t_changedate <= " + GetSQLDate(Data.RepDate) + ") " +
            "             AND m.t_sumid = t.t_sumid )";

      IsData = true;
      Point = false;
   end;

   /* ‚ (…/§ ç¨á«¥­¨ï) */
   if( Data.PortfBack )
      if( IsData != false )
         Select = Select + " Union ";
      end;
      Select = Select +
                   " SELECT   *  " +
                   " FROM (SELECT s.t_fiid, s.t_dealid, s.t_buy_sale, s.t_parent, s.t_sumid, s.t_instance, " +
                   "              s.t_amount, s.t_amountbd, s.t_changedate, s.t_portfolio, s.t_state, s.t_enterdate, " +
                   "              s.t_docid, s.t_dockind, s.t_partnum, s.t_kind " +
                   "       FROM dpmwrtsum_dbt s " +
                   "       WHERE " + SelectDprt + " s.t_Party = -1 " +
                   "             AND s.t_dockind in(" + string(DLDOC_PAYMENT) + ", " + string(DL_ISSUE_UNION) + ") " +
                   "             AND ( (    s.t_State = " + string(PM_WRTSUM_FORM) +
                   "                    and s.t_DealID = (select tick.t_DealID from ddl_tick_dbt tick " +
                   "                                       where     tick.t_DealID = s.t_DealID " +
                   "                                             and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                   "                                             and ( tick.t_DealStatus < 20 or (    tick.t_DealStatus = 20 " +
                   "                                                                              and tick.t_CloseDate > " + GetSQLDate(Data.RepDate) + "))) " +
                   "             AND s.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_BUY_BO) + " ) " +
                   "             OR s.t_kind in(40,110,130) )" +
                   "             AND s.t_Portfolio = " + string(KINDPORT_BACK) +
                   "             AND s.t_Amount != 0 " +
                   "             and s.t_AmountBD = 0 " +
                   "             AND s.t_changedate <= " + GetSQLDate(Data.RepDate) +
                   "     UNION   " +
                   "       SELECT m.t_fiid, m.t_dealid, m.t_buy_sale, m.t_parent, t.t_sumid, t.t_instance, " +
                   "              t.t_amount, t.t_amountbd, t.t_changedate, m.t_portfolio, t.t_state, m.t_enterdate, " +
                   "              m.t_docid, m.t_dockind, m.t_partnum, m.t_kind " +
                   "       FROM dpmwrtbc_dbt t, dpmwrtsum_dbt m " +
                   "       WHERE t.t_sumid IN ( " +
                   "                      SELECT s.t_sumid " +
                   "                        FROM dpmwrtsum_dbt s " +
                   "                       WHERE " + SelectDprt + " s.t_Party = -1 " +
                   "                             AND s.t_dockind in(" + string(DLDOC_PAYMENT) + ", " + string(DL_ISSUE_UNION) + ") " +
                   "                             AND ( (s.t_State = " + string(PM_WRTSUM_FORM) +
                   "                             and s.t_DealID = (select tick.t_DealID from ddl_tick_dbt tick where tick.t_DealID = s.t_DealID " +
                   "                                                 and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                   "                             and ( tick.t_DealStatus < 20 or (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(Data.RepDate) + "))) " +
                   "             and s.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_BUY_BO) + " ) " +
                   "             OR s.t_kind in(40,110,130) )" +
                   "             AND s.t_Portfolio = " + string(KINDPORT_BACK) +
                   "             AND s.t_changedate > " + GetSQLDate(Data.RepDate) +
                   "                           ) " +
                   "             and t.t_Amount != 0 " +
                   "             and t.t_AmountBD = 0 " +
                   "             AND t.t_instance = (SELECT MAX (v.t_instance) " +
                   "                                   FROM dpmwrtbc_dbt v " +
                   "                                  WHERE     v.t_sumid = t.t_sumid " +
                   "                                        AND v.t_changedate <= " + GetSQLDate(Data.RepDate) + ") " +
                   "             AND m.t_sumid = t.t_sumid )";

      IsData = true;
   end;

   /* +\- „ */
   if( Data.PortfOD_req or Data.PortfOD_com )
      if( IsData != false )
         Select = Select + " Union ";
      end;

      VAR SelectTmp =
                  SelectDprt + " s.t_Party = -1 " +
                  " AND s.t_dockind = " + string(DLDOC_PAYMENT) +
                  " and s.t_DealID = (select tick.t_DealID from ddl_tick_dbt tick where tick.t_DealID = s.t_DealID and " +
                  "                   rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, " +
                  "                   tick.t_BofficeKind)))=1 " +
                  "                   and ( tick.t_DealStatus < 20 or (tick.t_DealStatus = 20 " +
                  "                   and tick.t_CloseDate > " + GetSQLDate(Data.RepDate) + "))) ";
      Point = false;
      if( Data.PortfOD_req ) /* +„ */
         SelectTmp = SelectTmp + " AND (s.t_Portfolio = " + string(KINDPORT_BASICDEBT);
         Point = true;
      end;
      if( Data.PortfOD_com ) /* -„ */
         if(Point)
            SelectTmp = SelectTmp + " or ";
         else
            SelectTmp = SelectTmp + " AND ";
         end;
         SelectTmp = SelectTmp + " s.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_SALE);
      end;

      if(Point)
         SelectTmp = SelectTmp + " ) ";
      end;

      Select = Select +
               " SELECT   *  " +
               " FROM (SELECT s.t_fiid, s.t_dealid, s.t_buy_sale, s.t_parent, s.t_sumid, s.t_instance, " +
               "              s.t_amount, s.t_amountbd, s.t_changedate, s.t_portfolio, s.t_state, s.t_enterdate, " +
               "              s.t_docid, s.t_dockind, s.t_partnum, s.t_kind " +
               "       FROM dpmwrtsum_dbt s " +
               "       WHERE " + SelectTmp +
               "              and s.t_AmountBD != 0 " +
               "              and s.t_state = " + string(PM_WRTSUM_NOTFORM) +
               "              AND s.t_changedate <= " + GetSQLDate(Data.RepDate) +
               "     UNION   " +
               "       SELECT m.t_fiid, m.t_dealid, m.t_buy_sale, m.t_parent, t.t_sumid, t.t_instance, " +
               "              t.t_amount, t.t_amountbd, t.t_changedate, m.t_portfolio, t.t_state, m.t_enterdate, " +
               "              m.t_docid, m.t_dockind, m.t_partnum, m.t_kind " +
               "       FROM dpmwrtbc_dbt t, dpmwrtsum_dbt m " +
               "       WHERE t.t_sumid IN ( " +
               "                      SELECT s.t_sumid " +
               "                        FROM dpmwrtsum_dbt s " +
               "                       WHERE  " + SelectTmp +
               "                            AND s.t_changedate > " + GetSQLDate(Data.RepDate) +
               "                           ) " +
               "             and t.t_AmountBD != 0 " +
               "             and t.t_state = " + string(PM_WRTSUM_NOTFORM) +
               "             AND t.t_instance = (SELECT MAX (v.t_instance) " +
               "                                   FROM  dpmwrtbc_dbt v " +
               "                                  WHERE     v.t_sumid = t.t_sumid " +
               "                                        AND v.t_changedate <= " + GetSQLDate(Data.RepDate) + ") " +
               "             AND m.t_sumid = t.t_sumid )";

      IsData = true;
   end;

   /* ‚_Š‘“ (…/§ ç¨á«¥­¨ï) */
   if( Data.PortfBack_KSU )
      if( IsData != false )
         Select = Select + " Union ";
      end;
      Select = Select +
                   " SELECT   *  " +
                   " FROM (SELECT s.t_fiid, s.t_dealid, s.t_buy_sale, s.t_parent, s.t_sumid, s.t_instance, " +
                   "              s.t_amount, s.t_amountbd, s.t_changedate, s.t_portfolio, s.t_state, s.t_enterdate, " +
                   "              s.t_docid, s.t_dockind, s.t_partnum, s.t_kind " +
                   "       FROM dpmwrtsum_dbt s " +
                   "       WHERE " + SelectDprt + " s.t_Party = -1 " +
                   "             AND s.t_dockind = " + string(DLDOC_PAYMENT) +
                   "             AND s.t_State = " + string(PM_WRTSUM_FORM) +
                   "             AND s.t_Portfolio = " + string(KINDPORT_BACK_KSU) +
                   "             AND s.t_Amount != 0 " +
                   "             and s.t_AmountBD = 0 " +
                   "             AND s.t_changedate <= " + GetSQLDate(Data.RepDate) +
                   "     UNION   " +
                   "       SELECT m.t_fiid, m.t_dealid, m.t_buy_sale, m.t_parent, t.t_sumid, t.t_instance, " +
                   "              t.t_amount, t.t_amountbd, t.t_changedate, m.t_portfolio, t.t_state, m.t_enterdate, " +
                   "              m.t_docid, m.t_dockind, m.t_partnum, m.t_kind " +
                   "       FROM dpmwrtbc_dbt t, dpmwrtsum_dbt m " +
                   "       WHERE t.t_sumid IN ( " +
                   "                      SELECT s.t_sumid " +
                   "                        FROM dpmwrtsum_dbt s " +
                   "                       WHERE " + SelectDprt + " s.t_Party = -1 " +
                   "                             AND s.t_dockind = " + string(DLDOC_PAYMENT) +
                   "                             AND s.t_State = " + string(PM_WRTSUM_FORM) +
                   "                             AND s.t_Portfolio = " + string(KINDPORT_BACK_KSU) +
                   "                             AND s.t_changedate > " + GetSQLDate(Data.RepDate) +
                   "                           ) " +
                   "             and t.t_Amount != 0 " +
                   "             and t.t_AmountBD = 0 " +
                   "             AND t.t_instance = (SELECT MAX (v.t_instance) " +
                   "                                   FROM dpmwrtbc_dbt v " +
                   "                                  WHERE     v.t_sumid = t.t_sumid " +
                   "                                        AND v.t_changedate <= " + GetSQLDate(Data.RepDate) + ") " +
                   "             AND m.t_sumid = t.t_sumid )";

      IsData = true;
   end;

   /* ‚__Š‘“ */
   if( Data.PortfBack_BPP_KSU )
      if( IsData != false )
         Select = Select + " Union ";
      end;

      Select = Select + " SELECT s.t_fiid, s.t_dealid, s.t_buy_sale, s.t_parent, s.t_sumid, s.t_instance, " +
                        "        s.t_amount, s.t_amountbd, s.t_changedate, s.t_portfolio, s.t_state, s.t_enterdate, " +
                        "        s.t_docid, s.t_dockind, s.t_partnum, s.t_kind " +
                        " FROM v_scwrthistex s, dpmwrtsum_dbt buy1 " +
                        " where "+SelectDprt+" s.t_Party = -1 " +
                        " AND s.t_dockind = " + string(DLDOC_PAYMENT) +
                        " and s.t_State = " + string(PM_WRTSUM_NOTFORM) +
                        " and s.t_DealID = (select tick.t_DealID from ddl_tick_dbt tick where tick.t_DealID = s.t_DealID  " +
                        "                   and (   tick.t_DealStatus < 20 "+
                        "                        or (    tick.t_DealStatus = 20 " +
                        "                            and (   tick.t_CloseDate > " + GetSQLDate(Data.RepDate) +
                        "                                 or rsb_secur.DealIsRepo(tick.t_DealID)=0"+
                        "                                )"+
                        "                           )"+
                        "                       )"+
                        "                  ) " +
                        " and s.t_Amount   > 0 " +
                        " and s.t_instance =(SELECT MAX (t_instance) " +
                        "                      FROM v_scwrthistex " +
                        "                     WHERE t_sumid = s.t_sumid " +
                        "                       AND t_changedate <= " + GetSQLDate(Data.RepDate) + ") " +
                        " and s.t_Portfolio = " + string(KINDPORT_BACK_BPP_KSU) +
                        " and s.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
                        " and buy1.t_SumID = s.t_Source " +
                        " and buy1.t_Portfolio = " + KINDPORT_BACK_KSU;


      IsData = true;
   end;

   Query = RSDCommand(Select);
   Query.execute();
   pmwrtsum = TRsbDataSet(Query);

   Nrec = RSDCommand("select count(1) NRec from (" + Select + ")");
   Nrec.execute();
   count = TRsbDataSet(Nrec);
   count.MoveNext();

   InitProgressBar( ToInt(count.NRec), StatLine, "â¡®à «®â®¢" );
   while( pmwrtsum.Next() )
      if( (pmwrtsum.FIID == fininstr.rec.FIID) OR
          (NOT ®«ãç¨âì”¨­ˆ­( pmwrtsum.FIID, fininstr, avoiriss ) )
        )
         UseProgressBar;

         if( ®«ãç¨âì‘¤¥«ªã®‹®âã( pmwrtsum, dl_tick, false, false ) )
            Group   = GetOperationGroup( dl_tick.rec.DealType );
            LegKind = GetLegKindByLotDeal( pmwrtsum, dl_tick.rec);
            IsBack  = (LegKind == LEG_KIND_DL_TICK_BACK);

            FD = repSPFirstDoc( dl_tick, IsBack, pmwrtsum.SumID );
            FD.SetCurPFI(pmwrtsum.FIID);
            IsQuoted = ‚®§¬®¦­®áâì¯à¥¤¥«¥­¨ï’‘‘ „ âã(avoiriss, Data.RepDate);
            /* ®«ãç¨¬ ãç¥â­ë© ¯®àâä¥«ì. */
            PortfID = ®«ãç¨âì“ç¥â­ë©®àâä¥«ì(pmwrtsum, Group);

            if( PortfID != PortfID_Undef )

               if( PortfID == PortfID_Unadmitted )
                  selectbpp = RSDCommand("select * from dpmwrtsum_dbt where t_SumID = ?");
                  selectbpp.addParam("", RSDBP_IN, pmwrtsum.Parent);
                  selectbpp.execute();

                  pmwbpp = TRsbDataSet(selectbpp);

                  if( pmwbpp.movenext() )
                     if( ®«ãç¨âì‘¤¥«ªã®‹®âã( pmwbpp, dl_tick, true, true ) )
                        FD = repSPFirstDoc( dl_tick, false, pmwrtsum.SumID );
                        FD.SetCurPFI(pmwrtsum.FIID);
                     end;
                  end;
               end;

               if( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) )
                  FD = repSPFirstDoc( LEG_KIND_DL_TICK_BACK, pmwrtsum.DealID, pmwrtsum.SumID );
                  FD.SetCurPFI(pmwrtsum.FIID);
               end;
              
                
               account = ‹‘ç¥â Š®â®à®¬“ç¨âë¢ ¥âáï‹®â( pmwrtsum, Data.RepDate, FD );
               /* ®«ãç ¥¬ ­®¬¥à «¨æ¥¢®£® áç¥â */
               AccountNum  = account.Account;

               IssShName = GetPartyShortNameByID( FI_GetIssuerOnDate( fininstr, Data.RepDate + 1) );

               /* A3  - ’¨¯ æ¥­­®© ¡ã¬ £¨ - Šà âª®¥ ­ ¨¬¥­®¢ ­¨¥ ¢¨¤  æ/¡
                  A3¡ - ¢. ®¬¥à ¢ë¯ãáª  */
               AvoirKindName( fininstr.rec.AvoirKind, AvKindShName );
               AvKindShName = AvKindShName + " ¢." + avoiriss.rec.Issue;

               if( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) )
                   Amount = pmwrtsum.AmountBD;
               else
                   Amount = pmwrtsum.Amount;
               end;

               /* „®¡ ¢«ï¥¬ § ¯¨áì ¢® ¢à¥¬¥­­ãî ¡ §ã */
               ‚áâ ¢¨âì‡ ¯¨áì();
           end;
         end;
      end;
   end;
   RemProgressBar;
end;

/* ¥ç âì ®â®¡à ­­ëå ¤ ­­ëå. */
private macro PrintData( Data, TempFile )

   /* ˆâ®£¨ ¯®¤à §¤¥« , à §¤¥« , ¢á¥© â ¡«¨æë. */
   class TSummary
      var
         AvAmount           = $0,
         BalCostRUR         = $0,
         BuyCostRUR         = $0,
         CostInRUR          = $0,
         Upl		    = $0,
         OverAmountRURa      = $0,
         OverAmountRURb      = $0,
         InterestIncomeRUR  = $0,
         DiscountIncomeRUR  = $0,
         BonusRUR           = $0,
         BonusRestRUR       = $0,
         AvAmountPoint      = 0;/*â®ç­®áâì ª®«-¢  ¢ ¨â®£®¢®© áâà®ª¥*/

      /* „®¡ ¢¨âì ¤ ­­ë¥. */
      macro AddData( _AvAmount, _BalanceCost, _BuyCost, _CostIn, _OverAmounta, _OverAmountb, _InterestIncome, _DiscountIncome, _Bonus, _BonusRest, _AvAmountPoint, _Upl)
         inc( AvAmount,    _AvAmount      );
         inc( BalCostRUR,  _BalanceCost   );
         inc( BuyCostRUR,  _BuyCost       );
         inc( CostInRUR,   _CostIn        );
         inc( OverAmountRURa, _OverAmounta  );
         inc( OverAmountRURb, _OverAmountb  );
         inc( InterestIncomeRUR, _InterestIncome);
         inc( DiscountIncomeRUR, _DiscountIncome);
         inc( BonusRUR, _Bonus);
         inc( Upl, _Upl);
         inc( BonusRestRUR, _BonusRest);
         if( _AvAmountPoint > AvAmountPoint )
            AvAmountPoint = _AvAmountPoint;
         end;
      end;

      /* ç¨áâ¨âì ¨â®£¨. */
      macro Clear
         AvAmount           = $0;
         BalCostRUR         = $0;
         BuyCostRUR         = $0;
         CostInRUR          = $0;
         OverAmountRURa      = $0;
         OverAmountRURb      = $0;
         InterestIncomeRUR  = $0;
         DiscountIncomeRUR  = $0;
         BonusRUR           = $0;
         BonusRestRUR       = $0;
         AvAmountPoint      = 0;
         Upl		    = 0;
      end;

      macro GetAvAmPoint()
         return AvAmountPoint;
      end;
   end;

   /* „ ­­ë¥ ®¤­®© áâà®ª¨ ®âç¥â . */
   class TLineSummary
      var
         PortfID, IsQuoted, IssShName, AvKindShName, AvrName,
         Account, AvAmount, FIID, BalCostRUR, OutlayRUR,
         BalCostCUR, BuyCostRUR,
         CostInRUR, CostInCUR, OverAmountRURa, OverAmountRURb, InterestIncomeRUR,
         InterestIncomeCUR, DiscountIncomeRUR, DiscountIncomeCUR, ReservAmountRUR, NKD,
         AccOverAmount, AccDD, AccPD, AccReserv, AccPDBon, BonusCUR, BonusRUR, BonusRestCUR, BonusRestRUR, AccBon,
         AccReserv2732, ReservAmount2732, dealid;

      var NKD_RUR, BuyCost; /*¯®«ì§®¢ â¥«ìáª®¥ ¤®¡ ¢«ïâì §¤¥áì*/

      /* ç¨áâ¨âì ¨â®£¨. */
      macro Clear
         dealid 	= 0;
         PortfID        = 0;
         IsQuoted       = false;
         IssShName      = "";
         AvKindShName   = "";
         AvrName        = "";
         Account        = "";
         FIID           = -1;
         AvAmount       = $0;
         BalCostRUR     = $0;
         BalCostCUR     = $0;
         BuyCostRUR     = $0;
         BuyCost        = $0;
         CostInRUR      = $0;
         CostInCUR      = $0;
         OverAmountRURa  = $0;
         OverAmountRURb  = $0;
         InterestIncomeRUR = $0;
         InterestIncomeCUR = $0;
         DiscountIncomeRUR  = $0;
         DiscountIncomeCUR  = $0;
         ReservAmountRUR   = $0;
         NKD               = $0;
         nkd_RUR           = $0;
         AccOverAmount = "";
         AccDD = "";
         AccPD = "";
         AccReserv = "";
         OutlayRUR = $0;
         AccPDBon = "";
         BonusCUR = $0;
         BonusRUR = $0;
         BonusRestCUR = $0;
         BonusRestRUR = $0;
         AccBon = "";
         AccReserv2732 = "";
         ReservAmount2732 = $0;
      end;

      /* Š®­áâàãªâ®à */
      Clear();
   end;

   /* ®«ãç ¥¬ ªãàá ¡ã¬ £¨ ¢ àã¡«ïå ¨ ¨­ä®à¬ æ¨î ® â®à£®¢®© ¯«®é ¤ª¥.
      €«£®à¨â¬ à ¡®âë: Šãàá ¢¨¤  "XXX" ¢ ¢ «îâ¥ ­®¬¨­ «  §  ¯®á«¥¤­¨©
      à ¡®ç¨© ¤¥­ì, ¯à¥¤è¥áâ¢ãîé¨© ®âç¥â­®© ¤ â¥; ¥á«¨ §  íâã ¤ âã ªãàá ­¥
      ¢¢¥¤¥­, â® ¢ë¢®¤¨âáï ªãàá íâ®£® ¢¨¤  á ­ ¨¡®«ìè¥© ¤ â®©, ­¥
      ¯à¥¢ëè îé¥© ®âç¥â­ãî, ¥á«¨ ‚ - ­¥ àã¡«¨, â® XXX ¯¥à¥áç¨âë¢ ¥âáï ¢
      àã¡. ¯® ªãàáã ­  ¤ âã, ¯à¥¤è¥áâ¢ãîéãî ®âç¥â­®©, ¥á«¨ ­¥â XXX ¢ ‚, â®
      ¡¥à¥âáï XXX ¢ àã¡«ïå, ¥á«¨ XXX ­¨ ¢ ‚, ­¨ ¢ àã¡«ïå ­¥ ­ ©¤¥­ , â®
      ¯®«¥ ­¥ § ¯®«­ï¥âáï.
         RateType    - ¢¨¤ ªãàá 
         PriceStr    - áî¤  § ¯¨è¥¬ æ¥­ã
         MarketPlace - áî¤  § ¯¨è¥¬ ¨­ä®à¬ æ¨î ® ®à£ ­¨§ â®à¥ â®à£®¢«¨
         IsQuoted    - ä« £, ª®â¨àã¥¬ ï ¡ã¬ £  */
   macro GetRateInfo( fininstr, RateType, PriceStr:@string, MarketPlace:@string, IsQuoted )
      var
         FIFrom         = fininstr.FIID,
         FITo           = fininstr.FaceValueFI,
         CnvDate        = Data.RepDate,
         Price          = $0,
         InformUser, MarketPlaceID;

      /* …á«¨ ­¥ª®â¨àã¥¬®© æ/¡ ¨ ªãàá  ¢¨¤  "ë­®ç­ ï æ¥­ ", â® ¢ á«ãç ¥,
         ª®£¤  ªãàá  ­¥â, ¯®«ì§®¢ â¥«ï ­¥ ¨­ä®à¬¨àã¥¬. */
      InformUser = IsQuoted or ((RateType !=  SP_RATETYPE_RightCost) and (RateType !=  SP_RATETYPE_TSS_reqcom));

      InitError();

      if( ConvSum(Price, $1, CnvDate, FIFrom, FITo, RateType) )
         /* ¥ ­ è«¨ ªãàá. ‘¡à áë¢ ¥¬ ®è¨¡ªã ¯®á«¥ ConvSum.
            à®¡ã¥¬ ­ ©â¨ ªãàá ¢ àã¡«ïå. */
         InitError();

         FITo = NATCUR;

         if( ConvSum(Price, $1, CnvDate, FIFrom, FITo, RateType) )
            /* ¥ ­ è«¨ ªãàá. ‘¡à áë¢ ¥¬ ®è¨¡ªã ¯®á«¥ ConvSum.
               ‚ë¤ ¥¬ ¯à¥¤ã¯à¥¦¥¤¥­¨¥ ¯®«ì§®¢ â¥«î. */

            if( InformUser )
               Data.UniqStr.AddString(
                  "„«ï æ¥­­®© ¡ã¬ £¨ \"" + string(fininstr.FI_Code)
                  + "\" ­¥ ã¤ «®áì ¯®«ãç¨âì ªãàá ¢¨¤  \""
                  + GetRateTypeName(RateType) + "\" ­  "
                  + DateToStr( CnvDate, true) );
            end;

            PriceStr       = "";
            MarketPlace    = "";
            PriceStr       = "";
            return false;

         end;
      else
         /*  è«¨ ªãàá ¢ ¢ «îâ¥ ­®¬¨­ « . ¥à¥¢®¤¨¬ áã¬¬ã ¢ àã¡«¨. */
         if( (not SmartConvertSum(Price, Price, CnvDate, FITo, NATCUR)) and InformUser )
            /* ¥ á¬®£«¨ áª®­¢¥àâ¨à®¢ âì. */
            Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(FITo, NATCUR, CnvDate));
         end;
      end;

      /* ®«ãç¨¬ ¤ ­­ë¥ ® â®à£®¢®© ¯«®é ¤ª¥. */
      MarketPlaceID  = GetRateMarketPlace( FITo, FIFrom, RateType );
      MarketPlace    = GetPartyShortNameByID( MarketPlaceID );
      PriceStr       = Data.NumToStr( Price );
      return true;
   end;

   /* ¯à¥¤¥«ï¥¬ ­ã¦¥­ «¨ ¯®¤à §¤¥« ¤«ï ãª § ­­®£® à §¤¥« .*/
   macro IsNeedSubPartition( PortfID )
      return (PortfID == PortfID_Sale);
   end;

   macro IsNeedSubPartitionCateg( PortfID )
      return (PortfID == PortfID_Sale);
   end;

   /* ¥ç âì ¯®¤¢ «  ¯®¤à §¤¥«  */
   macro PrintFoot2( LastCateg, Summary )
		
      if( LastCateg != null )
       Report.merge( "N1_A1", "N1_A10" );
       Report.PrintTableLine( "N1_A1",   Data.CategFootArray[LastCateg],     null,
                              "N1_A11",  Summary.AvAmount, SetPrecisionByFractPart(Summary.AvAmount, Summary.GetAvAmPoint, 0),
                              "N1_A13b", Summary.BalCostRUR,                 null,
                              "N1_A14b", Summary.BuyCostRUR,                  null,
                          //    "N1_A15",  Summary.BuyCostRUR,                 null,
                              "N1_A17b",  Summary.Upl,		              null,
                              "N1_A18a",  Summary.OverAmountRURa,              null,
                              "N1_A18b",  Summary.OverAmountRURb,              null,
                              "N1_A20b", Summary.InterestIncomeRUR,          null,
                              "N1_A22b", Summary.DiscountIncomeRUR,          null,
                              "N1_B24b", Summary.BonusRUR,                   null,
                              "N1_B26b", Summary.BonusRestRUR,               null
         );
      end;
   end;
   /* ¥ç âì ¯®¤¢ «  à §¤¥« . */
   macro PrintFoot1( LastPortfID, LastCateg, PortfSumm, CategSumm )

      /* ¥ç â ¥¬ ¨â®£¨ ¯®¤à §¤¥«  ¯à¨ ­¥®¡å®¤¨¬®áâ¨. */
      if( IsNeedSubPartition(LastPortfID) )
         PrintFoot2( LastCateg, CategSumm );
      end;
     Report.merge( "N1_A1", "N1_A10" );
     Report.PrintTableLine( "N1_A1",   "ˆâ®£® ¯® ¯®àâä¥«î: "+Data.PortfNameArray[LastPortfID],     null,
                            "N1_A11",  PortfSumm.AvAmount, SetPrecisionByFractPart(PortfSumm.AvAmount, PortfSumm.GetAvAmPoint, 0),
                            "N1_A13b", PortfSumm.BalCostRUR,                 null,
                            "N1_A14b", PortfSumm.BuyCostRUR,                  null,
                            "N1_A15",  "",                		      null,
                            "N1_A16",  "",                		      null,
                            "N1_A17a",  "",                		      null,
                            "N1_A17b",  PortfSumm.Upl,         		      null,
                            "N1_A18a",  PortfSumm.OverAmountRURa,              null,
                            "N1_A18b",  PortfSumm.OverAmountRURb,              null,
                            "N1_A19",  "",                		      null,
                            "N1_A20a",  "",                		      null,
                            "N1_A20b", SGS_GetRest("‘ç¥â „", Data.RepDate, LastPortfID),  null,   //PortfSumm.InterestIncomeRUR,          null,
                            "N1_A21",  "",                		      null,
                            "N1_A22a",  "",                		      null,
                            "N1_A22b", SGS_GetRest("‘ç¥â „„", Data.RepDate, LastPortfID),  null,   //PortfSumm.DiscountIncomeRUR,          null,
                            "N1_A23",  "",                		      null,
                            "N1_A26a",  "",                		      null,
                            "N1_B26b", SGS_GetRest("‘ç¥â ¯à¥¬¨¨", Data.RepDate, LastPortfID),  null   //PortfSumm.BonusRestRUR,               null
      );
   end;


   /* ¥ç âì ¨â®£®¢ëå ¤ ­­ëå ¯® ¢á¥© â ¡«¨æ¥. */
   macro PrintFootTable( Summary )

     Report.PrintTableLine( "N1_A1",   "‚‘…ƒ",                            null,
                            "N1_A11",  Summary.AvAmount, SetPrecisionByFractPart(Summary.AvAmount, Summary.GetAvAmPoint , 0),
                            "N1_A13b", Summary.BalCostRUR,                 null,
                            "N1_A14b", Summary.BuyCostRUR,                  null,
                            "N1_A15",  "",                 		   null,
                            "N1_A16",  "",                		   null,
                            "N1_A17a",  "",                		   null,
                            "N1_A17b",  Summary.Upl,           		   null,
                            "N1_A18a",  Summary.OverAmountRURa,              null,
                            "N1_A18b",  Summary.OverAmountRURb,              null,
                            "N1_A19",  "",                		      null,
                            "N1_A20a",  "",                		      null,
                            "N1_A20b", SGS_GetRest("‘ç¥â „", Data.RepDate, 0),  null,   //Summary.InterestIncomeRUR,          null,
                            "N1_A21",  "",                		      null,
                            "N1_A22a",  "",                		      null,
                            "N1_A22b", SGS_GetRest("‘ç¥â „„", Data.RepDate, 0),  null,   //Summary.DiscountIncomeRUR,          null,
                            "N1_A23",  "",                		      null,
                            "N1_A26a",  "",                		      null,
//                            "N1_B24b", Summary.BonusRUR,                   null,
                            "N1_B26b", SGS_GetRest("‘ç¥â ¯à¥¬¨¨", Data.RepDate, 0),  null,   //Summary.BonusRestRUR,               null

                             "N1_C8700",  Total_8700,                      null,
                             "N1_C8704",  Total_8704,                      null,
                             "N1_C8924",  Total_8924,                      null,
                             "N1_C8961",  Total_8961,                      null,
                             "N1_C8972",  Total_8972,                      null,
                             "N1_C8989e", Total_8989e,                      null,
                             "N1_C8989n", Total_8989n,                      null,
                             "N1_C8995",  Total_8995,                      null,
                             "N1_C8998",  Total_8998,                      null,
                             "N1_C9060",  Total_9060,                      null
      );
   end;

   macro MakeFaceValueFI(fininstr:object) /* ®¯à¥¤¥«¥­¨¥ ¢ «îâë ¯ ï 179293*/

      var  à ¬¥âàë ï;
      if(fininstr.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE)
         à ¬¥âàë ï = RSDRecordSet("SELECT t_formvaluefiid FROM davrinvst_dbt WHERE t_fiid = " + fininstr.FIID);
        if( à ¬¥âàë ï.MoveNext())
          fininstr.FaceValueFI =  à ¬¥âàë ï.Value(0);
        end;
      end;

   end;

   /* ”ã­ªæ¨ï-¨â¥à â®à-áã¬¬ â®à ¤«ï ¢à¥¬¥­­®£® ä ©« .
      ‚®§¢à é ¥â ¤ ­­ë¥ ¨§ ¢à¥¬¥­­®£® ä ©«  ç¥à¥§ ª« áá TLineSummary.
      à¨ ­¥®¡å®¤¨¬®áâ¨ áã¬¬¨àã¥¬ ¤ ­­ë¥.
      ”ã­ªæ¨ï ¢®§¢à é ¥â true, ¥á«¨ ¤ ­­ë¥ ¥áâì, false ¢ ¯à®â¨¢­®¬ á«ãç ¥. */
   var IteratorFirstCall   = true;
   var IteratorContinue    = true;
   macro TempFileIterator( LineSumm, DealDate:@Date )

      /* „®¡ ¢¨âì ¤ ­­ë¥ ¢ LineSumm */
      macro AddDataToLineSumm

         macro GetSetBppDate(SumID)

            var Select, pmw;

            Select = RSDCommand(" SELECT t.t_changedate FROM v_scwrthistex t " +
                                " WHERE t.t_SumID = ? " +
                                "   and t.t_instance = (SELECT Min (t_instance) " +
                                "                       FROM v_scwrthistex " +
                                "                      WHERE t_sumid = t.t_sumid " +
                                "                        AND t_action = 50)");

            Select.addParam("", RSDBP_IN, SumID);
            Select.execute();

            pmw = TRsbDataSet(Select);

            if( pmw.MoveNext() )
                return date(pmw.changedate);
            end;

            return date(0,0,0);

         end;

         record acnt_ov_negative(account);
         record acnt_ov_positive(account);
         var Select = "", pmwrtsum;
         var fininstr, dlleg,
            BalCostCUR = $0, BalCostRUR = $0, BuyCostRUR = $0, AvPrice,
            CostInCUR = $0, CostInRUR = $0, DiscountIncomeRUR = $0, DiscountIncomeCUR = $0,
            InterestIncomeCUR = $0, InterestIncomeRUR = $0, NKD = $0, OverAmountRURa = $0, OverAmountRURb = $0, ReservAmountRUR = $0,
            FD, Party, Portfolio, Categ = "", Amount, OutlayRUR = $0,
            FiRole_PD, FiRole_DD, FiRole_OV = NULL, FiRoleBon, FiRolePDD,
            AccOverAmount = "", AccDD = "", AccPD = "", AccReserv = "", AccReserv2732 = "", ReservAmount2732 = $0,
            sum_ov_negative = $0, sum_ov_positive = $0, SetDate,
            BonusRUR = $0, BonusCUR = $0, BonusRestRUR = $0, BonusRestCUR = $0, AccPDBon = "", AccBon = "",
            FIRoleR = null;

         var NKD_RUR = $0, BuyCost = $0; /*¯®«ì§®¢ â¥«ìáª®¥ ¤®¡ ¢«ïâì §¤¥áì*/

         Select = DL_RSDCommand(    " select t.*, "
                                  + "        RSB_FIInstr.FI_AvrKindsGetRoot( fin.t_FI_Kind, fin.t_AvoirKind ) as RootAvoirKind "
                                  + "   from v_scwrthistex t, dfininstr_dbt fin " 
                                  + "  where t.t_DocKind = ? " 
                                  + "    and t.t_DocID = ? " 
                                  + "    and t.t_PartNum = ? " 
                                  + "    and fin.t_FIID = t.t_FIID "
                                  + "    and t.t_instance = (SELECT MAX (t_instance) " 
                                  + "                          FROM v_scwrthistex " 
                                  + "                         WHERE t_sumid = t.t_sumid " 
                                  + "                           AND t_changedate <= ?)"
                               );

         Select.addParam(TempFile.DocKind);
         Select.addParam(TempFile.DocID);
         Select.addParam(TempFile.PartNum);
         Select.addParam(Data.RepDate);

         pmwrtsum = Select.execute();
         pmwrtsum.MoveNext();

         FD = repSPFirstDoc( TempFile.LegKind, TempFile.DealID, pmwrtsum.SumID );
         FD.SetCurPFI(pmwrtsum.FIID);
         DealDate = FD.DateArray[DATE_DEALDATE];

         /*fininstr = FD.fininstr.rec;*/
         var fininstr_ = Trechandler( "fininstr.dbt" );
         if( NOT ®«ãç¨âì”¨­ˆ­( pmwrtsum.FIID, fininstr_ ) )
            fininstr = fininstr_.rec;
            dlleg    = FD.dl_leg.rec;

            Amount = TempFile.LotAmount;

            MakeFaceValueFI(fininstr);

            if (TempFile.PortfID != PortfID_OD_com)  /*¤«ï ¯®àâä¥«¥© +\-„ ª®«®­ª¨ ¯® Š„ ¨ ‡ âà â ¬ ¯ãáâë¥*/

               if(TempFile.PortfID != PortfID_OD_req)
                 if( pmwrtsum.RootAvoirKind == AVOIRISSKIND_BOND )
                  NKD = pmwrtsum.NKDAmount;
                 end;
                 if( TempFile.PortfID != PortfID_Back )
                   OutlayRUR = pmwrtsum.Outlay;
                   if( not SmartConvertSumDbl(OutlayRUR, OutlayRUR, Data.RepDate, dlleg.CFI, NATCUR) )
                      Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(dlleg.CFI, NATCUR, Data.RepDate));
                   end;
                 end;
               end;

               BuyCostRUR = pmwrtsum.Sum;

               if( TempFile.PortfID == PortfID_Unadmitted ) /*¤«ï  ¨é¥¬ ¤ âã ¯®áâ ¢ª¨ */
                  SetDate = GetSetBppDate(pmwrtsum.SumID);
               else
                  SetDate = date(pmwrtsum.Date);
               end;
               /*‘­ ç «  ¯¥à¥áç¨âë¢ ¥âáï ¢ ¢ «îâã ­®¬¨­ «  ¯® ªãàáã ­  ¤ âã ¯®áâ ¢ª¨,   § â¥¬ ã¦¥ ¢ àã¡«¨*/
               if( pmwrtsum.Currency != NATCUR )

                  if( not SmartConvertSumDbl(BuyCostRUR, BuyCostRUR, SetDate, pmwrtsum.Currency, fininstr.FaceValueFI) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg( pmwrtsum.Currency, fininstr.FaceValueFI, SetDate));
                  end;

                  if( fininstr.FaceValueFI != NATCUR )
                     if( not SmartConvertSumDbl(BuyCostRUR, BuyCostRUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                        Data.UniqStr.AddString(GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, Data.RepDate));
                     end;
                  end;
               end;

            else /* +\- „ */

                if(fininstr.FaceValueFI != NATCUR)
                   CostInCUR = pmwrtsum.BalanceCostBD;

                   if( not SmartConvertSumDbl(CostInRUR, CostInCUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                       Data.UniqStr.AddString(GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, Data.RepDate));
                   end;
                else
                    CostInRUR = pmwrtsum.BalanceCostBD;
                end;

                BuyCostRUR = CostInRUR - pmwrtsum.OverAmountBD;
            end;

            if( fininstr.FaceValueFI != NATCUR )
               if( FI_IsBond(fininstr.FIID) )
                  /*„ ¤«ï “ "’", "", "“„" "", "‚"*/
                  /*„„ ¤«ï “ "’", "", "“„" ""*/

                  if( (TempFile.PortfID == PortfID_Trade) or (TempFile.PortfID == PortfID_Sale)
                      or (TempFile.PortfID == PortfID_Retire) or ((TempFile.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio != KINDPORT_CONTR)) or (TempFile.PortfID == PortfID_Back)
                    )
                     InterestIncomeCUR = pmwrtsum.InterestIncome;
                     if( (TempFile.PortfID != PortfID_Back) )
                        DiscountIncomeCUR = pmwrtsum.DiscountIncome;
                     end;
                  end;
                     
                  BonusCUR = pmwrtsum.NotWrtBonus;
                  BonusRestCUR = pmwrtsum.BegBonus-pmwrtsum.Bonus+pmwrtsum.OldBonus+pmwrtsum.NOTWRTBONUS;//MDE 460571

                  if( not SmartConvertSum(InterestIncomeRUR, InterestIncomeCUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
                  end;
                  if( not SmartConvertSum(DiscountIncomeRUR, DiscountIncomeCUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
                  end;
                  if( not SmartConvertSum(BonusRUR, BonusCUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
                  end;
                  if( not SmartConvertSum(BonusRestRUR, BonusRestCUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
                  end;
               end;

               /*®¤ áâ®¨¬®áâìî ¢«®¦¥­¨© ¡ã¤¥¬ ¯®­¨¬ âì:
                 ’, , „, ’/  ¨ â.¤. - ç¨áâ ï áâ®¨¬®áâì (cost) + Š„ (NKDAMOUNT)
                 ‚ - ¯à®é¥ ¢á¥£® â¥ªãéãî áâ®¨¬®áâì  - balancecost
                 ®¤ áâ®¨¬®áâìî ¢ +/-„ - áâ®¨¬®áâì ¢ „ (balancecostbd)
                 ‡ âà âë ¨ Š„ ¢ +/-„ ­¥ ¢ë¢®¤ïâáï (¯® ä ªâã § âà âë ¢ ‚ â®¦¥ 0)*/
               if( (TempFile.PortfID != PortfID_OD_req) and (TempFile.PortfID != PortfID_OD_com) and (TempFile.PortfID != PortfID_Back) )

                  var BalanceCost, Cost;
                  if( (TempFile.PortfID == PortfID_Contr) or
                      ((TempFile.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_CONTR))
                    )
//                     BalCostRUR = pmwrtsum.BalanceCost;
                     CostInRUR  = pmwrtsum.Cost;
                     if( not SmartConvertSum(BalanceCost, BalCostRUR, Data.RepDate, NATCUR, fininstr.FaceValueFI) )
                        Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(NATCUR, fininstr.FaceValueFI, Data.RepDate));
                     end;
                     if( not SmartConvertSum(Cost, CostInRUR, Data.RepDate, NATCUR, fininstr.FaceValueFI) )
                        Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(NATCUR, fininstr.FaceValueFI, Data.RepDate));
                     end;
                  else
                     BalanceCost = pmwrtsum.BalanceCost;
                     Cost = pmwrtsum.Cost;
                  end;

                  BalCostCUR = BalanceCost;
                  CostInCUR = Cost + pmwrtsum.NKDAmount;

               elif( TempFile.PortfID == PortfID_Back )

                  BalCostCUR = pmwrtsum.BalanceCost;
                  CostInCUR  =  pmwrtsum.BalanceCost;

               elif( (TempFile.PortfID == PortfID_OD_req) or (TempFile.PortfID == PortfID_OD_com) )
                  BalCostCUR = pmwrtsum.BalanceCostBD;
                  CostInCUR  = pmwrtsum.BalanceCostBD;
               end;

               if( not((TempFile.PortfID == PortfID_Contr) or
                       ((TempFile.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_CONTR))
                      )
                 )
                  /* ‚ «îâ  ­®¬¨­ «  ­¥ àã¡«¨. */
                  if( not SmartConvertSum(BalCostRUR, BalCostCUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
                  end;

                  if( not SmartConvertSum(CostInRUR, CostInCUR, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
                  end;
               end;

            else

               if( FI_IsBond(fininstr.FIID) )
                  /*„ ¤«ï “ "’", "", "“„" "", "‚"*/
                  /*„„ ¤«ï “ "’", "", "“„" ""*/
                  if( (TempFile.PortfID == PortfID_Trade) or (TempFile.PortfID == PortfID_Sale)
                      or (TempFile.PortfID == PortfID_Retire) or ((TempFile.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio != KINDPORT_CONTR)) or (TempFile.PortfID == PortfID_Back)
                    )
                     InterestIncomeRUR = pmwrtsum.InterestIncome;
                     if( TempFile.PortfID != PortfID_Back )
                        DiscountIncomeRUR = pmwrtsum.DiscountIncome;
                     end;
                  end;

                  BonusRUR = pmwrtsum.NotWrtBonus;
                  BonusRestRUR = pmwrtsum.BegBonus-pmwrtsum.Bonus+pmwrtsum.OldBonus+pmwrtsum.NOTWRTBONUS;//MDE 460571
               end;

               if( (TempFile.PortfID != PortfID_OD_req) and (TempFile.PortfID != PortfID_OD_com) and (TempFile.PortfID != PortfID_Back) )
                  BalCostRUR = pmwrtsum.BalanceCost;
                  CostInRUR = pmwrtsum.Cost + pmwrtsum.NKDAmount;
               elif( TempFile.PortfID == PortfID_Back )
                  BalCostRUR = pmwrtsum.BalanceCost;
                  CostInRUR = pmwrtsum.BalanceCost;
               else
                  BalCostRUR = pmwrtsum.BalanceCostBD;
                  CostInRUR = pmwrtsum.BalanceCostBD;
               end;

            end;

            if( not SmartConvertSumDbl(ReservAmountRUR, pmwrtsum.ReservAmount, Data.RepDate, dlleg.CFI, NATCUR) )
               Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(dlleg.CFI, NATCUR, Data.RepDate));
            end;

            if( (((TempFile.PortfID == PortfID_Sale) or (TempFile.PortfID == PortfID_Unadmitted) or
                  (TempFile.PortfID == PortfID_Back)) and
                  (TempFile.IsQuoted == 1)) OR
                  (TempFile.PortfID == PortfID_Trade)
              )
	      	if (pmwrtsum.OverAmount > 0)
               		OverAmountRURa = pmwrtsum.OverAmount;
               		OverAmountRURb = 0;
	      	else
               		OverAmountRURb = pmwrtsum.OverAmount;
               		OverAmountRURa = 0;
	      	end;
            elif(((TempFile.PortfID == PortfID_OD_req) or (TempFile.PortfID == PortfID_OD_com)) and
                  (TempFile.IsQuoted == 1)
                )
	      	if (pmwrtsum.OverAmountBD > 0)
               		OverAmountRURa = pmwrtsum.OverAmountBD;
               		OverAmountRURb = 0;
	      	else
               		OverAmountRURb = pmwrtsum.OverAmountBD;
               		OverAmountRURa = 0;
	      	end;
            end;

            ReservAmountRUR = DoubleToMoney( ReservAmountRUR );

            /*¯®«ãç¥­¨¥ áç¥â®¢ ¯¥à¥®æ¥­ª¨, „„, „, à¥§¥à¢ */
            if( ((TempFile.PortfID == PortfID_Sale) and
                 (TempFile.IsQuoted == 1)) OR
                 (TempFile.PortfID == PortfID_Trade) OR
                 (TempFile.PortfID == PortfID_Unadmitted)
              )
               if( TempFile.PortfID == PortfID_Unadmitted )
                  FiRole_OV = GetFIRoleByPortfolio(pmwrtsum.Portfolio);
               else
                  FiRole_OV = GetFIRoleByPortfolio(TempFile.PortfID);
               end;

               if((FD.IsExistAccount( "-¥à¥®æ¥­ª , æ/¡", null, true, FiRole_OV, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate )) and
                  ((OverAmountRURa-abs(OverAmountRURb)) < 0))
                  AccOverAmount = acnt_ov_negative.Account;
               elif((FD.IsExistAccount( "+¥à¥®æ¥­ª , æ/¡", null, true, FiRole_OV, acnt_ov_positive, MC_PAIRACCMODE_MANUAL, Data.RepDate )) and
                   ((OverAmountRURa-abs(OverAmountRURb)) > 0))
                  AccOverAmount = acnt_ov_positive.Account;
               end;

            elif( (TempFile.PortfID == PortfID_Back) or (TempFile.PortfID == PortfID_OD_req) or (TempFile.PortfID == PortfID_OD_com) )
               AccOverAmount = "­  ®á­®¢­®¬";
            end;

            if( FI_IsBond(fininstr_.rec.FIID) and
                ((TempFile.PortfID == KINDPORT_TRADE) or (TempFile.PortfID == KINDPORT_SALE) or
                 (TempFile.PortfID == KINDPORT_RETIRE) or (TempFile.PortfID == PortfID_Back) or ((TempFile.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio != KINDPORT_CONTR)))
              )
               if( (TempFile.PortfID == KINDPORT_TRADE) or (TempFile.PortfID == KINDPORT_SALE) or (TempFile.PortfID == KINDPORT_RETIRE) )
                  FiRole_PD = GetFIRoleByPortfolio(TempFile.PortfID,false,true,false);
                  FiRole_DD = GetFIRoleByPortfolio(TempFile.PortfID,true,false,false);
               elif( TempFile.PortfID == PortfID_Unadmitted )
                  FiRole_PD = GetFIRoleByPortfolio(pmwrtsum.Portfolio,false,true,true);
                  FiRole_DD = GetFIRoleByPortfolio(pmwrtsum.Portfolio,true,false,true);
               else
                  FiRole_PD = GetFIRoleByPortfolio(TempFile.PortfID,false,true,false);
               end;

               if(FD.IsExistAccount( " ç¨á«.„„, æ/¡", null, true, FiRole_PD, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
                  AccPD = acnt_ov_negative.Account;
               end;

               if( TempFile.PortfID != PortfID_Back )
                  if(FD.IsExistAccount( " ç¨á«.„„, æ/¡", null, true, FiRole_DD, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
                     AccDD = acnt_ov_negative.Account;
                  end;
               end;

               if( TempFile.PortfID != PortfID_Back )
                  if( TempFile.PortfID == PortfID_Unadmitted )
                     FiRolePDD = GetFIRoleByPortfolio(pmwrtsum.Portfolio, false, false, true, false, true);
                     FiRoleBon = GetFIRoleByPortfolioBonus(pmwrtsum.Portfolio, true);
                  else
                     FiRolePDD = GetFIRoleByPortfolio(TempFile.PortfID, false, false, false, false, true);
                     FiRoleBon = GetFIRoleByPortfolioBonus(TempFile.PortfID);
                  end;

                  if( CheckChargeBonus() )
                     if( FD.IsExistAccount(" ç¨á«.„„, æ/¡", null, true, FiRolePDD, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
                        AccPDBon = acnt_ov_negative.Account;
                     end;

                     if( FD.IsExistAccount("à¥¬¨ï, æ/¡", null, true, FiRoleBon, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
                        AccBon = acnt_ov_negative.Account;
                     end;
                  else
                     if( FD.IsExistAccount("à¥¬¨ï, æ/¡", null, true, FiRoleBon, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate) )
                        AccPDBon = acnt_ov_negative.Account;
                        AccBon   = acnt_ov_negative.Account;
                     end;
                  end;
               end;
            end;

            if( (TempFile.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_SALE) )
               FIRoleR = FIROLE_BA_PPR;
            elif( TempFile.PortfID == PortfID_Sale )
               FIRoleR = FIROLE_BA_PPR_BPP;
            elif( TempFile.PortfID == PortfID_Retire )
               FIRoleR = FIROLE_BA_PUDP;
            elif( TempFile.PortfID == PortfID_Promissory )
               FIRoleR = FIROLE_BAINPROMISSORY;
            elif( (TempFile.PortfID == PortfID_Contr) or
                  ((TempFile.PortfID == PortfID_Unadmitted) and (pmwrtsum.Portfolio == KINDPORT_CONTR))
                )
               FIRoleR = FIROLE_BAINCONTR;
            end;

            if(FD.IsExistAccount( "¥§¥à¢ æ/¡", null, true, FIRoleR, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
               AccReserv = acnt_ov_negative.Account;
            end;

            if(FD.IsExistAccount( "¥§¥à¢ æ/¡", null, true, FIROLE_AVOIR_UC, acnt_ov_negative, MC_PAIRACCMODE_MANUAL, Data.RepDate ))
               AccReserv2732 = acnt_ov_negative.Account;
               ReservAmount2732 = ABS(GetRestAccount( acnt_ov_negative, Data.RepDate ));
            end;

            Portfolio = TempFile.PortfID;
            /*à¬¯*/
            BuyCost = pmwrtsum.sum - pmwrtsum.begbonus;
            if (fininstr.FaceValueFI != NATCUR)
               if( not SmartConvertSum(BuyCostRUR, BuyCost, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
                  Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
               end;
            else
               BuyCostRUR = BuyCost;
               BuyCost = $0;
            end;
             if(pmwrtsum.FIID==38)
                  end;
            /* „®¡ ¢«ï¥¬ ¤ ­­ë¥ ¢ LineSumm. */
            LineSumm.DealID         = TempFile.DealID;
            LineSumm.PortfID        = Portfolio;
            LineSumm.IsQuoted       = TempFile.IsQuoted;
            LineSumm.IssShName      = TempFile.IssShName;
            LineSumm.IssShName      = GetPartyShortNameByID( fininstr.issuer); /*adv ¢ â¥¬¯®¢®¬ ä ©«¥ à §¬¥à 20 á¨¬¢®«®¢, ®¡à¥§ ¥â ­ §¢ ­¨¥, çâ®¡ë ­¥ ¯à ¢¨âì tmp ¨ fmt*/
            LineSumm.AvKindShName   = TempFile.AvKindShName;
            LineSumm.AvrName        = substr(fininstr.Name, 1, 25);
            LineSumm.Account        = TempFile.Account;
            LineSumm.AccOverAmount  = AccOverAmount;
            LineSumm.AccPD          = AccPD;
            LineSumm.AccDD          = AccDD;
            LineSumm.AccReserv      = AccReserv;
            LineSumm.FIID           = TempFile.FIID;
            LineSumm.AvAmount       = LineSumm.AvAmount + Amount;
            LineSumm.BalCostCUR     = LineSumm.BalCostCUR + BalCostCUR;
            LineSumm.BalCostRUR     = LineSumm.BalCostRUR + BalCostRUR;
            LineSumm.BuyCost        = LineSumm.BuyCost + BuyCost;
            LineSumm.BuyCostRUR     = LineSumm.BuyCostRUR + BuyCostRUR;
            LineSumm.CostInCUR      = LineSumm.CostInCUR + CostInCUR;
            LineSumm.CostInRUR      = LineSumm.CostInRUR + CostInRUR;
            LineSumm.OutlayRUR      = LineSumm.OutlayRUR + OutlayRUR;
            LineSumm.OverAmountRURa  = LineSumm.OverAmountRURa + OverAmountRURa;
            LineSumm.OverAmountRURb  = LineSumm.OverAmountRURb + OverAmountRURb;
            LineSumm.InterestIncomeCUR     = LineSumm.InterestIncomeCUR + InterestIncomeCUR;
            LineSumm.InterestIncomeRUR     = LineSumm.InterestIncomeRUR + InterestIncomeRUR;
            LineSumm.DiscountIncomeCUR     = LineSumm.DiscountIncomeCUR + DiscountIncomeCUR;
            LineSumm.DiscountIncomeRUR     = LineSumm.DiscountIncomeRUR + DiscountIncomeRUR;
            LineSumm.ReservAmountRUR       = LineSumm.ReservAmountRUR + ReservAmountRUR;
            LineSumm.NKD                   = LineSumm.NKD + NKD;
            LineSumm.NKD_RUR               = LineSumm.NKD_RUR + NKD_RUR;
            LineSumm.BonusCUR          = LineSumm.BonusCUR + BonusCUR;
            LineSumm.BonusRUR          = LineSumm.BonusRUR + BonusRUR;
            LineSumm.BonusRestCUR      = LineSumm.BonusRestCUR + BonusRestCUR;
            LineSumm.BonusRestRUR      = LineSumm.BonusRestRUR + BonusRestRUR;
            LineSumm.AccPDBon          = AccPDBon;
            LineSumm.AccBon            = AccBon;
            LineSumm.ReservAmount2732  = ReservAmount2732;
            LineSumm.AccReserv2732     = AccReserv2732;
         end;
      end;

      record FirstRec( "repporst.tmp" );
      var    NoSubPart;

      if( IteratorFirstCall )
         /* à¨ ¯¥à¢®¬ ¢ë§®¢¥ ¨â¥à â®à  ¨­¨æ¨ «¨§¨àã¥¬ ¢à¥¬¥­­ë© ä ©«.
            à¨ ¯®¢â®à­®¬ ¢ë§®¢¥ â¥ªãé ï § ¯¨áì ä ©«  ¡ã¤¥â á®¤¥à¦ âì
            ­¥®¡à ¡®â ­­ë¥ ¤ ­­ë¥. */
         InitProgressBar( NRecords(TempFile), StatLine, "‚ë¯ãáª ®âç¥â " );
         Rewind(TempFile);
         ClearRecord(TempFile);
         IteratorContinue  = Next(TempFile);
         IteratorFirstCall = false;
      end;

      /* ç¨é ¥¬ ª« áá åà ­¥­¨ï ¤ ­­ëå ¨ ¯à®¡ã¥¬ ¥£® § ¯®«­¨âì. */
      LineSumm.Clear;
      if( IteratorContinue )

         UseProgressBar;

         /* …áâì ¤ ­­ë¥ ¢® ¢à¥¬¥­­®¬ ä ©«¥.
            ‡ ¯¨è¥¬ ¢ LineSumm ¤ ­­ë¥ ¨§ ®¤­®© áâà®ª¨ ¢à¥¬¥­­®£® ä ©« . */
         Copy( FirstRec, TempFile );
         AddDataToLineSumm;

         /* â¡¥à¥¬ ¢á¥ § ¯¨á¨ ä ©« , ª®â®àë¥ ¤®«¦­ë ¡ëâì ¯à¥¤áâ ¢«¥­ë
            ¢ ¢¨¤¥ ®¤­®© áâà®ª¨ ®âç¥â  ¨ ¯à®áã¬¬¨àã¥¬ ¨å. */
         /* ’‡: ¤«ï “ "’", "", "“„", "Š“", "„" ¢ ®¤­®© áâà®ª¥
            ¢ë¢®¤ïâáï áã¬¬ à­ë¥ ¤ ­­ë¥ ¯® ¢á¥¬ ®â®¡à ­­ë¬ «®â ¬ ®¤­®£®
            ¢ë¯ãáª , ãç¨âë¢ ¥¬ë¬ ¢ ¤ ­­®¬ “, â.¥. ¯® ¢á¥¬
            «®â ¬, ãç¨âë¢ ¥¬ë¬ ­  ®¤­®¬ «¨æ¥¢®¬ áç¥â¥ ª â¥£®à¨¨ " è ¯®àâä¥«ì, æ/¡", */
         IteratorContinue = Next(TempFile);
         if( (TempFile.PortfID == PortfID_Trade)
             or (TempFile.PortfID == PortfID_Sale)
             or (TempFile.PortfID == PortfID_Retire)
             or (TempFile.PortfID == PortfID_Contr)
             or (TempFile.PortfID == PortfID_Promissory)
           )
            NoSubPart = not IsNeedSubPartition(TempFile.PortfID);
            while( IteratorContinue
                   and (FirstRec.PortfID == TempFile.PortfID)
                   and (FirstRec.Account == TempFile.Account)
                   and (FirstRec.FIID == TempFile.FIID)
                   and (NoSubPart or (FirstRec.IsQuoted == TempFile.IsQuoted))
                 )
                 
               UseProgressBar;
               AddDataToLineSumm;
               IteratorContinue = Next(TempFile);
            end;
         end;
         /* ®«ãç¨«¨ ¤ ­­ë¥. */
        
         return true;
      else
         /* ¥ á¬®£«¨ ¯®«ãç¨âì § ¯¨áì. */
         RemProgressBar;
         return false;
      end;
   end;
  var
      fiwarnt = TBFile( "fiwarnts", "R", 1 ),
      fininstr    = TRecHandler( "fininstr" ),
      avoir       = TBFile( "avoiriss" ),
      PrevPortfID = null,
      PrevCateg   = null,
      LineSumm    = TLineSummary(),
      CategSumm   = TSummary(),
      PortfSumm   = TSummary(),
      TotalSumm   = TSummary(),
      CurPortf, CoupDrawDate, BondRetDate, BondFirstDate,
      IncomeRate,
      Categ = "",
      AvDep, AvAmount, AvoirAmountStr, AvoirPerc,
      FaceValCcy, FaceValue, DaysInYear:integer = 0, DaysInCoupon:integer = 0, CurrFaceValue = $0,
      Price_MPrice = "", Place_MPrice = "", DealDate, AmountPoint = 0;
   var point;
	 
	var Data_array = MYARRAY, count :integer = 0;
	
		
		
		
  
   while( TempFileIterator(LineSumm, @DealDate) )
      CurPortf = LineSumm.PortfID;

      /* ¥ç âì § £®«®¢ª®¢ ¨ ¯®¤¢ «®¢
         ******************************************************************/

      /* ¥ç â ¥¬ § £®«®¢®ª ­®¢®£® à §¤¥«  ¨ ¨â®£¨ ¯à¥¤ë¤ãé¥£®. */
      if( PrevPortfID != CurPortf )

         /* à¥¤ë¤ãé¨© à §¤¥«. ¤«ï ª ¦¤®£® á ¯¥à¢®£® ªà®¬¥ ¯®á«¥¤­¥£®*/
         if( PrevPortfID != null )
            //PrintFoot1( PrevPortfID, PrevCateg, PortfSumm, CategSumm );
         end;

         /* ®¢ë© à §¤¥«. */
         //Report.merge( "N1_A1", "N1_A31" );
		// Data_array.insertin(count, null,  Data.PortfNameArray[LineSumm.PortfID], null,null,null,null,null,null , null, null, null,  null,null,null,null,null,null , null, null, null, null , null,null,null,null,null,null , null, null, null, null , null,null,null,null,null,null , null, null, null, null , null,null,null,null,null,null , null, null, null, null, 1);
		// count=count+1;
         //Report.PrintTableLine( "N1_A1", Data.PortfNameArray[LineSumm.PortfID], null );

         PortfSumm.Clear();
         CategSumm.Clear();
         PrevPortfID = CurPortf;
         PrevCateg   = null;
      end;

      /* ¥ç â ¥¬ § £®«®¢®ª ­®¢®£® ¯®¤à §¤¥«  ¨ ¨â®£¨ ¯à¥¤ë¤ãé¥£®. */
      if( IsNeedSubPartition(CurPortf) and (PrevCateg != LineSumm.IsQuoted) )

         /* ¥ç â ¥¬ ¨â®£¨ ¯à¥¤ë¤ãé¥£® ¯®¤à §¤¥« . */
         PrintFoot2( PrevCateg, CategSumm );

         /* ¥ç â ¥¬ § £®«®¢®ª ¯®¤à §¤¥« . */
         //Report.merge( "N1_A1", "N1_A31" );
		// Data_array.insertin(count, null,  Data.CategNameArray[LineSumm.IsQuoted], null,null,null,null,null,null , null, null, null,  null,null,null,null,null,null , null, null, null, null , null,null,null,null,null,null , null, null, null, null , null,null,null,null,null,null , null, null, null, null , null,null,null,null,null,null , null, null, null, null ,1);
		 //count=count+1;
         //Report.PrintTableLine( "N1_A1", Data.CategNameArray[LineSumm.IsQuoted], null );
         CategSumm.Clear();
         PrevCateg = LineSumm.IsQuoted;
      end;

      /* ¥ç âì áâà®ª¨
         ******************************************************************/

      fininstr = GetFinInstr( LineSumm.FIID, true, true );
      avoir.Clear;
      avoir.rec.FIID = LineSumm.FIID;
      if( not avoir.GetEQ() )
         InformUser( "¥ ¬®£ã ¯®«ãç¨âì æ¥­­ãî ¡ã¬ £ã á ª®¤®¬ (FIID = " + string(LineSumm.FIID) + ")", true );
      end;

      MakeFaceValueFI(fininstr);
      /* „ â  ¯®£ è¥­¨ï ªã¯®­ 
         « ­®¢ ï ¤ â  ¯®£ è¥­¨ï ¯®á«¥¤­¥£® ªã¯®­  ¢ë¯ãáª  æ/¡ á¤¥«ª¨,
         ¬ ªá¨¬ «ì­ ï ¨§ ¢á¥å ¤ â ¯®£ è¥­¨ï ªã¯®­®¢ ¤ ­­®£® ¢ë¯ãáª , ­® ­¥
         ¯à¥¢ëè îé ï ®âç¥â­ãî ¤ âã (¢ë¢®¤¨âáï â®«ìª® ¤«ï ®¡«¨£ æ¨©) */
      /* ‚ «îâ  ­®¬¨­ « 
         ãª¢. ª®¤ ¢ «îâë ­®¬¨­ «  */
      FaceValCcy = GetFinInstrCcy( fininstr.FaceValueFI, true );

      /* ®¬¨­ « §  ¥¤.
         ®¬¨­ « æ/¡ ¢ ¢ «îâ¥ ­®¬¨­ «  */
      FaceValue = —¨á«®C‡ ¤ ­­®©’®ç­®áâìî( DoubleToMoney( GetFaceValue(fininstr.FIID, Data.RepDate) ), 4);

      if(( FI_IsBond(fininstr.FIID) ) AND ( FI_IsCouponAvoiriss(fininstr.FIID) ))
         CoupDrawDate = GetCoupon_MaxDrDateOnFrDate(fininstr.FIID, (Data.RepDate + 1));
         if( (CoupDrawDate != ZeroDate) and (CoupDrawDate >= (Data.RepDate + 1)) )
            /*áâ ¢ª  ¤®å®¤  ¯® ªã¯®­ã*/
            fiwarnt.Clear();
            fiwarnt.rec.IsPartial   = UNSET_CHAR;
            fiwarnt.rec.FIID        = fininstr.FIID;
            fiwarnt.rec.DrawingDate = CoupDrawDate;
            if( fiwarnt.GetLE() and
                (fiwarnt.rec.IsPartial == UNSET_CHAR) and
                (fiwarnt.rec.FIID == fininstr.FIID) and
                (fiwarnt.rec.DrawingDate == CoupDrawDate)
              )
               if(fiwarnt.rec.IncomeRate != 0)
                  IncomeRate = fiwarnt.rec.IncomeRate;
               else
                  /*‡ ¯®«­ï¥âáï â®«ìª® ¤«ï ªã¯®­­ëå ®¡«¨£ æ¨© - áâ ¢ª  ¯® ªã¯®­ã, ¤¥©áâ¢ãîé¥¬ã ­  ®âç¥â­ãî ¤ âã.
                    …á«¨ ¤«ï ªã¯®­ , ¤¥©áâ¢ãîé¥£® ­  ®âç¥â­ãî ¤ âã áâ ¢ª   ãª § ­  ¢ á¯à ¢®ç­¨ª¥, â® ¢ë¢®¤¨âáï ¨¬¥­­® ®­ .
                    …á«¨ áâ ¢ª  ­¥ ãª § ­ , â® ¢ëç¨á«ï¥âáï áâ ¢ª  ¯® ªã¯®­ã ¢ % £®¤®¢ëå ¯® ä®à¬ã«¥: 100%*B*C/(N*T),
                    £¤¥ B- ª®«¨ç¥áâ¢® ¤­¥© ¢ £®¤ã, C - áã¬¬  ªã¯®­ , N -áã¬¬  ­®¬¨­ « , ¤¥©áâ¢ãîé¥£® ­  ¤ âã ¯®£ è¥­¨ï ªã¯®­ ,
                    T - ¤«¨â¥«ì­®áâì ªã¯®­ . ‚¥«¨ç¨­ë T ¨ B ¢ëç¨á«ïîâáï ¢ á®®â¢¥âáâ¢¨¨ á ¬¥â®¤®¬, ãª § ­­ë¬ ¢ á¯à ¢®ç­¨ª¥ æ¥­­ëå ¡ã¬ £,
                    ¢ ¯®«¥ " §¨á à áç¥â  Š„". „«¨â¥«ì­®áâì ªã¯®­  = ¤ â  ¯®£ è¥­¨ï ªã¯®­  - ¤ â  ­ ç «  ¤¥©áâ¢¨ï ªã¯®­  + 1*/
                  ®«ãç¨âì à ¬¥âàë §¨á  áç¥â Šã¯®­ (avoir.rec.NKDBase_Kind, fiwarnt.rec, (Data.RepDate + 1), DaysInYear, DaysInCoupon);
                  CurrFaceValue = DoubleToMoney(GetFaceValue(fininstr.FIID,fiwarnt.rec.DrawingDate));
                  IncomeRate = 0.0;
                  if( (CurrFaceValue != $0) and (DaysInCoupon != 0) )
                    IncomeRate = 100.0 * DaysInYear * fiwarnt.rec.IncomeVolume / (CurrFaceValue * DaysInCoupon);
                    IncomeRate = usr_gr12(fininstr.FIID, fiwarnt.rec.drawingdate);
                  end;
                  IncomeRate = —¨á«®C‡ ¤ ­­®©’®ç­®áâìî( DoubleToMoney( IncomeRate), 4);
               end;
            else
               IncomeRate   = "";
            end;
            CoupDrawDate = date_as_string(1, CoupDrawDate);
         else
            CoupDrawDate = "";
            IncomeRate   = "";
         end;
      else
         CoupDrawDate = "";
         IncomeRate   = "";
      end;

      /* „ â  ¯®£ è¥­¨ï ®¡«¨£ æ¨¨
         « ­®¢ ï ¤ â  ¯®£ è¥­¨ï ¢ë¯ãáª  (¢ë¢®¤¨âáï â®«ìª® ¤«ï ®¡«¨£ æ¨©) */
      if( FI_IsBond(fininstr.FIID) )
         BondRetDate = date_as_string(1, fininstr.DrawingDate);
         BondFirstDate = date_as_string(1, fininstr.Issued);
      else
         BondRetDate = "";
         BondFirstDate = "";
      end;

      /* Š®«-¢® èâ.
         .  Š®«¨ç¥áâ¢® æ/¡ á¤¥«ª¨
         .¡ …á«¨ ¢¨¤ æ/¡ = ¤¥¯®§¨â à­ ï à á¯¨áª , â® ¢ë¢®¤¨âáï á¨¬¢®«
         "/" ¨ ª®«¨ç¥áâ¢® æ/¡ ¢ ®¤­®© ¤¥¯®§. à á¯¨áª¥ (®¯à¥¤¥«ï¥âáï ¨§
         ¯à¨¬¥ç ­¨ï ¢¨¤  "Š®«¨ç¥áâ¢® æ/¡ ¢ ¤¥¯.à á¯¨áª¥" ª  ¤ ­­®© æ¥­­®©
         ¡ã¬ £¥ ¢ á¯à ¢®ç­¨ª¥), ¨­ ç¥ - ¯®«¥ ­¥ § ¯®«­ï¥âáï */
      AvAmount    = LineSumm.AvAmount;
      AmountPoint = 0;
      /*Š®«¨ç¥áâ¢® ¯ ñ¢ ¢ë¢®¤¨âáï á â®ç­®áâìî, ãª § ­­®© ¢  ­ª¥â¥ ¯ ï!*/
      if( fininstr.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE )
         AmountPoint = fininstr.SumPrecision;
         AvoirAmountStr = Data.NumToStr( AvAmount, AmountPoint );
      else
         AmountPoint = fininstr.SumPrecision;
         AvoirAmountStr = Data.NumToStr( AvAmount, AmountPoint );
      end;

      if( FI_IsDeposReceipt(fininstr.FIID) )
         AvDep = avoir.rec.NumBaseFI;
         AvoirAmountStr = AvoirAmountStr + "/" + IIF( AvDep==null, "", AvDep );
      end;

      /* % ®â ®¡ê¥¬  í¬¨áá¨¨
         = <A10> * 100 / (®¡ê¥¬ ¢ë¯ãáª  æ/¡ ­  ¤ âã § ª«îç¥­¨ï á¤¥«ª¨) */
      if( IsAvoirQtyExist(avoir.rec, /*DealDate*/Data.RepDate) )  //VLV
         AvoirPerc = MoneyToDouble( AvAmount ) * 100 / GetAvoirQty( avoir.rec, /*DealDate*/Data.RepDate ); //VLV
      else
         AvoirPerc = 0.0;
         Data.UniqStr.AddString( "„«ï æ¥­­®© ¡ã¬ £¨ \"" + string(fininstr.FI_Code) + "\" ­¥ § ¤ ­ ®¡ê¥¬ ¢ë¯ãáª " );
      end;

      /* - ˆáâ®ç­¨ª ª®â¨à®¢ª¨ "àë­.æ¥­ " */
      /* - Šãàá ¢¨¤  <’‘‘>  - íâ® ¤«ï ¢á¥å ®áâ «ì­ëå, ¥á«¨ ®­  ¥áâì,   <’‘‘> - ¤«ï ¯®àâä¥«ï ¯à®¤ ­­ëå ¨§ ‚ ( -„ ) */
      if( CurPortf == PortfID_OD_com ) /* -„ */
         GetRateInfo(   fininstr, SP_RATETYPE_TSS_reqcom, @Price_MPrice,
                     @Place_MPrice, LineSumm.IsQuoted );
      else
         GetRateInfo(   fininstr, SP_RATETYPE_RightCost, @Price_MPrice,
                     @Place_MPrice, LineSumm.IsQuoted );
      end;

      /*adv ‚¬¥áâ® 29-© ª®«®­ª¨ ­ ¯à¨¬¥à (ˆáâ®ç­¨ª ª®â¨à®¢ª¨ "àë­. æ¥­ ") ­ ¤® ¢áâ ¢¨âì ªãàá ¤®«« à  §  ¤ âã. */
      if (fininstr.FaceValueFI != NATCUR)
         if( not SmartConvertSumDbl(Place_MPrice, 1, Data.RepDate, fininstr.FaceValueFI, NATCUR) )
            Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, Data.RepDate));
         end;
      end;

		
      /*ª â¥£®à¨ï ª ç¥áâ¢ */
      Categ = ®«ãç¨âìŠ â¥£®à¨îŠ ç¥áâ¢ (avoir, Data.RepDate);
       /* ¥ç âì áâà®ª¨ á ¤ ­­ë¬¨ */
      point =  SGS_point(fininstr.fiid, Data.RepDate);
	
		Data_array.insertin
		(  count,
		usr_gr34(LineSumm.Account), 
		LineSumm.IssShName,    
        LineSumm.AvrName,         
        usr_gr4(avoir.rec.fiid),                    
        avoir.rec.LSIN,                                
        avoir.rec.ISIN,                                
        CoupDrawDate,                      
        BondFirstDate,                                     
        BondRetDate,                
        FaceValCcy,                             
        Data.NumToStr(FaceValue),                         
        AvoirAmountStr,      
        —¨á«®C‡ ¤ ­­®©’®ç­®áâìî(round(IncomeRate,point), point):15, 
		Data.NumToStr(LineSumm.BuyCostRUR + LineSumm.OutlayRUR + (LineSumm.OverAmountRURa-abs(LineSumm.OverAmountRURb)) + LineSumm.InterestIncomeRUR + LineSumm.DiscountIncomeRUR + LineSumm.BonusRestRUR + LineSumm.NKD_RUR) , 
        Data.NumToStr(LineSumm.BuyCost, null, true), 
        Data.NumToStr(LineSumm.BuyCostRUR, null, true),        
        Data.NumToStr(LineSumm.Account),                      
        Data.NumToStr(LineSumm.OutlayRUR, null, true),       
        Data.NumToStr(LineSumm.NKD, null, true),              
        Data.NumToStr(round(LineSumm.NKD_RUR,2), null, true),          
        Data.NumToStr(LineSumm.OverAmountRURa, null, true),    
        Data.NumToStr(LineSumm.OverAmountRURb, null, true),     
        LineSumm.AccOverAmount,                               
        Data.NumToStr(LineSumm.InterestIncomeCUR, null, true),
        Data.NumToStr(LineSumm.InterestIncomeRUR, null, true),
        LineSumm.AccPD,                                        
        Data.NumToStr(LineSumm.DiscountIncomeCUR, null, true),
        Data.NumToStr(LineSumm.DiscountIncomeRUR, null, true), 
        LineSumm.AccDD,                                        
        Data.NumToStr(LineSumm.BonusRestCUR, null, true),      
        Data.NumToStr(LineSumm.BonusRestRUR, null, true),      
        LineSumm.AccBon,                                      
        Place_MPrice,                                          
        Categ,                                                 
        usr_gr32(avoir.rec.fiid,Categ),                        
        usr_gr33(avoir.rec.fiid),                            
		usr_gr35(avoir.rec.fiid),                            
        string(A_36(CurPortf, LineSumm.dealid, avoir.rec.fiid)),      
        string(A_37(CurPortf, LineSumm.dealid, avoir.rec.fiid)),     
        _GetCountryCodeNum3(FININSTR.Issuer),                     
        string(A_38(avoir.rec.fiid)),                    
        C_8700(LineSumm),                    
        C_8704(LineSumm),                     
        C_8924(LineSumm),                     
        C_8961(LineSumm),                      
        C_8972(LineSumm),                     
        C_8989e(LineSumm, avoir),                 
        C_8989n(LineSumm),                    
        C_8995(LineSumm),                   
        C_8998(LineSumm),                    
        C_9060(LineSumm),                  
       0 );
     /* Report.PrintTableLine( "N1_A30",  usr_gr34(LineSumm.Account),                            null,
                             "N1_A1",   LineSumm.IssShName,                                    null,
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A2",   Data.NumToStr(LineSumm.Account),                       null,
                             "N1_A3",   LineSumm.AvrName,                                      null,
                             //"N1_A4",   LineSumm.AvKindShName,                                 null,
                             "N1_A4",   usr_gr4(avoir.rec.fiid),                               null,
                             "N1_A5",   avoir.rec.LSIN,                                        null,
                             "N1_A6",   avoir.rec.ISIN,                                        null,
                             "N1_A7",   CoupDrawDate,                                          null,
                             "N1_A7_1", BondFirstDate,                                         null,
                             "N1_A8",   BondRetDate,                                           null,
                             "N1_A9",   FaceValCcy,                                            null,
                             "N1_A10",  Data.NumToStr(FaceValue),                              null,
                             "N1_A11",  AvoirAmountStr,                                        SetPrecisionByFractPart(AvoirAmountStr, AmountPoint, 0),
                             "N1_A12",  —¨á«®C‡ ¤ ­­®©’®ç­®áâìî(round(IncomeRate,point), point):15,  null,
//                             "N1_A12",  IncomeRate,                                            int(SGS_point(fininstr.fiid, Data.RepDate)),
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A13a", Data.NumToStr(LineSumm.BalCostCUR, null, true),        null,
                             "N1_A13b", Data.NumToStr(LineSumm.BuyCostRUR + LineSumm.OutlayRUR + (LineSumm.OverAmountRURa-abs(LineSumm.OverAmountRURb)) + LineSumm.InterestIncomeRUR + LineSumm.DiscountIncomeRUR + LineSumm.BonusRestRUR + LineSumm.NKD_RUR) ,                                   null,
                             /*
                             "N1_A14a", Data.NumToStr(LineSumm.CostInCUR, null, true),         null,
                             "N1_A14b", LineSumm.CostInRUR,                                    null,
                             "N1_A15",  LineSumm.BuyCostRUR,                                   null,
                             */
                             "N1_A14a", Data.NumToStr(LineSumm.BuyCost, null, true),           null,
                             "N1_A14b", Data.NumToStr(LineSumm.BuyCostRUR, null, true),        null,
                             "N1_A15",  Data.NumToStr(LineSumm.Account),                       null,
                             "N1_A16",  Data.NumToStr(LineSumm.OutlayRUR, null, true),         null,
                             "N1_A17a", Data.NumToStr(LineSumm.NKD, null, true),               null,
                             "N1_A17b", Data.NumToStr(round(LineSumm.NKD_RUR,2), null, true),           null,
                             "N1_A18a",  Data.NumToStr(LineSumm.OverAmountRURa, null, true),     null,
                             "N1_A18b",  Data.NumToStr(LineSumm.OverAmountRURb, null, true),     null,
                             "N1_A19",  LineSumm.AccOverAmount,                                null,
                             "N1_A20a", Data.NumToStr(LineSumm.InterestIncomeCUR, null, true), null,
                             "N1_A20b", Data.NumToStr(LineSumm.InterestIncomeRUR, null, true), null,
                             "N1_A21",  LineSumm.AccPD,                                        null,
                             "N1_A22a", Data.NumToStr(LineSumm.DiscountIncomeCUR, null, true), null,
                             "N1_A22b", Data.NumToStr(LineSumm.DiscountIncomeRUR, null, true), null,
                             "N1_A23",  LineSumm.AccDD,                                        null,
                             /* ã¤ «¥­ë ¢ è ¡«®­¥
                             "N1_B24a", Data.NumToStr(LineSumm.BonusCUR, null, true),          null,
                             "N1_B24b", Data.NumToStr(LineSumm.BonusRUR, null, true),          null,
                             "N1_B25",  LineSumm.AccPDBon,                                     null,
                             */
                             "N1_B26a", Data.NumToStr(LineSumm.BonusRestCUR, null, true),      null,
                             "N1_B26b", Data.NumToStr(LineSumm.BonusRestRUR, null, true),      null,
                             "N1_B27",  LineSumm.AccBon,                                       null,
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A24",  Data.NumToStr(AvoirPerc, 2, true),                     null,
                             "N1_A25",  Place_MPrice,                                          null,
                             //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A26",  Price_MPrice,                                          null,
                             "N1_A27",  Categ,                                                 null,
                             "N1_A28",  usr_gr32(avoir.rec.fiid,Categ),                        null,
                             "N1_A29",  usr_gr33(avoir.rec.fiid),                              null,

                             "N1_A31",  usr_gr35(avoir.rec.fiid),                              null,
                             "N1_A32",  string(A_36(CurPortf, LineSumm.dealid, avoir.rec.fiid)),       null,
                             "N1_A33",  string(A_37(CurPortf, LineSumm.dealid, avoir.rec.fiid)),       null,
                             "N1_A40",  _GetCountryCodeNum3(FININSTR.Issuer),                       null,
                             "N1_A34",  string(A_38(avoir.rec.fiid)),                      null,
                             "N1_C8700",  C_8700(LineSumm),                      null,
                             "N1_C8704",  C_8704(LineSumm),                      null,
                             "N1_C8924",  C_8924(LineSumm),                      null,
                             "N1_C8961",  C_8961(LineSumm),                      null,
                             "N1_C8972",  C_8972(LineSumm),                      null,
                             "N1_C8989e", C_8989e(LineSumm, avoir),                      null,
                             "N1_C8989n", C_8989n(LineSumm),                      null,
                             "N1_C8995",  C_8995(LineSumm),                      null,
                             "N1_C8998",  C_8998(LineSumm),                      null,
                             "N1_C9060",  C_9060(LineSumm),                      null
       ); */
	count = count+1;
/* ‘®¡¨à ¥¬ ¢®«è¥¡­ãî áâ â¨áâ¨ªã ¯® áç¥â ¬. SGS */
	SGS_AddAcc("‘ç¥â „", LineSumm.AccPD, CurPortf, 0);
	SGS_AddAcc("‘ç¥â „„", LineSumm.AccDD, CurPortf, 0);
	SGS_AddAcc("‘ç¥â ¯à¥¬¨¨", LineSumm.AccBon, CurPortf, 0);



      /* ‘®¡¨à ¥¬ áâ â¨áâ¨ªã. */
      CategSumm.AddData( AvAmount, LineSumm.BuyCostRUR + LineSumm.OutlayRUR + (LineSumm.OverAmountRURa-abs(LineSumm.OverAmountRURb)) + LineSumm.InterestIncomeRUR + LineSumm.DiscountIncomeRUR + LineSumm.BonusRestRUR + LineSumm.NKD_RUR, LineSumm.BuyCostRUR, LineSumm.CostInRUR,
                         LineSumm.OverAmountRURa, LineSumm.OverAmountRURb, LineSumm.InterestIncomeRUR, LineSumm.DiscountIncomeRUR, LineSumm.BonusRUR, LineSumm.BonusRestRUR, AmountPoint, round(LineSumm.NKD_RUR,2));
      PortfSumm.AddData( AvAmount, LineSumm.BuyCostRUR + LineSumm.OutlayRUR + (LineSumm.OverAmountRURa-abs(LineSumm.OverAmountRURb)) + LineSumm.InterestIncomeRUR + LineSumm.DiscountIncomeRUR + LineSumm.BonusRestRUR + LineSumm.NKD_RUR, LineSumm.BuyCostRUR, LineSumm.CostInRUR,
                         LineSumm.OverAmountRURa, LineSumm.OverAmountRURb, LineSumm.InterestIncomeRUR, LineSumm.DiscountIncomeRUR, LineSumm.BonusRUR, LineSumm.BonusRestRUR, AmountPoint, round(LineSumm.NKD_RUR,2));
      TotalSumm.AddData( AvAmount, LineSumm.BuyCostRUR + LineSumm.OutlayRUR + (LineSumm.OverAmountRURa-abs(LineSumm.OverAmountRURb)) + LineSumm.InterestIncomeRUR + LineSumm.DiscountIncomeRUR + LineSumm.BonusRestRUR + LineSumm.NKD_RUR, LineSumm.BuyCostRUR, LineSumm.CostInRUR,
                         LineSumm.OverAmountRURa, LineSumm.OverAmountRURb, LineSumm.InterestIncomeRUR, LineSumm.DiscountIncomeRUR, LineSumm.BonusRUR, LineSumm.BonusRestRUR, AmountPoint, round(LineSumm.NKD_RUR,2));
   end;
	 /* ¥ç âì ¯®á«¥¤­¥© áâà®ª¨, ¨â®£® à §¤¥«  ¨ ¤ ­­ëå ¯® ¢á¥© â ¡«¨æ¥. */
   
   PrintFootTable( TotalSumm );
   
   
	 if( PrevPortfID != null )
      //PrintFoot1( PrevPortfID, PrevCateg, PortfSumm, CategSumm );
   end;
	Data_array.printline(count, AvoirAmountStr, AmountPoint);
   
   RemProgressBar;
end;

PRIVATE CLASS (DL_CReportTemplate) SP_Portf_SS_Report
  PRIVATE MACRO PrintMode():INTEGER
    if(Excel)
      return DL_OUTREPORT_EXCEL;
    else
      return DL_OUTREPORT_STD;
    end;
  END;

  PRIVATE MACRO BeginReport()
     Dl_CallInsertStat(PrintMode());
     CreateTotalBook();
     SetActiveSheet( "1" );
  END;

  PRIVATE MACRO PrintHead(Data,Department:Integer)

   PrintFormatString( Cap,
                      "N1_H0", date_as_string(1, Data.RepDate + 1) +"  ”¨«¨ «: " + string(Department)
                    );
   CopyAllSheetInTotalBook( NULL, false, "N1_Cap", 0 );
   CopyAllSheetInTotalBook( NULL, false, "N1_TableHead", 1 );

   RegisterTable( "N1_TableLine", TableHeader,
                  "N1_A30",
                  "N1_A1",
                  //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A2",
                  "N1_A3",
                  "N1_A4",
                  "N1_A5",
                  "N1_A6",
                  "N1_A7",
                  "N1_A7_1",
                  "N1_A8",
                  "N1_A9",
                  "N1_A10",
                  "N1_A11",
                  "N1_A12",
                  //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A13a",
                  "N1_A13b",
                  "N1_A14a",
                  "N1_A14b",
                  "N1_A15",
                  "N1_A16",
                  "N1_A17a", /*à¬¯*/
                  "N1_A17b", /*à¬¯*/
                  "N1_A18a",
                  "N1_A18b",
                  "N1_A19",
                  "N1_A20a",
                  "N1_A20b",
                  "N1_A21",
                  "N1_A22a",
                  "N1_A22b",
                  "N1_A23",
                  /*ã¤ «¥­ë ¢ è ¡«®­¥
                  "N1_B24a",
                  "N1_B24b",
                  "N1_B25",
                  */
                  "N1_B26a",
                  "N1_B26b",
                  "N1_B27",
                  //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A24",
                  "N1_A25",
                  //ã¤ «¥­  ¢ è ¡«®­¥ "N1_A26",
                  "N1_A27",
                  "N1_A28",
                  "N1_A29",
                  "N1_A31",
                  "N1_A32",
                  "N1_A33",
                  "N1_A40",  /*¤®¡ ¢«¥­® ¯® § ï¢ª¥ ¡ ­ª */
                  "N1_A34",

                  "N1_C8700",
                  "N1_C8704",
                  "N1_C8924",
                  "N1_C8961",
                  "N1_C8972",
                  "N1_C8989e",
                  "N1_C8989n",
                  "N1_C8995",
                  "N1_C8998",
                  "N1_C9060"
               );
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO CreateDepartment( Department:integer )

   file TempFile( "repporst.tmp" ) write;

   if(   Data.PortfTrade or Data.PortfSale or Data.PortfRetire or Data.PortfUnadmitted
         or Data.PortfBack or Data.PortfOD_com or Data.PortfOD_req or Data.PortfContr or Data.PortfPromissory
         or Data.PortfBack_KSU or Data.PortfBack_BPP_KSU)

      /* ˆ¬¥¥â á¬ëá« ¢ë¯ãáª âì ®âç¥â. */

      ClearGlobalTmp( "drepporst_tmp" );

      CollectData( Data, TempFile, Department );
      if( Data.WasCollectedData AND Data.WasExistsDepData )
         PrintHead( Data,Department );
         PrintData( Data,TempFile );
         EndTable();
         CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
      end;
   end;
  END;

  PRIVATE MACRO Create()
   var Dep = Data.DprtNum;
   var Department, query, NumDep = 0;

   if(Data.DprtNum != -1)
    CreateDepartment( Dep );
   else
        query = " SELECT t_Code"
              + " FROM  ddp_dep_dbt";
        Department = TRsbDataSet( query );
        while( Department.MoveNext() )
           Dep = Department.Code;
           CreateDepartment(Dep);
        end;
   end;
   /* ¥ç âì ¯®¤¢ «  â ¡«¨æë */
   if( Data.WasCollectedData )
     AddStandardFooter( "N1_" );
     CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );
   else
     PrintFormatString( ReportRunFalse, "N1_N1_ReportRunFalse", "¥â ¤ ­­ëå, ã¤®¢«¥â¢®àïîé¨å ¯ à ¬¥âà ¬ ®âç¥â " );
     CopyAllSheetInTotalBook( NULL, false, "N1_N1_ReportRunFalse", 1 );
   end;

   /* ¥ç âì ¯à®â®ª®«  */
   var i:integer = 0;
   while( i < Data.UniqStr.Size )
     msgbox( Data.UniqStr.(i) );
     i = i + 1;
   end;
  END;
  initDL_CReportTemplate( NULL, "Repport_ss_port_mas.xls" );
END;

/***************************************************************************
   à®æ¥¤ãà , ¢ë§ë¢ ¥¬ ï ¯à¨ § ¯ãáª¥ ®âç¥â 
****************************************************************************/

macro ReportRun(  DprtNum          : integer, /* ”¨«¨ « */
                  RepDate          : date,    /* âç¥â­ ï ¤ â  */
                  PortfTrade       : bool,  /* ’ */
                  PortfSale        : bool,  /*  */
                  PortfRetire      : bool,  /* “„ */
                  PortfUnadmitted  : bool,  /*  */
                  PortfBack        : bool,  /* ‚ */
                  PortfODcom       : bool,  /* -„*/
                  PortfODreq       : bool,  /* +„*/
                  PortfContr       : bool,  /* Š“ */
                  PortfPromissory  : bool,  /* „ */
                  PortfBack_KSU    : bool,  /* ‚_Š‘“*/
                  PortfBack_BPP_KSU: bool,  /* ‚__Š‘“*/
                  Apostr           : bool,  /* ‘  ¯®áâà®ä ¬¨ */
                  ToExcel          : bool   /* ‚ Excel */
                  )
   Excel  = ToExcel;
   SGS_Clear();
   Data   = ReportData(DprtNum, RepDate, PortfTrade, PortfSale, PortfRetire, PortfUnadmitted, PortfBack, PortfODcom, PortfODreq, PortfContr, PortfPromissory, PortfBack_KSU, PortfBack_BPP_KSU, false/*Apostr*/);
   Report = SP_Portf_SS_Report();
   Report.Run();

   exit(1);
end;

