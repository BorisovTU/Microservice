/* SecurRedemptionsUI.mac

  Интерфейс полученных корпоративных действий по погашениям ценных бумаг
*/
import "ScrollHelperClass.mac", oralib, "KeyCodes.mac", likepy;
import "SecurRedemptionService.mac";

private class scroll_status_link_hist
    private const SCROLL_NAME = "История изменения статусов";
    private const STATUS_BAR = "ESC - Выход";
    private const X = 30;
    private const Y = 5;
    private const width = 70;
    private const height = 30;

    private var scrollHelper = ScrollHelperClass();

    private macro GetQuery()
        var query = ""
                 + "select os.name old_name, "
                 + "       ns.name new_name, "
                 + "       to_char(h.update_time, 'dd.mm.yyyy hh24:mi:ss.ff3') change_time "
                 + "  from secur_red_lnk_status_hist h "
                 + "  left join secur_redemption_link_statuses os on os.status_id = h.old_status "
                 + "  join secur_redemption_link_statuses ns on ns.status_id = h.new_status "
                 + "where link_id = :1 "
                 + "order by update_time desc ";
        return query;
    end;

    private macro GetColumns():TArray
        var columnsArray = TArray();

        scrollHelper.AddColumn(columnsArray, "old_name",    "Предыдущий статус", 20);
        scrollHelper.AddColumn(columnsArray, "new_name",    "Новый статус", 20);
        scrollHelper.AddColumn(columnsArray, "change_time", "Время изменения", 13);

        return columnsArray;
    end;

    macro Run(linkId:integer)
        var query = GetQuery();
        var columns = GetColumns();
        var params = MakeSqlParamsArray(linkId);
        var sqlRecordSet = scrollHelper.getRecordSet(query, params);

        while (RunScroll(sqlRecordSet,
                        columns.size()/6,
                        columns,
                        "scroll_status_link_hist",
                        null,
                        SCROLL_NAME,
                        STATUS_BAR,
                        true, //???
                        x,
                        Y,
                        width,
                        height)
            )
            sqlRecordSet = scrollHelper.getRecordSet(query, params);
        end;
    end;
end;

private class c_scroll_redemption_details
    private const SCROLL_NAME = "Распределённые суммы погашений";
    private const STATUS_BAR = "ESC - Выход  ctrl+H - история изменения статусов";
    private const X = 10;
    private const Y = 5;
    private const width = 150;
    private const height = 30;

    private var scrollStatusHist:scroll_status_link_hist = scroll_status_link_hist();
    private var scrollHelper = ScrollHelperClass();

    macro ScrollHandler(rs, cmd, id, key)
        var keys = KeyCodes;

        if (cmd == DLG_KEY)
            if (key == keys.CTRL_H)
                scrollStatusHist.Run(rs.value("link_id"));
            end;
        end;

        return CM_DEFAULT;
    end;

    private macro GetQuery():string
        var query = "select sf.t_number sfnumber, "
                  + "       l.t_id, "
                  + "       l.t_amount, "
                  + "       l.t_totalamount, "
                  + "       l.t_incomeamount nkd, "
                  + "       l.t_nominalamount, "
                  + "       l.t_payamount, "
                  + "       l.t_calctax, "
                  + "       t.t_dealcode, "
                  + "       alg.t_sznamealg oper_status, "
                  + "       l.t_id link_id, "
                  + "       ls.description status_descr, "
                  + "       case when rl.is_limit_locked = 1 then 'X' else chr(0) end is_limit_locked, "
                  + "       rl.diasoft_rest "
                  + "  from ddl_tklnk_dbt l "
                  + "  join dsfcontr_dbt sf on sf.t_id = l.t_clientcontrid "
                  + "  left join ddl_tick_dbt t on t.t_dealid = l.t_childid "
                  + "  left join dnamealg_dbt alg on alg.t_itypealg = 3155 "
                  + "                            and alg.t_inumberalg = t.t_dealstatus "
                  + "  left join secur_redemption_link rl on rl.link_id = l.t_id"
                  + "  left join secur_redemption_link_statuses ls on ls.status_id = rl.status_id "
                  + " where l.t_parentid = :dealId "
                  + "   and l.t_type = 1 ";
        
        return query;
    end;

    private macro GetColumns():TArray
        var columnsArray = TArray();

        scrollHelper.AddColumn(columnsArray, "sfnumber",        "Номер договора", 13);
        scrollHelper.AddColumn(columnsArray, "t_totalamount",   "Количество ц/б", 13);
        scrollHelper.AddColumn(columnsArray, "t_amount",        "Распр: Количество ц/б", 13);
        scrollHelper.AddColumn(columnsArray, "nkd",             "Распр: Куп. доход", 13);
        scrollHelper.AddColumn(columnsArray, "t_nominalamount", "Распр: Номинал", 13);
        scrollHelper.AddColumn(columnsArray, "t_payamount",     "Распр: Сумма", 13);
        scrollHelper.AddColumn(columnsArray, "t_dealcode",      "Код операции погашения", 13);
        scrollHelper.AddColumn(columnsArray, "oper_status",     "Статус операции", 13);
        scrollHelper.AddColumn(columnsArray, "t_calctax",       "Считать налоги", 13);
        scrollHelper.AddColumn(columnsArray, "status_descr",    "Статус", 17);
        scrollHelper.AddColumn(columnsArray, "is_limit_locked", "Блок лимитов", 12);
        scrollHelper.AddColumn(columnsArray, "diasoft_rest",    "Диасофт остатки", 17);
        scrollHelper.AddColumn(columnsArray, "t_id",            "ид", 5);

        return columnsArray;
    end;

    private macro getRecordSet(query:string, params:TArray)
        var sql = ExecSqlSelect(query, params, true, RSDVAL_CLIENT, RSDVAl_STATIC);
        sql.UpdateCommand = RsdCommand("select 1 from dual");

        return sql;
    end;

    macro Run(dealId:integer)
        var query = GetQuery();
        var params = MakeSqlParamsArray(dealId);
        var columns = GetColumns();
        var sqlRecordSet = getRecordSet(query, params);

        while (RunScroll(sqlRecordSet,
                        columns.size()/6,
                        columns,
                        "secur_redemption_details_ui",
                        R2M(this,"ScrollHandler"),
                        SCROLL_NAME,
                        STATUS_BAR,
                        true, //???
                        x,
                        Y,
                        width,
                        height
                        )
            )
            sqlRecordSet = getRecordSet(query, params);
        end;
    end;
    
end;

private class scroll_status_hist
    private const SCROLL_NAME = "История изменения статусов";
    private const STATUS_BAR = "ESC - Выход";
    private const X = 30;
    private const Y = 5;
    private const width = 70;
    private const height = 30;

    private var scrollHelper = ScrollHelperClass();

    private macro GetQuery()
        var query = ""
                 + "select os.name old_name, "
                 + "       ns.name new_name, "
                 + "       to_char(h.update_time, 'dd.mm.yyyy hh24:mi:ss.ff3') change_time "
                 + "  from secur_redemption_status_hist h "
                 + "  left join secur_redemption_statuses os on os.status_id = h.old_status "
                 + "  join secur_redemption_statuses ns on ns.status_id = h.new_status "
                 + "where redemption_id = :1 "
                 + "order by update_time desc ";
        return query;
    end;

    private macro GetColumns():TArray
        var columnsArray = TArray();

        scrollHelper.AddColumn(columnsArray, "old_name",    "Предыдущий статус", 20);
        scrollHelper.AddColumn(columnsArray, "new_name",    "Новый статус", 20);
        scrollHelper.AddColumn(columnsArray, "change_time", "Время изменения", 13);

        return columnsArray;
    end;

    macro Run(redemptionId:integer)
        var query = GetQuery();
        var columns = GetColumns();
        var params = MakeSqlParamsArray(redemptionId);
        var sqlRecordSet = scrollHelper.getRecordSet(query, params);

        while (RunScroll(sqlRecordSet,
                        columns.size()/6,
                        columns,
                        "secur_redemptions_status_hist",
                        null,
                        SCROLL_NAME,
                        STATUS_BAR,
                        true, //???
                        x,
                        Y,
                        width,
                        height)
            )
            sqlRecordSet = scrollHelper.getRecordSet(query, params);
        end;
    end;
end;

private class c_scroll_redemptions
    private const SCROLL_NAME = "КД по погашениям ценных бумаг";
    private const STATUS_BAR = "ESC - Выход  ctrl+R - Обновить  F6 - Детализация  ctrl+F2 - запустить обработку ctrl+H - история изменения статусов";

    private var detailsScroll:c_scroll_redemption_details = c_scroll_redemption_details();
    private var scrollStatusHist:scroll_status_hist = scroll_status_hist();
    private var scrollHelper = ScrollHelperClass();
    private var redemptionService = SecurRedemptionService();

    macro ScrollHandler(rs, cmd, id, key)
        var keys = KeyCodes;
        if (cmd == DLG_INIT)
        end;

        if (cmd == DLG_KEY)
            if (key == keys.CTRL_R)
                return CM_SELECT;
            end;

            if (key == keys.F6)
                var dealId = ifThenElse(ValType(rs.value("deal_id")) == 26, 0, rs.value("deal_id"));
                detailsScroll.Run(dealId);
            end;

            if (key == keys.F2)
                redemptionService.PushToFuncObj(rs.value("redemption_id"));
            end;

            if (key == keys.CTRL_H)
                scrollStatusHist.Run(rs.value("redemption_id"));
            end;
        end;

        return CM_DEFAULT;
    end;

    private macro GetQuery():string
        var query = "select r.redemption_id, "
                  + "       r.fix_date, "
                  + "       r.complete_date, "
                  + "       r.list_owners_date, "
                  + "       r.source_number, "
                  + "       r.source_id, "
                  + "       r.deal_id, "
                  + "       t.t_dealcode, "
                  + "       dep.t_name depositary_name, "
                  + "       r.isin, "
                  + "       r.reg_number, "
                  + "       r.nrd_code, "
                  + "       s.description status_description"
                  + "  from secur_redemptions r "
                  + "  join dparty_dbt dep on dep.t_partyid = r.depositary_id "
                  + "  join secur_redemption_statuses s on s.status_id = r.status_id "
                  + "  left join ddl_tick_dbt t on t.t_dealid = r.deal_id "
                  + " order by r.complete_date desc nulls last, "
                  + "          r.fix_date desc, "
                  + "          r.isin ";
        
        return query;
    end;

    private macro GetColumns():TArray
        var columnsArray = TArray();

        scrollHelper.AddColumn(columnsArray, "fix_date",           "Дата фиксации", 13);
        scrollHelper.AddColumn(columnsArray, "complete_date",      "Дата исполнения", 13);
        scrollHelper.AddColumn(columnsArray, "list_owners_date",   "Дата составления перечня", 13);
        scrollHelper.AddColumn(columnsArray, "source_number",      "Номер в Диасофт", 15);
        scrollHelper.AddColumn(columnsArray, "t_dealcode",         "Номер в СОФР", 15);
        scrollHelper.AddColumn(columnsArray, "depositary_name",    "Депозитарий", 15);
        scrollHelper.AddColumn(columnsArray, "isin",               "ISIN", 15);
        scrollHelper.AddColumn(columnsArray, "reg_number",         "Рег. номер", 15);
        scrollHelper.AddColumn(columnsArray, "nrd_code",           "Код в НРД", 15);
        scrollHelper.AddColumn(columnsArray, "status_description", "Статус", 15);
        scrollHelper.AddColumn(columnsArray, "redemption_id",      "ИД", 15);
        scrollHelper.AddColumn(columnsArray, "source_id",          "ИД в Диасофт", 15);
        scrollHelper.AddColumn(columnsArray, "deal_id",            "ИД в СОФР", 15);

        return columnsArray;
    end;

    private macro getRecordSet(query:string)
        var sql = ExecSqlSelect(query, null, true, RSDVAL_CLIENT, RSDVAl_STATIC);
        sql.UpdateCommand = RsdCommand("select 1 from dual");

        return sql;
    end;

    macro Run()
        var query = GetQuery();
        var columns = GetColumns();
        var sqlRecordSet = getRecordSet(query);

        while (RunScroll(sqlRecordSet,
                        columns.size()/6,
                        columns,
                        "secur_redemptions_ui",
                        R2M(this,"ScrollHandler"),
                        SCROLL_NAME,
                        STATUS_BAR)
            )
            sqlRecordSet = getRecordSet(query);
        end;
    end;

end;

c_scroll_redemptions.Run();
exit(1);