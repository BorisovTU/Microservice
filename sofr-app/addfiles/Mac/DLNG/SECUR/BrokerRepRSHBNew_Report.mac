/**                                                                                                             
 @file BrokerRepRSHBNew_Report.mac                                                                                           
 @brief Новый отчет брокера РСХБ 2024. Формирование отчета 

 #menu 
  - БО ЦБ\Сервисные операции\Отправка отчета брокера\Отчет брокера ФЛиЮЛ v2.0                                                                         
                                                                                                                
 # tag 
 - functional_block:СО                                                                                                                                                                                      
 - functional_block:Отчетность_Клиент                                                                             
 - code_type:Report 
 - code_type:API                                                                                                                                                                                                                                                                                              
                                                                                                                
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2024.05.31 |Жиц М.В.       |BOSS-2349           |Создание макроса отчета                                                                                                                                                 
*/ 

import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "scsrvrepfun.mac", "sc_inacc.mac";
import "dpstdrep.mac", "dl_util_xml_obj.mac";
import "dvserv.mac", "dlcontrfunc.mac";
import "lim_utils.mac";
import "BrokerRepRSHB_Common.mac";

CONST STR_HEIGHT = 14; //Высота строки в PDF, где не работает настройка авто-высоты

/**
 @brief Формирование шаблона письма об ошибке
 @param[in]  TemplID   идентификатор шаблона 
 @param[out] err       текст возникшей ошибки 
 @return объект шаблона
*/
private macro GetErrMailTemplNew(TemplID:integer, err:@variant)
   var cmd = RSDCommand("begin RSB_BRKREP_RSHB_NEW.GetErrMailTempl(:TemplID, :Subject, :Body, :err); end;");
   cmd.AddParam("TemplID", RSDBP_IN,  TemplID);
   cmd.AddParam("Subject", RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("Body",    RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("err",     RSDBP_OUT, V_INTEGER);
   cmd.NullConversion = true;
   cmd.Execute();

   if (cmd.Value("err") == 0)
      return CBrokerRepRSHBErrMail( iif(ValType(cmd.Value("Subject")) == V_STRING, cmd.Value("Subject"), ""),
                                    iif(ValType(cmd.Value("Body")) == V_STRING, cmd.Value("Body"), ""));
   else
      err = "Не удалось получить шаблон письма для отправки сообщения об ошибке";
      return NULL;
   end;
onerror(er)
   err = GetLargeErrorMessage(er);
   return NULL;
end;

/**
 @brief Класс сбора информации о клиенте
 @param[in] _DlContrID   идентификатор ДБО 
 @param[in] _BegDate     дата начала периода отчета 
 @param[in] _EndDate     дата окончания периода отчета 
 @param[in] _ServKind    вид обслуживания 
 @param[in] _ServKindSub подвид обслуживания 
 @param[in] _MarketID    идентификатор торговой площадки 
*/
PRIVATE CLASS СBrokerRepRSHB_DlContrData(_DlContrID:integer, _BegDate:date, _EndDate:date, _ServKind:integer, _ServKindSub:integer, _MarketID:integer)
  PRIVATE VAR m_DlContrID   = _DlContrID;
  PRIVATE VAR m_BegDate     = _BegDate;
  PRIVATE VAR m_EndDate     = _EndDate;
  PRIVATE VAR m_ServKind    = IIF(_ServKind == NULL, 0, _ServKind);
  PRIVATE VAR m_ServKindSub = IIF(_ServKindSub == NULL, 0, _ServKindSub);
  PRIVATE VAR m_MarketID    = IIF(_MarketID == NULL, -1, _MarketID);
  PRIVATE VAR m_sa = TRecHandler( "settacc.dbt" );
  PRIVATE VAR m_dlcontr = TBFile("dlcontr.dbt");

  PRIVATE VAR m_IsEDP       = false;
  PRIVATE VAR m_ClientName  = "";
  PRIVATE VAR m_ClientCode  = "";
  PRIVATE VAR m_ContrDate   = date(0,0,0);
  PRIVATE VAR m_ContrNumber = "";
  PRIVATE VAR m_DepoAcc = "";
  PRIVATE VAR m_DepoPart = "";
  PRIVATE VAR m_PartyId = "";
  PRIVATE VAR m_sfName = "";

  /**
   @brief Заполнение основных локальных переменных с данными клиента информацией из БД
  */  
  MACRO Load()
    var cmd, query, DataSet;
    var i = 0;

    m_dlcontr.Clear();
    m_dlcontr.rec.DlContrID = m_DlContrID;
    m_dlcontr.GetEQ();

    m_DepoAcc  = readNoteForObject(OBJTYPE_BROKERCONTR_DL, UniID(m_dlcontr, OBJTYPE_BROKERCONTR_DL), 104 /*Счет Депо Владельца*/, m_EndDate );
    m_DepoAcc = IIF(ValType(m_DepoAcc)==V_UNDEF, "", m_DepoAcc);

	if(m_MarketID == MMVB_ID())
		m_DepoPart = readNoteForObject(OBJTYPE_BROKERCONTR_DL, UniID(m_dlcontr, OBJTYPE_BROKERCONTR_DL), 106 /*Раздел счета Депо ММВБ Владельца*/, m_EndDate );
	elif(m_MarketID == SPB_ID())
		m_DepoPart = readNoteForObject(OBJTYPE_BROKERCONTR_DL, UniID(m_dlcontr, OBJTYPE_BROKERCONTR_DL), 115 /*Раздел счета Депо СПБ Владельца*/, m_EndDate );
	end;
	m_DepoPart = IIF(ValType(m_DepoPart)==V_UNDEF, "", m_DepoPart);

    query =   " select pt.t_Name, "
            + "        pt.t_PartyID, "
            + "        sf.t_Name as sfName, "
            + "        NVL(sf.t_DateConc, "+GetSQLDate(date(0,0,0))+") as ContrDate, "
            + "        NVL(sf.t_Number, CHR(1)) as ContrNumber, "
            + "        NVL((select objcode.t_Code "
            + "               from ddlobjcode_dbt objcode "
            + "              where objcode.t_ObjectType = " + 207
            + "                and objcode.t_CodeKind = " + 1
            + "                and objcode.t_ObjectID = dlc.t_DlcontrID "
            + "            ), CHR(1)) as ClientCode "
            + "   from ddlcontr_dbt dlc, dsfcontr_dbt sf, dparty_dbt pt "
            + "  where dlc.t_DlContrID = ? "
            + "    and sf.t_ID = dlc.t_SfContrID "
            + "    and pt.t_PartyID = sf.t_PartyID ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_DlContrID);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())
      m_ClientName  = DataSet.Name;
      m_ClientCode  = DataSet.ClientCode;
      m_ContrDate   = date(DataSet.ContrDate);
      m_ContrNumber = DataSet.ContrNumber;
      m_IsEDP       = ДоговорЕДП(m_DlContrID);
      m_PartyId     = DataSet.t_PartyID;
      m_sfName      = DataSet.sfName;
    end;
  END;

  MACRO DlContrID():INTEGER
    return m_DlContrID;
  END;

  MACRO FlClientName():STRING
    return m_ClientName;
  END;

  MACRO UlClientName():STRING
    var Query, DataSet, Select;
    
    Query = "select count(*) " +
            "  from dpartyown_dbt dp " +
            " where dp.t_partyid = ? and dp.t_Partykind = 65 ";

    Select = DL_RSDCommand(Query);
    Select.AddParam(m_PartyId);
    DataSet = Select.Execute(Query);

    if(DataSet.MoveNext())
      return m_sfName;
    END;

    return m_ClientName;
  END;

  MACRO ClientName():STRING
    if(not m_IsEDP)
      return UlClientName();
    else
      return FlClientName();
    END;
  END;

  MACRO ClientCode():STRING
    return m_ClientCode;
  END;

  MACRO ContrDate():DATE
    return m_ContrDate;
  END;

  MACRO ContrNumber():STRING
    return m_ContrNumber;
  END;

  MACRO ServKind():INTEGER
    return m_ServKind;
  END;

  MACRO ServKindSub():INTEGER
    return m_ServKindSub;
  END;

  MACRO MarketID():INTEGER
    return m_MarketID;
  END;

  MACRO IsEDP():BOOL
    return m_IsEDP;
  END;

  MACRO DepoAcc():STRING
    return m_DepoAcc;
  END;

  MACRO DepoPart():STRING
    return m_DepoPart;
  END;

  Load();
END;

/**
 @brief Класс для формирования всех данных для отчета
 @param[in] RepParams структура параметров запуска отчета 
*/
PRIVATE CLASS SP_BrokerRepRSHB_CreateData(RepParams:CBrokerRepRSHBParams)
  PRIVATE VAR m_RepParams = RepParams;

  /**
   @brief Подготовка данных по сделкам с ц/б (фондовый рынок ММВБ/СПБ, внебиржа)
   @param[in] IsEDP признак договора ЕДП 
  */
  PRIVATE MACRO CreateSecurDealData(IsEDP:bool)
    var sql, exec;

    InitProgress(-1, "Подготовка данных для разделов отчета", "Сделки фондового рынка");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateDealData(?, ?, ?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID);
    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);
    exec.addParam(IIF(m_RepParams.IsMarket == true, 1, 0));
    exec.addParam(IIF(m_RepParams.IsOutMarket == true, 1, 0));
    exec.addParam(IIF(IsEDP == true, 1, 0));
    exec.ExecuteCMD();

    RemProgress();
  END;

  /**
   @brief Подготовка данных по сделкам валютного рынка
   @param[in] IsEDP признак договора ЕДП 
  */
  PRIVATE MACRO CreateCurDealData(IsEDP:bool)
    var sql, exec;

    InitProgress(-1, "Подготовка данных для разделов отчета", "Сделки валютного рынка");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateCurDealData(?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID);
    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);
    exec.addParam(IIF(IsEDP == true, 1, 0));
    exec.ExecuteCMD();

    RemProgress();
  END;

  /**
   @brief Подготовка данных по сделкам срочного рынка
   @param[in] IsEDP признак договора ЕДП 
  */
  PRIVATE MACRO CreateDvDealData(IsEDP:bool)
    var sql, exec;

    InitProgress(-1, "Подготовка данных для разделов отчета", "Сделки срочного рынка");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateDvDealData(?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID);
    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);
    exec.addParam(IIF(IsEDP == true, 1, 0));
    exec.ExecuteCMD();

    RemProgress();
  END;

  /**
   @brief Подготовка данных для разделов по оценке позиций по активам (ц/б и ПФИ) и составу портфеля
          Для фондового рынка сначала готовятся данные СОСТАВ ПОРТФЕЛЯ, а уже по ним формируются АКТИВЫ
   @param[in] IsEDP    признак договора ЕДП 
   @param[in] IsMarket признак отбора данных по биржевому портфелю 
  */
  PRIVATE MACRO CreateActiveData(IsEDP:bool)
    var sql, exec;
    var query, cmd, DataSet;

    InitProgress(-1, "Подготовка данных для раздела Оценка позиций", "Оценка позиций по ЦБ");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateActiveData(?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID );
    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.addParam(IIF(IsEDP == true, 1, 0) );
    exec.ExecuteCMD();

    RemProgress();

    if(m_RepParams.IsMarket)
      InitProgress(-1, "Подготовка данных для раздела Оценка позиций", "Оценка позиций по ПФИ");

      sql =  "DECLARE "
           + "BEGIN "
           + "    RSB_BRKREP_RSHB_NEW.CreateActiveDerivData(?, ?, ?, ?); "
           + "END; ";
     
      exec = DL_RSDCommand(sql);

      exec.addParam(m_RepParams.DlContrID);
      exec.addParam(m_RepParams.BegDate);
      exec.addParam(m_RepParams.EndDate);
      exec.addParam(IIF(IsEDP == true, 1, 0));
      exec.ExecuteCMD();

      RemProgress(); 
    end;
  END;

  /**
   @brief Подготовка данных по остаткам и движениям ДС
   @param[in] IsEDP  признак договора ЕДП 
  */
  PRIVATE MACRO CreateCasheMoveData(IsEDP:bool)
    var sql, exec;
    var query;

    InitProgress(-1, "Подготовка данных для раздела Оценка денежной позиции", "Курсы валют");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateCoursesData(?, ?); "
         + "END; ";

    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);
    exec.ExecuteCMD();

    RemProgress();

    InitProgress(-1, "Подготовка данных для раздела Оценка денежной позиции", "Оценка денежной позиции");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateAccMoveData(?, ?, ?); "
         + "END; ";

    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.addParam(IIF(IsEDP == true, 1, 0) );
    exec.ExecuteCMD();

    RemProgress();

    InitProgress(-1, "Подготовка данных для раздела Оценка денежной позиции", "Движение денежных средств");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateCasheMoveData(?, ?, ?); "
         + "END; ";

    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);
    exec.addParam(IIF(IsEDP == true, 1, 0));
    exec.ExecuteCMD();

    RemProgress();
  END;

  /**
   @brief Подготовка данных по обязательствам перед банком
  */
  PRIVATE MACRO CreateDebtData()
    var sql, exec;
    var query;

    InitProgress(-1, "Подготовка данных для раздела Обязательства перед банком", "Обязательства перед банком");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateDebtData(?, ?, ?); "
         + "END; ";

    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID);
    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);
    exec.ExecuteCMD();

    RemProgress();
  END;

  /**
   @brief Подготовка данных по сводной информации
  */
  PRIVATE MACRO CreateSvodInfoData()
    var sql, exec;
    var query;

    InitProgress(-1, "Подготовка данных для раздела Сводная информация", "Сводная информация");

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.CreateSvodInfoData(?, ?); "
         + "END; ";

    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.BegDate);
    exec.addParam(m_RepParams.EndDate);
    exec.ExecuteCMD();

    RemProgress();
  END;

  /**
   @brief Подготовка отчетных данных
   @param[in] IsEDP  признак договора ЕДП 
  */  
  PRIVATE MACRO CreateAllData(IsEDP:bool)

    InitProgress(7, "Подготовка данных для разделов отчета", "Подготовка данных для разделов отчета");

    CreateCasheMoveData(IsEDP);
    UseProgress(1);

    CreateActiveData(IsEDP);
    UseProgress(2);

    CreateSecurDealData(IsEDP);
    UseProgress(3);

    if(m_RepParams.IsMarket == true)
      CreateDebtData();
      UseProgress(4);

      CreateCurDealData(IsEDP);
      UseProgress(5);

      CreateDvDealData(IsEDP);
      UseProgress(6);
    end;
  
    CreateSvodInfoData();
    UseProgress(7);
 
    RemProgress();
  END;

  /**
   @brief Сбор информации по клиентским счетам и подготовка отчетных данных
  */  
  MACRO Create()
    var DlContrData = NULL;
    var sql, exec;

    DlContrData = СBrokerRepRSHB_DlContrData(m_RepParams.DlContrID, m_RepParams.BegDate, m_RepParams.EndDate);

    sql =  "DECLARE "
         + "BEGIN "
         + "    RSB_BRKREP_RSHB_NEW.LoadAccInTmp(?, ?, ?, ?, ?, ?); "
         + "END; ";
     
    exec = DL_RSDCommand(sql);

    exec.addParam(m_RepParams.DlContrID );
    exec.addParam(m_RepParams.BegDate );
    exec.addParam(m_RepParams.EndDate );
    exec.addParam(IIF(DlContrData.IsEDP() == true, 1, 0) );
    exec.addParam(IIF(m_RepParams.IsOutMarket == true, 1, 0) );
    exec.addParam(IIF(m_RepParams.ShowPlanRest == true, 1, 0) );
    exec.ExecuteCMD();

    CreateAllData(DlContrData.IsEDP());
  END;
END;

/**
 @brief Класс печати отчета
 @param[in] RepParams структура параметров запуска отчета 
*/
PRIVATE CLASS СBrokerRepRSHB_PrintRep(RepParams:CBrokerRepRSHBParams)

  PRIVATE VAR m_rep = T_Poi_Rep();
  VAR m_RepParams = RepParams;
  var m_DlContrData = NULL;
  VAR m_CurrentRepName = "";
  PRIVATE VAR m_FullPath = "";
  PRIVATE VAR m_ItogCellColor = "E4DFEC"; //Цвет итоговых строк
  PRIVATE VAR m_TableHeadStyle = "BOR;FB;P=C;"; //Стиль шапок таблиц
  PRIVATE VAR m_TableHeadStyleGreen = "BOR;FB;P=C;IC=C6E0B4;"; //Стиль зеленых ячеек в шапках таблиц
  PRIVATE VAR m_TableHeadStyleYellow = "BOR;FB;P=C;IC=FFF2CC;"; //Стиль желтых ячеек в шапках таблиц
  PRIVATE VAR m_TitleStyle = "FB;HA=L;FS=10;R=10;END;"; //Стиль заголовков

  /**
   @brief Печать шапки отчета
   @param[in] SheetNum номер страницы 
  */
  PRIVATE MACRO PrintHeader(SheetNum)  
     var LogoTagName = String("LOGO__", SheetNum);
     m_Rep.Set_WrapText(0);

     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("Логотип", "FC=W;END;CN="+LogoTagName+";");

     m_rep.Put_Str("", "START;", STR_HEIGHT);
     m_rep.Put_Str("Отчет брокера за период с " + string(m_RepParams.BegDate:f) + " по " + string(m_RepParams.EndDate:f) + ", дата формирования " + string(m_RepParams.ReportDate:f), "FB;FS=11;HA=L;R=8;END;");
     m_rep.Blank_Line();

     m_rep.Put_Str("", "START;", STR_HEIGHT);
     m_rep.Put_Str("(АО \"Россельхозбанк\", " + m_RepParams.OurAddress + ", ИНН/КПП " + m_RepParams.OurINN + ")", "FB;FS=11;HA=L;R=10;END;");
     m_rep.Blank_Line();

     m_rep.Put_Str("", "START;", STR_HEIGHT);
     m_rep.Put_Str("Клиент", "FB;HA=L;FS=10;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str(m_DlContrData.ClientName(), "HA=L;FS=10;END;");

     m_rep.Put_Str("", "START;", STR_HEIGHT);
     m_rep.Put_Str("Уникальный код", "FB;HA=L;FS=10;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str(m_DlContrData.ClientCode(), "HA=L;FS=10;END;");

     m_rep.Put_Str("", "START;", STR_HEIGHT);
     m_rep.Put_Str("Договор на брокерское обслуживание", "FB;HA=L;FS=10;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("№"+m_DlContrData.ContrNumber()+" от "+string(m_DlContrData.ContrDate():f), "HA=L;FS=10;END;");

     if(m_DlContrData.ServKindSub() == 9)
       m_rep.Put_Str("", "START;", STR_HEIGHT);
       m_rep.Put_Str("Субсчет", "FB;FS=10;HA=L;");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("Внебиржа", "HA=L;FS=10;END;");
     end;

     m_rep.Blank_Line();    
  END;

  /**
   @brief Проверка наличия данных по остаткам ДС
   @return 1 - данные есть, 0 - данных нет 
  */
  PRIVATE MACRO ExistsDataForAccMoneyMoving():integer
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepaccitog_tmp "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    if(m_DlContrData.MarketID > 0)
      query = query + " and t_MarketID = ? ";

      cmd.AddParam(m_DlContrData.MarketID());
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  /**
   @brief Печать данных по остаткам ДС
  */
  PRIVATE MACRO PrintAccMoneyMoving()
    var query, CurrCmd, CurrData;
    var CCY = "";
    var cntCurr = 0;
    var i = 0, j = 0;
    var prevMarketName:string = "";

    //Напечатать итоговые строки
    MACRO PrintItogLines()
      CurrCmd = DL_RSDCommand();

      query =   " select * "
              + "   from dbrkrepaccitog_tmp "
              + "  where t_IsItog = 'X' ";

      if(m_DlContrData.ServKind() != 0)
        query = query + " and t_ServKind = ? "
                      + " and t_ServKindSub = ? ";

        CurrCmd.AddParam(m_DlContrData.ServKind());
        CurrCmd.AddParam(m_DlContrData.ServKindSub());
      else
        query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
      end;

      if(m_DlContrData.MarketID() > 0)
        query = query + " and t_MarketID = ? ";
        CurrCmd.AddParam(m_DlContrData.MarketID())
      end;

      query = query + "order by t_Currency ASC ";

      if(CurrCmd.GetCount(query))
        CurrData = CurrCmd.Execute(query);

        m_Rep.Set_WrapText(1);
        while(CurrData.moveNext())
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(CurrData.Ccy, "FB;BOR;HA=L;R=1;IC="+m_ItogCellColor+";");
          m_rep.Put_Str(CurrData.InRest, "FB;BOR;HA=R;T=M2;IC="+m_ItogCellColor+";");
          m_rep.Put_Str(CurrData.OutRest, "FB;BOR;HA=R;T=M2;IC="+m_ItogCellColor+";");
          if(m_RepParams.ShowPlanRest == true)
            m_rep.Put_Str(CurrData.PlanRest, "FB;BOR;HA=R;T=M2;IC="+m_ItogCellColor+";");
          end;
          m_rep.Put_Str("","END;");
        end;
      end;
    END;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str("1.3. Оценка денежной позиции", m_TitleStyle);
      m_rep.Blank_Line();

      m_Rep.Set_WrapText(1);
      m_rep.Put_Str("", "START;", 3.9*STR_HEIGHT);
      m_rep.Put_Str("Валюта/драгоценный металл", m_TableHeadStyle+"R=1;");
      m_rep.Put_Str("Входящий остаток (на начало периода)", m_TableHeadStyle);
      m_rep.Put_Str("Исходящий остаток (на конец периода)", m_TableHeadStyle);
      if(m_RepParams.ShowPlanRest == true)
        m_rep.Put_Str("Плановый остаток (на конец периода)", m_TableHeadStyle);
      end;
      m_rep.Put_Str("", "END;");
    END;
                                                      
    CurrCmd = DL_RSDCommand();

    query =   " select * "
            + "   from dbrkrepaccitog_tmp "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind == 0)
      query = query + " and t_ServKindSub <> 9 "; //Кроме внебирж
    else
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      CurrCmd.AddParam(m_DlContrData.ServKind());
      CurrCmd.AddParam(m_DlContrData.ServKindSub());
    end;

    if(m_DlContrData.MarketID > 0)
      query = query + " and t_MarketID = ? ";

      CurrCmd.AddParam(m_DlContrData.MarketID());
    end;

    query = query + "order by t_MarketName ASC, t_Currency ASC ";
    
    cntCurr = CurrCmd.GetCount(query);

    if(cntCurr > 0)
      
      PrintHeaderAndCap();

      CurrData = CurrCmd.Execute(query);

      while(CurrData.moveNext())
        if(prevMarketName != CurrData.MarketName)
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str(CurrData.MarketName, "FB;BOR;HA=L;VA=C;R=1;");
          m_rep.Put_Str("", "BOR");
          m_rep.Put_Str("", "BOR;");
          if(m_RepParams.ShowPlanRest == true)
            m_rep.Put_Str("", "BOR;");
          end;
          m_rep.Put_Str("", "END;");

          prevMarketName = CurrData.MarketName;
        end;

        m_rep.Put_Str("", "START;");
        m_rep.Put_Str(CurrData.Ccy, "BOR;HA=L;R=1;");
        m_rep.Put_Str(CurrData.InRest, "BOR;HA=R;T=M2;");
        m_rep.Put_Str(CurrData.OutRest, "BOR;HA=R;T=M2;");
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Str(CurrData.PlanRest, "BOR;HA=R;T=M2;");
        end;
        m_rep.Put_Str("","END;");
      end;

      PrintItogLines();
      m_rep.Blank_Line();
    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap();
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Печать данных по движениям ДС
  */
  PRIVATE MACRO PrintCasheMoneyMoving()
    var query, cmd, DataSet;
    var CCY = "", CurrName = "";
    var i = 0, j = 0;
    var prevCurrency = -1;
    var cnt = 0;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap(Currency:integer, NeedHeader:bool)
      m_Rep.Set_WrapText(0);
      if(NeedHeader)
        m_rep.Put_Str("", "START;", STR_HEIGHT);
        m_rep.Put_Str("2.1. Движение денежных средств", m_TitleStyle);
        m_rep.Blank_Line();
      end;

      CCY = GetFinInstrCcy(Currency,true,false);
      CurrName = IIF(Currency == NATCUR, "Рубли", GetFinInstrName(Currency,true,false)) + " ("+CCY+")"; 
    
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str(CurrName, m_TitleStyle);
      m_rep.Blank_Line();

      m_Rep.Set_WrapText(1);    
      m_rep.Put_Str("", "START;", 2*STR_HEIGHT);
      m_rep.Put_Str("Дата",                   m_TableHeadStyle+"R=1;");
      m_rep.Put_Str("Операция",               m_TableHeadStyle+"R=3;");
      m_rep.Put_Str("Торговая площадка",      m_TableHeadStyle);
      m_rep.Put_Str("Сумма/объем зачисления", m_TableHeadStyle);
      m_rep.Put_Str("Сумма/объем списания",   m_TableHeadStyle);
      m_rep.Put_Str("Сальдо расчетов (+/-)",  m_TableHeadStyle);
      m_rep.Put_Str("", "END;");
    END;

    cmd = DL_RSDCommand();

    query =   "  select  t.t_Currency, "  
            + "          t.t_Date, "
            + "          t.t_PrintDate,  "
            + "          t.t_OperName,  "
            + "          t.t_MarketName,  "
            + "          t.t_InSum,  "
            + "          t.t_OutSum,  "
            + "          t.t_Rest,  "
            + "          t.t_IsItog  "
            + "  from DBRKREPCASHEGROUPMOVING_TMP t  "
            + " where t.t_ServKind     = ?  "
            + "  and  t.t_ServKindSub  = ?  ";

    cmd.AddParam(m_DlContrData.ServKind());
    cmd.AddParam(m_DlContrData.ServKindSub());

    DataSet = cmd.Execute(query);

    cnt = cmd.GetCount(query);
    
    if(cnt)
      DataSet = cmd.Execute(query);

      while(DataSet.moveNext())
        if(DataSet.Currency != prevCurrency)
          PrintHeaderAndCap(DataSet.Currency, (prevCurrency == -1));
        end;
      
        if(DataSet.IsItog != SET_CHAR)
          m_rep.Put_Str("", "START;", 3*STR_HEIGHT);
          m_rep.Put_Str(DataSet.PrintDate,    "BOR;HA=L;VA=C;R=1;");
          m_rep.Put_Str(DataSet.OperName,     "BOR;HA=L;VA=C;R=3;");
          m_rep.Put_Str(DataSet.MarketName,   "BOR;HA=L;VA=C;");
          m_rep.Put_Str(IIF(DataSet.InSum==0, "", money(DataSet.InSum)),  "BOR;HA=R;VA=C;"+IIF(DataSet.InSum==0,"","T=M2;") );
          m_rep.Put_Str(IIF(DataSet.OutSum==0, "", money(DataSet.OutSum)),"BOR;HA=R;VA=C;"+IIF(DataSet.OutSum==0,"","T=M2;"));
          m_rep.Put_Str("",                   "BOR;HA=R;VA=C;");
          m_rep.Put_Str("", "END;");
   
        else
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str("Итого в "+CCY, "BOR;FB;HA=L;R=6;IC="+m_ItogCellColor+";");
          m_rep.Put_Str(IIF(DataSet.InSum==0, "", money(DataSet.InSum)),  "BOR;FB;HA=R;IC="+m_ItogCellColor+";"+IIF(DataSet.InSum==0,"","T=M2;") );
          m_rep.Put_Str(IIF(DataSet.OutSum==0, "", money(DataSet.OutSum)),"BOR;FB;HA=R;IC="+m_ItogCellColor+";"+IIF(DataSet.OutSum==0,"","T=M2;"));
          m_rep.Put_Str(money(DataSet.Rest),  "BOR;FB;HA=R;T=M;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "END;");
  
          m_rep.Blank_Line();
          
        end; 
        
        prevCurrency = DataSet.Currency;
      end;

    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap(NATCUR, true);
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Печать сводной информации
  */
  PRIVATE MACRO PrintSvodInfo()
    var query, cmd, DataSet;
    var cnt:integer = 0, i:integer = 0;

    //Напечатать итоговую строку
    MACRO PrintItogLines()
      cmd = DL_RSDCommand();

      query =   " select * "
              + "   from dbrkrepsvodinfo_tmp "
              + "  where t_IsItog = 'X' ";

      if(m_DlContrData.ServKind() != 0)
        query = query + " and t_ServKind = ? "
                      + " and t_ServKindSub = ? ";
   
        cmd.AddParam(m_DlContrData.ServKind());
        cmd.AddParam(m_DlContrData.ServKindSub());
      else
        query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
      end;

      DataSet = cmd.Execute(query);

      while(DataSet.moveNext())
        m_rep.Put_Str("", "START;", STR_HEIGHT);
        m_rep.Put_Str(DataSet.Name,       "BOR;FB;HA=L;R=3;IC="+m_ItogCellColor+";");
        m_rep.Put_Val(DataSet.InSum,      "BOR;FB;HA=R;T=M2;IC="+m_ItogCellColor+";");
        m_rep.Put_Val(DataSet.OutSum,     "BOR;FB;HA=R;T=M2;IC="+m_ItogCellColor+";");
        m_rep.Put_Val(DataSet.Difference, "BOR;FB;HA=R;T=M2;IC="+m_ItogCellColor+";");
        m_rep.Put_Str("", "END;");
      end;
    END;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str("1.1. Сводная информация (руб)", m_TitleStyle);
      m_rep.Blank_Line();      

      m_Rep.Set_WrapText(1);    
      m_rep.Put_Str("", "START;", 2*STR_HEIGHT);
      m_rep.Put_Str("Наименование",        m_TableHeadStyle+"R=3;");
      m_rep.Put_Str("На начало периода",   m_TableHeadStyle);
      m_rep.Put_Str("На конец периода",    m_TableHeadStyle);
      m_rep.Put_Str("Изменение за период", m_TableHeadStyle);
      m_rep.Put_Str("", "END;");
    END;

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dbrkrepsvodinfo_tmp  "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;
            
    cnt = cmd.GetCount(query);

    if(cnt > 0)
      DataSet = cmd.Execute(query);

      InitProgress(cnt, "Подготовка раздела Сводная информация", "Сводная информация");

      PrintHeaderAndCap();

      m_Rep.Set_WrapText(1);
      while(DataSet.moveNext())                           
        m_rep.Put_Str("", "START;");
        m_rep.Put_Str(DataSet.Name,       "BOR;HA=L;VA=C;R=3;");
        m_rep.Put_Val(DataSet.InSum,      "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(DataSet.OutSum,     "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(DataSet.Difference, "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Str("", "END;");

        UseProgress(i = i + 1);
      end;

      RemProgress();

      PrintItogLines();
      m_rep.Blank_Line();
    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap();
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Печать информации по обязательствам перед банком
  */
  PRIVATE MACRO PrintDebt()
    var query, cmd, DataSet, cmd1, DataSet1;
    var cnt:integer = 0, i:integer = 0;

    //Напечатать итоговую строку
    MACRO PrintItogLines()
      cmd = DL_RSDCommand();

      query =   " select * "
              + "   from dbrkrepdebt_tmp "
              + "  where t_IsItog = 'X' "
              + "    and t_OnDate  = ? ";
      cmd.AddParam(m_RepParams.EndDate);
              
      DataSet = cmd.Execute(query);

      m_Rep.Set_WrapText(1);
      while(DataSet.moveNext())
        m_rep.Put_Str("", "START;", STR_HEIGHT);
        m_rep.Put_Str(DataSet.Text, "BOR;FB;HA=L;R=3;IC="+m_ItogCellColor+";");
        m_rep.Put_Str("",           "BOR;FB;HA=R;IC="+m_ItogCellColor+";");
        m_rep.Put_Str("",           "BOR;FB;HA=R;IC="+m_ItogCellColor+";");
        m_rep.Put_Str("",           "BOR;FB;HA=L;IC="+m_ItogCellColor+";");
        m_rep.Put_Val(DataSet.Sum,  "BOR;FB;HA=R;T=M2;IC="+m_ItogCellColor+";");
        m_rep.Put_Str("", "END;");
      end;
    END;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str("1.4. Обязательства перед банком (руб)", m_TitleStyle);
      m_rep.Blank_Line();      

      m_Rep.Set_WrapText(1); 
      m_rep.Put_Str("", "START;", 3*STR_HEIGHT);
      m_rep.Put_Str("Наименование операции",            m_TableHeadStyle+"R=3;");
      m_rep.Put_Str("Дата возникновения задолженности", m_TableHeadStyle);
      m_rep.Put_Str("Плановая дата оплаты",             m_TableHeadStyle);
      m_rep.Put_Str("Валюта",                           m_TableHeadStyle);
      m_rep.Put_Str("Сумма",                            m_TableHeadStyle);
      m_rep.Put_Str("", "END;");
    END;

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dbrkrepdebt_tmp  "
            + "  where t_IsTotal = 'X' "
            + "    and t_IsItog  = CHR(0) "
            + "    and t_OnDate  = ? "  
            + "  order by t_Type ASC, t_Currency ASC ";
    cmd.AddParam(m_RepParams.EndDate);            
            
    cnt = cmd.GetCount(query);

    if(cnt > 0)
      DataSet = cmd.Execute(query);

      InitProgress(cnt, "Подготовка раздела Обязательства перед банком", "Обязательства перед банком");

      PrintHeaderAndCap();

      m_Rep.Set_WrapText(1);
      while(DataSet.moveNext())                           
        m_rep.Put_Str("", "START;");
        m_rep.Put_Str(DataSet.Text, "BOR;FB;HA=L;R=3;");
        m_rep.Put_Str("",           "BOR;FB;HA=R;");
        m_rep.Put_Str("",           "BOR;FB;HA=R;");
        m_rep.Put_Str(DataSet.CCY,  "BOR;FB;HA=L;");
        m_rep.Put_Val(DataSet.Sum,  "BOR;FB;HA=R;T=M2;");
        m_rep.Put_Str("", "END;");

        cmd1 = DL_RSDCommand(" select * " +                    
                             "   from dbrkrepdebt_tmp  " +    
                             "  where t_IsTotal = CHR(0) " +  
                             "    and t_IsItog  = CHR(0) " +
                             "    and t_OnDate  = ? " +  
                             "    and t_Type    = ? " +       
                             "  order by t_Currency ASC, t_OriginDate ASC "
                            );
        cmd1.AddParam(m_RepParams.EndDate);            
        cmd1.AddParam(DataSet.Type);            

        DataSet1 = cmd1.Execute();

        while(DataSet1.moveNext())                           
          m_rep.Put_Str("", "START;");
          m_rep.Put_Str(DataSet1.Text,             "BOR;HA=L;R=3;");
          m_rep.Put_Str(date(DataSet1.OriginDate), "BOR;HA=R;T=D;");
          m_rep.Put_Str(date(DataSet1.PayDate),    "BOR;HA=R;T=D;");
          m_rep.Put_Str(DataSet1.CCY,              "BOR;HA=L;");
          m_rep.Put_Val(DataSet1.Sum,              "BOR;HA=R;T=M2;");
          m_rep.Put_Str("", "END;");
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      PrintItogLines();
      m_rep.Blank_Line();
    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap();
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Проверка наличия данных по оценке позиций по ц/б
   @return 1 - данные есть, 0 - данных нет 
  */
  PRIVATE MACRO ExistsDataForActiveAvoiriss()
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepactiveavoir_tmp "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  /**
   @brief Печать данных по оценке позиций по ц/б
  */
  PRIVATE MACRO PrintActiveAvoiriss()
    var query, cmd, DataSet;
    var cnt = 0, i = 0;

    //Напечатать итоговые строки
    MACRO PrintItogLines()
      cmd = DL_RSDCommand();

      query =   " select * "
              + "   from dbrkrepactiveavoir_tmp "
              + "  where t_IsItog = 'X' ";

      if(m_DlContrData.ServKind() != 0)
        query = query + " and t_ServKind = ? "
                      + " and t_ServKindSub = ? ";

        cmd.AddParam(m_DlContrData.ServKind());
        cmd.AddParam(m_DlContrData.ServKindSub());
      else
        query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
      end;

      if(cmd.GetCount(query))
        DataSet = cmd.Execute(query);

        m_Rep.Set_WrapText(1);
        while(DataSet.moveNext())
        m_rep.Put_Str("", "START;", IIF((StrLen(string(DataSet.OutPlanCostRest)) > 12) or (StrLen(string(DataSet.InCostRest)) > 14) or (StrLen(string(DataSet.OutCostRest)) > 13), 2*STR_HEIGHT));
          m_rep.Put_Str(DataSet.Name,            "BOR;FB;HA=L;R=1;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(DataSet.InCostRest,      "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(DataSet.OutCostRest,     "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          if(m_RepParams.ShowPlanRest == true)
            m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
            m_rep.Put_Str(DataSet.OutPlanCostRest, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          end;
          m_rep.Put_Str("","END;");
        end;                                                                                      
      end;
    END;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str("1."+IIF(m_DlContrData.ServKindSub() == 9, "4", "5")+". Оценка позиций по ценным бумагам и иностранным финансовым инструментам, не квалифицированным в качестве ценных бумаг (руб)", m_TitleStyle);
      m_rep.Blank_Line();

      m_Rep.Set_WrapText(1);          
      m_rep.Put_Str("", "START;", 4.8*STR_HEIGHT);
      m_rep.Put_Str("Наименование ЦБ",                                            m_TableHeadStyle+"R=1;");
      m_rep.Put_Str("ISIN/Номер гос. регистрации",                                m_TableHeadStyle);
      m_rep.Put_Str("Валюта номинала",                                            m_TableHeadStyle);
      m_rep.Put_Str("Входящий остаток, шт. (на начало периода)",                  m_TableHeadStyleGreen);
      m_rep.Put_Str("Рыночная цена/ Котировка (на начало периода)",               m_TableHeadStyleGreen);
      m_rep.Put_Str("Валюта рыночной цены (на начало периода)",                   m_TableHeadStyleGreen);
      m_rep.Put_Str("НКД в валюте номинала (на начало периода)",                  m_TableHeadStyleGreen);
      m_rep.Put_Str("Рыночная стоимость, руб., с учетом НКД (на начало периода)", m_TableHeadStyleGreen);
      m_rep.Put_Str("Зачислено, шт.",                                             m_TableHeadStyle);
      m_rep.Put_Str("Списано, шт.",                                               m_TableHeadStyle);
      m_rep.Put_Str("Исходящий остаток, шт. (на конец периода)",                  m_TableHeadStyleYellow);
      m_rep.Put_Str("Рыночная цена/ Котировка (на конец периода)",                m_TableHeadStyleYellow);
      m_rep.Put_Str("Валюта рыночной цены (на конец периода)",                    m_TableHeadStyleYellow);
      m_rep.Put_Str("НКД в валюте номинала (на конец периода)",                   m_TableHeadStyleYellow);
      m_rep.Put_Str("Рыночная стоимость, руб., с учетом НКД (на конец периода)",  m_TableHeadStyleYellow);
      if(m_RepParams.ShowPlanRest == true)
        m_rep.Put_Str("Плановый остаток, шт.",                                    m_TableHeadStyle);
        m_rep.Put_Str("Плановый остаток, руб.",                                   m_TableHeadStyle);
      end;
      m_rep.Put_Str("","END;");
    END;

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dbrkrepactiveavoir_tmp  "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    query = query + " order by t_Name ";
            
    cnt = cmd.GetCount(query);

    if(cnt > 0)
      DataSet = cmd.Execute(query);

      InitProgress(cnt, "Подготовка раздела Оценка позиции", "Оценка позиции по ценным бумагам и НЕФИ");

      PrintHeaderAndCap();

      while(DataSet.moveNext())                           
        m_rep.Put_Str("", "START;", IIF((StrLen(string(DataSet.OutPlanCostRest)) > 12) or (StrLen(string(DataSet.InCostRest)) > 14) or (StrLen(string(DataSet.OutCostRest)) > 13) or 
                                        ((ValType(DataSet.InNKD) != V_UNDEF) and (StrLen(string(DataSet.InNKD)) > 13)) or ((ValType(DataSet.OutNKD) != V_UNDEF) and (StrLen(string(DataSet.OutNKD)) > 12)), 2*STR_HEIGHT));
        m_rep.Put_Str(DataSet.Name,              "BOR;HA=L;R=1;");                                           //Наименование ЦБ                                         
        m_rep.Put_Str(DataSet.ISINLSIN,          "BOR;HA=C;");                                               //ISIN/Номер гос. регистрации                             
        m_rep.Put_Str(DataSet.FaceValueFICcy,    "BOR;HA=C;");                                               //Валюта номинала                                         
        m_rep.Put_Val(DataSet.InRest,            "BOR;HA=R;VA=C;T=M"+AmountPrecision(DataSet.InRest)+";");   //Входящий остаток, шт. (на начало периода)               
        m_rep.Put_Val(DataSet.InCourse,          "BOR;HA=R;VA=C;T=N4;");                                     //Рыночная цена/ Котировка (на начало периода)
        m_rep.Put_Str(DataSet.InCourseFICcy,     "BOR;HA=C;");                                               //Валюта рыночной цены (на начало периода)                
        if(ValType(DataSet.InNKD) != V_UNDEF)                                                                //НКД в валюте номинала (на начало периода)               
          m_rep.Put_Val(DataSet.InNKD,           "BOR;HA=R;VA=C;T=M2;");                                     
        else                                                                                               
          m_rep.Put_Str("",                      "BOR;P=C;");                                                
        end;                                                                                               
        m_rep.Put_Val(DataSet.InCostRest,        "BOR;HA=R;VA=C;T=M2;");                                     //Рыночная стоимость, руб., с учетом НКД (на начало периода)
        m_rep.Put_Val(DataSet.Buy,               "BOR;HA=R;VA=C;T=M"+AmountPrecision(DataSet.Buy)+";");      //Зачислено, шт.                                          
        m_rep.Put_Val(DataSet.Sale,              "BOR;HA=R;VA=C;T=M"+AmountPrecision(DataSet.Sale)+";");     //Списано, шт.                                            
        m_rep.Put_Val(DataSet.OutRest,           "BOR;HA=R;VA=C;T=M"+AmountPrecision(DataSet.OutRest)+";");  //Исходящий остаток, шт. (на конец периода)               
        m_rep.Put_Val(DataSet.OutCourse,         "BOR;HA=R;VA=C;T=N4;");                                     //Рыночная цена/ Котировка (на конец периода)
        m_rep.Put_Str(DataSet.OutCourseFICcy,    "BOR;HA=C;");                                               //Валюта рыночной цены (на конец периода)                 
        if(ValType(DataSet.OutNKD) != V_UNDEF)                                                               //НКД в валюте номинала (на конец периода)                
          m_rep.Put_Val(DataSet.OutNKD,          "BOR;HA=R;VA=C;T=M2;");                                     
        else                                                                                                                               
          m_rep.Put_Str("",                      "BOR;P=C;");                                                                                
        end;                                                                                                                               
        m_rep.Put_Val(DataSet.OutCostRest,       "BOR;HA=R;VA=C;T=M2;");                                     //Рыночная стоимость, руб., с учетом НКД (на конец периода)
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Str(DataSet.OutPlanRest,     "BOR;HA=R;VA=C;T=M"+AmountPrecision(DataSet.OutPlanRest)+";"); //Плановый остаток, шт.
          m_rep.Put_Str(DataSet.OutPlanCostRest, "BOR;HA=R;VA=C;T=M2;");                                     //Плановый остаток, руб.
        end;
        m_rep.Put_Str("","END;");                                                                                      

        UseProgress(i = i + 1);
      end;

      RemProgress();

      PrintItogLines();
      m_rep.Blank_Line();
    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap();
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Печать данных по оценке позиций по ПФИ
  */
  PRIVATE MACRO PrintActiveDeriv()
    var query, cmd, DataSet;
    var cnt = 0, i = 0;

    //Напечатать итоговые строки
    MACRO PrintItogLines()
      cmd = DL_RSDCommand();

      query =   " select * "
              + "   from dbrkrepactivederiv_tmp "
              + "  where t_IsItog = 'X' ";

      if(m_DlContrData.ServKind() != 0)
        query = query + " and t_ServKind = ? "
                      + " and t_ServKindSub = ? ";

        cmd.AddParam(m_DlContrData.ServKind());
        cmd.AddParam(m_DlContrData.ServKindSub());
      else
        query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
      end;

      if(cmd.GetCount(query))
        DataSet = cmd.Execute(query);

        m_Rep.Set_WrapText(1);
        while(DataSet.moveNext())
          m_rep.Put_Str("", "START;", STR_HEIGHT);           
          m_rep.Put_Str(DataSet.FIKind,        "BOR;FB;HA=L;VA=C;R=1;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(DataSet.InCostRest,    "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(DataSet.InGuaranty,    "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(DataSet.OutCostRest,    "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(DataSet.OutGuaranty,    "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          if(m_RepParams.ShowPlanRest == true)
            m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
            m_rep.Put_Val(DataSet.OutPlanCostRest, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          end;
          m_rep.Put_Str("","END;"); 
        end;
      end;
    END;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str("1.6. Оценка позиций по Производным финансовым инструментам (руб)", m_TitleStyle);
      m_rep.Blank_Line();

      m_Rep.Set_WrapText(1);      
      m_rep.Put_Str("", "START;", 3.9*STR_HEIGHT);
      m_rep.Put_Str("Наименование/Вид договора",                   m_TableHeadStyle+"R=1;");
      m_rep.Put_Str("Код",                                         m_TableHeadStyle);
      m_rep.Put_Str("Входящий остаток, шт. (на начало периода)",   m_TableHeadStyleGreen);
      m_rep.Put_Str("Входящий остаток, руб. (на начало периода)",  m_TableHeadStyleGreen);
      m_rep.Put_Str("Гарантийное обеспечение (на начало периода)", m_TableHeadStyleGreen);
      m_rep.Put_Str("Покупка, шт.",                                m_TableHeadStyle);
      m_rep.Put_Str("Продажа, шт.",                                m_TableHeadStyle);
      m_rep.Put_Str("Исходящий остаток, шт. (на конец периода)",   m_TableHeadStyleYellow);
      m_rep.Put_Str("Исходящий остаток, руб. (на конец периода)",  m_TableHeadStyleYellow);
      m_rep.Put_Str("Гарантийное обеспечение (на конец периода)",  m_TableHeadStyleYellow);
      if(m_RepParams.ShowPlanRest == true)
        m_rep.Put_Str("Плановый остаток, шт.",                     m_TableHeadStyle);
        m_rep.Put_Str("Плановый остаток, руб.",                    m_TableHeadStyle);
      end;
      m_rep.Put_Str("","END;");
    END;

    cmd = DL_RSDCommand();

    query = " select * "
          + "   from dbrkrepactivederiv_tmp "
          + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    query = query + " order by t_FIKind, t_FIName ";
            
    cnt = cmd.GetCount(query);

    if(cnt > 0)
      DataSet = cmd.Execute(query);

      InitProgress(cnt, "Подготовка раздела Оценка позиции", "Оценка позиции по ПФИ");

      PrintHeaderAndCap();

      while(DataSet.moveNext())                            
        m_rep.Put_Str("", "START;", IIF(StrLen(DataSet.FIName) > 14, 3*STR_HEIGHT));
        m_rep.Put_Str(DataSet.FIKind,         "BOR;HA=L;VA=C;R=1;");
        m_rep.Put_Str(DataSet.FIName,         "BOR;HA=L;VA=C;");
        m_rep.Put_Val(DataSet.InRest,         "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.InRest)+";");
        m_rep.Put_Val(DataSet.InCostRest,     "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(DataSet.InGuaranty,     "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(DataSet.Buy,            "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.Buy)+";");
        m_rep.Put_Val(DataSet.Sale,           "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.Sale)+";");
        m_rep.Put_Val(DataSet.OutRest,        "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.OutRest)+";");
        m_rep.Put_Val(DataSet.OutCostRest,    "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(DataSet.OutGuaranty,    "BOR;HA=R;VA=C;T=M2;");
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Val(DataSet.OutPlanRest,     "BOR;HA=C;VA=C;T=M"+AmountPrecision(DataSet.OutPlanRest)+";");
          m_rep.Put_Val(DataSet.OutPlanCostRest, "BOR;HA=R;VA=C;T=M2;");
        end;
        m_rep.Put_Str("","END;");

        UseProgress(i = i + 1);
      end;

      RemProgress();

      PrintItogLines();
      m_rep.Blank_Line();
    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap();
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Печать курсов валют
  */
  PRIVATE MACRO PrintCourses()
    var query, cmd, DataSet;
    var cnt = 0;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str("1.2. Курсы валют/драгоценных металлов", m_TitleStyle);
      m_rep.Blank_Line();

      m_Rep.Set_WrapText(1);
      m_rep.Put_Str("", "START;", 2*STR_HEIGHT);
      m_rep.Put_Str("Валюта/драгоценный металл", m_TableHeadStyle);
      m_rep.Put_Str("Начало периода", m_TableHeadStyle);
      m_rep.Put_Str("Конец периода",  m_TableHeadStyle);
      m_rep.Put_Str("", "END;");
    END;

    cmd = DL_RSDCommand();
      
    query = " select * from dbrkrepcourses_tmp ";

    if(m_DlContrData.ServKind == 0)
      query = query + " where t_ServKindSub <> 9 "; //Кроме внебирж
    else
      query = query + " where t_ServKind = ? "
                    + "   and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind);
      cmd.AddParam(m_DlContrData.ServKindSub);
    end;

    query = query + " order by t_Currency ";

    cnt = cmd.GetCount(query);
          
    if(cnt > 0)
      DataSet = cmd.Execute(query);

      PrintHeaderAndCap();

      while(DataSet.moveNext())
        m_rep.Put_Str("", "START;");
        m_rep.Put_Str(DataSet.CCY, "BOR;HA=L;");
        m_rep.Put_Str(ЧислоCЗаданнойТочностью(DataSet.InRate, DataSet.InPoint),   "BOR;T=N"+DataSet.InPoint+";HA=R;");
        m_rep.Put_Str(ЧислоCЗаданнойТочностью(DataSet.OutRate, DataSet.OutPoint), "BOR;T=N"+DataSet.OutPoint+";HA=R;");
        m_rep.Put_Str("", "END;");
      end;
      m_rep.Blank_Line();

    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap();
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Проверка наличия данных по сделкам фондового рынка
   @param[in] ModeStr строка, содержащая перечисление проверяемых разделов 
   @return 1 - данные есть, 0 - данных нет 
  */
  PRIVATE MACRO ExistsDataForSecurDealByMode(ModeStr:string):integer
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepdeal_tmp "
            + "  where t_IsItog = CHR(0) "
            + "    and t_Part IN ("+ModeStr+")";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  /**
   @brief Проверка наличия данных по сделкам валютного рынка
   @param[in] ModeStr строка, содержащая перечисление проверяемых разделов 
   @return 1 - данные есть, 0 - данных нет 
  */
  PRIVATE MACRO ExistsDataForCurDealByMode(ModeStr:string):integer
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepcurdeal_tmp "
            + "  where t_IsItog = CHR(0) "
            + "    and t_Part IN ("+ModeStr+")";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  /**
   @brief Проверка наличия данных по сделкам срочного рынка
   @param[in] ModeStr строка, содержащая перечисление проверяемых разделов 
   @return 1 - данные есть, 0 - данных нет 
  */
  PRIVATE MACRO ExistsDataForDvDealByMode(ModeStr:string):integer
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepdvdeal_tmp "
            + "  where t_IsItog = CHR(0) "
            + "    and t_Part IN ("+ModeStr+")";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  /**
   @brief Получение наименования раздела отчета по сделкам
   @param[in] Mode раздел
   @param[in] NumStr порядковый номер в формате строки  
   @return наименование раздела 
  */
  PRIVATE MACRO GetPartName(Mode:integer, NumStr:string):string
    var PartStr:string = "";

    if(Mode == BROKERREP_PART_DEALINPERIOD)
      PartStr = NumStr+". Сделки, заключенные в период с "+string(m_RepParams.BegDate:f)+" по "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_REPOINPERIOD)
      PartStr = NumStr+". Сделки РЕПО, заключенные в период с "+string(m_RepParams.BegDate:f)+" по "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_EXECDEAL)
      PartStr = NumStr+". Сделки, заключенные ранее "+string(m_RepParams.BegDate:f);
    elif(Mode == BROKERREP_PART_EXECREPO)
      PartStr = NumStr+". Сделки РЕПО, заключенные ранее "+string(m_RepParams.BegDate:f);
    elif(Mode == BROKERREP_PART_CANCELDEAL)
      PartStr = NumStr+". Сделки, отмененные в период с "+string(m_RepParams.BegDate:f)+" по "+string(m_RepParams.EndDate:f);
    elif(Mode == BROKERREP_PART_CANCELREPO)
      PartStr = NumStr+". Сделки РЕПО, отмененные в период с "+string(m_RepParams.BegDate:f)+" по "+string(m_RepParams.EndDate:f);
    end;

    return PartStr;
  END;

  /**
   @brief Печать раздела по сделкам фондового рынка
   @param[in] Mode раздел
   @param[in] NumStr порядковый номер в формате строки  
  */
  PRIVATE MACRO PrintSecurDealsByMode(Mode:integer, NumStr:string)
     var query, cmd, DataSet;
     var DealData = NULL;
     var cnt = 0;
     var i = 0;

     //Напечатать итоговые строки
     MACRO PrintItogLines()
       var q, Select, ds;

       Select = DL_RSDCommand();

       q =   " select t_Direction, t_A16, t_A17, t_A18, t_A20, t_A27, t_A30 "
           + "   from dbrkrepdeal_tmp  "
           + "  where t_Part = ? "
           + "    and t_IsItog = 'X' ";
       
       Select.AddParam(Mode);

       if(m_DlContrData.ServKind() != 0)
         q = q + " and t_ServKind = ? "
               + " and t_ServKindSub = ? ";

         Select.AddParam(m_DlContrData.ServKind());
         Select.AddParam(m_DlContrData.ServKindSub());
       else
         q = q + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
       end;

       if(m_DlContrData.MarketID() > 0)
         q = q + " and t_MarketID = ? ";
         Select.AddParam(m_DlContrData.MarketID())
       end;

       q = q + " order by t_A30, t_Direction ";

       if(Select.GetCount(q))
         ds = Select.Execute(q);

         m_Rep.Set_WrapText(1);
         while(ds.moveNext())
           m_rep.Put_Str("", "START;", STR_HEIGHT);           
           m_rep.Put_Str("Итого "+IIF(ds.Direction == DIRECTION_BUY, "покупок", "продаж")+" в " + ds.A30, "BOR;FB;HA=L;VA=C;R=1;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           if((Mode == BROKERREP_PART_REPOINPERIOD) OR (Mode == BROKERREP_PART_EXECREPO) OR (Mode == BROKERREP_PART_CANCELREPO))
             m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           end;
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A16, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A17, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A18, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A20, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(ds.A27, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("",     "BOR;FB;P=C;IC="+m_ItogCellColor+";");

           m_rep.Put_Str("","END;");
         end;
       end;
     END;

     // Печать заголовка и шапки таблицы
     MACRO PrintHeaderAndCap()
       m_Rep.Set_WrapText(0);
       m_rep.Put_Str("", "START;", STR_HEIGHT);
       m_rep.Put_Str(GetPartName(Mode, NumStr), m_TitleStyle);
       m_rep.Blank_Line();

       m_Rep.Set_WrapText(1);
       m_rep.Put_Str("", "START;", 3.9*STR_HEIGHT);
       m_rep.Put_Str("Дата и время заключения сделки", m_TableHeadStyle);
       m_rep.Put_Str("Дата исполнения сделки",         m_TableHeadStyle);
       m_rep.Put_Str("Торговая площадка",              m_TableHeadStyle);
       m_rep.Put_Str("Вид сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Эмитент",                        m_TableHeadStyle);
       m_rep.Put_Str("Вид ЦБ",                         m_TableHeadStyle);
       m_rep.Put_Str("ISIN/Гос. рег. номер выпуска",   m_TableHeadStyle);
       m_rep.Put_Str("Цена заявки",                    m_TableHeadStyle);
       m_rep.Put_Str("Цена сделки",                    m_TableHeadStyle);
       if((Mode == BROKERREP_PART_REPOINPERIOD) OR (Mode == BROKERREP_PART_EXECREPO) OR (Mode == BROKERREP_PART_CANCELREPO))
         m_rep.Put_Str("Ставка РЕПО",                    m_TableHeadStyle);
       end;
       m_rep.Put_Str("Валюта сделки",                  m_TableHeadStyle);
       m_rep.Put_Str("Количество бумаг",               m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки",                   m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки в руб.",            m_TableHeadStyle);
       m_rep.Put_Str("Комиссия брокера",               m_TableHeadStyle);
       m_rep.Put_Str("Валюта комиссии брокера",        m_TableHeadStyle);
       m_rep.Put_Str("Комиссия, компенс. биржевые сборы, в руб.", m_TableHeadStyle);
       m_rep.Put_Str("Сумма НКД",                      m_TableHeadStyle);
       m_rep.Put_Str("Сумма НКД в руб.",               m_TableHeadStyle);
       m_rep.Put_Str("Тип сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Номер в ТС",                     m_TableHeadStyle);
       m_rep.Put_Str("Контрагент",                     m_TableHeadStyle);
       m_rep.Put_Str("Обязательство по ДС",            m_TableHeadStyle);
       m_rep.Put_Str("Обязательство по ЦБ",            m_TableHeadStyle);
       m_rep.Put_Str("Примечание",                     m_TableHeadStyle);

       m_rep.Put_Str("","END;");
     END;

     cmd = DL_RSDCommand();
     
     query =   " select d.* "
             + "   from dbrkrepdeal_tmp d"
             + "  where d.t_Part = ? "
             + "    and d.t_IsItog = CHR(0) ";
     
     cmd.AddParam(Mode);

     if(m_DlContrData.ServKind() != 0)
       query = query + " and d.t_ServKind = ? "
                     + " and d.t_ServKindSub = ? ";

       cmd.AddParam(m_DlContrData.ServKind());
       cmd.AddParam(m_DlContrData.ServKindSub());
     else
       query = query + " and d.t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
     end;

     if(m_DlContrData.MarketID() > 0)
       query = query + " and d.t_MarketID = ? ";
       cmd.AddParam(m_DlContrData.MarketID())
     end;

     query = query + " order by d.t_A05_D, d.t_A05_T, d.t_A08, d.t_A10";

     cnt = cmd.GetCount(query);

     if(cnt)
       DealData = cmd.Execute(query);

       InitProgress(cnt, "Подготовка разделов отчета", "Сделки"+IIF(((Mode == BROKERREP_PART_REPOINPERIOD) or (Mode == BROKERREP_PART_EXECREPO) or (Mode == BROKERREP_PART_CANCELREPO)), " РЕПО", "")+", заключенные на Фондовом рынке");

       PrintHeaderAndCap();

       while(DealData.moveNext())
         m_rep.Put_Str("", "START;", 3*STR_HEIGHT);

         m_rep.Put_Str(string(date(DealData.A05_D):f) + " " + string(time(DealData.A05_T)), "BOR;P=C;");/* Дата и время заключения сделки */
         m_rep.Put_Val(date(DealData.A06), "BOR;P=C;T=D;");						/* Дата исполнения сделки */		
         m_rep.Put_Str(DealData.A09,       "BOR;P=C;");							/* Торговая площадка */
         m_rep.Put_Str(DealData.A10,       "BOR;P=C;");							/* Вид сделки */
         m_rep.Put_Str(DealData.A11,       "BOR;P=C;");							/* Эмитент */
         m_rep.Put_Str(DealData.A25,       "BOR;P=C;");                                                 /* Вид ЦБ */
         m_rep.Put_Str(DealData.A12,       "BOR;P=C;");                                                 /* ISIN/Гос. рег. номер выпуска */
         // Цена заявки
         if(ValType(DealData.A95) != V_UNDEF) 
           m_rep.Put_Val(DealData.A95,     "BOR;HA=R;VA=C;T=N4;");
         else
           m_rep.Put_Str("",               "BOR;P=C;");
         end;
         // Цена сделки
         if(ValType(DealData.A13) != V_UNDEF)
           m_rep.Put_Val(DealData.A13,     "BOR;HA=R;VA=C;T=N4;");
         else
           m_rep.Put_Str("",               "BOR;P=C;");
         end;
         // Ставка РЕПО
         if((Mode == BROKERREP_PART_REPOINPERIOD) OR (Mode == BROKERREP_PART_EXECREPO) OR (Mode == BROKERREP_PART_CANCELREPO))
           m_rep.Put_Val(DealData.A13_i,     "BOR;HA=R;VA=C;T=N4;");
         end;
         m_rep.Put_Str(DealData.A14,       "BOR;P=C;");							/* Валюта сделки */
         m_rep.Put_Val(DealData.A15,       "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A15)+";");	/* Количество бумаг */
         m_rep.Put_Val(DealData.A16,       "BOR;HA=R;VA=C;T=M2;");					/* Сумма сделки */
         m_rep.Put_Val(DealData.A17,       "BOR;HA=R;VA=C;T=M2;");					/* Сумма сделки в рублях */
         m_rep.Put_Val(DealData.A18,       "BOR;HA=R;VA=C;T=M2;");					/* Комиссия брокера */
         m_rep.Put_Str(DealData.A19,       "BOR;P=C;");							/* Валюта комиссии брокера */
         m_rep.Put_Val(DealData.A20,       "BOR;HA=R;VA=C;T=M2;");					/* Комиссия, компенсирующая биржевые сборы, в рублях */
         // Сумма НКД
         if(ValType(DealData.A26) != V_UNDEF)
           m_rep.Put_Val(DealData.A26,     "BOR;HA=R;VA=C;T=M2;");
         else
           m_rep.Put_Val(" ",              "BOR;P=C;");
         end;
         m_rep.Put_Val(DealData.A27,       "BOR;HA=R;VA=C;T=M2;");					/* Сумма НКД в рублях */
         m_rep.Put_Str(DealData.A23,       "BOR;P=C;");							/* Тип сделки */
         m_rep.Put_Str(DealData.A08,       "BOR;P=C;");							/* Номер в ТС */
         m_rep.Put_Str(DealData.A24,       "BOR;P=C;");							/* Контрагент */
         m_rep.Put_Val(DealData.A28,       "BOR;HA=R;VA=C;T=M2;");					/* Обязательство по ДС */
         m_rep.Put_Val(DealData.A29,       "BOR;HA=R;VA=C;T=M"+AmountPrecision(DealData.A29)+";");	/* Обязательство по ЦБ */
         m_rep.Put_Val(DealData.A95_M,     "BOR;P=C;");							/* Примечание */

         m_rep.Put_Str("", "END;");

         UseProgress(i = i + 1);
       end;

       RemProgress();

       PrintItogLines();
       m_rep.Blank_Line();
     elif(m_RepParams.ShowEmpty)
       PrintHeaderAndCap();
       m_rep.Blank_Line();
     end;
  END;

  /**
   @brief Печать раздела по сделкам валютного рынка
   @param[in] Mode раздел
   @param[in] NumStr порядковый номер в формате строки  
  */
  PRIVATE MACRO PrintCurrDealsByMode(Mode:integer, NumStr:string)
     var query, cmd;
     var DealData = NULL;
     var cnt = 0;
     var i = 0;

     //Напечатать итоговые строки
     MACRO PrintItogLines()
       cmd = DL_RSDCommand();

       query =   " select t_ConcDate, t_ContrSumRub, t_BrokerComissRub, t_MarketComiss "
               + "   from dbrkrepcurdeal_tmp "
               + "  where t_Part = ? "
               + "    and t_IsItog = 'X' ";
       
       cmd.AddParam(Mode);

       if(m_DlContrData.ServKind() != 0)
         query = query + " and t_ServKind = ? "
                       + " and t_ServKindSub = ? ";

         cmd.AddParam(m_DlContrData.ServKind());
         cmd.AddParam(m_DlContrData.ServKindSub());
       else
         query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
       end;

       if(m_DlContrData.MarketID() > 0)
         query = query + " and t_MarketID = ? ";
         cmd.AddParam(m_DlContrData.MarketID())
       end;

       if(cmd.GetCount(query))
         DealData = cmd.Execute(query);

         m_Rep.Set_WrapText(1);
         while(DealData.moveNext())
           m_rep.Put_Str("", "START;", STR_HEIGHT);           
           m_rep.Put_Str(DealData.ConcDate,        "BOR;FB;HA=L;VA=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(DealData.ContrSumRub,     "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";R=1;");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(DealData.BrokerComissRub, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(DealData.MarketComiss,    "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";R=1;");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";R=1;");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "END;"); 
         end;
       end;
     END;

     // Печать заголовка и шапки таблицы
     MACRO PrintHeaderAndCap()
       m_Rep.Set_WrapText(0);
       m_rep.Put_Str("", "START;", STR_HEIGHT);
       m_rep.Put_Str(GetPartName(Mode, NumStr), m_TitleStyle);
       m_rep.Blank_Line();

       m_Rep.Set_WrapText(1);
       m_rep.Put_Str("", "START;", 3.9*STR_HEIGHT);
       m_rep.Put_Str("Дата и время заключения сделки", m_TableHeadStyle);
       m_rep.Put_Str("Дата исполнения сделки",         m_TableHeadStyle);
       m_rep.Put_Str("Торговая площадка",              m_TableHeadStyle);
       m_rep.Put_Str("Вид сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Инструмент",                     m_TableHeadStyle);
       m_rep.Put_Str("Объем сделки",                   m_TableHeadStyle);
       m_rep.Put_Str("Цена заявки",                    m_TableHeadStyle);
       m_rep.Put_Str("Цена сделки",                    m_TableHeadStyle);
       m_rep.Put_Str("Валюта инструмента",             m_TableHeadStyle);
       m_rep.Put_Str("Валюта расчетов",                m_TableHeadStyle);
       m_rep.Put_Str("Объем валюты инструмента",       m_TableHeadStyle);
       m_rep.Put_Str("Сумма в валюте расчетов",        m_TableHeadStyle);
       m_rep.Put_Str("Сумма расчетов в руб. (по курсу ЦБ на дату заключения)", m_TableHeadStyle+"R=1;");
       m_rep.Put_Str("Комиссия брокера в валюте расчетов", m_TableHeadStyle);
       m_rep.Put_Str("Комиссия брокера в руб.",        m_TableHeadStyle);
       m_rep.Put_Str("Комиссия, компенс. биржевые сборы, в руб.", m_TableHeadStyle);
       m_rep.Put_Str("Номер в ТС",                     m_TableHeadStyle);
       m_rep.Put_Str("Тип сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Контрагент",                     m_TableHeadStyle);
       m_rep.Put_Str("Обязательства в валюте сделки",  m_TableHeadStyle+"R=1;");
       m_rep.Put_Str("Обязательства в валюте расчетов",m_TableHeadStyle+"R=1;");
       m_rep.Put_Str("Примечание",		       m_TableHeadStyle);
       m_rep.Put_Str("", "END;");
     END;

     cmd = DL_RSDCommand();
     
     query =   " select * "
             + "   from dbrkrepcurdeal_tmp "
             + "  where t_Part = ? "
             + "    and t_IsItog = CHR(0) ";
     
     cmd.AddParam(Mode);

     if(m_DlContrData.ServKind() != 0)
       query = query + " and t_ServKind = ? "
                     + " and t_ServKindSub = ? ";

       cmd.AddParam(m_DlContrData.ServKind());
       cmd.AddParam(m_DlContrData.ServKindSub());
     else
       query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
     end;

     if(m_DlContrData.MarketID() > 0)
       query = query + " and t_MarketID = ? ";
       cmd.AddParam(m_DlContrData.MarketID())
     end;

     query = query + " order by t_DealID ";

     cnt = cmd.GetCount(query);

     if(cnt)
       DealData = cmd.Execute(query);

       InitProgress(cnt, "Подготовка разделов отчета", "Сделки, заключенные на Валютном рынке");

       PrintHeaderAndCap();

       while(DealData.moveNext())
         m_rep.Put_Str("", "START;");

         m_rep.Put_Str(DealData.ConcDate,          "BOR;P=C;");            /*Дата и время заключения сделки*/
         m_rep.Put_Str(string(date(DealData.ExecDate):f), "BOR;P=C;T=D;"); /*Дата исполнения сделки*/
         m_rep.Put_Str(DealData.MarketPlace,       "BOR;P=C;");            /*Торговая площадка*/
         m_rep.Put_Str(DealData.DealKind,          "BOR;P=C;");            /*Вид сделки*/
         m_rep.Put_Str(DealData.Instrument,        "BOR;P=C;");            /*Инструмент*/
         m_rep.Put_Val(DealData.Volume,            "BOR;HA=R;VA=C;T=M2;"); /*Объем сделки*/
         /*Цена заявки*/
         if(ValType(DealData.ReqPrice) != V_UNDEF)
           m_rep.Put_Val(DealData.ReqPrice,        "BOR;HA=R;VA=C;T=M4;");
         else 
           m_rep.Put_Str("",                       "BOR;P=C;");
         end;
         m_rep.Put_Val(DealData.Price,             "BOR;HA=R;VA=C;T=M4;"); /*Цена сделки*/
         m_rep.Put_Str(DealData.BaseCurr,          "BOR;P=C;");            /*Валюта сделки*/
         m_rep.Put_Str(DealData.ContrCurr,         "BOR;P=C;");            /*Валюта расчетов*/
         m_rep.Put_Val(DealData.BaseSum,           "BOR;HA=R;VA=C;T=M2;"); /*Сумма в валюте сделки*/
         m_rep.Put_Val(DealData.ContrSum,          "BOR;HA=R;VA=C;T=M2;"); /*Сумма в валюте расчетов*/
         m_rep.Put_Val(DealData.ContrSumRub,       "BOR;HA=R;VA=C;T=M2;R=1;"); /*Сумма расчетов в рублях (по курсу ЦБ на дату заключения)*/
         m_rep.Put_Val(DealData.BrokerComissContr, "BOR;HA=R;VA=C;T=M2;"); /*Комиссия брокера в валюте расчетов*/
         m_rep.Put_Val(DealData.BrokerComissRub,   "BOR;HA=R;VA=C;T=M2;"); /*Комиссия брокера в рублях*/
         m_rep.Put_Val(DealData.MarketComiss,      "BOR;HA=R;VA=C;T=M2;"); /*Комиссия, компенсирующая биржевые сборы, в рублях*/
         m_rep.Put_Str(DealData.CodeTS,            "BOR;P=C;");            /*Номер в ТС*/
         m_rep.Put_Str(DealData.DealType,          "BOR;P=C;");            /*Тип сделки*/
         m_rep.Put_Str(DealData.Contractor,        "BOR;P=C;");            /*Контрагент*/
         m_rep.Put_Val(DealData.LiabilityBase,     "BOR;HA=R;VA=C;T=M2;R=1;"); /*Обязательства в валюте сделки*/
         m_rep.Put_Val(DealData.LiabilityContr,    "BOR;HA=R;VA=C;T=M2;R=1;"); /*Обязательства в валюте расчетов*/
         m_rep.Put_Str(DealData.Note,              "BOR;P=C;");            /*Примечание*/

         m_rep.Put_Str("", "END;");

         UseProgress(i = i + 1);
       end;

       RemProgress();

       PrintItogLines();
       m_rep.Blank_Line();
     elif(m_RepParams.ShowEmpty)
       PrintHeaderAndCap();
       m_rep.Blank_Line();
     end;
  END; // PrintCurrDealsByMode

  /**
   @brief Печать раздела по сделкам срочного рынка
   @param[in] Mode раздел
   @param[in] NumStr порядковый номер в формате строки  
  */
  PRIVATE MACRO PrintDvDealsByMode(Mode:integer, NumStr:string)
    var query, cmd;
    var DealData = NULL;
    var cnt = 0;
    var i = 0;

    //Напечатать итоговые строки
    MACRO PrintItogLines()
       cmd = DL_RSDCommand();

       query =   " select t_ConcDate, t_DealSumRub, t_MarginRub, t_BrokerComissRub, t_MarketComiss "
               + "   from dbrkrepdvdeal_tmp "
               + "  where t_Part = ? "
               + "    and t_IsItog = 'X' ";
       
       cmd.AddParam(Mode);

       if(m_DlContrData.ServKind() != 0)
         query = query + " and t_ServKind = ? "
                       + " and t_ServKindSub = ? ";

         cmd.AddParam(m_DlContrData.ServKind());
         cmd.AddParam(m_DlContrData.ServKindSub());
       else
         query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
       end;

       if(m_DlContrData.MarketID() > 0)
         query = query + " and t_MarketID = ? ";
         cmd.AddParam(m_DlContrData.MarketID())
       end;

       if(cmd.GetCount(query))
         DealData = cmd.Execute(query);

         m_Rep.Set_WrapText(1);
         while(DealData.moveNext())
           m_rep.Put_Str("", "START;", STR_HEIGHT);           
           m_rep.Put_Str(DealData.ConcDate,        "BOR;FB;HA=L;VA=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";R=1;");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(DealData.DealSumRub,      "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(DealData.MarginRub,       "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(DealData.BrokerComissRub, "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Val(DealData.MarketComiss,    "BOR;FB;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";R=1;");
           m_rep.Put_Str("", "BOR;FB;P=C;IC="+m_ItogCellColor+";");
           m_rep.Put_Str("","END;"); 
         end;
       end;
    END;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
       m_Rep.Set_WrapText(0);
       m_rep.Put_Str("", "START;", STR_HEIGHT);
       m_rep.Put_Str(GetPartName(Mode, NumStr), m_TitleStyle);
       m_rep.Blank_Line();

       m_Rep.Set_WrapText(1);
       m_rep.Put_Str("", "START;", 3.9*STR_HEIGHT);
       m_rep.Put_Str("Дата и время заключения сделки", m_TableHeadStyle);
       m_rep.Put_Str("Дата расчётов по сделке",        m_TableHeadStyle);
       m_rep.Put_Str("Место заключения сделки",        m_TableHeadStyle);
       m_rep.Put_Str("Вид сделки",                     m_TableHeadStyle);
       m_rep.Put_Str("Вид контракта",                  m_TableHeadStyle);
       m_rep.Put_Str("Контракт",                       m_TableHeadStyle);
       m_rep.Put_Str("Цена заявки",                    m_TableHeadStyle);
       m_rep.Put_Str("Цена одного фьючерсного контракта (размер премии по опциону)", m_TableHeadStyle+"R=1;");
       m_rep.Put_Str("Цена исполнения по опциону",     m_TableHeadStyle);
       m_rep.Put_Str("Кол-во",                         m_TableHeadStyle);
       m_rep.Put_Str("Сумма сделки, руб.",             m_TableHeadStyle);
       m_rep.Put_Str("Вариационная маржа, руб.",       m_TableHeadStyle);
       m_rep.Put_Str("Комиссия брокера, руб",          m_TableHeadStyle);
       m_rep.Put_Str("Комиссия, компенс. биржевые сборы, руб.", m_TableHeadStyle);
       m_rep.Put_Str("№ сделки",                       m_TableHeadStyle+"R=1;");
       m_rep.Put_Str("Примечание",                     m_TableHeadStyle);
       m_rep.Put_Str("", "END;");
    END;

    cmd = DL_RSDCommand();
    
    query =   " select * "
            + "   from dbrkrepdvdeal_tmp "
            + "  where t_Part = ? "
            + "    and t_IsItog = CHR(0) ";
    
    cmd.AddParam(Mode);

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    if(m_DlContrData.MarketID() > 0)
      query = query + " and t_MarketID = ? ";
      cmd.AddParam(m_DlContrData.MarketID())
    end;

    query = query + " order by t_DealID ";

    cnt = cmd.GetCount(query);

    if(cnt)
       DealData = cmd.Execute(query);

       InitProgress(cnt, "Подготовка разделов отчета", "Сделки, заключенные на Срочном рынке");

       PrintHeaderAndCap();

       while(DealData.moveNext())
          m_rep.Put_Str("", "START;", IIF(((DealData.Note != "") or (StrLen(DealData.FIName) > 14)), 3*STR_HEIGHT));

          m_rep.Put_Str(DealData.ConcDate,            "BOR;P=C;");            /*Дата и время заключения сделки*/
          m_rep.Put_Val(date(DealData.ClrDate),       "BOR;P=C;T=D;");        /*Дата расчётов по сделке*/
          m_rep.Put_Str(DealData.MarketPlace,         "BOR;P=C;");            /*Место заключения сделки*/
          m_rep.Put_Str(DealData.DealKind,            "BOR;P=C;");            /*Вид сделки*/
          m_rep.Put_Str(DealData.FIKind,              "BOR;P=C;");            /*Вид контракта*/
          m_rep.Put_Str(DealData.FIName,              "BOR;P=C;");            /*Контракт*/
          /*Цена заявки*/
          if(ValType(DealData.ReqPrice) != V_UNDEF)
            m_rep.Put_Val(DealData.ReqPrice,          "BOR;HA=R;VA=C;T=M4;");
          else 
            m_rep.Put_Str("",                         "BOR;P=C;");
          end;
          m_rep.Put_Val(DealData.PriceFuturesOrBonus, "BOR;HA=R;VA=C;T=M4;R=1;"); /*Цена одного фьючерсного контракта (размер премии по опциону)*/
          /*Цена исполнения по опциону*/
          if(ValType(DealData.PriceOption) != V_UNDEF)
            m_rep.Put_Val(DealData.PriceOption,       "BOR;HA=R;VA=C;T=M4;");
          else 
            m_rep.Put_Str("",                         "BOR;P=C;");
          end;
          m_rep.Put_Val(DealData.Amount,              "BOR;HA=R;VA=C;T=M2;"); /*Кол-во*/
          m_rep.Put_Val(DealData.DealSumRub,          "BOR;HA=R;VA=C;T=M2;"); /*Сумма сделки, руб.*/
          m_rep.Put_Val(DealData.MarginRub,           "BOR;HA=R;VA=C;T=M2;"); /*Вариационная маржа, руб.*/
          m_rep.Put_Val(DealData.BrokerComissRub,     "BOR;HA=R;VA=C;T=M2;"); /*Комиссия брокера, руб*/ 
          m_rep.Put_Val(DealData.MarketComiss,        "BOR;HA=R;VA=C;T=M2;"); /*Комиссия, компенсирующая биржевые сборы, руб.*/
          m_rep.Put_Str(DealData.Code,                "BOR;P=C;R=1;");        /*№ сделки*/ 
          m_rep.Put_Str(DealData.Note,                "BOR;P=C;");            /*Примечание*/

          m_rep.Put_Str("","END;");

          UseProgress(i = i + 1);
       end;

       RemProgress();

       PrintItogLines();
       m_rep.Blank_Line();
     elif(m_RepParams.ShowEmpty)
       PrintHeaderAndCap();
       m_rep.Blank_Line();
     end;
  END; // PrintDvDeals

  /**
   @brief Проверка наличия данных по составу портфеля
   @return 1 - данные есть, 0 - данных нет 
  */
  PRIVATE MACRO ExistsPortfData():integer
    var query, cmd;

    cmd = DL_RSDCommand();

    query =   " select 1 "
            + "   from dbrkrepinacc_tmp "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    query = query + " and rownum = 1";

    return cmd.GetCount(query);
  END;

  /**
   @brief Печать данных по составу портфеля
  */
  PRIVATE MACRO PrintPortfData(NumStr:string)
    var query, cmd, DataSet;
    var InAccData = NULL;
    var prevPlaceID = NULL;
    var cnt = 0, i = 0;
    var PlaceName = "";
    var CurParams:string = "";
    var height:integer = 1;

    PRIVATE MACRO ТекущиеПараметры(FIID, dt)
      var cmd = DL_RSDCommand(
                            " select 'купон '||case when fiwarnts.t_relativeincome = chr(88) "
                            + "                      then trim(to_char(fiwarnts.t_incomerate,'99999999999999999990.'||lpad('0',fiwarnts.t_incomepoint,'9'))) "
                            + "                      else trim(to_char(fiwarnts.t_incomevolume,'99999999999999999990.'||lpad('0',fiwarnts.t_incomepoint,'9')))||' '||nvl(fininstr.t_ccy,'?') "
                            + "                 end "

                            + "               ||case when dininstrp.t_drawingdate != to_date('01.01.0001','dd.mm.yyyy') "
                            + "                      then ' дата погашения '||to_char(dininstrp.t_drawingdate,'dd.mm.yyyy') "
                            + "                      else '' "
                            + "                 end " 

                            + "               || ' номинал '||case when RSB_FIINSTR.FI_GETNOMINALONDATE(d.t_fiid,?) > 0 then RSB_FIINSTR.FI_GETNOMINALONDATE(d.t_fiid,?) else dininstrp.t_facevalue end " /*CHVA 525951*/ 

                            + "               ||' '|| (select (select t_ccy from dfininstr_dbt where t_fiid = f.t_facevaluefi) from dfininstr_dbt f where f.t_fiid = d.t_fiid) t_cupon "
                            + "from dfiwarnts_dbt fiwarnts "
                            + "left join dfininstr_dbt fininstr on fininstr.t_fiid = fiwarnts.t_incomefi "
                            + "join (select t_fiid, t_id "
                            + "      from (select fiwarnts.t_fiid, fiwarnts.t_id "
                            + "            from dfiwarnts_dbt fiwarnts "
                            + "            where fiwarnts.t_fiid = ? and "
                            + "                  fiwarnts.t_drawingdate >= ? "
                            + "            order by fiwarnts.t_drawingdate, fiwarnts.t_id desc) "
                            + "      where rownum = 1) d on rsi_rsb_fiinstr.FI_IsCouponAvoiriss(d.t_fiid) = 1 and "
                            + "                             fiwarnts.t_id = d.t_id "
                            + "join dfininstr_dbt dininstrp on dininstrp.t_fiid = d.t_fiid"
                            + " left join dobjcode_dbt o  on t_objecttype = 9 and t_codekind = 104 and t_objectid = d.t_fiid "
                           ); 
      cmd.AddParam(dt);  /*CHVA 525951*/ 
      cmd.AddParam(dt);
      cmd.AddParam(FIID);
      cmd.AddParam(dt);
      var dataSet = cmd.Execute();
      if(dataSet.movenext())
        return dataSet.cupon;
      else
        cmd = DL_RSDCommand("select 'дата погашения '||to_char(fininstr.t_drawingdate,'dd.mm.yyyy') "
                            + "               || ' номинал '||case when RSB_FIINSTR.FI_GETNOMINALONDATE(fininstr.t_fiid,?) > 0 then RSB_FIINSTR.FI_GETNOMINALONDATE(fininstr.t_fiid,?) else fininstr.t_facevalue end " /*PNV 511546*/ 
                            + "               ||' '|| (select (select t_ccy from dfininstr_dbt where t_fiid = f.t_facevaluefi) from dfininstr_dbt f where f.t_fiid = fininstr.t_fiid) "
                            + "  t_cupon "
                          + "from dfininstr_dbt fininstr "
                          + "where fininstr.t_fiid = ? and "
                          + "      fininstr.t_drawingdate != to_date('01.01.0001','dd.mm.yyyy')");
        cmd.AddParam(dt);
        cmd.AddParam(dt);  /*PNV 511546*/ 
        cmd.AddParam(FIID);
        dataSet = cmd.Execute();
        if(dataSet.movenext())
          return dataSet.cupon;
        else
          return "";
        end;
      end;
    END;

    //Напечатать итоговые строки
    MACRO PrintItogLines()
      var q, Select, ds;
      
      Select = DL_RSDCommand();
      
      q =   " select t_A61, t_A63 "
          + "   from dbrkrepinacc_tmp  "
          + "  where t_IsItog = 'X' ";

      if(m_DlContrData.ServKind() != 0)
        q = q + " and t_ServKind = ? "
              + " and t_ServKindSub = ? ";

        Select.AddParam(m_DlContrData.ServKind());
        Select.AddParam(m_DlContrData.ServKindSub());
      else
        q = q + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
      end;

      if(m_DlContrData.MarketID() > 0)
        q = q + " and t_MarketID = ? ";
        Select.AddParam(m_DlContrData.MarketID())
      end;

      if(Select.GetCount(q))
        ds = Select.Execute(q);
        
        m_Rep.Set_WrapText(1);
        while(ds.moveNext())
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str("Итого в RUB", "BOR;P=C;FB;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;R=1;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          if(m_RepParams.ShowPlanRest == true)
            m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          end;
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(ds.A61,   "BOR;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");
          m_rep.Put_Str("",       "BOR;P=C;IC="+m_ItogCellColor+";");
          m_rep.Put_Val(ds.A63,   "BOR;HA=R;VA=C;T=M2;IC="+m_ItogCellColor+";");

          m_rep.Put_Str("","END;");
        end;
      end;
    END;

    // Печать заголовка и шапки таблицы
    MACRO PrintHeaderAndCap()
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str(NumStr+". Состав портфеля по итогам торгов с "+string(m_RepParams.BegDate:f)+" по "+string(m_RepParams.EndDate:f), m_TitleStyle);
      m_rep.Blank_Line();
    
      m_Rep.Set_WrapText(1);
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str("Отчет/Выписка о движении по счету: Счет/Раздел счета ДЕПО: ", "HA=L;R=3;");
      if((m_DlContrData.DepoAcc() != "") or (m_DlContrData.DepoPart() != ""))
        m_rep.Put_Str(m_DlContrData.DepoAcc()+"/"+m_DlContrData.DepoPart(), "HA=L;R=3;END;");
      else
        m_rep.Put_Str("", "HA=L;R=3;END;");
      end;
    
      m_rep.Put_Str("", "START;", 3*STR_HEIGHT);
      m_rep.Put_Str("Номер гос. регистрации/ISIN", m_TableHeadStyle);
      m_rep.Put_Str("Выпуск ЦБ",                   m_TableHeadStyle+"R=1;");
      m_rep.Put_Str("Текущие параметры",           m_TableHeadStyle);
      m_rep.Put_Str("Остаток входящий",            m_TableHeadStyle);
      m_rep.Put_Str("Зачислено",                   m_TableHeadStyle);
      m_rep.Put_Str("Списано",                     m_TableHeadStyle);
      m_rep.Put_Str("Остаток исходящий",           m_TableHeadStyle);
      if(m_RepParams.ShowPlanRest == true)
        m_rep.Put_Str("Остаток исходящий (ПЛАНОВЫЙ)", m_TableHeadStyle);
      end;
      m_rep.Put_Str("Котировка",                   m_TableHeadStyle);
      m_rep.Put_Str("Валюта котировки",            m_TableHeadStyle);
      m_rep.Put_Str("Стоимость (6*"+IIF(m_RepParams.ShowPlanRest == true, "8","7")+")", m_TableHeadStyle);
      m_rep.Put_Str("Стоимость в руб.",            m_TableHeadStyle);
      m_rep.Put_Str("НКД",                         m_TableHeadStyle);
      m_rep.Put_Str("НКД в руб.",                  m_TableHeadStyle);
      m_rep.Put_Str("","END;");
    END;

    cmd = DL_RSDCommand();

    query =   " select t_FIID, t_A53, t_A54, t_A55, t_A56, t_A56_1, t_A57, t_A57_1, t_A58, t_A58_1, t_A59, t_A60, t_A61, t_A62, t_A63, "
            + "   NVL((select fin59.t_CCY from dfininstr_dbt fin59 where fin59.t_FIID = t_A59_1), CHR(1)) t_A59_CCY "
            + "   from dbrkrepinacc_tmp "
            + "  where t_IsItog = CHR(0) ";

    if(m_DlContrData.ServKind() != 0)
      query = query + " and t_ServKind = ? "
                    + " and t_ServKindSub = ? ";

      cmd.AddParam(m_DlContrData.ServKind());
      cmd.AddParam(m_DlContrData.ServKindSub());
    else
      query = query + " and t_ServKindSub <> 9 "; //Для ЕДП без внебиржи
    end;

    if(m_DlContrData.MarketID() > 0)
      query = query + " and t_MarketID = ? ";
      cmd.AddParam(m_DlContrData.MarketID())
    end;

    cnt = cmd.GetCount(query);

    if(cnt)
      InAccData = cmd.Execute(query);

      InitProgress(cnt, "Подготовка раздела", "Состав портфеля по итогам торгов");

      PrintHeaderAndCap();

      while(InAccData.moveNext())
        CurParams = ТекущиеПараметры(InAccData.FIID, m_RepParams.EndDate);
        height = IIF(((StrLen(InAccData.A53) > 16) or (StrLen(CurParams) > 13)), max(int(StrLen(InAccData.A53)/16) + 1, int(StrLen(CurParams)/13) + 1), 1);
        m_rep.Put_Str("","START;", height*STR_HEIGHT);

        m_rep.Put_Str(InAccData.A53,   "BOR;P=C;");
        m_rep.Put_Str(InAccData.A54,   "BOR;P=C;R=1;");
        m_rep.Put_Str(CurParams,       "BOR;P=C;");
        m_rep.Put_Val(InAccData.A55,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A55)+";");
        m_rep.Put_Val(InAccData.A56,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A56)+";");
        m_rep.Put_Val(InAccData.A57,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A57)+";");
        m_rep.Put_Val(InAccData.A58,   "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A58)+";");
        if(m_RepParams.ShowPlanRest == true)
          m_rep.Put_Val(InAccData.A58_1, "BOR;HA=R;VA=C;T=M"+AmountPrecision(InAccData.A58_1)+";");
        end;
        m_rep.Put_Val(InAccData.A59,   "BOR;HA=R;VA=C;T=N4;");
        m_rep.Put_Str(InAccData.A59_CCY, "BOR;P=C;");
        m_rep.Put_Val(InAccData.A60,   "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(InAccData.A61,   "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(InAccData.A62,   "BOR;HA=R;VA=C;T=M2;");
        m_rep.Put_Val(InAccData.A63,   "BOR;HA=R;VA=C;T=M2;");

        m_rep.Put_Str("","END;");

        UseProgress(i = i + 1);
      end;

      RemProgress();

      PrintItogLines();
      m_rep.Blank_Line();
    elif(m_RepParams.ShowEmpty)
      PrintHeaderAndCap();
      m_rep.Blank_Line();
    end;
  END;

  /**
   @brief Печать подвала отчета
   @param[in] mode     модификатор печати
   @param[in] count    номер раздела, после которого осуществляется печать  
   @param[in] SheetNum номер страницы  
  */
  MACRO AddStandardFooter(mode, count:integer, SheetNum)
     MACRO Операционист():string
       var cmd = DL_RSDCommand("SELECT RSB_BRKREP_RSHB_NEW.GetSignerName(?) SignerName FROM dual ");
       cmd.AddParam(m_repparams.SignerParty);

       var RS = cmd.Execute();
       if( RS.MoveNext() )
          return RS.SignerName;
       end;
       return "";
     END;

     var STAMPTagName = String("STAMP__", SheetNum);
     var SIGNTagName = String("SIGN_1__", SheetNum);

     if(valtype(mode) == V_UNDEF)
       mode = 0;
     end;

     m_rep.Set_WrapText(0);

     if(mode == 0)
       m_rep.Blank_Line();

       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("Подпись1", "FC=W;END;CN="+SIGNTagName+";");

       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   Исполнитель: " + Операционист(),"START;HA=L;VA=C;END;", STR_HEIGHT);
       m_rep.Put_Str("   М.П.", "START;HA=L;VA=C;END;", STR_HEIGHT);/*CHVA 515949*/

       m_rep.Blank_Line();
       m_rep.Put_Str("", "START");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("", "");
       m_rep.Put_Str("Печать", "FC=W;END;CN="+STAMPTagName+";");

       m_rep.Blank_Line();

       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   Отчет получен", "START;HA=L;VA=C;END;", STR_HEIGHT);
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   Клиент_________________________/_________________/Подпись", "START;HA=L;VA=C;END;", STR_HEIGHT);
       m_rep.Blank_Line();
       m_rep.Put_Str("   ""____""______________20___г.", "START;HA=L;VA=C;END;", STR_HEIGHT);
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Put_Str("   Выделение цветом полей в таблицах с оценками позиций:", "START;FB;HA=L;VA=C;END;", STR_HEIGHT);
       m_rep.Put_Str("", "START;", STR_HEIGHT);
       m_rep.Put_Str("",     m_TableHeadStyleGreen);
       m_rep.Put_Str("- данным цветом выделены параметры на начало периода", "FI;HA=L;VA=C;");
       m_rep.Put_Str("","END;");
       m_rep.Put_Str("", "START;", STR_HEIGHT);
       m_rep.Put_Str("",     m_TableHeadStyleYellow);
       m_rep.Put_Str("- данным цветом выделены параметры на конец периода", "FI;HA=L;VA=C;");
       m_rep.Put_Str("","END;");
     else
       m_rep.Blank_Line(mode);
       m_rep.Put_Str("", "START;");
       m_rep.Put_Str("Подпись1", "FC=W;CN="+SIGNTagName+";");

       m_rep.Put_Str("", "");
       m_rep.Put_Str("Печать", "FC=W;END;CN="+STAMPTagName+";");

       m_rep.Blank_Line(mode);
       m_rep.Put_Str("", "START");
       m_rep.Put_Str("Печать", "FC=W;END;CN="+STAMPTagName+";");

       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();
       m_rep.Blank_Line();

       m_rep.Blank_Line(mode);
       m_rep.Put_Val("Исполнитель","START;VA=C;HA=R;FS=8;", mode);
       m_rep.Put_Val("____________________","P=C;FB;FS=8;");
       m_rep.Put_Val("/ "+Операционист()+" /","VA=C;HA=L;FB;FS=8;END;");
       m_rep.Put_Val("","START;", mode);
       m_rep.Put_Val("М.П,","P=C;FB;FS=8;");
       m_rep.Put_Val("","END;");
       m_rep.Blank_Line(mode);
       m_rep.Put_Val("Отчет получен","START;VA=C;HA=R;FS=8;", mode);
       m_rep.Put_Val("____________________","P=C;FB;FS=8;D=1");
       m_rep.Put_Val("/____________________/","VA=C;HA=L;FB;FS=8;D=1;END;");
       m_rep.Put_Val("Клиент","START;VA=C;HA=R;FS=8;END;", mode);
       m_rep.Blank_Line(mode);
       m_rep.Put_Val("\"____\"______________20___г.","START;VA=C;HA=L;FS=8;END;", mode);
       m_rep.Blank_Line(mode);
     end;
   END;

  /**
   @brief Основная функция печати отчета, содержащая порядок вызова блоков
   @param[in] DlContrID  идентификатор ДБО
   @param[in] notServOp  признак вызова не из вервисной операции  
  */	
  PRIVATE MACRO PrintReport(DlContrID:integer, notServOp:bool)
    var Num = 0;
    var sNum = 0;
    var SheetCount = 0;

    //Биржевые
    if(m_RepParams.IsMarket == true)
      m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, 0, 0);

      Num = 0;
      m_rep.Print_Header("Биржевой портфель", "Arial", 9);
      SheetCount = SheetCount + 1;
     
      //Залоговок      
      PrintHeader(SheetCount);

      Num = Num + 1;
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str(Num+". Оценка портфеля (руб)", m_TitleStyle);
      m_rep.Blank_Line();
      //Сводная информация
      PrintSvodInfo();
      //Курсы валют
      PrintCourses();
      //Оценка денежной позиции
      PrintAccMoneyMoving();
      //Обязательства перед банком
      PrintDebt();
      //Оценка позиции по ЦБ и НЕФИ
      PrintActiveAvoiriss();
      //Оценка позиции по ПФИ
      PrintActiveDeriv();

      Num = Num + 1;
      m_rep.Put_Str("", "START;", STR_HEIGHT);
      m_rep.Put_Str(Num+". Движения по счету", m_TitleStyle);
      m_rep.Blank_Line();
      //Движение ДС
      PrintCasheMoneyMoving();
      
      //субсчет ЕДП
      if(m_DlContrData.IsEDP() == true)
        if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_REPOINPERIOD+","+BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_EXECREPO)))
          Num = Num + 1; 
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на Фондовом рынке", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки РЕПО, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPOINPERIOD)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_REPOINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
          //Сделки РЕПО, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECREPO)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_EXECREPO, string(Num,".",sNum));
          end;
        end;

        if((m_RepParams.ShowEmpty) or (ExistsDataForDvDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_EXECDEAL)))
          Num = Num + 1;
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на Срочном рынке", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForDvDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintDvDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForDvDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintDvDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
        end;

        if((m_RepParams.ShowEmpty) or (ExistsDataForCurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_EXECDEAL)))
          Num = Num + 1;
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на Валютном рынке", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForCurDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintCurrDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForCurDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintCurrDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
        end;

      else
        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_STOCKDL, 8/*Биржевой рынок*/, MMVB_ID());
        if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_REPOINPERIOD+","+BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_EXECREPO)))
          Num = Num + 1; 
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на Фондовом рынке", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки РЕПО, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPOINPERIOD)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_REPOINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
          //Сделки РЕПО, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECREPO)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_EXECREPO, string(Num,".",sNum));
          end;
          //Состав портфеля по итогам торгов
          if((m_RepParams.ShowEmpty) or (ExistsPortfData()))
            sNum = SNum + 1;
            PrintPortfData(string(Num,".",sNum));
          end;
        end;

        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_DV, 8/*Биржевой рынок*/);
        if((m_RepParams.ShowEmpty) or (ExistsDataForDvDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_EXECDEAL)))
          Num = Num + 1;
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на Срочном рынке", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForDvDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintDvDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForDvDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintDvDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
        end;

        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_CM, 8/*Биржевой рынок*/);
        if((m_RepParams.ShowEmpty) or (ExistsDataForCurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_EXECDEAL)))
          Num = Num + 1;
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на Валютном рынке", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForCurDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintCurrDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForCurDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintCurrDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
        end;

        m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_STOCKDL, 8/*Биржевой рынок*/, SPB_ID());
        if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_EXECDEAL)))
          Num = Num + 1; 
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на СПБ", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
          //Состав портфеля по итогам торгов
          if((m_RepParams.ShowEmpty) or (ExistsPortfData()))
            sNum = SNum + 1;
            PrintPortfData(string(Num,".",sNum));
          end;
        end;
      end;

      AddStandardFooter(null, num, SheetCount);
    end;
    UseProgress(1);

    //Внебиржевые
    if(m_RepParams.IsOutMarket == true)
      m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, PTSK_STOCKDL, 9/*Внебиржевой рынок*/);

      if(ExistsDataForAccMoneyMoving() or ExistsDataForActiveAvoiriss()
           or ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL+","+BROKERREP_PART_CANCELREPO)) //Не выводим страницу с внебиржевым отчетом, если у клиента нет внебиржевых активов и нет движений по внебиржевым счетам
        Num = 0;
        m_rep.Print_Header("Внебиржевой портфель", "Arial", 9, IIF(m_RepParams.IsMarket == true, true, false));
        SheetCount = SheetCount + 1;
      
        //Залоговок      
        PrintHeader(SheetCount);
      
        Num = Num + 1;
        m_rep.Put_Str("", "START;", STR_HEIGHT);
        m_rep.Put_Str(Num+". Оценка портфеля (руб)", m_TitleStyle);
        m_rep.Blank_Line();
        //Сводная информация
        PrintSvodInfo();
        //Курсы валют
        PrintCourses();
        //Оценка денежной позиции
        PrintAccMoneyMoving();
        //Оценка позиции по ЦБ и НЕФИ
        PrintActiveAvoiriss();
      
        Num = Num + 1;
        m_rep.Put_Str("", "START;", STR_HEIGHT);
        m_rep.Put_Str(Num+". Движения по счету", m_TitleStyle);
        m_rep.Blank_Line();
        //Движение ДС
        PrintCasheMoneyMoving();
      
        if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD+","+BROKERREP_PART_REPOINPERIOD+","+BROKERREP_PART_EXECDEAL+","+BROKERREP_PART_EXECREPO+","+BROKERREP_PART_CANCELDEAL+","+BROKERREP_PART_CANCELREPO)))
          Num = Num + 1; 
          sNum = 0;
          m_rep.Put_Str("", "START;", STR_HEIGHT);
          m_rep.Put_Str(Num+". Сделки на Внебиржевом рынке", m_TitleStyle);
          m_rep.Blank_Line();
          //Сделки, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_DEALINPERIOD)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_DEALINPERIOD, string(Num,".",sNum));
          end;
          //Сделки РЕПО, заключенные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_REPOINPERIOD)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_REPOINPERIOD, string(Num,".",sNum));
          end;
          //Сделки, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECDEAL)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_EXECDEAL, string(Num,".",sNum));
          end;
          //Сделки РЕПО, заключенные до начала периода отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_EXECREPO)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_EXECREPO, string(Num,".",sNum));
          end;
          //Сделки, отмененные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELDEAL)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_CANCELDEAL, string(Num,".",sNum));
          end;
          //Сделки РЕПО, отмененные в период отчета
          if((m_RepParams.ShowEmpty) or (ExistsDataForSecurDealByMode(BROKERREP_PART_CANCELREPO)))
            sNum = SNum + 1;
            PrintSecurDealsByMode(BROKERREP_PART_CANCELREPO, string(Num,".",sNum));
          end;
        end;
      
        AddStandardFooter(null, num, SheetCount);
      end;
    end;
    UseProgress(2);

    if(m_rep.ExistDataPrint() == true)
      m_rep.Print_Bottom();
    else
      m_DlContrData = СBrokerRepRSHB_DlContrData(DLContrID, m_RepParams.BegDate, m_RepParams.EndDate, 0, 0);

      m_RepParams.NoData = true;
      msgbox("Нет данных для выпуска отчета по ДБО №"+m_DlContrData.ContrNumber());
    end;
  END;

  /**
   @brief Поиск сделок без связанных заявок с последующй рассылкой писем об ошибках
   @param[in] DlContrID  идентификатор ДБО
   @param[in] notServOp  признак вызова не из вервисной операции  
  */	
  PRIVATE MACRO CheckApplicationsAndAssignments():bool
    var query = "   SELECT deals.t_A07        AS DealCode,"
              + " COALESCE(sk.t_Name,'ЕДП')   AS ServKindName,"
              + "          period.t_szNameAlg AS PeriodName"
              + "     FROM (SELECT DISTINCT t.t_A07,"
              + "                  t.t_ServKind,"
              + "                  t.t_ClientID"
              + "             FROM dbrkrepdeal_tmp t"
              + "            WHERE     t.t_ClientID  = ?"
              + "                  AND t.t_ContrID   > 0"
              + "                  AND t.t_IsItog    = CHR(0)"
              + "                  AND t.t_A07      <> CHR(1)"
              + "                  AND t.t_A95      IS NULL"
              + "                  AND t.t_A95_M     = CHR(1)"
              + "                  AND INSTR(t.t_A10, '2 часть') = 0 "
              + "                  AND t.t_Part     IN (" + BROKERREP_PART_DEALINPERIOD + ", "
                                                          + BROKERREP_PART_REPOINPERIOD + ", "
                                                          + BROKERREP_PART_EXECDEAL     + ", "
                                                          + BROKERREP_PART_EXECREPO     + ", "
                                                          + BROKERREP_PART_CANCELDEAL   + ", "
                                                          + BROKERREP_PART_CANCELREPO   + ")) deals,"
              + "          dservkind_dbt sk,"
              + "          dnamealg_dbt  period"
              + "    WHERE     sk.t_ServiseKind(+)   = deals.t_ServKind"
              + "          AND period.t_iTypeAlg     = " + ALG_SCREPPERIODKIND
              + "          AND period.t_iNumberAlg   = ?"
              + " ORDER BY deals.t_A07,"
              + "          deals.t_ServKind";

    var cmd = DL_RSDCommand(query);
    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(m_RepParams.PeriodKind);
    
    var errMes   = null;
    var DataSet  = cmd.Execute();
    var firstStr = true;
    var errMesMail = "", errGetMailTempl = null;
    var errMailTempl;
    var clientCode:string = "";

    while (DataSet.moveNext())
      if (firstStr)
        m_RepParams.NoReq = true;
        clientCode        = ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR);
        errMes            = "Ошибка! По клиенту \"" + clientCode + "\" отсутствуют заявки-поручения по сделкам: ";
        firstStr          = false;
      else
        errMes = errMes + ", ";
        errMesMail = errMesMail + ", "; 
      end;

      errMes = errMes + "\"" + DataSet.DealCode + " (" + DataSet.ServKindName + ")\"";
      errMesMail =  errMesMail + "\"" + DataSet.DealCode + " (" + DataSet.ServKindName + ")\"";
    end;

    if (errMes != null)
      msgbox(errMes);

      if (m_RepParams.InServOp)
        errMailTempl = GetErrMailTemplNew(BROKERREP_ERRMAILTEMPL_NOREQ, @errGetMailTempl);
        if (ValType(errMailTempl) == V_GENOBJ)
          m_RepParams.ErrMails[m_RepParams.ErrMails.Size] = CBrokerRepRSHBErrMail(errMailTempl.Subject, 
                                                                                  StrSubst(StrSubst(errMailTempl.Body, 
                                                                                                    "<код клиента>", clientCode),
                                                                                                    "<Номера сделок>", errMesMail));
          return true;                
        else
          msgbox(errGetMailTempl);
        end;
      end;

      return true;
    end;

    return true;
  END;

  //Создание файла отчета следующим образом:
  //если отчет выпускается сам по себе, т.е. из пункта меню:
  // - в двухзвенке он формируется на СП,  
  // - в трехзвенке на терминале
  //если отчет выпускается в сервисной операции отправки:
  // - в двухзвенке он формируется на СП
  // - в трехзвенке при работе с конвейерами он формируется на СП
  // - в трехзвенке без конвейеров он формируется на терминале, но затем перемещается на СП
  MACRO CreateReport()
    var err = 0;
    var query, cmd, DataSet;
    var cnt = 0;
    var resultFileName = "";
    var ShowFilePath = "";
    var CreateOnTerm = ((m_RepParams.InCnv == false) and (not isStandAlone()));
    var CreateDate = date();
    var CreateTime = time();
    var day, mon, year;
    var hour, min, sec;
    var repeatCount: Integer = 0;
    var maxRepeatCount: Integer = 5;
    var isRepeat: Bool = false;

    if (not CheckApplicationsAndAssignments())
      return;
    end;

     macro NewList(list:@tarray, str)
      var i = 0;
      var j = 1;
      var k = index(str, "/");
      while(k > 0)
        str = substr(str,1,k-1)+"-"+substr(str,k+1);
        k = index(str, "/");
      end;
      while(i < list.size)
        if(list[i] == str)
          j = j + 1;
        end;
        i = i + 1;
      end;
      list[list.size] = str;
      if(j == 1)
        return str;
      else
        return str + " (" + j + ")";
      end;
    end;
    
    /*ak*/
    var InOneList;
    if(m_RepParams.InServOp)
      InOneList = false;
    else
      InOneList = true;
    end;
    /*~ak*/


    DateSplit(m_RepParams.EndDate/*CreateDate*/, day, mon, year);
    TimeSplit(CreateTime, hour, min, sec);

    m_CurrentRepName = "!" + ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR)
                       //+"_"+string(year)+string(mon:f)+string(day:f)
                       +"_"+string(year)+string(mon:o:2)+string(day:o:2)
                       +"_"+string(hour:f)+string(min:f)+string(sec:f);


    //dan> Переопределение имени отчета
    var v_RepName;
    var ListArr = tarray;
    var v_cmd = DL_RSDCommand(String("SELECT sfc.t_number \n",
                       "   FROM ddlcontr_dbt dlc, dsfcontr_dbt sfc  \n",
                       "  WHERE sfc.t_id = dlc.t_sfcontrid AND dlc.t_dlcontrid = ?"));
        v_cmd.AddParam( m_RepParams.dlcontrid);               
    var v_ds = v_cmd.Execute();
    while(v_ds.movenext())
      v_RepName = NewList(@ListArr, v_ds.t_NUMBER);
    end;
    if(v_RepName !="")
      m_CurrentRepName = String(v_RepName, "_", string(year), string(mon:o:2), string(day:o:2));
    end;
    //<dan Переопределение имени отчета    
    
    InitProgress(2, "Формирование отчета", "Формирование отчета");

    m_rep.Init("utf8", m_RepParams.IsApp, 42);

    m_rep.Set_Column_Width(/* 1*/  10,
                           /* 2*/  90,
                           /* 3*/  71,
                           /* 4*/  78,
                           /* 5*/  68,
                           /* 6*/  78,
                           /* 7*/  71,
                           /* 8*/  84,
                           /* 9*/  76,
                           /*10*/  78,
                           /*11*/  70,
                           /*12*/  70,
                           /*13*/  71,
                           /*14*/  73,
                           /*15*/  68,
                           /*16*/  68,
                           /*17*/  71,
                           /*18*/  71,
                           /*19*/  68,
                           /*20*/  68,
                           /*21*/  64,
                           /*22*/  64,
                           /*23*/  66,
                           /*24*/  66,
                           /*25*/  66,
                           /*26*/  66);

    m_rep.Set_Landscape();
    m_rep.Set_Indent(0);
    m_rep.Set_MinPageMargins();

    PrintReport(m_RepParams.DlContrID, InOneList);

    //настройка, определяющая, либо мы тут делаем конвертацию в xlsx и pdf
    //либо в рамках отдельного процесса
    //только для конвейера
    if(m_rep.ExistDataPrint() == true)

      //используем poi для генерации excel файла
      //к этому моменту m_rep уже и так - poi, но он ещё держит файл в памяти, поэтому его остаётся только сохранить

      //если это не сервисная операция, то для менеджера файлов, значит что мы работаем сейчас от пользователя
      var brokFileManager = BrokerRepFileStatusManager(m_CurrentRepName+".xlsx", not m_RepParams.InServOp);
      m_rep.Save(brokFileManager.Get_GENERATED_REPORTS_path());

      if(m_RepParams.ExcelFormat == true)
        brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);
        if (not err)
          m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepRSHBData(brokFileManager.Get_CURRENT_filename_with_ext(), SC_SRVREPFORMAT_EXCEL_XLSX, CreateDate, CreateTime, m_RepParams.DlContrID);
        end;
        if((not err) and (m_RepParams.ShowFile == true))
          brokFileManager.ShowFile();
        end;
      end;

      if(m_RepParams.PdfFormat == true)
        brokFileManager = BrokerRepFileStatusManager(m_CurrentRepName+".pdf", not m_RepParams.InServOp);

        err = POIAddPictureAndConvertToPDF(m_rep, brokFileManager.Get_CURRENT_path_no_file_name(), m_RepParams.SignerParty, brokFileManager.Get_CURRENT_filename_with_no_ext());

        brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);

        if (not err)
          m_RepParams.RepData[m_RepParams.RepData.size] = CBrokerRepRSHBData(brokFileManager.Get_CURRENT_filename_with_ext(), SC_SRVREPFORMAT_PDF, CreateDate, CreateTime, m_RepParams.DlContrID);
        end;

        if((not err) and (m_RepParams.ShowFile == true))
          brokFileManager.ShowFile();
        end;
      end;

    end;
    
    m_rep.Delete();
    RemProgress();
  END;
END;

/**
 @brief Старт формирования нового ОБ
 @param[in] params  класс параметров панели отчета
*/	
MACRO SC_CreateRepBrokerRSHBNew(params)
  var query, cmd, DataSet;
  var DlContrID = params.DlContrID;

  params.RepData.size = 0;
  params.NoData = params.NoReq = false;

  cmd = DL_RSDCommand();

  //Если в параметрах запуска не задан ДБО, то отбираем все ДБО клиента
  query =  string( " select dlc.t_DlContrID "
                  ,"   from ddlcontr_dbt dlc, dsfcontr_dbt sf "
                  ,"  where sf.t_ID = dlc.t_SfContrID "
                  ,"    and sf.t_PartyID = ? "
                  );

  cmd.AddParam(params.ClientID);

  if(params.DlContrID > 0)
    query = query + " and dlc.t_DlContrID = ? ";
    
    cmd.AddParam(params.DlContrID);
  end;
/* dan > исключаем закрытые договора */
    query = query + string(" AND sf.t_datebegin <= " + GetSQLDate(params.enddate) + " \n",
                           " AND (   sf.t_dateclose = to_date('01.01.0001','dd.mm.yyyy') \n",
                           "      OR sf.t_dateclose >= " + GetSQLDate(params.enddate) + ") \n");
/*< dan*/

  var truncate_query = "BEGIN"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPDEAL_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPINACC_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPACTIVEAVOIR_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPACTIVEDERIV_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPPOOL_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPCASHE_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPACC_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPACCITOG_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPCURDEAL_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPDVDEAL_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPDEBT_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPSVODINFO_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPCASHEMOVING_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPCASHEGROUPMOVING_TMP';"
                     + "    EXECUTE IMMEDIATE 'TRUNCATE TABLE DBRKREPCOURSES_TMP';"
                     + "END;";

  var delete_query = "BEGIN"
                   + "    DELETE FROM DBRKREPDEAL_TMP;"
                   + "    DELETE FROM DBRKREPINACC_TMP;"
                   + "    DELETE FROM DBRKREPACTIVEAVOIR_TMP;"
                   + "    DELETE FROM DBRKREPACTIVEDERIV_TMP;"
                   + "    DELETE FROM DBRKREPPOOL_TMP;"
                   + "    DELETE FROM DBRKREPCASHE_TMP;"
                   + "    DELETE FROM DBRKREPACC_TMP;"
                   + "    DELETE FROM DBRKREPACCITOG_TMP;"
                   + "    DELETE FROM DBRKREPCURDEAL_TMP;"
                   + "    DELETE FROM DBRKREPDVDEAL_TMP;"
                   + "    DELETE FROM DBRKREPDEBT_TMP;"
                   + "    DELETE FROM DBRKREPSVODINFO_TMP;"
                   + "    DELETE FROM DBRKREPCASHEMOVING_TMP;" 
                   + "    DELETE FROM DBRKREPCASHEGROUPMOVING_TMP;"
                   + "    DELETE FROM DBRKREPCOURSES_TMP;"
                   + "END;";

  DataSet = cmd.Execute(query);
  while(DataSet.moveNext())
    SQL_Execute(truncate_query);

    //Устанавливаем текущий ДБО в качестве параметра запуска
    params.DlContrID = DataSet.DlContrID;

    //Подготовка всех данных
    SP_BrokerRepRSHB_CreateData(params).Create();
                            
    //Печать
    СBrokerRepRSHB_PrintRep(params).CreateReport();
  end;

  params.DlContrID = DlContrID;

  SQL_Execute(delete_query);
END;