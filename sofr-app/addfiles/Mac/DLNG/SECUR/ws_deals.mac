/*
$Name:           ws_deals.mac
$Module:         АРНУ
$Description:    Макрос сервисов скроллинга и панели сделок, погашений и конвертаций ц/б
*/

import PTInter;
import CTInter;
import FIInter;
import DealsInter;
import "ws_deals_regenerate.mac";
import "dlquery.mac";
import "sp_class.mac";
import "ws_avoiriss.mac";
import "ws_partylist.mac";
import "ws_fiunilist.mac";
import "ws_namealg.mac";
import "spserv.mac";
import "ws_common.mac";
import "ws_validation.mac";
import "spRepFun.mac";
import "sp_carin.mac";
import "ws_datafilter.mac";
import "ws_orderbygen.mac";

PRIVATE CONST COMPILATION_ERROR = 1361;
PRIVATE CONST NOTEKIND_SECDEAL_MANUALMODE_REASON = 32; // Причина перевода сделок/погашений в ручной режим

// ---------- Для реплицированных сделок ----------
PRIVATE CONST OBJKIND_DEAL = 80;  // Сделка с ЦБ
// ------------------------------------------------

macro ScDealRunError( err:Variant, stat:Integer )
  WSRunError( "ws_deals.mac", err, stat );
end;

// Проверить, находится ли сделка в ручном режиме редактирования
private macro СделкаВРучномРежимеРедактирования(dealID:Integer, bofficeKind:Integer)
   var stat:Integer = -1;
   var sql, rsdCmd, dataSet, IsReplDeal = false, IsManualMode = false;

   if( (bofficeKind != null) and (bofficeKind > 0)
   and (dealID != null) and (dealID > 0))
      sql = "select " +
            "  (CASE "
            "      WHEN (select Count(1) from dtxreplobj_dbt where T_OBJECTTYPE = " + OBJKIND_DEAL + " and T_DestID = tick.t_DealID and rownum < 2) > 0 THEN chr(88) " +
            "      ELSE chr(0) " +
            "   END) t_IsReplDeal " +
            " ,(CASE " +
            "      WHEN (select Count(1) from dtxreplobj_dbt where T_OBJECTTYPE = " + OBJKIND_DEAL + " and T_DestID = tick.t_DealID and rownum < 2) > 0 THEN " +
            "          (CASE " +
            "              WHEN (select T_OBJSTATE from dtxreplobj_dbt where T_OBJECTTYPE = " + OBJKIND_DEAL + " and T_DestID = tick.t_DealID) = " + SP_EditDealMode_Manual + " THEN chr(88) " +
            "              ELSE chr(0) " +
            "           END) " +
            "      ELSE CHR(0) " +
            "   END) t_IsManualMode " +
            " from ddl_tick_dbt tick " +
            " where tick.t_BOfficeKind = " + bofficeKind +
            "   and tick.t_DealID = " + dealID;

      rsdCmd = RSDCommand( sql );
      rsdCmd.NullConversion = true;
      rsdCmd.Execute();
      dataSet = TRsbDataSet( rsdCmd );

      if( ( dataSet != null ) and ( dataSet.MoveNext() ) )
         if( SQL_ConvTypeStr( dataSet.IsReplDeal ) == SET_CHR )
            IsManualMode = SQL_ConvTypeStr( dataSet.IsManualMode ) == SET_CHR;
         end;
      end;
   end;

   return IsManualMode;

OnError( err )
   ScDealRunError( err, stat );
end;

// SP_EditDealMode_Normal = 0;   // нормальный(автоматический) режим
// SP_EditDealMode_Manual = 1;   // ручной
// SP_EditDealMode_ReadOnly = 2; // только чтение
macro ПолучитьРежимРедактированияСделки(
  dealID:Integer,       // ID сделки
  bofficeKind:Integer,  // Вид Б/О
  kindOperation:Integer // Вид операции
):Integer
   if( СделкаВРучномРежимеРедактирования(dealID, bofficeKind) ) // для реплицированных сделок
      return SP_EditDealMode_Manual;
   end;

   return SP_EditDealMode_Normal; // для остальных сделок
end;

private macro getSqlChr_IsManualMode():string
   if( ПолучитьРежимРедактированияСделки() == SP_EditDealMode_Manual )
      return "chr(88)";
   end;

   return "chr(0)";
end;

private macro getSql_IsManualMode()
   return
     "  (CASE "
   + "      WHEN (select Count(1) from dtxreplobj_dbt where T_OBJECTTYPE = " + OBJKIND_DEAL + " and T_DestID = tick.t_DealID and rownum < 2) > 0 THEN "
   + "          (CASE "
   + "              WHEN (select T_OBJSTATE from dtxreplobj_dbt where T_OBJECTTYPE = " + OBJKIND_DEAL + " and T_DestID = tick.t_DealID) = " + SP_EditDealMode_Manual + " THEN chr(88) "
   + "              ELSE chr(0) "
   + "           END) "
   + "      ELSE " + getSqlChr_IsManualMode()
   + "   END) ";
end;

private macro GetSQLDealTypeCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = "";
  var valueCount : Integer = 0;

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_UserType ) )
    while( valueCount < value.Size )
      if( ( ValType( value[valueCount] ) != V_UNDEF )
      and ( ValType( value[valueCount].KindOperation ) == V_INTEGER )
      and ( value[valueCount].KindOperation > 0 ) )
        if( strSQLCond == "" )
          strSQLCond = strSQLCond + " ( ";
        else
          strSQLCond = strSQLCond + " OR ";
        end;

        strSQLCond = strSQLCond + " tick.t_DealType = " + String( value[valueCount].KindOperation ) + " ";
      end;
      valueCount = valueCount + 1;
    end;
    if( strSQLCond != "" )
      strSQLCond = strSQLCond + " ) ";
    end;
  end;
  if( strSQLCond == "" )
    strSQLCond = " tick.t_DealType = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLClientCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond:String = "";
  var valueCount:Integer = 0;

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_UserType ) )
    while( valueCount < value.Size )
      if( ( ValType( value[valueCount] ) != V_UNDEF )
      and ( ValType( value[valueCount].PartyID ) == V_INTEGER )
      and ( value[valueCount].PartyID > UnknownParty ) )
        if( strSQLCond == "" )
          strSQLCond = strSQLCond + " ( ";
        else
          strSQLCond = strSQLCond + " OR ";
        end;
        strSQLCond = strSQLCond + " tick.t_ClientID ";
        if( value[valueCount].PartyID == {OurBank} )
          strSQLCond = strSQLCond + " = " + String( UnknownParty ) + " ";
        else
          strSQLCond = strSQLCond + " = " + String( value[valueCount].PartyID ) + " ";
        end;
      end;
      valueCount = valueCount + 1;
    end;
    if( strSQLCond != "" )
      strSQLCond = strSQLCond + " ) ";
    end;
  end;
  if( strSQLCond == "" )
    strSQLCond = " tick.t_ClientID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLDepositCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond:String = "";
  var valueCount:Integer = 0;

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_UserType ) )
    while( valueCount < value.Size )
      if( ( ValType( value[valueCount] ) != V_UNDEF )
      and ( ValType( value[valueCount].PartyID ) == V_INTEGER )
      and ( value[valueCount].PartyID > UnknownParty ) )
        if( strSQLCond == "" )
          strSQLCond = strSQLCond + " ( ";
        else
          strSQLCond = strSQLCond + " OR ";
        end;
        strSQLCond = strSQLCond + " tick.t_DepositID ";
        strSQLCond = strSQLCond + " = " + String( value[valueCount].PartyID ) + " ";
      end;
      valueCount = valueCount + 1;
    end;
    if( strSQLCond != "" )
      strSQLCond = strSQLCond + " ) ";
    end;
  end;
  if( strSQLCond == "" )
    strSQLCond = " tick.t_DepositID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLContrCondition(
  condition : Integer
 ,value//: TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLPartyConditionEx( "tick", "t_PartyID", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " tick.t_PartyID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLTraderCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLPartyConditionEx( "tick", "t_MarketID", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " tick.t_MarketID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLAvoirKindCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLAvoirKindConditionEx( "fininstr", "t_AvoirKind", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " RSB_FIInstr.FI_AvrKindsEQ( " + String( FIKIND_AVOIRISS ) + ", 0, fininstr.t_AvoirKind ) = 1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLPortfolioCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLLlValuesConditionEx( "tick", "t_PortfolioID", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " tick.t_PortfolioID = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIssuerCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLPartyConditionEx( "fininstr", "t_Issuer", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " fininstr.t_Issuer = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIssueCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLFIConditionEx( "fininstr", "t_FIID", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " fininstr.t_FIID = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLDepartmenCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = "";
  var valueCount : Integer = 0;

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_UserType ) )
    while( valueCount < value.Size )
      if( ( ValType( value[valueCount] ) != V_UNDEF )
      and ( ValType( value[valueCount].Code ) == V_INTEGER )
      and ( value[valueCount].Code > 0 ) )
        if( strSQLCond == "" )
          strSQLCond = strSQLCond + " ( ";
        else
          strSQLCond = strSQLCond + " OR ";
        end;

        strSQLCond = strSQLCond + " tick.t_Department = " + String( value[valueCount].Code ) + " ";
      end;
      valueCount = valueCount + 1;
    end;
    if( strSQLCond != "" )
      strSQLCond = strSQLCond + " ) ";
    end;
  end;
  if( strSQLCond == "" )
    strSQLCond = " tick.t_Department = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLNalogGroupCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLLlValuesConditionEx( "avoiriss", "t_TaxGroup", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " avoiriss.t_TaxGroup = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLCurrencySingleCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLFIConditionEx( "fininstr", "t_FaceValueFI", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " fininstr.t_FaceValueFI = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLDepositaryCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLPartyConditionEx( "dl_leg", "t_Registrar", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " dl_leg.t_Registrar = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLCcyCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = GetSQLFIConditionEx( "dl_leg", "t_CFI", condition, value, type );

  if( strSQLCond == "" )
    strSQLCond = " dl_leg.t_CFI = -1 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIsNettingCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( ValType( value[0] ) == V_BOOL )
  and ( value[0] == true ) )
    strSQLCond = " RSB_SECUR.GetDealIsNett( tick.t_DealID, tick.t_BOfficeKind ) > 0 ";
  else
    strSQLCond = " RSB_SECUR.GetDealIsNett( tick.t_DealID, tick.t_BOfficeKind ) = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIsTechDealCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( ValType( value[0] ) == V_BOOL )
  and ( value[0] == true ) )
    strSQLCond = " RSB_SECUR.RSI_IsTechDeal( tick.t_DealID, RsbSessionData.curdate ) > 0 ";
  else
    strSQLCond = " RSB_SECUR.RSI_IsTechDeal( tick.t_DealID, RsbSessionData.curdate ) = 0 ";
  end;

  return strSQLCond;
end;

private macro GetSQLIsManualModeCondition(
  condition : Integer
 ,value// : TArray of <type>
 ,type : Integer
) : String
  var strSQLCond : String = "";

  if( ( ValType( value ) != V_UNDEF )
  and ( value.Size > 0 )
  and ( ValType( type ) == V_INTEGER )
  and ( type == FilterParameterType_Bool )
  and ( ValType( value[0] ) == V_BOOL )
  and ( value[0] == true ) )
    strSQLCond = getSql_IsManualMode() + " = chr(88) ";
  else
    strSQLCond = getSql_IsManualMode() + " = chr(0) ";
  end;

  return strSQLCond;
end;

private macro GetDealsAddWhereCondition(
  filterItems//: TArray of FilterCondItem
) : String

  var fp = FilterParser( filterItems );

  fp.AddUserFieldCondition( 0, @GetSQLDealTypeCondition ); // Вид сделки
  fp.AddFieldCondition( 1, "tick", "t_DealStatus" ); // Статус сделки
  fp.AddFieldCondition( 2, "tick", "t_DealCode" ); // Внутренний код сделки
  fp.AddFieldCondition( 3, "tick", "t_DealCodeTS" ); // Внешний код сделки
  fp.AddFieldCondition( 4, "tick", "t_DealID" ); // ID сделки
  fp.AddUserFieldCondition( 5, @GetSQLIsTechDealCondition ); // Техническая сделка
  fp.AddFieldCondition( 6, "tick", "t_DealDate" ); // Дата заключения
  fp.AddFieldCondition( 7, "tick", "t_CloseDate" ); // Дата закрытия
  fp.AddFieldCondition( 8, null, "RSB_SECUR.GetDealPayDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" ); // Дата оплаты
  fp.AddFieldCondition(
    9,
    null,
    "( "
 + " SELECT "
   + " MIN( dlrq.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq "
 + " WHERE "
       + " dlrq.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq.t_DocID(+) = tick.t_DealID "
   + " AND dlrq.t_DealPart(+) = 1 "
   + " AND dlrq.t_Type(+) = " + String( DLRQ_TYPE_PAYMENT ) + " "
 + " )"
  ); // Фактическая дата оплаты
  fp.AddFieldCondition( 10, null, "RSB_SECUR.GetDealPayDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" ); // Дата оплаты второй части
  fp.AddFieldCondition(
    11,
    null,
    "( "
 + " SELECT "
   + " MIN( dlrq2.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq2 "
 + " WHERE "
       + " dlrq2.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq2.t_DocID(+) = tick.t_DealID "
   + " AND dlrq2.t_DealPart(+) = 2 "
   + " AND dlrq2.t_Type(+) = " + String( DLRQ_TYPE_PAYMENT ) + " "
 + " )"
  ); // Фактическая дата оплаты второй части
  fp.AddFieldCondition( 12, null, "RSB_SECUR.GetDealSupplyDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" ); // Дата поставки
  fp.AddFieldCondition(
    13,
    null,
    "( "
 + " SELECT "
   + " MIN( dlrq3.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq3 "
 + " WHERE "
       + " dlrq3.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq3.t_DocID(+) = tick.t_DealID "
   + " AND dlrq3.t_DealPart(+) = 1 "
   + " AND dlrq3.t_Type(+) = " + String( DLRQ_TYPE_DELIVERY ) + " "
 + " )"
  ); // Фактическая дата поставки
  fp.AddFieldCondition( 14, "dl_leg", "t_SupplyTime" ); // Время поставки
  fp.AddFieldCondition( 15, null, "RSB_SECUR.GetDealSupplyDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" ); // Дата поставки второй части
  fp.AddFieldCondition(
    16,
    null,
    "( "
 + " SELECT "
   + " MIN( dlrq4.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq4 "
 + " WHERE "
       + " dlrq4.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq4.t_DocID(+) = tick.t_DealID "
   + " AND dlrq4.t_DealPart(+) = 2 "
   + " AND dlrq4.t_Type(+) = " + String( DLRQ_TYPE_DELIVERY ) + " "
 + " )"
  ); // Фактическая дата поставки второй части
  fp.AddFieldCondition( 17, null, "RSB_SECUR.GetDealSupplyTime2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" ); // Время поставки второй части
  fp.AddFieldCondition( 18, "dl_leg", "t_CliringDate" ); // Дата клиринга
  fp.AddFieldCondition( 18, "dl_leg2", "t_CliringDate" ); // Дата клиринга
  fp.AddUserFieldCondition( 19, @GetSQLClientCondition ); // Клиент
  fp.AddFieldCondition( 20, "tick", "t_ClientContrID" ); // Номер договора
  fp.AddUserFieldCondition( 21, @GetSQLContrCondition ); // Контрагент
  fp.AddUserFieldCondition( 22, @GetSQLTraderCondition ); // Торговая площадка
  fp.AddUserFieldCondition( 23, @GetSQLAvoirKindCondition ); // Вид ценной бумаги
  fp.AddUserFieldCondition( 24, @GetSQLPortfolioCondition ); // Портфель
  fp.AddUserFieldCondition( 25, @GetSQLIssueCondition ); // Ценная бумага
  fp.AddFieldCondition( 26, "fininstr", "t_Name" ); // Наименование ц/б
  fp.AddFieldCondition( 27, "avoiriss", "t_ISIN" ); // ISIN
  fp.AddUserFieldCondition( 28, @GetSQLDepartmenCondition ); // Филиал
  fp.AddUserFieldCondition( 29, @GetSQLNalogGroupCondition ); // Группа налогового учета
  fp.AddUserFieldCondition( 30, @GetSQLCurrencySingleCondition ); // Валюта номинала
  fp.AddFieldCondition( 31, "dl_leg", "t_TotalCost" ); // Сумма сделки
  fp.AddFieldCondition( 32, null, "NVL( dl_leg2.t_TotalCost, 0 )" ); // Сумма второй части сделки
  fp.AddFieldCondition( 33, "dl_leg", "t_Principal" ); // Количество
  fp.AddUserFieldCondition( 34, @GetSQLCcyCondition ); // Валюта цены
  fp.AddUserFieldCondition( 35, @GetSQLIsNettingCondition ); // Участие в неттинге
  fp.AddFieldCondition( 36, "tick", "t_Oper" ); // Исполнитель
  fp.AddUserFieldCondition( 37, @GetSQLIsManualModeCondition ); // Ручной режим
  fp.AddFieldCondition( 38, "tick", "t_ChangeDate" ); // Дата изменения

  //fp.GetFullSQLConditionDebug( "ws_scdeals_deals_filter_debug" );

  return fp.GetFullSQLCondition();
end;

private macro GetRetiresAddWhereCondition(
  filterItems//: TArray of FilterCondItem
) : String

  var fp = FilterParser( filterItems );

  fp.AddUserFieldCondition( 0, @GetSQLDealTypeCondition ); // Вид операции
  fp.AddFieldCondition( 1, "tick", "t_DealStatus" ); // Статус операции
  fp.AddFieldCondition( 2, "tick", "t_DealCode" ); // Внутренний код операции
  fp.AddFieldCondition( 3, "tick", "t_DealCodeTS" ); // Внешний код операции
  fp.AddFieldCondition( 4, "tick", "t_DealID" ); // ID операции
  fp.AddFieldCondition( 5, "tick", "t_DealDate" ); // Дата операции
  fp.AddFieldCondition( 6, "dl_leg", "t_Maturity" ); // Дата получения средств
  fp.AddFieldCondition( 7, "tick", "t_CommDate" ); // Дата оплаты комиссии
  fp.AddUserFieldCondition( 8, @GetSQLClientCondition ); // Клиент
  fp.AddFieldCondition( 9, "tick", "t_ClientContrID" ); // Номер договора
  fp.AddUserFieldCondition( 10, @GetSQLIssuerCondition ); // Эмитент
  fp.AddUserFieldCondition( 11, @GetSQLIssueCondition ); // Ценная бумага
  fp.AddUserFieldCondition( 12, @GetSQLCurrencySingleCondition ); // Валюта номинала
  fp.AddUserFieldCondition( 13, @GetSQLDepositaryCondition ); // Депозитарий
  fp.AddFieldCondition( 14, "dl_leg", "t_Principal" ); // Количество
  fp.AddFieldCondition( 15, "dl_leg", "t_TotalCost" ); // Сумма погашения
  fp.AddUserFieldCondition( 16, @GetSQLCcyCondition ); // Валюта погашения
  fp.AddUserFieldCondition( 17, @GetSQLDepartmenCondition ); // Филиал
  fp.AddFieldCondition( 18, "tick", "t_Oper" ); // Исполнитель
  fp.AddFieldCondition( 19, "fininstr", "t_Name" ); // Наименование ц/б
  fp.AddUserFieldCondition( 20, @GetSQLIsManualModeCondition ); // Ручной режим

  //fp.GetFullSQLConditionDebug( "ws_scdeals_retires_filter_debug" );

  return fp.GetFullSQLCondition();
end;

private macro GetConversionsAddWhereCondition(
  filterItems//: TArray of FilterCondItem
) : String

  var fp = FilterParser( filterItems );

  fp.AddUserFieldCondition( 0, @GetSQLDealTypeCondition ); // Вид операции
  fp.AddFieldCondition( 1, "tick", "t_DealStatus" ); // Статус операции
  fp.AddFieldCondition( 2, "tick", "t_DealDate" ); // Дата заключения
  fp.AddFieldCondition( 3, "tick", "t_CloseDate" ); // Дата закрытия
  fp.AddUserFieldCondition( 4, @GetSQLClientCondition ); // Клиент
  fp.AddUserFieldCondition( 5, @GetSQLContrCondition ); // Контрагент
  fp.AddUserFieldCondition( 6, @GetSQLAvoirKindCondition ); // Вид ценной бумаги
  fp.AddUserFieldCondition( 7, @GetSQLIssueCondition ); // Ценная бумага
  fp.AddUserFieldCondition( 8, @GetSQLDepartmenCondition ); // Филиал
  fp.AddFieldCondition( 9, "fininstr", "t_Name" ); // Наименование ц/б

  //fp.GetFullSQLConditionDebug( "ws_scdeals_conv_filter_debug" );

  return fp.GetFullSQLCondition();
end;

private macro GetAvrWrtAddWhereCondition(
  filterItems//: TArray of FilterCondItem
) : String

  var fp = FilterParser( filterItems );

  fp.AddUserFieldCondition( 0, @GetSQLDealTypeCondition ); // Вид операции
  fp.AddFieldCondition( 1, "tick", "t_DealStatus" ); // Статус операции
  fp.AddFieldCondition( 2, "tick", "t_DealDate" ); // Дата
  fp.AddUserFieldCondition( 3, @GetSQLClientCondition ); // Клиент
  fp.AddUserFieldCondition( 4, @GetSQLDepositCondition ); // Депозитарий
  fp.AddUserFieldCondition( 5, @GetSQLAvoirKindCondition ); // Вид ценной бумаги
  fp.AddUserFieldCondition( 6, @GetSQLIssueCondition ); // Ценная бумага
  fp.AddUserFieldCondition( 7, @GetSQLPortfolioCondition ); // Портфель
  fp.AddUserFieldCondition( 8, @GetSQLDepartmenCondition ); // Филиал
  fp.AddFieldCondition( 9, "dl_leg", "t_TotalCost" ); // Сумма
  fp.AddFieldCondition( 10, "dl_leg", "t_Principal" ); // Количество
  fp.AddFieldCondition( 11, "fininstr", "t_Name" ); // Наименование ц/б

  //fp.GetFullSQLConditionDebug( "ws_scdeals_conv_filter_debug" );

  return fp.GetFullSQLCondition();
end;

private macro GetDealsSortOrder(
  orderItems//:TArray of OrderItem  // Параметры сортировки
 ,defaultSQLSortOrder:String        // Строка сортировки по умолчанию
):String

  var ordrGen = OrderByGenerator( orderItems, defaultSQLSortOrder, false, false );

  ordrGen.AddObjectSorting( "DealCode", "tick.t_DealCode" );
  ordrGen.AddObjectSorting( "DealDate", "tick.t_DealDate" );
  ordrGen.AddObjectSorting( "TypeCode", "RSB_SECUR.GetDealTypeName( tick.t_DealType )" );
  ordrGen.AddObjectSorting( "StateName", "tick.t_DealStatus" );
  ordrGen.AddObjectSorting( "ClientName", "RSB_SECUR.GetDealClientShortName( tick.t_ClientID )" );
  ordrGen.AddObjectSorting( "ClientSfContr", "RSB_SECUR.GetDealSfContrNumber( tick.t_ClientContrID )" );
  ordrGen.AddObjectSorting( "ContrName", "RSB_SECUR.GetDealContrShortName( tick.t_PartyID )" );
  ordrGen.AddObjectSorting( "IssCode", "fininstr.t_FI_Code" );
  ordrGen.AddObjectSorting( "IssName", "fininstr.t_Name" );
  ordrGen.AddObjectSorting( "NalogGroup", "avoiriss.t_TaxGroup" );
  ordrGen.AddObjectSorting( "BaseAmount", "dl_leg.t_Principal" );
  ordrGen.AddObjectSorting( "TotalCost1", "dl_leg.t_TotalCost" );
  ordrGen.AddObjectSorting( "TotalCost2", "NVL( dl_leg2.t_TotalCost, 0 )" );
  ordrGen.AddObjectSorting( "CFI", "dl_leg.t_CFI" );
  ordrGen.AddObjectSorting( "Ccy", "RSB_SECUR.GetDealFICcy( dl_leg.t_CFI )" );
  ordrGen.AddObjectSorting( "IncomeRate", "dl_leg2.t_IncomeRate" );
  ordrGen.AddObjectSorting( "PayDate1", "RSB_SECUR.GetDealPayDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" );
  ordrGen.AddObjectSorting(
    "PayFactDate1",
    "( "
 + " SELECT "
   + " MIN( dlrq.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq "
 + " WHERE "
       + " dlrq.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq.t_DocID(+) = tick.t_DealID "
   + " AND dlrq.t_DealPart(+) = 1 "
   + " AND dlrq.t_Type(+) = " + String( DLRQ_TYPE_PAYMENT ) + " "
 + " )"
  );
  ordrGen.AddObjectSorting( "PayDate2", "RSB_SECUR.GetDealPayDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" );
  ordrGen.AddObjectSorting(
    "PayFactDate2",
    "( "
 + " SELECT "
   + " MIN( dlrq2.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq2 "
 + " WHERE "
       + " dlrq2.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq2.t_DocID(+) = tick.t_DealID "
   + " AND dlrq2.t_DealPart(+) = 2 "
   + " AND dlrq2.t_Type(+) = " + String( DLRQ_TYPE_PAYMENT ) + " "
 + " )"
  );
  ordrGen.AddObjectSorting( "ChangeDate", "tick.t_ChangeDate" );
  ordrGen.AddObjectSorting( "RejectDate1", "dl_leg.t_RejectDate" );
  ordrGen.AddObjectSorting( "RejectDate2", "RSB_SECUR.GetDealRejectDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" );
  ordrGen.AddObjectSorting( "DealCodeTS", "tick.t_DealCodeTS" );
  ordrGen.AddObjectSorting( "DealID", "tick.t_DealID" );
  ordrGen.AddObjectSorting( "IsNetting", "RSB_SECUR.GetDealIsNett( tick.t_DealID, tick.t_BOfficeKind )" );
  ordrGen.AddObjectSorting( "DepartmentName", "RSB_SECUR.GetDealDepName( tick.t_Department )" );
  ordrGen.AddObjectSorting( "SupplyDate1", "RSB_SECUR.GetDealSupplyDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" );
  ordrGen.AddObjectSorting(
    "SupplyFactDate1",
    "( "
 + " SELECT "
   + " MIN( dlrq3.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq3 "
 + " WHERE "
       + " dlrq3.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq3.t_DocID(+) = tick.t_DealID "
   + " AND dlrq3.t_DealPart(+) = 1 "
   + " AND dlrq3.t_Type(+) = " + String( DLRQ_TYPE_DELIVERY ) + " "
 + " )"
  );
  ordrGen.AddObjectSorting( "SupplyTime1", "dl_leg.t_SupplyTime" );
  ordrGen.AddObjectSorting( "SupplyDate2", "RSB_SECUR.GetDealSupplyDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" );
  ordrGen.AddObjectSorting(
    "SupplyFactDate2",
    "( "
 + " SELECT "
   + " MIN( dlrq4.t_FactDate ) "
 + " FROM "
   + " ddlrq_dbt dlrq4 "
 + " WHERE "
       + " dlrq4.t_DocKind(+) = tick.t_BOfficeKind "
   + " AND dlrq4.t_DocID(+) = tick.t_DealID "
   + " AND dlrq4.t_DealPart(+) = 2 "
   + " AND dlrq4.t_Type(+) = " + String( DLRQ_TYPE_DELIVERY ) + " "
 + " )"
  );
  ordrGen.AddObjectSorting( "SupplyTime2", "RSB_SECUR.GetDealSupplyTime2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" );
  ordrGen.AddObjectSorting( "OperName", "RSB_SECUR.GetDealOperName( tick.t_Oper )" );
  ordrGen.AddObjectSorting( "UserField1", "tick.t_UserField1" );
  ordrGen.AddObjectSorting( "UserField2", "tick.t_UserField2" );
  ordrGen.AddObjectSorting( "UserField3", "tick.t_UserField3" );
  ordrGen.AddObjectSorting( "UserField4", "tick.t_UserField4" );
  ordrGen.AddObjectSorting( "Comment", "tick.t_Comment" );
  ordrGen.AddObjectSorting( "IsTechDeal", "RSB_SECUR.RSI_IsTechDeal( tick.t_DealID, RsbSessionData.curdate )" );

  //ordrGen.GetFullSQLSortOrder( "ws_scdeals_deals_orderby_debug" );

  return ordrGen.GetFullSQLSortOrder();
end;

private macro GetRetiresSortOrder(
  orderItems//:TArray of OrderItem  // Параметры сортировки
 ,defaultSQLSortOrder:String        // Строка сортировки по умолчанию
):String

  var ordrGen = OrderByGenerator( orderItems, defaultSQLSortOrder, false, false );

  ordrGen.AddObjectSorting( "DealCode", "tick.t_DealCode" );
  ordrGen.AddObjectSorting( "DealCodeTS", "tick.t_DealCodeTS" );
  ordrGen.AddObjectSorting( "DealDate", "tick.t_DealDate" );
  ordrGen.AddObjectSorting( "StateName", "tick.t_DealStatus" );
  ordrGen.AddObjectSorting( "IssCode", "fininstr.t_FI_Code" );
  ordrGen.AddObjectSorting( "IssName", "fininstr.t_Name" );
  ordrGen.AddObjectSorting(
    "IssuerName",
    "( "
 + " SELECT "
   + " party2.t_ShortName "
 + " FROM "
   + " dparty_dbt party2 "
 + " WHERE "
   + " party2.t_PartyID = fininstr.t_Issuer "
 + " )"
  );
  ordrGen.AddObjectSorting( "BaseAmount", "dl_leg.t_Principal" );
  ordrGen.AddObjectSorting( "TotalCost1", "dl_leg.t_TotalCost" );
  ordrGen.AddObjectSorting( "CFI", "dl_leg.t_CFI" );
  ordrGen.AddObjectSorting( "Ccy", "RSB_SECUR.GetDealFICcy( dl_leg.t_CFI )" );
  ordrGen.AddObjectSorting( "ClientName", "RSB_SECUR.GetDealClientShortName( tick.t_ClientID )" );
  ordrGen.AddObjectSorting(
    "SymbOfKindOperRetire",
    "( "
 + " CASE "
   + " WHEN "
     + " RSB_SECUR.IsRet_Partly( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tick.t_DealType, tick.t_BofficeKind ) ) ) > 0 "
   + " THEN "
     + " 'ЧП' "
   + " WHEN "
     + " RSB_SECUR.IsRet_Coupon( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tick.t_DealType, tick.t_BofficeKind ) ) ) > 0 "
   + " THEN "
    + " 'Куп' "
   + " WHEN "
     + " RSB_SECUR.IsRet_Issue( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tick.t_DealType, tick.t_BofficeKind ) ) ) > 0 "
   + " THEN "
     + " 'Вып' "
   + " ELSE "
     + " '' "
 + " END "
 + " )"
  );
  ordrGen.AddObjectSorting( "ClientSfContr", "RSB_SECUR.GetDealSfContrNumber( tick.t_ClientContrID )" );
  ordrGen.AddObjectSorting(
    "DepositaryName",
    "( "
 + " SELECT "
   + " party.t_ShortName "
 + " FROM "
   + " dparty_dbt party "
 + " WHERE "
   + " party.t_PartyID = dl_leg.t_Registrar "
 + " )"
  );
  ordrGen.AddObjectSorting( "DealID", "tick.t_DealID" );
  ordrGen.AddObjectSorting( "DepartmentName", "RSB_SECUR.GetDealDepName( tick.t_Department )" );

  //ordrGen.GetFullSQLSortOrder( "ws_scdeals_retires_orderby_debug" );

  return ordrGen.GetFullSQLSortOrder();
end;

private macro GetConversionsSortOrder(
  orderItems//:TArray of OrderItem  // Параметры сортировки
 ,defaultSQLSortOrder:String        // Строка сортировки по умолчанию
):String

  var ordrGen = OrderByGenerator( orderItems, defaultSQLSortOrder, false, false );

  ordrGen.AddObjectSorting( "DealCode", "tick.t_DealCode" );
  ordrGen.AddObjectSorting( "DealDate", "tick.t_DealDate" );
  ordrGen.AddObjectSorting( "TypeCode", "RSB_SECUR.GetDealTypeName( tick.t_DealType )" );
  ordrGen.AddObjectSorting( "StateName", "tick.t_DealStatus" );
  ordrGen.AddObjectSorting( "ClientName", "RSB_SECUR.GetDealClientShortName( tick.t_ClientID )" );
  ordrGen.AddObjectSorting( "ClientSfContr", "RSB_SECUR.GetDealSfContrNumber( tick.t_ClientContrID )" );
  ordrGen.AddObjectSorting( "ContrName", "RSB_SECUR.GetDealContrShortName( tick.t_PartyID )" );
  ordrGen.AddObjectSorting( "IssCode", "fininstr.t_FI_Code" );
  ordrGen.AddObjectSorting( "IssName", "fininstr.t_Name" );
  ordrGen.AddObjectSorting( "NalogGroup", "avoiriss.t_TaxGroup" );
  ordrGen.AddObjectSorting( "BaseAmount", "dl_leg.t_Principal" );
  ordrGen.AddObjectSorting( "TotalCost1", "dl_leg.t_TotalCost" );
  ordrGen.AddObjectSorting( "CFI", "dl_leg.t_CFI" );
  ordrGen.AddObjectSorting( "Ccy", "RSB_SECUR.GetDealFICcy( dl_leg.t_CFI )" );
  ordrGen.AddObjectSorting( "PayDate1", "RSB_SECUR.GetDealPayDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" );
  ordrGen.AddObjectSorting( "PayDate2", "RSB_SECUR.GetDealPayDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" );
  ordrGen.AddObjectSorting( "DealCodeTS", "tick.t_DealCodeTS" );
  ordrGen.AddObjectSorting( "DealID", "tick.t_DealID" );
  ordrGen.AddObjectSorting( "IsNetting", "RSB_SECUR.GetDealIsNett( tick.t_DealID, tick.t_BOfficeKind )" );
  ordrGen.AddObjectSorting( "DepartmentName", "RSB_SECUR.GetDealDepName( tick.t_Department )" );
  ordrGen.AddObjectSorting( "SupplyDate1", "RSB_SECUR.GetDealSupplyDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" );
  ordrGen.AddObjectSorting( "SupplyTime1", "dl_leg.t_SupplyTime" );
  ordrGen.AddObjectSorting( "SupplyDate2", "RSB_SECUR.GetDealSupplyDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" );
  ordrGen.AddObjectSorting( "SupplyTime2", "RSB_SECUR.GetDealSupplyTime2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " )" );
  ordrGen.AddObjectSorting( "OperName", "RSB_SECUR.GetDealOperName( tick.t_Oper )" );
  ordrGen.AddObjectSorting( "UserField1", "tick.t_UserField1" );
  ordrGen.AddObjectSorting( "UserField2", "tick.t_UserField2" );
  ordrGen.AddObjectSorting( "UserField3", "tick.t_UserField3" );
  ordrGen.AddObjectSorting( "UserField4", "tick.t_UserField4" );
  ordrGen.AddObjectSorting( "Comment", "tick.t_Comment" );

  //ordrGen.GetFullSQLSortOrder( "ws_scdeals_conv_orderby_debug" );

  return ordrGen.GetFullSQLSortOrder();
end;

private macro GetAvrWrtSortOrder(
  orderItems//:TArray of OrderItem  // Параметры сортировки
 ,defaultSQLSortOrder:String        // Строка сортировки по умолчанию
):String

  var ordrGen = OrderByGenerator( orderItems, defaultSQLSortOrder, false, false );

  ordrGen.AddObjectSorting( "DealCode", "tick.t_DealCode" );
  ordrGen.AddObjectSorting( "DealDate", "tick.t_DealDate" );
  ordrGen.AddObjectSorting( "TypeCode", "RSB_SECUR.GetDealTypeName( tick.t_DealType )" );
  ordrGen.AddObjectSorting( "StateName", "tick.t_DealStatus" );
  ordrGen.AddObjectSorting( "ClientName", "RSB_SECUR.GetDealClientShortName( tick.t_ClientID )" );
  ordrGen.AddObjectSorting( "IssCode", "fininstr.t_FI_Code" );
  ordrGen.AddObjectSorting( "IssName", "fininstr.t_Name" );
  ordrGen.AddObjectSorting( "NalogGroup", "avoiriss.t_TaxGroup" );
  ordrGen.AddObjectSorting( "BaseAmount", "dl_leg.t_Principal" );
  ordrGen.AddObjectSorting( "TotalCost", "dl_leg.t_TotalCost" );
  ordrGen.AddObjectSorting( "CFI", "dl_leg.t_CFI" );
  ordrGen.AddObjectSorting( "Ccy", "RSB_SECUR.GetDealFICcy( dl_leg.t_CFI )" );
  ordrGen.AddObjectSorting( "PayDate1", "RSB_SECUR.GetDealPayDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" );
  ordrGen.AddObjectSorting( "DealCodeTS", "tick.t_DealCodeTS" );
  ordrGen.AddObjectSorting( "DealID", "tick.t_DealID" );
  ordrGen.AddObjectSorting( "IsNetting", "RSB_SECUR.GetDealIsNett( tick.t_DealID, tick.t_BOfficeKind )" );
  ordrGen.AddObjectSorting( "DepartmentName", "RSB_SECUR.GetDealDepName( tick.t_Department )" );
  ordrGen.AddObjectSorting( "SupplyDate1", "RSB_SECUR.GetDealSupplyDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry )" );
  ordrGen.AddObjectSorting( "SupplyTime1", "dl_leg.t_SupplyTime" );
  ordrGen.AddObjectSorting( "OperName", "RSB_SECUR.GetDealOperName( tick.t_Oper )" );
  ordrGen.AddObjectSorting( "UserField1", "tick.t_UserField1" );
  ordrGen.AddObjectSorting( "UserField2", "tick.t_UserField2" );
  ordrGen.AddObjectSorting( "UserField3", "tick.t_UserField3" );
  ordrGen.AddObjectSorting( "UserField4", "tick.t_UserField4" );
  ordrGen.AddObjectSorting( "Comment", "tick.t_Comment" );

  //ordrGen.GetFullSQLSortOrder( "ws_scdeals_conv_orderby_debug" );

  return ordrGen.GetFullSQLSortOrder();
end;

// Получить общее количество записей скроллинга сделок/погашений
macro ScGetDealCount(
  bOfficeKind:Integer
 ,filterItems//:TArray of FilterConditionItem
):Integer

  var stat:Integer = 0;
  var sqlQuery:String = "";
  var rsdCmd = null;
  var dataSet = null;
  var count:Integer = 0;

  InitError();

  sqlQuery =
    " SELECT "
    + " /*+ PARALLEL */ "
    + " COUNT( 1 ) t_Count "
  + " FROM "
    + " ddl_tick_dbt tick "
   + " ,ddl_leg_dbt dl_leg ";

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery = sqlQuery +
     " ,ddl_leg_dbt dl_leg2 ";
  end;

  sqlQuery = sqlQuery +
     " ,dfininstr_dbt fininstr "
   + " ,davoiriss_dbt avoiriss "
  + " WHERE "
        + " tick.t_BOfficeKind = " + String( bOfficeKind ) + " "
    + " AND dl_leg.t_LegKind = " + String( LEG_KIND_DL_TICK ) + " "
    + " AND dl_leg.t_DealID = tick.t_DealID "
    + " AND dl_leg.t_LegID = 0 "
    + " AND fininstr.t_FIID = tick.t_PFI "
    + " AND avoiriss.t_FIID = fininstr.t_FIID ";

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery = sqlQuery +
      " AND dl_leg2.t_LegKind(+) = " + String( LEG_KIND_DL_TICK_BACK ) + " "
    + " AND dl_leg2.t_DealID(+) = tick.t_DealID "
    + " AND dl_leg2.t_LegID(+) = 0 ";
  end;

  if( {cTypePerson} == TP_DEP )
    sqlQuery = sqlQuery +
      " AND ( tick.t_Oper = " + String( {Oper} ) + " "
       + " OR tick.t_Oper BETWEEN " + String( {GroupOperF} ) + " AND " + String( {GroupOperL} ) + " ) ";
  elif( {cTypePerson} == TP_OPER )
    sqlQuery = sqlQuery +
      " AND tick.t_Oper = " + String( {Oper} ) + " ";
  end;

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery = sqlQuery +
      " AND "
      + GetDealsAddWhereCondition( filterItems );
  elif( bOfficeKind == DL_RETIREMENT )
    sqlQuery = sqlQuery +
      " AND "
      + GetRetiresAddWhereCondition( filterItems );
  elif( bOfficeKind == DL_CONVAVR )
    sqlQuery = sqlQuery +
      " AND "
      + GetConversionsAddWhereCondition( filterItems );
  elif( bOfficeKind == DL_AVRWRT )
    sqlQuery = sqlQuery +
      " AND "
      + GetAvrWrtAddWhereCondition( filterItems );
  end;

  rsdCmd = RSDCommand( sqlQuery );

  rsdCmd.NullConversion = true;
  rsdCmd.Execute();

  dataSet = TRsbDataSet( rsdCmd );

  if( ( dataSet != null ) and ( dataSet.MoveNext() ) )
    count = SQL_ConvTypeInteger( dataSet.Count );
  end;

  return count;

OnError( err )
  ScDealRunError( err, stat );
end;

// Изменить режим редактирования сделки
macro ScChangeDealMode(
  dealID:Integer       // ID сделки
 ,bOfficeKind          // Вид бэкофиса
 ,mode:Integer         // Режим редактирования
 ,reason:String
)
  InitError();
  RslDefCon.BeginTrans();

  var stat = -1;
  var ResponseBuilder : WebResponseBuilder = WebResponseBuilder();

  if( ( dealID == null ) or ( dealID <= 0 ) )
    RunError( "Не задан обязательный параметр функции: ID сделки" );
  end;
  if( ( bOfficeKind == null ) or ( bOfficeKind <= 0 ) )
    RunError( "Не задан обязательный параметр функции: Вид бэкофиса" );
  end;
  if( ( mode == null ) or (( mode != SP_EditDealMode_Normal) and ( mode != SP_EditDealMode_Manual )) )
    RunError( "Неверно задан обязательный параметр функции: Режим редактирования сделки" );
  end;

  var sql = " update dtxreplobj_dbt " +
            "   set t_ObjState = ?, " +
            "       t_HandsDate = ? " +
            " where t_ObjectType = ? " +
            "   and t_DestID = ? " + 
            "   and t_ObjState not in (?,?)";

  var query = RSDCommand(sql);

  query.addParam( "", RSDBP_IN, mode );
  query.addParam( "", RSDBP_IN, IIF(mode == SP_EditDealMode_Manual, Date(), ZeroDate) );
  query.addParam( "", RSDBP_IN, OBJKIND_DEAL );
  query.addParam( "", RSDBP_IN, dealID );
  query.addParam( "", RSDBP_IN, mode );
  query.addParam( "", RSDBP_IN, 2/*запись помечена на удаление*/ );

  query.execute();

  // сохранение информации в примечании "Причина перевода в ручной режим"
  if( mode == SP_EditDealMode_Manual )
     if( (reason != null) and (reason != "") )
        if (addNoteForObject (bOfficeKind, L_Z(dealID, 34), NOTEKIND_SECDEAL_MANUALMODE_REASON, reason, date()))
           RunError ("Не удалось сохранить значение примечания \"Причина перевода в ручной режим\"!|" +
                     "Сделка оставлена в автоматическом режиме обработки.");
        end;
     end;
  end;

  RslDefCon.CommitTrans();

  ResponseBuilder.SetUserObject( dealID );

  return ResponseBuilder.Result;

OnError( err )
  RslDefCon.RollbackTrans();
  ScDealRunError( err, stat );
end;

// Удалить сделку
macro ScDeleteDeal( DealId: Integer):WebServiceResponse

  InitError();

  var ResponseBuilder : WebResponseBuilder = WebResponseBuilder();
  var stat = 0;
  var errMsg = "";

  if( ( DealId == null ) or ( DealId <= 0 ) )
    RunError( "Не задан обязательный параметр функции: Id сделки" );
  end;

  stat = SP_DelDealWithLinks(DealID, false, true);

  if( stat )

     errMsg = GetErrMsg();

     if( errMsg != "" )
        ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, errMsg );
     else
        if( stat == COMPILATION_ERROR )
           ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, "Ошибка при компиляции макросов" );
        else
           ResponseBuilder.AddErrorEx( stat, MessageSeverity.RuntimeError, "Ошибка транзакции удаления" );
           stat = -1;
        end;
     end;

  end;

  ResponseBuilder.SetUserObject( DealId );

  return ResponseBuilder.Result;

OnError( err )
  ScDealRunError( err, stat );

end;

// Получить список сделок/погашений/конвертаций
macro ScGetDealList(
  bOfficeKind:Integer                         // Вид отбираемых записей
 ,pageSize:Integer                            // Размер страницы
 ,pageNum:Integer                             // Номер страницы
 ,filterItems//:TArray of FilterConditionItem // Значения фильтрации
 ,orderItems//:TArray of OrderItem            // Параметры сортировки
)//:TArray of CScDealList

  var stat:Integer = 0;
  var sqlQuery:String = "";
  var sqlQuery2:String = "";
  var sortOrder:String = "";
  var rsdCmd = null;
  var dataSet = null;
  var dealList = TArray();
  var deal = null;

  InitError();

  sortOrder =
      " tick.t_DealStatus ASC "
   + " ,tick.t_DealDate DESC "
   + " ,tick.t_DealTime DESC "
   + " ,tick.t_DealID DESC ";

  if( bOfficeKind == DL_SECURITYDOC )
    sortOrder = GetDealsSortOrder( orderItems, sortOrder );
  elif( bOfficeKind == DL_RETIREMENT )
    sortOrder = GetRetiresSortOrder( orderItems, sortOrder );
  elif( bOfficeKind == DL_CONVAVR )
    sortOrder = GetConversionsSortOrder( orderItems, sortOrder );
  elif( bOfficeKind == DL_AVRWRT )
    sortOrder = GetAvrWrtSortOrder( orderItems, sortOrder );
  end;

  sqlQuery =
    " SELECT "
    + " /*+ PARALLEL */ "
    + " tick.t_DealID "
  + " FROM "
    + " ddl_tick_dbt tick "
   + " ,ddl_leg_dbt dl_leg ";

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery = sqlQuery +
     " ,ddl_leg_dbt dl_leg2 ";
  end;

  sqlQuery = sqlQuery +
     " ,dfininstr_dbt fininstr "
   + " ,davoiriss_dbt avoiriss "
  + " WHERE "
        + " tick.t_BOfficeKind = " + String( bOfficeKind ) + " "
    + " AND dl_leg.t_LegKind = " + String( LEG_KIND_DL_TICK ) + " "
    + " AND dl_leg.t_DealID = tick.t_DealID "
    + " AND dl_leg.t_LegID = 0 "
    + " AND fininstr.t_FIID = tick.t_PFI "
    + " AND avoiriss.t_FIID = fininstr.t_FIID ";

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery = sqlQuery +
      " AND dl_leg2.t_LegKind(+) = " + String( LEG_KIND_DL_TICK_BACK ) + " "
    + " AND dl_leg2.t_DealID(+) = tick.t_DealID "
    + " AND dl_leg2.t_LegID(+) = 0 ";
  end;

  if( {cTypePerson} == TP_DEP )
     sqlQuery = sqlQuery +
      " AND ( tick.t_Oper = " + String( {Oper} ) + " "
       + " OR tick.t_Oper BETWEEN " + String( {GroupOperF} ) + " AND " + String( {GroupOperL} ) + " ) ";
  elif( {cTypePerson} == TP_OPER )
     sqlQuery = sqlQuery +
      " AND tick.t_Oper = " + String( {Oper} ) + " ";
  end;

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery = sqlQuery +
      " AND "
      + GetDealsAddWhereCondition( filterItems );
  elif( bOfficeKind == DL_RETIREMENT )
    sqlQuery = sqlQuery +
      " AND "
      + GetRetiresAddWhereCondition( filterItems );
  elif( bOfficeKind == DL_CONVAVR )
    sqlQuery = sqlQuery +
      " AND "
      + GetConversionsAddWhereCondition( filterItems );
  elif( bOfficeKind == DL_AVRWRT )
    sqlQuery = sqlQuery +
      " AND "
      + GetAvrWrtAddWhereCondition( filterItems );
  end;

  sqlQuery = sqlQuery +
    " ORDER BY "
      + sortOrder;

  sqlQuery =
    " SELECT "
    + " t2.t_DealID "
  + " FROM "
    + " ( "
    + " SELECT "
      + " ROWNUM t_RowNumber "
     + " ,t1.t_DealID "
    + " FROM "
      + " ( "
      + sqlQuery
      + " ) t1 ";

  if( ( pageSize != null )
  and ( pageSize > 0 ) )
    sqlQuery = sqlQuery +
      " WHERE "
      + " ROWNUM <= " + String( pageSize * ( pageNum + 1 ) ) + " "
    + " ) t2 "
  + " WHERE ";
    if( ( pageNum != null )
    and ( pageNum > -1 ) )
      sqlQuery = sqlQuery +
      " t2.t_RowNumber >= " + String( pageSize * pageNum + 1 ) + " ";
    else
      sqlQuery = sqlQuery +
      " t2.t_RowNumber >= 1 ";
    end;
  else
    sqlQuery = sqlQuery +
      " ) t2 ";
  end;

  sqlQuery2 =
    " SELECT ";

  if( ( pageSize != null )
  and ( pageSize > 0 ) )
    sqlQuery2 = sqlQuery2 +
      " /*+ FIRST_ROWS(" + String( pageSize ) + ") */ ";
  end;

  sqlQuery2 = sqlQuery2 +
      " tick.t_DealID "
   + " ,tick.t_BOfficeKind "
   + " ,tick.t_DealType "
   + " ,tick.t_DealCode "
   + " ,tick.t_DealCodeTS "
   + " ,( "
    + " CASE "
      + " WHEN "
        + " tick.t_ClientID < 0 "
      + " THEN "
        + " RSBSESSIONDATA.OurBank "
      + " ELSE "
        + " tick.t_ClientID "
    + " END "
    + " ) t_ClientID "
   + " ,tick.t_PartyID "
   + " ,tick.t_MarketID "
   + " ,tick.t_DealDate "
   + " ,tick.t_DealStatus t_State "
   + " ,tick.t_Department "
   + " ,tick.t_Oper "
   + " ,tick.t_Flag1 "
   + " ,tick.t_Flag2 "
   + " ,tick.t_Flag3 "
   + " ,tick.t_Flag4 "
   + " ,tick.t_Flag5 "
   + " ,tick.t_UserField1 "
   + " ,tick.t_UserField2 "
   + " ,tick.t_UserField3 "
   + " ,tick.t_UserField4 "
   + " ,tick.t_Comment "
   + " ,tick.t_CloseDate "
   + " ,tick.t_DealTime "
   + " ,tick.t_PortfolioID "
   + " ,tick.t_ClientContrID "
   + " ,tick.t_ChangeDate "
   + " ,dl_leg.t_CFI "
   + " ,dl_leg.t_Maturity "
   + " ,dl_leg.t_Expiry "
   + " ,dl_leg.t_Principal t_BaseAmount "
   + " ,dl_leg.t_TotalCost t_TotalCost1 "
   + " ,dl_leg.t_MaturityIsPrincipal "
   + " ,dl_leg.t_Registrar "
   + " ,dl_leg.t_RejectDate t_RejectDate1 "
   + " ,dl_leg.t_SupplyTime t_SupplyTime1 "
   + " ,dl_leg.t_CliringDate t_CliringDate1 "
   + " ,dl_leg.t_CliringTime t_CliringTime1 "
   + " ,dl_leg.t_Session     t_CliringSession1 "
   + " ,dl_leg.t_CliringChange t_CliringChange1 "
   + " ,fininstr.t_FIID "
   + " ,fininstr.t_FI_Code t_IssCode "
   + " ,fininstr.t_AvoirKind "
   + " ,fininstr.t_Name t_IssName "
   + " ,fininstr.t_Issuer "
   + " ,fininstr.t_FaceValueFI "
   + " ,avoiriss.t_ISIN "
   + " ,avoiriss.t_TaxGroup t_NalogGroup "
   + " ,( "
    + " SELECT "
      + " namealg.t_szNameAlg "
    + " FROM "
      + " dnamealg_dbt namealg "
    + " WHERE "
          + " namealg.t_iTypeAlg(+) = 3155 "
      + " AND namealg.t_iNumberAlg(+) = tick.t_DealStatus "
   + " ) t_StateName "
   + " ,( "
    + " SELECT "
      + " MIN( dlrq.t_FactDate ) "
    + " FROM "
      + " ddlrq_dbt dlrq "
    + " WHERE "
          + " dlrq.t_DocKind(+) = tick.t_BOfficeKind "
      + " AND dlrq.t_DocID(+) = tick.t_DealID "
      + " AND dlrq.t_DealPart(+) = 1 "
      + " AND dlrq.t_Type(+) = " + String( DLRQ_TYPE_PAYMENT ) + " "
   + " ) t_PayFactDate1 "
   + " ,( "
    + " SELECT "
      + " MIN( dlrq2.t_FactDate ) "
    + " FROM "
      + " ddlrq_dbt dlrq2 "
    + " WHERE "
          + " dlrq2.t_DocKind(+) = tick.t_BOfficeKind "
      + " AND dlrq2.t_DocID(+) = tick.t_DealID "
      + " AND dlrq2.t_DealPart(+) = 2 "
      + " AND dlrq2.t_Type(+) = " + String( DLRQ_TYPE_PAYMENT ) + " "
   + " ) t_PayFactDate2 "
   + " ,RSI_RSB_FIINSTR.FI_AvrKindsGetRoot( " + String( FIKIND_AVOIRISS ) + ", fininstr.t_AvoirKind ) t_RootAvrKind "
   + " ,RSB_SECUR.GetDealTypeName( tick.t_DealType ) t_TypeCode "
   + " ,RSB_SECUR.GetDealClientShortName( tick.t_ClientID ) t_ClientName "
   + " ,RSB_SECUR.GetDealSfContrNumber( tick.t_ClientContrID ) t_ClientSfContr "
   + " ,RSB_SECUR.GetDealContrShortName( tick.t_PartyID ) t_ContrName "
   + " ,RSB_SECUR.GetDealFICcy( dl_leg.t_CFI ) t_Ccy "
   + " ,RSB_SECUR.GetDealDepName( tick.t_Department ) t_DepartmentName "
   + " ,RSB_SECUR.GetDealOperName( tick.t_Oper ) t_OperName "
   + " ,RSB_SECUR.GetDealSupplyDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry ) t_SupplyDate1 "
   + " ,RSB_SECUR.GetDealSupplyDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " ) t_SupplyDate2 "
   + " ,RSB_SECUR.GetDealSupplyTime2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " ) t_SupplyTime2 "
   + " ,RSB_SECUR.GetDealRejectDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " ) t_RejectDate2 "
   + " ,RSB_SECUR.GetDealPayDate1( dl_leg.t_MaturityIsPrincipal, dl_leg.t_Maturity, dl_leg.t_Expiry ) t_PayDate1 "
   + " ,RSB_SECUR.GetDealPayDate2( tick.t_DealID, " + String( LEG_KIND_DL_TICK_BACK ) + " ) t_PayDate2 "
   + " ,RSB_SECUR.GetDealIsNett( tick.t_DealID, tick.t_BOfficeKind ) t_IsNetting "
   + " ,RSB_SECUR.RSI_IsTechDeal( tick.t_DealID, RsbSessionData.curdate ) t_IsTechDeal ";

  if( (bOfficeKind == DL_SECURITYDOC) OR (bOfficeKind == DL_RETIREMENT) )
    sqlQuery2 = sqlQuery2 +
     " ,(CASE "
   + "      WHEN (select Count(1) from dtxreplobj_dbt where T_OBJECTTYPE = " + OBJKIND_DEAL + " and T_DestID = tick.t_DealID and rownum < 2) > 0 THEN chr(88) "
   + "      ELSE chr(0) "
   + "   END) t_IsReplDeal "
   + " , " + getSql_IsManualMode() + " t_IsManualMode ";
  end;

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery2 = sqlQuery2 +
     " ,NVL( dl_leg2.t_TotalCost, 0 ) t_TotalCost2 "
   + " ,dl_leg2.t_IncomeRate "
   + " ,dl_leg2.t_CliringDate t_CliringDate2 "
   + " ,dl_leg2.t_CliringTime t_CliringTime2 "
   + " ,dl_leg2.t_Session     t_CliringSession2 "
   + " ,dl_leg2.t_CliringChange t_CliringChange2 "
   + " ,( "
    + " SELECT "
      + " MIN( dlrq3.t_FactDate ) "
    + " FROM "
      + " ddlrq_dbt dlrq3 "
    + " WHERE "
          + " dlrq3.t_DocKind(+) = tick.t_BOfficeKind "
      + " AND dlrq3.t_DocID(+) = tick.t_DealID "
      + " AND dlrq3.t_DealPart(+) = 1 "
      + " AND dlrq3.t_Type(+) = " + String( DLRQ_TYPE_DELIVERY ) + " "
   + " ) t_SupplyFactDate1 "
   + " ,( "
    + " SELECT "
      + " MIN( dlrq4.t_FactDate ) "
    + " FROM "
      + " ddlrq_dbt dlrq4 "
    + " WHERE "
          + " dlrq4.t_DocKind(+) = tick.t_BOfficeKind "
      + " AND dlrq4.t_DocID(+) = tick.t_DealID "
      + " AND dlrq4.t_DealPart(+) = 2 "
      + " AND dlrq4.t_Type(+) = " + String( DLRQ_TYPE_DELIVERY ) + " "
   + " ) t_SupplyFactDate2 ";
  end;

  if( bOfficeKind == DL_RETIREMENT )
    sqlQuery2 = sqlQuery2 +
     " ,( "
    + " SELECT "
      + " party.t_ShortName "
    + " FROM "
      + " dparty_dbt party "
    + " WHERE "
      + " party.t_PartyID = dl_leg.t_Registrar "
   + " ) t_DepositaryName "
   + " ,( "
    + " SELECT "
      + " party2.t_ShortName "
    + " FROM "
      + " dparty_dbt party2 "
    + " WHERE "
      + " party2.t_PartyID = fininstr.t_Issuer "
   + " ) t_IssuerName "
   + " ,( "
    + " CASE "
      + " WHEN "
        + " RSB_SECUR.IsRet_Partly( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tick.t_DealType, tick.t_BofficeKind ) ) ) > 0 "
      + " THEN "
        + " 'ЧП' "
      + " WHEN "
        + " RSB_SECUR.IsRet_Coupon( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tick.t_DealType, tick.t_BofficeKind ) ) ) > 0 "
      + " THEN "
        + " 'Куп' "
      + " WHEN "
        + " RSB_SECUR.IsRet_Issue( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tick.t_DealType, tick.t_BofficeKind ) ) ) > 0 "
      + " THEN "
        + " 'Вып' "
      + " ELSE "
        + " '' "
    + " END "
   + " ) t_SymbOfKindOperRetire ";
  end;

  if( bOfficeKind == DL_CONVAVR )
    var T_ID_DLRQ_FOR_WRTSUM_B =
    " (SELECT NVL( (SELECT T_ID " +
    "                FROM DDLRQ_DBT " +
    "                WHERE T_DOCKIND(+) = tick.t_BOfficeKind " +
    "                  AND T_DOCID(+) = tick.t_DealID " +
    "                  AND T_DEALPART(+) = 2 " +
    "                  AND T_TYPE(+) = " + String( DLRQ_TYPE_DELIVERY ) + ") , -1 ) " +
    "          T_ID FROM DUAL) ";

    sqlQuery2 = sqlQuery2 +
    " , (SELECT WRTSUM.T_DATE T_WRTSUM_DATE " +
    " FROM   DPMWRTSUM_DBT WRTSUM " +
    " WHERE  WRTSUM.T_DOCKIND = " + string(29/*DLDOC_PAYMENT*/) +
    "    AND WRTSUM.T_DOCID = " + T_ID_DLRQ_FOR_WRTSUM_B +
    "    AND WRTSUM.T_BUY_SALE = 0 " +
    "    AND WRTSUM.T_PARTNUM = 0) T_WRTSUM_DATE " +

    " , (SELECT WRTSUM.T_TIME T_WRTSUM_TIME " +
    " FROM   DPMWRTSUM_DBT WRTSUM " +
    " WHERE  WRTSUM.T_DOCKIND = " + string(29/*DLDOC_PAYMENT*/) +
    "    AND WRTSUM.T_DOCID = " + T_ID_DLRQ_FOR_WRTSUM_B +
    "    AND WRTSUM.T_BUY_SALE = 0 " +
    "    AND WRTSUM.T_PARTNUM = 0) T_WRTSUM_TIME ";
  end;

  sqlQuery2 = sqlQuery2 +
    " FROM "
    + " ddl_tick_dbt tick "
   + " ,ddl_leg_dbt dl_leg "
   + " ,dfininstr_dbt fininstr "
   + " ,davoiriss_dbt avoiriss ";

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery2 = sqlQuery2 +
     " ,ddl_leg_dbt dl_leg2 "
  end;

  sqlQuery2 = sqlQuery2 +
    " WHERE "
        + " tick.t_BofficeKind = " + String( bOfficeKind ) + " "
    + " AND tick.t_DealID IN "
    + " ( "
    + sqlQuery
    + " ) "
    + " AND dl_leg.t_LegKind = " + String( LEG_KIND_DL_TICK ) + " "
    + " AND dl_leg.t_DealID = tick.t_DealID "
    + " AND dl_leg.t_LegID = 0 "
    + " AND fininstr.t_FIID = tick.t_PFI "
    + " AND avoiriss.t_FIID = fininstr.t_FIID ";

  if( bOfficeKind == DL_SECURITYDOC )
    sqlQuery2 = sqlQuery2 +
      " AND dl_leg2.t_LegKind(+) = " + String( LEG_KIND_DL_TICK_BACK ) + " "
    + " AND dl_leg2.t_DealID(+) = tick.t_DealID "
    + " AND dl_leg2.t_LegID(+) = 0 ";
  end;

  sqlQuery2 = sqlQuery2 +
    " ORDER BY "
      + sortOrder;

  //fprintln( "_deallist_query_", sqlQuery2 );

  rsdCmd = RSDCommand( sqlQuery2 );

  rsdCmd.NullConversion = true;
  rsdCmd.Execute();

  dataSet = TRsbDataSet( rsdCmd );

  while( ( dataSet != null ) and ( dataSet.MoveNext() ) )
    deal = CScDealList();

    deal.DealCode             = SQL_ConvTypeStr( dataSet.DealCode );
    deal.DealDate             = SQL_ConvTypeDate( dataSet.DealDate );
    deal.DealType             = SQL_ConvTypeInteger( dataSet.DealType );
    deal.State                = SQL_ConvTypeInteger( dataSet.State );
    deal.StateName            = SQL_ConvTypeStr( dataSet.StateName );
    deal.ClientID             = SQL_ConvTypeInteger( dataSet.ClientID );
    deal.ClientName           = SQL_ConvTypeStr( dataSet.ClientName );
    deal.ClientContrID        = SQL_ConvTypeInteger( dataSet.ClientContrID );
    deal.ClientSfContr        = SQL_ConvTypeStr( dataSet.ClientSfContr );
    deal.FIID                 = SQL_ConvTypeInteger( dataSet.FIID );
    deal.IssCode              = SQL_ConvTypeStr( dataSet.IssCode );
    deal.IssName              = SQL_ConvTypeStr( dataSet.IssName );
    deal.ISIN                 = SQL_ConvTypeStr( dataSet.ISIN );
    deal.BaseAmount           = SQL_ConvTypeSum( dataSet.BaseAmount );
    deal.TotalCost1           = SQL_ConvTypeSum( dataSet.TotalCost1 );
    deal.CFI                  = SQL_ConvTypeInteger( dataSet.CFI );
    deal.Ccy                  = SQL_ConvTypeStr( dataSet.Ccy );
    deal.DealCodeTS           = SQL_ConvTypeStr( dataSet.DealCodeTS );
    deal.DealID               = SQL_ConvTypeInteger( dataSet.DealID );
    deal.Department           = SQL_ConvTypeInteger( dataSet.Department );
    deal.DepartmentName       = SQL_ConvTypeStr( dataSet.DepartmentName );
    deal.BofficeKind          = SQL_ConvTypeInteger( dataSet.BofficeKind );

    if( bOfficeKind == DL_SECURITYDOC )
      deal.TypeCode             = SQL_ConvTypeStr( dataSet.TypeCode );
      deal.PartyID              = SQL_ConvTypeInteger( dataSet.PartyID );
      deal.ContrName            = SQL_ConvTypeStr( dataSet.ContrName );
      deal.RootAvrKind          = SQL_ConvTypeInteger( dataSet.RootAvrKind );
      deal.NalogGroup           = SQL_ConvTypeInteger( dataSet.NalogGroup );
      deal.TotalCost2           = SQL_ConvTypeSum( dataSet.TotalCost2 );
      deal.IncomeRate           = SQL_ConvTypeSum( dataSet.IncomeRate );
      deal.PayDate1             = SQL_ConvTypeDate( dataSet.PayDate1 );
      deal.PayFactDate1         = SQL_ConvTypeDate( dataSet.PayFactDate1 );
      deal.PayDate2             = SQL_ConvTypeDate( dataSet.PayDate2 );
      deal.PayFactDate2         = SQL_ConvTypeDate( dataSet.PayFactDate2 );
      deal.ChangeDate           = SQL_ConvTypeDate( dataSet.ChangeDate );
      deal.RejectDate1          = SQL_ConvTypeDate( dataSet.RejectDate1 );
      deal.RejectDate2          = SQL_ConvTypeDate( dataSet.RejectDate2 );
      deal.IsNetting            = ( SQL_ConvTypeInteger( dataSet.IsNetting ) > 0 );
      deal.SupplyDate1          = SQL_ConvTypeDate( dataSet.SupplyDate1 );
      deal.SupplyFactDate1      = SQL_ConvTypeDate( dataSet.SupplyFactDate1 );
      deal.SupplyTime1          = SQL_ConvTypeTime( dataSet.SupplyTime1 );
      deal.SupplyDate2          = SQL_ConvTypeDate( dataSet.SupplyDate2 );
      deal.SupplyFactDate2      = SQL_ConvTypeDate( dataSet.SupplyFactDate2 );
      deal.SupplyTime2          = SQL_ConvTypeTime( dataSet.SupplyTime2 );
      deal.Oper                 = SQL_ConvTypeInteger( dataSet.Oper );
      deal.OperName             = SQL_ConvTypeStr( dataSet.OperName );
      deal.UserField1           = SQL_ConvTypeStr( dataSet.UserField1 );
      deal.UserField2           = SQL_ConvTypeStr( dataSet.UserField2 );
      deal.UserField3           = SQL_ConvTypeStr( dataSet.UserField3 );
      deal.UserField4           = SQL_ConvTypeStr( dataSet.UserField4 );
      deal.Comment              = SQL_ConvTypeStr( dataSet.Comment );
      deal.NeedSetColorCliring  = SC_NeedSetColorCliring(
        SQL_ConvTypeDate( dataSet.CliringDate1 ),
        SQL_ConvTypeDate( dataSet.CliringDate2 ),
        ( SQL_ConvTypeStr( dataSet.CliringChange1 ) == SET_CHR ),
        ( SQL_ConvTypeStr( dataSet.CliringChange2 ) == SET_CHR ) );
      deal.IsTechDeal           = (SQL_ConvTypeInteger( dataSet.IsTechDeal ) > 0 );
      deal.IsReplDeal           = SQL_ConvTypeStr( dataSet.IsReplDeal ) == SET_CHR;
      deal.IsManualMode         = SQL_ConvTypeStr( dataSet.IsManualMode ) == SET_CHR;
    elif( BofficeKind == DL_RETIREMENT )
      deal.Issuer               = SQL_ConvTypeInteger( dataSet.Issuer );
      deal.IssuerName           = SQL_ConvTypeStr( dataSet.IssuerName );
      deal.SymbOfKindOperRetire = SQL_ConvTypeStr( dataSet.SymbOfKindOperRetire );
      deal.Depositary           = SQL_ConvTypeInteger( dataSet.Registrar );
      deal.DepositaryName       = SQL_ConvTypeStr( dataSet.DepositaryName );
      deal.IsReplDeal           = SQL_ConvTypeStr( dataSet.IsReplDeal ) == SET_CHR;
      deal.IsManualMode         = SQL_ConvTypeStr( dataSet.IsManualMode ) == SET_CHR;
    elif( BofficeKind == DL_CONVAVR )
      deal.TypeCode       = SQL_ConvTypeStr( dataSet.TypeCode );
      deal.PartyID        = SQL_ConvTypeInteger( dataSet.PartyID );
      deal.ContrName      = SQL_ConvTypeStr( dataSet.ContrName );
      deal.NalogGroup     = SQL_ConvTypeInteger( dataSet.NalogGroup );
      deal.PayDate1       = SQL_ConvTypeDate( dataSet.PayDate1 );
      deal.PayDate2       = SQL_ConvTypeDate( dataSet.PayDate2 );
      deal.IsNetting      = ( SQL_ConvTypeStr( dataSet.IsNetting ) == SET_CHR );
      deal.SupplyDate1    = SQL_ConvTypeDate( dataSet.SupplyDate1 );
      deal.SupplyTime1    = SQL_ConvTypeTime( dataSet.SupplyTime1 );
      deal.SupplyDate2    = SQL_ConvTypeDate( dataSet.WRTSUM_DATE );
      deal.SupplyTime2    = SQL_ConvTypeTime( dataSet.WRTSUM_TIME );
      deal.Oper           = SQL_ConvTypeInteger( dataSet.Oper );
      deal.OperName       = SQL_ConvTypeStr( dataSet.OperName );
      deal.UserField1     = SQL_ConvTypeStr( dataSet.UserField1 );
      deal.UserField2     = SQL_ConvTypeStr( dataSet.UserField2 );
      deal.UserField3     = SQL_ConvTypeStr( dataSet.UserField3 );
      deal.UserField4     = SQL_ConvTypeStr( dataSet.UserField4 );
      deal.Comment        = SQL_ConvTypeStr( dataSet.Comment );
    elif( BofficeKind == DL_AVRWRT )
      deal.TypeCode       = SQL_ConvTypeStr( dataSet.TypeCode );
      deal.PartyID        = SQL_ConvTypeInteger( dataSet.PartyID );
      deal.ContrName      = SQL_ConvTypeStr( dataSet.ContrName );
      deal.NalogGroup     = SQL_ConvTypeInteger( dataSet.NalogGroup );
      deal.PayDate1       = SQL_ConvTypeDate( dataSet.PayDate1 );
      deal.PayDate2       = SQL_ConvTypeDate( dataSet.PayDate2 );
      deal.IsNetting      = ( SQL_ConvTypeStr( dataSet.IsNetting ) == SET_CHR );
      deal.SupplyDate1    = SQL_ConvTypeDate( dataSet.SupplyDate1 );
      deal.SupplyTime1    = SQL_ConvTypeTime( dataSet.SupplyTime1 );
      deal.SupplyDate2    = SQL_ConvTypeDate( dataSet.SupplyDate2 );
      deal.SupplyTime2    = SQL_ConvTypeTime( dataSet.SupplyTime2 );
      deal.Oper           = SQL_ConvTypeInteger( dataSet.Oper );
      deal.OperName       = SQL_ConvTypeStr( dataSet.OperName );
      deal.UserField1     = SQL_ConvTypeStr( dataSet.UserField1 );
      deal.UserField2     = SQL_ConvTypeStr( dataSet.UserField2 );
      deal.UserField3     = SQL_ConvTypeStr( dataSet.UserField3 );
      deal.UserField4     = SQL_ConvTypeStr( dataSet.UserField4 );
      deal.Comment        = SQL_ConvTypeStr( dataSet.Comment );
    end;

    dealList[dealList.Size] = deal;
  end;

  return dealList;

OnError( err )
  ScDealRunError( err, stat );
end;

// Перерасчет сумм одной части по другой. (для операции конвертации ц/б)
private macro RecalcAmount( Deal )
  var stat : Integer = -1;
  var FI = TRecHandler( "fininstr.dbt" );
  var avr:CTxAvoirIss;
  var NumAvr:Double;

  // по части, в которой задана депозитарная расписка
  if( Deal.IsConvShare )
     if( (SP_GetFIID(Deal.Iss_b) > 0) and (not ПолучитьФинИн(Deal.Iss_b.FIID, FI)) )
        avr = TxGetAvoirIss(FI.rec.FIID);
        NumAvr = avr.NumBaseFI;

        if( NumAvr > 0 )
           Deal.Principal_b = Deal.Principal/NumAvr;
        end;
     end;
  elif( Deal.IsConvReceipt )
     if( (SP_GetFIID(Deal.Iss) > 0) and (not ПолучитьФинИн(Deal.Iss.FIID, FI)) )
        avr = TxGetAvoirIss(FI.rec.FIID);
        NumAvr = avr.NumBaseFI;

        if( NumAvr > 0 )
           Deal.Principal_b = Deal.Principal*NumAvr;
        end;
     end;
  end;

OnError( err )
  ScDealRunError( err, stat );
end;

// Подсчет кол-ва списываемых бумаг. (для операции конвертации ц/б)
private macro CalcWriteOffAmount( Deal )
  var stat : Integer = -1;

  if( (SP_GetFIID(Deal.Iss) > 0)
  and ((Deal.BaseDate != null) and (Deal.BaseDate != ZeroDate))
  and ((Deal.Portfolio != null) and (Deal.Portfolio.Element != null))
  and (Deal.Portfolio.Element != KINDPORT_UNDEF)
  and ((Deal.Portfolio.Element != KINDPORT_CLIENT) or (SP_GetPartyID(Deal.Client) != UnknownParty))
  )
    var Contr:Integer = 0;
    if( SP_GetContrID(Deal.ClientContr) > 0 )
       Contr = Deal.ClientContr.ID;
    end;

    Deal.Principal = Web_WRTGetPortfolioAmount(SP_GetDprtCode(Deal.Department), Deal.Iss.Fiid, SP_GetPartyID(Deal.Client), Contr, Deal.Portfolio.Element, Deal.BaseDate );

    RecalcAmount( Deal );
  end;

OnError( err )
  ScDealRunError( err, stat );
end;

// обновление портфелей для операции концертации ц/б (BofficeKind == DL_CONVAVR)
private macro UpdatePortfolioConv( Deal )
  var stat : Integer = -1;

  if( Deal.BofficeKind != DL_TRUSTAVRWRT )
     if( Deal.ChangedProperty == "Portfolio" )
        if( (Deal.Portfolio != null) and (Deal.Portfolio.Element != null) )
           if( Deal.Portfolio.Element == KINDPORT_CLIENT )
              Deal.Portfolio_2 = Deal.Portfolio;
           end;
        end;
     elif( Deal.ChangedProperty == "Portfolio_2" )
        if( (Deal.Portfolio_2 != null) and (Deal.Portfolio_2.Element != null) )
           if( Deal.Portfolio_2.Element == KINDPORT_CLIENT )
              Deal.Portfolio = Deal.Portfolio_2;
           end;
        end;
     end;
  end;

OnError( err )
  ScDealRunError( err, stat );
end;

// для операции займа
private macro RecalculatePC( Deal )
  Deal.ReturnIncome = (Deal.Cost + Deal.NKD) * Deal.IncomeRate / 100 * Deal.NumDays / (SP_GetNDaysByBasis(SP_GetNameAlgNumberAlg(Deal.BasisCalc), Deal.ContrDate));
end;

private macro Web_ChangeDate( Deal )
   if( (Deal.NumDays > 0) and (Deal.NumDays <= 9999) and (Deal.BaseDate != null) and (Deal.BaseDate != ZeroDate) )
      Deal.ContrDate = SP_ChangeDate(Deal.BaseDate, SP_GetNameAlgNumberAlg(Deal.BasisCalc), Deal.NumDays);
      RecalculatePC( Deal );
      Deal.ReturnIncomeLoan = SP_CalcReturnIncome(SP_GetFIID(Deal.Iss), Deal.BaseDate, Deal.ContrDate, Deal.Principal, Deal.Flag3);
   end;
end;

// для операции займа
private macro AfterChangeIss( Deal )
   var FinInstr = TRecHandler( "fininstr" );

   if( ( SP_GetFIID( Deal.Iss ) > ALLFININSTR )
   and ( ПолучитьФинИн( Deal.Iss.FIID, Fininstr ) == 0 )
   and ( not FI_IsCouponAvoiriss( Fininstr ) ) )
      Deal.Flag3 = false;
      Deal.ReturnIncomeLoan = $0;
   end;
end;

// для операции займа
private macro UpdateNumDays( Deal )
   if( (Deal.BaseDate != null)
   and (Deal.BaseDate != ZeroDate)
   and (Deal.ContrDate != null)
   and (Deal.ContrDate != ZeroDate)
   and (Deal.ContrDate > Deal.BaseDate) )
      Deal.NumDays = SP_GetPeriod(SP_GetNameAlgNumberAlg(Deal.BasisCalc), Deal.ContrDate, Deal.BaseDate);
      RecalculatePC(Deal);
      Deal.ReturnIncomeLoan = SP_CalcReturnIncome(SP_GetFIID(Deal.Iss), Deal.BaseDate, Deal.ContrDate, Deal.Principal, Deal.Flag3);
   end;
end;

// для операции займа
private macro Web_RecalculateNKDOutDate( PanelDeal, IsBackSale:bool ):bool

  var RetVal = true;
  var BaseDate:Date;

  var Tick = TRecHandler("dl_tick");
  var Leg = TRecHandler("dl_leg");

  SetTick_ByCScDeal(Tick.rec, PanelDeal.Deal);
  SetLeg_ByCScDeal(Leg.rec, PanelDeal.Deal, IIF(IsBackSale, 2, 1));

  if( PanelDeal.Deal.FactContrDate != ZeroDate)
     BaseDate = PanelDeal.Deal.FactContrDate;
  else
	 BaseDate = PanelDeal.Deal.ContrDate;
  end;

  if( BaseDate > PanelDeal.Deal.ContrDate )
     PanelDeal.Deal.NKD_b = Web_RecalculateNKD_OutDate( Tick, Leg, BaseDate ); // ReceiptAmount = NKD_b
  end;

  return RetVal;
end;

// Дополнительный обработчик по полю "Код ц/б" для операции конвертации ц/б
private macro proc_Avoiriss_Conv( Deal )
  var stat:integer = -1;

  CalcWriteOffAmount( Deal );

  RecalcAmount( Deal );

OnError( err )
  ScDealRunError(err, stat);
end;

private macro GetPartyLegalForm(PartyID:integer):integer
  var LegalForm = PTLEGF_ALL;
  var pt = TBFile("party.dbt");

  pt.rec.PartyID = PartyID;
  if(pt.GetEQ())
    LegalForm = pt.rec.LegalForm;
  end;

  return LegalForm;
end;

private macro IsExistNPTXLot( DocID )

  var query = RSDCommand( " SELECT count(1) CountLot " +
                        "   from dnptxlot_dbt txlot " +
                        "  where (txlot.t_dockind = ? or txlot.t_dockind = ?)" +
                        "    and txlot.t_docid = ? ");

  query.NullConversion = true;
  query.addParam( "", RSDBP_IN, DL_AVRWRT );
  query.addParam( "", RSDBP_IN, DL_TRUSTAVRWRT );
  query.addParam( "", RSDBP_IN, DocID );

  query.execute();

  var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  var Exist = false;

  if( ds.MoveNext() and (ds.CountLot > 0) )
     Exist = true;
  end;

  return Exist;
end;

/*Заполнение вкладки данные для НУ*/
private macro ClearAvrWrtTax(Deal)
   Deal.WrtTaxCostDate = ZeroDate;
   Deal.WrtTaxCostSum = $0;
   Deal.WrtTaxPriceSum = $0;
   Deal.WrtTaxNkdSum = $0;
   Deal.WrtTaxOutlaySum = $0;
   Deal.Flag2 = false;
   Deal.Flag3 = false;
end;

private macro FillAvrWrtTaxSum(Deal)
   var DlSum  = TRecHandler("dlsum");
   if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_PRICEWRTTAX, IIF(Deal.WrtTaxCostDate == ZeroDate, Deal.DealDate, Deal.WrtTaxCostDate), DlSum) == 0)
       Deal.WrtTaxPriceSum = DlSum.rec.Sum;
   else
       Deal.WrtTaxPriceSum = SQL_ConvTypeSum(Deal.Price);
   end;

   if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_NKDWRTTAX, IIF(Deal.WrtTaxCostDate == ZeroDate, Deal.DealDate, Deal.WrtTaxCostDate), DlSum) == 0)
       Deal.WrtTaxNkdSum = DlSum.rec.Sum;
   else
       Deal.WrtTaxNkdSum = Deal.NKD;
   end;

   if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_OUTLAYWRTTAX, IIF(Deal.WrtTaxCostDate == ZeroDate, Deal.DealDate, Deal.WrtTaxCostDate), DlSum) == 0)
       Deal.WrtTaxOutlaySum = DlSum.rec.Sum;
   else
       Deal.WrtTaxOutlaySum = Deal.BuyOutlay;
   end;
   if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_COSTWRTTAX, IIF(Deal.WrtTaxCostDate == ZeroDate, Deal.DealDate, Deal.WrtTaxCostDate), DlSum) == 0)
       Deal.WrtTaxCostDate = DlSum.rec.Date;
   else
       Deal.WrtTaxCostDate = Deal.Start;
   end;
   if( Deal.WrtTaxPriceSum > 0. )
      Deal.WrtTaxCostSum = Deal.WrtTaxPriceSum * Deal.Principal;
   end;
end;

// Получение значений вкладки "Сделка"
macro ScGetDeal( DealID:integer ):CScDeal
  var stat:integer = -1;
  var query = "";
  var cmd = null;
  var ds = null;
  var ScDeal = CScDeal();
  var RQ = null;
  var Iss = TRecHandler("fininstr");
  var nominal_fiid = NATCUR;

  InitError();

  if( (DealID == null) or (DealID <= 0) )
     RunError("Не задан обязательный параметр функции: ID сделки");
  end;

  query = " SELECT "
            + " leg.t_ID AS t_Leg_ID "
           + " ,tick.t_BOfficeKind "
           + " ,tick.t_DealCode "
           + " ,tick.t_DealDate "
           + " ,tick.t_DealTime "
           + " ,tick.t_IsNetting "
           + " ,tick.t_DealCodeTS "
           + " ,tick.t_Country AS t_DealCountry "
           + " ,leg.t_RejectDate "
           + " ,leg.t_IncomeRate AS t_IR "
           + " ,tick.t_TypeDoc "
           + " ,tick.t_Flag1 "
           + " ,tick.t_Flag2 "
           + " ,tick.t_Flag3 "
           + " ,tick.t_Flag4 "
           + " ,tick.t_Flag5 "
           + " ,tick.t_CloseDate "
           + " ,leg.t_ReturnIncome AS t_RI "
           + " ,leg.t_ReceiptAmount AS t_RA "
           + " ,(CASE "
                 + " WHEN tick.t_IsPFI = 'X' "
                  + " THEN 1 "
                  + " ELSE 0 "
             + " END) AS t_IsSetDVExe "
           + " ,tick.t_Prognos "
           + " ,tick.t_IsPartyClient "
           + " ,tick.t_MarketID AS t_Trader "
           + " ,tick.t_MarketSchemeID AS t_MarketSchem "
           + " ,(SELECT "
                 + " NVL(ptoffice.t_OfficeName, CHR(1)) "
             + " FROM "
                 + " dptoffice_dbt ptoffice "
           + " WHERE "
                 + " ptoffice.t_PartyID = tick.t_TraderID "
             + " AND ptoffice.t_OfficeID = tick.t_MarketOfficeID) AS t_CenterOfficeName "
           + " ,tick.t_DepSetID AS t_DepoSchem "
           + " ,fin.t_AvoirKind AS t_IssKind "
           + " ,fin.t_Issuer AS t_Issuer "
           + " ,leg.t_PFI "
           + " ,leg.t_DeliveringFIID "
           + " ,tick.t_FixSum "
           + " ,leg.t_Formula "
           + " ,leg.t_Principal "
           + " ,leg.t_RelativePrice "
           + " ,leg.t_Price "
           + " ,leg.t_Point "
           + " ,leg.t_IncomePoint "
           + " ,leg.t_CFI "
           + " ,leg.t_Cost "
           + " ,leg.t_NKD "
           + " ,leg.t_NKDFIID "
           + " ,leg.t_TotalCost "
           + " ,leg.t_PayFIID "
           + " ,tick.t_PreOutlay "
           + " ,tick.t_PreOutlayFIID "
           + " ,tick.t_CommDate "
           + " ,leg.t_StartDiff "
           + " ,leg.t_StartBase "
           + " ,leg.t_Start "
           + " ,leg.t_Diff "
           + " ,leg.t_Base "
           + " ,leg.t_PayRegTax "
           + " ,leg.t_Registrar "
           + " ,leg.t_RegistrarContrID AS t_RegistrarContr "
           + " ,leg.t_DepositID "
           + " ,leg.t_MaturityIsPrincipal "
           + " ,leg.t_Expiry "
           + " ,leg.t_Maturity "
           + " ,leg.t_CliringDate "
           + " ,leg.t_CliringTime "
           + " ,leg.t_Session "
           + " ,leg.t_CliringChange "
           + " ,leg.t_PrincipalDiff "
           + " ,leg.t_PrincipalBase "
           + " ,leg.t_SupplyTime "
           + " ,tick.t_PortfolioID "
           + " ,tick.t_PortfolioID_2 "
           + " ,tick.t_ClientID "
           + " ,tick.t_ClientContrID "
           + " ,tick.t_BrokerID "
           + " ,tick.t_BrokerContrID "
           + " ,tick.t_PartyID "
           + " ,tick.t_PartyContrID "
           + " ,tick.t_Department "
           + " ,tick.t_Oper "
           + " ,tick.t_Version AS t_DealVersion "
           + " ,leg.t_Version AS t_LegVersion "
           + " ,tick.t_DealType "
           + " ,tick.t_DealStatus "
           + " ,tick.t_ChangeDate "
           + " ,tick.t_TraderID "
           + " ,tick.t_MarketOfficeID "
           + " ,tick.t_OriginID "
           + " ,tick.t_Blocked "
           + " ,tick.t_ReturnIncomeKind "
           + " ,tick.t_Number_Coupon "
           + " ,tick.t_Number_Partly "
           + " ,leg.t_OperState "
           + " ,leg.t_Basis "
           + " ,fin2.t_AvoirKind AS t_IssKind_b "
           + " ,fin2.t_Issuer AS t_Issuer_b "
           + " ,leg2.t_ID AS t_Leg_ID_b "
           + " ,leg2.t_RejectDate AS t_RejectDate_b "
           + " ,leg2.t_IncomeRate AS t_IncomeRate_b "
           + " ,leg2.t_ReturnIncome AS t_ReturnIncome_b "
           + " ,leg2.t_MaturityIsPrincipal AS t_MaturityIsPrincipal_b "
           + " ,leg2.t_Expiry AS t_Expiry_b "
           + " ,leg2.t_Maturity AS t_Maturity_b "
           + " ,leg2.t_SupplyTime AS t_SupplyTime_b "
           + " ,leg2.t_CliringDate AS t_CliringDate_b "
           + " ,leg2.t_CliringTime AS t_CliringTime_b "
           + " ,leg2.t_Session AS t_CliringSession_b "
           + " ,leg2.t_CliringChange AS t_CliringChange_b "
           + " ,leg2.t_DeliveringFIID AS t_DeliveringFIID_b "
           + " ,leg2.t_Principal AS t_Principal_b "
           + " ,leg2.t_RelativePrice AS t_RelativePrice_b "
           + " ,leg2.t_Price AS t_Price_b "
           + " ,leg2.t_CFI AS t_CFI_b "
           + " ,leg2.t_Cost AS t_Cost_b "
           + " ,leg2.t_NKD AS t_NKD_b "
           + " ,leg2.t_NKDFIID AS t_NKDFIID_b "
           + " ,leg2.t_TotalCost AS t_TotalCost_b "
           + " ,leg2.t_Version AS t_LegVersion_b "
           + " ,leg2.t_OperState AS t_OperState_b "
           + " ,leg2.t_PayRegTax AS t_PayRegTax_b "
           + " ,leg2.t_Registrar AS t_Registrar_b "
           + " ,leg2.t_RegistrarContrID AS t_RegistrarContr_b "
           + " ,leg2.t_Start AS t_Start_b "
           + " ,leg2.t_Formula AS t_Formula_b "
           + " ,leg2.t_StartDiff AS t_StartDiff_b "
           + " ,leg2.t_StartBase AS t_StartBase_b "
           + " ,leg2.t_Diff AS t_Diff_b "
           + " ,leg2.t_Base AS t_Base_b "
           + " ,leg2.t_DepositID AS t_DepositID_b "
           + " ,leg2.t_PrincipalDiff AS t_PrincipalDiff_b "
           + " ,leg2.t_PrincipalBase AS t_PrincipalBase_b "
           + " ,leg2.t_PFI AS t_PFI_b "
           + " ,clir.t_ValueDate AS t_ValueDate_c "
           + " ,clir.t_Price AS t_Price_c "
           + " ,clir.t_Cost AS t_Cost_c "
           + " ,clir.t_NKD AS t_NKD_c "
           + " ,clir.t_TotalCost AS t_TotalCost_c "
           + " ,clir2.t_ValueDate AS t_ValueDate_cb "
           + " ,clir2.t_Price AS t_Price_cb "
           + " ,clir2.t_Cost AS t_Cost_cb "
           + " ,clir2.t_NKD AS t_NKD_cb "
           + " ,clir2.t_TotalCost AS t_TotalCost_cb "
        + " FROM "
            + " ddl_tick_dbt tick "
           + " ,ddl_leg_dbt leg "
           + " ,ddl_leg_dbt leg2 "
           + " ,ddlclir_dbt clir "
           + " ,ddlclir_dbt clir2 "
           + " ,dfininstr_dbt fin "
           + " ,dfininstr_dbt fin2 "
        + " WHERE "
            + " tick.t_DealID = ? "
        + " AND leg.t_LegKind = " + LEG_KIND_DL_TICK + " "
        + " AND leg.t_DealID = tick.t_DealID "
        + " AND leg.t_LegID = 0 "
        + " AND leg2.t_LegKind(+) = " + LEG_KIND_DL_TICK_BACK + " "
        + " AND leg2.t_DealID(+) = tick.t_DealID "
        + " AND leg2.t_LegID(+) = 0 "
        + " AND clir.t_DealID(+) = tick.t_DealID "
        + " AND clir.t_LegID(+) = " + LEG_KIND_DL_TICK + " "
        + " AND clir2.t_DealID(+) = tick.t_DealID "
        + " AND clir2.t_LegID(+) = " + LEG_KIND_DL_TICK_BACK + " "
        + " AND fin.t_FIID = leg.t_PFI "
        + " AND fin2.t_FIID(+) = leg2.t_PFI ";

  cmd = RSDCommand( query );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, DealID );
  cmd.execute();

  ds = TRsbDataSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );

  if( ds.MoveNext() )

     var FD = SPFirstDoc( LEG_KIND_DL_TICK, DealID );
     var FD_b = SPFirstDoc( LEG_KIND_DL_TICK_BACK, DealID );

     SetCScDeal_ByBOKO( SQL_ConvTypeInteger(ds.BOfficeKind), SQL_ConvTypeInteger(ds.DealType), SQL_ConvTypeInteger(ds.Oper), ScDeal );
     ScDeal.ExistLot             = SP_ExistLotByDeal(DealID);

     ScDeal.DealID               = DealID;
     ScDeal.BOfficeKind          = SQL_ConvTypeInteger(ds.BOfficeKind);
     ScDeal.Leg_ID               = SQL_ConvTypeInteger(ds.Leg_ID);
     ScDeal.DealCode             = SQL_ConvTypeStr(ds.DealCode);
     ScDeal.DealDate             = SQL_ConvTypeDate(ds.DealDate);
     ScDeal.CloseDate            = SQL_ConvTypeDate(ds.CloseDate);
     ScDeal.DealTime             = SQL_ConvTypeTime(ds.DealTime);
     ScDeal.IsNetting            = (SQL_ConvTypeStr(ds.IsNetting) == SET_CHAR);
     ScDeal.DealCodeTS           = SQL_ConvTypeStr(ds.DealCodeTS);
     ScDeal.DealCountry          = CreateCountryFromAppServ(SQL_ConvTypeStr(ds.DealCountry));
     ScDeal.RejectDate           = SQL_ConvTypeDate(ds.RejectDate);
     ScDeal.TypeDoc              = CreateTypeAcFromAppServ(154/*TA_TYPE_DEAL*/, SQL_ConvTypeStr(ds.TypeDoc));
     ScDeal.TypeDocList          = GetListTypeAc(154/*TA_TYPE_DEAL*/);
     ScDeal.Flag1                = (SQL_ConvTypeStr(ds.Flag1) == SET_CHAR);
     ScDeal.IsSetDVExe           = (SQL_ConvTypeInteger(ds.IsSetDVExe) == 1);
     ScDeal.IsPrognos            = (SQL_ConvTypeStr(ds.Prognos) == SET_CHAR);
     ScDeal.IsPartyClient        = (SQL_ConvTypeStr(ds.IsPartyClient) == SET_CHAR);
     ScDeal.Trader               = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Trader));
     ScDeal.MarketSchem          = ScGetMarketByID(SQL_ConvTypeInteger(ds.MarketSchem));
     ScDeal.CenterOfficeName     = SQL_ConvTypeStr(ds.CenterOfficeName);
     ScDeal.DepoSchem            = ScGetDepSetByID(SQL_ConvTypeInteger(ds.DepoSchem));
     ScDeal.IssKind              = TxGetAvrKindsById(SQL_ConvTypeInteger(ds.IssKind));
     ScDeal.Issuer               = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Issuer));
     ScDeal.Iss                  = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PFI));
     ScDeal.Iss_ISIN             = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PFI), CODE_ISIN);
     ScDeal.IssAvoirIss          = CTxAvoirIss();
     if( SP_GetFIID( ScDeal.Iss ) > ALLFININSTR )
       ScDeal.IssAvoirIss        = TxGetAvoirIss(ScDeal.Iss.Fiid);
     end;
     ScDeal.DeliverIss           = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.DeliveringFIID));
     if( ScDeal.BOfficeKind == DL_CONVAVR )
        RQ = FD.GetRQ(DLRQ_TYPE_DELIVERY, 2, null, null, false);
        if( RQ != null )
           var query_ = RSDCommand( " SELECT WRTSUM.T_DATE WRTSUM_DATE, " +
                                                   "        WRTSUM.T_TIME WRTSUM_TIME " +
                                                   " FROM   DPMWRTSUM_DBT WRTSUM " +
                                                   " WHERE  WRTSUM.T_DOCKIND = ? " +
                                                   "        AND WRTSUM.T_DOCID = ? " +
                                                   "        AND WRTSUM.T_BUY_SALE = ? " +
                                                   "        AND WRTSUM.T_PARTNUM = ?;" );
           query_.NullConversion = true;
           query_.addParam( "", RSDBP_IN, 29/*DLDOC_PAYMENT*/ );
           query_.addParam( "", RSDBP_IN, RQ.rec.ID );
           query_.addParam( "", RSDBP_IN, 0/*Buy_Sale_Back*/ );
           query_.addParam( "", RSDBP_IN, 0 );
           query_.execute();

           var ds_ = TRsbDataSet(query_, RSDVAL_CLIENT, RSDVAL_STATIC);

           if( ds_.MoveNext() )
              ScDeal.WrtSum_b_Date     = SQL_ConvTypeDate(ds_.WRTSUM_DATE);
              ScDeal.WrtSum_b_Time     = SQL_ConvTypeTime(ds_.WRTSUM_TIME);
           end;
        end;
        ScDeal.Iss_b             = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PFI_b));
        if( SP_GetFIID(ScDeal.Iss_b) > ALLFININSTR )
          ScDeal.IssAvoirIss_b   = TxGetAvoirIss(ScDeal.Iss_b.Fiid);
        end;
        ScDeal.IssKind_b         = TxGetAvrKindsById(SQL_ConvTypeInteger(ds.IssKind_b));
        ScDeal.Issuer_b          = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Issuer_b));
        ScDeal.Principal_b       = SQL_ConvTypeSum(ds.Principal_b);
        ScDeal.Crnc_b            = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.CFI_b), CODE_Ccy);
     end;
     ScDeal.FixSum               = CreateNameAlgFromAppServ(3126, SQL_ConvTypeInteger(ds.FixSum));
     ScDeal.PeriodType           = CreateNameAlgFromAppServ(3123, IIF(SQL_ConvTypeStr(ds.Flag3) == SET_CHAR, 1, 0));
     ScDeal.TypeCalc             = CreateTypeAcFromAppServ(155/*TA_TYPE_CALC*/, StrFor(SQL_ConvTypeInteger(ds.Formula)));
     ScDeal.TypeCalcList         = GetListTypeAc(155/*TA_TYPE_CALC*/);
     ScDeal.Principal            = SQL_ConvTypeSum(ds.Principal);
     ScDeal.RelativePrice        = (SQL_ConvTypeStr(ds.RelativePrice) == SET_CHAR);
     ScDeal.Price                = SQL_ConvTypeSum(ds.Price);
     ScDeal.Point                = SQL_ConvTypeInteger(ds.Point);
     ScDeal.Crnc                 = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.CFI), CODE_Ccy);
     ScDeal.Cost                 = SQL_ConvTypeSum(ds.Cost);
     ScDeal.NKD                  = SQL_ConvTypeSum(ds.NKD);
     ScDeal.Nom                  = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.NKDFIID), CODE_Ccy);
     ScDeal.TotalCost            = SQL_ConvTypeSum(ds.TotalCost);
     ScDeal.CrncPay              = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PayFIID), CODE_Ccy);
     ScDeal.PreOutlay            = SQL_ConvTypeSum(ds.PreOutlay);
     ScDeal.CrncPreOutlay        = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PreOutlayFIID), CODE_Ccy);
     ScDeal.CommDate             = SQL_ConvTypeDate(ds.CommDate);
     ScDeal.Avance               = FD.ExistAvance();
     ScDeal.Deposit              = FD.ExistDeposit();
     ScDeal.StartDiff            = SQL_ConvTypeInteger(ds.StartDiff);
     // ALG_FROMDATE совпадает с ALG_SP_WEB_KIND_TYPEPERIOD
     ScDeal.PeriodTypeAvance     = CreateNameAlgFromAppServ(/*ALG_SP_WEB_KIND_TYPEPERIOD*/3159, SQL_ConvTypeInteger(ds.StartBase));
     ScDeal.Start                = SQL_ConvTypeDate(ds.Start);
     if( ScDeal.Avance )
        RQ = FD.GetRQ(DLRQ_TYPE_AVANCE, null, null, null, false);
     elif( ScDeal.Deposit )
        RQ = FD.GetRQ(DLRQ_TYPE_DEPOSIT, null, null, null, false);
     else
        RQ = null
     end;
     if( RQ != null )
        ScDeal.FactAvanceDate = SP_FindPaymentFactValueDate(RQ);
        ScDeal.SumAvance = RQ.rec.Amount;
     else
        ScDeal.FactAvanceDate = ZeroDate;
        ScDeal.SumAvance = $0.0;
     end;
     ScDeal.Diff                 = SQL_ConvTypeInteger(ds.Diff);
     // ALG_FROMDATE совпадает с ALG_SP_WEB_KIND_TYPEPERIOD
     ScDeal.PeriodTypePay        = CreateNameAlgFromAppServ(/*ALG_SP_WEB_KIND_TYPEPERIOD*/3160, SQL_ConvTypeInteger(ds.Base));
     ScDeal.ContrDate            = IIF(SQL_ConvTypeStr(ds.MaturityIsPrincipal) == SET_CHAR, SQL_ConvTypeDate(ds.Expiry), SQL_ConvTypeDate(ds.Maturity));
     if(IsLoan(FD.Group))
        RQ = FD_b.GetRQ(DLRQ_TYPE_DELIVERY, null, null, null, false);
     else
        RQ = FD.GetRQ(DLRQ_TYPE_PAYMENT, null, null, null, false);
     end;
     if( RQ != null )
        ScDeal.FactContrDate     = SP_FindPaymentFactValueDate(RQ);
     end;
     ScDeal.SumPayNoAvance       = ScDeal.TotalCost - ScDeal.SumAvance;
     ScDeal.PayRegTax            = IIF(SQL_ConvTypeStr(ds.PayRegTax) == SET_CHAR, true, false);
     ScDeal.Registrar            = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Registrar));
     ScDeal.RegistrarContr       = GetTWsSfContrByID(SQL_ConvTypeInteger(ds.RegistrarContr));
     ScDeal.Registrar            = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Registrar));
     ScDeal.Depositary           = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.DepositID));
     ScDeal.CliringDate          = SQL_ConvTypeDate(ds.CliringDate);
     ScDeal.CliringTime          = SQL_ConvTypeTime(ds.CliringTime);
     ScDeal.CliringSession       = CreateNameAlgFromAppServ(3157 /*ALG_SP_CLIRINGSESSION*/, SQL_ConvTypeInteger(ds.Session));

     ScDeal.CliringChange        = IIF(SQL_ConvTypeStr(ds.CliringChange) == SET_CHAR, true, false);
     ScDeal.PrincipalDiff        = SQL_ConvTypeInteger(ds.PrincipalDiff);
     // ALG_FROMDATE совпадает с ALG_SP_WEB_KIND_TYPEPERIOD
     ScDeal.PeriodTypeState      = CreateNameAlgFromAppServ(/*ALG_SP_WEB_KIND_TYPEPERIOD*/3161, SQL_ConvTypeInteger(ds.PrincipalBase));
     ScDeal.BaseDate             = IIF(SQL_ConvTypeStr(ds.MaturityIsPrincipal) == SET_CHAR, SQL_ConvTypeDate(ds.Maturity), SQL_ConvTypeDate(ds.Expiry));
     RQ = FD.GetRQ(DLRQ_TYPE_DELIVERY, null, null, null, false);
     if( RQ != null )
        ScDeal.FactBaseDate      = SP_FindPaymentFactValueDate(RQ);
     end;
     ScDeal.SupplyTime           = SQL_ConvTypeTime(ds.SupplyTime);
     ScDeal.Portfolio            = CreateLLValueFromAppServ(1100, SQL_ConvTypeInteger(ds.PortfolioID));   CorrectIfEmptyPortfolio(@ScDeal.Portfolio);
     ScDeal.Portfolio_2          = CreateLLValueFromAppServ(1100, SQL_ConvTypeInteger(ds.PortfolioID_2)); CorrectIfEmptyPortfolio(@ScDeal.Portfolio_2);
     ScDeal.Client               = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.ClientID));
     ScDeal.ClientContr          = GetTWsSfContrByID(SQL_ConvTypeInteger(ds.ClientContrID));
     ScDeal.Broker               = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.BrokerID));
     ScDeal.BrokerContr          = GetTWsSfContrByID(SQL_ConvTypeInteger(ds.BrokerContrID));
     ScDeal.Party                = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.PartyID));
     ScDeal.PartyContr           = GetTWsSfContrByID(SQL_ConvTypeInteger(ds.PartyContrID));
     ScDeal.Department           = GetTWsDepartmentByCode(SQL_ConvTypeInteger(ds.Department));
     ScDeal.Oper                 = SQL_ConvTypeInteger(ds.Oper);
     ScDeal.DealVersion          = SQL_ConvTypeInteger(ds.DealVersion);
     ScDeal.LegVersion           = SQL_ConvTypeInteger(ds.LegVersion);
     ScDeal.DealType             = SQL_ConvTypeInteger(ds.DealType);
     ScDeal.Flag4                = IIF(SQL_ConvTypeStr(ds.Flag4) == SET_CHAR, true, false);
     ScDeal.DealStatus           = SQL_ConvTypeInteger(ds.DealStatus);
     ScDeal.ChangeDate           = SQL_ConvTypeDate(ds.ChangeDate);
     ScDeal.TraderID             = SQL_ConvTypeInteger(ds.TraderID);
     ScDeal.MarketOfficeID       = SQL_ConvTypeInteger(ds.MarketOfficeID);
     ScDeal.OriginID             = SQL_ConvTypeInteger(ds.OriginID);
     ScDeal.OperState            = SQL_ConvTypeInteger(ds.OperState);
     ScDeal.Flag5                = IIF(SQL_ConvTypeStr(ds.Flag5) == SET_CHAR, true, false);
     ScDeal.ReturnIncomeType     = CreateNameAlgFromAppServ(3142, SQL_ConvTypeInteger(ds.ReturnIncomeKind));
     ScDeal.BasisCalc            = CreateNameAlgFromAppServ(3121, SQL_ConvTypeInteger(ds.Basis));

     if( ScDeal.IsTwoPart or (ScDeal.BOfficeKind == DL_CONVAVR) )
        ScDeal.Leg_ID_b             = SQL_ConvTypeInteger(ds.Leg_ID_b);
        ScDeal.RejectDate_b         = SQL_ConvTypeDate(ds.RejectDate_b);
        ScDeal.IncomeRate_b         = SQL_ConvTypeSum(ds.IncomeRate_b);
        ScDeal.ReturnIncome_b       = SQL_ConvTypeSum(ds.ReturnIncome_b);
        ScDeal.BaseDate_b           = IIF(SQL_ConvTypeStr(ds.MaturityIsPrincipal_b) == SET_CHAR, SQL_ConvTypeDate(ds.Maturity_b), SQL_ConvTypeDate(ds.Expiry_b));
        RQ = FD_b.GetRQ(DLRQ_TYPE_PAYMENT, null, null, null, false);
        if( RQ != null )
           ScDeal.FactBaseDate_b    = SP_FindPaymentFactValueDate(RQ);
        end;
        ScDeal.Principal_b            = SQL_ConvTypeSum(ds.Principal_b);
        ScDeal.ContrDate_b          = IIF(SQL_ConvTypeStr(ds.MaturityIsPrincipal_b) == SET_CHAR, SQL_ConvTypeDate(ds.Expiry_b), SQL_ConvTypeDate(ds.Maturity_b));
        ScDeal.SupplyTime_b         = SQL_ConvTypeTime(ds.SupplyTime_b);
        ScDeal.CliringDate_b        = SQL_ConvTypeDate(ds.CliringDate_b);
        ScDeal.CliringTime_b        = SQL_ConvTypeTime(ds.CliringTime_b);
        ScDeal.CliringSession_b     = CreateNameAlgFromAppServ(3157 /*ALG_SP_CLIRINGSESSION*/, SQL_ConvTypeInteger(ds.CliringSession_b));
        ScDeal.CliringChange_b      = IIF(SQL_ConvTypeStr(ds.CliringChange_b) == SET_CHAR, true, false);
        ScDeal.DeliverIss_b         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.DeliveringFIID_b));
        ScDeal.RelativePrice_b      = IIF(SQL_ConvTypeStr(ds.RelativePrice_b) == SET_CHAR, true, false);
        ScDeal.Price_b              = SQL_ConvTypeSum(ds.Price_b);
        ScDeal.Cost_b               = SQL_ConvTypeSum(ds.Cost_b);
        ScDeal.NKD_b                = SQL_ConvTypeSum(ds.NKD_b);
        ScDeal.Nom_b                = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.NKDFIID_b), CODE_Ccy);
        ScDeal.TotalCost_b          = SQL_ConvTypeSum(ds.TotalCost_b);
        ScDeal.LegVersion_b         = SQL_ConvTypeInteger(ds.LegVersion_b);
        ScDeal.OperState_b          = SQL_ConvTypeInteger(ds.OperState_b);
        ScDeal.PayRegTax_b          = IIF(SQL_ConvTypeStr(ds.PayRegTax_b) == SET_CHAR, true, false);
        ScDeal.Registrar_b          = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Registrar_b));
        ScDeal.RegistrarContr_b     = GetTWsSfContrByID(SQL_ConvTypeInteger(ds.RegistrarContr_b));
        ScDeal.Start_b              = SQL_ConvTypeDate(ds.Start_b);
        ScDeal.Avance_b             = FD_b.ExistAvance();
        ScDeal.Deposit_b            = FD_b.ExistDeposit();
        if( ScDeal.Avance_b )
           RQ = FD_b.GetRQ(DLRQ_TYPE_AVANCE, null, null, null, false);
        elif( ScDeal.Deposit_b )
           RQ = FD_b.GetRQ(DLRQ_TYPE_DEPOSIT, null, null, null, false);
        else
           RQ = null
        end;
        if( RQ != null )
           ScDeal.FactAvanceDate_b = SP_FindPaymentFactValueDate(RQ);
           ScDeal.SumAvance_b = RQ.rec.Amount;
        else
           ScDeal.FactAvanceDate_b = ZeroDate;
           ScDeal.SumAvance_b = $0.0;
        end;
        ScDeal.SumPayNoAvance_b     = ScDeal.TotalCost_b - ScDeal.SumAvance_b;
        RQ = FD_b.GetRQ(DLRQ_TYPE_PAYMENT, null, null, null, false);
        if( RQ != null )
           ScDeal.FactContrDate_b   = SP_FindPaymentFactValueDate(RQ);
        end;
        ScDeal.TypeCalc_b           = CreateTypeAcFromAppServ(155/*TA_TYPE_CALC*/, StrFor(SQL_ConvTypeInteger(ds.Formula_b)));
        ScDeal.StartDiff_b          = SQL_ConvTypeInteger(ds.StartDiff_b);
        // ALG_FROMDATE совпадает с ALG_SP_WEB_KIND_TYPEPERIOD
        ScDeal.PeriodTypeAvance_b   = CreateNameAlgFromAppServ(/*ALG_SP_WEB_KIND_TYPEPERIOD*/3159, SQL_ConvTypeInteger(ds.StartBase_b));
        ScDeal.Diff_b               = SQL_ConvTypeInteger(ds.Diff_b);
        // ALG_FROMDATE совпадает с ALG_SP_WEB_KIND_TYPEPERIOD
        ScDeal.PeriodTypePay_b      = CreateNameAlgFromAppServ(/*ALG_SP_WEB_KIND_TYPEPERIOD*/3160, SQL_ConvTypeInteger(ds.Base_b));
        ScDeal.Depositary_b         = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.DepositID_b));
        ScDeal.PrincipalDiff_b      = SQL_ConvTypeInteger(ds.PrincipalDiff_b);
        // ALG_FROMDATE совпадает с ALG_SP_WEB_KIND_TYPEPERIOD
        ScDeal.PeriodTypeState_b    = CreateNameAlgFromAppServ(/*ALG_SP_WEB_KIND_TYPEPERIOD*/3161, SQL_ConvTypeInteger(ds.PrincipalBase_b));

        ScDeal.ValueDate_c          = SQL_ConvTypeDate(ds.ValueDate_c);
        ScDeal.Price_c              = SQL_ConvTypeSum(ds.Price_c);
        ScDeal.Cost_c               = SQL_ConvTypeSum(ds.Cost_c);
        ScDeal.NKD_c                = SQL_ConvTypeSum(ds.NKD_c);
        ScDeal.TotalCost_c          = SQL_ConvTypeSum(ds.TotalCost_c);
        ScDeal.ValueDate_cb         = SQL_ConvTypeDate(ds.ValueDate_cb);
        ScDeal.Price_cb             = SQL_ConvTypeSum(ds.Price_cb);
        ScDeal.Cost_cb              = SQL_ConvTypeSum(ds.Cost_cb);
        ScDeal.NKD_cb               = SQL_ConvTypeSum(ds.NKD_cb);
        ScDeal.TotalCost_cb         = SQL_ConvTypeSum(ds.TotalCost_cb);

     end;

     if( ScDeal.IsLoan )
        ScDeal.ContractorIsDeponent = false;
        if( ScDeal.FactContrDate == null )
           ScDeal.FactContrDate = ZeroDate;
        end;
        if( ScDeal.FactBaseDate == null )
           ScDeal.FactBaseDate = ZeroDate;
        end;
        ScDeal.NumDays              = SP_GetPeriod(SQL_ConvTypeInteger(ds.Basis), ScDeal.ContrDate, ScDeal.BaseDate);
        ScDeal.NumDaysFact          = SP_GetPeriod(SQL_ConvTypeInteger(ds.Basis), ScDeal.FactContrDate, ScDeal.FactBaseDate);

        ScDeal.Flag3                = IIF(SQL_ConvTypeStr(ds.Flag3) == SET_CHAR, true, false);
        ScDeal.IncomeRate           = SQL_ConvTypeSum(ds.IR);
        ScDeal.IncomePoint          = SQL_ConvTypeInteger(ds.IncomePoint);

        ScDeal.ReturnIncome         = SQL_ConvTypeSum(ds.RI);

        ScDeal.DeliverIss_b         = GetTWsFinInstrByID(SP_GetFIID(ScDeal.DeliverIss));
        ScDeal.NKD_b                = SQL_ConvTypeSum(ds.RA);

        ScDeal.ReturnIncomeLoan     = SP_CalcReturnIncome(SQL_ConvTypeInteger(ds.PFI), SQL_ConvTypeDate(ds.Maturity), SQL_ConvTypeDate(ds.Expiry), ScDeal.Principal, ScDeal.Flag3);
        ScDeal.CrncPayPC            = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.PayFIID), CODE_Ccy);

        AfterChangeIss(ScDeal);
     end;

     if( ScDeal.BOfficeKind == DL_RETIREMENT )
        if( SQL_ConvTypeInteger(ds.BrokerID) != -1 )
           ScDeal.Pay_Agent = GetTWsPartyExByID(SP_GetPartyID(ScDeal.Broker));
        else
           ScDeal.Pay_Agent = GetTWsPartyExByID(SP_GetPartyID(ScDeal.Trader));
        end;

        nominal_fiid = NATCUR;
        if( ( SP_GetFIID( ScDeal.Iss ) > ALLFININSTR )
        and ( ПолучитьФинИн( ScDeal.Iss.FIID, Iss ) == 0 )
        and ( (not FI_IsInvestmentShare( ScDeal.Iss.FIID ))and (not FI_IsHypothecaryCert( ScDeal.Iss.FIID ) ) ) )
           nominal_fiid = Iss.rec.FaceValueFI;
        end;

        ScDeal.NominalFIID   = GetTWsFinInstrByID( nominal_fiid, CODE_Ccy );
        ScDeal.Nominal       = GetFaceValue(SQL_ConvTypeInteger(ds.PFI));
        ScDeal.Number_Coupon = TxGetAvoirPayByNumber(SQL_ConvTypeInteger(ds.PFI), PayKind_Coupon, SQL_ConvTypeStr(ds.Number_Coupon), null, true);
        ScDeal.Number_Partly = TxGetAvoirPayByNumber(SQL_ConvTypeInteger(ds.PFI), PayKind_PartialDischarge, SQL_ConvTypeStr(ds.Number_Partly), null, true);
        ScDeal.Flag2         = IIF(SQL_ConvTypeStr(ds.Flag2) == SET_CHAR, true, false);
        ScDeal.Maturity      = SQL_ConvTypeDate(ds.Maturity);
     end;
     ScDeal.PortfolioList    = GetListForPortfolio(ScDeal, 1100);

     if( ScDeal.BOfficeKind == DL_AVRWRT )  // Списания/Зачисления
       var DlSum  = TRecHandler("dlsum");
       ScDeal.BuyOutlay = $0;
       ScDeal.CrncBuyOutlay = GetTWsFinInstrByID(NATCUR, CODE_Ccy);
       ScDeal.Overval = $0;
       ScDeal.CrncOverval = GetTWsFinInstrByID(NATCUR, CODE_Ccy);
       ScDeal.DateOverval = ZeroDate;

       ClearAvrWrtTax(ScDeal);
       ScDeal.IsAvrwrtTaxesPanelReadOnly = true;

       if(FindDLSUM(ScDeal.BOfficeKind, ScDeal.DealID, DLSUM_KIND_OUTLAY, ScDeal.DealDate, DlSum) == 0)
          ScDeal.BuyOutlay = DlSum.rec.Sum;
          ScDeal.CrncBuyOutlay = GetTWsFinInstrByID(SQL_ConvTypeInteger(DlSum.rec.Currency), CODE_Ccy);
       end;
       var qry = RSDCommand( " SELECT max(dlsum.t_Date) t_MDate FROM ddlsum_dbt dlsum " +
                             " WHERE  dlsum.t_DocID    = ? AND " +
                             "        dlsum.t_DocKind  = ? AND  " +
                             "        dlsum.t_Kind     = ? " +
                             " ORDER BY t_Date Desc;" );
       qry.NullConversion = true;
       qry.addParam( "", RSDBP_IN, ScDeal.DealID );
       qry.addParam( "", RSDBP_IN, ScDeal.BOfficeKind );
       qry.addParam( "", RSDBP_IN, DLSUM_KIND_OVERVALUE );
       qry.execute();

       var dst = TRsbDataSet(qry, RSDVAL_CLIENT, RSDVAL_STATIC);

       if( dst.MoveNext() )
          if(FindDLSUM(ScDeal.BOfficeKind, ScDeal.DealID, DLSUM_KIND_OVERVALUE, SQL_ConvTypeDate(dst.MDate), DlSum) == 0)
            ScDeal.Overval = DlSum.rec.Sum;
            ScDeal.CrncOverval = GetTWsFinInstrByID(SQL_ConvTypeInteger(DlSum.rec.Currency), CODE_Ccy);
            ScDeal.DateOverval = DlSum.rec.Date;
          end;
       end;

       var qryCost = DL_RSDCommand( " SELECT max(dlsum.t_Date) as t_MDate FROM ddlsum_dbt dlsum " +
                                    " WHERE  dlsum.t_DocID = ? AND " +
                                    "        dlsum.t_DocKind = ? AND" +
                                    "        dlsum.t_Kind = ?" +
                                    " ORDER BY t_Date Desc");

       qryCost.AddParam(ScDeal.DealID);
       qryCost.AddParam(ScDeal.BOfficeKind);
       qryCost.AddParam(DLSUM_KIND_COSTWRTTAX);

       var dstCost = qryCost.execute();
       if(dstCost.MoveNext())
         ScDeal.WrtTaxCostDate = dstCost.MDate;
       end;

       /*Поля на вкладке "Данные для НУ" заполняются только для клиентов - физ. Лиц ИЛИ ИЛИ собственных операций банка*/
       if( (SQL_ConvTypeInteger(ds.ClientID) <= 0) or
            ( (SQL_ConvTypeInteger(ds.ClientID) > 0) and (GetPartyLegalForm(SQL_ConvTypeInteger(ds.ClientID) ) == PTLEGF_PERSN)
               and (not IsExistNPTXLot(DealID) ) )
         )
         ScDeal.IsAvrwrtTaxesPanelReadOnly = false;

         if(SQL_ConvTypeInteger(ds.ClientID) <= 0)
           ScDeal.Flag2 = false;
           ScDeal.Flag3 = true;
         else
           ScDeal.Flag2 = IIF(SQL_ConvTypeStr(ds.Flag2) == SET_CHAR, true, false);
           ScDeal.Flag3 = IIF(SQL_ConvTypeStr(ds.Flag3) == SET_CHAR, true, false);
         end;

         FillAvrWrtTaxSum(ScDeal);
       end;
     end;

    // Источники данных для виджетов "NameAlgWidget", подкачиваемые из прикладного кода
    ScDeal.PeriodTypeList = GetListNamealg(3123);
    ScDeal.PeriodTypePayList = GetListNamealg(3160);
    ScDeal.PeriodTypeAvanceList = GetListNamealg(3159);
    ScDeal.ReturnIncomeTypeList = GetListNamealg(3142);
    ScDeal.BasisCalcList = GetListNamealg(3121);
    ScDeal.PeriodTypeStateList = GetListNamealg(3161);

  else
     ScDeal.DealID = -1;
  end;

  return ScDeal;

OnError( err )
  ScDealRunError(err, stat);
end;

// Получение значений вкладки "Платежные реквизиты"
macro ScGetRQAccList(
  DealID:Integer      // ID сделки
)//:TArray of ScRQAcc

  var result = TArray();
  var query = "";
  var cmd = null;
  var ds = null;
  var stat:integer = -1;
  var ScRQAcc;

  if( DealID == null )
    RunError("Не задан обязательный параметр функции: ID сделки");
  end;

  query = " SELECT "
            + " rqacc.t_ID "
           + " ,rqacc.t_DocKind "
           + " ,rqacc.t_DocID "
           + " ,rqacc.t_SubKind "
           + " ,rqacc.t_Type "
           + " ,(SELECT "
                 + " NVL(na.t_szNameAlg, CHR(1)) "
             + " FROM "
                 + " dnamealg_dbt na "
             + " WHERE "
                 + " na.t_iTypeAlg = 7513 " // ALG_DLRQ_TYPE
             + " AND na.t_iNumberAlg = rqacc.t_Type) AS t_TypeName "
           + " ,rqacc.t_Party "
           + " ,(SELECT "
                 + " NVL(pt.t_ShortName, CHR(1)) "
             + " FROM "
                 + " dparty_dbt pt "
             + " WHERE "
                 + " pt.t_PartyID = rqacc.t_Party) AS t_PartyShortName "
           + " ,rqacc.t_FIID "
           + " ,(SELECT "
                 + " NVL(DECODE(fi.t_FI_Kind, " + FIKIND_CURRENCY + ", fi.t_ISO_Number, fi.t_FI_Code), CHR(1)) "
             + " FROM "
                 + " dfininstr_dbt fi "
             + " WHERE "
                 + " fi.t_FIID = rqacc.t_FIID) AS t_FICode "
           + " ,rqacc.t_BankID "
           + " ,rqacc.t_Chapter "
           + " ,rqacc.t_Account "
           + " ,rqacc.t_BankName "
           + " ,rqacc.t_CorrAcc "
           + " ,rqacc.t_BankCorrName "
           + " ,rqacc.t_BankCodeKind "
           + " ,rqacc.t_BankCode "
           + " ,rqacc.t_BankCorrID "
           + " ,rqacc.t_BankCorrCodeKind "
           + " ,rqacc.t_BankCorrCode "
           + " ,rqacc.t_Version "
        + " FROM "
            + " ddl_tick_dbt tick "
           + " ,ddlrqacc_dbt rqacc "
        + " WHERE "
            + " tick.t_DealID = ? "
        + " AND rqacc.t_DocKind = tick.t_BOfficeKind "
        + " AND rqacc.t_DocID = tick.t_DealID "
        + " ORDER BY "
            + " rqacc.t_DocKind "
           + " ,rqacc.t_DocID "
           + " ,rqacc.t_SubKind "
           + " ,rqacc.t_Party "
           + " ,rqacc.t_Type "
           + " ,rqacc.t_FIID ";

  cmd = RSDCommand( query );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, DealID );
  cmd.execute();

  ds = TRsbDataSet( cmd );

  while( ds.MoveNext() )
     ScRQAcc = CScRQAcc();

     ScRQAcc.ID               = SQL_ConvTypeInteger(ds.ID);
     ScRQAcc.DocKind          = SQL_ConvTypeInteger(ds.DocKind);
     ScRQAcc.DocID            = SQL_ConvTypeInteger(ds.DocID);
     ScRQAcc.SubKind          = SQL_ConvTypeInteger(ds.SubKind);
     ScRQAcc.Type             = SQL_ConvTypeInteger(ds.Type);
     ScRQAcc.TypeName         = SQL_ConvTypeStr(ds.TypeName);
     ScRQAcc.Party            = SQL_ConvTypeInteger(ds.Party);
     ScRQAcc.PartyShortName   = SQL_ConvTypeStr(ds.PartyShortName);
     ScRQAcc.FIID             = SQL_ConvTypeInteger(ds.FIID);
     ScRQAcc.FICode           = SQL_ConvTypeStr(ds.FICode);
     ScRQAcc.BankID           = SQL_ConvTypeInteger(ds.BankID);
     ScRQAcc.Chapter          = SQL_ConvTypeInteger(ds.Chapter);
     ScRQAcc.Account          = SQL_ConvTypeStr(ds.Account);
     ScRQAcc.BankName         = SQL_ConvTypeStr(ds.BankName);
     ScRQAcc.CorrAcc          = SQL_ConvTypeStr(ds.CorrAcc);
     ScRQAcc.BankCorrName     = SQL_ConvTypeStr(ds.BankCorrName);
     ScRQAcc.BankCodeKind     = SQL_ConvTypeInteger(ds.BankCodeKind);
     ScRQAcc.BankCode         = SQL_ConvTypeStr(ds.BankCode);
     ScRQAcc.BankCorrID       = SQL_ConvTypeInteger(ds.BankCorrID);
     ScRQAcc.BankCorrCodeKind = SQL_ConvTypeStr(ds.BankCorrCodeKind);
     ScRQAcc.BankCorrCode     = SQL_ConvTypeStr(ds.BankCorrCode);
     ScRQAcc.Version          = SQL_ConvTypeInteger(ds.Version);
     ScRQAcc.Action           = OperationKind_Undefine;

     result[result.Size] = ScRQAcc;
  end;

  return result;

OnError( err )
  ScDealRunError(err, stat);
end;

private macro GetFIName(FI, RqSubKind)
 var FiName = "";

  if( (FI != null) and (RqSubKind == DLRQ_SUBKIND_AVOIRISS ) )
    FiName = FI.Name;
  end;

 return FiName;
end;

// Получение значений вкладки "Требования/обязательства"
macro ScGetRQList(
  DealID:Integer      // ID сделки
)//:TArray of ScRQ

  var result = TArray();
  var query = "";
  var cmd = null;
  var ds = null;
  var stat:integer = -1;
  var ScRQ = null;

  if( DealID == null )
    RunError("Не задан обязательный параметр функции: ID сделки");
  end;

  query = " SELECT "
            + " rq.t_ID "
           + " ,rq.t_Kind "
           + " ,rq.t_SubKind "
           + " ,rq.t_Type "
           + " ,rq.t_Amount "
           + " ,rq.t_FIID "
           + " ,(SELECT "
                 + " NVL(fi.t_FI_Kind, " + FIKIND_ALLFI + ") "
             + " FROM "
                 + " dfininstr_dbt fi "
             + " WHERE "
                 + " fi.t_FIID = rq.t_FIID) AS t_FI_Kind "
           + " ,rq.t_Party "
           + " ,(SELECT "
                 + " NVL(party.t_ShortName, CHR(1)) "
             + " FROM "
                 + " dparty_dbt party "
             + " WHERE "
                 + " party.t_PartyID = rq.t_Party) AS t_PartyShortName "
           + " ,rq.t_PlaceID "
           + " ,(SELECT "
                 + " NVL(party.t_ShortName, CHR(1)) "
             + " FROM "
                 + " dparty_dbt party "
             + " WHERE "
                 + " party.t_PartyID = rq.t_PlaceID) AS t_PlaceShortName "
           + " ,rq.t_State "
           + " ,rq.t_PlanDate "
           + " ,rq.t_FactDate "
           + " ,rq.t_UseNetting "
           + " ,rq.t_Netting "
           + " ,rq.t_Cliring "
           + " ,(SELECT "
                 + " oprkdoc.t_name "
             + " FROM "
                 + " doprkdoc_dbt oprkdoc "
             + " WHERE "
                 + " oprkdoc.t_dockind = rq.t_DocKind) AS t_DocKindName "
           + " ,rq.t_DocID "
           + " ,rq.t_DealPart "
           + " ,rq.t_RqAccId "
           + " ,rq.t_Num "
           + " ,rq.t_DocKind "
           + " ,rq.t_DocID "
           + " ,rq.t_SourceObjKind "
           + " ,rq.t_SourceObjID "
           + " ,rq.t_ChangeDate "
           + " ,rq.t_Action "
           + " ,rq.t_Version "
        + " FROM "
            + " ddl_tick_dbt tick "
           + " ,ddlrq_dbt rq "
        + " WHERE "
            + " tick.t_DealID = ? "
        + " AND rq.t_DocKind = tick.t_BOfficeKind "
        + " AND rq.t_DocID = tick.t_DealID "
        + " ORDER BY "
            + " rq.t_DocKind "
           + " ,rq.t_DocID "
           + " ,rq.t_DealPart "
           + " ,rq.t_SubKind "
           + " ,rq.t_Type "
           + " ,rq.t_Num ";

  cmd = RSDCommand( query );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, DealID );
  cmd.execute();

  ds = TRsbDataSet( cmd );

  while( ds.MoveNext() )
     ScRQ = CScRQ();

     ScRQ.ID             = SQL_ConvTypeInteger(ds.ID);
     ScRQ.Kind           = CreateNameAlgFromAppServ(7511/*ALG_DLRQ_KIND*/, SQL_ConvTypeInteger(ds.Kind));
     ScRQ.KindEx         = CreateNameAlgFromAppServ(7516/*ALG_DLRQ_KIND_EX*/, SQL_ConvTypeInteger(ds.Kind));
     ScRQ.SubKind        = CreateNameAlgFromAppServ(7512/*ALG_DLRQ_SUBKIND*/, SQL_ConvTypeInteger(ds.SubKind));
     ScRQ.Type           = CreateNameAlgFromAppServ(7513/*ALG_DLRQ_TYPE*/, SQL_ConvTypeInteger(ds.Type));
     ScRQ.Amount         = SQL_ConvTypeSum(ds.Amount);
     ScRQ.FI             = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.FIID), IIF(SQL_ConvTypeInteger(ds.FI_Kind) == FIKIND_AVOIRISS, CODE_FI_Code, CODE_Ccy));
     ScRQ.FIName         = GetFIName(ScRQ.FI, ds.SubKind);
     ScRQ.Party          = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.Party));
     if(ScRQ.Party != null)
        ScRQ.Party.shortname= SQL_ConvTypeStr(ds.PartyShortName);
     end;
     ScRQ.Place          = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.PlaceID));
     if(ScRQ.Place != null)
        ScRQ.Place.shortname= SQL_ConvTypeStr(ds.PlaceShortName);
     end;
     ScRQ.State          = CreateNameAlgFromAppServ(7514/*ALG_DLRQ_STATE*/, SQL_ConvTypeInteger(ds.State));
     ScRQ.PlanDate       = SQL_ConvTypeDate(ds.PlanDate);
     ScRQ.FactDate       = SQL_ConvTypeDate(ds.FactDate);
     ScRQ.UseNetting     = (SQL_ConvTypeStr(ds.UseNetting) == SET_CHR);
     ScRQ.Netting        = (SQL_ConvTypeStr(ds.Netting) == SET_CHR);
     ScRQ.Cliring        = (SQL_ConvTypeStr(ds.Cliring) == SET_CHR);
     ScRQ.DocKindName    = SQL_ConvTypeStr(ds.DocKindName);
     ScRQ.DocID          = SQL_ConvTypeInteger(ds.DocID);
     ScRQ.DealPart       = CreateNameAlgFromAppServ(7518/*ALG_DLRQ_DEALPART*/, SQL_ConvTypeInteger(ds.DealPart));
     ScRQ.RQAcc          = GetScRQAcc(SQL_ConvTypeInteger(ds.RqAccId));
     ScRQ.Num            = SQL_ConvTypeInteger(ds.Num);
     ScRQ.DocKind        = SQL_ConvTypeInteger(ds.DocKind);
     ScRQ.DocID          = SQL_ConvTypeInteger(ds.DocID);
     ScRQ.SourceObjKind  = SQL_ConvTypeInteger(ds.SourceObjKind);
     ScRQ.SourceObjID    = SQL_ConvTypeInteger(ds.SourceObjID);
     ScRQ.ChangeDate     = SQL_ConvTypeDate(ds.ChangeDate);
     ScRQ.RQAction       = SQL_ConvTypeInteger(ds.Action);
     ScRQ.Action         = OperationKind_Undefine;
     ScRQ.Version        = SQL_ConvTypeInteger(ds.Version);

    // Источники данных для виджетов "NameAlgWidget", подкачиваемые из прикладного кода
    ScRQ.KindExList = GetListNamealg(7516);
    ScRQ.TypeList = GetListNamealg(7513);
    ScRQ.StateList = GetListNamealg(7514);
    ScRQ.DealPartList = GetListNamealg(7518);

     result[result.Size] = ScRQ;
  end;

  return result;

OnError( err )
  ScDealRunError(err, stat);
end;

private macro SP_FindContrComiss( ID:integer, ObjectType_, ObjectID_, FeeType_, CommNumber_, DateBegin_ )
  var RetVal;

  if( ID <= 0 )
    RetVal = CreateSfConComFromParam(-1, -1, "", "", -1, -1, -1, ZeroDate);
  else
    RetVal = FindContrComiss(-1, ObjectType_, ObjectID_, FeeType_, CommNumber_, -1, DateBegin_);
  end;

  return RetVal;
end;

// Получение значений вкладки "Комиссии"
macro ScGetComissList(
  dealID:Integer      // ID сделки
)//:TArray of ScComiss

  var stat:integer = -1;
  var comissList = TArray();
  var sqlQuery:String = "";
  var rsdCmd = null;
  var dataSet = null;
  var comiss = null;

  if( dealID == null )
    RunError("Не задан обязательный параметр функции: ID сделки");
  end;

  sqlQuery =
    " SELECT "
      + " comis.t_ID "
     + " ,sfcontr.t_PartyID "
     + " ,sfcomiss.t_ReceiverID "
     + " ,comis.t_Contract "
     + " ,comis.t_FeeType "
     + " ,comis.t_ComNumber "
     + " ,concom.t_ID t_Comission "
     + " ,concom.t_ObjectType t_ComOT "
     + " ,concom.t_ObjectID t_ComOID "
     + " ,concom.t_FeeType t_ComFT "
     + " ,concom.t_CommNumber t_ComN "
     + " ,concom.t_DateBegin t_ComDB "
     + " ,sfcomiss.t_Code "
     + " ,comis.t_Sum "
     + " ,comis.t_NDS "
     + " ,sfcomiss.t_FIID_Comm "
     + " ,comis.t_Date "
     + " ,comis.t_PlanPayDate "
     + " ,comis.t_FactPayDate "
     + " ,comis.t_InputMedium "
     + " ,comis.t_DocID "
     + " ,comis.t_DocKind "
     + " ,comis.t_Immaterial "
     + " ,comis.t_IsBack "
     + " ,rsi_dlgr.CheckExistGrDealByCom( "
        + " comis.t_DocKind "
       + " ,comis.t_DocID "
       + " ,comis.t_Contract "
       + " ,comis.t_PlanPayDate "
       + " ," + String( DLGRACC_STATE_FACTEXEC ) + " "
       + " ,0 ) ExistGrDeal "
     + " ,comis.t_Version "
  + " FROM "
      + " ddl_tick_dbt tick "
     + " ,ddlcomis_dbt comis "
     + " ,dsfcontr_dbt sfcontr "
     + " ,dsfcomiss_dbt sfcomiss "
     + " ,dsfconcom_dbt concom "
  + " WHERE "
      + " tick.t_DealID = ? "
  + " AND comis.t_DocKind = tick.t_BOfficeKind "
  + " AND comis.t_DocID = tick.t_DealID "
  + " AND sfcontr.t_ID(+) = comis.t_Contract "
  + " AND sfcomiss.t_FeeType(+) = comis.t_FeeType "
  + " AND sfcomiss.t_Number(+) = comis.t_ComNumber "
  + " AND concom.t_FeeType(+) = comis.t_FeeType "
  + " AND concom.t_CommNumber(+) = comis.t_ComNumber "
  + " AND concom.t_ObjectID(+) = comis.t_Contract "
  + " ORDER BY "
      + " comis.t_DocKind "
     + " ,comis.t_DocID "
     + " ,comis.t_Contract "
     + " ,comis.t_FeeType "
     + " ,comis.t_ComNumber ";

  rsdCmd = RSDCommand( sqlQuery );

  rsdCmd.NullConversion = true;
  rsdCmd.addParam( "", RSDBP_IN, dealID );
  rsdCmd.execute();

  dataSet = TRsbDataSet( rsdCmd );

  while( dataSet.MoveNext() )
     comiss = CScComiss();

     comiss.ID          = SQL_ConvTypeInteger( dataSet.ID );
     comiss.DocKind     = SQL_ConvTypeInteger( dataSet.DocKind );
     comiss.DocID       = SQL_ConvTypeInteger( dataSet.DocID );
     comiss.FeeType     = SQL_ConvTypeInteger( dataSet.FeeType );
     comiss.ComNumber   = SQL_ConvTypeInteger( dataSet.ComNumber );
     comiss.Payer       = GetTWsPartyExByID( SQL_ConvTypeInteger( dataSet.PartyID ) );
     comiss.Receiver    = GetTWsPartyExByID( SQL_ConvTypeInteger( dataSet.ReceiverID ) );
     comiss.Contr       = GetTWsSfContrByID( SQL_ConvTypeInteger( dataSet.Contract ) );
     comiss.Comission   = SP_FindContrComiss(
                            SQL_ConvTypeInteger( dataSet.Comission ),
                            SQL_ConvTypeInteger( dataSet.t_ComOT ),
                            SQL_ConvTypeInteger( dataSet.t_ComOID ),
                            SQL_ConvTypeInteger( dataSet.t_ComFT ),
                            SQL_ConvTypeInteger( dataSet.t_ComN ),
                            SQL_ConvTypeDate( dataSet.t_ComDB ) );
     comiss.Sum               = SQL_ConvTypeSum( dataSet.Sum );
     comiss.NDS         = SQL_ConvTypeSum( dataSet.NDS );
     comiss.SummaNotNDS = comiss.Sum - comiss.NDS;
     comiss.FIID_Comm   = GetTWsFinInstrByID( SQL_ConvTypeInteger( dataSet.FIID_Comm ), CODE_Ccy );
     comiss.Date        = SQL_ConvTypeDate( dataSet.Date );
     comiss.PlanPayDate = SQL_ConvTypeDate( dataSet.PlanPayDate );
     comiss.FactPayDate = SQL_ConvTypeDate( dataSet.FactPayDate );
     comiss.InputMedium = SQL_ConvTypeStr( dataSet.InputMedium );
     comiss.Immaterial  = ( SQL_ConvTypeStr( dataSet.Immaterial ) == SET_CHR );
     comiss.IsBack      = ( SQL_ConvTypeStr( dataSet.IsBack ) == SET_CHR );
     comiss.ExistGrDeal = ( SQL_ConvTypeInteger( dataSet.ExistGrDeal ) == 1 );
     comiss.Action      = OperationKind_Undefine;
     comiss.TypeNDS     = SP_GetTypeNDS( comiss.FeeType, comiss.ComNumber );
     comiss.Version     = SQL_ConvTypeInteger( dataSet.Version );

     comissList[comissList.Size] = comiss;
  end;

  return comissList;

OnError( err )
  ScDealRunError( err, stat );
end;

//
macro ScGetEnsureList(
  DealID:Integer
)//:TArray of CScEnsure

  var Stat:Integer = -1;
  var StrSQLQuery:String = "";
  var RSDCmd = null;
  var DataSet = null;
  var EnsureList = TArray();
  var Ensure = null;

  InitError();

  if( ( ValType( DealID ) == V_UNDEF) and ( DealID < 0 ) )
    RunError( "Не задан обязательны параметр: DealID" );
  end;

  StrSQLQuery = " SELECT ensure.*, "
              + "        NVL(fininstr.t_FaceValueFI, " + String(ALLFININSTR) + " ) t_CFI, "
              + "        NVL(avoir.t_IndexNom, chr(0)) t_IsIndexNominal, "
              + "        RSB_FIInstr.FI_AvrKindsGetRoot(fininstr.t_FI_Kind, fininstr.t_AvoirKind) t_RootAvrKinds "
              + "   FROM ddl_tick_ens_dbt ensure, dfininstr_dbt fininstr, davoiriss_dbt avoir "
              + "  WHERE ensure.t_DealID = ? "
              + "    AND fininstr.t_FIID(+) = ensure.t_FIID "
              + "    AND avoir.t_FIID(+)    = fininstr.t_FIID "
              + " ORDER BY ensure.t_FIID ASC, ensure.t_Date ASC, ensure.t_Kind ASC ";

  RSDCmd = RSDCommand( StrSQLQuery );
  RSDCmd.NullConversion = true;
  RSDCmd.AddParam( "", RSDBP_IN, DealID );
  RSDCmd.Execute();

  DataSet = TRsbDataSet( RSDCmd );
  while( DataSet.MoveNext() )
    Ensure = CScEnsure();

    Ensure.ID               = SQL_ConvTypeInteger( DataSet.ID );
    Ensure.DealID           = SQL_ConvTypeInteger( DataSet.DealID );
    Ensure.FI               = GetTWsFinInstrByID( SQL_ConvTypeInteger( DataSet.FIID ), CODE_NADC );
    Ensure.CFI              = GetTWsFinInstrByID( SQL_ConvTypeInteger( DataSet.CFI ), CODE_Ccy );
    Ensure.Date             = SQL_ConvTypeDate( DataSet.Date );
    Ensure.Kind             = SQL_ConvTypeInteger( DataSet.Kind );
    Ensure.Principal        = SQL_ConvTypeSum( DataSet.Principal );
    Ensure.TotalCost        = SQL_ConvTypeSum( DataSet.TotalCost );
    Ensure.CostFI           = GetTWsFinInstrByID( SQL_ConvTypeInteger( DataSet.CostFIID ), CODE_Ccy );
    Ensure.NKD              = SQL_ConvTypeSum( DataSet.NKD );
    Ensure.ChangedProperty  = "";
    Ensure.Action           = OperationKind_Undefine;
    Ensure.Version          = SQL_ConvTypeInteger( DataSet.Version );
    Ensure.IsIndexNominal   = (SQL_ConvTypeStr(DataSet.t_IsIndexNominal) == SET_CHR);
    Ensure.RootAvrKinds     = SQL_ConvTypeInteger(DataSet.RootAvrKinds);
    Ensure.Parent           = false;

    EnsureList[EnsureList.Size] = Ensure;
  end;

  return EnsureList;

OnError( Err );
  ScDealRunError( Err, Stat );
end;

private macro УстановитьКатегорию( Tick, ObjGroup:integer, AttrID:integer, CatDate:date, ErrorMsg:@string )
  var stat:integer = 0;

  if( ( not DisconnectObjAttr(OBJTYPE_SECDEAL,  UniID( Tick, OBJTYPE_SECDEAL), ObjGroup) ) OR
      ( not ConnectObjAttr(stat, OBJTYPE_SECDEAL, UniID( Tick, OBJTYPE_SECDEAL), ObjGroup, AttrID, null, null, CatDate) ) OR
      ( stat != 0 )
    )
     ErrorMsg = "Ошибка при установке категории <" + ИмяКатегории(OBJTYPE_SECDEAL, ObjGroup) + ">." + GetErrMsg();
  end;

  return stat;
end;

private macro SaveDeal( Deal/*:CScDeal*/, SaveDeal/*:CScDeal*/, ErrorMsg:@string, DealID:@integer ):integer
  var stat = 0;
  var Avoir, IsPay:bool = false;
  var TickOldRec = Tbfile("dl_tick", "R", 0);
  var LegOldRec = Tbfile("dl_leg", "R", 1);
  var Leg_bOldRec = Tbfile("dl_leg", "R", 1);
  var DlSum_f = Tbfile("dlsum", "W", 0);
  var DlSum = TRecHandler("dlsum");

  TickOldRec.Clear();
  LegOldRec.Clear();
  Leg_bOldRec.Clear();
  DlSum_f.Clear();

  if( Deal.DealID > 0 )
     TickOldRec.rec.DealID = Deal.DealID;
     if( not TickOldRec.GetEQ() )
        stat = 1;
        ErrorMsg = "Не найдена запись таблицы ddl_tick_dbt с DealID=" + string(Deal.DealID);
     end;

     if( (stat == 0) and (Deal.BofficeKind == DL_AVRWRT) )
       if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_OUTLAY, SaveDeal.DealDate, DlSum) == 0)
          DlSum_f.rec.DlSumID = DlSum.rec.DlSumID;
          DlSum_f.GetEQ();
          DlSum_f.rec.Sum = Deal.BuyOutlay;
          DlSum_f.rec.Currency = SP_GetFIID( Deal.CrncBuyOutlay );
          if( not DlSum_f.update() )
             stat = 1;
             ErrorMsg = "Ошибка обновления записи в таблице ddlsum_dbt";
          end;
       else
         if( Deal.BuyOutlay != 0 )
           DlSum_f.rec.DlSumID = 0;
           DlSum_f.rec.DocKind = Deal.BofficeKind;
           DlSum_f.rec.DocID = Deal.DealID;
           DlSum_f.rec.Kind = DLSUM_KIND_OUTLAY;
           DlSum_f.rec.Date = Deal.DealDate;
           DlSum_f.rec.Sum = Deal.BuyOutlay;
           DlSum_f.rec.Currency = SP_GetFIID( Deal.CrncBuyOutlay );
           DlSum_f.rec.Fiid = ALLFININSTR;
           if( not DlSum_f.insert() )
              stat = 1;
              ErrorMsg = "Ошибка вставки новой записи в таблицу ddlsum_dbt";
           end;
         end;
       end;

       if(stat == 0)
          if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_OVERVALUE, SaveDeal.DateOverval, DlSum) == 0)
          DlSum_f.rec.DlSumID = DlSum.rec.DlSumID;
          DlSum_f.GetEQ();
          DlSum_f.rec.Date = Deal.DateOverval;
          DlSum_f.rec.Sum = Deal.Overval;
          DlSum_f.rec.Currency = SP_GetFIID( Deal.CrncOverval );
             if( not DlSum_f.update() )
                stat = 1;
                ErrorMsg = "Ошибка обновления записи в таблице ddlsum_dbt";
             end;
       else
         if( ( Deal.BuyOutlay != 0 ) and ( Deal.DateOverval != ZeroDate ) )
           DlSum_f.rec.DlSumID = 0;
           DlSum_f.rec.DocKind = Deal.BofficeKind;
           DlSum_f.rec.DocID = Deal.DealID;
           DlSum_f.rec.Kind = DLSUM_KIND_OVERVALUE;
           DlSum_f.rec.Date = Deal.DateOverval;
           DlSum_f.rec.Sum = Deal.Overval;
           DlSum_f.rec.Currency = SP_GetFIID( Deal.CrncOverval );
           DlSum_f.rec.Fiid = ALLFININSTR;
           if( not DlSum_f.insert() )
              stat = 1;
              ErrorMsg = "Ошибка вставки новой записи в таблицу ddlsum_dbt";
           end;
          end;
         end;
       end;

       //DLSUM_KIND_COSTWRTTAX
       if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_COSTWRTTAX, IIF((Deal.WrtTaxCostDate == ZeroDate) or (Deal.WrtTaxCostDate != SaveDeal.WrtTaxCostDate), SaveDeal.WrtTaxCostDate, Deal.WrtTaxCostDate), DlSum) == 0)
         DlSum_f.rec.DlSumID = DlSum.rec.DlSumID;
         DlSum_f.GetEQ();
         DlSum_f.rec.Sum = Deal.WrtTaxCostSum;
         DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
         DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
         if( not DlSum_f.update() )
            stat = 1;
            ErrorMsg = "Ошибка обновления записи в таблице ddlsum_dbt";
         end;
       else
        if( (Deal.WrtTaxCostSum != 0) and (Deal.WrtTaxCostDate != ZeroDate) )
          DlSum_f.rec.DlSumID = 0;
          DlSum_f.rec.DocKind = Deal.BofficeKind;
          DlSum_f.rec.DocID = Deal.DealID;
          DlSum_f.rec.Kind = DLSUM_KIND_COSTWRTTAX;
          DlSum_f.rec.Sum = Deal.WrtTaxCostSum;
          DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
          DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
          DlSum_f.rec.Fiid = ALLFININSTR;
          if( not DlSum_f.insert() )
             stat = 1;
             ErrorMsg = "Ошибка вставки новой записи в таблицу ddlsum_dbt";
          end;
        end;
       end;

       //DLSUM_KIND_PRICEWRTTAX
       if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_PRICEWRTTAX, IIF((Deal.WrtTaxCostDate == ZeroDate) or (Deal.WrtTaxCostDate != SaveDeal.WrtTaxCostDate), SaveDeal.WrtTaxCostDate, Deal.WrtTaxCostDate), DlSum) == 0)
         DlSum_f.rec.DlSumID = DlSum.rec.DlSumID;
         DlSum_f.GetEQ();
         DlSum_f.rec.Sum = Deal.WrtTaxPriceSum;
         DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
         DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
         if( not DlSum_f.update() )
            stat = 1;
            ErrorMsg = "Ошибка обновления записи в таблице ddlsum_dbt";
         end;
       else
        if( Deal.BuyOutlay != 0 )
          DlSum_f.rec.DlSumID = 0;
          DlSum_f.rec.DocKind = Deal.BofficeKind;
          DlSum_f.rec.DocID = Deal.DealID;
          DlSum_f.rec.Kind = DLSUM_KIND_PRICEWRTTAX;
          DlSum_f.rec.Sum = Deal.WrtTaxPriceSum;
          DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
          DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
          DlSum_f.rec.Fiid = ALLFININSTR;
          if( not DlSum_f.insert() )
             stat = 1;
             ErrorMsg = "Ошибка вставки новой записи в таблицу ddlsum_dbt";
          end;
        end;
       end;

       //DLSUM_KIND_NKDWRTTAX
       if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_NKDWRTTAX, IIF((Deal.WrtTaxCostDate == ZeroDate) or (Deal.WrtTaxCostDate != SaveDeal.WrtTaxCostDate), SaveDeal.WrtTaxCostDate, Deal.WrtTaxCostDate), DlSum) == 0)
         DlSum_f.rec.DlSumID = DlSum.rec.DlSumID;
         DlSum_f.GetEQ();
         DlSum_f.rec.Sum = Deal.WrtTaxNKDSum;
         DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
         DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
         if( not DlSum_f.update() )
            stat = 1;
            ErrorMsg = "Ошибка обновления записи в таблице ddlsum_dbt";
         end;
       else
        if( Deal.BuyOutlay != 0 )
          DlSum_f.rec.DlSumID = 0;
          DlSum_f.rec.DocKind = Deal.BofficeKind;
          DlSum_f.rec.DocID = Deal.DealID;
          DlSum_f.rec.Kind = DLSUM_KIND_NKDWRTTAX;
          DlSum_f.rec.Sum = Deal.WrtTaxNKDSum;
          DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
          DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
          DlSum_f.rec.Fiid = ALLFININSTR;
          if( not DlSum_f.insert() )
             stat = 1;
             ErrorMsg = "Ошибка вставки новой записи в таблицу ddlsum_dbt";
          end;
        end;
       end;

       //DLSUM_KIND_OUTLAYWRTTAX
       if(FindDLSUM(Deal.BofficeKind, Deal.DealID, DLSUM_KIND_OUTLAYWRTTAX, IIF((Deal.WrtTaxCostDate == ZeroDate) or (Deal.WrtTaxCostDate != SaveDeal.WrtTaxCostDate), SaveDeal.WrtTaxCostDate, Deal.WrtTaxCostDate), DlSum) == 0)
         DlSum_f.rec.DlSumID = DlSum.rec.DlSumID;
         DlSum_f.GetEQ();
         DlSum_f.rec.Sum = Deal.WrtTaxOutlaySum;
         DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
         DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
         if( not DlSum_f.update() )
            stat = 1;
            ErrorMsg = "Ошибка обновления записи в таблице ddlsum_dbt";
         end;
       else
        if( Deal.BuyOutlay != 0 )
          DlSum_f.rec.DlSumID = 0;
          DlSum_f.rec.DocKind = Deal.BofficeKind;
          DlSum_f.rec.DocID = Deal.DealID;
          DlSum_f.rec.Kind = DLSUM_KIND_OUTLAYWRTTAX;
          DlSum_f.rec.Sum = Deal.WrtTaxOutlaySum;
          DlSum_f.rec.Date = IIF(Deal.WrtTaxCostDate == ZeroDate, SaveDeal.DealDate, Deal.WrtTaxCostDate);
          DlSum_f.rec.Currency = SP_GetFIID( Deal.Nom );
          DlSum_f.rec.Fiid = ALLFININSTR;
          if( not DlSum_f.insert() )
             stat = 1;
             ErrorMsg = "Ошибка вставки новой записи в таблицу ddlsum_dbt";
          end;
        end;
       end;

     end;

     if( (stat == 0) and (Deal.Leg_ID > 0) )
        LegOldRec.rec.ID = Deal.Leg_ID;
        if( not LegOldRec.GetEQ() )
           stat = 1;
           ErrorMsg = "Не найдена запись таблицы ddl_leg_dbt с ID=" + string(Deal.Leg_ID);
        end;
     end;

     if( (stat == 0) and (Deal.IsTwoPart or (Deal.BofficeKind == DL_CONVAVR)) and (Deal.Leg_ID_b > 0) )
        Leg_bOldRec.rec.ID = Deal.Leg_ID_b;
        if( not Leg_bOldRec.GetEQ() )
           stat = 1;
           ErrorMsg = "Не найдена запись таблицы ddl_leg_dbt с ID=" + string(Deal.Leg_bOldRec);
        end;
     end;
  end;

  if( stat == 0 )
     SetTick_ByCScDeal(TickOldRec.rec, Deal);
     SetLeg_ByCScDeal(LegOldRec.rec, Deal, 1);
     SetLeg_ByCScDeal(Leg_bOldRec.rec, Deal, 2);
     stat = WEB_CreateDeal(TickOldRec, LegOldRec, Leg_bOldRec);

     if(stat == 0)
        if(Deal.BofficeKind == DL_AVRWRT)
          var LastTaxDate = ZeroDate, err;

          GetRegistryValue("SECUR\\DATE_BUILD_TAXREG", V_STRING, LastTaxDate, err);
          if( err!=0 )
             stat = 1;
             ErrorMsg = "Ошибка при получении значения настройки SECUR\\DATE_BUILD_TAXREG";
          end;

          Deal.WrtTaxLastDate = date(LastTaxDate);
        end;
     end;

  end;

  DealID = TickOldRec.rec.DealID;

  return stat;
end;

private macro SaveRQAcc( RQAcc, RQ, DealID, ErrorMsg:@string ):integer

  var stat:integer = 0;
  var RQAccRec = Tbfile("dlrqacc", "W", 0);
  var RQAccOldRec = Tbfile("dlrqacc", "W", 0);
  var size:integer = RQAcc.size();
  var i:integer = 0;
  var RQAccItem;

  if( size > 0 )
     // Удаляем записи
     i = 0;
     while( (i < size) AND (stat == 0) )
        RQAccItem = RQAcc(i);

        if( (RQAccItem.Action == OperationKind_Delete) and (RQAccItem.ID > 0) )
           RQAccRec.Clear();
           RQAccRec.rec.ID = RQAccItem.ID;
           if( not RQAccRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы ddlrqacc_dbt с ID=" + string(RQAccItem.ID);
           elif( RQAccRec.rec.Version != RQAccItem.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы ddlrqacc_dbt. Документ изменен другим операционистом";
           else
              if( not RQAccRec.delete() )
                 stat = 1; // ???
                 ErrorMsg = "Ошибка удаления записи таблицы ddlrqacc_dbt";
              end;
           end;
        end;

        i = i + 1;
     end;

     // Редактируем записи
     i = 0;
     while( (i < size) AND (stat == 0) )
        RQAccItem = RQAcc(i);

        if( (RQAccItem.Action == OperationKind_Update) and (RQAccItem.ID > 0) )
           RQAccOldRec.Clear();
           RQAccOldRec.rec.ID = RQAccItem.ID;
           if( not RQAccOldRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы ddlrqacc_dbt с ID=" + string(RQAccItem.ID);
           elif( RQAccOldRec.rec.Version != RQAccItem.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы ddlrqacc_dbt. Документ изменен другим операционистом";
           end;

           if( stat == 0 )
              Copy(RQAccRec, RQAccOldRec);
              if( not RQAccRec.GetEQ() )
                 stat = 1;
                 ErrorMsg = "Не найдена запись таблицы ddlrqacc_dbt с ID=" + string(RQAccItem.ID);
              end;
           end;

           if( stat == 0 )
              SetRQAcc_ByCScRQAcc(RQAccRec.rec, RQAccItem);

              if( SP_CmpRec(RQAccRec, RQAccOldRec) == false )
                 if( not RQAccRec.update() )
                    stat = 1; // ???
                    ErrorMsg = "Ошибка обновления записи таблицы ddlrqacc_dbt";
                 end;
              end;
           end;
        end;

        i = i + 1;
     end;

     // Вставляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        RQAccItem = RQAcc(i);

        if( (RQAccItem.Action == OperationKind_Insert) and (RQAccItem.ID <= 0) )
           RQAccRec.Clear();
           SetRQAcc_ByCScRQAcc(RQAccRec.rec, RQAccItem);
           RQAccRec.rec.ID = 0;
           RQAccRec.rec.DocID = DealID;
           if( not RQAccRec.insert() )
              stat = 1; // ???
              ErrorMsg = "Ошибка вставки новой записи в таблицу ddlrqacc_dbt";
           else
              var j:integer = 0;
              while( j < RQ.size() )
                 if( (RQ(j).Action != OperationKind_Delete) and (RQ(j).RQAcc != null) and (RQ(j).RQAcc.ID == RQAccItem.ID) )
                    RQ(j).RQAcc.ID = RQAccRec.rec.ID;
                 end;
                 j = j + 1;
              end;
           end;
        end;

        i = i + 1;
     end;
  end;

  return stat;
end;

private macro SaveRQ( RQ, DealID, ErrorMsg:@string, ValidError:@string ):integer

  var stat:integer = 0;
  var RQRec = Tbfile("dlrq", "W", 0);
  var RQOldRec = Tbfile("dlrq", "W", 0);
  var size:integer = RQ.size();
  var i:integer = 0;
  var RQItem;

  if( size > 0 )
     // Удаляем записи
     i = 0;
     while( (i < size) AND (stat == 0) )
        RQItem = RQ(i);

        if( (RQItem.Action == OperationKind_Delete) and (RQItem.ID > 0) )
           RQRec.Clear();
           RQRec.rec.ID = RQItem.ID;
           if( not RQRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы ddlrq_dbt с ID=" + string(RQItem.ID);
           elif( RQRec.rec.Version != RQItem.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы ddlrq_dbt. Документ изменен другим операционистом";
           else
              if( not RQRec.delete() )
                 stat = 1; // ???
                 ErrorMsg = "Ошибка удаления записи таблицы ddlrq_dbt";
              end;
           end;
        end;

        i = i + 1;
     end;

     // Редактируем записи
     i = 0;
     while( (i < size) AND (stat == 0) )
        RQItem = RQ(i);

        if( (RQItem.Action == OperationKind_Update) and (RQItem.ID > 0) )
           RQOldRec.Clear();
           RQOldRec.rec.ID = RQItem.ID;
           if( not RQOldRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы ddlrq_dbt с ID=" + string(RQItem.ID);
           elif( RQOldRec.rec.Version != RQItem.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы ddlrq_dbt. Документ изменен другим операционистом";
           end;

           if( stat == 0 )
              Copy(RQRec, RQOldRec);
              if( not RQRec.GetEQ() )
                 stat = 1;
                 ErrorMsg = "Не найдена запись таблицы ddlrq_dbt с ID=" + string(RQItem.ID);
              end;
           end;

           if(stat == 0)
              if(
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_AVANCE)   or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_COMISS)   or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_COMPPAYM) or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_INCREPO)  or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_PAYMENT)  or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_PAYMREPOCOUP) or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_PAYMREPOPART) or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_PAYINCOME) or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_TAX_ULN) or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_TAX_FLN) or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_TAX_FLR) or
                    (RQItem.Type.NumberAlg == DLRQ_TYPE_TAX_FLR_ADD)
                )
                 if((RQItem == NULL) or (RQItem.SubKind == NULL) or (RQItem.SubKind.NumberAlg == DLRQ_SUBKIND_AVOIRISS))
                    stat = 1;
                    ValidError = "Вид финансового инструмента ТО не соответствует типу ТО";
                 end;
              else
                 if((RQItem == NULL) or (RQItem.SubKind == NULL) or (RQItem.SubKind.NumberAlg == DLRQ_SUBKIND_CURRENCY))
                    stat = 1;
                    ValidError = "Вид финансового инструмента ТО не соответствует типу ТО";
                 end;
              end;
           end;

           if( stat == 0 )
              SetRQ_ByCScRQ(RQRec.rec, RQItem);

              if( SP_CmpRec(RQRec, RQOldRec) == false )
                 var RQNumQuery = "select nvl(max(t_Num), -1) as t_Num " +
                                  "from ddlrq_dbt " +
                                  "where t_DocKind = ? " +
                                  "  and t_DocID = ? " +
                                  "  and t_DealPart = ? " +
                                  "  and t_FIID = ? " +
                                  "  and t_Type = ? ";

                 var RQNumCmd = DL_RSDCommand(RQNumQuery);
                 RQNumCmd.AddParam(RQRec.rec.DocKind);
                 RQNumCmd.AddParam(RQRec.rec.DocID);
                 RQNumCmd.AddParam(RQRec.rec.DealPart);
                 RQNumCmd.AddParam(RQRec.rec.FIID);
                 RQNumCmd.AddParam(RQRec.rec.Type);

                 var RQNumDS = RQNumCmd.Execute();
                 if(RQNumDS.MoveNext())
                    RQRec.rec.Num = RQNumDS.Num + 1;
                 end;

                 if( not RQRec.update() )
                    stat = 1; // ???
                    ErrorMsg = "Ошибка обновления записи таблицы ddlrq_dbt";
                 end;
              end;
           end;
        end;

        i = i + 1;
     end;

     // Вставляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        RQItem = RQ(i);

        if( (RQItem.Action == OperationKind_Insert) and (RQItem.ID <= 0) )
           RQRec.Clear();
           SetRQ_ByCScRQ(RQRec.rec, RQItem);
           RQRec.rec.ID = 0;
           RQRec.rec.DocID = DealID;
           if( not RQRec.insert() )
              stat = 1; // ???
              ErrorMsg = "Ошибка вставки новой записи в таблицу ddlrq_dbt";
           end;
        end;

        i = i + 1;
     end;
  end;

  return stat;
end;

private macro SaveComiss( Comiss, DealID, RQList, ErrorMsg:@string ):integer

  var stat:integer = 0;
  var ComissRec = Tbfile("dlcomis", "W", 0);
  var ComissOldRec = Tbfile("dlcomis", "W", 0);
  var size:integer = Comiss.size();
  var i:integer = 0;
  var ComissItem;

  if( size > 0 )
     // Удаляем записи
     i = 0;
     while( (i < size) AND (stat == 0) )
        ComissItem = Comiss(i);

        if( (ComissItem.Action == OperationKind_Delete) and (ComissItem.ID > 0) )
           ComissRec.Clear();
           ComissRec.rec.ID = ComissItem.ID;
           if( not ComissRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы ddlcomis_dbt с ID=" + string(ComissItem.ID);
           elif( ComissRec.rec.Version != ComissItem.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы ddlcomis_dbt. Документ изменен другим операционистом";
           elif( not ComissRec.delete() )
              stat = 1; // ???
              ErrorMsg = "Ошибка удаления записи таблицы ddlcomis_dbt";
           end;
        end;

        i = i + 1;
     end;

     // Редактируем записи
     i = 0;
     while( (i < size) AND (stat == 0) )
        ComissItem = Comiss(i);

        if( (ComissItem.Action == OperationKind_Update) and (ComissItem.ID > 0) )
           ComissOldRec.Clear();
           ComissOldRec.rec.ID = ComissItem.ID;
           if( not ComissOldRec.GetEQ() )
              stat = 1;
              ErrorMsg = "Не найдена запись таблицы ddlcomis_dbt с ID=" + string(ComissItem.ID);
           elif( ComissOldRec.rec.Version != ComissItem.Version )
              stat = 70;
              ErrorMsg = "Конфликт таблицы ddlcomis_dbt. Документ изменен другим операционистом";
           end;

           if( stat == 0 )
              Copy(ComissRec, ComissOldRec);
              if( not ComissRec.GetEQ() )
                 stat = 1;
                 ErrorMsg = "Не найдена запись таблицы ddlcomis_dbt с ID=" + string(ComissItem.ID);
              end;
           end;

           if( stat == 0 )
              SetCom_ByCScComiss(ComissRec.rec, ComissItem);

              if( SP_CmpRec(ComissRec, ComissOldRec) == false )
                 if( not ComissRec.update() )
                    stat = 1; // ???
                    ErrorMsg = "Ошибка обновления записи таблицы ddlcomis_dbt";
                 end;
              end;
           end;
        end;

        i = i + 1;
     end;

     // Вставляем записи
     i = 0;
     while((i < size) AND (stat == 0))
        ComissItem = Comiss(i);

        if( (ComissItem.Action == OperationKind_Insert) and (ComissItem.ID <= 0) )
           ComissRec.Clear();
           SetCom_ByCScComiss(ComissRec.rec, ComissItem);
           ComissRec.rec.ID = 0;
           ComissRec.rec.DocID = DealID;
           if( not ComissRec.insert() )
              stat = 1; // ???
              ErrorMsg = "Ошибка вставки новой записи в таблицу ddlcomis_dbt";
           else
             // Нужно обновить "SourceObjID" связанного ТО
	     // В EW "SourceObjID" ТО обновляется в "int CCacheDLCOMIS::OnAfterInsert(...) при сохранении сделки"
             var DLRQ;//:CScRQ
             if( FindDLRQ_BySource(RQList, DL_SECURITYCOM, ComissItem.ID/*Id before insert*/, @DLRQ) )
               DLRQ.SourceObjID = ComissRec.rec.ID; // Id after insert
             end;
           end;
        end;

        i = i + 1;
     end;
  end;

  return stat;
end;

// Сохранить обеспечения
private macro SaveEnsure(
  EnsureList//:TArray of CScEnsure
 ,DealID:Integer
 ,ErrorMsg:@String
):Integer;

  var Stat:Integer = 0;
  var EnsureCount:Integer = 0;
  var Ensure = null;
  var EnsureFile = TbFile( "dl_tick_ens", "W", 0 );
  var OldEnsureFile = TbFile( "dl_tick_ens", "W", 0 );

  if( EnsureList.Size > 0 )
    // Удаляем записи
    EnsureCount = 0;
    while( ( Stat == 0 ) and ( EnsureCount < EnsureList.Size ) )
      Ensure = EnsureList[EnsureCount];
      if( ( Ensure.Action == OperationKind_Delete ) and ( Ensure.ID > 0 ) )
        EnsureFile.Clear();
        EnsureFile.rec.ID = Ensure.ID;
        if( not EnsureFile.GetEQ() )
          Stat = 1;
          ErrorMsg = "Не найдена запись таблицы ddl_tick_ens_dbt c ID = " + String( Ensure.ID );
        elif( EnsureFile.rec.Version != Ensure.Version )
          Stat = 70;
          ErrorMsg = "Конфликт таблицы ddl_tick_ens_dbt. Документ изменен другим операционистом";
        elif( not EnsureFile.Delete() )
          Stat = 1;
          ErrorMsg = "Ошибка удаления записи таблицы ddl_tick_ens_dbt";
        end;
      end;
      EnsureCount = EnsureCount + 1;
    end;

    // Редактируем записи
    EnsureCount = 0;
    while( ( Stat == 0 ) and ( EnsureCount < EnsureList.Size ) )
      Ensure = EnsureList[EnsureCount];
      if( ( Ensure.Action == OperationKind_Update ) and ( Ensure.ID > 0 ) )
        OldEnsureFile.Clear();
        OldEnsureFile.rec.ID = Ensure.ID;
        EnsureFile.Clear();
        EnsureFile.rec.ID = Ensure.ID;
        if( ( not OldEnsureFile.GetEQ() ) or ( not EnsureFile.GetEQ() ) )
          Stat = 1;
          ErrorMsg = "Не найдена запись таблицы ddl_tick_ens_dbt c ID = " + String( Ensure.ID );
        elif( OldEnsureFile.rec.Version != Ensure.Version )
          Stat = 70;
          ErrorMsg = "Конфликт таблицы ddl_tick_ens_dbt. Документ изменен другим операционистом";
        else
          FillTickEnsRecUsingCScEnsure( EnsureFile.rec, Ensure );
          if( not SP_CmpRec( EnsureFile, OldEnsureFile ) )
            if( not EnsureFile.Update() )
              Stat = 1;
              ErrorMsg = "Ошибка обновления записи таблицы ddl_tick_ens_dbt";
            end;
          end;
        end;
      end;
      EnsureCount = EnsureCount + 1;
    end;

    // Вставляем записи
    EnsureCount = 0;
    while( ( Stat == 0 ) and ( EnsureCount < EnsureList.Size ) )
      Ensure = EnsureList[EnsureCount];
      if( ( Ensure.Action == OperationKind_Insert ) and ( Ensure.ID <= 0 ) )
        EnsureFile.Clear();
        FillTickEnsRecUsingCScEnsure( EnsureFile.rec, Ensure );
        EnsureFile.rec.ID = 0;
        EnsureFile.rec.DealID = DealID;
        if( not EnsureFile.Insert() )
          Stat = 1;
          ErrorMsg = "Ошибка вставки новой записи в таблицу ddl_tick_ens_dbt";
        end;
      end;
      EnsureCount = EnsureCount + 1;
    end;
  end;

  return Stat;
end;

macro ScInitDeal(
  BofficeKind:Integer // Вид бэк-оффиса
 ,KindOperation:Integer // Вид операции
):CScDeal

  var Stat:Integer = -1;
  var Deal = CScDeal();
  var Tick = TRecHandler( "dl_tick" );
  var Leg = TRecHandler( "dl_leg" );
  var Leg_b = TRecHandler( "dl_leg" );
  var FI = TRecHandler( "fininstr" );

  InitError();

  if( ( BofficeKind == null )
   or ( BofficeKind <= 0 ) )
    RunError( "Не задан обязательный параметр функции: Вид бэк-оффиса" );
  end;

  if( ( KindOperation == null )
   or ( KindOperation <= 0 ) )
    RunError( "Не задан обязательный параметр функции: Вид операции" );
  end;

  InitSPDeal( Tick, BofficeKind, KindOperation, true );
  SetCScDeal_ByTick( Tick.rec, Deal );
  InitSPLeg( Leg );
  SetCScDeal_ByLeg( Leg.rec, 1, Deal );
  if( Deal.IsTwoPart )
    InitSPLeg( Leg_b );
    SetCScDeal_ByLeg( Leg_b.rec, 2, Deal );
  end;

  Deal.IsSetDVExe       = false;
  Deal.IsPrognos        = false;
  Deal.TypeCalcList     = GetListTypeAc(155/*TA_TYPE_CALC*/);
  Deal.IssKind          = CTxAvrKinds();
  Deal.Issuer           = null;
  Deal.Iss_ISIN         = null;
  Deal.IssAvoirIss      = CTxAvoirIss();
  Deal.IssAvoirIss_b    = CTxAvoirIss();

  if( ( BofficeKind == DL_AVRWRT ) and ( KindOperation == 2010 ) )
    Deal.BaseDate = ZeroDate;
  end;

  Deal.PortfolioList = GetListForPortfolio( Deal, 1100 );

  if ( Deal.IsRepo and Deal.IsExchange )
     Deal.Flag1 = true; // для "Прямое/Обратное РЕПО на бирже без признания ц/б" флаг "ОРЦБ" должен быть взведен всегда
     Deal.BaseDate = {CurDate};

     if( Deal.IsBasket )  // при вводе сделки с ЦК параметр Способ возврата доходов контрагенту  заполняется как Списание с суммы РЕПО (209680)
        Deal.Flag5 = true;
        Deal.ReturnIncomeType = CreateNameAlgFromAppServ(3142, SQL_ConvTypeInteger( 2 /*SP_RETURNINCOME_WRTOFF*/ ));
     end;
  end;

  if ( Deal.IsRepo and Deal.IsOutExchange and not Deal.IsBasket )
     Deal.BaseDate = ZeroDate;
     Deal.ContrDate = ZeroDate;
  end;

  if( Deal.IsLoan )
     Deal.ContractorIsDeponent = false;
     Deal.NumDays = 1;
     Deal.IncomePoint = 4;
     Deal.ContrDate = Deal.ContrDate + 1;
     Deal.CrncPayPC = GetTWsFinInstrByID( SP_GetFIID( Deal.Crnc ) );
  end;

  if( Deal.IsExchange )
    Deal.TypeDoc = CreateTypeAcFromAppServ( 154, "T" );
    Deal.Portfolio = TWsLlvalues( -2, "", "", -2 );
  end;

  if( Deal.IsOutExchange )
     /*По умолчанию место заключения договора - Россия*/
     Deal.DealCountry = CreateCountryFromAppServ( "RUS" );
  end;

  if( Deal.IsRepo and Deal.IsBasket )
    if( ПолучитьФинИн( "Корзина с БР", FI ) == 0 )
      Deal.Iss = TWsFinInstr( FI.rec.fiid, FI.rec.fi_code, null, FI.rec.fi_kind, null, FI.rec.name );
    end;
    Deal.Registrar = GetTWsPartyExByID( ПолучитьКодСубъекта( GetSecurNRDCode(), PTCK_CONTR ) );
    Deal.Registrar_b = GetTWsPartyExByID( SP_GetPartyID( Deal.Registrar ) );
    if( SP_GetPartyID( Deal.Registrar ) != UnknownParty )
      Deal.RegistrarContr = DL_GetClientContrByPartyID( Tick.rec.DealDate, SP_GetPartyID( Deal.Registrar ), PTSK_STOCKDL );
    end;
  end;

  if( BofficeKind == DL_AVRWRT )
    Deal.CrncPreOutlay = null;
    if( Deal.IsAvrWrtIn )
      Deal.CrncOverval = GetTWsFinInstrByID( NATCUR, CODE_Ccy );
    end;
  end;

  if( BofficeKind == DL_RETIREMENT )
    /*Дата получения средств - значение по умолчанию == Дата операции */
    Deal.Maturity = Deal.BaseDate;
  end;

  return Deal;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

private macro WS_FillFromSPTKCHNG(Id, panelDeal)
  var StrSQLQuery = "SELECT hist.* "+
                    " FROM DSPTKCHNG_DBT hist "+
                    " WHERE HIST.T_ID = ? ";

  var RSDCmd = RSDCommand( StrSQLQuery );
  RSDCmd.NullConversion = true;
  RSDCmd.AddParam( "", RSDBP_IN, Id );
  RSDCmd.Execute();

  var ds = TRsbDataSet( RSDCmd );
  while( ds.MoveNext() )
    panelDeal.Deal.ChangeDate  = SQL_ConvTypeDate(ds.OldChangeDate);
    panelDeal.Deal.Crnc        = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.OldCFI1), CODE_Ccy);
    panelDeal.Deal.Price       = SQL_ConvTypeSum(ds.OldPrice1);
    panelDeal.Deal.Point       = SQL_ConvTypeInteger(ds.OldPoint1);
    panelDeal.Deal.IncomeRate  = SQL_ConvTypeSum(ds.OldIncomeRate);
    panelDeal.Deal.Cost        = SQL_ConvTypeSum(ds.OldCost1);
    panelDeal.Deal.TotalCost   = SQL_ConvTypeSum(ds.OldTotalCost1);
    panelDeal.Deal.NKD         = SQL_ConvTypeSum(ds.OldNKD1);
    panelDeal.Deal.FixSum      = CreateNameAlgFromAppServ(3126, SQL_ConvTypeInteger(ds.OldFixSum));
    panelDeal.Deal.Iss         = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.OldPFI1));
    panelDeal.Deal.Iss_ISIN    = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.OldPFI1), CODE_ISIN);

    panelDeal.Deal.Principal   = SQL_ConvTypeSum(ds.OldPrincipal);

    /*для ТО по поставке заполнить Amount???
      if((GetOperationGroup(New->Ticket.DealType, &OperGroup) == 0) && !IsBasket(OperGroup))
      {
         New->Payment(BAi).Amount = sptkchng->OldPrincipal;
         New->Payment(BRi).Amount = sptkchng->OldPrincipal2;
      }
*/
    panelDeal.Deal.TypeCalc         = CreateTypeAcFromAppServ(155/*TA_TYPE_CALC*/, StrFor(SQL_ConvTypeInteger(ds.OldFormula1)));
    panelDeal.Deal.CrncPay          = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.OldPayFIID1), CODE_Ccy);
    panelDeal.Deal.Party            = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.OldPartyID));
    panelDeal.Deal.SumAvance        = SQL_ConvTypeSum(ds.OldAdvance1);
    panelDeal.Deal.Start            = SQL_ConvTypeDate(ds.OldStart1);
    panelDeal.Deal.ContrDate        = IIF(SQL_ConvTypeStr(ds.OldMaturityIsPrincipal1) == SET_CHAR, SQL_ConvTypeDate(ds.OldExpiry1), SQL_ConvTypeDate(ds.OldMaturity1));
    panelDeal.Deal.BaseDate         = IIF(SQL_ConvTypeStr(ds.OldMaturityIsPrincipal1) == SET_CHAR, SQL_ConvTypeDate(ds.OldMaturity1), SQL_ConvTypeDate(ds.OldExpiry1));
    panelDeal.Deal.PreOutlay        = SQL_ConvTypeSum(ds.OldPreOutlay);
    panelDeal.Deal.PayRegTax        = IIF(SQL_ConvTypeStr(ds.OldPayRegTax1) == SET_CHAR, true, false);
    panelDeal.Deal.Registrar        = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.OldRegistrar1));
    panelDeal.Deal.DealTime         = SQL_ConvTypeTime(ds.OldDealTime);
    panelDeal.Deal.BasisCalc        = CreateNameAlgFromAppServ(3121, SQL_ConvTypeInteger(ds.OldBasis));
    panelDeal.Deal.RejectDate       = SQL_ConvTypeDate(ds.OldRejectDate1);
    panelDeal.Deal.PeriodType       = CreateNameAlgFromAppServ(3123, IIF(SQL_ConvTypeStr(ds.Flag3) == SET_CHAR, 1, 0));
    panelDeal.Deal.DeliverIss       = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.OldDeliveringFIID));
    panelDeal.Deal.CrncPreOutlay    = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.OldPreOutlayFIID), CODE_Ccy);
    panelDeal.Deal.StartDiff        = SQL_ConvTypeInteger(ds.OldStartDiff1);
    panelDeal.Deal.PrincipalDiff    = SQL_ConvTypeInteger(ds.OldPrincipalDiff1);
    panelDeal.Deal.Diff             = SQL_ConvTypeInteger(ds.OldDiff1);
    panelDeal.Deal.Flag5            = IIF(SQL_ConvTypeStr(ds.OldFlag5) == SET_CHAR, true, false);
    panelDeal.Deal.ReturnIncomeType = CreateNameAlgFromAppServ(3142, SQL_ConvTypeInteger(ds.OldReturnIncomeKind));
    panelDeal.Deal.Portfolio        = CreateLLValueFromAppServ(1100, SQL_ConvTypeInteger(ds.OldPortfolio)); CorrectIfEmptyPortfolio(@panelDeal.Deal.Portfolio);
    panelDeal.Deal.Portfolio_2      = CreateLLValueFromAppServ(1100, SQL_ConvTypeInteger(ds.OldPortfolio)); CorrectIfEmptyPortfolio(@panelDeal.Deal.Portfolio_2);

    if( panelDeal.Deal.BofficeKind == DL_CONVAVR )
      panelDeal.Deal.Iss_b     = GetTWsFinInstrByID(SQL_ConvTypeInteger(ds.OldPFI2));
      panelDeal.Deal.Principal_b = SQL_ConvTypeSum(ds.OldPrincipal2);
    end;

    if( panelDeal.Deal.IsTwoPart or (panelDeal.Deal.BofficeKind == DL_CONVAVR) )
      panelDeal.Deal.Price_b   = SQL_ConvTypeSum(ds.OldPrice2);
      panelDeal.Deal.IncomeRate_b  = SQL_ConvTypeSum(ds.OldIncomeRate);
      panelDeal.Deal.Cost_b        = SQL_ConvTypeSum(ds.OldCost2);
      panelDeal.Deal.TotalCost_b   = SQL_ConvTypeSum(ds.OldTotalCost2);
      panelDeal.Deal.NKD_b         = SQL_ConvTypeSum(ds.OldNKD2);
      panelDeal.Deal.Principal_b   = SQL_ConvTypeSum(ds.OldPrincipal2);
      panelDeal.Deal.TypeCalc_b    = CreateTypeAcFromAppServ(155/*TA_TYPE_CALC*/, StrFor(SQL_ConvTypeInteger(ds.OldFormula2)));
      panelDeal.Deal.SumAvance_b   = SQL_ConvTypeSum(ds.OldAdvance2);
      panelDeal.Deal.Start_b       = SQL_ConvTypeDate(ds.OldStart2);
      panelDeal.Deal.BaseDate_b    = IIF(SQL_ConvTypeStr(ds.OldMaturityIsPrincipal2) == SET_CHAR, SQL_ConvTypeDate(ds.OldMaturity2), SQL_ConvTypeDate(ds.OldExpiry2));
      panelDeal.Deal.ContrDate_b   = IIF(SQL_ConvTypeStr(ds.OldMaturityIsPrincipal2) == SET_CHAR, SQL_ConvTypeDate(ds.OldExpiry2), SQL_ConvTypeDate(ds.OldMaturity2));
      panelDeal.Deal.PayRegTax_b   = IIF(SQL_ConvTypeStr(ds.OldPayRegTax2) == SET_CHAR, true, false);
      panelDeal.Deal.Registrar_b   = GetTWsPartyExByID(SQL_ConvTypeInteger(ds.OldRegistrar2));
      panelDeal.Deal.RejectDate_b  = SQL_ConvTypeDate(ds.OldRejectDate2);
      panelDeal.Deal.ReturnIncome_b = SQL_ConvTypeSum(ds.OldReturnIncome);
      panelDeal.Deal.StartDiff_b    = SQL_ConvTypeInteger(ds.OldStartDiff2);
      panelDeal.Deal.PrincipalDiff_b = SQL_ConvTypeInteger(ds.OldPrincipalDiff2);
      panelDeal.Deal.Diff_b        = SQL_ConvTypeInteger(ds.OldDiff2);
    end;

    if( panelDeal.Deal.IsLoan )
      panelDeal.Deal.ReturnIncome  = SQL_ConvTypeSum(ds.OldReturnIncome);
      panelDeal.Deal.Flag3         = IIF(SQL_ConvTypeStr(ds.Flag3) == SET_CHAR, true, false);
      panelDeal.Deal.ReturnIncomeLoan  = SP_CalcReturnIncome(SQL_ConvTypeInteger(ds.OldPFI1), SQL_ConvTypeDate(ds.OldMaturity1), SQL_ConvTypeDate(ds.OldExpiry1), ds.OldPrincipal, ds.Flag3);
    end;

  end; /*while*/

end;

macro CorrectDealWithHistory(panelDeal, ID, DealHist)
  if( ID > 0 )
     WS_FillFromSPTKCHNG( ID, panelDeal );
     if( DealHist != null )
        if( DealHist.ChangeKind == SPTKCHNG_INITIAL )
           panelDeal.Deal.ChangeDate = DealHist.ChangeDate;
        end;
        panelDeal.Deal.ChangeKind = DealHist.ChangeKind;
     end;
  elif( DealHist != null )
    panelDeal.Deal.ChangeDate = DealHist.ChangeDate;
    panelDeal.Deal.ChangeKind = DealHist.ChangeKind;
  end;
end;

macro ScInitPanelDeal(
  dealID:Integer,       // ID сделки
  bofficeKind:Integer,  // Вид Б/О
  kindOperation:Integer, // Вид операции
  CurDealHist //:CScDealHistList // Текущая запись из истории
):CScPanelDeal

  var stat:Integer = -1;
  var panelDeal = CScPanelDeal();
  var OldPanelDeal = CScPanelDeal();

  InitError();

  if( ( dealID == null ) or ( dealID <= 0 ) )
    if( ( ( bofficeKind == null ) or ( bofficeKind <= 0 ) )
    and ( ( kindOperation == null ) or ( kindOperation <= 0 ) ) )
      // Если не заданы все три, то будем считать что не задали dealID
      RunError("Не задан обязательный параметр функции: ID сделки");
    elif( ( ( bofficeKind == null ) or ( bofficeKind <= 0 ) )
     and  ( kindOperation != null ) and ( kindOperation > 0 ) )
      // Если dealID не задан, но задан только третий параметр
      RunError( "Не задан обязательный параметр функции: вид Б/О" );
    elif( ( bofficeKind != null ) and ( bofficeKind > 0 )
    and ( ( kindOperation == null ) or ( kindOperation <= 0 ) ) )
      // Если dealID не задан, но задан только второй параметр
      RunError( "Не задан обязательный параметр функции: Вид операции" );
    end;
  end;

  if( ( dealID != null ) and ( dealID > 0 )
   or ( kindOperation != null ) and ( kindOperation > 0 ) )
    if( ( dealID != null ) and ( dealID > 0 ) )
      panelDeal.Deal = ScGetDeal( dealID );
      if( panelDeal.Deal.DealID > -1 )
        panelDeal.RQAcc = ScGetRQAccList( dealID );
        panelDeal.RQ = ScGetRQList( dealID );
        panelDeal.Comiss = ScGetComissList( dealID );
        panelDeal.EnsureList = ScGetEnsureList( dealID );
      end;
      // История по сделке
      if( ( panelDeal.Deal.BOfficeKind == DL_SECURITYDOC )
      and ( CurDealHist != null )
      and ( CurDealHist.DealID != null )
      and ( CurDealHist.DealID > 0 ) )
         // Предыдущее состояние из истории
         if( CurDealHist.PrevID > 0 )
            OldPanelDeal.Deal = ScGetDeal( dealID );
            //if( OldPanelDeal.Deal.DealID > -1 )
            //  OldPanelDeal.RQAcc = ScGetRQAccList( dealID );
            //  OldPanelDeal.RQ = ScGetRQList( dealID );
            //  OldPanelDeal.Comiss = ScGetComissList( dealID );
            //  OldPanelDeal.EnsureList = ScGetEnsureList( dealID );
            //end;
            CorrectDealWithHistory( OldPanelDeal, CurDealHist.PrevID );
            panelDeal.OldDeal = OldPanelDeal.Deal;
         end;

         // Текущее состояние из истории
         CorrectDealWithHistory( panelDeal, CurDealHist.ID, CurDealHist );
      end;
    else
      panelDeal.Deal = ScInitDeal( bofficeKind, kindOperation );
    end;
    panelDeal.SaveDeal = panelDeal.Deal; // в C# из xml будет создано 2 разных объекта
    if( dealID == -1 )
       panelDeal.EditDealMode = SP_EditDealMode_Normal; // новую сделку вводим в обычном режиме
    else
       panelDeal.EditDealMode = ПолучитьРежимРедактированияСделки( dealID, bofficeKind, kindOperation );
    end;
    if( panelDeal.EditDealMode == SP_EditDealMode_Normal )
      panelDeal.RecalcDealParam = true;
    else
      panelDeal.RecalcDealParam = false;
    end;
  else
    RunError( "Неверные параметры вызова функции ScInitPanelDeal" );
  end;

  return panelDeal;

OnError( err )
  ScDealRunError( err, stat );
end;

// из-за особенностей нового инструмента HTML5
private macro CorrectRQDates(RQ)
  if((RQ != null) and (RQ.size > 0))
    var i = 0;
    while(i < RQ.size)
      if(RQ[i].PlanDate == null) RQ[i].PlanDate = Date(0,0,0); end;
      if(RQ[i].FactDate == null) RQ[i].FactDate = Date(0,0,0); end;
      if(RQ[i].ChangeDate == null) RQ[i].ChangeDate = Date(0,0,0); end;

      i = i + 1;
    end;
  end;
end;

// из-за особенностей нового инструмента HTML5 (возможно временно)
private macro CorrectDealDatesTimes(Deal)
  if(Deal.DealDate == null) Deal.DealDate = Date(0,0,0); end;
  if(Deal.DateOverval == null) Deal.DateOverval = Date(0,0,0); end;
  if(Deal.CommDate == null) Deal.CommDate = Date(0,0,0); end;
  if(Deal.ChangeDate == null) Deal.ChangeDate = Date(0,0,0); end;
  if(Deal.RejectDate == null) Deal.RejectDate = Date(0,0,0); end;
  if(Deal.CloseDate == null) Deal.CloseDate = Date(0,0,0); end;
  if(Deal.Start == null) Deal.Start = Date(0,0,0); end;
  if(Deal.FactAvanceDate == null) Deal.FactAvanceDate = Date(0,0,0); end;
  if(Deal.ContrDate == null) Deal.ContrDate = Date(0,0,0); end;
  if(Deal.FactContrDate == null) Deal.FactContrDate = Date(0,0,0); end;
  if(Deal.CliringDate == null) Deal.CliringDate = Date(0,0,0); end;
  if(Deal.BaseDate == null) Deal.BaseDate = Date(0,0,0); end;
  if(Deal.FactBaseDate == null) Deal.FactBaseDate = Date(0,0,0); end;
  if(Deal.Maturity == null) Deal.Maturity = Date(0,0,0); end;
  if(Deal.RejectDate_b == null) Deal.RejectDate_b = Date(0,0,0); end;
  if(Deal.BaseDate_b == null) Deal.BaseDate_b = Date(0,0,0); end;
  if(Deal.ContrDate_b == null) Deal.ContrDate_b = Date(0,0,0); end;
  if(Deal.FactBaseDate_b == null) Deal.FactBaseDate_b = Date(0,0,0); end;
  if(Deal.WrtSum_b_Date == null) Deal.WrtSum_b_Date = Date(0,0,0); end;
  if(Deal.CliringDate_b == null) Deal.CliringDate_b = Date(0,0,0); end;
  if(Deal.Start_b == null) Deal.Start_b = Date(0,0,0); end;
  if(Deal.FactAvanceDate_b == null) Deal.FactAvanceDate_b = Date(0,0,0); end;
  if(Deal.FactContrDate_b == null) Deal.FactContrDate_b = Date(0,0,0); end;
  if(Deal.ValueDate_c == null) Deal.ValueDate_c = Date(0,0,0); end;
  if(Deal.ValueDate_cb == null) Deal.ValueDate_cb = Date(0,0,0); end;
  if(Deal.WrtTaxCostDate == null) Deal.WrtTaxCostDate = Date(0,0,0); end;
  if(Deal.WrtTaxLastDate == null) Deal.WrtTaxLastDate = Date(0,0,0); end;

  if(Deal.IssAvoirIss != null)
    if(deal.IssAvoirIss.DrawingDate == null) deal.IssAvoirIss.DrawingDate = Date(0,0,0); end;
  end;
  if(Deal.IssAvoirIss_b != null)
    if(deal.IssAvoirIss_b.DrawingDate == null) deal.IssAvoirIss_b.DrawingDate = Date(0,0,0); end;
  end;

  if(Deal.DealTime == null) Deal.DealTime = Time(0,0,0); end;
  if(Deal.CliringTime == null) Deal.CliringTime = Time(0,0,0); end;
  if(Deal.SupplyTime == null) Deal.SupplyTime = Time(0,0,0); end;
  if(Deal.SupplyTime_b == null) Deal.SupplyTime_b = Time(0,0,0); end;
  if(Deal.WrtSum_b_Time == null) Deal.WrtSum_b_Time = Time(0,0,0); end;
  if(Deal.CliringTime_b == null) Deal.CliringTime_b = Time(0,0,0); end;
end;

macro ScSaveDeal(
  DealID:Integer // ID сделки
 ,Deal//:CScDeal // Параметры сделки
 ,SaveDealBuf//:CScDeal // Буфер сделки до изменений
 ,RQAcc//:TArray of CScRQAcc // Массив объектов CTxRQAcc, описывающий список платежных реквизитов
 ,RQ//:TArray of CScRQ // Массив объектов CTxRQ, описывающий список требований/обязательств
 ,Comiss//:TArray of CScComiss // Массив объектов CTxComiss, описывающий список комиссий по сделке
 ,EnsureList//:TArray of CScEnsure // Массив объектов CScEnsure, описывающий список обеспечений по сделке
):WebServiceResponse
  var stat:integer = 0;
  var MessageStr:string = "";
  var begin_transaction:bool = false;
  var responseBuilder:WebResponseBuilder = WebResponseBuilder();
  var ValidError:string = "";

  InitError();

  RslDefCon.BeginTrans();
  begin_transaction = true;

  CorrectDealDatesTimes(Deal);
  CorrectDealDatesTimes(SaveDealBuf);
  CorrectRQDates(RQ);

  // сохранение сделки
  if( (stat == 0) and (Deal != null) and (SaveDealBuf != null) )
     stat = SaveDeal(Deal, SaveDealBuf, @MessageStr, @DealID);
  end;

  // сохранение платежных реквизитов
  if( (stat == 0) and (RQAcc != null) )
     stat = SaveRQAcc(RQAcc, RQ, DealID, @MessageStr);
  end;

  // сохранение комиссий (!!! сохранять до ТО)
  if( (stat == 0) and (Comiss != null) )
     stat = SaveComiss(Comiss, DealID, RQ, @MessageStr);
  end;

  // сохранение требований/обязательств
  if( (stat == 0) and (RQ != null) )
     stat = SaveRQ(RQ, DealID, @MessageStr, @ValidError);
  end;

  if((ValidError != NULL) and (ValidError != ""))
     responseBuilder.AddErrorEx(stat, MessageSeverity.ValidationError, ValidError);
  end;

  // сохранение обеспечений
  if( (stat == 0) and (EnsureList != null) )
     stat = SaveEnsure(EnsureList, DealID, @MessageStr);
  end;

  if( stat != 0 )
     if( MessageStr != "" )
        responseBuilder.AddErrorEx(stat, MessageSeverity.RuntimeError, MessageStr);
     else
        stat = -1;
        var ErrMsg = GetErrMsg();
        if( ErrMsg != "" )
          responseBuilder.AddErrorEx(stat, MessageSeverity.RuntimeError, ErrMsg);
        else
          responseBuilder.AddErrorEx(stat, MessageSeverity.RuntimeError, "Ошибка транзакции сохранения сделки");
        end;

     end;

     if( begin_transaction )
        RslDefCon.RollbackTrans();
        begin_transaction = false;
     end;
  end;

  if( begin_transaction )
     begin_transaction = false;
     RslDefCon.CommitTrans();
  end;

  ResponseBuilder.SetUserObject( DealID );

  return ResponseBuilder.Result;

OnError( err )
  if( begin_transaction )
     RslDefCon.RollbackTrans();
  end;
  ScDealRunError(err, stat);
end;

MACRO ScCheckTaxDatePreDel( DealID ) :WebServiceResponse
   var responseBuilder:WebResponseBuilder = WebResponseBuilder();
   var LastTaxDate = Date(0,0,0), err;
   var RetVal = 0, rq_avoir;
   var Tick = TBFile("dl_tick.dbt");

   Tick.rec.DealID = DealID;
   if(Tick.GetEQ())
       var FD = SPFirstDoc( Tick );
       rq_avoir = FD.GetRQ(DLRQ_TYPE_DELIVERY);

       GetRegistryValue("SECUR\\DATE_BUILD_TAXREG", V_STRING, LastTaxDate, err);
       if( err!=0 )
          MsgBox( "Ошибка при получении значения настройки SECUR\\DATE_BUILD_TAXREG");
          RetVal = 2;
       end;

       if( not ТОЗакрыто(rq_avoir) OR (ТОЗакрыто(rq_avoir) and (rq_avoir.rec.FactDate > LastTaxDate)) ) 
          RetVal = 0;
       else
          /*if( MsgBoxEx( "По сделке уже выполнялись расчеты в системе. Продолжить?",
                        MB_YES+MB_NO, IND_NO, 
                        "", "") == IND_YES )
             return true;
          else
             return false;
          end;*/
          RetVal = 1;
       end;
   else
       RetVal = 0;
   end;

//   return true;

  ResponseBuilder.SetUserObject( RetVal );

  return ResponseBuilder.Result;
END;

macro ScApplyDealChanges(
  BofficeKind:Integer               // Вид Б/О
 ,DealID:Integer                    // ID сделки
 ,Deal//:CScDeal                    // Параметры сделки
 ,SaveDeal//:CScDeal                // Буфер сделки до изменений
 ,RQAcc//:TArray of CScRQAcc        // Массив объектов CTxRQAcc, описывающий список платежных реквизитов
 ,RQ//:TArray of CScRQ              // Массив объектов CTxRQ, описывающий список требований/обязательств
 ,Comiss//:TArray of CScComiss      // Массив объектов CTxComiss, описывающий список комиссий по сделке
 ,EnsureList//:TArray of CScEnsure  // Массив объектов CScEnsure, описывающий список обеспечений по сделке
):CScDealList

  return ScInitPanelDeal( BofficeKind, ScSaveDeal( DealID, Deal, SaveDeal, RQAcc, RQ, Comiss, EnsureList ) );
end;

private macro GetSysNumField(
  Deal//:CScDeal
):Integer

  var sysNumFld:Integer = -1;

  if( Deal.ChangedProperty == "Price" )
    sysNumFld = pticketDeal_price_;
  elif( Deal.ChangedProperty == "Price_b" )
    sysNumFld = pticketDeal_price_Back_;
  elif( Deal.ChangedProperty == "Cost" )
    sysNumFld = pticketAmount_;
  elif( Deal.ChangedProperty == "Cost_b" )
    sysNumFld = pticketAmount_Back_;
  elif( Deal.ChangedProperty == "SumAvance" )
    sysNumFld = pticketSumAvance_;
  elif( Deal.ChangedProperty == "SumAvance_b" )
    sysNumFld = pticketSumAvance_Back_;
  end;

  return sysNumFld;
end;

private macro Web_SP_RecalcSum(
  PanelDeal
 ,IsBackSale:Bool
 ,ChangeIncomeRate:Bool
):bool
  if( PanelDeal.RecalcDealParam )
     var Tick  = TRecHandler("dl_tick");
     var Leg   = TRecHandler("dl_leg");
     var Leg_b = TRecHandler("dl_leg");
     var DlRqAvance1 = TRecHandler("dlrq");
     var DlRqMoney1  = TRecHandler("dlrq");
     var DlRqAvance2 = TRecHandler("dlrq");
     var DlRqMoney2  = TRecHandler("dlrq");
     var DlRqPercent = TRecHandler("dlrq");
     var Curr_nominal:double = GetFaceValue(SP_GetFIID(PanelDeal.Deal.Iss), PanelDeal.Deal.DealDate);
     var DlRq;

     if( ChangeIncomeRate == null )
        ChangeIncomeRate = false;
     end;

     SetTick_ByCScDeal(Tick.rec, PanelDeal.Deal);
     SetLeg_ByCScDeal(Leg.rec, PanelDeal.Deal, 1);

     if( PanelDeal.Deal.IsTwoPart or (PanelDeal.Deal.BofficeKind == DL_CONVAVR) )
        SetLeg_ByCScDeal(Leg_b.rec, PanelDeal.Deal, 2);

        if( FindDLRQbyDocKind(PanelDeal.RQ, PanelDeal.Deal.BofficeKind, PanelDeal.Deal.DealID, 1, SP_GetRQSubKindbyType(DLRQ_TYPE_AVANCE), DLRQ_TYPE_AVANCE, 0, @DlRq))
           SetRQ_ByCScRQ(DlRqAvance1.rec, DlRq);
        end;
        if( FindDLRQbyDocKind(PanelDeal.RQ, PanelDeal.Deal.BofficeKind, PanelDeal.Deal.DealID, 1, SP_GetRQSubKindbyType(DLRQ_TYPE_PAYMENT), DLRQ_TYPE_PAYMENT, 0, @DlRq))
           SetRQ_ByCScRQ(DlRqMoney1.rec, DlRq);
        end;
        if( FindDLRQbyDocKind(PanelDeal.RQ, PanelDeal.Deal.BofficeKind, PanelDeal.Deal.DealID, 2, SP_GetRQSubKindbyType(DLRQ_TYPE_AVANCE), DLRQ_TYPE_AVANCE, 0, @DlRq))
           SetRQ_ByCScRQ(DlRqAvance2.rec, DlRq);
        end;
        if( FindDLRQbyDocKind(PanelDeal.RQ, PanelDeal.Deal.BofficeKind, PanelDeal.Deal.DealID, 2, SP_GetRQSubKindbyType(DLRQ_TYPE_PAYMENT), DLRQ_TYPE_PAYMENT, 0, @DlRq))
           SetRQ_ByCScRQ(DlRqMoney2.rec, DlRq);
        end;
        if( FindDLRQbyDocKind(PanelDeal.RQ, PanelDeal.Deal.BofficeKind, PanelDeal.Deal.DealID, 2, SP_GetRQSubKindbyType(DLRQ_TYPE_INCREPO), DLRQ_TYPE_INCREPO, 0, @DlRq))
           SetRQ_ByCScRQ(DlRqPercent.rec, DlRq);
        end;
     end;

     SP_RecalcSum( Tick, Leg, Curr_nominal, PanelDeal.Deal.SumPayNoAvance, PanelDeal.Deal.SumAvance, IsBackSale,
                   GetSysNumField( PanelDeal.Deal ), ChangeIncomeRate, PanelDeal.Deal.SumPayNoAvance_b,
                   PanelDeal.Deal.SumAvance_b, Leg_b, DlRqAvance1, DlRqMoney1, DlRqAvance2, DlRqMoney2,
                   DlRqPercent, PanelDeal.RecalcDealParam );

     // данные, которые меняются в SP_RecalcSum
     PanelDeal.Deal.Cost_b           = Leg_b.rec.Cost;
     PanelDeal.Deal.Price_b          = Leg_b.rec.Price;
     PanelDeal.Deal.TotalCost_b      = Leg_b.rec.TotalCost;
     PanelDeal.Deal.ReturnIncome_b   = Leg_b.rec.ReturnIncome;
     PanelDeal.Deal.SumPayNoAvance_b = PanelDeal.Deal.TotalCost_b - PanelDeal.Deal.SumAvance_b;
     PanelDeal.Deal.Cost             = Leg.rec.Cost;
     PanelDeal.Deal.Price            = Leg.rec.Price;
     PanelDeal.Deal.TotalCost        = Leg.rec.TotalCost;
     PanelDeal.Deal.SumPayNoAvance   = PanelDeal.Deal.TotalCost - PanelDeal.Deal.SumAvance;
  end;
  return true;
end;

private macro Web_SP_ReCalcDealPrice( PanelDeal, IsBackSale:bool )

  var IsRecalc:bool = false;

  if( PanelDeal.Deal.IsOutExchange )
     if( PanelDeal.RecalcDealParam and (SP_GetNameAlgNumberAlg(PanelDeal.Deal.FixSum) != SP_FIXED_PRICE) )
        IsRecalc = true;
     else
        IsRecalc = false;
     end;
  else
     IsRecalc = PanelDeal.RecalcDealParam;
  end;

  if( IsRecalc )
     var Tick = TRecHandler("dl_tick");
     var Leg = TRecHandler("dl_leg");

     SetTick_ByCScDeal(Tick.rec, PanelDeal.Deal);
     SetLeg_ByCScDeal(Leg.rec, PanelDeal.Deal, IIF(IsBackSale, 2, 1));

     SP_ReCalcDealPrice(Tick, Leg);

     // данные, которые меняются в SP_ReCalcDealPrice
     if( IsBackSale )
        PanelDeal.Deal.Price_b = Leg.rec.Price;
     else
        PanelDeal.Deal.Price = Leg.rec.Price;
     end;
  end;
end;

private macro Web_SP_CalcDL_LEG_NKD( Deal, IsBackSale:bool ):bool

  var RetVal = true;

  var Tick = TRecHandler("dl_tick");
  var Leg = TRecHandler("dl_leg");

  SetTick_ByCScDeal(Tick.rec, Deal);
  SetLeg_ByCScDeal(Leg.rec, Deal, IIF(IsBackSale, 2, 1));

  var IsCoupon = false;
  if( (Deal.BofficeKind == DL_RETIREMENT)
  and (SP_GetFIID( Deal.Iss ) > ALLFININSTR))
    IsCoupon = Deal.IssAvoirIss.IsCoupon;
  end;

  if((Deal.BofficeKind == DL_AVRWRT) and (Deal.DealType == 2010)) // Списание
    RetVal = SP_CalcDL_LEG_NKD(Tick, Leg, Deal.DealDate, IsCoupon);
  else
    RetVal = SP_CalcDL_LEG_NKD(Tick, Leg, IIF(IsBackSale, IIF(Deal.IsLoan, Deal.ContrDate, Deal.BaseDate_b), Deal.BaseDate), IsCoupon);
  end;

  // данные, которые меняются в SP_CalcDL_LEG_NKD
  if( IsBackSale )
     Deal.NKD_b            = Leg.rec.NKD;
     Deal.TotalCost_b      = Leg.rec.TotalCost;
     Deal.SumPayNoAvance_b = Deal.TotalCost_b - Deal.SumAvance_b;
  else
     Deal.NKD              = Leg.rec.NKD;
     Deal.TotalCost        = Leg.rec.TotalCost;
     Deal.SumPayNoAvance   = Deal.TotalCost - Deal.SumAvance;
  end;

  return RetVal;
end;

private macro Web_SP_ReCalcBaseAmount( PanelDeal, IsBackSale:bool ):bool

  var RetVal = true;

  var Tick = TRecHandler("dl_tick");
  var Leg = TRecHandler("dl_leg");

  SetTick_ByCScDeal(Tick.rec, PanelDeal.Deal);
  SetLeg_ByCScDeal(Leg.rec, PanelDeal.Deal, IIF(IsBackSale, 2, 1));

  RetVal = SP_ReCalcBaseAmount(Tick, Leg, GetFaceValue(SP_GetFIID(PanelDeal.Deal.Iss), PanelDeal.Deal.DealDate), PanelDeal.RecalcDealParam);

  // данные, которые меняются в SP_ReCalcBaseAmount
  PanelDeal.Deal.Principal = Leg.rec.Principal; // пока есть только одно количество

  return RetVal;
end;

private macro Web_SP_RecalcLinkDates( Deal, IsBackSale:bool ):integer

  var RetVal = 0;

  var Tick = TRecHandler("dl_tick");
  var Leg = TRecHandler("dl_leg");
  var BaseDate:date, ContrDate:date, Start:date;

  SetTick_ByCScDeal(Tick.rec, Deal);
  SetLeg_ByCScDeal(Leg.rec, Deal, IIF(IsBackSale, 2, 1));

  if( IsBackSale )
     BaseDate  = Deal.BaseDate_b;
     ContrDate = Deal.ContrDate_b;
     Start     = Deal.Start_b;
  else
     BaseDate  = Deal.BaseDate;
     ContrDate = Deal.ContrDate;
     Start     = Deal.Start;
  end;

  RetVal = SP_WEB_RecalcLinkDates(Tick, Leg, BaseDate, ContrDate, Start);

  // данные, которые меняются в SP_WEB_RecalcLinkDates
  if( IsBackSale )
     Deal.BaseDate_b  = BaseDate;
     Deal.ContrDate_b = ContrDate;
     Deal.Start_b     = Start;
  else
     Deal.BaseDate    = BaseDate;
     Deal.ContrDate   = ContrDate;
     Deal.Start       = Start;
  end;

  return RetVal;
end;

private macro Web_SP_GetOperationGroup( Deal ):integer
  return SP_GetOperationGroup_(Deal.DealType, Deal.BofficeKind, IIF(Deal.Flag1, "X", ""), IIF(Deal.Flag4, "X", ""));
end;

private macro Web_SP_CalcRetireAmount( Deal ):bool

  var RetVal:bool = false;

  var Tick = TRecHandler("dl_tick");
  var Leg = TRecHandler("dl_leg");
  var Amount:money = Deal.Principal;
  var Group = Web_SP_GetOperationGroup(Deal);

  SetTick_ByCScDeal(Tick.rec, Deal);
  SetLeg_ByCScDeal(Leg.rec, Deal, 1);

  RetVal = SP_CalcRetireAmount(Tick, Leg, Amount, Group, -1);

  // данные, которые меняются в SP_CalcRetireAmount
  Deal.Principal = Amount;

  return RetVal;
end;

private macro SP_ReCalcSumNKD( PanelDeal, IsBackSale:bool )
   var Deal = PanelDeal.Deal;

   if( CheckTaxDepositoryMode()
   and Deal.IsTwoPart
   and ( Deal.DealStatus >= DL_READIED )
    or ( not PanelDeal.RecalcDealParam )
    or ( SP_GetNameAlgNumberAlg( Deal.FixSum ) == SP_FIXED_NKD )
    or Deal.IsBasket
    or Deal.IsKSU)
      return true;
   else
      return Web_SP_CalcDL_LEG_NKD( Deal, IsBackSale );
   end;
end;

// для РЕПО изменения валюты цены или валюты оплаты всегда синхронны для 2х частей
private macro SP_SynchFieldsREPO(
  PanelDeal
 ,ReCalcSums:Bool
 ,IsBackSale:bool
 ,ChangeIncomeRate:Bool
):Bool

  var RetVal = true;

  if( PanelDeal.Deal.IsTwoPart )
     var OperState;
     if( IsBackSale )
        PanelDeal.Deal.RelativePrice = PanelDeal.Deal.RelativePrice_b;
        PanelDeal.Deal.Nom = GetTWsFinInstrByID( SP_GetFIID( PanelDeal.Deal.Nom_b ) );

        OperState = PanelDeal.Deal.OperState;
     else
        PanelDeal.Deal.RelativePrice_b = PanelDeal.Deal.RelativePrice;
        PanelDeal.Deal.Nom_b = GetTWsFinInstrByID( SP_GetFIID( PanelDeal.Deal.Nom ) );

        OperState = PanelDeal.Deal.OperState_b;
     end;

     // пересчитаем суммы по другой части если она не на балансе
     if( ReCalcSums and (OperState <= DL_LEG_PLANE) )
        RetVal = SP_ReCalcSumNKD(PanelDeal, not IsBackSale);
        if( RetVal )
           RetVal = Web_SP_RecalcSum(PanelDeal, not IsBackSale, ChangeIncomeRate);
        end;
     end;
  end;

  return RetVal;
end;

private macro SP_AfterImportantChange(
  PanelDeal
 ,IsBackSale:Bool
 ,ChangeIncomeRate:Bool
):Bool

  var RetVal = true;

  RetVal = SP_ReCalcSumNKD(PanelDeal, IsBackSale);

  if( RetVal )
     RetVal = Web_SP_RecalcSum(PanelDeal, IsBackSale, ChangeIncomeRate);
     if( (RetVal) and PanelDeal.Deal.IsTwoPart )
        RetVal = SP_SynchFieldsREPO(PanelDeal, true, IsBackSale, ChangeIncomeRate);
     end;
  end;

  return RetVal;
end;

private macro SetFieldsByAvoirKind(
  panelDeal//:CScPanelDeal
)
  var deal = panelDeal.Deal;
  var payFinInstr = TRecHandler("fininstr");

  if( deal.IssKind != null )
     if( (deal.IssKind.RootAvrKinds == AVOIRISSKIND_BOND) and (not deal.IsLoan) and (not deal.IsAvrWrtIn) and (not deal.IsRet_Issue) )
        deal.RelativePrice = true;
     else
        deal.RelativePrice = false;
     end;
     if( deal.IsTwoPart )
       deal.RelativePrice_b = deal.RelativePrice;
     end;

     if( (deal.IssKind.RootAvrKinds == AVOIRISSKIND_INVESTMENT_SHARE) or (deal.IssKind.RootAvrKinds == AVOIRISSKIND_HYPOTHECARY_CERT) )
        deal.Crnc = GetTWsFinInstrByID( NATCUR, CODE_Ccy );
        deal.Nom = GetTWsFinInstrByID( SP_GetFIID( deal.Crnc ) );
        if( deal.IsTwoPart )
          deal.Nom_b = GetTWsFinInstrByID( SP_GetFIID( deal.Nom ) );
        end;
     elif( deal.IssKind.RootAvrKinds == AVOIRISSKIND_DEPOSITORY_RECEIPT )
        if( ( deal.IssKind.AvoirKind == AVOIRISSKIND_AMERICAN_DEPREC )
         or ( deal.IssKind.AvoirKind == AVOIRISSKIND_GLOBAL_DEPREC ) )
          ПолучитьФинИнПоISO( "USD", payFinInstr );
        else
          ПолучитьФинИнПоISO( "RUB", payFinInstr );
        end;

        deal.Crnc = GetTWsFinInstrByID( payFinInstr.rec.FIID, CODE_Ccy );
        deal.Nom = GetTWsFinInstrByID( SP_GetFIID( deal.Crnc ) );
        deal.CrncPay = GetTWsFinInstrByID( SP_GetFIID( deal.Crnc ) );
     end;
  end;
end;

private macro SetFieldsByAvoiriss( PanelDeal, IsBackSale:bool )
  // часть сишной функции
  var Deal = PanelDeal.Deal;
  if( ( ( Deal.IssKind != null )
    and ( Deal.IssKind.AvoirKind != FIKIND_ALLAVOIRISS )
    and ( not FI_IsAvrKindCoupon( Deal.IssKind.AvoirKind ) ) )
   or ( ( Deal.BofficeKind == DL_CONVAVR )
    and IsBackSale
    and ( Deal.IssKind_b.AvoirKind != FIKIND_ALLAVOIRISS )
    and ( not FI_IsAvrKindCoupon( Deal.IssKind_b.AvoirKind ) ) ) )
     if( SP_GetNameAlgNumberAlg( Deal.FixSum ) != SP_FIXED_PRICE )
        Deal.FixSum = CreateNameAlgFromAppServ( 3126, SP_FIXED_PRICE );
        Web_SP_RecalcSum( PanelDeal, IsBackSale );
     end;
  else
     Web_SP_RecalcSum( PanelDeal, IsBackSale );
  end;
end;

private macro AfterClearIss( PanelDeal, IsBackSale:bool )
  if( IsBackSale and (PanelDeal.Deal.BofficeKind == DL_CONVAVR) )
     PanelDeal.Deal.DeliverIss_b = null;
  else
     PanelDeal.Deal.DeliverIss = null;

     if( PanelDeal.Deal.IsTwoPart )
        PanelDeal.Deal.DeliverIss_b = GetTWsFinInstrByID( SP_GetFIID( PanelDeal.Deal.DeliverIss ) );
     end;
  end;

  SetFieldsByAvoiriss( PanelDeal, IsBackSale );

  if( PanelDeal.Deal.IsLoan )
    AfterChangeIss( PanelDeal.Deal );
  end;
end;

private macro SetIss(
  panelDeal
 ,isBackSale:bool
)
  var deal = panelDeal.Deal;
  var iss = TRecHandler( "fininstr" );

  if( ( SP_GetFIID( deal.Iss ) > ALLFININSTR )
  and ( ПолучитьФинИн( SP_GetFIID( deal.Iss ), iss ) == 0 ) )

    deal.IssKind = TxGetAvrKindsById( iss.rec.AvoirKind );
    deal.IssAvoirIss = TxGetAvoirIss( deal.Iss.Fiid );

    SetFieldsByAvoirKind( panelDeal );

    if( ( (deal.IssKind.RootAvrKinds != AVOIRISSKIND_INVESTMENT_SHARE) and (deal.IssKind.RootAvrKinds != AVOIRISSKIND_HYPOTHECARY_CERT) )
    and ( deal.IssKind.RootAvrKinds != AVOIRISSKIND_DEPOSITORY_RECEIPT ) )
      deal.Crnc = GetTWsFinInstrByID( iss.rec.FaceValueFI, CODE_Ccy );
      deal.Nom = GetTWsFinInstrByID( SP_GetFIID( deal.Crnc ) );
      if( deal.IsTwoPart )
        deal.Nom_b = GetTWsFinInstrByID( SP_GetFIID( deal.Nom ) );
      end;
    end;

    if( deal.BofficeKind == DL_AVRWRT )
      if( SP_GetFIID( deal.Iss ) > ALLFININSTR )
        deal.CrncPreOutlay = GetTWsFinInstrByID( SP_GetFIID( deal.Crnc ) );
        deal.CrncBuyOutlay = GetTWsFinInstrByID( SP_GetFIID( deal.Crnc ) );
      end;
    end;

    if( iss.rec.IsGeneralized )
      deal.DeliverIss = null;
    else
      deal.DeliverIss = GetTWsFinInstrByID( iss.rec.FIID );
    end;

    if( deal.IsTwoPart )
      deal.DeliverIss_b = GetTWsFinInstrByID( SP_GetFIID( deal.DeliverIss ) );
    end;

    deal.Issuer = GetTWsPartyExByID( iss.rec.Issuer );

    // Для паев управляющая компания из бумаги это есть контрагент по сделке
    if( ( deal.BofficeKind == DL_INVESTSHARE )
     or ( deal.BofficeKind == DL_GET_DIVIDEND ) )
      deal.Party = GetTWsPartyExByID( SP_GetPartyID( deal.Issuer ) );
    end;

    SetFieldsByAvoiriss( panelDeal, isBackSale );

    Web_SP_ReCalcDealPrice( panelDeal, isBackSale );
    Web_SP_RecalcSum( panelDeal, isBackSale );

    if( deal.IsTwoPart )
      if( deal.IsKsu )
        deal.Price = iss.rec.FaceValue;
      end;
      Web_SP_ReCalcDealPrice( panelDeal, true );
      Web_SP_RecalcSum( panelDeal, true );
    end;

    deal.OriginID = 0;
  end;
end;

// обработчик поля Код ц/б из группы Зачисление для операции конвертации ц/б
private macro SetIss_b(
  panelDeal
 ,isBackSale:bool
)
  var deal = panelDeal.Deal;
  var iss_b = TRecHandler( "fininstr" );

  if( ( SP_GetFIID( deal.Iss_b ) > ALLFININSTR )
  and ( ПолучитьФинИн( SP_GetFIID( deal.Iss_b ), iss_b ) == 0 ) )

    deal.IssKind_b = TxGetAvrKindsById( iss_b.rec.AvoirKind );

    if( ( ( deal.IssKind.RootAvrKinds != AVOIRISSKIND_INVESTMENT_SHARE) and (deal.IssKind.RootAvrKinds != AVOIRISSKIND_HYPOTHECARY_CERT) )
    and ( deal.IssKind.RootAvrKinds != AVOIRISSKIND_DEPOSITORY_RECEIPT ) )
      deal.Crnc_b = GetTWsFinInstrByID( iss_b.rec.FaceValueFI, CODE_Ccy );
      deal.Nom_b = GetTWsFinInstrByID( SP_GetFIID( deal.Crnc_b ) );
    end;

    if( iss_b.rec.IsGeneralized )
      deal.DeliverIss_b = null;
    else
      deal.DeliverIss_b = GetTWsFinInstrByID( iss_b.rec.FIID );
    end;

    deal.Issuer_b = GetTWsPartyExByID( iss_b.rec.Issuer );

    SetFieldsByAvoiriss( panelDeal, IsBackSale );

    Web_SP_ReCalcDealPrice( panelDeal, IsBackSale );
    Web_SP_RecalcSum( panelDeal, IsBackSale );

    deal.OriginID = 0;
  end;
end;

private macro SetTraderSector( Deal )

  var PartyID:integer = 0, OfficeID:integer = 0;

  Deal.CenterOfficeName = "";

  if( SP_GetMarketID(Deal.MarketSchem) > 0 )
     PartyID  = Deal.MarketSchem.Centr;
     OfficeID = Deal.MarketSchem.CentrOffice;
  else
     PartyID  = Deal.TraderID;
     OfficeID = Deal.MarketOfficeID;
  end;

  if( (PartyID > 0) and (OfficeID > 0) )
     var query = RSDCommand( " SELECT ptoffice.t_OfficeName CenterOfficeName " +
                             "   FROM dptoffice_dbt ptoffice " +
                             "  WHERE ptoffice.t_PartyID  = ? " +
                             "    AND ptoffice.t_OfficeID = ? " );

     query.NullConversion = true;
     query.addParam( "", RSDBP_IN, PartyID );
     query.addParam( "", RSDBP_IN, OfficeID );
     query.execute();

     var ds = TRsbDataSet(query);
     if( ds.MoveNext() )
        Deal.CenterOfficeName = SQL_ConvTypeStr(ds.CenterOfficeName);
     end;
  end;
end;

private macro SP_ClearMarketSchem( Deal )
  if( Deal.BofficeKind == DL_RETIREMENT )
     Deal.Registrar = null;
  else
     Deal.Depositary = null;
     if( Deal.IsTwoPart )
        Deal.Depositary_b = null;
     end;
  end;

  Deal.DepoSchem        = ScGetDepSetByID(0);
  Deal.TraderID         = -1;
  Deal.MarketOfficeID   = 0;
  Deal.MarketSchem      = ScGetMarketByID(0);
  Deal.CenterOfficeName = "";
end;

private macro SP_SetFieldsByMarketSchem( Deal )
  Deal.TraderID       = Deal.MarketSchem.Centr;
  Deal.MarketOfficeID = Deal.MarketSchem.CentrOffice;
  SetTraderSector(Deal);

  if ( (Deal.MarketSchem != null) and (Deal.MarketSchem.DepSetID != null) )
     Deal.DepoSchem = ScGetDepSetByID(Deal.MarketSchem.DepSetID);
     if( SP_GetDepSetID(Deal.DepoSchem) > 0 )
        if( Deal.BofficeKind == DL_RETIREMENT )
           Deal.Registrar = GetTWsPartyExByID(Deal.DepoSchem.Depositary);
        else
           Deal.Depositary = GetTWsPartyExByID(Deal.DepoSchem.Depositary);
           if( Deal.IsTwoPart )
              Deal.Depositary_b = GetTWsPartyExByID(SP_GetPartyID(Deal.Depositary));
           end;
        end;
     end;
  end;
end;

private macro SP_ClearSchem( Deal )
  var ScMarket = null;
  var ORCB = false;

  if(Deal.bOfficeKind == DL_AVRWRT)
     if(FI_IsKSU(SP_GetFIID(Deal.Iss)))
        ORCB = true;
     end;
  else
     ORCB = Deal.Flag1;
  end;

  SP_ClearMarketSchem( Deal );

  if( ( ( Deal.BofficeKind != DL_RETIREMENT )
     or ( ( not Deal.Flag4 )
      and ( SP_GetPartyID( Deal.Pay_Agent ) != UnknownParty ) ) )
  and ( SP_GetPartyID( Deal.Trader ) != UnknownParty ) )
      ScMarket = SP_WEB_FindDLMARKETbyMarket( SP_GetPartyID( Deal.Trader ), ORCB, false, FIKIND_AVOIRISS );
      if( ScMarket.ID > 0 )
         Deal.MarketSchem = ScMarket;
         SP_SetFieldsByMarketSchem( Deal );
      end;
   end;
end;

private macro SP_RoundPrice( Deal, Part:integer )
  if( SP_GetNameAlgNumberAlg(Deal.FixSum) == SP_FIXED_PRICE )
     if( Part == 1 )
        Deal.Price = round(Deal.Price, Deal.Point);
     elif( Part == 2 )
        Deal.Price_b = round(Deal.Price_b, Deal.Point);
     end;
  end;
end;

private macro proc_basedate( PanelDeal, IsBackSale:bool )
  var ErrorRecalcDates:Integer = 0;

  if( PanelDeal.Deal.IsBasket )
     if( IsBackSale )
        PanelDeal.Deal.ContrDate_b = PanelDeal.Deal.BaseDate_b;
     else
        PanelDeal.Deal.ContrDate = PanelDeal.Deal.BaseDate;
     end;
  end;

  PanelDeal.Deal.OriginID = 0;
  ErrorRecalcDates = Web_SP_RecalcLinkDates(PanelDeal.Deal, IsBackSale);
  if( ErrorRecalcDates == 0 )
     if( PanelDeal.Deal.IsRepo and PanelDeal.Deal.IsExchange )
        if( IsBackSale )
           PanelDeal.Deal.ContrDate_b = PanelDeal.Deal.BaseDate_b;
        else
           PanelDeal.Deal.ContrDate = PanelDeal.Deal.BaseDate;
        end;
        ErrorRecalcDates = Web_SP_RecalcLinkDates(PanelDeal.Deal, IsBackSale);
     end;
     if(PanelDeal.Deal.IsLoan)
        ErrorRecalcDates = Web_SP_RecalcLinkDates(PanelDeal.Deal, IsBackSale);
     end;
     if( ErrorRecalcDates == 0 )
        SP_AfterImportantChange(PanelDeal, IsBackSale);
     end;
  end;

  return ErrorRecalcDates;
end;

private macro ReCalcBaseAmount( Deal, IsBackSale:bool ):bool

  var RetVal = false;

  if( IsBackSale )
     if( (Deal.Cost_b != 0.0) and (Deal.Price_b != 0.0) and (Deal.Principal == 0) )
        RetVal = true;
     end;
  else
     if( (Deal.Cost != 0.0) and (Deal.Price != 0.0) and (Deal.Principal == 0) )
        RetVal = true;
     end;
  end;

  return RetVal;
end;

private macro proc_dealprice( PanelDeal, IsBackSale:bool )

  if( ReCalcBaseAmount(PanelDeal.Deal, IsBackSale) )
     Web_SP_ReCalcBaseAmount(PanelDeal, IsBackSale);
  end;

  // при изменениях сумм во второй части, в первой части ничего не меняем кроме ставки
  SP_AfterImportantChange(PanelDeal, IsBackSale, IsBackSale);

  if( PanelDeal.Deal.IsLoan )
     RecalculatePC( PanelDeal.Deal );
  end;
end;

private macro proc_IsRelativePrice( PanelDeal, IsBackSale:bool )

  var Iss = TRecHandler("fininstr");

  if( SP_GetFIID(PanelDeal.Deal.Iss) > ALLFININSTR )
     ПолучитьФинИн(SP_GetFIID(PanelDeal.Deal.Iss), Iss);
  end;

  // в веб сейчас Crnc одинаковый и для первой и для второй части, так что сделаем пока так
  if( (not IsBackSale) and (PanelDeal.Deal.RelativePrice) )
     var nominal_fiid = NATCUR;
     if( (SP_GetFIID(PanelDeal.Deal.Iss) > ALLFININSTR) and ( (not FI_IsInvestmentShare(Iss.rec.FIID)) and (not FI_IsHypothecaryCert(Iss.rec.FIID ) ) ) )
        nominal_fiid = Iss.rec.FaceValueFI;
     end;
     PanelDeal.Deal.Crnc = GetTWsFinInstrByID(nominal_fiid, CODE_Ccy);
  end;

  SP_AfterImportantChange(PanelDeal, IsBackSale);
end;

private macro proc_dealsum( PanelDeal, IsBackSale:bool )

  if( ReCalcBaseAmount(PanelDeal.Deal, IsBackSale) )
     Web_SP_ReCalcBaseAmount(PanelDeal, IsBackSale);
  end;

  Web_SP_ReCalcDealPrice(PanelDeal, IsBackSale);
  SP_AfterImportantChange(PanelDeal, IsBackSale, IsBackSale);

  if( PanelDeal.Deal.IsLoan )
     RecalculatePC( PanelDeal.Deal );
  end;
end;

private macro proc_AllNKD( PanelDeal, IsBackSale:bool )
  // при изменениях сумм во второй части, в первой части ничего не меняем кроме ставки
  Web_SP_RecalcSum(PanelDeal, IsBackSale, IsBackSale);
end;

private macro proc_crnc_NKD( PanelDeal, IsBackSale:bool )
  SP_AfterImportantChange(PanelDeal, IsBackSale);
end;

private macro proc_dealsum_byAllAmount( PanelDeal, IsBackSale:bool )
  if( (not IsBackSale) and (PanelDeal.Deal.TotalCost >= PanelDeal.Deal.SumAvance) )
     PanelDeal.Deal.SumPayNoAvance = PanelDeal.Deal.TotalCost - PanelDeal.Deal.SumAvance;
  end;

  if( IsBackSale and (PanelDeal.Deal.TotalCost_b >= PanelDeal.Deal.SumAvance_b) )
     PanelDeal.Deal.SumPayNoAvance_b = PanelDeal.Deal.TotalCost_b - PanelDeal.Deal.SumAvance_b;
  end;

  if( not PanelDeal.Deal.IsTwoPart or PanelDeal.Deal.IsExchange )
     Web_SP_RecalcSum(PanelDeal, IsBackSale);
  end;
end;

private macro proc_dealsum_byAllAmount_Bas( PanelDeal )
  if( ( PanelDeal.Deal.TotalCost_b != $0 ) and ( PanelDeal.Deal.TotalCost != $0 ) )
    PanelDeal.Deal.ReturnIncome_b = PanelDeal.Deal.TotalCost_b - PanelDeal.Deal.TotalCost;
    if( PanelDeal.Deal.ReturnIncome_b < $0 )
      PanelDeal.Deal.ReturnIncome_b = $0 - PanelDeal.Deal.ReturnIncome_b;
    end;
  else
    PanelDeal.Deal.ReturnIncome_b = $0;
  end;
end;

private macro common_proc_RecalcDates( PanelDeal, IsBackSale:bool )
  var ErrorRecalcDates:integer = 0;

  ErrorRecalcDates = Web_SP_RecalcLinkDates(PanelDeal.Deal, IsBackSale);

  if( ErrorRecalcDates == 0 )
     SP_AfterImportantChange(PanelDeal, IsBackSale);
  end;

  return ErrorRecalcDates;
end;

private macro proc_contrdate( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_PeriodTypeState( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_avancedate( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_TypeCalc( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_PeriodTypeAvance( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_PeriodTypePay( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_StartDiff( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_Diff( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_PrincipalDiff( PanelDeal, IsBackSale:bool )
  return common_proc_RecalcDates(PanelDeal, IsBackSale);
end;

private macro proc_BrokerCode( PanelDeal )
  return true;
end;

private macro proc_AgentCode( PanelDeal )
  PanelDeal.Deal.BrokerContr = null;
end;

private macro proc_TraderCode( PanelDeal )
  if( ( PanelDeal.Deal.IsExchange )
  and ( ( SP_GetPartyID( PanelDeal.Deal.Trader ) == ПолучитьКодСубъекта( MICEX_CODE, PTCK_CONTR ) )
     or ( SP_GetPartyID( PanelDeal.Deal.Trader ) == ПолучитьКодСубъекта( MICEX_CODE_FB, PTCK_CONTR ) ) ) )
     PanelDeal.Deal.Flag1 = true;
  end;

  SP_ClearSchem( PanelDeal.Deal );
end;

private macro ClearRegistrarContr( Deal, IsBackSale:bool )
  if( IsBackSale )
     Deal.RegistrarContr = null;
  else
     Deal.RegistrarContr_b = null;
  end;
end;

private macro SP_SetDepositaryReceiver( Deal )
  if( Deal.IsRet_Issue )
     Deal.Registrar = null;
     ClearRegistrarContr(Deal, false);
  end;
end;

private macro proc_PayAgentCode( PanelDeal )

  var RetVal = true;

  if( (PanelDeal.Deal.BofficeKind == DL_RETIREMENT) and (PanelDeal.Deal.Flag4 == true) ) // погашение через брокера
     PanelDeal.Deal.Broker = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Pay_Agent ) );
     RetVal = proc_BrokerCode(PanelDeal);
     if( RetVal )
        PanelDeal.Deal.Party = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Broker ) );
        PanelDeal.Deal.Trader = null;

        SP_ClearSchem( PanelDeal.Deal );

        // брокер поменялся, а значит при заполненном поле с выпуском ц\б депозитария брокера надо взять по новой (поле ведь в нашем случае недоступно, и заполняем мы его автоматически)
        // по ТЗ: Если указан признак <Брокер>, то в поле <Депозитарий> по умолчанию загружается депозитарий брокера, указанного в поле <Платежный агент>,
        if( SP_GetFIID(PanelDeal.Deal.Iss) > 0 )
           SP_SetDepositaryReceiver(PanelDeal.Deal);
        end;
     end;
  elif( (PanelDeal.Deal.BofficeKind == DL_RETIREMENT) and (PanelDeal.Deal.Flag1 == true) ) // погашение ОРЦБ
     PanelDeal.Deal.Trader = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Pay_Agent ) );
     proc_TraderCode( PanelDeal );
     PanelDeal.Deal.Party = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Trader ) );
     PanelDeal.Deal.Broker = null;
  else // не ОРЦБ и не брокер
     PanelDeal.Deal.Broker = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Pay_Agent ) );
     proc_AgentCode(PanelDeal);
     if( ВидСубъекта(SP_GetPartyID(PanelDeal.Deal.Broker), PTK_MARKETPLASE) == true ) // задали биржу
        PanelDeal.Deal.Trader = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Broker ) );
        PanelDeal.Deal.Broker = null;
        // Для погашения выпуска PartyID(получатель) задается в поле "Депозитарий"
        // Для погашения купонов и ЧП поле "Депозитарий" не задается
        if( PanelDeal.Deal.IsRet_Coupon or PanelDeal.Deal.IsRet_Partly )
           PanelDeal.Deal.Party = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Trader ) );
        end;
     else // задали не биржу (брокера)
        PanelDeal.Deal.Trader = null;
        // Для погашения выпуска PartyID(получатель) задается в поле "Депозитарий"
        // Для погашения купонов и ЧП поле "Депозитарий" не задается
        if( PanelDeal.Deal.IsRet_Coupon or PanelDeal.Deal.IsRet_Partly )
           PanelDeal.Deal.Party = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Broker ) );
        end;
     end;
     SP_ClearSchem(PanelDeal.Deal);
  end;

  return RetVal;
end;

private macro proc_RetireFlag( PanelDeal )
  if( PanelDeal.Deal.BofficeKind == DL_RETIREMENT )
     PanelDeal.Deal.Registrar = null;
     PanelDeal.Deal.Pay_Agent = null;
     PanelDeal.Deal.Broker = null;
     PanelDeal.Deal.Trader = null;

     // все почистить, что было в панели
     proc_PayAgentCode( PanelDeal );

     // погашение не через биржу и не через брокера. Депозитарий - получатель
     if( PanelDeal.Deal.Flag1 and PanelDeal.Deal.Flag4 and PanelDeal.Deal.IsRet_Issue )
        PanelDeal.Deal.Party = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Registrar ) );
     end;

     if( (PanelDeal.Deal.ChangedProperty == "Flag1") and (PanelDeal.Deal.Flag1 == true) )
        PanelDeal.Deal.Flag4 = false;
     end;

     if( PanelDeal.Deal.ChangedProperty == "Flag4" )
        if( PanelDeal.Deal.Flag4 == true )
           PanelDeal.Deal.Flag1 = false;
        else
           PanelDeal.Deal.BrokerContr = null;
        end;
     end;
  end;
end;

private macro proc_Iss_Kind(
  panelDeal//:CScPanelDeal
)
  SetFieldsByAvoirKind( panelDeal );

  panelDeal.Deal.Iss = null;
  panelDeal.Deal.Iss_ISIN = null;

  AfterClearIss( panelDeal, false );
end;

private macro proc_Iss_Kind_b(
  panelDeal//:CScPanelDeal
)
  panelDeal.Deal.Iss_b = null;

  AfterClearIss( panelDeal, true );
end;

private macro proc_Iss(
  panelDeal//:CScPanelDeal
)
  if( SP_GetFIID( panelDeal.Deal.Iss ) > ALLFININSTR )
    SetIss( panelDeal );
  else
    AfterClearIss( panelDeal, false );
  end;
end;

// обработчик поля Код ц/б из группы Зачисление для операции конвертации ц/б
private macro proc_Iss_b(
  panelDeal//:CScPanelDeal
)
  if( SP_GetFIID( panelDeal.Deal.Iss_b ) > ALLFININSTR )
    SetIss_b( panelDeal );
  else
    AfterClearIss( panelDeal, true );
  end;
end;

// Обработчик поля "кол-во ц/б" для операции конвертации ц/б
private macro proc_base_amount( PanelDeal, IsBackSale:Bool );
  var stat : Integer = -1;
  var Nominal:Double = 0;

  if( PanelDeal.Deal.BofficeKind == DL_CONVAVR )
     if( IsBackSale )
        Nominal = GetFaceValue(SP_GetFIID(PanelDeal.Deal.Iss_b));
        PanelDeal.Deal.Cost_b = PanelDeal.Deal.Principal_b  * Nominal;
        PanelDeal.Deal.TotalCost_b = PanelDeal.Deal.Cost_b;
     else
        Nominal = GetFaceValue(SP_GetFIID(PanelDeal.Deal.Iss));
        PanelDeal.Deal.Cost = PanelDeal.Deal.Principal  * Nominal;
        PanelDeal.Deal.TotalCost = PanelDeal.Deal.Cost;
     end;

     Web_SP_ReCalcDealPrice( PanelDeal, IsBackSale );
  elif( PanelDeal.Deal.BofficeKind == DL_AVRWRT )
     PanelDeal.Deal.Cost = PanelDeal.Deal.Principal  * PanelDeal.Deal.Price;
  end;

OnError( err )
  ScDealRunError( err, stat );
end;

private macro proc_Iss_ret( PanelDeal )
  var nominal_fiid:Integer = NATCUR;

  proc_Iss( PanelDeal );

  PanelDeal.Deal.Number_Coupon = CTxAvoirPay();
  PanelDeal.Deal.Number_Partly = CTxAvoirPay();

  // ...

  Web_SP_CalcRetireAmount(PanelDeal.Deal);

  PanelDeal.Deal.CrncPay = GetTWsFinInstrByID( SP_GetFIID( PanelDeal.Deal.Crnc ) );

  SP_SetDepositaryReceiver(PanelDeal.Deal);
  SP_AfterImportantChange(PanelDeal, false);

  if( SP_GetFIID(PanelDeal.Deal.Iss) <= ALLFININSTR )
     PanelDeal.Deal.Start = ZeroDate;
     PanelDeal.Deal.Maturity = ZeroDate;
  end;

  nominal_fiid = NATCUR;
  if( ( SP_GetFIID( PanelDeal.Deal.Iss ) > ALLFININSTR )
  and ( (not FI_IsInvestmentShare( SP_GetFIID( PanelDeal.Deal.Iss ) )) and (not FI_IsHypothecaryCert(SP_GetFIID( PanelDeal.Deal.Iss ) ) ) ) )
     nominal_fiid = SP_GetFIID( PanelDeal.Deal.IssAvoirIss.FaceValueFI );
  end;

  PanelDeal.Deal.NominalFIID = GetTWsFinInstrByID( nominal_fiid, CODE_Ccy );
  PanelDeal.Deal.Nominal = GetFaceValue( SP_GetFIID( PanelDeal.Deal.Iss ) );
end;

private macro proc_AvanceDeposit(
  panelDeal//:CScPanelDeal
 ,isBackSale:Bool
)
  if( not isBackSale )
    if( not panelDeal.Deal.Avance )
      panelDeal.Deal.PeriodTypeAvance = CreateNameAlgFromAppServ( 3159, 0 );
    end;
    if( (not panelDeal.Deal.Avance) and (not panelDeal.Deal.Deposit) )
      panelDeal.Deal.StartDiff = 0;
      panelDeal.Deal.Start = ZeroDate;
      panelDeal.Deal.SumAvance = $0;
      Web_SP_RecalcSum(PanelDeal, false);
    end;
  else
    if( not panelDeal.Deal.Avance_b )
      panelDeal.Deal.PeriodTypeAvance_b = CreateNameAlgFromAppServ( 3159, 0 );
    end;
    if( (not panelDeal.Deal.Avance_b) and (not panelDeal.Deal.Deposit_b) )
      panelDeal.Deal.StartDiff_b = 0;
      panelDeal.Deal.Start_b = ZeroDate;
      panelDeal.Deal.SumAvance_b = $0;
      Web_SP_RecalcSum(PanelDeal, true);
    end;
  end;
end;

private macro proc_over_val( Deal )
   if( Deal.Overval > 0 )
      Deal.DateOverval = Deal.DealDate;
   else
      Deal.DateOverval = ZeroDate;
   end;
end;

// Для операции конвертации ц/б Эмитент зачисляемых ц/б по умолчанию равен эмитенту списываемых ц/б.
private macro SetBackIssuerConv( Deal )
  var stat:integer = -1;

  if( (Deal.ChangedProperty == "IssKind") or (Deal.ChangedProperty == "Issuer") or (Deal.ChangedProperty == "Iss") )
     if( (SP_GetPartyID(Deal.Issuer) != UnknownParty) and (SP_GetPartyID(Deal.Issuer_b) == UnknownParty) )
        Deal.Issuer_b = GetTWsPartyExByID( SP_GetPartyID( Deal.Issuer ) );
     end;
  elif( (Deal.ChangedProperty == "IssKind_b") or (Deal.ChangedProperty == "Issuer_b") or (Deal.ChangedProperty == "Iss_b") )
     if( (SP_GetPartyID(Deal.Issuer_b) != UnknownParty) and (SP_GetPartyID(Deal.Issuer) == UnknownParty) )
        Deal.Issuer = GetTWsPartyExByID( SP_GetPartyID( Deal.Issuer_b ) );
     end;
  end;

OnError( err )
  ScDealRunError(err, stat);
end;

private macro check_DealCode(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;
  var sqlQuery:String = "";
  var rsdCmd = null;
  var dataSet = null;

  if( (deal.DealCode != null) and (deal.DealCode != "") )
    sqlQuery =
      " SELECT "
      "   Count(1) cnt "
      " FROM "
      "   ddl_tick_dbt tick "
      " WHERE "
      "       tick.t_BofficeKind = ? "
      "   AND tick.t_DealCode = ? "
      "   AND ROWNUM = 1 "
      +   IIF(data.Deal.DealID > 0, " AND tick.t_DealID != " + data.Deal.DealID, "" );

    rsdCmd = RSDCommand( sqlQuery );

    rsdCmd.NullConversion = true;

    rsdCmd.AddParam( "", RSDBP_IN, deal.BofficeKind );
    rsdCmd.AddParam( "", RSDBP_IN, deal.DealCode );

    rsdCmd.Execute();

    dataSet = TRsbDataSet( rsdCmd );
    if( dataSet.MoveNext() )
      if( dataSet.Cnt > 0 )
        // Запись с таким номером уже существует.
        responseBuilder.AddError( 31684 );
      end;
    end;
  end;
end;

private macro check_date(d1:date, d2:date, condition:bool ):bool
  var RetVal = true;

  // проверяем только если одна из дат задана, иначе проверка не нужна
  if( (d1 != ZeroDate) and (d2 != ZeroDate) and condition )
    RetVal = false;
  end;

  return RetVal;
end;

private macro check_DealDate(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( SP_GetFIID( deal.Iss ) > ALLFININSTR )
    if( deal.IsTwoPart )
      if( not check_date( deal.IssAvoirIss.DrawingDate, deal.DealDate, ( deal.IssAvoirIss.DrawingDate <= deal.DealDate ) ) );
        // Дата заключения сделки должна быть не больше даты погашения ценной бумаги
        responseBuilder.AddError( 37102 );
      end;

      if( not check_date( deal.IssAvoirIss.Issued, deal.DealDate, ( deal.IssAvoirIss.Issued > deal.DealDate ) ) );
        // Дата заключения сделки должна быть не меньше даты выпуска ценной бумаги
        responseBuilder.AddError( 37103 );
      end;

      if( not check_date( deal.IssAvoirIss.InCirculationDate, deal.DealDate, ( deal.IssAvoirIss.InCirculationDate > deal.DealDate ) ) );
        // Дата заключения сделки должна быть не меньше даты ввода ценной бумаги в обращение
        responseBuilder.AddError( 37104 );
      end;
    end;
  end;

  if( not check_date( deal.DealDate, deal.CommDate, ( deal.DealDate > deal.CommDate ) ) )
    // Дата заключения сделки должна быть не больше любой из дат валютирования
    responseBuilder.AddError( 8085 ); // SEC_ERROR_BAD_DEAL_DATE
  end;

  if( (deal.BofficeKind != DL_RETIREMENT) and (deal.BofficeKind != DL_AVRWRT) )
    if( ( not check_date( deal.DealDate, deal.BaseDate, ( deal.DealDate > deal.BaseDate ) ) )
     or ( not check_date( deal.DealDate, deal.ContrDate, ( deal.DealDate > deal.ContrDate ) ) )
     or ( not check_date( deal.DealDate, deal.BaseDate_b, ( deal.DealDate > deal.BaseDate_b ) ) )
     or ( not check_date( deal.DealDate, deal.ContrDate_b, ( deal.DealDate > deal.ContrDate_b ) ) ) )
      // Дата заключения сделки должна быть не больше любой из дат валютирования
      responseBuilder.AddError( 8085 ); // SEC_ERROR_BAD_DEAL_DATE
    end;
  end;

  if( deal.DealStatus != DL_PREPARING )
    if( not check_date( deal.DealDate, {CurDate}, ( deal.DealDate > {CurDate} ) ) )
      // Дата должна быть не больше текущей
      responseBuilder.AddErrorEx( 37084, MessageSeverity.ValidationError, GetErrorMsgEx( 8063 ) ); // SEC_ERROR_DATEBIG
    end;
  end;
end;

private macro check_Client(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.IsOutExchange )
    if( SP_GetPartyID( deal.Client ) == {OurBank} )
      // Наш банк не может быть клиентом
      responseBuilder.AddError( 37004 );
    end;
  end;
end;

private macro check_Party(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.IsOutExchange )
    if( SP_GetPartyID( deal.Party ) == {OurBank} )
      // Наш банк не может быть контрагентом
      responseBuilder.AddError( 37005 );
    end;
  end;

  if( ( SP_GetPartyID( Deal.Party ) != UnknownParty )
  and ( SP_GetPartyID( Deal.Party ) == SP_GetPartyID( Deal.Client ) ) )
    // Контрагент не может быть клиентом
    responseBuilder.AddError( 37006 );
  end;

  if( ( not Deal.IsBroker )
  and ( SP_GetPartyID( Deal.Party ) != UnknownParty )
  and ( SP_GetPartyID( Deal.Party ) == SP_GetPartyID( Deal.Broker ) ) )
    // Контрагент не может быть посредником
    responseBuilder.AddError( 37007 );
  end;
end;

private macro check_NumDays(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.IsLoan )
    if( deal.NumDays < 1 )
      // Неверное значение поля
      responseBuilder.AddError( 8026 );
    end;
  end;
end;

private macro check_IncomeRate(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.IsLoan )
    if( deal.IncomeRate < $0 )
      // Процентная ставка должна быть больше нуля
      responseBuilder.AddError( 37107 );
    end;
  end;
end;

private macro check_IncomeRate_b(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;
  if( deal.IsKsu and deal.IsSALE and ВидСубъекта(SP_GetPartyID( deal.Party ), PTK_CENTRBANK) )
    if( deal.IncomeRate_b < $0 )
      // Процентная ставка должна быть больше нуля
      responseBuilder.AddError( 37107 );
    end;
  end;
end;

private macro check_Issuer(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.IsOutExchange )
    if( SP_GetPartyID( deal.Issuer ) == {OurBank} )
      // Наш банк не может быть эмитентом
      responseBuilder.AddError( 37001 );
    end;
  end;
end;

private macro check_Iss(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( SP_GetFIID( deal.Iss ) > ALLFININSTR )
    if( deal.Iss.Kind != FIKIND_AVOIRISS )
      // Фин. инструмент не является ценной бумагой
      responseBuilder.AddError( 8077 ); // SEC_ERROR_NOT_SP
    else
      if( SP_GetPartyID( deal.Issuer ) != SP_GetPartyID( deal.IssAvoirIss.Issuer ) )
        // Фин. инструмент не является ценной бумагой
        responseBuilder.AddError( 8077 ); // SEC_ERROR_NOT_SP
      end;
    end;
  end;
end;

private macro check_Iss_Ret(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;
  var stat:Integer = 0;
  var isWarning:Bool = false;
  var lastPartial:String = "";
  var lastCoupon:String = "";
  var existPartial:Bool = false;
  var issueBeforDrawingDate:Bool = false;
  var coupon:String = "";
  var existCoupon:Bool = false;

  if( deal.BofficeKind == DL_RETIREMENT )
    if( SP_GetFIID( deal.Iss ) > ALLFININSTR )

      // Если хотят погасить ЧП то проверить, что сумма ЧП == 100%
      if( deal.Number_Partly.ID > 0 )
        stat = SP_WEB_CheckPartialSumma( deal.Iss.FIID, isWarning );

        if( stat != 0 )
          if( isWarning )
            responseBuilder.AddWarning( stat );
          else
            responseBuilder.AddError( stat );
          end;
        end;
      end;

      if( stat == 0 )
        // Погашение выпуска
        if( deal.IsRet_Issue )

          // Обязательно должно быть указано последнее ЧП, если оно есть и не погашено
          if( SP_GetLastCouponORPartialNumber( deal.Iss.FIID, lastPartial, false ) == 0 )
            if( lastPartial != "" ) // есть последнее ЧП
              if( deal.Number_Partly.Number != lastPartial )
                if( deal.Number_Partly.Number != "" )
                  // В операции погашения выпуска может быть указано только частичное погашение
                  // с полным списанием номинальной стоимости ценной бумаги
                  responseBuilder.AddError( 8177 );
                else
                  // Есть не выполненное частичное погашение (%s) с полным списанием номинальной стоимости ценной бумаги.
                  // Необходимо указать его в операции погашения выпуска.
                  responseBuilder.AddErrorEx( 8176, MessageSeverity.ValidationError, GetErrorMsgEx( 8176, lastPartial ) );
                end;
              else
                // Разрешать выполнять погашение выпуска если не выполнено только последнее ЧП
                // и запрещать если есть еще не выполненные ЧП кроме последнего
                if( ( SP_ExistNoExecuteCouponORPartial( deal.Iss.FIID, true, lastPartial, existPartial ) == 0 )
                and existPartial )
                  // Для ц/б есть невыполненные частичные погашения.|Запрещено погашение выпуска.
                  responseBuilder.AddError( 8140 );
                end;
              end;
            end;
          end;

          issueBeforDrawingDate = false;
          stat = SP_GetLastCouponORPartialNumber( deal.Iss.FIID, coupon, true );
          if( ( deal.Number_Coupon.ID > 0 ) and ( deal.Number_Coupon.Number != coupon ) )
            issueBeforDrawingDate = true;
          end;

          if( stat == 0 )
            // если досрочное погашение то купон должен быть на дату операции
            if( issueBeforDrawingDate )
              stat = SP_GetLastCouponORPartialNumber( deal.Iss.FIID, lastCoupon, true, deal.DealDate);
            else
              stat = SP_GetLastCouponORPartialNumber( deal.Iss.FIID, lastCoupon, true );
            end;
          end;

          if( stat == 0 )
            if( lastCoupon != "" )
              if( not issueBeforDrawingDate )
                if( ( deal.Number_Coupon.ID > 0 ) and ( deal.Number_Coupon.Number != lastCoupon ) )
                  // Можно указать только последний купон (%s).
                  responseBuilder.AddErrorEx( 8179, MessageSeverity.ValidationError, GetErrorMsgEx( 8179, lastCoupon ) );
                else
                  existCoupon = false;
                  if( ( SP_ExistNoExecuteCouponORPartial( deal.Iss.FIID, false, lastCoupon, existCoupon ) == 0 )
                  and existCoupon )
                    // Для ц/б есть непогашенный купон.|Запрещено погашение выпуска.
                    responseBuilder.AddError( 8180 );
                  end;
                end;
              end;
            elif( deal.Number_Coupon.ID > 0 )
              // В операции погашения должен быть указан купон
              responseBuilder.AddError( 8181 );
            end;
          end;
        else // if( deal.IsRet_Issue ) // Погашение купона или ЧП
          // В операциях погашения купона и ЧП нельзя указывать номер последнего ЧП
          if( ( deal.Number_Partly.ID > 0 )
          and ( SP_GetLastCouponORPartialNumber( deal.Iss.FIID, lastPartial, false ) == 0 )
          and ( deal.Number_Partly.Number == lastPartial ) )
            // Частичное погашение с полным списанием номинальной стоимости ценной бумаги
            // может быть выполнено только в операции погашения выпуска
            responseBuilder.AddError( 8174 );
          end;
        end;
      end;
    end;
  end;
end;

private macro check_Principal(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( Deal.BofficeKind != DL_CONVAVR )
    if( Deal.Principal < $0 )
      // Количество должно быть больше нуля
      responseBuilder.AddError( 37016 );
    end;
  end;
end;

private macro check_Price(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.BofficeKind != DL_CONVAVR )
    if( not deal.IsBasket )
      if( deal.Price < $0 )
        // Цена должна быть больше нуля
        responseBuilder.AddError( 37017 );
      end;
    end;
  end;
end;

private macro check_Cost(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.IsRet_Partly
   or deal.IsRet_Issue )
    if( deal.Cost < $0 )
      // Стоимость должна быть больше нуля
      responseBuilder.AddError( 37018 );
    end;
  end;
end;

private macro check_SumAvance(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.IsOutExchange and (deal.Avance or deal.Deposit) )
    if( ( deal.TotalCost + deal.ReturnIncome_b ) < deal.SumAvance )
      // Сумма аванса не должна превышать сумму сделки
      responseBuilder.AddError( 8094 ); // SEC_ERROR_AVANCE_SUM
    end;
  end;
end;

private macro check_BaseDate(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( not check_date( deal.ChangeDate, deal.BaseDate, ( deal.ChangeDate > deal.BaseDate ) ) )
    // Дата поставки должна быть не меньше даты изменения условий
    responseBuilder.AddError( 37003 );
  end;

  if( not check_date( deal.BaseDate, deal.BaseDate_b, ( deal.BaseDate > deal.BaseDate_b ) ) )
    // Дата поставки по второй части сделки должна быть больше чем по первой.
    responseBuilder.AddError( 8018 );
  end;

  if( deal.BofficeKind != DL_RETIREMENT )
    if( CodeFor( SP_GetTypeAccType( deal.TypeCalc ) ) == SP_TYPE_CALC_PP )
      if( not check_date( deal.ContrDate, deal.BaseDate, ( deal.ContrDate > deal.BaseDate ) ) )
        // Плановая дата поставки должна быть не меньше даты платежа
        responseBuilder.AddError( 37092 );
      end;
    end;
  end;

  if( deal.BofficeKind == DL_AVRWRT )
    if( not check_date( deal.DealDate, deal.BaseDate, ( deal.DealDate < deal.BaseDate ) ) )
    // Дата исходной покупки должна быть не больше даты зачисления ц/б
      responseBuilder.AddError( 8188 );
    end;
  end;
end;

private macro check_DateOverval(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.BofficeKind == DL_AVRWRT )
    if( not check_date( deal.DateOverval, deal.BaseDate, ( deal.DateOverval < deal.BaseDate ) ) )
    // Дата последней переоценки не должна быть меньше даты исходной покупки
      responseBuilder.AddError( 31809 );
    end;
  end;
end;

private macro check_ContrDate(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.BofficeKind != DL_RETIREMENT )
    if( not check_date( deal.ChangeDate, deal.ContrDate, ( deal.ChangeDate > deal.ContrDate ) ) )
      // Дата оплаты должна быть не меньше даты изменения условий
      responseBuilder.AddError( 37002 );
    end;

    if( CodeFor( SP_GetTypeAccType( deal.TypeCalc ) ) == SP_TYPE_CALC_PD )
      if( not check_date( deal.BaseDate, deal.ContrDate, ( deal.BaseDate > deal.ContrDate ) ) )
        // Плановая дата платежа должна быть не меньше даты поставки
        responseBuilder.AddError( 37093 );
      end;
    end;

    if( deal.IsLoan )
      if( not check_date( deal.ContrDate, deal.BaseDate, ( deal.BaseDate > deal.ContrDate ) ) )
        // Дата возврата ц/б должна быть больше даты получения ц/б
        responseBuilder.AddError( 8141 );
      end;
    end;
  end;
end;

private macro check_BaseDate_b(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.BofficeKind != DL_RETIREMENT )
    if( deal.IsTwoPart )
      if( not check_date( deal.ChangeDate, deal.BaseDate_b, ( deal.ChangeDate > deal.BaseDate_b ) ) )
        // Дата поставки второй части должна быть не меньше даты изменения условий
        responseBuilder.AddError( 37083 );
      end;

      if( not deal.IsExchange )
        if( not check_date( deal.BaseDate, deal.BaseDate_b, ( deal.BaseDate > deal.BaseDate_b ) ) )
        // Дата поставки по второй части сделки должна быть больше чем по первой
          responseBuilder.AddError( 37108 );
        end;
      end;

      if( CodeFor( SP_GetTypeAccType( deal.TypeCalc_b ) ) == SP_TYPE_CALC_PP )
        if( not check_date( deal.ContrDate_b, deal.BaseDate_b, ( deal.ContrDate_b > deal.BaseDate_b ) ) )
          // Плановая дата поставки второй части должна быть не меньше даты платежа
          responseBuilder.AddError( 37109 );
        end;
      end;
    end;
  end;
end;

private macro check_ContrDate_b(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.BofficeKind != DL_RETIREMENT )
    if( deal.IsTwoPart )
      if( not check_date( deal.ChangeDate, deal.ContrDate_b, ( deal.ChangeDate > deal.ContrDate_b ) ) )
        // Дата оплаты второй части должна быть не меньше даты изменения условий
        responseBuilder.AddError( 37082 );
      end;

      if( CodeFor( SP_GetTypeAccType( deal.TypeCalc_b ) ) == SP_TYPE_CALC_PD )
        if( not check_date( deal.BaseDate_b, deal.ContrDate_b, ( deal.BaseDate_b > deal.ContrDate_b ) ) )
          // Плановая дата платежа второй части должна быть не меньше даты поставки
          responseBuilder.AddError( 37110 );
        end;
      end;
    end;
  end;
end;

private macro check_Start(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.BofficeKind == DL_RETIREMENT )
    if( not check_date( deal.Start, {CurDate}, ( deal.Start > {CurDate} ) ) )
      // Дата должна быть не больше текущей
      responseBuilder.AddErrorEx( 37085, MessageSeverity.ValidationError, GetErrorMsgEx( 8063 ) ); // SEC_ERROR_DATEBIG
    end;

    if( not check_date( deal.DealDate, deal.Start, ( deal.DealDate < deal.Start ) ) )
      // Дата составления перечня должна быть не больше даты операции
      responseBuilder.AddError( 8115 );
    end;
  end;
end;

private macro check_Maturity(
  data:Variant
 ,responseBuilder:SP_WebResponseBuilder
)
  var panelDeal = data;
  var deal = panelDeal.Deal;

  if( deal.BofficeKind == DL_RETIREMENT )
    if( deal.DealDate > deal.Maturity )
      // Дата получения средств должна быть больше или равна дате планового погашения (Дата операции)
      responseBuilder.AddError( 37089 );
    end;
  end;
end;

private macro REPOBasketExitField(
  PanelDeal//:CScPanelDeal // Параметры сделки
 ,TransfersGenerated:@Bool
):Bool

  var Handled:Bool = false;
  var Deal = PanelDeal.Deal;

  TransfersGenerated = true;

  if( Deal.ChangedProperty == "DealTime" )
    Handled = true;
  elif( Deal.ChangedProperty == "Depositary" )
    Deal.Depositary_b = GetTWsPartyExByID( SP_GetPartyID( Deal.Depositary ) );
    Handled = true;
  elif( Deal.ChangedProperty == "Registrar" )
    Handled = true;
  elif( Deal.ChangedProperty == "RegistrarContr" )
    Handled = true;
  elif( Deal.ChangedProperty == "Iss" )
    Handled = true;
  elif( Deal.ChangedProperty == "IncomeRate_b" )
    TransfersGenerated = false;
    Handled = true;
  elif( Deal.ChangedProperty == "ReturnIncome_b" )
    Handled = true;
  elif( Deal.ChangedProperty == "Principal" )
    Handled = true;
  elif( ( Deal.ChangedProperty == "Cost" ) or ( Deal.ChangedProperty == "Cost_b" ) )
    Handled = true;
  elif( ( Deal.ChangedProperty == "TotalCost" ) or ( Deal.ChangedProperty == "TotalCost_b" ) )
    proc_dealsum_byAllAmount_Bas( PanelDeal );
    TransfersGenerated = false;
    Handled = true;
  end;

  return Handled;
end;

private macro GetCorrectPartyName(Deal)
  var name = "";
  if(Deal.ChangedProperty == "Client")
    if(Deal.Client != null)
      if( (Deal.Client.ShortName != null) and (Deal.Client.ShortName != "") )
        name = Deal.Client.ShortName;
      elif ((Deal.Client.Name != null) and (Deal.Client.Name != "") )
        name = Deal.Client.Name;
      end;
    end;
  else
    if((Deal.Party != null) and (Deal.Party.Name != null))
      name = Deal.Party.name;
    end;
  end;

  return name;
end;

macro ScDealExitField(
  PanelDeal//:CScPanelDeal // Параметры сделки
):WebServiceResponse

  var stat:integer = 0;
  var ResponseBuilder:SP_WebResponseBuilder = SP_WebResponseBuilder();
  var Iss = TRecHandler( "fininstr" );
  var Handled:Bool = false;
  var TransfersGenerated:Bool = true;
  var ErrorRecalcDates:Integer = 0;
  var ErrorRegenerate:Integer = 0;
  var Group:Integer = 0;
  var dataChngHandl = null;

  InitError();

  if( PanelDeal == null )
     RunError("Не задан обязательный параметр функции: параметры сделки");
  end;

  var Deal = PanelDeal.Deal;
  if( Deal == null )
     RunError("Не задан обязательный параметр функции: сделка");
  end;

  // !!! Иначе не работает добавление элементов
  PanelDeal.RQ = TArray(PanelDeal.RQ);
  PanelDeal.RQAcc = TArray(PanelDeal.RQAcc);
  PanelDeal.Comiss = TArray(PanelDeal.Comiss);
  if( Deal.IsBasket )
    PanelDeal.EnsureList = TArray(PanelDeal.EnsureList);
  end;

  CorrectDealDatesTimes(Deal);
  CorrectRQDates(PanelDeal.RQ);

  dataChngHandl = DataChangeHandler();

  dataChngHandl.SetData( PanelDeal );
  dataChngHandl.SetResponseBuilder( ResponseBuilder );

  dataChngHandl.AddPropertyHandlers( "DealCode", null, @check_DealCode );
  dataChngHandl.AddPropertyHandlers( "DealDate", null, @check_DealDate );
  dataChngHandl.AddPropertyHandlers( "Client", null, @check_Client );
  dataChngHandl.AddPropertyHandlers( "Party", null, @check_Party );
  dataChngHandl.AddPropertyHandlers( "NumDays", null, @check_NumDays );
  dataChngHandl.AddPropertyHandlers( "IncomeRate", null, @check_IncomeRate );
  dataChngHandl.AddPropertyHandlers( "Issuer", null, @check_Issuer );
  dataChngHandl.AddPropertyHandlers( "Iss", null, @check_Iss );
  dataChngHandl.AddPropertyHandlers( "Iss_ISIN", null, @check_Iss );
  dataChngHandl.AddPropertyHandlers( "Principal", null, @check_Principal );
  dataChngHandl.AddPropertyHandlers( "Price", null, @check_Price );
  dataChngHandl.AddPropertyHandlers( "Cost", null, @check_Cost );
  dataChngHandl.AddPropertyHandlers( "SumAvance", null, @check_SumAvance );
  dataChngHandl.AddPropertyHandlers( "BaseDate", null, @check_BaseDate );
  dataChngHandl.AddPropertyHandlers( "DateOverval", null, @check_DateOverval );
  dataChngHandl.AddPropertyHandlers( "ContrDate", null, @check_ContrDate );
  dataChngHandl.AddPropertyHandlers( "BaseDate_b", null, @check_BaseDate_b );
  dataChngHandl.AddPropertyHandlers( "ContrDate_b", null, @check_ContrDate_b );
  dataChngHandl.AddPropertyHandlers( "Start", null, @check_Start );
  dataChngHandl.AddPropertyHandlers( "Maturity", null, @check_Maturity );
  dataChngHandl.AddPropertyHandlers( "Iss", null, @check_Iss_Ret );
  dataChngHandl.AddPropertyHandlers( "IncomeRate_b", null, @check_IncomeRate_b );

  dataChngHandl.SetChangedProperty( Deal.ChangedProperty );
  dataChngHandl.SetCheckingPropertyList( Deal.CheckingPropertyList );

  // обработка схода с поля
  if( Deal.ChangedProperty != null )

     // частные обработчики
     // биржевые
     if( Deal.IsExchange and not Deal.IsRepo )
     // брокерские
     elif( Deal.IsBroker )
     // внебиржевые
     elif( Deal.IsOutExchange and not Deal.IsRepo )
     // сделки РЕПО биржевые
     elif( Deal.IsRepo and Deal.IsExchange and not Deal.IsBasket )
     // сделки РЕПО внебиржевые
     elif( Deal.IsRepo and Deal.IsOutExchange and not Deal.IsBasket )
     // сделки РЕПО на корзину
     elif( Deal.IsRepo and Deal.IsBasket )
        Handled = REPOBasketExitField( PanelDeal, @TransfersGenerated );
     // займ
     elif( Deal.IsLoan )
     end;

     if( not Handled )
        // общие обработки
        if( Deal.ChangedProperty == "DealDate" )
           Group = Web_SP_GetOperationGroup(Deal);

           if( IsTODAY(Group) )
              Deal.CommDate  = Deal.DealDate;
              Deal.ContrDate = Deal.DealDate;
              Deal.BaseDate  = Deal.DealDate;
           end;

           if( Deal.BofficeKind == DL_RETIREMENT )
              Deal.ContrDate = Deal.DealDate;
              Deal.BaseDate  = Deal.DealDate;
           end;
        elif( Deal.ChangedProperty == "Flag1" )
           if( Deal.BofficeKind == DL_RETIREMENT )
              proc_RetireFlag( PanelDeal );
              if( Deal.Flag1 )
                 Deal.Maturity = Deal.DealDate;
              end;
           end;
           SP_ClearSchem( Deal );
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Flag2" )
           SP_AfterImportantChange(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Flag4" )
           if( Deal.BofficeKind == DL_RETIREMENT )
              proc_RetireFlag( PanelDeal );
              if( Deal.Flag4 )
                 Deal.Maturity = Deal.DealDate;
              end;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "IssKind" )
           proc_Iss_Kind( PanelDeal );
           if( PanelDeal.Deal.BofficeKind == DL_AVRWRT )
             Deal.Portfolio = TWsLlvalues(-2,"","",-2);
             Deal.PortfolioList = GetListForPortfolio(Deal, 1100);
             if( SP_GetFIID( Deal.Iss ) > ALLFININSTR )
                Deal.IssAvoirIss = TxGetAvoirIss( Deal.Iss.Fiid );
                if(not FI_IsKSU(SP_GetFIID(Deal.Iss)))
                  Deal.Trader = null;
                  SP_ClearSchem( Deal );
                end;
             else
                Deal.IssAvoirIss = CTxAvoirIss();
                Deal.Trader = null;
                SP_ClearSchem( Deal );
             end;
           end;
           if( Deal.BofficeKind == DL_CONVAVR )
              SetBackIssuerConv( Deal );
           end;
        elif( Deal.ChangedProperty == "IssKind_b" )
           proc_Iss_Kind_b( PanelDeal );
           if( Deal.BofficeKind == DL_CONVAVR )
              SetBackIssuerConv( Deal );
           end;
        elif( Deal.ChangedProperty == "Issuer" )
           Deal.Iss = null;
           Deal.Iss_ISIN = null;
           AfterClearIss(PanelDeal, false);
           if( Deal.BofficeKind == DL_RETIREMENT )
              proc_Iss_ret(PanelDeal);
           elif( Deal.BofficeKind == DL_CONVAVR )
              SetBackIssuerConv( Deal );
           end;
        elif( Deal.ChangedProperty == "Issuer_b" )
           Deal.Iss_b = null;
           AfterClearIss(PanelDeal, true);
           if( Deal.BofficeKind == DL_CONVAVR )
              SetBackIssuerConv( Deal );
           end;
        elif(Deal.ChangedProperty == "Iss_ISIN")
           /*Установить нового Iss*/
            if( SP_GetFIID( Deal.Iss_ISIN ) > ALLFININSTR)
              Deal.Iss = GetTWsFinInstrByID( SP_GetFIID( panelDeal.Deal.Iss_ISIN ) );
              proc_Iss( PanelDeal );
            else
              Deal.Iss = null;
              AfterClearIss( panelDeal, true );
            end;
        elif( Deal.ChangedProperty == "Iss")
           if( Deal.BofficeKind != DL_RETIREMENT )
              if( SP_GetFIID( Deal.Iss ) > ALLFININSTR)
                Deal.Iss_ISIN = GetTWsFinInstrByID( SP_GetFIID( panelDeal.Deal.Iss ), CODE_ISIN );
              else
                Deal.Iss_ISIN = null;
              end;
              proc_Iss( PanelDeal );
           else
              proc_Iss_ret( PanelDeal );
           end;
           if( Deal.BofficeKind != DL_CONVAVR )
              if (FI_IsKSU(SP_GetFIID(Deal.Iss)))
                Deal.Portfolio = CreateLLValueFromAppServ(1100, KINDPORT_BACK_KSU);
              else
                var AvoirIss = TRecHandler( "avoiriss.dbt" );
                ПолучитьФинИн( SP_GetFIID(Deal.Iss), null, AvoirIss );
                if( ExistNOSS( AvoirIss, IIF(Deal.DealDate != ZeroDate, Deal.DealDate, ZeroDate) ) )
                   Deal.Portfolio = CreateLLValueFromAppServ(1100, KINDPORT_TRADE);
                else
                   if(Deal.BofficeKind == DL_AVRWRT)
                      Deal.Portfolio = CreateLLValueFromAppServ(1100, KINDPORT_SALE);
                   else
                      Deal.Portfolio = TWsLlvalues(-2,"","",-2);
                   end;
                   Deal.Client = null;
                   Deal.ClientContr = null;
                end;
              end;
              Deal.PortfolioList = GetListForPortfolio(Deal, 1100);
              if( SP_GetFIID( Deal.Iss ) > ALLFININSTR )
                 Deal.IssAvoirIss = TxGetAvoirIss( Deal.Iss.Fiid );
                 if (not FI_IsKSU(SP_GetFIID(Deal.Iss)))
                    Deal.Trader = null;
                    SP_ClearSchem( Deal );
                 end;
              else
                 Deal.IssAvoirIss = CTxAvoirIss();
                 if (Deal.BofficeKind == DL_RETIREMENT)
                    AfterClearIss(PanelDeal, false);
                    Deal.Issuer = null;
                    Deal.NominalFiid = null;
                    Deal.Principal = $0;
                 elif(Deal.BofficeKind == DL_AVRWRT)
                    Deal.Trader = null;
                    SP_ClearSchem( Deal );
                    Deal.Portfolio = TWsLlvalues(-2,"","",-2);
                 end;
              end;
           end;
           if( Deal.IsLoan )
              AfterChangeIss( Deal );
           elif( Deal.BofficeKind == DL_CONVAVR )
              proc_base_amount( PanelDeal, false );
              proc_Avoiriss_Conv( Deal );
              SetBackIssuerConv( Deal );
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Iss_b" )
           if( Deal.BofficeKind == DL_CONVAVR )
              proc_Iss_b( PanelDeal );
              proc_base_amount( PanelDeal, true );
              RecalcAmount( Deal );
              SetBackIssuerConv( Deal );
              if( SP_GetFIID( Deal.Iss_b ) > ALLFININSTR )
                 Deal.IssAvoirIss_b = TxGetAvoirIss( Deal.Iss_b.Fiid );
              else
                 Deal.IssAvoirIss_b = CTxAvoirIss();
              end;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Portfolio" )
           if( (Deal.Portfolio != null) and (Deal.Portfolio.Element == KINDPORT_CLIENT) )
              Deal.PreOutlay = 0;
           else
              Deal.Client = null;
              Deal.ClientContr = null;
           end;
           if( Deal.BofficeKind == DL_CONVAVR )
              UpdatePortfolioConv( Deal );
              CalcWriteOffAmount( Deal );
              TransfersGenerated = false;
           end;
        elif( Deal.ChangedProperty == "Portfolio_2" )
           if( (Deal.Portfolio_2 != null) and (Deal.Portfolio_2.Element == KINDPORT_CLIENT) )
              Deal.PreOutlay = 0;
           else
              Deal.Client = null;
              Deal.ClientContr = null;
           end;
           if( Deal.BofficeKind == DL_CONVAVR )
              UpdatePortfolioConv( Deal );
              RecalcAmount( Deal );
              TransfersGenerated = false;
           end;
        elif( Deal.ChangedProperty == "Principal" )
           if( Deal.BofficeKind == DL_CONVAVR )
              proc_base_amount( PanelDeal, false );
              RecalcAmount( Deal );
           elif( Deal.BofficeKind == DL_AVRWRT)
              proc_dealprice(PanelDeal, false);
              proc_base_amount( PanelDeal, false );

              Deal.WrtTaxCostSum = Deal.WrtTaxPriceSum * Deal.Principal;
              Deal.WrtTaxNKDSum = PanelDeal.Deal.NKD;
           else
              SP_AfterImportantChange(PanelDeal, false);
           end;

           if( Deal.IsLoan )
              RecalculatePC( Deal );
           end;
           TransfersGenerated = false;
           // сделки РЕПО биржевые/внебиржевые
           if( Deal.IsRepo and ( Deal.IsExchange or Deal.IsOutExchange ) and not Deal.IsBasket )
             Deal.Principal_b = Deal.Principal;
           end;
        elif( Deal.ChangedProperty == "Principal_b" )
           if( Deal.BofficeKind == DL_CONVAVR )
              proc_base_amount( PanelDeal, true );
           else
              SP_AfterImportantChange(PanelDeal, true);
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Price" )
           proc_dealprice(PanelDeal, false);
           if(Deal.BofficeKind == DL_AVRWRT)
             proc_base_amount( PanelDeal, false );
             Deal.WrtTaxNKDSum = PanelDeal.Deal.NKD;
             Deal.WrtTaxPriceSum = Round(money(PanelDeal.Deal.Price), 2);
             Deal.WrtTaxCostSum = Deal.WrtTaxPriceSum * PanelDeal.Deal.Principal;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Price_b" )
           proc_dealprice(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "RelativePrice" )
           proc_IsRelativePrice(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "RelativePrice_b" )
           proc_IsRelativePrice(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Crnc" )
           Web_SP_RecalcSum(PanelDeal, false);
           SP_AfterImportantChange(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Point" )
           SP_RoundPrice(Deal, 1);
           if( Deal.IsTwoPart )
              SP_RoundPrice(Deal, 2);
           end;
           SP_AfterImportantChange(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Cost" )
           proc_dealsum(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Cost_b" )
           proc_dealsum(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "NKD" )
           proc_AllNKD(PanelDeal, false);
           if(Deal.BofficeKind == DL_AVRWRT)
              Deal.WrtTaxNkdSum = PanelDeal.Deal.NKD;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "NKD_b" )
           proc_AllNKD(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Nom" )
           proc_crnc_NKD(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Nom_b" )
           proc_crnc_NKD(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "ContrDate" )
           ErrorRecalcDates = proc_contrdate(PanelDeal, false);
           if( (ErrorRecalcDates == 0) and (Deal.IsLoan) )
              Deal.NumDays = SP_GetPeriod(SP_GetNameAlgNumberAlg(Deal.BasisCalc), Deal.ContrDate, Deal.BaseDate);
              UpdateNumDays(Deal);
              Web_RecalculateNKDOutDate( PanelDeal, false );
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "ContrDate_b" )
           ErrorRecalcDates = proc_contrdate(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "TotalCost" )
           proc_dealsum_byAllAmount(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "TotalCost_b" )
           proc_dealsum_byAllAmount(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "CrncPay" )
           SP_AfterImportantChange(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "MarketSchem" )
           if( SP_GetMarketID(Deal.MarketSchem) > 0 )
              if( SP_GetPartyID( Deal.Trader ) == UnknownParty )
                 Deal.Trader = GetTWsPartyExByID( Deal.MarketSchem.Market );
              end;
              SP_SetFieldsByMarketSchem(Deal);
           else
              SP_ClearMarketSchem(Deal);
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "BaseDate" )
           ErrorRecalcDates = proc_basedate(PanelDeal, false);
           if( ErrorRecalcDates == 0 )
              if( Deal.IsLoan )
                 Web_ChangeDate(Deal);
              elif( Deal.BofficeKind == DL_CONVAVR )
                 CalcWriteOffAmount( Deal );
              end;
              TransfersGenerated = false;
           end;
        elif( Deal.ChangedProperty == "BaseDate_b" )
           ErrorRecalcDates = proc_basedate(PanelDeal, true);
           if( ErrorRecalcDates == 0 )
              TransfersGenerated = false;
           end;
        elif( Deal.ChangedProperty == "DepoSchem" )
           if( SP_GetDepSetID(Deal.DepoSchem) > 0 )
              Deal.Depositary = GetTWsPartyExByID(Deal.DepoSchem.Depositary);
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Client" )
           if( Deal.BofficeKind != DL_CONVAVR )
              if( SP_GetPartyID( Deal.Client ) != UnknownParty )
                 Deal.Portfolio = Deal.Portfolio_2 = CreateLLValueFromAppServ(1100, KINDPORT_CLIENT);
              end;
           end;
           if( SP_GetPartyID( Deal.Client ) != UnknownParty )
              Deal.ClientContr = DL_GetClientContrByPartyID( Deal.DealDate, SP_GetPartyID( Deal.Client ), PTSK_STOCKDL, false );
           else
              Deal.ClientContr = null;
           end;

           Web_SP_CalcRetireAmount( Deal );

           if( Deal.BofficeKind == DL_CONVAVR )
              CalcWriteOffAmount( Deal );
           elif(Deal.BofficeKind == DL_AVRWRT)
             Deal.IsAvrwrtTaxesPanelReadOnly = true;
             ClearAvrWrtTax(Deal);

             if( (SP_GetPartyID( Deal.Client ) == UnknownParty) or
                  ( (SP_GetPartyID( Deal.Client ) != UnknownParty) and (GetPartyLegalForm(SP_GetPartyID( Deal.Client ) ) == PTLEGF_PERSN)
                     and (not IsExistNPTXLot(Deal.DealID) ) )
                )
               Deal.IsAvrwrtTaxesPanelReadOnly = false;
               if(SP_GetPartyID( Deal.Client ) == UnknownParty)
                 Deal.Flag2 = false;
                 Deal.Flag3 = true;
               end;
               FillAvrWrtTaxSum(Deal);
             end;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Party" )
           if( PanelDeal.Deal.IsExchange )
              if( ( ВидСубъекта( SP_GetPartyID( PanelDeal.Deal.Party ), PTK_MARKETPLASE ) == true )
               or ( SP_GetPartyID( PanelDeal.Deal.Party ) == UnknownParty ) )
                 PanelDeal.Deal.TypeDoc = CreateTypeAcFromAppServ( 154, "T" );
              else
                 PanelDeal.Deal.TypeDoc = CreateTypeAcFromAppServ( 154, "N" );
              end;
           end;
           Deal.IsPartyClient = false;
           if( ОбслуживаетсяКлиент( SP_GetPartyID( Deal.Party ), PTSK_STOCKDL ) )
              Deal.IsPartyClient = true;
           end;
           if( Deal.IsPartyClient and ( SP_GetPartyID( Deal.Party ) != UnknownParty ) )
              Deal.PartyContr = DL_GetClientContrByPartyID( Deal.DealDate, Deal.Party.PartyID, PTSK_STOCKDL, false );
           else
              Deal.PartyContr = null;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "IsPartyClient" )
           if( Deal.IsPartyClient == false )
              Deal.PartyContr = null;
           end;
        elif( Deal.ChangedProperty == "FixSum" )
           Web_SP_RecalcSum(PanelDeal, false);
        elif( Deal.ChangedProperty == "SumAvance" )
           Web_SP_RecalcSum(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "SumAvance_b" )
           Web_SP_RecalcSum(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Trader" )
           proc_TraderCode( PanelDeal );
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Start" )
           if( Deal.BofficeKind != DL_RETIREMENT )
              ErrorRecalcDates = proc_avancedate(PanelDeal, false);
           else
              if( Deal.IsRet_Issue )
                 Deal.ContrDate = Deal.Start;
                 Deal.BaseDate  = Deal.Start;

                 if( Web_SP_CalcRetireAmount(Deal) )
                    SP_AfterImportantChange(PanelDeal, false);
                 end;
              end;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Start_b" )
           ErrorRecalcDates = proc_avancedate(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "TypeCalc" )
           ErrorRecalcDates = proc_TypeCalc(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "TypeCalc_b" )
           ErrorRecalcDates = proc_TypeCalc(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PeriodTypeAvance" )
           if((Deal.PeriodTypeAvance == null) or (SP_GetNameAlgNumberAlg(Deal.PeriodTypeAvance) == SP_WEB_ALG_KIND_TYPEPERIOD_DATE))
              Deal.StartDiff = 0;
           end;
           ErrorRecalcDates = proc_PeriodTypeAvance(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PeriodTypeAvance_b" )
           if((Deal.PeriodTypeAvance_b == null) or (SP_GetNameAlgNumberAlg(Deal.PeriodTypeAvance_b) == SP_WEB_ALG_KIND_TYPEPERIOD_DATE))
              Deal.StartDiff_b = 0;
           end;
           ErrorRecalcDates = proc_PeriodTypeAvance(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PeriodTypePay" )
           if((Deal.PeriodTypePay == null) or (SP_GetNameAlgNumberAlg(Deal.PeriodTypePay) == SP_WEB_ALG_KIND_TYPEPERIOD_DATE))
              Deal.Diff = 0;
           end;
           ErrorRecalcDates = proc_PeriodTypePay(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PeriodTypePay_b" )
           if((Deal.PeriodTypePay_b == null) or (SP_GetNameAlgNumberAlg(Deal.PeriodTypePay_b) == SP_WEB_ALG_KIND_TYPEPERIOD_DATE))
              Deal.Diff_b = 0;
           end;
           ErrorRecalcDates = proc_PeriodTypePay(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PeriodTypeState" )
           if((Deal.PeriodTypeState == null) or (SP_GetNameAlgNumberAlg(Deal.PeriodTypeState) == SP_WEB_ALG_KIND_TYPEPERIOD_DATE))
              Deal.PrincipalDiff = 0;
           end;
           ErrorRecalcDates = proc_PeriodTypeState(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PeriodTypeState_b" )
           if((Deal.PeriodTypeState_b == null) or (SP_GetNameAlgNumberAlg(Deal.PeriodTypeState_b) == SP_WEB_ALG_KIND_TYPEPERIOD_DATE))
              Deal.PrincipalDiff_b = 0;
           end;
           ErrorRecalcDates = proc_PeriodTypeState(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Broker" )
           proc_AgentCode( PanelDeal );
           if( SP_GetPartyID( Deal.Broker ) != UnknownParty )
              Deal.BrokerContr = DL_GetClientContrByPartyID( Deal.DealDate, Deal.Broker.PartyID, PTSK_STOCKDL, true );
              if( Deal.IsLoan )
                 Deal.CommDate = Deal.DealDate;
              end;
           else
              Deal.BrokerContr = null;
              if( Deal.IsLoan )
                 Deal.CommDate = ZeroDate;
              end;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Registrar" )
           if( Deal.BofficeKind == DL_RETIREMENT )
              // погашение не через биржу и не через брокера. Депозитарий - получатель
              if( PanelDeal.Deal.Flag1 and PanelDeal.Deal.Flag4 and PanelDeal.Deal.IsRet_Issue )
                 PanelDeal.Deal.Party = GetTWsPartyExByID( SP_GetPartyID( PanelDeal.Deal.Registrar ) );
              end;
           end;
           if( SP_GetPartyID( Deal.Registrar ) != UnknownParty )
              Deal.RegistrarContr = DL_GetClientContrByPartyID( Deal.DealDate, Deal.Registrar.PartyID, PTSK_STOCKDL );
           else
              Deal.RegistrarContr = null;
           end;
           TransfersGenerated = false;
        elif( ( Deal.ChangedProperty == "Depositary" )
           or ( Deal.ChangedProperty == "Depositary_b" ) )
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "ClientContr" )
           if( SP_GetContrID( Deal.ClientContr ) > 0 )
              if( SP_GetPartyID( Deal.Client ) == UnknownParty )
                 Deal.Client = GetTWsPartyExByID( Deal.ClientContr.PayerID );
              end;
           end;
           if( Deal.BofficeKind == DL_RETIREMENT )
              if( SP_GetContrID( Deal.ClientContr ) <= 0 ) // Сбросим также клиента, что бы не занулять сумму
                 Deal.Client = null;
              end;

              if( Web_SP_CalcRetireAmount( Deal ) )
                 SP_AfterImportantChange( PanelDeal, false );
              end;
           elif( Deal.BofficeKind == DL_CONVAVR )
              CalcWriteOffAmount( Deal );
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "BrokerContr" )
           if( SP_GetContrID( Deal.BrokerContr ) > 0 )
              if( SP_GetPartyID( Deal.Broker ) == UnknownParty )
                 Deal.Broker = GetTWsPartyExByID( Deal.BrokerContr.ContractorID );
              end;
           end;
           if( Deal.IsLoan )
              if( SP_GetPartyID( Deal.Broker ) > 0 )
                 Deal.CommDate = Deal.DealDate;
              else
                 Deal.CommDate = ZeroDate;
              end;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "RegistrarContr" )
           if( SP_GetContrID( Deal.RegistrarContr ) > 0 )
              if( SP_GetPartyID( Deal.Registrar ) == UnknownParty )
                 Deal.Registrar = GetTWsPartyExByID( Deal.RegistrarContr.ContractorID );
              end;
           end;
        elif( Deal.ChangedProperty == "PartyContr" )
           if( SP_GetContrID( Deal.PartyContr ) > 0 )
              if( SP_GetPartyID( Deal.Party ) == UnknownParty )
                 Deal.Party = GetTWsPartyExByID( Deal.PartyContr.PayerID );
              end;
           end;
           TransfersGenerated = false;
        elif( ( Deal.ChangedProperty == "Avance" )
           or ( Deal.ChangedProperty == "Deposit" ) )
           proc_AvanceDeposit( PanelDeal, false );
           TransfersGenerated = false;
        elif( ( Deal.ChangedProperty == "Avance_b" )
           or ( Deal.ChangedProperty == "Deposit_b" ) )
           proc_AvanceDeposit( PanelDeal, true );
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "IncomeRate" )
           SP_AfterImportantChange( PanelDeal, false );
           if( Deal.IsLoan )
              RecalculatePC( Deal );
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "IncomeRate_b" )
           SP_AfterImportantChange( PanelDeal, true );
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "ReturnIncome_b" )
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PeriodType" )
           ErrorRecalcDates = Web_SP_RecalcLinkDates(Deal, false);
           if( ErrorRecalcDates == 0 )
              SP_AfterImportantChange(PanelDeal, false);
              if( Deal.IsTwoPart )
                 ErrorRecalcDates = Web_SP_RecalcLinkDates(Deal, true);
                 if( ErrorRecalcDates == 0 )
                    SP_AfterImportantChange(PanelDeal, true);
                 end;
              end;
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "BasisCalc" )
           SP_AfterImportantChange(PanelDeal, false);
           UpdateNumDays( Deal );
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Flag5" )
           if( not Deal.Flag5 )
              Deal.ReturnIncomeType = null;
           end;
        elif( Deal.ChangedProperty == "StartDiff" )
           ErrorRecalcDates = proc_StartDiff(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "StartDiff_b" )
           ErrorRecalcDates = proc_StartDiff(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Diff" )
           ErrorRecalcDates = proc_Diff(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Diff_b" )
           ErrorRecalcDates = proc_Diff(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PrincipalDiff" )
           ErrorRecalcDates = proc_PrincipalDiff(PanelDeal, false);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "PrincipalDiff_b" )
           ErrorRecalcDates = proc_PrincipalDiff(PanelDeal, true);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Pay_Agent" )
           proc_PayAgentCode( PanelDeal );
        elif( Deal.ChangedProperty == "Number_Coupon" )
           if( Web_SP_CalcRetireAmount(Deal) )
              SP_AfterImportantChange(PanelDeal, false);
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Number_Partly" )
           if( Web_SP_CalcRetireAmount(Deal) )
              SP_AfterImportantChange(PanelDeal, false);
           end;
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "NumDays" )
           Web_ChangeDate(Deal);
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "IncomePoint" )
           Deal.IncomeRate = Web_FI_ConvertToPointlessRate( Deal.IncomeRate, Deal.IncomePoint );
           RecalculatePC( Deal );
           TransfersGenerated = false;
        elif( Deal.ChangedProperty == "Overval" )
           if( Deal.BofficeKind == DL_AVRWRT )
              proc_over_val( Deal );
           end;
           TransfersGenerated = false;
        elif(Deal.ChangedProperty == "BuyOutlay")
           if( Deal.BofficeKind == DL_AVRWRT )
              Deal.WrtTaxOutlaySum = Deal.BuyOutlay;
           end;
        elif(Deal.ChangedProperty == "WrtTaxPriceSum")
           if( Deal.BofficeKind == DL_AVRWRT )
               Deal.WrtTaxCostSum = Deal.WrtTaxPriceSum * Deal.Principal;
           end;
        elif(Deal.ChangedProperty == "WrtTaxCostSum")
           if( (Deal.BofficeKind == DL_AVRWRT) and (Deal.Principal > 0) )
               Deal.WrtTaxPriceSum = Deal.WrtTaxCostSum / Deal.Principal;
           end;
        end;
     end;

     if( not TransfersGenerated )
        ErrorRegenerate = SP_PTICKET_regenerate_transfers(PanelDeal);
     end;
  end;

  // валидация
  if( ( not ResponseBuilder.HasErrors() ) and ( ErrorRecalcDates != 0 ) )
     responseBuilder.AddError( ErrorRecalcDates );
  end;

  if( ( not ResponseBuilder.HasErrors() ) and ( ErrorRegenerate != 0 ) )
     responseBuilder.AddErrorEx( ErrorRegenerate, MessageSeverity.ValidationError, GetErrorMsgEx( ErrorRegenerate, GetCorrectPartyName(Deal) ) );
  end;

  if( PanelDeal.EditDealMode == SP_EditDealMode_Normal )
     dataChngHandl.StartProcessing();
  end;

  responseBuilder.SetUserObject( PanelDeal );

  return ResponseBuilder.Result();

OnError( err )
  if( ( Index( err.Message, String( 5832 ) ) > 0 )
   or ( Index( err.Message, String( 1032 ) ) > 0 ) )
     if( Index( err.Message, String( 5832 ) ) > 0 )
        // Ошибка FDecimal: переполнение
        responseBuilder.AddErrorEx( 5832, MessageSeverity.RuntimeError );
     elif( Index( err.Message, String( 1032 ) ) > 0 )
        // Арифметическая операция: переполнение
        responseBuilder.AddErrorEx( 1032, MessageSeverity.RuntimeError );
     end;
     responseBuilder.SetUserObject( PanelDeal );
     return ResponseBuilder.Result();
  else
     ScDealRunError( err, stat );
  end;
end;

private macro GetPayerID( SfContrID:integer )
  var RetVal:integer = -1;

  if( SfContrID > 0 )
     var query = RSDCommand( " SELECT t_PartyID " +
                             "   FROM dsfcontr_dbt "+
                             "  WHERE t_ID = ? " );
     query.NullConversion = true;
     query.addParam( "", RSDBP_IN, SfContrID );
     query.execute();

     var ds = TRsbDataSet(query);
     if( ds.MoveNext() )
        RetVal = SQL_ConvTypeInteger(ds.PartyID);
     end;
  end;

  return RetVal;
end;

private macro GetCurrency( FeeType:integer, ComNumber:integer )
  var RetVal:integer = -1;

  if( (FeeType > 0) and (ComNumber > 0) )
     var query = RSDCommand( " SELECT t_FIID_Comm, " +
                             "        ( SELECT fin.t_CCY " +
                             "            FROM dfininstr_dbt fin " +
                             "           WHERE fin.t_FIID = t_FIID_Comm " +
                             "        ) t_Currency " +
                             "   FROM dsfcomiss_dbt " +
                             "  WHERE t_FeeType = ? " +
                             "    AND t_Number  = ? " );
     query.NullConversion = true;
     query.addParam( "", RSDBP_IN, FeeType );
     query.addParam( "", RSDBP_IN, ComNumber );
     query.execute();

     var ds = TRsbDataSet(query);
     if( ds.MoveNext() )
        RetVal = SQL_ConvTypeInteger(ds.FIID_Comm);
     end;
  end;

  return RetVal;
end;

private macro GetReceiver( FeeType:integer, ComNumber:integer, ShortName:@string )
  var RetVal:integer = -1;

  ShortName = "";

  if( (FeeType > 0) and (ComNumber > 0) )
     var query = RSDCommand( " SELECT t_ReceiverID, " +
                             "        ( SELECT party.t_ShortName " +
                             "            FROM dparty_dbt party " +
                             "           WHERE party.t_PartyID = t_ReceiverID " +
                             "        ) t_ShortName " +
                             "   FROM dsfcomiss_dbt " +
                             "  WHERE t_FeeType = ? " +
                             "    AND t_Number  = ? " );
     query.NullConversion = true;
     query.addParam( "", RSDBP_IN, FeeType );
     query.addParam( "", RSDBP_IN, ComNumber );
     query.execute();

     var ds = TRsbDataSet(query);
     if( ds.MoveNext() )
        RetVal = SQL_ConvTypeInteger(ds.ReceiverID);
        ShortName = SQL_ConvTypeStr(ds.ShortName);
     end;
  end;

  return RetVal;
end;

macro ScInitComiss(
  Deal//:CScDeal  // Параметры сделки
 ,DealID:Integer
):CScComiss

  var stat:integer = -1;
  var ScComiss = CScComiss();
  var tick = TRecHandler("dl_tick");

  InitError();

  if( (Deal == null) and ((DealID == null) or (DealID <= 0)) )
     RunError("Не задан обязательный параметр функции: ID сделки");
  end;

  if( Deal != null)
     SetTick_ByCScDeal(tick.rec, Deal);
  else
     GetDealByID(DealID, NULL, NULL, tick);
     if( tick.rec.DealID == 0 )
        RunError("Не найдена сделка с DealID = " + string(DealID));
     end;
  end;

  ScComiss.Sum = $0;
  ScComiss.DocKind     = tick.rec.BofficeKind;
  ScComiss.DocID       = tick.rec.DealID;
  ScComiss.Date        = tick.rec.DealDate;
  ScComiss.PlanPayDate = ScComiss.FactPayDate = tick.rec.CommDate;
  ScComiss.FeeType     = -1;
  ScComiss.ComNumber   = -1;
  ScComiss.InputMedium = "П";
  ScComiss.Comission   = SP_FindContrComiss(-1);
  ScComiss.Contr       = GetTWsSfContrByID(SP_GetDealContrByPayer(tick));
  ScComiss.Payer       = GetTWsPartyExByID(GetPayerID(SP_GetContrID(ScComiss.Contr)));
  ScComiss.IsBack      = false;
  ScComiss.TypeNDS     = SP_GetTypeNDS(ScComiss.FeeType, ScComiss.ComNumber);

  return ScComiss;

OnError( err )
  ScDealRunError(err, stat);
end;


private macro SP_ExConComByContr
(
  ContrID,   // Идентификатор объекта
  OnDate,    // Дата действия комиссий
  FeeType,   // Тип взимания
  CommNumber //
)
  var RetVal:bool = false;
  var cmd = RSDCommand();
  var query = " SELECT concom.t_ID " +
              "   FROM dsfconcom_dbt concom " +
              "  WHERE concom.t_FeeType    = ? " +
              "    AND concom.t_CommNumber = ? " +
              "    AND concom.t_ObjectType = " + OBJTYPE_SFCONTR +
              "    AND concom.t_ObjectID   = ? " +
              "    AND ? BETWEEN concom.t_DateBegin AND DECODE(concom.t_DateEnd, to_date('01 01 0001','dd.mm.yyyy'), to_date('31 12 9999','dd.mm.yyyy'), concom.t_DateEnd) ";

  cmd.addParam( "", RSDBP_IN, FeeType );
  cmd.addParam( "", RSDBP_IN, CommNumber );
  cmd.addParam( "", RSDBP_IN, ContrID );
  cmd.addParam( "", RSDBP_IN, OnDate );
  cmd.CmdText = query;
  cmd.NullConversion = true;

  var rs = rsdRecordSet(cmd);

  if( rs.moveNext() )
    RetVal = true;
  end;

  return RetVal;
end;

macro ScComissExitField(
  PanelDeal//:CScPanelDeal // Параметры панели сделки (частичные)
 ,ComissList//:TArray of CScComiss // Список комиссий по сделке
 ,Comiss//:CScComiss // Комиссия
)
  var Stat:Integer = 0;
  var ResponseBuilder = SP_WebResponseBuilder();
  var Comiss2 = null;
  var CheckExist:Bool = false;
  var Deal = PanelDeal.Deal;

  if( Deal == null )
    RunError("Не задан обязательный параметр функции: параметры сделки");
  end;

  if( ( ComissList == null )
   or ( ComissList.Size == 0 ) )
    RunError("Не задан обязательный параметр функции: Список комиссий по сделке");
  end;

  if( Comiss == null )
    RunError("Не задан обязательный параметр функции: комиссия");
  end;

  // обработка схода с поля
  if( Comiss.ChangedProperty != null )
    if( Comiss.ChangedProperty == "Comission" )
      if( (Comiss.Comission != null) and (Comiss.Comission.ID > 0) )
        Comiss.FeeType   = Comiss.Comission.FeeType;
        Comiss.ComNumber = Comiss.Comission.Number;
      else
        Comiss.FeeType   = -1;
        Comiss.ComNumber = -1;
      end;
      Comiss.TypeNDS = SP_GetTypeNDS(Comiss.FeeType, Comiss.ComNumber);
      Comiss.FIID_Comm = GetTWsFinInstrByID(GetCurrency(Comiss.FeeType, Comiss.ComNumber), CODE_Ccy);
      var ShortName = "";
      Comiss.Receiver = GetTWsPartyExByID(GetReceiver(Comiss.FeeType, Comiss.ComNumber, @ShortName));
      Comiss.Receiver.shortname = ShortName;
    elif( Comiss.ChangedProperty == "Payer" )
      var tick = TRecHandler("dl_tick");
      SetTick_ByCScDeal(tick.rec, Deal);
      Comiss.Contr = GetTWsSfContrByID(SP_GetDealContrByPayer(tick, SP_GetPartyID(Comiss.Payer)));
      if( not SP_ExConComByContr(SP_GetContrID(Comiss.Contr), Comiss.Date, Comiss.FeeType, Comiss.ComNumber) )
         Comiss.FeeType   = -1;
         Comiss.ComNumber = -1;
         Comiss.TypeNDS   = SP_GetTypeNDS(Comiss.FeeType, Comiss.ComNumber);
         Comiss.Comission = SP_FindContrComiss(-1);
         Comiss.FIID_Comm = null;
         Comiss.Receiver  = null;
      end;
    elif( Comiss.ChangedProperty == "Contr" )
      Comiss.Payer = GetTWsPartyExByID(GetPayerID(SP_GetContrID(Comiss.Contr)));
      if( not SP_ExConComByContr(SP_GetContrID(Comiss.Contr), Comiss.Date, Comiss.FeeType, Comiss.ComNumber) )
         Comiss.FeeType   = -1;
         Comiss.ComNumber = -1;
         Comiss.TypeNDS   = SP_GetTypeNDS(Comiss.FeeType, Comiss.ComNumber);
         Comiss.Comission = SP_FindContrComiss(-1);
         Comiss.FIID_Comm = null;
         Comiss.Receiver  = null;
      end;
    elif( Comiss.ChangedProperty == "Sum" )
      if( PanelDeal.RecalcDealParam )
        if( Comiss.TypeNDS == 2/*SF_ADD_TAX*/ )
          Comiss.NDS = Round(money(SP_GetNDS(Comiss.Date) * Comiss.Sum / 100.0), 2);
        end;
        Comiss.SummaNotNDS = Comiss.Sum - Comiss.NDS;
      end;
      Web_SP_ActuateDealCOMIS(Deal, Comiss);
    elif( Comiss.ChangedProperty == "NDS" )
      if( PanelDeal.RecalcDealParam )
        Comiss.SummaNotNDS = Comiss.Sum - Comiss.NDS;
        if( Comiss.TypeNDS == 3/*SF_NOT_ADD_TAX*/ )
          Comiss.Sum = Round(money(100.0 * Comiss.SummaNotNDS / (100.0 - SP_GetNDS(Comiss.Date))), 2);
        end;
      end;
      Web_SP_ActuateDealCOMIS(Deal, Comiss);
    elif( Comiss.ChangedProperty == "SummaNotNDS" )
      if( PanelDeal.RecalcDealParam )
        if( Comiss.TypeNDS == 3/*SF_NOT_ADD_TAX*/ )
          Comiss.Sum = Round(money(100.0 * Comiss.SummaNotNDS / (100.0 - SP_GetNDS(Comiss.Date))), 2);
          Comiss.NDS = Round(money(Comiss.SummaNotNDS * SP_GetNDS(Comiss.Date) / (100.0 - SP_GetNDS(Comiss.Date))), 2);
        end;
      end;
      Web_SP_ActuateDealCOMIS(Deal, Comiss);
    end;
  end;

  if( PanelDeal.EditDealMode == SP_EditDealMode_Normal )
    // валидация
    if( Comiss.Sum < 0 )
      ResponseBuilder.AddError( 37031 );
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( Comiss.NDS < 0 ) )
      ResponseBuilder.AddError( 37032 );
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( Comiss.SummaNotNDS < 0 ) )
      ResponseBuilder.AddError( 37033 );
    end;

    if( Comiss.InputMedium == "П" )
      if( ( not ResponseBuilder.HasErrors() )
      and ( Comiss.Date == ZeroDate ) )
        ResponseBuilder.AddError( 37034 );
      end;

      if( ( not ResponseBuilder.HasErrors() )
      and ( Comiss.Date < Deal.DealDate ) )
        ResponseBuilder.AddError( 31822 );
      end;

      if( ( not ResponseBuilder.HasErrors() )
      and ( Comiss.Date > max( Deal.ContrDate, Deal.BaseDate ) ) )
        ResponseBuilder.AddError( 31823 );
      end;

      if( ( not ResponseBuilder.HasErrors() )
      and ( Comiss.PlanPayDate < Comiss.Date ) )
        ResponseBuilder.AddError( 31824 );
      end;

      if( ( not ResponseBuilder.HasErrors() )
      and ( Comiss.FeeType < 0 )
      and ( Comiss.ComNumber < 0 ) )
        ResponseBuilder.AddError( 37035 );
      end;

      if( ( not ResponseBuilder.HasErrors() )
      and ( Deal.IsPartyClient )
      and ( SP_GetPartyID( Comiss.Payer ) == UnknownParty ) )
        ResponseBuilder.AddError( 37036 );
      end;

      if( ( not ResponseBuilder.HasErrors() )
      and ( FindDLCOMIS_ByDoc(
              ComissList,
              Comiss.DocKind,
              Comiss.DocID,
              SP_GetContrID( Comiss.Contr ),
              Comiss.FeeType,
              Comiss.ComNumber,
              Comiss.PlanPayDate,
              Comiss.IsBack,
              @Comiss2 )
      and ( Comiss2.ID != Comiss.ID ) ) )
        // Для сделки уже задана комиссия с такими параметрами
        ResponseBuilder.AddError( 37100 );
      end;

      if( not CheckTaxDepositoryMode() )
        if( ( not ResponseBuilder.HasErrors() )
        and ( Web_SP_CheckExistGrDealByCom( Comiss, DLGRACC_STATE_FACTEXEC, @CheckExist ) == 0 )
        and ( CheckExist ) )
          ResponseBuilder.AddWarning( 31876 );
        end;

        if( ( not ResponseBuilder.HasErrors() )
        and ( ( ( SP_GetPartyID( Deal.Client ) != UnknownParty )
           or ( SP_ExistLotByDeal( Deal.DealID ) ) ) == false ) )
          // По сделке выполнена поставка. Ввод комиссии невозможен при наличии поставленного лота по "%ld" ч.
          ResponseBuilder.AddErrorEx(
            31877,
            MessageSeverity.Warning,
            GetErrorMsgEx( 31877, IIF( Comiss.IsBack, 2, 1 ) )
          );
        end;
      end;
    end;
  end;

  ResponseBuilder.SetUserObject( Comiss );

  return ResponseBuilder.Result;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

macro ScComissInsUpdtRQ(
  PanelDeal//:CScPanelDeal
 ,Comiss//:CScComiss
)//:WebServiceResponse

  var Stat:Integer = 0;
  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();

  if( PanelDeal == null )
    RunError( "Не задан обязательный параметр функции: параметры сделки" );
  end;

  if( Comiss == null )
    RunError( "Не задан обязательный параметр функции: комиссия" );
  end;

  // !!! Иначе не работает добавление элементов
  PanelDeal.RQ = TArray( PanelDeal.RQ );
  PanelDeal.RQAcc = TArray( PanelDeal.RQAcc );
  PanelDeal.Comiss = TArray( PanelDeal.Comiss );
  if( PanelDeal.Deal.IsBasket )
    PanelDeal.EnsureList = TArray(PanelDeal.EnsureList);
  end;

  Stat = InsUpdtRQ( PanelDeal, Comiss );

  if( Stat != 0 )
    ResponseBuilder.AddError( Stat );
  end;

  ResponseBuilder.SetUserObject( PanelDeal );

  return ResponseBuilder.Result;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

macro ScInitRQ(
  Deal//:CScDeal // Параметры сделки
 ,DealID:Integer // Идентификатор сделки
):CScRQ

  var Stat:Integer = -1;
  var OprkDoc = Tbfile( "oprkdoc" );
  var RQ = CScRQ();

  InitError();

  if( ( Deal == null )
  and ( ( DealID == null ) or ( DealID <= 0 ) ) )
    RunError( "Не задан обязательный параметр функции: ID сделки" );
  end;

  if( Deal == null )
    Deal = ScGetDeal( DealID );
  end;

  RQ.DocKind = Deal.BofficeKind;
  RQ.DocID = Deal.DealID;
  RQ.Kind = CreateNameAlgFromAppServ( 7511, 0 ); // ALG_DLRQ_KIND
  RQ.KindEx = CreateNameAlgFromAppServ( 7516, 0 ); // ALG_DLRQ_KIND_EX
  RQ.SubKind = CreateNameAlgFromAppServ( 7512, 0 ); // ALG_DLRQ_SUBKIND
  RQ.Type = CreateNameAlgFromAppServ( 7513, 0 ); // ALG_DLRQ_TYPE
  RQ.State = CreateNameAlgFromAppServ( 7514, 0 ); // ALG_DLRQ_STATE
  RQ.Netting = Deal.IsNetting;
  RQ.Cliring = ( ( Deal.Flag1 ) or ( Deal.IsBroker ) );
  OprkDoc.Clear();
  OprkDoc.rec.DocKind = Deal.BofficeKind;
  if( OprkDoc.GetEQ() )
    RQ.DocKindName = OprkDoc.rec.Name;
  end;
  RQ.DealPart = CreateNameAlgFromAppServ( 7518, 1 ); // ALG_DLRQ_DEALPART

  // Источники данных для виджетов "NameAlgWidget", подкачиваемые из прикладного кода
  RQ.KindExList = GetListNamealg(7516);
  RQ.TypeList = GetListNamealg(7513);
  RQ.StateList = GetListNamealg(7514);
  RQ.DealPartList = GetListNamealg(7518);

  return RQ;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

private MACRO RQUpdateNum( RQList, RQ )
  var Stat:Integer = -1;
  var RQ2 = null;

  if ( (FindDLRQbyDocKind(RQList, RQ.DocKind, RQ.DocID, SP_GetNameAlgNumberAlg( RQ.DealPart ), SP_GetFIID( RQ.FI ), SP_GetNameAlgNumberAlg( RQ.Type ), RQ.Num, @RQ2))
  and (RQ2.ID != RQ.ID) )
    var v_MaxNum:Integer = -1;
    if( GetLastNumForDLRQ( RQList, RQ.DocKind, RQ.DocID, SP_GetNameAlgNumberAlg( RQ.DealPart ), SP_GetFIID( RQ.FI ), SP_GetNameAlgNumberAlg( RQ.Type ), @v_MaxNum) )
      RQ.Num = v_MaxNum + 1;
    end;
  end;

OnError( Err )
  ScDealRunError( Err, Stat );
END;

macro ScRQExitField(
  PanelDeal//:CScPanelDeal // Параметры панели сделки (частичные)
 ,RQList//:TArray of CScRQ // Список ТО по сделке
 ,RQ//:CScRQ // Редактируемое ТО
)
  var Stat:integer = 0;
  var ResponseBuilder:SP_WebResponseBuilder = SP_WebResponseBuilder();
  var RQ2 = null;
  var Deal = PanelDeal.Deal;

  if( Deal == null )
    RunError("Не задан обязательный параметр функции: Параметры сделки");
  end;

  if( ( RQList == null )
   or ( RQList.Size == 0 ) )
    RunError("Не задан обязательный параметр функции: Список ТО по сделке");
  end;

  if( RQ == null )
    RunError("Не задан обязательный параметр функции: Редактируемое ТО");
  end;

  // обработка схода с поля
  if( RQ.ChangedProperty != null )
     if( RQ.ChangedProperty == "KindEx" )
       RQ.Kind = CreateNameAlgFromAppServ( 7511, SP_GetNameAlgNumberAlg( RQ.KindEx ) );
     elif( RQ.ChangedProperty == "Place" )
     elif( RQ.ChangedProperty == "FI" )
       if( RQ.FI != null )
         RQ.SubKind = CreateNameAlgFromAppServ( 7512, IIF(RQ.FI.Kind == 1, 0, 1) );
       else
         RQ.SubKind = null;
       end;
       RQUpdateNum( RQList, RQ );
     elif( RQ.ChangedProperty == "DealPart" )
     elif( RQ.ChangedProperty == "FIID" )
       RQUpdateNum( RQList, RQ );
     elif( RQ.ChangedProperty == "Type" )
       RQ.FI = null;
       RQUpdateNum( RQList, RQ );
     end;
  end;

  if( PanelDeal.EditDealMode == SP_EditDealMode_Normal )
    // валидация
    if( SP_GetFIID( RQ.FI ) <= ALLFININSTR )
      // Не указан финансовый инструмент
      ResponseBuilder.AddError( 7811 );
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( ВестиВнутреннийУчет() )
    and ( SP_GetPartyID( RQ.Place ) == UnknownParty ) )
      // Не задано место учета ТО
      ResponseBuilder.AddError( 37095 );
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( ( ValType( RQ.PlanDate ) == V_UNDEF ) or ( RQ.PlanDate == ZeroDate ) ) )
      // Не задана плановая дата исполнения ТО
      ResponseBuilder.AddError( 37096 );
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( SP_GetPartyID( RQ.Party ) == UnknownParty ) )
      // Не задан контрагент
      ResponseBuilder.AddError( 1598 );
    end;

    if( ( ValType( RQ.SubKind ) != V_UNDEF )
    and ( SP_GetNameAlgNumberAlg(RQ.SubKind) == DLRQ_SUBKIND_CURRENCY )
    and ( RQ.RQAcc.ID == 0 ) )
      if( ( not ResponseBuilder.HasErrors() )
      and ( ( ValType( RQ.RQAcc ) == V_UNDEF )
         or ( ValType( RQ.RQAcc.Account ) == V_UNDEF )
         or ( RQ.RQAcc.Account == "" ) ) )
        // Не задан счет расчета с контрагентом
        ResponseBuilder.AddError( 37097 );
      end;

      if( ( not ResponseBuilder.HasErrors() )
      and ( ( ValType( RQ.RQAcc ) == V_UNDEF )
         or ( ValType( RQ.RQAcc.BankName ) == V_UNDEF )
         or ( RQ.RQAcc.BankName == "" ) ) )
        // Не задан Банк/Депозитарий контрагента
        ResponseBuilder.AddError( 37098 );
      end;
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( FindDLRQbyDocKind(
            RQList,
            RQ.DocKind,
            RQ.DocID,
            SP_GetNameAlgNumberAlg( RQ.DealPart ),
            SP_GetFIID( RQ.FI ),
            SP_GetNameAlgNumberAlg( RQ.Type ),
            RQ.Num,
            @RQ2 ) )
    and ( RQ2.ID != RQ.ID ) )
      // Для сделки уже задано ТО с такими параметрами
      ResponseBuilder.AddError( 37099 );
    end;
  end;

  ResponseBuilder.SetUserObject( RQ );

  return ResponseBuilder.Result;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

macro ScInitEnsure(
  Deal//:CScDeal
 ,DealID:Integer
):CScEnsure

  var Stat:Integer = -1;
  var Ensure = CScEnsure();
  var FinInstr = TRecHandler( "fininstr" );

  InitError();

  if( ( Deal == null )
  and ( ( DealID == null )
     or ( DealID <= 0 ) ) )
    RunError( "Не задан обязательный параметр функции: Идентификатор сделки" );
  end;

  if( Deal == null )
    Ensure.DealID = Deal.DealID;
  else
    Ensure.DealID = DealID;
  end;
  Ensure.Date = {curdate};
  Ensure.Kind = TICKENS_KIND_IN;
  Ensure.CostFI = GetTWsFinInstrByID( NATCUR, CODE_Ccy );
  Ensure.IsIndexNominal = false;
  Ensure.RootAvrKinds = 0;

  return Ensure;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

macro ScEnsureExitField(
  PanelDeal//:CScPanelDeal // Параметры панели сделки (частичные)
 ,EnsureList//:TArray of CScEnsure
 ,Ensure//:CScEnsure
)//:WebServiceResponse of CScEnsure

  var Stat:Integer = 0;
  var ResponseBuilder:SP_WebResponseBuilder = SP_WebResponseBuilder();
  var FinInstr = TRecHandler( "fininstr" );
  var Deal = PanelDeal.Deal;

  InitError();

  if( Deal == null )
    RunError( "Не задан обязательный параметр функции: Параметры сделки" );
  end;

  if( ( EnsureList == null )
   or ( EnsureList.Size == 0 ) )
    RunError( "Не задан обязательный параметр функции: Список обеспечений по сделке" );
  end;

  if( Ensure == null )
    RunError( "Не задан обязательный параметр функции: Редактируемое обеспечение" );
  end;

  // обработка схода с поля
  if( Ensure.ChangedProperty == "FI" )
    if( (SP_GetFIID(Ensure.FI) > ALLFININSTR) and
        (ПолучитьФинИн(Ensure.FI.Fiid, FinInstr) == 0)
      )
      Ensure.CFI = GetTWsFinInstrByID( FinInstr.rec.FaceValueFI, CODE_Ccy );
      Ensure.CostFI = GetTWsFinInstrByID( FinInstr.rec.FaceValueFI, CODE_Ccy );
      var avr = TxGetAvoirIss(Ensure.FI.Fiid);
      Ensure.IsIndexNominal = avr.IsIndexNominal;
      Ensure.RootAvrKinds   = avr.AvoirKindObj;
    else
      Ensure.CFI = null;
      Ensure.CostFI = null;
      Ensure.IsIndexNominal = false;
      Ensure.RootAvrKinds   = 0;
    end;
  elif( Ensure.ChangedProperty == "BeginDate" )
    Ensure.Kind = TICKENS_KIND_IN;
    Ensure.NKD = $0;
    if( ( SP_GetFIID( Ensure.FI ) > ALLFININSTR )
    and ( ПолучитьФинИн( Ensure.FI.Fiid, FinInstr ) == 0 )
    and ( FI_IsCouponAvoiriss( FinInstr ) ) )
      Ensure.NKD = Round( НКД( FinInstr.rec.FIID, 1, Ensure.Date ), 2 );
    end;
  elif( Ensure.ChangedProperty == "EndDate" )
    Ensure.Kind = TICKENS_KIND_OUT;
    Ensure.NKD = $0;
  end;

  if( PanelDeal.EditDealMode == SP_EditDealMode_Normal )
    // валидация
    if( SP_GetFIID( Ensure.FI ) <= ALLFININSTR )
      // Не указана ценная бумага
      ResponseBuilder.AddError( 7810 );
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( Ensure.Date == ZeroDate ) )
      if( Ensure.Kind == 0 )
        // Дата включения должна быть задана
        ResponseBuilder.AddError( 37105 );
      else
        // Дата исключения должна быть задана
        ResponseBuilder.AddError( 37106 );
      end;
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( Ensure.Principal <= $0 ) )
      // Количество должно быть больше нуля
      ResponseBuilder.AddError( 37016 );
    end;

    if( ( not ResponseBuilder.HasErrors() )
    and ( Ensure.TotalCost <= $0 ) )
      // Стоимость должна быть больше нуля
      ResponseBuilder.AddError( 37018 );
    end;
  end;

  ResponseBuilder.SetUserObject( Ensure );

  return ResponseBuilder.Result;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

macro ScUpdatePanelDealAfterEnsureChanges(
  PanelDeal//:CScPanelDeal
)//:WebServiceResponse

  var Stat:Integer = 0;
  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();

  if( PanelDeal == null )
    RunError( "Не задан обязательный параметр функции: параметры сделки" );
  end;

  // !!! Иначе не работает добавление элементов
  PanelDeal.RQ = TArray( PanelDeal.RQ );
  PanelDeal.RQAcc = TArray( PanelDeal.RQAcc );
  PanelDeal.Comiss = TArray( PanelDeal.Comiss );
  PanelDeal.EnsureList = TArray( PanelDeal.EnsureList );

  SP_UpdLegByDLTICKENS( PanelDeal );

  Stat = SP_PTICKET_regenerate_transfers( PanelDeal );

  if( Stat != 0 )
    ResponseBuilder.AddError( Stat );
  end;

  ResponseBuilder.SetUserObject( PanelDeal );

  return ResponseBuilder.Result;

OnError( Err )
  ScDealRunError( Err, Stat );
end;

macro Regenerate_transfers ( PanelDeal ) :WebServiceResponse

  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();

  var stat = SP_PTICKET_regenerate_transfers( PanelDeal );

  if( stat != 0 )
    ResponseBuilder.AddError( stat );
  end;

  responseBuilder.SetUserObject( PanelDeal );

  return ResponseBuilder.Result();

OnError( Err )
  ScDealRunError( Err, Stat );
end;

macro ScGetDealTypeInfo(DealID, BofficeKind, DealType, Oper)
  var Deal = CScDeal();

  if((DealID != null) and (DealID > 0) )
    var query = " SELECT t_BofficeKind, t_DealType, t_Oper " +
                  " FROM DDL_TICK_DBT " +
                 " WHERE t_DealID = ? ";

    var cmd = RSDCommand(query);
    cmd.addParam( "", RSDBP_IN, DealID );

    var ds = TRsbDataSet(cmd);
    if( ds.moveNext() )
      SetCScDeal_ByBOKO( Int(ds.BofficeKind), Int(ds.DealType), Int(ds.Oper), Deal );
    end;

  elif((BofficeKind != null) and (BofficeKind > 0)
   and (DealType != null) and (DealType > 0)
   and (Oper != null) and (Oper > 0))
    SetCScDeal_ByBOKO( BofficeKind, DealType, Oper, Deal );
  else
    RunError( "Не заданы параметры для получения сведений о сделке" );
  end;

  return Deal;
end;


// MVA: копия одноименные класс и ф-ция из ws_oprkopr, добавлена проверка t_kind_operation > 0
class TWsOprkoper()
	var KindOperation;
	var Name;
end;

macro GetListOprkoper(KindOperations, DocKind, InUseOnly) // Integer-Массив номеров видов операций                   
	var cmd : RsdCommand, outArray = TArray(), i = 0, arSize, tempObj = TWsOprkoper(), dataSet;
    
	cmd.cmdText = "select t_kind_operation, t_name from doprkoper_dbt WHERE ";

	if((KindOperations != NULL) OR (DocKind > 0))
	  if(DocKind > 0)
	  	cmd.cmdText = cmd.cmdText + "doprkoper_dbt.t_dockind = ?"; 
			cmd.AddParam("", RSDBP_IN,  DocKind);                           
		elif(KindOperations != NULL)
			arSize = KindOperations.size();

			while(i < (arSize - 1))
				cmd.cmdText = cmd.cmdText + "t_kind_operation = ?" + " OR ";
				cmd.AddParam("", RSDBP_IN,  KindOperations[i]);
		
				i = i + 1;
			end;
			
			cmd.cmdText = cmd.cmdText + "t_kind_operation = ?";
			cmd.AddParam("", RSDBP_IN, KindOperations[arSize - 1]);
		end;

    if ((InUseOnly != NULL) AND (InUseOnly == true))
      cmd.cmdText = cmd.cmdText + " AND t_notinuse <> 'X'";
    end;

    cmd.cmdText = cmd.cmdText + " AND t_kind_operation > 0 "; // 

		cmd.execute();

		dataSet = RsdRecordset(cmd);


		i = 0;

		while(dataSet.moveNext())
			tempObj = TWsOprkoper();
			tempObj.KindOperation 	= dataSet.value(0);
			tempObj.Name 						= dataSet.value(1);

			outArray[outArray.size] = tempObj;

			i = i + 1;
		end;
		
	else              
		var err = "Отсутствует обязательные входные параметры";
                                                                 
		RunError(err);	// ошибка
	end;
                                        
	return outArray;	
end;   
