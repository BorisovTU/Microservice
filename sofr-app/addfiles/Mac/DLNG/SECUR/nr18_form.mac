/*
$Name:             nr18.mac
$Module:           АРНУ
$Author:	   Сагиян С.Г.
$Description:      Отчет "Информация о выплаченных иностранным организациям доходах и удержанных налогах" (НУ) - форма ввода данных
*/

import "DlRepForm_h.mac", "globals.mac", "ws_txreportform.mac";

  CLASS TRow()
          VAR        Q0,      	
          /*2 */     Q5,      	
          /*3 */     Q10,      	
          /*4 */     Q20,         	
          /*5 */     Q30,      	
          /*6 */     Q40,       	
          /*7 */     Q50,     	
          /*8 */     Q60,        	
          /*9 */     Q70,      	
          /*10*/     Q80,       	
          /*11*/     D10,      	
          /*12*/     D20,  	
          /*13*/     D30,     	
          /*14*/     D40,  	
          /*15*/     D50,      	
          /*16*/     D60,        	
          /*17*/     D70,         	
          /*18*/     D80,      	
          /*19*/     D90,     	
          /*20*/     D100,     	
          /*21*/     D110,      	
          /*22*/     D120,     	
          /*23*/     D130,       	
          /*24*/     D140,    	
          /*25*/     D150,       	
          /*26*/     D160, 	
          /*27*/     D170,    	
          /*28*/     D180,  	
          /*29*/     D190,
	  SOURCE;
  END;


  CLASS TRow2()
  	 VAR
          /*1 */     N2_D0,      	
          /*2 */     N2_D05,      	
          /*11*/     N2_D010,      	
          /*12*/     N2_D020,  	
          /*13*/     N2_D030,     	
          /*14*/     N2_D040,  	
          /*15*/     N2_D050,      	
          /*16*/     N2_D060,        	
          /*17*/     N2_D070,         	
          /*25*/     N2_D150,       	
          /*26*/     N2_D160, 	
          /*27*/     N2_D170,    	
          /*28*/     N2_D180,  	
          /*29*/     N2_D190,
          /*29*/     N2_D200,
          /*29*/     N2_D210,          
	  /*29*/     N2_D220,
	  /*29*/     N2_D230,
	  /*29*/     N2_D240,
	  /*29*/     N2_D250,
	  /*29*/     N2_D260,
	  /*29*/     N2_D270,
	  /*29*/     N2_D271,
	  /*29*/     N2_D272,
	  /*29*/     N2_D273,
	  /*29*/     N2_D274,
	  /*29*/     N2_D275,
	  /*29*/     N2_D276,
	  /*29*/     N2_D277,
	  /*29*/     N2_D278,
	  /*29*/     N2_D279,
	  /*29*/     N2_D280,
	  /*29*/     N2_D290,
	  /*29*/     N2_D300;
   END;




/*Подвиды регистров*/
CONST NR18_ALL    = 0, 
      NR18_031    = 1, //  разделы 3.1 - 3.2
      NR18_033U   = 2, //  раздел 3.3 Юрлица
      NR18_033F   = 3; //  раздел 3.3 Физлица

VAR PART_NAME = TArray();
PART_NAME[NR18_ALL]  = "Все";
PART_NAME[NR18_031]  = "Разделы 3.1 - 3.2. Сведения об ин. организации - получателе дохода";
PART_NAME[NR18_033U] = "Раздел 3.3. Физические лица";
PART_NAME[NR18_033F] = "Раздел 3.3. Юридические лица";


/*Номера полей в форме отчета*/
CONST PNFLD_NR18_PERIOD     = 0,
      PNFLD_NR18_YEAR       = 1,
      PNFLD_NR18_BEGINDATE  = 2,
      PNFLD_NR18_ENDDATE    = 3,
      PNFLD_NR18_SUBKIND    = 4,
      PNFLD_NR18_LOAD = 5,
      PNFLD_NR18_SOUR1 = 6,
      PNFLD_NR18_SOUR2 = 7,
      PNFLD_NR18_SOUR3 = 8;

CONST H_PNFLD_SUBKIND  = 100, 
      H_PNFLD_AVRGROUP = 101;
 
/*Тип отчета - 0211*/
PRIVATE MACRO FldProc_Subkind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = NR18_ALL;
     end;
     FldShowValue = PART_NAME[FldRealValue];

  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     DL_ListString( null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                    PART_NAME[NR18_ALL],  NR18_ALL,
                    PART_NAME[NR18_031],  NR18_031,
                    PART_NAME[NR18_033U], NR18_033U,
                    PART_NAME[NR18_033F], NR18_033F
                  );
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) ) 
     FldRealValue = NR18_ALL;
     FldShowValue = PART_NAME[FldRealValue];
  end;
  return CM_DEFAULT;
END;


CLASS (DL_CPanel) DL_NR18_Panel()

  PRIVATE MACRO Init()
     VAR CurMonth, PrevQuartal, Year;
     DateSplit( {curdate}, null, CurMonth, Year );

     PrevQuartal = (CurMonth - 1)/3; /*текущий квартал-1*/
     if( PrevQuartal == 0 )
        PrevQuartal = 4;
        Year        = Year-1;
     end;


     AddFieldProc( 0, PNFLD_NR18_PERIOD,      DL_PNFLD_PERIOD,      @DL_FldProc_Period, PrevQuartal + 12, 17, 5 ); /*(+12 - для NameAlg.dbt)*/
     AddFieldProc( 0, PNFLD_NR18_YEAR,        DL_PNFLD_YEAR,        @DL_FldProc_Year, Year );
     AddFieldProc( 0, PNFLD_NR18_BEGINDATE,   DL_PNFLD_BEGINDATE,   @DL_FldProc_BeginDate );
     AddFieldProc( 0, PNFLD_NR18_ENDDATE,     DL_PNFLD_ENDDATE,     @DL_FldProc_EndDate );
     AddFieldProc( 0, PNFLD_NR18_SUBKIND,     H_PNFLD_SUBKIND,      @FldProc_Subkind, NR18_ALL, 10, 10 );
     AddFieldProc( 0, PNFLD_NR18_LOAD, 	      DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox, "X" );
     AddFieldProc( 0, PNFLD_NR18_SOUR1,       DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox, "X" );
     AddFieldProc( 0, PNFLD_NR18_SOUR2,       DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox, "X" );
     AddFieldProc( 0, PNFLD_NR18_SOUR3,       DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox, "X" );
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel( "ndfl_sgs.lbr", "NR18" ); 
END;

CLASS ( TxReportForm ) WS_TX_NR18_Panel(
  FormData/* : CTxReportForm*/
)
  private var ReDefineFieldNum = TArray;

  // Переопределяем номера полей
  ReDefineFieldNum[PNFLD_NR18_PERIOD]      = TXREPORTFORM_WIDGET_PERIOD;
  ReDefineFieldNum[PNFLD_NR18_YEAR]        = TXREPORTFORM_FLD_YEAR;
  ReDefineFieldNum[PNFLD_NR18_BEGINDATE]   = TXREPORTFORM_FLD_DATEBEGIN;
  ReDefineFieldNum[PNFLD_NR18_ENDDATE]     = TXREPORTFORM_FLD_DATEEND;
  ReDefineFieldNum[PNFLD_NR18_SUBKIND]     = TXREPORTFORM_WIDGET_KIND;
  ReDefineFieldNum[PNFLD_NR18_LOAD]        = TXREPORTFORM_FLD_EXCLUDE;

  MACRO GetFieldValue(
    FieldNumber : Integer,
    ShowValue   : @Variant,
    RealValue   : @Variant
  )
    return GetFieldValueEx( ReDefineFieldNum[FieldNumber], @ShowValue, @RealValue );
  END;

  initTxReportForm( FormData );
END;