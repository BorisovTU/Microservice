/*
$Name:        sp_ownacc.mac
$Module:      Ценные бумаги - ОЭБ
$Description: Общие функции для проводок в операциях ОЭБ
*/
IMPORT "scincfun.mac", "spservsql.mac", "spretownfun.mac";

MACRO БУ_ПроводкиОплатыРазмещенияОЭБ( FD, dat, GrDealID:integer )

  if(IsOUTEXCHANGE(FD.Group))
    if( БУ_ОбработатьТОПоОплате( FD, dat ) != 0 )
       return 1;
    end;
  end;

  return 0; 
END;


MACRO БУ_ПроводкиУчетаПоставкиРазмещенияОЭБ( FD, dat, GrDealID:integer )
  var Sum = $0, SumNat = $0;
  var Ground = "", CatDebet = "", SumDebet = $0, FIIDDebet = -1, CatCredit = "", SumCredit = $0, FIIDCredit = -1;
  var Scc = $0, P = $0, NK = $0;
  var query, cmd, DataSet;
  var CatDeb = "", DebFIID;
  
  if(IsEXCHANGE(FD.Group))
    CatDeb  = "+Биржа";
    DebFIID = FD.GetPayFIID();
  else
    CatDeb  = "-Форвард, расчеты";
    DebFIID = FD.GetPayFIID();
  end;

    if(FD.dl_leg.rec.NKD > 0)
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         CatDeb, "Обяз%, ОЭБ",           /* КатегДеб , КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         FD.NKD(),                       /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         "Отражение НКД полученного при размещении, " + GetFinName(FD.fininstr.rec),
                                         null,
                                         null,
                                         null,
                                         DebFIID, FD.FaceFIID() 
                                       )
        )
      return 1;
    end;
  end;
  
  if( FD.dl_leg.rec.CFI != FD.FaceFIID() )
     if( not SmartConvertSum( P, FD.dl_leg.rec.Cost, dat, FD.dl_leg.rec.CFI, FD.FaceFIID(), true))
        return 1;
     end;
  else
     P = FD.dl_leg.rec.Cost;
  end;

  NK = FD.FaceValue() * FD.dl_leg.rec.Principal;

  if(P <= NK)
    Sum = P; 
    Ground = "Отражение суммы привлеченных средств по размещенным ц/б";
  else
    Sum = NK; 
    Ground = "Отражение суммы привлеченных средств по размещенным ц/б, " + GetFinName(FD.fininstr.rec);
  end;

  if(Sum > 0)
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         CatDeb, КодКатегорииРазмещОЭБ(FD, dat), /* КатегДеб , КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         Sum,                            /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         Ground,
                                         null,
                                         null,
                                         null,
                                         DebFIID, FD.FaceFIID() 
                                       )
        )
      return 1;
    end;
  end;

  if(P > NK)
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         CatDeb, КодКатегорииПремияОЭБ(FD, dat),          /* КатегДеб , КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         (P - NK),                       /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         "Отражение размещения по цене выше номинальной стоимости, " + GetFinName(FD.fininstr.rec),
                                         null,
                                         null,
                                         FIROLE_BA,
                                         DebFIID, FD.FaceFIID() 
                                       )
        )
      return 1;
    end;
  end;

  if(FD.tick.rec.Placement == UNSET_CHAR) //Просто продажа, не размещение
    
    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         "ВнебалСчетОЭБ"/*"ВнебалСчетКорресп"*/, "Выкуп, ОЭБ", /* КатегДеб , КатегКредит*/
                                         dat,                               /* Дата */
                                         3,                                 /* Глава */
                                         FD.FaceFIID(),                     /* Валюта */
                                         NK,                                /* Сумма  */
                                         INPCARRY,                          /* Result_Carry */
                                         " 1",                              /* Kind_Oper */
                                         "",                                /* Numb_Document */
                                         "Списание номинальной стоимости с внебалансового учета, " + GetFinName(FD.fininstr.rec),
                                         null,
                                         FIROLE_CORACC_ACTIVE,
                                         null,
                                         NATCUR, FD.FaceFIID() 
                                       )
      )
      return 1;
    end;
  end;

  //Корректировка стоимости ОЭБ
  Sum = FD.pmwrtsum.rec.CorrIntToEIR;
  /*
  if(Sum != $0)

    if(FD.FaceFIID() != NATCUR)
      if( not SmartConvertSum( SumNat, abs(Sum), dat, FD.FaceFIID(), NATCUR, true))
        return 1;
      end;
    else
      SumNat = abs(Sum);
    end;

    if(Sum < 0)
      CatDebet   = "+Корр, ОЭБ";
      SumDebet   = SumNat;
      FIIDDebet  = NATCUR;

      CatCredit  = "+Эмиссия, ОЭБ";
      SumCredit  = SumNat;
      FIIDCredit = NATCUR;

      Ground     = "Отражение отрицательной разницы, " + GetFinName(FD.fininstr.rec); 
    else
      CatDebet   = "-Эмиссия, ОЭБ";
      SumDebet   = SumNat;
      FIIDDebet  = NATCUR;

      CatCredit = "-Корр, ОЭБ";
      SumCredit  = SumNat;          
      FIIDCredit = NATCUR;

      Ground     = "Отражение положительной разницы, " + GetFinName(FD.fininstr.rec);
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
          CatDebet, CatCredit,   /* AccDeb , AccCred*/
          dat,                   /* Дата */
          1,                     /* Глава */
          FIIDDebet,             /* Валюта */
          SumDebet,              /* Сумма */
          INPCARRY,              /* Result_Carry */
          " 1",                  /* Kind_Oper */
          FD.tick.rec.DealCode,  /* Numb_Document */
          Ground                /* Ground */
         ))
       return 1;
    end;

  end;
 */ 
/*DAN Проверка наличия и дооткрытие счетов по КУ*/
record ExtAccount(account);
var ExtAcc = "Обяз%, ОЭБ";
var FIRolePayer;
   if( (not FD.OpenAccount( ExtAcc, null, true, FIRolePayer, ExtAccount, dat, FD.FaceFIID(), null, null, null)) )
         if( not FD.ReOpenAccount( ExtAcc, null, false, FIRolePayer, ExtAccount, dat, FD.FaceFIID(), null, null) )
              msgbox("Ошибка открытия счета по категории: " + ExtAcc);
         end;
   end;
    ExtAcc = "ЗпоСд, ОЭБ"; 
   if( (not FD.OpenAccount( ExtAcc, null, true, FIRolePayer, ExtAccount, dat,             0, null, null, null)) )
         if( not FD.ReOpenAccount( ExtAcc, null, false, FIRolePayer, ExtAccount, dat,              0, null, null) )
              msgbox("Ошибка открытия счета по категории: " + ExtAcc);
         end;
   end;
/****************************************/

  return 0; 
END;

MACRO БУ_ПроводкиОплатыВыкупаОЭБ( FD, dat, GrDealID:integer )

  if(IsOUTEXCHANGE(FD.Group))
    if( БУ_ОбработатьТОПоОплате( FD, dat ) != 0 )
       return 1;
    end;
  end;

  return 0; 
END;

PRIVATE MACRO СписатьКорректировкиХедж(FD, dat, SumCorr, IsAmortSum:bool)
  var CorrAcc = TRecHandler("account.dbt");
  var RestSumCorr = $0;
  var SumRest = $0;
  var q, c, ds;
  var cntHdi = 0;
  
  if(SumCorr != 0)
    SumRest = $0;

    q =   " select NVL(SUM(rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null)), 0) as SumRest, count(distinct hdr.t_ID) as CntHdi "
        + "   from dmccateg_dbt cat, dmcaccdoc_dbt accdoc, ddlhdgrelation_dbt hdr "
        + "  where cat.t_LevelType = 1 "
        + "    and cat.t_Code IN ('-Корр, ОЭБ_Хедж','+Корр, ОЭБ_Хедж') "
        + "    and accdoc.t_CatID = cat.t_ID "
        + "    and accdoc.t_FIID = ? "
        + "    and accdoc.t_DocKind = " + SP_AVRHDGRELATION
        + "    and rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null) <> 0"
        + "    and hdr.t_ID = accdoc.t_DocID "
        + "    and hdr.t_EndDate <= ? "
        + "    and "+IIF(IsAmortSum==false, "NOT", "")+" Exists(select 1 "
        + "                     from doproper_dbt opr, doprstep_dbt st "
        + "                    where opr.t_DocKind = " + DLDOC_ISSUE
        + "                      and opr.t_DocumentID = LPAD(to_char(accdoc.t_FIID), 34, '0') "
        + "                      and st.t_ID_Operation = opr.t_ID_Operation "
        + "                      and st.t_ServDocKind = " + SP_AMORTHEDGCORR
        + "                  )";

    c = DL_RSDCommand(q);

    c.AddParam(dat);
    c.AddParam(FD.fininstr.rec.FIID);
    c.AddParam(dat);
    c.AddParam(dat);
    
    ds = c.Execute();
    if(ds.moveNext())
      SumRest = money(ds.SumRest);
      cntHdi  = ds.CntHdi;
    end;

    if(abs(SumRest) < abs(SumCorr))
      msgbox("Сумма остатков на счетах корректировок хеджирования менЬше суммы списания");
      return 1;
    end;

    RestSumCorr = abs(SumCorr);

    q =   " select hdr.t_ID, rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null) RestCorr "
        + "   from dmccateg_dbt cat, dmcaccdoc_dbt accdoc, ddlhdgrelation_dbt hdr "
        + "  where cat.t_LevelType = 1 "
        + "    and cat.t_Code IN ('-Корр, ОЭБ_Хедж','+Корр, ОЭБ_Хедж') "
        + "    and accdoc.t_CatID = cat.t_ID "
        + "    and accdoc.t_FIID = ? "
        + "    and accdoc.t_DocKind = " + SP_AVRHDGRELATION
        + "    and rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null) <> 0"
        + "    and hdr.t_ID = accdoc.t_DocID "
        + "    and hdr.t_EndDate <= ? "
        + "    and "+IIF(IsAmortSum==false, "NOT", "")+" Exists(select 1 "
        + "                     from doproper_dbt opr, doprstep_dbt st "
        + "                    where opr.t_DocKind = " + DLDOC_ISSUE
        + "                      and opr.t_DocumentID = LPAD(to_char(accdoc.t_FIID), 34, '0') "
        + "                      and st.t_ID_Operation = opr.t_ID_Operation "
        + "                      and st.t_ServDocKind = " + SP_AMORTHEDGCORR
        + "                  )";

    c = DL_RSDCommand(q);

    c.AddParam(dat);
    c.AddParam(FD.fininstr.rec.FIID);
    c.AddParam(dat);
    c.AddParam(dat);
    
    ds = c.Execute();
    
    var FDhdi = NULL;
    var CarrySum = $0;
    var i = 1;
    while(ds.moveNext())
      FDhdi = SP_AvrHdRelationFD(ds.ID);

      if(i == CntHdi)
        CarrySum = abs(RestSumCorr);
      else
        CarrySum = money(round((abs(SumCorr) * abs(ds.RestCorr)/abs(SumRest)), 2)); 
      end;
      
      if( (FDhdi.IsExistAccount("-Корр, ОЭБ_Хедж", null, true, NULL, CorrAcc, MC_PAIRACCMODE_MANUAL, dat)) and
        (abs(GetRestAccount(CorrAcc.rec, dat)) > 0) 
      )
        if(not БУ_ПроводкаПоКатегориямУчета( FDhdi, 
                                            CorrAcc, "Доходы_хедж, ПФИ",     /* КатегДеб, КатегКредит*/
                                            dat,                             /* Дата */
                                            1,                               /* Глава */
                                            NATCUR,                          /* Валюта */
                                            CarrySum,                        /* Сумма  */
                                            INPCARRY,                        /* Result_Carry */
                                            " 1",                            /* Kind_Oper */
                                            FD.tick.rec.DealCode,            /* Numb_Document */
                                            "Списание корректировок хеджирования по выкупленным ОЭБ",
                                            null,
                                            null,
                                            null,
                                            NATCUR, NATCUR  
                                          )
           )
          return 1;
        end;
      elif( (FDhdi.IsExistAccount("+Корр, ОЭБ_Хедж", null, true, NULL, CorrAcc, MC_PAIRACCMODE_MANUAL, dat)) and
            (abs(GetRestAccount(CorrAcc.rec, dat)) > 0) 
          )
        if(not БУ_ПроводкаПоКатегориямУчета( FDhdi, 
                                            "Расходы_хедж, ПФИ", CorrAcc,    /* КатегДеб, КатегКредит*/
                                            dat,                             /* Дата */
                                            1,                               /* Глава */
                                            NATCUR,                          /* Валюта */
                                            CarrySum,                        /* Сумма  */
                                            INPCARRY,                        /* Result_Carry */
                                            " 1",                            /* Kind_Oper */
                                            FD.tick.rec.DealCode,            /* Numb_Document */
                                            "Списание корректировок хеджирования по выкупленным ОЭБ",
                                            null,
                                            null,
                                            null,
                                            NATCUR, NATCUR  
                                          )
              )
          return 1;
        end;
      end;

      i = i + 1;

      RestSumCorr = RestSumCorr - CarrySum;
    end;
  end;

  return 0;
END;

MACRO БУ_ПроводкиУчетаПоставкиВыкупаОЭБ( FD, dat, GrDealID:integer )
  var Sum = $0, SumCorr = 0, TotalSum = $0, NK = $0;
  var CorrAcc = TRecHandler("account.dbt");
  var ProfPFIAcc = TRecHandler("account.dbt");
  var findAcc = TRecHandler("account.dbt");
  var Ground = "";
  var cmd, DataSet, query;
  record СчетРазмещ( account );
  var S = $0;
  var SumDiscountWrt = $0;
  var CatCred = "", CredFIID;
  var SumOutlayAdd = $0, SumVatOutlayAdd = $0;
  query =   " select NVL(SUM(t_DiscountIncomeBuy+t_DiscountIncomeAdd), 0) as SumDiscountWrt "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);
  
  DataSet = cmd.Execute();
  
  if(DataSet.moveNext())
    SumDiscountWrt = DataSet.SumDiscountWrt;
  end;
  
  if(FD.FaceFIID() == FD.dl_leg.rec.CFI)
    S = FD.dl_leg.rec.TotalCost-FD.dl_leg.rec.NKD;
  else
    if( not SmartConvertSum( S, FD.dl_leg.rec.TotalCost-FD.dl_leg.rec.NKD, dat, FD.dl_leg.rec.CFI, FD.FaceFIID(), true))
      return 1;
    end;
  end;
 
  NK = FD.FaceValue() * FD.dl_leg.rec.Principal;

  if(IsEXCHANGE(FD.Group))
    CatCred  = "+Биржа";
    CredFIID = FD.GetPayFIID();
  else
    CatCred  = "+Форвард, расчеты";
    CredFIID = FD.GetPayFIID();
  end;

  if(S <= NK) //Выкуп ц/б по номинальной стоимости или ниже

    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                         КодКатегорииРазмещОЭБ(FD, dat), CatCred,         /* КатегДеб, КатегКредит*/
                                         dat,                            /* Дата */
                                         1,                              /* Глава */
                                         FD.FaceFIID(),                  /* Валюта */
                                         S - SumDiscountWrt,             /* Сумма  */
                                         INPCARRY,                       /* Result_Carry */
                                         " 1",                           /* Kind_Oper */
                                         "",                             /* Numb_Document */
                                         "Списание стоимости выкупленных ц/б с баланса,  " + GetFinName(FD.fininstr.rec) ,
                                         null,
                                         null,
                                         null,
                                         FD.FaceFIID(), CredFIID 
                                       )
        )
      return 1;
    end;


    Sum = NK - S; 
    if(Sum != $0)
      FD.SetParmForCateg24828("+Эмиссия, ОЭБ", "02");
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           КодКатегорииРазмещОЭБ(FD, dat), "+Эмиссия, ОЭБ", /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           Sum,                            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Отражение дохода, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           null,
                                           FD.FaceFIID(), NATCUR 
                                         )
          )
        return 1;
      end;
      FD.ResetParmForCateg24828();
    end;

  else
////////////////////////////////////////////////////////////////////////////////
///*
    if (not FD.IsExistAccount(КодКатегорииРазмещОЭБ(FD, dat), null, true, null, СчетРазмещ, null, dat ))
       msgbox("Не найден счет по категории \""+КодКатегорииРазмещОЭБ(FD, dat)+"\"");
       return 1; /*Счета нет, списывать нечего*/
    end;

    var RSD1 = DL_RSDCommand();

    var query1 = "select RSB_PMWRTOFF.WRTGetAmountOwn( ?, ?, ?, ?, ? ) Amount from dual ";
    RSD1.AddParam(-1);
    RSD1.AddParam(FD.avoiriss.rec.fiid);
    RSD1.AddParam(dat);
    RSD1.AddParam(1);
    RSD1.AddParam(0); //DAN   old - RSD1.AddParam(1);

    var DataSet1 = RSD1.Execute(query1);
    if(DataSet1.moveNext())
//    Sum = (ABS(GetRestAccount(СчетРазмещ, dat)) / DataSet1.Amount) * FD.dl_leg.rec.Principal;
    else 
//    return 1;
    end;



    if(not БУ_ПроводкаПоКатегориямУчета(FD, 
                                        КодКатегорииРазмещОЭБ(FD, dat), CatCred,        /* КатегДеб, КатегКредит*/
                                        dat,                            /* Дата */
                                        1,                              /* Глава */
                                        FD.FaceFIID(),                  /* Валюта */
                                        NK - SumDiscountWrt/*DAN Sum*/, /* Сумма  */
                                        INPCARRY,                       /* Result_Carry */
                                        " 1",                           /* Kind_Oper */
                                        "",                             /* Numb_Document */
                                        "Списание стоимости выкупленных ц/б с баланса, " + GetFinName(FD.fininstr.rec) + " по сделке " + FD.tick.rec.dealcode + " от " + string(FD.tick.rec.dealdate) ,
                                        null,
                                        null,
                                        null,
                                        FD.FaceFIID(), CredFIID 
                                       )
        )
      return 1;
    end;
//*/
////////////////////////////////////////////////////////////////////////////////
    
    Sum = S - NK;
    var SumFV = Sum;
    if(FD.FaceFIID() != NATCUR)
      if( not SmartConvertSum( Sum, Sum, dat, FD.FaceFIID(), NATCUR, true))
        return 1;
      end;
    end;

    if(Sum != $0)
      FD.SetParmForCateg24828("-Эмиссия, ОЭБ", "01");
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Эмиссия, ОЭБ", CatCred,       /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           Sum,                            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Расход на сумму превышения над номинальной стоимостью  при досрочном выкупе собственных облигаций ЦБ " + GetFinName(FD.fininstr.rec) + ", " + FD.tick.rec.DealCode + ", " + dat + ", " + FD.dl_leg.rec.principal + " шт",
                                           null,
                                           null,
                                           null,
                                           NATCUR, CredFIID, FD.FaceFIID(), SumFV 
                                         )
          )
        return 1;
      end;
      FD.ResetParmForCateg24828();
    end;
  end;

  query =   " select t_Sum, t_NDS "
          + "   from ddlsum_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_Kind = " + DLSUM_KIND_OWNAVR_DEALAMORTCOM
          + "    and t_Date = ? ";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    SumOutlayAdd    = DataSet.Sum;
    SumVatOutlayAdd = DataSet.NDS;
  end;

  query =   " select NVL(SUM(t_InterestIncomeAdd), 0) as SumInterestAdd, "
          + "        NVL(SUM(t_DiscountIncomeAdd), 0) as SumDiscountAdd, "
          + "        NVL(SUM(t_DiscountIncomeBuy), 0) as SumDiscountBuy, "
          + "        NVL(SUM(t_BonusAdd), 0) as SumBonusAdd, "
          + "        NVL(SUM(t_OutlayBuy-t_WrtOutlayBuy), 0) as SumOutlayAdd, "
          + "        NVL(SUM(t_VatOutlayChange-t_WrtVatOutlayBuy), 0) as SumVatOutlayAdd, "
          + "        NVL(SUM(t_AccountedDefDiffAdd), 0) as SumDefDiffAdd, "
          + "        NVL(SUM(t_CostBuy), 0) as SumCostBuy, "
          + "        NVL(SUM(t_NKDBuyAmount+t_InterestIncomeBuy+t_InterestIncomeAdd), 0) as SumWrtInterest "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);
  
  DataSet = cmd.Execute();
  
  if(DataSet.moveNext())

    //Доначисление ПКД
    if(DataSet.SumInterestAdd != 0)
      var CatCode = "%Расход, ОЭБ";
      
      if((FD.avoiriss.rec.Subordinated == SET_CHAR) and (GetSubordCvalTypeAttrID(FD.fininstr.rec.FIID) == OBJATTR_SUBORDCVALTYPE_DI))
        CatCode = "-Изм.кап., суборд.ОЭБ";
      end;
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           CatCode, "Обяз%, ОЭБ",   /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumInterestAdd,         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Доначисление ПКД облигация  ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, FD.FaceFIID() 
                                         )
          )
        return 1;
      end;
    end;

    //Списание ПКД
    if(DataSet.SumWrtInterest != 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "Обяз%, ОЭБ", CatCred,          /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumWrtInterest,         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание ПКД",
                                           null,
                                           null,
                                           null,
                                           FD.FaceFIID(), CredFIID
                                         )
          )
        return 1;
      end;
    end;

    //Доначисление суммы дисконта по выкупаемым ц/б
    if(DataSet.SumDiscountAdd != 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "%Расход, ОЭБ", КодКатегорииДисконтОЭБ(FD, dat), /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumDiscountAdd,         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Доначисление суммы дисконта по выкупаемым ц/б, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           FIROLE_BA,
                                           NATCUR, FD.FaceFIID() 
                                         )
          )
        return 1;
      end;
    end;

    if(DataSet.SumDiscountBuy+DataSet.SumDiscountAdd != 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           КодКатегорииДисконтОЭБ(FD, dat), CatCred,        /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           (DataSet.SumDiscountBuy+DataSet.SumDiscountAdd),         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание дисконта выкупленных ц/б с баланса",
                                           null,
                                           FIROLE_BA,
                                           null,
                                           FD.FaceFIID(), CredFIID 
                                         )
          )
        return 1;
      end;
    end;

    //Списание премии по выкупаемым ОЭБ на доходы
    if(DataSet.SumBonusAdd != 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           КодКатегорииПремияОЭБ(FD, dat), "+Эмиссия, ОЭБ",  /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           DataSet.SumBonusAdd,            /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание премии по выкупаемым ОЭБ на доходы, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           FIROLE_BA,
                                           null,
                                           FD.FaceFIID(), NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание затрат по выкупаемым ОЭБ на расходы
    if(DataSet.SumOutlayAdd != 0)
      
      Sum = DataSet.SumOutlayAdd;
      if(FD.FaceFIID() != NATCUR)
        if( not SmartConvertSum( Sum, Sum, dat, FD.FaceFIID(), NATCUR, true))
          return 1;
        end;
      end;
      
      SumOutlayAdd = SumOutlayAdd + Sum;
    end;
      
    if(SumOutlayAdd > 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Маржа, проч.", "ЗпоСд, ОЭБ",  /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           SumOutlayAdd,                   /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание затрат по выкупаемым ОЭБ на расходы, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание НДС затрат по выкупаемым ОЭБ на расходы 
    SumVatOutlayAdd = SumVatOutlayAdd + DataSet.SumVatOutlayAdd;
    if(SumVatOutlayAdd != 0)
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "+НДС", "ЗпоСд, ОЭБ",           /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           SumVatOutlayAdd,                /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание НДС затрат по выкупаемым ОЭБ на расходы",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Налог", "+НДС",               /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           SumVatOutlayAdd,                /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание НДС затрат по выкупаемым ОЭБ на расходы, " + GetFinName(FD.fininstr.rec),
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание отсроченной разницы по выкупленным ОЭБ
    if(DataSet.SumDefDiffAdd != 0)
      
      if(DataSet.SumDefDiffAdd > 0)
        FD.SetParmForCateg24828("-Эмиссия, ОЭБ", "02");
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-Эмиссия, ОЭБ", "+КоррАС, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             DataSet.SumDefDiffAdd,           /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Положительная отсроченная разница, " + GetFinName(FD.fininstr.rec),
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
        FD.ResetParmForCateg24828();
      else
        FD.SetParmForCateg24828("+Эмиссия, ОЭБ", "05");
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-КоррАС, ОЭБ", "+Эмиссия, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             abs(DataSet.SumDefDiffAdd),      /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Отрицательная отсроченная разница, " + GetFinName(FD.fininstr.rec),
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
        FD.ResetParmForCateg24828();
      end;
    end;
  end;

  //Списание корректировок и допдохода выкупленным ОЭБ
  
  query =   " select NVL(sum(t_CorrIntToEIRChange), 0) as SumCorr, "
          + "        NVL(sum(t_AddIncomeOwnChange), 0) as SumAddIncome, "
          + "        NVL(sum(t_HedgCorrChange), 0) as SumWrtHedgCorr, "
          + "        NVL(sum(t_AmortHedgCorrChange), 0) as SumWrtAmortHedgCorr "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    SumCorr = abs(DataSet.SumCorr);
/*
    if(SumCorr > 0)
      if( (FD.IsExistAccount("-Корр, ОЭБ", null, true, FIROLE_AJUSTVALOEB, CorrAcc, MC_PAIRACCMODE_MANUAL, dat)) and
        (abs(GetRestAccount(CorrAcc.rec, dat)) > 0) 
      )
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             CorrAcc, "+Эмиссия, ОЭБ",        /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             SumCorr,                         /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Списание корректировок выкупленным ОЭБ, " + GetFinName(FD.fininstr.rec),
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
      elif( (FD.IsExistAccount("+Корр, ОЭБ", null, true, FIROLE_AJUSTVALOEB, CorrAcc, MC_PAIRACCMODE_MANUAL, dat)) and
            (abs(GetRestAccount(CorrAcc.rec, dat)) > 0) 
          )
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-Эмиссия, ОЭБ", CorrAcc,        /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                             SumCorr,                         /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Списание корректировок выкупленным ОЭБ, " + GetFinName(FD.fininstr.rec),
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
               )
          return 1;
        end;
      end;
    end;
*/
    if(DataSet.SumAddIncome > 0)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                          "-ПФИ ОЭБ", "Выбытие ПФИ ОЭБ",   /* КатегДеб, КатегКредит*/
                                          dat,                             /* Дата */
                                          1,                               /* Глава */
                                          NATCUR,                          /* Валюта */
                                          money(DataSet.SumAddIncome),     /* Сумма  */
                                          INPCARRY,                        /* Result_Carry */
                                          " 1",                            /* Kind_Oper */
                                          "",                              /* Numb_Document */
                                          "Списание СС ПФИ",
                                          null,
                                          null,
                                          null,
                                          NATCUR, NATCUR  
                                        )
            )
        return 1;
      end;

      if( (FD.IsExistAccount("Доходы ПФИ", null, true, FIROLE_AJUSTVALOEB, findAcc, MC_PAIRACCMODE_MANUAL, dat)) and
          (abs(GetRestAccount(findAcc.rec, dat)) > 0) 
        )
        copy(ProfPFIAcc, findAcc);
      elif((FD.IsExistAccount("Расходы ПФИ", null, true, FIROLE_AJUSTVALOEB, findAcc, MC_PAIRACCMODE_MANUAL, dat)) and
           (abs(GetRestAccount(findAcc.rec, dat)) > 0) 
          )
        copy(ProfPFIAcc, findAcc);
      else
        ProfPFIAcc = "Доходы ПФИ";
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                          "Выбытие ПФИ ОЭБ", ProfPFIAcc,   /* КатегДеб, КатегКредит*/
                                          dat,                             /* Дата */
                                          1,                               /* Глава */
                                          NATCUR,                          /* Валюта */
                                          money(DataSet.SumAddIncome),     /* Сумма  */
                                          INPCARRY,                        /* Result_Carry */
                                          " 1",                            /* Kind_Oper */
                                          "",                              /* Numb_Document */
                                          "Списание СС ПФИ",
                                          null,
                                          null,
                                          null,
                                          NATCUR, NATCUR  
                                        )
            )
        return 1;
      end;
    end;
  
    if(DataSet.SumWrtHedgCorr != 0)
      if(СписатьКорректировкиХедж(FD, dat, DataSet.SumWrtHedgCorr, false) != 0)
        return 1;
      end;
    end;

    if(DataSet.SumWrtAmortHedgCorr != 0)
      if(СписатьКорректировкиХедж(FD, dat, DataSet.SumWrtAmortHedgCorr, true) != 0)
        return 1;
      end;
    end;
  end;

  if(IsEXCHANGE(FD.Group) or (FD.tick.rec.Flag2 == UNSET_CHAR)) //Если биржева или внебиржевая, в которой не выставлен признак "с погашением выкупленных ц/б"
  if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                       "Выкуп, ОЭБ", "ВнебалСчетОЭБ"/*"ВнебалСчетКорресп"*/, /* КатегДеб, КатегКредит*/
                                       dat,                               /* Дата */
                                       3,                                 /* Глава */
                                       FD.FaceFIID(),                     /* Валюта */
                                       NK,                                /* Сумма  */
                                       INPCARRY,                          /* Result_Carry */
                                       " 1",                              /* Kind_Oper */
                                       "",                                /* Numb_Document */
                                       "Выкупленные до срока погашения собственные облигации  " + GetFinName(FD.fininstr.rec),
                                       null,
                                       null,
                                       FIROLE_CORACC_ACTIVE,
                                       FD.FaceFIID(), NATCUR  
                                     )
      )
    return 1;
  end;
  end;

  return 0; 
END;

/* Проводки постановки сделки на внебаланс/корректировки суммы на внебалансе*/
MACRO БУ_ПоставитьНаВнебалансОЭБ( FD, dat, _ChangeSum, GrDealID )
  var DealType;
  var Sum = $0, SumNat = $0, ChangeSum = $0, BaseSum = $0;
  var AccFIID = -1, AccCat = "";
  var Ground = "";

  if(_ChangeSum != NULL)
    ChangeSum = _ChangeSum;
  end;

  FD.SetCurPFI(FD.CurPFI());
  DealType = FD.ВидСрочностиСделки();

  if( (DealType != СделкаПрочая) and (DealType != СделкаНеРанееТретьегоДня))
     msgbox( "Шаг должен выполняться только для сделок не ранее третьего дня или прочих сделок" );
     return 1;
  end;

  BaseSum = FD.dl_leg.rec.TotalCost;
  if(ChangeSum != 0)
    BaseSum = ChangeSum;
  end;

  if( FD.dl_leg.rec.CFI != NATCUR )
     if( not SmartConvertSum( SumNat, BaseSum, dat, FD.dl_leg.rec.CFI, NATCUR, true))
        return 1;
     end;
  else
     SumNat = BaseSum;
  end;


//1.Постановка/корректировка требований

  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.GetPayFIID(); /*валюта расчетов*/
  else 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  end; 

  Ground = "Постановка требований на внебалансовый учет"; 
  if(ChangeSum != 0)
    Ground = "Корректировка требований на внебалансовом учете";
  end;

  if( AccFIID != FD.dl_leg.rec.CFI )
     if( not SmartConvertSum( Sum, BaseSum, dat, FD.dl_leg.rec.CFI, AccFIID, true))
        return 1;
     end;
  else
     Sum = BaseSum;
  end;

  if( DealType == СделкаПрочая )
     AccCat = "+Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "+Форвард, дрейф"; 
  end;

  if(Sum > 0)
    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           AccCat, "СчКорреспГлаваГ", /* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           AccFIID,               /* Валюта */
           Sum,                   /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           //Ground,              /* Ground */
           "Постановка на внебаланс по сделке/договору N  " + FD.tick.rec.DealCode + " от  " + FD.tick.rec.DealDate + " ЦБ " + FD.fininstr().rec.Name + " " + iif( TRIM(FD.avoiriss.rec.ISIN) == "", FD.avoiriss.rec.LSIN, FD.avoiriss.rec.ISIN),
           0, FIROLE_FIREQ, FIROLE_CORACC_ACTIVE, 
           AccFIID, null,
           NATCUR, SumNat         /*сумма в валюте второго счета*/
          ))
        return 1;
    end;
  elif(Sum < 0)
    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "СчКорреспГлаваГ", AccCat,/* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           AccFIID,               /* Валюта */
           ABS(Sum),              /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           //Ground,                /* Ground */
           "Постановка на внебаланс по сделке/договору N  " + FD.tick.rec.DealCode + " от  " + FD.tick.rec.DealDate + " ЦБ " + FD.fininstr().rec.Name + " " + iif( TRIM(FD.avoiriss.rec.ISIN) == "", FD.avoiriss.rec.LSIN, FD.avoiriss.rec.ISIN),
           0, FIROLE_CORACC_ACTIVE, FIROLE_FIREQ,
           null, AccFIID,
           NATCUR, ABS(SumNat)         /*сумма в валюте второго счета*/
          ))
        return 1;
    end;
  end;

//2. Постановка/корректировка обязательств

  Sum = $0;
  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  else 
    AccFIID = FD.GetPayFIID(); /*валюта расчетов*/
  end; 

  if( AccFIID != FD.dl_leg.rec.CFI )
     if( not SmartConvertSum( Sum, BaseSum, dat, FD.dl_leg.rec.CFI, AccFIID, true))
        return 1;
     end;
  else
     Sum = BaseSum;
  end;

  if( DealType == СделкаПрочая )
     AccCat = "-Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "-Форвард, дрейф"; 
  end;
  
  Ground = "Постановка обязательств на внебалансовый учет"; 
  if(ChangeSum != 0)
    Ground = "Корректировка обязательств на внебалансовом учете";
  end;
  
  if(Sum > 0)
    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "СчКорреспГлаваГ", AccCat, /* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           NATCUR,                /* Валюта */
           SumNat,                /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           //Ground,                /* Ground */
           "Постановка на внебаланс по сделке/договору N  " + FD.tick.rec.DealCode + " от  " + FD.tick.rec.DealDate + " ЦБ " + FD.fininstr().rec.Name + " " + iif( TRIM(FD.avoiriss.rec.ISIN) == "", FD.avoiriss.rec.LSIN, FD.avoiriss.rec.ISIN),
           0, FIROLE_CORACC_PASSIVE, FIROLE_FICOM, 
           null, AccFIID,
           AccFIID, Sum
          ))
        return 1;
    end;
  elif(Sum < 0)
    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           AccCat, "СчКорреспГлаваГ", /* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           NATCUR,                /* Валюта */
           ABS(SumNat),           /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           //Ground,                /* Ground */
           "Постановка на внебаланс по сделке/договору N  " + FD.tick.rec.DealCode + " от  " + FD.tick.rec.DealDate + " ЦБ " + FD.fininstr().rec.Name + " " + iif( TRIM(FD.avoiriss.rec.ISIN) == "", FD.avoiriss.rec.LSIN, FD.avoiriss.rec.ISIN),
           0, FIROLE_FICOM, FIROLE_CORACC_PASSIVE,
           AccFIID, null,
           AccFIID, ABS(Sum)
          ))
        return 1;
    end;
  end;

  return 0;
END;

//Проводки снятия сделки с внебаланса
MACRO БУ_СнятьСВнебалансаОЭБ( FD, dat, GrDealID )
  var DealType;
  var Sum = $0, SumNat = $0;
  var AccFIID = -1, AccCat = "";
  var ForRestAcc = 0;
  record СчетУчета( account );

  FD.SetCurPFI(FD.CurPFI());
  DealType = FD.ВидСрочностиСделки();

  if( (DealType != СделкаПрочая) and (DealType != СделкаНеРанееТретьегоДня))
     msgbox( "Шаг должен выполняться только для сделок не ранее третьего дня или прочих сделок" );
     return 1;
  end;

//1.Списание требований

  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.GetPayFIID(); /*валюта расчетов*/
  else 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  end; 

  if( DealType == СделкаПрочая )
     AccCat = "+Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "+Форвард, дрейф"; 
  end;

  if( not FD.IsExistAccount( AccCat, null, true, FIROLE_FIREQ, СчетУчета, null, dat ))
     return 0; /*Счета нет, списывать нечего*/
  end;

  Sum  = ABS( GetRestAccount( СчетУчета, dat ) );

  if(FD.tick.rec.ChangeDate == dat)
    ForRestAcc = GETRESTACC_CREDIT;
  end;

  if((Sum > 0) or (ForRestAcc > 0))
    if( AccFIID != NATCUR )
       if( not SmartConvertSum( SumNat, Sum, dat, AccFIID, NATCUR, true))
          return 1;
       end;
    else
       SumNat = Sum;
    end;

    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "СчКорреспГлаваГ", СчетУчета, /* AccDeb , AccCred*/
           dat,                   /* Дата */
           4,                     /* Глава */
           NATCUR,                /* Валюта */
           IIF(ForRestAcc > 0, $0, SumNat),  /* Сумма */
           INPCARRY,              /* Result_Carry */
           " 1",                  /* Kind_Oper */
           FD.tick.rec.DealCode,  /* Numb_Document */
           "Списание требований с внебалансового учета", /* Ground */
           ForRestAcc, FIROLE_CORACC_ACTIVE, FIROLE_FIREQ,
           null, AccFIID,
           AccFIID, IIF(ForRestAcc > 0, $0, Sum)    /*сумма в валюте второго счета*/
          ))
        return 1;
    end;
  end;

//2. Списание обязательств

  Sum = $0;
  if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
    AccFIID = FD.FaceFIID(); /*валюта номинала*/
  else 
    FD.GetPayFIID(); /*валюта расчетов*/
  end; 

  if( DealType == СделкаПрочая )
     AccCat = "-Форвард, прочие"; 
  elif( DealType == СделкаНеРанееТретьегоДня )
     AccCat = "-Форвард, дрейф"; 
  end;

  if( not FD.IsExistAccount( AccCat, null, true, FIROLE_FICOM, СчетУчета, null, dat ))
     return 0; /*Счета нет, списывать нечего*/
  end;

  Sum  = ABS( GetRestAccount( СчетУчета, dat ) );
  
  if(FD.tick.rec.ChangeDate == dat)
    ForRestAcc = GETRESTACC_DEBET;
  end;

  if((Sum > 0) or (ForRestAcc > 0))

    if( AccFIID != NATCUR )
       if( not SmartConvertSum( SumNat, Sum, dat, AccFIID, NATCUR, true))
          return 1;
       end;
    else
       SumNat = Sum;
    end;

    FD.SetFIIDForCorAccNum(AccFIID);
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           AccCat, "СчКорреспГлаваГ", /* AccDeb , AccCred*/
           dat,                       /* Дата */
           4,                         /* Глава */
           AccFIID,                   /* Валюта */
           IIF(ForRestAcc > 0, $0, Sum), /* Сумма */
           INPCARRY,                  /* Result_Carry */
           " 1",                      /* Kind_Oper */
           FD.tick.rec.DealCode,      /* Numb_Document */
           "Списание обязательств с внебалансового учета",   /* Ground */
           ForRestAcc, FIROLE_FICOM, FIROLE_CORACC_PASSIVE, 
           AccFIID, NATCUR,
           NATCUR, IIF(ForRestAcc > 0, $0, SumNat)
          ))
        return 1;
    end;
  end;

  return 0;
END;

/* Проводки постановки сделки на баланс*/
MACRO БУ_ПоставитьНаБалансОЭБ( FD, dat, GrDealID )
  var Sum = $0;

  FD.SetCurPFI(FD.CurPFI());

  if(FD.GetPayFIID() != FD.dl_leg.rec.CFI )
     if( not SmartConvertSum( Sum, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), true))
        return 1;
     end;
  else
     Sum = FD.dl_leg.rec.TotalCost;
  end;

  if(Sum > 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "+Форвард, расчеты", "-Форвард, расчеты", /* AccDeb , AccCred*/
           dat,                                      /* Дата */
           1,                                        /* Глава */
           FD.GetPayFIID(),                          /* Валюта */
           Sum,                                      /* Сумма */
           INPCARRY,                                 /* Result_Carry */
           " 1",                                     /* Kind_Oper */
           FD.tick.rec.DealCode,                     /* Numb_Document */
           "Постановка сделки на балансовый учет"    /* Ground */
          ))
        return 1;
    end;
  end;

  return 0;
END;

//Проводки оплаты комиссий при размещении/продаже
MACRO БУ_ОплатаКомиссийПриРазмещенииОЭБ( FD, dat, GrDealID )
  var query, cmd, DataSet;
  var Sum = $0, SumComiss = $0, SumNDS = $0, SumPF = $0;
  var EssSum = $0, NotEssSum = $0;

  query =   " SELECT NVL(SUM(ROUND(Rsb_FIInstr.ConvSum(dlcomis.t_Sum-dlcomis.t_NDS, comis.t_FIID_Comm, ?, ?), 2)),0) as SumComiss, "
          + "        NVL(SUM(ROUND(Rsb_FIInstr.ConvSum(dlcomis.t_NDS, comis.t_FIID_Comm, ?, ?), 2)),0) as SumNDS " 
          + "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis "
          + "  WHERE dlcomis.t_DocKind = ? "
          + "    AND dlcomis.t_DocID   = ? "
          + "    AND dlcomis.t_FeeType   = comis.t_FeeType "
          + "    AND dlcomis.t_ComNumber = comis.t_Number "
          + "    AND dlcomis.t_Immaterial <> CHR(88) "
          + "    AND comis.t_ReceiverID <> " + {OurBank};

  cmd = DL_RSDCommand(query);

  cmd.AddParam(NATCUR);
  cmd.AddParam(dat);
  cmd.AddParam(NATCUR);
  cmd.AddParam(dat);
  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    SumComiss = money(DataSet.SumComiss);
    SumNDS    = money(DataSet.SumNDS);
    Sum       = SumComiss+SumNDS;
  end;

  if(Sum > 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "ЗпоСд, ОЭБ", "РасРасх, ОЭБ", /* AccDeb , AccCred*/
           dat,                       /* Дата */
           1,                         /* Глава */
           NATCUR,                    /* Валюта */
           Sum,                       /* Сумма */
           INPCARRY,                  /* Result_Carry */
           " 1",                      /* Kind_Oper */
           FD.tick.rec.DealCode,      /* Numb_Document */
           "Отражение обязательств по оплате затрат по сделке, " + GetFinName(FD.fininstr.rec)   /* Ground */
          ))
        return 1;
    end;
/*chesnokov D.S. 513138 - Эти проводка лишняя*/
/*DAN*/
//    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
//           "Затраты, ОЭБ", "ЗпоСд, ОЭБ", /* AccDeb , AccCred*/
//           dat,                       /* Дата */
//           1,                         /* Глава */
//           NATCUR,                    /* Валюта */
//           Sum,                       /* Сумма */
//           INPCARRY,                  /* Result_Carry */
//           " 1",                      /* Kind_Oper */
//           FD.tick.rec.DealCode,      /* Numb_Document */
//           "Отнесение на расходы затрат по сделке, " + GetFinName(FD.fininstr.rec)   /* Ground */
//          ))
//        return 1;
//    end;
/*DAN*/
    if(NATCUR != FD.FaceFIID())
      if( not SmartConvertSum( SumPF, Sum, dat, NATCUR, FD.FaceFIID(), true))
        return 1;
      end;
    else
      SumPF = Sum;
    end;
      
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "РасРасх, ОЭБ", IIF(IsOUTEXCHANGE(FD.Group), "-Расчеты", "+Биржа"),  /* AccDeb , AccCred*/ /*PDV 531431*/
           dat,                       /* Дата */
           1,                         /* Глава */
           NATCUR,                    /* Валюта */
           Sum,                       /* Сумма */
           INPCARRY,                  /* Result_Carry */
           " 1",                      /* Kind_Oper */
           FD.tick.rec.DealCode,      /* Numb_Document */
           "Отражение исполнения обязательств по оплате затрат по сделке, " + GetFinName(FD.fininstr.rec),   /* Ground */
           0, NULL, NULL, 
           NULL, FD.FaceFIID(),
           FD.FaceFIID(), SumPF
          ))
        return 1;
    end;
  end;

  if(SumComiss > 0 )
    EssSum = FD.pmwrtsum.rec.Outlay;
    if((EssSum > 0) and (FD.FaceFIID() != NATCUR))
      if( not SmartConvertSum( EssSum, EssSum, dat, FD.FaceFIID(), NATCUR, true))
        return 1;
      end;
    end;

    NotEssSum = SumComiss - EssSum;

    if(NotEssSum > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Затраты, ОЭБ", "ЗпоСд, ОЭБ",  /* AccDeb , AccCred*/
             dat,                           /* Дата */
             1,                             /* Глава */
             NATCUR,                        /* Валюта */
             NotEssSum,                     /* Сумма */
             INPCARRY,                      /* Result_Carry */
             " 1",                          /* Kind_Oper */
             FD.tick.rec.DealCode,          /* Numb_Document */
             "Отнесение на расходы затрат по сделке, " + GetFinName(FD.fininstr.rec)   /* Ground */ /*chesnokov D.S. 513138*/
            ))
          return 1;
      end;
    end;
  end;

  if(SumNDS > 0)
    EssSum = FD.pmwrtsum.rec.VatOutlay;
    if((EssSum > 0) and (FD.FaceFIID() != NATCUR))
      if( not SmartConvertSum( EssSum, EssSum, dat, FD.FaceFIID(), NATCUR, true))
        return 1;
      end;
    end;

    NotEssSum = SumNDS - EssSum;

    if(NotEssSum > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "+НДС", "ЗпоСд, ОЭБ",      /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             NATCUR,                    /* Валюта */
             NotEssSum,                 /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отражение НДС уплаченного"/* Ground */
            ))
          return 1;
      end;

      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Налог", "+НДС",          /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             NATCUR,                    /* Валюта */
             NotEssSum,                 /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отнесение НДС уплаченного на расходы"   /* Ground */
            ))
          return 1;
      end;
    end;

  end;

  return 0;
END;

//Проводки оплаты комиссий при выкупе
MACRO БУ_ОплатаКомиссийПриВыкупеОЭБ( FD, dat, GrDealID )
  var query, cmd, DataSet;
  var Sum = $0, SumPF = $0, SumNDS = $0;
  var Curr = -1;

  query =   " SELECT dlcomis.t_Sum as SumComiss, "
          + "        dlcomis.t_NDS as SumNDS, "
          + "        comis.t_FIID_Comm"
          + "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis "
          + "  WHERE dlcomis.t_DocKind = ? "
          + "    AND dlcomis.t_DocID   = ? "
          + "    AND dlcomis.t_FeeType   = comis.t_FeeType "
          + "    AND dlcomis.t_ComNumber = comis.t_Number ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    Sum    = money(DataSet.SumComiss-DataSet.SumNDS);
    SumNDS = money(DataSet.SumNDS);
    Curr   = DataSet.FIID_Comm;

    if(Sum > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Эмиссия, ОЭБ", "+Биржа",  /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             Sum,                       /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
//             "Признание расходов в виде комиссии за размещение ц/б. "  + GetFinName(FD.fininstr.rec),   /* Ground */
               "комиссия торговой системы по сделке выкупа  собственные облигации "  + GetFinName(FD.fininstr.rec),   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;
    end;

    if(SumNDS > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "+НДС", "+Биржа",          /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             SumNDS,                    /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отражение НДС уплаченного",   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;

      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Налог", "+НДС",           /* AccDeb , AccCred*/
             dat,                        /* Дата */
             1,                          /* Глава */
             Curr,                       /* Валюта */
             SumNDS,                     /* Сумма */
             INPCARRY,                   /* Result_Carry */
             " 1",                       /* Kind_Oper */
             FD.tick.rec.DealCode,       /* Numb_Document */
             "Отнесение НДС на расходы", /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
      end;
    end;
    
  end;

  return 0;
END;

//Проводки оплаты комиссий при внебиржевом размещении
MACRO БУ_ОплатаКомиссийПриВнебиржРазмещенииОЭБ(FD, dat, GrDealID )
  var query, cmd, DataSet;
  var DebAcc = TRecHandler("account.dbt");
  var rq = TRecHandler("dlrq.dbt");
  var Sum = $0, SumPF = $0;

  //Оплата комиссии эмитента контрагентом
  if(FD.tick.rec.Flag3 == SET_CHAR)
    query =   " SELECT ROUND(Rsb_FIInstr.ConvSum(dlcomis.t_Sum, comis.t_FIID_Comm, ?, ?), 2) as SumComiss, rq.t_ID as RQID "
            + "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis, dsfcontr_dbt contr, ddlrq_dbt rq "
            + "  WHERE dlcomis.t_DocKind = ? "
            + "    AND dlcomis.t_DocID   = ? "
            + "    AND dlcomis.t_FeeType   = comis.t_FeeType "
            + "    AND dlcomis.t_ComNumber = comis.t_Number "
            + "    AND dlcomis.t_Immaterial <> CHR(88) "
            + "    AND comis.t_Code = ? "
            + "    AND contr.t_ID = dlcomis.t_Contract "
            + "    AND contr.t_ObjectType = " + SF_SECUROWN
            + "    AND contr.t_Object = ? "
            + "    AND rq.t_SourceObjKind = " + DL_SECURITYCOM
            + "    AND rq.t_SourceObjID = dlcomis.t_ID ";
    

    cmd = DL_RSDCommand(query);

    cmd.AddParam(NATCUR);
    cmd.AddParam(dat);
    cmd.AddParam(FD.tick.rec.BOfficeKind);
    cmd.AddParam(FD.tick.rec.DealID);
    cmd.AddParam(ПолучитьКодКомиссииЭмитентаВО());
    cmd.AddParam(FD.tick.rec.DealCode);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Sum = money(DataSet.SumComiss);
      
      cmd = DL_RSDCommand("select * from ddlrq_dbt where t_ID = ?");
      cmd.AddParam(DataSet.RQID);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        DataSet.GetRecord().CopyTo(rq.rec);
      else
        msgbox("Не найдено ТО по комиссии");
        return 1;
      end;
    end;

    if(Sum > 0)
      if(FD.GetPayFIID() != NATCUR)
        if( not SmartConvertSum( SumPF, Sum, dat, NATCUR, FD.GetPayFIID(), true))
          return 1;
        end;
      else
        SumPF = Sum;
      end;

      if( ПолучитьСчетКонтрагентаПоТООплатыКомиссии( rq, FD, dat, DebAcc ) != 0)
        msgbox("Ошибка при определении счета контрагента по ТО оплаты комиссии");
        return 1;
      end;

      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             DebAcc, "+Эмиссия, ОЭБ",   /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             NATCUR,                    /* Валюта */
             Sum,                       /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Оплата комиссии банку контрагентом"   /* Ground */
            ))
          return 1;
      end;
    end;
  end;
 
  if(БУ_ОплатаКомиссийПриРазмещенииОЭБ( FD, dat, GrDealID ) != 0)
    return 1;
  end;

  return 0;
END;



//Перенос на счета к исполнению при погашении купона
macro БУ_ПереносНаСчетаКИсполнениюКупонОЭБ( FD, dat, GrDealID )
  var cmd, query, DataSet;
  var InterestAdd = $0;
  var CatAcc = "";
  var fiw = TRecHandler("fiwarnts.dbt");
  var Sum = $0;

 var BondName, BondRegN;
 var sqlFI = "select fi.t_definition, fi.t_name, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " +fd.tick.rec.pfi;
 var cmdFI = DL_RSDCommand();
 var dsFI = cmdFI.Execute(sqlFI);
 if(dsFI.moveNext())
  BondName = IIF(dsFi.value("t_definition") != "", dsFi.value("t_definition"), dsFi.value("t_name")); 
  BondRegN = dsFi.value("t_LSIN");
 end;
 

  record СчетОЭБпрц( account );
   
  if(FD.tick.rec.Number_Coupon == "")
    msgbox("Не задан номер купона");
    return 1;
  end;

  if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
    msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
    return 1;
  end;

  query =   " SELECT NVL(SUM(ROUND(A.T_INTERESTINCOME,2) - ROUND(B.T_INTERESTINCOME,2)), 0) InterestAdd "
          + "   FROM V_SCWRTHISTEX A, DPMWRTBC_DBT B "
          + "  WHERE A.T_ID_OPERATION = ? "
          + "    AND A.T_ID_STEP = -1 "
          + "    AND A.T_ACTION = " + PM_WRTSUM_UPDTMODE_INCPDD
          + "    AND A.T_PARTY = -1 "
          + "    AND A.T_CONTRACT = 0 "
          + "    AND A.T_FIID = ? "
          + "    AND B.T_SUMID = A.T_SUMID "
          + "    AND B.T_INSTANCE  = A.T_INSTANCE - 1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ПроводкиБУ.GetServDocID());
  cmd.AddParam(ПроводкиБУ.GetCurrAvrFIID());

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    InterestAdd  = DataSet.InterestAdd;
  end;

  if( FD.IsExistAccount("Обяз%, ОЭБ", null, true, null, СчетОЭБпрц, null, dat))
    Sum = GetRestAccount(СчетОЭБпрц, dat);
  end;

  if(InterestAdd != 0)
var rq_payinc_tmp;

if (FD.FaceFIID() != natcur)
  if(FD.ExistRqPayIncome())
      rq_payinc_tmp = FD.GetRQ(DLRQ_TYPE_PAYINCOME);
      if ((Sum + InterestAdd) > rq_payinc_tmp.rec.amount)
        interestAdd = rq_payinc_tmp.rec.amount - Sum;
      end;
  end;
end;
 
    var CatCode = "%Расход, ОЭБ";
      
    if((FD.avoiriss.rec.Subordinated == SET_CHAR) and (GetSubordCvalTypeAttrID(FD.fininstr.rec.FIID) == OBJATTR_SUBORDCVALTYPE_DI))
      CatCode = "-Изм.кап., суборд.ОЭБ";
    end;
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatCode, "Обяз%, ОЭБ",        /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             InterestAdd,                  /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Доначисление ПКД, облигация  " + BondName + ", госрег " + BondRegN  ,           /* Ground */
             null,
             null,
             null,
             NATCUR, FD.FaceFIID()
            ))
          return 1;
    end;

    Sum = Sum + InterestAdd;
  end;


  CatAcc = "ОЭБ купон, к погашению";
  if(fiw.rec.DrawingDate == FD.fininstr().rec.DrawingDate)
    CatAcc = "ОЭБ купон, к исполнению";
  end;

  if(not БУ_ПроводкаПоКатегориямУчета( FD, 
         "Обяз%, ОЭБ", CatAcc,             /* Деб , КатегКредит*/
         dat,                              /* Дата */
         1,                                /* Глава */
         FD.FaceFIID(),                    /* Валюта */
         $0,                               /* Сумма дебет*/
         INPCARRY,                         /* Result_Carry */
         " 1",                             /* Kind_Oper */
         FD.tick.rec.DealCode,             /* Numb_Document */
         "Перенос на счет к исполнению при погаш. купона №" + FD.tick.rec.Number_Coupon + " , обл. "+ BondName + ", госрег " + BondRegN ,   /* Ground */
         GETRESTACC_DEBET 
        ))
      return 1;
  end;

  return 0;
end;
private macro getRealSum(FD)

  record AccDb( account);
  record AccKr( account);

  FD.IsExistAccount("Обяз%, ОЭБ", null, true, null, AccDb, null, {curdate} );
//  FD.IsExistAccount("ОЭБ%, к исполнению", null, true, null, AccKr, null, {curdate} );

end;

//Проводки учёта погашения купона
macro БУ_ПроводкиУчетаПогашенияКупонаОЭБ( FD, dat, GrDealID )
  record  Счет_ДСвКО( account );
  record  Счет_ОЭБкИсп( account );

  var rq_payinc = NULL;
  var CatAcc = "";
  var fiw = TRecHandler("fiwarnts.dbt");
  var sum = $0, sumTax = $0;
  var OurBankIsTaxAgent = UNSET_CHAR;
  var query, cmd, DataSet;
  var SumTaxPF = $0;
  var stat;
  var UseCouponRefuse;
var BondName, BondRegN;
 var sqlFI = "select fi.t_definition, fi.t_name, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " +fd.tick.rec.pfi;
 var cmdFI = DL_RSDCommand();
 var dsFI = cmdFI.Execute(sqlFI);
 if(dsFI.moveNext())
  BondName = IIF(dsFi.value("t_definition") != "", dsFi.value("t_definition"), dsFi.value("t_name")); 
  BondRegN = dsFi.value("t_LSIN");
 end;

  if(FD.tick.rec.Number_Coupon == "")
    msgbox("Не задан номер купона");
    return 1;
  end;

  if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
    msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
    return 1;
  end;
  
  if(fiw.rec.PaymentRefuse == SET_CHAR) // Запрет по выплате дохода по купону
    GetRegistryValue("COMMON\\WORK_MODE\\USE_COUPON_REFUSE", V_BOOL, UseCouponRefuse, stat);
    if ((stat == 0) and (UseCouponRefuse))
      return 0;
    end;
  end;
  
  if(FD.ExistRqPayIncome())
    rq_payinc = FD.GetRQ(DLRQ_TYPE_PAYINCOME);
  end;

  if(rq_payinc == NULL)
    msgbox("Не найдено ТО по выплате дохода");
    return 1;
  end;
  
  if(ДатаЯвляетсяПереходящейПогашОЭБ(FD.dl_leg.rec.Maturity, FD.ПолучитьКалендСвязанный()) == true)

    query =  " select NVL(SUM(t_InterestIncomeAdd), 0) as SumInterestAdd "
           + "   from dpmwrtlnk_dbt "
           + "  where t_SaleID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(FD.pmwrtsum.rec.SumID);
    
    DataSet = cmd.Execute();
    
    if(DataSet.moveNext())

      //Доначисление ПКД
      if(DataSet.SumInterestAdd != 0)
        var CatCode = "%Расход, ОЭБ";
      
        if((FD.avoiriss.rec.Subordinated == SET_CHAR) and (GetSubordCvalTypeAttrID(FD.fininstr.rec.FIID) == OBJATTR_SUBORDCVALTYPE_DI))
          CatCode = "-Изм.кап., суборд.ОЭБ";
        end;

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             CatCode, "Обяз%, ОЭБ",   /* КатегДеб, КатегКредит*/
                                             dat,                               /* Дата */
                                             1,                                 /* Глава */
                                             FD.FaceFIID(),                     /* Валюта */
                                             DataSet.SumInterestAdd,            /* Сумма  */
                                             INPCARRY,                          /* Result_Carry */
                                             " 1",                              /* Kind_Oper */
                                             "",                                /* Numb_Document */
                                             "Доначисление ПКД , облигация  " + BondName,
                                             null,
                                             null,
                                             null,
                                             NATCUR, FD.FaceFIID() 
                                           )
            )
          return 1;
        end;

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "Обяз%, ОЭБ", "ОЭБ купон, к погашению",   /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumInterestAdd,         /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Перенос на счет \"к исполнению\" , облигация  " + BondName,
                                             null,
                                             null,
                                             null,
                                             FD.FaceFIID(), FD.FaceFIID() 
                                           )
            )
          return 1;
        end;

      end;
    end;
  end;
 
  CatAcc = "ОЭБ купон, к погашению";

  sum = rq_payinc.rec.Amount; //Уже за вычетом налогов
  if(rq_payinc.rec.FIID != FD.dl_leg.rec.PayFIID)
    if( not SmartConvertSum( sum, sum, dat, rq_payinc.rec.FIID, FD.dl_leg.rec.PayFIID, true))
      return 1;
    end;
  end;

  sumTax = 0;
  if(FD.ExistsRQ(DLRQ_TYPE_TAX_ULN))
    sumTax = FD.GetRQ(DLRQ_TYPE_TAX_ULN).rec.Amount;
  end;
/*DAN*/
       var rqaccTax = TRecHandler("dlrqacc.dbt");
       var accbufTax = TRecHandler("account.dbt");
    
       if (ПолучитПлатежныеРеквизитыПоТО(rq_payinc, rqaccTax))
//        return SayError(1, "Ошибка при получении реквизитов");
       end;
       if (ПолучитьСчетПоПлатежнымРеквизитам(rqaccTax, accbufTax))
//        return SayError(1, "Ошибка при получении счета");
       end;
    var catTax = accbufTax;
/*DAN*/



  if(sumTax)

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "-Бюджет, ф.налоги, ULN",  /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTax,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Налог на доходы иностранных организаций (20%) при погашении купона по облигации " + BondName,           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Бюджет, ф.налоги, ULN",catTax, /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTax,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Налог на доходы иностранных организаций при погашении купона по облигации " + BondName,           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;

  sumTax = 0;

  if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLR))
    sumTax = round(FD.GetRQ(DLRQ_TYPE_TAX_FLR).rec.Amount, 0);
    sumTax = round(sumTax, 0);
  end;
 
  if(sumTax)

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "НДФЛ к перечислению, FLR",/* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTax,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "налог на доходы физ лиц при выплате купонного дохода по обл " +  BondName,           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "НДФЛ к перечислению, FLR",CatTax,/* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTax,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "налог на доходы физ лиц при выплате купонного дохода по обл " +  BondName,           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;

  sumTax = 0;

  if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLR_ADD))
    sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLR_ADD).rec.Amount;
    sumTax = round(sumTax, 0);
  end;

  if(sumTax)

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "НДФЛ к перечислению 15%",/* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             sumTax,                       /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Удержание налога",           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;

  var RedistrMainTax = $0, RedistrTax15 = $0;
  ОЭБ_ПолучитьПераспределенныеСуммыНалога(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, @RedistrMainTax, @RedistrTax15);

  if(RedistrMainTax != 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             IIF(RedistrMainTax > 0, CatAcc, "НДФЛ к перечислению"), IIF(RedistrMainTax > 0, "НДФЛ к перечислению", CatAcc),/* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             abs(RedistrMainTax),          /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Перераспределение сумм налога. " + IIF(RedistrMainTax > 0, "Удержание", "Возврат"),           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;

  if(RedistrTax15 != 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             IIF(RedistrTax15 > 0, CatAcc, "НДФЛ к перечислению 15%"), IIF(RedistrTax15 > 0, "НДФЛ к перечислению 15%", CatAcc),/* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             NATCUR,                       /* Валюта */
             abs(RedistrTax15),            /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Перераспределение сумм налога. " + IIF(RedistrTax15 > 0, "Удержание", "Возврат"),           /* Ground */
             null,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;


  sumTax = 0;
  if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLN))
    sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLN).rec.Amount;
    sumTax = round(sumTax, 0);
  end;

  if(sumTax)
   if( not БУ_ПроводкаПоКатегориямУчета( FD, 
            CatAcc, "НДФЛ к перечислению, FLN",/* AccDeb , AccCred*/
            dat,                          /* Дата */
            1,                            /* Глава */
            NATCUR,                       /* Валюта */
            sumTax,                       /* Сумма */
            INPCARRY,                     /* Result_Carry */
            " 1",                         /* Kind_Oper */
            FD.tick.rec.DealCode,         /* Numb_Document */
            "налог на доходы физ лиц (30%) при выплате купонного дохода по обл " +  BondName,           /* Ground */
            null,
            null,
            null,
            FD.FaceFIID(), NATCUR
           ))
         return 1;
   end;
   if( not БУ_ПроводкаПоКатегориямУчета( FD, 
            "НДФЛ к перечислению, FLN",catTax,/* AccDeb , AccCred*/
            dat,                          /* Дата */
            1,                            /* Глава */
            NATCUR,                       /* Валюта */
            sumTax,                       /* Сумма */
            INPCARRY,                     /* Result_Carry */
            " 1",                         /* Kind_Oper */
            FD.tick.rec.DealCode,         /* Numb_Document */
            "налог на доходы физ лиц (30%) при выплате купонного дохода по обл " +  BondName,           /* Ground */
            null,
            null,
            null,
            FD.FaceFIID(), NATCUR
           ))
         return 1;
   end;
  end;

  
  if(sum)
      var RestType = null;
      if(FD.FaceFIID() != NATCUR)
        sum = $0;
        RestType = GetRestAcc_Debet;
      end;
      
      var AmountRurNote = readNoteForObject( 181, L_Z( Int(FD.tick.rec.DealID), 34 ), 102 );
      if ((ValType(AmountRurNote) != V_MONEY))
        AmountRurNote = 0;
      end;
      
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatAcc, "ДС в КО",            /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             IIF(FD.FaceFIID() != NATCUR,FD.FaceFIID() ,NATCUR), /* Валюта */
             sum,                          /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Исполнение обязательств Банка по выплате купона №" + FD.tick.rec.Number_Coupon 
            +" по облигации " + BondName ,/* Ground */
             RestType,
             null,
             null,
             FD.FaceFIID(), NATCUR, IIF(AmountRurNote != 0, NATCUR, NULL), IIF(AmountRurNote != 0, AmountRurNote, NULL), NULL,
              NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, IIF(AmountRurNote != 0, AmountRurNote, NULL)
            ))
          return 1;
    end;


    var deltaRest;

    IF ((FD.FaceFIID() != NATCUR) and (AmountRurNote == 0))
      if (not FD.IsExistAccount("ДС в КО", null, true, null, Счет_ДСвКО, null, dat ))
       msgbox("Не найден счет по категории \"ДС в КО\"");
       return 1; /*Счета нет, списывать нечего*/
      end;

      if (not FD.IsExistAccount(CatAcc, null, true, null, Счет_ОЭБкИсп, null, dat ))
       msgbox("Не найден счет по категории " + CatAcc );
       return 1; /*Счета нет, списывать нечего*/
      end;
      var Счет_ОЭБкИсп_Rest = $0;
      SmartConvertSum(Счет_ОЭБкИсп_Rest, ABS(GetRestAccount(Счет_ОЭБкИсп, dat)), dat, FD.FaceFIID(), natcur);
      
      DeltaRest = ABS(GetRestAccount(Счет_ДСвКО, dat)) - Счет_ОЭБкИсп_Rest ;
       if (DeltaRest > 0)
          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                "Расходы Окргл", "ДС в КО",   /* AccDeb , AccCred*/
                                                dat,                          /* Дата */
                                                1,                            /* Глава */
                                                NATCUR,        /* Валюта */
                                                DeltaRest,                    /* Сумма */
                                                INPCARRY,                     /* Result_Carry */
                                                " 1",                         /* Kind_Oper */
                                                FD.tick.rec.DealCode,         /* Numb_Document */
                                                "Расходы от округления при выплате купона №" + FD.tick.rec.Number_Coupon 
                                               +" по облигации " + BondName , /* Ground */
                                                null,
                                                null,
                                                null,
                                                NATCUR, NATCUR   
                                               ))
              return 1;
          end;
       elif(DeltaRest < 0)
          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                "ДС в КО", "ОкруглДоход" ,    /* AccDeb , AccCred*/
                                                dat,                          /* Дата */
                                                1,                            /* Глава */
                                                NATCUR,                       /* Валюта */
                                                ABS(DeltaRest),               /* Сумма */
                                                INPCARRY,                     /* Result_Carry */
                                                " 1",                         /* Kind_Oper */
                                                FD.tick.rec.DealCode,         /* Numb_Document */
                                                "Доходы от округления при выплате купона №" + FD.tick.rec.Number_Coupon 
                                               +" по облигации " + BondName , /* Ground */
                                                null,
                                                null,
                                                null,
                                                NATCUR, NATCUR   
                                               ))
              return 1;
          end;
       end;
    end;

  end;

  return 0;
end;

macro БУ_ПереносНаСчетаКИсполнениюДопДоходОЭБ( FD, dat, GrDealID )
  var sum = $0;
  var sumNat = $0, sumPay = $0, sumFace = $0;
  sumNat = sumPay = sumFace = FD.dl_leg.rec.Price*FD.dl_leg.rec.Principal;  // всегда рублевый

  if( NATCUR != FD.FaceFIID())
    if( not SmartConvertSum( sumFace, sumFace, dat, NATCUR, FD.FaceFIID(), true))
      return 1;
    end;
  end;

  if( NATCUR != FD.dl_leg.rec.PayFIID)
    if( not SmartConvertSum( sumPay, sumPay, dat, NATCUR, FD.dl_leg.rec.PayFIID, true))
      return 1;
    end;
  end;

  if(sumNat > 0)
    if( FD.tick.rec.Flag1 == UNSET_CHAR)// выплачивать доп. доход
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-ПФИ ОЭБ", "Выбытие ПФИ ОЭБ",  /* AccDeb , AccCred*/
               dat,                          /* Дата */
               1,                            /* Глава */
               NATCUR,                       /* Валюта */
               sumNat,                       /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Погашение доп. дохода"       /* Ground */
              ))
            return 1;
      end;
    
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "Выбытие ПФИ ОЭБ", "Обяз%, ОЭБ (доп. доход)",  /* AccDeb , AccCred*/
               dat,                          /* Дата */
               1,                            /* Глава */
               NATCUR,                /* Валюта */
               sumNat,                       /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Погашение доп. дохода",      /* Ground */
               null,
               null,
               null,
               NATCUR, FD.FaceFIID()
              ))
            return 1;
      end;
    
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "Обяз%, ОЭБ (доп. доход)", "ОЭБ купон, к исполнению",  /* AccDeb , AccCred*/
               dat,                          /* Дата */
               1,                            /* Глава */
               FD.FaceFIID(),                /* Валюта */
               sumFace,                       /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Погашение доп. дохода",       /* Ground */
               null,
               null,
               null,
               FD.FaceFIID(), FD.FaceFIID(),
               NATCUR, sumNat
    
              ))
            return 1;
      end;
    end;
  end;

  return 0;
end;

//Проводки учёта погашения дополнительного дохода
macro БУ_ПроводкиУчетаПогашенияДопДоходаОЭБ( FD, dat, GrDealID )
  var sum = $0;
  var sumNat = $0, sumPay = $0, sumFace = $0;
  var query, cmd, DataSet;
  var ProfPFIAcc = TRecHandler("account.dbt");
  var findAcc = TRecHandler("account.dbt");

  sumNat = sumPay = sumFace = FD.dl_leg.rec.Price*FD.dl_leg.rec.Principal;  // всегда рублевый

  if( NATCUR != FD.FaceFIID())
    if( not SmartConvertSum( sumFace, sumFace, dat, NATCUR, FD.FaceFIID(), true))
      return 1;
    end;
  end;

  if( NATCUR != FD.dl_leg.rec.PayFIID)
    if( not SmartConvertSum( sumPay, sumPay, dat, NATCUR, FD.dl_leg.rec.PayFIID, true))
      return 1;
    end;
  end;

  if(sumNat > 0)
    if( FD.tick.rec.Flag1 == SET_CHAR)// не выплачивать доп. доход
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-ПФИ ОЭБ", "Выбытие ПФИ ОЭБ",  /* AccDeb , AccCred*/
               dat,                          /* Дата */
               1,                            /* Глава */
               NATCUR,                       /* Валюта */
               sumNat,                       /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Погашение доп. дохода"       /* Ground */
              ))
            return 1;
      end;
    
      if( (FD.IsExistAccount("Доходы ПФИ", null, true, FIROLE_AJUSTVALOEB, findAcc, MC_PAIRACCMODE_MANUAL, dat)) and
          (abs(GetRestAccount(findAcc.rec, dat)) > 0) 
        )
        copy(ProfPFIAcc, findAcc);
      elif((FD.IsExistAccount("Расходы ПФИ", null, true, FIROLE_AJUSTVALOEB, findAcc, MC_PAIRACCMODE_MANUAL, dat)) and
           (abs(GetRestAccount(findAcc.rec, dat)) > 0) 
          )
        copy(ProfPFIAcc, findAcc);
      else
        ProfPFIAcc = "Доходы ПФИ";
      end;
    
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "Выбытие ПФИ ОЭБ", ProfPFIAcc, /* AccDeb , AccCred*/
               dat,                          /* Дата */
               1,                            /* Глава */
               NATCUR,                /* Валюта */
               sumNat,                       /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Погашение доп. дохода"      /* Ground */
              ))
            return 1;
      end;
    else
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "ОЭБ купон, к исполнению", "ДС в КО",  /* AccDeb , AccCred*/
               dat,                          /* Дата */
               1,                            /* Глава */
               FD.FaceFIID(),                /* Валюта */     
               sumFace,                       /* Сумма */
               INPCARRY,                     /* Result_Carry */
               " 1",                         /* Kind_Oper */
               FD.tick.rec.DealCode,         /* Numb_Document */
               "Погашение доп. дохода",      /* Ground */
               null,
               null,
               null,
               FD.FaceFIID(), NATCUR,
               NATCUR, sumNat
              ))
            return 1;
      end;
    end;
  end;

  return 0;
end;


//Проводки оплаты комиссий при погашении купона
MACRO БУ_ОплатаКомиссийПриПогашенииОЭБ( FD, dat, GrDealID )
  var query, cmd, DataSet;
  var Sum = $0, SumNat = $0, SumPF = $0, SumNDS = $0, SumNDSnat = $0;
  var Curr = -1;

  query =   " SELECT dlcomis.t_Sum as SumComiss, "
          + "        dlcomis.t_NDS as SumNDS, "
          + "        comis.t_FIID_Comm, dlcomis.t_ID"
          + "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis "
          + "  WHERE dlcomis.t_DocKind = ? "
          + "    AND dlcomis.t_DocID   = ? "
          + "    AND dlcomis.t_FeeType   = comis.t_FeeType "
          + "    AND dlcomis.t_ComNumber = comis.t_Number "
          + "    AND dlcomis.t_Immaterial <> CHR(88) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    Sum    = money(DataSet.SumComiss-DataSet.SumNDS);
    SumNDS = money(DataSet.SumNDS);
    Curr   = DataSet.FIID_Comm;

    if(Curr != NATCUR)
      if( not SmartConvertSum(Sumnat, Sum, dat, Curr, NATCUR, true))
        return 1;
      end;

      if(SumNDS > 0)
        if( not SmartConvertSum(SumNDSnat, SumNDS, dat, Curr, NATCUR, true))
          return 1;
        end;
      end;
    else
      SumNat    = Sum;     
      SumNDSnat = SumNDS;  
    end;

    if(Sum > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-КВ, ц/б", "-Расчеты",    /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             Sum,                       /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Признание расходов в виде комиссии за услуги платежному агенту",   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;
    end;

    if(SumNDS > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "+НДС", "-Расчеты",        /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             Curr,                      /* Валюта */
             SumNDS,                    /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отражение НДС уплаченного",   /* Ground */
             null,
             null,
             null,
             NATCUR, Curr
            ))
          return 1;
      end;

      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Налог", "+НДС",          /* AccDeb , AccCred*/
             dat,                       /* Дата */
             1,                         /* Глава */
             NATCUR,                    /* Валюта */
             SumNDSnat,                 /* Сумма */
             INPCARRY,                  /* Result_Carry */
             " 1",                      /* Kind_Oper */
             FD.tick.rec.DealCode,      /* Numb_Document */
             "Отнесение НДС уплаченного на расходы",   /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
      end;
    end;
  end;

  return 0;
END;

//Проводки переноса на счета к исполнению при погашении выпуска
macro БУ_ПереносНаСчетаКИсполнениюПогашениеОЭБ(FD, dat, GrDealID)
  var cmd, query, DataSet;
  var InterestAdd = $0, DiscountAdd = $0, BonusAdd = $0, OutlayAdd = $0, VatOutlayAdd = $0, DefDiffAdd = $0, CorrIntToEIRAdd = $0;
  var ComissAdd = $0, NDSAdd = $0;
  var CatAcc = "";
  var fiw = TRecHandler("fiwarnts.dbt");
  var RestD = $0, RestB = $0;
  record СчетДисконт( account );
  record СчетПремия( account );
  var SumComisRub, SumNDSRub;
  var FullWrt = false;
 var BondName, BondRegN;
 var sqlFI = "select fi.t_definition, fi.t_name, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " +fd.tick.rec.pfi;
 var cmdFI = DL_RSDCommand();
 var dsFI = cmdFI.Execute(sqlFI);
 if(dsFI.moveNext())
  BondName = IIF(dsFi.value("t_definition") != "", dsFi.value("t_definition"), dsFi.value("t_name")); 
  BondRegN = dsFi.value("t_LSIN");
 end;
  var ErrStr = "";

  if((FD.tick.rec.Number_Coupon != "") and (ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false))
    msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
    return 1;
  end;

  if(FD.tick.rec.Flag3 == SET_CHAR) //при досрочном погашении ничего не делаем
    return 0;
  end;

  query =   " SELECT NVL(SUM(ROUND(A.T_INTERESTINCOME,2) - ROUND(B.T_INTERESTINCOME,2)), 0) InterestAdd, "
          + "        NVL(SUM(ROUND(A.T_DISCOUNTINCOME,2) - ROUND(B.T_DISCOUNTINCOME,2)), 0) DiscountAdd, "
          + "        NVL(SUM(ROUND(A.T_BONUS,2) - ROUND(B.T_BONUS,2)), 0) BonusAdd, "
          + "        NVL(SUM(ROUND(A.T_WRTOUTLAY,2) - ROUND(B.T_WRTOUTLAY,2)), 0) OutlayAdd, "
          + "        NVL(SUM(ROUND(A.T_WRTVATOUTLAY,2) - ROUND(B.T_WRTVATOUTLAY,2)), 0) VatOutlayAdd, "
          + "        NVL(SUM(ROUND(A.T_ACCOUNTEDDEFDIFF,2) - ROUND(B.T_ACCOUNTEDDEFDIFF,2)), 0) DefDiffAdd, "
          + "        NVL(SUM(ROUND(A.T_CORRINTTOEIR,2) - ROUND(B.T_CORRINTTOEIR,2)), 0) CorrIntToEIRAdd "
          + "   FROM V_SCWRTHISTEX A, DPMWRTBC_DBT B "
          + "  WHERE A.T_ID_OPERATION = ? "
          + "    AND A.T_ID_STEP = -1 "
          + "    AND A.T_ACTION = " + PM_WRTSUM_UPDTMODE_INCPDD
          + "    AND A.T_PARTY = -1 "
          + "    AND A.T_CONTRACT = 0 "
          + "    AND A.T_FIID = ? "
          + "    AND B.T_SUMID = A.T_SUMID "
          + "    AND B.T_INSTANCE  = A.T_INSTANCE - 1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ПроводкиБУ.GetServDocID());
  cmd.AddParam(ПроводкиБУ.GetCurrAvrFIID());

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    InterestAdd     = DataSet.InterestAdd;
    DiscountAdd     = DataSet.DiscountAdd;
    BonusAdd        = DataSet.BonusAdd;
    OutlayAdd       = DataSet.OutlayAdd;
    VatOutlayAdd    = DataSet.VatOutlayAdd;
    DefDiffAdd      = DataSet.DefDiffAdd;
    CorrIntToEIRAdd = DataSet.CorrIntToEIRAdd;
  end;

  if(InterestAdd != 0)
    var CatCode = "%Расход, ОЭБ";
      
    if((FD.avoiriss.rec.Subordinated == SET_CHAR) and (GetSubordCvalTypeAttrID(FD.fininstr.rec.FIID) == OBJATTR_SUBORDCVALTYPE_DI))
      CatCode = "-Изм.кап., суборд.ОЭБ";
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             CatCode, "Обяз%, ОЭБ",        /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             InterestAdd,                  /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Доначисление ПКД, облигация  " + BondName,           /* Ground */
             null,
             null,
             null,
             NATCUR, FD.FaceFIID()
            ))
          return 1;
    end;
  end;

  if(not БУ_ПроводкаПоКатегориямУчета( FD, 
         "Обяз%, ОЭБ", "ОЭБ купон, к исполнению", /* Деб , КатегКредит*/
         dat,                              /* Дата */
         1,                                /* Глава */
         FD.FaceFIID(),                    /* Валюта */
         $0,                               /* Сумма дебет*/
         INPCARRY,                         /* Result_Carry */
         " 1",                             /* Kind_Oper */
         FD.tick.rec.DealCode,             /* Numb_Document */
         "Перенос на счет к исполнению при погаш.  купона №" + FD.tick.rec.Number_Coupon + " , обл. " + BondName , 
         GETRESTACC_DEBET 
        ))
      return 1;
  end; 

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
          КодКатегорииРазмещОЭБ(FD, dat), "ОЭБ, к исполнению", /* AccDeb , AccCred*/
          dat,                          /* Дата */
          1,                            /* Глава */
          FD.FaceFIID(),                /* Валюта */
          $0,                           /* Сумма */
          INPCARRY,                     /* Result_Carry */
          " 1",                         /* Kind_Oper */
          FD.tick.rec.DealCode,         /* Numb_Document */
          "Перенос остатка при погашении выпуска облигации " + GetFinName(FD.fininstr.rec),            /* Ground */
          GETRESTACC_DEBET,
          null,
          null,
          FD.FaceFIID(), FD.FaceFIID()
         ))
       return 1;
  end;


  if(DiscountAdd != 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "%Расход, ОЭБ", КодКатегорииДисконтОЭБ(FD, dat), /* AccDeb , AccCred*/
             dat,                            /* Дата */
             1,                              /* Глава */
             FD.FaceFIID(),                  /* Валюта */
             DiscountAdd,                    /* Сумма */
             INPCARRY,                       /* Result_Carry */
             " 1",                           /* Kind_Oper */
             FD.tick.rec.DealCode,           /* Numb_Document */
             "Доначисление дисконта",        /* Ground */
             null,
             null,
             FIROLE_BA,
             NATCUR, FD.FaceFIID()
            ))
          return 1;
    end;
  end;

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           КодКатегорииДисконтОЭБ(FD, dat), "ОЭБ, к исполнению", /* AccDeb , AccCred*/
           dat,                          /* Дата */
           1,                            /* Глава */
           FD.FaceFIID(),                /* Валюта */
           $0,                           /* Сумма */
           INPCARRY,                     /* Result_Carry */
           " 1",                         /* Kind_Oper */
           FD.tick.rec.DealCode,         /* Numb_Document */
           "Перенос остатка дисконта",   /* Ground */
           GETRESTACC_DEBET,
           FIROLE_BA,
           null,
           FD.FaceFIID(), FD.FaceFIID()
          ))
        return 1;
  end;

  if(BonusAdd != 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             КодКатегорииПремияОЭБ(FD, dat), "+Премия, ОЭБ",    /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             FD.FaceFIID(),                    /* Валюта */
             BonusAdd,                         /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Списание части премии в доходы", /* Ground */
             null,
             FIROLE_BA,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;
  end;

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           КодКатегорииПремияОЭБ(FD, dat), "ОЭБ, к исполнению", /* AccDeb , AccCred*/
           dat,                          /* Дата */
           1,                            /* Глава */
           FD.FaceFIID(),                /* Валюта */
           $0,                           /* Сумма */
           INPCARRY,                     /* Result_Carry */
           " 1",                         /* Kind_Oper */
           FD.tick.rec.DealCode,         /* Numb_Document */
           "Перенос остатка премии",     /* Ground */
           GETRESTACC_DEBET,
           FIROLE_BA,
           null,
           FD.FaceFIID(), FD.FaceFIID()
          ))
        return 1;
  end;


  if(DefDiffAdd != 0)
    if(DefDiffAdd > 0)
      FD.SetParmForCateg24828("-Эмиссия, ОЭБ", "02");
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-Эмиссия, ОЭБ", "+КоррАС, ОЭБ",    /* AccDeb , AccCred*/
               dat,                              /* Дата */
               1,                                /* Глава */
               NATCUR,                           /* Валюта */
               DefDiffAdd,                       /* Сумма */
               INPCARRY,                         /* Result_Carry */
               " 1",                             /* Kind_Oper */
               FD.tick.rec.DealCode,             /* Numb_Document */
               "Положительная отсроченная разница", /* Ground */
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
      FD.ResetParmForCateg24828();
    else
      FD.SetParmForCateg24828("+Эмиссия, ОЭБ", "05");
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-КоррАС, ОЭБ", "+Эмиссия, ОЭБ",   /* AccDeb , AccCred*/
               dat,                              /* Дата */
               1,                                /* Глава */
               NATCUR,                           /* Валюта */
               abs(DefDiffAdd),                  /* Сумма */
               INPCARRY,                         /* Result_Carry */
               " 1",                             /* Kind_Oper */
               FD.tick.rec.DealCode,             /* Numb_Document */
               "Отрицательная отсроченная разница", /* Ground */
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
      FD.ResetParmForCateg24828();
    end;
  end;

  // Банк не использует
  if(CorrIntToEIRAdd != 0)
    if(CorrIntToEIRAdd > 0)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "-КоррАС, ОЭБ", "-Корр, ОЭБ",     // AccDeb , AccCred
               dat,                              // Дата
               1,                                // Глава
               NATCUR,                           // Валюта
               CorrIntToEIRAdd,                  // Сумма
               INPCARRY,                         // Result_Carry
               " 1",                             // Kind_Oper
               FD.tick.rec.DealCode,             // Numb_Document
               "Корректировка до амортизированной стоимости, увеличивающая стоимость ц/б", // Ground
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
    else
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
               "+Корр, ОЭБ", "+КоррАС, ОЭБ",     // AccDeb , AccCred
               dat,                              // Дата
               1,                                // Глава
               NATCUR,                           // Валюта
               abs(CorrIntToEIRAdd),             // Сумма
               INPCARRY,                         // Result_Carry
               " 1",                             // Kind_Oper
               FD.tick.rec.DealCode,             // Numb_Document
               "Корректировка до амортизированной стоимости, уменьшающая стоимость ц/б", // Ground
               null,
               null,
               null,
               NATCUR, NATCUR
              ))
            return 1;
      end;
    end;
  end;

  query =   " select t_Sum, t_NDS "
          + "   from ddlsum_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_Kind = " + DLSUM_KIND_OWNAVR_DEALAMORTCOM
          + "    and t_Date = ? ";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    ComissAdd = DataSet.Sum;
    NDSAdd    = DataSet.NDS;
  end;

  ComissAdd = ComissAdd + OutlayAdd;
  NDSAdd    = NDSAdd + VatOutlayAdd;


/*  DAN затраты списываются при размещении
  if(ComissAdd > 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Затраты, ОЭБ", "ЗпоСд, ОЭБ",     /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             NATCUR,                           /* Валюта */
             ComissAdd,                        /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Списание затрат при погашении выпуска", /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
    end;
  end;
 */
  if(NDSAdd > 0)
    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "+НДС", "ЗпоСд, ОЭБ",             /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             NATCUR,                           /* Валюта */
             NDSAdd,                           /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Списание НДС затрат при погашении выпуска", /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "-Налог", "+НДС",                 /* AccDeb , AccCred*/
             dat,                              /* Дата */
             1,                                /* Глава */
             NATCUR,                           /* Валюта */
             NDSAdd,                           /* Сумма */
             INPCARRY,                         /* Result_Carry */
             " 1",                             /* Kind_Oper */
             FD.tick.rec.DealCode,             /* Numb_Document */
             "Отнесение на расходы НДС затрат при погашении выпуска", /* Ground */
             null,
             null,
             null,
             NATCUR, NATCUR
            ))
          return 1;
    end;
  end;

  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
           "ОЭБ, к погашению", "ВнебалСчетОЭБ", /* AccDeb , AccCred*/
           dat,                              /* Дата */
           3,                                /* Глава */
           FD.FaceFIID(),                    /* Валюта */
           FD.dl_leg.rec.Cost,               /* Сумма */
           INPCARRY,                         /* Result_Carry */
           " 1",                             /* Kind_Oper */
           FD.tick.rec.DealCode,             /* Numb_Document */
           "Предъявление облигаций для погашения " + GetFinName(FD.fininstr.rec), /* Ground */
           null,
           null,
           FIROLE_CORACC_ACTIVE,
           FD.FaceFIID(), NATCUR
          ))
        return 1;
  end;
  

  return 0;
end;

//Проводки учёта погашения ц/б
macro БУ_ПроводкиУчетаПогашенияОЭБ( FD, dat, GrDealID )
  var fiw = TRecHandler("fiwarnts.dbt");
  record СчетКорр( account );
  record Счетобяз( account );
  var SumComisRub, SumNDSRub;
  var rq_payinc = NULL, rq_paym = NULL;
  var query, cmd, DataSet, ds, cmd1;
  var OurBankIsTaxAgent = UNSET_CHAR;
  var CatAcc = "";
  var sum = $0, sumTax = $0;
  var ComissAdd = $0, NDSAdd = $0;

 var BondName, BondRegN;
 var sqlFI = "select fi.t_definition, fi.t_name, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " +fd.tick.rec.pfi;
 var cmdFI = DL_RSDCommand();
 var dsFI = cmdFI.Execute(sqlFI);
 if(dsFI.moveNext())
  BondName = IIF(dsFi.value("t_definition") != "", dsFi.value("t_definition"), dsFi.value("t_name")); 
  BondRegN = dsFi.value("t_LSIN");
 end;
  var SumDefDiffAdd = $0;
  var ErrStr = "";
  var isCouponPaymentRefuse: bool = false;
  var stat;
  var UseCouponRefuse;

  //если задан купон, то погашение купона
  if(FD.tick.rec.Number_Coupon != "") 
    if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
      msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
      return 1;
    end;

    GetRegistryValue("COMMON\\WORK_MODE\\USE_COUPON_REFUSE", V_BOOL, UseCouponRefuse, stat);
    if ((stat == 0) and (UseCouponRefuse))
      isCouponPaymentRefuse = (fiw.rec.PaymentRefuse == SET_CHAR);
    end;

    if(FD.ExistRqPayIncome())
      rq_payinc = FD.GetRQ(DLRQ_TYPE_PAYINCOME);
    end;

    if((rq_payinc == NULL) and (not isCouponPaymentRefuse))
      msgbox("Не найдено ТО по выплате дохода");
      return 1;
    end;

    if(FD.avrserv() != NULL)
      OurBankIsTaxAgent = FD.avrserv().rec.TaxAgent; 
    end;

    query =  " select NVL(SUM(t_InterestIncomeAdd), 0) as SumInterestAdd, "
           + "        NVL(SUM(t_DiscountIncomeAdd), 0) as SumDiscountAdd, "
           + "        NVL(SUM(t_BonusAdd), 0) as SumBonusAdd "
           + "   from dpmwrtlnk_dbt "
           + "  where t_SaleID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(FD.pmwrtsum.rec.SumID);
    
    DataSet = cmd.Execute();
    
    if(DataSet.moveNext())

      //Доначисление ПКД
      if((DataSet.SumInterestAdd != 0) and (not isCouponPaymentRefuse))
        var CatCode = "%Расход, ОЭБ";
      
        if((FD.avoiriss.rec.Subordinated == SET_CHAR) and (GetSubordCvalTypeAttrID(FD.fininstr.rec.FIID) == OBJATTR_SUBORDCVALTYPE_DI))
          CatCode = "-Изм.кап., суборд.ОЭБ";
        end;

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             CatCode, "Обяз%, ОЭБ",          /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumInterestAdd,         /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Доначисление ПКД, облигация  " + BondName,
                                             null,
                                             null,
                                             null,
                                             NATCUR, FD.FaceFIID() 
                                           )
            )
          return 1;
        end;
        //DAN *****************************************************************************************************
        if(FD.tick.rec.Flag3 == UNSET_CHAR)  //НЕ досрочное погашение
          var ОстОбяз = $0;
          if( FD.IsExistAccount("Обяз%, ОЭБ", null, true, null, Счетобяз, null, dat))
            OprGetAccountRest( Счетобяз.Chapter, Счетобяз.Code_Currency, Счетобяз.Account, dat, ОстОбяз );
             ОстОбяз = ОстОбяз + DataSet.SumInterestAdd;
          end;
          if (ОстОбяз != 0)
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                               "Обяз%, ОЭБ", "ОЭБ купон, к исполнению", /* Деб , КатегКредит*/
                                            dat,                              /* Дата */
                                            1,                                /* Глава */
                                            FD.FaceFIID(),                    /* Валюта */
                                            ОстОбяз,                               /* Сумма дебет*/
                                            INPCARRY,                         /* Result_Carry */
                                            " 1",                             /* Kind_Oper */
                                            FD.tick.rec.DealCode,             /* Numb_Document */
                                            "Перенос на счет к исполнению при погаш.  купона №" + FD.tick.rec.Number_Coupon + " , обл. " + BondName
                                           ))
              return 1;
            end;
          end; 
        end;
        //DAN ******************************************************************************************************
      end;

      if(DataSet.SumDiscountAdd != 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "%Расход, ОЭБ", КодКатегорииДисконтОЭБ(FD, dat), /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumDiscountAdd,         /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Доначисление дисконта",
                                             null,
                                             null,
                                             null,
                                             NATCUR, FD.FaceFIID() 
                                           )
            )
          return 1;
        end;
        //DAN ******************************************************************************************************
        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                 КодКатегорииДисконтОЭБ(FD, dat), "ОЭБ, к исполнению", /* AccDeb , AccCred*/
                 dat,                          /* Дата */
                 1,                            /* Глава */
                 FD.FaceFIID(),                /* Валюта */
                 $0,                           /* Сумма */
                 INPCARRY,                     /* Result_Carry */
                 " 1",                         /* Kind_Oper */
                 FD.tick.rec.DealCode,         /* Numb_Document */
                 "Перенос остатка дисконта",   /* Ground */
                 GETRESTACC_DEBET,
                 FIROLE_BA,
                 null,
                 FD.FaceFIID(), FD.FaceFIID()
                ))
              return 1;
        end;
        //DAN ******************************************************************************************************
      end;

      if(DataSet.SumBonusAdd != 0)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             КодКатегорииПремияОЭБ(FD, dat), "+Премия, ОЭБ",  /* КатегДеб, КатегКредит*/
                                             dat,                            /* Дата */
                                             1,                              /* Глава */
                                             FD.FaceFIID(),                  /* Валюта */
                                             DataSet.SumBonusAdd,            /* Сумма  */
                                             INPCARRY,                       /* Result_Carry */
                                             " 1",                           /* Kind_Oper */
                                             "",                             /* Numb_Document */
                                             "Списание части премии в доходы",
                                             null,
                                             FIROLE_BA,
                                             null,
                                             FD.FaceFIID(), NATCUR  
                                           )
            )
          return 1;
        end;
      end;
    end;

    if (not isCouponPaymentRefuse) // Нет признака запрета выплаты по купону
        
      if(FD.tick.rec.Flag3 == SET_CHAR) //Погашение досрочное
        CatAcc = "Обяз%, ОЭБ";
      else
        CatAcc = "ОЭБ купон, к исполнению";
      end;

      sum = rq_payinc.rec.Amount;

      if(sum)
        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                 CatAcc, "ДС в КО",            /* AccDeb , AccCred*/
                 dat,                          /* Дата */
                 1,                            /* Глава */
                 NATCUR,                       /* Валюта */
                 iif(FD.FaceFIID() != NATCUR, $0, sum),  /* Сумма */
                 INPCARRY,                     /* Result_Carry */
                 " 1",                         /* Kind_Oper */
                 FD.tick.rec.DealCode,         /* Numb_Document */
                 "Погашение купона. №" + FD.tick.rec.Number_Coupon + " при погашении обл. " + BondName  ,   /* Ground */
                 iif(FD.FaceFIID() != NATCUR, GetRestAcc_Debet, null),
                 null,
                 null,
                 FD.FaceFIID(), NATCUR
                ))
              return 1;
        end;
      end;

      if(OurBankIsTaxAgent == SET_CHAR) //Наш Банк является налоговым агентом по выпуску

        sumTax = 0;
        if(FD.ExistsRQ(DLRQ_TYPE_TAX_ULN))
          sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_ULN).rec.Amount;
        end;
      
        /*DAN*/
        var rqaccTax = TRecHandler("dlrqacc.dbt");
        var accbufTax = TRecHandler("account.dbt");
    
        if (ПолучитПлатежныеРеквизитыПоТО(rq_payinc, rqaccTax))
          //return SayError(1, "Ошибка при получении реквизитов");
        end;
        if (ПолучитьСчетПоПлатежнымРеквизитам(rqaccTax, accbufTax))
          //return SayError(1, "Ошибка при получении счета");
        end;

        var catTax = accbufTax;
        /*DAN*/

        if(sumTax)
          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                   CatAcc, "-Бюджет, ф.налоги, ULN",  /* AccDeb , AccCred*/
                   dat,                          /* Дата */
                   1,                            /* Глава */
                   NATCUR,                       /* Валюта */
                   sumTax,                       /* Сумма */
                   INPCARRY,                     /* Result_Carry */
                   " 1",                         /* Kind_Oper */
                   FD.tick.rec.DealCode,         /* Numb_Document */
                   "Удержание налога (юр.лица нерезиденты), " + GetFinName(FD.fininstr.rec), /* Ground */
                   null,
                   null,
                   null,
                   FD.FaceFIID(), NATCUR
                  ))
                return 1;
          end;
        end;

        sumTax = 0;
        if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLR))
          sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLR).rec.Amount;
          sumTax = round(sumTax, 0);
        end;

        if(sumTax)

          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                   CatAcc, "НДФЛ к перечислению, FLR"/*"НДФЛ к перечислению"*/,/* AccDeb , AccCred*/
                   dat,                          /* Дата */
                   1,                            /* Глава */
                   NATCUR,                       /* Валюта */
                   sumTax,                       /* Сумма */
                   INPCARRY,                     /* Result_Carry */
                   " 1",                         /* Kind_Oper */
                   FD.tick.rec.DealCode,         /* Numb_Document */
                   "Удержание налога (физ.лица резиденты)," + GetFinName(FD.fininstr.rec), /* Ground */
                   null,
                   null,
                   null,
                   FD.FaceFIID(), NATCUR
                  ))
                return 1;
          end;
        end;

        sumTax = 0;
        if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLR_ADD))
          sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLR_ADD).rec.Amount;
          sumTax = round(sumTax, 0);
        end;

        if(sumTax)

          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                   CatAcc, "НДФЛ к перечислению 15%",/* AccDeb , AccCred*/
                   dat,                          /* Дата */
                   1,                            /* Глава */
                   NATCUR,                       /* Валюта */
                   sumTax,                       /* Сумма */
                   INPCARRY,                     /* Result_Carry */
                   " 1",                         /* Kind_Oper */
                   FD.tick.rec.DealCode,         /* Numb_Document */
                   "Удержание налога",           /* Ground */
                   null,
                   null,
                   null,
                   FD.FaceFIID(), NATCUR
                  ))
                return 1;
          end;
        end;

        var RedistrMainTax = $0, RedistrTax15 = $0;
        ОЭБ_ПолучитьПераспределенныеСуммыНалога(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, @RedistrMainTax, @RedistrTax15);

        if(RedistrMainTax != 0)
          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                   IIF(RedistrMainTax > 0, CatAcc, "НДФЛ к перечислению"), IIF(RedistrMainTax > 0, "НДФЛ к перечислению", CatAcc),/* AccDeb , AccCred*/
                   dat,                          /* Дата */
                   1,                            /* Глава */
                   NATCUR,                       /* Валюта */
                   abs(RedistrMainTax),          /* Сумма */
                   INPCARRY,                     /* Result_Carry */
                   " 1",                         /* Kind_Oper */
                   FD.tick.rec.DealCode,         /* Numb_Document */
                   "Перераспределение сумм налога. " + IIF(RedistrMainTax > 0, "Удержание", "Возврат"),           /* Ground */
                   null,
                   null,
                   null,
                   FD.FaceFIID(), NATCUR
                  ))
                return 1;
          end;
        end;

        if(RedistrTax15 != 0)
          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                   IIF(RedistrTax15 > 0, CatAcc, "НДФЛ к перечислению 15%"), IIF(RedistrTax15 > 0, "НДФЛ к перечислению 15%", CatAcc),/* AccDeb , AccCred*/
                   dat,                          /* Дата */
                   1,                            /* Глава */
                   NATCUR,                       /* Валюта */
                   abs(RedistrTax15),            /* Сумма */
                   INPCARRY,                     /* Result_Carry */
                   " 1",                         /* Kind_Oper */
                   FD.tick.rec.DealCode,         /* Numb_Document */
                   "Перераспределение сумм налога. " + IIF(RedistrTax15 > 0, "Удержание", "Возврат"),           /* Ground */
                   null,
                   null,
                   null,
                   FD.FaceFIID(), NATCUR
                  ))
                return 1;
          end;
        end;

        sumTax = 0;
        if(FD.ExistsRQ(DLRQ_TYPE_TAX_FLN))
          sumTax = sumTax + FD.GetRQ(DLRQ_TYPE_TAX_FLN).rec.Amount;
          sumTax = round(sumTax, 0);
        end;

        if(sumTax)

          if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                   CatAcc, "НДФЛ к перечислению, FLN"/*"НДФЛ к перечислению.нерез"*/,/* AccDeb , AccCred*/
                   dat,                          /* Дата */
                   1,                            /* Глава */
                   NATCUR,                       /* Валюта */
                   sumTax,                       /* Сумма */
                   INPCARRY,                     /* Result_Carry */
                   " 1",                         /* Kind_Oper */
                   FD.tick.rec.DealCode,         /* Numb_Document */
                   "Удержание налога (физ.лица нерезиденты)," + GetFinName(FD.fininstr.rec), /* Ground */
                   null,
                   null,
                   null,
                   FD.FaceFIID(), NATCUR
                  ))
                return 1;
          end;
        end;

      end;
    end;
  end;

  if(FD.tick().rec.Flag3 == SET_CHAR) //Погашение досрочное


    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             КодКатегорииДисконтОЭБ(FD, dat), "ДС в КО",    /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             $0,                           /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Перенос остатка дисконта",   /* Ground */
             GETRESTACC_DEBET,
             FIROLE_BA,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             КодКатегорииРазмещОЭБ(FD, dat), "ДС в КО",    /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             $0,                           /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Перенос остатка размещения", /* Ground */
             GETRESTACC_DEBET,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             КодКатегорииПремияОЭБ(FD, dat), "+Премия, ОЭБ",    /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             FD.FaceFIID(),                /* Валюта */
             $0,                           /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Списание премии",            /* Ground */
             GETRESTACC_DEBET,
             null,
             null,
             FD.FaceFIID(), NATCUR
            ))
          return 1;
    end;

  else //Погашение не досрочное

    sum = FD.dl_leg.rec.Principal * FD.FaceValue();

    if(sum)
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                 "ВнебалСчетОЭБ", "ОЭБ, к погашению", /* AccDeb , AccCred*/
                 dat,                          /* Дата */
                 3,                            /* Глава */
                 FD.FaceFIID(),                /* Валюта */
                 sum,                          /* Сумма */
                 INPCARRY,                     /* Result_Carry */
                 " 1",                         /* Kind_Oper */
                 FD.tick.rec.DealCode,         /* Numb_Document */
                 "Списание погашенных облигаций с внебалансового учета ," + GetFinName(FD.fininstr.rec), /* Ground */
                 null,
                 FIROLE_CORACC_ACTIVE,
                 null,
                 NATCUR, FD.FaceFIID()
                ))
              return 1;
      end;
    end;

  if(sum)
      var RestType = null;
      if(FD.FaceFIID() != NATCUR)
        sum = $0;
        RestType = GetRestAcc_Debet;
      end;
      

    if( not БУ_ПроводкаПоКатегориямУчета( FD, 
             "ОЭБ, к исполнению", "ДС в КО",            /* AccDeb , AccCred*/
             dat,                          /* Дата */
             1,                            /* Глава */
             natcur,    
             sum,                          /* Сумма */
             INPCARRY,                     /* Result_Carry */
             " 1",                         /* Kind_Oper */
             FD.tick.rec.DealCode,         /* Numb_Document */
             "Исполнение обязательств Банка по выплате номинала при погашении обл. " + GetFinName(FD.fininstr.rec), /* Ground */ 
             RestType,
             null,
             null,
          //   FD.FaceFIID(), FD.dl_leg.rec.PayFIID
             FD.FaceFIID() , NATCUR   
            ))
          return 1;
    end;
   end;

    sum = FD.dl_leg.rec.ReceiptAmount * FD.FaceValue();
    if(sum)
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "ВнебалСчетОЭБ", "Выкуп, ОЭБ", /* КатегДеб , КатегКредит*/
                                           dat,                               /* Дата */
                                           3,                                 /* Глава */
                                           FD.FaceFIID(),                     /* Валюта */
                                           sum,                               /* Сумма  */
                                           INPCARRY,                          /* Result_Carry */
                                           " 1",                              /* Kind_Oper */
                                           "",                                /* Numb_Document */
                                           "Списание ранее выкупленных облигаций с внебалансового учета," + GetFinName(FD.fininstr.rec), /* Ground */
                                           null,
                                           FIROLE_CORACC_ACTIVE,
                                           null,
                                           NATCUR, FD.FaceFIID() 
                                         )
        )
        return 1;
      end;
    end;
  end;

  if( FD.IsExistAccount("-Корр, ОЭБ", null, true, null, СчетКорр, MC_PAIRACCMODE_MANUAL, dat))

    Sum = ABS(GetRestAccount(СчетКорр, dat));

    if(Sum != $0)
      FD.SetParmForCateg24828("+Эмиссия, ОЭБ", "05");
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           СчетКорр, "+Эмиссия, ОЭБ",       /* КатегДеб, КатегКредит*/
                                           dat,                             /* Дата */
                                           1,                               /* Глава */
                                           NATCUR,                          /* Валюта */
                                           Sum,                             /* Сумма  */
                                           INPCARRY,                        /* Result_Carry */
                                           " 1",                            /* Kind_Oper */
                                           "",                              /* Numb_Document */
                                           "Списание корректировок по погашенным ОЭБ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
      FD.ResetParmForCateg24828();
    end;
  end;

  if( FD.IsExistAccount("+Корр, ОЭБ", null, true, null, СчетКорр, MC_PAIRACCMODE_MANUAL, dat))

    Sum = ABS(GetRestAccount(СчетКорр, dat));

    if(Sum != $0)
      FD.SetParmForCateg24828("-Эмиссия, ОЭБ", "02");
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Эмиссия, ОЭБ", СчетКорр,       /* КатегДеб, КатегКредит*/
                                           dat,                             /* Дата */
                                           1,                               /* Глава */
                                           NATCUR,                          /* Валюта */
                                           Sum,                             /* Сумма  */
                                           INPCARRY,                        /* Result_Carry */
                                           " 1",                            /* Kind_Oper */
                                           "",                              /* Numb_Document */
                                           "Списание корректировок по погашенным ОЭБ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
      FD.ResetParmForCateg24828();
    end;
  end;

  query =   " select t_Sum, t_NDS "
          + "   from ddlsum_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_Kind = " + DLSUM_KIND_OWNAVR_DEALAMORTCOM
          + "    and t_Date = ? ";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(FD.tick.rec.BOfficeKind);
  cmd.AddParam(FD.tick.rec.DealID);
  cmd.AddParam(dat);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    ComissAdd = DataSet.Sum;
    NDSAdd    = DataSet.NDS;
  end;

  query =   " select NVL(SUM(t_OutlayBuy-t_WrtOutlayBuy), 0) as SumOutlayAdd, "
          + "        NVL(SUM(t_VatOutlayChange-t_WrtVatOutlayBuy), 0) as SumVatOutlayAdd, "
          + "        NVL(SUM(t_AccountedDefDiffAdd), 0) as SumDefDiffAdd "
          + "   from dpmwrtlnk_dbt "
          + "  where t_SaleID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(FD.pmwrtsum.rec.SumID);
  
  DataSet = cmd.Execute();
  
  if(DataSet.moveNext())
    ComissAdd = ComissAdd + DataSet.SumOutlayAdd;
    NDSAdd    = NDSAdd + DataSet.SumVatOutlayAdd;

    SumDefDiffAdd = DataSet.SumDefDiffAdd;
  end;

    //Списание затрат по погашаемым ОЭБ на расходы
    if(ComissAdd != 0)
      
      Sum = ComissAdd;
      if(FD.FaceFIID() != NATCUR)
        if( not SmartConvertSum( Sum, Sum, dat, FD.FaceFIID(), NATCUR, true))
          return 1;
        end;
      end;
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           IIF(FD.tick.rec.Flag3 == SET_CHAR, "-Маржа, проч.", "Затраты, ОЭБ"), "ЗпоСд, ОЭБ",  /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           $0 /* Sum*/,                    /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание затрат по погашаемым ОЭБ на расходы," + GetFinName(FD.fininstr.rec), /* Ground */
                                           GETRESTACC_CREDIT,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание НДС затрат по погашаемым ОЭБ на расходы !!!
    if(NDSAdd != 0)
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "+НДС", "ЗпоСд, ОЭБ",           /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           NDSAdd,                         /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Списание НДС затрат по погашаемым ОЭБ на расходы",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "-Налог", "+НДС",               /* КатегДеб, КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           DataSet.SumVatOutlayAdd,        /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Перечисление НДС по погашаемым ОЭБ",
                                           null,
                                           null,
                                           null,
                                           NATCUR, NATCUR  
                                         )
          )
        return 1;
      end;
    end;

    //Списание отсроченной разницы по выкупленным ОЭБ
  if(SumDefDiffAdd != 0)
      
    if(SumDefDiffAdd > 0)
        FD.SetParmForCateg24828("-Эмиссия, ОЭБ", "02");
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-Эмиссия, ОЭБ", "+КоррАС, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                           SumDefDiffAdd,                   /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Положительная отсроченная разница",
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
        FD.ResetParmForCateg24828();
      else
        FD.SetParmForCateg24828("+Эмиссия, ОЭБ", "05");
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             "-КоррАС, ОЭБ", "+Эмиссия, ОЭБ", /* КатегДеб, КатегКредит*/
                                             dat,                             /* Дата */
                                             1,                               /* Глава */
                                             NATCUR,                          /* Валюта */
                                           abs(SumDefDiffAdd),              /* Сумма  */
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Отрицательная отсроченная разница",
                                             null,
                                             null,
                                             null,
                                             NATCUR, NATCUR  
                                           )
            )
          return 1;
        end;
        FD.ResetParmForCateg24828();
      end;
    end;
  // end;
  
  return 0;
end;

macro БУ_ПроводкиИзмененияУсловийОЭБ( FD, dat, GrDealID )
  var saveFD:SPFirstDoc;
  var chngFD:SPFirstDoc;

  LoadSpTkChangeData(FD, NULL, GrDealID);

  /*состояние до изменений*/
  saveFD  = SPFirstDoc(GetSaveDlTick,  FD.IsBack, false, GetSaveDlLeg);
  saveFD.SetCurPFI(saveFD.CurPFI());

  /*состояние после изменений*/
  chngFD  = SPFirstDoc(GetSpChangeDlTick,  FD.IsBack, false, GetSpChangeDlLeg);
  chngFD.SetCurPFI(chngFD.CurPFI());

  if(saveFD.dl_leg.rec.TotalCost != chngFD.dl_leg.rec.TotalCost) 
     /*скорректируем суммы на внебалансе*/
     if( БУ_ПоставитьНаВнебалансОЭБ(FD, dat, (chngFD.dl_leg.rec.TotalCost-saveFD.dl_leg.rec.TotalCost), GrDealID) != 0 )
        return 1;
     end;
  end;

  return 0;
end;

macro БУ_ПроводкиПризнанияПФИОЭБ( FD, dat, GrDealID )
  var query, cmd, DataSet;
  var Amount = 0;
  var BondName, BondRegN;
  var sqlFI = "select fi.t_definition, fi.t_name, av.t_lsin from dfininstr_dbt fi, davoiriss_dbt av where av.t_fiid = fi.t_fiid and fi.t_fiid = " +fd.tick.rec.pfi;
  var cmdFI = DL_RSDCommand();
  var dsFI = cmdFI.Execute(sqlFI);
  if(dsFI.moveNext())
   BondName = IIF(dsFi.value("t_definition") != "", dsFi.value("t_definition"), dsFi.value("t_name")); 
   BondRegN = dsFi.value("t_LSIN");       // PDV 520707
  end;
  query =   " select NVL(SUM(lot.t_Amount),0) sumAmount "
          + "   from v_scwrthistex lot "
          + "  where lot.t_ID_Operation = ? "
          + "    and lot.t_ID_Step = -1 "
          + "    and lot.t_FIID = ? "
          + "    and lot.t_Action = " + PM_WRTSUM_UPDTMODE_CREATE
          + "    and lot.t_Kind = " + PM_WRTSUM_KIND_DSTR;

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ПроводкиБУ.GetServDocID());
  cmd.AddParam(ПроводкиБУ.GetCurrAvrFIID());

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    Amount = DataSet.sumAmount;
  end;

  if(Amount > 0)
    query =   " select ROUND(Rsb_FIInstr.ConvSum(fr.t_OneItemFv*?, fr.t_Currency, "+NATCUR+", ?), 2) sumNat, "
            + "        ROUND(Rsb_FIInstr.ConvSum(fr.t_OneItemFv*?, fr.t_Currency, fin.t_FaceValueFI, ?), 2) sumFV "
            + "   from dfininstr_dbt fin, dbiofrval_dbt fr "
            + "  where fin.t_FIID = ? "
            + "    and fr.t_FIID = fin.t_FIID "
            + "    and fr.t_Date = (select MAX(fr1.t_Date)  "
            + "                       from dbiofrval_dbt fr1 "
            + "                      where fr1.t_FIID = fr.t_FIID "
            + "                        and fr1.t_Date <= ? "
            + "                    ) ";
      
    cmd = DL_RSDCommand(query);

    cmd.AddParam(FD.dl_leg.rec.principal);
    cmd.AddParam(dat);
    cmd.AddParam(FD.dl_leg.rec.principal);
    cmd.AddParam(dat);
    cmd.AddParam(ПроводкиБУ.GetCurrAvrFIID());
    cmd.AddParam(dat);

    DataSet = cmd.Execute();

    if((DataSet.moveNext()) and (DataSet.sumNat > 0))

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           КодКатегорииРазмещОЭБ(FD, dat), "-ПФИ ОЭБ",       /* КатегДеб, КатегКредит*/
                                           dat,                             /* Дата */
                                           1,                               /* Глава */
                                           NATCUR,                          /* Валюта */
                                           money(DataSet.sumNat),           /* Сумма  */
                                           INPCARRY,                        /* Result_Carry */
                                           " 1",                            /* Kind_Oper */
                                           "",                              /* Numb_Document */
                                           "Отражение признания ПФИ " + GetFinName(FD.fininstr.rec) +  ", госрег " + BondRegN + " по сделке " + FD.tick.rec.dealcode ,     /* PDV 520707 */
                                           null,
                                           null,
                                           null,
                                           FD.FaceFIID(), NATCUR,
                                           FD.FaceFIID(), money(DataSet.sumFV)  
                                         )
          )
        return 1;
      end;
    end;
  end;

  return 0;
end;