/*
$Name:        sptagfl.mac
$Module:      Ценные бумаги
$Description: Заполнение общих тэгов для шаблонов договоров и подтверждений по сделкам
*/
const ERROR  = 1;
/*const Path   = "../mac/dlng/secur/templs/";*/
const AGENT_SUBKIND = 2; /*подвид агентский*/
const CB_RF = 45;        /*ЦБ РФ*/

import SecInter, "dlcnst.inc", "SpRepFun.mac", "adress.mac";

/* дополнение строки слева нулями до нужной длины,
   если длина строки больше нужной, строка обрезается слева
*/ 
macro SP_StrTrimLeft( num, len )
var
   s=trim(string(num)),
   l=strlen(s);

   if(l==len)
      /*возвращаем без изменений*/;
   elif (l>len)
      /*обрезаем*/
      s=SubStr(s,l-len+1,len);          
   else
      /*дополняем*/
      s=mkstr("0",len-l)+s;
   end;

   return s;
end;

macro CreateFileName()
   return GetTxtFileName ("tmpout");
end;

macro GetProxy( FD, ContractParty, prx)
   ClearRecord(prx);
   prx.DocKind    = DL_SECURLEG;
   prx.ContractID = FD.dl_leg.rec.Id;
   prx.ContractParty = ContractParty;
   prx.ProxyRole  = DL_PROXY_BOSS;
   if(GetEQ(prx) == false)
     return 1;
   end;
   return 0;
end;


PRIVATE MACRO GetPartyName( PartyID:INTEGER ) :STRING
  VAR Party = TRecHandler( "party.dbt" );

  if( ПолучитьСубъекта( PartyID, Party ) == 0 )
     return Party.rec.Name;
  end;
  return "";
end;

macro ПолучитьТипЦБ( AvrTypeID )
   file avrkinds( avrkinds );
   var  Name = "";
   if( AvrTypeID )
     avrkinds.FI_Kind   = FIKIND_AVOIRISS;
     avrkinds.AvoirKind = AvrTypeID;
     if( GetEQ(avrkinds) )  
       Name = avrkinds.Name;
     end;
   end;
   return Name;
end;

macro PercToStr( Str )
   var last, first;
   var temp = money(Str);
   CurToStrAlt(temp, first, last, 0); 
   return (first + " целых " + last + " сотых процента");
end;

macro CheckData ( Data )
   var str;
   if( ValType( Data ) == V_DATE)
     if(Data == Date(0,0,0))
       return str = ("\"___\"" + " _________ " + "20__ ");
     else
       return Data;
     end;
   elif(ValType( Data ) == V_STRING)
     if(Data == "")
       return str = "________________________";
     else
       return Data;
     end;
   else
     if( not Data )
       return str = "________";
     else
       return Data;
     end;
   end;
end;

macro GetRegDoc(PartyID)

  file objrgdoc(objrgdoc) key 1;
  file objkdoc(objkdoc) key 0;
  var str = " ";

  ClearRecord(objrgdoc);
  objrgdoc.ObjectType   = OBJTYPE_PARTY;
  objrgdoc.RegPartyKind = REGPT_CENTRALBANK;
  objrgdoc.RegDocKind   = OBJKDOC_GENERAL_LICENCE;
  objrgdoc.ObjectID     = PartyID;

  if (GetEQ(objrgdoc))
     ClearRecord(objkdoc);
     objkdoc.ObjectType = objrgdoc.ObjectType;
     objkdoc.RegDocKind = objrgdoc.RegDocKind;
     if(GetEQ(objkdoc))
        str = CheckData(objkdoc.Name) + " № " + CheckData(objrgdoc.Series) + "/" +
              CheckData(objrgdoc.Number) + " от " + 
              CheckData (string(objrgdoc.StartDate)) + " выдано ЦБ РФ" ;
        return str;
     end;
  end;

  return str;
end;

macro ПолучитьПодвидОбслуживания( Contract )
  file SKS(servksub);
  ClearRecord(SKS);
  SKS.ServiceKind    = Contract.ServKind;
  SKS.ServiceKindSub = Contract.ServKindSub;
  if(GetEQ(SKS) == true)
    return SKS.Name;
  else
    return "";
  end;
end;

macro GetRate( FD )
  var Rate = $0;
  var PriceConvert = $0;
  if( FD.dl_leg.rec.RelativePrice == "" ) /*Валюта сделки не задана в процентах*/
     if( FD.FaceValueMoney == 0 )
        msgbox("Не задан номинал ц/б ", FD.fininstr.rec.Name);
        return 0;
     end;
     SmartConvertSum(PriceConvert, money(FD.dl_leg.rec.Price), FD.tick.rec.DealDate, FD.pm_money_.rec.FIID, FD.fininstr.rec.FaceValueFI);  /*IAL 19 April 2005*/
     if( FD.FaceValueDealDt != 0 )
        Rate = ((PriceConvert/FD.FaceValueDealDt)*100);
     else
        Rate = 0;
     end;
  else
     Rate = (FD.dl_leg.rec.Price);
  end;

  return Rate;
end;

/********************** Представители сторон в сделке ********************/

macro Representatives_Of_Sides(Deal, IsBack) 
   record Party(party);
   record PartyOwn(party);
   record RecordAdress ( adress );
   file Proxy(dl_proxy);
   file spg(spground);
   file Inst(institut);
   record Contract(sfcontr);
   record SfContr(sfcontr);

   var prefix_side;  /*кем является сторона в сделке*/
   var prefix_our;   /*Кем в сделке являемся мы*/
   var Caption = "", BankAutority, ContrID = 0;
   var Registr, DuePartyID, OK = true;
   var PhoneNumber = "", Fax = "";

   var FD = SPFirstDoc(Deal, IsBack);

   if( ((GetDealBuySale( Deal ) == DEAL_TYPE_BUY) AND (not FD.IsBack)) OR
        (GetDealBuySale( Deal ) == DEAL_TYPE_SALE) AND (FD.IsBack)) /*Мы покупаем бумаги*/
     prefix_side = "Seller";
     prefix_our = "Purchaser";
   else
     prefix_side = "Purchaser";
     prefix_our = "Seller";
   end;

 /****************************** Для контрагента или клиента *****************************/

   if( ((GetDealBuySale( Deal ) == DEAL_TYPE_BUY) AND (not FD.IsBack)) OR
       (GetDealBuySale( Deal ) == DEAL_TYPE_SALE) AND (FD.IsBack)) 
      /* Представитель контрагента */
      if(GetProxy( FD, DLPROXY_CONTRACTOR, Proxy))
        ClearRecord(Proxy);  /*Если представитель не найден, то зануляем поля, чтобы и остальные параметры
                            которые ищутся по proxy случайно не нашлись */
      end;
   else
      /* Представитель клиента */
       if(GetProxy( FD, DLPROXY_CLIENT, Proxy))
         ClearRecord(Proxy);  /*Если представитель не найден, то зануляем поля, чтобы и остальные параметры
                                которые ищутся по proxy случайно не нашлись */
       end;
   end;

   println("~" + string(prefix_side) + "ProxyNameShort");  
   println(CheckData(Proxy.AgentName));
   /*Представитель стороны*/
   println("~" + string(prefix_side) + "ProxyName");  
   println(CheckData(Proxy.AgentName));
   /*Должность представителя стороны*/
   println("~" + string(prefix_side) + "ProxyAuthority"); 
   println(CheckData(Proxy.AgentPost));

   clearrecord(spg);
   spg.SpgroundID = Proxy.ProxyID;
   GetEQ(spg);

   /*Документ на основании которого действует представитель*/
   println("~" + string(prefix_side) + "ProxyMandateCaption"); 
   DL_GetValueName( OBJTYPE_KINDDOC, spg.Kind, Caption );
   println(CheckData(Caption) + " № " + CheckData(spg.AltXld) + 
           " от " + CheckData(spg.SignedDate));
   /*Полные данные представителя стороны*/
   println("~" + string(prefix_side) + "ProxyTotal");  
   println(CheckData(Proxy.AgentPost) + " " + CheckData(Proxy.AgentName) +
           ", действующего(ей) на основании "+ CheckData(Caption) + " № " +
           CheckData(spg.AltXld) + " от " + CheckData(spg.SignedDate));
  

   /*Адрес (с индексом) контрагента*/
 /*  println("~" + string(prefix_side) + "Address");      
   println(Party.PostIndex + Party.Address);*/

   /************************** Для нашего банка ****************************/

   /* Представитель нашего банка */
   if(GetProxy( FD, DLPROXY_OURBANK, Proxy))
     ClearRecord(Proxy);  /*Если представитель не найден, то зануляем поля, чтобы и остальные параметры
                            которые ищутся по proxy случайно не нашлись */
   end;

   clearrecord(spg);
   spg.SpgroundID = Proxy.ProxyID;
   GetEQ(spg);

   /* Должность представителя нашего банка*/
   println("~" + string(prefix_our) + "ProxyAuthority"); 
   println(CheckData(Proxy.AgentPost));

   /* Наш босс как представитель ФИО*/
   println("~" + string(prefix_our) + "ProxyName");  
   println(CheckData(Proxy.AgentName));

   /* Наш босс как представитель ФИО*/
   println("~" + string(prefix_our) + "ProxyNameShort"); 
   println(CheckData(Proxy.AgentName));

   /*документ, на основании которого действует представитель нашего банка*/
   println("~" + string(prefix_our) + "ProxyMandateCaption");  
   DL_GetValueName( OBJTYPE_KINDDOC, spg.Kind, Caption );
   println(CheckData(Caption) + " № " + CheckData(spg.AltXld) + 
           " от " + CheckData(spg.SignedDate));

   /*Полные данные представителя нашего банка*/
   println("~" + string(prefix_our) + "ProxyTotal");  
   println(CheckData(Proxy.AgentPost) + " " + CheckData(Proxy.AgentName) +
           ", действующего(ей) на основании "+ CheckData(Caption) + " № " +
           CheckData(spg.AltXld) + " от " + CheckData(spg.SignedDate));

   /*********************** По договорам обслуживания *******************/
   ClearRecord(SfContr);
   if( IsClientDeal(Deal) )
     if(ПолучитьДоговорПоСделке( Deal, SfContr, true ) == false)
       OK = false;
     end;
   end;
   /*Дата договора*/
   println("~Ord_date");
   if(OK == true)
     println(CheckData(SfContr.DateBegin));
   else 
     println(CheckData(""));
   end;
   /*За счет кого совершается сделка*/
   println("~Due_To");
   if( IsClientDeal(Deal) AND (OK == true))
     if(SfContr.ServKindSub == AGENT_SUBKIND) /* за счет нашего банка*/
       DuePartyID = {OurBank};
     else                            /*за счет клиента*/
       DuePartyID = Deal.ClientID;
     end;
   else
     DuePartyID = {OurBank};
   end;
   ПолучитьСубъекта( DuePartyID, Party );
   println(CheckData(Party.ShortName));
   /*Вид договора обслуживания*/
   println("~Ord_kind");
   if( IsClientDeal(Deal) AND (OK == true))
     println(CheckData(ПолучитьПодвидОбслуживания( SfContr )));
   else 
     println(CheckData(""));
   end;
   /*номер договора обслуживания*/
   println("~Ord_num");
   if( IsClientDeal(Deal) AND (OK == true))
      println(CheckData(SfContr.Number));
   else 
     println(CheckData(""));
   end;
   OK = true;
   /*Договор с регистратором*/
   println("~Depo_ord");
   if(FD.dl_leg.rec.Registrar > 0)
     SP_GetSfContrIDbyPartyID( Deal.DealDate, FD.dl_leg.rec.Registrar, ContrID );
     if(ContrID > 0)
       SfGetContr(contrID, Contract);
       println("Депозитарный договор № " + CheckData(Contract.Number) + " от " +
              CheckData(Contract.DateBegin));
     end;
   end;
   /*Ответственный за регистацию*/
   println("~RegistOwn");
   if(FD.dl_leg.rec.PayRegTax == SET_CHAR)
     Registr = {OurBank};
   else
     Registr = Deal.PartyID;
   end;
   ПолучитьСубъекта( Registr, Party );
   println(CheckData(Party.ShortName));

   /**************************** НАШ БАНК ******************************/
   /*Наименование нашего банка*/
   println("~НашБанк");
   ПолучитьСубъекта( {OurBank}, PartyOwn );
   ClearRecord(RecordAdress);
   НайтиЮридическийАдресСубъекта(PartyOwn.PartyID,RecordAdress);
   println(CheckData(PartyOwn.Name));
   /*Телефон*/
   FindAdressContactValue(PartyOwn.PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber);
   println("~НашБанкTel");
   println(CheckData(PhoneNumber));
   /*Факс*/
   FindAdressContactValue(PartyOwn.PartyID, PTADDR_LEGAL, CNTADR_FAX, Fax);
   println("~НашБанкFax");
   println(CheckData(Fax));
   /*Представитель нашего банка*/
   GetProxy( FD, DLPROXY_OURBANK, Proxy);
   println("~НашБанкProxy");
   println(CheckData(Proxy.AgentName));

   /*наш банк адрес*/
   println("~НашБанкАдрес");
   println(CheckData(RecordAdress.PostIndex) + " " + CheckData(RecordAdress.Adress));


   return 0;
end;

/**************************** ПРЕДМЕТ СДЕЛКИ  *************************/
macro Object_of_Deal(Deal, IsBack)
   
   record Currency(fininstr);
   record FaceValueFI(fininstr);
   record fFiwarnts( fiwarnts );
   record rParty( party );
   record Sptk( Sptkchng );

   var FaceValueAll = $0, Price = $0, Perc_Repo, PriceBack = $0, 
       Rate = $0;
   var SumFirst = $0, SumLast = $0, Cource = 0, Group, point = 0;
   var FD1;
   
   var FD = SPFirstDoc(Deal); /*Первичный документ по сделке*/

/********************** Для обратной части сделки ***********************************/

   if(FD.ExistBack)  /*В сделке существует обратная часть*/
      
      FD = SPFirstDoc(Deal, true);   /*Первичный документ для обратной части*/
      SP_GetDealParmsByDate( Deal, Deal.DealDate, Sptk, false, true );
      FD.dl_leg.rec.pfi = Sptk.oldpfi1; 
      ПолучитьФинИн( FD.dl_leg.rec.CFI, Currency );

      /* Ставка по сделкам Репо*/
      println("~Perc_Repo");    
      Perc_Repo = money(FD.dl_leg.rec.IncomeRate);
      println(CheckData(Perc_Repo));
      /* Ставка по сделкам Репо прописью*/
      println("~Perc_RepoWr");  
      println(CheckData(PercToStr(FD.dl_leg.rec.IncomeRate)));
      /* цена в процентах от номинала */
      println("~Rate_back");         
      println(CheckData(GetRate(FD):m));
      /*валюта цены ценной бумаги*/
      println("~FiPriceBack");         
      println(CheckData(Currency.Name));

      /*Сумма договора без НКД для обратной сделки*/
      println("~SummWithoutNKDBack");      
      println(CheckData(FD.dl_leg.rec.Cost));
      /*Сумма договора без НКД прописью для обратной сделки*/
      println("~SummWithoutNKDBackWr");    
      println(CheckData(CurToStrAlt (FD.dl_leg.rec.Cost, NULL, NULL, Currency.ISO_Number)));
      /*Сумма договора с НКД для обратной сделки*/
      println("~SummWithNKDBack");      
      println(CheckData(FD.dl_leg.rec.TotalCost));
      /*Сумма договора с НКД прописью для обратной сделки*/
      println("~SummWithNKDBackWr");    
      println(CheckData(CurToStrAlt (FD.dl_leg.rec.TotalCost, NULL, NULL, Currency.ISO_Number)));
      /*Сумма обратной сделки */
      println("~Summ_Back");      
      println(CheckData(FD.dl_leg.rec.TotalCost));
      /*Сумма обратной сделки  прописью*/
      println("~Summ_BackWr");    
      println(CheckData(CurToStrAlt (FD.dl_leg.rec.TotalCost, NULL, NULL, Currency.ISO_Number)));

      /*Валюта платежа для обратной сделки*/
      println("~Fi_dealBack");          
      println( CheckData(ПолучитьИмяФинИн ( FD.pm_money_.rec.FIID )));

      /*Дата поставки ц/б*/
      println("~DateDelievBack");   
      println(CheckData(FD.DateArray[DATE_DEALSETAVOIRISS_PLAN]));
      /*Дата платежа по ц/б*/
      println("~PaymentDateBack");  
      println(CheckData(FD.DateArray[DATE_DEALPAY_PLAN]));
      /*Тип расчетов*/
      println("~Type_SetBack");
      println(CheckData(GetTypeAc( 155, StrFor(FD.dl_leg.rec.Formula) ) ));   /*155 - типы расчетов*/
      /*Сумма аванса по обратной части сделки*/
      println("~Summ_Adv_Back");
      if(FD.ExistAvance)
        println(CheckData(FD.pm_avance.rec.Amount));
      else
        println(CheckData(0));
      end;
      /*Сумма обратной сделки без аванса*/
      println("~DeltaSummAdvBack");
      if(FD.ExistAvance)
         println(CheckData(FD.dl_leg.rec.TotalCost - FD.pm_avance.rec.Amount));
      else
         println(CheckData(FD.dl_leg.rec.TotalCost));
      end;
      
   end;

/********************** Для текущей части сделки ***********************************/

   FD = SPFirstDoc(Deal, IsBack);
   SP_GetDealParmsByDate( Deal, Deal.DealDate, Sptk, false, true );
   FD.dl_leg.rec.pfi = Sptk.oldpfi1; 

   println("~Date_deal");
   println(FD.GetParametr(MC_TYPE_PARAMETR_BEGDATE));

   ПолучитьФинИн( FD.dl_leg.rec.CFI, Currency );

   /* Вид ценной бумаги в сделке*/
   println("~Kind_avoir");    
   println(CheckData(ПолучитьТипЦБ( FD.fininstr.rec.AvoirKind )));
   /* Эмитент ценной бумаги*/
   println("~Issuer");                                                   /*Date_deal*/
   ПолучитьСубъекта( FI_GetIssuerOnDate(FD.fininstr, FD.GetParametr(MC_TYPE_PARAMETR_BEGDATE) ), rParty );

   println(CheckData(rParty.ShortName));
   /* Наименование ценной бумаги */
   println("~Name_avoi");    
   println(CheckData(FD.fininstr.rec.Name));
   /* Код ценной бумаги*/
   println("~CodeAvoi");     
   println(CheckData(FD.fininstr.rec.FI_Code));
   /* LSIN */
   println("~LSIN");         
   println(CheckData(FD.avoiriss.rec.LSIN));
   /* ISIN */
   println("~ISIN");         
   println(CheckData(FD.avoiriss.rec.ISIN));
   /* Дата погашения */
   println("~DrawingDate");     
   println(CheckData(FD.fininstr.rec.DrawingDate));
   /* Дата выпуска */
   println("~IssDate");         
   println(CheckData(FD.fininstr.rec.Issued));
   /* Номинал */
   println("~FaceValue");       
   println(CheckData(FD.FaceValue));
   /* Валюта ниминала ц/б */
   println("~FiFaceValue");
   println(CheckData(ПолучитьКодФинИн ( FD.fininstr.rec.FaceValueFI, null, FICK_ISOSTRING )));
   /* Номинал  прописью*/
   println("~FaceValueWr");
   ПолучитьФинИн( FD.fininstr.rec.FaceValueFI, FaceValueFI );
   println(CheckData(CurToStrAlt(FD.FaceValueMoney, NULL,NULL, FaceValueFI.ISO_Number)));
   /* Валюта номинала ц/б */
   println("~ParentFI");       
   println(CheckData(ПолучитьИмяФинИн ( FD.fininstr.rec.FaceValueFI )));
   /* Количество бумаг в части сделки*/
   println("~Amount");        
   println(CheckData(double(FD.dl_leg.rec.Principal ) ));
   /* Количество бумаг в части сделки прописью*/
   println("~AmountWr");       
   println(CheckData(NumToStr(int( double(FD.dl_leg.rec.Principal) ))));
   /* Общая номинальная стоимость бумаг в части сделки*/
   println("~FaceValueAll");    
   FaceValueAll = money( FD.dl_leg.rec.Principal * FD.FaceValue );
   println(CheckData(FaceValueAll));
   /* Общая номинальная стоимость бумаг в части сделки прописью*/
   println("~FaceValueAllWr");       
   println(CheckData(CurToStrAlt(FaceValueAll, NULL,NULL, FaceValueFI.ISO_Number)));
   /* цена в процентах от номинала */
   println("~Rate");
     Rate = GetRate(FD);
   println(CheckData(Rate:m));
   /* цена в процентах от номинала прописью */
   println("~RateWr");       
   println(CheckData(PercToStr(Rate)));
   /*валюта цены ценной бумаги*/
   println("~FiPrice");      
   println(CheckData(ПолучитьИмяФинИн ( FD.dl_leg.rec.CFI )));

   /*По 88177 - берем данные для купона по 1 части.*/
   FD1 = SPFirstDoc(Deal, false);
   if( FI_IsCouponAvoiriss(FD1.fininstr) and 
      (FI_GetCouponOnDate(FD1.dl_leg.rec.PFI, FD1.pmwrtsum.rec.Date, fFiwarnts) == 0)
     )  /*   Купонная ц/б   */

     /*Ставка купона в процентах*/
     println("~CouponPerc");
     println(CheckData( fiwarnts_GetIncomeRate(fFiwarnts) ));
     /*Ставка купона в процентах прописью*/
     println("~CouponPercWr");
     println(CheckData(PercToStr( fiwarnts_GetIncomeRate(fFiwarnts) )));
     /*Дата погашения купона*/
     println("~NKD_DrawingDate");
     println(CheckData(fFiwarnts.DrawingDate ));
     /*Дней купонного периода*/
     println("~Days_NKD");
     println(CheckData({CurDate} - fFiwarnts.FirstDate));
     /*НКД по сделке*/
     println("~NKD");                 
     println(CheckData(FD.dl_leg.rec.NKD));
     /* Код валюты ниминала ц/б */
     println("~FiNKD");
     println(CheckData(ПолучитьКодФинИн ( FD.fininstr.rec.FaceValueFI, null, FICK_ISOSTRING )));
     /*НКД по сделке прописью*/
     println("~NKDWr");               
     println(CheckData(CurToStrAlt(FD.dl_leg.rec.NKD, NULL, NULL, Currency.ISO_Number)));
     /*валюта НКД*/
     println("~Fi_NKD");              
     println(CheckData(ПолучитьИмяФинИн ( FD.fininstr.rec.FaceValueFI )));
   else
     /*Такой изврат нужен только для подтверждений так как для всех типов
       бумажек подтверждение одно, поэтому НКД должен отображаться 
       корректно*/
     println("~NKD_DrawingDate");
     println("~Days_NKD");
     println("~NKD");                 
     println("~FiNKD");
     println("~NKDWr");               
     println("~Fi_NKD");              
   end;
   /*Сумма договора без НКД*/
   println("~SummWithoutNKD");      
   println(CheckData(FD.dl_leg.rec.Cost));
   /*Сумма договора без НКД прописью*/
   println("~SummWithoutNKDWr");    
   println(CheckData(CurToStrAlt(FD.dl_leg.rec.Cost, NULL, NULL, Currency.ISO_Number)));
   /*Сумма договора с НКД*/
   println("~SummWithNKD");      
   println(CheckData(FD.dl_leg.rec.TotalCost));
   /*Сумма договора с НКД прописью*/
   println("~SummWithNKDWr");    
   println(CheckData(CurToStrAlt(FD.dl_leg.rec.TotalCost, NULL, NULL, Currency.ISO_Number)));
   /*Сумма аванса по договору*/
   println("~PaymentInAdv");
   if(FD.ExistAvance)
     println(CheckData(FD.pm_avance.rec.Amount));
   else
     println(CheckData(0));
   end;
   /*Сумма аванса по договору прописью*/
   println("~PaymentInAdvWr");
   if(FD.ExistAvance)
     println(CheckData(CurToStrAlt(FD.pm_avance.rec.Amount, NULL, NULL, Currency.ISO_Number)));
   else
     println(CheckData(CurToStrAlt($0, NULL, NULL, Currency.ISO_Number)));
   end;
   /*Дата оплаты аванса*/
   println("~PaymentInAdvDate");
   if(FD.ExistAvance)
     println(CheckData(FD.pm_avance.rec.ValueDate));
   else
     println(CheckData(""));
   end;
   /*Сумма договора за вычетом аванса*/
   println("~DeltaPmAdv");
   if(FD.ExistAvance)
     println(CheckData(FD.dl_leg.rec.TotalCost - FD.pm_avance.rec.Amount));
   else
     println(CheckData(FD.dl_leg.rec.TotalCost));
   end;
   /*Сумма договора за вычетом аванса прописью*/
   println("~DeltaPmAdvWr");
   if(FD.ExistAvance)
     println(CheckData(CurToStrAlt((FD.dl_leg.rec.TotalCost - FD.pm_avance.rec.Amount), NULL, NULL, Currency.ISO_Number)));
   else
     println(CheckData(CurToStrAlt(FD.dl_leg.rec.TotalCost, NULL, NULL, Currency.ISO_Number)));
   end;
   /*Дата поставки ц/б*/
   println("~DateDeliev");   
   println( CheckData(FD.DateArray[DATE_DEALSETAVOIRISS_PLAN]));
   /*Число дней до поставки бумаг*/
   println("~DeltaDateDeliev");   
   println( FD.DateArray[DATE_DEALSETAVOIRISS_PLAN] - {curdate});
   /*Число дней до поставки бумаг прописью*/
   println("~DeltaDateDelievWr");
   println( NumToStr(FD.DateArray[DATE_DEALSETAVOIRISS_PLAN] - {curdate})); 
   /*Дата платежа по ц/б*/
   println("~PaymentDate");     
   println(CheckData(FD.DateArray[DATE_DEALPAY_PLAN]));
   /*Срок платежа по ц/б*/
   println("~DeltaPaymentDate");     
   println(FD.DateArray[DATE_DEALPAY_PLAN] - Deal.DealDate);
   /*Срок платежа по ц/б прописью*/
   println("~DeltaPaymentDateWr");     
   println(NumToStr(FD.DateArray[DATE_DEALPAY_PLAN] - Deal.DealDate));
   /*Валюта платежа по контрактиву*/
   println("~Fi_deal");              
   println(CheckData(ПолучитьИмяФинИн ( FD.pm_money_.rec.FIID )));
   /*Сумма договора с НКД в валюте FI_deal*/
   println("~SummWithNKDFi");
   println(CheckData(FD.dl_leg.rec.TotalCost));
   /*Сумма договора с НКД в валюте FI_deal прописью*/
   println("~SummWithNKDFiWr");    
   println(CheckData(CurToStrAlt(FD.dl_leg.rec.TotalCost, NULL, NULL, Currency.ISO_Number)));
   /*Сумма договора без НКД в валюте FI_deal*/
   println("~SummWithoutNKDFi");      
   println(CheckData(FD.dl_leg.rec.Cost));
   /*Сумма договора без НКД в валюте FI_deal прописью*/
   println("~SummWithoutNKDFiWr");    
   println(CheckData(CurToStrAlt(FD.dl_leg.rec.Cost, NULL, NULL, Currency.ISO_Number)));
   /*Валюта платежа по контрактиву в которой будет делаться проводка*/
   println("~OtherFi");              
   println(CheckData(ПолучитьИмяФинИн ( FD.pm_money_.rec.PayFIID ) ));
   /*Тип расчетов*/
   println("~Type_Set");
   println(CheckData(GetTypeAc( 155, StrFor(FD.dl_leg.rec.Formula)) )); /*155 - типы расчетов*/

   return 0;
end;


macro DepoAndCorr(Deal, IsBack)

   record Party(party);

   var FD;


   FD = SPFirstDoc(Deal, IsBack);
   
   /*Счет депо покупателя ц/б*/
   println("~AccDepoBuyer");        
   println(CheckData(FD.pm_avoir.rec.ReceiverAccount));
   /*Депозитарий покупателя*/
   println("~DepositoryBuyer");      
   println(CheckData(GetPartyName( FD.pm_avoir.rec.ReceiverBankID )));

   /*Тип счета*/
   println("~Type_depo");
   if(Deal.ClientID < 0) /*Сделка для нашего банка*/
     println("собственник");
   else
     println("номинальный держатель");
   end;
   /*Идентификатор покупателя в НДЦ*/
   println("~Identificator");
   println(CheckData(ПолучитьКодСубъекта(FD.pm_avoir.rec.Receiver, PTCK_NDC)));
   /*Счет получателя денег*/
   println("~Account");        
   println(CheckData(FD.pm_money_.rec.ReceiverAccount));
   /*Банк получателя денег*/
   println("~BankName");      
   ПолучитьСубъекта(FD.pm_money_.rec.ReceiverBankID, Party);
   println(CheckData(Party.Name));
   /*Код Swift получателя денег*/
   println("~BankCodeSwift");  
   println(CheckData(ПолучитьКодСубъекта (FD.pm_money_.rec.ReceiverBankID, PTCK_SWIFT)));
   /*Счет плательщика денег*/
   println("~AccountPurch");        
   println(CheckData(FD.pm_money_.rec.PayerAccount));
   /*Банк плательщика денег*/
   println("~BankNamePurch");            
   ПолучитьСубъекта(FD.pm_money_.rec.PayerBankID, Party);
   println(CheckData(Party.Name));
   /*Код BIC получателя денег*/
   println("~BIC");                
   println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.ReceiverBankID, PTCK_BIC)));
   /*Код ИНН получателя денег*/
   println("~TaxId");                
   println(CheckData(ПолучитьКодСубъекта (FD.pm_money_.rec.ReceiverBankID, PTCK_INN)));
   /*Корсчет банка получателя*/
   println("~BankCorrAcc");
   println(CheckData(FD.debet.rec.CorrAcc));
   /*Банк в котором открыт корсчет*/
   println("~CorrBankName");          
   println(CheckData(FD.debet.rec.BankCode));
   return 0;
end;

macro Properties_Sides(Deal, IsBack)
  
  record Party(party);
  record Seller_B(party);
  record Purch_B(party);
  record RecordAdress ( adress );
//  file   pmrmprop(pmrmprop);
  file   Proxy(dl_proxy);
  file   country(country,"rsrfdb.def") key 2;
  
  record sfcontr(sfcontr);
  record settacc(settacc);
  

  var SellerPartyID, PurchaserPartyID;
  var continue_cicle;
  var TelexNumber = "", PhoneNumber = "", Fax = "";

/************************** ПРОДАВЕЦ ********************************/
  var FD = SPFirstDoc(Deal, IsBack);

  /*Наименование продавца */

  println("~SellerName");
  if( ((GetDealBuySale( Deal ) == DEAL_TYPE_BUY) AND (not FD.IsBack)) OR
       (GetDealBuySale( Deal ) == DEAL_TYPE_SALE) AND (FD.IsBack)) 
    SellerPartyID = Deal.PartyID;
  else
    SellerPartyID = Deal.ClientID;
    if(SellerPartyID < 0) SellerPartyID = {OurBank}; end;
  end;
  ПолучитьСубъекта( SellerPartyID, Party );
  println(CheckData(Party.Name));

  /*Адрес продавца юридический*/
  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(Party.PartyID,RecordAdress);
  println("~SellerAddress");
  println(CheckData(RecordAdress.PostIndex) + " " + CheckData(RecordAdress.Adress));
  /*Адрес продавца фактический*/
  ClearRecord(RecordAdress);
  НайтиАдресСубъекта(Party.PartyID,PTADDR_REAL,RecordAdress);
  println("~SellerAddressP");
  println(CheckData(RecordAdress.PostIndex) + " " + CheckData(RecordAdress.Adress));
  /*Телефон продавца */
  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(Party.PartyID,RecordAdress);
  
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber);
  println("~SellerTel");
  println(CheckData(PhoneNumber));
  /*Факс продавца */
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_FAX, Fax);
  println("~SellerFax");
  println(CheckData(Fax));
  /*Телекс продавца */
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_TELEXNUMBER, TelexNumber);
  println("~SellerTelex");
  println(CheckData(TelexNumber));
  /*Счет продавца в национальной валюте*/
  println("~SellerAccount");
  println(CheckData(FD.pm_money_.rec.ReceiverAccount));
  /*Название банка продавца*/
  println("~Seller_BankName");
  ПолучитьСубъекта( FD.pm_money_.rec.ReceiverBankID, Seller_B );
  println(CheckData(Seller_B.Name));
  /*БИК банка продавца*/
  println("~Seller_BankBIC");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.ReceiverBankID, PTCK_BIC)));
  /*Корсчет*/
  println("~SellerCorAccNutcur");
  println(CheckData(FD.debet.rec.CorrAcc  ));
  /*Банк в котором открыт корсчет*/
  println("~SellerCorrBankName");
  println(CheckData(FD.debet.rec.CorrCode));
  /*БИК продавца*/
  println("~SellerBIC");
  println(CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_BIC)));
  /*ИНН продавца*/
  println("~SellerTaxId");
  println(CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_INN)));
  /*Счет депо продавца ц/б*/
  println("~SellerDepoAcc");        
  println(CheckData(FD.pm_avoir.rec.PayerAccount));
  /*Депозитарий продавца*/
  println("~SellerDeposit");      
  println(CheckData(GetPartyName( FD.pm_avoir.rec.PayerBankID )));

  /*Идентификатор продавца в НДЦ*/
  println("~SellerIdentificator");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_avoir.rec.Payer, PTCK_NDC)));
  /*SWIFT продавца*/
  println("~SellerSWIFT");
  println(CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_SWIFT)));
  /*Счет продавца в иностранной валюте*/
  println("~Seller_AccountCur");
  println(CheckData(FD.pm_money_.rec.ReceiverAccount));
  /*Название банка продавца*/
  println("~Seller_BankNameCur");
  ПолучитьСубъекта( FD.pm_money_.rec.ReceiverBankID, Seller_B );
  println(CheckData(Seller_B.ShortName));
  /*SWIFT банка продавца*/
  println("~Seller_BankSWIFT");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.ReceiverBankID, PTCK_SWIFT)));
  /*Корсчет*/
  println("~SellerCorAccCur");
  println(CheckData(FD.debet.rec.CorrAcc));
  /*Банк в котором открыт корсчет*/
  println("~SellerCorrBankNameCur");
  println(CheckData(FD.debet.rec.CorrCode));
  /*SWIFT банка */
  println("~SellerCorrBankCodeSWIFT");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.ReceiverBankID, PTCK_SWIFT)));
  /*Адрес банка */
  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(Seller_B.PartyID,RecordAdress);
  println("~SellerCorrBankAdd");
  println(CheckData(RecordAdress.Adress));
  /*Реквизиты продавца в полном виде*/
  println("~Ins_Seller");
  if(FD.pm_money_.rec.FIID == NATCUR)
    println("р/с "    +  CheckData(FD.pm_money_.rec.ReceiverAccount) + 
            " , к/с " +  CheckData(FD.debet.rec.CorrAcc) + 
            " в "     +  CheckData(FD.debet.rec.CorrCode) + 
            ", БИК "  +  CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_BIC)) +
            ", ИНН "  +  CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_INN)) );  
  else
    println("Acc № "  +  CheckData(FD.pm_money_.rec.ReceiverAccount) + 
            " with "  +  CheckData(Seller_B.ShortName) + 
            ", SWIFT "+  CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.ReceiverBankID, PTCK_SWIFT))); 
  end;
  /*удостоверяющий документ*/
  println("~SellerDoc");
  println(CheckData(GetRegDoc(SellerPartyID)));

  /*Страна нерезидента (если сторона таковым является)*/
  println("~SellerRepublic_NonRes");  

  if(Party.NotResident == "X") /*стороны нерезидент*/
    clearrecord(country);
    country.CodeLat3 = Party.NRCountry;
    GetEQ(country);
    println(CheckData(country.Name));
  else
    println(CheckData(""));
  end;

/******************************* ПОКУПАТЕЛЬ ******************************/
  /*Наименование покупателя */
  println("~PurchaserName");
  if( ((GetDealBuySale( Deal ) == DEAL_TYPE_SALE) AND (not FD.IsBack)) OR
       (GetDealBuySale( Deal ) == DEAL_TYPE_BUY) AND (FD.IsBack)) 
    PurchaserPartyID = Deal.PartyID;
  else
    PurchaserPartyID = Deal.ClientID;
    if(PurchaserPartyID < 0) PurchaserPartyID = {OurBank}; end;
  end;
  ПолучитьСубъекта( PurchaserPartyID, Party );
  println(CheckData(Party.Name));
  /*Адрес покупателя юридический*/
  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(Party.PartyID,RecordAdress);
  println("~PurchaserAddress");
  println(CheckData(RecordAdress.PostIndex) + " " + CheckData(RecordAdress.Adress));
  /*Адрес покупателя фактический*/
  ClearRecord(RecordAdress);
  НайтиАдресСубъекта(Party.PartyID,PTADDR_REAL,RecordAdress);
  println("~PurchaserAddressP");
  println(CheckData(RecordAdress.PostIndex) + " " + CheckData(RecordAdress.Adress));
  /*Телефон покупателя */
  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(Party.PartyID,RecordAdress);
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber);
  println("~PurchaserTel");
  println(CheckData(PhoneNumber));
  /*Факс покупателя */
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_FAX, Fax);
  println("~PurchaserFax");
  println(CheckData(Fax));
  /*Телекс покупателя */
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_TELEXNUMBER, TelexNumber);
  println("~PurchaserTelex");
  println(CheckData(TelexNumber));
  /*Счет покупателя в национальной валюте*/
  println("~PurchaserAccount");
  println(CheckData(FD.pm_money_.rec.PayerAccount));
  /*Название банка покупателя*/
  println("~Purchaser_BankName");
  ПолучитьСубъекта( FD.pm_money_.rec.PayerBankID, Purch_B );
  println(CheckData(Purch_B.Name));
  /*БИК банка покупателя*/
  println("~Purchaser_BankBIC");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.PayerBankID, PTCK_BIC)));
  /*Корсчет*/
  println("~PurchaserCorAccNutcur");
  println(CheckData(FD.credit.rec.CorrAcc));
  /*Банк в котором открыт корсчет*/
  println("~PurchaserCorrBankName");
  println(CheckData(FD.credit.rec.CorrCode));
  /*БИК покупателя*/
  println("~PurchaserBIC");
  println(CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_BIC)));
  /*ИНН покупателя*/
  println("~PurchaserTaxId");
  println(CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_INN)));
  /*Счет депо покупателя ц/б*/
  println("~PurchaserDepoAcc");        
  println(CheckData(FD.pm_avoir.rec.ReceiverAccount));
  /*Депозитарий покупателя*/
  println("~PurchaserDeposit");      
  println(CheckData(GetPartyName( FD.pm_avoir.rec.ReceiverBankID )));

  /*Идентификатор покупателя в НДЦ*/
  println("~PurchaserIdentificator");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.Receiver, PTCK_NDC)));
  /*SWIFT покупателя*/
  println("~PurchaserSWIFT");
  println(CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_SWIFT)));
  /*Счет покупателя в иностранной валюте*/
  println("~Purchaser_AccountCur");
  println(CheckData(FD.pm_money_.rec.PayerAccount));
  /*Название банка покупателя*/
  println("~Purchaser_BankNameCur");
  ПолучитьСубъекта( FD.pm_money_.rec.PayerBankID, Purch_B );
  println(CheckData(Purch_B.ShortName));
  /*SWIFT банка покупателя*/
  println("~Purchaser_BankSWIFT");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.PayerBankID, PTCK_SWIFT)));
  /*Корсчет*/
  println("~PurchaserCorAccCur");
  println(CheckData(FD.credit.rec.CorrAcc));
  /*Банк в котором открыт корсчет*/
  println("~PurchaserCorrBankNameCur");
  println(CheckData(FD.credit.rec.CorrCode));
  /*SWIFT банка */
  println("~PurchaserCorrBankCodeSWIFT");
  println(CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.PayerBankID, PTCK_SWIFT)));
  /*Адрес банка */
  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(Purch_B.PartyID,RecordAdress);
  println("~PurchaserCorrBankAdd");
  println(CheckData(RecordAdress.Adress));
  /*Реквизиты покупателя в полном виде*/
  println("~Ins_Purchaser");
  if(FD.pm_money_.rec.FIID == NATCUR)
    println("р/с "    +  CheckData(FD.pm_money_.rec.PayerAccount) + 
            " , к/с " +  CheckData(FD.credit.rec.CorrAcc) + 
            " в "     +  CheckData(FD.credit.rec.CorrCode) + 
            ", БИК "  +  CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_BIC)) +
            ", ИНН "  +  CheckData(ПолучитьКодСубъекта(Party.PartyID, PTCK_INN)) );  
  else
    println("Acc № "  +  CheckData(FD.pm_money_.rec.PayerAccount) + 
            " with "  +  CheckData(Purch_B.ShortName) + 
            ", SWIFT "+  CheckData(ПолучитьКодСубъекта(FD.pm_money_.rec.ReceiverBankID, PTCK_SWIFT))); 
  end;
  /*удостоверяющий документ*/
  println("~PurchaserDoc");
  println(CheckData(GetRegDoc(PurchaserPartyID)));

  /*Страна нерезидента (если сторона таковым является)*/
  println("~PurchaserRepublic_NonRes");  

  if(Party.NotResident == "X") /*стороны нерезидент*/
    clearrecord(country);
    country.CodeLat3 = Party.NRCountry;
    GetEQ(country);
    println(CheckData(country.Name));
  else
    println(CheckData(""));
  end;


  /*************************** КОНТРАГЕНТ ***********************/
  /*Наименование контрагента*/
  println("~CP");
  ПолучитьСубъекта( Deal.PartyID, Party );
  println(CheckData(Party.ShortName));
  /*Телефон*/
  ClearRecord(RecordAdress);
  НайтиЮридическийАдресСубъекта(Party.PartyID,RecordAdress);
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber);
  println("~CPTel");
  println(CheckData(PhoneNumber));
  /*Факс*/
  FindAdressContactValue(Party.PartyID, PTADDR_LEGAL, CNTADR_FAX, Fax);
  println("~CPFax");
  println(CheckData(Fax));
  /*Представитель контрагента*/
  println("~CPProxy");
  GetProxy( FD, DLPROXY_CONTRACTOR, Proxy);
  println(CheckData(Proxy.AgentName));

  return 0;
end;
