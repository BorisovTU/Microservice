/*
$Name:        sp_catfn.mac
$Module:      Ценные бумаги
$Description: Процедуры для получения параметров шаблонов счетов параметры - это значения из llvalues.dbt для заданных  справочников (objects.dbt) и классификаторов (llclass.dbt). Дополнительный макрос для sp_cattp.mac
*/
import "mctplprm.mac", secinter, OprInter;

PRIVATE MACRO AvrIsShare( FI )
   return (FI_IsInvestmentShare(FI) OR FI_IsShare( FI ) );
END;

/*получение вида портфеля для операций перемещения ц/б*/
MACRO Transfer_GetKindPort( FD, FIRole )
   return -1;
END;        

/*получение признака котируемости для операций перемещения ц/б*/
MACRO Transfer_GetQuoted( FD, FIID, FIRole )
   return -1;
END;

MACRO GetActiveBank( FIRole )
   /*базовый актив*/
   if( (FIRole == FIROLE_BA) OR (FIRole == FIROLE_BA_RESALE) OR (FIRole == FIROLE_BA_INVEST) ) 
      return 3; /* ценная бумага */
   /*контрактив*/   
   else
      return 1; /* денежные средства */
   end;         
END;

/*определяем относится ли переданный FIRole к операции перемещения ц/б*/
MACRO IsTransferFIRole( FIRole )
   if( (FIRole == FIROLE_SRCA) OR (FIRole == FIROLE_SRCA2) OR (FIRole == FIROLE_DSTA) OR (FIRole == FIROLE_DSTA2) )
      return true;
   else   
      return false;
   end;
END;

/*получаем цель приобретения*/
MACRO GetBuyGoal( FD, FIID, FIRole )
   return BUYGOAL_UNDEF;    
END;

MACRO GetCategZaemByParty( Contragent )
   var Select, Pt;

   Select = RSDCommand("Select * From dpartyown_dbt Where t_PartyKind = ? and t_PartyID = ?");

   Select.addParam("", RSDBP_IN, PTK_BANK);
   Select.addParam("", RSDBP_IN, Contragent);
   Select.execute();

   Pt = TRsbDataSet(Select);

   if( Pt.MoveNext() )
      return 1;
   end;

   return 2;
END;

/*получить тип портфеля для сделки с ц/б в зависимости от FIRole */
MACRO  GetPortfolioByFIRole( FD /*SPFirst*/, FIRole:INTEGER ):INTEGER
   VAR Portfolio = -1;

   if( (FD.Kind == DL_CONVAVR) and FD.IsBack ) /*только 2ч конвертации. 1-я часть - как обычные сделки.*/
      Portfolio = FD.tick.rec.PortfolioID_2; 
   else
      if ((FIRole == FIROLE_PD_TP) or (FIRole == FIROLE_DD_TP) or 
          (FIRole == FIROLE_PD_TP_BPP) or (FIRole == FIROLE_DD_TP_BPP) or 
          (FIRole ==  FIROLE_BA_TP) or (FIRole ==  FIROLE_BA_TP_OVERDUE) or
          (FIRole == FIROLE_BONUS_TP) or (FIRole == FIROLE_BONUS_TP_BPP) or
          (FIRole == FIROLE_BONUS_TP_PAID) or (FIRole == FIROLE_BONUS_TP_BPP_PAID) or
          (FIRole == FIROLE_RESERV_SALEREPO2_TP) or
          (FIRole == FIROLE_BA_SSPU_BPP) or (FIRole == FIROLE_BA_SSPU_BPP_OVERDUE)
         )
         Portfolio = KINDPORT_TRADE;
      elif ((FIRole == FIROLE_PD_PPR) or (FIRole == FIROLE_DD_PPR) or 
            (FIRole == FIROLE_PD_PPR_BPP) or (FIRole == FIROLE_DD_PPR_BPP) or 
            (FIRole ==  FIROLE_BA_PPR) or (FIRole ==  FIROLE_BA_PPR_OVERDUE)
            or (FIRole ==  FIROLE_BA_PPR_BPP) or
            (FIRole == FIROLE_BONUS_PPR) or (FIRole == FIROLE_BONUS_PPR_BPP) or
            (FIRole == FIROLE_BONUS_PPR_PAID) or (FIRole == FIROLE_BONUS_PPR_BPP_PAID) or
            (FIRole == FIROLE_BA_PPR_TSS_YES)  or (FIRole == FIROLE_BA_PPR_TSS_NO) or
            (FIRole == FIROLE_RESERV_SALEREPO2_PPR) or
            (FIRole == FIROLE_BA_SSSD_BPP) or (FIRole == FIROLE_BA_SSSD_BPP_OVERDUE)
           )
         Portfolio = KINDPORT_SALE;
      elif ( (FIRole == FIROLE_BAINCONTR) OR (FIRole == FIROLE_PD_PKU) or 
             (FIRole == FIROLE_RESERV_SALEREPO2_CONTR) or (FIRole == FIROLE_BA_CONTR_OVERDUE) or
             (FIRole == FIROLE_BA_CONTR_BPP) or (FIRole == FIROLE_BA_CONTR_BPP_OVERDUE)
           )
         Portfolio = KINDPORT_CONTR;
      elif ( (FIRole == FIROLE_BAINPROMISSORY) OR (FIRole == FIROLE_PD_PDO) OR (FIRole == FIROLE_DD_PDO))
         Portfolio = KINDPORT_PROMISSORY;
      elif(( FIRole == FIROLE_BA_BACK_CONTR ) or ( FIRole == FIROLE_BA_BACK ))
         Portfolio = KINDPORT_BACK;
      elif ((FIRole == FIROLE_PD_PUDP) or (FIRole == FIROLE_DD_PUDP) or (FIRole == FIROLE_BA_PUDP) or (FIRole == FIROLE_BA_PUDP_OVERDUE) or
            (FIRole == FIROLE_PD_PUDP_BPP) or (FIRole == FIROLE_DD_PUDP_BPP) or
            (FIRole == FIROLE_BONUS_PUDP) or (FIRole == FIROLE_BONUS_PUDP_BPP) or
            (FIRole == FIROLE_BONUS_PUDP_PAID) or (FIRole == FIROLE_BONUS_PUDP_BPP_PAID) or
            (FIRole == FIROLE_RESERV_SALEREPO2_PUDP) or
            (FIRole == FIROLE_BA_ASCB_BPP) or (FIRole == FIROLE_BA_ASCB_BPP_OVERDUE)
           )
         Portfolio = KINDPORT_RETIRE;
      elif( IsTransferFIRole( FIRole ) == true ) /*это перевод*/              
         Portfolio = Transfer_GetKindPort( FD, FIRole );
      elif( FD.tick != null )
         Portfolio = FD.tick.rec.PortfolioID;
      end;

      if( (Portfolio < 0) AND (FIRole == FIROLE_BA) )
         Portfolio = KINDPORT_TRADE;
      end;
   end;

   return Portfolio;
END;

MACRO GetFIRoleByPortfolioBonus( Portfolio:INTEGER, Bpp:BOOL ):INTEGER
   var FIRole = FIROLE_BA;

   if( Portfolio == KINDPORT_TRADE )
      if( Bpp )
         FIRole = FIROLE_BONUS_TP_BPP_PAID;
      else
         FIRole = FIROLE_BONUS_TP_PAID;
      end;
   elif( Portfolio == KINDPORT_SALE )
      if( Bpp )
         FIRole = FIROLE_BONUS_PPR_BPP_PAID;
      else
         FIRole = FIROLE_BONUS_PPR_PAID;
      end;
   elif( Portfolio == KINDPORT_RETIRE )
      if( Bpp )
         FIRole = FIROLE_BONUS_PUDP_BPP_PAID;
      else
         FIRole = FIROLE_BONUS_PUDP_PAID;
      end;
   end;

   return FIRole;
END;

MACRO GetFIRoleByPortfolio( Portfolio:INTEGER, Discount:BOOL, Percent:BOOL, Bpp:BOOL, IsOverdue:BOOL, Bonus:BOOL ):INTEGER
   VAR FIRole = FIROLE_BA;

   if( IsOverdue )
      FIRole = FIROLE_BA_OVERDUE;
   end;

   if( Portfolio == KINDPORT_TRADE )
      if( Discount )
         if( Bpp )
            FIRole = FIROLE_DD_TP_BPP;
         else
            FIRole = FIROLE_DD_TP;
         end;
      elif( Percent )
         if( Bpp )
            FIRole = FIROLE_PD_TP_BPP;
         else
            FIRole = FIROLE_PD_TP;
         end;
      elif( Bonus )
         if( Bpp )
            FIRole = FIROLE_BONUS_TP_BPP;
         else
            FIRole = FIROLE_BONUS_TP;
         end;
      else
         if(Bpp)
           if( IsOverdue )
              FIRole = FIROLE_BA_SSPU_BPP_OVERDUE;
           else
              FIRole = FIROLE_BA_SSPU_BPP;
           end;
         else
           if( IsOverdue )
              FIRole = FIROLE_BA_TP_OVERDUE;
           else
              FIRole = FIROLE_BA_TP;
           end;
         end;
      end;
   elif( Portfolio == KINDPORT_SALE )
      if( Discount )
         if( Bpp )
            FIRole = FIROLE_DD_PPR_BPP;
         else
            FIRole = FIROLE_DD_PPR;
         end;
      elif( Percent )
         if( Bpp )
            FIRole = FIROLE_PD_PPR_BPP;
         else
            FIRole = FIROLE_PD_PPR;
         end;
      elif( Bonus )
         if( Bpp )
            FIRole = FIROLE_BONUS_PPR_BPP;
         else
            FIRole = FIROLE_BONUS_PPR;
         end;
      else
         if(Bpp)
           if( IsOverdue )
              FIRole = FIROLE_BA_SSSD_BPP_OVERDUE;
           else
              FIRole = FIROLE_BA_SSSD_BPP;
           end;
         else
           if( IsOverdue )
              FIRole = FIROLE_BA_PPR_OVERDUE;
           else
              FIRole = FIROLE_BA_PPR;
           end;
         end;
      end;
   elif( Portfolio == KINDPORT_CONTR )
      if(Bpp)
        if( IsOverdue )
           FIRole = FIROLE_BA_CONTR_BPP_OVERDUE;
        else
           FIRole = FIROLE_BA_CONTR_BPP;
        end;
      else
        if( IsOverdue )
           FIRole = FIROLE_BA_CONTR_OVERDUE;
        else
           FIRole = FIROLE_BAINCONTR;
        end;
      end;
   elif( Portfolio == KINDPORT_PROMISSORY )
      if( Discount )
        FIRole = FIROLE_DD_PDO;
      elif( Percent )
        FIRole = FIROLE_PD_PDO;
      else
        FIRole = FIROLE_BAINPROMISSORY;
      end;
   elif( Portfolio == KINDPORT_RETIRE )
      if( Discount )
         if( Bpp )
            FIRole = FIROLE_DD_PUDP_BPP;
         else
            FIRole = FIROLE_DD_PUDP;
         end;
      elif( Percent )
         if( Bpp )
            FIRole = FIROLE_PD_PUDP_BPP;
         else
            FIRole = FIROLE_PD_PUDP;
         end;
      elif( Bonus )
         if( Bpp )
            FIRole = FIROLE_BONUS_PUDP_BPP;
         else
            FIRole = FIROLE_BONUS_PUDP;
         end;
      else
         if(Bpp)
           if( IsOverdue )
              FIRole = FIROLE_BA_ASCB_BPP_OVERDUE;
           else
              FIRole = FIROLE_BA_ASCB_BPP;
           end;
         else
           if( IsOverdue )
              FIRole = FIROLE_BA_PUDP_OVERDUE;
           else
              FIRole = FIROLE_BA_PUDP;
           end;
         end;
      end;
   elif( (Portfolio == KINDPORT_BACK) OR (Portfolio == KINDPORT_BACK_KSU))
      FIRole = FIROLE_BA_BACK;
   elif( (Portfolio == KINDPORT_BASICDEBT) OR (Portfolio == KINDPORT_BACK_BPP_KSU) )
      FIRole = FIROLE_BA;
   end;

   return FIRole;
END;

MACRO ДолеваяЦБ(FIID:integer,FiRole:integer)
   return (MC_GetKindCbPortf(FIID,FiRole) == 102);
END;

MACRO ДолговаяЦБ(FIID:integer,FiRole:integer)
   return (MC_GetKindCbPortf(FIID,FiRole) == 3);
END;
