/*
$Name:        nptxressumbudg_form.mac
$Module:      Ценные бумаги
$Description: 
*/
import "DlRepForm_h.mac", "nptxstbfun.mac";

CONST PNFLD_NPTXRESSUMBUDG_DATE             = 0,
      PNFLD_NPTXRESSUMBUDG_PACKNUMB         = 1,
      PNFLD_NPTXRESSUMBUDG_PROTOCOL         = 2;

PRIVATE CONST
  H_DATE             = 101,
  H_PACKNUMB         = 102,
  H_PROTOCOL         = 103;

macro GetNumberPackFromReg()
  const txtRegPath = "CB\\REGPAIRACC\\NUMBER_PACK_NDFL";
  var retVal;
  var err = 0;

  GetRegistryValue(txtRegPath, V_INTEGER, retVal, err);
  if(err != 0) 
    retVal = 0;
  end;
  return retVal;
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Date( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = date();
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
     FldRealValue = FldShowValue;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;


CLASS (DL_CPanel) Sp_NPTXRESSUMBUDG_Panel()
  var m_Date;
  var m_PackNumb;
  var m_IsProtocol; 

  PRIVATE MACRO Init()
     var Year = 0;

     AddFieldProc( 0, PNFLD_NPTXRESSUMBUDG_DATE,            H_DATE,             @FldProc_Date,            {curdate});
     AddFieldProc( 0, PNFLD_NPTXRESSUMBUDG_PACKNUMB,        H_PACKNUMB,         @Default,                 GetNumberPackFromReg());
     AddFieldProc( 0, PNFLD_NPTXRESSUMBUDG_PROTOCOL,        H_PROTOCOL,         @DL_FldProc_CheckBox,     SET_CHAR );
  END;

  PRIVATE MACRO Check():BOOL
    return true;
  END;

  MACRO Run()
    var stat = Run();

    m_Date             = GetFieldValue(PNFLD_NPTXRESSUMBUDG_DATE);
    m_PackNumb         = GetFieldValue(PNFLD_NPTXRESSUMBUDG_PACKNUMB);
    m_IsProtocol       = IIF(GetFieldValue(PNFLD_NPTXRESSUMBUDG_PROTOCOL) == SET_CHAR, true, false);

    return stat;
  END;

  initDL_CPanel( "txctrl.lbr", "nptxrssm" );
END;