/*
$Name:        represpm.mac
$Module:      Ценные бумаги
$Description: Отчет "Расчеты между резидентами и нерезидентами"
*/

import "spserv.mac", "spRepFun.mac", "spRepFn2.mac", "globals.mac", "DLReport_h.mac", "sp_voop.mac", "dp_voop.mac", "dlvaprds.mac", "vsbnrfd.mac", "vatickfd.mac", "nutxfun.mac", "vsordfd.mac", "likepy.mac", "bnk_dttmfrmt.mac", "scsrvrepfun.mac";
import "param.mac";

PRIVATE FILE Kliko_F405() txt write;
PRIVATE VAR  Kliko_F405_Use = false;

private var PrintBack = false;
private var PrintVA = false;
private var PrintVS = false;

private const
   НЕ_НАЙДЕН  = 0,
   РЕЗИДЕНТ   = 1,
   НЕРЕЗИДЕНТ = 2,
   ПЕРВАЯ_ЧАСТЬ = 1,
   ВТОРАЯ_ЧАСТЬ = 2;

private const
   OUTASTEXT = "OUTASTEXT";

private const
   RCB_XML_PK_MONTHLY   = 4,
   RCB_XML_PK_QUARTERLY = 5;

private const
   IP_VEKSEL = 37,
   IP_VEKSELACCOUNTED = 41;

private const
   DL_INSERT_SECDEAL = 967; // вставки сделки БОЦБ

private const PARTY_ATTR_FZ290  = 17;     // Международная компания по 290-ФЗ
private const PARTY_ATTR_FZ4015 = 24;     // Филиал иностранной страховой организации по ФЗ 4015-I
private const PARTY_ATTR_FZ424  = 14;     // Не предусматривает бенефициарного владельца
private const PARTY_ATTR_21     = 21;     // Иностранный агент


CLASS F405DeltaXML(OKUD:String, ReportKind:String, EndDate:Date, Periodicity:Integer)
   private var m_XmlReport;
   private var m_EndDate = EndDate;
   private var jvm;
   private var m_Protocol;
   private var m_FileName = "";
   private var m_OKUD = OKUD;
   private var m_kindOrganisation = ReportKind;
   
   var RowNum = 0;
   PRIVATE MACRO Delta_Fld( Val:VARIANT ):STRING
      VAR ValStr = "";

      if( Val != NULL ) 
        VAR vt = ValType(Val);
        if( vt == V_DATE )
           if( Val == DATE(0,0,0) )
              ValStr = "0";
           else
              ValStr = YYYY_MM_DD(Val);
           end;
        elif( vt == V_STRING )
           ValStr = StrSubst( Val, "\"", "''" );
           /*
           ValStr = StrSubst( ValStr, "-", "0" );
           if (ValStr == "")
               ValStr = "0";
           end;    */  
        elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
          if( Val != 0.00)
            ValStr = trim(string(Val:18:2));
          else
            ValStr = "0.00";    
          end;
        else
           ValStr = string(Val);
        end;
      else
        ValStr="";
      end;

      return ValStr;
   END;
   
   macro PrintInfo()
      var registrationNumber = repGetPartyCode({OurBank}, PTCK_BANKREGNUM, m_EndDate);
      var BIC = repGetPartyCode({OurBank}, PTCK_BIC, m_EndDate);
      var party = TRecHandler("party.dbt");
      var OKATO;
      var OKPO;
      var Name;
      var PostalAdress;
      var OGRN = repGetPartyCode({OurBank}, PTCK_OGRN, m_EndDate);
      var adress = TRecHandler("adress.dbt");
      var leaderPost:String, leaderName:String;
      var executorPost;
      var executorName;
      var executorPhone;
      var executorEmail;
      var executorFax;

      ПолучитьСубъекта({OurBank}, party);
      OKPO = IIF(party.rec.OKPO != NULL, party.rec.OKPO, "");
      Name = party.rec.Name;

      GetMainObjAttr(NULL,
                     OBJTYPE_PARTY,
                     UniID(party, OBJTYPE_PARTY),
                     RCB_OBJGROUP_PT_OKATO, // 12
                     NULL,
                     NULL,
                     OKATO,
                     m_EndDate
                    );

      if(OKATO == NULL)
         var OkatoQuery = "select adress.t_OKATO " +
                          "from dadress_dbt adress " +
                          "where adress.t_Type = 1 " +
                          "  and adress.t_PartyID = " + string({OurBank});

         var OkatoSelect = DL_RSDCommand(OkatoQuery);
         var OkatoDS = OkatoSelect.Execute();
         if(OkatoDS.MoveNext())
            OKATO = OkatoDS.OKATO;
         end;
      end;

      OKATO = IIF(OKATO != NULL, OKATO, "");

      if(найтиАдресСубъекта({OurBank}, PTADDR_REAL, adress)
        )
         PostalAdress = adress.rec.Adress;
      end;

      var leaderQuery = "select off.t_Post, " +
                        "       party.t_Name " +
                        "from dofficer_dbt off, dparty_dbt party " +
                        "where off.t_IsFirstPerson = 'X' " +
                        "  and off.t_PartyID = " + string({OurBank}) +
                        "  and party.t_PartyID = off.t_PersonID ";

      var leaderSelect = DL_RSDCommand(leaderQuery);
      var leaderDS = leaderSelect.Execute();

      if(leaderDS.MoveNext())
         leaderPost = leaderDS.Post;
         leaderName = leaderDS.Name;
      else
         leaderPost = leaderName = "";
      end;
      
      var executorQuery = 
              "select off.t_Post,                                                              " +
              "       persn.t_Name1 || ' ' || persn.t_Name2 || ' ' || persn.t_Name3 as t_Name, " +
              "       nvl(                                                                     " +
              "        (                                                                       " +
              "              select q_Phone.t_Value                                            " +
              "              from (                                                            " +
              "                    select Phone.t_Value                                        " +
              "                    from dcontact_dbt Phone                                     " +
              "                    where Phone.t_PartyID = person.t_PartyID                    " +
              "                          and Phone.t_ContactKind = 1                           " +
              "                          and Phone.t_ContactType = 2                           " +
              "                          order by Phone.t_IsMain DESC                          " +
              "                    ) q_Phone                                                   " +
              "              where ROWNUM = 1                                                  " +
              "              ), chr(1)                                                         " +
              "           ) as t_Phone,                                                        " +
              "       nvl(                                                                     " +
              "        (                                                                       " +
              "              select q_Fax.t_Value                                              " +
              "              from (                                                            " +
              "                      select Fax.t_Value                                        " +
              "                      from dcontact_dbt Fax                                     " +
              "                      where Fax.t_PartyID = person.t_PartyID                    " +
              "                        and Fax.t_ContactKind = 3                               " +
              "                      order by Fax.t_IsMain DESC                                " +
              "                   ) q_Fax                                                      " +
              "              where ROWNUM = 1                                                  " +
              "              ), chr(1)                                                         " +
              "           ) as t_Fax,                                                          " +
              "        nvl(                                                                    " +
              "        (                                                                       " +
              "          select q_Email.t_Value                                                " +
              "          from (                                                                " +
              "                select Email.t_Value                                            " +
              "                from dcontact_dbt Email                                         " +
              "                where Email.t_PartyID = person.t_PartyID                        " +
              "                      and Email.t_ContactKind = 5                               " +
              "                      and Email.t_ContactType = 8                               " +
              "                      order by Email.t_IsMain DESC                              " +
              "                ) q_Email                                                       " +
              "          where ROWNUM = 1                                                      " +
              "          ), chr(1)                                                             " +
              "        )                                                                       " +
              "        as t_Email                                                              " +
              "from dofficer_dbt off,                                                          " +
              "     dpersOn_dbt  persOn,                                                       " +
              "     dpersn_dbt   persn                                                         " +
              "where persOn.t_Oper = "     + string({oper})                                      +
              "      and off.t_PartyID = " + string({OurBank})                                   +
              "      and off.t_PersonID = persOn.t_PartyID                                     " +
              "      and persn.t_PersonID = persOn.t_PartyID                                   ";
                         
                        
      var executorSelect = DL_RSDCommand(executorQuery);
      var executorDS = executorSelect.Execute();

      if(executorDS.MoveNext())
         executorPost  = executorDS.Post;
         executorName  = executorDS.Name;//{Name_Oper}
         executorPhone = executorDS.Phone;
         executorEmail = executorDS.Email;
         executorFax   = executorDS.Fax;
      else
         executorPost = executorName = executorPhone = executorEmail = executorFax = "";
      end;    
      
      var signers = jvm.createJavaObject("java.util.ArrayList", "<init>");
      
      var leaderNode = jvm.createJavaObject("XMLReportExporter.XMLNode", "<init>", "Руководитель");
      leaderNode.addAttribute("Должность", leaderPost);
      leaderNode.addAttribute("ФИО", leaderName);
      signers.add(leaderNode);

      var executorNode = jvm.createJavaObject("XMLReportExporter.XMLNode", "<init>", "Исполнитель");
      executorNode.addAttribute("Должность", executorPost);
      executorNode.addAttribute("ФИО",       executorName);
      executorNode.addAttribute("Телефон",   executorPhone);
      executorNode.addAttribute("Факс",      executorFax);
      executorNode.addAttribute("ЭлПочта",   executorEmail);
      signers.add(executorNode);
      
       m_xmlReport.addInfoPart(registrationNumber,
                              BIC,
                              OKATO,
                              OKPO,
                              OGRN,
                              Name,
                              PostalAdress,
                              signers
                             );


      m_Protocol = m_XmlReport.getProtocol();
   end;

   macro BeginData405()
      var IdAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Ид", "1");
      var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var NullAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

      Attributes.add(IdAttribute);
      m_XmlReport.beginPart("Данные405", Attributes);

      RowNum = 1;
   end;
   
   macro atrAdd(Name: string, Val:VARIANT)
     var atr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", Name, Delta_Fld(Val));
     return atr;
   end;
   
   macro AddLineP1(PartNumber, SubPartNumber, LineNum, 
                                       K1 , K2, 
                                       A1,  A2,  A3,  A4,  A5,  A6,  A7,  A8,  A9,  A10,
                                       A11, A12, A13, A14, A15, A16, A20, A21, A22, 
                                       A23_1, A23_2, A23_3, A23_4, A23_5, A23_6, A23_7,
                                       A23_8, A23_9,
                                       A18A, A17, A18, A19) 
     var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
     var XmlPartNumber = PartNumber;
     if (XmlPartNumber == 1)
       XmlPartNumber = "";
     end;
     Attributes.add(atrAdd ("РегнКОФил", A1));     
     //Attributes.add(atrAdd ("НомСтроки" + PartNumber, LineNum));
     Attributes.add(atrAdd ("НомСтроки" + XmlPartNumber + SubPartNumber, "1." + SubPartNumber + "." + LineNum));
     
     Attributes.add(atrAdd ("К1", K1));
     Attributes.add(atrAdd ("К2", K2));
     Attributes.add(atrAdd ("ДатаОпер",            A2));
     Attributes.add(atrAdd ("КодВидВалОпер",       A3));
     Attributes.add(atrAdd ("КодИнструмента",      A4));
     Attributes.add(atrAdd ("КодОп",               A5));
     Attributes.add(atrAdd ("КодНПл",              A6));
     Attributes.add(atrAdd ("КолЦб",               A7));
     Attributes.add(atrAdd ("РазмерДоли",          A8));
     Attributes.add(atrAdd ("КодВлПл",             A9));
     Attributes.add(atrAdd ("СуммаВсего",          numeric(A10)));
     Attributes.add(atrAdd ("СуммаДоход",          numeric(A11)));
     //Attributes.add(atrAdd ("Налог",               A12));
     Attributes.add(atrAdd ("НаимРезидент",        A13));
     Attributes.add(atrAdd ("КодРезидент",         A14));
     Attributes.add(atrAdd ("НаимНерезидент",      A15));
     Attributes.add(atrAdd ("КодСтраны",           A16));
     Attributes.add(atrAdd ("ДатаРегВып",          IIF(((A20 != NULL) AND (A20 != "")), ToDate_DDpMMpYYYY(A20), A20)));
     Attributes.add(atrAdd ("ДатаПогашЦб",         IIF(((A21 != NULL) AND (A21 != "")), ToDate_DDpMMpYYYY(A21), A21)));
     Attributes.add(atrAdd ("КодВлЦб",             A22));
     Attributes.add(atrAdd ("ПримРАССРОЧКА",       A23_1));
     Attributes.add(atrAdd ("ПримПАКЕТ",           A23_2));
     Attributes.add(atrAdd ("ПримТЕКСТ",           A23_3));
     Attributes.add(atrAdd ("ПримКАНаимИнБ",       A23_4));
     Attributes.add(atrAdd ("ПримКАКодСтраныИнБ",  A23_5));
     Attributes.add(atrAdd ("ПримКАНаимНРзд",      A23_6));
     Attributes.add(atrAdd ("ПримКАКодСтраныНРзд", A23_7));
     Attributes.add(atrAdd ("ПримДатаОпСделки",    A23_8));
     Attributes.add(atrAdd ("ПримСобствБум",       A23_9));
     
     m_XmlReport.beginPart("строка", Attributes);

      var Rec = jvm.createJavaObject("java.util.ArrayList", "<init>");

      Rec.add(atrAdd ("К3", A18A));
      Rec.add(atrAdd ("НаимЭмЦб", A17));
      Rec.add(atrAdd ("КодЭмЦб", A18));
      Rec.add(atrAdd ("РегНомЦб", A19));
      
      m_XmlReport.addLine("запись", Rec, "");    
     
     m_XmlReport.finishPart();
     RowNum = RowNum + 1;
   end;
   
   macro AddLineP2(PartNumber, SubPartNumber, LineNum,
                                       K4 , K5, 
                                       A1,  A2,  A3,  A4,  A5,  A6,  A7,  A8,  A9,  A10,
                                       A11, A12, A16, A17_1, A17_2, A17_3, A17_4,
                                       KL_A13, A13, A14, A15)
   var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
   var XmlPartNumber = PartNumber;
   if (XmlPartNumber == 1)
      XmlPartNumber = "";
   end;
   Attributes.add(atrAdd ("РегнКОФил", A1));     
   //Attributes.add(atrAdd ("НомСтроки" + PartNumber, LineNum));
   Attributes.add(atrAdd ("НомСтроки" + XmlPartNumber + SubPartNumber, "2." + SubPartNumber + "." + LineNum));
   
   Attributes.add(atrAdd ("К4", K4));     
   Attributes.add(atrAdd ("К5", K5));     
   Attributes.add(atrAdd ("ДатаОпер",            A2));
   Attributes.add(atrAdd ("КодИнструмента",      A3));
   Attributes.add(atrAdd ("КодОпР2",             A4));
   Attributes.add(atrAdd ("КолЦбР2",             A5));
   Attributes.add(atrAdd ("РазмерДоли2",         A6));
   Attributes.add(atrAdd ("КодВлПл",             A7));
   Attributes.add(atrAdd ("СуммаВсегоР2",        A8));
   Attributes.add(atrAdd ("НаимПокупатель",      A9));
   Attributes.add(atrAdd ("КодПокупатель",       A10));
   Attributes.add(atrAdd ("НаимПродавец",        A11));
   Attributes.add(atrAdd ("КодПродавец",         A12));
   Attributes.add(atrAdd ("КодВлЦб",             A16));
   
   Attributes.add(atrAdd ("ПримРАССРОЧКА",       A17_1));
   Attributes.add(atrAdd ("ПримПАКЕТ",           A17_2));
   Attributes.add(atrAdd ("ПримТЕКСТ",           A17_3));
   Attributes.add(atrAdd ("ПримСобствБум",       A17_4));  
   
     m_XmlReport.beginPart("строка", Attributes);

      var Rec = jvm.createJavaObject("java.util.ArrayList", "<init>");

      Rec.add(atrAdd ("К3", KL_A13));
      Rec.add(atrAdd ("НаимЭмЦб", A13));
      Rec.add(atrAdd ("КодЭмЦб", A14));
      Rec.add(atrAdd ("РегНомЦб", A15));
      
      m_XmlReport.addLine("запись", Rec, "");    
     
     m_XmlReport.finishPart();
     RowNum = RowNum + 1;
   end;
   
   macro Section ( Sec, Sub )
     var NullAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
     m_XmlReport.beginPart("Раздел" + Sec + "Подраздел" + Sub, NullAttributes);
   end;
   
   macro FinishData()
      m_XmlReport.finishPart();
   end;

   macro NoData()
      var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrCode = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодНепредоставления", "1");

      attributes.add(attrCode);
      m_XmlReport.addLine("НетДанных", attributes, "");
   end;

   macro PrintProtocol()
      m_Protocol = m_XmlReport.getProtocol();

      var Notes = m_Protocol.getNotesText();
      var Errors = m_Protocol.getErrorsText();
      var Fails = m_protocol.getFailsText();
      var atrtibutesNotes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusNotes = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "0");
      atrtibutesNotes.add(attrStatusNotes);
      var atrtibutesErrors = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusErrors = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "1");
      atrtibutesErrors.add(attrStatusErrors);
      var atrtibutesFails = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusFails = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "2");
      atrtibutesFails.add(attrStatusFails);

      if((Notes != "") or (Errors != "") or (Fails != ""))
         m_XmlReport.beginPart("ПротоколКонтроля");
         if(Notes != "")
            m_XmlReport.addLine("Сообщение", atrtibutesNotes, Notes);
         end;
         if(Errors != "")
            m_XmlReport.addLine("Сообщение", atrtibutesErrors, Errors);
         end;
         if(Fails != "")
            m_XmlReport.addLine("Сообщение", atrtibutesFails, Fails);
         end;
         m_XmlReport.finishPart();
      end;
   end;

   macro GetFileName()
      return m_FileName;
   end;

   macro CreateXMLFile()
      return m_XmlReport.export(m_FileName);
   end;

   var DepCode;
   var DepCodeQuery = "select dp_dep.t_Name " +
                      "from ddp_dep_dbt dp_dep " +
                      "where dp_dep.t_Code = " + string({OperDprt});

   var DepCodeSelect = DL_RSDCommand(DepCodeQuery);
   var DepCodeDS = DepCodeSelect.Execute();
   if(DepCodeDS.MoveNext())
      DepCode = DepCodeDS.Name;
   else
      DepCode = "";
   end;

   private var dd;
   private var mm;
   DateSplit(m_EndDate, dd, mm, NULL);

   var len = strlen(DepCode);
   if(len < 4)
      var i = len;
      while(i < 4)
         DepCode = "0" + DepCode;
         i = i + 1;
      end;
   elif(len > 4)
      DepCode = SubStr(DepCode, 1, 4);
   end;

   m_FileName = "..\\TxtFile\\" + m_OKUD + "_" + string(dd:o:2) + string(mm:o:2) + DepCode + ".xml";

   jvm = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   m_XmlReport = jvm.createJavaObject("XMLReportExporter.XMLReport", "<init>", "4.0.4.5", m_OKUD, m_OKUD, ReportKind, String(m_EndDate : f), Periodicity);
   m_Protocol = m_XmlReport.getProtocol();
END;
 
MACRO GetOkud():String
   return "0409405";
END;

MACRO GetReportKind():String
   return "КО";
END;

MACRO GetPeriodicity():Integer
   return RCB_XML_PK_MONTHLY;
END;
// Данные отчета
PRIVATE CLASS ReportData( _MonthNum,
                          _YearNum,
                          _PrintPart1,
                          _PrintPart11,
                          _FirstWorkMode,
                          _PrintPart12,
                          _Mode_Retire,
                          _Mode_Payments,
                          _PrintPart2,
                          _PrintPart21,
                          _PrintPart22,
                          _IsApp,
                          _IsAgreg,
                          _IsExcel,
                          _Kliko,
                          _Delta
                          )
   // Исходные данные
   var PrintPart1    = _PrintPart1;    // Печатать 1-ый раздел
   var PrintPart11   = _PrintPart11;   // Печатать 1-ый подраздел
   var FirstWorkMode = _FirstWorkMode; // Режим работы:
                                       //    true  - резеденты с нерезидентами
                                       //    false - рез. с нерез. и наоборот
   var PrintPart12   = _PrintPart12;   // Печатать 2-ой подраздел
                                       // Режим работы:
   var Mode_Retire   = _Mode_Retire;   //    погашения (вкл. просроченные) БОЦБ
   var Mode_Payments = _Mode_Payments; //    обработки выплат в "Депозитарии"
   var PrintPart2    = _PrintPart2;    // Печатать 2-ой раздел
   var PrintPart21   = _PrintPart21;   // Печатать 1-ый подраздел
   var PrintPart22   = _PrintPart22;   // Печатать 2-ой подраздел
   var IsApp         = _IsApp;         // Печать с апострофами
   var IsAgreg       = _IsAgreg;       // Агрегация данных за каждый день
   var IsExcel       = _IsExcel;       // Выпуск в Excel
   var Kliko         = _Kliko;
   var Delta         = _Delta;
   var DeltaReport;
   var PartNameArr = TArray(), SubPartNameArr1 = TArray(), SubPartNameArr2 = TArray();
   var PeriodBeg = ZeroDate, PeriodEnd = ZeroDate, PeriodName = "";
   var ActDate7047   = ZeroDate;
   var ActDateStr:String;

   var UniqStr = TUniqStrCollector();

   PeriodName = PeriodName_GetMonthsAndQuart( _MonthNum, _YearNum );
   Period_GetInterval( _MonthNum, _YearNum, @PeriodBeg, @PeriodEnd );
   //PeriodEnd = PeriodBeg + 4;

   GetRegistryValue("РСХБ\\ДАТА АКТ. Ф. 0409405 (7047-У)", V_STRING, ActDateStr, 0); //по умолчанию в настройке должна быть дата 01.01.2026

   ActDate7047 = Date(ActDateStr);
   if( ActDate7047 == ZeroDate )
      ActDate7047 = Date(01, 01, 2026);
   end;

   if (PeriodEnd >= ActDate7047)
     SubPartNameArr1[1] = "Подраздел 1. Операции по выпуску ценных бумаг, цифровых финансовых активов, покупке и продаже ценных бумаг, долей, недвижимого имущества, паев, цифровых финансовых активов, внесению вкладов в имущество, а также операции по договорам с обратной продажей (репо)";
     SubPartNameArr1[2] = "Подраздел 2. Операции по погашению основного долга (корпуса), выплатам дивидендов по акциям, процентов (купонов) по облигациям и иным ценным бумагам, цифровым финансовым активам, выкупу долей, паев, выплате распределенной части прибыли";
   else
     SubPartNameArr1[1] = "Подраздел 1. Операции по выпуску ценных бумаг, покупке и продаже ценных бумаг, долей, паев, внесению вкладов в имущество на первичном и вторичном рынках, а также операции по договорам с обратной продажей (репо)";
     SubPartNameArr1[2] = "Подраздел 2. Операции по погашению основного долга (корпуса), выплатам дивидендов по акциям, процентов (купонов) по облигациям и иным ценным бумагам, выкупу долей, паев, выплате распределенной части прибыли";
   end;
   PartNameArr[1] = SubPartNameArr1;
   SubPartNameArr2[1] = "Подраздел 1. Операции, осуществляемые в собственных интересах Банка";
   SubPartNameArr2[2] = "Подраздел 2. Операции, выгодоприобретателями по которым являются клиенты - резиденты Банка";
   PartNameArr[2] = SubPartNameArr2;

   // Получить число в виде строки с апострофами или нет
   macro NumToStr( Num )
      return PrintToStr( Num, IIF( IsExcel, false, IsApp ), true );
   end;

   macro AuditMsg():String
    var msg:string = "";
    var part1:string = "";
    var part2:string = "";

    part1 = IIF(PrintPart11,
                "Сделки с ц/б:       " +
                IIF(FirstWorkMode,
                    "Сделки банка и клиентов-резидентов с нерезидентами\n",
                    "Сделки нерезидентов с резидентами\n"),
                "");
    part2 = IIF(PrintPart12 and (Mode_Retire or Mode_Payments),
                "Погашения (включая просроченные) и выплаты:\n" +
                IIF(Mode_Retire,
                    "Операции погашения (включая просроченные) БО ЦБ\n",
                    "") +
                IIF(Mode_Payments,
                    "Операции обработки выплат в \"Депозитарии\"\n",
                    ""),
                "");

    msg = "Отчет:              Расчеты между резидентами и нерезидентами (ф.405)\n\n" +
          "Период:             " + PeriodName + "\n" +
          part1 + part2 +
          "\n----------------------------------------\n";

    return msg;
  end;
END;

// Данные строки отчета
PRIVATE CLASS TRepLineData()
   var OperDate;
   var AvrType405;
   var OperCode;
   var PaymDirectCode;
   var A7_Amount;
   var PayFIIDCode;
   var A10_SumPay;
   var A11_SumPay;
   var BIK;
   var BIK_type;
   var ResName;
   var ResCode;
   var ResPartyID;
   var NotResName;
   var NotResCode;
   var NotResPartyID;
   var IssuerName;
   var IssuerCode;
   var IssuerPartyID;
   var AvRegNum;
   var AvIssued;
   var PlanDrawDate;
   var AvFaceFICode;
   var K9;
   var K10;
   var K11;
   var K_A19EE;
   var K_A19EC;
   var K_A19ED;
   var Note;
   var Department;
   var VO_Code;
   var K_DOP1;
   var K_PSO;
   var K_RAS;
   var IsBNR;

   MACRO Init()
      OperDate = "";
      PlanDrawDate = "";
      A7_Amount = 0;
      A10_SumPay = 0; A11_SumPay = 0;
      AvrType405 = "";
      OperCode = ""; PaymDirectCode = ""; PayFIIDCode = "";
      BIK = ""; BIK_type = -1;
      ResName = ""; ResCode = ""; ResPartyID = -1;
      NotResName = ""; NotResCode = ""; NotResPartyID = -1;
      IssuerName = ""; IssuerCode = ""; IssuerPartyID = -1;
      AvRegNum = ""; AvIssued = ""; AvFaceFICode = "";
      K9 = ""; K10 = ""; K11 = ""; K_A19EE = ""; K_A19EC = ""; K_A19ED = "";
      Note = ""; Department = -1; VO_Code = "";
      K_DOP1 = ""; K_PSO = ""; K_RAS = "";
   END;

END;

PRIVATE CLASS (DL_CReportTemplate) SP_RepRespm_Report (_Data:ReportData)

  PRIVATE VAR Data:ReportData = _Data;
  PRIVATE CONST StatLine = "Выпуск отчета \"Расчеты между резидентами и нерезидентами\"";

  PRIVATE VAR Header =
  "\n" +
  "                                                                                                                                                                                                                                                                   Банковская отчетность\n" +
  "                                                                                                                                                                                                                              ┌────────────────┬───────────────────────────────────────┐\n" +
  "                                                                                                                                                                                                                              │ Код территории │  Код кредитной организации (филиала)  │\n" +
  "                                                                                                                                                                                                                              │    по ОКАТО    ├───────────────┬───────────────────────┤\n" +
  "                                                                                                                                                                                                                              │                │    по ОКПО    │ регистрационный номер │\n" +
  "                                                                                                                                                                                                                              │                │               │  (/порядковый номер)  │\n" +
  "                                                                                                                                                                                                                              │                │               │                       │\n" +
  "                                                                                                                                                                                                                              │                │               │                       │\n" +
  "                                                                                                                                                                                                                              ├────────────────┼───────────────┼───────────────────────┤\n" +
  "                                                                                                                                                                                                                              │################│###############│#######################│\n" +
  "                                                                                                                                                                                                                              └────────────────┴───────────────┴───────────────────────┘\n" +
  "\n" +
  "СВЕДЕНИЯ ОБ ОПЕРАЦИЯХ С ЦЕННЫМИ БУМАГАМИ, ДОЛЯМИ, НЕДВИЖИМЫМ ИМУЩЕСТВОМ, ПАЯМИ И ВКЛАДАМИ В ИМУЩЕСТВО, СОВЕРШЕННЫХ МЕЖДУ РЕЗИДЕНТАМИ И НЕРЕЗИДЕНТАМИ, А ТАКЖЕ ОБ ОПЕРАЦИЯХ МЕЖДУ РЕЗИДЕНТАМИ С ИНОСТРАННЫМИ ЦЕННЫМИ БУМАГАМИ, НЕДВИЖИМЫМ ИМУЩЕСТВОМ ЗА РУБЕЖОМ, ДОЛЯМИ, ПАЯМИ И ВКЛАДАМИ\n" +
  "                                                                                                                            В ИМУЩЕСТВО ИНОСТРАННЫХ КОМПАНИЙ\n" +
  "\n" +
  "                                                                                                                                      за #\n" +
  "Полное или сокращенное фирменное наименование кредитной организации #\n" +
  "Адрес (место нахождения) кредитной организации #\n" +
  "                                                                                                                                                                                                                                                               Код формы по ОКУД 0409405\n" +
  "                                                                                                                                                                                                                                                                                Месячная";

  PRIVATE VAR TableHeader1 =
  "┌────────┬──────────┬──────────┬─────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────┬────────────┐\n" +
  "│  Номер │   Дата   │ Код вида │     Код     │                               Параметры расчетов по операциям с ценными бумагами, долями, паями и вкладами в имущество                                 │           Характеристика ценной бумаги, доли, пая, вклада в имущество           │ Примечание │\n" +
  "│ строки │ операции │ валютной │ инструмента ├──────────┬─────────────┬─────────────┬────────┬─────────┬─────────────────────────────────────────┬────────────────────────────┬───────────────────────┼────────────────────────────┬─────────────────┬─────────────┬───────────┬────────┤            │\n" +
  "│        │          │ операции │             │ Код вида │     Код     │ Количество, │ Размер │   Код   │             Сумма платежа               │          Резидент          │       Нерезидент      │    Эмитент ценной бумаги   │ Регистрационный │     Дата    │    Дата   │   Код  │            │\n" +
  "│        │          │          │             │ операции │ направления │      шт.    │  доли  │  валюты │        по операции, ед. валюты          │                            │                       │   (резидент, нерезидент),  │   номер ценной  │ регистрации │ погашения │ валюты │            │\n" +
  "│        │          │          │             │          │   платежа   │             │        │ платежа │                                         │                            │                       │  с долями, паями, вкладами │      бумаги     │   выпуска   │   ценной  │ ценной │            │\n" +
  "│        │          │          │             │          │             │             │        │         │                                         │                            │                       │    в имуществе которого    │                 │    ценной   │   бумаги  │ бумаги │            │\n" +
  "│        │          │          │             │          │             │             │        │         │                                         │                            │                       │     совершены операции     │                 │    бумаги   │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         ├─────────────┬─────────────┬─────────────┼──────────────┬─────────────┼──────────────┬────────┼──────────────┬─────────────┤                 │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │    Всего    │ В том числе │  Удержано   │ Наименование │     Код     │ Наименование │   Код  │ Наименование │     Код     │                 │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │             │ выплаченные │   налога    │              │             │              │ страны │              │             │                 │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │             │  проценты   │ (справочно) │              │             │              │        │              │             │                 │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │             │  (доходы)   │             │              │             │              │        │              │             │                 │             │           │        │            │\n" +
  "├────────┼──────────┼──────────┼─────────────┼──────────┼─────────────┼─────────────┼────────┼─────────┼─────────────┼─────────────┼─────────────┼──────────────┼─────────────┼──────────────┼────────┼──────────────┼─────────────┼─────────────────┼─────────────┼───────────┼────────┼────────────┤\n" +
  "│    1   │     2    │     3    │      4      │     5    │      6      │      7      │    8   │    9    │      10     │      11     │      12     │      13      │      14     │      15      │   16   │      17      │      18     │        19       │      20     │     21    │   22   │     23     │\n" +
  "├────────┼──────────┼──────────┼─────────────┼──────────┼─────────────┼─────────────┼────────┼─────────┼─────────────┼─────────────┼─────────────┼──────────────┼─────────────┼──────────────┼────────┼──────────────┼─────────────┼─────────────────┼─────────────┼───────────┼────────┼────────────┤";

  PRIVATE VAR TableHeader1_7047 =
  "┌────────┬──────────┬──────────┬─────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────┬────────────┐\n" +
  "│  Номер │   Дата   │ Код вида │     Код     │               Параметры расчетов по операциям с ценными бумагами, долями, паями, вкладами в имущество и цифровыми финансовыми активами                 │Характеристика ценной бумаги, доли, пая, вклада в имущество, цифрового финансового актива│ Примечание │\n" +
  "│ строки │ операции │ валютной │ инструмента ├──────────┬─────────────┬─────────────┬────────┬─────────┬─────────────────────────────────────────┬────────────────────────────┬───────────────────────┼────────────────────────────┬─────────────────────────┬─────────────┬───────────┬────────┤            │\n" +
  "│        │          │ операции │             │ Код вида │     Код     │ Количество, │ Размер │   Код   │             Сумма платежа               │          Резидент          │       Нерезидент      │    Эмитент ценной бумаги   │     Регистрационный     │     Дата    │    Дата   │   Код  │            │\n" +
  "│        │          │          │             │ операции │ направления │      шт.    │  доли  │  валюты │        по операции, ед. валюты          │                            │                       │   (резидент, нерезидент),  │       номер ценной      │ регистрации │ погашения │ валюты │            │\n" +
  "│        │          │          │             │          │   платежа   │             │        │ платежа │                                         │                            │                       │  с долями, паями, вкладами │          бумаги         │   выпуска   │   ценной  │ ценной │            │\n" +
  "│        │          │          │             │          │             │             │        │         │                                         │                            │                       │    в имуществе которого    │                         │    ценной   │   бумаги  │ бумаги │            │\n" +
  "│        │          │          │             │          │             │             │        │         │                                         │                            │                       │     совершены операции     │                         │    бумаги   │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         ├─────────────┬─────────────┬─────────────┼──────────────┬─────────────┼──────────────┬────────┼──────────────┬─────────────┤                         │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │    Всего    │ В том числе │  Удержано   │ Наименование │     Код     │ Наименование │   Код  │ Наименование │     Код     │                         │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │             │ выплаченные │   налога    │              │             │              │ страны │              │             │                         │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │             │  проценты   │ (справочно) │              │             │              │        │              │             │                         │             │           │        │            │\n" +
  "│        │          │          │             │          │             │             │        │         │             │  (доходы)   │             │              │             │              │        │              │             │                         │             │           │        │            │\n" +
  "├────────┼──────────┼──────────┼─────────────┼──────────┼─────────────┼─────────────┼────────┼─────────┼─────────────┼─────────────┼─────────────┼──────────────┼─────────────┼──────────────┼────────┼──────────────┼─────────────┼─────────────────────────┼─────────────┼───────────┼────────┼────────────┤\n" +
  "│    1   │     2    │     3    │      4      │     5    │      6      │      7      │    8   │    9    │      10     │      11     │      12     │      13      │      14     │      15      │   16   │      17      │      18     │            19           │      20     │     21    │   22   │     23     │\n" +
  "├────────┼──────────┼──────────┼─────────────┼──────────┼─────────────┼─────────────┼────────┼─────────┼─────────────┼─────────────┼─────────────┼──────────────┼─────────────┼──────────────┼────────┼──────────────┼─────────────┼─────────────────────────┼─────────────┼───────────┼────────┼────────────┤";


  PRIVATE VAR TableHeader2 =
  "┌────────┬──────────┬─────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────────┬────────────┐\n" +
  "│  Номер │   Дата   │     Код     │                                                 Параметры операции                                                 │               Характеристика инструмента              │ Примечание │\n" +
  "│ строки │ операции │ инструмента ├──────────┬─────────────┬────────┬─────────┬──────────────┬────────────────────────────┬────────────────────────────┼────────────────────────────┬─────────────────┬────────┤            │\n" +
  "│        │          │             │ Код вида │ Количество, │ Размер │   Код   │     Сумма    │         Покупатель         │          Продавец          │           Эмитент          │ Регистрационный │   Код  │            │\n" +
  "│        │          │             │ операции │      шт.    │  доли  │  валюты │    платежа   │                            │                            │                            │  номер ценной   │ валюты │            │\n" +
  "│        │          │             │          │             │        │ платежа │ по операции, ├──────────────┬─────────────┼──────────────┬─────────────┼──────────────┬─────────────┤      бумаги     │ ценной │            │\n" +
  "│        │          │             │          │             │        │         │  ед. валюты  │ Наименование │     Код     │ Наименование │     Код     │ Наименование │     Код     │                 │ бумаги │            │\n" +
  "├────────┼──────────┼─────────────┼──────────┼─────────────┼────────┼─────────┼──────────────┼──────────────┼─────────────┼──────────────┼─────────────┼──────────────┼─────────────┼─────────────────┼────────┼────────────┤\n" +
  "│    1   │     2    │      3      │     4    │      5      │    6   │    7    │       8      │       9      │      10     │      11      │      12     │      13      │      14     │        15       │   16   │     17     │\n" +
  "├────────┼──────────┼─────────────┼──────────┼─────────────┼────────┼─────────┼──────────────┼──────────────┼─────────────┼──────────────┼─────────────┼──────────────┼─────────────┼─────────────────┼────────┼────────────┤";

  PRIVATE VAR IsHeaderPrinted = false;
  PRIVATE VAR IsTableHeaderPrinted1 = false;
  PRIVATE VAR IsTableHeaderPrinted2 = false;
  PRIVATE VAR WasCollectedDataForPart12 = false;

  private macro ClearGlobalTmpByIdent(tableName, idents:TArray)
        var query =
      "   delete from "+ tableName
     +"          where T_IDENTPROGRAM in ("+join( idents, "," )+")";
    RSDCommand(query).execute();
  end;

  PRIVATE VAR kliko_file_name;
  
  PRIVATE MACRO PrintMode():INTEGER
     if(Data.IsExcel)
       return DL_OUTREPORT_EXCEL;
     else
       return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
     CreateTotalBook();
  END;

  PRIVATE MACRO InExcel()
     return(( m_outmode == DL_OUTREPORT_EXCEL_NO_FORMAT) or (m_outmode ==DL_OUTREPORT_EXCEL ));
  END;

  PRIVATE MACRO EndReport()
     SaveTotalBook();
     if(InExcel())
       ReplaceAndCalculate( OUTASTEXT, " " );/*добавляем пробел - тогда сможем вывести номера строк в строковые ячейки как текст с точкой-разделителем.*/
     end;
  END;

   // Нужно ли НЕРЕЗИДЕНТА обрабатывать как РЕЗИДЕНТА
   private macro IsNotResPartyTreatedRes( partyid):bool
      var cmd, DataSet;
      cmd = RsdCommand ( "SELECT 1 " +
                        " FROM dobjatcor_dbt attr" +
                        " WHERE attr.t_ObjectType = 3 " +
                        " AND attr.t_GroupID = 16 " +
                        " AND attr.t_Object = LPAD( ?, 10, '0' ) " +
                        " AND attr.t_attrid IN ( " +  
                              PARTY_ATTR_FZ4015 + ", " +     // Филиал иностранной страховой организации по ФЗ 4015-I
                              PARTY_ATTR_FZ290 +             // Международная компания по 290-ФЗ
                        " ) " );
      cmd.addParam("partyid" , RSDBP_IN, partyid ); 
      cmd.execute();  

      DataSet = TRSBDataSet(cmd);  
      if(DataSet.MoveNext())
         return true;
      end;
      return false;
   end;

   private macro IsPartyNotRes(party):bool
      // var party : TRecHandler("party.dbt");
      if(party.NotResident == SET_CHAR)
         return (not IsNotResPartyTreatedRes(party.partyid));
      else
         return false;
      end;
   end;




  /********************************************************************************************************************
   Выгрузка в Kliko
   ********************************************************************************************************************/
  PRIVATE MACRO Kliko_InsertInTxtFile( Str:String ):Bool

     if( insert( Kliko_F405, Str ) == false )
        MsgBox( "Ошибка при вставке записи в файл Kliko" );
        return false;
     end;
     return true;
  END;

  PRIVATE MACRO Kliko_TxtFileName( PartNumber:Integer, SubPartNumber:Integer, PeriodEnd:Date ):String
     var fName = "", Day = 0, Month = 0, Year = 0;

     /* первый день месяца, следующего за отчетным. Т.е. если отчет выпускается за май 2001г, то ДДММГГ - это 010611 */
     datesplit( PeriodEnd + 1, Day, Month, Year );
     Year = SubStr( String( Year ), StrLen( String( Year ) ) - 1 );

     kliko_file_name = String( Day:2:o, Month:2:o, Year:2:o, "_F405_", IIF( PartNumber == 2, "2", "" ), SubPartNumber ); //GAA: 505493 Не удалять при адаптации!!!

     fName = GetTxtFileName( kliko_file_name );

     return fName;
  END;

  PRIVATE MACRO Kliko_CloseTxtFile()
    //var kliko_file_name_term = "$C:\\SOFR\\EXPORT\\"+kliko_file_name+".dat";
    var kliko_file_name_term = "$txtfile\\"+kliko_file_name+".dat";
//    var kliko_file_name_term = "$D:\\RSHB_SOFR_TEST\\EXPORT_KLIKO"+kliko_file_name+".dat"; //GAA: для тестирования

     if( Kliko_F405_Use )
        close( Kliko_F405 );

        if(ExistFile(kliko_file_name_term))      //GAA: Не удалять при адаптации!!!
            RemoveFile(kliko_file_name_term);
        end;

        copyFile(FileName(Kliko_F405),kliko_file_name_term,true,"Копирование на терминал"); // Golovkin 28.06.2019
        
        Kliko_F405_Use = false;
     end;
  END;

  PRIVATE MACRO Kliko_OpenTxtFile( PartNumber:Integer, SubPartNumber:Integer, PeriodEnd:Date )
     var errcode = 0, errtext = "";
     var fName = "";

     Kliko_CloseTxtFile();

     fName = Kliko_TxtFileName( PartNumber, SubPartNumber, PeriodEnd );

     if( not Open( Kliko_F405, fName ) )
        errcode = status( errtext );
        RunError( "Ошибка при открытии файла|" + fName + "|(" + errcode + ") " + errtext );
     end;
     Kliko_F405_Use = true;

     MsgBox( "Сформирован файл KLIKO - \"" + fName + "\"" );

     return Kliko_InsertInTxtFile( "<F405_" + IIF( PartNumber == 2, "2", "" ) + SubPartNumber + "N>" );
  END;

  PRIVATE MACRO Kliko_Fld( Val:VARIANT ):STRING
     VAR ValStr = "";

     if( Val != null )
        if( ValType(Val) == V_DATE )
           if( Val == DATE(0,0,0) )
              ValStr = "";
           else
              ValStr = String(Val:f);
           end;
        else
           ValStr = StrSubst( String(Val), "\"", "~^" ); // Кодируем кавычку
        end;
     end;
     return "\""+ValStr+"\"";
  END;

  /* Номер филиала */
  PRIVATE MACRO K1( RepLine:TRepLineData, IsDelta:Bool ):String
     VAR vK1 = "";
     if(ValType(IsDelta) == V_UNDEF)
       IsDelta = false;
     end;
     if( RepLine.Department > 0 )
        var PartyID = CB_GetDprtPartyID( RepLine.Department );
        if( PartyID > 0 )
           var RegNum = ПолучитьКодСубъекта( PartyID, PTCK_BANKREGNUM );
           if( (RegNum != null) and (RegNum != "") )
              var SlPos = Index( RegNum, "/" );
              if( (SlPos > 0) and (SlPos < StrLen(RegNum) ) )
                 vK1 = SubStr( RegNum, SlPos + 1, 5 );
              else
                 if(IsDelta)
                    vK1 = RegNum;
                 else
                    vK1 =  "0";
                 end;
              end;
           end;
        end;
     end;

     return vK1;
  END;

  PRIVATE VAR K_Party  = TRecHandler( "party" );

  /* Тип участника операции */
  PRIVATE MACRO K2( PartyID:Integer ):String

     if( PartyID > 0 )
        K_Party = GetPartyByID( PartyID, true, false );
        if( K_Party.PartyID > 0 )

           if( ВидСубъекта( K_Party.PartyID, PTK_BANK ) )
              return "КО";
           elif( PartyRecIsJur( K_Party ) )
              return "ЮЛ";
           elif( PartyIsEmployer( K_Party.PartyID ) )
              return "ИП";
           elif( PartyRecIsPhis( K_Party ) )
              return "ФЛ";
           end;
        end;
     end;
     return "";
  END;

  /* Тип участника операции */
  PRIVATE MACRO K5( PartyID:Integer ):String
     var isKO = false;

     if( PartyID > 0 )
        K_Party = GetPartyByID( PartyID, true, false );
        if( K_Party.PartyID > 0 )

           isKO = ( ВидСубъекта( K_Party.PartyID, PTK_BANK ) and not ВидСубъекта( K_Party.PartyID, PTK_CENTRBANK ) );

           if( PartyRecIsJur( K_Party ) and ( not isKO or ВидСубъекта( K_Party.PartyID, PTK_UNIT_INVESTMENT_FUND ) ) )
              return "ЮЛ";
           elif( isKO )
              return "КО";
           elif( PartyIsEmployer( K_Party.PartyID ) )
              return "ИП";
           elif( PartyRecIsPhis( K_Party ) )
              return "ФЛ";
           end;
        end;
     end;
     return "";
  END;
  /* Тип участника операции */
  PRIVATE MACRO K1_Delta( PartyID:Integer ):String
     if( PartyID > 0 )
        K_Party = GetPartyByID( PartyID, true, false );
        if( K_Party.PartyID > 0 )

           if( ВидСубъекта( K_Party.PartyID, PTK_BANK ) )
              return "2";
           elif( PartyRecIsJur( K_Party ) )
              return "1";
           elif( PartyIsEmployer( K_Party.PartyID ) )
              return "4";
           elif( PartyRecIsPhis( K_Party ) )
              return "3";
           end;
        end;
     end;
     return "";
  END;

  /* Тип участника операции */
  PRIVATE MACRO K2_Delta( PartyID:Integer ):String
     if( PartyID > 0 )
        K_Party = GetPartyByID( PartyID, true, false );
        if( K_Party.PartyID > 0 )

           if( PartyRecIsJur( K_Party ) )
              return "1";
           elif( PartyRecIsPhis( K_Party ) )
              return "2";
           end;
        end;
     end;
     return "";
  END;

  PRIVATE MACRO K4_5_Delta( PartyID:Integer ):String
     var isKO = false;

     if( PartyID > 0 )
        K_Party = GetPartyByID( PartyID, true, false );
        if( K_Party.PartyID > 0 )

           isKO = ( ВидСубъекта( K_Party.PartyID, PTK_BANK ) and not ВидСубъекта( K_Party.PartyID, PTK_CENTRBANK ) );

           if( PartyRecIsJur( K_Party ) and ( not isKO or ВидСубъекта( K_Party.PartyID, PTK_UNIT_INVESTMENT_FUND ) ) )
              return "1";
           elif( isKO )
              return "2";
           elif( PartyIsEmployer( K_Party.PartyID ) )
              return "4";
           elif( PartyRecIsPhis( K_Party ) )
              return "3";
           end;
        end;
     end;
     return "";
  END;
  
  /* Эмитент. Резидентность */
  PRIVATE MACRO K6( RepLine:TRepLineData ):String
     if( RepLine.IssuerPartyID > 0 )
        K_Party = GetPartyByID( RepLine.IssuerPartyID, true, false );
        if( K_Party.PartyID > 0 )
           if(IsPartyNotRes(K_Party)) // ( K_Party.NotResident == SET_CHAR )
              return "3";
           else
              return "2";
           end;
        end;
     end;
     return "0";
  END;

  private macro PaymentLastStateIsContain(PaymentID,DateTo,States:TArray):Bool
    var query =
      "   SELECT T_STATUSIDTO"
     +"     FROM DPMHIST_DBT"
     +"    WHERE T_PAYMENTID = ?"
     +"    and T_DATE <= ?"
     +" ORDER BY T_DATE DESC";
    var cmd = DL_RSDCommand(query);
    cmd.addParam(PaymentID);
    cmd.addParam(DateTo);
    var ds = cmd.execute();
    if (ds.moveNext())
      return find(States,ds.StatusIdTo) >= 0;
    end;
    return false;
  end;

  PRIVATE MACRO ПолучитьИмяСубъекта(ID)
     FILE party(party);
     ClearRecord(party);
     party.PartyID = ID;
     if(not getEQ(party))
        return "";
     end;
     return party.Name;
  END;

  /* Получаем параметры субъекта */
  PRIVATE MACRO GetPartyParam( PartyID, NotRes:@bool, IsBank:@bool, IsBrok:@bool, IsConfIDManager:@bool )
     var
        party  = TRecHandler( "party" );

     party       = GetPartyByID( PartyID, true, true );
   //   NotRes      = party.NotResident == SET_CHAR;
     if((party.NotResident != SET_CHAR) OR IsNotResPartyTreatedRes(PartyID))
         NotRes = false;
     else
         NotRes = true;
     end;
     IsBank      = ВидСубъекта( PartyID, PTK_BANK );
     if(IsBrok != NULL)
        IsBrok      = ВидСубъекта( PartyID, PTK_BROKER );
     end;
     if(IsConfIDManager != NULL)
        IsConfIDManager = ВидСубъекта( PartyID, PTK_CONFID_MANAGER);
     end;
  END;

  PRIVATE MACRO GetExtraName( PartyId, Name:@String )
      var DataSet, cmd;
      cmd = RsdCommand ( "SELECT party.t_name " +
                         " FROM dpartyname_dbt party" +
                         " WHERE party.t_partyid = ? " +
                         " AND party.t_nametypeid = 4 " );
      cmd.addParam("partyid" , RSDBP_IN, partyid ); 
      cmd.execute();  

      DataSet = TRSBDataSet(cmd);  
      if(DataSet.MoveNext())
         Name = DataSet.Name;
      end;
  END;

  PRIVATE MACRO GetNameForInvst(PartyID,FIID,IssuerName:@String, IssuerINN:@String, AvRegNum:@String)/*для сделок с паями*/

      var partyown = TBFile("partyown"),
          finin    = TBFile("fininstr");

      var ПараметрыПая;
      var AvRegNumTmp;

      IssuerName = "";

      partyown.KeyNum = 0;
      partyown.rec.PartyID = PartyID;
      partyown.rec.PartyKind = 19;

      if(GetEQ(partyown))  /*проверяем, явл. ли ПИФом*/
         finin.rec.FIID = FIID;
         if(GetEQ(finin))/*нашли анкету пая, из неё извлекаем УК*/
            if(IssuerName != "")
                IssuerName = IssuerName + ";";
            end;
            IssuerName = IssuerName + ПолучитьИмяСубъекта(finin.rec.Issuer) + " (" + ПолучитьИмяСубъекта(PartyID) + ")"; /*наименование УК и наименование ПИФа*/

            if(IssuerINN != "")
                IssuerINN = IssuerINN + ";";
            end;
            IssuerINN  = IssuerINN + GetPartyTrueINN( finin.rec.Issuer );

            ПараметрыПая = TRsbDataSet("SELECT t_RulesRegXid FROM davrinvst_dbt WHERE t_fiid = " + finin.rec.FIID);
            if(ПараметрыПая.MoveNext())
               AvRegNumTmp = string(ПараметрыПая.Value(0));
               if( trim(AvRegNumTmp) != "" )
                  AvRegNumTmp = substr(AvRegNumTmp, 1, 4);
               end;

               if(AvRegNum != "")
                  AvRegNum = AvRegNum + ";";
               end;
               AvRegNum = AvRegNum + AvRegNumTmp;
            end;

            return  true;

         end;
      end;

      return false;

  END;

   private macro PartyNeedsExtraName( partyid):bool
      var cmd, DataSet;
      cmd = RsdCommand ( "SELECT 1 " +
                        " FROM dobjatcor_dbt attr" +
                        " WHERE attr.t_ObjectType = 3 " +
                        " AND attr.t_GroupID = 16 " +
                        " AND attr.t_Object = LPAD( ?, 10, '0' ) " +
                        //   " AND ( attr.t_attrid = 14 OR attr.t_attrid = 21 ) " );
                        " AND attr.t_attrid IN ( " +  
                              PARTY_ATTR_FZ424 + ", " +      // Не предусматривает бенефициарного владельца
                              PARTY_ATTR_21 + ", " +         // Иностранный агент
                              PARTY_ATTR_FZ4015 + ", " +     // Филиал иностранной страховой организации по ФЗ 4015-I
                              PARTY_ATTR_FZ290 +             // Международная компания по 290-ФЗ
                        " ) " );
      cmd.addParam("partyid" , RSDBP_IN, partyid ); 
      //  cmd.addParam("fiid" , RSDBP_IN, fininstr.fiid );
      cmd.execute();  

      DataSet = TRSBDataSet(cmd);  
      if(DataSet.MoveNext())
         return true;
      end;
      return false;
   end;

  PRIVATE MACRO GetResidentNameCode( PartyID, fininstr, NeedOLF, OwnerID, Dealid, Name:@string, Code:@string )
    var Party = GetPartyByID( PartyID, true, true ), NotRes = false, IsBank = false;
    var PartyName = Party.Name, PartyLegalForm = Party.LegalForm;
    /*CHVA добавил отбор для резидентов на принадлежность Доверительное управление, если такая принадлежность присутствует, то в поле "резидент" выводим наименование договора по сделке  */
    var cmd, DataSet;
	var own = false;
    var NameRes = ""; 	
    
    cmd = RsdCommand ( " Select partyown.t_partykind, contr.t_name nameres from dparty_dbt party, dpartyown_dbt partyown , ddl_tick_dbt tick, dsfcontr_dbt contr" +
                       "  where  party.t_partyid  = ? and party.t_partyid  = partyown.t_partyid and tick.t_dealid = ? and  tick.t_clientcontrid = contr.t_id");

    cmd.addParam("partyid" , RSDBP_IN, partyid ); 
    cmd.addParam("dealid" , RSDBP_IN, dealid );  	
    cmd.execute();  

    DataSet = TRSBDataSet(cmd);  

    while (DataSet.MoveNext()) 
       if (Dataset.partykind == 65)
         own = true;
         NameRes = DataSet.nameres;
       end;
    end;
   /*CHVA */
    var ExtrName = false;
    ExtrName = PartyNeedsExtraName( partyid);

    GetPartyParam( PartyID, @NotRes, @IsBank );
    // для паёв ищем ПИФ
    if( ( fininstr.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE )
    and not NotRes
    and GetNameForInvst( PartyID, fininstr.FIID, @Name, @Code ) )
    else
      /*var IssuerNotRes;
      GetPartyParam(fininstr.Issuer, @IssuerNotRes);
      if((OwnerID > 0) and (OwnerID != {OurBank}) and (not IssuerNotRes) and FI_IsDeposReceipt(fininstr.FIID))
         Code = GetPartyTrueINN( PartyID );
      else*/
         if( (PartyLegalForm == legal_form_jur) and (not NotRes)  )
           if( NeedOLF )
             Name = PartyGetOrgLegFormsName( PartyID, true );
             if( Name == "" )
               Data.UniqStr.AddString( "Для субъекта \"" + PartyName + "\" не задано значение категории \"Организационно-правовые формы\"");
             else
               Name = Name + " ";
             end;
           end;
       if (own) /*CHVA*/
           Name = NameRes;
       else
           Name = Name +PartyName;//Upg 54 перенес из пользовательских (GAA)
       end;
           if( IsBank )
             Code = GetPartyRegNum( PartyID );
   
             if( Code == "" )
               // Выводим сообщение, если код не задан (#59157)
               Data.UniqStr.AddString( "Для субъекта \"" + PartyName + "\" не задан код вида \"Рег. номер кредитной организации\"");
             end;
           else
             Code = GetPartyTrueINN( PartyID );
           end;
         elif( PartyLegalForm == legal_form_phys )
           Name = IIF( PartyIsEmployer( PartyID ), "ИП", "ФЛ" );
           Code = "";
         end;
      //end;
    end;
    if( ExtrName )
       GetExtraName(PartyId, @Name);
    end;
  END;

  PRIVATE MACRO GetPayerReceiverInfo( Data, OwnerID, IssuerID, fininstr, RepLine )
    // A2.9 - A2.10 - покупатель/код
    RepLine.ResPartyID = OwnerID;
    GetResidentNameCode( RepLine.ResPartyID, fininstr, true, OwnerID, @RepLine.ResName, @RepLine.ResCode );

    // A2.11 - A2.12 - продавец/код
    RepLine.NotResPartyID = IssuerID;
    GetResidentNameCode( RepLine.NotResPartyID, fininstr, true, OwnerID, @RepLine.NotResName, @RepLine.NotResCode );
  END;

  // Если <A4> имеет значение из списка "DOL1, DOL2, DOL3, DOL4, DOL5, DOL7, ОТН3, ОТН4", то графа не заполняется
  PRIVATE MACRO Exclude_A7( AvrType405 ):BOOL
      return((AvrType405 != "") and ( Index( "DOL1,DOL2,DOL3,DOL4,DOL5,DOL7,OTH3,OTH4", AvrType405 ) != 0 ));
  END;

  PRIVATE MACRO CutPtName( Str:string )
     return SubStr( Str, 1, 250 );
  END;

  // обрезаем постфикс, если есть
  PRIVATE MACRO DeltaPtCode( Str:string )
     var Res = str, Ind = Index(Res,"-");
     if (Ind > 0)
         Res = SubStr(Res,1,Ind-1);
     end;
     return Res;
  END;

  PRIVATE MACRO Delta_Export( PartNumber:Integer, SubPartNumber:Integer, LineNum:Integer, RepLine:TRepLineData )
    if( PartNumber == 1 )
    
      Data.DeltaReport.AddLineP1(
      PartNumber,
      SubPartNumber,
      LineNum,
      
      K1_Delta(RepLine.ResPartyID),
      K2_Delta(RepLine.NotResPartyID),
      
      /*IIF( LineNum != 0, IIF( InExcel(), OUTASTEXT, "" ) + "1." + SubPartNumber + "." + LineNum, "" ),*/
      K1(RepLine, true),
      RepLine.OperDate,
      RepLine.VO_Code,
      RepLine.AvrType405,
      RepLine.OperCode,
      RepLine.PaymDirectCode,
      IIF( ((not RepLine.IsBNR) and Exclude_A7( RepLine.AvrType405 )), "", RepLine.A7_Amount ),
      "", 
      RepLine.PayFIIDCode, 
      RepLine.A10_SumPay,
      RepLine.A11_SumPay,
      $0,
      RepLine.ResName,
      DeltaPtCode(RepLine.ResCode),
      RepLine.NotResName,
      DeltaPtCode(RepLine.NotResCode),
      RepLine.AvIssued,
      RepLine.PlanDrawDate,
      RepLine.AvFaceFICode,
      
      IIF ((RepLine.Note == "РАССРОЧКА"), RepLine.Note, ""),
      IIF ((RepLine.Note == "ПАКЕТ"),     RepLine.Note, ""),
      RepLine.Note,
      CutPtName( RepLine.K10 ),
      RepLine.K11,
      CutPtName( RepLine.K_A19EC ),
      RepLine.K_A19ED,
      "",
      IIF ((RepLine.Note == "СобственныеБумаги"), RepLine.Note, ""),
      
      K6( RepLine ),
      
      RepLine.IssuerName,
      RepLine.IssuerCode,
      RepLine.AvRegNum
      );
    elif( PartNumber == 2 )
    
      Data.DeltaReport.AddLineP2(
      PartNumber,
      SubPartNumber,
      LineNum,
      
      K4_5_Delta(RepLine.ResPartyID),
      K4_5_Delta(RepLine.NotResPartyID),
      
      /*IIF( LineNum != 0, IIF( InExcel(), OUTASTEXT, "" ) + "2." + SubPartNumber + "." + LineNum, "" ),*/
      K1(RepLine, true),
      RepLine.OperDate,
      RepLine.AvrType405,
      RepLine.OperCode,
      IIF( ((not RepLine.IsBNR) and Exclude_A7( RepLine.AvrType405 )), "", RepLine.A7_Amount ),
      "",
      RepLine.PayFIIDCode, 
      RepLine.A10_SumPay, 
      RepLine.ResName,
      DeltaPtCode(RepLine.ResCode),
      RepLine.NotResName,
      DeltaPtCode(RepLine.NotResCode),
      RepLine.AvFaceFICode,
      
      IIF ((RepLine.Note == "РАССРОЧКА"), RepLine.Note, ""),
      IIF ((RepLine.Note == "ПАКЕТ"),     RepLine.Note, ""),
      RepLine.Note,
      IIF ((RepLine.Note == "СобственныеБумаги"), RepLine.Note, ""),
      
      K6( RepLine ),
      
      RepLine.IssuerName,
      RepLine.IssuerCode,
      RepLine.AvRegNum
      );
    end;
  END;

  PRIVATE MACRO Kliko_Export( PartNumber:Integer, SubPartNumber:Integer, RepLine:TRepLineData ):BOOL

     if( PartNumber == 1 )
        return Kliko_InsertInTxtFile( /*1  "А0    */ Kliko_Fld( K1( RepLine, false )                ) + "," + // Номер филиала
                                      /*2  "А1    */ Kliko_Fld( RepLine.OperDate                    ) + "," + // Дата операции
                                      /*3  "А2    */ Kliko_Fld( RepLine.AvrType405                  ) + "," + // Код инструмента
                                      /*4  "А3    */ Kliko_Fld( RepLine.OperCode                    ) + "," + // Код вида операции
                                      /*5  "А4    */ Kliko_Fld( RepLine.PaymDirectCode              ) + "," + // Код направления платежа
                                      /*6  "А5    */ Kliko_Fld( IIF( ((not RepLine.IsBNR) and Exclude_A7( RepLine.AvrType405 )), "", RepLine.A7_Amount ) ) + "," + // Колво ц/б, шт. (долей)
                                      /*7  "А6    */ Kliko_Fld( RepLine.PayFIIDCode                 ) + "," + // Код валюты платежа
                                      /*8  "А7    */ Kliko_Fld( Money( RepLine.A10_SumPay )         ) + "," + // Сумма платежа по операции, валютный единиц/всего
                                      /*9  "А8    */ Kliko_Fld( IIF( ( RepLine.A11_SumPay != "" ), Money( RepLine.A11_SumPay ), "" ) ) + "," + // сумма платежа по опе-рации, валютный единиц/в том числе вы-плаченные проценты (доходы)
                                      /*10 "А9    */ Kliko_Fld( CutPtName(RepLine.ResName) ) + "," + // Резидент. Наименование
                                      /*11 "А9А   */ Kliko_Fld( K2( RepLine.ResPartyID )            ) + "," + // Резидент. Тип участника операции
                                      /*12 "А9В   */ Kliko_Fld( ""                                  ) + "," +
                                      /*13 "А9С   */ Kliko_Fld( ""                                  ) + "," +
                                      /*14 "А10   */ Kliko_Fld( SubStr( RepLine.ResCode, 1, 10 )    ) + "," + // Резидент. Код
                                      /*15 "А11   */ Kliko_Fld( CutPtName( RepLine.NotResName )     ) + "," + // Нерезидент. Наименование
                                      /*16 "А11А  */ Kliko_Fld( K2( RepLine.NotResPartyID )         ) + "," + // Нерезидент. Тип участника операции
                                      /*17 "А12   */ Kliko_Fld( RepLine.NotResCode                  ) + "," + // Нерезидент. Код страны
                                      /*18 "А13   */ Kliko_Fld( CutPtName( RepLine.IssuerName )     ) + "," + // Эмитент ценной бумаги (резидент, нерезидент), с долями, паями, вкладами в имуществе которых совершены операции). Наименование
                                      /*19 "А14   */ Kliko_Fld( SubStr( RepLine.IssuerCode, 1, 12 ) ) + "," + // Эмитент ценной бумаги (резидент, нерезидент), с долями, паями, вкладами в имуществе которых совершены операции). Код
                                      /*20 "А15   */ Kliko_Fld( SubStr( RepLine.AvRegNum, 1, 50 )   ) + "," + // Регистрационный номер ценной бумаги
                                      /*21 "А16   */ Kliko_Fld( RepLine.AvIssued                    ) + "," + // Дата регистрации выпуска ценной бумаги
                                      /*22 "А17   */ Kliko_Fld( RepLine.PlanDrawDate                ) + "," + // Дата погашения ценной бумаги
                                      /*23 "А18   */ Kliko_Fld( RepLine.AvFaceFICode                ) + "," + // Код валюты ценной бумаги
                                      /*24 "А18А  */ Kliko_Fld( K6( RepLine )                       ) + "," + // Эмитент. Резидентность
                                      /*25 "А18В  */ Kliko_Fld( ""                                  ) + "," +
                                      /*26 "А19   */ Kliko_Fld( SubStr( RepLine.Note, 1, 250 )      ) + "," + // Примечание
                                      /*27 "А19А  */ Kliko_Fld( ""                                  ) + "," +
                                      /*28 "А19В  */ Kliko_Fld( ""                                  ) + "," +
                                      /*29 "А19С  */ Kliko_Fld( IIF( ( RepLine.Note == "рассрочка" ), "РАССРОЧКА", "" ) ) + "," + // Примечание. Рассрочка
                                      /*30 "А19D  */ Kliko_Fld( ""                                  ) + "," +
                                      /*31 "А19Е  */ Kliko_Fld( RepLine.K9                          ) + "," + // Примечание. Контрагент
                                      /*32 "А19ЕА */ Kliko_Fld( CutPtName( RepLine.K10 )            ) + "," + // Наименование Банка 2
                                      /*33 "А19ЕВ */ Kliko_Fld( RepLine.K11                         ) + "," + // Цифровой код страны Банка 2
                                      /*34 "А19ЕС */ Kliko_Fld( CutPtName( RepLine.K_A19EC )        ) + "," +
                                      /*35 "А19ЕD */ Kliko_Fld( RepLine.K_A19ED                     ) + "," +
                                      /*36 "А20   */ Kliko_Fld( ""                                  ) + "," +
                                      /*37 "А21   */ Kliko_Fld( ""                                  ) + "," +
                                      /*38 "А19ЕЕ */ IIF( SubPartNumber == 1, Kliko_Fld( RepLine.K_A19EE ) + ",", "" ) +
                                      /*39 "KVVOP"*/ Kliko_Fld( RepLine.VO_Code                     ) + "," +
                                      /*40 "RD"   */ Kliko_Fld( IIF( ( RepLine.AvrType405 == "DOL1" ) or ( RepLine.AvrType405 == "DOL2" ), "0.00", "" ) ) + "," + // Размер доли
                                      /*41 "PSO"  */ IIF( SubPartNumber == 1, Kliko_Fld( RepLine.K_PSO ) , "") + "," + // Признак собственных операций GAA:497465 
// GAA:497465, old:                                     /*41 "PSO"  */ Kliko_Fld( RepLine.K_PSO                       ) + "," + // Признак собственных операций
                                      /*42 "NALOG"*/ Kliko_Fld( ""                                  ) );      // Удержано налога (справочно)

     else
        return Kliko_InsertInTxtFile( /*1  "NST"  */ Kliko_Fld( 0                                   ) + "," + // Номер строки
                                      /*2  "G0"   */ Kliko_Fld( K1( RepLine, false )                ) + "," + // Номер филиала
                                      /*3  "G2"   */ Kliko_Fld( RepLine.OperDate                    ) + "," + // Дата операции
                                      /*4  "G3"   */ Kliko_Fld( RepLine.AvrType405                  ) + "," + // Код инструмента
                                      /*5  "G4"   */ Kliko_Fld( RepLine.OperCode                    ) + "," + // Код вида операции
                                      /*6  "G5"   */ Kliko_Fld( IIF( ((not RepLine.IsBNR) and Exclude_A7( RepLine.AvrType405 )), "", RepLine.A7_Amount ) ) + "," + // Количество, штук
                                      /*7  "G6"   */ Kliko_Fld( ""                                  ) + "," + // Размер доли
                                      /*8  "G7"   */ Kliko_Fld( RepLine.PayFIIDCode                 ) + "," + // Код валюты платежа
                                      /*9  "G8"   */ Kliko_Fld( Money( RepLine.A10_SumPay )         ) + "," + // Сумма платежа по операции, валют.единиц.
                                      /*10 "K4"   */ Kliko_Fld( K5( RepLine.ResPartyID )            ) + "," + // Условный код для контроля информации о покупателе
                                      /*11 "G9"   */ Kliko_Fld( CutPtName( RepLine.ResName )        ) + "," + // Покупатель. Наименование
                                      /*12 "G10"  */ Kliko_Fld( SubStr( RepLine.ResCode, 1, 10 )    ) + "," + // Покупатель. Код
                                      /*13 "K5"   */ Kliko_Fld( K5( RepLine.NotResPartyID )         ) + "," + // Условный код для контроля информации о продавце
                                      /*14 "G11"  */ Kliko_Fld( CutPtName( RepLine.NotResName )     ) + "," + // Продавец. Наименование
                                      /*15 "G12"  */ Kliko_Fld( SubStr( RepLine.NotResCode, 1, 10 ) ) + "," + // Продавец. Код
                                      /*16 "K3"   */ Kliko_Fld( K6( RepLine )                       ) + "," + // Эмитент: 0-нет информ. 2-резидент 3-нерезидент
                                      /*17 "VKEM" */ Kliko_Fld( 0                                   ) + "," + // Эмитент. Внутр. код э-та(запол-ся программой, иначе-0)
                                      /*18 "G13"  */ Kliko_Fld( CutPtName( RepLine.IssuerName )     ) + "," + // Эмитент ц.б. Наименование
                                      /*19 "G14"  */ Kliko_Fld( SubStr( RepLine.IssuerCode, 1, 12 ) ) + "," + // Эмитент ц.б. Код
                                      /*20 "G15"  */ Kliko_Fld( SubStr( RepLine.AvRegNum, 1, 50 )   ) + "," + // Регистрационный номер ц.б.
                                      /*21 "G16"  */ Kliko_Fld( RepLine.AvFaceFICode                ) + "," + // Код валюты ц.б.
                                      /*22 "G17"  */ Kliko_Fld( SubStr( RepLine.Note, 1, 250 )      ) + "," + // Примечание
                                      /*23 "PAKET"*/ Kliko_Fld( ""                                  ) + "," + // Для платежей за пакет из ц.б. разных эмитентов
                                      /*24 "DOP1" */ IIF( SubPartNumber == 1, Kliko_Fld( RepLine.K_DOP1 ) + ",", "" ) + // Дата операции по первой части сделки
                                      /*25 "PSO"  */ Kliko_Fld( RepLine.K_PSO                       ) + "," + // Признак собственных операций
                                      /*26 "RAS"  */ Kliko_Fld( RepLine.K_RAS                       ) );      // Признак Рассрочка
     end;
  END;
  /*********************************************************************************************************************/

  /* Печать заголовка отчета */
  PRIVATE MACRO PrintHeader( Data )
     var OurBank = null;

     if( not IsHeaderPrinted )
        OurBank = TRecHandler( "party.dbt" );

        ПолучитьСубъекта({OurBank}, OurBank);

        PrintFormatString( Header,
                           "N1_OKATO:c",      DL_GetOkatoCode( {OurBank}, Data.PeriodEnd ),
                           "N1_OKPO:c",       OurBank.rec.OKPO,
                           "N1_BANKREGNUM:c", ПолучитьКодСубъекта( {OurBank}, PTCK_BANKREGNUM ),
                           "N1_H0_1",         Substr( Data.PeriodName, 1, Index( Data.PeriodName, "год" ) ) + ".",
                           "N1_H0_2",         OurBank.rec.ShortName,
                           "N1_H0_3",         DL_GetRealAddress( {OurBank} ) );

        CopyAllSheetInTotalBook( "Отчет1", false, "N1_Header", 0, "Отчет1", false );

        IsHeaderPrinted = true;
     end;
  END;

  /* Печать заголовка таблицы 1-го раздела */
  PRIVATE MACRO PrintTableHeader1( Data )
     PrintHeader( Data );

     if( not IsTableHeaderPrinted1 )
        PrintFormatString( "\n#", "N1_PartitionHeader1", "Раздел 1. Сведения об операциях с ценными бумагами, долями, недвижимым имуществом, паями и вкладами в имущество, совершенных между резидентами и нерезидентами" );
        CopyAllSheetInTotalBook( "Отчет1", false, "N1_PartitionHeader1", 1, "Отчет1", false );

        CopyAllSheetInTotalBook( "Отчет1", false, "N1_TableHeader1", 0, "Отчет1", false );
        RegisterTable( "N1_Table1", TableHeader1,
                       "N1_A1", "N1_A2", "N1_A3", "N1_A4", "N1_A5", "N1_A6", "N1_A7", "N1_A8", "N1_A9", "N1_A10",
                       "N1_A11", "N1_A12", "N1_A13", "N1_A14", "N1_A15", "N1_A16", "N1_A17", "N1_A18", "N1_A19", "N1_A20",
                       "N1_A21", "N1_A22", "N1_A23" );

        IsTableHeaderPrinted1 = true;
     end;
  END;

  /* Печать заголовка таблицы 1-го раздела */
  PRIVATE MACRO PrintTableHeader1_7047( Data )
     PrintHeader( Data );

     if( not IsTableHeaderPrinted1 )
        PrintFormatString( "\n#", "N1_PartitionHeader1", "Раздел 1. Сведения об операциях с ценными бумагами, долями, недвижимым имуществом, паями, вкладами в имущество и цифровыми финансовыми активами, совершенных между резидентами и нерезидентами" );
        CopyAllSheetInTotalBook( "Отчет1", false, "N1_PartitionHeader1", 1, "Отчет1", false );

        CopyAllSheetInTotalBook( "Отчет1", false, "N1_TableHeader1", 0, "Отчет1", false );
        RegisterTable( "N1_Table1", TableHeader1_7047,
                       "N1_A1", "N1_A2", "N1_A3", "N1_A4", "N1_A5", "N1_A6", "N1_A7", "N1_A8", "N1_A9", "N1_A10",
                       "N1_A11", "N1_A12", "N1_A13", "N1_A14", "N1_A15", "N1_A16", "N1_A17", "N1_A18", "N1_A19", "N1_A20",
                       "N1_A21", "N1_A22", "N1_A23" );

        IsTableHeaderPrinted1 = true;
     end;
  END;

  /* Печать заголовка таблицы 2-го раздела */
  PRIVATE MACRO PrintTableHeader2( Data )
     if( not IsTableHeaderPrinted2 )
        PrintFormatString( "\n#", "N2_PartitionHeader2", "Раздел 2. Сведения об операциях между резидентами с иностранными ценными бумагами, недвижимым имуществом за рубежом, долями, паями и вкладами в имущество иностранных компаний" );
        CopyAllSheetInTotalBook( "Отчет2", false, "N2_PartitionHeader2", 1, "Отчет2", false );

        CopyAllSheetInTotalBook( "Отчет2", false, "N2_TableHeader2", 0, "Отчет2", false );
        RegisterTable( "N2_Table2", TableHeader2,
                       "N2_AA1", "N2_AA2", "N2_AA3", "N2_AA4", "N2_AA5", "N2_AA6", "N2_AA7", "N2_AA8", "N2_AA9", "N2_AA10",
                       "N2_AA11", "N2_AA12", "N2_AA13", "N2_AA14", "N2_AA15", "N2_AA16", "N2_AA17" );

        IsTableHeaderPrinted2 = true;
     end;
  END;

  /* Печать заголовка подраздела 1-го раздела */
  PRIVATE MACRO PrintSubPartitionHeader1( Data, SubPartNumber, NotEmpty )
     if (Data.PeriodEnd >= Data.ActDate7047)
       PrintTableHeader1_7047( Data );
     else
       PrintTableHeader1( Data );
     end;

     Merge( "N1_A1", "N1_A22", null );
     PrintTableLine( "N1_A1:l", Data.PartNameArr[1][SubPartNumber], null );

     if( Data.Kliko ) // and NotEmpty )  - 28.01.2021 MAA: iSupport - 522376
        Kliko_OpenTxtFile( 1, SubPartNumber, Data.PeriodEnd );
     end;
  END;

  /* Печать заголовка подраздела 2-го раздела */
  PRIVATE MACRO PrintSubPartitionHeader2( Data, SubPartNumber, NotEmpty )
     PrintTableHeader2( Data );

     Merge( "N2_AA1", "N2_AA17", null );
     PrintTableLine( "N2_AA1:l", Data.PartNameArr[2][SubPartNumber], null );

     if( Data.Kliko ) // and NotEmpty )  - 28.01.2021 MAA: iSupport - 522376
        Kliko_OpenTxtFile( 2, SubPartNumber, Data.PeriodEnd );
     end;
  END;

  /* Печать одной строки отчета 1-го раздела */
  PRIVATE MACRO PrintRepLine1( Data, SubPartNumber, LineNum, RepLine )
     PrintTableLine( "N1_A1", IIF( LineNum != 0, IIF( InExcel(), OUTASTEXT, "" ) + "1." + SubPartNumber + "." + LineNum, "" ), null,
                     "N1_A2", RepLine.OperDate, null,
                     "N1_A3", RepLine.VO_Code, null,
                     "N1_A4", RepLine.AvrType405, null,
                     "N1_A5", RepLine.OperCode, null,
                     "N1_A6", RepLine.PaymDirectCode, null,
                     "N1_A7", IIF( ((not RepLine.IsBNR) and Exclude_A7( RepLine.AvrType405 )), "", Data.NumToStr( RepLine.A7_Amount ) ), null,
                     "N1_A8", "", null,
                     "N1_A9", RepLine.PayFIIDCode, null,
                     "N1_A10", Data.NumToStr( RepLine.A10_SumPay ), null,
                     "N1_A11", Data.NumToStr( RepLine.A11_SumPay ), null,
                     "N1_A12", "", null,
                     "N1_A13", RepLine.ResName, null,
                     "N1_A14", RepLine.ResCode, null,
                     "N1_A15", RepLine.NotResName, null,
                     "N1_A16", RepLine.NotResCode, null,
                     "N1_A17", RepLine.IssuerName, null,
                     "N1_A18", RepLine.IssuerCode, null,
                     "N1_A19", RepLine.AvRegNum, null,
                     "N1_A20", RepLine.AvIssued, null,
                     "N1_A21", RepLine.PlanDrawDate, null,
                     "N1_A22", RepLine.AvFaceFICode, null,
                     "N1_A23", RepLine.Note, null );

     RepLine.Department = {OperDprt};
     if( Data.Kliko and ( LineNum != 0 ) )
        Kliko_Export( 1, SubPartNumber, RepLine );
     end;
     if( Data.Delta and ( LineNum != 0 ) )
        Delta_Export( 1, SubPartNumber, LineNum, RepLine );
     end;
  END;

  /* Печать одной строки отчета 2-го раздела */
  PRIVATE MACRO PrintRepLine2( Data, SubPartNumber, LineNum, RepLine )
     PrintTableLine( "N2_AA1", IIF( LineNum != 0, IIF( InExcel(), OUTASTEXT, "" ) + "2." + SubPartNumber + "." + LineNum, "" ), null,
                     "N2_AA2", RepLine.OperDate, null,
                     "N2_AA3", IIF((Index( "BON5,BON6,BON7,SHS5,SHS6,SHS7,SHS9,SHS10,SN3,SN4,BIL5,BIL6,BIL7,DR2,DS2,DOL2,DOL7,OTHER,OTH2", RepLine.AvrType405 ) != 0), RepLine.AvrType405, ""), null,
                     "N2_AA4", RepLine.OperCode, null,
                     "N2_AA5", IIF( ((not RepLine.IsBNR) and Exclude_A7( RepLine.AvrType405 )), "", Data.NumToStr( RepLine.A7_Amount ) ), null,
                     "N2_AA6", "", null,
                     "N2_AA7", RepLine.PayFIIDCode, null,
                     "N2_AA8", Data.NumToStr( RepLine.A10_SumPay ), null,
                     "N2_AA9", RepLine.ResName, null,
                     "N2_AA10", RepLine.ResCode, null,
                     "N2_AA11", RepLine.NotResName, null,
                     "N2_AA12", RepLine.NotResCode, null,
                     "N2_AA13", RepLine.IssuerName, null,
                     "N2_AA14", RepLine.IssuerCode, null,
                     "N2_AA15", RepLine.AvRegNum, null,
                     "N2_AA16", RepLine.AvFaceFICode, null,
                     "N2_AA17", RepLine.Note, null );

     RepLine.Department = {OperDprt};
     if( Data.Kliko and ( LineNum != 0 ) )
        Kliko_Export( 2, SubPartNumber, RepLine );
     end;
     if( Data.Delta and ( LineNum != 0 ) )
        Delta_Export( 2, SubPartNumber, LineNum, RepLine );
     end;
  END;

  PRIVATE MACRO AddFooter()
     var Executer = DepoExecuter({oper});
     var NamePhone = "Телефон исполнителя:";
     var MaxLength = strlen( NamePhone );

     if( m_UseTemplate )
        PrintFormatString( "N2_Footer",
                           "N2_ДолжностьДиректора",     {Name_Boss},
                           "N2_Директор",               "(" + {FIO_Boss} + ")",
                           "N2_ДолжностьОперациониста", Executer.Post,
                           "N2_Операционист",           "(" + Executer.Name + ")",
                           "N2_Телефон",                Executer.PhoneNumber,
                           "N2_ДатаСоставления",        DL_DateToStr( {curdate}, true ) );
     else
        MaxLength = max( max( strLen( {Name_Boss} ), strLen( Executer.Post ) ), strlen( NamePhone ) );

        PrintFormatString( " " );
        PrintFormatString( strRPad( {Name_Boss}, MaxLength, " " ) + "          (" + {FIO_Boss}+")" );
        PrintFormatString( " " );
        PrintFormatString( strRPad( Executer.Post, MaxLength, " " ) + "          (" + Executer.Name + ")" );
        PrintFormatString( " " );
        PrintFormatString( strRPad( NamePhone, MaxLength, " " ) + "          " + Executer.PhoneNumber );
        PrintFormatString( " " );
        PrintFormatString( DL_DateToStr( {curdate}, true ) );
     end;
  END;

  /* Печать подвала отчета */
  PRIVATE MACRO PrintFoot( Data )
    AddFooter();
    CopyAllSheetInTotalBook( "Отчет2", false, "N2_Footer", 1, "Отчет2", false );
  END;

  /* Печать протокола ошибок */
  PRIVATE MACRO PrintProtocol( Data )
     var Counter = 0;

     if(Data.UniqStr.Size > 0)
       InitProgress(Data.UniqStr.Size, "Печать протокола", "Печать протокола");

       while( Counter < Data.UniqStr.Size )
         MsgBox( Data.UniqStr.( Counter ) );
         UseProgress(Counter = Counter + 1);
       end;

       RemProgress();
     end;
  END;

  /* Получаем код финансового инструмента. Если он 810, то возвращаем 643. */
  PRIVATE MACRO GetFICode( FIID )
     var
        FICode = GetFinInstr( FIID ).ISO_Number;

     return IIF( FICode == {ISONatCur}, "643", FICode );
  END;

   private macro GetFaceValueFICode(fiid)
      var ret = "";
      var Select = DL_RSDCommand("select t_FaceValueFI from dfininstr_dbt where t_FIID = ?");
      Select.AddParam(fiid);
      var DataSet = Select.Execute();
      if(DataSet.MoveNext())
         ret = GetFICode(DataSet.FaceValueFI);
      end;
      return ret;
   end;

   private macro GetFaceValueFICodeIfSetFaceValue(fiid):string
      var ret = "";
      var Select = DL_RSDCommand("select t_FaceValueFI, t_facevalue from dfininstr_dbt where t_FIID = ?");
      Select.AddParam(fiid);
      var DataSet = Select.Execute();
      if(DataSet.MoveNext())
         if(DataSet.facevalue != $0)
            ret = GetFICode(DataSet.FaceValueFI);
         end;
      end;
      return ret;
   end;

   // получить Функциональная валюта для ф.405
   PRIVATE macro GetCodeCurrency405(fiid)
      var FICode = 0;
      var sqltxt = RSDCommand("select t.t_nameobject "+
                              "  from dobjatcor_dbt attr " +
                              "  join dobjattr_dbt t on T.T_OBJECTTYPE = attr.t_ObjectType and T.T_GROUPID = attr.t_GroupID and T.T_ATTRID = attr.t_attrid " +
                              " where attr.t_ObjectType = ? "+
                              "   and attr.t_GroupID = 69 " +        // Функциональная валюта для ф.405
                              "   AND attr.t_Object = LPAD( ?, 10, '0' )"
                              
                              );

      sqltxt.addParam("", RSDBP_IN, OBJTYPE_AVOIRISS);
      sqltxt.addParam("", RSDBP_IN, fiid);
      sqltxt.execute();

      var DataSql = TRsbDataSet(sqltxt);

      if( DataSql.MoveNext() )
         FICode = DataSql.nameobject;
      end;

      return FICode;
   end;


   // Проверяем подходит ли бумага для выпуска по ней отчета.
   // Возвращаем true, если бумага подходит.
   // Отчет формируется только по акциям, облигациям и депозитарным распискам.
  PRIVATE MACRO IsGoodAvoir( Data, FIID, Issuer:@integer )
     record avoir(avoiriss);
     record fininstr(fininstr);
     file _fininstr(fininstr);
     var AvoirKind;

     Issuer = 0;

     _fininstr.fiid = FIID;
     if(GetEQ(_fininstr))
        AvoirKind = _fininstr.AvoirKind;
     else
        AvoirKind = 0;
     end;

     var is_good_avoir : bool = false;

     if( FI_IsBond(FIID) or FI_IsShare(FIID, true) or ( AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE ) )
        if( not ПолучитьФинИн(FIID, fininstr, avoir) )
           Issuer = FI_GetIssuerOnDate (fininstr, Data.PeriodEnd);
           is_good_avoir = true;
        else
           RunError("Ошибка при получении параметров финансового инструмента (FIID = " + string(FIID) + ").");
        end;
     end;

     return is_good_avoir;
  END;

  /* Получаем числовой код страны нерезидента. Если страна не задана, то
     возвращаем 999.
     Если нерезидент является международной организацией (в анкете субъекта есть принадлежность "Международная организация"),
     то  вместо кода страны выводится текст "998"
  */
  PRIVATE MACRO FL290( PartyID )
     var query =
      "   SELECT T_PARTYKIND"
     +"     FROM DPARTYOWN_DBT"
     +"    WHERE T_PARTYID = ?";
    var cmd = DL_RSDCommand(query);
    cmd.addParam(PartyID);
    var ds = cmd.execute();
    while (ds.moveNext())
      if(ds.PartyKind == 94)
        return true;   
      end;
    end;
    return false;
  END;

  PRIVATE MACRO GetNotResCountryNumCode( PartyRec )
     if( FL290( PartyRec.PartyID ) )
        return "996";
     end;
     if( ВидСубъекта( PartyRec.PartyID, 34 /*Международная организация*/ ) )
        return "998";
     end;

     var
        NumCode = SC_GetCountryByCodeLat3( PartyRec.NRCountry ).CodeNum3;

     return IIF( NumCode == "", "999", NumCode );
  END;

  /*проверяем, что контрагент совершает сделку в интересах своего клиента-нерезидента или клиента-резидента */
  PRIVATE MACRO КлиентКонтрагента( DealID:integer, ContrID:integer, ClientID:@integer )

     record contrclient("party.dbt");
     var deal = TRecHandler( "dl_tick" );

     ClientID = 0;
     deal = GetDealFileByID( DealID, true );

     if( deal )
        if( GetLinkedObject( 1, OBJTYPE_SECDEAL, UniID( deal, OBJTYPE_SECDEAL ), OBJTYPE_PARTY, contrclient) == 0 )
           if( ПолучитьСубъекта(contrclient.PartyID, contrclient) == 0 )
              ClientID = contrclient.PartyID;
            //   if(contrclient.NotResident == SET_CHAR)
            //      return НЕРЕЗИДЕНТ;
            //   else
            //      return РЕЗИДЕНТ;
            //   end;
              if((contrclient.NotResident != SET_CHAR) OR IsNotResPartyTreatedRes(ClientID))
                 return РЕЗИДЕНТ;
              else
                 return НЕРЕЗИДЕНТ;
              end;
           else
              RunError( "Не могу получить субъекта (PartyID = " + string(contrclient.PartyID) + ")." );
           end;
        end;
     end;

     return НЕ_НАЙДЕН;
  END;

  /*получить эмитента базового актива деп. расписки*/
  PRIVATE MACRO ЭмитентБазовогоАктиваДР( fin:variant, ClientID:@integer )
     record srcfin("fininstr.dbt");

     if( GetLinkedObject( 10, OBJTYPE_AVOIRISS, UniID( fin, OBJTYPE_AVOIRISS ), OBJTYPE_AVOIRISS, srcfin) == 0 )
        if( ПолучитьФинИн(srcfin.FIID, srcfin, null) == 0 )
           ClientID = srcfin.Issuer;
           return true;
        end;
     end;

     Data.UniqStr.AddString( "Не найден базовый выпуск для депозитарной расписки с кодом " + string(fin.FI_Code) );
     return false;
  END;

  /*Для правильного отражения в отчете сделок с ценными бумагами, являющимися результатом исполнения срочных поставочных контрактов
    для сделки должна быть заполнена категория "Исполнение поставочных срочных контрактов"="Да"
    (всегда нужно проверять категорию <Исполнение поставочных срочных контрактов> на сделке)
  */
  PRIVATE MACRO РезультатИсполненияПИ( deal:variant )
     return (GetNameCategValue( OBJTYPE_SECDEAL, OBJGROUP_TICKSETDVEXE, ПолучитьЗначениеКатегории(deal,OBJGROUP_TICKSETDVEXE,OBJTYPE_SECDEAL), true ) == "Да");
  END;

  PRIVATE MACRO ДатаПодтверждДокументов( rq:TRecHandler )
     var VerDate = readNoteForObject(OBJTYPE_DLRQ, UniID(rq, OBJTYPE_DLRQ), 46);
     if( (VerDate != null) AND (VerDate != "") )
        if( VerDate != ZeroDate )
           return VerDate;
        end;
     end;
     return ZeroDate;
  END;

  PRIVATE MACRO ВходящееТОКлиента( rq, deal, Group:integer )
     return ( (deal.ClientID > 0) AND
              ( (IsSALE(Group) AND ((rq.DealPart == ПЕРВАЯ_ЧАСТЬ)  AND
                                   ( (rq.type == DLRQ_TYPE_PAYMENT) or (rq.type == DLRQ_TYPE_AVANCE) or (rq.type == DLRQ_TYPE_AVANCE)) )
                ) OR
                (IsBUY(Group) AND IsREPO(Group) AND ((rq.DealPart == ВТОРАЯ_ЧАСТЬ)  AND
                                   ( (rq.type == DLRQ_TYPE_PAYMENT) or (rq.type == DLRQ_TYPE_AVANCE) or (rq.type == DLRQ_TYPE_AVANCE)) )
                )
              )
            );
  END;

  PRIVATE MACRO Payer(rq, deal):INTEGER
     if( rq.rec.Kind == DLRQ_KIND_REQUEST ) // требование
        return rq.rec.Party;
     elif( deal.rec.ClientID > 0 )
        return deal.rec.ClientID;
     end;
     return {OurBank};
  END;

  PRIVATE MACRO Receiver(rq, deal):INTEGER
     if( rq.rec.Kind == DLRQ_KIND_REQUEST ) // требование
        if( deal.rec.ClientID > 0 )
           return deal.rec.ClientID;
        end;
        return {OurBank};
     end;
     return rq.rec.Party;
  END;

  PRIVATE MACRO ДатаДокИзПримечания()
     return " NVL((select TO_DATE(DECODE(UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 1, 1))),0,1,"+
            "                   UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 1, 1)))) || '-' || " +
            "                   DECODE(UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 2, 1))),0,1," +
            "                   UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 2, 1)))) || '-' || " +
            "                   DECODE(UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 3, 2))),0,1," +
            "                   UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 3, 2)))), 'DD-MM-YYYY') " +
            "        from dnotetext_dbt note " +
            "       where note.t_ObjectType = "+string(OBJTYPE_DLRQ)+
            "         and note.t_NoteKind = 46 " +
            "         and note.t_DocumentID = lpad(to_char(rq.t_Id), 10, '0')),TO_DATE('01.01.0001','DD.MM.YYYY')) ";
  END;

  PRIVATE MACRO КатегДокНетИлиНеЗаполн()
     return " (case when Exists(SELECT attr.* " +
            "                      FROM dobjatcor_dbt attr " +
            "                     WHERE attr.t_ObjectType = " + string(OBJTYPE_DLRQ) +
            "                       AND attr.t_GroupID = 14 " +
            "                       AND attr.t_Object = LPAD(rq.t_id, 10, '0') " +
            "                       AND attr.t_AttrID = NVL((select objattr.t_AttrID " +
            "                                                  from dobjattr_dbt objattr " +
            "                                                 where objattr.t_ObjectType = attr.t_ObjectType " +
            "                                                   and objattr.t_GroupID = attr.t_GroupID " +
            "                                                   and objattr.t_Name like 'Да'), 0))" +
            " then 0 else 1 end) = 1 ";
  END;

  /* Проверяем, что у клиента есть договор обслуживания вида "Фондовый дилинг"
     на дату операции.
        IsClientDeal   -  флаг, клиентская сделка
        ClientID       -  код клиента
        OperDate       -  дата операции */
  PRIVATE MACRO CheckClientContr( IsClientDeal, ClientID, OperDate )
     return   (not IsClientDeal)
              or (IsClientDeal and IsClientHaveContrStock(ClientID, OperDate));
  END;

  /* Инициализация счетчика при отборе данных в раздел отчета. */
  PRIVATE MACRO InitProgressForCollectData( NumRecs, PartNumber, SubPartNumber );
     InitProgressBar( NumRecs, StatLine, "Отбор данных для " + SubPartNumber + "-го подраздела " + PartNumber + "-го раздела отчета" );
  END;

  /* Инициализация счетчика при отборе данных в раздел отчета. */
  PRIVATE MACRO InitProgressForPrintData( NumRecs, PartNumber, SubPartNumber );
     InitProgressBar( NumRecs, StatLine, "Печать " + SubPartNumber + "-го подраздела " + PartNumber + "-го раздела отчета" );
  END;

  /* Получить значения поля A12 - A15 */
  PRIVATE MACRO GetResidentInfo(Data, ContrID, ContrIsBank,
                                OwnerID, OwnerIsBank, OwnerNotRes, fininstr,
                                RepLine, ForPart11, Is_EXCHANGE, DealID, ЭтоВыплата
  )
     var party = TRecHandler("party");
     var ResPartyID;
     var ResIsBank;
     var NotResPartyID;
     var IssuerName;
     var ContrClient;

     if( ЭтоВыплата == null )
        ЭтоВыплата = false;
     end;

     if( OwnerNotRes )
        /* Владелец ц/б - нерезидент, значит контрагент - резидент */
        ResPartyID        = ContrID;
        ResIsBank         = ContrIsBank;
        NotResPartyID     = OwnerID;
     else
        ResPartyID        = OwnerID;
        ResIsBank         = OwnerIsBank;
        NotResPartyID     = ContrID;
     end;

     // A13 - резидент/ наименование
     //       Наименование участника сделки (владельца ц/б или контрагента) -
     //       резидента: если данный участник операции - юр.лицо (в том числе банк),
     //       то выводится его полное наименование, если данный участник - ПИФ,
     //       то указывается наименование управляющей компании, а в скоб-ках наименование ПИФа),
     //       если данный участник - физ.лицо,
     //       то выводится текст "ФЛ", если данный участник - физ.лицо и
     //       предприниматель, то выводится текст "ИП"
     // A14 - резидент/код
     //       Для участника операции - резидента, являющегося юр. лицом, но не
     //       являющегося банком: выводится ИНН этого участника,
     //       для банка выводится код вида "Рег. номер кредитной организации",
     //       для ПИФов - ИНН управляющей компании,
     //       для остальных участников (физ.лиц и и инд.предпринимателей) - поле
     //       не заполняется.

     // Если операция клиентская и вид ц/б = депозитарная расписка, выпущенная
     // резидентом, то A13 = полное наименование эмитента депозитарной расписки
     var IssuerNotRes;
     GetPartyParam(fininstr.Issuer, @IssuerNotRes);

     if((OwnerID > 0) and (OwnerID != {OurBank}) and (not IssuerNotRes) and FI_IsDeposReceipt(fininstr.FIID))
        RepLine.ResPartyID = fininstr.Issuer;
     elif (not ЭтоВыплата or (OwnerID == ResPartyID))
        if(ForPart11 and (DealID != null) and (КлиентКонтрагента( DealID, ContrID, @ContrClient ) == РЕЗИДЕНТ))
           RepLine.ResPartyID = ContrClient;
        else // part 1.2
           RepLine.ResPartyID = ResPartyID;
        end;
     end;

     GetResidentNameCode( RepLine.ResPartyID, fininstr, false, OwnerID, Dealid, @RepLine.ResName, @RepLine.ResCode );

     // A15 - нерезидент/наименование
     //       Наименование участника операции - нерезидента: если данный
     //       участник операции - юр.лицо, то выводится его полное
     //       наименование, если данный участник - физ.лицо, , то выводится "ФЛ"
     //       Если платеж относится к биржевой сделке и биржа является нерезидентом
     //       и в сделке не задан контрагент, то биржа рассматривается в качестве контрагента-нерезидента
     // A16 - нерезидент/код
     //       Цифровой код страны участника операции - нерезидента (юр. или физ.лица);
     //       если страна для данного участника в справочнике
     //       субъектов не задана, то выводится текст "999"

     if( not ЭтоВыплата or ( OwnerID == NotResPartyID ) )
        if (ForPart11 and (DealID != null) and (КлиентКонтрагента(DealID, ContrID, @ContrClient) == НЕРЕЗИДЕНТ))
           NotResPartyID = ContrClient;
        end;

        party = GetPartyByID( NotResPartyID, true, true );
        RepLine.NotResPartyID = NotResPartyID;

        if (ForPart11)
           if ((PartyRecIsJur(party)) and (party.Name != ""))
              RepLine.NotResName = party.Name;
           elif(PartyRecIsPhis(party))
              RepLine.NotResName = "ФЛ";
           elif((Is_EXCHANGE == true) and (OwnerNotRes == true))
              RepLine.NotResName = party.Name;
           else
              RepLine.NotResName = "";
           end;
        else // part 1.2
           RepLine.NotResName = IIF( PartyRecIsJur(party), party.Name, "ФЛ" );
        end;
        RepLine.NotResCode = GetNotResCountryNumCode( party );
     end;
  END;

  MACRO GetFactReceiverID(DealID, ClientID)
     var tick = TRecHandler("dl_tick");

     tick.Clear();
     tick.rec.DealID = DealID;
     
     var QueryDeal = "select t_AttrID" +
                     " from dobjlink_dbt" +
                     " where t_ObjectType = " + string(DL_SECURITYDOC) +
                     "   and t_ObjectID = ?" +
                     "   and t_AttrType = " + string(OBJTYPE_PARTY) +
                     "   and t_GroupID = 3";

     var SelectDeal = DL_RSDCommand(QueryDeal);
     SelectDeal.AddParam(UniID(tick, DL_SECURITYDOC));
     var DataSetDeal = SelectDeal.Execute();
     if(DataSetDeal.MoveNext())
        return DataSetDeal.AttrID;
     else
        return GetFactReceiverForNUTX(ClientID);
     end;
  END;

  /* Получить данные ценной бумаги. Поля A4, A17 - A22
        fininstr    - фин. инстумент
        avoir       - ц/б
        RepLine     - данные строки отчета */
  PRIVATE MACRO GetAvoirInfo( Data, fininstr, avoir, issuer, RepLine )
     /* A4 - Код типа ц/б
        Выводится значение категории "Код инструмента для формы 405",
        указанное для выпуска ц/б сделки, по которой выполнено ТО */
     var AvrType405;
     if(RepLine.AvrType405 != "")
        RepLine.AvrType405 = RepLine.AvrType405 + ";";
     end;
     var CategValue = GetNameCategValue( OBJTYPE_AVOIRISS, OBJGROUP_AVRTYPE711/*405*/, /*ПолучитьКодТипаЦБ405*/ПолучитьКодТипаЦБ711( avoir ), true );/*PNV*///GAA: 505493 Вместо кода для 405 брать код дл 711, т.к. он точно имеется. Не удалять при адаптации!!!
     RepLine.AvrType405 = RepLine.AvrType405 + CategValue;
     AvrType405 = CategValue;
     if( CategValue == "" )
        /* Выводим сообщение, если значение категории не задано (#59157). */

        Data.UniqStr.AddString( "Для ценной бумаги \"" + fininstr.FI_Code + "\" не задано значение категории \"Код инструмента для формы 405\"");
     end;

     RepLine.IssuerPartyID = issuer.PartyID;
     // для паёв ищем ПИФ
     if( ( fininstr.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE )
     and (not IsPartyNotRes(issuer)) // ( issuer.NotResident != SET_CHAR )
     and GetNameForInvst( issuer.PartyID, fininstr.FIID, @RepLine.IssuerName, @RepLine.IssuerCode, @RepLine.AvRegNum ) )
     else
        /* A17 - эмитент ценной бумаги / наименование
           А) для юр.лиц-резидентов выводится сокращенное наименование организационно-правовой формы эмитента
             (берется из соответствующей категории субъекта) + его полное наименование,
           Б) для ПИФов-резидентов - полное наименование управляющей компании, а в скобках - полное наименование ПИФа,
           В) если физ.лицо является индивидуальным предпринимателем (в анкете субъекта выставлен признак "Предприниматель"),
             то выводится текст "ИП"
             для остальных физ.лиц-резидентов(нерезидентов) выводится текст "ФЛ",
           Г) для остальных эмитентов - их полное наименование.
           Д) для депозитарной расписки указывается наименование эмитента ценных бумаг,
             лежащего в основе расписки(наименование эмитента базового выпуска).
           Если <A4> имеет значение из списка "DOL3, DOL4, DOL5, DOL7, ОТН3, ОТН4", то графа не заполняется.*/
        if(RepLine.IssuerName != "")
          RepLine.IssuerName = RepLine.IssuerName + ";";
        end;
        if( PartyRecIsJur(issuer) and (not IsPartyNotRes(issuer)) ) //(issuer.NotResident != SET_CHAR)
           // Юридическое лицо - резидент
           var IssuerName = PartyGetOrgLegFormsName( issuer.PartyID, true );
           if( IssuerName == "" )
              // Выводим сообщение, если значение категории не задано (#59157)
              Data.UniqStr.AddString( "Для субъекта \"" + issuer.Name + "\" не задано значение категории \"Организационно-правовые формы\"");
           else
              RepLine.IssuerName = RepLine.IssuerName + " ";
           end;
           RepLine.IssuerName = RepLine.IssuerName + issuer.Name;
        elif( PartyRecIsPhis(issuer) )
           if( PartyIsEmployer(issuer.PartyID) )
              RepLine.IssuerName = RepLine.IssuerName + "ИП";
           else
              RepLine.IssuerName = RepLine.IssuerName + "ФЛ";
           end;
        else
           RepLine.IssuerName = RepLine.IssuerName + issuer.Name;
        end;

        /* A18 - эмитент ценной бумаги / код
        Для эмитентов - резидент, то выводится его ИНН,
        для эмитентов - нерезидент, то выводится цифровой код страны эмитента,
        а если страна для данного эмитента в справочнике субъектов не задана, то выводится текст "999".
        Если эмитент - физ.лицо-резидент ИЛИ индивидуальный предприниматель, то данное поле не заполняется.
        Если <A4> имеет значение из списка "DOL3, DOL4, DOL5, DOL7, ОТН3, ОТН4", то графа не заполняется. */
        if(RepLine.IssuerCode != "")
            RepLine.IssuerCode = RepLine.IssuerCode + ";";
        end;
        if( (PartyRecIsPhis(issuer) AND (not IsPartyNotRes(issuer))) OR PartyIsEmployer(issuer.PartyID) ) // (issuer.NotResident != SET_CHAR)
           RepLine.IssuerCode = RepLine.IssuerCode + "";
        else
           if(IsPartyNotRes(issuer)) // ( issuer.NotResident )
              RepLine.IssuerCode = RepLine.IssuerCode + GetNotResCountryNumCode( issuer );
           else
              RepLine.IssuerCode = RepLine.IssuerCode + GetPartyTrueINN( issuer.PartyID );
           end;
        end;

        if( FL290(issuer.PartyID) )
           RepLine.IssuerCode = "996"; 
        end; 

        /* A19 - регистрационный номер ценной бумаги
           Если эмитент ценной
        бумаги - резидент, то выводится номер гос. регистрации этой
        ц/б, а если номер гос. регистрации в справочнике для данной
        ценной бумаги не указан, то выводится ее ISIN;если эмитент
        ценной бумаги - нерезидент, то выводится ее ISIN, а если ISIN
        для данной ценной бумаги не задан, то выводится номер гос.
        регистрации; */

        if(Index(RepLine.Note, "пакет") == 0)
            if(RepLine.AvRegNum != "")
                RepLine.AvRegNum = RepLine.AvRegNum + ";";
            end;
            if(Index( "DR1,DR2", RepLine.AvrType405) != 0)
               RepLine.AvRegNum = RepLine.AvRegNum + avoir.ISIN;
            else
               if(not IsPartyNotRes(issuer)) // ( issuer.NotResident != SET_CHAR )
                  RepLine.AvRegNum = RepLine.AvRegNum + IIF( avoir.LSIN != "", avoir.LSIN, avoir.ISIN );
               else
                  RepLine.AvRegNum = RepLine.AvRegNum + IIF( avoir.ISIN != "", avoir.ISIN, avoir.LSIN );
               end;
            end;
        end;
     end;

     if( ( RepLine.AvrType405 != "" ) and ( Index( "DOL3,DOL4,DOL5,DOL7,OTH3,OTH4", RepLine.AvrType405 ) != 0 ) )
        RepLine.IssuerName = "";
        RepLine.IssuerCode = "";
     end;

     /* A20 - дата регистрации выпуска ценной бумаги
        Дата выпуска ценной бумаги (для пая это же поле)*/
     if(Index(RepLine.Note, "пакет") == 0)
        if(RepLine.AvIssued != "")
           RepLine.AvIssued = RepLine.AvIssued + ";";
        end;
        RepLine.AvIssued = RepLine.AvIssued + DateToStr(fininstr.Issued, true);
     end;

     /* A21 - дата погашения ценной бумаги
        Поле заполняется только для облигаций: выводится плановая дата
        погашения выпуска */
     if(Index(RepLine.Note, "пакет") == 0)
        if(RepLine.PlanDrawDate != "")
           RepLine.PlanDrawDate = RepLine.PlanDrawDate + ";";
        end;
        if( FI_IsBond(fininstr) )
           if( avoir.Termless == SET_CHAR )
              RepLine.PlanDrawDate = RepLine.PlanDrawDate + DateToStr(ПолучитьДатуПоследнегоИзвестногоКупона(fininstr.FIID), true);
           else
              RepLine.PlanDrawDate = RepLine.PlanDrawDate + DateToStr(fininstr.DrawingDate, true);
           end;
        end;
     end;

     /* A22 - код валюты ценной бумаги
        Цифровой код валюты номинала ц/б */
     if( (AvrType405 != "DOL7") and (Index(RepLine.Note, "пакет") == 0))
        var FICode = 0;
        RepLine.AvFaceFICode = "";
        if((fininstr.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE) )
         //   RepLine.AvFaceFICode = GetFaceValueFICode(fininstr.ParentFI);
           // нужно цифровой код валюты выплаты т.е. A9
           RepLine.AvFaceFICode = RepLine.PayFIIDCode;
        elif(FI_IsDeposReceipt(fininstr))
            RepLine.AvFaceFICode = GetFaceValueFICodeIfSetFaceValue(fininstr.ParentFI);
        elif( fininstr.FaceValue == 0 )
            FICode = 0;
            FICode = GetCodeCurrency405(fininstr.fiid);
            if ( FICode == 0 )
               // нужно код валюты для страны RepLine.IssuerCode, но пока оставим как было
               RepLine.AvFaceFICode = RepLine.IssuerCode;
            else 
               RepLine.AvFaceFICode = FICode;
            end;
        else
           RepLine.AvFaceFICode = GetFICode( fininstr.FaceValueFI );
        end;
     end;
  END;

  /* получить кол-во ц\б в сделке на дату платежа по выплатам (комп., купон или ЧП) */
  PRIVATE MACRO GetAmountOnFactDate( DealID:integer, ChangeDate:Date, ID_STEP:integer)
     var sqlQuery, DataSet, OldPrincipal2 = 0.0;

     var Query = " select SPTK.t_OldPrincipal2                                                                                                             " +
                 "   from dsptkchng_dbt sptk                                                                                                               " +
                 "  where sptk.t_DealID = ?                                                                                                                " +
                 "    and sptk.t_OldInstance = (select NVL(max(sptk2.t_OldInstance),-1)                                                                    " +
                 "                                from dsptkchng_dbt sptk2                                                                                 " +
                 "                               where sptk2.t_DealID =  sptk.t_DealID                                                                     " +
                 "                                 and sptk2.t_OldChangeDate = (select NVL(max(sptk1.t_OldChangeDate), to_date('01.01.0001','DD.MM.YYYY')) " +
                 "                                                               from dsptkchng_dbt sptk1                                                  " +
                 "                                                              where sptk1.t_DealID = sptk.t_DealID                                       " +
                 "                                                                and sptk1.t_OldChangeDate <= ?                                           " +
                 "                                                                and SPTK1.T_ID_STEP = ?                                                  " +
                 "                                                             )                                                                           " +
                 "                             )                                                                                                           ";

     sqlQuery = RSDCommand(Query);

     sqlQuery.addParam( "", RSDBP_IN, DealID );
     sqlQuery.addParam( "", RSDBP_IN, ChangeDate );
     sqlQuery.addParam( "", RSDBP_IN, ID_STEP );

     sqlQuery.execute();

     DataSet = TRsbDataSet( sqlQuery );

     if( DataSet.MoveNext() )
        OldPrincipal2 = DataSet.OldPrincipal2;
     end;

     return OldPrincipal2;
  END;

  /* Записываем данные во временный файл */
  macro PutInTempFile2( TempFile2, OperDate,
                                   FIID,
                                   DealID,
                                   DLLegID,
                                   DocumentID,
                                   HolderAccID,
                                   RegLineID,
                                   Amount,
                                   PayAmount,
                                   OwnerID,
                                   OwnerNotRes,
                                   OwnerIsBank,
                                   IssuerID,
                                   IssuerNotRes,
                                   IssuerIsBank,
                                   IsExistAvance,
                                   IdentProgram )
     ClearRecord( TempFile2 );

     TempFile2.OperDate     = OperDate;
     TempFile2.FIID         = FIID;
     TempFile2.DealID       = DealID;
     TempFile2.DLLegID      = DLLegID;
     TempFile2.DocumentID   = DocumentID;
     TempFile2.HolderAccID  = HolderAccID;
     TempFile2.RegLineID    = RegLineID;
     TempFile2.Amount       = Amount;
     TempFile2.PayAmount    = PayAmount;
     TempFile2.OwnerID      = OwnerID;
     TempFile2.OwnerNotRes  = OwnerNotRes;
     TempFile2.OwnerIsBank  = OwnerIsBank;
     TempFile2.IssuerID     = IssuerID;
     TempFile2.IssuerNotRes = IssuerNotRes;
     TempFile2.IssuerIsBank = IssuerIsBank;
     if (IsExistAvance != null)
      TempFile2.IsExistsAvance = IsExistAvance;
     end;
     if (IdentProgram != null)
      TempFile2.IdentProgram = IdentProgram;
     end;

     InsertRecTempFile( TempFile2 );
  end;

PRIVATE MACRO CollectDataForPart1ByVS( Data, SubPartNumber, TempFile2 )
    var WasCollectedData = false;
    var Query = "", Set = null;

    var OwnerID, OwnerNotRes, OwnerIsBank;

    Query = 
       "      SELECT pmpaym.t_ValueDate, pmpaym.t_PaymentID, "
     + "             vsbanner.t_fiid, ORD.T_CONTRACTID, "
     + "             ord.T_CONTRACTOR, vsbanner.t_bcid, "
     + "             vsordlnk.t_BCCost AS t_PayAmount "
     + "  FROM dvsbanner_dbt vsbanner, "
     + "       dpmpaym_dbt pmpaym,"
     + "       dvsordlnk_dbt vsordlnk,"
     + "       ddl_order_dbt ord,"
     + "       DDL_LEG_DBT leg,"
     + "       dparty_dbt party"
     + " WHERE     pmpaym.t_Purpose = " + IIF(SubPartNumber == 1, PM_PURP_VEKSEL, PM_PURP_VEKSELDRAW)
     + "       AND pmpaym.t_ValueDate BETWEEN "+GetSQLDate(Data.PeriodBeg)+" AND "+GetSQLDate(Data.PeriodEnd)
     + "       AND vsordlnk.t_LinkKind = " + IIF(SubPartNumber == 1, VSORDLNK_K_EMISSION, VSORDLNK_K_DRAW)
     + "       AND vsordlnk.t_BCID = vsbanner.t_BCID"
     + "       AND VSORDLNK.T_CONTRACTID = ORD.T_CONTRACTID"
     + "       AND vsordlnk.T_DOCKIND = ORD.T_DOCKIND"
     + "       AND ORD.T_CONTRACTOR = party.t_partyid"
     + "       AND party.t_NotResident = CHR (88)"
     + "       and NOT EXISTS " 
     + "             (SELECT 1 " 
     + "                FROM dobjatcor_dbt attr " 
     + "               WHERE attr.t_ObjectType = 3 "
     + "                 AND attr.t_Object = LPAD(PARTY.T_PARTYID, 10, '0' ) " 
     + "                 AND attr.t_GroupID = 16 " 
     + "                 AND attr.t_attrid IN ( " 
                          + PARTY_ATTR_FZ4015 + ", "      // Филиал иностранной страховой организации по ФЗ 4015-I
                          + PARTY_ATTR_FZ290              // Международная компания по 290-ФЗ
     + "                )) "
     + "       AND pmpaym.t_DocKind = ord.T_DOCKIND"
     + "       AND pmpaym.t_DocumentID = ord.T_CONTRACTID"
     + "       AND pmpaym.t_IsFactPaym = CHR (88)"
     + "       AND LEG.T_LEGKIND = " + LEG_KIND_VSBANNER
     + "       AND LEG.T_LEGID = 0"
     + "       AND LEG.T_DEALID = vsbanner.t_BCID"
     + IIF(PrintVA and PrintVS," AND (vsbanner.T_BACKOFFICE = 'N' or vsbanner.T_BACKOFFICE = 'Y' ) ",
       IIF(PrintVS, " AND vsbanner.T_BACKOFFICE = 'Y' ", " AND vsbanner.T_BACKOFFICE = 'N' " ))
     + "";

    Set = RsdRecordset( Query );

    while( Set.MoveNext() )
      PutInTempFile2( TempFile2, Set.Value( "t_ValueDate" ),
                           Set.Value( "t_FIID" ),
                           0,
                           0,
                           Set.Value( "t_bcid" ),
                           Set.Value( "t_PaymentID"),
                           Set.Value( "T_CONTRACTID" ),
                           1,
                           Set.Value( "t_PayAmount" ),
                           Set.Value( "T_CONTRACTOR" ),
                           0,
                           0,
                           0,
                           0,
                           0,
                           BoolToInt(false),
                           IP_VEKSEL );
      WasCollectedData = true;
    end;

    return WasCollectedData;

  END;

  private macro PrintDataForPart1VS(Data, DS, RepLine, Subpart)
     record fininstr( fininstr );
     record avoir( avoiriss );

     var
         issuer = TRecHandler( "party" ),
         party = TRecHandler( "party" );
     var
       bnrfd = VSBannerFD( DL_VSBANNER, DS.DocumentID ),
       ordfd = VSOrderFD( 0, DS.RegLineID ),
       СуммаПроцентов = $0, 
       НачисПроц = $0,
       payFIID = 0 ;

     //var RepLineArray = TArray();

     /* Получаем параметры бумаги */
     if( ПолучитьФинИн(DS.FIID, fininstr, avoir) )
        RunError(   "Ошибка при получении параметров финансового инструмента "
                    + "(FIID = " + string(DS.FIID) + ")." );
     end;

     RepLine.IsBNR = true;

     issuer = GetPartyByID({ourbank}, true, true);

     RepLine.ResPartyID = issuer.partyid;

     RepLine.PlanDrawDate = DateToStr(DL_GetBnrPlanRepayDate( bnrfd.GetBnr(), bnrfd.GetLeg() ), true);

     RepLine.OperDate = IIF(Subpart == 1, SQL_ConvTypeDate(DS.OperDate), DL_GetBnrPlanRepayDate( bnrfd.GetBnr(), bnrfd.GetLeg() ));

     //т.к. эмитент векселя всегда резидент, а контрагент всегда нерезидент (плюс назначения платежей тоже всегда одни и те же)
     //, тот тут достаточно подбирать код по подчасти отчёта
     RepLine.VO_Code = IIF(Subpart == 1, "51250", "55250"); 

     GetAvoirInfo( Data, fininstr, avoir, issuer, RepLine );

     RepLine.OperCode = IIF(Subpart == 1, "11", "99"); 

     RepLine.PaymDirectCode = IIF(Subpart == 1,"INR","OUTR") ; 

     RepLine.A7_Amount = 1;

     payFIID = IIF(Subpart == 1,bnrfd.GetLeg().rec.pfi,bnrfd.ОпределитьВалютуУчета());

     RepLine.PayFIIDCode = GetFICode(payFIID);

     if (Subpart == 1)
       RepLine.A10_SumPay = DS.PayAmount;
     else
       SmartConvertSum(RepLine.A10_SumPay, DS.PayAmount, SQL_ConvTypeDate(DS.OperDate), payFIID, bnrfd.GetLeg().rec.PFI, true);
     end;

     if (Subpart == 2)
        ПолучитьСуммуКНачисл_В(bnrfd.GetBnr(), bnrfd.GetLeg(), SQL_ConvTypeDate(DS.OperDate), @СуммаПроцентов, @НачисПроц);
        RepLine.A11_SumPay = СуммаПроцентов + НачисПроц;
     else
        RepLine.A11_SumPay = 0;
     end;

     GetResidentNameCode( {ourbank}, fininstr, true, NULL, -1,  @RepLine.ResName, @RepLine.ResCode);
     //GetResidentNameCode( DS.OwnerID, fininstr, true, NULL, -1,  @RepLine.NotResName, @RepLine.NotResCode);
     GetResidentNameCode( {ourbank}, fininstr, true, NULL, -1,  @RepLine.IssuerName, @RepLine.IssuerCode);
    
     RepLine.AvRegNum = bnrfd.GetBnr().rec.BCSeries+" "+trim(bnrfd.GetBnr().rec.BCNumber);

     RepLine.AvIssued = DateToStr(bnrfd.GetBnr().rec.RegistrationDate, true);

     party = GetPartyByID( DS.OwnerID, true, true );

     if (Subpart == 1)
        if ((PartyRecIsJur(party)) and (party.Name != ""))
           RepLine.NotResName = party.Name;
        elif(PartyRecIsPhis(party))
           RepLine.NotResName = "ФЛ";
        else
           RepLine.NotResName = "";
        end;
     else // part 1.2
        RepLine.NotResName = IIF( PartyRecIsJur(party), party.Name, "ФЛ" );
     end;
     RepLine.NotResCode = GetNotResCountryNumCode( party );

     if( RepLine.AvrType405 != "DOL7" )
       RepLine.AvFaceFICode = GetFICode( bnrfd.GetLeg().rec.PFI );
     end;

     // todo ...
     RepLine.Note = "";
  end;

  /* Сбор данных для 2-го подраздела 1-го раздела отчета.
     Бегаем по бумагам, для каждой бумаги ищем подходящиие операции погашения.
     Записываем результаты во временный файл */
  PRIVATE MACRO CollectDataForPart12ByRetire( Data, TempFile2 )

     macro GetCoupon( Data, FIID, CoupNumber, p_IsPartial:bool )
        var
           fiwarnt = TBFile( "fiwarnts" ), v_IsPartial=false;

        if(p_IsPartial != null)
           v_IsPartial = p_IsPartial;
        end;

        fiwarnt.Clear();
        fiwarnt.rec.FIID = FIID;
        fiwarnt.rec.Number = CoupNumber;

        if(v_IsPartial)
           fiwarnt.rec.IsPartial = SET_CHAR;
        else
           fiwarnt.rec.IsPartial = UNSET_CHAR;
        end;

        if( not fiwarnt.GetEQ() )
           fiwarnt.Clear();

           Data.UniqStr.AddString( "Не могу получить "+IIF(v_IsPartial,"ЧП","купон")+" ц/б (FIID = " + string(FIID) +
                  ", Number = " + CoupNumber + ")" );
        end;

        return fiwarnt.rec;
     end;

     var
        dl_tick,
        PlanRetireDate, FactRetireDate,
        OwnerID, OwnerNotRes, OwnerIsBank,
        IssuerID, IssuerNotRes, IssIsBank,
        Group, ClientDealFlag, OperDate,
        WasCollectedData = false, Query, sqlQuery, FD, BrokerNotRes;

     /* Подраздел 2 раздела 1: Отчет формируется по выполненным в плановую дату,
        досрочно или позже плановой даты операциям погашения (частичным,
        пол-ным или погашениям купонов), при условии, что
        дата операции погашения входит в отчетный период. */

     Query = "select tick.t_DealID, rq.t_ID RQID, rq.t_FactDate " +
             "  from ddl_tick_dbt tick, ddlrq_dbt rq " +
             " where tick.t_BOfficeKind IN (" + string(DL_RETIREMENT) + ", " +
                                                string(DL_RETIREMENT_DST) + ", " +
                                                string(DL_TRUSTRETIREMENT) + ")" +
             "   and rq.t_FactDate != to_date('01.01.0001','DD.MM.YYYY')" +
             "   and rq.t_DocID = tick.t_DealID " +
             "   and rq.t_DocKind = tick.t_BOfficeKind " +
             "   and rq.t_DealPart = 1 and rq.t_Type =  " + string(DLRQ_TYPE_PAYMENT)+
             "   and (( tick.t_ClientID = -1 and  rq.t_FactDate >= " + GetSQLDate(Data.PeriodBeg) +
             "          and rq.t_FactDate <= " + GetSQLDate(Data.PeriodEnd) + ") " +
             "         or (tick.t_ClientID > 0 " +
             "             and " +КатегДокНетИлиНеЗаполн()+
             "             and case when " +ДатаДокИзПримечания()+ " != TO_DATE('01.01.0001','DD.MM.YYYY') " +
             "                      then " +ДатаДокИзПримечания()+
             "                      else rq.t_FactDate end between "+GetSQLDate(Data.PeriodBeg)+" and "+GetSQLDate(Data.PeriodEnd) +
             "            )" +
             "       ) ";

     sqlQuery = RSDCommand(Query);
     sqlQuery.execute();

     dl_tick = TRsbDataSet( sqlQuery );

     InitProgressForCollectData( SQL_GetNRecs( Query ), 1, 2 );

     while( dl_tick.MoveNext() )
        UseProgressBar;
        /* Нашли погашение с фактической датой в отчетном периоде. */

        /* Проверим бумагу. */
        FD = SPFirstDoc(LEG_KIND_DL_TICK, dl_tick.DealID);

        if( IsGoodAvoir(Data, FD.dl_leg.rec.PFI) )

           if( (FD.tick.rec.Flag1 == UNSET_CHAR) AND (FD.tick.rec.Flag4 == UNSET_CHAR) )
              FactRetireDate = SQL_ConvTypeDate(dl_tick.FactDate);
           else
              FactRetireDate = SQL_ConvTypeDate(FD.tick.rec.DealDate);
           end;

           /* Получим плановую дату погашения из анкеты бумаги.
              Если погашение купона или частичное, то плановая дата - дата
              погашения соответствующего купона, если погашение выпуска, то
              дата погашения выпуска. */
           if( IsRET_COUPON(FD.Group) )
              PlanRetireDate = GetCoupon(Data, FD.dl_leg.rec.PFI, FD.tick.rec.Number_Coupon).DrawingDate;
           elif( IsRET_PARTLY(FD.Group) )
              PlanRetireDate = GetCoupon(Data, FD.dl_leg.rec.PFI, FD.tick.rec.Number_Partly, true).DrawingDate;
           else
              PlanRetireDate = FD.fininstr.rec.DrawingDate;
           end;

           ClientDealFlag = IsClientDeal(FD.tick.rec) ;

           OwnerID = IIF( ClientDealFlag, FD.tick.rec.ClientID, {OurBank} );

           /* Это просроченное погашение? */
           /* Получаем дату операции. */
           if( (PlanRetireDate >= Data.PeriodBeg) and (PlanRetireDate <= Data.PeriodEnd) )
             OperDate = IIF( FactRetireDate > PlanRetireDate, FactRetireDate, PlanRetireDate );
           else
             OperDate = FactRetireDate; 
           end;

           /* Проверяем договор обслуживания клиента. */
           if( CheckClientContr(ClientDealFlag, OwnerID, OperDate) )

              /* Получим параметры владельца ц/б */
              GetPartyParam( OwnerID, @OwnerNotRes, @OwnerIsBank);

              /* Получим параметры эмитента */
              IssuerID = FI_GetIssuerOnDate(FD.fininstr, Data.PeriodEnd );

              GetPartyParam( IssuerID, @IssuerNotRes, @IssIsBank );

              var FactReceiverID = Int(GetFactReceiverID(FD.Tick.rec.DealID, OwnerID));
              GetPartyParam(FD.Tick.rec.BrokerID, @BrokerNotRes);

              // Операция погашения отбирается в отчет, если:
              //   - эмитент выпуска - нерезидент, а владелец ц/б - наш банк или клиент-резидент.
              //   - эмитент выпуска - резидент (но не банк), а владелец ц/б - клиент-нерезидент.
              //   - эмитент ценной бумаги Наш Банк, а владелец ц/б - клиент-нерезидент, является фактическим получателем дохода.
              // Ограничения:
              //   - Операции Погашение ц/б СЭБ и Погашение купона СЭБ не отражаются в отчете.
              if ((
                       (IssuerNotRes and (not ClientDealFlag or not OwnerNotRes))
                    or (not IssuerNotRes and not IssIsBank and ClientDealFlag and OwnerNotRes and OwnerID == FactReceiverID)
                    or ( (IssuerID == {OurBank}) and ClientDealFlag and OwnerNotRes and (OwnerID == FactReceiverID) )
                  )
                  and (not(
                         (not BrokerNotRes)
                     and IssuerNotRes
                     and (not ВидСубъекта(FactReceiverID, PTK_CLIENT))
                  ))
              )

                 PutInTempFile2( TempFile2, OperDate,
                                            FD.dl_leg.rec.PFI,
                                            dl_tick.RQID,
                                            FD.dl_leg.rec.ID,
                                            0,
                                            0,
                                            0,
                                            0,
                                            $0,
                                            OwnerID,
                                            BoolToInt( OwnerNotRes ),
                                            BoolToInt( OwnerIsBank ),
                                            IssuerID,
                                            BoolToInt( IssuerNotRes ),
                                            BoolToInt( IssIsBank ) );

                 WasCollectedData = true;
              end;
           end;
        end;
     end;

     RemProgressBar;

     return WasCollectedData;
  END;

  /* Сбор данных для 2-го подраздела 1-го раздела отчета по данным депозитария */
  PRIVATE MACRO CollectDataForPart12ByPayments( Data, TempFile2 )
    var Query = "";
    var DataSet = null;
    var Query2 = "";
    var DataSet2 = null;
    var Query3 = "";
    var DataSet3 = null;
    var IsIssuerResident = false;
    var IsIssuerBank = false;
    var IsHolderResident = false;
    var IsHolderBank = false;
    var OpenedLoroAccAmount = 0;
    var OpenedLoroOwnPayAmount = 0;
    var OpenedLoroAccPayAmount = 0;
    var PrevDocumentID = 0;
    var PrevHolderID = 0;
    var PrevHolderBankIC = 0;
    var PrevPartyID = 0;
    var PrevShortName = "";
    var PrevBankBIC = "";
    var RepResp2 = TRecHandler( "represp2.tmp" );
    var WasCollectedData = false;

    Query = " SELECT "
              + " crp.t_DocumentID "
             + " ,regstr.t_RegisterID "
             + " ,regstr.t_Issuer "
             + " ,pmfi.t_FIID "
             + " ,pmacc.t_HolderAccID "
             + " ,pmacc.t_HolderID "
             + " ,pmacc.t_BeneficiarID "
             + " ,(SELECT "
                   + " pmrac.t_BankIC "
               + " FROM "
                   + " ddppmrac_dbt pmrac "
               + " WHERE "
                   + " pmrac.t_DocumentID = crp.t_DocumentID "
               + " AND pmrac.t_HolderAccID = pmacc.t_HolderAccID) AS t_HolderBankIC "
             + " ,pmacc.t_PayAmount "
             + " ,pmacc.t_State "
             + " ,pmacc.t_StateDate "
             + " ,RSB_DEPO.DepoKindType(pmacc.t_HolderAccID) AS t_DepoKindType "
             + " ,(SELECT "
                   + " SUM(reglin.t_HRest) "
               + " FROM "
                   + " ddpreglin_dbt reglin "
               + " WHERE "
                   + " reglin.t_RegisterID = regstr.t_RegisterID "
               + " AND reglin.t_HolderAccID = pmacc.t_HolderAccID "
               + " AND reglin.t_Type = " + DP_REGLINETYPE_LACCOUNT + ") AS t_AccountAmount "
          + " FROM "
              + " ddpcorpop_dbt crp "
             + " ,ddpregstr_dbt regstr "
             + " ,ddppmfi_dbt pmfi "
             + " ,ddppmacc_dbt pmacc "
          + " WHERE "
              + " crp.t_Department = " + {OperDprt} + " "
          + " AND crp.t_DocKind = " + SP_DEPOPER_DIVIDEND + " "
          + " AND (crp.t_ValueDate BETWEEN " + GetSQLDate( Data.PeriodBeg ) + " AND " + GetSQLDate( Data.PeriodEnd ) + " "
            + " OR crp.t_EndReturnDate BETWEEN " + GetSQLDate( Data.PeriodBeg ) + " AND " + GetSQLDate( Data.PeriodEnd ) + ") "
          + " AND regstr.t_DocumentID = crp.t_DocumentID "
          + " AND pmfi.t_RegisterID = regstr.t_RegisterID "
          + " AND pmacc.t_DocumentID = crp.t_DocumentID "
          + " AND (pmacc.t_State = " + DPPMAC_STATE_PAID + " "
            + " OR pmacc.t_State = " + DPPMAC_STATE_RET + ") "
          + " AND (crp.t_PaymentType = " + DP_CRPPAYMENTTYPE_DIVIDENDS + " "
            + " OR NOT EXISTS "
                  + " (SELECT "
                       + " tick.t_DealID "
                   + " FROM "
                       + " ddl_tick_dbt tick "
                      + " ,doprdocs_dbt docs "
                      + " ,doproper_dbt oper "
                   + " WHERE "
                       + " tick.t_DealID = TO_NUMBER(docs.t_DocumentID) "
                   + " AND docs.t_ID_Operation = oper.t_ID_Operation "
                   + " AND docs.t_DocKind = " + DL_INSERT_SECDEAL + " "
                   + " AND docs.t_ServDocKind = crp.t_DocKind "
                   + " AND docs.t_ServDocID = crp.t_DocumentID "
                   + " AND oper.t_DocKind = " + SP_DEPOPER_DEPOACNT + " "
                   + " AND oper.t_DocumentID = TO_CHAR(pmacc.t_HolderAccID))) "
          + " AND SUBSTR(NVL(RSI_RSB_KERNEL.ExtractText(RSI_RSB_KERNEL.GetNote(" + OBJTYPE_DEPOACNT + ", TO_CHAR(pmacc.t_HolderAccID, 0), " + 3 + ", " + GetSQLDate( Data.PeriodEnd ) + ")), CHR(0)), 1, 1) = CHR(0) "
          + " ORDER BY "
              + " crp.t_DocumentID ASC "
             + " ,pmacc.t_HolderID ASC "
             + " ,t_HolderBankIC ASC ";

    DataSet = TRsbDataSet( Query );

    InitProgressForCollectData( SQL_GetNRecs( Query ), 1, 2 );

    while( DataSet.MoveNext() )
      IsIssuerResident = ( MC_IsResident( DataSet.Issuer ) == 1 );
      IsIssuerBank = ВидСубъекта( DataSet.Issuer, PTK_BANK );

      if( ( DataSet.DepoKindType == OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER )
       or ( DataSet.DepoKindType == OBJTYPE_DEPOKINDTYPE_FOREIGNNOMKEEPER )
       or ( DataSet.DepoKindType == OBJTYPE_DEPOKINDTYPE_FOREIGNAUTHKEEPER ) )
        Query2 = " SELECT "
                   + " reglin.t_RegLineID "
                  + " ,loroown.t_PartyID "
                  + " ,loroown.t_ShortName "
                  + " ,loroown.t_TaxType "
                  + " ,loroown.t_Amount "
                  + " ,loroown.t_BankBIC "
               + " FROM "
                   + " ddpreglin_dbt reglin "
                  + " ,ddploroown_dbt loroown "
               + " WHERE "
                   + " reglin.t_RegisterID = " + DataSet.RegisterID + " "
               + " AND reglin.t_HolderAccID = " + DataSet.HolderAccID + " "
               + " AND reglin.t_Type = " + DP_REGLINETYPE_DEPOACC + " "
               + " AND loroown.t_RegLineID = reglin.t_RegLineID "
               + " ORDER BY "
                   + " loroown.t_PartyID ASC "
                  + " ,loroown.t_ShortName ASC "
                  + " ,loroown.t_BankBIC ASC ";

        DataSet2 = TRsbDataSet( Query2 );

        OpenedLoroAccAmount = 0;
        OpenedLoroAccPayAmount = 0;
        PrevPartyID = 0;
        PrevShortName = "";
        PrevBankBIC = "";
        while( DataSet2.MoveNext() )
          if( DataSet2.TaxType != 0 )
            IsHolderResident = ( DataSet2.TaxType == 1 );
          elif( DataSet2.PartyID > 0 )
            IsHolderResident = ( MC_IsResident( DataSet2.PartyID ) == 1 );
          else
            IsHolderResident = false;
          end;

          if( DataSet2.PartyID > 0 )
            IsHolderBank = ВидСубъекта( DataSet2.PartyID, PTK_BANK );
          else
            IsHolderBank = false;
          end;

          OpenedLoroAccAmount = OpenedLoroAccAmount + DataSet2.Amount;
          OpenedLoroOwnPayAmount = Round( DataSet.PayAmount / DataSet.AccountAmount * DataSet2.Amount, 2 );
          OpenedLoroAccPayAmount = OpenedLoroAccPayAmount + OpenedLoroOwnPayAmount;

          var NotResID;
          if(not IsIssuerResident)
             NotResID = DataSet.Issuer;
          elif(not IsHolderResident)
             NotResID = DataSet.HolderID;
          end;

          if( IsIssuerResident and not IsIssuerBank and not IsHolderResident
           or not IsIssuerResident and ( IsHolderResident and not IsHolderBank
                                      or ( DataSet.State == DPPMAC_STATE_RET ) ) 
            and (DataSet.BeneficiarID == NotResID))
            if( ( DataSet2.PartyID != PrevPartyID )
             or ( DataSet2.ShortName != PrevShortName )
             or ( DataSet2.BankBIC != PrevBankBIC ) )
              if( WasCollectedData )
                PutInTempFile2( TempFile2, RepResp2.rec.OperDate,
                                           RepResp2.rec.FIID,
                                           RepResp2.rec.DealID,
                                           RepResp2.rec.DLLegID,
                                           RepResp2.rec.DocumentID,
                                           RepResp2.rec.HolderAccID,
                                           RepResp2.rec.RegLineID,
                                           RepResp2.rec.Amount,
                                           RepResp2.rec.PayAmount,
                                           RepResp2.rec.OwnerID,
                                           RepResp2.rec.OwnerNotRes,
                                           RepResp2.rec.OwnerIsBank,
                                           RepResp2.rec.IssuerID,
                                           RepResp2.rec.IssuerNotRes,
                                           RepResp2.rec.IssuerIsBank );
              end;

              RepResp2.Clear();
            end;

            RepResp2.rec.OperDate = SQL_ConvTypeDate( DataSet.StateDate );
            RepResp2.rec.FIID = DataSet.FIID;
            RepResp2.rec.DealID = 0;
            RepResp2.rec.DLLegID = 0;
            RepResp2.rec.DocumentID = DataSet.DocumentID;
            RepResp2.rec.HolderAccID = DataSet.HolderAccID;
            RepResp2.rec.RegLineID = DataSet2.RegLineID;
            RepResp2.rec.Amount = RepResp2.rec.Amount + DataSet2.Amount;
            RepResp2.rec.PayAmount = RepResp2.rec.PayAmount + OpenedLoroOwnPayAmount;
            RepResp2.rec.OwnerID = DataSet2.PartyID;
            RepResp2.rec.OwnerNotRes = BoolToInt( not IsHolderResident );
            RepResp2.rec.OwnerIsBank = BoolToInt( IsHolderBank );
            RepResp2.rec.IssuerID = DataSet.Issuer;
            RepResp2.rec.IssuerNotRes = BoolToInt( not IsIssuerResident );
            RepResp2.rec.IssuerIsBank = BoolToInt( IsIssuerBank );

            WasCollectedData = true;

            PrevPartyID = DataSet2.PartyID;
            PrevShortName = DataSet2.ShortName;
            PrevBankBIC = DataSet2.BankBIC;
          end;
        end;

        if( OpenedLoroAccAmount != DataSet.AccountAmount )
          Query3 = " SELECT "
                     + " acnt.t_Code "
                    + " ,fi.t_Name "
                    + " ,fi.t_SumPrecision "
                    + " ,avr.t_ISIN "
                 + " FROM "
                     + " ddepoacnt_dbt acnt "
                    + " ,dfininstr_dbt fi "
                    + " ,davoiriss_dbt avr "
                 + " WHERE "
                     + " fi.t_FIID = " + DataSet.FIID + " "
                 + " AND avr.t_FIID = fi.t_FIID "
                 + " AND acnt.t_AutoKey = " + DataSet.HolderAccID + " ";

          DataSet3 = TRsbDataSet( Query3 );
          DataSet3.MoveNext();

          MsgBox( "Сведения о выплатах по счёту " + DataSet3.Code + ", приходящихся на владельцев, "
                + "сведения о которых не раскрыты, в количестве "
                + ЧислоCЗаданнойТочностью( DataSet.AccountAmount - OpenedLoroAccAmount, DP_GetPrecision( DataSet.AccountAmount - OpenedLoroAccAmount, DataSet3.SumPrecision ), IIF( Data.IsApp, "a", "" ) )
                + " шт. " + DataSet3.ISIN + " " + DataSet3.Name + " в отчёт не включаются" );
        elif( OpenedLoroAccPayAmount != DataSet.PayAmount )
          if( WasCollectedData )
            RepResp2.rec.PayAmount = RepResp2.rec.PayAmount + DataSet.PayAmount - OpenedLoroAccPayAmount;
          end;
        end;
      else
        IsHolderResident = ( MC_IsResident( DataSet.HolderID ) == 1 );
        IsHolderBank = ВидСубъекта( DataSet.HolderID, PTK_BANK );

        if( (IsIssuerResident and (not IsIssuerBank) and (not IsHolderResident) and (DataSet.HolderID == DataSet.BeneficiarID))
         or not IsIssuerResident and ( ( DataSet.HolderID == {OurBank} )
                                    or IsHolderResident and not IsHolderBank
                                    or ( DataSet.State == DPPMAC_STATE_RET ) ) )

          if( ( DataSet.DocumentID != PrevDocumentID )
           or ( DataSet.HolderID != PrevHolderID )
           or ( DataSet.HolderBankIC != PrevHolderBankIC ) )
            if( WasCollectedData )
              PutInTempFile2( TempFile2, RepResp2.rec.OperDate,
                                         RepResp2.rec.FIID,
                                         RepResp2.rec.DealID,
                                         RepResp2.rec.DLLegID,
                                         RepResp2.rec.DocumentID,
                                         RepResp2.rec.HolderAccID,
                                         RepResp2.rec.RegLineID,
                                         RepResp2.rec.Amount,
                                         RepResp2.rec.PayAmount,
                                         RepResp2.rec.OwnerID,
                                         RepResp2.rec.OwnerNotRes,
                                         RepResp2.rec.OwnerIsBank,
                                         RepResp2.rec.IssuerID,
                                         RepResp2.rec.IssuerNotRes,
                                         RepResp2.rec.IssuerIsBank );
            end;

            RepResp2.Clear();
          end;

          RepResp2.rec.OperDate = SQL_ConvTypeDate( DataSet.StateDate );
          RepResp2.rec.FIID = DataSet.FIID;
          RepResp2.rec.DealID = 0;
          RepResp2.rec.DLLegID = 0;
          RepResp2.rec.DocumentID = DataSet.DocumentID;
          RepResp2.rec.HolderAccID = DataSet.HolderAccID;
          RepResp2.rec.RegLineID = 0;
          RepResp2.rec.Amount = RepResp2.rec.Amount + DataSet.AccountAmount;
          RepResp2.rec.PayAmount = RepResp2.rec.PayAmount + DataSet.PayAmount;
          RepResp2.rec.OwnerID = DataSet.HolderID;
          RepResp2.rec.OwnerNotRes = BoolToInt( not IsHolderResident );
          RepResp2.rec.OwnerIsBank = BoolToInt( IsHolderBank );
          RepResp2.rec.IssuerID = DataSet.Issuer;
          RepResp2.rec.IssuerNotRes = BoolToInt( not IsIssuerResident );
          RepResp2.rec.IssuerIsBank = BoolToInt( IsIssuerBank );

          WasCollectedData = true;

          PrevDocumentID = DataSet.DocumentID;
          PrevHolderID = DataSet.HolderID;
          PrevHolderBankIC = DataSet.HolderBankIC;
        end;
      end;

      UseProgressBar;
    end;

    if( WasCollectedData )
      PutInTempFile2( TempFile2, RepResp2.rec.OperDate,
                                 RepResp2.rec.FIID,
                                 RepResp2.rec.DealID,
                                 RepResp2.rec.DLLegID,
                                 RepResp2.rec.DocumentID,
                                 RepResp2.rec.HolderAccID,
                                 RepResp2.rec.RegLineID,
                                 RepResp2.rec.Amount,
                                 RepResp2.rec.PayAmount,
                                 RepResp2.rec.OwnerID,
                                 RepResp2.rec.OwnerNotRes,
                                 RepResp2.rec.OwnerIsBank,
                                 RepResp2.rec.IssuerID,
                                 RepResp2.rec.IssuerNotRes,
                                 RepResp2.rec.IssuerIsBank );
    end;

    RemProgressBar;

    return WasCollectedData;
  END;

  /* Это ТО аванса/задатка */
  PRIVATE MACRO IsAvancePayment( rq )
     return   (rq.type == DLRQ_TYPE_AVANCE)
              or (rq.type == DLRQ_TYPE_DEPOSIT);
  END;

  /* Это ТО по поставке */
  PRIVATE MACRO IsBaseActPayment( rq )
     return ((rq.type == DLRQ_TYPE_DELIVERY) and
             (rq.DealPart == ПЕРВАЯ_ЧАСТЬ) or (rq.DealPart == ВТОРАЯ_ЧАСТЬ)
            );
  END;

  /* Это  ТО по оплате*/
  PRIVATE MACRO IsContrActPayment( rq )
     return ((rq.type == DLRQ_TYPE_PAYMENT) and
             (rq.DealPart == ПЕРВАЯ_ЧАСТЬ) or (rq.DealPart == ВТОРАЯ_ЧАСТЬ)
            );
  END;

  /*Выводятся данные о банке контрагента по сделке (его БИК, СВИФТ-код или код страны месторасположения банка).
    Эти данные берутся из того ТО, по которому сформирована данная строка:
    А) для ТО по собственным сделкам банка или по сделкам клиента-резидента в валюте РФ
       -        если счет контрагента-нерезидента открыт в банке-резиденте (в платёжных реквизитах контрагента в ТО указан счет в банке-резиденте (Банк 1)),
          то выводится БИК банка резидента (Банка 1), если контрагент - клиент нашего банка, то выводится БИК нашего банка
       -  если счет контрагента-нерезидента открыт в банке-нерезиденте (Банк 2) и задан банк-резидент (Банк 1),
          в котором открыт корсчет Банка 2 (в платёжных реквизитах контрагента в ТО указан корсчет банка 2), то выводится БИК банка-резидента (Банка 1)
    Б) для ТО по собственным сделкам банка или по сделкам клиента-резидента в ино-странной валюте ИЛИ в валюте РФ и счет контрагента-нерезидента
       открыт в банке за пределами РФ (код страны месторасположения банка не РФ), выводится СВИФТ-код банка нерезидента,
       а если СВИФТ-код не задан, то выводится цифровой код страны банка-нерезидента;
    В) для ТО в иностранной валюте на территории РФ (т.е. счет контрагента-нерезидента открыт в банке с кодом страны месторасположения банка - РФ),
       выводится БИК банка, в котором открыт счет контрагента-нерезидента;
    Г) для ТО по сделкам контрагента-резидента для своего клиента-нерезидента, выводится БИК банка, в котором открыт счет контрагента-резидента.*/

  PRIVATE MACRO ПолучитьБИКБанкаКонтрагента( rq:Object, OwnerID:integer, PayFIID:integer, Deal:Object, BIK_type:@integer )
     var
        party  = TRecHandler( "party" ),
        rqacc =  TRecHandler("dlrqacc"),
        ContractorID = 0, ContractorBankID = 0, BIK = "";
     BIK_type = -1;

     /*найдем банк, где открыт счет контрагента из платежа*/
     if(OwnerID == Payer(rq, Deal))
        ContractorID = Receiver(rq, Deal);/*получим контрагента*/
        ContractorBankID = ПолучитьБанкСубъектаПоСделке(ContractorID, rq.rec.DocKind, rq.rec.DocID, PayFIID, rq.rec.Type)
     else
        ContractorID = Payer(rq, Deal);/*получим контрагента*/
        ContractorBankID = ПолучитьБанкСубъектаПоСделке(ContractorID, rq.rec.DocKind, rq.rec.DocID, PayFIID, rq.rec.Type)
     end;

     party = GetPartyByID( ContractorID, true, true );

     if( ValType(Deal.rec.DealID) != V_UNDEF )
        /*для платежей по сделкам контрагента-резидента для своего клиента-нерезидента,
          выводится БИК банка, в котором открыт счет контрагента-резидента*/
        if( (КлиентКонтрагента(Deal.rec.DealID, ContractorID) == НЕРЕЗИДЕНТ) AND (party.NotResident != SET_CHAR) )
           BIK_type = PTCK_BIC;
           return GetPartyBIK( ContractorBankID );
        end;
     end;
     /*проверим резидентность контрагента*/
     if(not IsPartyNotRes(party)) // ( party.NotResident != SET_CHAR )
        return "";
     end;
     /* если счет контрагента-нерезидента открыт в банке-резиденте
     (в платёжных реквизитах контрагента в ТО указан счет в банке-резиденте (Банк 1)),
     то выводится БИК банка резидента (Банка 1), если контрагент - клиент нашего банка, то выводится БИК нашего банка*/
     if( (ContractorBankID == {OurBank}) AND (PayFIID == NATCUR) )
        BIK_type = PTCK_BIC;
        return GetPartyBIK( {OurBank} );
     else
        party = GetPartyByID( ContractorBankID, true, true );
        /*этот банк является резидентом*/
        if(not IsPartyNotRes(party)) // (party.NotResident != SET_CHAR)
           BIK_type = PTCK_BIC;
           return GetPartyBIK( ContractorBankID );
        else
           rqacc.Clear();
           rqacc.rec.Id = rq.rec.RqAccId;
           if(GetEQ(rqacc) == true)
              party = GetPartyByID( rqacc.rec.BankCorrId, true, true ); /*банк 1*/
              /*проверяем резидентность банка 1 и берем БИК*/
              if(not IsPartyNotRes(party)) // ( party.NotResident != SET_CHAR )
                 BIK_type = PTCK_BIC;
                 return GetPartyBIK( rqacc.rec.BankCorrId );
              end;
           end;
           /*если счет контрагента-нерезидента открыт в банке за пределами РФ (код страны месторасположения банка не РФ),
             выводится СВИФТ-код банка нерезидента, а если СВИФТ-код не задан, то выводится цифровой код страны банка-нерезидента*/
           BIK_type = PTCK_SWIFT;
           BIK = ПолучитьКодСубъекта( ContractorBankID, PTCK_SWIFT );
           if( BIK == "" )
              BIK_type = 0;
              return GetNotResCountryNumCode( party );
           end;
        end;
     end;

     return BIK;
  END;

  /* Получить контрагента в сделке. */
  macro GetContrForDeal( Group, deal )
     /* Если сделка биржевая и контрагент не указан, то берем
        организатора торговли, иначе контрагента. */
     return IIF( IsEXCHANGE(Group) and (deal.rec.PartyID == -1),
                 deal.rec.MarketID, deal.rec.PartyID );
  end;

  /* Сбор данных для 1-го подраздела 1-го раздела отчета.
     Возвращаем true, если отобрали данные. */
  PRIVATE MACRO CollectDataForPart11( Data, TempFile, TempFile2 )

     /* Отчет формируется по ТО, порожденным биржевыми, внебиржевыми,
        а также выпол-ненными через брокера операциями покупки, продажи,
        РЕПО и обратной продажи. По биржевым сделкам, если контрагент не задан
        в сделке, то контрагентом считается биржа, а по сделкам,
        выполненным через брокера - брокер. */

     /* Процедура проверяет подходит ли ТО под режим работы отчета.
           ClientDealFlag    - флаг, клиентская сделка
           OwnerNotRes       - владелец бумаг является нерезидентом
           ContractorNotRes  - контрагент является нерезидентом */
     macro PaymCorrespWorkMode( ClientDealFlag, OwnerNotRes, ContractorNotRes )

        /* Проверка условия для первого режима работы. */
        macro CheckForFirstMode()
           return ContractorNotRes
              and ( not ClientDealFlag or not OwnerNotRes );
        end;

        if( Data.FirstWorkMode )
           /* если отчет формируется в режиме "операции банка и
              клиентов-резидентов с нерезидентами", то отбираются:
              i.  платежи сделок нашего банка с контрагентом-нерезидентом
              ii. платежи сделок клиентов-резидентов с контрагентами-нерезидентами. */
           return CheckForFirstMode();
        else
           /* если отчет формируется в режиме "операции нерезидентов с
              резидентами", то отбираются:
              i.   сделки нашего банка с контрагентом-нерезидентом
              ii.  сделки клиентов-резидентов с контрагентами-нерезидентами,
              iii. сделки клиентов-нерезидентов с контрагентами-резидентами. */
           return CheckForFirstMode()
               or ClientDealFlag and OwnerNotRes and not ContractorNotRes;
        end;
     end;

     var
        rq,
        WasCollectedData = false;

     /* Процедура отбора ТО заданного назначения
           Type              - Вид ТО
           DealPart          - Часть сделки
           NeedClientDeal    - true   - платеж должен быть по клиентской сделке
                             - false  - по собственной сделке */
     macro CollectPayments(Type, DealPart, NeedClientDeal )
        var
           deal        = TRecHandler( "dl_tick" ),
           dl_leg      = TRecHandler( "dl_leg" ),
           ClientDealFlag, Gr,
           OwnerID, OwnerNotRes, OwnerIsBank,
           ContrID, ContrNotRes, ContrIsBank, ContrShName,
           IsExistAvance, A6_PaymFIID, OperDate, Query, sqlQuery, TempQuery,
           Temp1Query, IssuerID, IssuerNotRes, IssIsBank, BrokerNotRes,
           RqSelect,RqWhere,tickWhere,AttrJoin,tickJoin,RqWith,withAttr,withNote,withRq_all,withRqWhere;

        /* Назначение ТО должно совпадать и ТО должно быть закрыто.
           Если платеж не закрыт, то ValueDate - это не фактическая дата
           платежа, фактической даты в этом случае еще нет. */
       begaction(100,"Подготовка данных для отчета");


        /*По паям могут быть как отдельные операции получения паев, так и обычные покупки и продажи*/
         
       withAttr =" attr as "+
                     " (select /*+ materialize*/ attr.t_Object "+
            "                      FROM dobjatcor_dbt attr " +
            "                     WHERE attr.t_ObjectType = " + string(OBJTYPE_DLRQ) +
            "                       AND attr.t_GroupID = 14 " +
            // "                       AND attr.t_Object = LPAD(rq.t_id, 10, '0') " +
            "                       AND attr.t_AttrID = NVL((select objattr.t_AttrID " +
            "                                                  from dobjattr_dbt objattr " +
            "                                                 where objattr.t_ObjectType = attr.t_ObjectType " +
            "                                                   and objattr.t_GroupID = attr.t_GroupID " +
            "                                                   and objattr.t_Name like 'Да'), 0))" ;


       withNote = " note as  "+
            "(select /*+ materialize*/  "+
            "       note.t_DocumentID "+
            "       ,TO_DATE(DECODE(UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 1, 1))),0,1,"+
            "                   UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 1, 1)))) || '-' || " +
            "                   DECODE(UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 2, 1))),0,1," +
            "                   UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 2, 1)))) || '-' || " +
            "                   DECODE(UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 3, 2))),0,1," +
            "                   UTL_RAW.CAST_TO_binary_integer(utl_raw.reverse(utl_raw.substr(note.t_text, 3, 2)))), 'DD-MM-YYYY') as t_46note " +
            "        from dnotetext_dbt note " +
            "       where note.t_ObjectType = "+string(OBJTYPE_DLRQ)+
            "         and note.t_NoteKind = 46 "+
            //--    and note.t_DocumentID = lpad(to_char(rq.t_Id), 10, '0'))
            "         )  " ;

       RqSelect = "select rq.* " +
                 " from ddlrq_dbt rq ";

       RqWhere = " where rq.t_DocKind in(" + string(DL_SECURITYDOC) + ", " + string(DL_INVESTSHARE) + ", " + string(DL_SECUROWN) + ") " +
                 " and rq.t_DealPart = " + string(DealPart) +
                 " and   rq.t_type = " + string(Type) +
                 " and  ( rq.t_state = " + string(DLRQ_STATE_EXEC) +
                 "        or rq.t_state = " + string(DLRQ_STATE_GO_CLOSE) +
/*GAA:501637*/   "        or (rq.t_state = " + string(DLRQ_STATE_REJECT) + " and rq.t_DocKind = "+ string(DL_INVESTSHARE) + ") " +
                 "         )"  ;



       tickJoin = " join ddl_tick_dbt tick "+
                 " on tick.t_DealID = rq.t_DocID ";



        /*  Temp1Query = "select rq.* " +
                 " from ddlrq_dbt rq, ddl_tick_dbt tick " +
                 " where rq.t_DocKind in(" + string(DL_SECURITYDOC) + ", " + string(DL_INVESTSHARE) + ", " + string(DL_SECUROWN) + ") " +
                 " and rq.t_DealPart = " + string(DealPart) +
                 " and   rq.t_type = " + string(Type) +
                 " and  ( rq.t_state = " + string(DLRQ_STATE_EXEC) +
                 "        or rq.t_state = " + string(DLRQ_STATE_GO_CLOSE) +
                 "        or (rq.t_state = " + string(DLRQ_STATE_REJECT) + " and rq.t_DocKind = "+ string(DL_INVESTSHARE) + ") " +
                 "         )" +
                 " and tick.t_DealID = rq.t_DocID "; */

        if ((Type==DLRQ_TYPE_PAYMREPOCOUP) or (Type==DLRQ_TYPE_PAYMREPOPART))	
          /*TempQuery = Temp1Query + " and */
          tickWhere =  " tick.t_ClientID " +
                 IIF( NeedClientDeal, " != -1 ", " = -1 and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " );
        else
          /*TempQuery = Temp1Query + " and */    
          tickWhere =  " tick.t_ClientID " +
                 IIF( NeedClientDeal, " != -1 ", " = -1 and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) != 1 " );
        end;

       AttrJoin = " left join attr "+ 
                   "   on attr.t_Object = LPAD(rq.t_id, 10, '0') " ;
          
       withRqWhere = RqWhere + " and attr.t_Object is null " ;

       withRq_all = " with "+withAttr+","+withNote+","+
                    " rq_all as ( " + RqSelect+ AttrJoin +
                    " join note on note.t_DocumentID = lpad(to_char(rq.t_Id), 10, '0') "+
                    withRqWhere+ " and note.t_46note between "+GetSQLDate(Data.PeriodBeg)+" and "+GetSQLDate(Data.PeriodEnd)+
                    " union all "+ RqSelect+ AttrJoin +
                    " left join note on note.t_DocumentID = lpad(to_char(rq.t_Id), 10, '0') "+
                    withRqWhere+" and rq.t_FactDate  between "+GetSQLDate(Data.PeriodBeg)+" and "+GetSQLDate(Data.PeriodEnd)+
                    " and note.t_DocumentID is null) " ;


        if( (Type==DLRQ_TYPE_COMPPAYM) or (Type==DLRQ_TYPE_PAYMREPOCOUP) or (Type==DLRQ_TYPE_PAYMREPOPART) )

          Query = withRq_all +
              " select rq.* " +
              " from rq_all rq " + tickJoin + " where "+ tickWhere;

               /*  Query =  TempQuery + +
                    " and " +КатегДокНетИлиНеЗаполн()+
                    " and case when " +ДатаДокИзПримечания()+ " != TO_DATE('01.01.0001','DD.MM.YYYY') " +
                    "          then " +ДатаДокИзПримечания()+
                    "          else rq.t_FactDate end between "+GetSQLDate(Data.PeriodBeg)+" and "+GetSQLDate(Data.PeriodEnd); */


        elif( NeedClientDeal == true )

          Query = withRq_all +
                RqSelect + tickJoin + RqWhere + " and " + tickWhere+
                 " and rq.t_FactDate >= " + GetSQLDate(Data.PeriodBeg) +
                 " and rq.t_FactDate <= " + GetSQLDate(Data.PeriodEnd) +
                 " and ((rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                 "       and (rq.t_DealPart =  1" +
                 "            or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                 "            or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ ")) "+
                 "      or (rsb_secur.IsSale(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                 "          and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                 "         and (rq.t_DealPart = 2 " +
                 "          or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                 "          or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ "))) "+
                 " union all " +
                 " select rq.* " +
                 " from rq_all rq " + tickJoin + " where "+ tickWhere+
                 " and ((rsb_secur.IsSale(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                 "       and (rq.t_DealPart = 1 " +
                 "            or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                 "            or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ ")) "+
                 "      or (rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                 "          and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                 "         and (rq.t_DealPart =  2 " +
                 "          or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                 "          or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ "))) ";		  

           /*Query =  TempQuery +
                    " and rq.t_FactDate >= " + GetSQLDate(Data.PeriodBeg) +
                    " and rq.t_FactDate <= " + GetSQLDate(Data.PeriodEnd) +

                    " and ((rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                    "       and (rq.t_DealPart =  1" +
                    "            or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                    "            or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ ")) "+
                    "      or (rsb_secur.IsSale(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                    "          and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                    "         and (rq.t_DealPart = 2 " +
                    "          or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                    "          or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ "))) "+
                    " union all " +
                    TempQuery +
                    " and ((rsb_secur.IsSale(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                    "       and (rq.t_DealPart = 1 " +
                    "            or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                    "            or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ ")) "+
                    "      or (rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                    "          and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 " +
                    "         and (rq.t_DealPart =  2 " +
                    "          or rq.t_type = " + string(DLRQ_TYPE_AVANCE)+
                    "          or rq.t_type = " + string(DLRQ_TYPE_DEPOSIT)+ "))) "+
                    " and " +КатегДокНетИлиНеЗаполн()+
                    " and case when " +ДатаДокИзПримечания()+ " != TO_DATE('01.01.0001','DD.MM.YYYY') " +
                    "          then " +ДатаДокИзПримечания()+
                    "          else rq.t_FactDate end between "+GetSQLDate(Data.PeriodBeg)+" and "+GetSQLDate(Data.PeriodEnd); */
        else
           Query = RqSelect + tickJoin + RqWhere + " and " + tickWhere+
          /* TempQuery + */
                 " and rq.t_FactDate >= " + GetSQLDate(Data.PeriodBeg) +
                 " and rq.t_FactDate <= " + GetSQLDate(Data.PeriodEnd); 
        end;
        
        Query = " select count(*) over() as Recc, res.* from ("+Query+") res  ";

        sqlQuery = RSDCommand(Query);
        sqlQuery.execute();

        rq = TRsbDataSet( sqlQuery );

        var reccount = -1 ;

        while( rq.MoveNext() )
              if (reccount == -1)
                endaction();
                InitProgressForCollectData( int(rq.Recc), 1, 1 );
              end;
              reccount = rq.Recc ;
              UseProgressBar;

              /* Получим сделку. */
              /* Проверим клиентская сделка или нет и нужна ли нам такая */
              /* Проверим вид сделки */
              /* Проверим договор обслуживания клиента */
              deal           = GetDealFileByID( rq.DocID, true );
              Gr             = GetOpGroup( deal.rec );
              ClientDealFlag = IsClientDeal( deal.rec );
              OwnerID        = IIF( ClientDealFlag, deal.rec.ClientID, {OurBank} );
              OperDate       = SQL_ConvTypeDate(rq.FactDate);

              var ClientIsBrok = false;
              /* Определим параметры владельца ц/б */
              GetPartyParam(OwnerID, @OwnerNotRes, @OwnerIsBank, @ClientIsBrok);
              IsGoodAvoir(Data, deal.rec.PFI, @IssuerID);
              GetPartyParam(deal.rec.BrokerID, @BrokerNotRes);
              GetPartyParam(IssuerID, @IssuerNotRes);

              var FactReceiverID = Int(GetFactReceiverID(deal.rec.DealID, deal.rec.ClientID));
              if(   (deal.rec.DealID > 0)
                    and (IsEXCHANGE(Gr) or IsOUTEXCHANGE(Gr) or IsBROKER(Gr) or (deal.rec.BofficeKind == DL_INVESTSHARE))
                    and (IsBUY(Gr) or IsSale(Gr) or IsREPO(Gr) )
                    and (not( ((not BrokerNotRes) and (deal.rec.brokerid != -1)) and IssuerNotRes and (not ВидСубъекта(FactReceiverID, PTK_CLIENT))) )/*PNV*/
                    and CheckClientContr(ClientDealFlag, OwnerID, OperDate)
                )

                 /* Проверим подходит ли бумага и правильно ли задан контрагент. */
                 ContrID  = GetContrForDeal( Gr, deal );
                 dl_leg   = GetDlLegByDealID( deal.rec.DealID,
                                   IIF(DealPart == 1, LEG_KIND_DL_TICK, LEG_KIND_DL_TICK_BACK) );

                 if( (ContrID != 0) and IsGoodAvoir(Data, dl_leg.PFI, @IssuerID) )

                    /* Определим параметры контрагента по сделке. */
                    GetPartyParam( ContrID, @ContrNotRes, @ContrIsBank );

                    /* Подходит ли платеж под режим работы? */
                    if( PaymCorrespWorkMode( ClientDealFlag, OwnerNotRes, ContrNotRes )
                    or ( ( Type == DLRQ_TYPE_PAYMREPOCOUP ) or ( Type == DLRQ_TYPE_PAYMREPOPART ) ) 
                    or ( КлиентКонтрагента( deal.rec.DealID, ContrID ) == НЕРЕЗИДЕНТ ) and ( ContrNotRes or СделкаСКлиентомКонтрагентом( deal ) ) )

                       /* Проверим существование аванса или задатка. */
                       var AvanceQuery = "select 1" +
                                         " from ddlrq_dbt" +
                                         " where t_DocKind = ?" +
                                         "    and t_DocID = ?" +
                                         "    and t_Type in(" + string(DLRQ_TYPE_AVANCE) + ", " + string(DLRQ_TYPE_DEPOSIT) + ")";

                       var AvanceSelect = DL_RSDCommand(AvanceQuery);
                       AvanceSelect.AddParam(deal.rec.BOfficeKind);
                       AvanceSelect.AddParam(deal.rec.DealID);
                       var AvanceDS = AvanceSelect.Execute();
                       IsExistAvance = AvanceDS.MoveNext();

                       /*  A7 - код валюты платежа
                           Цифровой код валюты расчетов сделки (для ТО по оплате и поставке комп. платежа)
                           или код валюты оплаты аванса (для ТО аванса)
                           Для <A4> = "22" (если вид ТО = "Поставка") выводится код валюты номинала ц/б.*/

                       if( IsAvancePayment(rq) or (rq.Type == DLRQ_TYPE_COMPPAYM) or (rq.Type==DLRQ_TYPE_PAYMREPOCOUP) or (rq.Type==DLRQ_TYPE_PAYMREPOPART))
                          A6_PaymFIID = rq.FIID;
                       else
                          A6_PaymFIID = dl_leg.PayFIID;
                       end;

                       /*для сделки РЕПО сохраним выплаты Купонов и ЧП в файл для подраздела 2 раздела 1*/
                       if( ( Data.PrintPart12 ) and ( ( Type == DLRQ_TYPE_PAYMREPOCOUP ) or ( Type == DLRQ_TYPE_PAYMREPOPART ) ) )

                          GetPartyParam( IssuerID, @IssuerNotRes, @IssIsBank );
                          if (OwnerNotRes)
                           PutInTempFile2( TempFile2, SQL_ConvTypeDate(rq.FactDate),
                                                      dl_leg.PFI,
                                                      rq.ID,
                                                      dl_leg.ID,
                                                      0,
                                                      0,
                                                      0,
                                                      0,
                                                      $0,
                                                      OwnerID,
                                                      BoolToInt( OwnerNotRes ),
                                                      BoolToInt( OwnerIsBank ),
                                                      IssuerID,
                                                      BoolToInt( IssuerNotRes ),
                                                      BoolToInt( IssIsBank ) );
                           WasCollectedDataForPart12 = true;
                          end;
                       else

                          /* Запишем данные во временный файл. */
                          ClearRecord(TempFile);
                          TempFile.PaymentID         = rq.ID;
                          TempFile.FactPaymDate      = OperDate;
                          TempFile.FIID              = dl_leg.PFI;
                          TempFile.DealID            = deal.rec.DealID;
                          TempFile.IsClientDeal      = BoolToInt(ClientDealFlag);
                          TempFile.A6_PaymFIID       = A6_PaymFIID;
                          TempFile.DlLegID           = dl_leg.ID;
                          TempFile.OwnerID           = OwnerID;
                          TempFile.OwnerNotRes       = BoolToInt(OwnerNotRes);
                          TempFile.OwnerIsBank       = BoolToInt(OwnerIsBank);
                          TempFile.ContrID           = ContrID;
                          TempFile.ContrNotRes       = BoolToInt(ContrNotRes);
                          TempFile.ContrIsBank       = BoolToInt(ContrIsBank);
                          TempFile.IsExistAvance     = BoolToInt(IsExistAvance);

                          InsertRecTempFile( TempFile );
                          WasCollectedData = true;

                       end;
                    end;
                 end;
              end;
        end;

        RemProgressBar;
     end;

     /* Помечаем ТО аванса/задатка и по оплате, относящиеся к одной
        части сделки. Важно: в момент вызова функции в файле не должно быть
        никаких платежей, кроме платежей по контрактиву и аванса/задатка. */
     macro MarkPayments()
        var
           Marker = BoolToInt(true),
           DealID, DlLegID, A6_PaymFIID, DiffFIIDFlag, continue_cicle;

        ClearRecord( TempFile );
        Rewind( TempFile );
        continue_cicle = Next(TempFile);

        while( continue_cicle )
           DealID      = TempFile.DealID;
           DlLegID     = TempFile.DlLegID;
           A6_PaymFIID = TempFile.A6_PaymFIID;

           continue_cicle = Next( TempFile );
           if(   continue_cicle    and (DealID == TempFile.DealID)
                             and (DlLegID == TempFile.DlLegID) )

              /* Нашли два ТО по одной части сделки. Один из них будет
                 платежом по контрактиву(оплате), другой платежом аванса/задатка.
                 Пометим их. */

              DiffFIIDFlag = BoolToInt( A6_PaymFIID != TempFile.A6_PaymFIID );

              /* Помечаем первый платеж - текущий. */
              TempFile.InUnionPayment = Marker;
              TempFile.DiffFIIDFlag   = DiffFIIDFlag;
              continue_cicle = Update( TempFile );

              /* Помечаем второй платеж - предыдущий. */
              continue_cicle = continue_cicle and Prev( TempFile );
              if( continue_cicle )
                 TempFile.InUnionPayment = Marker;
                 TempFile.DiffFIIDFlag   = DiffFIIDFlag;
                 continue_cicle = continue_cicle and Update( TempFile );
                 continue_cicle = continue_cicle and Next( TempFile );
              end;

              continue_cicle = continue_cicle and Next( TempFile );
           end;
        end;
     end;

     /* По собственным сделкам банка отбираются  ТО по поставке
        (даже в том случае, когда контрагентом по сделке является клиент-нерезидент),
         фактическая дата исполнения которых входит в отчетный период. */

     /* По клиентским сделкам отбираются ТО аванса/задатка и ТО по оплате,
        исходя из следующих положений. Если в сделке есть аванс/задаток и
        платеж по контрактиву и аванса/задатка попадают в один отчетный период,
        то они отражаются одной строкой в отчете. */

     /* Итоговые ТО операции неттинга в отчёт НЕ отбираются.*/

     /* Если сделка состоит из двух частей, то в отчет могут быть
        включены независимо друг от друга ТО как первой, так и второй
        частей, если фактическая дата их исполнения входит в отчетный
        период. */

     if( Data.PrintPart11 )
        /* Собираем платежи по клиентским сделкам. */
        CollectPayments( DLRQ_TYPE_PAYMENT, ПЕРВАЯ_ЧАСТЬ,  true );
        CollectPayments( DLRQ_TYPE_PAYMENT, ВТОРАЯ_ЧАСТЬ,  true );
        CollectPayments( DLRQ_TYPE_AVANCE,  ПЕРВАЯ_ЧАСТЬ,  true );
        CollectPayments( DLRQ_TYPE_AVANCE,  ВТОРАЯ_ЧАСТЬ,  true );
        CollectPayments( DLRQ_TYPE_DEPOSIT, ПЕРВАЯ_ЧАСТЬ,  true );
        CollectPayments( DLRQ_TYPE_DEPOSIT, ВТОРАЯ_ЧАСТЬ,  true );
        /* Помечаем ТО аванса/задатка и ТО по оплате, относящиеся к одной
           сделке. Они будут выводиться в одной строке отчета. */
        MarkPayments();
        /* Собираем ТО по собственным сделкам. */
        CollectPayments(DLRQ_TYPE_DELIVERY, ПЕРВАЯ_ЧАСТЬ,  false );
        CollectPayments(DLRQ_TYPE_DELIVERY, ВТОРАЯ_ЧАСТЬ,  false );

        CollectPayments(DLRQ_TYPE_COMPPAYM, ВТОРАЯ_ЧАСТЬ,  true );

        WasCollectedData = CollectDataForPart1ByVS( Data, 1, TempFile2 ) or WasCollectedData;
     end;

     if( Data.PrintPart12 )
        CollectPayments( DLRQ_TYPE_PAYMREPOCOUP, ВТОРАЯ_ЧАСТЬ,  true );
        CollectPayments( DLRQ_TYPE_PAYMREPOPART, ВТОРАЯ_ЧАСТЬ,  true );
        CollectPayments( DLRQ_TYPE_PAYMREPOCOUP, ВТОРАЯ_ЧАСТЬ,  false );
        CollectPayments( DLRQ_TYPE_PAYMREPOPART, ВТОРАЯ_ЧАСТЬ,  false );
     end;

     return WasCollectedData;
  END;

  PRIVATE MACRO CollectDataForPart2ByCB( Data, SubPartNumber, TempFile, TempFile2 )
    var WasCollectedData = false;
    var ClientContrNotRes;
    var ClientContrBrok;
    var ClientcontrContrIDManager;

    macro MarkPayments()
        var
           Marker = BoolToInt(true),
           DealID, DlLegID, A6_PaymFIID, DiffFIIDFlag, continue_cicle;

        ClearRecord( TempFile );
        Rewind( TempFile );
        continue_cicle = Next(TempFile);

        while( continue_cicle )
           DealID      = TempFile.DealID;
           DlLegID     = TempFile.DlLegID;
           A6_PaymFIID = TempFile.A6_PaymFIID;

           continue_cicle = Next( TempFile );
           if(   continue_cicle    and (DealID == TempFile.DealID)
                             and (DlLegID == TempFile.DlLegID) )

              /* Нашли два ТО по одной части сделки. Один из них будет
                 платежом по контрактиву(оплате), другой платежом аванса/задатка.
                 Пометим их. */

              DiffFIIDFlag = BoolToInt( A6_PaymFIID != TempFile.A6_PaymFIID );

              /* Помечаем первый платеж - текущий. */
              TempFile.InUnionPayment = Marker;
              TempFile.DiffFIIDFlag   = DiffFIIDFlag;
              continue_cicle = Update( TempFile );

              /* Помечаем второй платеж - предыдущий. */
              continue_cicle = continue_cicle and Prev( TempFile );
              if( continue_cicle )
                 TempFile.InUnionPayment = Marker;
                 TempFile.DiffFIIDFlag   = DiffFIIDFlag;
                 continue_cicle = continue_cicle and Update( TempFile );
                 continue_cicle = continue_cicle and Next( TempFile );
              end;

              continue_cicle = continue_cicle and Next( TempFile );
           end;
        end;
    end;

    var Query = "select dlrq.*, dl_tick.t_ClientID" + IIF(SubPartNumber == 1, ", issuer.t_PartyID as t_Issuer ", " ") +
                "from ddlrq_dbt dlrq, ddl_tick_dbt dl_tick, dparty_dbt party ";
                if(SubPartNumber == 1)
                    Query = Query +  ", dfininstr_dbt fininstr, dparty_dbt issuer ";
                else
                    Query = Query + ", dparty_dbt client ";
                end;
    Query = Query +
                "where dl_tick.t_BofficeKind = " + string(DL_SECURITYDOC) +
                "   and dlrq.t_DocKind = dl_tick.t_BofficeKind" +
                "   and dlrq.t_DocID = dl_tick.t_DealID" +
                "   and (" +
                "               party.t_PartyID = dl_tick.t_PartyID" +
                "               and ( party.t_NotResident <> 'X'" +
                // плюс нерезиденты со спецпризнаком  
                "                  OR ( party.t_NotResident = CHR (88)" +
                "                  and EXISTS " +
                "                    (SELECT 1 " +
                "                       FROM dobjatcor_dbt attr " +
                "                      WHERE attr.t_ObjectType = 3 " +
                "                        AND attr.t_Object = LPAD(PARTY.T_PARTYID, 10, '0' ) " +
                "                        AND attr.t_GroupID = 16 " +
                "                        AND attr.t_attrid IN ( " 
                                                + PARTY_ATTR_FZ4015 + ", "      // Филиал иностранной страховой организации по ФЗ 4015-I
                                                + PARTY_ATTR_FZ290  +           // Международная компания по 290-ФЗ
                "                    )) " +
                "                  ) " +
                "                ) " +
                // ------
                "       )"; 

    if(SubPartNumber == 1)
        Query = Query +
                "   and dl_tick.t_ClientID = -1" +
                "   and fininstr.t_FIID = dlrq.t_FIID" +
                "   and dlrq.t_Type = " + DLRQ_TYPE_DELIVERY +
                "   and dlrq.t_FactDate BETWEEN ? and ?";

        // DEF-74943 - оптимизация запроса через замену OR на union
        var Query1 = Query +
                "   and (" +
                "           (" +
                "               (" +
                "                   (" +
                "                       fininstr.t_AvoirKind not in(" + AVOIRISSKIND_DEPOSITORY_RECEIPT + ", " + AVOIRISSKIND_AMERICAN_DEPREC + ", " + AVOIRISSKIND_GLOBAL_DEPREC + ", " + AVOIRISSKIND_RUSSIAN_DEPREC + ", " + AVOIRISSKIND_EUROPEAN_DEPREC + ", " + AVOIRISSKIND_BASKET + ")" +
                "                       and issuer.t_PartyID = fininstr.t_Issuer" +
                "                   )" +
                "                   or issuer.t_PartyID = (" +
                "                                             select fi.t_Issuer" +
                "                                             from dfininstr_dbt fi"
                "                                             where fi.t_FIID = fininstr.t_ParentFI" +
                "                                         )" +
                "               )" +
                "               and issuer.t_NotResident = 'X'" +
                // минус нерезиденты со спецпризнаком  
                "                  and NOT EXISTS " +
                "                    (SELECT 1 " +
                "                       FROM dobjatcor_dbt attr " +
                "                      WHERE attr.t_ObjectType = 3 " +
                "                        AND attr.t_Object = LPAD(issuer.T_PARTYID, 10, '0' )" +
                "                        AND attr.t_GroupID = 16 " +
                "                        AND attr.t_attrid IN ( " 
                                                + PARTY_ATTR_FZ4015 + ", "      // Филиал иностранной страховой организации по ФЗ 4015-I
                                                + PARTY_ATTR_FZ290  +           // Международная компания по 290-ФЗ
                "                    )) " +
                // ------
                "           )" +
                "       )";

        var Query2 = Query + 
                "   and (" +
                "                  fininstr.t_AvoirKind = " + AVOIRISSKIND_BASKET +
                "                  and exists(" +
                "                               select SUM(CASE WHEN dl_tick_ens.T_KIND = 0 THEN NVL(T_PRINCIPAL,0) ELSE NVL(-T_PRINCIPAL,0) END) T_PRINCIPAL, dl_tick_ens.t_FIID " +
                "                               from ddl_tick_ens_dbt dl_tick_ens, dfininstr_dbt fib, dparty_dbt fibissuer" +
                "                               where dl_tick_ens.t_DealID = dlrq.t_DocID" +
                "                                   and dl_tick_ens.t_Date <= ? " +
                "                                   and fib.t_FIID = dl_tick_ens.t_FIID" +
                "                                   and fibissuer.t_PartyID = fib.t_Issuer" +
                "                                   and fibissuer.t_NotResident = 'X'" +
                "                               group by T_PRINCIPAL, dl_tick_ens.t_FIID " +
                "                               having SUM(CASE WHEN dl_tick_ens.T_KIND = 0 THEN NVL(T_PRINCIPAL,0) ELSE NVL(-T_PRINCIPAL,0) END) > 0" +
                "                            )" +
                "       )";
        Query = "select * from  ( " + Query1 + " union " + Query2 + " ) "; 
    elif(SubPartNumber == 2)
        Query = Query +
                "   and dl_tick.t_ClientID > 0" +
                "   and client.t_PartyID = dl_tick.t_ClientID" +
                "   and ( client.t_NotResident <> 'X'" +
                // плюс нерезиденты со спецпризнаком  
                "                  OR ( client.t_NotResident = CHR (88)" +
                "                  and Exists " +
                "                    (SELECT 1 " +
                "                       FROM dobjatcor_dbt attr " +
                "                      WHERE attr.t_ObjectType = 3 " +
                "                        AND attr.t_Object = LPAD(client.T_PARTYID, 10, '0' ) " +
                "                        AND attr.t_GroupID = 16 " +
                "                        AND attr.t_attrid IN ( " 
                                                + PARTY_ATTR_FZ4015 + ", "      // Филиал иностранной страховой организации по ФЗ 4015-I
                                                + PARTY_ATTR_FZ290  +           // Международная компания по 290-ФЗ
                "                    )) " +
                "                  ) " +
                "        ) " +
                // ------
                "   and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind))) = 0" +
                "   and rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind))) = 1" +
                "   and dlrq.t_Kind = " + DLRQ_KIND_COMMIT +
                "   and (" +
                "           (" +
                "               dlrq.t_Type in (" + DLRQ_TYPE_PAYMENT + ")" +
                "               and " +
                "                       dlrq.t_FactDate BETWEEN ? and ?" + //1, 2
                "           )" +
                "           or " +
                "           (" +
                "               (dlrq.t_Type = " + DLRQ_TYPE_AVANCE + " or dlrq.t_Type = " + DLRQ_TYPE_DEPOSIT + ")" +
                "               and rsb_secur.GetMainObjAttr(" + OBJTYPE_DLRQ + ", LPAD(dlrq.t_ID, 10, '0'), 14, ?) <> 241" + //3
                "               and (dlrq.t_FactDate >= ? or (rsi_rsb_kernel.GetNote(" + OBJTYPE_DLRQ + ", LPAD(dlrq.t_ID, 10, '0'), 46, ?) is not NULL and rsb_struct.getDate(rsi_rsb_kernel.GetNote(" + OBJTYPE_DLRQ + ", LPAD(dlrq.t_ID, 10, '0'), 46, ?)) BETWEEN ? and ?))" + //4, 5, 6, 7, 8
                "           )" +
                "       )" +
                "   and RSI_RSB_FIInstr.ConvSum(dlrq.t_Amount, dlrq.t_FIID, " + NATCUR + ", dlrq.t_FactDate, 1) >= RSI_RSB_FIInstr.ConvSum(10000000, ?, " + NATCUR + ", dlrq.t_FactDate, 1)"; //9
    end;
    Query = Query + " order by t_FactDate";

    var comm = DL_RSDCommand(Query);
    if(SubPartNumber == 1)
        comm.AddParam(Data.PeriodBeg);
        comm.AddParam(Data.PeriodEnd);
        comm.AddParam(Data.PeriodBeg);
        comm.AddParam(Data.PeriodEnd);
        comm.AddParam(Data.PeriodEnd);
    elif(SubPartNumber == 2)
        comm.AddParam(Data.PeriodBeg); //1
        comm.AddParam(Data.PeriodEnd); //2
        comm.AddParam(Data.PeriodEnd); //3
        comm.AddParam(Data.PeriodBeg); //4
        comm.AddParam(Data.PeriodEnd); //5
        comm.AddParam(Data.PeriodEnd); //6
        comm.AddParam(Data.PeriodBeg); //7
        comm.AddParam(Data.PeriodEnd); //8
        var USDQuery = "select t_FIID from dfininstr_dbt where t_FI_Code = '840'";
        var USDSelect = DL_RSDCommand(USDQuery);
        var USDDataSet = USDSelect.Execute();
        USDDataSet.MoveNext();
        comm.AddParam(USDDataSet.FIID); //9
    end;
    var DS = comm.execute();

    while(DS.MoveNext())
        var deal = GetDealFileByID( DS.DocID, true );
        var Gr = GetOpGroup( deal.rec );
        var ContrID = GetContrForDeal( Gr, deal );
        var dl_leg = GetDlLegByDealID( deal.rec.DealID, IIF( DS.DealPart == 1, LEG_KIND_DL_TICK, LEG_KIND_DL_TICK_BACK ) );

        var IssuerID;
        IsGoodAvoir(Data, dl_leg.PFI, @IssuerID);

        var SelectExistsAvance = DL_RSDCommand("select 1 from ddlrq_dbt where t_DocID = " + deal.rec.DealID + " and t_Type in(" + DLRQ_TYPE_AVANCE + ", " + DLRQ_TYPE_DEPOSIT + ")");
        var DSExistsAvance = SelectExistsAvance.Execute();
        var IsExistAvance = DSExistsAvance.MoveNext();
        var OwnerNotRes = false, OwnerIsBank = false;
        var ContrNotRes = false, ContrIsBank = false, ContrIsBrok = false, ContrIsConfIDManager = false;
        var OwnerIsConfIDManager = false, OwnerIsBrok = false;

        GetPartyParam(ContrID, @ContrNotRes, @ContrIsBank, @ContrIsBrok, @ContrIsConfIDManager);
        GetPartyParam(IIF(deal.rec.ClientID == -1, {OurBank}, deal.rec.ClientID), @OwnerNotRes, @OwnerIsBank, @OwnerIsBrok, @OwnerIsConfIDManager);
        var ContrIsBuyer = (IsBuy(Gr) and (not IsREPO(Gr))) or (IsRepo(Gr) and ((IsBuy(Gr) and (DS.DealPart == 1)) or (IsSale(Gr) and (DS.DealPart == 2))));
        var OwnerIsBuyer = not ContrIsBuyer;
        var IssuerNotRes, IssuerIsBank;
        GetPartyParam(IssuerID, @IssuerNotRes, @IssuerIsBank);
        if(not IssuerNotRes)
            continue;
        end;
        
        if(not ContrNotRes)
           if(SubPartNumber == 2)
              if((not OwnerIsBank) and (not OwnerIsBrok) and (not OwnerIsConfIDManager) and (not IsRepo(Gr)))
              PutInTempFile2( TempFile2, date(DS.FactDate),
                                         dl_leg.PFI,
                                         DS.ID,
                                         dl_leg.ID,
                                         0,
                                         0,
                                         0,
                                         0,
                                         dl_leg.TotalCost,
                                         deal.rec.ClientID,
                                         BoolToInt(OwnerIsBuyer),
                                         BoolToInt(OwnerIsBank),
                                         ContrID,
                                         BoolToInt(ContrIsBuyer),
                                         BoolToInt(ContrIsBank),
                                         BoolToInt(IsExistAvance) );
              MarkPayments();
              end;
           elif(SubPartNumber == 1)
               ClearRecord(TempFile);
               TempFile.PaymentID      = DS.ID;
               TempFile.FactPaymDate   = date(DS.FactDate);
               TempFile.FIID           = DS.FIID;
               TempFile.IsClientDeal   = 0;
               TempFile.A6_PaymFIID    = dl_leg.PayFIID;
               TempFile.DlLegID        = dl_leg.ID;
               TempFile.OwnerID        = {OurBank};
               TempFile.OwnerNotRes    = BoolToInt(OwnerIsBuyer);
               TempFile.OwnerIsBank    = BoolToInt(OwnerIsBank);
               TempFile.ContrID        = ContrID;
               TempFile.ContrNotRes    = BoolToInt(ContrIsBuyer);
               TempFile.ContrIsBank    = BoolToInt(ContrIsBank);
               TempFile.IsExistAvance  = BoolToInt(IsExistAvance);
               TempFile.DealID         = DS.DocID;
               InsertRecTempFile( TempFile );
           end;
    
           WasCollectedData = true;
        end;
    end;

    if(SubPartNumber == 1)
        var QueryCompPayments = "select dlrq.*, dl_tick.t_PartyID as t_ContrID, dl_tick.t_ClientID " +
                                "from ddlrq_dbt dlrq, ddl_tick_dbt dl_tick, dparty_dbt party " +
                                "where dl_tick.t_BofficeKind = " + string(DL_SECURITYDOC) +
                                "   and dlrq.t_DocKind = dl_tick.t_BofficeKind" +
                                "   and dlrq.t_DocID = dl_tick.t_DealID" +
                                "   and party.t_PartyID = dl_tick.t_PartyID" +
                                "   and ( party.t_NotResident <> 'X'" +
                                 // плюс нерезиденты со спецпризнаком  
                                 "                  OR ( party.t_NotResident = CHR (88)" +
                                 "                  and EXISTS " +
                                 "                    (SELECT 1 " +
                                 "                       FROM dobjatcor_dbt attr " +
                                 "                      WHERE attr.t_ObjectType = 3 " +
                                 "                        AND attr.t_Object = LPAD(PARTY.T_PARTYID, 10, '0' )" +
                                 "                        AND attr.t_GroupID = 16 " +
                                 "                        AND attr.t_attrid IN ( " 
                                                                  + PARTY_ATTR_FZ4015 + ", "      // Филиал иностранной страховой организации по ФЗ 4015-I
                                                                  + PARTY_ATTR_FZ290  +           // Международная компания по 290-ФЗ
                                 "                    )) " +
                                 "                  ) " +
                                 "      ) " +
                                 // ------
                                "   and dl_tick.t_ClientID = -1" +
                                "   and dlrq.t_Type = " + DLRQ_TYPE_COMPPAYM +
                                "   and dlrq.t_FactDate BETWEEN ? and ?";

        var SelectCompPayments = DL_RSDCommand(QueryCompPayments);
        SelectCompPayments.AddParam(Data.PeriodBeg);
        SelectCompPayments.AddParam(Data.PeriodEnd);
        var DSCompPayments = SelectCompPayments.Execute();

        while(DSCompPayments.MoveNext())
            GetPartyParam(DSCompPayments.ClientID, @ClientContrNotRes, NULL, @ClientContrBrok, @ClientContrContrIDManager);
            if(ВидСубъекта(DSCompPayments.ClientID, PTK_CONTR) and (not ClientContrNotRes))
               var dealComp = GetDealFileByID( DSCompPayments.DocID, true );
               var GrComp = GetOpGroup( dealComp.rec );
               var dl_legComp = GetDlLegByDealID( DSCompPayments.DocID, IIF( DSCompPayments.DealPart == 1, LEG_KIND_DL_TICK, LEG_KIND_DL_TICK_BACK ) );
               var OwnerNotResComp = false, OwnerIsBankComp = false;
               var ContrNotResComp = false, ContrIsBankComp = false;
   
               ContrNotResComp = (IsBuy(GrComp) and (not IsREPO(GrComp))) or (IsRepo(GrComp) and ((IsBuy(GrComp) and (DSCompPayments.DealPart == 1)) or (IsSale(GrComp) and (DSCompPayments.DealPart == 2))));
               OwnerNotResComp = not ContrNotResComp;
   
               ClearRecord(TempFile);
               TempFile.PaymentID      = DSCompPayments.ID;
               TempFile.FactPaymDate   = DSCompPayments.FactDate;
               TempFile.FIID           = dl_legComp.PFI;
               TempFile.IsClientDeal   = 0;
               TempFile.A6_PaymFIID    = DSCompPayments.FIID;
               TempFile.DlLegID        = dl_legComp.ID;
               TempFile.OwnerID        = {OurBank};
               TempFile.OwnerNotRes    = BoolToInt(OwnerNotResComp);
               TempFile.OwnerIsBank    = BoolToInt(OwnerIsBankComp);
               TempFile.ContrID        = DSCompPayments.ContrID;
               TempFile.ContrNotRes    = BoolToInt(ContrNotResComp);
               TempFile.ContrIsBank    = BoolToInt(ContrIsBankComp);
               TempFile.IsExistAvance  = 0;
               TempFile.DealID         = DSCompPayments.DocID;
               InsertRecTempFile( TempFile );
   
               WasCollectedData = true;
            end;
        end;
    end;

    return WasCollectedData;
  END;

  PRIVATE MACRO CollectDataForPart2ByVA( Data, SubPartNumber, TempFile2 )
    var WasCollectedData = false;
    var Query = "", Set = null;

    Query = " SELECT "
              + " q.t_RegLineID "
             + " ,q.t_PayAmount "
             + " ,q.t_DocumentID "
             + " ,q.t_FIID "
             + " ,q.t_OwnerID "
             + " ,q.t_IssuerID "
             + " ,COUNT(1) AS t_Amount "
          + " FROM "
              + " (SELECT "
                   + " dl_tick.t_DealID AS t_RegLineID "
                  + " ,vsordlnk.t_BCCost AS t_PayAmount "
                  + " ,vsbanner.t_BCID AS t_DocumentID "
                  + " ,vsbanner.t_FIID ";

    if( SubPartNumber == 1 )
      Query = Query +
                    " ,DECODE(vsordlnk.t_LinkKind, " + VSORDLNK_K_BUY + ", " + {OurBank} + ", dl_tick.t_PartyID) AS t_OwnerID "
                  + " ,DECODE(vsordlnk.t_LinkKind, " + VSORDLNK_K_SALE + ", " + {OurBank} + ", dl_tick.t_PartyID) AS t_IssuerID ";
    else
      Query = Query +
                    " ,DECODE(vsordlnk.t_LinkKind, " + VSORDLNK_K_BUY + ", dl_tick.t_ClientID, dl_tick.t_PartyID) AS t_OwnerID "
                  + " ,DECODE(vsordlnk.t_LinkKind, " + VSORDLNK_K_SALE + ", dl_tick.t_ClientID, dl_tick.t_PartyID) AS t_IssuerID ";
    end;

    Query = Query +
                 " FROM "
                   + " dpmpaym_dbt pmpaym "
                  + " ,ddl_tick_dbt dl_tick "
                  + " ,dvsordlnk_dbt vsordlnk "
                  + " ,dvsbanner_dbt vsbanner "
                  + " ,dparty_dbt party "
                  + " ,doprkoper_dbt oprkoper "
               + " WHERE "
                   + " pmpaym.t_DocKind = dl_tick.t_BofficeKind "
               + " AND pmpaym.t_DocumentID = dl_tick.t_DealID "
               + " AND pmpaym.t_IsFactPaym = 'X' ";

    if( SubPartNumber == 1 )
      Query = Query +
                 " AND pmpaym.t_Purpose = " + BAi + " "
               + " AND pmpaym.t_ValueDate BETWEEN " + GetSQLDate( Data.PeriodBeg ) + " AND " + GetSQLDate( Data.PeriodEnd ) + " "
               + " AND dl_tick.t_ClientID = " + UnknownParty + " ";
    else
      Query = Query +
                 " AND pmpaym.t_Purpose = " + CAi + " "
               + " AND (pmpaym.t_ValueDate BETWEEN " + GetSQLDate( Data.PeriodBeg ) + " AND " + GetSQLDate( Data.PeriodEnd ) + " "
                 + " OR rsi_rsb_kernel.GetNote(" + OBJTYPE_PAYMENT + " "
                                          + " ,LPAD(pmpaym.t_PaymentID, 10, '0') "
                                          + " ,46 "
                                          + " ," + GetSQLDate( Data.PeriodEnd ) + ") IS NULL "
                 + " OR rsb_struct.getDate(rsi_rsb_kernel.GetNote(" + OBJTYPE_PAYMENT + " "
                                                             + " ,LPAD(pmpaym.t_PaymentID, 10, '0') "
                                                             + " ,46 "
                                                             + " ," + GetSQLDate( Data.PeriodEnd ) + ")) BETWEEN " + GetSQLDate( Data.PeriodBeg ) + " AND " + GetSQLDate( Data.PeriodEnd ) + ") "
               + " AND rsb_secur.GetMainObjAttr(" + OBJTYPE_PAYMENT + " "
                                           + " ,LPAD(pmpaym.t_PaymentID, 10, '0') "
                                           + " ,14 "
                                           + " ," + GetSQLDate( Data.PeriodEnd ) + ") = 0 "
               + " AND dl_tick.t_ClientID <> " + UnknownParty + " "
    end;

    Query = Query +
                 " AND dl_tick.t_BofficeKind = " + DL_VEKSELACCOUNTED + " "
               + " AND rsb_fiinstr.FI_AvrKindsGetRoot(" + FIKIND_AVOIRISS + ", dl_tick.t_AvoirKind) = " + AVOIRISSKIND_BILL + " "
               + " AND dl_tick.t_BofficeKind = vsordlnk.t_DocKind "
               + " AND dl_tick.t_DealID = vsordlnk.t_ContractID "
               + " AND vsordlnk.t_BCID = vsbanner.t_BCID "
               + " AND vsbanner.t_Issuer = party.t_PartyID "
               + " AND party.t_NotResident = 'X' "
               + "       and NOT EXISTS " 
               + "             (SELECT 1 " 
               + "                FROM dobjatcor_dbt attr " 
               + "               WHERE attr.t_ObjectType = 3 "
               + "                 AND attr.t_Object = LPAD(PARTY.T_PARTYID, 10, '0' ) " 
               + "                 AND attr.t_GroupID = 16 " 
               + "                 AND attr.t_attrid IN ( " 
                                    + PARTY_ATTR_FZ4015 + ", "      // Филиал иностранной страховой организации по ФЗ 4015-I
                                    + PARTY_ATTR_FZ290              // Международная компания по 290-ФЗ
               + "                )) "
               + " AND dl_tick.t_DealType = oprkoper.t_Kind_Operation "
               + " AND (INSTR(oprkoper.t_SysTypes, 'B') <> 0 "
                 + " OR INSTR(oprkoper.t_SysTypes, 'S') <> 0 "
                 + " OR INSTR(oprkoper.t_SysTypes, 'X') <> 0 "
                 + " OR INSTR(oprkoper.t_SysTypes, 'XW') <> 0 "
                + " AND vsordlnk.t_LinkKind = " + VSORDLNK_K_SALE + " "
                 + " OR INSTR(oprkoper.t_SysTypes, 'XF') <> 0 "
                + " AND vsordlnk.t_LinkKind = " + VSORDLNK_K_BUY + ")"
              + IIF(PrintVA and PrintVS," AND (vsbanner.T_BACKOFFICE = 'N' or vsbanner.T_BACKOFFICE = 'Y' ) ",
                IIF(PrintVS, " AND vsbanner.T_BACKOFFICE = 'Y' ", " AND vsbanner.T_BACKOFFICE = 'N' " ))
              + " ) q "
          + " GROUP BY "
              + " q.t_RegLineID "
             + " ,q.t_PayAmount "
             + " ,q.t_DocumentID "
             + " ,q.t_FIID "
             + " ,q.t_OwnerID "
             + " ,q.t_IssuerID ";

    Set = RsdRecordset( Query );

    while( Set.MoveNext() )
      PutInTempFile2( TempFile2, ZeroDate,
                                 Set.Value( "t_FIID" ),
                                 0,
                                 0,
                                 Set.Value( "t_DocumentID" ),
                                 0,
                                 Set.Value( "t_RegLineID" ),
                                 Set.Value( "t_Amount" ),
                                 Set.Value( "t_PayAmount" ),
                                 Set.Value( "t_OwnerID" ),
                                 0,
                                 0,
                                 Set.Value( "t_IssuerID" ),
                                 0,
                                 0 );
      WasCollectedData = true;
    end;

    return WasCollectedData;
  END;

  PRIVATE MACRO GetDataTempTemp2()
    var Query = " SELECT "
                  + " CAST(t_PaymentID AS NUMBER(10)) AS t_PaymentID "
                 + " ,CAST(t_FactPaymDate AS DATE) AS t_FactPaymDate "
                 + " ,CAST(t_IsClientDeal AS NUMBER(5)) AS t_IsClientDeal "
                 + " ,CAST(t_A6_PaymFIID AS NUMBER(10)) AS t_A6_PaymFIID "
                 + " ,CAST(t_ContrID AS NUMBER(10)) AS t_ContrID "
                 + " ,CAST(t_ContrNotRes AS NUMBER(5)) AS t_ContrNotRes "
                 + " ,CAST(t_ContrIsBank AS NUMBER(5)) AS t_ContrIsBank "
                 + " ,CAST(t_IsExistAvance AS NUMBER(5)) AS t_IsExistAvance "
                 + " ,CAST(t_InUnionPayment AS NUMBER(5)) AS t_InUnionPayment "
                 + " ,CAST(t_DiffFIIDFlag AS NUMBER(5)) AS t_DiffFIIDFlag "
                 + " ,CAST(t_FIID AS NUMBER(10)) AS t_FIID "
                 + " ,CAST(t_DealID AS NUMBER(10)) AS t_DealID "
                 + " ,CAST(t_DlLegID AS NUMBER(10)) AS t_DlLegID "
                 + " ,CAST(t_OwnerID AS NUMBER(10)) AS t_OwnerID "
                 + " ,CAST(t_OwnerNotRes AS NUMBER(5)) AS t_OwnerNotRes "
                 + " ,CAST(t_OwnerIsBank AS NUMBER(5)) AS t_OwnerIsBank "
                 + " ,CAST(t_OperDate AS DATE) AS t_OperDate "
                 + " ,CAST(t_DocumentID AS NUMBER(10)) AS t_DocumentID "
                 + " ,CAST(t_HolderAccID AS NUMBER(10)) AS t_HolderAccID "
                 + " ,CAST(t_RegLineID AS NUMBER(10)) AS t_RegLineID "
                 + " ,CAST(t_Amount AS NUMBER(32, 12)) AS t_Amount "
                 + " ,CAST(t_PayAmount AS NUMBER(32, 12)) AS t_PayAmount "
                 + " ,CAST(t_IssuerID AS NUMBER(10)) AS t_IssuerID "
                 + " ,CAST(t_IssuerNotRes AS NUMBER(5)) AS t_IssuerNotRes "
                 + " ,CAST(t_IssuerIsBank AS NUMBER(5)) AS t_IssuerIsBank "
                 + " ,CAST(t_IsExistsAvance AS NUMBER(5)) AS t_IsExistsAvance "
                 + " ,CAST(t_IdentProgram AS NUMBER(10)) AS t_IdentProgram "
                 + " ,CAST(t_OperationDate AS DATE) AS t_OperationDate "
              + " FROM "
                  + " (SELECT "
                       + " t_PaymentID "
                      + " ,t_FactPaymDate "
                      + " ,t_IsClientDeal "
                      + " ,t_A6_PaymFIID "
                      + " ,t_ContrID "
                      + " ,t_ContrNotRes "
                      + " ,t_ContrIsBank "
                      + " ,t_IsExistAvance "
                      + " ,t_InUnionPayment "
                      + " ,t_DiffFIIDFlag "
                      + " ,t_FIID "
                      + " ,t_DealID "
                      + " ,t_DlLegID "
                      + " ,t_OwnerID "
                      + " ,t_OwnerNotRes "
                      + " ,t_OwnerIsBank "
                      + " ,TO_DATE('01 01 0001', 'DD MM YYYY') AS t_OperDate "
                      + " ,0 AS t_DocumentID "
                      + " ,0 AS t_HolderAccID "
                      + " ,0 AS t_RegLineID "
                      + " ,0 AS t_Amount "
                      + " ,0 AS t_PayAmount "
                      + " ,-1 AS t_IssuerID "
                      + " ,0 AS t_IssuerNotRes "
                      + " ,0 AS t_IssuerIsBank "
                      + " ,0 AS t_IsExistsAvance "
                      + " ,t_FactPaymDate AS t_OperationDate "
                      + " ,t_IdentProgram "
                   + " FROM "
                       + " dreprespm_tmp "
                   + " UNION "
                   + " SELECT "
                       + " 0 AS t_PaymentID "
                      + " ,TO_DATE('01 01 0001', 'DD MM YYYY') AS t_FactPaymDate "
                      + " ,0 AS t_IsClientDeal "
                      + " ,-1 AS t_A6_PaymFIID "
                      + " ,-1 AS t_ContrID "
                      + " ,0 AS t_ContrNotRes "
                      + " ,0 AS t_ContrIsBank "
                      + " ,0 AS t_IsExistAvance "
                      + " ,0 AS t_InUnionPayment "
                      + " ,0 AS t_DiffFIIDFlag "
                      + " ,t_FIID "
                      + " ,t_DealID "
                      + " ,t_DlLegID "
                      + " ,t_OwnerID "
                      + " ,t_OwnerNotRes "
                      + " ,t_OwnerIsBank "
                      + " ,t_OperDate "
                      + " ,t_DocumentID "
                      + " ,t_HolderAccID "
                      + " ,t_RegLineID "
                      + " ,t_Amount "
                      + " ,t_PayAmount "
                      + " ,t_IssuerID "
                      + " ,t_IssuerNotRes "
                      + " ,t_IssuerIsBank "
                      + " ,t_IsExistsAvance "
                      + " ,t_OperDate AS t_OperationDate "
                      + " ,t_IdentProgram "
                   + " FROM "
                       + " drepresp2_tmp) "
              + " ORDER BY "
                  + " t_OperationDate ASC "
                 + " ,t_FIID ASC ";

    return Query;
  END;

  /* Печать пустого отчета */
  PRIVATE MACRO PrintReportRunFalse( PartNumber, SubPartNumber, Data )
    var RepLine = TRepLineData();

    RepLine.Init();

    if( PartNumber == 1 )
        PrintSubPartitionHeader1( Data, SubPartNumber, false );
        PrintRepLine1( Data, SubPartNumber, 0, RepLine );
    else
        PrintSubPartitionHeader2( Data, SubPartNumber, false );
        PrintRepLine2( Data, SubPartNumber, 0, RepLine );
    end;
  END;

  PRIVATE MACRO GetIssuerOnDate(FIID, Date)
    record fininstr(fininstr);
    ПолучитьФинИн(FIID, fininstr);
    if((fininstr.AvoirKind == AVOIRISSKIND_DEPOSITORY_RECEIPT) or (fininstr.AvoirKind == AVOIRISSKIND_AMERICAN_DEPREC) or (fininstr.AvoirKind == AVOIRISSKIND_GLOBAL_DEPREC) or (fininstr.AvoirKind == AVOIRISSKIND_RUSSIAN_DEPREC) or 	         (fininstr.AvoirKind == AVOIRISSKIND_EUROPEAN_DEPREC))
        return FI_GetIssuerOnDate( fininstr.ParentFI, Date );
    else
        return FI_GetIssuerOnDate( FIID, Date );
    end;
  END;

  PRIVATE MACRO GetIndexOfAgregElem(RepLineArr:TArray, RepLine:TRepLineData):INTEGER
     var i = 0;
     while(i < RepLineArr.Size())
        if((RepLineArr(i).OperDate == RepLine.OperDate) and (RepLineArr(i).VO_Code == RepLine.VO_Code) and (RepLineArr(i).AvrType405 == RepLine.AvrType405) and
           (RepLineArr(i).OperCode == RepLine.OperCode) and (RepLineArr(i).PaymDirectCode == RepLine.PaymDirectCode) and
           (RepLineArr(i).PayFIIDCode == RepLine.PayFIIDCode) and (RepLineArr(i).BIK_type == RepLine.BIK_type) and (RepLineArr(i).ResPartyID == RepLine.ResPartyID) and
           (RepLineArr(i).NotResPartyID == RepLine.NotResPartyID) and (RepLineArr(i).IssuerPartyID == RepLine.IssuerPartyID) and (RepLineArr(i).AvRegNum == RepLine.AvRegNum) and
           (RepLineArr(i).AvIssued == RepLine.AvIssued) and (RepLineArr(i).PlanDrawDate == RepLine.PlanDrawDate) and (RepLineArr(i).AvFaceFICode == RepLine.AvFaceFICode))
              return i;
        end;

        i = i + 1;
     end;

     return -1;
  END;

  PRIVATE MACRO CopyRepLine(RepLine)
     var RepLine1 = TRepLineData();
     RepLine1.OperDate = RepLine.OperDate;
     RepLine1.AvrType405 = RepLine.AvrType405;
     RepLine1.OperCode = RepLine.OperCode;
     RepLine1.PaymDirectCode = RepLine.PaymDirectCode;
     RepLine1.A7_Amount = RepLine.A7_Amount;
     RepLine1.PayFIIDCode = RepLine.PayFIIDCode;
     RepLine1.A10_SumPay = RepLine.A10_SumPay;
     RepLine1.A11_SumPay = RepLine.A11_SumPay;
     RepLine1.BIK = RepLine.BIK;
     RepLine1.BIK_Type = RepLine.BIK_Type;
     RepLine1.ResName = RepLine.ResName;
     RepLine1.ResCode = RepLine.ResCode;
     RepLine1.ResPartyID = RepLine.ResPartyID;
     RepLine1.NotResName = RepLine.NotResName;
     RepLine1.NotResCode = RepLine.NotResCode;
     RepLine1.NotResPartyID = RepLine.NotResPartyID;
     RepLine1.IssuerName = RepLine.IssuerName;
     RepLine1.IssuerCode = RepLine.IssuerCode;
     RepLine1.IssuerPartyID = RepLine.IssuerPartyID;
     RepLine1.AvRegNum = RepLine.AvRegNum;
     RepLine1.AvIssued = RepLine.AvIssued;
     RepLine1.PlanDrawDate = RepLine.PlanDrawDate;
     RepLine1.AvFaceFICode = RepLine.AvFaceFICode;
     RepLine1.K9 = RepLine.K9;
     RepLine1.K10 = RepLine.K10;
     RepLine1.K11 = RepLine.K11;
     RepLine1.K_A19EE = RepLine.K_A19EE;
     RepLine1.K_A19EC = RepLine.K_A19EC;
     RepLine1.K_A19ED = RepLine.K_A19ED;
     RepLine1.Note = RepLine.Note;
     RepLine1.Department = RepLine.Department;
     RepLine1.VO_Code = RepLine.VO_Code;
     RepLine1.K_DOP1 = RepLine.K_DOP1;
     RepLine1.K_PSO = RepLine.K_PSO;
     RepLine1.K_RAS = RepLine.K_RAS;

     return RepLine1;
  END;

  PRIVATE MACRO AddInAgregArr(RepLineArray, RepLine, IsAgregEveryDay)
    var RepLineIndex = GetIndexOfAgregElem(RepLineArray, RepLine);
    if((RepLineIndex >= 0) and IsAgregEveryDay)
       RepLineArray(RepLineIndex).A7_Amount = RepLineArray(RepLineIndex).A7_Amount + RepLine.A7_Amount;
       RepLineArray(RepLineIndex).A10_SumPay = RepLineArray(RepLineIndex).A10_SumPay + RepLine.A10_SumPay;
       RepLineArray(RepLineIndex).A11_SumPay = RepLineArray(RepLineIndex).A11_SumPay + RepLine.A11_SumPay;
       if(Index(RepLineArray(RepLineIndex).Note, "агрегация") == 0)
          if(RepLineArray(RepLineIndex).Note != "")
             RepLineArray(RepLineIndex).Note = RepLineArray(RepLineIndex).Note + "; ";
          end;
          RepLineArray(RepLineIndex).Note = RepLineArray(RepLineIndex).Note + "агрегация";
       end;
    else
       RepLineArray(RepLineArray.Size) = CopyRepLine(RepLine);
    end;
  END;

  PRIVATE MACRO PrintDataForPart11( Data, DS )

     /* Расчет поля А6, A8, A9.
           rq             - ТО
           deal           - сделка
           dl_leg         - условия сделки
           TempFile       - текущая запись во временном файле
           FaceValueFI    - валюта номинала бумаги
           RepLine        - данные строки отчета
        Перевод в другую валюту делаем по курсу на дату операции. */

     var IsAgreg = false, IsInst = false, IsAgregEveryDay = Data.IsAgreg;
     var RepLineArray = TArray();

     file fin(fininstr);

     macro CalcA71011( rq, deal, dl_leg, TempFile, FaceValueFI, RepLine )

        /* Получаем сумму платежа в заданной валюте. */
        macro GetPaymSum( rq, ToFIID, ConvDate )
           var
              Res = $0;

           SmartConvertSum( Res, rq.Amount, ConvDate, rq.FIID, ToFIID, true );
           return Res;
        end;

        /* Вычисляем отношение S1 * K / Sc. Возвращаем money. */
        macro CalcPart( S1:money, K:money, Sc:money )
           if( Sc != $0 )
              return money( S1 * K / Sc );
           else
              return $0;
           end;
        end;

        var
           paymContr      = TRecHandler( "dlrq.dbt" ),
           pmpc           = TRecHandler( "dlrq.dbt" ), /* платеж %%*/
           IsBasePaym     = IsBaseActPayment(rq),
           IsContrPaym    = IsContrActPayment(rq),
           InUnionPaym    = TempFile.InUnionPayment,
           IsExistAvance  = TempFile.IsExistAvance,
           PayFIID, AmountMon, FullSumFlag, ConvDate;

        /* Получаем ТО по оплате*/
        ПолучитьТОпоДокументу(deal.rec.BofficeKind, deal.rec.DealID, IIF(dl_leg.LegKind == LEG_KIND_DL_TICK, 1, 2), DLRQ_TYPE_PAYMENT, 0, paymContr);

        /* Определяем валюту расчетов. */
        PayFIID = dl_leg.PayFIID;

        /* Определяем дату курса для конвертации валюты. */
        if(   (IsContrPaym and IsExistAvance and (not InUnionPaym))
              or (IsAvancePayment(rq) and (not InUnionPaym)) )
           /* Если дата оплаты аванса/задатка и платежа по контрактиву
              приходятся на разные отчетные периоды - в этом случае берется курс
              на фактическую дату этого платежа. */
           ConvDate = TempFile.FactPaymDate;
        elif( IsBasePaym and (not DL_GetRQStateOnDate(paymContr.rec.Id, Data.PeriodEnd) ==  DLRQ_STATE_EXEC) )
           /* Если ТО по поставке (собственная сделка) и оплата
              на конец отчетного периода не исполнена - в этом случае берется
              курс на фактическую дату поставки. */
           ConvDate = TempFile.FactPaymDate;
        else
           /* Иначе. Конвертация производится по курсу на дату оплаты сделки. */
           ConvDate = paymContr.rec.FactDate;
        end;

        FullSumFlag =  IsBasePaym
                       or (rq.Type == DLRQ_TYPE_COMPPAYM)
                       or (IsContrPaym and (not IsExistAvance))
                       or (IsContrPaym and InUnionPaym);

        /* A7 - кол-во ц/б, шт.
        Количество ценных бумаг, соответствующее ТО:
        -       для ТО по поставке выводится количество ц/б сделки,
        -       для ТО по оплате/аванса/задатка:
        -       если по сделке данного ТО не было ни аванса, ни задатка, то <A6> = количеству  ц/б всей сделки,
        -       если и аванс/задаток, и ТО по оплате были оплачены в отчетный период, то  <A6> = количеству ц/б всей сделки,
        -       если ТО аванса/задатка было исполнено в прошлом отчетном периоде, а ТО по оплате этой же сделки - в данном отчетном периоде,
        то для ТО по оплате <A6> рассчитывается пропорционально его доле в общей сумме сделки (см. Примечание к табл., п.2.),
        - если ТО аванса/задатка было исполнено в данном отчетном периоде, а ТО по оплате по состоянию на начало отчетной даты еще не исполнено,
        то для ТО по авансу/задатку <A6> рассчитывается пропорционально его доле в общей сумме сделки
        Количество дробных акций (паев, долей) указывается с точностью до четвертого знака после запятой (точки).
        Если <A4> имеет значение из списка "DOL1, DOL2, DOL3, DOL4, DOL5, DOL7, ОТН3, ОТН4", то графа не заполняется*/

        fin.fiid = TempFile.FIID;
        if( FullSumFlag )
           if(rq.Type == DLRQ_TYPE_COMPPAYM)
              RepLine.A7_Amount = GetAmountOnFactDate(deal.rec.DealID,rq.FactDate,rq.ID_Step);
           else
              RepLine.A7_Amount = RepLine.A7_Amount + dl_leg.Principal;
           end;

           if(GetEQ(fin))
              if(fin.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE)
                 RepLine.A7_Amount = ЧислоCЗаданнойТочностью( RepLine.A7_Amount, 4, "" );
              else
                 RepLine.A7_Amount = MoneyToInt( RepLine.A7_Amount );
              end;
           else
              RepLine.A7_Amount = MoneyToInt( RepLine.A7_Amount );
           end;
        else
           AmountMon = CalcPart( GetPaymSum(rq, dl_leg.CFI, ConvDate), dl_leg.Principal, dl_leg.TotalCost);

           if( IsContrPaym )
              if(GetEQ(fin))
                 if(fin.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE)
                   RepLine.A7_Amount = ЧислоCЗаданнойТочностью( AmountMon, 4, "" );
                 else
                   RepLine.A7_Amount = MoneyToIntUp( AmountMon );
                 end;
              else
                 RepLine.A7_Amount = MoneyToIntUp( AmountMon );
              end;
           else
              if(GetEQ(fin))
                 if(fin.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE)
                   RepLine.A7_Amount = ЧислоCЗаданнойТочностью( AmountMon, 4, "" );
                 else
                   RepLine.A7_Amount = MoneyToInt( AmountMon );
                 end;
              else
                 RepLine.A7_Amount = MoneyToInt( AmountMon );
              end;
           end;
        end;

        /* A11 - сумма платежа по операции, валютный единиц / в том числе
                выплаченные проценты (доходы)

          Сумма полученных (выплаченных) процентов по операциям на возвратной основе (РЕПО):
           - для платежа по контрактиву по второй части обратного РЕПО - сумма полученных процен-тов,
           - для платежей по контрактиву второй части прямого РЕПО - сумма выплаченных процентов.
          Поле заполняется для платежей с кодом вида операции <A5> = "13" - выводится сумма пла-тежа "Проценты" по сделке данного платежа.
          Поле не заполняется:
            1. для платежей по базовому активу и аванса\задатка;
            Выводится значение "0":
              -  если код вида операции <A5> = "11";
              -  если в сделках РЕПО задана отрицательная ставка */
        RepLine.A11_SumPay = "";
        if( rq.Type != DLRQ_TYPE_COMPPAYM)
           if( IsContrPaym AND (RepLine.OperCode == "13") AND (dl_leg.IncomeRate > 0) )
              if(ПолучитьТОпоДокументу(deal.rec.BofficeKind, deal.rec.DealID, IIF(dl_leg.LegKind == LEG_KIND_DL_TICK, 1, 2), DLRQ_TYPE_INCREPO, 0, pmpc))
                 RepLine.A11_SumPay  = pmpc.rec.Amount;
              end;
           elif( (RepLine.OperCode == "11") OR ((RepLine.OperCode == "13") AND (dl_leg.IncomeRate < 0)) )
              RepLine.A11_SumPay = 0;
           end;
        end;

        /* A10 - сумма платежа по операции, валютный единиц/ всего
           Выводим сумму сделки с НКД в валюте расчетов, если:
              - платеж по базовому активу
              - платеж по контрактиву и по сделке нет аванса/задатка
              - если объединенный платеж
           Иначе, сумма этого платежа в валюте расчетов. */
        if( rq.Type == DLRQ_TYPE_COMPPAYM)
           RepLine.A10_SumPay = rq.Amount;/*сумма из ТО*/
        elif( FullSumFlag OR (RepLine.OperCode == "13") )
           SmartConvertSum( RepLine.A10_SumPay, dl_leg.TotalCost, ConvDate, dl_leg.CFI, PayFIID, true );
        else
           SmartConvertSum( RepLine.A10_SumPay, rq.Amount, ConvDate, rq.FIID, PayFIID, true );
        end;
     end; // macro CalcA71011...

     private macro PrintDataForPart11CB( Data, DS, RepLine )
        record avoir(avoiriss);
        record fininstr(fininstr);

        var
            issuer = TRecHandler( "party" ),
            rq = TRecHandler( "dlrq" ),
            paymContr = TRecHandler( "dlrq.dbt" ),
            rqacc = TRecHandler( "dlrqacc" ),
            party = TRecHandler( "party" ),
            party2 = TRecHandler( "party" ),
            paymContr_1 = TRecHandler( "dlrq.dbt" ),
            paymContr_2 = TRecHandler( "dlrq.dbt" ),

            SkipPayment, PayFIID, continue_cicle, IsBackPart, IsSalePart, ContractorBankID = 0, Account, ContractorID = 0, VerDate = ZeroDate,
            IssuerID = UnknownParty;

        var FD = null, LegKind = 0;

        if (DS.PaymentID <= 0)
          SkipPayment = true;
        elif (not ПолучитьТО(DS.PaymentID, rq))
          SkipPayment = true;
          RunError( "Не найдено ТО  (ID = " + string(DS.PaymentID) + " )" );
        else
          /* Если это ТО аванса/задатка и оно включен в объединенный платеж,
             то не будем его выводить, т.к. все данные по объединенному платежу
             будут выведены при печати платежа по контрактиву. */
          SkipPayment = IsAvancePayment(rq.rec) and DS.InUnionPayment;
        end;

         if( not SkipPayment )

           if(rq.rec.DealPart == 2)
              LegKind = LEG_KIND_DL_TICK_BACK;
           else
              LegKind = LEG_KIND_DL_TICK;
           end;

           FD = SPFirstDoc(LegKind, rq.rec.DocID);
    	   RepLine.VO_Code = SP_GetVO_CodeByDlRqForRep(rq,FD);

           /* Получаем данные сделки */
           IsBackPart  = FD.dl_leg.rec.LegKind == LEG_KIND_DL_TICK_BACK;
           IsSalePart  = not IsBuyPartDeal( FD.tick.rec, IsBackPart );

           /* Получаем параметры бумаги */
           if( ПолучитьФинИн(DS.FIID, fininstr, avoir) )
              RunError(   "Ошибка при получении параметров финансового инструмента "
                          + "(FIID = " + string(DS.FIID) + ")." );
           end;

           /* A1 - Дата операции
             Для собственных операций: фактическая дата исполнения ТО по поставке ценных бумаг,
             для клиентских - фактическая дата исполнения ТО задатка, аванса или оплаты,
             а если  аванс/задаток и ТО по оплате были исполнены в одном отчетном периоде,
             т.е. их данные суммируются в одной строке, то выводится фактическая дата исполнения ТО по оплате*/

           RepLine.OperDate = Date(DS.FactPaymDate);

           /* A5 - Код операции
           Код операции, по которой выполненоТО:
           для сделки покупки или продажи (без второй части), не включённой в неттинг (в ТО не установлен признак "включено в неттинг") или операции займа <A5> = "11",
           для сделки покупки или продажи, появившейся при исполнении срочного контракта <A5> = "40" (см. Примечания),
           для покупки или продажи, являющейся первой частью сделки из двух частей <A5>, в том числе включённой в неттинг (в ТО установлен признак "включено в неттинг" и статус "исполнено") = "12",
           для покупки или продажи, являющейся второй частью сделки из двух частей <A5>, в том числе включённой в неттинг (в ТО установлен признак "включено в неттинг" и статус "исполнено") = "13",
           для ТО сделок покупки или продажи (без второй части), включённых в неттинг (установлен признак "включено в неттинг" и статус "исполнено"), за исключением ТО по сделкам РЕПО:
           - если вид ТО = "Оплата", то <A5> = "21";
           - если вид ТО = "Поставка", то <A5> = "22".*/

           if( ( ( rq.rec.Type == DLRQ_TYPE_PAYMREPOCOUP ) or ( rq.rec.Type == DLRQ_TYPE_PAYMREPOPART ) )
           and IsREPO(FD.Group) and IsSALE(FD.Group) )
              /*Для ТО по выплатам по сделке ПРЕПО между первой и второй частями  <A5> = "99"*/
              RepLine.OperCode = "99";
           elif( rq.rec.Type == DLRQ_TYPE_COMPPAYM )
              /*Для ТО по компенсационным платежам по сделкам из двух частей <A5> = <14>, при этом, если по сделке РЕПО сумма по компенсационному платежу уменьшает сумму основного долга, то <A4> = <13>*/
              /*Аналитик: Судя по тексту последних изменений в бух. учете РЕПО (215-Т) могут быть и комп. платежи, увеличивающие сумму основного долга по обычным сделкам.
                          То что у нас в системе этого нет - это уже совсем другая история .
                          Но условие пусть будет такое, чтобы потом не пришлось переделывать, если мы вдруг сделаем комп. платежи в другую сторону.*/
              if( (IsSALE(FD.Group) and (rq.rec.Kind == DLRQ_KIND_REQUEST)) OR
                  (IsBUY(FD.Group) and (rq.rec.Kind == DLRQ_KIND_COMMIT))
                )
                 RepLine.OperCode = "14";
              else
                 RepLine.OperCode = "13";/*сейчас для обычных РЕПО реализовано только уменьшение основного долга при компенсационных платежах, поэтому пока будет только "13"*/
              end;
           elif( РезультатИсполненияПИ(FD.tick) )
              RepLine.OperCode = "40";
           elif( IsREPO(FD.Group) )
              RepLine.OperCode = IIF( IsBackPart, "13", "12" );
           elif( (rq.rec.Netting == SET_CHAR) AND ((rq.rec.State ==  DLRQ_STATE_GO_CLOSE) or (rq.rec.State ==  DLRQ_STATE_REJECT)) )
              RepLine.OperCode = IIF(IsBaseActPayment(rq.rec),"22","21");
           else
              RepLine.OperCode = "11";
           end;

           /* A6 - Код направления платежа
           Подраздел 1 раздела 1:
           -    для ТО сделок нашего банка или клиентов-резидентов с нерезидентами (в том числе,
              если нерезидент является клиентом нашего банка) или с резидентами (если для сделки задан субъект-нерезидент с ролью "клиент контрагента"):
           i.   если сделка покупки или вх. Платеж по операции с кодом "22" в графе 4 (неттинг - получе-ние), то код = OUTR,
           ii.  если сделка продажи или исх. Платеж по операции с кодом "22" в графе 4 (неттинг - пере-дача), то код = INR,
           -    для ТО сделок клиентов-нерезидентов с резидентами (не являющимися клиентами нашего банка и если для сделки не задан субъект-нерезидент с ролью "клиент контрагента"):
                i. если сделка покупки, то код = OUTN,
                ii.   если сделка продажи, то код = INN */

           if(   (not DS.IsClientDeal)
                 or (DS.IsClientDeal and (not DS.OwnerNotRes)) )
              /* Собственная сделка или клиентская и клиент является резидентом. */
              RepLine.PaymDirectCode = IIF( IsSalePart, "INR", "OUTR" );
           elif( DS.IsClientDeal and DS.OwnerNotRes AND
                 (КлиентКонтрагента(FD.tick.rec.DealID,DS.ContrID) != НЕРЕЗИДЕНТ))
              /* Клиент-нерезидент. */
              RepLine.PaymDirectCode = IIF( IsSalePart, "INN", "OUTN" );
           else
              RepLine.PaymDirectCode = "";
           end;

           /* A9 - код валюты платежа
              Цифровой код валюты расчетов сделки (для ТО по оплате и поставке) или код валюты оплаты аванса (для ТО аванса)
              Для <A5> = "22" выводится код валюты номинала ц/б.

              Если платеж объединенный и валюты платежей различаются, то
              не выводим код. */
           if( DS.InUnionPayment and DS.DiffFIIDFlag )
              RepLine.PayFIIDCode = "";
           else
              RepLine.PayFIIDCode = GetFICode( DS.A6_PaymFIID );
           end;

           // A7, A10 и A11 */
           CalcA71011( rq.rec, FD.tick, FD.dl_leg.rec, DS, fininstr.FaceValueFI, RepLine );

           /* Выводятся данные о банке контрагента по сделке (его БИК, СВИФТ-код или код страны месторасположения банка).
              Примечания:
              - Для собственных операций банка с нерезидентами графа заполняется только в том случае, если платежи и
                по базовому активу и по контрактиву относятся к данному отчетному периоду
              - Графа не заполняется:
                1) Для строк со значениями кодов направления платежа А6 равными "INN" и "OUTN"
                2) Если <A5> = "22"*/

           if( (RepLine.PaymDirectCode != "INN") AND (RepLine.PaymDirectCode != "OUTN") AND
               ((not IsClientDeal(FD.tick.rec)) or (not DS.OwnerNotRes)) AND
               (RepLine.OperCode != "22" )
             )
              RepLine.BIK = ПолучитьБИКБанкаКонтрагента(rq, DS.OwnerID, DS.A6_PaymFIID, FD.tick, @RepLine.BIK_type);
           else
              RepLine.BIK = "";
              RepLine.BIK_type = -1;
           end;

           // A12 - не заполняется

           // A13 - A16
           GetResidentInfo( Data, DS.ContrID, DS.ContrIsBank,
                            DS.OwnerID, DS.OwnerIsBank,
                            DS.OwnerNotRes, fininstr, RepLine, true, IsEXCHANGE(FD.Group), FD.tick.rec.DealID );

           issuer = GetPartyByID(GetIssuerOnDate(fininstr.FIID, Data.PeriodEnd), true, true);

           // A4, A17 - A22
           GetAvoirInfo( Data, fininstr, avoir, issuer, RepLine );

           // A23 - Примечание
           RepLine.Note = "";

           if( ВходящееТОКлиента(rq.rec, FD.tick.rec, FD.Group) )
              VerDate = ДатаПодтверждДокументов(rq);
              if( VerDate != ZeroDate )
                 RepLine.Note = DateToStr(VerDate, true);
              end;
           end;

           /* Получаем ТО по оплате для сделки. */
           ПолучитьТОпоДокументу(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, IIF(FD.dl_leg.rec.LegKind == LEG_KIND_DL_TICK, 1, 2), DLRQ_TYPE_PAYMENT, 0, paymContr);

           /* Определяем валюту расчетов. */
           PayFIID = FD.dl_leg.rec.PayFIID;

           /*Если одновременно  выполняются следующие условия:
             -  Расчёты по сделке в валюте
             -  Контрагент по сделке - нерезидент
             -  Указан клиент контрагента и он нерезидент
             -  Сделка собственная или клиента-резидента*/
           if( (PayFIID != NATCUR) AND
               (DS.ContrNotRes != 0) AND
               (КлиентКонтрагента(FD.tick.rec.DealID,DS.ContrID) == НЕРЕЗИДЕНТ) AND
               ( (DS.OwnerID == {OurBank}) or (DS.OwnerNotRes != 0 ) )
             )
              if( RepLine.Note != "" )
                 RepLine.Note = RepLine.Note + "; ";
              end;
              party = GetPartyByID( DS.ContrID, true, true );
              RepLine.K_A19EC = string(party.Name);
              RepLine.K_A19ED = GetNotResCountryNumCode(party);
              RepLine.Note = RepLine.Note  + "контрагент: " + RepLine.K_A19EC + " / " + RepLine.K_A19ED;
           end;

           if( ((rq.rec.Type == DLRQ_TYPE_COMPPAYM) and (RepLine.OperCode == "13")) or
               ((DS.IsExistAvance) and (not DS.InUnionPayment)) or
               ((IsAvancePayment(rq.rec)) and (not DS.InUnionPayment))
             )
              if( RepLine.Note != "" )
                 RepLine.Note = RepLine.Note + "; ";
              end;
              RepLine.Note = RepLine.Note  + "рассрочка";
           elif((DS.IsExistAvance) and (DS.InUnionPayment))
              if( RepLine.Note != "" )
                 RepLine.Note = RepLine.Note + "; ";
              end;
              RepLine.Note = RepLine.Note  + "агрегация";
              IsAgregEveryDay = false;
           end;

           if( (RepLine.OperCode == "13") and (rq.rec.Type != DLRQ_TYPE_COMPPAYM) )
              if( RepLine.Note != "" )
                 RepLine.Note = RepLine.Note + "; ";
              end;
              /* Получаем ТО по оплате для сделки. */
              ПолучитьТОпоДокументу(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, 1, DLRQ_TYPE_PAYMENT, 0, paymContr_1);
              RepLine.K_A19EE = DateToStr(IIF((paymContr_1.rec.FactDate==ZeroDate),paymContr_1.rec.PlanDate,paymContr_1.rec.FactDate),true);
              RepLine.Note = RepLine.Note + RepLine.K_A19EE;
              /*GAA: 497465*/
              RepLine.K_DOP1 = DateToStr(IIF((paymContr_1.rec.FactDate==ZeroDate),paymContr_1.rec.PlanDate,paymContr_1.rec.FactDate),true);
           end;

           if( RepLine.OperCode == "12" )
              if( RepLine.Note != "" )
                 RepLine.Note = RepLine.Note + "; ";
              end;
              /* Получаем ТО по оплате для сделки. */
              ПолучитьТОпоДокументу(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, 2, DLRQ_TYPE_PAYMENT, 0, paymContr_2);
              RepLine.Note = RepLine.Note + DateToStr(IIF((paymContr_2.rec.FactDate==ZeroDate),paymContr_2.rec.PlanDate,paymContr_2.rec.FactDate),true);
              /*GAA: 497465*/
              RepLine.K_DOP1 = DateToStr(IIF((paymContr_2.rec.FactDate==ZeroDate),paymContr_2.rec.PlanDate,paymContr_2.rec.FactDate),true);
           end;

           if( (RepLine.BIK != "") )
              if(RepLine.PayFIIDCode == {ISONatCur})/* если платеж в валюте РФ */
             /* Для строк, в которых: содержатся суммарные данные по авансу/задатку
              и платежу по к/активу одной сделки или содержатся данные только об
              авансе/задатке, выводится текст "рассрочка" */
             /*
             -  если счет контрагента-нерезидента открыт в банке-нерезиденте (Банк 2) и задан банк-резидент (Банк 1),
                в котором открыт корсчет Банка 2 (в платёжных реквизитах контрагента в ТО указан корсчет банка 2),
                 то выводится текст: "контрагент:" <наименование Банка 2> / <цифровой код страны Банка 2>*/

                 if(DS.OwnerID == Payer(rq, FD.tick))
                    ContractorID = Receiver(rq, FD.tick);/*получим контрагента*/
                    ContractorBankID = ПолучитьБанкСубъектаПоСделке(ContractorID, rq.rec.DocKind, rq.rec.DocID, PayFIID, rq.rec.Type)
                 else
                    ContractorID = Payer(rq, FD.tick);/*получим контрагента*/
                    ContractorBankID = ПолучитьБанкСубъектаПоСделке(ContractorID, rq.rec.DocKind, rq.rec.DocID, PayFIID, rq.rec.Type)
                 end;

                 party = GetPartyByID( ContractorID, true, true );
                 /*контрагент-нерезидент*/
                 if(IsPartyNotRes(party)) // (party.NotResident == SET_CHAR)
                    party2 = GetPartyByID( ContractorBankID, true, true ); /*(Банк 2)*/
                    /*этот банк является нерезидентом*/
                    if(IsPartyNotRes(party2)) // (party2.NotResident == SET_CHAR)
                       rqacc.Clear();
                       rqacc.rec.Id = rq.rec.RqAccId;
                       if(GetEQ(rqacc) == true)
                          party = GetPartyByID( rqacc.rec.BankCorrId, true, true ); /*банк 1*/
                          /*проверяем резидентность банка 1 и выводиv текст: "контрагент:" <наименование Банка 2> / <цифровой код страны Банка 2>*/
                          if(not IsPartyNotRes(party)) // ( party.NotResident != SET_CHAR )
                             if( RepLine.Note != "" )
                               RepLine.Note = RepLine.Note + "; ";
                             end;

                             RepLine.K10 = string(party2.Name);
                             RepLine.K11 = GetNotResCountryNumCode( party2 );

                             RepLine.Note = RepLine.Note + "контрагент: " + RepLine.K10 + "/" + RepLine.K11;

                             RepLine.K9  = "контрагент";
                          end;
                       end;
                    end;
                 end;
              end;
           end;

           if((not FI_IsBOND(avoir.FIID)) and ((RepLine.IssuerName == RepLine.ResName) or (RepLine.IssuerName == RepLine.NotResName)))
              if(RepLine.Note != "")
                 RepLine.Note = RepLine.Note + "; собственные бумаги";
              else
                 RepLine.Note = "собственные бумаги";
              end;
           end;

           RepLine.Department = FD.tick.rec.department;

           if((not FI_IsBOND(avoir.FIID)) and ((RepLine.IssuerName == RepLine.ResName) or (RepLine.IssuerName == RepLine.NotResName))) /*GAA: 497465*/
//           if( Data.Kliko and ( DS.OwnerID == {OurBank} ) )
              RepLine.K_PSO = "СобственныеБумаги";
           end;

        end; // SkipPayment
        return (not SkipPayment);
     end;//macro PrintDataForPart11CB

     InitProgressForPrintData( SQL_GetNRecs( GetDataTempTemp2() ), 1, 1 );

     PrintSubPartitionHeader1( Data, 1, true );

     var RepLine  = TRepLineData();
     var LineNum  = 1;

     while( DS.MoveNext() )
        RepLine.Init();

        UseProgressBar;
        IsAgregEveryDay = Data.IsAgreg;

        if ( (DS.IdentProgram == IP_VEKSEL) and (PrintVA or PrintVS) )
          PrintDataForPart1VS(Data, DS, RepLine, 1);
          AddInAgregArr(RepLineArray, RepLine, IsAgregEveryDay);
        else
          if (PrintBack)
            if (PrintDataForPart11CB(Data, DS, RepLine))
               AddInAgregArr(RepLineArray, RepLine, IsAgregEveryDay);
            end;
          end;
        end;

       
     end;

     if( Data.Delta)
       Data.DeltaReport.Section( 1 , 1 );
     end;

     var i = 0;
     while(i < RepLineArray.Size)
        // Печать строки
        PrintRepLine1( Data, 1, LineNum, RepLineArray(i) );
        LineNum = LineNum + 1;
        i = i + 1;
     end;
     
     if(Data.Delta)
       Data.DeltaReport.FinishData();
     end;
     
     RemProgressBar;
  END;

  MACRO ЭтоВыплатаКупонаЧП( Type:integer )
     return ((Type == DLRQ_TYPE_PAYMREPOCOUP)or(Type == DLRQ_TYPE_PAYMREPOPART));
  END;

  PRIVATE MACRO PrintDataForPart12ByRetire( Data, TempFile2, fininstr, avoir, RepLine )
    var
      rq = TRecHandler( "dlrq" ),
      LegKind = 0,
      FD = null,
      rqacc = TRecHandler( "dlrqacc" ),
      party = TRecHandler( "party" ),
      party2 = TRecHandler( "party" ),
      ContractorBankID = 0,
      Account,
      ContractorID = 0,
      VerDate = ZeroDate,
      РезидентностьКлиентаКонтр,
      Владелец = 0,
      ВладелецНеРезидент = 0,
      ВладелецБанк = 0,
      Контрагент = 0,
      КонтрагентНеРезидент = 0,
      КонтрагентБанк = 0,
      ContrNotRes:bool,
      ContrIsBank:bool;

    // Получаем ТО
    if( not ПолучитьТО( TempFile2.DealID, rq ) )
      RunError( "Не найдено ТО (ID = " + string( TempFile2.DealID ) + " )" );
    end;

    if( rq.rec.DealPart == 2 )
      LegKind = LEG_KIND_DL_TICK_BACK;
    else
      LegKind = LEG_KIND_DL_TICK;
    end;

    FD = SPFirstDoc( LegKind, rq.rec.DocID );

    // A3 - Код вида валютной операции
    RepLine.VO_Code = SP_GetVO_CodeByDlRqForRep( rq, FD );

    // A5 - Код операции
    // Для операций неттинга:
    // - если вид платежа = "Контрактив", то <A5> = "21";
    // - если вид платежа = "Базовый актив", то <A5> = "22".
    // Для всех остальных операций раздела <A5> = "99".
    if( not ЭтоВыплатаКупонаЧП( rq.rec.Type )
    and ( rq.rec.Netting == SET_CHAR )
    and ( ( rq.rec.State ==  DLRQ_STATE_GO_CLOSE ) or ( rq.rec.State ==  DLRQ_STATE_REJECT ) ) )
      RepLine.OperCode = IIF( IsBaseActPayment( rq.rec ), "22", "21" );
    else
      RepLine.OperCode = "99";
    end;

    // A6 - Код направления платежа
    // -  погашения ценных бумаг, эмитентом которых является нерезидент,
    //    для нашего бан-ка или клиентов-резидентов: код = INR,
    // -  погашения для клиентов-нерезидентов: код = OUTR.
    // -    Выплаты купонов и ЧП в сделках РЕПО, где первоначальным покупателем является резидент, а первоначальным продавцом клиент-нерезидент = INN.
    if( ЭтоВыплатаКупонаЧП( rq.rec.Type ) )
      // Для обратного РЕПО первоначальный покупатель - это клиент; первоначальный продавец - это либо контрагент, либо клиент контрагента.
      // Для прямого РЕПО первоначальный покупатель - это либо контрагент, либо клиент контрагента; первоначальный продавец - это клиент.
      РезидентностьКлиентаКонтр = КлиентКонтрагента( FD.tick.rec.DealID, TempFile2.IssuerID, @ContractorID );

      if( РезидентностьКлиентаКонтр != НЕ_НАЙДЕН )
        Контрагент = ContractorID;
        КонтрагентНеРезидент = IIF( РезидентностьКлиентаКонтр == НЕРЕЗИДЕНТ, 1, 0 );
        КонтрагентБанк = BoolToInt( ВидСубъекта( Контрагент, PTK_BANK ) );
      else
        Контрагент = GetContrForDeal( FD.Group, FD.tick );
        // Определим параметры контрагента по сделке.
        GetPartyParam( Контрагент, @ContrNotRes, @ContrIsBank );
        КонтрагентНеРезидент = BoolToInt( ContrNotRes );
        КонтрагентБанк = BoolToInt( ContrIsBank );
      end;

      Владелец = TempFile2.OwnerID;
      ВладелецНеРезидент = TempFile2.OwnerNotRes;
      ВладелецБанк = TempFile2.OwnerIsBank;

      if( IsBUY( FD.Group ) and ( ВладелецНеРезидент != 1 ) and ( КонтрагентНеРезидент == 1 )
      or IsSALE( FD.Group ) and ( КонтрагентНеРезидент != 1 ) and ( ВладелецНеРезидент == 1 ) )
        RepLine.PaymDirectCode = "INN";
      end;
    else
      RepLine.PaymDirectCode = IIF( TempFile2.IssuerNotRes, "INR", "OUTR" );
    end;

    // A7 - кол-во ц/б, шт.
    // Количество ц/б в операции погашения
    if( ЭтоВыплатаКупонаЧП( rq.rec.Type ) )
      // количество бумаг, по которому выполняется погашение
      RepLine.A7_Amount = GetAmountOnFactDate( FD.tick.rec.DealID, rq.rec.FactDate, rq.rec.ID_Step );
    else
      RepLine.A7_Amount = FD.dl_leg.rec.Principal;
    end;

    // A10 - сумма платежа по операции, валютный единиц/ всего
    // Сумма полученная владельцем ц/б в операции погашения (включая
    // сумму погашения купона, если производилось погашение выпуска -
    // полное или частичное - одновременно с погашением купона) в валюте
    // номинала
    // A11 - сумма платежа по операции, валютный единиц/ в том числе
    //      выплаченные проценты (доходы)
    // Сумма погашения купона; если в данной операции производилось только
    // погашение купона, то <A11> = <A10>;если погашение купона в данной
    // операции не производилось, то выводится значение "0"
    if( ЭтоВыплатаКупонаЧП( rq.rec.Type ) )
      RepLine.A10_SumPay = rq.rec.Amount;
      if( rq.rec.Type == DLRQ_TYPE_PAYMREPOCOUP )
        RepLine.A11_SumPay = RepLine.A10_SumPay;
      else
        RepLine.A11_SumPay = $0;
      end;
    else
      RepLine.A10_SumPay = FD.dl_leg.rec.TotalCost;
      if( fininstr.AvoirKind == AVOIRISSKIND_ORDINARY_BOND )
        // Погашение безкупонной облигации. НКД быть не должно, но в dl_leg оно есть.
        RepLine.A11_SumPay = $0;
      else
        RepLine.A11_SumPay = FD.dl_leg.rec.NKD;
      end;
    end;

    // Выводятся данные о банке контрагента по сделке (его БИК, СВИФТ-код или код страны месторасположения банка).
    // Примечания:
    //   - Для собственных операций банка с нерезидентами графа заполняется только в том случае, если платежи и
    //     по базовому активу и по контрактиву относятся к данному отчетному периоду
    //   - Графа не заполняется:
    //       1) Для строк со значениями кодов направления платежа А6 равными "INN" и "OUTN"
    //       2) Если <A5> = "22"
    if( not ЭтоВыплатаКупонаЧП( rq.rec.Type )
    and ( RepLine.PaymDirectCode != "INN" )
    and ( RepLine.PaymDirectCode != "OUTN" )
    and ( not IsClientDeal( FD.tick.rec ) or not TempFile2.OwnerNotRes )
    and ( RepLine.OperCode != "22" ) )
      RepLine.BIK = ПолучитьБИКБанкаКонтрагента(rq, TempFile2.OwnerID, fininstr.FaceValueFI, FD.tick, @RepLine.BIK_type );
    else
      RepLine.BIK = "";
      RepLine.BIK_type = -1;
    end;

    // A12 - A15
    if(Контрагент <= 0)
      Контрагент = GetContrForDeal(FD.Group, FD.tick);
    end;

    if( ЭтоВыплатаКупонаЧП( rq.rec.Type ) )
      // здесь важно передать первоначального покупателя - либо Владелец,
      // либо Контрагент в зависимости от РЕПО прямого или обратного
      GetResidentInfo(Data,
                      IIF(IsBUY(FD.Group), Контрагент, Владелец),
                      IIF(IsBUY(FD.Group), КонтрагентБанк, ВладелецБанк),
                      IIF(IsBUY(FD.Group), Владелец, Контрагент),
                      IIF(IsBUY(FD.Group), ВладелецБанк, КонтрагентБанк),
                      IIF(IsBUY(FD.Group), ВладелецНеРезидент, КонтрагентНеРезидент),
                      fininstr, RepLine, false, false, null,
                      ЭтоВыплатаКупонаЧП(rq.rec.Type));
    end;

    // A22 - Примечание
    RepLine.Note = "";

    if( IsClientDeal(FD.tick.rec) )
      VerDate = ДатаПодтверждДокументов(rq);

      if( VerDate != ZeroDate )
        RepLine.Note = DateToStr(VerDate, true);
      end;
    end;

    if( (RepLine.BIK != "") and (RepLine.PayFIIDCode == {ISONatCur}) ) // если платеж в валюте РФ
      // если счет контрагента-нерезидента открыт в банке-нерезиденте (Банк 2)
      // и задан банк-резидент (Банк 1), в котором открыт корсчет Банка 2
      // (в платеже в СПИ контр-агента указан корсчет банка 2),
      // то выводится текст: "контрагент:" <наименование Банка 2> / <цифровой код страны Банка 2>

      if( TempFile2.OwnerID == Payer( rq, FD.tick ) )
        ContractorID = Receiver( rq, FD.tick ); // получим контрагент
        ContractorBankID = ПолучитьБанкСубъектаПоСделке(ContractorID, rq.rec.DocKind, rq.rec.DocID, TempFile2.FIID, rq.rec.Type)
      else
        ContractorID = Payer( rq, FD.tick ); // получим контрагент
        ContractorBankID = ПолучитьБанкСубъектаПоСделке(ContractorID, rq.rec.DocKind, rq.rec.DocID, TempFile2.FIID, rq.rec.Type)
      end;

      party = GetPartyByID( ContractorID, true, true );
      // контрагент-нерезидент
      if(IsPartyNotRes(party)) //( party.NotResident == SET_CHAR )
        party2 = GetPartyByID( ContractorBankID, true, true ); // (Банк 2)

        // этот банк является нерезидентом
        if(IsPartyNotRes(party2)) // ( party2.NotResident == SET_CHAR )
          rqacc.Clear();
          rqacc.rec.Id = rq.rec.RqAccId;

          if( GetEQ( rqacc ) )
            party = GetPartyByID( rqacc.rec.BankCorrId, true, true ); /*банк 1*/

            // проверяем резидентность банка 1 и выводиv текст: "контрагент:" <наименование Банка 2> / <цифровой код страны Банка 2>*/
            if(not IsPartyNotRes(party))  // ( party.NotResident != SET_CHAR )
              if( RepLine.Note != "" )
                RepLine.Note = RepLine.Note + "; ";
              end;

              RepLine.K10 = string( party2.Name );
              RepLine.K11 = GetNotResCountryNumCode( party2 );

              RepLine.Note = RepLine.Note + "контрагент: " + RepLine.K10 + "/" + RepLine.K11;

              RepLine.K9  = "контрагент";
            end;
          end;
        end;
      end;
    end;

    RepLine.Department = FD.tick.rec.department;
  END;

  PRIVATE MACRO PrintDataForPart12ByPayments( Data, TempFile2, RepLine )
    var
      dpcorpop = TBFile( "dpcorpop.dbt" ),
      dppmacc = TBFile( "dppmacc.dbt", "R", 1 ),
      dppmrac = TBFile( "dppmrac.dbt" ),
      settacc = TBFile( "settacc.dbt", "R", 3 );

    dpcorpop.rec.DocumentID = TempFile2.DocumentID;
    dpcorpop.GetEQ();

    dppmacc.rec.DocumentID = TempFile2.DocumentID;
    dppmacc.rec.HolderAccID = TempFile2.HolderAccID;
    dppmacc.GetEQ();

    // A3 - Код вида валютной операции
    RepLine.VO_Code = DP_GetVO_CodeForReport( dpcorpop, dppmacc );

    // A5 - Код операции
    RepLine.OperCode = "99";

    // A7 - кол-во ц/б, шт.
    RepLine.A7_Amount = TempFile2.Amount;

    // A10 - сумма платежа по операции, валютный единиц/ всего
    RepLine.A10_SumPay = TempFile2.PayAmount;

    // A11 - сумма платежа по операции, валютный единиц/ в том числе
    RepLine.A11_SumPay = $0;

    RepLine.BIK = "";
    RepLine.BIK_type = -1;

    if( TempFile2.RegLineID == 0 )
      if( TempFile2.OwnerNotRes )
        dppmrac.rec.DocumentID = TempFile2.DocumentID;
        dppmrac.rec.HolderAccID = TempFile2.HolderAccID;

        if( dppmrac.GetEQ() )
          RepLine.BIK = dppmrac.rec.BankCode;
          RepLine.BIK_type = dppmrac.rec.BankCodeKind;
        end;
      elif( TempFile2.IssuerNotRes )
        dppmrac.rec.DocumentID = TempFile2.DocumentID;
        dppmrac.rec.HolderAccID = 0;

        if( dppmrac.GetEQ() )
          RepLine.BIK = dppmrac.rec.BankCode;
          RepLine.BIK_type = dppmrac.rec.BankCodeKind;
        else
          settacc.rec.PartyID = TempFile2.IssuerID;
          settacc.rec.FIKind = FIKIND_AVOIRISS;

          if( ( settacc.GetGE() )
          and ( settacc.rec.PartyID = TempFile2.IssuerID )
          and ( RepLine.BIK_type = dppmrac.rec.BankCodeKind ) )
            RepLine.BIK = settacc.rec.BankCode;
            RepLine.BIK_type = settacc.rec.BankCodeKind;
          end;
        end;
      end;
    end;

    RepLine.Department = {OperDprt};
  END;

  // Печать данных 2-го подраздела 1-го раздела отчета
  PRIVATE MACRO PrintDataForPart12( Data, DS )


    var
      continue_cicle = false,
      RepLine = TRepLineData(),
      LineNum = 1, IsAgregEveryDay = Data.IsAgreg;
    var RepLineArray = TArray();

    private macro PrintDataForPart12CB(Data, DS, RepLine)
      record fininstr( fininstr );
      record avoir( avoiriss );
      // Получаем параметры бумаги
      if( ПолучитьФинИн( DS.FIID, fininstr, avoir ) )
        RunError( "Ошибка при получении параметров финансового инструмента (FIID = " + DS.FIID + ")." );
      end;

      // Общие данные
      // A2 - Дата операции
      RepLine.OperDate = Date(DS.OperDate);

      // A9 - код валюты платежа
      // Цифровой код валюты номинала
      RepLine.PayFIIDCode = GetFICode( fininstr.FaceValueFI );

      // A12 - A15
      GetResidentInfo(Data, DS.IssuerID, DS.IssuerIsBank,
                      DS.OwnerID, DS.OwnerIsBank, DS.OwnerNotRes, fininstr,
                      RepLine, false, false, null, false);

      // A4, A16 - A21
      GetAvoirInfo( Data, fininstr, avoir, GetPartyByID( GetIssuerOnDate( fininstr.FIID, Data.PeriodEnd ), true, true ), RepLine );

      // Частные данные (могут переопределять общие)
      if( DS.DealID > 0 )
        PrintDataForPart12ByRetire( Data, DS, fininstr, avoir, RepLine );
      elif( DS.DocumentID > 0 )
        PrintDataForPart12ByPayments( Data, DS, RepLine );
      end;

      if((not FI_IsBOND(avoir.FIID)) and ((RepLine.IssuerName == RepLine.ResName) or (RepLine.IssuerName == RepLine.NotResName))) /*GAA: 497465*/
//      if( Data.Kliko and ( DS.OwnerID == {OurBank} ) )
        RepLine.K_PSO = "СобственныеБумаги";
      end;

    end;

    InitProgressForPrintData( SQL_GetNRecs( GetDataTempTemp2() ), 1, 2 );

    PrintSubPartitionHeader1( Data, 2, true );

    while( DS.MoveNext() )
      RepLine.Init();
      UseProgressBar;

      if ( (DS.IdentProgram == IP_VEKSEL) and (PrintVA or PrintVS) )
        PrintDataForPart1VS(Data, DS, RepLine, 2);
        AddInAgregArr(RepLineArray, RepLine, IsAgregEveryDay);
      else
        if (PrintBack)
          PrintDataForPart12CB(Data, DS, RepLine);
          AddInAgregArr(RepLineArray, RepLine, IsAgregEveryDay);
        end;
      end;

      
    end;

    var i = 0;
    
    if( Data.Delta )
      Data.DeltaReport.Section( 1 , 2 );
    end;
     
    while(i < RepLineArray.Size)
      // Печать строки.
      PrintRepLine1( Data, 2, LineNum, RepLineArray(i) );
      LineNum = LineNum + 1;
      i = i + 1;
    end;

    if(Data.Delta)
      Data.DeltaReport.FinishData();
    end;
    
    RemProgressBar;
  END;

  PRIVATE MACRO PrintDataForPart2ByCB( Data, DS, fininstr, avoir, RepLine, SubPartNumber, RepLineArray, IsAgregEveryDay:@BOOL )
    var QueryIsAvanceDeposAndPaym = "select dlrq.t_FactDate, dlrq.t_Amount, dlrq.t_ID from ddlrq_dbt dlrq where dlrq.t_DocKind = " + DL_SECURITYDOC + " and dlrq.t_DocID = ? and dlrq.t_Type in (";
    var SelectIsAvanceDeposAndPaym;
    var DSIsAvanceDeposAndPaym;
    var DateNoteAvance;
    var DateNotePaym;

    var rq = TRecHandler("dlrq");
    var PaymentID;
    if(SubPartNumber == 1)
        PaymentID = DS.PaymentID;
    else
        PaymentID = DS.DealID;
    end;
    if( not ПолучитьТО(PaymentID, rq) )
       RunError( "Не найдено ТО  (ID = " + string(IIF(SubPartNumber == 1, DS.PaymentID, DS.DealID)) + " )" );
    end;

    var LegKind;
    if(rq.rec.DealPart == 2)
       LegKind = LEG_KIND_DL_TICK_BACK;
    else
       LegKind = LEG_KIND_DL_TICK;
    end;

    var FD = SPFirstDoc(LegKind, rq.rec.DocID);

    var
           paymContr      = TRecHandler( "dlrq.dbt" ),
           pmpc           = TRecHandler( "dlrq.dbt" ), /* платеж %%*/
           IsBasePaym     = IsBaseActPayment(rq.rec),
           IsContrPaym    = IsContrActPayment(rq.rec),
           InUnionPaym    = DS.InUnionPayment,
           IsExistAvance,
           PayFIID, AmountMon, FullSumFlag, ConvDate;

    ПолучитьТОпоДокументу(DL_SECURITYDOC, FD.dl_leg.rec.DealID, IIF(FD.dl_leg.rec.LegKind == LEG_KIND_DL_TICK, 1, 2), DLRQ_TYPE_PAYMENT, 0, paymContr);
    PayFIID = FD.dl_leg.rec.PayFIID;

    if(SubPartNumber == 2)
        IsExistAvance = DS.IsExistsAvance;
    else
        IsExistAvance = false;
    end;

    if((IsContrPaym and IsExistAvance and (not InUnionPaym))
           or (IsAvancePayment(rq.rec) and (not InUnionPaym)) )
        /* Если дата оплаты аванса/задатка и платежа по контрактиву
           приходятся на разные отчетные периоды - в этом случае берется курс
           на фактическую дату этого платежа. */
       ConvDate = Date(DS.OperationDate);
    elif( IsBasePaym and (not DL_GetRQStateOnDate(paymContr.rec.Id, Data.PeriodEnd) ==  DLRQ_STATE_EXEC) )
       /* Если ТО по поставке (собственная сделка) и оплата
          на конец отчетного периода не исполнена - в этом случае берется
          курс на фактическую дату поставки. */
       ConvDate = Date(DS.OperationDate);
    else
       /* Иначе. Конвертация производится по курсу на дату оплаты сделки. */
       ConvDate = paymContr.rec.FactDate;
    end;

    if(DS.IsExistsAvance)
        if((rq.rec.Type == DLRQ_TYPE_AVANCE) or (rq.rec.Type == DLRQ_TYPE_DEPOSIT))
            QueryIsAvanceDeposAndPaym = QueryIsAvanceDeposAndPaym + string(DLRQ_TYPE_PAYMENT) + ")";
            SelectIsAvanceDeposAndPaym = DL_RSDCommand(QueryIsAvanceDeposAndPaym);
            SelectIsAvanceDeposAndPaym.AddParam(rq.rec.DocID);
            DSIsAvanceDeposAndPaym = SelectIsAvanceDeposAndPaym.Execute();
            if(DSIsAvanceDeposAndPaym.MoveNext())
                var rqPaym = TRecHandler("dlrq");
                if( not ПолучитьТО(DSIsAvanceDeposAndPaym.ID, rqPaym) )
                   RunError( "Не найдено ТО  (ID = " + string(DSIsAvanceDeposAndPaym.ID) + " )" );
                end;
                DateNoteAvance = readNoteForObject(OBJTYPE_DLRQ, UniID(rq/*DS*/, OBJTYPE_DLRQ), 46, Data.PeriodEnd);
                DateNotePaym = readNoteForObject(OBJTYPE_DLRQ, UniID(rqPaym/*DSIsAvanceDeposAndPaym*/, OBJTYPE_DLRQ), 46, DateNotePaym);
                if((DateNoteAvance >= Data.PeriodBeg) and (DateNoteAvance <= Data.PeriodEnd) and (DateNotePaym >= Data.PeriodBeg) and (DateNotePaym <= Data.PeriodEnd))
                    return NULL;
                elif(((DateNoteAvance < Data.PeriodBeg) and (rq.rec.FactDate < Data.PeriodBeg) and (DateNotePaym > Data.PeriodBeg) and (DateNotePaym < Data.PeriodEnd) and (DSIsAvanceDeposAndPaym.FactDate > Data.PeriodBeg) and (DSIsAvanceDeposAndPaym.FactDate < Data.PeriodEnd))
                        or ((DateNoteAvance >= Data.PeriodBeg) and (DateNoteAvance <= Data.PeriodEnd) and (rq.rec.FactDate >= Data.PeriodBeg) and (rq.rec.FactDate <= Data.PeriodEnd) and (DateNotePaym > Data.PeriodEnd)))
                    if(RepLine.Note != "")
                        RepLine.Note = RepLine.Note + ";";
                    end;
                    RepLine.Note = RepLine.Note + "рассрочка";
                end;
            end;
        elif(rq.rec.Type = DLRQ_TYPE_PAYMENT)
            QueryIsAvanceDeposAndPaym = QueryIsAvanceDeposAndPaym + string(DLRQ_TYPE_AVANCE) + ", " + string(DLRQ_TYPE_DEPOSIT) + ")";
            SelectIsAvanceDeposAndPaym = DL_RSDCommand(QueryIsAvanceDeposAndPaym);
            SelectIsAvanceDeposAndPaym.AddParam(rq.rec.DocID);
            DSIsAvanceDeposAndPaym = SelectIsAvanceDeposAndPaym.Execute();
            if(DSIsAvanceDeposAndPaym.MoveNext())
                var rqAvance = TRecHandler("dlrq");
                if( not ПолучитьТО(DSIsAvanceDeposAndPaym.ID, rqAvance) )
                   RunError( "Не найдено ТО  (ID = " + string(DSIsAvanceDeposAndPaym.ID) + " )" );
                end;
                DateNotePaym = readNoteForObject(OBJTYPE_DLRQ, UniID(rq, OBJTYPE_DLRQ), 46, DateNotePaym);
                DateNoteAvance = readNoteForObject(OBJTYPE_DLRQ, UniID(rqAvance, OBJTYPE_DLRQ), 46, DateNoteAvance);
                if((((DateNoteAvance == NULL) and (DateNotePaym == NULL)) or ((DateNoteAvance >= Data.PeriodBeg) and (DateNoteAvance <= Data.PeriodEnd) and (DateNotePaym >= Data.PeriodBeg) and (DateNotePaym <= Data.PeriodEnd))) and ((rqAvance.rec.FactDate >= Data.PeriodBeg) and (rqAvance.rec.FactDate <= Data.PeriodEnd) and (rq.rec.FactDate >= Data.PeriodBeg) and (rq.rec.FactDate <= Data.PeriodEnd)))
                    if(RepLine.Note != "")
                        RepLine.Note = RepLine.Note + ";";
                    end;
                    RepLine.Note = RepLine.Note + "агрегация";
                    SmartConvertSum(RepLine.A10_SumPay, FD.dl_leg.rec.TotalCost, ConvDate, FD.dl_leg.rec.CFI, PayFIID, true);
                    RepLine.A7_Amount = FD.dl_leg.rec.Principal;
                    IsAgregEveryDay = false;
                elif((((DateNoteAvance < Data.PeriodBeg) or (DateNoteAvance == NULL)) and (rqAvance.rec.FactDate < Data.PeriodBeg) and (((DateNotePaym >= Data.PeriodBeg) and (DateNotePaym <= Data.PeriodEnd)) or (DateNotePaym == NULL)) and (rq.rec.FactDate >= Data.PeriodBeg) and (rq.rec.FactDate <= Data.PeriodEnd)))
                    if(RepLine.Note != "")
                        RepLine.Note = RepLine.Note + ";";
                    end;
                    RepLine.Note = RepLine.Note + "рассрочка";
                    RepLine.A7_Amount = FD.dl_leg.rec.Principal * (rq.rec.Amount / FD.dl_leg.rec.TotalCost);
                    SmartConvertSum(RepLine.A10_SumPay, rq.rec.Amount, ConvDate, FD.dl_leg.rec.CFI, PayFIID);
                elif(((DateNoteAvance >= Data.PeriodBeg) and (DateNoteAvance <= Data.PeriodEnd) or (DateNoteAvance == NULL)) and (rqAvance.FactDate >= Data.PeriodBeg) and (rqAvance.FactDate <= Data.PeriodEnd) and ((DateNotePaym > Data.PeriodEnd) or (DateNotePaym == NULL)))
                    if(RepLine.Note != "")
                        RepLine.Note = RepLine.Note + ";";
                    end;
                    RepLine.Note = RepLine.Note + "рассрочка";
                    RepLine.A7_Amount = FD.dl_leg.rec.Principal * (rq.rec.Amount / FD.dl_leg.rec.TotalCost);
                    SmartConvertSum(RepLine.A10_SumPay, rq.rec.Amount, ConvDate, FD.dl_leg.rec.CFI, PayFIID);
                end;
            end;
        end;
    end;

    //2.4 - код вида операции

    var QueryDealPart2Exists = "select dlrq.*" +
                               " from ddlrq_dbt dlrq" +
                               " where dlrq.t_DocKind = " + string(DL_SECURITYDOC) +
                               "    and dlrq.t_DocID = ?" +
                               "    and dlrq.t_DealPart = " + IIF(rq.rec.DealPart == 1, string(2), string(1));

    var SelectDealPart2Exists = DL_RsdCommand(QueryDealPart2Exists);

    SelectDealPart2Exists.AddParam(rq.rec.DocID);

    var DSDealPart2Exists = SelectDealPart2Exists.execute();
    var IsPart2Exists = DSDealPart2Exists.MoveNext();

    if((rq.rec.Type != DLRQ_TYPE_COMPPAYM) and IsPart2Exists and (rq.rec.DealPart == 2))
        RepLine.OperCode = "13";
        if(RepLine.Note != "")
            RepLine.Note = RepLine.Note + ";";
        end;
        RepLine.Note = RepLine.Note + DateToStr(Date(DSDealPart2Exists.FactDate), true);
        /*GAA: 497465*/
        RepLine.K_DOP1 = DateToStr(Date(DSDealPart2Exists.FactDate), true);
    elif((rq.rec.Type != DLRQ_TYPE_COMPPAYM) and (rq.rec.DealPart == 1) and IsPart2Exists)
        RepLine.OperCode = "12";
        if(RepLine.Note != "")
            RepLine.Note = RepLine.Note + ";";
        end;
        RepLine.Note = RepLine.Note + DateToStr(IIF(Date(DSDealPart2Exists.FactDate) != ZeroDate, Date(DSDealPart2Exists.FactDate), Date(DSDealPart2Exists.PlanDate)), true);
        /*GAA: 497465*/
        RepLine.K_DOP1 = DateToStr(IIF(Date(DSDealPart2Exists.FactDate) != ZeroDate, Date(DSDealPart2Exists.FactDate), Date(DSDealPart2Exists.PlanDate)), true);
    elif((rq.rec.Type == DLRQ_TYPE_COMPPAYM) and IsPart2Exists)
        if(RepLine.Note != "")
            RepLine.Note = RepLine.Note + ";";
        end;
        if((rq.rec.DealPart != 2) and (rq.rec.Kind == 0))
            RepLine.OperCode = "14";
            RepLine.Note = RepLine.Note + DateToStr(IIF(Date(DSDealPart2Exists.FactDate) != ZeroDate, Date(DSDealPart2Exists.FactDate), Date(DSDealPart2Exists.PlanDate)), true);
        else
            RepLine.OperCode = "13";
            RepLine.Note = RepLine.Note + "рассрочка";
        end;
        SmartConvertSum( RepLine.A10_SumPay, FD.dl_leg.rec.TotalCost, ConvDate, FD.dl_leg.rec.CFI, PayFIID, true );
    else
        RepLine.OperCode = "15";
    end;

    if(SubPartNumber == 1)
         if((rq.rec.Type == DLRQ_TYPE_COMPPAYM) and IsPart2Exists)
            RepLine.A7_Amount = FD.dl_leg.rec.Principal;
         else
            SmartConvertSum( RepLine.A10_SumPay, FD.dl_leg.rec.TotalCost, ConvDate, FD.dl_leg.rec.CFI, PayFIID, true );
            RepLine.A7_Amount = rq.rec.Amount;
         end;
    else
        if( not IsExistAvance )
            //A2.5 - количество
            RepLine.A7_Amount = FD.dl_leg.rec.Principal;
            SmartConvertSum(RepLine.A10_SumPay, DS.PayAmount, ConvDate, FD.dl_leg.rec.CFI, PayFIID);
        end;
    end;

    /*if((RepLine.VO_Code == "DOL1") or (RepLine.VO_Code == "DOL2") or (RepLine.VO_Code == "DOL3") or (RepLine.VO_Code == "DOL4") or (RepLine.VO_Code == "DOL5") or
        (RepLine.VO_Code == "DOL7") or (RepLine.VO_Code == "OTH3") or (RepLine.VO_Code == "OTH4"))*/
    if(Exclude_A7(RepLine.VO_Code))

        RepLine.A7_Amount = 0;
    end;

    if(RepLine.OperCode == "13")
        SmartConvertSum(Repline.A10_SumPay, FD.dl_leg.rec.TotalCost, ConvDate, FD.dl_leg.rec.CFI, PayFIID, true);
    end;

    // A2.7 - код валюты платежа
    RepLine.PayFIIDCode = GetFICode( PayFIID );

    // A2.9 - A2.12
    if( SubPartNumber == 1 )
        GetResidentInfo( Data, DS.ContrID, DS.ContrIsBank,
                               DS.OwnerID, DS.OwnerIsBank, DS.OwnerNotRes,
                               fininstr, RepLine, true,
                               IsEXCHANGE( FD.Group ), DS.DealID, ЭтоВыплатаКупонаЧП( rq.rec.Type ) );
    else
        GetResidentInfo( Data, DS.IssuerID, DS.IssuerNotRes,
                               DS.OwnerID, DS.OwnerIsBank, DS.OwnerNotRes,
                               fininstr, RepLine, false,
                               IsEXCHANGE( FD.Group ), DS.DealID, ЭтоВыплатаКупонаЧП( rq.rec.Type ) );
    end;
    GetResidentNameCode( RepLine.NotResPartyID, fininstr, false, DS.OwnerID, DS.DealID, NULL, @RepLine.NotResCode );

    // A2.13 - A2.16
    if(fininstr.AvoirKind == AVOIRISSKIND_BASKET)
        RepLine.Note = "пакет";
        var AvoirFromBasketQuery = "select SUM(CASE WHEN dl_tick_ens.T_KIND = ? THEN NVL(T_PRINCIPAL,0) ELSE NVL(-T_PRINCIPAL,0) END) T_PRINCIPAL, dl_tick_ens.t_FIID " +
                                   "from ddl_tick_ens_dbt dl_tick_ens " +
                                   "where dl_tick_ens.t_DealID = ?" +
                                   "    and dl_tick_ens.t_Date <= ? " +
                                   "group by T_PRINCIPAL, dl_tick_ens.t_FIID " +
                                   "having SUM(CASE WHEN dl_tick_ens.T_KIND = ? THEN NVL(T_PRINCIPAL,0) ELSE NVL(-T_PRINCIPAL,0) END) > 0";

        var AvoirFromBasketSelect = DL_RSDCommand(AvoirFromBasketQuery);
        AvoirFromBasketSelect.AddParam(TICKENS_KIND_IN);
        AvoirFromBasketSelect.AddParam(DS.DealID);
        AvoirFromBasketSelect.AddParam(Data.PeriodEnd);
        AvoirFromBasketSelect.AddParam(TICKENS_KIND_IN);

        var AvoirFromBasketDS = AvoirFromBasketSelect.Execute();
        while(AvoirFromBasketDS.MoveNext())
            ClearRecord(fininstr);
            ClearRecord(avoir);
            if(ПолучитьФинИн(AvoirFromBasketDS.FIID, fininstr, avoir) == 0)
                GetAvoirInfo( Data, fininstr, avoir, GetPartyByID( GetIssuerOnDate( AvoirFromBasketDS.FIID, Data.PeriodEnd ), true, true ), RepLine );
            end;
        end;
    else
        GetAvoirInfo( Data, fininstr, avoir, GetPartyByID( GetIssuerOnDate( fininstr.FIID, Data.PeriodEnd ), true, true ), RepLine );
    end;

    if( Data.Kliko )
/* GAA: 497465 Требование банка
        if( ( SubPartNumber == 1 ) and IsREPO( FD.Group ) )
            if( FD.dl_leg.rec.LegKind == LEG_KIND_DL_TICK )
                RepLine.K_DOP1 = Date( DS.OperationDate );
            else
                var rq1 = TRecHandler( "dlrq" );
                if( DS.OwnerID == {OurBank} )
                    if( ПолучитьТОпоДокументу( DL_SECURITYDOC, FD.dl_leg.rec.DealID, 1, DLRQ_TYPE_DELIVERY, 0, rq1 ) )
                        RepLine.K_DOP1 = Date( rq1.rec.FactDate );
                    end;
                else
                    if( ПолучитьТОпоДокументу( DL_SECURITYDOC, FD.dl_leg.rec.DealID, 1, DLRQ_TYPE_PAYMENT, 0, rq1 )
                     or ПолучитьТОпоДокументу( DL_SECURITYDOC, FD.dl_leg.rec.DealID, 1, DLRQ_TYPE_AVANCE, 0, rq1 )
                     or ПолучитьТОпоДокументу( DL_SECURITYDOC, FD.dl_leg.rec.DealID, 1, DLRQ_TYPE_DEPOSIT, 0, rq1 ) )
                        if( ( rq1.rec.FactDate >= Data.PeriodBeg )
                        and ( rq1.rec.FactDate <= Data.PeriodEnd ) )
                            RepLine.K_DOP1 = Date( rq1.rec.FactDate );
                        end;
                    end;
                end;
            end;
        end;
*/
        if( ( RepLine.OperCode == "13" ) and ( rq.rec.Type == DLRQ_TYPE_COMPPAYM ) )
            RepLine.K_RAS = "РАССРОЧКА";
        end;
    end;

    AddInAgregArr(RepLineArray, RepLine, IsAgregEveryDay);

    return RepLine;
  END;

  PRIVATE MACRO PrintDataForPart2ByVA( Data, DS, fininstr, avoir, RepLine, RepLineArray )
    var
      bnrfd = VSBannerFD( DL_VSBANNER, DS.DocumentID ),
      tickfd = VATickFD( DL_VEKSELACCOUNTED, DS.RegLineID );

    var IsAgregEveryDay = Data.IsAgreg;
    //var RepLineArray = TArray();

    // A2.2 - дата операции
    RepLine.OperDate = DL_GetBnrPlanRepayDate( bnrfd.GetBnr(), bnrfd.GetLeg() );

    // A2.4 - код вида операции
    if( tickfd.GetBartDiffSum() != $0 )
      RepLine.OperCode = "21";
    end;

    // A2.5 - количество, шт.
    RepLine.A7_Amount = DS.Amount;

    // A2.7 - код валюты платежа
    RepLine.PayFIIDCode = GetFICode( tickfd.GetDealPayFI() );

    // A2.8 - сумма платежа по операции, ед. валюты
    RepLine.A10_SumPay = DS.PayAmount;

    // A2.9 - A2.12
    GetPayerReceiverInfo( Data, DS.OwnerID, DS.IssuerID, fininstr, RepLine );

    // A2.13 - A2.15
    GetAvoirInfo( Data, fininstr, avoir, GetPartyByID( bnrfd.GetBnr().rec.Issuer, true, true ), RepLine );

    // A2.16 - код валюты ценной бумаги
    if( RepLine.AvrType405 != "DOL7" )
      RepLine.AvFaceFICode = GetFICode( bnrfd.GetLeg().rec.PFI );
    end;

    // A2.17 - примечание
    // todo ...
    RepLine.Note = "";

    AddInAgregArr(RepLineArray, RepLine, IsAgregEveryDay);
  END;

  // Печать данных 2-го раздела отчета
  PRIVATE MACRO PrintDataForPart2( Data, SubPartNumber, DS )

    record fininstr( fininstr );
    record avoir( avoiriss );
    var rq = TRecHandler( "dlrq.dbt" );
    var
      RepLine = TRepLineData(),
      LineNum = 1;
    var RepLineArray = TArray();

    InitProgressForPrintData( SQL_GetNRecs( GetDataTempTemp2() ), 2, SubPartNumber );

    PrintSubPartitionHeader2( Data, SubPartNumber, true );

    while( DS.MoveNext() )
      RepLine = TRepLineData();
      RepLine.Init();
      UseProgressBar;

      // Получаем параметры бумаги
      if( ПолучитьФинИн( DS.FIID, fininstr, avoir ) )
        RunError( "Ошибка при получении параметров финансового инструмента (FIID = " + DS.FIID + ")." );
      end;

      // Общие данные
      // A2.2 - Дата операции
      if(SubPartNumber == 1)
         RepLine.OperDate = Date( DS.OperationDate );
      else
         var RQSelect = DL_RSDCommand(
                               "select dlrqPaym.t_FactDate as t_PaymDate, dlrqAvance.t_FactDate as t_AvanceDate" +
                               " from ddlrq_dbt dlrqPaym, ddlrq_dbt dlrqAvance" +
                               " where dlrqPaym.t_DocKind = ?" +
                               "   and dlrqPaym.t_DocID = ?" +
                               "   and dlrqPaym.t_Type = " + string(DLRQ_TYPE_PAYMENT) +
                               "   and dlrqAvance.t_DocKind = ?" +
                               "   and dlrqAvance.t_DocID = ?" +
                               "   and dlrqAvance.t_Type in (" + string(DLRQ_TYPE_AVANCE) + ", " + string(DLRQ_TYPE_DEPOSIT) + ")"
                             );
         ПолучитьТО(DS.PaymentID, rq);
         RQSelect.AddParam(rq.rec.DocKind);
         RQSelect.AddParam(rq.rec.DocID);
         RQSelect.AddParam(rq.rec.DocKind);
         RQSelect.AddParam(rq.rec.DocID);
         var RQDataSet = RQSelect.Execute();
         var IsMoveNext = RQDataSet.MoveNext();

         if(
              IsMoveNext and (RQDataSet.PaymDate >= Data.PeriodBeg)
                                     and (RQDataSet.PaymDate <= Data.PeriodEnd)
                                     and (RQDataSet.AvanceDate >= Data.PeriodBeg)
                                     and (RQDataSet.AvanceDate <= Data.PeriodEnd)
           )
              RepLine.OperDate = Date(RQDataSet.PaymDate);
         elif(IsMoveNext and (RQDataSet.PaymDate >= Data.PeriodBeg)
                         and (RQDataSet.PaymDate <= Data.PeriodEnd))
              RepLine.OperDate = DS.PaymDate;
         elif(IsMoveNext and (RQDataSet.AvanceDate >= Data.PeriodBeg)
                         and (RQDataSet.AvanceDate <= Data.PeriodEnd))
              RepLine.OperDate = DS.PaymDate;
         end;
      end;

      // Частные данные (могут переопределять общие)
      if( (DS.DealID > 0 ) and PrintBack)
        RepLine = PrintDataForPart2ByCB( Data, DS, fininstr, avoir, RepLine, SubPartNumber, RepLineArray );
      elif( (DS.DocumentID > 0) and (PrintVA or PrintVS) )
        PrintDataForPart2ByVA( Data, DS, fininstr, avoir, RepLine, RepLineArray );
      end;

      // Печать строки.
      if( RepLine != NULL )
       if((not FI_IsBOND(avoir.FIID)) and ((RepLine.IssuerName == RepLine.ResName) or (RepLine.IssuerName == RepLine.NotResName))) /*GAA: 497465*/
//        if( Data.Kliko and ( DS.OwnerID == {OurBank} ) )
          RepLine.K_PSO = "СобственныеБумаги";
        end;
      end;
    end;

    var i = 0;
    if( Data.Delta )
      Data.DeltaReport.Section(2 , 1);
    end;
    
    while(i < RepLineArray.Size)
       PrintRepLine2( Data, SubPartNumber, LineNum, RepLineArray(i) );
       LineNum = LineNum + 1;
       i = i + 1;
    end;
    
    if(Data.Delta)
      Data.DeltaReport.FinishData();
    end;
     
    RemProgressBar;
  END;

  PRIVATE MACRO PrintPartition1( Data )

     var Select = DL_RSDCommand(GetDataTempTemp2()), DS;

     file TempFile( "represpm.tmp" ) write;
     file TempFile2( "represp2.tmp" ) write;

     ClearGlobalTmp( "dreprespm_tmp" );
     ClearGlobalTmp( "drepresp2_tmp" );

     WasCollectedDataForPart12 = false;

     // здесь кроме 1-го подраздела 1-го раздела собираем инфу для 2-го подраздела 1-го раздела по выплатам купонов и ЧП в РЕПО
     if( ( Data.PrintPart11 or Data.PrintPart12 and ( Data.Mode_Retire or Data.Mode_Payments ) )//UPG 54 Перенес из пользовательского макроса (GAA)
     and CollectDataForPart11( Data, TempFile, TempFile2 ) )
        KeyNum( TempFile, 1 );
        Rewind( TempFile );
        DS = Select.Execute();
        PrintDataForPart11( Data, DS );
     elif(Data.PrintPart11 or Data.PrintPart12 and ( Data.Mode_Retire or Data.Mode_Payments ))//UPG 54 Перенес из пользовательского макроса (GAA)
        PrintReportRunFalse( 1, 1, Data );
     end;

     ClearGlobalTmpByIdent("dreprespm_tmp", makeArray(IP_VEKSEL,IP_VEKSELACCOUNTED));
     ClearGlobalTmpByIdent("drepresp2_tmp", makeArray(IP_VEKSEL,IP_VEKSELACCOUNTED));
     ClearGlobalTmp( "dreprespm_tmp" );

     if (Data.PrintPart12)
        WasCollectedDataForPart12 = CollectDataForPart1ByVS( Data, 2, TempFile2 ) or WasCollectedDataForPart12;
     end;

     if( Data.PrintPart12
     and ( Data.Mode_Retire and ( CollectDataForPart12ByRetire( Data, TempFile2 ) or WasCollectedDataForPart12 )
        or Data.Mode_Payments and CollectDataForPart12ByPayments( Data, TempFile2 ) ) )
        DS = Select.Execute();
        PrintDataForPart12( Data, DS );
     elif(Data.PrintPart12 and Data.Mode_Retire or Data.Mode_Payments)
        PrintReportRunFalse( 1, 2, Data );
     end;

     if( IsTableHeaderPrinted1 )
        EndTable();
        CopyAllSheetInTotalBook( "Отчет1", false, GetTableRange(), 0, "Отчет1", false );
     end;
  END;

  PRIVATE MACRO PrintPartition2( Data )

     var Select = DL_RSDCommand(GetDataTempTemp2()), DS;

     file TempFile( "represpm.tmp" ) write;
     file TempFile2( "represp2.tmp" ) write;

     ClearGlobalTmp( "dreprespm_tmp" );
     ClearGlobalTmp( "drepresp2_tmp" );

     if( Data.PrintPart21 and ( CollectDataForPart2ByCB( Data, 1, TempFile, TempFile2 )
                             or CollectDataForPart2ByVA( Data, 1, TempFile2 ) ) )
       IsHeaderPrinted = true;
       DS = Select.Execute();
       PrintDataForPart2( Data, 1, DS );
     else
       PrintReportRunFalse( 2, 1, Data );
     end;

     ClearGlobalTmp( "dreprespm_tmp" );
     ClearGlobalTmp( "drepresp2_tmp" );

     if( Data.PrintPart22 and ( CollectDataForPart2ByCB( Data, 2, TempFile, TempFile2 )
                             or CollectDataForPart2ByVA( Data, 2, TempFile2 ) ) )
       DS = Select.Execute();
       PrintDataForPart2( Data, 2, DS );
     else
       PrintReportRunFalse( 2, 2, Data );
     end;

     if( IsTableHeaderPrinted2 )
        EndTable();
        CopyAllSheetInTotalBook( "Отчет2", false, GetTableRange(), 0, "Отчет2", false );
     end;
  END;

  PRIVATE MACRO Create()
     if(Data.Delta)
        Data.DeltaReport = F405DeltaXML(GetOKUD(), GetReportKind(), Data.PeriodEnd, GetPeriodicity());
        Data.DeltaReport.PrintInfo();
        Data.DeltaReport.BeginData405();
     end;
     
     SetActiveSheet("Отчет1");
     if( Data.PrintPart1 )
        PrintPartition1( Data );
     end;

     SetActiveSheet("Отчет2");
     if( Data.PrintPart2 )
        PrintPartition2( Data );
     end;

     PrintFoot( Data );

     PrintProtocol( Data );

     Kliko_CloseTxtFile();
     
      if(Data.Delta)
        if(Data.DeltaReport.RowNum == 1)
          Data.DeltaReport.NoData();
        end;
        Data.DeltaReport.FinishData();
        Data.DeltaReport.PrintProtocol();
        if(Data.DeltaReport.CreateXMLFile())
          msgbox("Создан файл " + Data.DeltaReport.GetFileName());
        else
          msgbox("Ошибка экспорта в Delta");
        end;

        var delta_file_name_term = "$" + SC_GetFullPath(true) + Data.DeltaReport.GetFileName();
        if(ExistFile(delta_file_name_term))
          RemoveFile(delta_file_name_term);
        end;
        if (not copyFile(Data.DeltaReport.GetFileName(),delta_file_name_term,true,"Копирование на терминал"))
          msgbox("Ошибка при копировании " + Data.DeltaReport.GetFileName() + " на терминал");
        else
          RemoveFile(Data.DeltaReport.GetFileName());
        end;
      end;
  END;
   
   if (Data.PeriodEnd >= Data.ActDate7047)
      initDL_CReportTemplate( null, "Report_SpReprespm_7047.xls" );
   else
      initDL_CReportTemplate( null, "Report_SpReprespm.xls" );
   end;
END;

macro ReportRun( MonthNum: integer,      // Месяц
                 YearNum: integer,       // Год
                 _PrintBack: bool,       // БО ЦБ
                 _PrintVA: bool,         // Учтенные векселя
                 _PrintVS: bool,         // Векселя банка
                 PrintPart1: bool,       // Печатать раздел: сделки между резидентами и нерезидентами
                 PrintPart11: bool,      // Печатать подраздел: сделки ц/б
                 Mode_Res_NoRes: bool,   // Режим работы: резеденты с нерезидентами
                 Mode_All_All: bool,     // Режим работы: рез. с нерез. и наоборот
                 PrintPart12: bool,      // Печатать подраздел: операции погашения и выплаты
                 Mode_Retire: bool,      // Режим работы: погашения (вкл. просроченные) БОЦБ
                 Mode_Payments: bool,    // Режим работы: обработки выплат в "Депозитарии"
                 PrintPart2: bool,       // Печатать раздел: сделки между резидентами
                 PrintPart21: bool,      // Печатать подраздел: сделки в интересах банка
                 PrintPart22: bool,      // Печатать подраздел: сделки в интересах клиентов
                 IsApp: bool,            // Апострофы
                 IsAgreg: bool,          // Агрегация данных за каждый день
                 IsExcel: bool,          // Выпуск в Excel
                 Kliko: bool,            // Выгрузка для kliko
                 Delta: bool)            // Выгрузка для Delta

   PrintBack = _PrintBack;
   PrintVA = _PrintVA;
   PrintVS = _PrintVS;

   if( IsExcel )
      Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
   else
      Dl_CallInsertStat( DL_OUTREPORT_STD );
   end;

   if( Kliko )
      Dl_CallInsertStat( DL_OUTREPORT_KLIKO );
   end;

   if( not ( ( PrintPart1 and ( PrintPart11 or PrintPart12 and ( Mode_Retire or Mode_Payments ) ) )
          or ( PrintPart2 and ( PrintPart21 or PrintPart22 ) ) ) )
      MsgBox( "Не выбрано ни одного раздела для выпуска отчета." );
   else
      var data = ReportData( MonthNum, YearNum, PrintPart1, PrintPart11, Mode_Res_NoRes, PrintPart12, Mode_Retire, Mode_Payments, PrintPart2, PrintPart21, PrintPart22, IsApp, IsAgreg, IsExcel, Kliko, Delta);
      SP_Represpm_Report( data ).Run( null, data.AuditMsg() );
   end;

   exit( 1 );
end;
