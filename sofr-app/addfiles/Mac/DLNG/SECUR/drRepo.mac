



import RsbFormsInter, Global, or_rep_h;



CLASS OfferRep(Begdate, Enddate)

var Report;
var rn = 1;
var _BegDate = begdate;
var _EndDate = enddate;
var sheet = 1,n_sheet = 2;
var count = 0;

var col1_len = 20,  col2_len = 15, col3_len = 45;
var col4_len = 10,  col5_len = 10,  col6_len = 6;
var col7_len = 15, col8_len = 15,  col9_len = 10;
var col10_len = 15, col11_len = 15,  col12_len = 10;

var color  = 12632256;  
var ColorD = 16316664;
var ColorL = 15395562;

var head_format = "ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
var format      = "ex_FS():ex_B(tblr):ex_BC(" + color + ")";

private macro ДобавитьСтроку()
  Report.AddStr();rn = rn + 1;
end;

private macro ДобавитьПустуюСтроку()
   Report.AddEmptyStr();rn = rn + 1;
end; 

private macro ПечатьШапки ()        

    ДобавитьПустуюСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
   
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("Доходы и расходы по операциям РЕПО, отраженные в бухгалтерском учете", col1_len, null, "r:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":D"+(rn)+"\").merge;");
    Report.AddPrintCell("За период: " + string(_Begdate) +  " - "+ string(_EndDate):f, col1_len, null, "l:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    ДобавитьПустуюСтроку();
/*1*/   Report.AddPrintCell ("Счет",         col1_len,  null, "c:" + head_format);
/*2*/   Report.AddPrintCell ("Остаток на счете",  col2_len,  null,"c:" + head_format);
/*2*/   Report.AddPrintCell ("Наименование ценной бумаги",   col3_len,  null,"c:" + head_format);
/*4*/   Report.AddPrintCell ("ID сделки",        col4_len,  null, "c:"+ head_format);
/*5*/   Report.AddPrintCell ("Дата сделки",       col5_len,  null, "c:" + head_format);
/*6*/   Report.AddPrintCell ("ПФИ",        col6_len,  null,"c:" + head_format); 
/*7*/   Report.AddPrintCell ("ISIN",        col7_len,  null, "c:" + head_format);
/*8*/   Report.AddPrintCell ("Номер госрегистрации",         col8_len,  null, "c:" + head_format);
/*9*/   Report.AddPrintCell ("Номер сделки",  col9_len,  null,"c:" + head_format);
/*10*/   Report.AddPrintCell ("Счет плательщика",   col10_len,  null,"c:" + head_format);
/*11*/   Report.AddPrintCell ("Счет получателя",         col11_len,  null, "c:" + head_format);
/*12*/   Report.AddPrintCell ("Сумма",  col12_len,  null,"c:" + head_format);

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+(rn-1)+").AutoFilter;");
    ДобавитьСтроку;
end;


private macro ПечатьБлокаДанных(_rs);
    if(valtype(_rs) != v_undef)
    format = "ex_FS():ex_B(tblr)";
      while(_rs.movenext)
        Report.AddPrintCell(_rs.value("acc1"), col1_len, null, "l:"+format); // 1. 
        Report.AddPrintCell(_rs.value("restt"), col2_len, null, "l:"+format); // 2.  
        Report.AddPrintCell(_rs.value("name1"), col3_len, null, "l:"+format); // 3. 
        Report.AddPrintCell(_rs.value("deal1"), col4_len, null, "c:"+format); // 4. 
        Report.AddPrintCell(date(_rs.value("deald1")), col5_len, null, "c:"+format); // 5. 
        Report.AddPrintCell(_rs.value("PFI"), col6_len, null, "r:"+format); // 6. 
        Report.AddPrintCell(_rs.value("ISIN"), col7_len, null, "r:"+format); // 7. 
        Report.AddPrintCell(_rs.value("LSIN"), col8_len, null, "l:"+format); // 3. 
        Report.AddPrintCell(_rs.value("num1"), col9_len, null, "c:"+format); // 4. 
        Report.AddPrintCell(_rs.value("ap"), col10_len, null, "c:"+format); // 5. 
        Report.AddPrintCell(_rs.value("ar"), col11_len, null, "r:"+format); // 6. 
        Report.AddPrintCell(_rs.value("suma1"), col12_len, null, "r:"+format); // 7. 

        ДобавитьСтроку;
             
      end;
    end;
end;





macro run()
var SQL, cmd, rs;

  Report = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Report.SetDefaultFontName("Times New Roman");
  Report.SetDefaultFontSize(10);
  Report.SetFlagShowGrid(true);

  ПечатьШапки();
 
begaction(100,"Сбор данных...");
ExecMacroFile ("nu_assist.mac","UpdateTempTable");    
endaction;
                                                       
SQL ="  SELECT (CASE                                                                           "+
"             WHEN t_account_payer LIKE '706%' THEN t_account_payer                            "+
"             ELSE T_ACCOUNT_RECEIVER                                                          "+
"          END)                                                                                "+
"            acc1,/*счет*/                                                                     "+ 
"         (CASE                                                                                "+
"             WHEN t_account_payer LIKE '706%' THEN rest1                                      "+
"             ELSE rest2                                                                       "+
"          END)                                                                                "+
"            restt, /*остаток*/                                                                "+   
"         (SELECT t_name                                                                       "+
"            FROM dfininstr_Dbt                                                                "+
"           WHERE t_fiid = pfi)                                                                "+
"            name1,  /*наименование цб*/                                                       "+
"         r.T_DEALID  deal1,  /*id сделки*/                                                    "+
"         r.DEALDATE deald1,  /*дата сделки*/                                                  "+
"         PFI , /*ПФИ*/                                                                        "+
"         ISIN ,/*ISIN*/                                                                       "+
"         LSIN , /*номер госрегистрации*/                                                      "+
"         (SELECT t_dealcodets                                                                 "+
"            FROM ddl_tick_dbt                                                                 "+
"           WHERE t_dealid = r.t_dealid)                                                       "+
"            num1, /*номер сделки*/                                                            "+
"         T_ACCOUNT_PAYER ap,                                                                  "+
"         T_ACCOUNT_RECEIVER ar,                                                               "+
"         (CASE WHEN fiid1 = 0 THEN SUM (summ1) ELSE SUM (summ2) END)                          "+
"            suma1  /*сумма*/                                                                  "+
"    FROM tsgs r, ddl_tick_dbt t                                                               "+
"   WHERE     r.t_dealid = t.t_dealid                                                          "+
"         AND (t_account_payer  in ('70601810100001121503', '70601810800001121502','70606810200003140102','70606810400003141503','70606810700003141504') or t_account_receiver in ('70601810100001121503', '70601810800001121502','70606810200003140102','70606810400003141503','70606810700003141504') )      "+
"         AND isrepo = 1                                                                       "+
"         AND t.t_clientid = -1                                                                "+
"         AND r.trndate BETWEEN :datebeg                                                       "+
"                           AND :dateend                                                       "+
"GROUP BY r.t_dealid,                                                                          "+
"         t_account_payer,                                                                     "+
"         t_account_receiver,                                                                  "+
"         pfi,                                                                                 "+
"         ISREPO,                                                                              "+
"         r.DEALDATE,                                                                          "+
"         isin,                                                                                "+
"         lsin,                                                                                "+
"         fiid1, rest1,rest2,                                                                  "+
"         fiid2                                                                                "+
"ORDER BY 1, r.t_dealid                                                                        ";
   








    cmd = RSDCommand(SQL);
    cmd.AddParam("datebeg", RSDBP_IN, _BegDate);
    cmd.AddParam("dateend", RSDBP_IN, _EndDate);
    begaction(100,"Сбор данных...");

    rs = RSDRecordset(cmd);
      ПечатьБлокаДанных(rs);
      endaction;

      Report.PrintWinRep("Доходы и расходы по операциям РЕПО.");
      Report.SetWinRepOutput();
      Report.ShowWinRep();

end;  

END;

CLASS (TRsbPanel) Pan
    initTRsbPanel();


    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;
    const EndCalcDate_ID = 2;
    var curstr = 1;
    Caption = "Доходы и расходы по операциям РЕПО.";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, EndCalcDate, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    EndCalcDate = TRsbEditField(V_DATE);
    EndCalcDate.setPosition(27,curstr);
    EndCalcDate.setSize(8,1);
    EndCalcDate.name = "endincalcdate";
    EndCalcDate.value = {curdate};
    addControl(EndCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr," За период:");
    addLabel (m_LabelCD);

    var m_LabelT:TrsbLabel = TRsbLabel(25,curstr,"~");
    addLabel (m_LabelT);
 
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));


    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if ((ev.id == BeginCalcDate_ID) or (ev.id == EndCalcDate_ID ))
            BeginCalcDate.value = GetDateByCalendar({CurDate});
//            EndCalcDate.value   = BeginCalcDate.value + Delta;
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
//            EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
  //       EndCalcDate.value   = BeginCalcDate.value + Delta;
        
         var myRep = OfferRep(BeginCalcDate.value, EndCalcDate.value);
         myRep.run;
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);
