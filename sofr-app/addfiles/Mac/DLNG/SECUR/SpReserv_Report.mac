 /*
 $Name: SpReserv_Report.mac
 $Module: Ценные бумаги
 $Description: Печать протокола операции резервирования
 */

import "DLReport_h.mac", "dlquery.mac", "spserv.mac";

macro КоличествоЗначащихРазрядовРезерв(str:string)
  var len;
  var i = 0;

  str = trim(str);
  len = strlen(str);
  while(i < len)
    if(substr(str, len-i, 1) != "0")
      if(substr(str, len-i, 1) != ".")
        return len-i;
      else
        return (len-i)-1;
      end;
    end;

    i = i + 1;

  end;

  return len;
end;

CLASS (DL_CReportTemplate) SP_Reserv_Report(_ScOprServDoc)
   var ScOprServDoc = _ScOprServDoc;
   var FirstRowNum = 2;
   var CurRowNum = FirstRowNum;

   PRIVATE MACRO PrintMode()
      return DL_OUTREPORT_EXCEL;
   end;

   macro BeginReport()
      CreateTotalBook();
   end;

   private macro PrintCBProtocol()
      var OldIssue = -1, OldPortfolio = -1, OldResKind = -1, OldIsBPP = -1;
      var ItogReserv = 0, ItogOldReserv = 0, ItogReservChange = 0, ItogSum = 0, ItogReservOR = 0, ItogOldReservOR = 0, ItogReservChangeOR = 0, ItogSumOR = 0;
      var FirstRowNumIssue = 0, FirstRowNumPortf = 0, FirstRowNumResKind = 0;
      var CurRowNumIssue = 0, CurRowNumPortf = 0, CurRowNumResKind = 0;
      var queryDel = "DELETE FROM DSPRESERVREP_TMP tmp WHERE tmp.T_SUM = 0"
                   + " AND EXISTS ( SELECT 1 FROM  DSPRESERVREP_TMP REP1 "
                   + " WHERE REP1.T_ACC = tmp.T_ACC"
                   + " AND REP1.T_OBJID = tmp.T_OBJID "
                   + " AND REP1.T_PORTFOLIO = tmp.T_PORTFOLIO "
                   + " AND REP1.T_ISBPP = tmp.T_ISBPP "
                   + " AND REP1.T_SUM <> 0"
                   + ")"
      ; 
      SQL_Execute(queryDel);

      CopyAllSheetInTotalBook("Протокол", false, "N1_Header1", 0, NULL, false);

      RegisterTable("N1_MainTable1", NULL,
                    "N1_Issue",
                    "N1_Portfolio",
                    "N1_AccNum",
                    "N1_RestAcc",
                    "N1_ResKind",
                    "N1_QualCat",
                    "N1_ResPer",
                    "N1_SumRes",
                    "N1_OldRes",
                    "N1_CorSum",
                    "N1_Sum",
                    "N1_DbtAcc",
                    "N1_CredAcc");

      var TmpDataQuery =   "SELECT (fininstr.t_Name || '/' || avoiriss.t_ISIN) as t_Issue,"
                         + "       reservrep.t_Portfolio, "
                         + "       reservrep.t_IsBPP, "
                         + "       reservrep.t_Acc, "
                         + "       reservrep.t_RestAcc, "
                         + "       reservrep.t_ResKind, "
                         + "       reservrep.t_QualCat, "
                         + "       reservrep.t_ResPer, "
                         + "       reservrep.t_Reserv, "
                         + "       reservrep.t_OldReserv, "
                         + "       reservrep.t_CorrSum, "
                         + "       reservrep.t_Sum, "
                         + "       reservrep.t_DebAcc, "
                         + "       reservrep.t_CredAcc "
                         + "FROM DSPRESERVREP_TMP reservrep, DFININSTR_DBT fininstr, DAVOIRISS_DBT avoiriss "
                         + "WHERE fininstr.t_FIID = reservrep.t_ObjID "
                         + "  and avoiriss.t_FIID = reservrep.t_ObjID "
                         + "ORDER BY t_Issue, t_Portfolio, t_IsBPP, t_Priority, t_ResKind ";
      var TmpDataSelect = DL_RSDCommand(TmpDataQuery);
      var TmpDataDS = TmpDataSelect.execute();
      var IsFirst = true;
      while(TmpDataDS.MoveNext())
         var KindPortfStr = "";
         if(TmpDataDS.Portfolio != -1)
            SP_GetValueLL(1100, int(TmpDataDS.Portfolio), @KindPortfStr);
            if(TmpDataDS.IsBPP == 1)
              KindPortfStr = KindPortfStr + "_БПП" ;
            end;
         end;

         var ResKindStr = "";
         if(TmpDataDS.ResKind != OldResKind)
            if(TmpDataDS.ResKind == KINDRES_RCBUC)
              ResKindStr = "В ненадежных депозитариях";
            elif(TmpDataDS.ResKind == KINDRES_RVPCB)
              ResKindStr = "ПДД";
            elif(TmpDataDS.ResKind == KINDRES_RCB)
              ResKindStr = "Ц/б";
            elif(TmpDataDS.ResKind == KINDRES_ROCB)
              ResKindStr = "Оценочный резерв";
            end;
         end;
    var  str = ЧислоCЗаданнойТочностью(TmpDataDS.ResPer, 9);
    var точность = КоличествоЗначащихРазрядовРезерв(str);
    var ResPer  = substr ( str, 1, точность);

         if(TmpDataDS.Issue != OldIssue)
            if(not IsFirst)
               MergeRow("N1_Issue", "N1_Issue", FirstRowNumIssue, CurRowNumIssue);
               CurRowNumIssue = CurRowNumIssue + 1;
               FirstRowNumIssue = CurRowNumIssue;
               MergeRow("N1_Portfolio", "N1_Portfolio", FirstRowNumPortf, CurRowNumPortf);
               CurRowNumPortf = CurRowNumIssue;
               FirstRowNumPortf = FirstRowNumIssue;
               MergeRow("N1_ResKind", "N1_ResKind", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_QualCat", "N1_QualCat", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_ResPer", "N1_ResPer", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_SumRes", "N1_SumRes", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_OldRes", "N1_OldRes", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_CorSum", "N1_CorSum", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_Sum", "N1_Sum", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_DbtAcc", "N1_DbtAcc", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_CredAcc", "N1_CredAcc", FirstRowNumResKind, CurRowNumResKind);
               FirstRowNumResKind = FirstRowNumIssue;
               CurRowNumResKind = CurRowNumIssue;
            end;

            PrintTableLine("N1_Issue", TmpDataDS.Issue, NULL,
                           "N1_Portfolio", KindPortfStr, NULL,
                           "N1_AccNum", TmpDataDS.Acc, NULL,
                           "N1_RestAcc", TmpDataDS.RestAcc, NULL,
                           "N1_ResKind", ResKindStr, NULL,
                           "N1_QualCat", TmpDataDS.QualCat, NULL,
                           "N1_ResPer", ResPer, NULL,
                           "N1_SumRes", TmpDataDS.Reserv, NULL,
                           "N1_OldRes", TmpDataDS.OldReserv, NULL,
                           "N1_CorSum", TmpDataDS.CorrSum, NULL,
                           "N1_Sum", TmpDataDS.Sum, NULL,
                           "N1_DbtAcc", TmpDataDS.DebAcc, NULL,
                           "N1_CredAcc", TmpDataDS.CredAcc, NULL);

            ItogReserv = ItogReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Reserv);
            ItogOldReserv = ItogOldReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.OldReserv);
            ItogReservChange = ItogReservChange + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.CorrSum);
            ItogSum = ItogSum + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Sum);
            ItogReservOR = ItogReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Reserv, 0);
            ItogOldReservOR = ItogOldReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.OldReserv, 0);
            ItogReservChangeOR = ItogReservChangeOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.CorrSum, 0);
            ItogSumOR = ItogSumOR +  IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Sum, 0);
 
            OldIssue = TmpDataDS.Issue;
            OldPortfolio = TmpDataDS.Portfolio;
            OldResKind = TmpDataDS.ResKind;
            OldIsBPP   = TmpDataDS.IsBPP;
         else
            if(  (TmpDataDS.Portfolio != OldPortfolio) OR (OldIsBPP != TmpDataDS.IsBPP) )
               MergeRow("N1_Portfolio", "N1_Portfolio", FirstRowNumPortf, CurRowNumPortf);
               CurRowNumPortf = CurRowNumPortf + 1;
               FirstRowNumPortf = CurRowNumPortf;
               MergeRow("N1_ResKind", "N1_ResKind", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_QualCat", "N1_QualCat", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_ResPer", "N1_ResPer", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_SumRes", "N1_SumRes", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_OldRes", "N1_OldRes", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_CorSum", "N1_CorSum", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_Sum", "N1_Sum", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_DbtAcc", "N1_DbtAcc", FirstRowNumResKind, CurRowNumResKind);
               MergeRow("N1_CredAcc", "N1_CredAcc", FirstRowNumResKind, CurRowNumResKind);
               CurRowNumResKind = CurRowNumPortf;
               FirstRowNumResKind = CurRowNumResKind;
               PrintTableLine("N1_Issue", "", NULL,
                              "N1_Portfolio", KindPortfStr, NULL,
                              "N1_AccNum", TmpDataDS.Acc, NULL,
                              "N1_RestAcc", TmpDataDS.RestAcc, NULL,
                              "N1_ResKind", ResKindStr, NULL,
                              "N1_QualCat", TmpDataDS.QualCat, NULL,
                              "N1_ResPer", ResPer, NULL,
                              "N1_SumRes", TmpDataDS.Reserv, NULL,
                              "N1_OldRes", TmpDataDS.OldReserv, NULL,
                              "N1_CorSum", TmpDataDS.CorrSum, NULL,
                              "N1_Sum", TmpDataDS.Sum, NULL,
                              "N1_DbtAcc", TmpDataDS.DebAcc, NULL,
                              "N1_CredAcc", TmpDataDS.CredAcc, NULL);
   
               ItogReserv = ItogReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Reserv);
               ItogOldReserv = ItogOldReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.OldReserv);
               ItogReservChange = ItogReservChange + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.CorrSum);
               ItogSum = ItogSum + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Sum);
               ItogReservOR = ItogReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Reserv, 0);
               ItogOldReservOR = ItogOldReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.OldReserv, 0);
               ItogReservChangeOR = ItogReservChangeOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.CorrSum, 0);
               ItogSumOR = ItogSumOR +  IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Sum, 0);
   
               OldPortfolio = TmpDataDS.Portfolio;
               OldResKind = TmpDataDS.ResKind;
               OldIsBPP   = TmpDataDS.IsBPP;
            else
               if(TmpDataDS.ResKind != OldResKind)
                  MergeRow("N1_ResKind", "N1_ResKind", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_QualCat", "N1_QualCat", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_ResPer", "N1_ResPer", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_SumRes", "N1_SumRes", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_OldRes", "N1_OldRes", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_CorSum", "N1_CorSum", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_Sum", "N1_Sum", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_DbtAcc", "N1_DbtAcc", FirstRowNumResKind, CurRowNumResKind);
                  MergeRow("N1_CredAcc", "N1_CredAcc", FirstRowNumResKind, CurRowNumResKind);
                  CurRowNumResKind = CurRowNumResKind + 1;
                  FirstRowNumResKind = CurRowNumResKind;
                  PrintTableLine("N1_Issue", "", NULL,
                                 "N1_Portfolio", "", NULL,
                                 "N1_AccNum", TmpDataDS.Acc, NULL,
                                 "N1_RestAcc", TmpDataDS.RestAcc, NULL,
                                 "N1_ResKind", ResKindStr, NULL,
                                 "N1_QualCat", TmpDataDS.QualCat, NULL,
                                 "N1_ResPer", ResPer, NULL,
                                 "N1_SumRes", TmpDataDS.Reserv, NULL,
                                 "N1_OldRes", TmpDataDS.OldReserv, NULL,
                                 "N1_CorSum", TmpDataDS.CorrSum, NULL,
                                 "N1_Sum", TmpDataDS.Sum, NULL,
                                 "N1_DbtAcc", TmpDataDS.DebAcc, NULL,
                                 "N1_CredAcc", TmpDataDS.CredAcc, NULL);
      
                  ItogReserv = ItogReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Reserv);
                  ItogOldReserv = ItogOldReserv + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.OldReserv);
                  ItogReservChange = ItogReservChange + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.CorrSum);
                  ItogSum = ItogSum + IIF((TmpDataDS.ResKind == KINDRES_RCBUC) or (TmpDataDS.ResKind == KINDRES_ROCB), 0, TmpDataDS.Sum);
                  ItogReservOR = ItogReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Reserv, 0);
                  ItogOldReservOR = ItogOldReservOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.OldReserv, 0);
                  ItogReservChangeOR = ItogReservChangeOR + IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.CorrSum, 0);
                  ItogSumOR = ItogSumOR +  IIF(TmpDataDS.ResKind == KINDRES_ROCB, TmpDataDS.Sum, 0);
      
                  OldResKind = TmpDataDS.ResKind;
               else
                  PrintTableLine("N1_Issue", "", NULL,
                                 "N1_Portfolio", "", NULL,
                                 "N1_AccNum", TmpDataDS.Acc, NULL,
                                 "N1_RestAcc", TmpDataDS.RestAcc, NULL,
                                 "N1_ResKind", "", NULL,
                                 "N1_QualCat", "", NULL,
                                 "N1_ResPer", "", NULL,
                                 "N1_SumRes", "", NULL,
                                 "N1_OldRes", "", NULL,
                                 "N1_CorSum", "", NULL,
                                 "N1_Sum", "", NULL,
                                 "N1_DbtAcc", "", NULL,
                                 "N1_CredAcc", "", NULL);

                  CurRowNumResKind = CurRowNumResKind + 1;
               end;

               CurRowNumPortf = CurRowNumPortf + 1;
            end;

            CurRowNumIssue = CurRowNumIssue + 1;
         end;

         IsFirst = false;
      end;

      MergeRow("N1_Issue", "N1_Issue", FirstRowNumIssue, CurRowNumIssue);
      MergeRow("N1_Portfolio", "N1_Portfolio", FirstRowNumPortf, CurRowNumPortf);
      MergeRow("N1_ResKind", "N1_ResKind", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_QualCat", "N1_QualCat", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_ResPer", "N1_ResPer", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_SumRes", "N1_SumRes", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_OldRes", "N1_OldRes", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_CorSum", "N1_CorSum", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_Sum", "N1_Sum", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_DbtAcc", "N1_DbtAcc", FirstRowNumResKind, CurRowNumResKind);
      MergeRow("N1_CredAcc", "N1_CredAcc", FirstRowNumResKind, CurRowNumResKind);

      EndTable();

      CopyAllSheetInTotalBook("Протокол", false, GetTableRange(), 0, NULL, false);

      PrintFormatString(NULL, "N1_F11", ItogReserv,
                              "N1_F12", ItogOldReserv,
                              "N1_F13", ItogReservChange,
                              "N1_F14", ItogSum,
                              "N1_G11", ItogReservOR,
                              "N1_G12", ItogOldReservOR,
                              "N1_G13", ItogReservChangeOR,
                              "N1_G14", ItogSumOR);

      CopyAllSheetInTotalBook("Протокол", false, "N1_ItogLine1", 0, NULL, false);
   end;

   private macro PrintReqNotRepo2Protocol():bool
      var IsFirstRow = true;

      var TmpReqQuery =  "select tick.t_DealCode, "
                       + "       party.t_ShortName, "
                       + "       reservrep.t_BaseAcc, "
                       + "       reservrep.t_ReservAcc, "
                       + "       reservrep.t_QualCat, "
                       + "       reservrep.t_ResPer, "
                       + "       reservrep.t_BaseSum, "
                       + "       reservrep.t_Reserv, "
                       + "       reservrep.t_GuarantSum, "
                       + "       reservrep.t_OldReserv, "
                       + "       reservrep.t_CorrSum, "
                       + "       reservrep.t_ResKind "
                       + "from dspreservrep_tmp reservrep, ddl_tick_dbt tick, dparty_dbt party "
                       + "where tick.t_DealID = reservrep.t_ObjID "
                       + "  and party.t_PartyID = reservrep.t_Party";

      var TmpReqSelect = DL_RSDCommand(TmpReqQuery);
      var TmpReqDS = TmpReqSelect.execute();
      while(TmpReqDS.MoveNext())
         if(TmpReqDS.ResKind != KINDRES_SALEREPO2)
            if(IsFirstRow)
               CopyAllSheetInTotalBook("Протокол", false, "N1_Header2", 0, NULL, false);
               RegisterTable("N1_MainTable2", NULL,
                             "N1_E1",
                             "N1_E2",
                             "N1_E3",
                             "N1_A3",
                             "N1_A4",
                             "N1_A5",
                             "N1_A6",
                             "N1_A7",
                             "N1_E4",
                             "N1_A8",
                             "N1_A9");

               IsfirstRow = false;
            end;

            PrintTableLine("N1_E1", TmpReqDS.DealCode, NULL,
                           "N1_E2", TmpReqDS.ShortName, NULL,
                           "N1_E3", TmpReqDS.BaseAcc, NULL,
                           "N1_A3", TmpReqDS.ReservAcc, NULL,
                           "N1_A4", TmpReqDS.QualCat, NULL,
                           "N1_A5", TmpReqDS.ResPer, NULL,
                           "N1_A6", TmpReqDS.BaseSum, NULL,
                           "N1_A7", TmpReqDS.Reserv, NULL,
                           "N1_E4", TmpReqDS.GuarantSum, NULL,
                           "N1_A8", TmpReqDS.OldReserv, NULL,
                           "N1_A9", TmpReqDS.CorrSum, NULL);
         else
            return false;
         end;
      end;
      if(IsFirstRow != true) // если есть записи
        EndTable();
        CopyAllSheetInTotalBook("Протокол", false, GetTableRange(), 0, NULL, false);
      end;
      return true;
   end;

   private macro PrintReqRepo2Protocol():bool
      var FirstRowNumber = -1, CurRowNumber = -1;
      var ReservAcc = "", BaseAcc = "";
      var ind = 0;
      var IsFirstRow = true;

      var TmpRepoQuery =  "select tick.t_DealCode, "
                        + "       party.t_ShortName, "
                        + "       reservrep.t_BaseAcc, "
                        + "       reservrep.t_ReservAcc, "
                        + "       reservrep.t_QualCat, "
                        + "       reservrep.t_ResPer, "
                        + "       reservrep.t_BaseSum, "
                        + "       reservrep.t_Reserv, "
                        + "       reservrep.t_GuarantSum, "
                        + "       reservrep.t_OldReserv, "
                        + "       reservrep.t_CorrSum, "
                        + "       reservrep.t_ResKind, "
                        + "       reservrep.t_ObjID as t_DealID, "
                        + "       reservrep.t_Party "
                        + "from dspreservrep_tmp reservrep, ddl_tick_dbt tick, dparty_dbt party "
                        + "where tick.t_DealID = reservrep.t_ObjID "
                        + "  and party.t_PartyID = reservrep.t_Party";

      var TmpRepoSelect = DL_RSDCommand(TmpRepoQuery);
      var TmpRepoDS = TmpRepoSelect.execute();

      var OldDealID = -1, OldPartyID = -1, OldReservAcc = "", OldQualCat = -1, OldResPer = -1, OldBaseSum = -1, Old_Reserv = -1, Old_OldReserv = -1, OldCorrSum = -1;
      while(TmpRepoDS.MoveNext())
         if(TmpRepoDS.ResKind == KINDRES_SALEREPO2)
            if(IsFirstRow)
               CopyAllSheetInTotalBook("Протокол", false, "N1_Header3", 0, NULL, false);
   
               RegisterTable("N1_MainTable3", NULL,
                             "N1_D1",
                             "N1_D2",
                             "N1_A3_1",
                             "N1_D3",
                             "N1_D4",
                             "N1_D5",
                             "N1_D6",
                             "N1_D7",
                             "N1_A8_1",
                             "N1_D8");
   
               IsFirstRow = false;
            end;
            if((TmpRepoDS.DealID == OldDealID) and (TmpRepoDS.Party == OldPartyID) and (ReservAcc == OldReservAcc) and (TmpRepoDS.Reserv == Old_Reserv) and (TmpRepoDS.OldReserv == Old_OldReserv) and (TmpRepoDS.CorrSum == OldCorrSum))
               PrintTableLine("N1_D1", "", NULL,
                              "N1_D2", "", NULL,
                              "N1_A3_1", "", NULL,
                              "N1_D3", TmpRepoDS.BaseAcc, NULL,
                              "N1_D4", TmpRepoDS.QualCat, NULL,
                              "N1_D5", TmpRepoDS.ResPer, NULL,
                              "N1_D6", TmpRepoDS.BaseSum, NULL,
                              "N1_D7", "", NULL,
                              "N1_A8_1", "", NULL,
                              "N1_D8", "", NULL);

               CurRowNumber = CurRowNumber + 1;
               MergeRow("N1_D1", "N1_D1", FirstRowNumber, CurRowNumber);
               MergeRow("N1_D2", "N1_D2", FirstRowNumber, CurRowNumber);
               MergeRow("N1_A3_1", "N1_A3_1", FirstRowNumber, CurRowNumber);
               MergeRow("N1_D7", "N1_D7", FirstRowNumber, CurRowNumber);
               MergeRow("N1_A8_1", "N1_A8_1", FirstRowNumber, CurRowNumber);
               MergeRow("N1_D8", "N1_D8", FirstRowNumber, CurRowNumber);

               OldQualCat = TmpRepoDS.QualCat;
               OldResPer = TmpRepoDS.ResPer;
               OldBaseSum = TmpRepoDS.BaseSum;
            else
               ReservAcc = "";
               BaseAcc = "";
               ind = index(TmpRepoDS.BaseAcc, "|");
               if(ind == 0)
                 BaseAcc = TmpRepoDS.BaseAcc;
               else
                 BaseAcc = substr(TmpRepoDS.BaseAcc, 1, ind);
                 TmpRepoDS.BaseAcc = substr(TmpRepoDS.BaseAcc, ind+1);
               end;
       
               ind = index(TmpRepoDS.ReservAcc, "|");
               if(ind == 0)
                 ReservAcc = TmpRepoDS.ReservAcc;
               else
                 ReservAcc = substr(TmpRepoDS.ReservAcc, 1, ind - 1);
                 TmpRepoDS.ReservAcc = substr(TmpRepoDS.ReservAcc, ind + 1);
               end;

               CurRowNumber = CurRowNumber + 1;
               FirstRowNumber = CurRowNumber;
               PrintTableLine("N1_D1", TmpRepoDS.DealCode, NULL,
                              "N1_D2", TmpRepoDS.ShortName, NULL,
                              "N1_A3_1", ReservAcc, NULL,
                              "N1_D3", BaseAcc, NULL,
                              "N1_D4", TmpRepoDS.QualCat, NULL,
                              "N1_D5", TmpRepoDS.ResPer, NULL,
                              "N1_D6", TmpRepoDS.BaseSum, NULL,
                              "N1_D7", TmpRepoDS.Reserv, NULL,
                              "N1_A8_1", TmpRepoDS.OldReserv, NULL,
                              "N1_D8", TmpRepoDS.CorrSum, NULL);

               var ind_b = index(TmpRepoDS.BaseAcc, "|");
               var ind_r = index(TmpRepoDS.ReservAcc, "|");
               ind = IIF(ind_b>ind_r,ind_b,ind_r);
               while(ind)
       
                  if( ind_r > 0 )
                     ReservAcc = substr(TmpRepoDS.ReservAcc, 1, ind_r - 1);
                     TmpRepoDS.ReservAcc = substr(TmpRepoDS.ReservAcc, ind_r + 1);
                  else
                     ReservAcc = TmpRepoDS.ReservAcc = " ";
                  end;
       
                  if( ind_b > 0 )
                     BaseAcc = substr(TmpRepoDS.BaseAcc, 1, ind_b);
                     TmpRepoDS.BaseAcc = substr(TmpRepoDS.BaseAcc, ind_b+1);
                  else
                     BaseAcc = TmpRepoDS.BaseAcc = " ";
                  end;
                  
                  PrintTableLine("N1_D1", "", NULL,
                                 "N1_D2", "", NULL,
                                 "N1_A3_1", ReservAcc, NULL,
                                 "N1_D3", BaseAcc, NULL,
                                 "N1_D4", "", NULL,
                                 "N1_D5", "", NULL,
                                 "N1_D6", "", NULL,
                                 "N1_D7", "", NULL,
                                 "N1_A8_1", "", NULL,
                                 "N1_D8", "", NULL);

                  CurRowNumber = CurRowNumber + 1;
                  MergeRow("N1_D1", "N1_D1", FirstRowNumber, CurRowNumber);
                  MergeRow("N1_D2", "N1_D2", FirstRowNumber, CurRowNumber);
                  MergeRow("N1_D4", "N1_D4", FirstRowNumber, CurRowNumber);
                  MergeRow("N1_D5", "N1_D5", FirstRowNumber, CurRowNumber);
                  MergeRow("N1_D6", "N1_D6", FirstRowNumber, CurRowNumber);
                  MergeRow("N1_D7", "N1_D7", FirstRowNumber, CurRowNumber);
                  MergeRow("N1_A8_1", "N1_A8_1", FirstRowNumber, CurRowNumber);
                  MergeRow("N1_D8", "N1_D8", FirstRowNumber, CurRowNumber);
                  
                  ind_b = index(TmpRepoDS.BaseAcc, "|");
                  ind_r = index(TmpRepoDS.ReservAcc, "|");
                  ind = IIF(ind_b>ind_r,ind_b,ind_r);
               end;

               OldDealID = TmpRepoDS.DealID;
               OldPartyID = TmpRepoDS.Party;
               OldReservAcc = ReservAcc;
               OldQualCat = TmpRepoDS.QualCat;
               OldResPer = TmpRepoDS.ResPer;
               OldBaseSum = TmpRepoDS.BaseSum;
               Old_Reserv = TmpRepoDS.Reserv;
               Old_OldReserv = TmpRepoDS.OldReserv;
               OldCorrSum = TmpRepoDS.CorrSum;
            end;
         else
            return false;
         end;
      end;

      if(IsFirstRow != true) // если есть записи
        EndTable();
        CopyAllSheetInTotalBook("Протокол", false, GetTableRange(), 0, NULL, false);
      end;
      return true;
   end;

   macro Create()
      SetActiveSheet("Протокол");

      PrintFormatString(NULL, "N1_H12", ScOprServDoc.CommCode,
                              "N1_H13", ScOprServDoc.CommDate);

      CopyAllSheetInTotalBook(NULL, false, "N1_TotalHeader", 0);

      if(ScOprServDoc.OperationKind == KINDRES_RCB)
         PrintCBProtocol();
      elif(ScOprServDoc.OperationKind == KINDRES_REQ)
         if(not PrintReqNotRepo2Protocol())
            PrintReqRepo2Protocol();
         end;
      end;
   end;

   macro EndReport()
      SaveTotalBook();
   end;

   initDL_CReportTemplate(NULL, "Report_SpReserv.xls", true);
END;
