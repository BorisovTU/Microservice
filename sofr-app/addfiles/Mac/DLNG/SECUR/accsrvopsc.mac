/*******************************************************************************
 FILE         :   accsrvopsc.mac
 COPYRIGHT    :   R-Style, 2013
 DESCRIPTION  :   Макрос скролинга операций бухгалтерского учета БОЦБ
 PROGRAMMED BY:   Nikonorov Evgeny
 CREATION DATE:   07.06.2013
*******************************************************************************/
import DealsInter, SPInter, PTInter, globals;
import RsbDataSet;
import "dlQuery.mac";

/* Уже заполненные структуры, все изменения отразятся в базах */
PRIVATE VAR Документ         = TRecHandler( "dl_comm" );
PRIVATE VAR СтарыйДокумент   = TRecHandler( "dl_comm" ); /* заполняется при редактировании */

/* Макрофункция инициализации нового актива 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Новый_Документ()
  
  return 0;
END;

private macro Проверить_Документ( Режим:integer )
  if(Режим == 3) //редактирование операции

    //здесь должны быть проверки при редактировании

  elif(Режим == 1) //удаление
    
    //здесь должны быть проверки при удалении

  end;

  return 0;
end;

/* Установка подсказки для скролингов из макроса */
private MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string

  //пример
  //return "/*+FIRST_ROWS LEADING(t) INDEX(t ddl_comm_dbt_idx0)*/";

  return DefaultHint;

END;

/* Вызывается по CTRL+Z из скроллинга */
private macro Функция_Пользователя()

  macro getDocumentName(id)
    var query = "select * from doprkdoc_dbt where t_dockind = " + id;
    var cmd = RSDCommand(query);
    var rs = RSDRecordSet(cmd);
    if (rs.movenext)
      return rs.value("t_name");
    else
      return "";
    end; 
  end;

  //MsgBox( "Выполняется макрофункция \"accsrvopsc.mac\\ Функция_Пользователя\"." );
  var query = " SELECT 1                                                      " +
              "   FROM dacsgroup_dbt acsgroup, dacsgroupoper_dbt acsgroupoper " +
              "  WHERE acsgroup.t_groupid = acsgroupoper.t_groupid            " +
              "        AND acsgroup.t_name = '[10] Прикладной администратор'  " +
              "        AND acsgroupoper.t_oper = :1                           ";
  var cmd = DL_RSDCommand(query);
      cmd.AddParam({oper});

  var DataSet = cmd.Execute();
  if(DataSet.movenext)
     if(MsgBoxEx("Изменить статус операции на \"Закрыта\"? | Перед выполнением этого действия необходимо убедиться, что нет сессий, которые выполняют операцию", MB_ERROR + MB_YES + MB_NO, IND_NO) == IND_YES)
         if(Документ.rec.commstatus == 2)

             MsgBoxEx("Операция уже закрыта", MB_ERROR);
             return 0;
         end;

         WriteFiscLog(OLstrproc, "Старт закрытия сервисной операции. Имя файла - dl_comm_dbt. ID операции "+Документ.rec.documentid+
           ". Тип операции "+Документ.rec.dockind+" "+getDocumentName(Документ.rec.dockind)+
           ". Код операции "+Документ.rec.commcode); 

         rsdCommand("update ddl_comm_dbt set t_commstatus = 2 where t_documentid = "+int(Документ.rec.documentid)).execute;

         WriteFiscLog(OLfinproc, "Окончание закрытия сервисной операции. Имя файла - dl_comm_dbt. ID операции "+Документ.rec.documentid+
           ". Тип операции "+Документ.rec.dockind+" "+getDocumentName(Документ.rec.dockind)+
           ". Код операции "+Документ.rec.commcode); 

     end; 
  end;

  return 0;
end;
