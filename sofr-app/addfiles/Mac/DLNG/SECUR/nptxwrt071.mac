/*
$Name: nptxwrt071.mac
$Module: Ценные бумаги
$Description: Формирование записи в хранилище для операций списания/зачисления денежных средств
*/

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac", "nptxcalcfun.mac";

private macro Error( err, ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  if(err)
    MsgBox( ErrStr );
  end;
  return err;
end;

PRIVATE MACRO GetDlContrID(SfContrID:integer)
  var query, cmd, DataSet;
  var DlContrID = 0;

  if(SfContrID > 0)
    cmd = DL_RSDCommand();

    query = "select dlc.t_DlContrID from ddlcontr_dbt dlc where dlc.t_SfContrID = " + cmd.AddParam(SfContrID);

    DataSet = cmd.Execute(query);

    if(DataSet.moveNext())
      DlContrID = DataSet.DlContrID;
    end;

    if(DlCOntrID == 0)
      cmd = DL_RSDCommand();

      query = "select mp.t_DlContrID from ddlcontrmp_dbt mp where mp.t_SfContrID = " + cmd.AddParam(SfContrID);

      DataSet = cmd.Execute(query);

      if(DataSet.moveNext())
        DlContrID = DataSet.DlContrID;
      end;
    end;
  end;

  return DlContrID;
END;

PRIVATE MACRO GetDlCOntrIDByNPTXOP(nptxop)
  var op = TRecHandler("nptxop.dbt");
  var DlContrID = 0;

  copy(op, nptxop);

  if(op.rec.DocKind == DL_CALCNDFL)
    DlContrID = op.rec.Contract;
  else
    DlContrID = GetDlContrID(op.rec.Contract);
  end;

  return DlContrID;
END;

private macro isUseCorrForAddKBK(NpTxOpID)
  var query =   " select msg.t_Message "
              + "   from dnptxmes_dbt msg"
              + "  where msg.t_DocID = ? "
              + "    and msg.t_Type in (205) "
              + "    and msg.t_Message = 'X' "
              + " order by msg.t_ID ASC";

  var cmd = DL_RSDCommand(query);
  cmd.AddParam(NpTxOpID);
  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    return true;
  end;
  
  return false;
end;

private macro GetSumNOB(arr)
  var i = 0;
  var sum = $0;

  while(i < arr.size)
    sum = sum + arr[i].НОБ;
    i = i + 1;
  end;
  return sum;
end;

macro ExecuteStep( kind_oper, FDoc, DocKind, ID_Operation, ID_Step )
  record nptxop("nptxop");
  var ErrStr = "";
  var Year = 0;
  var err = 0;
  var TxArr = TArray();
  var CorrTxArr = TArray();
  var НОБ_опер = $0;

  SetBuff( nptxop, FDoc );

  if(nptxop.SubKind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY)

    DateSplit(nptxop.OperDate, null, null, Year);
    
    if(DL_GetPartyResident(nptxop.Client) == NPTXPARTY_RESIDENT)
      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT*100),
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_13), 
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TAXE));

      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_15), 
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TAXE_15));
    else
      TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_NOTRESIDENT*100),
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_30), 
                                          STB_GetSavedNptxval(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TAXE));
    end;

    GetLastOpSTBVal(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_Oper, @НОБ_опер);
    
    STB_GetTxArrFromMsg(nptxop.ID, @CorrTxArr);
    
    if(isUseCorrForAddKBK(nptxop.ID) and (CorrTxArr.size))
      НОБ_опер = НОБ_опер + GetSumNOB(CorrTxArr);
      var iCorr = 0;
      while(iCorr < CorrTxArr.size)
        TxArr[TxArr.size] = STB_TaxRateParm(CorrTxArr[iCorr].Ставка,
                                            CorrTxArr[iCorr].НОБ, 
                                            CorrTxArr[iCorr].Налог,
                                            CorrTxArr[iCorr].КБК,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            "C");
        iCorr = iCorr + 1;
      end;
      CorrTxArr.size = 0;
    end;

    err = STB_ExecuteCreateSTBOnStep(TxArr,
                                     НОБ_опер, 
                                     nptxop.DocKind, 
                                     nptxop.ID, 
                                     nptxop.Client, 
                                     nptxop.OperDate, 
                                     IIF(nptxop.IIS == SET_CHAR, true, false), 
                                     Year, 
                                     ID_Operation, 
                                     ID_Step, 
                                     @ErrStr,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     NULL,
                                     IIF(nptxop.IIS == SET_CHAR, GetDlCOntrIDByNPTXOP(nptxop), NULL),
                                     GetSpecialTagByOper(nptxop, STB_GetTaxBaseKindByDocKind(nptxop.DocKind, IIF(nptxop.IIS == SET_CHAR, true, false))));


    if(ErrStr)
      err = Error(err, ErrStr);
    end;

    if(not err)
      if(CorrTxArr.size)
        err = STB_ExecuteCreateSTBOnStep(CorrTxArr,
                                         $0, 
                                         nptxop.DocKind, 
                                         nptxop.ID, 
                                         nptxop.Client, 
                                         nptxop.OperDate, 
                                         IIF(nptxop.IIS == SET_CHAR, true, false), 
                                         Year, 
                                         ID_Operation, 
                                         ID_Step, 
                                         @ErrStr,
                                         NULL,
                                         NULL,
                                         $0);
        if(ErrStr)
          err = Error(err, ErrStr);
        end;
      end;
    end;
  end;

  return err;
end;

