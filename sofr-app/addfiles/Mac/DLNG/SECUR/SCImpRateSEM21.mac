/**                                                                                                             
 @file  SCImpRateSEM21.mac                                                                                           
 @brief Загрузка курсов ММВБ, XML формат SEM21 

 #menu 
  - БО ЦБ\Справочники\Импорт котировок с ММВБ (скорее всего в настоящий момент в Банке не используется)                                                                         
                                                                                                                
 #tag                                                                                                          
 - functional_block:Ценные бумаги                                                                             
 - code_type:GUI 
 - code_type:API                                                                                                                                                                                               
                                                                                                                
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2024.02.27 |Жиц М.В.       |DEF-60763           |Изменение загрузки котировок с ММВБ в СОФР для ц/б с номиналом в рублях, добавление шапки макроса                                                                                                                                                  
 |?          |?              |?                   |Создание макроса                                                                                                                                                                                                                                                                                                    
*/ 

IMPORT "XMLLoader.mac", "SCImpRate.mac";
/*ak*/
import gtdlfun_u;
/*~ak*/

PRIVATE VAR   FlagCtrlBrk = false;
PRIVATE CONST CtrlBrkErr  = 17;

PRIVATE CONST Код_на_ММВБ_ФинИн   = 11;
PRIVATE CONST Код_на_ММВБ_Субъект = 8;

PRIVATE CONST RATE_KIND_MARKET  = 1;  /*курс вида "Рыночная цена"         */        
PRIVATE CONST RATE_KIND_MIN     = 2;  /*курс вида "Минимальная цена"      */
PRIVATE CONST RATE_KIND_MAX     = 3;  /*курс вида "Максимальная цена"     */
PRIVATE CONST RATE_KIND_WA      = 4;  /*курс вида "Средневзвешенная цена" */
PRIVATE CONST RATE_KIND_NKD1SEC = 15; /*курс вида "НКД на одну бумагу"    */
PRIVATE CONST RATE_KIND_VOLUME  = 17; /*курс вида "Объём торгов"          */
PRIVATE CONST RATE_KIND_MARKET_TAX = 21; /*курс вида "Рыночная цена для НДФЛ"*/

PRIVATE CLASS (SC_ImportRate) SC_ImportRateSEM21()

  PRIVATE CLASS DataRates()
    var TradeDate   :date,
        BoardType   :string,
        SecurityId  :string,
        SecurityType:string,
        Decimals    :integer,
        Volume      :integer,
        CurrencyId  :string,
        FaceUnit    :string,
        Low         :double,
        High        :double,
        WAPrice     :double,
        AccInt      :double,
        MarketPrice :double,
        BoardID     :string,
        MarketPrice3:double,
        PriceType   :string,
        FaceValue   :double;

    macro Init()
       MarketPrice = WAPrice      = AccInt     = High      = Low = MarketPrice3 = FaceValue = 0.0;
       SecurityId  = SecurityType = CurrencyId = FaceUnit = BoardType = BoardID = PriceType = "";
       Decimals    = Volume       = 0;
       TradeDate   = date(0,0,0);
    end;

    macro InitRecords()
       MarketPrice = WAPrice      = AccInt     = High = Low = MarketPrice3 = FaceValue = 0.0;
       SecurityId  = SecurityType = CurrencyId = FaceUnit = PriceType = "";
       Decimals    = Volume       = 0;
    end;

  end;

  PRIVATE VAR Rates = DataRates();

  /* настраиваемый пользователем макрос формирования
     имен файла котировок и сделок с госбумагами с ММВБ */
  MACRO GetDataFileName( datafilepath:@string, fname:@string ):BOOL
     var ErrStr = "";

/*ak
     datafilepath = GetRegImportDir( "MICEX", @ErrStr );

     if( ErrStr != "" )
        errmsg = ErrStr;
        return false;
     end;

     datafilepath = datafilepath + "QUOTESX" + "\\";*/
     datafilepath = GetRegImportDirU(strImpDate(), @ErrStr);
/*!ak*/

     var datafilemask = "???????_" + "SEM21" + "_00T_" + strImpDate() + "_?????????" + ".xml";
     var List = TDirList ( datafilepath + datafilemask, "f" );

     List.Sort(0);

     if (List.Count == 0)
        fname = "";
        MsgBox( "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask );
        return false;
     end;

     fname = List.name(0);
     return true;
  END;

  PRIVATE MACRO RunImp( RateKind:INTEGER, RateValue:DOUBLE ):INTEGER
     VAR IsRelative, IsDominant, imp_date, MMVB_NumSection, SecType, CurRate;
     record fin ("fininstr");
     
     /* Признак: цена задана в процентах от номинала */
     if( (StrUpr(Rates.PriceType) == "PERC") and (RateKind != RATE_KIND_NKD1SEC) )
        IsRelative = true;
     else
        IsRelative = false;
     end;

     if( RateKind == RATE_KIND_MARKET ) /*вид котировки - рыночная цена, значит устанавливаем признак основного курса*/
        IsDominant = true;
     else
        IsDominant = false;
     end;   

     if( Rates.TradeDate != date(0,0,0) )
        imp_date = Rates.TradeDate;
     else
        imp_date = ImpDate();
     end;

     /*Сектор биржи*/
     if( MarketCode() == MICEX_CODE_FB )
        MMVB_NumSection = СекторФонд;
     elif( MarketCode() == MICEX_CODE )
        MMVB_NumSection = СекторГосЦБ;
     else
        MMVB_NumSection = 0;
     end;

/*По валютным бумагам Курс НКД на 1 ЦБ не грузим. Инцидент IM2765454 */

     If(ПолучитьФинИН(Rates.SecurityId,fin, null, null, null, Код_на_ММВБ_ФинИн) == 0);
        If((fin.facevaluefi != 0) and (RateKind == RATE_KIND_NKD1SEC) )
           return 0;
        end;
     end;

     if( (RateKind == RATE_KIND_MARKET) or (RateKind == RATE_KIND_MARKET_TAX) )
        SecType = StrUpr(Rates.SecurityType);
        if( (SecType == "ОБ") and (Rates.FaceUnit != "RUR") and (Rates.FaceUnit != "RUB") )
           CurRate = Rates.FaceUnit;
        elif( (SecType == "АО") or (SecType == "АП") or (SecType == "ИП") or (SecType == "ИФ") or (SecType == "ДР") )
           CurRate = "RUR";
        else
           CurRate = Rates.CurrencyId;
        end;
     else
        CurRate = Rates.CurrencyId;
     end;

     if( ImportOneCourse( Rates.SecurityId,        // Код ФИ (Базовый ФИ)
                          Код_на_ММВБ_ФинИн,       // Вид кода ФИ (FICK_...)
                          RateKind,                // Вид курса
                          IsRelative,              // Признак относительной котировки
                          IsDominant,              // Признак основного курса
                          false,                   // Признак обратной котировки
                          1,                       // Масштаб курса
                          Rates.Decimals,          // Количество значащих цифр
                          imp_date,                // Дата установки курса
                          CurRate,                 // Код валюты котировки (Котируемый ФИ)
                          Код_на_ММВБ_ФинИн,       // Вид кода валюты котировки (FICK_...)
                          MarketCode(),            // Код торговой площадки
                          Код_на_ММВБ_Субъект,     // Вид кода субъекта торговой площадки (PTCK_...)
                          MMVB_NumSection,         // Сектор торговой площадки
                          RateValue,               // Значение курса
                          null,                    // Возможность надежного определения справедливой стоимости
                          Rates.BoardID            // Режима торгов
                        ) == false )
        return 1;
     end;     
     return 0;

  OnError(ErObj)

     Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  PRIVATE MACRO ImpNomForIndexNom():INTEGER

     var ErrMsg = "", imp_date;

     if( Rates.TradeDate != date(0,0,0) )
        imp_date = Rates.TradeDate;
     else
        imp_date = ImpDate();
     end;

     InstLoadModule("gtdlfun.mac");
     if( ExecMacro2("ЗагрузитьНоминалДляОФЗИНЗаДату", m_BaseAvoir, Rates.FaceValue, imp_date, @ErrMsg) != 0 ) 
        Warning("Ошибка загрузки номинала за дату по ц/б с кодом \""+ ПолучитьКодФинИн(m_BaseAvoir.rec.FIID)+"\"."+ErrMsg);
     elif( ErrMsg != "" )
        msgbox(ErrMsg);
     end;

     return 0;

  OnError(ErObj)

     Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

     if(ErObj.Code == CtrlBrkErr)
        FlagCtrlBrk = true;
     else
        RemProgress();
        RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
     end;
     return ErObj.Code;
  end;

  MACRO LoadFromFile():bool
     var xml:object = ActiveX( "MSXML.DOMDocument" );
     var node:object, child_MicexDoc:object, child_Sem21:object, child_Board:object, child_SessionNo:object;
     var DOC_REQUISITES = false, SEM21 = false, SessionNo:integer = -1;
     var i=0, j=0, k=0, s=0;

     Rates.Init();

     /* откроем файл импорта */
     if( not xml.load( DataFileName() ) )
       return Error(string( "Неверный формат файла импорта|", DataFileName(), "|Невозможно загрузить xml-документ" ));
     end;
     node = xml.DocumentElement;
     /* считаем параметры котировок */
     i=0;
     while( i < node.childNodes.length ) /* бегаем по MICEX_DOC */
        child_MicexDoc = node.childNodes.item(i);
        if(child_MicexDoc and (child_MicexDoc.nodeType==CHILD_NODE))

           if(child_MicexDoc.tagname == "DOC_REQUISITES")
              if(DOC_REQUISITES)
                 return Error( DataFileName() + ": Блок MICEX_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре");
              end;
              DOC_REQUISITES = true;
           end;

           if(child_MicexDoc.tagname == "SEM21")
              if(SEM21)
                 return Error( DataFileName(), ": Блок MICEX_DOC\SEM21 должен присутствовать в единственном экземпляре");
              end;
              SEM21 = true;
              Rates.TradeDate = date(0,0,0);
              if(ReadTagAttribut(child_MicexDoc, "TRADEDATE", V_DATE, Rates.TradeDate) == false)
                 /* если не нашли дату предоставления информации */
              end;
              j=0;

              while(j<child_MicexDoc.childNodes.length) /* бегаем по SEM21 */
                 child_Sem21 = child_MicexDoc.childNodes.item(j);
                 if(child_Sem21 and (child_Sem21.nodeType==CHILD_NODE))
                    if(child_Sem21.tagname == "SESSION")
                       SessionNo = -1;
                       if(ReadTagAttribut(child_Sem21, "SESSIONNO", V_INTEGER, SessionNo) == false)
                       end;
                       if( SessionNo == 3 )/*берем данные только итоговой сессии*/
                          s=0;

                          InitProgress(child_Sem21.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр режимов торгов...");

                          while(s<child_Sem21.childNodes.length) /* бегаем по SEM21 */
                             child_SessionNo = child_Sem21.childNodes.item(s);
                             if(child_SessionNo and (child_SessionNo.nodeType==CHILD_NODE))

                                if(child_SessionNo.tagname == "BOARD")
                        Rates.BoardID = "";
                                    if(ReadTagAttribut(child_SessionNo, "BOARDID", V_STRING, Rates.BoardID) == false)
                           /* если не нашли идентификатор режима торгов */
                        end;
                        Rates.BoardType = "";
                                    if(ReadTagAttribut(child_SessionNo, "BOARDTYPE", V_STRING, Rates.BoardType) == false)
                           /* если не нашли режим торгов */
                        end;
                        if(Rates.BoardType == "MAIN") /*если основной режим торгов*/
                            k=0;
                                        InitProgress(child_SessionNo.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр записей котировок...");
                                        while(k<child_SessionNo.childNodes.length) /* бегаем по BOARD */
                                           child_Board = child_SessionNo.childNodes.item(k);
                               if(child_Board and (child_Board.nodeType==CHILD_NODE))

                                   if(child_Board.tagname == "RECORDS")
                                       Rates.InitRecords();
                                       if(ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Rates.SecurityId) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "SECURITYTYPE", V_STRING, Rates.SecurityType) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "DECIMALS", V_INTEGER, Rates.Decimals) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "VOLUME", V_INTEGER, Rates.Volume) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "CURRENCYID", V_STRING, Rates.CurrencyId) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "FACEUNIT", V_STRING, Rates.FaceUnit) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "LOW", V_DOUBLE, Rates.Low) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "HIGH", V_DOUBLE, Rates.High) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "WAPRICE", V_DOUBLE, Rates.WAPrice) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "ACCINT", V_DOUBLE, Rates.AccInt) == false)
                                          /* если не нашли  */
                                       end;
                                       /*MarketPrice3 загружаем и в курс <Рыночная цена для НДФЛ> и в курс <Рыночная цена>*/
                                       if(ReadTagAttribut(child_Board, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice3) == false)
                                          /* если не нашли  */
                                       end;
                                       if(ReadTagAttribut(child_Board, "PRICETYPE", V_STRING, Rates.PriceType) == false)
                                          /* если не нашли тип цены */                                                  
                                       end;                                                                             
                                       if(ReadTagAttribut(child_Board, "FACEVALUE", V_DOUBLE, Rates.FaceValue) == false)
                                          /* если не нашли  */                                                          
                                       end;                                                                             

                                       RunImp( RATE_KIND_MARKET,  Rates.MarketPrice );
                                       RunImp( RATE_KIND_MIN,     Rates.Low );
                                       RunImp( RATE_KIND_MAX,     Rates.High );
                                       RunImp( RATE_KIND_WA,      Rates.WAPrice );
                                       RunImp( RATE_KIND_NKD1SEC, Rates.AccInt );
                                       RunImp( RATE_KIND_VOLUME,  Rates.Volume );
                                       RunImp( RATE_KIND_MARKET_TAX, Rates.MarketPrice3 );
                                        
                                       ImpNomForIndexNom();

                                   end;
                               end;
                               k = k + 1;
                               UseProgress(k);
                               if( FlagCtrlBrk == true )
                                  break;
                               end;
                            end;
                            RemProgress(); 
                        end;
                    end;
                 end;
                             s = s + 1;
                             UseProgress(s);
                 if( FlagCtrlBrk == true )
                    break;
                 end;
              end;
              RemProgress(); 
           end;
                    end;
                 end;
                 j = j + 1;
              end;
           end;
        end;
        i = i + 1;
        if( FlagCtrlBrk == true )
           RemProgress(); RemProgress();
           break;
        end;
     end;

     return true;

  OnError( RslErrObj )
     RemProgress();RemProgress();
     MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
     RunError;
  END;

  initSC_ImportRate( true, MICEX_CODE_FB );
END;

PRIVATE VAR Rate = SC_ImportRateSEM21();
if( Rate != NULL )
   Rate.Run();
end;

Exit(1);

