/*
$Name:         scso015.mac 
$Module:       Ценные бумаги
$Description:  Операция внебиржевой продажи ц/б Шаг подтверждения сделки
*/
/* Операция внебиржевой продажи ц/б
   шаг подтверждения сделки */

import InsCarryDoc, "sp_class.mac", "sp_car.mac", "sprconf.mac", "boswift.mac";

record Deal_Tick (dl_tick);
const CreateMT = False;
macro ExecuteStep( doc, FDoc)
  var query, DataSet, cmd;
  var     FD, dat;
  var AttrID = 0;
  var flag = false;
  var stat = -1;

  SetBuff( Deal_Tick, FDoc ); 
  FD = SPFirstDoc( Deal_Tick, IsBackExec(Deal_Tick, SP_EXECUTE_STEP_SALE) );

  GetOprDate( FD.GetKindDate(DATE_DEALDATE), dat );
  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;
if(CreateMT)
  if( IsOUTEXCHANGE(FD.Group))
    if(FD.tick.rec.GenagrID > 0)   // если в ген. соглашении Основной способ подтверждения = SWIFT
      query = "Select gen.T_CONFIRMMETHOD Method From ddl_genagr_dbt gen Where gen.t_GenagrID = ?" ;
      cmd = DL_RSDCommand(query);
      cmd.AddParam(FD.tick.rec.GenagrID);
      DataSet = cmd.Execute();
      if( (DataSet.moveNext()) and (DataSet.Method == 0) )    // метод подтверждения- Swift
        if( ( not DisconnectObjAttr(OBJTYPE_SECDEAL,  UniID( FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT) ) OR
            ( not ConnectObjAttr(stat, OBJTYPE_SECDEAL, UniID( FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT, 1, null, null, {curdate}) ) OR
            ( stat != 0 ) )
             msgbox( "Ошибка при установке Категории <Формировать SWIFT>" );
             return 1;
          
        end;
      end;
    end;
end;
    if( GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID(FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT, AttrID ) )
      if(AttrID == 1)
        flag = true;
      end;
    
    end;
    if(flag)
      if( DL_CreateMsgInfBO(Deal_Tick) )
        return 1;
      elif( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KC, SP_OPERSTATUS_SECURDEALS_KC_RUN) ) 
         msgbox( "Ошибка при установке статуса <Квитовка подтверждений> операции" );
         return 1;
      end;
    else
      if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KC, SP_OPERSTATUS_SECURDEALS_KC_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Квитовка подтверждений> операции" );
        return 1;
      end;
    end;
  end;


  /*ставим признак - Сделка подтверждена*/ 
  /*ставим признак - Сделка подтверждена*/ 
  if( not ОбновитьФлагиЧастиСделки( FD.dl_leg, DL_LEG_CONFIRM_DEAL ) )
     msgbox("Ошибка при обновлении статуса в лоте"); 
     return 1;
  end;

  return 0;
end;

/* Макрос постобработки */
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    
    SetBuff(Deal_Tick, FDoc ); 

    if (errTrn OR (CommitOrRollback == 2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

/*    message("Идет формирование подтверждения...");
    PrintConfirmation(Deal_Tick.DealID, IsBackExec(Deal_Tick, SP_EXECUTE_STEP_SALE));*/
/*DAN*/
  var cmd_upd_step = RsdCommand("  UPDATE doprstep_dbt step "+
            " SET step.T_ISREADYFORAUTOEXEC = CHR (88) "+
            " WHERE step.T_ISEXECUTE = 'R' " +
            " AND step.t_id_operation = ?");
  cmd_upd_step.addParam( "ID_Operation", RSDBP_IN, ID_Operation );
  cmd_upd_step.execute;
/*DAN*/
    
    return 0;

END;


/* Макрос печати */
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */
    
    message("Идет формирование подтверждения...");
    PrintConfirmation(Deal_Tick.DealID, IsBackExec(Deal_Tick, SP_EXECUTE_STEP_SALE));

    exit(1); /*Для того, чтобы не выводился пустой файл */

END;
