/*
$Name: scbo016.mac
$Module: Ценные бумаги
$Description: Квитовка сообщений
*/

import InsCarryDoc, "sp_class.mac", "sp_car.mac", "sprconf.mac", "boswift.mac";

record Deal_Tick (dl_tick);

Private Macro IsKvitMsg(Kind, id)
  var query, DataSet, cmd;
  query = "select msg.* from ddlinfmsg_dbt msg, ddlinfmsgobj_dbt obj where msg.t_id = obj.t_mesid and obj.t_dockind = ? and obj.t_docid = ?" ;
  cmd = DL_RSDCommand(query);
  cmd.AddParam(Kind);
  cmd.AddParam(Id);
  DataSet = cmd.Execute();
  if( DataSet.moveNext() )
     If(DataSet.status == 11)
        return true;
     else
        return false;
     end;
  else
     return true;//нет сообщения, значит не нужно и квитовать
  end;
  return false;
End;

// запрос подтверждения получения ответа
Private macro GetConfirmParams(DraftKind, DraftID)
  var query, Select, Transport, Stat;

  

  query = "begin\n ? := RSP_SECURITY.GETCONFIRMIDSEC(?,?);\n end; ";

  Select = RSDCommand( query );

  Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );

  Select.AddParam("p_DraftID", RSDBP_IN, DraftID );

  Select.AddParam("p_Status", RSDBP_OUT, V_INTEGER );

  Select.Execute();

  return SQL_ConvTypeInteger(Select.value("p_Stat"));
end;



macro ExecuteStep( kind_oper, FDoc, DocKind, ID_Operation, ID_Step )
  var err = 0, stat = -1 , AttrID, flag = false;
  var FD ;
  var KindMsg = "";
  var IsKvit = false;
  var IsKv ;
  SetBuff( Deal_Tick, FDoc ); 
  FD = SPFirstDoc( Deal_Tick, IsBackExec(Deal_Tick, SP_EXECUTE_STEP_BUY) );
  // надо заполнить полученными данными таблицу для скроллинга
  if( IsOUTEXCHANGE(FD.Group) )           // внебиржевые
  // проверка категории "Подтверждение SWIFT"
    stat = DL_GetConfirmParamsSEC(1, FD.tick.rec.DealID, KindMsg, {Oper}, {NumDprt}, FD.tick.rec.BOfficeKind);
  end;

/* КД Сделки, заключенные по телефону должны быть обязательно подтверждены */
    if( GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID(FD.tick, OBJTYPE_SECDEAL), 101, AttrID ) )
      if(AttrID == 1)
         IsKv = GetConfirmParams(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID);
//           IsKvit = IsKvitMsg(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID);
         If(IsKv == 0)
            msgbox( "Не получено подтверждение по сделке, заключенной по телефону" );
            return 1;
         end;
      end;
    end;
/* End КД */

  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KC, SP_OPERSTATUS_SECURDEALS_KC_FINISH) ) 
     msgbox( "Ошибка при установке статуса <Квитовка подтверждений> операции" );
     return 1;
  end;

  return stat;
end;

