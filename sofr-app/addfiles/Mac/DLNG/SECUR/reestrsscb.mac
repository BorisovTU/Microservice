/*****************************************************************************/ 
/*                                                           R-Style Softlab */ 
/*                                                                           */ 
/*               Реестр сделок с ценными бумагами                            */
/*                                                                           */ 
/*  Create : Punyaev D.V.                                                    */ 
/*  Date   : 05.08.2019                                                      */ 
/*****************************************************************************/ 

import RsbFormsInter, Global, or_rep_h, "spRepFun.mac", "DlReport_h.mac";

private const SHEET_NAME = "Реестр сделок с ценными бумагам";

PRIVATE CLASS (DL_CReportTemplate) OfferRep_Report(_BegDate:Date, _EndDate:Date)
   private var BegDate = _BegDate;
   private var EndDate = _EndDate;

   macro PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
   end;

   macro BeginReport()
   end;

   private macro del0(s:string)
      var i = 0, len = 0;
      var s1 = "";
      for (i, 0, StrLen(s), i+1)
         len = StrLen(s) - i;
         if (len > 1)
            if ((SubStr(s, len, 1) == "0") or (SubStr(s, len, 1) == "."))
               s1 = SubStr(s, 1, StrLen(s)-i-1);
            else
               s1 = SubStr(s, 1, StrLen(s)-i);
               break;
            end;
         end;
      end;
      return s1;
   end;

   macro Create()
      var SQL, cmd, rs;
      var ExistsData = true;
      var num = 0;

      SetActiveSheet(SHEET_NAME);

      PrintFormatString(NULL, "N1_RepDate", "За период: " + string(BegDate:f) + " - " + string(EndDate:f));

      RegisterTable("N1_MainTable", NULL,
                    "N1_DealID",
                    "N1_DealDate",
                    "N1_PortfCode",
                    "N1_PortfName",
                    "N1_DealType",
                    "N1_DealCode",
                    "N1_DealCodeTS",
                    "N1_FI_Code",
                    "N1_FI_Name",
                    "N1_ISIN",
                    "N1_LSIN",
                    "N1_Amount",
                    "N1_RepoRate",
                    "N1_Comiss",
                    "N1_FaceValue",
                    "N1_CCY",
                    "N1_Price1",
                    "N1_Cost1",
                    "N1_NKD1",
                    "N1_Cost_NKD1",
                    "N1_Price2",
                    "N1_Cost2",
                    "N1_NKD2",
                    "N1_Cost_NKD2",
                    "N1_DeliveryDate1",
                    "N1_PaymentDate1",
                    "N1_DeliveryDate2",
                    "N1_PaymentDate2");

      SQL = "  SELECT tick.t_dealid dealid /*ID сделки*/,                                                 "+
            "         TO_CHAR (tick.t_dealdate, 'dd.mm.yyyy') deald                                            "+
            "           /* Дата заключения*/,                                                                  "+
            "       nvl((CASE WHEN tick.t_portfolioid > 0 THEN tick.t_portfolioid END),0) pcod                 "+
            "           /* Код портфеля*/,                                                                     "+
            "        nvl((SELECT t_name                                                                        "+
            "            FROM dllvalues_dbt                                                                    "+
            "           WHERE t_list = 1100 AND t_element = tick.t_portfolioid),0) pname                       "+
            "            /*Наименование портфеля*/,                                                            "+
            "         nvl(DECODE (tick.t_dealtype,                                                             "+
            "                 12122, 'Обратное РЕПО на бирже',                                                 "+
            "                 12123, 'Обратное РЕПО на бирже c КСУ',                                           "+
            "                 12127, 'Прямое РЕПО на бирже',                                                   "+
            "                 12143, 'Покупка биржевая',                                                       "+
            "                 12144, 'Покупка биржевая',                                                       "+
            "                 12153, 'Продажа биржевая',                                                       "+
            "                 12154, 'Продажа биржевая',                                                       "+
            "                 2154, 'Продажа биржевая',                                                        "+
            "                 12183, 'Покупка внебиржевая',                                                    "+
            "                 2183, 'Покупка внебиржевая',                                                     "+
            "                 12193, 'Продажа внебиржевая',                                                    "+
            "                 2193, 'Продажа внебиржевая',                                                     "+
            "                 12022, 'Погашение купона',                                                       "+
            "                 12021, 'Погашение ц/б',                                                          "+
            "                 12027, 'Частичное погашение',                                                    "+
            "                 2051, 'Погашение ц/б СЭБ',                                                       "+
            "                 2052, 'Погашение купона СЭБ',                                                    "+
            "                 tick.t_dealtype),0) dealtype                                                     "+
            "            /*Тип сделки*/,                                                                       "+
            "         tick.t_dealcode dealc /*Внутренний код сделки*/,                                         "+
            "         tick.t_dealcodets dealcv /*Внешний код сделки*/,                                         "+
            "         t_fi_code ficode /*Код бумаги*/,                                                         "+
            "         fi.t_name nam1 /*Наименование бумаги*/,                                                  "+
            "         avr.t_isin isin /*ISIN*/,                                                                "+
            "         avr.t_lsin lsin /*Номер госрегистрации*/,                                                "+
            "         leg1.t_principal kolvo /*Количество бумаг*/,                                             "+
            "         leg1.t_incomerate srepo /*Ставка РЕПО*/,                                                 "+
            "         NVL (                                                                                    "+
            "            CASE                                                                                  "+
            "               WHEN (SELECT t_sum                                                                 "+
            "                       FROM ddlsum_dbt                                                            "+
            "                      WHERE t_kind = 1250 AND t_docid = tick.t_dealid) > 0                        "+
            "               THEN                                                                               "+
            "                  (SELECT t_sum                                                                   "+
            "                     FROM ddlsum_dbt                                                              "+
            "                    WHERE t_kind = 1250 AND t_docid = tick.t_dealid)                              "+
            "               ELSE                                                                               "+
            "                  (SELECT SUM (t_sum)                                                             "+
            "                     FROM ddlcomis_dbt                                                            "+
            "                    WHERE t_docid = tick.t_dealid)                                                "+
            "            END,                                                                                  "+
            "            0)sumk                                                                                "+
            "           /* Сумма комиссий по сделке*/,                                                         "+
            "         rsi_rsb_fiinstr.FI_GetNominalOnDate (tick.t_pfi, tick.t_dealdate) nom1                   "+
            "            /*Номинал на дату сделки*/,                                                           "+
            "         (SELECT t_ccy                                                                            "+
            "            FROM dfininstr_Dbt                                                                    "+
            "           WHERE t_fiid = leg1.t_cfi) val                                                         "+
            "           /* Валюта сделки,*/,                                                                   "+
            "         leg1.t_price * POWER(10, 8)  pr1 /*Цена I части*/,                                       "+ //SVE для того чтобы значения не округлялись до 4х знаков.
            "         leg1.t_cost s1 /*Стоимость I части*/,                                                    "+
            "         leg1.t_nkd nkd1/*НКД по I части*/,                                                       "+
            "         leg1.t_totalcost snkd1 /*Стоимость I части c НКД*/,                                      "+
            "        nvl( leg2.t_price,0) * POWER(10, 8)  pr2 /*Цена II части*/,                               "+ //SVE см. комментарий выше
            "        nvl( leg2.t_cost,0) s2 /*Стоимость II части*/,                                            "+
            "        nvl( leg2.t_nkd,0) nkd2 /*НКД по II части*/,                                              "+
            "        nvl( leg2.t_totalcost,0) snkd2 /*Стоимость II части c НКД*/,                              "+
            "         TO_CHAR (                                                                                "+
            "            (CASE                                                                                 "+
            "                WHEN leg1.t_maturityisprincipal = CHR (88) THEN leg1.t_maturity                   "+
            "                ELSE leg1.t_expiry                                                                "+
            "             END),                                                                                "+
            "            'dd.mm.yyyy') dp1                                                                     "+
            "           /* Дата поставки I части*/,                                                            "+
            "         TO_CHAR (                                                                                "+
            "            (CASE                                                                                 "+
            "                WHEN leg1.t_maturityisprincipal <> CHR (88)                                       "+
            "                THEN                                                                              "+
            "                   leg1.t_maturity                                                                "+
            "                ELSE                                                                              "+
            "                   leg1.t_expiry                                                                  "+
            "             END),                                                                                "+
            "            'dd.mm.yyyy') do1                                                                     "+
            "            /*Дата оплаты I части*/,                                                              "+
            "        nvl( TO_CHAR (                                                                            "+
            "            (CASE                                                                                 "+
            "                WHEN leg2.t_maturityisprincipal = CHR (88) THEN leg2.t_maturity                   "+
            "                ELSE leg2.t_expiry                                                                "+
            "             END),                                                                                "+
            "            'dd.mm.yyyy'),0) dp2                                                                  "+
            "            /*Дата поставки II части*/,                                                           "+
            "        nvl( TO_CHAR (                                                                            "+
            "             (CASE                                                                                "+
            "                WHEN leg2.t_maturityisprincipal <> CHR (88)                                       "+
            "                THEN                                                                              "+
            "                   leg2.t_maturity                                                                "+
            "                ELSE                                                                              "+
            "                   leg2.t_expiry                                                                  "+
            "             END),                                                                                "+
            "            'dd.mm.yyyy'),0) do2,                                                                 "+
            "           /* Дата оплаты II части*/                                                              "+  
            "        count(1) over() as t_Count                                                                "+                           
            "    FROM ddl_tick_dbt tick,                                                                       "+                             
            "         ddl_leg_dbt leg1,                                                                        "+                            
            "         ddl_leg_dbt leg2,                                                                        "+                             
            "         dfininstr_dbt fi,                                                                        "+                            
            "         davoiriss_dbt avr,                                                                       "+                             
            "         davrkinds_dbt k                                                                          "+                               
            "   WHERE     tick.t_dealid = leg1.t_dealid                                                        "+                             
            "         AND tick.t_dealid = leg2.t_dealid(+)                                                     "+                              
            "         AND tick.t_pfi = fi.t_fiid                                                               "+                              
            "         AND fi.t_fiid = avr.t_fiid                                                               "+                               
            "         AND fi.t_avoirkind = k.t_avoirkind                                                       "+                              
            "         AND k.t_isemissive = CHR (88)                                                            "+                               
            "         AND tick.t_dealdate BETWEEN :datebeg                                                     "+                              
            "                                 AND :dateend                                                     "+                               
            "         AND t_bofficekind IN (101, 117)                                                          "+                             
            "         AND t_clientid = -1                                                                      "+                              
            "         AND leg1.t_legkind = 0                                                                   "+                              
            "         AND leg2.t_legkind(+) = 2                                                                "+
            "ORDER BY t_dealdate, tick.t_dealid                                                                ";   

      InitProgress(-1, "Сбор данных...", "Сбор данных...");
      cmd = RSDCommand(SQL);
      cmd.AddParam("datebeg", RSDBP_IN, BegDate);
      cmd.AddParam("dateend", RSDBP_IN, EndDate);

      rs = RSDRecordset(cmd);
      if(rs.MoveNext())
         RemProgress();

         InitProgress(Int(rs.value("t_Count")), "Печать отчета", "Печать отчета");
         while(ExistsData)
            PrintTableLine("N1_DealID", Int(rs.value("dealid")), NULL,
                           "N1_DealDate", string(Date(rs.value("deald")):f), NULL,
                           "N1_PortfCode", rs.value("pcod"), NULL,
                           "N1_PortfName", rs.value("pname"), NULL,
                           "N1_DealType", rs.value("dealtype"), NULL,
                           "N1_DealCode", rs.value("dealc"), NULL,
                           "N1_DealCodeTS", rs.value("dealcv"), NULL,
                           "N1_FI_Code", rs.value("ficode"), NULL,
                           "N1_FI_Name", rs.value("nam1"), NULL,
                           "N1_ISIN", rs.value("isin"), NULL,
                           "N1_LSIN", rs.value("lsin"), NULL,
                           "N1_Amount", rs.value("kolvo"), NULL,
                           "N1_RepoRate", rs.value("srepo"), NULL,
                           "N1_Comiss", rs.value("sumk"), NULL,
                           "N1_FaceValue", rs.value("nom1"), NULL,
                           "N1_CCY", rs.value("val"), NULL,
                           "N1_Price1", del0(ЧислоCЗаданнойТочностью(rs.value("pr1") / 100000000, 8)), NULL,
                           "N1_Cost1", rs.value("s1"), NULL,
                           "N1_NKD1", rs.value("nkd1"), NULL,
                           "N1_Cost_NKD1", rs.value("snkd1"), NULL,
                           "N1_Price2", del0(ЧислоCЗаданнойТочностью(rs.value("pr2") / 100000000, 8)), NULL,
                           "N1_Cost2", rs.value("s2"), NULL,
                           "N1_NKD2", rs.value("nkd2"), NULL,
                           "N1_Cost_NKD2", rs.value("snkd2"), NULL,
                           "N1_DeliveryDate1", string(Date(rs.value("dp1")):f), NULL,
                           "N1_PaymentDate1", string(Date(rs.value("do1")):f), NULL,
                           "N1_DeliveryDate2", string(Date(rs.value("dp2")):f), NULL,
                           "N1_PaymentDate2", string(Date(rs.value("do2")):f), NULL);

            UseProgress(num = num + 1);
            ExistsData = rs.MoveNext();
      end;
         RemProgress();
      else
         RemProgress();
    end;

      EndTable();
   end;

   macro EndReport()
      m_ObjTemplateXLS.SetAutoFilter("A6:AB6", SHEET_NAME);
   end;

   InitDL_CReportTemplate(NULL, "Report_reestrsscb.xlsx", true, false, NULL, true, true /*UseBigReport*/, NULL);
END;

CLASS (TRsbPanel) Pan
    initTRsbPanel();


    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;
    const EndCalcDate_ID = 2;
    var curstr = 1;
    Caption = "Реестр сделок с ценными бумагами.";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, EndCalcDate, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    EndCalcDate = TRsbEditField(V_DATE);
    EndCalcDate.setPosition(27,curstr);
    EndCalcDate.setSize(8,1);
    EndCalcDate.name = "endincalcdate";
    EndCalcDate.value = {curdate};
    addControl(EndCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr," За период:");
    addLabel (m_LabelCD);

    var m_LabelT:TrsbLabel = TRsbLabel(25,curstr,"~");
    addLabel (m_LabelT);
 
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));


    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if ((ev.id == BeginCalcDate_ID) or (ev.id == EndCalcDate_ID ))
            BeginCalcDate.value = GetDateByCalendar({CurDate});
//            EndCalcDate.value   = BeginCalcDate.value + Delta;
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
//            EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
  //       EndCalcDate.value   = BeginCalcDate.value + Delta;
        
         var myRep = OfferRep_Report(BeginCalcDate.value, EndCalcDate.value);
         myRep.run();
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);