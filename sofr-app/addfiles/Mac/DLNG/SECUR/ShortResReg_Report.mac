/*
$Name:             ShortResReg_Report.mac
$Module:           АРНУ
$Description:      Отчет "Краткие регистры по резервам" (НУ)
*/

IMPORT Проценты, "spCache.mac", "ShortResReg_Form.mac", "DLReport_h.mac", "spserv.mac", "spRepFun.mac", "oralib.mac", "ws_txreportform.mac";

/*Здесь можно через "," в апострофах указать код (FININSTR.FI_Code) ценных бумаг, которые будут исключаться из отчета.
  Например: 
    ИсключаемыеИзОтчетаЦБ = "'1','2','3'"
*/
PRIVATE CONST ИсключаемыеИзОтчетаЦБ = "";

PRIVATE CONST Строка_Итого                = 0,
              Строка_СтрокаДанных         = 1;

PRIVATE CONST ItogsLineName = "Всего:";

PRIVATE CONST SHEET_0901 = "0901";
PRIVATE CONST SHEET_0902 = "0902";

PRIVATE VAR ShortResReg_Form;
PRIVATE VAR ShortResReg_Report;
PRIVATE VAR WebMenuItem; // Информация о запуске отчета из веб

PRIVATE VAR T_Dep:T_Dep_Collector;
PRIVATE VAR Protocol = TArray(); 

PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

PRIVATE VAR ReportHeader =
"\n\n##############################  ###########################\n" +
"Приложение № ##.## \n" +
"Аналитический регистр налогового учета № 1-02-#####-###-##-000-##-210302-##-##-70102000000000000000\n" +
"                ┌──────────────────────┬─────────────────────────────────────────────────┐\n" +
"                │                    1 │Наименование налоговой базы                      │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   02 │Лист декларации                                  │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                ##### │Номер приложения синтетического регистра         │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                  ### │Код строки в синтетическом регистре              │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │Номер аналитического регистра                    │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                  000 │Код филиала                                      │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │                                                 │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │               210302 │Код структурного подразделения внутри филиала    │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │Номер месяца (последний в отчетном периоде)      │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │                   ## │Две последние цифры года                         │\n" +
"                ├──────────────────────┼─────────────────────────────────────────────────┤\n" +
"                │ 70102000000000000000 │Номер лиц. счета по учету доходов/расходов банка │\n" +
"                └──────────────────────┴─────────────────────────────────────────────────┘\n" +
"###########################################################################################################################################################################################################################\n" +
"в отчетную дату ##########\n" +
"Группа налогового учета: #################################################################\n" +
"Вид ц/б:                 #################################################################\n" +
"Выпуск ц/б:              #################################################################\n";                      





var TableHeader_0901 = 
"┌────────────┬────────────────┬────────────┬──────────────┬────────┬────────────┬─────────────┬────────────┬─────────────┬────────────────────────────┬────────────────────────────┬──────────────────────────────────────────────┬─────────────┬─────────────┬──────────────────────────────────────────────────┬─────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬───────────┬──────────┬──────────┐\n"+
"│ Код бумаги │     Выпуск     │    Дата    │ Номер сделки │  Код   │    Дата    │     Дата    │ Количество │ Код валюты  │     Цена приобретения      │   Стоимость приобретения   │ Максимальная цена на дату заключения сделки, │  Комиссия,  │  Cтоимость  │ Рыночная котировка на дату корректировки резерва,│  Величина   │ Курс ЦБ РФ │    Курс    │    Курс    │ Курс ЦБ РФ │   Цена,    │ Стоимость, │  Эмитент   │    Дата    │ ГО/филиал  │ Налоговая │   Вид    │   ISIN(  │\n"+
"│            │     ценной     │ начисления │ приобретения │ валюты │ заключения │   перехода  │   ценных   │    цены     │                            │                            │      сложивш. на ОРЦБ; расч. цена ЦБ,        │ уплаченная  │приобретенных│                 сложивш. на ОРЦБ                 │  резерва    │  на дату   │ пересчета  │ пересчета  │на отчетную │  в валюте  │  в валюте  │            │ переквали- │ по сделке  │  группа   │  сделки  │ номер го │\n"+
"│            │     бумаги     │  резерва   │              │  номи- │ сделки на  │    права    │   бумаг,   │приобретения │                            │                            │   приобр.по срочн. сделке, увелич. на 20%    │     при     │    ценных   │                                                  │ на отчетную │ заключения │ цены/ст-ти │ из валюты  │    дату    │  номинала  │  номинала  │            │  фикации   │приобретения│           │          │сударствен│\n"+
"│            │                │            │              │  нала  │  приобре-  │собственности│     шт.    │             ├──────────────┬─────────────┼──────────────┬─────────────┼──────────────┬───────────────┬───────────────┤приобретении,│    бумаг,   ├───────────────┬─────────────────┬────────────────┤  дату, руб. │ сделки на  │приобретения│  расчетов  │            │            │            │            │   сделки   │            │           │          │ ной реги │\n"+
"│            │                │            │              │        │  тение ЦБ  │     при     │            │             │   в валюте   │  в рублях   │   в валюте   │  в рублях   │     Цена     │    Источник   │     Дата      │  руб. (не   │ принимаемая │      Цена     │    Источник     │      Дата      │             │приобретение│ в рублевый │  в валюту  │            │            │            │            │    РЕПО    │            │           │          │ страции) │\n"+
"│            │                │            │              │        │            │   приобре-  │            │             │              │             │              │             │              │   информации  │   котировки   │ включая НДС)│  для целей  │               │   информации    │   котировки    │             │            │ эквивалент │  номинала  │            │            │            │            │            │            │           │          │          │\n"+
"│            │                │            │              │        │            │   тение ЦБ  │            │             │              │             │              │             │              │               │               │             │формирования │               │                 │                │             │            │            │            │            │            │            │            │            │            │           │          │          │\n"+
"│            │                │            │              │        │            │             │            │             │              │             │              │             │              │               │               │             │   резерва,  │               │                 │                │             │            │            │            │            │            │            │            │            │            │           │          │          │\n"+
"│            │                │            │              │        │            │             │            │             │              │             │              │             │              │               │               │             │     руб.    │               │                 │                │             │            │            │            │            │            │            │            │            │            │           │          │          │\n"+
"├────────────┼────────────────┼────────────┼──────────────┼────────┼────────────┼─────────────┼────────────┼─────────────┼──────────────┼─────────────┼──────────────┼─────────────┼──────────────┼───────────────┼───────────────┼─────────────┼─────────────┼───────────────┼─────────────────┼────────────────┼─────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼──────────┼──────────┤\n"+
"│     1      │       2        │      3     │       4      │    5   │      6     │       7     │      8     │       9     │      10      │      11     │      12      │      13     │      14      │       15      │       16      │      17     │      18     │       19      │        20       │       21       │      22     │     T1     │     T2     │     T3     │     T4     │     T5     │     T6     │     T7     │     T8     │     T9     │     T10   │    T11   │    R1    │\n"+
"├────────────┼────────────────┼────────────┼──────────────┼────────┼────────────┼─────────────┼────────────┼─────────────┼──────────────┼─────────────┼──────────────┼─────────────┼──────────────┼───────────────┼───────────────┼─────────────┼─────────────┼───────────────┼─────────────────┼────────────────┼─────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼──────────┼──────────┤";


var TableHeader_0902 = 
"┌────────────┬────────────────┬────────────┬──────────────┬────────┬────────────┬─────────────┬────────────┬─────────────┬────────────────────────────┬──────────────────────────────────────────────┬─────────────┬────────────────────────────┬─────────────┬──────────────────────────────────────────────────┬─────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬───────────┬──────────┬──────────┐\n"+
"│ Код бумаги │     Выпуск     │    Дата    │ Номер сделки │  Код   │    Дата    │     Дата    │ Количество │    Цена     │   Стоимость приобретения   │Максимальная цена на дату заключения сделки,  │  Комиссия,  │   Доходы, полученные при   │  Cтоимость  │ Рыночная котировка на дату корректировки резерва,│  Величина   │ Код валюты │ Курс ЦБ РФ │    Курс    │    Курс    │ Курс ЦБ РФ │  Эмитент   │  Номинал   │  Номинал   │    Дата    │ ГО/филиал  │ Налоговая │   Вид    │   ISIN(  │\n"+
"│            │     ценной     │ начисления │ приобретения │ валюты │ заключения │   перехода  │   ценных   │приобретения,│                            │      сложивш. на ОРЦБ; расч. цена ЦБ,        │ уплаченная  │частичном погашении номинала│приобретенных│                 сложивш. на ОРЦБ                 │  резерва    │    цены    │  на дату   │ пересчета  │ пересчета  │на отчетную │            │  на дату   │на отчетную │ переквали- │ по сделке  │  группа   │  сделки  │ номер го │\n"+
"│            │     бумаги     │  резерва   │              │  номи- │ сделки на  │    права    │   бумаг,   │   в % от    │                            │   приобр.по срочн. сделке, увелич. на 20%    │     при     │                            │    ценных   │                                                  │ на отчетную │приобретения│ заключения │ цены/ст-ти │ из валюты  │    дату    │            │приобретения│   дату     │  фикации   │приобретения│           │          │сударствен│\n"+
"│            │                │            │              │  нала  │  приобре-  │собственности│     шт.    │  номинала   ├──────────────┬─────────────┼──────────────┬───────────────┬───────────────┤приобретении,├──────────────┬─────────────┤    бумаг,   ├───────────────┬─────────────────┬────────────────┤  дату, руб. │            │ сделки на  │приобретения│  расчетов  │            │            │            │            │   сделки   │            │           │          │ ной реги │\n"+
"│            │                │            │              │        │  тение ЦБ  │     при     │            │             │   Сумма, в   │   Сумма,    │   Цена, в %  │    Источник   │     Дата      │  руб. (не   │   Сумма, в   │   Сумма,    │ принимаемая │   Цена, в %   │    Источник     │      Дата      │             │            │приобретение│ в рублевый │  в валюту  │            │            │            │            │    РЕПО    │            │           │          │ страции) │\n"+
"│            │                │            │              │        │            │   приобре-  │            │             │    валюте    │    руб.     │  от номинала │   информации  │   котировки   │ включая НДС)│    валюте    │    руб.     │  для целей  │  от номинала  │   информации    │   котировки    │             │            │            │ эквивалент │  номинала  │            │            │            │            │            │            │           │          │          │\n"+
"│            │                │            │              │        │            │   тение ЦБ  │            │             │   номинала   │             │              │               │               │             │   номинала   │             │формирования │               │                 │                │             │            │            │            │            │            │            │            │            │            │            │           │          │          │\n"+
"│            │                │            │              │        │            │             │            │             │              │             │              │               │               │             │              │             │   резерва,  │               │                 │                │             │            │            │            │            │            │            │            │            │            │            │           │          │          │\n"+
"│            │                │            │              │        │            │             │            │             │              │             │              │               │               │             │              │             │     руб.    │               │                 │                │             │            │            │            │            │            │            │            │            │            │            │           │          │          │\n"+
"├────────────┼────────────────┼────────────┼──────────────┼────────┼────────────┼─────────────┼────────────┼─────────────┼──────────────┼─────────────┼──────────────┼───────────────┼───────────────┼─────────────┼──────────────┼─────────────┼─────────────┼───────────────┼─────────────────┼────────────────┼─────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼──────────┼──────────┤\n"+
"│     1      │       2        │      3     │       4      │    5   │      6     │       7     │      8     │       9     │      10      │      11     │      12      │       13      │       14      │       15    │      16      │      17     │      18     │       19      │        20       │       21       │      22     │     T1     │     T2     │     T3     │     T4     │     T5     │     T6     │     T7     │     T8     │     T9     │     T10    │     T11   │    T12   │    R1    │\n"+
"├────────────┼────────────────┼────────────┼──────────────┼────────┼────────────┼─────────────┼────────────┼─────────────┼──────────────┼─────────────┼──────────────┼───────────────┼───────────────┼─────────────┼──────────────┼─────────────┼─────────────┼───────────────┼─────────────────┼────────────────┼─────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼──────────┼──────────┤";


var TableHeader_Protocol = 
"┌────────────┬──────────────────────┬───────────────────────────┬─────────────────────────────────────┬─────────────────────────┐\n"+
"│ Код бумаги │ Выпуск ценной бумаги │ Номер сделки приобретения │ Дата заключения сделки приобретения │ Дата начисления резерва │\n"+
"│            │                      │                           │                                     │                         │\n"+
"├────────────┼──────────────────────┼───────────────────────────┼─────────────────────────────────────┼─────────────────────────┤";


PRIVATE CLASS ProtocolData(_SecCode, _SecName, _CodeB, _DZB, _Drez)
  VAR SecCode =  _SecCode,
      SecName =  _SecName,
      CodeB   =  _CodeB,  
      DZB     =  _DZB,    
      Drez    =  _Drez;    
END;

/*отбираются сделки с акциями*/
PRIVATE CLASS CShResReg_901( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()
     m_Report.PrintMainHeader( SHEET_0901, "N1_" );

     m_Report.RegisterTable( "N1_MainTable", TableHeader_0901,
                             "N1_SecCode",  "N1_SecName",  "N1_Drez",      "N1_CodeB",   "N1_VN",      "N1_DZB",   
                             "N1_DDB",      "N1_Qnty",     "N1_VprB",      "N1_PrBvp",   "N1_PrBrub",  "N1_SumBvp",    
                             "N1_SumBrub",  "N1_MaxMrkt",  "N1_MrktB",     "N1_DMrktB",  "N1_ComB",    "N1_SumBrez",   
                             "N1_RezMrkt",  "N1_MrktRez",  "N1_DMrktRez",  "N1_RezRub",  "N1_CrBZ",    "N1_CrBD",  
                             "N1_CrBP",     "N1_CrRez",    "N1_PrBvn",     "N1_SumBvn",  "N1_Emit",    "N1_DQual",  
                             "N1_FilB",     "N1_SecType",  "N1_TypeB",     "N1_ISIN");                                                                                                                                               

     m_Report.SetCellAutoSummaPoint( ItogsLineName, 
                                "N1_Qnty",6, "N1_SumBvp",2, "N1_SumBrub",2, "N1_ComB",2, "N1_SumBrez",2, "N1_RezRub",2); 

     this.ПечататьСтрокуТаблицы( Строка_Итого );
  END;

  MACRO ПечататьПромежуточныеИтоги()

     m_Report.SetSubtotal(29, 26 + MAXROWSHEET,
                        "H23",      
                        "L23",    
                        "M23",   
                        "Q23",      
                        "R23",   
                        "V23"    
                        );
  END;

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     if( LineType == Строка_СтрокаДанных )
        m_Report.PrintTableLine( "N1_SecCode",   m_Report.SecCode(),     null,               //1 
                                 "N1_SecName",   m_Report.SecName(),     null,               //2 
                                 "N1_Drez",      m_Report.Drez(),        null,               //3 
                                 "N1_CodeB",     m_Report.CodeB(),       null,               //4 
                                 "N1_VN",        m_Report.VN(),          null,               //5 
                                 "N1_DZB",       m_Report.DZB(),         null,               //6 
                                 "N1_DDB",       m_Report.DDB(),         null,               //7 
                                 "N1_Qnty",      m_Report.Qnty(),        SetPrecisionByFractPart(m_Report.Qnty(), m_Report.QntyPrecision(), 0),//8 
                                 "N1_VprB",      m_Report.VprB(),        null,               //9 
                                 "N1_PrBvp",     m_Report.PrBvp(),       null,               //10
                                 "N1_PrBrub",    m_Report.PrBrub(),      null,               //11
                                 "N1_SumBvp",    m_Report.SumBvp(),      null,               //12
                                 "N1_SumBrub",   m_Report.SumBrub(),     null,               //13
                                 "N1_MaxMrkt",   m_Report.MaxMrkt(),     null,               //14
                                 "N1_MrktB",     m_Report.MrktB(),       null,               //15
                                 "N1_DMrktB",    m_Report.DMrktB(),      null,               //16
                                 "N1_ComB",      m_Report.ComB(),        null,               //17
                                 "N1_SumBrez",   m_Report.SumBrez(),     null,               //18
                                 "N1_RezMrkt",   m_Report.RezMrkt(),     null,               //19
                                 "N1_MrktRez",   m_Report.MrktRez(),     null,               //20
                                 "N1_DMrktRez",  m_Report.DMrktRez(),    null,               //21
                                 "N1_RezRub",    m_Report.RezRub(),      null,               //22
                                 "N1_CrBZ",      m_Report.printCrBZ(),   null,               //T1 
                                 "N1_CrBD",      m_Report.printCrBD(),   null,               //T2 
                                 "N1_CrBP",      m_Report.printCrBP(),   null,               //T3 
                                 "N1_CrRez",     m_Report.printCrRez(),  null,               //T4 
                                 "N1_PrBvn",     m_Report.PrBvn(),       null,               //T5 
                                 "N1_SumBvn",    m_Report.SumBvn(),      null,               //T6 
                                 "N1_Emit",      m_Report.Emit(),        null,               //T7 
                                 "N1_DQual",     m_Report.DQual(),       null,               //T8
                                 "N1_FilB",      m_Report.FilB(),        null,               //T9 
                                 "N1_SecType",   m_Report.SecType(),     null,               //T10
                                 "N1_TypeB",     m_Report.TypeB(),       null,               //T11
                                 "N1_ISIN",      m_Report.ISIN(),        null                //R1
                               );                  

     elif( LineType == Строка_Итого )
        m_Report.SetCurrentLineFont( 8, true, false );
        m_Report.PrintTableLine( "N1_SecCode",  ItogsLineName, null );
        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine( "N1_SecCode",  "в том числе:", null );
     end;
  END;         

  MACRO EndReport();
     m_Report.EndTable();
     ПечататьПромежуточныеИтоги();
     m_Report.AddStandardFooter( "N1_" );
  END;         
END;

/*отбираются сделки с облигациями*/
PRIVATE CLASS CShResReg_902( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()
     m_Report.PrintMainHeader( SHEET_0902, "N2_" );

     m_Report.RegisterTable( "N2_MainTable", TableHeader_0902,
                             "N2_SecCode",    "N2_SecName",     "N2_Drez",      "N2_CodeB",    "N2_VN",       "N2_DZB",   
                             "N2_DDB",        "N2_Qnty",        "N2_PrBnom",    "N2_SumBvn",   "N2_SumBrub",  "N2_MaxMrkt",   
                             "N2_MrktB",      "N2_DMrktB",      "N2_ComB",      "N2_AmortVN",  "N2_AmortRub", "N2_SumBrez",   
                             "N2_RezMrkt",    "N2_MrktRez",     "N2_DMrktRez",  "N2_RezRub",   "N2_VPrB",     "N2_CrBZ",  
                             "N2_CrBD",       "N2_CrBP",        "N2_CrRez",     "N2_Emit",     "N2_NomB",     "N2_NomRez",    
                             "N2_DQual",      "N2_FilB",        "N2_SecType",   "N2_TypeB",    "N2_ISIN" );

     m_Report.SetCellAutoSummaPoint( ItogsLineName,
                                "N2_Qnty",6, "N2_SumBvn",2, "N2_SumBrub",2, "N2_ComB",2, "N2_AmortVN",2, "N2_AmortRub",2, "N2_SumBrez",2, "N2_RezRub",2);                                                                                                                                                                                      

     this.ПечататьСтрокуТаблицы( Строка_Итого );
  END;

  MACRO ПечататьПромежуточныеИтоги()

     m_Report.SetSubtotal(29, 26 + MAXROWSHEET,
                        "H23",     
                        "J23",   
                        "K23",  
                        "O23",     
                        "P23",  
                        "Q23", 
                        "R23",  
                        "V23"   
                        );
  END;

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     if( LineType == Строка_СтрокаДанных )
        m_Report.PrintTableLine( "N2_SecCode",   m_Report.SecCode(),     null,               //1   
                                 "N2_SecName",   m_Report.SecName(),     null,               //2
                                 "N2_Drez",      m_Report.Drez(),        null,               //3   
                                 "N2_CodeB",     m_Report.CodeB(),       null,               //4   
                                 "N2_VN",        m_Report.VN(),          null,               //5   
                                 "N2_DZB",       m_Report.DZB(),         null,               //6   
                                 "N2_DDB",       m_Report.DDB(),         null,               //7   
                                 "N2_Qnty",      m_Report.Qnty(),        SetPrecisionByFractPart(m_Report.Qnty(), m_Report.QntyPrecision(), 0), //8   
                                 "N2_PrBnom",    m_Report.PrBnom(),      null,               //9   
                                 "N2_SumBvn",    m_Report.SumBvn(),      null,               //10  
                                 "N2_SumBrub",   m_Report.SumBrub(),     null,               //11  
                                 "N2_MaxMrkt",   m_Report.MaxMrkt(),     null,               //12  
                                 "N2_MrktB",     m_Report.MrktB(),       null,               //13  
                                 "N2_DMrktB",    m_Report.DMrktB(),      null,               //14  
                                 "N2_ComB",      m_Report.ComB(),        null,               //15  
                                 "N2_AmortVN",   m_Report.AmortVN(),     null,               //16  
                                 "N2_AmortRub",  m_Report.AmortRub(),    null,               //17  
                                 "N2_SumBrez",   m_Report.SumBrez(),     null,               //18  
                                 "N2_RezMrkt",   m_Report.RezMrkt(),     null,               //19  
                                 "N2_MrktRez",   m_Report.MrktRez(),     null,               //20  
                                 "N2_DMrktRez",  m_Report.DMrktRez(),    null,               //21  
                                 "N2_RezRub",    m_Report.RezRub(),      null,               //22  
                                 "N2_VPrB",      m_Report.VPrB(),        null,               //T1  
                                 "N2_CrBZ",      m_Report.printCrBZ(),   null,               //T2  
                                 "N2_CrBD",      m_Report.printCrBD(),   null,               //T3  
                                 "N2_CrBP",      m_Report.printCrBP(),   null,               //T4  
                                 "N2_CrRez",     m_Report.printCrRez(),  null,               //T5  
                                 "N2_Emit",      m_Report.Emit(),        null,               //T6  
                                 "N2_NomB",      m_Report.NomB(),        null,               //T7  
                                 "N2_NomRez",    m_Report.NomRez(),      null,               //T8  
                                 "N2_DQual",     m_Report.DQual(),       null,               //T9  
                                 "N2_FilB",      m_Report.FilB(),        null,               //T10 
                                 "N2_SecType",   m_Report.SecType(),     null,               //T11
                                 "N2_TypeB",     m_Report.TypeB(),       null,               //T12
                                 "N2_ISIN",      m_Report.ISIN(),        null                //R1
                               );                  
                               
     elif( LineType == Строка_Итого )
        m_Report.SetCurrentLineFont( 8, true, false );
        m_Report.PrintTableLine( "N2_SecCode",  ItogsLineName, null );
        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine( "N2_SecCode",  "в том числе:", null );
     end;
  END;         
  
  MACRO EndReport();
     m_Report.EndTable();
     ПечататьПромежуточныеИтоги();
     m_Report.AddStandardFooter( "N2_" );
  END;         
END;

                                                    
PRIVATE CLASS (DL_CReportTemplate) SP_ShortResReg_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL)
  PRIVATE VAR m_ReportKind, m_RS, 
              m_CacheFinInstr = TX_CacheFinInstr();
  PRIVATE VAR m_LastGetRezMrkt_Result = false, m_LastGetRezMrkt_FIID = -1, m_LastGetRezMrkt_CalcDate = DATE(0,0,0);
  PRIVATE VAR m_DMrktRez, m_RezMrkt, m_MrktRez;
  PRIVATE VAR m_CrVPr_DDB;

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
  /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if (m_IsWebService == true)
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END; 

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO SetAutoFilter()
     if( ExistsSheet( SHEET_0901 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:AH28", SHEET_0901);
     end;

     if( ExistsSheet( SHEET_0902 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:AI28", SHEET_0902);
     end;
  END;

  PRIVATE MACRO EndReport()
    EndReport();
    SetAutoFilter();
  END;

  MACRO PrintMainHeader( ReportCode:STRING, FldNamePrefix:STRING )
     SetActiveSheet( ReportCode );
     PrintFormatString( ReportHeader,
                       FldNamePrefix+"H0_A:l" , this.H0_A(),     // Банк
                       FldNamePrefix+"H0_B:l" , this.H0_B(),     // Инн/КПП
                       FldNamePrefix+"H0_1"   , this.H0_1(),     // Приложение №
                       FldNamePrefix+"H0_3"   , this.H0_3(),  
                       FldNamePrefix+"H0_12"  , this.H0_12(),    // Аналитический регистр налогового учета №
                       FldNamePrefix+"H0_2"   , this.H0_2(),  
                       FldNamePrefix+"H0_3"   , this.H0_3(),  
                       FldNamePrefix+"H0_1"   , this.H0_1(),  
                       FldNamePrefix+"H0_4"   , this.H0_4(),  
                       FldNamePrefix+"H0_5"   , this.H0_5(),  
                       FldNamePrefix+"H0_12:r"  , this.H0_12(),    // Номер приложения синтетического регистра
                       FldNamePrefix+"H0_2"   , this.H0_2(),     // Код строки в синтетическом регистре
                       FldNamePrefix+"H0_3"   , this.H0_3(),     // Номер аналитического регистра
                       FldNamePrefix+"H0_1"   , this.H0_1(),  
                       FldNamePrefix+"H0_4"   , this.H0_4(),     // Номер месяца (последний в отчетном периоде)
                       FldNamePrefix+"H0_5"   , this.H0_5(),     // Две последние цифры года
                       FldNamePrefix+"H0_6"   , this.H0_6(),     // Имя отчета
                       FldNamePrefix+"H0_8"   , this.H0_8(),     // в отчетную дату
                       FldNamePrefix+"H0_9"   , this.H0_9(),     // Группа налогового учета
                       FldNamePrefix+"H0_10"  , this.H0_10(),    // Вид ц/б
                       FldNamePrefix+"H0_11"  , this.H0_11()     // Выпуск ц/б
                     ); 

  END;

  MACRO PrintProtocol()
    var i = 0;
    if(Protocol.size)

      m_IsDataExist = true;
      SetActiveSheet( "Протокол - необращающиеся цб" );
      RegisterTable( "N3_MainTable", TableHeader_Protocol,
                       "N3_SecCode", "N3_SecName", "N3_CodeB", "N3_DZB", "N3_Drez");

      var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

      if( m_IsWebService and (WebMenuItem != null) )
        var header = "Формирование отчета " + WebMenuItem.szNameItem;
        ProgressIndicator.Start(Protocol.size, header, header);
      else
        ProgressIndicator.Start(Protocol.size, "Протокол - необращающиеся цб", "Печать протокола");
      end;

      while(i<Protocol.size)
        PrintTableLine( "N3_SecCode",  Protocol[i].SecCode, null,               //1
                        "N3_SecName",  Protocol[i].SecName, null,               //2
                        "N3_CodeB",    Protocol[i].CodeB,   null,               //3
                        "N3_DZB",      Protocol[i].DZB,     null,               //4
                        "N3_Drez",     Protocol[i].Drez,    null                //5
                      );
        i = i + 1;
        ProgressIndicator.Update(i, Protocol.size); // всего 3 парамера Update(index, count, text)
      end;
      ProgressIndicator.Stop();
      EndTable();
    end;
  END;

  PRIVATE MACRO Get_str_PaymDateBuy(Type, DealPart)
     var sql_PlanDate:String = 
        " (NVL( (SELECT min(dlrq.t_PlanDate) " +
        "  FROM ddlrq_dbt dlrq " + 
        "  WHERE dlrq.t_DocKind    = DealBuy.t_BOfficeKind " +
        "     AND dlrq.t_DocID = DealBuy.t_DealID " +
        "     AND dlrq.t_Type    = " + string(Type) + 
        "     AND dlrq.t_DealPart    = " + string(DealPart) + 
        "     AND dlrq.t_FactDate = TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "     ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     var sql_FactDate:String = 
        " (NVL( (SELECT min(dlrq.t_FactDate) " +
        "  FROM ddlrq_dbt dlrq " + 
        "  WHERE dlrq.t_DocKind    = DealBuy.t_BOfficeKind " +
        "     AND dlrq.t_DocID = DealBuy.t_DealID " +
        "     AND dlrq.t_Type    = " + string(Type) + 
        "     AND dlrq.t_DealPart    = " + string(DealPart) + 
        "     AND dlrq.t_State = " + string(DLRQ_STATE_EXEC) +
        "     AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
        "     ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
        " ) ";

     return 
        " (DECODE( " +
             sql_FactDate + ", " +                   // Выражение
        "    TO_DATE('01-01-0001','DD-MM-YYYY'), " + // search1
             sql_PlanDate + ", " +                   // result1
             sql_FactDate + ") " +                   // default
        " ) ";
  END;


  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
     var QueryRest, DataQuery, AddWhere = "";
     var AvrFIID, AvrKind, AvrGroup, DealKind;
     var AvrFIIDList = null,
         AvrFIIDCount : Integer = 0,
         AvrFIIDAddWhere : String = "",
         WasSetSecurity : Bool = false,

         AvrKindList = null,
         AvrKindAddWhere : String = "",
         AvrKindCount : Integer = 0,
         
         GNUList = null,
         GNUAddWhere : String = "",
         GNUCount : Integer = 0;
     var ProgressValue = CTxProgressValue();
     
     ObjReport.BeginReport();

     if( m_ReportKind == SHRESREG_0901 )
       AddWhere = AddWhere + " AND (   RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_SHARE+", Fin.t_AvoirKind) > 0 "
                           + "      OR RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_DEPOSITORY_RECEIPT+", Fin.t_AvoirKind) > 0 )";
     elif( m_ReportKind == SHRESREG_0902 )
       AddWhere = AddWhere + " AND  RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", Fin.t_AvoirKind) > 0 ";
     end;

     if( not m_IsWebService )
        AvrFIIDList = TArray();
        AvrFIIDList[AvrFIIDList.Size] = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRCODE );
     else
        AvrFIIDList = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRCODE );
     end;
     if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
        while( AvrFIIDCount < AvrFIIDList.Size )
           if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
           and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
              if( AvrFIIDAddWhere == "" )
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
              else
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
              end;
              AvrFIIDAddWhere = AvrFIIDAddWhere + " TXRest.t_FIID = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
           end;
           AvrFIIDCount = AvrFIIDCount + 1;
        end;
        if( AvrFIIDAddWhere != "" )
           AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
           WasSetSecurity = true;
        end;
        AddWhere = AddWhere + AvrFIIDAddWhere;
     end;

     /*если не задана бумага*/
     if( not WasSetSecurity )
        if( not m_IsWebService )
           AvrKindList = TArray();
           AvrKindList[AvrKindList.Size] = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRKIND );
        else
           AvrKindList = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRKIND );
        end;
        /*задан вид бумаги*/
        if( ( ValType( AvrKindList ) != V_UNDEF ) and ( AvrKindList.Size > 0 ) )
           while( AvrKindCount < AvrKindList.Size )
              if( ( ValType( AvrKindList[AvrKindCount] ) == V_INTEGER )
              and ( AvrKindList[AvrKindCount] > 0 ) )
                 if( AvrKindAddWhere == "" )
                    AvrKindAddWhere = AvrKindAddWhere + " AND ( ";
                 else
                    AvrKindAddWhere = AvrKindAddWhere + " OR ";
                 end;
                 AvrKindAddWhere = AvrKindAddWhere + " RSB_FIInstr.FI_AvrKindsEQ(2, " + String( AvrKindList[AvrKindCount] ) + ", Fin.t_AvoirKind) = 1 ";
              end;
              AvrKindCount = AvrKindCount + 1;
           end;
           if( AvrKindAddWhere != "" )
              AvrKindAddWhere = AvrKindAddWhere + " ) ";
           end;
           AddWhere = AddWhere + AvrKindAddWhere;      
        end;

        if( not m_IsWebService )
           GNUList = TArray();
           GNUList[GNUList.Size] = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRGROUP );
        else
           GNUList = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRGROUP );
        end;
        /*задана категория бумаги*/
        if( ( ValType( GNUList ) != V_UNDEF ) and ( GNUList.Size > 0 ) )
           while( GNUCount < GNUList.Size )
              if( ( ValType( GNUList[GNUCount] ) == V_INTEGER )
              and ( GNUList[GNUCount] > 0 ) )
               if( GNUAddWhere == "" )
                    GNUAddWhere = GNUAddWhere + " AND ( ";
                 else
                    GNUAddWhere = GNUAddWhere + " OR ";
                 end;
                 GNUAddWhere = GNUAddWhere + " av.t_TaxGroup = " + String( GNUList[GNUCount] ) + " ";
              end;
              GNUCount = GNUCount + 1;
           end;
           if( GNUAddWhere != "" )
              GNUAddWhere = GNUAddWhere + " ) ";
           end;
           AddWhere = AddWhere + GNUAddWhere;
        end;
     end;
                                                          
     if( (ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_EXCLUDE ) == "X") AND (ИсключаемыеИзОтчетаЦБ != "") )
        AddWhere = AddWhere + " AND Fin.t_FI_Code not in (" + ИсключаемыеИзОтчетаЦБ + ")";
     end;

     DealKind = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_DEALKIND );
     if(DealKind == SHRESREG_DEALKIND_ALL)
       AddWhere = AddWhere + " AND SourceLot.t_Type in ("+TXLOTS_BUY+","+TXLOTS_BACKREPO+","+TXLOTS_LOANGET+")";
     elif(DealKind == SHRESREG_DEALKIND_BUY)
       AddWhere = AddWhere + " AND SourceLot.t_Type in ("+TXLOTS_BUY+")";
     elif(DealKind == SHRESREG_DEALKIND_BACKREPO)
       AddWhere = AddWhere + " AND SourceLot.t_Type in ("+TXLOTS_BACKREPO+","+TXLOTS_LOANGET+")";
     end;

     QueryRest =   " SELECT TXRest.t_SourceID, NVL(SUM(TXRest.t_Amount),0) AS Amount "
                 + "   FROM dsctxrest_dbt TXRest, dsctxlot_dbt SourceLot, dfininstr_dbt Fin, davoiriss_dbt av "
                 + "  WHERE SourceLot.t_ID = TXRest.t_SourceID " 
                 + "    AND (   TXRest.t_SaleDate > " + GetSQLDate(this.H0_8()) 
                 + "         OR TXRest.t_SaleDate = " + GetSQLDate(date(0,0,0)) 
                 + "         OR TXRest.t_SaleDate IS NULL "
                 + "        ) "
                 + "    AND ( TXRest.t_BuyDate <= " + GetSQLDate(this.H0_8()) + " AND TXRest.t_BuyDate <> " + GetSQLDate( DATE(0,0,0) ) + " ) "
                 + "    AND TXRest.t_Amount > 0 "
                 + "    AND Fin.t_FIID = TXRest.t_FIID "
                 + "    AND av.t_FIID = Fin.t_FIID "
                 + "    AND av.t_TaxGroup <> 13 AND av.t_TaxGroup <> 35 AND av.t_TaxGroup <> 919 AND av.t_TaxGroup <> 943 "
                 + AddWhere 
                 + " GROUP BY TXRest.t_SourceID";

     DataQuery =   " SELECT FinInstr.t_FI_Code AS AvrCode, FinInstr.t_Name AS AvrName, DealBuy.t_DealCodeTS, FinInstr.t_FaceValueFI, FinInstr.t_SumPrecision AS SumPrecision, "
                 + "        (case when Avoir.t_ISIN IS null OR Avoir.t_ISIN IN (chr(0), chr(1)) then (case when Avoir.t_LSIN IS null OR Avoir.t_LSIN IN (chr(0), chr(1)) then chr(0) else Avoir.t_LSIN end) else Avoir.t_ISIN end) AS t_ISIN, "
                 + Get_str_PaymDateBuy(DLRQ_TYPE_DELIVERY, 1) + " DDB, "
                 + "        dlleg.t_NKD NkdBuy, "
                 + Get_str_PaymDateBuy(DLRQ_TYPE_PAYMENT, 1) + " as t_PaymDate, "
                 + "        QueryRest.Amount as Qnty, dlleg.t_CFI VPrB, DealBuy.t_BofficeKind AS DealBuyBofficeKind, DealBuy.t_DealID DealBuyID, TXLotBuy.t_DealDate DealBuyDate, "
                 + "        FinInstr.t_FIID FIID, dlleg.t_Cost SumBmain, dlleg.t_Price Price, dlleg.t_Principal QB, rsb_secur.get_OperationGroup(BuyOper.t_SysTypes) AS DealBuyGroup, "
                 + "        dlleg.t_CFI CFI, FinInstr.t_Issuer Issuer, DealBuy.t_Department AS DealBuyDepartment, Avoir.t_TaxGroup TaxGroup, "
                 + "        Rsb_SCTX.GetMarketPrice( TXLotBuy.t_ID, 0 ) AS BuyMarketPrice, "
                 + "        Rsb_SCTX.GetMarket( TXLotBuy.t_ID, 0 ) AS BuyMarket, "
                 + "        NVL(Rsb_SCTX.GetVal_Market_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ), 0) AS Val_MarketB,"
                 + "        NVL((select t_fiid from dfininstr_dbt where t_fi_kind=1 and t_iso_number = "
                 + "            Rsb_SCTX.GetVal_Market_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ) and rownum = 1), 0) AS Val_MarketB_Fiid,"
                 + "        Rsb_SCTX.GetDateMarket( TXLotBuy.t_ID, 0 ) AS BuyDateMarket, "
                 + "        TXLotBuy.t_Type as TypeB, "
                 + "        Rsb_SCTX.GetRezMrkt(FinInstr.t_FIID,"+GetSQLDate(this.H0_8())+") as RezMrkt, "
                 + "        Rsb_SCTX.IfMarketRez(FinInstr.t_FIID,"+GetSQLDate(this.H0_8())+") as IfMarket, "
                 + "        Rsb_SCTX.GetMrktRez(FinInstr.t_FIID,"+GetSQLDate(this.H0_8())+") as MrktRez, "
                 + "        Rsb_SCTX.GetDMrktRez(FinInstr.t_FIID,"+GetSQLDate(this.H0_8())+") as DMrktRez, "
                 + "        CASE WHEN((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) THEN 1 ELSE 0 end as IsDUDealB, "
                 + "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) as ImportDUDate "
                 + "  FROM (" + QueryRest + ") QueryRest," 
                 + "       DDL_TICK_DBT  DealBuy,"                      
                 + "       DSCTXLOT_DBT  TXLotBuy, "
                 + "       DDL_LEG_DBT   dlleg, "
                 + "       DFININSTR_DBT FinInstr, "
                 + "       DOPRKOPER_DBT BuyOper, " 
                 + "       DAVOIRISS_DBT Avoir "
                 + " WHERE TXLotBuy.t_ID  = QueryRest.t_SourceID " 
                 + "   AND DealBuy.t_DealID = TXLotBuy.t_DealID "
                 + "   AND FinInstr.t_FIID = TXLotBuy.t_FIID " 
                 + "   AND Avoir.t_FIID = FinInstr.t_FIID "
                 + "   AND dlleg.t_LegKind = "+ string(LEG_KIND_DL_TICK)
                 + "   AND dlleg.t_DealID  = DealBuy.t_DealID "
                 + "   AND dlleg.t_LegID   = 0 "
                 + "   AND BuyOper.t_Kind_Operation = DealBuy.t_DealType " 
                 + "   AND BuyOper.t_DocKind        = DealBuy.t_BOfficeKind "
                 + "   AND ((SELECT COUNT(1)"
                 + "          FROM dobjatcor_dbt objatcor"
                 + "         WHERE objatcor.t_ObjectType = 12"
                 + "           AND objatcor.t_GroupID = 57" //Включать ц/б в расчётрезервов для НУ
                 + "           AND objatcor.t_AttrID = 1" //Да
                 + "           AND objatcor.t_Object = LPAD(FinInstr.t_FIID, 10, '0' )) > 0";

                 if( SC_IncludeSecurInCalcOfReservTax() == true )
                    DataQuery = DataQuery + 
                        "         OR (SELECT COUNT(1)" +
                        "          FROM dobjatcor_dbt objatcor" +
                        "         WHERE objatcor.t_ObjectType = 12" +
                        "           AND objatcor.t_GroupID = 57" +
                        "           AND objatcor.t_Object = LPAD(FinInstr.t_FIID, 10, '0' )) = 0";
                 end;
                 DataQuery = DataQuery + " ) ORDER BY TXLotBuy.t_BuyDate" ;

     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Current = 0;

     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header1 = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(Protocol.size, header1, header1);
     else
       ProgressIndicator.Start(Protocol.size, HTML_StSheetName, HTML_StSheetName);
     end;
     
     m_RS = TRsbDataSet( DataQuery );

     m_CacheFinInstr.Clear();
     T_Dep.ClearArray();
     while( m_RS.MoveNext() )
        this.ClearCacheOneRecord();
        if(m_RS.IfMarket==SET_CHAR)
          m_IsDataExist = true;
          ObjReport.ПечататьСтрокуТаблицы( Строка_СтрокаДанных );
        else
          Protocol[Protocol.size] = ProtocolData(this.SecCode(), this.SecName(), this.CodeB(), this.DZB(), this.Drez());
        end;
        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); // всего 3 парамера Update(index, count, text)
     end;

     ProgressIndicator.Stop();
     ObjReport.EndReport();

  END;

  PRIVATE MACRO CreateReportByKind( Kind:INTEGER )
     m_ReportKind = Kind;

     if( Kind == SHRESREG_0901 )
        ExecuteReport( CShResReg_901(this) );
     elif( Kind == SHRESREG_0902 )
        ExecuteReport( CShResReg_902(this) );
     end;
  END;

  PRIVATE MACRO Create()
     Protocol.size = 0;

     var SubKindList = null;
     var SubKindCount : Integer = 0;
     if( not m_IsWebService )
        SubKindList = TArray();
        SubKindList[SubKindList.Size] = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_SUBKIND );
     else
        SubKindList = ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_SUBKIND );
     end;

     if( ( ValType( SubKindList ) != V_UNDEF )
     and ( SubKindList.Size > 0 )
     and ( ValType( SubKindList[SubKindCount] ) == V_INTEGER )
     and ( SubKindList[SubKindCount] != SHRESREG_ALL ) )
        while( SubKindCount < SubKindList.Size )
           CreateReportByKind( SubKindList[SubKindCount] );
           SubKindCount = SubKindCount + 1;
        end;
     else
        CreateReportByKind( SHRESREG_0901 );
        CreateReportByKind( SHRESREG_0902 );
     end;

     PrintProtocol();
  END;

  PRIVATE VAR m_DZB, m_PrBNom, m_NomB, m_SumBvn, m_SumBvp, m_CrDU,
              m_CrBD, m_CrBP, m_SumBrub, m_PrBvp, m_PrBrub, m_PrBvn, m_ComB,
              m_AmortVN, m_AmortRub, m_SumBrez, m_CrRez, m_CrBZ, m_NomRez, m_DQual, 
              m_DealBuy = TBFile( "dl_tick.dbt", "R", 0 );

  MACRO ClearCacheOneRecord()
    m_DZB     = NULL; 
    m_PrBNom  = NULL;
    m_NomB    = NULL;
    m_SumBvn  = NULL;
    m_SumBvp  = NULL;              
    m_CrBD    = NULL;
    m_CrBP    = NULL;
    m_SumBrub = NULL;
    m_PrBvp   = NULL;
    m_PrBrub  = NULL;
    m_PrBvn   = NULL;
    m_ComB    = NULL;
    m_AmortVN = NULL;
    m_AmortRub = NULL;
    m_SumBrez  = NULL;
    m_CrRez   = NULL;
    m_CrBZ    = NULL;
    m_NomRez  = NULL;
    m_DQual   = NULL;
    m_DealBuy.Clear();
  END;

  PRIVATE MACRO GetDeal( Deal:TBFile, DealID:INTEGER ):BOOL
     Deal.Clear();
     Deal.rec.DealID = DealID;
     return Deal.GetEQ();
  END;

  MACRO DealBuy():TBFile
     if( m_DealBuy.rec.DealID == 0 )
        if( GetDeal( m_DealBuy, m_RS.DealBuyID ) == false )
           MsgBox( "Не найдена сделка по лоту налогового учета DSCTXLOT_DBT.t_DealID = " + string(m_RS.DealBuyID)  );
           m_DealBuy.Clear();
        end;
     end;
     return m_DealBuy;
  END;

  PRIVATE MACRO BuyIsBack():BOOL
     return ( IsSale( int(m_RS.DealBuyGroup) ) OR IsAVRWRTOUT( int(m_RS.DealBuyGroup) ) );
  END;

    /*Наименование нашего банка*/
  MACRO H0_A():STRING
     return ПолучитьКороткоеИмяСубъекта( {OurBank} );
  END;

  /*ИНН / КПП нашего банка*/
  MACRO H0_B()
     VAR INN, KPP;

     SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, KPP );
     return INN + "/" + KPP;
  END;

  /*Константа, задаваемая в макросе формировании отчета. Значение константы - текст "09"*/
  MACRO H0_1():STRING
     return "09";
  END;

  /*Константа, задаваемая в макросе формировании отчета.  Значение константы - текст  "XXX"*/
  MACRO H0_2():STRING
     return "XXX";
  END;

  MACRO H0_3():STRING
     if( m_ReportKind == SHRESREG_0901 )
       return "01";
     elif( m_ReportKind == SHRESREG_0902 )
       return "02";
     end;
  END;

  /*Номер месяца из даты <H0_.8>*/
  MACRO H0_4():STRING
     VAR Month;
     DateSplit( this.H0_8(), null, Month, null );

     return string(Month:2:o);
  END;

  /*Две последние цифры года из даты <H0_.8>*/
  MACRO H0_5():STRING
     VAR Year;
     DateSplit( this.H0_8(), null, null, Year );

     return SubStr( string(Year), strlen(string(Year))-1 );
  END;

  /*Название подвида регистра:*/
  MACRO H0_6():STRING
     if( m_ReportKind == SHRESREG_0901 )
        return "Расчет резерва под обесценение акций и депозитарных расписок";
     elif( m_ReportKind == SHRESREG_0902 )
        return "Расчет резерва под обесценение облигаций";
     end;
  END;

  /*Отчетная дата, указанная в форме запуска отчета*/
  MACRO H0_8():DATE
     return date(ShortResReg_Form.GetFieldValue(PNFLD_SHRESREG_REPDATE));
  END;

  /*Группа налогового учета*/
  MACRO H0_9():STRING
     var GroupName = "";
     ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRGROUP, @GroupName );
     return GroupName;
  END;

  /*Вид ц/б*/
  MACRO H0_10():STRING
     var AvrKindShowValue = "";
     ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRKIND, @AvrKindShowValue );
     return AvrKindShowValue;
  END;

  /*Выпуск ц/б*/
  MACRO H0_11():STRING
     return ShortResReg_Form.GetFieldValue( PNFLD_SHRESREG_AVRNAME );
  END;

  /*Константа, задаваемая в макросе формировании отчета.  Значение константы - текст  "РР"*/
  MACRO H0_12():STRING
     return "PP";
  END;

  MACRO SecCode():STRING
    return m_RS.AvrCode;
  END;
   
  MACRO SecName():STRING
    return m_RS.AvrName;
  END;

  MACRO ISIN():STRING
    return m_RS.ISIN;
  END;
   
  MACRO Drez():DATE
    return this.H0_8();
  END;
    
  MACRO CodeB():STRING
    return m_RS.DealCodeTS;
  END;
   
  MACRO VN():STRING
    return m_CacheFinInstr.GetISO( m_RS.FaceValueFI ).m_Number;
  END;
      
  MACRO DZB():DATE
     /* 26 - договор купли продажи*/
     if( m_DZB == NULL )
       m_DZB = SQL_ConvTypeDate(m_RS.DealBuyDate);
     end;
     return m_DZB;
  END;
     
  MACRO DDB():DATE
    return SQL_ConvTypeDate( m_RS.DDB );
  END;
     
  MACRO Qnty():MONEY
    return m_RS.Qnty;
  END;
    
  MACRO QntyPrecision():INTEGER
    return m_RS.SumPrecision;
  END;

  MACRO PrBnom():DOUBLE
    if( m_PrBNom == NULL )
      m_PrBNom = m_RS.Price;
    end;
    return m_PrBNom;
  END;
  
  MACRO SumBvn():MONEY
    if( m_SumBvn == NULL )
      if(m_RS.VPrB == m_RS.FaceValueFI)
        m_SumBvn = this.SumBvp();
      else
        if(m_RS.VPrB == NATCUR)
          m_SumBvn = this.SumBvp()/this.CrBD();
        elif(m_RS.FaceValueFI == NATCUR)
          m_SumBvn = this.SumBvp()*this.CrBD();
        else
          m_SumBvn = this.SumBvp()/this.CrBP();
        end;
      end;
    end;
    return m_SumBvn;
  END;

  /*Курс ЦБ РФ валюты цены договора на дату поставки ценных бумаг*/
  MACRO CrVPr_DDB():DOUBLE
    if (m_CrVPr_DDB == NULL)
      m_CrVPr_DDB = GetRateOnDateCrossDbl(this.DDB(), m_RS.VPrB, NATCUR,
                                          true);
    end;

    if ((m_CrVPr_DDB == NULL) or (m_CrVPr_DDB == 0.0))
      m_CrVPr_DDB = NULL;
      return 1.0;
    end;

    return m_CrVPr_DDB;
  END;
  
  MACRO SumBrub():MONEY
    if(m_SumBrub == NULL)
      if(m_RS.VprB == NATCUR)
        m_SumBrub = this.SumBvp();
      else
        var V19 = 0;
        GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
        if (this.IsDUDealB() == 1)
          m_SumBrub = this.SumBvp() * this.CrDU();
        elif ((V19 == 1) and (this.TypeB() == "B"))
          m_SumBrub = (this.SumBvp() + m_RS.NkdBuy * Qnty() / m_RS.QB)
                    * this.CrBD() - m_RS.NkdBuy * Qnty() / m_RS.QB
                    * this.CrVPr_DDB();
        else
          m_SumBrub = this.SumBvp() * this.CrBD();
        end;
      end;
    end;
    return m_SumBrub;
  END;
 
  MACRO MaxMrkt():DOUBLE
     return m_RS.BuyMarketPrice;
  END;
 
  MACRO MrktB():STRING
     return SQL_ConvTypeStr( m_RS.BuyMarket );
  END;

  MACRO DMrktB():DATE
     return SQL_ConvTypeDate(m_RS.BuyDateMarket);
  END;
  
  MACRO ComB():MONEY
     if( m_ComB == NULL )
        m_ComB = ( СуммаКомиссий( DealBuy().rec.DealID, DealBuy().rec.BOfficeKind, DDB(), NATCUR )) * (Qnty()/m_RS.QB);
     end;
     return m_ComB;
  END;
    
  MACRO AmortVN():MONEY
     if( m_AmortVN == NULL )
        m_AmortVN = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1, this.H0_8() );
     end;
     return m_AmortVN;
  END;
 
  MACRO AmortRub():MONEY
     if( m_AmortRub == NULL )
        m_AmortRub = GetPartialSumByPeriod_Rub( m_RS.FIID, Qnty(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1, this.H0_8() );
     end;
     return m_AmortRub;
  END;

  PRIVATE VAR m_CrB;
  PRIVATE CONST NOTEKIND_SECDEAL_REJECTMPRICE = 27;

  MACRO CrB():DOUBLE
    var CrBDate = iif(this.PaymDate() == ZeroDate,this.DDB(),
                      min(this.DDB(),this.PaymDate()));              
    m_CrB = GetRateOnDateCrossDbl(CrBDate, m_RS.VprB, NATCUR, true);
    return m_CrB;
  END;

  MACRO SumBrez():MONEY
     var PrDeal, K1, K2, K3, DifB, KN, CV, Srub, NumInList;
     if(m_SumBrez == NULL)
       if(m_ReportKind == SHRESREG_0901)
         if(m_RS.FaceValueFI == m_RS.VprB)
           PrDeal = m_RS.Price;
         else
           K1 = GetRateOnDateCrossDbl( this.DZB(), m_RS.VprB, NATCUR, true );
           K2 = GetRateOnDateCrossDbl( this.DZB(), m_RS.FaceValueFI, NATCUR, true );
           if((ValType(K1) != V_UNDEF) and (ValType(K2) != V_UNDEF))
             PrDeal = m_RS.SumBmain*K1/(m_RS.QB*K2);
           end;
         end;

         KN = 1;
       else
         PrDeal = m_RS.Price;
         KN = this.NomB()/100.0; 
       end;

       if((m_RS.FaceValueFI != NATCUR) and (m_RS.VprB != NATCUR) and (m_RS.FaceValueFI == m_RS.VprB))
         CV = this.CrBD();
       elif((m_RS.FaceValueFI == NATCUR) and (m_RS.VprB == NATCUR))
         CV = 1;
       else
         K1 = GetRateOnDateCrossDbl( this.DZB(), m_RS.FaceValueFI, NATCUR, true );
         K2 = GetRateOnDateCrossDbl( this.DDB(), m_RS.VprB, NATCUR, true );
         K3 = GetRateOnDateCrossDbl( this.DZB(), m_RS.VprB, NATCUR, true );
         if(K3 != 0.0)
           CV = K1*K2/K3;
         else
           CV = 1;
         end;
       end;
////////////////////////////////////////////////////////////////////////////////
      if (IsFilledNoteByDeal(this.DealBuy().rec.DealID, 
                             NOTEKIND_SECDEAL_REJECTMPRICE))
        DifB = readNoteForObject(OBJTYPE_SECDEAL, UniID(this.DealBuy(),
                                                          OBJTYPE_SECDEAL),
                                 NOTEKIND_SECDEAL_REJECTMPRICE);
        DifB = double(DifB) * this.Qnty() / m_RS.QB;
      else
        if ((this.MaxMrkt() == 0) or (StrUpr(this.MrktB) == "ФАКТ") 
            or (StrUpr(this.MrktB) == "НЕКОНТРОЛИРУЕМАЯ СДЕЛКА"))
          DifB = 0;
        else
          var SumMrkt = 0;
          var _Val_MarketB_FIID = IIF(m_RS.Val_MarketB == 0,
                                      m_RS.FaceValueFI,
                                      m_RS.Val_MarketB_Fiid);
          var m_Cr_Val_MrkBZ = GetRateOnDateCrossDbl(this.DZB(), 
                                                     _Val_MarketB_FIID, NATCUR,
                                                     true);

          var _CrBZ;

          if (m_RS.FaceValueFI == NATCUR)
            _CrBZ = 1;
          else
            _CrBZ = GetRateOnDateCrossDbl(this.DZB(), m_RS.FaceValueFI, NATCUR,
                                         true);
            if ((_CrBZ == NULL) or (_CrBZ == 0.0))
              _CrBZ = 1;
            end;
          end;
          if (m_ReportKind == SHRESREG_0901)
            SumMrkt = this.MaxMrkt() * m_Cr_Val_MrkBZ / _CrBZ 
                      * this.Qnty();
            if (this.SumBvp() - SumMrkt > 0)
              DifB = (this.SumBvp() - SumMrkt) * this.CrBD();
            else
              DifB = 0;
            end;
          else
            if (m_RS.FaceValueFI == NATCUR)
              SumMrkt = this.MaxMrkt() * this.NomB() / 100 * this.Qnty();
              if (this.SumBrub() - SumMrkt > 0)
                DifB = this.SumBrub() - SumMrkt;
              else
                DifB = 0;
              end;
            else
              if (m_RS.VprB == NATCUR)
                SumMrkt = this.MaxMrkt() * this.NomB() / 100 * this.Qnty()
                          * _CrBZ;
                if (this.SumBvp() - SumMrkt > 0)
                  DifB = this.SumBvp() - SumMrkt;
                else
                  DifB = 0;
                end;
              else
                var V19 = 0;
                GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 
                                 0);
                SumMrkt = this.MaxMrkt() * this.NomB() / 100 * this.Qnty();
                if (V19 == 1)
                  if (this.SumBrub() - SumMrkt * _CrBZ > 0)
                    DifB = this.SumBrub() - SumMrkt * _CrBZ;
                  else
                    DifB = 0;
                  end;
                else
                  if (this.SumBvp() - SumMrkt > 0)
                    DifB = (this.SumBvp() - SumMrkt) * this.CrB();
                  else
                    DifB = 0;
                  end;
                end;
              end;
            end;
          end;
        end;
      end;
////////////////////////////////////////////////////////////////////////////////

       Srub = this.SumBrub();

       if(m_ReportKind == SHRESREG_0901)
          m_SumBrez = Srub-DifB+this.ComB();
       else
          if( not GetCalcWithRetPart() )
             m_SumBrez = Srub-this.AmortRub()-DifB+this.ComB();
          else
             m_SumBrez = Srub * (1 - this.AmortVN() / this.NomB() / this.Qnty()) + this.ComB() - DifB;
          end;
       end;

     end;
     return m_SumBrez;
  END;
 
  MACRO RezMrkt():DOUBLE
    return SQL_ConvTypeSum(m_RS.RezMrkt);
  END;
 
  MACRO MrktRez():STRING
    return SQL_ConvTypeStr(m_RS.MrktRez);
  END;
 
  MACRO DMrktRez():DATE
    return SQL_ConvTypeDate(m_RS.DMrktRez);
  END;

  MACRO RezRub():MONEY
     VAR RR;

     if( m_ReportKind == SHRESREG_0901 )
        RR = this.SumBrez()-this.RezMrkt()*this.Qnty()*this.CrRez();
     else
        RR = this.SumBrez()-this.RezMrkt()*this.Qnty()*this.CrRez()*this.NomRez()/100.0; 
     end;

     if( RR <= 0 )
        RR = 0;
     end;

     return RR;
  END;
  
  MACRO VprB():STRING
    return m_CacheFinInstr.GetISO( m_RS.VPrB ).m_Number;
  END;

  MACRO PrBvp():MONEY
    if(m_PrBvp == NULL)
      if((m_RS.CFI) != NATCUR AND (m_ReportKind == SHRESREG_0901))
        m_PrBvp = m_RS.Price;
      end;
    end;
    return m_PrBvp;
  END;

  MACRO PrBrub():MONEY
    if(m_PrBrub == NULL)
      if(m_ReportKind == SHRESREG_0901)
        if(m_RS.VprB == NATCUR)
          m_PrBrub = m_RS.Price;
        else
          m_PrBrub = this.SumBrub()/this.Qnty();
        end;
      end;
    end;
    return m_PrBrub;
  END;

  MACRO SumBvp():MONEY
    if(m_SumBvp == NULL)
      m_SumBvp = m_RS.SumBmain*this.Qnty()/m_RS.QB; 
    end;
    return m_SumBvp;
  END;
    
  MACRO CrBZ():DOUBLE 
     if( m_CrBZ == NULL )
        if(m_ReportKind == SHRESREG_0901)
          m_CrBZ = GetRateOnDateCrossDbl( this.DZB(), m_RS.VprB, m_RS.FaceValueFI, true );
        else
          if(m_RS.FaceValueFI == NATCUR)
            m_CrBZ = GetRateOnDateCrossDbl( this.DZB(), m_RS.VprB, NATCUR, true );
          else
            m_CrBZ = GetRateOnDateCrossDbl( this.DZB(), m_RS.FaceValueFI, NATCUR, true );
          end;
        end;
     end;

     if((m_CrBZ == NULL) or (m_CrBZ == 0.0))
       m_CrBZ = NULL;
       return 1.0;
     end;

     return m_CrBZ;
  END;

  MACRO printCrBZ():DOUBLE
    this.CrBZ();
    return m_CrBZ;
  END;

  MACRO PaymDate():DATE
     return SQL_ConvTypeDate(m_RS.PaymDate);
  END;

  MACRO CrDU():DOUBLE
    if ((m_CrDU == 0) or (m_CrDU == NULL))
      if(m_RS.VPrB == NATCUR)
        m_CrDU = 1.0;
      else
        m_CrDU = GetRateOnDateCrossDbl(this.ImportDUDate(), m_RS.VPrB, NATCUR, true);
      end;
    end;

    if((m_CrDU == NULL) or (m_CrDU == 0.0))
      m_CrDU = NULL;
      return 1.0;
    end;

    return m_CrDU;
  END;

  MACRO CrBD():DOUBLE
    if(m_CrBD == NULL)
      m_CrBD = ПолучитьКурсПостановкиНаБаланс(DealBuy());
      if ((m_CrBD == 0) or (m_CrBD == NULL))
        if(m_RS.VPrB == NATCUR)
          m_CrBD = 1;
        else
          if (this.TypeB() == "B")
            m_CrBD = GetRateOnDateCrossDbl(mindate(this.DDB(), this.PaymDate()),
                                           m_RS.VprB, NATCUR, true);
          else
            m_CrBD = GetRateOnDateCrossDbl(this.DDB(), m_RS.VPrB, NATCUR, true);
          end;
        end;
      end;
    end;

    if((m_CrBD == NULL) or (m_CrBD == 0.0))
      m_CrBD = NULL;
      return 1.0;
    end;

    return m_CrBD;
  END;

  MACRO printCrBD():DOUBLE
    this.CrBD();
    return m_CrBD;
  END;
    
  MACRO CrBP():DOUBLE
    var VprBrate=NULL;
    if(m_CrBP == NULL)
      if((m_RS.FaceValueFI == NATCUR) and (m_RS.VprB == NATCUR))
        m_CrBP = 1;
      elif((m_RS.FaceValueFI == NATCUR) and (m_RS.VprB != NATCUR))
        VprBrate = GetRateOnDateCrossDbl( this.DDB(), m_RS.VprB, NATCUR, true );
        if((ValType(VprBrate) != V_UNDEF) AND (VprBrate != 0.0))
          m_CrBP = 1/VprBrate;
        else
          m_CrBP = 0.0;
        end;
      elif((m_RS.FaceValueFI != NATCUR) and (m_RS.VprB != NATCUR))
        VprBrate = GetRateOnDateCrossDbl( this.DDB(), m_RS.VprB, NATCUR, true );
        if((ValType(VprBrate) != V_UNDEF) AND (VprBrate != 0.0))
          m_CrBP = GetRateOnDateCrossDbl( this.DDB(), m_RS.FaceValueFI, NATCUR, true )/VprBrate;
        else
          m_CrBP = 0.0;
        end;
      else
        m_CrBP = GetRateOnDateCrossDbl( this.DDB(), m_RS.FaceValueFI, NATCUR, true );
      end;
    end;

    if((m_CrBP == NULL) or (m_CrBP == 0.0))
      m_CrBP = NULL;
      return 1.0;
    end;

    return m_CrBP;
  END;

  MACRO printCrBP():DOUBLE
    this.CrBP();
    return m_CrBP;
  END;
    
  MACRO CrRez():DOUBLE
    if( m_CrRez == NULL )
       if(m_RS.FaceValueFI == NATCUR)
         m_CrRez = 1.0;
       else
         m_CrRez = GetRateOnDateCrossDbl( this.DRez(), m_RS.FaceValueFI, NATCUR, true );
       end;
    end;

    if((m_CrRez == NULL) or (m_CrRez == 0.0))
      m_CrRez = NULL;
      return 1.0;
    end;

    return m_CrRez;
  END;

  MACRO printCrRez():DOUBLE
    this.CrRez();
    return m_CrRez;
  END;
                                                                                      
  MACRO PrBvn():MONEY
    if(m_PrBvn == NULL)
      if(m_RS.VPrB == m_RS.FaceValueFI)
        m_PrBvn = m_RS.Price;
      else
        m_PrBvn = this.SumBvn()/this.Qnty();
      end; 
    end;
    return m_PrBvn;
  END;
   
  MACRO Emit():STRING
     return ПолучитьКороткоеИмяСубъекта( m_RS.Issuer );
  END;
    
  MACRO NomB():DOUBLE
    if( m_NomB == NULL )
      m_NomB = GetFaceValue( m_RS.FIID, iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()), true, false );
    end;
    return m_NomB;
  END;
    
  MACRO NomRez():DOUBLE
     if( m_NomRez == NULL )
        m_NomRez = GetFaceValue( m_RS.FIID, this.H0_8(), true, false );
     end;
     return m_NomRez;
  END;
  
  MACRO DQual():DATE
    if(m_DQual == NULL)
      m_DQual = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_REQUALREPO);
      if((ValType(m_DQual) != V_UNDEF) and (m_DQual != ""))
        m_DQual = date(m_DQual);
      end;
    end;
    return m_DQual;
  END;
   
  MACRO FilB()
     return T_Dep.Get_Dep(m_RS.DealBuyDepartment);
  END;

  MACRO SecType()
     return m_RS.TaxGroup;
  END;

  MACRO TypeB():STRING //Код сделки приобретения

     if( m_RS.TypeB == TXLOTS_BUY )
        return "B";
     elif( m_RS.TypeB == TXLOTS_SALE )
        return "S";
     elif( m_RS.TypeB == TXLOTS_REPO )
        return "РП";
     elif( m_RS.TypeB == TXLOTS_BACKREPO )
        return "РО";
     elif( m_RS.TypeB == TXLOTS_LOANPUT )
        return "ЗП";
     elif( m_RS.TypeB == TXLOTS_LOANGET )
        return "ЗО";
     else
        return "";
     end;

  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode );
  SetRowFlushCount(2000);
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( stat )
    if( not IsWebService )
      ShortResReg_Form = SP_ShortResReg_Panel();
    else
      if( ValType( FormData ) != V_UNDEF )
        ShortResReg_Form = WS_TX_ShortResReg_Panel( FormData );
      else
        stat = false;
      end;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = ShortResReg_Form.Run();
    end;

    if( stat )
      ShortResReg_Report = SP_ShortResReg_Report( null, "Report_TxShortRegisterRes.xlsx", false, IsWebService, ReportHashCode, POI_MODE, BIGREPORT_MODE);
      ShortResReg_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( ShortResReg_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = ShortResReg_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( ShortResReg_Report.PrintMode() );
      end;
    end;
end;

  return FullReportFileNames;
END;
