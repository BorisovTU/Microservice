/*                           
$Name:             scservop_ext.mac
$Module:           Ценные бумаги
$Description:      Сервисные операции (операции сопровождения). Дополнительное
*/

import globals, SPInter, BankInter, OprInter, CTInter, DealsInter, FIInter, "dlcnst.inc";

MACRO SpServGetQuery(dl_comm, KindDoc, Type)
  If (ValType(Type) != V_INTEGER)
    Type = INCOME_UNKNOWN;
  End;
  
  var Query =
  " Select d.t_DealID DealID "
  + "   From ddl_tick_dbt d, "
  + "        ( Select oper.t_Kind_Operation, oper.t_DocKind, "
  + "                 rsb_secur.get_OperationGroup(oper.t_SysTypes) as OperGroup "
  + "            From doprkoper_dbt oper "
  + "        ) OperData "
  + "  Where d.t_BofficeKind = ? "
  + "    and d.t_DealStatus = ? "
  + "    and d.t_DealDate <= ? ";
  
  If (dl_comm.rec.ClientID != -1)
    If (dl_comm.rec.DocKind == DL_RESERVEDOC)
      Query = Query + "    and d.t_PartyID = ? ";
      If ((dl_comm.rec.DestPOrtofolio > KINDPORT_UNDEF) And (dl_comm.rec.OperationKind == KINDRES_RCB))
        Query = Query + "    AND d.t_PortfolioID = ? ";
      End;
    Else
      If (dl_comm.rec.ClientID == {OurBank})
        Query = Query
        +   "    and (d.t_ClientID = ? or d.t_ClientID = ?) ";
      Else
        Query = Query
        +   "    and d.t_ClientID = ? ";
      End;
    End;
  End;
  
  Query = Query
  +"    and OperData.t_Kind_Operation = d.t_DealType "
  +"    and OperData.t_DocKind        = d.t_BOfficeKind "
  +"    and Rsb_Secur.IsRet_Coupon(OperData.OperGroup)!=1 ";
  
  If (((dl_comm.rec.DocKind == DL_GET_INCOME) And ((dl_comm.rec.Flag2 == SET_CHAR) Or (dl_comm.rec.Flag3 == SET_CHAR))) And (dl_comm.rec.FIID > 0))
    Query = Query
    +"    and ((Select leg.t_PFI "
    +"            From ddl_leg_dbt leg "
    +"           Where leg.t_DealID = d.t_DealID "
    +"             and leg.t_LegKind = ? "
    +"             and leg.t_LegID = 0 "
    +"         ) = ? "
    +"         OR "
    +"         (select sum(case when ens.t_Kind = ? then nvl(ens.t_Principal,0) else nvl(-t_Principal,0) end) "
    +"            from ddl_tick_ens_dbt ens "
    +"           where ens.t_DealID = d.t_DealID "
    +"             and ens.t_Date <= ? "
    +"             and ens.t_FIID = ? "
    +"         ) > 0"
    +"        )";
  End;
  
  If ( (dl_comm.rec.DocKind == DL_GET_INCOME) And (Type == INCOME_BACK_KA) )
    Query = Query
    +" and ((d.t_Flag5 = chr(88) and Rsb_Secur.IsBuy(OperData.OperGroup) = 1 and Rsb_Secur.IsREPO(OperData.OperGroup) = 1) or "
    +"      (d.t_Flag3 = chr(88) and Rsb_Secur.IsBuy(OperData.OperGroup) = 1 and Rsb_Secur.IsLOAN(OperData.OperGroup) = 1)) ";
  ElIf ((dl_comm.rec.DocKind == DL_GET_INCOME) And (Type == INCOME_REPO))
    Query = Query + "    and  Rsb_Secur.IsREPO(OperData.OperGroup) = 1 ";
  End;
  
  If ( dl_comm.rec.DocKind == DL_OVERVALUE_RD ) /*переоценка требований и обязательств*/
     /* покупки и продажи, не репо, не займы, не обр. продажи */
    Query = Query
    +"     and ((Rsb_Secur.IsBuy(OperData.OperGroup)=1 or Rsb_Secur.IsSale(OperData.OperGroup)=1) "
    +"     and  (Rsb_Secur.IsREPO(OperData.OperGroup)!=1) and (Rsb_Secur.IsBACKSALE(OperData.OperGroup)!=1)"
    +"     and  (Rsb_Secur.IsLOAN(OperData.OperGroup)!=1)) ";
    
      /*только сделки на внебалансе*/
    Query = Query
    +"    and ((Select leg.t_OperState "
    +"            From ddl_leg_dbt leg "
    +"           Where leg.t_DealID = d.t_DealID "
    +"             and leg.t_LegKind = ? "
    +"             and leg.t_LegID = 0 "
    +"         ) = ? "
    +"         OR "
    +"         (Exists(select 1 "
    +"                   from ddlgrdeal_dbt grdeal "
    +"                  where grdeal.t_DocKind = d.t_BOfficeKind "
    +"                    and grdeal.t_DocID = d.t_DealID "
    +"                    and grdeal.t_TemplNum = ? "
    +"                    and Exists(select 1 from ddlgracc_dbt gracc "
    +"                                where gracc.t_GrDealID = grdeal.t_ID "
    +"                                  and gracc.t_AccNum = ? "
    +"                                  and gracc.t_State = ? "
    +"                                  and gracc.t_FactDate <= ? "
    +"                              ) "
    +"                 ) "
    +"           and not Exists(select 1 "
    +"                            from ddlgrdeal_dbt grdeal "
    +"                           where grdeal.t_DocKind = d.t_BOfficeKind "
    +"                             and grdeal.t_DocID = d.t_DealID "
    +"                             and grdeal.t_TemplNum = ? "
    +"                             and Exists(select 1 from ddlgracc_dbt gracc "
    +"                                         where gracc.t_GrDealID = grdeal.t_ID "
    +"                                           and gracc.t_AccNum = ? "
    +"                                           and gracc.t_State = ? "
    +"                                       ) "
    +"                         ) "
    +"         ) "
    +"        )";
    
      /*ВЦ != НацВ*/
    If ((dl_comm.rec.Flag1 != SET_CHAR) And (dl_comm.rec.Flag2 == SET_CHAR ))
      Query = Query
      +"    and (Select leg.t_CFI "
      +"           From ddl_leg_dbt leg "
      +"          Where leg.t_DealID = d.t_DealID "
      +"            and leg.t_LegKind = ? "
      +"            and leg.t_LegID = 0 "
      +"        ) != ? ";
    End;
    
    If ( (dl_comm.rec.Flag1 == SET_CHAR) Or ((dl_comm.rec.Flag2 == SET_CHAR) And (dl_comm.rec.OperSubKind == SC_OVERVALUE_RD_BYSELECTAVOIR)))
      If (dl_comm.rec.FIID > 0)
        Query = Query
        +"    and (Select leg.t_PFI "
        +"           From ddl_leg_dbt leg "
        +"          Where leg.t_DealID = d.t_DealID "
        +"            and leg.t_LegKind = ? "
        +"            and leg.t_LegID = 0 "
        +"        ) = ? ";
      End;
      
      If ((dl_comm.rec.FIID <= 0) And (dl_comm.rec.AvoirKind != 0))
        Query = Query
        +"    and RSI_RSB_FIInstr.FI_AvrKindsEQ(?, ?, "
        +"        (Select fin.t_AvoirKind "
        +"           From dfininstr_dbt fin, ddl_leg_dbt leg "
        +"          Where leg.t_DealID = d.t_DealID "
        +"            and leg.t_LegKind = ? "
        +"            and leg.t_LegID = 0 "
        +"            and leg.t_PFI = fin.t_FIID "
        +"        ) "
        +"                                 ) = 1 ";
      End;
      
      If ((dl_comm.rec.FIID <= 0) And (dl_comm.rec.Currency > -1))
        Query = Query
        +" and  (Select fin.t_FaceValueFI "
        +"       From dfininstr_dbt fin, ddl_leg_dbt leg "
        +"       Where leg.t_DealID = d.t_DealID "
        +"            and leg.t_LegKind = ? "
        +"            and leg.t_LegID = 0 "
        +"            and leg.t_PFI = fin.t_FIID "
        +"        )  = ? ";
      End;
    End;
  End;
  
  If ( dl_comm.rec.DocKind == DL_OVERVALUE_NVPI ) /*переоценка НВПИ*/
     /* покупки и продажи, не репо, не займы, не обр. продажи */
    Query = Query +  "     and d.t_ClientID = -1 ";
    
      /*только сделки на внебалансе*/
    Query = Query
    +"    and Exists (Select 1 "
    +"                  From ddl_leg_dbt leg "
    +"                 Where leg.t_DealID = d.t_DealID "
    +"                   and leg.t_LegKind = 0 "
    +"                   and leg.t_CFI <> ? "
    +"               ) ";
  End;
  
  If ((dl_comm.rec. DocKind == DL_OVERVALUE) And (dl_comm.rec.Flag9 == SET_CHAR)) /*переоценка ПФИ*/
    Query = Query
    +" and d.t_IsPFI = 'X' "
    +" and NVL((select 1   "
    +"            from ddvnfrval_dbt frval "
    +"           where frval.t_DealID = d.t_DealID "
    +"             and frval.t_DocKind= d.t_BofficeKind "
    +"             and frval.t_Date = ? "
    +"             and frval.t_Accounted = 'X'),0) = 0 ";
    
      /*только сделки на внебалансе*/
    Query = Query
    +"    and ((Select leg.t_OperState "
    +"            From ddl_leg_dbt leg "
    +"           Where leg.t_DealID = d.t_DealID "
    +"             and leg.t_LegKind = ? "
    +"             and leg.t_LegID = 0 "
    +"         ) = ? "
    +"         OR "
    +"         (Exists(select 1 "
    +"                   from ddlgrdeal_dbt grdeal "
    +"                  where grdeal.t_DocKind = d.t_BOfficeKind "
    +"                    and grdeal.t_DocID = d.t_DealID "
    +"                    and grdeal.t_TemplNum = ? "
    +"                    and Exists(select 1 from ddlgracc_dbt gracc "
    +"                                where gracc.t_GrDealID = grdeal.t_ID "
    +"                                  and gracc.t_AccNum = ? "
    +"                                  and gracc.t_State = ? "
    +"                                  and gracc.t_FactDate <= ? "
    +"                              ) "
    +"                 ) "
    +"           and not Exists(select 1 "
    +"                            from ddlgrdeal_dbt grdeal "
    +"                           where grdeal.t_DocKind = d.t_BOfficeKind "
    +"                             and grdeal.t_DocID = d.t_DealID "
    +"                             and grdeal.t_TemplNum = ? "
    +"                             and Exists(select 1 from ddlgracc_dbt gracc "
    +"                                         where gracc.t_GrDealID = grdeal.t_ID "
    +"                                           and gracc.t_AccNum = ? "
    +"                                           and gracc.t_State = ? "
    +"                                       ) "
    +"                         ) "
    +"         ) "
    +"        )";
    
    If (dl_comm.rec.FIID > 0)
      Query = Query+ "    and d.t_PFI = ? ";
    End;
  End;
  
  return Query;
End;

//Возвращаем параметры просто массивом. И в rsl и Си коде уже сами решают как с этим распоряжаться
MACRO SpServGetParameters(dl_comm, KindDoc)
  var retArr = TArray();
  retArr[retArr.size] = KindDoc;
  retArr[retArr.size] = DL_READIED;
  retArr[retArr.size] = dl_comm.rec.CommDate;
  If (dl_comm.rec.ClientID != -1)
    If (dl_comm.rec.DocKind == DL_RESERVEDOC)
      retArr[retArr.size] = dl_comm.rec.ClientID; // в резерве ClientID - это контрагент по сделке
      
      If ((dl_comm.rec.DestPortofolio > KINDPORT_UNDEF) And (dl_comm.rec.OperationKind == KINDRES_RCB))
        retArr[retArr.size] = dl_comm.rec.DestPortofolio;
      End;
      
    Else
      
      If (dl_comm.rec.ClientID == {OurBank})
        
        retArr[retArr.size] = {OurBank};
        retArr[retArr.size] = UnknownParty;
        
      Else
        retArr[retArr.size] = dl_comm.rec.ClientID;
      End;
    End;
  End;
  
  If ((dl_comm.rec.DocKind == DL_GET_INCOME) And ((dl_comm.rec.Flag2 == SET_CHAR) Or (dl_comm.rec.Flag3 == SET_CHAR)))
    If (dl_comm.rec.FIID > 0)
      
      retArr[retArr.size] = LEG_KIND_DL_TICK;
      retArr[retArr.size] = dl_comm.rec.FIID;
      retArr[retArr.size] = TICKENS_KIND_IN;
      retArr[retArr.size] = dl_comm.rec.CommDate;
      retArr[retArr.size] = dl_comm.rec.FIID;
    End;
  End;
  
  If ( dl_comm.rec.DocKind == DL_OVERVALUE_RD )
    retArr[retArr.size] = LEG_KIND_DL_TICK;
    retArr[retArr.size] = DL_LEG_OUTBAL;
    retArr[retArr.size] = DLGR_TEMPL_OFFBALANCE;
    retArr[retArr.size] = DLGR_ACCKIND_ACCOUNTING;
    retArr[retArr.size] = DLGRACC_STATE_FACTEXEC;
    retArr[retArr.size] = dl_comm.rec.CommDate;
    retArr[retArr.size] = DLGR_TEMPL_BALANCE;
    retArr[retArr.size] = DLGR_ACCKIND_ACCOUNTING;
    retArr[retArr.size] = DLGRACC_STATE_FACTEXEC;
    
    If ((dl_comm.rec.Flag1 != SET_CHAR) And (dl_comm.rec.Flag2 == SET_CHAR ))
      
      retArr[retArr.size] = LEG_KIND_DL_TICK;
      retArr[retArr.size] = NATCUR;
    End;
    
    If ((dl_comm.rec.Flag1 == SET_CHAR) Or ((dl_comm.rec.Flag2 == SET_CHAR) And (dl_comm.rec.OperSubKind == SC_OVERVALUE_RD_BYSELECTAVOIR)))
      
      If (dl_comm.rec.FIID > 0)
        
        retArr[retArr.size] = LEG_KIND_DL_TICK;
        retArr[retArr.size] = dl_comm.rec.FIID;
      End;
      
      If ((dl_comm.rec.FIID <= 0) And (dl_comm.rec.AvoirKind != 0))
        
        retArr[retArr.size] = FIKIND_AVOIRISS;
        retArr[retArr.size] = dl_comm.rec.AvoirKind;
        retArr[retArr.size] = LEG_KIND_DL_TICK;
      End;
      
      If ((dl_comm.rec.FIID <= 0) And (dl_comm.rec.Currency > -1))
        
        retArr[retArr.size] = LEG_KIND_DL_TICK;
        retArr[retArr.size] = dl_comm.rec.Currency;
      End;
    End;
  End;
  
  If ( dl_comm.rec.DocKind == DL_OVERVALUE_NVPI ) /*переоценка НВПИ*/
    
    retArr[retArr.size] = NATCUR;
  End;
  
  If ( (dl_comm.rec.DocKind == DL_OVERVALUE) And (dl_comm.rec.Flag9 == SET_CHAR) ) /*переоценка ПФИ*/
    
    retArr[retArr.size] = dl_comm.rec.CommDate;
    
    retArr[retArr.size] = LEG_KIND_DL_TICK;
    retArr[retArr.size] = DL_LEG_OUTBAL;
    retArr[retArr.size] = DLGR_TEMPL_OFFBALANCE;
    retArr[retArr.size] = DLGR_ACCKIND_ACCOUNTING;
    retArr[retArr.size] = DLGRACC_STATE_FACTEXEC;
    retArr[retArr.size] = dl_comm.rec.CommDate;
    retArr[retArr.size] = DLGR_TEMPL_BALANCE;
    retArr[retArr.size] = DLGR_ACCKIND_ACCOUNTING;
    retArr[retArr.size] = DLGRACC_STATE_FACTEXEC;
    
    If (dl_comm.rec.FIID > 0)
      retArr[retArr.size] = dl_comm.rec.FIID;
    End;
  End;
  
  return retArr;
End;


MACRO SpServGetQueryAvr(dl_comm, KindDoc, Type)
  If (ValType(Type) != V_INTEGER)
    Type = INCOME_UNKNOWN;
  End;

  if (dl_comm.rec.FIID > 0)
    return " select " + string(dl_comm.rec.FIID) + " as FIID from dual ";
  end;

  var Query =
   " select avr.t_FIID FIID from davoiriss_dbt avr, dfininstr_dbt fin, davrkinds_dbt avrkind "
  +" where fin.t_FIID = avr.t_FIID "
  +"   and avrkind.t_AvoirKind = fin.t_AvoirKind "
  +"   and avrkind.t_Fi_Kind   = fin.t_Fi_Kind "
  +"   and fin.t_Fi_Kind       = ? ";
  If ( dl_comm.rec.DocKind == DL_RESERVEDOC ) /* резерв */
    
    If (KindDoc == DLDOC_ISSUE)
      
      Query = Query
      + " AND avrkind.t_IsIndividual != ? "
      +" AND( (fin.t_ExpiryDate > TO_DATE('01-01-0001', 'DD-MM-YYYY') AND (? <=  fin.t_ExpiryDate)) OR "
      +"  (? >= avr.t_InCirculationDate ))";
      If (dl_comm.rec.AvoirKind > 0)
        Query = Query
        +  " AND ( RSI_RSB_FIInstr.FI_AvrKindsEQ( ?, ?, fin.t_AvoirKind )= 1) ";
      End;
      If (dl_comm.rec.IssuerID > 0)
        Query = Query
        + " AND  fin.t_Issuer = ? ";
      End;
    End;
  End;
  If (dl_comm.rec.DocKind == DL_OVERVALUE)/*переоценка*/
    
    Query = Query
    +" AND  fin.t_AvoirKind != ? "
    +" AND avrkind.t_IsIndividual != ? "
    +" AND RSB_FIINSTR.FI_GETSTATUS (fin.t_FIID, ?) = ?";
    If (not DL_GetModeDepositoryForTax())
      Query = Query
      +" AND avr.t_SPIsClosed != ? ";
    Else
      Query = Query
      +" AND fin.t_IsClosed != ? ";
    End;
  End;
  
  If ( dl_comm.rec.DocKind == DL_GET_INCOME )/* начисление ПДД*/
    
    If (KindDoc != DL_SECURITYDOC)
      
      Query = Query
      +" AND avrkind.t_IsIndividual != ? "
      +" AND RSB_FIInstr.FI_AvrKindsEQ(?, ?, fin.t_AvoirKind) > 0 ";
    End;
  End;
  
  If ( dl_comm.rec.DocKind == DL_OVERVALUE_NVPI ) //Переоценка НВПИ
    
    If (KindDoc == DLDOC_ISSUE)
      
      Query = Query
      +" AND avr.t_IndexNom = 'X' "
      +" AND 0 < RSB_PMWRTOFF.WRTGetPortfolioAmount( ?, fin.t_FIID, -1, 0, ?, -1, ?, 1, 0, 0) ";
    End;
  End;
  
  If ((dl_comm.rec.DocKind == SP_AJUSTVALOEB) Or (dl_comm.rec.DocKind == SP_ACCEXPREVOEB)) /* Корректировка стоимости ОЭБ */
    Query = Query
    + " AND FIN.T_ISSUER = ? "
    +" AND FIN.T_ISSUED <= ? "
    +" AND AVRKIND.T_ISINDIVIDUAL = CHR(0) "
    +" AND RSI_RSB_FIInstr.FI_AvrKindsEQ(AVRKIND.T_FI_KIND, ?, AVRKIND.T_AVOIRKIND) > 0 ";
  End;
  
  If (dl_comm.rec.DocKind == SP_AMORTHEDGCORR)
    
    Query = Query
    + " AND AVRKIND.T_ISINDIVIDUAL = CHR(0) "
    +" AND RSI_RSB_FIInstr.FI_AvrKindsEQ(AVRKIND.T_FI_KIND, ?, AVRKIND.T_AVOIRKIND) > 0 "
    +" AND Exists(select 1 from ddlavrhdobj_dbt hdo, ddlavrhdinstr_dbt hdi where hdo.t_ObjKind = ? and hdo.t_ObjID = fin.t_FIID and hdi.t_HOID = hdo.t_HOID and hdi.t_EndDate > ? and hdi.t_EndDate <= ?) ";
  End;
  
  return Query;
End;


MACRO SpServGetParametersAvr ( dl_comm, KindDoc)
  var retArr = TArray();

  if (dl_comm.rec.FIID > 0)
    return retArr;
  end;

  retArr[retArr.size] = FIKIND_AVOIRISS;
  
  If ( dl_comm.rec.DocKind == DL_RESERVEDOC ) /* резерв */
    If (KindDoc == DLDOC_ISSUE)
      retArr[retArr.size] = SET_CHAR;
      retArr[retArr.size] = dl_comm.rec.CommDate;
      retArr[retArr.size] = dl_comm.rec.CommDate;
      If (dl_comm.rec.AvoirKind > 0)
        retArr[retArr.size] = FIKIND_AVOIRISS;
        retArr[retArr.size] = dl_comm.rec.AvoirKind;
      End;
      If (dl_comm.rec.IssuerID > 0 )
        retArr[retArr.size] = dl_comm.rec.IssuerID;
      End;
      
    End;
  End;
  If (dl_comm.rec.DocKind == DL_OVERVALUE) /*переоценка*/
    retArr[retArr.size] = AVOIRISSKIND_BASKET; /*корзины пропускаем*/
    retArr[retArr.size] = SET_CHAR;/*не индивидуальные*/
    retArr[retArr.size] = dl_comm.rec.CommDate; /*дата для проверки обращения*/
    retArr[retArr.size] = FI_STATE_INCIRCULATION;
    retArr[retArr.size] = SET_CHAR;
  End;
  If ( dl_comm.rec.DocKind == DL_GET_INCOME )/* начисление ПДД*/
    If (KindDoc != DL_SECURITYDOC)
      retArr[retArr.size] = SET_CHAR;/*не индивидуальные*/
      retArr[retArr.size] = FIKIND_AVOIRISS;   /* отбираем*/
      retArr[retArr.size] = AVOIRISSKIND_BOND; /*облигации*/
    End;
  End;
  If ( dl_comm.rec.DocKind == DL_OVERVALUE_NVPI ) //Переоценка НВПИ
    If (KindDoc == DLDOC_ISSUE)
      retArr[retArr.size] = dl_comm.rec.Division;
      retArr[retArr.size] = KINDPORT_RETIRE;
      retArr[retArr.size] = dl_comm.rec.CommDate;
    End;
  End;
  If ((dl_comm.rec.DocKind == SP_AJUSTVALOEB) Or (dl_comm.rec.DocKind == SP_ACCEXPREVOEB)) /* Корректировка стоимости ОЭБ */
    retArr[retArr.size] = {OurBank};
    retArr[retArr.size] = dl_comm.rec.CommDate;
    retArr[retArr.size] = AVOIRISSKIND_BOND;
  End;
  If (dl_comm.rec.DocKind == SP_AMORTHEDGCORR)
    retArr[retArr.size] = AVOIRISSKIND_BOND;
    retArr[retArr.size] = OBJTYPE_AVOIRISS;
    retArr[retArr.size] = ZeroDate;
    retArr[retArr.size] = dl_comm.rec.CommDate;
  End;
  
  return retArr;
End;