/*
 $Name: nptxreq020.mac
 $Module: Ценные бумаги
 $Description: Сопровождение заявлений на возврат. Шаг автопроверки
 */

import DealsInter, "nptxreqfun.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  var err = 0;
  var nptxop = TRecHandler("nptxop.dbt");
  var retTaxMain = $0, retTaxHigh = $0;
  var calcToRet = $0;
  var ReqStatus = 0;

  SetBuff( nptxop, FDoc );

  err = CalcRetTax(nptxop, ID_Step, @retTaxMain, @retTaxHigh);

  if (err == 0)
    calcToRet = retTaxMain + retTaxHigh;

    if (calcToRet == nptxop.rec.Tax)
      ReqStatus = DLNPTXRETREQ_CHECKED;
    else
      ReqStatus = DLNPTXRETREQ_REJECTED;
    end;

    DL_RslChangeNptxRetReq(nptxop.rec.Id, 
                           "Status", ReqStatus,
                           "ToRetSumMain", retTaxMain,
                           "ToRetSumHigh", retTaxHigh);

  end;

  return err;
end;
