import RsbFormsInter, Global, or_rep_h;

IMPORT "secinter.mac", "spserv.mac", "mc_lib.mac", "dlcarry.inc", "sp_catfn.mac", "sp_catac.mac", "sp_carsf.mac", "sp_voop.mac", "spserv.mac", "dltransf.mac", "sp_carin.mac",
       "spRepFn2.mac", "dl_car.mac", "sp_grfun.mac";
IMPORT "role_model.mac";//à®«¥¢ ï ¬®¤¥«ì


CLASS OfferRep(Begdate, Enddate)

var Report;
var printEngine, csvTable, csvFile, fName;
var rn = 1;
var _BegDate = begdate;
var _EndDate = enddate;
var sheet = 1,n_sheet = 2;
var count = 0;


private macro ¥ç âì˜ ¯ª¨ ()        
    printEngine.SetValue_NameCell("templateTitle", "‡  ¯¥à¨®¤: " + string(_Begdate) +  " - "+ string(_EndDate):f);
end;


private macro ¥ç âì«®ª „ ­­ëå(_rs);
    if(valtype(_rs) != v_undef)
        csvFile.AddCell(_rs.value("ac1")); //1
        csvFile.AddCell(" ");              //2
        csvFile.AddCell(" ");              //3
        csvFile.AddCell(_rs.value("s1"));  //4
        csvFile.AddRow();
    end;
end;

private macro ¥ç âì«®ª „ ­­ëå1(_rs);                                                   
    if(valtype(_rs) != v_undef)                                                         
        csvFile.AddCell(_rs.value("ac1"));          //1
        csvFile.AddCell(_rs.value("nam"));          //2
        csvFile.AddCell(_rs.value("isin"));         //3
        csvFile.AddCell(_rs.value("prevcostrur"));  //4
        csvFile.AddRow();                                                                                                                                   
    end;                                                                                
end;                                                                                    


macro run()
    var SQL, cmd, rs, SQL1,cmd1,rs1;
    var Select, DataSet, Query;

    printEngine = CTemplateSXLSX(NULL);

    csvFile = C_CSVFile();
    fName = csvFile.CreateFullFileName("Report_dlscv_csv.txt");

    if(printEngine.UsePoi())
        printEngine.SetXLSXFormat();
    end;

    printEngine.OpenTemplate("Report_dlscv.xlsx", true);
    printEngine.SheetChange(1);

    csvTable = printEngine.RegisterTable("templateTable", "templateTableHeader", true);

    if (printEngine.UsePoi())
        csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
    end;

    csvFile.FileOpen(fName, true);

    ¥ç âì˜ ¯ª¨();
                                                                                                                                                                                                    
                                                                                                                                                                                                    
SQL = " select ac1, sum(prevcostrur) s1 from(                                         "+
      " (select credaccount ac1, fiid, prevcostrur, (select t_isin from davoiriss_dbt where t_fiid = fiid) ISIN, (select t_name from dfininstr_dbt where t_fiid = fiid) NAM from (                       "+
      "  SELECT credaccount, fiid,                                                                                                                                                                        "+
      "                            NVL (SUM (t_sum_natcur), 0) PrevCostRur                                                                                                                                "+
      "                       FROM (SELECT acccred.t_account credaccount,                                                                                                                                 "+
      "                                    (SELECT DISTINCT t_fiid                                                                                                                                        "+
      "                                       FROM dmcaccdoc_dbt                                                                                                                                          "+
      "                                      WHERE t_account = accdeb.t_account)                                                                                                                          "+
      "                                       AS fiid,                                                                                                                                                    "+
      "                                    trn.t_sum_natcur                                                                                                                                               "+
      "                               FROM dacctrn_dbt trn,                                                                                                                                               "+
      "                                    daccount_dbt AccDeb,                                                                                                                                           "+
      "                                    daccount_dbt AccCred                                                                                                                                           "+
      "                              WHERE     trn.t_date_carry >= :datebeg                                                                                                                               "+
      "                                    AND trn.t_date_carry <= :dateend                                                                                                                               "+
      "                                    AND trn.t_state = 1                                                                                                                                            "+
      "                                    AND AccDeb.t_accountid =                                                                                                                                       "+
      "                                           trn.t_accountid_payer                                                                                                                                   "+
      "                                    AND AccCred.t_accountid =                                                                                                                                      "+
      "                                           trn.t_accountid_receiver                                                                                                                                "+
      "                                    AND accdeb.t_account IN                                                                                                                                        "+
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                       "+
      "                                              FROM dmccateg_dbt categ,                                                                                                                             "+
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                            "+
      "                                             WHERE categ.t_code IN                                                                                                                                 "+
      "                                                      (' è ¯®àâä¥«ì æ/¡', '“¯« ç¥­­ë© Š„', 'à¥¬¨ï, æ/¡', ' ç¨á«.„„, æ/¡','–/¡, ','–/¡, Š®à§¨­  ','–/¡, Š“ ', '–/¡, Š®à§¨­  Š“ ')                                                               "+
      "                                                   AND accdoc.t_catid =                                                                                                                            "+
      "                                                          categ.t_id)                                                                                                                              "+
      "                                    AND acccred.t_account IN                                                                                                                                       "+
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                       "+
      "                                              FROM dmccateg_dbt categ,                                                                                                                             "+
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                            "+
      "                                             WHERE categ.t_code IN                                                                                                                                 "+
      "                                                      ('+¥à¥®æ¥­ª €')                                                                                                                             "+
      "                                                   AND accdoc.t_catid =                                                                                                                            "+
      "                                                          categ.t_id))                                                                                                                             "+
      "                   GROUP BY credaccount, fiid)                                                                                                                                                    "+
      "                  union all                                                                                                                                                                        "+
      
      " /*    -     */                                                                                                                                                                                    "+
      
      "                   select debaccount ac, fiid, - prevcostrur, (select t_isin from davoiriss_dbt where t_fiid = fiid) ISIN, (select t_name from dfininstr_dbt where t_fiid = fiid) NAM  from (    "+
      "                    SELECT debaccount, fiid,                                                                                                                                                       "+
      "                            NVL (SUM (t_sum_natcur), 0) PrevCostRur                                                                                                                                 "+ 
      "                       FROM (SELECT accdeb.t_account debaccount,                                                                                                                                    "+ 
      "                                    (SELECT DISTINCT t_fiid                                                                                                                                         "+ 
      "                                       FROM dmcaccdoc_dbt                                                                                                                                           "+ 
      "                                      WHERE t_account = acccred.t_account)                                                                                                                          "+ 
      "                                       AS fiid,                                                                                                                                                     "+ 
      "                                    trn.t_sum_natcur                                                                                                                                                "+ 
      "                               FROM dacctrn_dbt trn,                                                                                                                                                "+ 
      "                                    daccount_dbt AccDeb,                                                                                                                                            "+ 
      "                                    daccount_dbt AccCred                                                                                                                                            "+ 
      "                              WHERE     trn.t_date_carry >= :datebeg                                                                                                                                "+ 
      "                                    AND trn.t_date_carry <= :dateend                                                                                                                                "+ 
      "                                    AND trn.t_state = 1                                                                                                                                             "+ 
      "                                    AND AccDeb.t_accountid =                                                                                                                                        "+ 
      "                                           trn.t_accountid_payer                                                                                                                                    "+ 
      "                                    AND AccCred.t_accountid =                                                                                                                                       "+ 
      "                                           trn.t_accountid_receiver                                                                                                                                 "+ 
      "                                    AND acccred.t_account IN                                                                                                                                        "+ 
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                        "+ 
      "                                              FROM dmccateg_dbt categ,                                                                                                                              "+ 
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                             "+ 
      "                                             WHERE categ.t_code IN                                                                                                                                  "+ 
      "                                                       (' è ¯®àâä¥«ì æ/¡', '“¯« ç¥­­ë© Š„', 'à¥¬¨ï, æ/¡', ' ç¨á«.„„, æ/¡','–/¡, ','–/¡, Š®à§¨­  ','–/¡, Š“ ', '–/¡, Š®à§¨­  Š“ ')                                                                "+ 
      "                                                   AND accdoc.t_catid =                                                                                                                             "+ 
      "                                                          categ.t_id)                                                                                                                               "+ 
      "                                    AND accdeb.t_account IN                                                                                                                                         "+ 
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                        "+ 
      "                                              FROM dmccateg_dbt categ,                                                                                                                              "+ 
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                             "+ 
      "                                             WHERE categ.t_code IN                                                                                                                                  "+ 
      "                                                      ('-¥à¥®æ¥­ª €')   /* and accdoc.t_account = ?  */                                                                                                                        "+ 
      "                                                   AND accdoc.t_catid =                                                                                                                             "+ 
      "                                                          categ.t_id))                                                                                                                              "+ 
      "                   GROUP BY debaccount, fiid)))  group by ac1 order by ac1 desc                                                                                                                                   ";

    cmd = RSDCommand(SQL);                             
    cmd.AddParam("datebeg", RSDBP_IN, _BegDate);       
    cmd.AddParam("dateend", RSDBP_IN, _EndDate);       
    begaction(100,"‘¡®à ¤ ­­ëå...");                   
    rs = RSDRecordset(cmd);
	while(rs.movenext)
       	¥ç âì«®ª „ ­­ëå(rs);


Sql1 =                                                                                                                                   
      " (select credaccount ac1, fiid, prevcostrur, (select t_isin from davoiriss_dbt where t_fiid = fiid) ISIN, (select t_name from dfininstr_dbt where t_fiid = fiid) NAM from (                       "+                
      "  SELECT credaccount, fiid,                                                                                                                                                                        "+               
      "                            NVL (SUM (t_sum_natcur), 0) PrevCostRur                                                                                                                                "+               
      "                       FROM (SELECT acccred.t_account credaccount,                                                                                                                                 "+               
      "                                    (SELECT DISTINCT t_fiid                                                                                                                                        "+               
      "                                       FROM dmcaccdoc_dbt                                                                                                                                          "+               
      "                                      WHERE t_account = accdeb.t_account)                                                                                                                          "+               
      "                                       AS fiid,                                                                                                                                                    "+               
      "                                    trn.t_sum_natcur                                                                                                                                               "+               
      "                               FROM dacctrn_dbt trn,                                                                                                                                               "+               
      "                                    daccount_dbt AccDeb,                                                                                                                                           "+               
      "                                    daccount_dbt AccCred                                                                                                                                           "+               
      "                              WHERE     trn.t_date_carry >= :datebeg                                                                                                                               "+               
      "                                    AND trn.t_date_carry <= :dateend                                                                                                                               "+               
      "                                    AND trn.t_state = 1                                                                                                                                            "+               
      "                                    AND AccDeb.t_accountid =                                                                                                                                       "+               
      "                                           trn.t_accountid_payer                                                                                                                                   "+               
      "                                    AND AccCred.t_accountid =                                                                                                                                      "+               
      "                                           trn.t_accountid_receiver                                                                                                                                "+               
      "                                    AND accdeb.t_account IN                                                                                                                                        "+               
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                       "+               
      "                                              FROM dmccateg_dbt categ,                                                                                                                             "+               
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                            "+               
      "                                             WHERE categ.t_code IN                                                                                                                                 "+               
      "                                                       (' è ¯®àâä¥«ì æ/¡', '“¯« ç¥­­ë© Š„', 'à¥¬¨ï, æ/¡', ' ç¨á«.„„, æ/¡','–/¡, ','–/¡, Š®à§¨­  ','–/¡, Š“ ', '–/¡, Š®à§¨­  Š“ ')                                                "+               
      "                                                   AND accdoc.t_catid =                                                                                                                            "+               
      "                                                          categ.t_id)                                                                                                                              "+               
      "                                    AND acccred.t_account IN                                                                                                                                       "+               
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                       "+               
      "                                              FROM dmccateg_dbt categ,                                                                                                                             "+               
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                            "+               
      "                                             WHERE categ.t_code IN                                                                                                                                 "+               
      "                                                      ('+¥à¥®æ¥­ª €')    and accdoc.t_account = :acc                                                                                                                         "+               
      "                                                   AND accdoc.t_catid =                                                                                                                            "+               
      "                                                          categ.t_id))                                                                                                                             "+               
      "                   GROUP BY credaccount, fiid)                                                                                                                                                    "+                
      "                  union all                                                                                                                                                                        "+               
                                                                                                                                                                                                                           
      " /*    -     */                                                                                                                                                                                    "+               
                                                                                                                                                                                                                           
      "                   select debaccount ac, fiid, - prevcostrur, (select t_isin from davoiriss_dbt where t_fiid = fiid) ISIN, (select t_name from dfininstr_dbt where t_fiid = fiid) NAM  from (    "+                 
      "                    SELECT debaccount, fiid,                                                                                                                                                       "+               
      "                            NVL (SUM (t_sum_natcur), 0) PrevCostRur                                                                                                                                 "+              
      "                       FROM (SELECT accdeb.t_account debaccount,                                                                                                                                    "+              
      "                                    (SELECT DISTINCT t_fiid                                                                                                                                         "+              
      "                                       FROM dmcaccdoc_dbt                                                                                                                                           "+              
      "                                      WHERE t_account = acccred.t_account)                                                                                                                          "+              
      "                                       AS fiid,                                                                                                                                                     "+              
      "                                    trn.t_sum_natcur                                                                                                                                                "+              
      "                               FROM dacctrn_dbt trn,                                                                                                                                                "+              
      "                                    daccount_dbt AccDeb,                                                                                                                                            "+              
      "                                    daccount_dbt AccCred                                                                                                                                            "+              
      "                              WHERE     trn.t_date_carry >= :datebeg                                                                                                                               "+              
      "                                    AND trn.t_date_carry <= :dateend                                                                                                                               "+              
      "                                    AND trn.t_state = 1                                                                                                                                             "+              
      "                                    AND AccDeb.t_accountid =                                                                                                                                        "+              
      "                                           trn.t_accountid_payer                                                                                                                                    "+              
      "                                    AND AccCred.t_accountid =                                                                                                                                       "+              
      "                                           trn.t_accountid_receiver                                                                                                                                 "+              
      "                                    AND acccred.t_account IN                                                                                                                                        "+              
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                        "+              
      "                                              FROM dmccateg_dbt categ,                                                                                                                              "+              
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                             "+              
      "                                             WHERE categ.t_code IN                                                                                                                                  "+              
      "                                                       (' è ¯®àâä¥«ì æ/¡', '“¯« ç¥­­ë© Š„', 'à¥¬¨ï, æ/¡', ' ç¨á«.„„, æ/¡','–/¡, ','–/¡, Š®à§¨­  ','–/¡, Š“ ', '–/¡, Š®à§¨­  Š“ ')                                                                       "+              
      "                                                   AND accdoc.t_catid =                                                                                                                             "+              
      "                                                          categ.t_id)                                                                                                                               "+              
      "                                    AND accdeb.t_account IN                                                                                                                                         "+              
      "                                           (SELECT DISTINCT accdoc.t_account                                                                                                                        "+              
      "                                              FROM dmccateg_dbt categ,                                                                                                                              "+              
      "                                                   dmcaccdoc_dbt accdoc                                                                                                                             "+              
      "                                             WHERE categ.t_code IN                                                                                                                                  "+              
      "                                                      ('-¥à¥®æ¥­ª €')    and accdoc.t_account = :acc                                                                                                  "+                                                                                                            
      "                                                   AND accdoc.t_catid =                                                                                                                             "+              
      "                                                          categ.t_id))                                                                                                                              "+              
      "                   GROUP BY debaccount, fiid))  order by ac1 desc                                                                                                                                    ";

        cmd1 = RSDCommand(SQL1);
        cmd1.AddParam("datebeg", RSDBP_IN, _BegDate);
        cmd1.AddParam("dateend", RSDBP_IN, _EndDate);
        cmd1.AddParam("acc", RSDBP_IN, rs.value(0));

        begaction(100,"‘¡®à ¤ ­­ëå...");
    
        rs1 = RSDRecordset(cmd1);
        while(rs1.movenext()) 
            ¥ç âì«®ª „ ­­ëå1(rs1);
            endaction;
        end;
    end;
    
    csvFile.FileClose();
    csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
    csvTable.EndTable();

    printEngine.SetAutoFilter("A6:D6", 1);

    printEngine.SaveAsTemplate("„®å®¤ë ¨ à áå®¤ë ®â ¢ «îâ­®© ¯¥à¥®æ¥­ª¨ æ¥­­ëå ¡ã¬ £, ®âà ¦¥­­®© ¢ ¡ãå£ «â¥àáª®¬ ãç¥â¥ ­  ¤ âã" + string(_Begdate) +  " - "+ string(_EndDate):f, true);
    printEngine.Close();

end;  

END;

CLASS (TRsbPanel) Pan
    initTRsbPanel();


    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;
    const EndCalcDate_ID = 2;
    var curstr = 1;
    Caption = "„®å®¤ë ¨ à áå®¤ë ®â ¢ «îâ­®© ¯¥à¥®æ¥­ª¨ æ¥­­ëå ¡ã¬ £";
    Status = "~ESC~‚ëå®¤ ~F2~‚ë¯®«­¨âì";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, EndCalcDate, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    EndCalcDate = TRsbEditField(V_DATE);
    EndCalcDate.setPosition(27,curstr);
    EndCalcDate.setSize(8,1);
    EndCalcDate.name = "endincalcdate";
    EndCalcDate.value = {curdate};
    addControl(EndCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr," ‡  ¯¥à¨®¤:");
    addLabel (m_LabelCD);

    var m_LabelT:TrsbLabel = TRsbLabel(25,curstr,"~");
    addLabel (m_LabelT);
 
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));


    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if ((ev.id == BeginCalcDate_ID) or (ev.id == EndCalcDate_ID ))
            BeginCalcDate.value = GetDateByCalendar({CurDate});
//            EndCalcDate.value   = BeginCalcDate.value + Delta;
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
//            EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
  //       EndCalcDate.value   = BeginCalcDate.value + Delta;
        
         var myRep = OfferRep(BeginCalcDate.value, EndCalcDate.value);
         myRep.run;
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);
