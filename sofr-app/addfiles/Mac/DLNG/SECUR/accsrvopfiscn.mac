/*
$Name:        accsrvopfiscn.mac
$Module:      Ценные бумаги
$Description: Массовое выполнение действий над группами обработки по операции бухгалтерского учета
*/

IMPORT SPInter, DealsInter, dlquery;   
 
PRIVATE VAR Grp = TRecHandler( "pmwrtgrp.dbt" );
PRIVATE VAR ClientShortName = "";
PRIVATE VAR ContrNumber = "";
PRIVATE VAR FiCode = "";


PRIVATE CONST ERROR_EXEC = 0,
              PRINT_HEADER = 1,
              PRINT_FOOTER = 2;

PRIVATE MACRO PrintHead( Head:STRING )
[
                   #
┌──────────────────────────┬──────────────────────────┬──────────────────────────┬──────┬───────────────────────────────────────────────────────────────────────────────────────────────────┐
│          Клиент          │         Договор          │          Код ц/б         │  №   │                      Сообщение                                                                    │
│                          │                          │                          │ошибки│                                                                                                   │
├──────────────────────────┼──────────────────────────┼──────────────────────────┼──────┼───────────────────────────────────────────────────────────────────────────────────────────────────┤](Head);
END;


PRIVATE MACRO PrintFooter()
[└──────────────────────────┴──────────────────────────┴──────────────────────────┴──────┴───────────────────────────────────────────────────────────────────────────────────────────────────┘
];

END;

PRIVATE MACRO PrintLine( ErrStatus:INTEGER, ErrMessage:STRING )
[│##########################│##########################│##########################│######│###################################################################################################│]
( ClientShortName:w, ContrNumber:w, FiCode:w, ErrStatus, ErrMessage:w );
END;


PRIVATE MACRO DeleteFIFromOper( NumExec:INTEGER, ErrStatus:INTEGER, ErrMessage:STRING )

  if( NumExec == PRINT_HEADER )
     PrintHead( "Отчет о массовом удалении групп обработки из операции бухгалтерского учета." );
  elif( NumExec == PRINT_FOOTER )            
     PrintFooter();
  elif( NumExec == ERROR_EXEC )
     if( ErrStatus == 0 ) 
       ErrMessage = "Группа из операции удалена успешно.";
     end;
     PrintLine( ErrStatus, ErrMessage);
  end;
END;

/*   Action = 3 - удаление (F8 из скроллинга )
*/
MACRO Печать_ОтчетСканирования( NumExec:INTEGER, FDoc:VARIANT, ErrStatus:INTEGER, ErrMessage:STRING, Action:INTEGER )
  var query, cmd, DataSet;
  var pt = TBfile("party.dbt");
  var sf = TBfile("sfcontr.dbt");

  if( Action == 3 )
    Grp.SetRecordAddr( FDoc );

    FiCode = "Все";

    if(Grp.rec.Party == -1)
      query =   " select fin.t_FI_Code "
              + "   from dfininstr_dbt fin, dpmwrtgrpfi_dbt grpfi "
              + "  where grpfi.t_GrpID = ? "
              + "    and fin.t_FIID = grpfi.t_FIID ";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(Grp.rec.ID);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        FiCode = DataSet.FI_Code;
      end;
    end;

    pt.Clear();
    pt.rec.PartyID = Grp.rec.Party;
    if(pt.GetEQ())
      ClientShortName = pt.rec.ShortName;
    end;

    sf.Clear();
    sf.rec.ID = Grp.rec.Contract;
    if(sf.GetEQ())
      ContrNumber = sf.rec.Number;
    end;
  
    DeleteFIFromOper( NumExec, ErrStatus, ErrMessage );
  end;

END;
