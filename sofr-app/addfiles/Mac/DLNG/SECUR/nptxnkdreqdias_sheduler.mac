/*
$Name:        nptxnkdreqdias_sheduler.mac
$Module:      Ценные бумаги
$Description: Запуск плановой процедуры "Обработка запросов УНКД от Диасофта"
*/
import "sprepfun.mac", "sqlconv.mac", "CbReport_h.mac", "scsrvrepfun.mac", "func_lib.mac", "funcobj.mac";

private const SS_RESPONSE_END = 3; /* Успешное завершение всего сервиса */
private const SS_RESPONSE_FATAL = 4; /* Ошибка исполнения, обработка всей цепочки прерывается */

class c_ssRunResult_NkdReqDias(p_ProcessState, p_ErrorNumber, p_ErrorText)
  var ProcessState = p_ProcessState;
  var ErrorNumber = p_ErrorNumber;
  var ErrorText = p_ErrorText;
end;

macro ExecNkdReqDias_Shed()
  var query, cmd;
  var N = ПериодОбработкиУНКД();

  query =   " INSERT INTO DFUNCOBJ_DBT ( T_ID "
          + "                           ,T_OBJECTTYPE "
          + "                           ,T_OBJECTID "
          + "                           ,T_FUNCID "
          + "                           ,T_PRIORITY "
          + "                          ) "   
          + "                   SELECT 0 "
          + "                         ," + OBJTYPE_PARTY
          + "                         ,q.t_PartyID "
          + "                         ,5300 "
          + "                         ,1 "
          + "                    FROM (select DISTINCT t_PartyID "
          + "                            from dnptxnkdreqdias_dbt "
          + "                           where (t_requestdate + (t_requesttime - trunc(t_requesttime))) >= TO_DATE(TO_CHAR(SYSDATE-?/(24*60), 'DD.MM.YYYY:HH24:MI:SS'), 'DD.MM.YYYY:HH24:MI:SS') "
          + "                             and (   t_Status IN (" + NPTXNKDREQDIAS_STATUS_NEW + ", " + NPTXNKDREQDIAS_STATUS_WAITCONFIRM + ", " + NPTXNKDREQDIAS_STATUS_PROCESSING_ERROR + ")"
          + "                                  or (t_Status = "+NPTXNKDREQDIAS_STATUS_VALIDATION_ERROR+" and t_GUIDResp = CHR(1)) "
          + "                                 ) "
          + "                         ) q "
          + "                   WHERE NOT EXISTS(SELECT 1 "
          + "                                      FROM DFUNCOBJ_DBT F "
          + "                                     WHERE F.T_OBJECTTYPE = " + OBJTYPE_PARTY
          + "                                       AND F.T_OBJECTID = q.t_PartyID "
          + "                                       AND F.T_FUNCID = 5300 "
          + "                                       AND F.T_STATE IN ("+FUNCOBJ_STATE_OK+", "+FUNCOBJ_STATE_PROCESS+")"
          + "                                   ) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(N);

  cmd.ExecuteCMD();

  return c_ssRunResult_NkdReqDias(SS_RESPONSE_END);
OnError(e)
  return c_ssRunResult_NkdReqDias(SS_RESPONSE_FATAL, 1, e.message);
end;


