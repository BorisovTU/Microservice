/*
$Name: dpdrutl.mac
$Module: Ценные бумаги
$Description: Поддержка динамической загрузки Депозитария
*/

import DealsInter, OprInter, "dlquery.mac", "dpimp.mac", "dlmisc.mac";

/* Проверить наличие сформированного поручения */
/* возврашает true - если поручение есть */
macro SP_GetDraftDate( dlrq:TRecHandler,
                       registrDate:date) : bool
  var cmd, dataSet;
  var isExist = false;
  
  cmd = DL_RSDCommand( "Select Ground.t_RegistrDate " 
                     + "  From ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal, dspdrprop_dbt Prop, dspdraft_dbt Draft, dspground_dbt Ground " 
                     + " Where grdoc.t_DocKind     = " + DL_DEPODRAFT
                     + "   and grdeal.t_ID         = grdoc.t_GrDealID "
                     + "   and grdeal.t_DocKind    = ? "
                     + "   and grdeal.t_DocID      = ? "
                     + "   and grdeal.t_TemplNum IN ("+IIF(dlrq.rec.DealPart == 1, DLGR_TEMPL_DEPODRAFT+","+DLGR_TEMPL_DEPODRAFTCONTR, DLGR_TEMPL_DEPODRAFT2+","+DLGR_TEMPL_DEPODRAFTCONTR2)+")"
                     + "   and Prop.t_PaymentID    = Prop.t_DocumentID " 
                     + "   And Prop.t_DocumentID   = grdeal.t_ID " 
                     + "   And Prop.t_DocumentKind = " + DL_DLGRDEAL 
                     + "   And Draft.t_AutoKey     = Prop.t_DraftID " 
                     + "   And Prop.t_IsMain       = chr(88) " 
                     + "   And Ground.t_SpGroundID = Draft.t_SpGroundID "
                     );

  cmd.addParam( dlrq.rec.DocKind );
  cmd.addParam( dlrq.rec.DocID );

  dataSet = cmd.execute();

  if( dataSet.MoveNext() )
    registrDate = date(dataSet.RegistrDate);
    isExist = true;
  end;

  SetParm(1, registrDate);

  return isExist;
end;

/* Получить кол-во ц/б в исполненных поручениях */
macro SP_GetDraftAmount( PaymentID:integer, /*Вх. парам.  - ИД платежа по БА*/
                         _Amount:money,     /*Вовз. парам - суммарное кол-во ц/б в поручениях*/ 
                         DocumentKind,
                         DocumentID)

  var Amount = DP_GetDraftAmount(PaymentID, DocumentKind, DocumentID);

  SetParm(1, Amount);
end;

macro SP_InsertDeferDraft(DepoDraftParm, avr_DlRq, DontShowError, ErrStr )
   var stat = DP_InsertDeferDraftRQ(DepoDraftParm, avr_DlRq, DontShowError, ErrStr);
      SetParm(3, ErrStr);
   return stat;
end;

macro SP_InitParmSPgr( GroundPrm )
    DP_InitParmSPgr( GroundPrm );
end;

macro SP_InsertGroundDocument( GroundPrm, NeedFiltred )
  var Id;
  var UseDocFltr = false;

  if(ValType(NeedFiltred) != V_UNDEF)
    UseDocFltr = NeedFiltred;
  end;

  return DP_InsertGroundDocument( Id, GroundPrm, null, null, UseDocFltr );
end;

macro SP_InsertGroundDocumentRetID( GroundPrm, NeedFiltred, SPgroundID:@variant )
  
  var UseDocFltr = false;

  if(ValType(NeedFiltred) != V_UNDEF)
    UseDocFltr = NeedFiltred;
  end;

  return DP_InsertGroundDocument( SPgroundID, GroundPrm, null, null, UseDocFltr );
end;

macro SP_InitParmInfOpr( _DepoInfo )
    DP_InitParmInfOpr( _DepoInfo );
end;

macro SP_CreateInfOperation( _DepoInfo, _CreateReport, _PrintMode, Copies )
  return DP_CreateInfOperation( _DepoInfo, _CreateReport, _PrintMode, Copies );
end;
