
/*
$Name: nptx_mass_list.mac 
$Module: Ценные бумаги
$Description: BOSS-2487 выгрузка списка клиентов в excel
*/

import cb_sql, "or_exl_h.mac", secinter, dlquery;

MACRO ClearList() 
  var cmd = "DELETE FROM DNPTXOPMASSLIST_TMP";
  ExecSQL(cmd);
end;

MACRO InsertTempData(ClientID, ContrNum)
  var ins, query;
  var ind = 0;

  if((ClientID == NULL) or (ClientID == "Undefined"))
    ClientID = "";
  end;

  if((ContrNum == NULL) or (ContrNum == "Undefined"))
    ContrNum = "";
  end;

  query =   " INSERT INTO DNPTXOPMASSLIST_TMP(T_IN_CLIENTID, T_CLIENTID, T_CONTRNUM, T_DLCONTRID) "
          + " VALUES ("+IIF(ValType(ClientID) == V_STRING, "?", "TO_CHAR(TRUNC(?)) ") + ", "
          + "         -1, "
          +           IIF(ValType(ContrNum) == V_STRING, "?", "TO_CHAR(TRUNC(?)) ") + ", "
          + "         0)";

  ins = DL_RSDCommand(query);
  ins.AddParam(string(ClientID));
  ins.AddParam(string(ContrNum));

  ins.ExecuteCMD();
end;

MACRO CreateClientList (listFile : string, ClientIdType : integer)

   var row, firstCol, secondCol, ActiveBook, fileName, extName, dirName, sheet, excel;
   var Path_AppServ = "";
   dirName = splitfile(listFile, fileName, extName);
   fileName = fileName + extName;

   var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   var rc = jvm.callStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");

   if (OR_ExistFile(listFile)) 
      if (not isStandAlone()) 
         Path_AppServ = "..\\txtfile\\" + FileName;
         if (not copyfile("$" + listFile, Path_AppServ) )
            msgbox("Ошибка при передаче файла на сервер приложений");
         end;
      end;
      ActiveBook = rc.openWorkbook("..\\txtfile\\" + fileName );
      if (not ActiveBook )
         ActiveBook.close();
         ActiveBook = null;
         rc = null;
         MsgBox("Ошибка открытия файла \""  + listFile + "\"");
         EndAction(1);
         return 1;
       end;

       ActiveBook.setActiveSheet(0);
       row = 1;
       ClearList;

       while (valtype(ActiveBook.getCellValue("A" + row)) != V_UNDEF)
          firstCol = ActiveBook.getCellValue("A" + row);
          secondCol = ActiveBook.getCellValue("B" + row);
          InsertTempData(firstCol, secondCol);
          row = row + 1; 
       end;

       ActiveBook.close();
       ActiveBook = null;
       rc = null;
       
       if (not isStandAlone()) 
          if (not RemoveFile (Path_AppServ))
             MsgBox("Ошибка удаления с сервера приложений файла " + Path_AppServ);
          end;
       end;
       return 0;
   else
      MsgBox("Файла " + listFile + " Не существует");
      return 1;
   end;
end;
