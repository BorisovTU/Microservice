/*
$Name:        loan520.mac
$Module:      Ценные бумаги
$Description: Операция займа. Шаг "Просрочка оплаты процентов".
*/
import InsCarryDoc, "sp_class.mac", "sp_car.mac";

private record SpChangeDates("spchdate.str");/*глобальная структура с данными для расчетов*/

macro ExecuteStep( doc, FDoc)

   record deal(dl_tick);
   var    FD, PcAccID, AddSum, dat = SpChangeDates.FactDate, pmobj;

   if( SpChangeDates.Action <= 0 )
      msgbox("Шаг просрочки оплаты процентов из списка шагов выполнять запрещено."); 
      return 1;
   end; 

   SetBuff( deal, FDoc ); 
   FD = SPFirstDoc( deal );

   PcAccID = SP_GetPercentAccount( deal );
   if( PcAccID <= 0 )
      MsgBox( "Не найден счет процентов для сделки." );
      return 1;
   end;

  // if( ПолучитьСуммуНачисленных( PcAccID, dat, dat, AddSum ) == false )
  //    MsgBox( "Ошибка при получении суммы начисленных процентов." );
  //    return 1;
  // end;
  // AddSum = Round(AddSum); /*До копеек*/

   if( AddSum > 0 )
      if(not ПроводкаПоКатегориямУчета( FD, 
             "-% к погашению", "-% с н.с.", /* КатегДеб , КатегКредит*/
             dat,                  /* Дата */
             1 ,                   /* Глава */
             FD.pmpc.rec.BaseFIID, /* Валюта */
             AddSum,               /* Сумма */
             Doc,                  /* Документ */
             INPCARRY,             /* Result_Carry */
             " 1",                 /* Kind_Oper */
             FD.tick.rec.DealCode, /* Numb_Document */
             "Перенос на просрочку суммы начисленных процентов" /* Ground */
            ))
          return 1;
      end;
   end;

   if( AddSum != FD.pmpc.rec.BaseAmount ) /*выполнить доначисление*/

      if( not InsertPcAdd( PcAccID, dat, dat, FD.pmpc.rec.BaseAmount-AddSum ) )
          msgbox( "Ошибка при начислении процентов." );
          return 1;
      end;

      if(not ПроводкаПоКатегориямУчета( FD, 
             "-% начисленные", "-% с н.с.", /* КатегДеб , КатегКредит*/
             dat,                  /* Дата */
             1 ,                   /* Глава */
             FD.pmpc.rec.BaseFIID, /* Валюта */
             FD.pmpc.rec.BaseAmount-AddSum,/* Сумма */
             Doc,                  /* Документ */
             INPCARRY,             /* Result_Carry */
             " 1",                 /* Kind_Oper */
             FD.tick.rec.DealCode, /* Numb_Document */
             "Доначисление и перенос на просрочку суммы доначисленных процентов." /* Ground */
            ))
          return 1;
      end;
   end;

   pmobj = RsbPayment( FD.pmpc.rec.PaymentID );
   pmobj.PaymStatus = PM_OVERDUE;

   return 0;
end;
