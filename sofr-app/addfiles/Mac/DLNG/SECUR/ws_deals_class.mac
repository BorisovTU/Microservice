/*
$Name:             ws_deals_class.mac
$Module:           АРНУ
$Description:      WEB. АРНУ. Макрос классов для сервисов скроллинга и панелей сделок, погашений и конвертаций ц/б и т.д.
*/
/*
 Классы
*/

import "ws_avoiriss.mac";
import "ws_typeac.mac";
import "ws_scmrkshm.mac";
import "ws_sfcontrclass.mac";
import "ws_dprt.mac";
import "ws_sfconcom.mac";
import "wcl_pt_access.mac";

const SP_EditDealMode_Normal = 0;   // нормальный(автоматический) режим
const SP_EditDealMode_Manual = 1;   // ручной
const SP_EditDealMode_ReadOnly = 2; // только чтение

// класс CScDealList для заполнения скроллинга "Список сделок"
class CScDealList
  var DealCode:String;            // Код
  var DealDate:Date;              // Дата заключения сделки
  var DealType:Integer;           // Тип сделки
  var TypeCode:String;            // Наименование типа сделки
  var State:Integer;              // Статус
  var StateName:String;           // Наименование статуса
  var ClientID:Integer;           // Идентификатор клиента
  var ClientName:String;          // Наименование клиента
  var ClientContrID:Integer;      // Идентификатор номера договора с клиентом
  var ClientSfContr:String;       // Номер договора с клиентом
  var PartyID:Integer;            // Идентификатор контрагента
  var ContrName:String;           // Наименование контрагента
  var FIID:Integer;               // Идентификатор ценной бумаги
  var RootAvrKind:Integer;        // Корневой вид цб
  var IssCode:String;             // Код ценной бумаги
  var IssName:String;             // Наименование ценной бумаги
  var ISIN:String;                // ИСИН
  var NalogGroup:Integer;         // Группа налогового учета
  var BaseAmount:Money;           // Количество
  var TotalCost1:Money;           // Сумма
  var TotalCost2:Money;           // Сумма второй части
  var CFI:Integer;                // Валюта цены
  var Ccy:String;                 // Буквенный код валюты цены
  var IncomeRate:Double;          // Ставка РЕПО
  var PayDate1:Date;              // Дата оплаты (1ч)
  var PayFactDate1:Date;          // Фактическая дата оплаты
  var PayDate2:Date;              // Дата оплаты второй части
  var PayFactDate2:Date;          // Фактическая дата оплаты второй части
  var ChangeDate:Date;            // Дата изменения
  var RejectDate1:Date;           // Дата отказа
  var RejectDate2:Date;           // Дата отказа от второй части
  var DealCodeTS:String;          // Код внешний
  var DealID:Integer;             // ID сделки
  var IsNetting:Bool;             // Неттинг
  var Department:Integer;         // Идентификатор Филиала
  var DepartmentName:String;      // Наименование филиала
  var SupplyDate1:Date;           // Дата поставки
  var SupplyFactDate1:Date;       // Фактическая дата поставки
  var SupplyTime1:Time;           // Время поставки
  var SupplyDate2:Date;           // Дата поставки второй части
  var SupplyFactDate2:Date;       // Фактическая дата поставки второй части
  var SupplyTime2:Time;           // Время поставки второй части
  var Oper:Integer;               // Исполнитель
  var OperName:String;            // Имя исполнителя
  var UserField1:String;          // Первое пользовательское поле
  var UserField2:String;          // Второе пользовательское поле
  var UserField3:String;          // Третье пользовательское поле
  var UserField4:String;          // Четвертое пользовательское поле
  var Comment:String;             // Комментарий
  var Issuer:Integer;             // Идентификатор эмитента ценной бумаги
  var IssuerName:String;          // Наименование эмитента ценной бумаги
  var SymbOfKindOperRetire:String;// Вид погашения
  var Depositary:Integer;         // Идентификатор депозитария
  var DepositaryName:String;      // Наименование депозитария
  var BofficeKind:Integer;        // Вид бэкофиса
  var NeedSetColorCliring:Bool;   // Надо ли выделить цветом строку скроллинга
  var IsTechDeal:Bool;            // Техническая сделка
  var IsReplDeal:Bool;            // Реплицированная сделка
  var IsManualMode:Bool;          // Ручной режим
end;

// класс CScDeal для заполнения вкладки "Сделка"
class CScDeal
  var DealID:Integer;                  // Идентификатор сделки
  var DealCode:String;                 // Код внутренний
  var DealDate:Date;                   // Дата заключения
  var DealTime:Time;                   // Время заключения
  var IsNetting:Bool;                  // Возможность включения сделки в неттинг
  var DealCodeTS:String;               // Код внешний
  var DealCountry;//:TWsCountry        // Место заключения сделки
  var TypeDoc:TWsTypeAc;               // Тип сделки
  var TypeDocList:TArray;              // Массив типов сделок
  var Flag1:Bool;                      // Признак "ОРЦБ"
  var Flag2:Bool;                      // Признак "с учетом НДФЛ"
  var Flag3:Bool;                      // Признак "возврат доходов"
  var Flag4:Bool;                      // Признак "Расчеты через брокера"
  var Flag5:Bool;                      // Признак "Возврат доходов по ц/б контрагенту"
  var IsPartyClient:Bool;              // Контрагент является клиентом
  var Trader;//:TWsPartyEx             // Биржа
  var MarketSchem:CScMarket;           // Схема расчетов с биржей
  var DepoSchem:CScDepSet;             // Схема депозитарного учета
  var CenterOfficeName:String;         // Сектор
  var FixSum;//:TWsNameAlg             // Пересчет
  var PeriodType;//:TWsNameAlg         // Срок задается в
  var PreOutlay:Integer;               // Предварительные затраты
  var CrncPreOutlay;//:TWsFinInstr     // Валюта предварительных затрат
  var BuyOutlay:Money;                 // Затраты на преобретение
  var CrncBuyOutlay;//:TWsFinInstr     // Валюта затрат на преобретение
  var Overval:Money;                   // Сумма переоценки
  var CrncOverval;//:TWsFinInstr       // Валюта суммы переоценки
  var DateOverval:Date;                // Дата переоценки
  var CommDate:Date;                   // Дата оплаты комиссии
  var Portfolio:TWsLlvalues;           // Портфель
  var Portfolio_2:TWsLlvalues;         // Портфель 2ч.
  var PortfolioList:TArray;            // Портфель
  var Client;//:TWsPartyEx             // Клиент
  var ClientContr;//:TWsSfContr        // Договор с клиентом
  var Broker;//:TWsPartyEx             // Посредник
  var BrokerContr;//:TWsSfContr        // Договор с посредников
  var Party;//:TWsPartyEx              // Контрагент
  var PartyContr;//:TWsSfContr         // Договор с контрагентом
  var Department:TWsDepartment;        // Филиал
  var Oper:Integer;                    // Номер операциониста
  var OperName:String;                 // Имя операциониста
  var DealType:Integer;                // Тип сделки
  var BofficeKind:Integer;             // Вид бэк-оффиса
  var DealStatus:integer;              // Статус сделки
  var ChangeDate:Date;                 // Дата изменения
  var ChangeKind:integer;              // Действие
  var TraderID:integer;                // Идентификатор трейдера
  var MarketOfficeID:integer;          // Идентификатор сектора торговой площадки
  var OriginID:integer;                // Происхождение сделки
  var DealVersion:Integer;             // Версия записи сделки
  var Blocked:Bool;                    // Признак "Блокировка ц/б"
  var ReturnIncomeType;//:TWsNameAlg   // Способ возврата дохода
  var Pay_Agent;//:TWsPartyEx          // Платежный агент
  var Number_Coupon:CTxAvoirPay;       // № купона
  var Number_Partly:CTxAvoirPay;       // № ЧП
  var IsTechDeal:Bool;                 // Техническая сделка

  // Данные для операции Займа
  var ContractorIsDeponent:Bool;       // Контрагент является депонентом
  var NumDays:Integer;                 // Срок займа план
  var NumDaysFact:Integer;             // Срок займа факт
  var IncomeRate:Money;                // Процентная ставка Операция Займ
  var IncomePoint:Integer;             // Точность процентная ставка
  var ReturnIncome:Money;              // Сумма процентов
  var CrncPayPC;//:TWsFinInstr         // Валюта оплаты
  var ReturnIncomeLoan:Money;          // Сумма доходов Займ

  var Leg_ID:Integer;                  // Идентификатор части
  var RejectDate:Date;                 // Дата отказа
  var CloseDate:Date;                  // Дата закрытия
  var IsSetDVExe:Bool;                 // Сделка ПФИ
  var IsPrognos:Bool;                  // Заполняется программно при импорте клиентских сделок из системы QUIK
  var IssKind:CTxAvrKinds;             // Вид ц/б
  var Issuer;//:TWsPartyEx             // Эмитент
  var Iss;//:TWsFinInstr               // ц/б
  var Iss_ISIN; //:TWsFinInstr         // та же ц/б, но для листалки и отображения ISIN
  var IssKind_b:CTxAvrKinds;           // Вид ц/б 2
  var Issuer_b;//:TWsPartyEx           // Эмитент 2
  var Iss_b;//:TWsFinInstr             // ц/б 2
  var IssAvoirIss:CTxAvoirIss;         // ц/б_extern
  var IssAvoirIss_b:CTxAvoirIss;       // ц/б_extern 2
  var DeliverIss;//:TWsFinInstr        // Поставляемый выпуск
  var TypeCalc:TWsTypeAc;              // Тип расчета
  var TypeCalcList:TArray;             // Массив типов расчетов
  var Principal:Money;                 // Количество ц/б
  var Principal_b:Money;               // Количество ц/б 2
  var RelativePrice:Bool;              // Признак "цена задается в %" от номинала
  var Price:Double;                    // Цена
  var Point:Integer;                   // Точность цены
  var Crnc;//:TWsFinInstr              // Валюта цены
  var Crnc_b;//:TWsFinInstr            // Валюта цены 2
  var Cost:Money;                      // Стоимость ц/б
  var NKD:Money;                       // НКД
  var Nom;//:TWsFinInstr               // Валюта НКД
  var TotalCost:Money;                 // Сумма
  var CrncPay;//:TWsFinInstr           // Валюта расчетов
  var Avance:Bool;                     // Аванс
  var Deposit:Bool;                    // Задаток
  var StartDiff:Integer;               // Срок аванса
  var PeriodTypeAvance;//:TWsNameAlg   // Тип срока аванса
  var Start:Date;                      // Дата аванса плановая
  var FactAvanceDate:Date;             // Дата аванса фактическая
  var SumAvance:Money;                 // Сумма аванса
  var Diff:Integer;                    // Срок оплаты
  var PeriodTypePay;//:TWsNameAlg      // Тип срока оплаты
  var ContrDate:Date;                  // Дата оплаты
  var FactContrDate:Date;              // Фактическая дата оплаты
  var SumPayNoAvance:Money;            // Сумма оплаты
  var PayRegTax:Bool;                  // Оплата регистрационного сбора
  var Registrar;//:TWsPartyEx          // Регистратор
  var RegistrarContr;//:TWsSfContr     // Договор с регистратором
  var Depositary;//:TWsPartyEx         // РД
  var CliringDate:Date;                // Дата клиринга
  var CliringTime:Time;                // Время клиринга
  var CliringSession;//:TWsNameAlg     // Номер сессии клиринга
  var CliringChange:Bool;              // Признак "изменение условий в клиринге"
  var PrincipalDiff:Integer;           // Срок поставки
  var PeriodTypeState;//:TWsNameAlg    // Тип срока поставки
  var BaseDate:Date;                   // Дата поставки
  var FactBaseDate:Date;               // Фактическая дата поставки
  var SupplyTime:Time;                 // Время поставки
  var LegVersion:Integer;              // Версия записи части
  var OperState:Integer;               // Статус операции
  var BasisCalc;//:TWsNameAlg          // База расчета цены
  var Nominal:Double;                  // Номинал ц/б
  var NominalFIID;//:TWsFinInstr       // Валюта номинала
  var Maturity:Date;                   // Для погашений - дата получения средств

  var Leg_ID_b:Integer;                // Идентификатор второй части
  var RejectDate_b:Date;               // Дата отказа от второй части
  var IncomeRate_b:Double;             // Ставка РЕПО
  var ReturnIncome_b:Money;            // Сумма процентов к получению
  var BaseDate_b:Date;                 // Дата поставки 2ч.
  var ContrDate_b:Date;                // Дата оплаты 2ч.
  var FactBaseDate_b:Date;             // Фактическая дата поставки 2ч.
  var SupplyTime_b:Time;               // Время поставки 2ч.
  var WrtSum_b_Date:Date;              // Дата поставки 2ч.
  var WrtSum_b_Time:Time;              // Время поставки 2ч.
  var CliringDate_b:Date;              // Дата клиринга 2ч.
  var CliringTime_b:Time;              // Время клиринга   2ч.
  var CliringSession_b;//:TWsNameAlg   // Номер сессии клиринга 2ч.
  var CliringChange_b:Bool;            // Признак "изменение условий в клиринге" 2ч.
  var DeliverIss_b;//:TWsFinInstr      // Поставляемый выпуск 2ч.
  var RelativePrice_b:Bool;            // Признак "цена задается в %" от номинала 2ч.
  var Price_b:Double;                  // Цена 2ч.
  var Cost_b:Money;                    // Стоимость ц/б 2ч.
  var NKD_b:Money;                     // НКД 2ч.
  var Nom_b;//:TWsFinInstr             // Валюта НКД 2ч.
  var TotalCost_b:Money;               // Сумма 2ч.
  var LegVersion_b:Integer;            // Версия записи второй части
  var OperState_b:Integer;             // Статус операции по второй части
  var PayRegTax_b:Bool;                // Оплата регистрационного сбора по второй части
  var Registrar_b;//:TWsPartyEx;       // Регистратор 2ч
  var RegistrarContr_b;//:TWsSfContr   // Договор с регистратором 2ч
  var Start_b:Date;                    // Дата аванса плановая по 2ч
  var Avance_b:Bool;                   // Аванс 2ч
  var Deposit_b:Bool;                  // Задаток 2ч
  var SumAvance_b:Money;               // Сумма аванса 2ч
  var SumPayNoAvance_b:Money;          // Сумма оплаты 2ч
  var FactAvanceDate_b:Date;           // Дата аванса фактическая по 2ч
  var FactContrDate_b:Date;            // Фактическая дата оплаты 2ч
  var TypeCalc_b:TWsTypeAc;            // Тип расчета по 2ч
  var StartDiff_b:Integer;             // Срок аванса по 2ч
  var PeriodTypeAvance_b;//:TWsNameAlg // Тип срока аванса по 2ч
  var Diff_b:Integer;                  // Срок оплаты по 2ч
  var PeriodTypePay_b;//:TWsNameAlg    // Тип срока оплаты по 2ч
  var Depositary_b;//:TWsPartyEx       // Расчетный депозитарий по 2ч
  var PrincipalDiff_b:Integer;         // Срок поставки по 2ч
  var PeriodTypeState_b;//:TWsNameAlg  // Тип срока поставки по 2ч
  var ValueDate_c:Date;                // Клиринг дата
  var Price_c:Double;                  // Клиринг цена
  var Cost_c:Money;                    // Клиринг стоимость
  var NKD_c:Money;                     // Клиринг НКД
  var TotalCost_c:Money;               // Клиринг сумма
  var ValueDate_cb:Date;               // Клиринг дата 2ч
  var Price_cb:Double;                 // Клиринг цена 2ч
  var Cost_cb:Money;                   // Клиринг стоимость 2ч
  var NKD_cb:Money;                    // Клиринг НКД 2ч
  var TotalCost_cb:Money;              // Клиринг сумма 2ч

  var WrtTaxCostDate:Date;             // Дата первоначальной покупки бумаг по документам клиента
  var WrtTaxPriceSum:Money;            // Цена первоначальной покупки для целей налогообложения
  var WrtTaxCostSum:Money;             // Стоимость первоначальной покупки для целей налогообложения
  var WrtTaxNkdSum:Money;              // НКД, уплаченный при покупке для целей налогообложения
  var WrtTaxOutlaySum:Money;           // Затраты при покупке для целей налогообложения

  var IsAvrwrtTaxesPanelReadOnly:bool; // Доступность панели данные для НУ для редактирования
  var WrtTaxLastDate:Date;             // Дата окончания периода  расчета связей по зачисляемой/списываемой бумаге

  // Данные используемые в шарпе
  var IsExchange:Bool;                 // Биржевая сделка?
  var IsOutExchange:Bool;              // Внебиржевая сделка?
  var IsBroker:Bool;                   // Брокерская сделка?
  var IsRepo:Bool;                     // РЕПО?
  var IsBasket:Bool;                   // Корзина?
  var IsKsu:Bool;                      // КСУ?
  var IsInterDealerRepo:Bool;          // Междиллерское РЕПО?
  var IsLoan:Bool;                     // Займ?
  var IsConvShare:Bool;                // Конвертация акций в депозитарные расписки?
  var IsConvReceipt:Bool;              // Конвертация депозитарных расписок в акции?
  var IsAvrWrtIn:Bool;                 // Операция зачисления ц/б?
  var IsSALE:Bool;                     // Продажа?
  var IsRet_Coupon:Bool;               // Погашение купона?
  var IsRet_Partly:Bool;               // ЧП?
  var IsRet_Issue:Bool;                // Погашение выпуска?
  var IsToday:Bool;                    // Признак сделка today?
  var IsTwoPart:Bool;                  // Сделка из двух частей?
  var ExistLot:Bool;                   // Есть лот?
  var TypeCode:String;                 // Тип сделки

  // Источники данных для виджетов "NameAlgWidget", подкачиваемые из прикладного кода
  var PeriodTypeList:TArray;           // Срок задается в
  var PeriodTypePayList:TArray;        // Тип срока оплаты
  var PeriodTypeAvanceList:TArray;     // Тип срока аванса
  var ReturnIncomeTypeList:TArray;     // Способ возврата дохода
  var BasisCalcList:TArray;            // База расчета цены
  var PeriodTypeStateList:TArray;      // Тип срока поставки

  var ChangedProperty:String;          // Имя измененного поля
  var CheckingPropertyList; //:TArray of String // Список свойств для проверки

  macro Construct()
    /*TypeDocList = TArray();
    PortfolioList = TArray();
    TypeCalcList = TArray();
    PeriodTypeList = TArray();
    PeriodTypePayList = TArray();
    PeriodTypeAvanceList = TArray();
    ReturnIncomeTypeList = TArray();
    BasisCalcList = TArray();
    PeriodTypeStateList = TArray();*/

    // из-за особенностей нового инструмента HTML5 (возможно временно)
    DealID = 0;
    DealCode = "";
    //DealDate = Date(0,0,0);
    //DealTime = Time(0,0,0);
    IsNetting = false;
    DealCodeTS = "";
    //DealCountry;//:TWsCountry
    //TypeDoc:TWsTypeAc;
    TypeDocList = TArray();
    Flag1 = false;
    Flag2 = false;
    Flag3 = false;
    Flag4 = false;
    Flag5 = false;
    IsPartyClient = false;
    //Trader;//:TWsPartyEx
    //MarketSchem:CScMarket;
    //DepoSchem:CScDepSet;
    CenterOfficeName = "";
    //FixSum;//:TWsNameAlg
    //PeriodType;//:TWsNameAlg
    PreOutlay = 0;
    //CrncPreOutlay;//:TWsFinInstr
    BuyOutlay = $0;
    //CrncBuyOutlay;//:TWsFinInstr
    Overval = $0;
    //CrncOverval;//:TWsFinInstr
    //DateOverval = Date(0,0,0);
    //CommDate = Date(0,0,0);
    //Portfolio:TWsLlvalues;
    //Portfolio_2:TWsLlvalues;
    PortfolioList = TArray();
    //Client;//:TWsPartyEx
    //ClientContr;//:TWsSfContr
    //Broker;//:TWsPartyEx
    //BrokerContr;//:TWsSfContr
    //Party;//:TWsPartyEx
    //PartyContr;//:TWsSfContr
    //Department:TWsDepartment;
    Oper = 0;
    OperName = "";
    DealType = 0;
    BofficeKind = 0;
    DealStatus = 0;
    //ChangeDate = Date(0,0,0);
    ChangeKind = 0;
    TraderID = 0;
    MarketOfficeID = 0;
    OriginID = 0;
    DealVersion = 0;
    Blocked = false;
    //ReturnIncomeType;//:TWsNameAlg
    //Pay_Agent;//:TWsPartyEx
    //Number_Coupon:CTxAvoirPay;
    //Number_Partly:CTxAvoirPay;
    IsTechDeal = false;

    ContractorIsDeponent = false;
    NumDays = 0;
    NumDaysFact = 0;
    IncomeRate = $0;
    IncomePoint = 0;
    ReturnIncome = $0;
    //CrncPayPC;//:TWsFinInstr
    ReturnIncomeLoan = $0;

    Leg_ID = 0;
    //RejectDate = Date(0,0,0);
    //CloseDate = Date(0,0,0);
    IsSetDVExe = false;
    IsPrognos = false;
    //IssKind:CTxAvrKinds;
    //Issuer;//:TWsPartyEx
    //Iss;//:TWsFinInstr
    //Iss_ISIN;//:TWsFinInstr
    //IssKind_b:CTxAvrKinds;
    //Issuer_b;//:TWsPartyEx
    //Iss_b;//:TWsFinInstr
    //IssAvoirIss:CTxAvoirIss;
    //IssAvoirIss_b:CTxAvoirIss;
    //DeliverIss;//:TWsFinInstr
    //TypeCalc:TWsTypeAc;
    TypeCalcList = TArray();
    Principal = $0;
    Principal_b = $0;
    RelativePrice = false;
    Price = 0.0;
    Point = 0;
    //Crnc;//:TWsFinInstr
    //Crnc_b;//:TWsFinInstr
    Cost = $0;
    NKD = $0;
    //Nom;//:TWsFinInstr
    TotalCost = $0;
    //CrncPay;//:TWsFinInstr
    Avance = false;
    Deposit = false;
    StartDiff = 0;
    //PeriodTypeAvance;//:TWsNameAlg
    //Start = Date(0,0,0);
    //FactAvanceDate = Date(0,0,0);
    SumAvance = $0;
    Diff = 0;
    //PeriodTypePay;//:TWsNameAlg
    //ContrDate = Date(0,0,0);
    //FactContrDate = Date(0,0,0);
    SumPayNoAvance = $0;
    PayRegTax = false;
    //Registrar;//:TWsPartyEx
    //RegistrarContr;//:TWsSfContr
    //Depositary;//:TWsPartyEx
    //CliringDate = Date(0,0,0);
    //CliringTime = Time(0,0,0);
    //CliringSession;//:TWsNameAlg
    CliringChange = false;
    PrincipalDiff = 0;
    //PeriodTypeState;//:TWsNameAlg
    //BaseDate = Date(0,0,0);
    //FactBaseDate = Date(0,0,0);
    //SupplyTime = Time(0,0,0);
    LegVersion = 0;
    OperState = 0;
    //BasisCalc;//:TWsNameAlg
    Nominal = 0.0;
    //NominalFIID;//:TWsFinInstr
    //Maturity = Date(0,0,0);

    Leg_ID_b = 0;
    //RejectDate_b = Date(0,0,0);
    IncomeRate_b = 0.0;
    ReturnIncome_b = $0;
    //BaseDate_b = Date(0,0,0);
    //ContrDate_b = Date(0,0,0);
    //FactBaseDate_b = Date(0,0,0);
    //SupplyTime_b = Time(0,0,0);
    //WrtSum_b_Date = Date(0,0,0);
    //WrtSum_b_Time = Time(0,0,0);
    //CliringDate_b = Date(0,0,0);
    //CliringTime_b = Time(0,0,0);
    //CliringSession_b;//:TWsNameAlg
    CliringChange_b = false;
    //DeliverIss_b;//:TWsFinInstr
    RelativePrice_b = false;
    Price_b = 0.0;
    Cost_b = $0;
    NKD_b = $0;
    //Nom_b;//:TWsFinInstr
    TotalCost_b = $0;
    LegVersion_b = 0;
    OperState_b = 0;
    PayRegTax_b = false;
    //Registrar_b;//:TWsPartyEx;
    //RegistrarContr_b;//:TWsSfContr
    //Start_b = Date(0,0,0);
    Avance_b = false;
    Deposit_b = false;
    SumAvance_b = $0;
    SumPayNoAvance_b = $0;
    //FactAvanceDate_b = Date(0,0,0);
    //FactContrDate_b = Date(0,0,0);
    //TypeCalc_b:TWsTypeAc;
    StartDiff_b = 0;
    //PeriodTypeAvance_b;//:TWsNameAlg
    Diff_b = 0;
    //PeriodTypePay_b;//:TWsNameAlg
    //Depositary_b;//:TWsPartyEx
    PrincipalDiff_b = 0;
    //PeriodTypeState_b;//:TWsNameAlg
    //ValueDate_c = Date(0,0,0);
    Price_c = 0.0;
    Cost_c = $0;
    NKD_c = $0;
    TotalCost_c = $0;
    //ValueDate_cb = Date(0,0,0);
    Price_cb = 0.0;
    Cost_cb = $0;
    NKD_cb = $0;
    TotalCost_cb = $0;

    //WrtTaxCostDate = Date(0,0,0);
    WrtTaxPriceSum = $0;
    WrtTaxCostSum = $0;
    WrtTaxNkdSum = $0;
    WrtTaxOutlaySum = $0;

    IsAvrwrtTaxesPanelReadOnly = false;
    //WrtTaxLastDate = Date(0,0,0);

    IsExchange = false;
    IsOutExchange = false;
    IsBroker = false;
    IsRepo = false;
    IsBasket = false;
    IsKsu = false;
    IsInterDealerRepo = false;
    IsLoan = false;
    IsConvShare = false;
    IsConvReceipt = false;
    IsAvrWrtIn = false;
    IsSALE = false;
    IsRet_Coupon = false;
    IsRet_Partly = false;
    IsRet_Issue = false;
    IsToday = false;
    IsTwoPart = false;
    ExistLot = false;
    TypeCode = "";
    
    PeriodTypeList = TArray();
    PeriodTypePayList = TArray();
    PeriodTypeAvanceList = TArray();
    ReturnIncomeTypeList = TArray();
    BasisCalcList = TArray();
    PeriodTypeStateList = TArray();

    ChangedProperty = "";
    CheckingPropertyList = TArray();
  end;

  this.Construct();
end;

// класс CScRQAcc для заполнения вкладки "Платежные реквизиты"
class CScRQAcc()
  var ID:Integer;               // Идентификатор записи
  var DocKind:Integer;          // Вид документа
  var DocID:Integer;            // Идентификатор документа
  var SubKind:Integer;          // Подвид ТО
  var Type:Integer;             // Тип ТО
  var TypeName:String;          // Название типа ТО
  var Party:Integer;            // Контрагент
  var PartyShortName:String;    // Короткое наименование контрагента
  var FIID:Integer;             // Финансовый инструмент
  var FICode:String;            // Код финансового инструмента
  var BankID:Integer;           // Идентификатор банка
  var Chapter:Integer;          // Глава счетов
  var Account:String;           // Счет куда перечисляются средства
  var BankCodeKind:Integer;     // Вид кода банка
  var BankCode:String;          // Код банка
  var BankName:String;          // Наименование банка
  var BankCorrID:Integer;       // Идентификатор корреспондента банка
  var BankCorrCodeKind:Integer; // Вид кода корреспондента банка
  var BankCorrCode:String;      // Код корреспондента банка
  var BankCorrName:String;      // Наименование корреспондента банка
  var CorrAcc:String;           // Корсчет
  var Action:Integer;           // Вид действия
  var Version:Integer;          // Версия записи

  macro Construct()
     ID               = 0;
     DocKind          = 0;
     DocID            = 0;
     SubKind          = 0;
     Type             = -1;
     TypeName         = "";
     Party            = UnknownParty;
     PartyShortName   = "";
     FIID             = ALLFININSTR;
     FICode           = "";
     BankID           = -1;
     Chapter          = 0;
     Account          = "";
     BankCodeKind     = 0;
     BankCode         = "";
     BankName         = "";
     BankCorrID       = -1;
     BankCorrCodeKind = 0;
     BankCorrCode     = "";
     BankCorrName     = "";
     CorrAcc          = "";
     Action           = OperationKind_Undefine;
     Version          = 0;
  end;

  this.Construct();
end;

// класс CScRQ для заполнения вкладки "Требования/обязательства"
class CScRQ
  var ID:Integer;            // Идентификатор
  var Kind;//:TWsNameAlg     // Вид
  var KindEx;//:TWsNameAlg   // Вид
  var SubKind;//:TWsNameAlg  // Подвид ТО
  var Type;//:TWsNameAlg     // Тип
  var Amount:Money;          // Сумма
  var FI;//:TWsFinInstr      // ИД ФИ
  var FIName: string;        // Наименование ФИ
  var Party;//:TWsPartyEx    // Контрагент
  var Place;//:TWsPartyEx    // Место учета
  var State;//:TWsNameAlg    // Статус
  var PlanDate:Date;         // Плановая дата исполнения
  var FactDate:Date;         // Фактическая дата исполнения
  var UseNetting:Bool;       // Включать ли в неттинг?
  var Netting:Bool;          // Включено в неттинг
  var Cliring:Bool;          // Клиринг
  var DocKindName:String;    // Сделка/операция
  var DocID:Integer;         // Идентификатор документа
  var DealPart;//:TWsNameAlg // Часть сделки (1 или 2)
  var RQAcc:CScRQAcc;        // Платежные реквизиты
  var Num:Integer;           // Порядковый номер ТО данного типа по сделке
  var DocKind:integer;       // Вид документа
  var SourceObjKind:Integer; // Вид ПД объекта-источника ТО
  var SourceObjID:Integer;   // ID ПД объекта-источника ТО
  var ChangeDate:Date;       // Дата изменения
  var RQAction:Integer;      // Вид изменения
  var Action:Integer;        // Вид действия
  var Version:Integer;       // Версия записи
  var ChangedProperty:String;// Имя измененного поля

  // Источники данных для виджетов "NameAlgWidget", подкачиваемые из прикладного кода
  var KindExList:TArray;     // Вид
  var TypeList:TArray;       // Тип
  var StateList:TArray;      // Статус
  var DealPartList:TArray;   // Часть

  macro Construct()
     ID              = 0;
     Amount          = 0.0;
     PlanDate        = ZeroDate;
     FactDate        = ZeroDate;
     UseNetting      = false;
     Netting         = false;
     Cliring         = false;
     FIName          = "";
     DocKindName     = "";
     DocID           = 0;
     Num             = 0;
     DocKind         = 0;
     SourceObjKind   = 0;
     SourceObjID     = 0;
     ChangeDate      = ZeroDate;
     RQAction        = -1;
     Action          = OperationKind_Undefine;
     Version         = 0;
     ChangedProperty = "";

     KindExList = TArray();
     TypeList = TArray();
     StateList = TArray();
     DealPartList = TArray();
  end;

  this.Construct();
end;

// класс CScComiss для заполнения вкладки "Комиссии"
class CScComiss
  var ID:Integer;               // Идентификатор
  var DocKind:integer;          // Вид ПД, к которому при-вязана комиссия
  var DocID:integer;            // ПД (сделка), к которому привязана комиссия
  var FeeType:integer;          // Тип взимания по комиссии
  var ComNumber:integer;        // Идентификатор комиссии в разрезе типов взимания
  var Payer;//:TWsPartyEx       // Плательщик
  var Receiver;//:TWsPartyEx    // Получатель
  var Contr;//:TWsSfContr       // Договор
  var Comission;//:TWsSfConCom  // Комиссиия
  var Sum:Money;                // Сумма комиссии
  var SummaNotNDS:Money;        // Сумма комиссии без НДС
  var NDS:Money;                // НДС
  var FIID_Comm;//:TWsFinInstr  // ИД валюты комиссии
  var Date:Date;                // Дата комиссии
  var PlanPayDate:Date;         // Планируемая дата оплаты
  var FactPayDate:Date;         // Фактическая дата оплаты
  var InputMedium:String;       // Способ ввода комиссии в систему
  var Immaterial:Bool;          // Признак несущественной суммы
  var IsBack:Bool;              // Признак - комиссия по 2ч сделки.
  var ExistGrDeal:Bool;         // Признак - существуют обработанные виды учёта по строке графика оплаты комисси за дату
  var Action:Integer;           // Вид действия
  var TypeNDS:Integer;          // Тип НДС
  var Version:Integer;          // Версия записи
  var ChangedProperty:String;   // Имя измененного поля
end;

// класс CScEnsure вкладки "Обеспечение"
class CScEnsure()
  var ID:Integer;             // Идентификатор
  var DealID:Integer;         // Идентификатор сделки
  var FI;//:TWsFinInstr       // Идентификатор ценной бумаги обеспечения
  var CFI;//:TWsFinInstr      // Валюта номинала ценной бумаги обеспечения
  var Date:Date;              // Дата включения/исключения
  var Kind:Integer;           // Направление ввод/вывод
  var Principal:Money;        // Направление ввод/вывод
  var TotalCost:Money;        // Стоимость
  var CostFI;//:TWsFinInstr   // Валюта стоимости
  var NKD:Money;              // НКД
  var IsIndexNominal:Bool;    // Индексируемый номинал
  var RootAvrKinds:Integer;   // Корневой подвид ц/б
  var Action:Integer;         // Вид действия
  var Version:Integer;        // Версия записи
  var Children;               // Дочерние записи
  var ChangedProperty:String; // Имя измененного поля
  var Parent:Bool;            // Родительская запись
end;

// класс CScPanelDeal данные панели сделки
class CScPanelDeal
  var Deal;//:CScDeal // Параметры сделки
  var SaveDeal;//:CScDeal // Буфер сделки до изменений
  var RQAcc:TArray; // Список платежных реквизитов
  var RQ:TArray; // Список требований/обязательств
  var Comiss:TArray; // Список комиссий
  var EnsureList:TArray; // Список обеспечений
  var RQAccLastID:Integer;
  var RQLastID:Integer;
  var ComissLastID:Integer;
  var EnsureLastID:Integer;
  var EditDealMode:Integer; // Режим редактирования панели сделки
  var RecalcDealParam:Bool; // Пересчитывать ценовые параметры
  var OldDeal;//:CScDeal // Параметры сделки

  macro Construct()
    RQAcc = TArray();
    RQ = TArray();
    Comiss = TArray();
    EnsureList = TArray();
  end;

  this.Construct();
end;

// Получение записи CScRQAcc
macro GetScRQAcc(
  ID:integer // Идентификатор записи
)

  var stat:integer = -1;
  var ScRQAcc = CScRQAcc();

  if( ID == null )
     RunError("Не задан обязательный параметр функции GetScRQAcc: идентификатор");
  end;

  var query = RSDCommand( " SELECT (case when fin.t_FI_Kind = ? then fin.t_ISO_Number else fin.t_FI_Code end) FICode, " +
                          "        party.t_ShortName PartyShortName, " +
                          "        namealg.t_szNameAlg TypeName, " +
                          "        rqacc.t_ID, " +
                          "        rqacc.t_DocKind, " +
                          "        rqacc.t_DocID, " +
                          "        rqacc.t_SubKind, " +
                          "        rqacc.t_Type, " +
                          "        rqacc.t_Party, " +
                          "        rqacc.t_FIID, " +
                          "        rqacc.t_BankID, " +
                          "        rqacc.t_Chapter, " +
                          "        rqacc.t_Account, " +
                          "        rqacc.t_BankName, " +
                          "        rqacc.t_CorrAcc, " +
                          "        rqacc.t_BankCorrName, " +
                          "        rqacc.t_BankCodeKind, " +
                          "        rqacc.t_BankCode, " +
                          "        rqacc.t_BankCorrID, " +
                          "        rqacc.t_BankCorrCodeKind, " +
                          "        rqacc.t_BankCorrCode, " +
                          "        rqacc.t_Version " +
                          "   FROM ddlrqacc_dbt rqacc, dfininstr_dbt fin, dparty_dbt party, dnamealg_dbt namealg " +
                          "  WHERE rqacc.t_ID = ? " +
                          "    AND fin.t_FIID(+)           = rqacc.t_FIID " +
                          "    AND party.t_PartyID(+)      = rqacc.t_Party " +
                          "    AND namealg.t_iTypeAlg(+)   = ? " +
                          "    AND namealg.t_iNumberAlg(+) = rqacc.t_Type " );
  query.NullConversion = true;
  query.addParam( "", RSDBP_IN, FIKIND_CURRENCY );
  query.addParam( "", RSDBP_IN, ID );
  query.addParam( "", RSDBP_IN, 7513/*ALG_DLRQ_TYPE*/ );
  query.execute();

  var ds = TRsbDataSet(query);

  if( ds.MoveNext() )
     ScRQAcc.ID               = SQL_ConvTypeInteger(ds.ID);
     ScRQAcc.DocKind          = SQL_ConvTypeInteger(ds.DocKind);
     ScRQAcc.DocID            = SQL_ConvTypeInteger(ds.DocID);
     ScRQAcc.SubKind          = SQL_ConvTypeInteger(ds.SubKind);
     ScRQAcc.Type             = SQL_ConvTypeInteger(ds.Type);
     ScRQAcc.TypeName         = SQL_ConvTypeStr(ds.TypeName);
     ScRQAcc.Party            = SQL_ConvTypeInteger(ds.Party);
     ScRQAcc.PartyShortName   = SQL_ConvTypeStr(ds.PartyShortName);
     ScRQAcc.FIID             = SQL_ConvTypeInteger(ds.FIID);
     ScRQAcc.FICode           = SQL_ConvTypeStr(ds.FICode);
     ScRQAcc.BankID           = SQL_ConvTypeInteger(ds.BankID);
     ScRQAcc.Chapter          = SQL_ConvTypeInteger(ds.Chapter);
     ScRQAcc.Account          = SQL_ConvTypeStr(ds.Account);
     ScRQAcc.BankName         = SQL_ConvTypeStr(ds.BankName);
     ScRQAcc.CorrAcc          = SQL_ConvTypeStr(ds.CorrAcc);
     ScRQAcc.BankCorrName     = SQL_ConvTypeStr(ds.BankCorrName);
     ScRQAcc.BankCodeKind     = SQL_ConvTypeInteger(ds.BankCodeKind);
     ScRQAcc.BankCode         = SQL_ConvTypeStr(ds.BankCode);
     ScRQAcc.BankCorrID       = SQL_ConvTypeInteger(ds.BankCorrID);
     ScRQAcc.BankCorrCodeKind = SQL_ConvTypeStr(ds.BankCorrCodeKind);
     ScRQAcc.BankCorrCode     = SQL_ConvTypeStr(ds.BankCorrCode);
     ScRQAcc.Version          = SQL_ConvTypeInteger(ds.Version);
  end;

  return ScRQAcc;
end;


//  Функции заполнения записей таблиц из классов RSL

macro SetTick_ByCScDeal( TickRec, Deal )
  TickRec.DealID           = Deal.DealID;
  TickRec.DealCode         = Deal.DealCode;
  TickRec.DealDate         = WS_ConvTypeDate(Deal.DealDate);
  TickRec.DealTime         = Deal.DealTime;
  TickRec.IsNetting        = IIF(Deal.IsNetting, SET_CHR, UNSET_CHR);
  TickRec.IsPFI            = IIF(Deal.IsSetDVExe, SET_CHR, UNSET_CHR);
  TickRec.DealCodeTS       = Deal.DealCodeTS;
  if( Deal.DealCountry != NULL )
     TickRec.Country = Deal.DealCountry.CodeLat3;
  else
     TickRec.Country = "";
  end;
  TickRec.TypeDoc          = SP_GetTypeAccType(Deal.TypeDoc);
  TickRec.Flag1            = IIF(Deal.Flag1, SET_CHR, UNSET_CHR);
  if( not Deal.IsLoan )
     TickRec.Flag3         = IIF(SP_GetNameAlgNumberAlg(Deal.PeriodType) == 1, SET_CHR, UNSET_CHR);
  else
     TickRec.Flag3         = IIF(Deal.Flag3, SET_CHR, UNSET_CHR);
  end;
  TickRec.Flag4            = IIF(Deal.Flag4, SET_CHR, UNSET_CHR);
  TickRec.Flag5            = IIF(Deal.Flag5, SET_CHR, UNSET_CHR);
  TickRec.ReturnIncomeKind = SP_GetNameAlgNumberAlg(Deal.ReturnIncomeType);
  TickRec.IsPartyClient    = IIF(Deal.IsPartyClient, SET_CHR, UNSET_CHR);
  TickRec.MarketID         = SP_GetPartyID(Deal.Trader);
  TickRec.MarketSchemeID   = SP_GetMarketID(Deal.MarketSchem);
  TickRec.DepSetID         = SP_GetDepSetID(Deal.DepoSchem);
  TickRec.FixSum           = SP_GetNameAlgNumberAlg(Deal.FixSum);
  TickRec.PreOutlay        = Deal.PreOutlay;
  TickRec.PreOutlayFIID    = SP_GetFIID(Deal.CrncPreOutlay);
  TickRec.CommDate         = WS_ConvTypeDate(Deal.CommDate);
  TickRec.PortfolioID      = SP_GetLlvElement(Deal.Portfolio);
  TickRec.PortfolioID_2    = SP_GetLlvElement(Deal.Portfolio_2);
  TickRec.ClientID         = SP_GetPartyID(Deal.Client);
  TickRec.ClientContrID    = SP_GetContrID(Deal.ClientContr);
  TickRec.BrokerID         = SP_GetPartyID(Deal.Broker);
  TickRec.BrokerContrID    = SP_GetContrID(Deal.BrokerContr);
  TickRec.PartyID          = SP_GetPartyID(Deal.Party);
  TickRec.PartyContrID     = SP_GetContrID(Deal.PartyContr);
  TickRec.Department       = SP_GetDprtCode(Deal.Department);
  TickRec.Oper             = Deal.Oper;
  TickRec.DealType         = Deal.DealType;
  TickRec.BofficeKind      = Deal.BofficeKind;
  TickRec.DealStatus       = Deal.DealStatus;
  TickRec.ChangeDate       = WS_ConvTypeDate(Deal.ChangeDate);
  TickRec.TraderID         = Deal.TraderID;
  TickRec.MarketOfficeID   = Deal.MarketOfficeID;
  TickRec.OriginID         = Deal.OriginID;
  TickRec.Version          = Deal.DealVersion;
  TickRec.Blocked          = IIF(Deal.Blocked, SET_CHR, UNSET_CHR);
  TickRec.Flag5            = IIF(Deal.Flag5, SET_CHR, UNSET_CHR);
  TickRec.ReturnIncomeKind = SP_GetNameAlgNumberAlg(Deal.ReturnIncomeType);
  TickRec.PFI              = SP_GetFIID(Deal.Iss);
  TickRec.Points           = Deal.Point;

  if( Deal.BofficeKind == DL_RETIREMENT )
     TickRec.Number_Coupon    = Deal.Number_Coupon.Number;
     TickRec.Number_Partly    = Deal.Number_Partly.Number;
     TickRec.Flag2            = IIF(Deal.Flag2, SET_CHR, UNSET_CHR);
  end;

  if( Deal.BofficeKind == DL_AVRWRT )
     TickRec.Flag2            = IIF(Deal.Flag2, SET_CHR, UNSET_CHR);
     TickRec.Flag3            = IIF(Deal.Flag3, SET_CHR, UNSET_CHR);
  end;
end;

macro SetLeg_ByCScDeal( LegRec, Deal, Part:integer )

  if( (Part == NULL) or (Part == 1) )
     LegRec.LegKind             = LEG_KIND_DL_TICK;
     LegRec.ID                  = Deal.Leg_ID;
     LegRec.SupplyTime          = Deal.SupplyTime;
     LegRec.Version             = Deal.LegVersion;
     LegRec.OperState           = Deal.OperState;
     LegRec.RelativePrice       = IIF(Deal.RelativePrice, SET_CHR, UNSET_CHR);
     LegRec.NKD                 = Deal.NKD;
     LegRec.TotalCost           = Deal.TotalCost;
     LegRec.Price               = Deal.Price;
     LegRec.Cost                = Deal.Cost;
     LegRec.RejectDate          = WS_ConvTypeDate(Deal.RejectDate);
     LegRec.DeliveringFIID      = SP_GetFIID(Deal.DeliverIss);
     LegRec.NKDFIID             = SP_GetFIID(Deal.Nom);
     LegRec.MaturityIsPrincipal = IIF(WS_ConvTypeDate(Deal.BaseDate) < WS_ConvTypeDate(Deal.ContrDate), SET_CHR, UNSET_CHR);
     LegRec.Expiry              = IIF(WS_ConvTypeDate(Deal.BaseDate) >= WS_ConvTypeDate(Deal.ContrDate), WS_ConvTypeDate(Deal.BaseDate), WS_ConvTypeDate(Deal.ContrDate));
     LegRec.Maturity            = IIF(WS_ConvTypeDate(Deal.BaseDate) <= WS_ConvTypeDate(Deal.ContrDate), WS_ConvTypeDate(Deal.BaseDate), WS_ConvTypeDate(Deal.ContrDate));
     LegRec.CliringDate         = WS_ConvTypeDate(Deal.CliringDate);
     LegRec.CliringTime         = WS_ConvTypeTime(Deal.CliringTime);
     LegRec.Session             = SP_GetNameAlgNumberAlg(Deal.CliringSession);
     LegRec.CliringChange       = IIF(Deal.CliringChange, SET_CHR, UNSET_CHR);
     LegRec.PayRegTax           = IIF(Deal.PayRegTax, SET_CHR, UNSET_CHR);
     LegRec.Registrar           = SP_GetPartyID(Deal.Registrar);
     LegRec.RegistrarContrID    = SP_GetContrID(Deal.RegistrarContr);
     LegRec.Start               = WS_ConvTypeDate(Deal.Start);
     LegRec.Formula             = CodeFor(SP_GetTypeAccType(Deal.TypeCalc));
     LegRec.StartDiff           = Deal.StartDiff;
     LegRec.StartBase           = SP_GetNameAlgNumberAlg(Deal.PeriodTypeAvance);
     LegRec.Diff                = Deal.Diff;
     LegRec.Base                = SP_GetNameAlgNumberAlg(Deal.PeriodTypePay);
     LegRec.PrincipalDiff       = Deal.PrincipalDiff;
     LegRec.PrincipalBase       = SP_GetNameAlgNumberAlg(Deal.PeriodTypeState);
     LegRec.DepositID           = SP_GetPartyID(Deal.Depositary);

     if( Deal.BofficeKind == DL_RETIREMENT )
        LegRec.Maturity         = WS_ConvTypeDate(Deal.Maturity);
     else
        LegRec.MaturityIsPrincipal = IIF(WS_ConvTypeDate(Deal.BaseDate) < WS_ConvTypeDate(Deal.ContrDate), SET_CHR, UNSET_CHR);
        LegRec.Expiry              = IIF(WS_ConvTypeDate(Deal.BaseDate) >= WS_ConvTypeDate(Deal.ContrDate), WS_ConvTypeDate(Deal.BaseDate), WS_ConvTypeDate(Deal.ContrDate));
        LegRec.Maturity            = IIF(WS_ConvTypeDate(Deal.BaseDate) <= WS_ConvTypeDate(Deal.ContrDate), WS_ConvTypeDate(Deal.BaseDate), WS_ConvTypeDate(Deal.ContrDate));
     end;

     if( Deal.BofficeKind == DL_CONVAVR )
        LegRec.Principal        = Deal.Principal;
        LegRec.PFI              = SP_GetFIID(Deal.Iss);
        LegRec.CFI              = SP_GetFIID(Deal.Crnc);
     end;

     if( Deal.IsLoan )
        LegRec.IncomeRate          = Deal.IncomeRate;
        LegRec.IncomePoint         = Deal.Point;
        LegRec.ReceiptAmount       = Deal.NKD_b;
        LegRec.ReturnIncome        = Deal.ReturnIncome;
     end;
  else
     LegRec.LegKind             = LEG_KIND_DL_TICK_BACK;
     LegRec.ID                  = Deal.Leg_ID_b;
     LegRec.SupplyTime          = Deal.SupplyTime_b;
     LegRec.Version             = Deal.LegVersion_b;
     LegRec.OperState           = Deal.OperState_b;
     LegRec.RelativePrice       = IIF(Deal.RelativePrice_b, SET_CHR, UNSET_CHR);
     LegRec.NKD                 = Deal.NKD_b;
     LegRec.TotalCost           = Deal.TotalCost_b;
     LegRec.Price               = Deal.Price_b;
     LegRec.Cost                = Deal.Cost_b;
     LegRec.RejectDate          = WS_ConvTypeDate(Deal.RejectDate_b);
     LegRec.DeliveringFIID      = SP_GetFIID(Deal.DeliverIss_b);
     LegRec.NKDFIID             = SP_GetFIID(Deal.Nom_b);
     LegRec.MaturityIsPrincipal = IIF(WS_ConvTypeDate(Deal.BaseDate_b) < WS_ConvTypeDate(Deal.ContrDate_b), SET_CHR, UNSET_CHR);
     LegRec.Expiry              = IIF(WS_ConvTypeDate(Deal.BaseDate_b) >= WS_ConvTypeDate(Deal.ContrDate_b), WS_ConvTypeDate(Deal.BaseDate_b), WS_ConvTypeDate(Deal.ContrDate_b));
     LegRec.Maturity            = IIF(WS_ConvTypeDate(Deal.BaseDate_b) <= WS_ConvTypeDate(Deal.ContrDate_b), WS_ConvTypeDate(Deal.BaseDate_b), WS_ConvTypeDate(Deal.ContrDate_b));
     LegRec.CliringDate         = WS_ConvTypeDate(Deal.CliringDate_b);
     LegRec.CliringTime         = WS_ConvTypeTime(Deal.CliringTime_b);
     LegRec.Session             = SP_GetNameAlgNumberAlg(Deal.CliringSession_b);
     LegRec.CliringChange       = IIF(Deal.CliringChange_b, SET_CHR, UNSET_CHR);
     LegRec.PayRegTax           = IIF(Deal.PayRegTax_b, SET_CHR, UNSET_CHR);
     LegRec.Registrar           = SP_GetPartyID(Deal.Registrar_b);
     LegRec.RegistrarContrID    = SP_GetContrID(Deal.RegistrarContr_b);
     LegRec.Start               = Deal.Start_b;
     LegRec.Formula             = CodeFor(SP_GetTypeAccType(Deal.TypeCalc_b));
     LegRec.StartDiff           = Deal.StartDiff_b;
     LegRec.StartBase           = SP_GetNameAlgNumberAlg(Deal.PeriodTypeAvance_b);
     LegRec.Diff                = Deal.Diff_b;
     LegRec.Base                = SP_GetNameAlgNumberAlg(Deal.PeriodTypePay_b);
     LegRec.PrincipalDiff       = Deal.PrincipalDiff_b;
     LegRec.PrincipalBase       = SP_GetNameAlgNumberAlg(Deal.PeriodTypeState_b);
     LegRec.DepositID           = SP_GetPartyID(Deal.Depositary_b);

     LegRec.IncomeRate          = Deal.IncomeRate_b;
     LegRec.ReturnIncome        = Deal.ReturnIncome_b;
     if( Deal.BofficeKind == DL_CONVAVR )
        LegRec.CFI              = SP_GetFIID(Deal.Crnc_b);
        LegRec.PFI              = SP_GetFIID(Deal.Iss_b);
        LegRec.Principal        = Deal.Principal_b;
     end;
  end;

  LegRec.DealID              = Deal.DealID;

  if( Deal.BofficeKind != DL_CONVAVR )
     LegRec.Principal           = Deal.Principal;
     LegRec.PFI                 = SP_GetFIID(Deal.Iss);
     LegRec.CFI              = SP_GetFIID(Deal.Crnc);
  end;
  LegRec.Point               = Deal.Point;
  if( not Deal.IsLoan )
     LegRec.PayFIID          = SP_GetFIID(Deal.CrncPay);
  else
     LegRec.PayFIID          = SP_GetFIID(Deal.CrncPayPC);
  end;

  if( Deal.IsTwoPart )
     LegRec.IncomePoint      = Deal.Point;
     LegRec.Basis            = SP_GetNameAlgNumberAlg(Deal.BasisCalc);
  end;
end;

macro SetCom_ByCScComiss( ComRec, Comiss )
  ComRec.ID            = Comiss.ID;
  ComRec.DocKind       = Comiss.DocKind;
  ComRec.DocID         = Comiss.DocID;
  ComRec.FeeType       = Comiss.FeeType;
  ComRec.ComNumber     = Comiss.ComNumber;
  ComRec.Contract      = SP_GetContrID(Comiss.Contr);
  ComRec.Sum           = Comiss.Sum;
  ComRec.NDS           = Comiss.NDS;
  ComRec.Date          = Comiss.Date;
  ComRec.PlanPayDate   = Comiss.PlanPayDate;
  ComRec.FactPayDate   = Comiss.FactPayDate;
  ComRec.InputMedium   = Comiss.InputMedium;
  ComRec.Immaterial    = IIF(Comiss.Immaterial, SET_CHR, UNSET_CHR);
  ComRec.IsBack        = IIF(Comiss.IsBack, SET_CHR, UNSET_CHR);
  ComRec.Version       = Comiss.Version;
end;

macro SetRQ_ByCScRQ( RQRec, RQ )
  RQRec.ID             = RQ.ID;
  RQRec.DocID          = RQ.DocID;
  RQRec.DocKind        = RQ.DocKind;
  RQRec.Kind           = SP_GetNameAlgNumberAlg(RQ.Kind);
  RQRec.SubKind        = SP_GetNameAlgNumberAlg(RQ.SubKind);
  RQRec.Type           = SP_GetNameAlgNumberAlg(RQ.Type);
  RQRec.Amount         = RQ.Amount;
  RQRec.FIID           = SP_GetFIID(RQ.FI);
  RQRec.Party          = SP_GetPartyID(RQ.Party);
  RQRec.PlaceID        = SP_GetPartyID(RQ.Place);
  RQRec.State          = SP_GetNameAlgNumberAlg(RQ.State);
  RQRec.PlanDate       = RQ.PlanDate;
  RQRec.FactDate       = RQ.FactDate;
  RQRec.UseNetting     = IIF(RQ.UseNetting, SET_CHR, UNSET_CHR);
  RQRec.Netting        = IIF(RQ.Netting, SET_CHR, UNSET_CHR);
  RQRec.Cliring        = IIF(RQ.Cliring, SET_CHR, UNSET_CHR);
  RQRec.DealPart       = SP_GetNameAlgNumberAlg(RQ.DealPart);
  RQRec.RqAccID        = RQ.RQAcc.ID;
  RQRec.Num            = RQ.Num;
  RQRec.SourceObjKind  = RQ.SourceObjKind;
  RQRec.SourceObjID    = RQ.SourceObjID;
  RQRec.ChangeDate     = RQ.ChangeDate;
  RQRec.Action         = RQ.RQAction;
  RQRec.Version        = RQ.Version;
end;

macro SetRQAcc_ByCScRQAcc( RQAccRec, RQAcc )
  RQAccRec.ID            = RQAcc.ID;
  RQAccRec.DocKind       = RQAcc.DocKind;
  RQAccRec.DocID         = RQAcc.DocID;
  RQAccRec.SubKind       = RQAcc.SubKind;
  RQAccRec.Type          = RQAcc.Type;
  RQAccRec.Party         = RQAcc.Party;
  RQAccRec.FIID          = RQAcc.FIID;
  RQAccRec.BankID        = RQAcc.BankID;
  RQAccRec.Chapter       = RQAcc.Chapter;
  RQAccRec.Account       = RQAcc.Account;
  RQAccRec.BankCodeKind  = RQAcc.BankCodeKind;
  RQAccRec.BankCode      = RQAcc.BankCode;
  RQAccRec.BankName      = RQAcc.BankName;
  RQAccRec.BankCorrID    = RQAcc.BankCorrID;
  RQAccRec.BankCorrCode  = RQAcc.BankCorrCode;
  RQAccRec.BankCorrName  = RQAcc.BankCorrName;
  RQAccRec.CorrAcc       = RQAcc.CorrAcc;
  RQAccRec.Version       = RQAcc.Version;
end;

macro FillTickEnsRecUsingCScEnsure(
 TickEnsRec
,Ensure
)
  TickEnsRec.ID = Ensure.ID;
  TickEnsRec.DealID = Ensure.DealID;
  TickEnsRec.FIID = SP_GetFIID( Ensure.FI );
  TickEnsRec.Date = Ensure.Date;
  TickEnsRec.Kind = Ensure.Kind;
  TickEnsRec.Principal = Ensure.Principal;
  TickEnsRec.TotalCost = Ensure.TotalCost;
  TickEnsRec.CostFIID = SP_GetFIID( Ensure.CostFI );
  TickEnsRec.NKD = Ensure.NKD;
  TickEnsRec.Version = Ensure.Version;
end;

// Получить все значения классификатора ClsNum
PRIVATE MACRO GetLLClassValues( Classificator:INTEGER, Values:TArray )
  VAR NextRec, ClsVal = TBFile("llclsval.dbt", "R", 0 );

  Values.Size = 0;
  ClsVal.rec.Classificator = Classificator;
  NextRec = ClsVal.GetGE();
  while( NextRec AND (ClsVal.rec.Classificator == Classificator) )
     Values[Values.Size] = ClsVal.rec.Element;
     NextRec = ClsVal.Next();
  end;
END;

PRIVATE MACRO GetLLClassForPortfolio( Deal_, Group_ ):INTEGER
   var classificator = -1;

   record  FI_( "fininstr.dbt" );
   var fiid_ = ALLFININSTR;
   if ( SP_GetFIID(Deal_.Iss) > 0)
      fiid_ = Deal_.Iss.Fiid;
   end;

   if( Deal_.BofficeKind == DL_TRUSTAVRWRT )
      classificator = 1710; // LLCLASS_PORT_TRUSTAVRWRT
   elif( Deal_.BofficeKind == DL_INVESTSHARE )
      classificator = 1643; // LLCLASS_PORTBUY_INVST
   elif( IsAVRWRTIN(Group_) OR IsAVRWRTOUT(Group_) )
      classificator = 1709; // LLCLASS_PORT_AVRWRT
      if( (Deal_.IssKind != null) and (Deal_.IssKind.RootAvrKinds != null) and (Deal_.IssKind.RootAvrKinds == AVOIRISSKIND_KSU) )
         classificator = 1828; // LLCLASS_PORT_KSU
      end;
   else
      classificator = 1642; // LLCLASS_PORTBUY_SHARE
   end;

   if ( not ПолучитьФинИн(fiid_, FI_))
      if( Deal_.BofficeKind == DL_TRUSTAVRWRT )
         classificator = 1710; // LLCLASS_PORT_TRUSTAVRWRT
      elif( Deal_.BofficeKind == DL_INVESTSHARE )
         classificator = 1643; // LLCLASS_PORTBUY_INVST
      elif( IsCONVERT_SHARE(Group_) OR IsCONVERT_RECEIPT(Group_) )
         classificator = 1642; // LLCLASS_PORTBUY_SHARE
      elif( IsBUY(Group_) )
         if( FI_IsShare(FI_, true) )
            classificator = 1642; // LLCLASS_PORTBUY_SHARE
         elif( FI_IsBond(FI_) )
            classificator = 1644; // LLCLASS_PORTBUY_BOND
         else
            classificator = 1643; // LLCLASS_PORTBUY_INVST
         end;
      elif( IsAVRWRTIN(Group_) OR IsAVRWRTOUT(Group_) )
         classificator = 1709; // LLCLASS_PORT_AVRWRT
         if( FI_IsKSU(fiid_) )
            classificator = 1828; // LLCLASS_PORT_KSU
         end;
      else
         if( FI_IsShare(FI_, true) )
            classificator = 1645; // LLCLASS_PORTSALE_SHARE
         elif( FI_IsBond(FI_) )
            classificator = 1647; // LLCLASS_PORTSALE_BOND
         else
            classificator = 1646; // LLCLASS_PORTSALE_INVST
         end;
      end;
   end;

   return classificator;
END;

macro ExistNOSSForPortfolio( FIID:INTEGER, DealDate:DATE ):BOOL
   var NumInList = "", ValidFromDate = ZeroDate;

   return (
      (GetMainObjAttr( null, OBJTYPE_AVOIRISS, L_Z( FIID, 10 ), 27, null, null, NumInList, DealDate, ValidFromDate) == true)
      AND (ValidFromDate <= DealDate)
      AND (NumInList == "1")
   );
end;

MACRO GetListForPortfolio(  Deal_, List_ )
   // получаем группу, в которую входит сделка данного вида
   var Group_ = SP_GetOperationGroup(Deal_);
   var whereCond_:string = " AND t_element IN (";

   if( Deal_.BofficeKind == DL_CONVAVR )
      whereCond_ = whereCond_ + "0,1,2,3";
   else
      var DealDate_:Date = IIF(Deal_.DealDate != ZeroDate, Deal_.DealDate, ZeroDate);
      var LLClass_, PortfolioL = TArray();
      LLClass_ = GetLLClassForPortfolio(Deal_, Group_);
      GetLLClassValues( LLClass_, PortfolioL );
      var i:integer = 0;
      while( i < PortfolioL.Size )
         if ((not (IsAVRWRTIN(Group_) OR IsAVRWRTOUT(Group_)))
         and ((PortfolioL[i] == 10) or (PortfolioL[i] == 11)) )
            i = i + 1;
            continue;
         end;
         whereCond_ = whereCond_ + IIF(i == 0, "", ",") + string(PortfolioL[i]);
         i = i + 1;
      end;
   end;

   if (whereCond_ != " AND t_element IN (")
      whereCond_ = whereCond_ + ")  ORDER BY t_element;";
   else
      whereCond_ = "";
   end;

   if(List_ <= 0)
     RunError("Не задан вид справочника");
   end;

   var query = "select * from dllvalues_dbt where t_List = " + string(List_) + whereCond_;

   var ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
   var result = TArray();
   var p;
   while (ds.MoveNext())
      p = TWsLlvalues(ds.Element, ds.Code, ds.Name, List_);

      result.value(result.Size) = p;
   end;

   return result;
END;

macro CorrectIfEmptyPortfolio( Portfolio:@TWsLlvalues )
  if( (Portfolio == null)
  or ( (Portfolio != null)
  and ((Portfolio.Element == null) or (Portfolio.Element == 0))
  and ((Portfolio.List == null) or (Portfolio.List == 0))
  and ((Portfolio.Code == null) or (Portfolio.Code == ""))
  and ((Portfolio.Name == null) or (Portfolio.Name == ""))) )
     Portfolio = TWsLlvalues(-2, "", "", -2);
  end;
end;

// Функции заполнения классов RSL из записей таблиц

macro SetCScDeal_ByBOKO( BofficeKind, DealType, Oper, Deal )
  var query = "", cmd = null, ds = null;

  query = " SELECT "
            + " (SELECT person.t_Name FROM dperson_dbt person WHERE person.t_oper = ?) AS t_OperName "
           + " ,rsb_secur.GetDealTypeName(?) AS t_TypeCode "
           + " ,rsb_secur.IsExchange(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsExchange "
           + " ,rsb_secur.IsOutExchange(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsOutExchange "
           + " ,rsb_secur.IsBroker(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsBroker "
           + " ,rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsRepo "
           + " ,rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsBasket "
           + " ,rsb_secur.IsDealKSU(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsKsu "
           + " ,rsb_secur.IsInterDealerRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsInterDealerRepo "
           + " ,rsb_secur.IsLoan(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsLoan "
           + " ,rsb_secur.IsConvShare(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsConvShare "
           + " ,rsb_secur.IsConvReceipt(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsConvReceipt "
           + " ,rsb_secur.IsAvrWrtIn(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsAvrWrtIn "
           + " ,rsb_secur.IsSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsSALE "
           + " ,rsb_secur.IsRet_Coupon(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsRet_Coupon "
           + " ,rsb_secur.IsRet_Partly(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsRet_Partly "
           + " ,rsb_secur.IsRet_Issue(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsRet_Issue "
           + " ,rsb_secur.IsToday(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(?, ?))) AS t_IsToday "
        + " FROM "
            + " dual ";

  cmd = RSDCommand( query );
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, Oper );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.addParam( "", RSDBP_IN, DealType );
  cmd.addParam( "", RSDBP_IN, BofficeKind );
  cmd.execute();

  ds = TRsbDataSet( cmd, RSDVAL_CLIENT, RSDVAL_STATIC );
  if( ds.MoveNext() )
     Deal.OperName          = SQL_ConvTypeStr( ds.OperName );
     Deal.TypeCode          = SQL_ConvTypeStr( ds.TypeCode );
     Deal.IsExchange        = ( SQL_ConvTypeInteger( ds.IsExchange ) == 1 );
     Deal.IsOutExchange     = ( SQL_ConvTypeInteger( ds.IsOutExchange ) == 1 );
     Deal.IsBroker          = ( SQL_ConvTypeInteger( ds.IsBroker ) == 1 );
     Deal.IsRepo            = ( SQL_ConvTypeInteger( ds.IsRepo ) == 1 );
     Deal.IsBasket          = ( SQL_ConvTypeInteger( ds.IsBasket ) == 1 );
     Deal.IsKsu             = ( SQL_ConvTypeInteger( ds.IsKsu ) == 1 );
     Deal.IsInterDealerRepo = ( SQL_ConvTypeInteger( ds.IsInterDealerRepo ) == 1 );
     Deal.IsLoan            = ( SQL_ConvTypeInteger( ds.IsLoan ) == 1 );
     Deal.IsConvShare       = ( SQL_ConvTypeInteger( ds.IsConvShare ) == 1 );
     Deal.IsConvReceipt     = ( SQL_ConvTypeInteger( ds.IsConvReceipt ) == 1 );
     Deal.IsAvrWrtIn        = ( SQL_ConvTypeInteger( ds.IsAvrWrtIn ) == 1 );
     Deal.IsSALE            = ( SQL_ConvTypeInteger( ds.IsSALE ) == 1 );
     Deal.IsRet_Coupon      = ( SQL_ConvTypeInteger( ds.IsRet_Coupon ) == 1 );
     Deal.IsRet_Partly      = ( SQL_ConvTypeInteger( ds.IsRet_Partly ) == 1 );
     Deal.IsRet_Issue       = ( SQL_ConvTypeInteger( ds.IsRet_Issue ) == 1 );
     Deal.IsToday           = ( SQL_ConvTypeInteger( ds.IsToday ) == 1 );
     Deal.IsTwoPart         = ( Deal.IsRepo or Deal.IsLoan )
  end;
end;

macro SetCScDeal_ByTick( TickRec, Deal )
  Deal.DealID           = TickRec.DealID;
  Deal.DealCode         = TickRec.DealCode;
  Deal.DealDate         = TickRec.DealDate;
  Deal.DealTime         = TickRec.DealTime;
  Deal.IsNetting        = IIF(TickRec.IsNetting == SET_CHAR, true, false);
  Deal.DealCodeTS       = TickRec.DealCodeTS;
  Deal.DealCountry      = CreateCountryFromAppServ(TickRec.Country);
  Deal.TypeDoc          = CreateTypeAcFromAppServ(154/*TA_TYPE_DEAL*/, TickRec.TypeDoc);
  Deal.TypeDocList      = GetListTypeAc(154/*TA_TYPE_DEAL*/);
  Deal.Flag1            = IIF(TickRec.Flag1 == SET_CHAR, true, false);
  Deal.PeriodType       = CreateNameAlgFromAppServ(3123, IIF(TickRec.Flag3 == SET_CHAR, 1, 0));
  Deal.Flag4            = IIF(TickRec.Flag4 == SET_CHAR, true, false);
  Deal.Flag5            = IIF(TickRec.Flag5 == SET_CHAR, true, false);
  Deal.ReturnIncomeType = CreateNameAlgFromAppServ(3142, TickRec.ReturnIncomeKind );
  Deal.IsPartyClient    = IIF(TickRec.IsPartyClient == SET_CHAR, true, false);
  Deal.Trader           = GetTWsPartyExByID(TickRec.MarketID);
  Deal.MarketSchem      = ScGetMarketByID(TickRec.MarketSchemeID);
  Deal.DepoSchem        = ScGetDepSetByID(TickRec.DepSetID);
  Deal.FixSum           = CreateNameAlgFromAppServ(3126, TickRec.FixSum);
  Deal.PreOutlay        = TickRec.PreOutlay;
  Deal.CrncPreOutlay    = GetTWsFinInstrByID(TickRec.PreOutlayFIID, CODE_Ccy);
  Deal.Portfolio        = CreateLLValueFromAppServ(1100, TickRec.PortfolioID);   CorrectIfEmptyPortfolio(@Deal.Portfolio);
  Deal.Portfolio_2      = CreateLLValueFromAppServ(1100, TickRec.PortfolioID_2); CorrectIfEmptyPortfolio(@Deal.Portfolio_2);
  Deal.Client           = GetTWsPartyExByID(TickRec.ClientID);
  Deal.ClientContr      = GetTWsSfContrByID(TickRec.ClientContrID);
  Deal.Broker           = GetTWsPartyExByID(TickRec.BrokerID);
  Deal.BrokerContr      = GetTWsSfContrByID(TickRec.BrokerContrID);
  Deal.Party            = GetTWsPartyExByID(TickRec.PartyID);
  Deal.PartyContr       = GetTWsSfContrByID(TickRec.PartyID);
  Deal.Department       = GetTWsDepartmentByCode(TickRec.Department);
  Deal.Oper             = TickRec.Oper;
  Deal.DealType         = TickRec.DealType;
  Deal.BofficeKind      = TickRec.BofficeKind;
  Deal.DealStatus       = TickRec.DealStatus;
  Deal.ChangeDate       = TickRec.ChangeDate;
  Deal.TraderID         = TickRec.TraderID;
  Deal.MarketOfficeID   = TickRec.MarketOfficeID;
  Deal.OriginID         = TickRec.OriginID;
  Deal.DealVersion      = TickRec.Version;
  Deal.Blocked          = (TickRec.Blocked == SET_CHAR);
  Deal.Flag5            = (TickRec.Flag5 == SET_CHAR);
  Deal.ReturnIncomeType = CreateNameAlgFromAppServ(3142, TickRec.ReturnIncomeKind);
  if( ( TickRec.CommDate == null ) or ( TickRec.CommDate == ZeroDate ) )
    Deal.CommDate       = {curdate};
  else
    Deal.CommDate       = TickRec.CommDate;
  end;
  Deal.CloseDate        = TickRec.CloseDate;

  SetCScDeal_ByBOKO( TickRec.BofficeKind, TickRec.DealType, TickRec.Oper, Deal );
end;

macro SetCScDeal_ByLeg( LegRec, Part, Deal )
  if( Part == 1 )
    Deal.Leg_ID             = LegRec.ID;
    Deal.SupplyTime         = LegRec.SupplyTime;
    Deal.LegVersion         = LegRec.Version;
    Deal.OperState          = LegRec.OperState;
    Deal.RelativePrice      = ( LegRec.RelativePrice == SET_CHR );
    Deal.NKD                = LegRec.NKD;
    Deal.TotalCost          = LegRec.TotalCost;
    Deal.Price              = LegRec.Price;
    Deal.Cost               = LegRec.Cost;
    Deal.RejectDate         = LegRec.RejectDate;
    Deal.IncomeRate         = LegRec.IncomeRate;
    Deal.ReturnIncome       = LegRec.ReturnIncome;
    Deal.DeliverIss         = GetTWsFinInstrByID( LegRec.DeliveringFIID, CODE_Ccy );
    Deal.Nom                = GetTWsFinInstrByID( LegRec.NKDFIID, CODE_Ccy );
    Deal.BaseDate           = IIF( LegRec.MaturityIsPrincipal == SET_CHR, LegRec.Maturity, LegRec.Expiry );
    Deal.ContrDate          = IIF( LegRec.MaturityIsPrincipal == SET_CHR, LegRec.Expiry, LegRec.Maturity );
    Deal.CliringDate        = LegRec.CliringDate;
    Deal.CliringTime        = LegRec.CliringTime;
    Deal.CliringSession     = CreateNameAlgFromAppServ( 3157 /*ALG_SP_CLIRINGSESSION*/, LegRec.Session );
    Deal.CliringChange      = ( LegRec.CliringChange == SET_CHR );
    Deal.PayRegTax          = ( LegRec.PayRegTax == SET_CHR );
    Deal.Registrar          = GetTWsPartyExByID( LegRec.Registrar );
    Deal.RegistrarContr     = GetTWsSfContrByID( LegRec.RegistrarContrID );
    Deal.Start              = LegRec.Start;
    Deal.TypeCalc           = CreateTypeAcFromAppServ( 155/*TA_TYPE_CALC*/, StrFor( LegRec.Formula ) );
    Deal.StartDiff          = LegRec.StartDiff;
    Deal.PeriodTypeAvance   = CreateNameAlgFromAppServ( ALG_SP_WEB_KIND_TYPEPERIOD, LegRec.StartBase );
    Deal.Diff               = LegRec.Diff;
    Deal.PeriodTypePay      = CreateNameAlgFromAppServ( ALG_SP_WEB_KIND_TYPEPERIOD, LegRec.Base );
    Deal.PrincipalDiff      = LegRec.PrincipalDiff;
    Deal.PeriodTypeState    = CreateNameAlgFromAppServ( ALG_SP_WEB_KIND_TYPEPERIOD, LegRec.PrincipalBase );
    Deal.Depositary         = GetTWsPartyExByID( LegRec.DepositID );
    Deal.LegVersion         = LegRec.Version;

    if( Deal.BofficeKind == DL_RETIREMENT )
      Deal.Maturity         = LegRec.Maturity;
    end;

    if( Deal.BofficeKind != DL_CONVAVR )
      Deal.Principal        = LegRec.Principal;
      Deal.Iss              = GetTWsFinInstrByID( LegRec.PFI );
      Deal.Crnc             = GetTWsFinInstrByID( LegRec.CFI );
    end;

    Deal.Point              = LegRec.Point;

    Deal.CrncPay            = GetTWsFinInstrByID( LegRec.PayFIID );
  else
    Deal.Leg_ID_b           = LegRec.ID;
    Deal.SupplyTime_b       = LegRec.SupplyTime;
    Deal.LegVersion_b       = LegRec.Version;
    Deal.OperState_b        = LegRec.OperState;
    Deal.RelativePrice_b    = ( LegRec.RelativePrice == SET_CHR );
    Deal.NKD_b              = LegRec.NKD;
    Deal.TotalCost_b        = LegRec.TotalCost;
    Deal.Price_b            = LegRec.Price;
    Deal.Cost_b             = LegRec.Cost;
    Deal.RejectDate_b       = LegRec.RejectDate;
    Deal.IncomeRate_b       = LegRec.IncomeRate;
    Deal.ReturnIncome_b     = LegRec.ReturnIncome;
    Deal.DeliverIss_b       = GetTWsFinInstrByID( LegRec.DeliveringFIID, CODE_Ccy );
    Deal.Nom_b              = GetTWsFinInstrByID( LegRec.NKDFIID, CODE_Ccy );
    Deal.BaseDate_b         = IIF( LegRec.MaturityIsPrincipal == SET_CHR, LegRec.Maturity, LegRec.Expiry );
    Deal.ContrDate_b        = IIF( LegRec.MaturityIsPrincipal == SET_CHR, LegRec.Expiry, LegRec.Maturity );
    Deal.CliringDate_b      = LegRec.CliringDate;
    Deal.CliringTime_b      = LegRec.CliringTime;
    Deal.CliringSession_b   = CreateNameAlgFromAppServ( 3157 /*ALG_SP_CLIRINGSESSION*/, LegRec.Session );
    Deal.CliringChange_b    = ( LegRec.CliringChange == SET_CHR );
    Deal.PayRegTax_b        = ( LegRec.PayRegTax == SET_CHR );
    Deal.Registrar_b        = GetTWsPartyExByID( LegRec.Registrar );
    Deal.RegistrarContr_b   = GetTWsSfContrByID( LegRec.RegistrarContrID );
    Deal.Start_b            = LegRec.Start;
    Deal.TypeCalc_b         = CreateTypeAcFromAppServ( 155/*TA_TYPE_CALC*/, StrFor( LegRec.Formula ) );
    Deal.StartDiff_b        = LegRec.StartDiff;
    Deal.PeriodTypeAvance_b = CreateNameAlgFromAppServ( ALG_SP_WEB_KIND_TYPEPERIOD, LegRec.StartBase );
    Deal.Diff_b             = LegRec.Diff;
    Deal.PeriodTypePay_b    = CreateNameAlgFromAppServ( ALG_SP_WEB_KIND_TYPEPERIOD, LegRec.Base );
    Deal.PrincipalDiff_b    = LegRec.PrincipalDiff;
    Deal.PeriodTypeState_b  = CreateNameAlgFromAppServ( ALG_SP_WEB_KIND_TYPEPERIOD, LegRec.PrincipalBase );
    Deal.Depositary_b       = GetTWsPartyExByID( LegRec.DepositID );
    Deal.LegVersion_b       = LegRec.Version;

    if( Deal.BofficeKind != DL_CONVAVR )
      Deal.Principal_b    = LegRec.Principal;
      Deal.Iss_b          = GetTWsFinInstrByID( LegRec.PFI );
      Deal.Crnc_b         = GetTWsFinInstrByID( LegRec.CFI );
    end;

    Deal.Point           = LegRec.IncomePoint;
    Deal.BasisCalc       = CreateNameAlgFromAppServ( 3121, LegRec.Basis );

    if( Deal.IsLoan )
      Deal.CrncPayPC        = GetTWsFinInstrByID( LegRec.PayFIID );
    end;
  end;
end;

macro SetCScRQ_ByRQ( RQRec, RQ )
  RQ.ID                  = RQRec.ID;
  RQ.DocID               = RQRec.DocID;
  RQ.DocKind             = RQRec.DocKind;
  RQ.Kind                = CreateNameAlgFromAppServ(7511/*ALG_DLRQ_KIND*/, RQRec.Kind);
  RQ.KindEx              = CreateNameAlgFromAppServ(7516/*ALG_DLRQ_KIND_EX*/, RQRec.Kind);
  RQ.SubKind             = CreateNameAlgFromAppServ(7512/*ALG_DLRQ_SUBKIND*/, RQRec.SubKind);
  RQ.Type                = CreateNameAlgFromAppServ(7513/*ALG_DLRQ_TYPE*/, RQRec.Type);
  RQ.Amount              = RQRec.Amount;
  RQ.FI                  = GetTWsFinInstrByID(RQRec.FIID);
  RQ.Party               = GetTWsPartyExByID(RQRec.Party);
  RQ.Place               = GetTWsPartyExByID(RQRec.PlaceID);
  RQ.State               = CreateNameAlgFromAppServ(7514/*ALG_DLRQ_STATE*/, RQRec.State);
  RQ.PlanDate            = RQRec.PlanDate;
  RQ.FactDate            = RQRec.FactDate;
  RQ.UseNetting          = (RQRec.UseNetting == SET_CHR);
  RQ.Netting             = (RQRec.Netting == SET_CHR);
  RQ.Cliring             = (RQRec.Cliring == SET_CHR);
  RQ.DealPart            = CreateNameAlgFromAppServ(7518/*ALG_DLRQ_DEALPART*/, RQRec.DealPart);
  RQ.RQAcc               = GetScRQAcc(RQRec.RqAccID); /*???*/
  RQ.Num                 = RQRec.Num;
  RQ.SourceObjKind       = RQRec.SourceObjKind;
  RQ.SourceObjID         = RQRec.SourceObjID;
  RQ.ChangeDate          = RQRec.ChangeDate;
  RQ.RQAction            = RQRec.Action;
  RQ.Version             = RQRec.Version;
end;

// Функции для парсинга объектов С# -> RSL

macro SetRQAcc_ByRecordSharp( RQAcc, RQAccRecord )
  RQAcc.ID               = RQAccRecord.ID;
  RQAcc.DocKind          = RQAccRecord.DocKind;
  RQAcc.DocID            = RQAccRecord.DocID;
  RQAcc.SubKind          = RQAccRecord.SubKind;
  RQAcc.Type             = RQAccRecord.Type;
  RQAcc.TypeName         = RQAccRecord.TypeName;
  RQAcc.Party            = RQAccRecord.Party;
  RQAcc.PartyShortName   = RQAccRecord.PartyShortName;
  RQAcc.FIID             = RQAccRecord.FIID;
  RQAcc.FICode           = RQAccRecord.FICode;
  RQAcc.BankID           = RQAccRecord.BankID;
  RQAcc.Chapter          = RQAccRecord.Chapter;
  RQAcc.Account          = RQAccRecord.Account;
  RQAcc.BankName         = RQAccRecord.BankName;
  RQAcc.CorrAcc          = RQAccRecord.CorrAcc;
  RQAcc.BankCorrName     = RQAccRecord.BankCorrName;
  RQAcc.BankCodeKind     = RQAccRecord.BankCodeKind;
  RQAcc.BankCode         = RQAccRecord.BankCode;
  RQAcc.BankCorrID       = RQAccRecord.BankCorrID;
  RQAcc.BankCorrCodeKind = RQAccRecord.BankCorrCodeKind;
  RQAcc.BankCorrCode     = RQAccRecord.BankCorrCode;
  RQAcc.Action           = RQAccRecord.Action;
  RQAcc.Version          = RQAccRecord.Version;
end;

/*
// Пока не используются

macro SetComiss_ByRecordSharp( Comiss, ComissRecord )
  Comiss.ID           = ComissRecord.ID;
  Comiss.DocKind      = ComissRecord.DocKind;
  Comiss.DocID        = ComissRecord.DocID;
  Comiss.FeeType      = ComissRecord.FeeType;
  Comiss.ComNumber    = ComissRecord.ComNumber;
  Comiss.Payer        = ComissRecord.Payer;
  Comiss.Receiver     = ComissRecord.Receiver;
  Comiss.Contr        = ComissRecord.Contr;
  Comiss.Comission    = ComissRecord.Comission;
  Comiss.Sum          = ComissRecord.Sum;
  Comiss.NDS          = ComissRecord.NDS;
  Comiss.SummaNotNDS  = ComissRecord.SummaNotNDS;
  Comiss.FIID_Comm    = ComissRecord.FIID_Comm;
  Comiss.Date         = ComissRecord.Date;
  Comiss.PlanPayDate  = ComissRecord.PlanPayDate;
  Comiss.FactPayDate  = ComissRecord.FactPayDate;
  Comiss.InputMedium  = ComissRecord.InputMedium;
  Comiss.Immaterial   = ComissRecord.Immaterial;
  Comiss.Action       = ComissRecord.Action;
  Comiss.TypeNDS      = ComissRecord.TypeNDS;
  Comiss.Version      = ComissRecord.Version;
end;

macro SetRQ_ByRecordSharp( RQ, RQRecord )
  RQ.ID             = RQRecord.ID;
  RQ.Kind           = RQRecord.Kind;
  RQ.SubKind        = RQRecord.SubKind;
  RQ.Type           = RQRecord.Type;
  RQ.Amount         = RQRecord.Amount;
  RQ.FI             = RQRecord.FI;
  RQ.Party          = RQRecord.Party;
  RQ.Place          = RQRecord.Place;
  RQ.State          = RQRecord.State;
  RQ.PlanDate       = RQRecord.PlanDate;
  RQ.FactDate       = RQRecord.FactDate;
  RQ.UseNetting     = RQRecord.UseNetting;
  RQ.Netting        = RQRecord.Netting;
  RQ.Cliring        = RQRecord.Cliring;
  RQ.DocKindName    = RQRecord.DocKindName;
  RQ.DocID          = RQRecord.DocID;
  RQ.DealPart       = RQRecord.DealPart;
  RQ.RQAcc          = RQRecord.RQAcc;
  RQ.Num            = RQRecord.Num;
  RQ.DocKind        = RQRecord.DocKind;
  RQ.DocID          = RQRecord.DocID;
  RQ.SourceObjKind  = RQRecord.SourceObjKind;
  RQ.SourceObjID    = RQRecord.SourceObjID;
  RQ.ChangeDate     = RQRecord.ChangeDate;
  RQ.RQAction       = RQRecord.RQAction;
  RQ.Action         = RQRecord.Action;
  RQ.Version        = RQRecord.Version;
end;
*/
