/**
  @file nptxpit6_new_det_2023.mac
  @brief Макрос формирования отчета 6-НДФЛ с расшифровками c 2023-го года

  #menu
  - БО ЦБ\Отчеты\Отчеты для НДФЛ\6-НДФЛ\Форма 6-НДФЛ 2023 г.

  #tag
  - 6-НДФЛ
  - 6-НДФЛ с расшифровками

  #changeLog
*/

Import DPInter, SFInter, "DLReport_h.mac", "nptxpit6_new_det_2024_form.mac", "RepPersonalIncomeTax.mac", "nptxcalcfun.mac", "TaxReportBase.mac", likepy, "scsrvrepfun.mac", "nptxslice.mac";

CONST NPTXPIT6NEW_REPORTKIND = 20142;
PRIVATE CONST POI_MODE = true;
PRIVATE CONST POI_SIZE_PACK = 100;

private const ReturnsOnPage = 16;

private var Form;

private var SheetsNamesNPTX2 = TArray();
private var SheetsNamesAttach2 = TArray();
private var ItogSym;

//Получить имя папки файлов отчета
PRIVATE MACRO GetSaveRepPath()
  var RegistryPath = "РСХБ\\ДИРЕКТОРИИ\\OUT\\6-НДФЛ";
  var Path = "";
  var stat = 0;
 
  GetRegistryValue(RegistryPath, V_STRING, Path, stat);
  if((stat) or (Path == "")) 
    msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
  else
    if(substr(Path, strlen(Path), 1) != "\\")
      Path = Path + "\\";
    end;

    if((not IsStandAlone()) and (substr(Path, 1, 1) != "$"))
      Path  = "$" + Path;
    end;
  end;

  return Path;
END;

private class ByClientNumerator()

   private var KeyPairStore = TArray();
   private var CodeGen = DL_CodeGenerator(1);

   macro GetNexNumbByClientId(ClientId)
     var idx = DL_FindKeyPairInArr(KeyPairStore,ClientId);
     if (idx >= 0)
       return KeyPairStore[idx].Value;
     end;
     var nextCode = CodeGen.GetNextValInt();
     KeyPairStore[KeyPairStore.size] = DL_KeyPair(ClientId,nextCode);
     return nextCode;
   end;

end;

PRIVATE MACRO RemoveFromArrByIdx(arr:@TArray, idx)
   var i = idx;
   while(i < arr.Size - 1)
      arr[i] = arr[i + 1];
      i = i + 1;
   end;
   arr.Size = arr.Size - 1;
end;

private class OldIdx(_Idx, _SubIdx)
  var Idx = _Idx;
  var SubIdx = _SubIdx;
end;

private class CollapseStruct(_Idx, _Code, _Sum, _SubIdx)
  var Idx = _Idx;
  var Code = _Code;
  var SubIdx = _SubIdx;
  var Sum = _Sum;
  var IsMinus = ValType(_SubIdx) != V_UNDEF;
end;

macro MinusCodeSort(left:Variant, right:Variant, data:Variant)

end;

macro SortBySum(left:Variant, right:Variant, data:Variant)
  return IIF(left.Sum > right.Sum, -1, (IIF(left.Sum < right.Sum, 1, 0)));
end;

private class MinusMoveStruct(_PlusSum, _PlusCode, _Idx, _MinusCodes)
  var PlusSum = _PlusSum;
  var PlusCode = _PlusCode;
  var Idx = _Idx;
  var MinusCodes = TArray ();
  var i = -1;
  while ((i = i + 1) < _MinusCodes.size)
    if (_MinusCodes[i] and _MinusCodes[i].IsShow)
      MinusCodes[MinusCodes.size] = CollapseStruct(_Idx, _MinusCodes[i].MSCode, _MinusCodes[i].MSnnn, i);
    end;
  end;

  macro SortMinus()
    MinusCodes.sort(@SortBySum);
  end;

  macro GetMinus()
    var MSnnn = $0;
    var j = -1;
    while((j=j+1) < MinusCodes.Size)
      MSnnn = MSnnn + MinusCodes[j].Sum;
    end;
    return MSnnn;
  end;

  macro GetOD()
    return PlusSum - GetMinus();
  end;

  SortMinus();
end;

private class OverMinus(_Month, _Code)
  var Month = _Month;
  var MCode = _Code;
end;

macro CheckForPosCollapseStruct(struct)
  return (struct != NULL) and (struct.Sum > $0);
end;

macro MakeSortedPLusByCodeAndSum(NPTXCodeParmArr, Code)
  var i = -1;
  var retArr = TArray();
  while ((i=i+1) < NPTXCodeParmArr.Size)
    if ((NPTXCodeParmArr[i].PSCode != NULL) and (NPTXCodeParmArr[i].PSCode == Code))
      retArr[retArr.size] = CollapseStruct(i, Code, NPTXCodeParmArr[i].PSnnn);
    end;
  end;
  retArr.Sort(@SortBySum);
  return filter(retArr, @CheckForPosCollapseStruct);
end;

macro MakeSortedMinusByCodeAndSum(NPTXCodeParmArr, Code)
  var i = -1, j = -1;
  var retArr = TArray();
  while ((i=i+1) < NPTXCodeParmArr.Size)
    j = -1;
    while ((j=j+1) < NPTXCodeParmArr[i].MinusCodes.Size)
      if ((NPTXCodeParmArr[i].MinusCodes[j] != NULL) and (NPTXCodeParmArr[i].MinusCodes[j].MSCode != NULL) and (NPTXCodeParmArr[i].MinusCodes[j].MSCode == Code))
        retArr[retArr.size] = CollapseStruct(i, Code, NPTXCodeParmArr[i].MinusCodes[j].MSnnn, j);
      end;
    end;
  end;
  retArr.Sort(@SortBySum);
  return filter(retArr, @CheckForPosCollapseStruct);
end;

macro MakeSortedCodesByNobkind(NPTXCodeParmArr, NOBKind)
  var i = -1;
  var retArr = TArray();
  i = NPTXCodeParmArr.Size;
  while ((i=i-1) >= 0)
    if ((NPTXCodeParmArr[i].NOBKind != NULL) and (NPTXCodeParmArr[i].NOBKind == NOBKind))
      retArr[retArr.size] = CollapseStruct(i, NPTXCodeParmArr[i].PSCode, 0);
    end;
  end;
  return retArr;
end;

macro MakeCopyNPTXCodeParmArr(NPTXCodeParmArr)
  var copyArr = TArray();
  //делаем полную копию NPTXCodeParmArr по значениям
  var i = -1;
  var j = -1;
  while ((i=i+1) < NPTXCodeParmArr.Size)
    copyArr[i] = NPTXPlusCodeParm(
       NPTXCodeParmArr[i].Month,
       NPTXCodeParmArr[i].PSCode,
       NPTXCodeParmArr[i].PSnnn,
       NPTXCodeParmArr[i].ЧНБ,
       NPTXCodeParmArr[i].NOBKind,
       NULL,
       NPTXCodeParmArr[i].IsShow);
    if (NPTXCodeParmArr[i].MinusCodes != NULL)
      j = -1;
      while ((j=j+1) < NPTXCodeParmArr[i].MinusCodes.size)
        copyArr[i].MinusCodes[j] = 
        NPTXMinusCodeParm(
           NPTXCodeParmArr[i].MinusCodes[j].MSCode,
           NPTXCodeParmArr[i].MinusCodes[j].MSnnn,
           NPTXCodeParmArr[i].MinusCodes[j].IsShow);
      end;
    end;
  end;
  return copyArr;
end;

macro GetCurrNameNPTX2(Name1:string, Name2:string, Name3:string)
   var Name = substr(Name1, 1, 20) + substr(Name2, 1, 1) + substr(Name3, 1, 1);
   var NameSheet = "";
   var CntEqualNamesNPTX2 = 0;

   NameSheet = Name;
   var i = 0;
   while(i < SheetsNamesNPTX2.Size)
      if(StrUpr(NameSheet) == StrUpr(SheetsNamesNPTX2[i]))
         CntEqualNamesNPTX2 = CntEqualNamesNPTX2 + 1;
         NameSheet = substr(Name, 1, 31 - StrLen(" " + string(CntEqualNamesNPTX2))) + " " + string(CntEqualNamesNPTX2);
         i = 0;
      else
         i = i + 1;
      end;
   end;

   SheetsNamesNPTX2[SheetsNamesNPTX2.Size] = NameSheet;

   return NameSheet;
end;

macro GetCurrNameAttach2(Name1:string, Name2:string, Name3:string)
   var Name = substr(Name1, 1, 20) + substr(Name2, 1, 1) + substr(Name3, 1, 1);
   var NameSheet = "";
   var CntEqualNamesAttach2 = 0;

   NameSheet = Name + " Приложение";
   var i = 0;
   while(i < SheetsNamesAttach2.Size)
      if(StrUpr(NameSheet) == StrUpr(SheetsNamesAttach2[i]))
         CntEqualNamesAttach2 = CntEqualNamesAttach2 + 1;
         NameSheet = substr(Name, 1, 31 - StrLen(" Приложение " + string(CntEqualNamesAttach2))) + " Приложение " + string(CntEqualNamesAttach2);
         i = 0;
      else
         i = i + 1;
      end;
   end;

   SheetsNamesAttach2[SheetsNamesAttach2.Size] = NameSheet;

   return NameSheet;
end;

private class TPart1KBKData(KBK:string, 
                            SumTotal:money, Sum021:money, Sum022:money, Sum023:money, Sum024:money, Sum025:money, Sum026:money,
                            SumRetTotal:money, SumRet021:money, SumRet022:money, SumRet023:money, SumRet024:money, SumRet025:money, SumRet026:money
                           )
  var m_KBK    = KBK;
  var m_SumTotal = SumTotal;
  var m_Sum021   = Sum021;
  var m_Sum022   = Sum022;
  var m_Sum023   = Sum023;
  var m_Sum024   = Sum024;
  var m_Sum025   = Sum025;
  var m_Sum026   = Sum026;
  var m_SumRetTotal = SumRetTotal;
  var m_SumRet021   = SumRet021;
  var m_SumRet022   = SumRet022;
  var m_SumRet023   = SumRet023;
  var m_SumRet024   = SumRet024;
  var m_SumRet025   = SumRet025;
  var m_SumRet026   = SumRet026;
end;

private class TPart1Collect()
  var m_KBKDataArr = TArray();

  private macro find(KBK:string)
    var i = 0;

    while(i < m_KBKDataArr.size)
      if(m_KBKDataArr[i].m_KBK == KBK)
        return i;
      end;

      i = i + 1;
    end;

    return -1;
  end;

  macro AddKBKPaid(KBK:string, SumTotal:money, Sum021:money, Sum022:money, Sum023:money, Sum024:money, Sum025:money, Sum026:money)
    var i = find(KBK);

    if(i == -1)
      m_KBKDataArr[m_KBKDataArr.size] = TPart1KBKData(KBK, SumTotal, Sum021, Sum022, Sum023, Sum024, Sum025, Sum026, $0, $0, $0, $0, $0, $0, $0);
    else
      m_KBKDataArr[i].m_SumTotal = SumTotal;
      m_KBKDataArr[i].m_Sum021   = Sum021;
      m_KBKDataArr[i].m_Sum022   = Sum022;
      m_KBKDataArr[i].m_Sum023   = Sum023;
      m_KBKDataArr[i].m_Sum024   = Sum024;
      m_KBKDataArr[i].m_Sum025   = Sum025;
      m_KBKDataArr[i].m_Sum026   = Sum026;
    end;
  end;

  macro AddKBKReturn(KBK:string, SumRetTotal:money, SumRet021:money, SumRet022:money, SumRet023:money, SumRet024:money, SumRet025:money, SumRet026:money)
    var i = find(KBK);

    if(i == -1)
      m_KBKDataArr[m_KBKDataArr.size] = TPart1KBKData(KBK, $0, $0, $0, $0, $0, $0, $0, SumRetTotal, SumRet021, SumRet022, SumRet023, SumRet024, SumRet025, SumRet026);
    else
      m_KBKDataArr[i].m_SumRetTotal = SumRetTotal;
      m_KBKDataArr[i].m_SumRet021   = SumRet021;
      m_KBKDataArr[i].m_SumRet022   = SumRet022;
      m_KBKDataArr[i].m_SumRet023   = SumRet023;
      m_KBKDataArr[i].m_SumRet024   = SumRet024;
      m_KBKDataArr[i].m_SumRet025   = SumRet025;
      m_KBKDataArr[i].m_SumRet026   = SumRet026;
    end;
  end;

  macro ExistsData()
    return m_KBKDataArr.size;
  end;
end;

private var BeginDate021 = Date(0, 0, 0);
private var EndDate021   = Date(0, 0, 0);
private var BeginDate022 = Date(0, 0, 0);
private var EndDate022   = Date(0, 0, 0);
private var BeginDate023 = Date(0, 0, 0);
private var EndDate023   = Date(0, 0, 0);
private var BeginDate024 = Date(0, 0, 0);
private var EndDate024   = Date(0, 0, 0);
private var BeginDate025 = Date(0, 0, 0);
private var EndDate025   = Date(0, 0, 0);
private var BeginDate026 = Date(0, 0, 0);
private var EndDate026   = Date(0, 0, 0);

private macro FillQDates(EndDate:date)
  var dayEnd, monthEnd, Year;

  DateSplit(EndDate, dayEnd, monthEnd, Year);

  if((dayEnd == 31) and (monthEnd == 3))
    BeginDate021 = date(1, 1, Year);  EndDate021 = date(22, 1, Year);
    BeginDate022 = date(23, 1, Year); EndDate022 = date(31, 1, Year);
    BeginDate023 = date(1, 2, Year);  EndDate023 = date(22, 2, Year);
    BeginDate024 = date(23, 2, Year); EndDate024 = date(1, 3, Year)-1;
    BeginDate025 = date(1, 3, Year);  EndDate025 = date(22, 3, Year);
    BeginDate026 = date(23, 3, Year); EndDate026 = date(31, 3, Year);
  elif((dayEnd == 30) and (monthEnd == 6))
    BeginDate021 = date(1, 4, Year);  EndDate021 = date(22, 4, Year);
    BeginDate022 = date(23, 4, Year); EndDate022 = date(30, 4, Year);
    BeginDate023 = date(1, 5, Year);  EndDate023 = date(22, 5, Year);
    BeginDate024 = date(23, 5, Year); EndDate024 = date(31, 5, Year);
    BeginDate025 = date(1, 6, Year);  EndDate025 = date(22, 6, Year);
    BeginDate026 = date(23, 6, Year); EndDate026 = date(30, 6, Year);
  elif((dayEnd == 30) and (monthEnd == 9))
    BeginDate021 = date(1, 7, Year);  EndDate021 = date(22, 7, Year);
    BeginDate022 = date(23, 7, Year); EndDate022 = date(31, 7, Year);
    BeginDate023 = date(1, 8, Year);  EndDate023 = date(22, 8, Year);
    BeginDate024 = date(23, 8, Year); EndDate024 = date(31, 8, Year);
    BeginDate025 = date(1, 9, Year);  EndDate025 = date(22, 9, Year);
    BeginDate026 = date(23, 9, Year); EndDate026 = date(30, 9, Year);
  elif((dayEnd == 31) and (monthEnd == 12))
    BeginDate021 = date(1, 10, Year); EndDate021 = date(22, 10, Year);
    BeginDate022 = date(23, 10, Year);EndDate022 = date(31, 10, Year);
    BeginDate023 = date(1, 11, Year); EndDate023 = date(22, 11, Year);
    BeginDate024 = date(23, 11, Year);EndDate024 = date(30, 11, Year);
    BeginDate025 = date(1, 12, Year); EndDate025 = date(22, 12, Year);
    BeginDate026 = date(23, 12, Year);EndDate026 = date(31, 12, Year);
  end;
end;

CLASS NPTXRepCalc_NPTXPIT6_NEW(_BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS, _IsSOFR, _IsDiasoft)
   private var m_BeginDate = _BeginDate;
   private var m_EndDate   = _EndDate;  
   private var m_ByCB      = _ByCB;     
   private var m_ByDepo    = _ByDepo;   
   private var m_ByVS      = _ByVS;     
   private var m_IsSOFR    = _IsSOFR;
   private var m_IsDiasoft = _IsDiasoft;

   var m_StatPart1 = false;

   var m_Part1Collect = TPart1Collect();

   private var lastWorkDay = NULL;
   private macro GetLastWorkDayYear(pDate):DATE
      var Year:Integer;
      var IsWorkDay = 0;
      var query = "";
      var cmd;
      var DataSet;

      if(lastWorkDay == NULL)
         DateSplit(pDate, NULL, NULL, Year);
         lastWorkDay = Date(31, 12, Year);

         while(IsWorkDay == 0)
            query = "select rsi_rsbcalendar.IsWorkDay(?) as t_IsWorkDay from dual";
            cmd = DL_RSDCommand(query);
            cmd.AddParam(lastWorkDay);
            DataSet = cmd.Execute();
            if(DataSet.MoveNext())
               IsWorkDay = DataSet.IsWorkDay;
               if(IsWorkDay != 0)
                  break;
               end;
            end;

            lastWorkDay = lastWorkDay - 1;
         end;
      end;

      return lastWorkDay;
   end;

   macro Calculate()
         
      var query, cmd, DataSet;
      var Year;
      var TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_ONB + ", " + NPTXTOTALBASE_TAXBASEKIND_BROK + "," + NPTXTOTALBASE_TAXBASEKIND_IIS + ",0";

      if((m_ByCB) and (not m_ByVS))
        TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_BROK + "," + NPTXTOTALBASE_TAXBASEKIND_IIS + ",0";
      elif((not m_ByCB) and (m_ByVS))
        TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_ONB;
      end;

      FillQDates(m_EndDate);

      DateSplit(m_EndDate, null, null, Year);

      if(not ((BeginDate021 != ZeroDate) and (EndDate021 != ZeroDate) and (BeginDate022 != ZeroDate) and (EndDate022 != ZeroDate) and (BeginDate023 != ZeroDate) and (EndDate023 != ZeroDate) and 
              (BeginDate024 != ZeroDate) and (EndDate024 != ZeroDate) and (BeginDate025 != ZeroDate) and (EndDate025 != ZeroDate) and (BeginDate026 != ZeroDate) and (EndDate026 != ZeroDate)
             )
        )
        m_StatPart1 = false;
        return;
      end;

      cmd = DL_RSDCommand();

      query =   " select tb.t_BCCHoldPITax, "
              + "        NVL(SUM(tb.t_HoldPITax), 0) as SumTotal, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as Sum021, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as Sum022, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as Sum023, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as Sum024, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as Sum025, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as Sum026 "
              + "   from dnptxtotalbase_dbt tb, dnptxretconf_tmp rc "
              + "  where tb.t_ClientID in (select t_PartyID from dnptx6client_tmp) "
              + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
              + "    and rc.t_TaxPeriod = tb.t_TaxPeriod "
              + "    and tb.t_IncDate between ? and ? "
              + "    and (   (((tb.t_Type IN (1,2) and tb.t_HoldPITax > 0) or (tb.t_Type IN (3) and tb.t_HoldPITax <> 0))) "
              + "         or (tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? and tb.t_IncDate between ? and rc.t_DatePart1) "
              + "         or (tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? ) "
              + "        ) "
              + "    and tb.t_TaxBaseKind IN ("+TaxBaseKind+")";

      cmd.AddParam(BeginDate021);
      cmd.AddParam(EndDate021);
      cmd.AddParam(BeginDate022);
      cmd.AddParam(EndDate022);
      cmd.AddParam(BeginDate023);
      cmd.AddParam(EndDate023);
      cmd.AddParam(BeginDate024);
      cmd.AddParam(EndDate024);
      cmd.AddParam(BeginDate025);
      cmd.AddParam(EndDate025);
      cmd.AddParam(BeginDate026);
      cmd.AddParam(EndDate026);

      cmd.AddParam(m_BeginDate);
      cmd.AddParam(m_EndDate);

      cmd.AddParam(Year-1);
      cmd.AddParam(date(1,1,Year));
      cmd.AddParam(Year);
      
      if((m_IsSOFR) and (not m_IsDiasoft))
        query = query + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) = 0 ";
      elif((not m_IsSOFR) and (m_IsDiasoft))
        query = query + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) <> 0 ";
      end;

      query = query + " group by tb.t_BCCHoldPITax "
                    + " order by tb.t_BCCHoldPITax ASC ";

      InitProgress(-1, "Форма 6-НДФЛ 2024г", "Подготовка данных для раздела 1");
      DataSet = cmd.Execute(query);
      while(DataSet.moveNext())
        m_Part1Collect.AddKBKPaid(DataSet.BCCHoldPITax, DataSet.SumTotal, DataSet.Sum021, DataSet.Sum022, DataSet.Sum023, DataSet.Sum024, DataSet.Sum025, DataSet.Sum026);
      end;
      RemProgress();

      cmd = DL_RSDCommand();

      query =   " select tb.t_BCCHoldPITax,  "
              + "        NVL(SUM(tb.t_HoldPITax), 0) as SumRetTotal, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as SumRet021, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as SumRet022, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as SumRet023, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as SumRet024, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as SumRet025, "
              + "        NVL(SUM((case when tb.t_IncDate between ? and ? then tb.t_HoldPITax else 0 end)), 0) as SumRet026 "
              + "   from dnptxtotalbase_dbt tb, dnptxretconf_tmp rc "
              + "  where tb.t_ClientID in (select t_PartyID from dnptx6client_tmp) "
              + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
              + "    and tb.t_Type = 2 "
              + "    and tb.t_HoldPITax < 0 "
              + "    and tb.t_IncDate between ? and ? "
              + "    and tb.t_TaxPeriod < ? "
              + "    and rc.t_TaxPeriod = tb.t_TaxPeriod "
              + "    and tb.t_IncDate > rc.t_DatePart1 "
              + "    and tb.t_TaxBaseKind IN ("+TaxBaseKind+")";

      cmd.AddParam(BeginDate021);
      cmd.AddParam(EndDate021);
      cmd.AddParam(BeginDate022);
      cmd.AddParam(EndDate022);
      cmd.AddParam(BeginDate023);
      cmd.AddParam(EndDate023);
      cmd.AddParam(BeginDate024);
      cmd.AddParam(EndDate024);
      cmd.AddParam(BeginDate025);
      cmd.AddParam(EndDate025);
      cmd.AddParam(BeginDate026);
      cmd.AddParam(EndDate026);

      cmd.AddParam(m_BeginDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(Year);
      
      if((m_IsSOFR) and (not m_IsDiasoft))
        query = query + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) = 0 ";
      elif((not m_IsSOFR) and (m_IsDiasoft))
        query = query + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) <> 0 ";
      end;

      query = query + " group by tb.t_BCCHoldPITax "
                    + " order by tb.t_BCCHoldPITax ASC ";
      
      DataSet = cmd.Execute(query);
      while(DataSet.moveNext())
        m_Part1Collect.AddKBKReturn(DataSet.BCCHoldPITax, abs(DataSet.SumRetTotal), abs(DataSet.SumRet021), abs(DataSet.SumRet022), abs(DataSet.SumRet023), abs(DataSet.SumRet024), abs(DataSet.SumRet025), abs(DataSet.SumRet026));
      end;
      
      m_StatPart1 = true;
   end;

END;

CLASS NPTXPayerInfo(_ClientID:integer, _ClientINN:string, _LastName:string, _FirstName:string, _MiddleName:string, _ResidenceStatus:string, _DateBirth:Date,
                           _ResidenceCountry:string, _DocumentType:string, _DocumentNumber:string, _ArrCodeParm:TArray)
   var ClientID         = _ClientID;
   var ClientINN        = _ClientINN;
   var LastName         = _LastName;
   var FirstName        = _FirstName;
   var MiddleName       = _MiddleName;
   var ResidenceStatus  = _ResidenceStatus;
   var DateBirth        = _DateBirth;
   var ResidenceCountry = _ResidenceCountry;
   var DocumentType     = _DocumentType;
   var DocumentNumber   = _DocumentNumber;
   var ArrCodeParm      = TArray();
   var Income15         = TArray();
   var RateIndex = -1;
   
   private var i = 0;
   private var j = 0;
   private var j1 = 0;
   private var k = 0;
   while(i < _ArrCodeParm.Size)
      j = 0;
      j1 = 0;
      RateIndex = -1;
      while(j < _ArrCodeParm[i].NPTXCodeParmArr.Size)
         RateIndex = AddInArrCodeParms(ArrCodeParm, _ArrCodeParm[i].NPTXCodeParmArr[j].Month, _ArrCodeParm[i].NPTXCodeParmArr[j].PScode,
                                       _ArrCodeParm[i].NPTXCodeParmArr[j].PSnnn, NULL/*_ArrCodeParm[i].NPTXCodeParmArr[j].MSCode*/,
                                       0.0/*_ArrCodeParm[i].NPTXCodeParmArr[j].MSnnn*/, 0.0, 0.0, 0.0, 0.0, 0.0, _ArrCodeParm[i].Rate,
                                       _ArrCodeParm[i].NPTXCodeParmArr[j].ЧНБ, 0.0, 0.0, 0.0, _ArrCodeParm[i].IsHighRate, 0.0, _ArrCodeParm[i].DepoMinus, _ArrCodeParm[i].NPTXCodeParmArr[j].IsShow, NULL, 
                                       ((_ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes.Size > 0)),_ArrCodeParm[i].RateType, _ArrCodeParm[i].NPTXCodeParmArr[j].NOBKind, 
                                       _ArrCodeParm[i].KBK, 0.0);

         if(RateIndex >= 0)
            k = 0;
            while(k < _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes.Size)
               ArrCodeParm[RateIndex].NPTXCodeParmArr[j1].MinusCodes[ArrCodeParm[RateIndex].NPTXCodeParmArr[j1].MinusCodes.Size] = NPTXMinusCodeParm(
                  _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].MSCode, _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].MSnnn, _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].IsShow);
               k = k + 1;
            end;

            j1 = j1 + 1;
         end;

         j = j + 1;
      end;

      if(j == 0)
         ArrCodeParm[ArrCodeParm.Size] = NPTXRateParm(0, NULL, _ArrCodeParm[i].PlusSum, NULL, _ArrCodeParm[i].MinusSum, _ArrCodeParm[i].TaxBaseSum, _ArrCodeParm[i].TaxCalculated,
                                                      _ArrCodeParm[i].TaxPaid, _ArrCodeParm[i].TaxToReturnDue, _ArrCodeParm[i].TaxDue, _ArrCodeParm[i].Rate, 0.0,
                                                      _ArrCodeParm[i].DivPlus, _ArrCodeParm[i].TaxCalculatedDiv, _ArrCodeParm[i].TaxOver,
                                                      _ArrCodeParm[i].IsHighRate, _ArrCodeParm[i].Znp, _ArrCodeParm[i].DepoMinus,
                                                      NULL, NULL, NULL, NULL, NULL, NULL, _ArrCodeParm[i].KBK, _ArrCodeParm[i].TaxRefund);
      else
         if(RateIndex >= 0)
            ArrCodeParm[RateIndex].TaxBaseSum       = _ArrCodeParm[i].TaxBaseSum;
            ArrCodeParm[RateIndex].TaxCalculated    = _ArrCodeParm[i].TaxCalculated;
            ArrCodeParm[RateIndex].TaxPaid          = _ArrCodeParm[i].TaxPaid;
            ArrCodeParm[RateIndex].TaxToReturnDue   = _ArrCodeParm[i].TaxToReturnDue;
            ArrCodeParm[RateIndex].TaxDue           = _ArrCodeParm[i].TaxDue;
            ArrCodeParm[RateIndex].DivPlus          = _ArrCodeParm[i].DivPlus;
            ArrCodeParm[RateIndex].TaxCalculatedDiv = _ArrCodeParm[i].TaxCalculatedDiv;
            ArrCodeParm[RateIndex].TaxOver          = _ArrCodeParm[i].TaxOver;
            ArrCodeParm[RateIndex].Znp              = _ArrCodeParm[i].Znp;
            ArrCodeParm[RateIndex].DepoMinus        = _ArrCodeParm[i].DepoMinus;
            ArrCodeParm[RateIndex].TaxRefund        = _ArrCodeParm[i].TaxRefund;
            //после доработки множественности кодов вычета, потерялось суммирование
            //плюс - для единобразия
            ArrCodeParm[RateIndex].MinusSum         = _ArrCodeParm[i].MinusSum;
            ArrCodeParm[RateIndex].PlusSum          = _ArrCodeParm[i].PlusSum;
            if (_ArrCodeParm[RateIndex].Income15.size > 0)
              ArrCodeParm[RateIndex].Income15 = _ArrCodeParm[i].Income15;
            end;
         end;
      end;
      i = i + 1;
   end;
END;

private class TNotWrtMinusData(_Month, _MSCode, _NotWrtSum)
  var Month     = _Month;    
  var MSCode    = _MSCode;   
  var NotWrtSum = _NotWrtSum;
end;

private class TKBKData(_KBK, _Rate, _TaxBase, _TaxPaid, _TaxToReturnDue,
                       _TaxPaid1Data, _TaxPaid2Data, _TaxPaid3Data, _TaxPaid4Data, _TaxPaid5Data, _TaxPaid6Data,
                       _TaxToReturn1Data, _TaxToReturn2Data, _TaxToReturn3Data, _TaxToReturn4Data, _TaxToReturn5Data, _TaxToReturn6Data,
                       _TaxRefund 
                      )
  var KBK            = _KBK;           
  var Rate           = _Rate;          
  var TaxBase        = _TaxBase;       
  var TaxPaid        = _TaxPaid;       
  var TaxToReturnDue = _TaxToReturnDue;

  var RestTaxBase = TaxBase;
  var IsHighRate  = IIF(Rate == int(NPTXGENTAXRATE_RESIDENT_15*100), true, false);

  var TotalPlus     = $0;
  var TotalMinus    = $0;
  var TaxCalculated = $0;
  var TaxDue        = $0;
  var TaxOver       = $0;

  var TaxPaid1Data = _TaxPaid1Data;
  var TaxPaid2Data = _TaxPaid2Data;
  var TaxPaid3Data = _TaxPaid3Data;
  var TaxPaid4Data = _TaxPaid4Data;
  var TaxPaid5Data = _TaxPaid5Data;
  var TaxPaid6Data = _TaxPaid6Data;

  var TaxToReturn1Data = _TaxToReturn1Data;
  var TaxToReturn2Data = _TaxToReturn2Data;
  var TaxToReturn3Data = _TaxToReturn3Data;
  var TaxToReturn4Data = _TaxToReturn4Data;
  var TaxToReturn5Data = _TaxToReturn5Data;
  var TaxToReturn6Data = _TaxToReturn6Data;

  var TaxRefund = _TaxRefund;
end;

var GeneralNOBSums = TArray();
var HighRateNOBSums = TArray();

/**
  @brief Класс для формирования данных для раздела 2 (включая приложение 1 и справку для выдачи клиентам)
  @param [in] _BeginDate Дата начала
  @param [in] _EndDate Дата окончания
  @param [in] _ByCB Значение флага "По модулю "БО ЦБ" из панели
  @param [in] _ByDepo Значение флага "По модулю "Депозитарий" из панели
  @param [in] _ByVS Значение флага "По модулю "Векселя банка" из панели
  @param [in] IsPart2 Значение флага "Раздел 2" из панели
  @param [in] RepDate Дата формирования отчета
*/
CLASS (NPTXRepCalc_NPTXPIT6) NPTXRepCalc_NPTXPIT6_NEW_2(_BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS, IsPart2:BOOL, RepDate:DATE, _IsDetails, _IsSOFR, _IsDiasoft, _IsApp1)
   m_PersnIdcMain = TBFile("persnidc.dbt");
   m_ArrCodeParms = TArray();
   private var m_MinusG_618_Store;
   private var m_MinusG_619_Store;
   private var m_cmd;

   private var m_IsDetails;
   private var m_IsSOFR;   
   private var m_IsDiasoft;
   private var m_IsApp1;
   private var m_IsPart2;


   MACRO ClearDataClient()
      m_Pg = NULL;
      m_Pm = NULL;
      m_Ps = NULL;
      m_Pp = NULL;
      m_PersnIdcMain.Clear();
      m_TaxCalculated = $0.0;
      m_PlusSum = $0.0;
      m_MinusSum = $0.0;
      m_ResidenceStatus = -1;

      var i = 0;
      while(i < m_ArrCodeParms.Size)
        m_ArrCodeParms[i].NPTXCodeParmArr.Size = 0;
        i = i + 1;
      end;
      m_ArrCodeParms.Size = 0;

      m_MinusG_618 = null;
      m_MinusG_619 = null;
   END;

   MACRO MinusG_618(ClientId, infRate, ResidenceStatus)
      var key = string(infRate) + "_" + ClientId;
      var MinusG_618;
      m_MinusG_618_Store = IIF((ValType(m_MinusG_618_Store) != V_UNDEF), m_MinusG_618_Store, TArray());
      var idx = DL_FindKeyPairInArr(m_MinusG_618_Store, key);
      if (idx == -1)
         if( (infRate == INFORATE_TOTAL) and (ResidenceStatus == 1) )
             MinusG_618 = GetRubSumByClientOperDocKind(ClientId, string(TXOBJ_MINUSG_618), date(1,1,m_CurrYear), m_EndDate, DL_CALCNDFL, null, GetTypeContract()) + //созданные в операциях расчета НОБ
                         GetRubSumByClientOperDocKind(ClientId, string(TXOBJ_MINUSG_618), date(1,1,m_CurrYear), m_EndDate, 0 /*только пользовательские*/, null, GetTypeContract());
         else
            MinusG_618 = $0;
         end;
         idx = m_MinusG_618_Store.size;
         m_MinusG_618_Store[idx] = DL_KeyPair(key,ExtRound(MinusG_618));
      end;
      return m_MinusG_618_Store[idx].Value;
   END;

   MACRO MinusG_619(ClientId, infRate, ResidenceStatus)
      var key = string(infRate) + "_" + ClientId;
      var MinusG_619;
      m_MinusG_619_Store = IIF((ValType(m_MinusG_619_Store) != V_UNDEF), m_MinusG_619_Store, TArray());
      var idx = DL_FindKeyPairInArr(m_MinusG_619_Store, key);
      if (idx == -1)
         if ((m_InfoRate == INFORATE_TOTAL) and (ResidenceStatus == 1) 
             and (IIS_CONTRACTS == SET_CHAR))
           MinusG_619 = GetRubSumByClientOperDocKind(ClientId,
                                                     string(TXOBJ_MINUSG_619),
                                                     date(1,1,m_CurrYear),
                                                     m_EndDate,
                                                     DL_CALCNDFL,
                                                     null,
                                                     1)
                        + GetRubSumByClientOperDocKind(ClientId,
                                                       string(TXOBJ_MINUSG_619),
                                                       date(1,1,m_CurrYear),
                                                       m_EndDate,
                                                       0,
                                                       null,
                                                       1);
         else
           MinusG_619 = $0;
         end;
         idx = m_MinusG_619_Store.size;
         m_MinusG_619_Store[idx] = DL_KeyPair(key,ExtRound(MinusG_619));
      end;
      return m_MinusG_619_Store[idx].Value;
   END;

   MACRO Init(BeginDate, EndDate, IsConsiderCB, IsConsiderDepo, IsConsiderVS, RepDate:DATE, IsDetails, IsSOFR, IsDiasoft, IsApp1, IsPart2)
      m_RepDate = RepDate;
      m_EndDate = EndDate;
      m_CurrSign = 0;
  
      if(IsConsiderCB != null)
         m_IsConsiderCB = IsConsiderCB;
      end;
  
      if(IsConsiderDEPO != null)
         m_IsConsiderDEPO = IsConsiderDepo;
      end;
  
      if(IsConsiderVS != null)
         m_IsConsiderVS = IsConsiderVS;
      end;

      DateSplit(m_EndDate, null, null, m_CurrYear);

      m_BeginDate = BeginDate;

      m_IsDetails = IsDetails;
      m_IsSOFR    = IsSOFR;   
      m_IsDiasoft = IsDiasoft;
      m_IsApp1    = IsApp1;
      m_IsPart2   = IsPart2;

      if(m_IsDetails)
        InitProgress(-1, "6-НДФЛ 2024г.", "Отбор данных для расшифровок раздела 2");
        var query_fill_tmp = "begin " +
                             "   RSI_NPTX6CALC.CalcDataForPart2(?, ?, ?, ?, ?, ?); " +
                             "end; ";

        var cmd_fill_tmp = RSDCommand(query_fill_tmp);
        cmd_fill_tmp.AddParam("", RSDBP_IN, m_BeginDate );
        cmd_fill_tmp.AddParam("", RSDBP_IN, m_EndDate );
        cmd_fill_tmp.AddParam("", RSDBP_IN, m_IsConsiderCB );
        cmd_fill_tmp.AddParam("", RSDBP_IN, m_IsConsiderDepo );
        cmd_fill_tmp.AddParam("", RSDBP_IN, m_IsConsiderVS );
        cmd_fill_tmp.AddParam("", RSDBP_IN, m_RepDate );

        cmd_fill_tmp.Execute();

        m_query = "select 1 " +
                  "from dnptx6calc1_tmp " +
                  "group by t_ClientID ";

        m_cmd = DL_RSDCommand(m_query);
        m_count = m_cmd.GetCount();

        RemProgress();
     end;
   END;

   MACRO Count():Integer
      return m_count;
   END;

   MACRO OurKPP():String
      var ErrCode = 0;
      var RegVal = false;
      PRIVATE RECORD OurBankRec("party.dbt");

      GetRegistryValue("COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ", V_BOOL, RegVal, ErrCode);

      if(ErrCode == 0)
         if(RegVal)
            if(ПолучитьСубъекта({OurBank}, OurBankRec) == 0)
               var str = String(ReadNoteForObject(OBJTYPE_PARTY, UniID(OurBankRec, OBJTYPE_PARTY), 79, m_RepDate));
               var SlashIndex = Index(str, "/");
               if(SlashIndex > 0)
                  return SubStr(str, 1, SlashIndex-1);
               end;

               return str;
            else
               MsgBox("Ошибка получения субъекта " + {OurBank});
               return OurKPP();
            end;
         else
            return OurKPP();
         end;
      else
         MsgBox("Ошибка чтения значения настройки \"COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ\". Код " + ErrCode);
         return OurKPP();
      end;
   END;

   MACRO OurFNSCode():String
      var ErrCode = 0;
      var RegVal = false;
      PRIVATE RECORD OurBankRec("party.dbt");

      GetRegistryValue("COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ", V_BOOL, RegVal, ErrCode);

      if(ErrCode == 0)
         if(RegVal)
            if(ПолучитьСубъекта({OurBank}, OurBankRec) == 0)
               var str = String(ReadNoteForObject(OBJTYPE_PARTY, UniID(OurBankRec, OBJTYPE_PARTY), 79, m_RepDate));
               var SlashIndex = Index(str, "/");
               if(SlashIndex > 0)
                  return SubStr(str, SlashIndex + 1);
               end;

               return str;
            else
               MsgBox("Ошибка получения субъекта " + {OurBank});
               return OurFNSCode();
            end;
         else
            return OurFNSCode();
         end;
      else
         MsgBox("Ошибка чтения значения настройки \"COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ\". Код " + ErrCode);
         return OurKPP();
      end;
   END;

   MACRO DocumentInfo(ClientID:Integer, DocumentType:@String, DocumentNumber:@String)
      var SerNum = "";

      DocumentType = "";
      DocumentNumber = "";

      var query = "select ppk.t_CodeDocum, idc.t_PaperSeries, idc.t_PaperKind, idc.t_PaperNumber " +
                  "from dpaprkind_dbt ppk, " +
                  "     dpersnidc_dbt idc " +
                  "where idc.t_PersonID = ? " +
                  "  and idc.t_IsMain = 'X' " +
                  "  and ppk.t_PaperKind = idc.t_PaperKind ";

      var cmd = DL_RSDCommand(query);
      cmd.AddParam(ClientID);
      var DS = cmd.Execute();
      if(DS.MoveNext())
         DocumentType = trim(DS.CodeDocum);
         SerNum = strsubst(trim(DS.PaperSeries), " ", "");
         if((DS.PaperKind == 0) and (strlen(SerNum)))
            SerNum = substr(SerNum, 1, 2)+ " " + Substr(SerNum, 3, 2);
         end;
  
         DocumentNumber = trim(SerNum + " " + DS.PaperNumber);
      end;
   END;

   MACRO Citizenship(ClientID:Integer):String
      var DocumentType = "";

      var query = "select NVL(cn.t_CodeNum3, chr(1)) as t_Citizenship " +
                  "from dparty_dbt pt, dcountry_dbt cn " +
                  "where pt.t_PartyID = ? " +
                  "  and cn.t_CodeLat3(+) = pt.t_NRCountry ";

      var cmd = DL_RSDCommand(query);
      cmd.AddParam(ClientID);
      var DS = cmd.Execute();

      if(DS.MoveNext())
         DocumentInfo(ClientID, @DocumentType, NULL);
         if((DS.Citizenship == "") and DocumentType == "21")
            return NumOurCountry;
         end;

         return DS.Citizenship;
      end;

      return NumOurCountry;
   END;

   PRIVATE MACRO GetEndDayOfMonth(Month, Year)
      if((Month == 1) or (Month == 3)  or (Month == 5)  or (Month == 7) or (Month == 8)  or (Month == 10) or (Month == 12))
         return date(31, Month, Year);
      elif((Month == 2) and (Int(double(Year) / 4) != double(Year) / 4))
         return date(28, Month, Year);
      elif((Month == 2) and (Int(double(Year) / 4) == double(Year) / 4))
         return date(29, Month, Year);
      elif((Month == 4) or (Month == 6) or (Month == 9) or (Month == 11))
         return date(30, Month, Year);
      end;

      return date(0, 0, 0);
   END;

   PRIVATE MACRO RecalcNOB(ArrCodeParm:@TArray, RateIndex, RateVal)
     var NOBSum = $0;
     var i = -1;
     var bufSum = $0;
     ArrCodeParm[RateIndex].PlusSum = $0;
     ArrCodeParm[RateIndex].MinusSum = $0;
     ArrCodeParm[RateIndex].TaxBaseSum = $0;
     while ((i=i+1) < ArrCodeParm[RateIndex].NPTXCodeParmArr.size)
       NOBSum = NOBSum + (ExtRound(ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn) - ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum(NULL, true));
       ArrCodeParm[RateIndex].PlusSum = ArrCodeParm[RateIndex].PlusSum + ExtRound(ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn);
       ArrCodeParm[RateIndex].MinusSum = ArrCodeParm[RateIndex].MinusSum + ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum(NULL, true);
     end;
     if ((ArrCodeParm[RateIndex].TaxPaid != $0) and (ArrCodeParm[RateIndex].TaxToReturnDue != 0))
       bufSum = ArrCodeParm[RateIndex].TaxPaid - ArrCodeParm[RateIndex].TaxToReturnDue;
       ArrCodeParm[RateIndex].TaxPaid = IIF(bufSum > $0, ABS(bufSum), $0);
       ArrCodeParm[RateIndex].TaxToReturnDue = IIF(bufSum < $0, ABS(bufSum), $0);
     end;
     ArrCodeParm[RateIndex].TaxBaseSum = NOBSum;
     ArrCodeParm[RateIndex].TaxCalculated = ExtRound(NOBSum) * RateVal / 100.0;
     ArrCodeParm[RateIndex].TaxDue = ExtRound(ArrCodeParm[RateIndex].TaxCalculated,0) 
                + ExtRound(-ArrCodeParm[RateIndex].TaxPaid - ArrCodeParm[RateIndex].TaxToReturnDue,0);
     if(ArrCodeParm[RateIndex].TaxDue >= 0)
       ArrCodeParm[RateIndex].TaxOver = 0;
     else
       ArrCodeParm[RateIndex].TaxOver = -ArrCodeParm[RateIndex].TaxDue;
       ArrCodeParm[RateIndex].TaxDue = 0;
     end;
     
   END;

   PRIVATE MACRO IsLastElemOfNOBKind(RateParm, index)
      var i = index + 1;

      while(i < RateParm.NPTXCodeParmArr.Size)
         if(RateParm.NPTXCodeParmArr[i].PSCode == RateParm.NPTXCodeParmArr[index].PSCode)
            return false;
         end;
         i = i + 1;
      end;

      return true;
   END;

   PRIVATE MACRO DeleteFromNOBKinds(RateParm:@NPTXRateParm, index)
      var i = index;
      while(i < RateParm.NPTXCodeParmArr.Size - 1)
         RateParm.NPTXCodeParmArr[i] = RateParm.NPTXCodeParmArr[i + 1];
         i = i + 1;
      end;

      RateParm.NPTXCodeParmArr.Size = RateParm.NPTXCodeParmArr.Size - 1;
   END;

   MACRO CalcNPTXPIT2General(ArrCodeParm:@TArray, Rate, IsHighRate, KBK, ClientID, LastName, FirstName, MiddleName)
      var PlusSum = $0, MinusSum = $0, PlusSum15 = $0, MinusSum15 = $0, TaxBase15 = $0;
      var indexTotal = IndexOfRate(ArrCodeParm, Rate, IsHighRate, KBK);
      var i = 0, j = 0, k = 0, l = 0, j2 = 0;
      var codeBufPlusSums = TArray();
      var codeBufMinusSums = TArray();
      var codeBuf = TArray();
      var odBuf = Tarray();
      var sortedArr = TArray();
      var bufIdx = -1;
      var totalRecBuf = null;
      var MSnnn = $0, OD = $0, calcOD = $0, bufOD = $0;
      var minusFind = false;
      var OD2 = $0;
      var D15 = $0;
      var NOBSum = $0;
      var mnsSum = $0;
      var fromIndex, toIndex;
      var psCode = "";
      
      //проверка на отрицательные суммы и "схлопывание"
      if (indexTotal >= 0)
        i = -1;
        while ((i=i+1) < ArrCodeParm[indexTotal].NPTXCodeParmArr.Size)
          totalRecBuf = ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
          if (totalRecBuf.PSnnn < 0.0)
            codeBuf[codeBuf.size] = CollapseStruct(i, totalRecBuf.PSCode, totalRecBuf.PSnnn);
          end;

          j=-1;
          while ((j=j+1) < totalRecBuf.MinusCodes.Size)
            if (totalRecBuf.MinusCodes[j].MSnnn < 0.0)
              codeBuf[codeBuf.size] = CollapseStruct(i, totalRecBuf.MinusCodes[j].MSCode, totalRecBuf.MinusCodes[j].MSnnn, j);
            end;
          end;
        end;
      end;

      if (indexTotal >= 0)
        i = -1;
        while ((i = i + 1) < codeBuf.size)
          if (not codeBuf[i].IsMinus)
            sortedArr = MakeSortedPlusByCodeAndSum(ArrCodeParm[indexTotal].NPTXCodeParmArr, codeBuf[i].Code);
          else
            sortedArr = MakeSortedMinusByCodeAndSum(ArrCodeParm[indexTotal].NPTXCodeParmArr, codeBuf[i].Code);
          end;
          j = -1;
          while ((j=j+1) < sortedArr.size)
            codeBuf[i].Sum = codeBuf[i].Sum + sortedArr[j].Sum;
            if (ExtRound(codeBuf[i].Sum) >= $0)
              if (not codeBuf[i].IsMinus)
                ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = codeBuf[i].Sum;
                //если он вдруг нулевой, то его "стираем"
                if (ExtRound(ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn) == 0)
                  ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL;
                end;
              else
                ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx].MSnnn = codeBuf[i].Sum;
                //если он вдруг нулевой, то его "стираем"
                if (ExtRound(ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx].MSnnn) == $0)
                  //пока делаем просто null чтобы не сбить индексы
                  ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx] = NULL;
                end;
              end;

              while ((j=j-1) >= 0)
                if (not codeBuf[i].IsMinus)
                  ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = 0.0;
                  ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL; 
                else
                  ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx] = NULL;
                end;
              end;
              if (not codeBuf[i].IsMinus)
                ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].PSnnn = 0.0;
                ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].PSCode = NULL; 
              else
                ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].MinusCodes[codeBuf[i].SubIdx] = NULL;
              end;
              RemoveFromArrByIdx(@codeBuf,i);
              i=i-1;
              break;
            end;
          end;
        end;

        //подчищаем null значения в minuscodes
        i = -1;
        while ((i = i + 1) < ArrCodeParm[indexTotal].NPTXCodeParmArr.size)
          if (ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes != NULL)
            ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes = filter(ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes);
          end;
        end;
      end;

      var oldArr;
      //проверка на отрицательный ОД (остаток доходов, т.е. доход минус вычеты), и перенос излишних вычетов в предыдущие (или следующие) месяцы
      if (indexTotal >= 0)
        //делаем полную копию NPTXCodeParmArr по значениям
        oldArr = MakeCopyNPTXCodeParmArr(ArrCodeParm[indexTotal].NPTXCodeParmArr);

        i = ArrCodeParm[indexTotal].NPTXCodeParmArr.Size;
        while ((i=i-1) >= 0)
          totalRecBuf = ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
          if (not totalRecBuf.IsShow)
            continue;
          end;

          MSnnn = totalRecBuf.GetMinusSum(true);

          if (totalRecBuf.PSnnn - MSnnn < $0)
            psCode = totalRecBuf.PSCode;
            if (psCode == NULL)
              k = -1;
              while ((k = k + 1) < GetCodeGroupsValue().size)
                if (find(GetCodeGroupsValue()[k],totalRecBuf.MinusCodes[0].MSCode) != -1)
                  psCode = GetCodeGroups()[k].Key;
                  break;
                end;
              end;
            end;
            odBuf[odBuf.size] = MinusMoveStruct(totalRecBuf.PSnnn, psCode, i, totalRecBuf.MinusCodes);
          end;
        end;

        i = -1;
        while ((i=i+1) < odBuf.size)
          //j2 = 0;
          j=odBuf[i].Idx;
          //закольцовываем
          if (j == 0)
            j = ArrCodeParm[indexTotal].NPTXCodeParmArr.size;
          end;
          while (((j=j-1) >= 0) and (j != odBuf[i].Idx))
            totalRecBuf = ArrCodeParm[indexTotal].NPTXCodeParmArr[j];
            if ((totalRecBuf.PSCode != NULL) and (totalRecBuf.PSCode == odBuf[i].PlusCode))
              MSnnn = totalRecBuf.GetMinusSum(true);

              OD2 = totalRecBuf.PSnnn - MSnnn;

              j2 = -1;

              while (((j2=j2+1) < odBuf[i].MinusCodes.size) and (ExtRound(OD2) > 0))
                mnsSum = min(min(odBuf[i].MinusCodes[j2].Sum,ABS(odBuf[i].GetOD())),OD2);
                if (mnsSum <= $0)
                  continue;
                end;
                
                OD2 = OD2 - mnsSum;
                odBuf[i].MinusCodes[j2].Sum = ExtRound(odBuf[i].MinusCodes[j2].Sum - mnsSum);
                ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn
                  = ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn - mnsSum;

                if (ExtRound(ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn) == $0)
                  ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx] = NULL;
                end;
                
                l = -1;
                minusFind = false;
                while(((l=l+1) < totalRecBuf.MinusCodes.Size) )
                  //ищем что среди кодов вычетов, нет вычета который мы запомнили
                  if (totalRecBuf.MinusCodes[l].MSCode == odBuf[i].MinusCodes[j2].Code)
                    minusFind = true;
                    ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[l].MSnnn = 
                      ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[l].MSnnn + mnsSum;
                    break;
                  end;
                end;
                if (not minusFind)
                  ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes.size] = 
                                            NPTXMinusCodeParm(odBuf[i].MinusCodes[j2].Code, mnsSum, true);
                end;
              end;
            end;

            if (ExtRound(odBuf[i].GetOD()) >= $0)
              break;
            end;

            //закольцовываем
            if (j == 0)
              j = ArrCodeParm[indexTotal].NPTXCodeParmArr.size;
            end;
          end;
        end;

        //подчищаем null значения в minuscodes
        i = -1;
        while ((i = i + 1) < ArrCodeParm[indexTotal].NPTXCodeParmArr.size)
          if (ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes != NULL)
            ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes = filter(ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes);
          end;
        end;

      end;

      var wasNotReDef = false;
      var needRecalcNob = false;
      var Year = 0;
      var НОБ_обр_ЦБ    = NULL;
      var НОБ_необр_ЦБ  = NULL;
      var НОБ_потеря_ЦБ = NULL;

      DateSplit(m_EndDate, null, null, Year);

      if(m_EndDate == date(31,12,Year))
        i = -1;
        while ((i = i + 1) < odBuf.size)
          OD = odBuf[i].GetOD();
          if(OD < 0)
            НОБ_обр_ЦБ    = Рассчитать_НОБ_обр_ЦБ(ClientID, Year);
            НОБ_необр_ЦБ  = Рассчитать_НОБ_необр_ЦБ(ClientID, Year);
            НОБ_потеря_ЦБ = Рассчитать_НОБ_потеря_ЦБ(ClientID, Year);
            if((НОБ_обр_ЦБ < 0) or (НОБ_необр_ЦБ < 0) or (НОБ_потеря_ЦБ < 0))
              var query, cmd;

              query =   " select 1"
                      + "   from dnptxobj_dbt obj "
                      + "  where obj.t_Client = ? "
                      + "    and obj.t_Kind IN ("+TXOBJ_PLUSG_1530+","+TXOBJ_PLUSG_1531+","+TXOBJ_PLUSG_1536+")"
                      + "    and obj.t_Date between ? and ? "
                      + "    and obj.t_FromOutSyst = 'X' " 
                      + "    and obj.t_OutSystCode in ('DEPO','ДЕПО') "
                      + "    and obj.t_ChangeCode = 'X'"
                      + "    and ROWNUM = 1 ";

              cmd = DL_RSDCommand(query);

              cmd.AddParam(ClientID);
              cmd.AddParam(date(1,1,Year));
              cmd.AddParam(date(31,12,Year));

              if(cmd.GetCount() > 0)
                
                var CoupPayDed1 = abs(min(НОБ_обр_ЦБ, 0));
                var CoupPayDed2 = abs(min(НОБ_необр_ЦБ, 0));
                var CoupPayDed3 = abs(min(НОБ_потеря_ЦБ, 0));

                if (indexTotal >= 0)
                  k = 1;
                  while(k <= 3) //Для каждого: CoupPayDed1, CoupPayDed2, CoupPayDed3  
                    var CoupPayDed = 0;
                    var MinusGArr = TArray();

                    if(k == 1)
                      CoupPayDed = CoupPayDed1;

                      MinusGArr[MinusGArr.size] = "201";
                      MinusGArr[MinusGArr.size] = "222";
                      MinusGArr[MinusGArr.size] = "218";
                      MinusGArr[MinusGArr.size] = "208";
                    elif(k == 2)
                      CoupPayDed = CoupPayDed2;

                      MinusGArr[MinusGArr.size] = "202";
                      MinusGArr[MinusGArr.size] = "223";
                      MinusGArr[MinusGArr.size] = "219";
                    elif(k == 3)
                      CoupPayDed = CoupPayDed3;

                      MinusGArr[MinusGArr.size] = "203";
                      MinusGArr[MinusGArr.size] = "224";
                    end;

                    if(CoupPayDed > 0)
                      //перебираем все доходы по месяцам
                      //идём снизу вверх
                      i = ArrCodeParm[indexTotal].NPTXCodeParmArr.Size - 1;
                      while((i >= 0) and (CoupPayDed > 0))
                        totalRecBuf = ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
                        
                        MSnnn = totalRecBuf.GetMinusSum(true);

                        //Вычисляем НОБ в данной группе
                        var Amount1 = totalRecBuf.PSnnn - MSnnn;

                        if(Amount1 < 0) //НОБ отрицательная, значит попытаемся уменьшить вычеты этой группы купонными выплатами ДЕПО
                          j = 0;

                          //Перебираем все вычеты группы
                          while((j < totalRecBuf.MinusCodes.size) and (CoupPayDed > 0))

                            var d = 0;

                            //Проверяем по приоритету, что вычет подходит
                            while((d < MinusGArr.size) and (CoupPayDed > 0))
                              if(totalRecBuf.MinusCodes[j].MSCode == MinusGArr[d])
                                //Определяем сумму уменьшения вычета
                                var Sum = min(totalRecBuf.MinusCodes[j].MSnnn, min(abs(Amount1), CoupPayDed));

                                totalRecBuf.MinusCodes[j].MSnnn = totalRecBuf.MinusCodes[j].MSnnn - Sum;
                                Amount1 = Amount1 + Sum;

                                CoupPayDed = CoupPayDed - Sum;

                                needRecalcNob = true;
                              end;

                              d = d + 1;
                            end;

                            j = j + 1;
                          end;

                        end;

                        i = i - 1;
                      end;
                    end;

                    k = k + 1;
                  end;
                end;
              end;
            end;

            //Переформируем odBuf
            odBuf.size = 0;
            i = ArrCodeParm[indexTotal].NPTXCodeParmArr.Size;
            while ((i=i-1) >= 0)
              totalRecBuf = ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
              if (not totalRecBuf.IsShow)
                continue;
              end;

              MSnnn = totalRecBuf.GetMinusSum(true);

              if (totalRecBuf.PSnnn - MSnnn < $0)
                psCode = totalRecBuf.PSCode;
                if (psCode == NULL)
                  k = -1;
                  while ((k = k + 1) < GetCodeGroupsValue().size)
                    if (find(GetCodeGroupsValue()[k],totalRecBuf.MinusCodes[0].MSCode) != -1)
                      psCode = GetCodeGroups()[k].Key;
                      break;
                    end;
                  end;
                end;
                odBuf[odBuf.size] = MinusMoveStruct(totalRecBuf.PSnnn, psCode, i, totalRecBuf.MinusCodes);
              end;
            end;

            break; //Выходим после первой подходящей записи, так как это была просто проверка на то, что есть отрицательная НОБ в массиве. Все действия выполнены при этом проходе.
          end;
        end;
      end;

      i = -1;
      while ((i = i + 1) < odBuf.size)
        OD = odBuf[i].GetOD();
        if (OD < -0.5)
          wasNotReDef = true;
          MsgBox("По клиенту с PartyID = " + ClientID + " (" + LastName + " " + FirstName + " " +  MiddleName + 
               "), не распределено превышение расходов над доходами на сумму "+string(ABS(odBuf[i].GetOD())));
        elif ((OD < 0.0) and (OD >= -0.5))
          j=-1;
          while(((j=j+1) < ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes.size) and (ExtRound(OD) < 0.0))
            mnsSum = min(ABS(OD),ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn);
            ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn = 
                ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn - mnsSum;
            OD=OD+mnsSum;
            needRecalcNob = true;
          end;
        end;
      end;
      if (wasNotReDef)
        MsgBox("По клиенту с PartyID = " + ClientID + " (" + LastName + " " + FirstName + " " +  MiddleName + ") вычеты возвращены в исходное состояние");
        ArrCodeParm[indexTotal].NPTXCodeParmArr = oldArr;
      end;
      
      if (indexTotal >= 0)
        ////идём сверху вниз
        i = -1;
        while ((i=i+1) < ArrCodeParm[indexTotal].NPTXCodeParmArr.Size)
          totalRecBuf = ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
          if ( ((ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes == NULL) 
             OR (ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes.Size == 0)) and ((totalRecBuf.PSCode == NULL) or (totalRecBuf.PSnnn == 0.0)))
            RemoveFromArrByIdx(@ArrCodeParm[indexTotal].NPTXCodeParmArr,i);
            i = i - 1;
          end;
        end;
      end;


      if ((indexTotal >= 0) and (ArrCodeParm[indexTotal].Income15.size > 0) and true)
        i = -1;
        while ((i = i + 1) < ArrCodeParm[indexTotal].Income15.size)
          sortedArr = MakeSortedCodesByNobkind(ArrCodeParm[indexTotal].NPTXCodeParmArr, ArrCodeParm[indexTotal].Income15[i].Key);
          j = -1;
          D15 = 1;
          while ((j = j + 1) < sortedArr.size)
            totalRecBuf = ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx];
            OD = totalRecBuf.PSnnn - totalRecBuf.GetMinusSum();
            D15 = min(ArrCodeParm[indexTotal].Income15[i].Value, OD);
            if (D15 > $0)
              ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = 
                ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn - D15;
              ArrCodeParm[indexTotal].Income15[i].Value = ArrCodeParm[indexTotal].Income15[i].Value - D15;

              AddInArrCodeParms(ArrCodeParm, totalRecBuf.Month, totalRecBuf.PSCode, D15, NULL, NULL, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, true);
              if ((ExtRound(ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn) == $0) and 
                  ((ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes == NULL) or 
                   (ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes.size == 0))
                 )
                ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL;
              end;
              if (ArrCodeParm[indexTotal].Income15[i].Value <= $0)
                break;
              end;
            end;
          end;
        end;

        needRecalcNob = true;
      end;

      if (needRecalcNob)
        if (indexTotal >= 0)
          RecalcNOB(@ArrCodeParm, indexTotal, Rate);
        end;
      end;
   END;

   //Здесь формируем общий массив данных доходов и х вычетов без разбивки по ставке и КБК. Поэтому используем произвольне значения ставки и КБК - они нам в массиве не понадобятся тут.
   private macro CollectAllArrCodeParm(ClientID, LastName, FirstName, MiddleName, ResidenceStatus, AllArrCodeParm:@TArray)
     var queryPlus, cmdPlus, DataSetPlus;
     var queryMinus, cmdMinus, DataSetMinus;
     var Rate       = IIF(ResidenceStatus == 1, int(NPTXGENTAXRATE_NOTRESIDENT*100), int(NPTXGENTAXRATE_RESIDENT*100)); //Просто произвольная ставка для общего массива. 
     var IsHighRate = false; //Просто произвольное значение для общего массива. 
     var KBK        = NPTXKBK_MAIN; //Просто произвольное значение для общего массива. 
     var ArrNotWrtMinus618 = TArray();
     var ArrNotWrtMinus619 = TArray();
     var Year = 0;

     DateSplit(m_EndDate, null, null, Year);

     //Формируем суммы доходов и вычетов в единую таблицу (массив)
     queryPlus =   "with k as (select t_Element, t_Code, t_TaxBaseKind from dnptxkind_dbt where t_Level in (5) and t_Code like 'PlusG%'), "
                 + "     m as (select t_Element, t_Code, t_TaxBaseKind from dnptxkind_dbt where t_Code like 'MinusG%')"
                 + " select q.ObjMonth, q.t_Kind as PlusKind, q.t_Code as PlusCode, NVL(SUM(q.t_Sum0), 0) as PlusSum "
                 + "   from (select Extract(month from obj.t_Date) as ObjMonth, obj.t_Sum0, k.t_Code, obj.t_Kind "
                 + "           from k, dnptxobj_dbt obj "
                 + "          where obj.t_Client = ? "
                 + "            and obj.t_Date between ? and ? "
                 + "            and obj.t_Kind = k.t_Element "
                 + "            and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                 + "            and (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst is null) "
                 + "            and 1 = (case when obj.t_Kind = " + TXOBJ_PLUSG_1011 + " and obj.t_Sum0 = NVL((select SUM(obj1.t_Sum0) "
                 + "                                                                                  from dnptxobj_dbt obj1 "
                 + "                                                                                 where obj1.t_Client = obj.t_Client "
                 + "                                                                                   and obj1.t_Date = obj.t_Date " 
                 + "                                                                                   and obj1.t_Kind IN ("+TXOBJ_PLUSG_1011_1+","+TXOBJ_PLUSG_1011_2+","+TXOBJ_PLUSG_1011_3+")"
                 + "                                                                                   and obj1.t_AnaliticKind6 = obj.t_AnaliticKind6 "   
                 + "                                                                                   and obj1.t_Analitic6 = obj.t_Analitic6 "
                 + "                                                                                   and obj1.t_OutSystCode = obj.t_OutSystCode "
                 + "                                                                                   and obj1.t_OutObjID = obj.t_OutObjID "
                 + "                                                                                   and (obj1.t_Technical = CHR(0) or obj1.t_Technical is null) "
                 + "                                                                                   and (obj1.t_FromOutSyst = CHR(0) or obj1.t_FromOutSyst is null) "
                 + "                                                                               ),0) then 0 "
                 + "                          else 1 end) "
                 + "            and 1 = (case when obj.t_Kind = " + TXOBJ_PLUSG_1011_IIS + " and obj.t_Sum0 = NVL((select SUM(obj1.t_Sum0) "
                 + "                                                                                      from dnptxobj_dbt obj1 "
                 + "                                                                                     where obj1.t_Client = obj.t_Client "
                 + "                                                                                       and obj1.t_Date = obj.t_Date "
                 + "                                                                                       and obj1.t_Kind IN ("+TXOBJ_PLUSG_1011_1_IIS+","+TXOBJ_PLUSG_1011_2_IIS+","+TXOBJ_PLUSG_1011_3_IIS+")"
                 + "                                                                                       and obj1.t_AnaliticKind6 = obj.t_AnaliticKind6 "
                 + "                                                                                       and obj1.t_Analitic6 = obj.t_Analitic6 "
                 + "                                                                                       and obj1.t_OutSystCode = obj.t_OutSystCode "
                 + "                                                                                       and obj1.t_OutObjID = obj.t_OutObjID "
                 + "                                                                                       and (obj1.t_Technical = CHR(0) or obj1.t_Technical is null) "
                 + "                                                                                       and (obj1.t_FromOutSyst = CHR(0) or obj1.t_FromOutSyst is null) "
                 + "                                                                                   ), 0) then 0 "
                 + "                          else 1 end) "
                 + "        ) q " 
                 + "  group by q.ObjMonth, q.t_Kind, q.t_Code "
                 + "  order by q.ObjMonth ASC, q.t_Code ASC ";

     cmdPlus = DL_RSDCommand(queryPlus);

     cmdPlus.AddParam(ClientID);
     cmdPlus.AddParam(m_BeginDate);
     cmdPlus.AddParam(m_EndDate);

     DataSetPlus = cmdPlus.Execute();
     var prevObjMonth = 0;
     var WrtMinus618 = 0, Minus618 = null;
     var WrtMinus619 = 0, Minus619 = null;
     var AddPSnnn15 = $0;
     var stat = DataSetPlus.moveNext();
     while(stat)
       var MinusKindsStr = "";
       var MinusOrderByStr = "";
       var PSnnn = 0;
       var PSCode = "";
       
       MinusOrderByStr = "";
       if(DataSetPlus.PlusKind == TXOBJ_PLUSG_1010)
         PSCode = "1010";
         MinusKindsStr = "";
       elif((DataSetPlus.PlusKind == TXOBJ_PLUSG_1011) or (DataSetPlus.PlusKind == TXOBJ_PLUSG_1011_1) or (DataSetPlus.PlusKind == TXOBJ_PLUSG_1011_2) or (DataSetPlus.PlusKind == TXOBJ_PLUSG_1011_3))
         PSCode = "1011";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1110)
         PSCode = "1110";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_3023)
         PSCode = "3023";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1530)
         PSCode = "1530";
         MinusKindsStr = TXOBJ_MINUSG_201+","+TXOBJ_MINUSG_208+","+TXOBJ_MINUSG_218+","+TXOBJ_MINUSG_222+","+TXOBJ_MINUSG_618;
         MinusOrderByStr =   "(case when q.t_Kind = " + TXOBJ_MINUSG_201 + " then 1 "
                           + "      when q.t_Kind = " + TXOBJ_MINUSG_218 + " then 2 "
                           + "      when q.t_Kind = " + TXOBJ_MINUSG_222 + " then 3 "
                           + "      when q.t_Kind = " + TXOBJ_MINUSG_208 + " then 4 "
                           + "      when q.t_Kind = " + TXOBJ_MINUSG_618 + " then 5 "
                           + "      else 0 end ) ";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1531)
         PSCode = "1531";
         MinusKindsStr = TXOBJ_MINUSG_202+","+TXOBJ_MINUSG_219+","+TXOBJ_MINUSG_223;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1532)
         PSCode = "1532";
         MinusKindsStr = TXOBJ_MINUSG_205+","+TXOBJ_MINUSG_206+","+TXOBJ_MINUSG_209;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1533)
         PSCode = "1533";
         MinusKindsStr = TXOBJ_MINUSG_220;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1535)
         PSCode = "1535";
         MinusKindsStr = TXOBJ_MINUSG_207+","+TXOBJ_MINUSG_210;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1536)
         PSCode = "1536";
         MinusKindsStr = TXOBJ_MINUSG_203+","+TXOBJ_MINUSG_224;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1537)
         PSCode = "1537";
         MinusKindsStr = TXOBJ_MINUSG_211;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1539)
         PSCode = "1539";
         MinusKindsStr = TXOBJ_MINUSG_213;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_2640)
         PSCode = "2640";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_2641)
         PSCode = "2641";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_2800)
         PSCode = "2800";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_4800)
         PSCode = "4800";
         MinusKindsStr = "";
       elif((DataSetPlus.PlusKind == TXOBJ_PLUSG_1011_IIS) or (DataSetPlus.PlusKind == TXOBJ_PLUSG_1011_1_IIS) or (DataSetPlus.PlusKind == TXOBJ_PLUSG_1011_2_IIS) or (DataSetPlus.PlusKind == TXOBJ_PLUSG_1011_3_IIS))
         PSCode = "1011";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_3023_IIS)
         PSCode = "3023";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1544)
         PSCode = "1544";
         MinusKindsStr = TXOBJ_MINUSG_225+","+TXOBJ_MINUSG_233+","+TXOBJ_MINUSG_239+","+TXOBJ_MINUSG_251+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1545)
         PSCode = "1545";
         MinusKindsStr = TXOBJ_MINUSG_226+","+TXOBJ_MINUSG_234+","+TXOBJ_MINUSG_240+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1546)
         PSCode = "1546";
         MinusKindsStr = TXOBJ_MINUSG_228+","+TXOBJ_MINUSG_250+","+TXOBJ_MINUSG_252+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1547)
         PSCode = "1547";
         MinusKindsStr = TXOBJ_MINUSG_235+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1548)
         PSCode = "1548";
         MinusKindsStr = TXOBJ_MINUSG_229+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1549)
         PSCode = "1549";
         MinusKindsStr = TXOBJ_MINUSG_227+","+TXOBJ_MINUSG_236+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1551)
         PSCode = "1551";
         MinusKindsStr = TXOBJ_MINUSG_230+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_1553)
         PSCode = "1553";
         MinusKindsStr = TXOBJ_MINUSG_231+","+TXOBJ_MINUSG_619;
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_2640_IIS)
         PSCode = "2640";
         MinusKindsStr = "";
       elif(DataSetPlus.PlusKind == TXOBJ_PLUSG_2641_IIS)
         PSCode = "2641";
         MinusKindsStr = "";
       end;
       
       var SumMinus = $0;
       if(MinusKindsStr != "")
         queryMinus =   "with k as (select t_Element, t_Code from dnptxkind_dbt where t_Element IN ("+MinusKindsStr+"))"
                      + " select q.t_Kind as MinusKind, q.t_Code as MinusCode, NVL(SUM(q.t_Sum0), 0) as MinusSum "
                      + "   from (select obj.t_ObjID, obj.t_Sum0, obj.t_Kind, k.t_Code "
                      + "           from k, dnptxobj_dbt obj "
                      + "          where obj.t_Client = ? "
                      + "            and obj.t_Date between ? and ? "
                      + "            and Extract(month from obj.t_Date) = ? "
                      + "            and obj.t_Kind = k.t_Element "
                      + "            and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                      + "            and (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst is null) "
                      + "         union "
                      + "         select obj.t_ObjID, obj.t_Sum0, obj.t_Kind, k.t_Code "
                      + "           from k, dnptxobj_dbt obj "
                      + "          where obj.t_Client = ? "
                      + "            and obj.t_Date between ? and ? "
                      + "            and Extract(month from obj.t_Date) <> ? "
                      + "            and obj.t_Kind = k.t_Element "
                      + "            and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                      + "            and (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst is null) "
                      + "            and 1 = (case when obj.t_Kind <> "+TXOBJ_MINUSG_619+" and "
                      + "                               not Exists(select 1 "
                      + "                                            from dnptxobj_dbt obj_plus "
                      + "                                           where obj_plus.t_Client = obj.t_Client "
                      + "                                             and obj_plus.t_Date between ? and ? "
                      + "                                             and Extract(month from obj_plus.t_Date) = Extract(month from obj.t_Date) "
                      + "                                             and obj_plus.t_Kind = ? "
                      + "                                             and (obj_plus.t_Technical = CHR(0) or obj_plus.t_Technical is null) "
                      + "                                             and (obj_plus.t_FromOutSyst = CHR(0) or obj_plus.t_FromOutSyst is null) "
                      + "                                         ) then 1 "
                      + "                          when obj.t_Kind = "+TXOBJ_MINUSG_619+" and "
                      + "                               not Exists(select 1 "
                      + "                                            from dnptxobj_dbt obj_plus "
                      + "                                           where obj_plus.t_Client = obj.t_Client "
                      + "                                             and obj_plus.t_Date between ? and ? "
                      + "                                             and Extract(month from obj_plus.t_Date) = Extract(month from obj.t_Date) "
                      + "                                             and obj_plus.t_Kind in (select t_Element from dnptxkind_dbt where t_Level in (5) and t_Code like 'PlusG%' and t_TaxBaseKind = 5) "
                      + "                                             and (obj_plus.t_Technical = CHR(0) or obj_plus.t_Technical is null) "
                      + "                                             and (obj_plus.t_FromOutSyst = CHR(0) or obj_plus.t_FromOutSyst is null) "
                      + "                                         ) then 1 "
                      + "                    else 0 end) "
                      + "            and ? = (select max(Extract(month from obj_plus.t_Date)) "
                      + "                       from dnptxobj_dbt obj_plus "
                      + "                      where obj_plus.t_Client = obj.t_Client "
                      + "                        and obj_plus.t_Date between ? and ? "
                      + "                        and 1 = (case when obj.t_Kind <> "+TXOBJ_MINUSG_619+" and obj_plus.t_Kind = ? then 1 "
                      + "                                      when obj.t_Kind = "+TXOBJ_MINUSG_619+" and obj_plus.t_Kind in (select t_Element from dnptxkind_dbt where t_Level in (5) and t_Code like 'PlusG%' and t_TaxBaseKind = 5) then 1 "
                      + "                                      else 0 end)"
                      + "                        and (obj_plus.t_Technical = CHR(0) or obj_plus.t_Technical is null) "
                      + "                        and (obj_plus.t_FromOutSyst = CHR(0) or obj_plus.t_FromOutSyst is null) "
                      + "                    ) "
                      + "        ) q " 
                      + "  group by q.t_Kind, q.t_Code "
                      + "  order by (case when q.t_Kind = "+TXOBJ_MINUSG_618+" or q.t_Kind = "+TXOBJ_MINUSG_619+" then 1 else 0 end) ASC, "+IIF(MinusOrderByStr != "", MinusOrderByStr, "q.t_Code")+" ASC ";

         cmdMinus = DL_RSDCommand(queryMinus);

         cmdMinus.AddParam(ClientID);
         cmdMinus.AddParam(m_BeginDate);
         cmdMinus.AddParam(m_EndDate);
         cmdMinus.AddParam(int(DataSetPlus.ObjMonth));
         cmdMinus.AddParam(ClientID);
         cmdMinus.AddParam(m_BeginDate);
         cmdMinus.AddParam(m_EndDate);
         cmdMinus.AddParam(int(DataSetPlus.ObjMonth));
         cmdMinus.AddParam(m_BeginDate);
         cmdMinus.AddParam(m_EndDate);
         cmdMinus.AddParam(DataSetPlus.PlusKind);
         cmdMinus.AddParam(m_BeginDate);
         cmdMinus.AddParam(m_EndDate);
         cmdMinus.AddParam(int(DataSetPlus.ObjMonth));
         cmdMinus.AddParam(m_BeginDate);
         cmdMinus.AddParam(m_EndDate);
         cmdMinus.AddParam(DataSetPlus.PlusKind);

         DataSetMinus = cmdMinus.Execute();
         var RestPlusSum = ExtRound(DataSetPlus.PlusSum);
         while(DataSetMinus.moveNext())
           var MSnnn = ExtRound(DataSetMinus.MinusSum);
           var MSCode = "";

           if(MSnnn != 0)
             if(DataSetMinus.MinusKind == TXOBJ_MINUSG_618)
               if(Minus618 == null)
                 Minus618 = MSnnn;
               end;
               MSnnn = MSnnn - WrtMinus618;
               
               MSnnn = min(max(RestPlusSum, 0), MSnnn);

               WrtMinus618 = WrtMinus618 + MSnnn;
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_619)
               if(Minus619 == null)
                 Minus619 = MSnnn;
               end;
               
               MSnnn = MSnnn - WrtMinus619;
               
               MSnnn = min(max(RestPlusSum, 0), MSnnn);

               WrtMinus619 = WrtMinus619 + MSnnn;
             end;

             RestPlusSum = RestPlusSum - MSnnn;

             SumMinus = SumMinus + MSnnn;

             MSCode = "";
             if(DataSetMinus.MinusKind == TXOBJ_MINUSG_201)
               MSCode = "201";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_208)
               MSCode = "208";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_218)
               MSCode = "218";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_222)
               MSCode = "222";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_618)
               MSCode = "618";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_202)
               MSCode = "202";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_219)
               MSCode = "219";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_223)
               MSCode = "223";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_205)
               MSCode = "205";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_206)
               MSCode = "206";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_209)
               MSCode = "209";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_220)
               MSCode = "220";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_207)
               MSCode = "207";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_210)
               MSCode = "210";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_203)
               MSCode = "203";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_224)
               MSCode = "224";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_211)
               MSCode = "211";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_213)
               MSCode = "213";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_225)
               MSCode = "225";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_233)
               MSCode = "233";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_239)
               MSCode = "239";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_251)
               MSCode = "251";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_619)
               MSCode = "619";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_226)
               MSCode = "226";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_234)
               MSCode = "234";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_240)
               MSCode = "240";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_228)
               MSCode = "228";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_250)
               MSCode = "250";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_252)
               MSCode = "252";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_235)
               MSCode = "235";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_229)
               MSCode = "229";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_227)
               MSCode = "227";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_236)
               MSCode = "236";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_231)
               MSCode = "231";
             elif(DataSetMinus.MinusKind == TXOBJ_MINUSG_230)
               MSCode = "230";
             end;
             
             AddInArrCodeParms(AllArrCodeParm, int(DataSetPlus.ObjMonth), PSCode, $0, MSCode, MSnnn, 0.0, 0.0, 0.0, 0.0, 0.0, Rate, 0.0,
                               0.0, 0.0, 0.0, IsHighRate, 0.0, 0.0, true, true, true,
                               null, null, KBK, 0.0);
           end;
           
         end;
       end;

       PSnnn = ExtRound(DataSetPlus.PlusSum);
       if(PSnnn != 0)
         AddInArrCodeParms(AllArrCodeParm, int(DataSetPlus.ObjMonth), PSCode, PSnnn, NULL, NULL, 0.0, 0.0, 0.0, 0.0, 0.0, Rate, 0.0,
                             0.0, 0.0, 0.0, IsHighRate, 0.0, 0.0, true, true, true,
                             null, null, KBK, 0.0);
       end;


       prevObjMonth = int(DataSetPlus.ObjMonth);

       stat = DataSetPlus.moveNext();

       if((not stat) or (prevObjMonth != int(DataSetPlus.ObjMonth)))
         var delta = 0;
         
         if(Minus618 != null)
           delta = ExtRound(Minus618 - WrtMinus618);

           if(delta > 0)
             ArrNotWrtMinus618[ArrNotWrtMinus618.size] = TNotWrtMinusData(prevObjMonth, "618", delta);
           end;
         end;

         if(Minus619 != null)
           delta = ExtRound(Minus619 - WrtMinus619);

           if(delta > 0)
             ArrNotWrtMinus619[ArrNotWrtMinus619.size] = TNotWrtMinusData(prevObjMonth, "619", delta);
           end;
         end;

         WrtMinus618 = 0;
         WrtMinus619 = 0;
         Minus618 = null;
         Minus619 = null;
       end;

     end;
     
     var s = 0, d = 0, g = 0;
     if(ArrNotWrtMinus618.size > 0)
       CalcNPTXPIT2General(@AllArrCodeParm, Rate, IsHighRate, KBK, ClientID, LastName, FirstName, MiddleName);
       
       s = IndexOfRate(AllArrCodeParm, Rate, IsHighRate, KBK);
       if(s >= 0)
         g = 0;
         while(g < ArrNotWrtMinus618.size)
           delta = ArrNotWrtMinus618[g].NotWrtSum;
           
           d = AllArrCodeParm[s].NPTXCodeParmArr.size - 1;
           while((d >= 0) and (delta > 0))

             sumMinus = 0;
             if(AllArrCodeParm[s].NPTXCodeParmArr[d].Month <= ArrNotWrtMinus618[g].Month)
               if(AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1530")

                 sumMinus = AllArrCodeParm[s].NPTXCodeParmArr[d].GetMinusSum();

                 if(AllArrCodeParm[s].NPTXCodeParmArr[d].PSnnn > sumMinus)
                   MSnnn = min(delta, (AllArrCodeParm[s].NPTXCodeParmArr[d].PSnnn - sumMinus));
                   delta = delta - MSnnn;

                   AddInArrCodeParms(AllArrCodeParm, AllArrCodeParm[s].NPTXCodeParmArr[d].Month, AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode, $0, "618", MSnnn, 0.0, 0.0, 0.0, 0.0, 0.0, Rate, 0.0,
                                     0.0, 0.0, 0.0, IsHighRate, 0.0, 0.0, true, true, true,
                                     null, null, KBK, 0.0);

                 end;
               end;
             end;
             d = d - 1;
           end;

           g = g + 1;
         end;
       end;
     end;

     if(ArrNotWrtMinus619.size > 0)
       CalcNPTXPIT2General(@AllArrCodeParm, Rate, IsHighRate, KBK, ClientID, LastName, FirstName, MiddleName);
       
       s = IndexOfRate(AllArrCodeParm, Rate, IsHighRate, KBK);
       if(s >= 0)
         g = 0;
         while(g < ArrNotWrtMinus619.size)
           delta = ArrNotWrtMinus619[g].NotWrtSum;
           
           d = AllArrCodeParm[s].NPTXCodeParmArr.size - 1;
           while((d >= 0) and (delta > 0))

             sumMinus = 0;
             if(AllArrCodeParm[s].NPTXCodeParmArr[d].Month <= ArrNotWrtMinus619[g].Month)
               if((AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1544") or
                  (AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1545") or
                  (AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1546") or
                  (AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1547") or
                  (AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1548") or
                  (AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1549") or
                  (AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1551") or
                  (AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode == "1553")  
                 )

                 sumMinus = AllArrCodeParm[s].NPTXCodeParmArr[d].GetMinusSum();

                 if(AllArrCodeParm[s].NPTXCodeParmArr[d].PSnnn > sumMinus)
                   MSnnn = min(delta, (AllArrCodeParm[s].NPTXCodeParmArr[d].PSnnn - sumMinus));
                   delta = delta - MSnnn;

                   AddInArrCodeParms(AllArrCodeParm, AllArrCodeParm[s].NPTXCodeParmArr[d].Month, AllArrCodeParm[s].NPTXCodeParmArr[d].PSCode, $0, "619", MSnnn, 0.0, 0.0, 0.0, 0.0, 0.0, Rate, 0.0,
                                     0.0, 0.0, 0.0, IsHighRate, 0.0, 0.0, true, true, true,
                                     null, null, KBK, 0.0);

                 end;
               end;
             end;
             d = d - 1;
           end;

           g = g + 1;
         end;
       end;
     end;

     CalcNPTXPIT2General(@AllArrCodeParm, Rate, IsHighRate, KBK, ClientID, LastName, FirstName, MiddleName);
     
   end;


   /**
      @brief Получает массив с данными по клиентам (для приложения 1 и для справки для выдачи клиентам)
      @return TArray
   */
   macro GetNPTXPayerInfoArr():TArray
      var CountFLPart2 = 0;
      var NPTXPayerInfoArr = TArray();
      var queryClients, cmdClients, DataSetClients;
      var queryKBK, cmdKBK, DataSetKBK;
      var RateIndex = -1;
      var PartyNum = 0;
      var Year = 0;
      var i = 0;
      var num = 0;         

      var TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_ONB + ", " + NPTXTOTALBASE_TAXBASEKIND_BROK + "," + NPTXTOTALBASE_TAXBASEKIND_IIS + ",0";
      var ObjTaxBaseKind = "0,2,3,5,9";

      if((m_ByCB) and (not m_ByVS))
        TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_BROK + "," + NPTXTOTALBASE_TAXBASEKIND_IIS + ",0";
        ObjTaxBaseKind = "0,2,3,5";
      elif((not m_ByCB) and (m_ByVS))
        TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_ONB;
        ObjTaxBaseKind = "9";
      end;

      FillQDates(m_EndDate);

      datesplit(m_EndDate, null, null, Year);

      cmdClients = DL_RSDCommand();

      queryClients =   " select COUNT(1) OVER() as t_Count, " 
                     + "        persn.t_PersonID as ClientID, " 
                     + "        persn.t_Name1 as t_LastName, "
                     + "        persn.t_Name2 as t_FirstName, "
                     + "        persn.t_Name3 as t_MiddleName, "
                     + "        persn.t_Born as t_BirthDate, "
                     + "        NVL(RSB_SECUR.SC_GetObjCodeOnDate("+OBJTYPE_PARTY+", "+PTCK_INN+", persn.t_PersonID), CHR(1)) AS t_ClientINN, "
                     + "        NVL(RSB_SECUR.SC_GetObjCodeOnDate("+OBJTYPE_PARTY+", 101 /*Код ЦФТ*/, persn.t_PersonID), CHR(1)) as ID_CFT, "
                     + "        RSI_NPTX.ResidenceStatus(persn.t_PersonID, ?) as t_ResidenceStatus, "
                     + "        NVL((select sum(obj.t_Sum0) "
                     + "               from dnptxobj_dbt obj "
                     + "              where obj.t_Client = persn.t_PersonID "
                     + "                and obj.t_Kind in (select k.t_Element from dnptxkind_dbt k where k.t_Level in (5) and k.t_Code like 'PlusG%' and k.t_TaxBaseKind in ("+ObjTaxBaseKind+")) "
                     + "                and obj.t_Date between ? and ? "
                     + "                and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                     + "                and (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst is null) "
                     + "            and 1 = (case when obj.t_Kind = " + TXOBJ_PLUSG_1011 + " and obj.t_Sum0 = NVL((select SUM(obj1.t_Sum0) "
                     + "                                                                                  from dnptxobj_dbt obj1 "
                     + "                                                                                 where obj1.t_Client = obj.t_Client "
                     + "                                                                                   and obj1.t_Date = obj.t_Date " 
                     + "                                                                                   and obj1.t_Kind IN ("+TXOBJ_PLUSG_1011_1+","+TXOBJ_PLUSG_1011_2+","+TXOBJ_PLUSG_1011_3+")"
                     + "                                                                                   and obj1.t_AnaliticKind6 = obj.t_AnaliticKind6 "   
                     + "                                                                                   and obj1.t_Analitic6 = obj.t_Analitic6 "
                     + "                                                                                   and obj1.t_OutSystCode = obj.t_OutSystCode "
                     + "                                                                                   and obj1.t_OutObjID = obj.t_OutObjID "
                     + "                                                                                   and (obj1.t_Technical = CHR(0) or obj1.t_Technical is null) "
                     + "                                                                                   and (obj1.t_FromOutSyst = CHR(0) or obj1.t_FromOutSyst is null) "
                     + "                                                                               ),0) then 0 "
                     + "                          else 1 end) "
                     + "            and 1 = (case when obj.t_Kind = " + TXOBJ_PLUSG_1011_IIS + " and obj.t_Sum0 = NVL((select SUM(obj1.t_Sum0) "
                     + "                                                                                      from dnptxobj_dbt obj1 "
                     + "                                                                                     where obj1.t_Client = obj.t_Client "
                     + "                                                                                       and obj1.t_Date = obj.t_Date "
                     + "                                                                                       and obj1.t_Kind IN ("+TXOBJ_PLUSG_1011_1_IIS+","+TXOBJ_PLUSG_1011_2_IIS+","+TXOBJ_PLUSG_1011_3_IIS+")"
                     + "                                                                                       and obj1.t_AnaliticKind6 = obj.t_AnaliticKind6 "
                     + "                                                                                       and obj1.t_Analitic6 = obj.t_Analitic6 "
                     + "                                                                                       and obj1.t_OutSystCode = obj.t_OutSystCode "
                     + "                                                                                       and obj1.t_OutObjID = obj.t_OutObjID "
                     + "                                                                                       and (obj1.t_Technical = CHR(0) or obj1.t_Technical is null) "
                     + "                                                                                       and (obj1.t_FromOutSyst = CHR(0) or obj1.t_FromOutSyst is null) "
                     + "                                                                                   ),0) then 0 "
                     + "                          else 1 end) "
                     + "            ), 0) as PlusG2_9, "
                     + "        NVL((select sum(obj.t_Sum0) "
                     + "               from dnptxobj_dbt obj "
                     + "              where obj.t_Client = persn.t_PersonID "
                     + "                and obj.t_Kind in (select k.t_Element from dnptxkind_dbt k where k.t_Level in (5,6,7) and k.t_Code like 'MinusG%' and (k.t_TaxBaseKind in ("+ObjTaxBaseKind+") or k.t_Element in ("+TXOBJ_MINUSG_618+","+TXOBJ_MINUSG_619+"))) "
                     + "                and obj.t_Date between ? and ? "
                     + "                and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                     + "                and (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst is null) "
                     + "            ), 0) as MInusG2_9 "
                     + "   from dpersn_dbt persn "
                     + "  where persn.t_PersonID in (select t_PartyID from dnptx6client_tmp) "
                     + "    and (exists(select 1 "
                     + "                  from dnptxtotalbase_dbt tb "
                     + "                 where tb.t_ClientID = persn.t_PersonID "
                     + "                   and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                     + "                   and tb.t_Type IN (1,2,3) "
                     + "                   and ((tb.t_IncDate between ? and ?) or (tb.t_TaxPeriod = ? and EXTRACT(YEAR FROM tb.t_IncDate) <> ?) and ? = TO_DATE('31.12.'||TO_CHAR(tb.t_TaxPeriod),'DD.MM.YYYY'))"
                     + "                   and tb.t_TaxBaseKind IN ("+TaxBaseKind+")";

      if((m_IsSOFR) and (not m_IsDiasoft))
        queryClients = queryClients + "    and instr(UPPER(tb.t_Description), UPPER('Диасофт')) = 0 ";
      elif((not m_IsSOFR) and (m_IsDiasoft))
        queryClients = queryClients + "    and instr(UPPER(tb.t_Description), UPPER('Диасофт')) <> 0 ";
      end;

      queryClients = queryClients + "  ) ";

      cmdClients.AddParam(m_EndDate);
      cmdClients.AddParam(m_BeginDate);
      cmdClients.AddParam(m_EndDate);
      cmdClients.AddParam(m_BeginDate);
      cmdClients.AddParam(m_EndDate);
      cmdClients.AddParam(m_BeginDate);
      cmdClients.AddParam(m_EndDate);
      cmdClients.AddParam(Year);
      cmdClients.AddParam(Year);
      cmdClients.AddParam(m_EndDate);

      if(m_IsSOFR)
        queryClients = queryClients
                     + "          or exists(select 1"
                     + "                      from dnptxobj_dbt obj "
                     + "                     where obj.t_Client = persn.t_PersonID "
                     + "                       and obj.t_Kind in (select k.t_Element from dnptxkind_dbt k where k.t_Level in (5) and k.t_Code like 'PlusG%' and k.t_TaxBaseKind in ("+ObjTaxBaseKind+")) "
                     + "                       and obj.t_Date between ? and ? "
                     + "                       and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                     + "                       and (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst is null) "
                     + "                   ) ";

        cmdClients.AddParam(m_BeginDate);
        cmdClients.AddParam(m_EndDate);
      end;

      queryClients = queryClients 
                     + "        ) ";

      
      
      DataSetClients = cmdClients.Execute(queryClients);
      while(DataSetClients.moveNext())
        var arrKBKData = TArray();
        var ArrCodeParm = TArray();

        var Доход2_9  = DataSetClients.PlusG2_9;
        var Расход2_9 = DataSetClients.MinusG2_9;
        var НОБ_Осн   = $0;
        var НОБ_15    = $0;

        ClearDataClient();

        if(num == 0)
          CountFLPart2 = int(DataSetClients.Count);
          InitProgress(CountFLPart2, "Подготовка данных для "+IIF(m_IsPart2, "раздела 2", "Приложения 1"), "Подготовка данных для "+IIF(m_IsPart2, "раздела 2", "Приложения 1"));
        end;

        var subqueryTaxPaid = " NVL(SUM(case when tb.t_IncDate between ? and ? then (select (case when ((tb.t_Type IN (1,2) and tb.t_HoldPITax > 0) or (tb.t_Type IN (3) and tb.t_HoldPITax <> 0)) and tb.t_TaxPeriod = ? then tb.t_HoldPITax "
                                                                                + "               when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? and tb.t_IncDate between ? and ? then tb.t_HoldPITax "
                                                                                + "               when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? and tb.t_IncDate between TO_DATE('01.01.'||EXTRACT(Year from rc.t_DatePart2),'DD.MM.YYYY') and rc.t_DatePart2 then tb.t_HoldPITax "
                                                                                + "               else 0 end) from dual) "
                            + "              else 0 end), 0) ";

        var subqueryTaxPaid6 = " NVL(SUM(case when (tb.t_IncDate between ? and ?) or (? = TO_DATE('31.12.'||TO_CHAR(?),'DD.MM.YYYY') and EXTRACT(YEAR FROM tb.t_IncDate) <> ? and tb.t_TaxPeriod = ?) "
                                                   + " then (select (case when ((tb.t_Type IN (1,2) and tb.t_HoldPITax > 0) or (tb.t_Type IN (3) and tb.t_HoldPITax <> 0)) and tb.t_TaxPeriod = ? then tb.t_HoldPITax "
                                                   + "               when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? and tb.t_IncDate between ? and ? then tb.t_HoldPITax "
                                                   + "               when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? and tb.t_IncDate between TO_DATE('01.01.'||EXTRACT(Year from rc.t_DatePart2),'DD.MM.YYYY') and rc.t_DatePart2 then tb.t_HoldPITax "
                                                   + "               else 0 end) from dual) "
                             + "              else 0 end), 0) ";


        var subqueryTaxRet =   " ABS(NVL(SUM(case when tb.t_IncDate between ? and ? then (select (case when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_IncDate > rc.t_DatePart2 and tb.t_TaxPeriod < ? then tb.t_HoldPITax else 0 end) from dual) "
                             + "                  else 0 end), 0)) ";

        queryKBK =   " select q.t_BCCHoldPITax, q.t_RateHoldPITax, "
                   + "        NVL(SUM(q.TaxBase), 0) as TaxBase, "
                   + "        NVL(SUM(q.TaxPaid), 0) as TaxPaid, "
                   + "        NVL(SUM(q.TaxPaid1Data), 0) as TaxPaid1Data, "
                   + "        NVL(SUM(q.TaxPaid2Data), 0) as TaxPaid2Data, "
                   + "        NVL(SUM(q.TaxPaid3Data), 0) as TaxPaid3Data, "
                   + "        NVL(SUM(q.TaxPaid4Data), 0) as TaxPaid4Data, "
                   + "        NVL(SUM(q.TaxPaid5Data), 0) as TaxPaid5Data, "
                   + "        NVL(SUM(q.TaxPaid6Data), 0) as TaxPaid6Data, "
                   + "        NVL(SUM(q.TaxToReturnDue), 0) as TaxToReturnDue, "
                   + "        NVL(SUM(q.TaxToReturn1Data), 0) as TaxToReturn1Data, "
                   + "        NVL(SUM(q.TaxToReturn2Data), 0) as TaxToReturn2Data, "
                   + "        NVL(SUM(q.TaxToReturn3Data), 0) as TaxToReturn3Data, "
                   + "        NVL(SUM(q.TaxToReturn4Data), 0) as TaxToReturn4Data, "
                   + "        NVL(SUM(q.TaxToReturn5Data), 0) as TaxToReturn5Data, "
                   + "        NVL(SUM(q.TaxToReturn6Data), 0) as TaxToReturn6Data, "
                   + "        NVL(SUM(q.TaxRefund), 0) as TaxRefund "
                   + "   from ( select tb.t_BCCHoldPITax, tb.t_RateHoldPITax, "
                   + "                 NVL(SUM(tb.t_TaxBaseCurrPay), 0) as TaxBase, "
                   + "                 NVL(SUM(case when ((tb.t_Type IN (1,2) and tb.t_HoldPITax > 0) or (tb.t_Type IN (3) and tb.t_HoldPITax <> 0)) and tb.t_TaxPeriod = ? then tb.t_HoldPITax "
                   + "                              when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? and tb.t_IncDate between ? and ? then tb.t_HoldPITax "
                   + "                              when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_TaxPeriod = ? and tb.t_IncDate between TO_DATE('01.01.'||EXTRACT(Year from rc.t_DatePart2),'DD.MM.YYYY') and rc.t_DatePart2 then tb.t_HoldPITax "
                   + "                              else 0 end), 0) as TaxPaid, "
                   +                   subqueryTaxPaid  + " as TaxPaid1Data, "
                   +                   subqueryTaxPaid  + " as TaxPaid2Data, "
                   +                   subqueryTaxPaid  + " as TaxPaid3Data, "
                   +                   subqueryTaxPaid  + " as TaxPaid4Data, "
                   +                   subqueryTaxPaid  + " as TaxPaid5Data, "
                   +                   subqueryTaxPaid6 + " as TaxPaid6Data, "
                   + "                 ABS(NVL(SUM(case when tb.t_Type = 2 and tb.t_HoldPITax < 0 and tb.t_IncDate > rc.t_DatePart2 and tb.t_TaxPeriod < ? then tb.t_HoldPITax else 0 end), 0)) as TaxToReturnDue, "
                   +                   subqueryTaxRet + " as TaxToReturn1Data, "
                   +                   subqueryTaxRet + " as TaxToReturn2Data, "
                   +                   subqueryTaxRet + " as TaxToReturn3Data, "
                   +                   subqueryTaxRet + " as TaxToReturn4Data, "
                   +                   subqueryTaxRet + " as TaxToReturn5Data, "
                   +                   subqueryTaxRet + " as TaxToReturn6Data, "
                   + "                 0 as TaxRefund "
                   + "            from dnptxtotalbase_dbt tb, dnptxretconf_tmp rc "
                   + "           where tb.t_ClientID = ? "
                   + "             and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                   + "             and tb.t_Type IN (1,2,3) "
                   + "             and ((tb.t_IncDate between ? and ?) or (tb.t_TaxPeriod = ? and EXTRACT(YEAR FROM tb.t_IncDate) <> ?) and ? = TO_DATE('31.12.'||TO_CHAR(tb.t_TaxPeriod),'DD.MM.YYYY'))"
                   + "             and tb.t_TaxBaseKind IN ("+TaxBaseKind+")"
                   + "             and rc.t_TaxPeriod = tb.t_TaxPeriod ";

        if((m_IsSOFR) and (not m_IsDiasoft))
          queryKBK = queryKBK + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) = 0 ";
        elif((not m_IsSOFR) and (m_IsDiasoft))
          queryKBK = queryKBK + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) <> 0 ";
        end;

        queryKBK = queryKBK + " group by tb.t_BCCHoldPITax, tb.t_RateHoldPITax ";



        queryKBK = queryKBK + " UNION "
                   + "          select tb.t_BCCHoldPITax, tb.t_RateHoldPITax, "
                   + "                 0 as TaxBase, "
                   + "                 0 as TaxPaid, "
                   + "                 0 as TaxPaid1Data, "
                   + "                 0 as TaxPaid2Data, "
                   + "                 0 as TaxPaid3Data, "
                   + "                 0 as TaxPaid4Data, "
                   + "                 0 as TaxPaid5Data, "
                   + "                 0 as TaxPaid6Data, "
                   + "                 0 as TaxToReturnDue, "
                   + "                 0 as TaxToReturn1Data, "
                   + "                 0 as TaxToReturn2Data, "
                   + "                 0 as TaxToReturn3Data, "
                   + "                 0 as TaxToReturn4Data, "
                   + "                 0 as TaxToReturn5Data, "
                   + "                 0 as TaxToReturn6Data, "
                   + "                 SUM(tb.t_HoldPITax) as TaxRefund "
                   + "            from dnptxtotalbase_dbt tb "
                   + "           where tb.t_ClientID = ? "
                   + "             and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                   + "             and tb.t_Type IN (2) "
                   + "             and EXTRACT(YEAR FROM tb.t_IncDate) <> ? "
                   + "             and tb.t_TaxPeriod = ? "
                   + "             and tb.t_HoldPITax < 0 "
                   + "             and tb.t_TaxBaseKind IN ("+TaxBaseKind+") "
                   + "             and NOT EXISTS(select 1 "
                   + "                              from dnptxretconf_tmp rc "
                   + "                             where rc.t_TaxPeriod = tb.t_TaxPeriod "
                   + "                               and tb.t_IncDate between TO_DATE('01.01.'||EXTRACT(Year from rc.t_DatePart2),'DD.MM.YYYY') and rc.t_DatePart2 "
                   + "                           ) ";

        if((m_IsSOFR) and (not m_IsDiasoft))
          queryKBK = queryKBK + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) = 0 ";
        elif((not m_IsSOFR) and (m_IsDiasoft))
          queryKBK = queryKBK + " and instr(UPPER(tb.t_Description), UPPER('Диасофт')) <> 0 ";
        end;

        queryKBK = queryKBK + " group by tb.t_BCCHoldPITax, tb.t_RateHoldPITax ";


        queryKBK = queryKBK + ") q "
                            + " group by q.t_BCCHoldPITax, q.t_RateHoldPITax "
                            + " order by q.t_BCCHoldPITax ASC, q.t_RateHoldPITax ASC ";


        cmdKBK = DL_RSDCommand(queryKBK);

        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate021);
        cmdKBK.AddParam(EndDate021);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate022);
        cmdKBK.AddParam(EndDate022);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate023);
        cmdKBK.AddParam(EndDate023);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate024);
        cmdKBK.AddParam(EndDate024);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate025);
        cmdKBK.AddParam(EndDate025);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate026);
        cmdKBK.AddParam(EndDate026);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate021);
        cmdKBK.AddParam(EndDate021);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate022);
        cmdKBK.AddParam(EndDate022);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate023);
        cmdKBK.AddParam(EndDate023);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate024);
        cmdKBK.AddParam(EndDate024);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate025);
        cmdKBK.AddParam(EndDate025);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(BeginDate026);
        cmdKBK.AddParam(EndDate026);
        cmdKBK.AddParam(Year);

        cmdKBK.AddParam(DataSetClients.ClientID);
        cmdKBK.AddParam(m_BeginDate);
        cmdKBK.AddParam(m_EndDate);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(m_EndDate);

        cmdKBK.AddParam(DataSetClients.ClientID);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        
        DataSetKBK = cmdKBK.Execute();
        
        var arrKBK = TArray();
        var ContinueClient = false;
        while(DataSetKBK.moveNext())
          i = arrKBK.size;

          if((ExtRound(DataSetKBK.TaxBase) != 0) or 
             (ExtRound(DataSetKBK.TaxPaid) != 0) or
             (ExtRound(DataSetKBK.TaxToReturnDue) != 0) or
             (DataSetKBK.TaxPaid1Data != 0) or 
             (DataSetKBK.TaxPaid2Data != 0) or 
             (DataSetKBK.TaxPaid3Data != 0) or 
             (DataSetKBK.TaxPaid4Data != 0) or 
             (DataSetKBK.TaxPaid5Data != 0) or 
             (DataSetKBK.TaxPaid6Data != 0) or
             (DataSetKBK.TaxToReturn1Data != 0) or 
             (DataSetKBK.TaxToReturn2Data != 0) or 
             (DataSetKBK.TaxToReturn3Data != 0) or 
             (DataSetKBK.TaxToReturn4Data != 0) or 
             (DataSetKBK.TaxToReturn5Data != 0) or 
             (DataSetKBK.TaxToReturn6Data != 0) or
             (DataSetKBK.TaxRefund != 0)
            ) 
            arrKBK[i] = TKBKData(DataSetKBK.BCCHoldPITax, DataSetKBK.RateHoldPITax, ExtRound(DataSetKBK.TaxBase), ExtRound(DataSetKBK.TaxPaid), ExtRound(DataSetKBK.TaxToReturnDue),
                                 DataSetKBK.TaxPaid1Data, DataSetKBK.TaxPaid2Data, DataSetKBK.TaxPaid3Data, DataSetKBK.TaxPaid4Data, DataSetKBK.TaxPaid5Data, DataSetKBK.TaxPaid6Data,
                                 DataSetKBK.TaxToReturn1Data, DataSetKBK.TaxToReturn2Data, DataSetKBK.TaxToReturn3Data, DataSetKBK.TaxToReturn4Data, DataSetKBK.TaxToReturn5Data, DataSetKBK.TaxToReturn6Data,
                                 DataSetKBK.TaxRefund 
                                );
          end;

          if(((DataSetClients.ResidenceStatus == 1) and (DataSetKBK.RateHoldPITax == int(NPTXGENTAXRATE_NOTRESIDENT*100)) and (DataSetKBK.TaxBase != 0)) or
             ((DataSetClients.ResidenceStatus != 1) and (DataSetKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT*100)) and (DataSetKBK.TaxBase != 0))
            )
            msgbox("Ошибка. По клиенту "+DataSetClients.FirstName+" "+DataSetClients.MiddleName+" "+DataSetClients.LastName+" "+DataSetClients.ID_CFT+" не пересчитана НОБ при смене резидентства");
            ContinueClient = true;
          end;


          if(DataSetKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT_15*100))
            НОБ_15 = НОБ_15 + ExtRound(DataSetKBK.TaxBase);
          else
            НОБ_Осн = НОБ_Осн + ExtRound(DataSetKBK.TaxBase);
          end;
        end;

        if(ContinueClient == true)
          continue;
        end;

        if(arrKBK.size > 0)
          if((НОБ_осн <= 0) and (НОБ_15 <= 0) and ((Доход2_9 != 0) or (Расход2_9 != 0)) and (arrKBK[0].KBK != NPTXKBK_MAIN))
            arrKBKData[arrKBKData.size] = TKBKData(NPTXKBK_MAIN, IIF((DataSetClients.ResidenceStatus == 1), int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)), $0, $0, $0,
                                                   $0, $0, $0, $0, $0, $0,
                                                   $0, $0, $0, $0, $0, $0,
                                                   $0
                                                  );
          end;
          i = 0;
          while(i < arrKBK.size)
            arrKBKData[arrKBKData.size] = arrKBK[i];

            i = i + 1;
          end;
        end;

        if(arrKBKData.size == 0)
          arrKBKData[arrKBKData.size] = TKBKData(NPTXKBK_MAIN, IIF((DataSetClients.ResidenceStatus == 1), int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)), $0, $0, $0,
                                                 $0, $0, $0, $0, $0, $0,
                                                 $0, $0, $0, $0, $0, $0,
                                                 $0
                                                );
        end;

        if(round((НОБ_Осн + НОБ_15),2) != round(money(Доход2_9 - Расход2_9),2))
          msgbox("По клиенту "+DataSetClients.FirstName+" "+DataSetClients.MiddleName+" "+DataSetClients.LastName+" "+DataSetClients.ID_CFT+" не совпадают суммы НОБ, рассчитанные по НДР ("+(Доход2_9 - Расход2_9)+") и по хранилищу СНОБ ("+(НОБ_Осн + НОБ_15)+")");
        end;
        
        if((m_IsApp1) or ((НОБ_Осн != 0) and (НОБ_15 != 0)))

          //Формируем суммы доходов и вычетов
          var AllArrCodeParm = TArray();
          CollectAllArrCodeParm(DataSetClients.ClientID, DataSetClients.LastName, DataSetClients.FirstName, DataSetClients.MiddleName, DataSetClients.ResidenceStatus, @AllArrCodeParm);
          if(AllArrCodeParm.size > 0)
            var indP = 0;
            var prevObjMonth = 0;
            var WrtMinus618 = 0, Minus618 = null;
            var WrtMinus619 = 0, Minus619 = null;
            var AddPSnnn15 = $0;
            i = 0;
            var NPTXCodeParmArr = AllArrCodeParm[0].NPTXCodeParmArr;
            while(indP < NPTXCodeParmArr.size)
              var MinusKindsStr = "";
              var MinusOrderByStr = "";
              var PSnnn = 0;
              var PSCode = NPTXCodeParmArr[indP].PSCode;

              if(arrKBKData[i].KBK == NPTXKBK_PROC)
                arrKBKData[i].TotalPlus = $0;
                arrKBKData[i].TotalMinus = $0;
                arrKBKData[i].TaxCalculated = $0;

                i = i + 1;

                if(i == arrKBKData.size)
                  break;
                end;
              end;
              
              var SumMinus = $0;
              if(NPTXCodeParmArr[indP].MinusCodes.size > 0)
                var RestPlusSum = ExtRound(NPTXCodeParmArr[indP].PSnnn);
                var indM = 0;
                while(indM < NPTXCodeParmArr[indP].MinusCodes.size)
                  var MinusCode = NPTXCodeParmArr[indP].MinusCodes[indM];
                  var MSnnn = ExtRound(MinusCode.MSnnn);
                  var MSCode = MinusCode.MSCode;

                  if(MSnnn != 0)

                    RestPlusSum = RestPlusSum - MSnnn;

                    arrKBKData[i].TotalMinus = arrKBKData[i].TotalMinus + MSnnn;

                    SumMinus = SumMinus + MSnnn;
                    
                    RateIndex = AddInArrCodeParms(ArrCodeParm, int(NPTXCodeParmArr[indP].Month), PSCode, $0, MSCode, MSnnn, 0.0, 0.0, 0.0, 0.0, 0.0, arrKBKData[i].Rate, 0.0,
                                                  0.0, 0.0, 0.0, arrKBKData[i].IsHighRate, 0.0, 0.0, true, true, true,
                                                  null, null, arrKBKData[i].KBK, 0.0);
                  end;
                  
                  indM = indM + 1;
                end;
              end;

              PSnnn = ExtRound(NPTXCodeParmArr[indP].PSnnn);
              if((arrKBKData[i].KBK == NPTXKBK_MAIN) and (НОБ_15 != 0))
                if(arrKBKData[i].RestTaxBase > 0)
                  PSnnn = PSnnn - max((ExtRound(NPTXCodeParmArr[indP].PSnnn) - SumMinus) - arrKBKData[i].RestTaxBase, 0);

                  arrKBKData[i].RestTaxBase = arrKBKData[i].RestTaxBase - (PSnnn - SumMinus);

                  AddPSnnn15 = NPTXCodeParmArr[indP].PSnnn - PSnnn;
                end;
              end;

              if(PSnnn != 0)
                
                RateIndex = AddInArrCodeParms(ArrCodeParm, int(NPTXCodeParmArr[indP].Month), PSCode, PSnnn, NULL, NULL, 0.0, 0.0, 0.0, 0.0, 0.0, arrKBKData[i].Rate, 0.0,
                                                0.0, 0.0, 0.0, arrKBKData[i].IsHighRate, 0.0, 0.0, true, true, true,
                                                null, null, arrKBKData[i].KBK, 0.0);
              end;

              if(AddPSnnn15 > 0)
                var j = i;
                while(j < arrKBKData.size)
                  if(arrKBKData[j].KBK == NPTXKBK_15)
                    arrKBKData[j].TotalPlus = arrKBKData[j].TotalPlus + AddPSnnn15;
                    RateIndex = AddInArrCodeParms(ArrCodeParm, int(NPTXCodeParmArr[indP].Month), PSCode, AddPSnnn15, NULL, NULL, 0.0, 0.0, 0.0, 0.0, 0.0, arrKBKData[j].Rate, 0.0,
                                                  0.0, 0.0, 0.0, arrKBKData[j].IsHighRate, 0.0, 0.0, true, true, true,
                                                  null, null, arrKBKData[j].KBK, 0.0);
                  end;

                  j = j + 1;
                end;
              end;

              AddPSnnn15 = $0;

              arrKBKData[i].TotalPlus = arrKBKData[i].TotalPlus + PSnnn;

              if(arrKBKData[i].KBK == NPTXKBK_MAIN)
                if((arrKBKData[i].TaxBase > 0) and (arrKBKData[i].RestTaxBase == 0) and ((i+1) < arrKBKData.size))
                  i = i + 1;
                end;
              end;

              indP = indP + 1;
            end;  //end Plus
          end;
        else

          i = 0;
          while(i < arrKBKData.size)
            if(arrKBKData[i].KBK == NPTXKBK_PROC)
              arrKBKData[i].TotalPlus = $0;
              arrKBKData[i].TotalMinus = $0;
            else
              arrKBKData[i].TotalPlus = Доход2_9;
              arrKBKData[i].TotalMinus = Расход2_9;

              Доход2_9 = $0;
              Расход2_9 = $0;
            end;

            i = i + 1;
          end;

        end;

        if(m_EndDate == date(31,12,Year))
          i = 0;
          while(i < arrKBKData.size)
            var query, cmd, DataSet;
            
            //5.       Распределяем суммы вычетов, созданные для купонных выплат в Депозитарии по соответствующим ставкам и КБК и по соответствующим датам получения дохода.
            query =   " select Extract(month from tb.t_IncDate) as IncMonth, tb.*, ch.t_TaxRate, ch.t_KBK_After,"
                    + "        (case when ch.t_Code_After = 1530 then 201 "
                    + "              when ch.t_Code_After = 1531 then 202 "
                    + "              when ch.t_Code_After = 1536 then 203 "
                    + "              when ch.t_Code_After = 1544 then 225 "
                    + "              when ch.t_Code_After = 1545 then 226 "
                    + "              when ch.t_Code_After = 1549 then 227 "
                    + "              else 0 end) as MSCode "
                    + "   from dnptxtotalbase_dbt tb, dnptxcodechange_dbt ch "
                    + "  where tb.t_ClientID = ? "
                    + "    and tb.t_TaxPeriod = ? "
                    + "    and tb.t_TaxBaseCurrPay < 0 "
                    + "    and tb.t_IncDate between ? and ? "
                    + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                    + "    and instr(tb.t_Description, 'Диасофт.') > 0 "
                    + "    and instr(tb.t_Description, '(ID =') > 0 "
                    + "    and ch.t_ID = TO_NUMBER(substr(tb.t_Description, instr(tb.t_Description, '(ID =')+6, instr(tb.t_Description, ')')-(instr(tb.t_Description, '(ID =')+6))) "
                    + "    and ch.t_KBK_After = ? "
                    + "    and ch.t_TaxRate " + IIF(arrKBKData[i].IsHighRate, " NOT ", "") + " IN ("+int(NPTXGENTAXRATE_NOTRESIDENT*100)+", "+int(NPTXGENTAXRATE_RESIDENT*100)+")";

            cmd = DL_RSDCommand(query);

            cmd.AddParam(DataSetClients.ClientID);
            cmd.AddParam(Year);
            cmd.AddParam(m_BeginDate);
            cmd.AddParam(m_EndDate);
            cmd.AddParam(arrKBKData[i].KBK);

            DataSet = cmd.Execute();

            while(DataSet.moveNext())
              if(DataSet.MSCode > 0)
                AddInArrCodeParms(ArrCodeParm, int(DataSet.IncMonth), "", $0, string(int(DataSet.MSCode)), abs(DataSet.TaxBaseCurrPay), 0.0, 0.0, 0.0, 0.0, 0.0, int(DataSet.TaxRate), 0.0,
                                  0.0, 0.0, 0.0, arrKBKData[i].IsHighRate, 0.0, 0.0, true, true, true,
                                  null, null, DataSet.KBK_After, 0.0);


                arrKBKData[i].TotalMinus = arrKBKData[i].TotalMinus + abs(DataSet.TaxBaseCurrPay);
              end;
            end;

            i = i + 1;
          end;
        end;

        i = 0;
        while(i < arrKBKData.size)
          arrKBKData[i].TaxCalculated = round(((arrKBKData[i].TotalPlus - arrKBKData[i].TotalMinus) * arrKBKData[i].Rate / 100.0), 0);
          
          if(arrKBKData[i].TaxPaid < arrKBKData[i].TaxCalculated)
            arrKBKData[i].TaxDue  = arrKBKData[i].TaxCalculated - arrKBKData[i].TaxPaid;
            arrKBKData[i].TaxOver = $0;
          else
            arrKBKData[i].TaxDue = $0;
            arrKBKData[i].TaxOver = arrKBKData[i].TaxPaid - arrKBKData[i].TaxCalculated;
          end;
          
          if((arrKBKData[i].TaxCalculated != 0.0) or 
             (arrKBKData[i].TaxPaid != 0.0) or 
             (arrKBKData[i].TaxDue != 0.0) or 
             (arrKBKData[i].TaxOver != 0.0) or 
             (arrKBKData[i].TaxToReturnDue != 0.0) or
             (arrKBKData[i].TaxPaid1Data != 0.0) or  
             (arrKBKData[i].TaxPaid2Data != 0.0) or   
             (arrKBKData[i].TaxPaid3Data != 0.0) or   
             (arrKBKData[i].TaxPaid4Data != 0.0) or   
             (arrKBKData[i].TaxPaid5Data != 0.0) or   
             (arrKBKData[i].TaxPaid6Data != 0.0) or   
             (arrKBKData[i].TaxToReturn1Data != 0.0) or
             (arrKBKData[i].TaxToReturn2Data != 0.0) or
             (arrKBKData[i].TaxToReturn3Data != 0.0) or
             (arrKBKData[i].TaxToReturn4Data != 0.0) or
             (arrKBKData[i].TaxToReturn5Data != 0.0) or
             (arrKBKData[i].TaxToReturn6Data != 0.0) or
             (arrKBKData[i].TaxRefund != 0.0)
            )
             
             RateIndex = AddInArrCodeParms(ArrCodeParm, NULL, NULL, 0.0, NULL, 0.0, 0.0, arrKBKData[i].TaxCalculated, arrKBKData[i].TaxPaid, arrKBKData[i].TaxToReturnDue,
                                           arrKBKData[i].TaxDue, arrKBKData[i].Rate, 0.0, 0.0, 0.0, arrKBKData[i].TaxOver, arrKBKData[i].IsHighRate, 0.0, 0.0,
                                           false, false, false, 0, 0, arrKBKData[i].KBK, arrKBKData[i].TaxRefund);
          end;


          if((arrKBKData[i].TotalPlus != 0.0) or 
             (arrKBKData[i].TotalMinus != 0.0) or 
             (arrKBKData[i].TaxCalculated != 0.0) or 
             (arrKBKData[i].TaxPaid != 0.0) or 
             (arrKBKData[i].TaxDue != 0.0) or 
             (arrKBKData[i].TaxOver != 0.0) or 
             (arrKBKData[i].TaxToReturnDue != 0.0) or
             (arrKBKData[i].TaxPaid1Data != 0.0) or  
             (arrKBKData[i].TaxPaid2Data != 0.0) or   
             (arrKBKData[i].TaxPaid3Data != 0.0) or   
             (arrKBKData[i].TaxPaid4Data != 0.0) or   
             (arrKBKData[i].TaxPaid5Data != 0.0) or   
             (arrKBKData[i].TaxPaid6Data != 0.0) or   
             (arrKBKData[i].TaxToReturn1Data != 0.0) or
             (arrKBKData[i].TaxToReturn2Data != 0.0) or
             (arrKBKData[i].TaxToReturn3Data != 0.0) or
             (arrKBKData[i].TaxToReturn4Data != 0.0) or
             (arrKBKData[i].TaxToReturn5Data != 0.0) or
             (arrKBKData[i].TaxToReturn6Data != 0.0) or
             (arrKBKData[i].TaxRefund != 0.0)
            )
            var insQuery =   "INSERT INTO DNPTX6CALCKBK_TMP (T_CLIENTID        , "
                           + "                               T_RATE            , "
                           + "                               T_KBK             , "
                           + "                               T_TOTALPLUS       , "
                           + "                               T_TOTALMINUS      , "
                           + "                               T_TAXCALCULATED   , "
                           + "                               T_TAXCALCULATEDDIV, "
                           + "                               T_TAXPAID         , "
                           + "                               T_TAXDUE          , "
                           + "                               T_TAXOVER         , "
                           + "                               T_TAXTORETURNDUE  , "
                           + "                               T_ZNP             , "
                           + "                               T_ISHIGHRATE      , "
                           + "                               T_TAXPAID1DATA    , "
                           + "                               T_TAXPAID2DATA    , "
                           + "                               T_TAXPAID3DATA    , "
                           + "                               T_TAXPAID4DATA    , "
                           + "                               T_TAXPAID5DATA    , "
                           + "                               T_TAXPAID6DATA    , "
                           + "                               T_TAXTORETURN1DATA, "
                           + "                               T_TAXTORETURN2DATA, "
                           + "                               T_TAXTORETURN3DATA, "
                           + "                               T_TAXTORETURN4DATA, "
                           + "                               T_TAXTORETURN5DATA, "
                           + "                               T_TAXTORETURN6DATA, "
                           + "                               T_TAXREFUND         "
                           + "                              )                    "
                           + "  VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) ";

            var ins = DL_RSDCOmmand(insQuery);

            ins.AddParam(DataSetClients.ClientID);
            ins.AddParam(arrKBKData[i].Rate);
            ins.AddParam(arrKBKData[i].KBK);
            ins.AddParam(arrKBKData[i].TotalPlus);
            ins.AddParam(arrKBKData[i].TotalMinus);
            ins.AddParam(arrKBKData[i].TaxCalculated);
            ins.AddParam(0);
            ins.AddParam(arrKBKData[i].TaxPaid);
            ins.AddParam(arrKBKData[i].TaxDue);
            ins.AddParam(arrKBKData[i].TaxOver);
            ins.AddParam(arrKBKData[i].TaxToReturnDue);
            ins.AddParam(0);
            ins.AddParam(IIF(arrKBKData[i].IsHighRate, SET_CHAR, UNSET_CHAR));
            ins.AddParam(arrKBKData[i].TaxPaid1Data);
            ins.AddParam(arrKBKData[i].TaxPaid2Data);
            ins.AddParam(arrKBKData[i].TaxPaid3Data);
            ins.AddParam(arrKBKData[i].TaxPaid4Data);
            ins.AddParam(arrKBKData[i].TaxPaid5Data);
            ins.AddParam(arrKBKData[i].TaxPaid6Data);
            ins.AddParam(arrKBKData[i].TaxToReturn1Data);
            ins.AddParam(arrKBKData[i].TaxToReturn2Data);
            ins.AddParam(arrKBKData[i].TaxToReturn3Data);
            ins.AddParam(arrKBKData[i].TaxToReturn4Data);
            ins.AddParam(arrKBKData[i].TaxToReturn5Data);
            ins.AddParam(arrKBKData[i].TaxToReturn6Data);
            ins.AddParam(arrKBKData[i].TaxRefund);

            ins.ExecuteCMD();
          end;

          i = i + 1;
        end;

        var DocumentType, DocumentNumber;
        DocumentInfo(DataSetClients.ClientID, @DocumentType, @DocumentNumber);
        NPTXPayerInfoArr[NPTXPayerInfoArr.Size()] = NPTXPayerInfo(DataSetClients.ClientID, DataSetClients.ClientINN, DataSetClients.LastName,
                                                                  DataSetClients.FirstName, DataSetClients.MiddleName, DataSetClients.ResidenceStatus,
                                                                  DataSetClients.BirthDate, Citizenship(DataSetClients.ClientID),
                                                                  DocumentType, DocumentNumber,
                                                                  ArrCodeParm);


        arrKBKData.size = 0;
        ArrCodeParm.size = 0;

        UseProgress(num = num + 1);
      end;

      if(num > 0)
        RemProgress();
      end;
      
      m_Count = CountFLPart2;

      return NPTXPayerInfoArr;
   end;

   macro Rates()
      if(m_Set2 == null)
         m_Query2 = " SELECT "
                      + " COUNT(1) OVER () AS t_Count "
                     + " ,q.t_CountFL "
                     + " ,q.t_Rate "
                     + " ,SUM(q.t_TotalPlus) as t_TotalPlus "
                     + " ,SUM(q.t_DivPlus) as t_DivPlus "
                     + " ,SUM(q.t_TotalMinus) as t_TotalMinus "
                     + " ,SUM(q.t_TaxCalculated) as t_TaxCalculated "
                     + " ,SUM(q.t_TaxCalculatedDiv) as t_TaxCalculatedDiv "
                     + " ,SUM(q.t_TaxPaid) as t_TaxPaid "
                     + " ,SUM(q.t_TaxDue) as t_TaxDue "
                     + " ,SUM(q.t_TaxOver) as t_TaxOver "
                     + " ,SUM(q.t_TaxToReturnDue) as t_TaxToReturnDue "
                     + " ,SUM(q.t_Znp) as t_Znp "
                     + " ,q.t_IsHighRate "
                     + " ,q.t_KBK as t_KBK "
                     + " ,SUM(q.t_TaxBaseSum) as t_TaxBaseSum "
                     + " ,SUM(q.t_TaxPaid1Data) as t_TaxPaid1Data "
                     + " ,SUM(q.t_TaxPaid2Data) as t_TaxPaid2Data "
                     + " ,SUM(q.t_TaxPaid3Data) as t_TaxPaid3Data "
                     + " ,SUM(q.t_TaxPaid4Data) as t_TaxPaid4Data "
                     + " ,SUM(q.t_TaxPaid5Data) as t_TaxPaid5Data "
                     + " ,SUM(q.t_TaxPaid6Data) as t_TaxPaid6Data "
                     + " ,SUM(q.t_TaxToReturn1Data) as t_TaxToReturn1Data "
                     + " ,SUM(q.t_TaxToReturn2Data) as t_TaxToReturn2Data "
                     + " ,SUM(q.t_TaxToReturn3Data) as t_TaxToReturn3Data "
                     + " ,SUM(q.t_TaxToReturn4Data) as t_TaxToReturn4Data "
                     + " ,SUM(q.t_TaxToReturn5Data) as t_TaxToReturn5Data "
                     + " ,SUM(q.t_TaxToReturn6Data) as t_TaxToReturn6Data "
                     + " ,SUM(q.t_TaxRefund) as t_TaxRefund "
                  + " FROM ( "
                     + "      SELECT qq.t_Rate "
                     + "            ,qq.t_CountFL "
                     + "            ,qq.t_TotalPlus "
                     + "            ,qq.t_DivPlus "
                     + "            ,qq.t_TotalMinus "
                     + "            ,qq.t_TaxCalculated "
                     + "            ,qq.t_TaxCalculatedDiv "
                     + "            ,qq.t_TaxPaid "
                     + "            ,qq.t_TaxDue as t_TaxDue "
                     + "            ,qq.t_TaxOver as t_TaxOver "
                     + "            ,abs(qq.t_TaxToReturnDue) as t_TaxToReturnDue "
                     + "            ,qq.t_Znp "
                     + "            ,qq.t_IsHighRate "
                     + "            ,qq.t_KBK "
                     + "            ,(qq.t_TotalPlus-qq.t_TotalMinus) as t_TaxBaseSum "
                     + "            ,qq.t_TaxPaid1Data "
                     + "            ,qq.t_TaxPaid2Data "
                     + "            ,qq.t_TaxPaid3Data "
                     + "            ,qq.t_TaxPaid4Data "
                     + "            ,qq.t_TaxPaid5Data "
                     + "            ,qq.t_TaxPaid6Data "
                     + "            ,qq.t_TaxToReturn1Data "
                     + "            ,qq.t_TaxToReturn2Data "
                     + "            ,qq.t_TaxToReturn3Data "
                     + "            ,qq.t_TaxToReturn4Data "
                     + "            ,qq.t_TaxToReturn5Data "
                     + "            ,qq.t_TaxToReturn6Data "
                     + "            ,qq.t_TaxRefund "
                     + "      FROM ( "
                  + "                 SELECT tmp.t_Rate "
                     + "                    ,count(1) over(partition by tmp.t_KBK, tmp.t_IsHighRate, tmp.t_Rate) as t_CountFL "
                     + "                    ,NVL(SUM(tmp.t_TotalPlus), 0) AS t_TotalPlus "
                     + "                    ,0 AS t_DivPlus "
                     + "                    ,NVL(SUM(tmp.t_TotalMinus), 0) AS t_TotalMinus "
                     + "                    ,SUM(tmp.t_TaxCalculated) AS t_TaxCalculated "
                     + "                    ,SUM(tmp.t_TaxCalculatedDiv) AS t_TaxCalculatedDiv "
                     + "                    ,SUM(tmp.t_TaxPaid) AS t_TaxPaid"
                     + "                    ,SUM(tmp.t_TaxToReturnDue) AS t_TaxToReturnDue "
                     + "                    ,SUM(tmp.t_Znp) AS t_Znp "
                     + "                    ,SUM(tmp.t_TaxDue) AS t_TaxDue "
                     + "                    ,SUM(tmp.t_TaxOver) AS t_TaxOver "
                     + "                    ,tmp.t_IsHighRate "
                     + "                    ,tmp.t_KBK "
                     + "                    ,SUM(tmp.t_TaxPaid1Data) AS t_TaxPaid1Data "
                     + "                    ,SUM(tmp.t_TaxPaid2Data) AS t_TaxPaid2Data "
                     + "                    ,SUM(tmp.t_TaxPaid3Data) AS t_TaxPaid3Data "
                     + "                    ,SUM(tmp.t_TaxPaid4Data) AS t_TaxPaid4Data "
                     + "                    ,SUM(tmp.t_TaxPaid5Data) AS t_TaxPaid5Data "
                     + "                    ,SUM(tmp.t_TaxPaid6Data) AS t_TaxPaid6Data "
                     + "                    ,SUM(tmp.t_TaxToReturn1Data) AS t_TaxToReturn1Data "
                     + "                    ,SUM(tmp.t_TaxToReturn2Data) AS t_TaxToReturn2Data "
                     + "                    ,SUM(tmp.t_TaxToReturn3Data) AS t_TaxToReturn3Data "
                     + "                    ,SUM(tmp.t_TaxToReturn4Data) AS t_TaxToReturn4Data "
                     + "                    ,SUM(tmp.t_TaxToReturn5Data) AS t_TaxToReturn5Data "
                     + "                    ,SUM(tmp.t_TaxToReturn6Data) AS t_TaxToReturn6Data "
                     + "                    ,SUM(tmp.t_TaxRefund) AS t_TaxRefund "
                     + "              FROM "
                      + "                  dnptx6calckbk_tmp tmp "
                     + "              GROUP BY tmp.t_ClientID, tmp.t_KBK, tmp.t_IsHighRate, tmp.t_Rate "
                     + "           ) qq "
                     + "   ) q "
                  + " GROUP BY "
                      + " q.t_Rate, "
                      + " q.t_IsHighRate, "
                      + " q.t_CountFL, "
                      + " q.t_KBK "
                  + " ORDER BY "
                      + " q.t_Rate ASC, "
                      + " q.t_IsHighRate, "
                      + " q.t_KBK ";
   
         m_Cmd2 = RsdCommand(m_Query2);
         m_Cmd2.NullConversion = true;
         m_Cmd2.Execute();
   
         m_Set2 = RsdRecordset(m_Cmd2, RSDVAL_CLIENT, RSDVAL_STATIC);
      end;

      return m_Set2;
   end;


   SQL_Truncate("dnptx6calc1_tmp");
   SQL_Truncate("dnptx6calckbk_tmp");

   if(IsPart2 == SET_CHAR)
      Init(_BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS, RepDate, _IsDetails, _IsSOFR, _IsDiasoft, _IsApp1, IsPart2);
   end;

   m_TaxAgentParm = TaxAgentParm();
   m_TaxAgentParm.Load();
END;

private macro NDLFPayerStatus(PartyID)
   var Status = 0;
   PRIVATE RECORD party("party.dbt");
   if(ПолучитьСубъекта(PartyID, party) == 0)
      GetMainObjAttr(NULL, OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 42, NULL, NULL, Status);
   end;

   return Status;
end;

CLASS (DL_XML) NPTXPit6_NEW_XML
   macro CreateXMLObj()
      CreateXML();
   end;

   macro GetXMLObj()
      return m_xml;
   end;

   macro SetFileName(fileName)
      if(fileName != NULL)
         m_FileName = fileName;
      end;
   end;

   macro GetFileName()
      return m_FileName;
   end;


   macro SaveXML()
      var NameFile = GetFileName(); 
      var DirFileLen = 0;
          
      var NameFileTxt = GetTxtFileName(NameFile); 

      var nm, ext;
      SplitFile(NameFileTxt, nm, ext);

      var FileNameLen = strlen(nm+ext);
    
      DirFileLen = strlen(NameFileTxt);

      var NamePath = substr(NameFileTxt, 1, DirFileLen - FileNameLen);
      m_xml.save(NamePath + NameFile);
   end;

   macro Save()
      SaveXML();
   end;

   macro CreateNode(nodeName /* attrName, attrValue, ... */)
      var node = NULL;
      var numParm = 2;
      var attrName = "", attrValue = "";

      node = m_xml.createNode(1, nodeName, NameSpace);
      while(GetParm(numParm, attrName))
        GetParm(numParm + 1, attrValue);
        node.setAttributeNode(CreateAttr(attrName, attrValue));
        numParm = numParm + 2;
      end;
  
      return node;
   end;

   InitDL_XML();
   m_FileName = "NO_NDFL6.2_0000_0000_0000000000000000000_00000000_0";
END;

   /**
     @brief Вставить выбранных в панели клиентов во временную таблицу DNPTX6CLIENT_TMP для дальнейшего использования
     @param [in] PartyID t_PartyID из таблицы DPARTY_DBT для клиента
   */
   private macro InsertClientToNPTX6CLIENT(PartyID)
      var queryInsert = "INSERT INTO DNPTX6CLIENT_TMP ( " +
                        "                                t_PartyID " +
                        "                             ) " +
                        "                      VALUES ( " +
                        "                                ? " +
                        "                             ) ";

      var cmdInsert = DL_RSDCommand(queryInsert);
      cmdInsert.AddParam(PartyID);
      cmdInsert.ExecuteCMD();
   end;

   /**
     @brief Вставить всех клиентов, у которых есть объекты НДР за указанный период в таблицу DNPTX6CLIENT_TMP для дальнейшего использования
     @param [in] BeginDate Дата начала
     @param [in] EndDate Дата окончания
   */
   private macro InsertAllClientsToNPTX6CLIENT(BeginDate:DATE, EndDate:DATE)
      var Year = 0;
      datesplit(EndDate, null, null, Year);
      
      var queryInsertAll = "INSERT INTO DNPTX6CLIENT_TMP " +
                           "SELECT persn.t_PersonID " +
                           "FROM dpersn_dbt persn " +
                           "WHERE exists( " +
                           "               SELECT 1 " +
                           "               FROM dnptxobj_dbt obj " +
                           "               WHERE obj.t_Client = persn.t_PersonID " +
                           "                 and obj.t_Date between ? and ? " +
                           "                 and (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst is null) "
                           "            ) " +
                           "      or exists( select 1 from dnptxtotalbase_dbt tb where tb.t_ClientID = persn.t_PersonID and (tb.t_IncDate between ? and ? or tb.t_TaxPeriod = ?)) ";

      var cmdInsertAll = DL_RSDCommand(queryInsertAll);
      cmdInsertAll.AddParam(BeginDate);
      cmdInsertAll.AddParam(EndDate);
      cmdInsertAll.AddParam(BeginDate);
      cmdInsertAll.AddParam(EndDate);
      cmdInsertAll.AddParam(Year);
      cmdInsertAll.ExecuteCMD();
   end;

/**
  @brief Класс отчета (кроме справки для выдачи клиентам)
  @param [in] IsPart1 Формировать раздел 1
  @param [in] P1BeginDate Дата начала для раздела 1
  @param [in] P1EndDate Дтаа окончания для раздела 1
  @param [in] IsPart2 Формировать раздел 2
  @param [in] P2BeginDate Дата начала для раздела 2
  @param [in] P2EndDate Дата окончания для раздела 2
  @param [in] IsApp1 Формировать приложение 1
  @param [in] App1EndDate Дата окончания для приложения 1
  @param [in] Clients Формировать отчет для клиента
  @param [in] IsBOCB Формировать по данным БО ЦБ
  @param [in] IsDepo Формировать по данным Депозитария
  @param [in] IsVS Формировать по данным модуля "Векселя банка"
  @param [in] InXLS Формировать в формате XLS
  @param [in] InXML Формировать в формате XML
  @param [in] IsDetails Формировать расшифровку
  @param [in] IsSOFR Формировать по данным СОФР
  @param [in] IsDiasoft Формировать по данным Диасофт
  @param [in] RepDate Дата формирования отчета
*/
CLASS (TaxReportBase) NPTX_Pit6_NEW_Report(IsPart1,
                                           P1BeginDate:DATE,
                                           P1EndDate:DATE,
                                           IsPart2,
                                           P2BeginDate:DATE,
                                           P2EndDate:DATE,
                                           IsApp1,
                                           App1EndDate:DATE,
                                           Clients,
                                           IsBOCB,
                                           IsDepo,
                                           IsVS,
                                           InXLS,
                                           InXml,
                                           IsDetails,
                                           IsSOFR,
                                           IsDiasoft,
                                           RepDate:DATE
                                          )
   // Константы, определяющие количество строк на одной странице отчета
   private const CodesOnPageApp2 = 14;

   // Значения полей панели (кроме "Код клиента" и "Наименование клиента" справки для выдачи клиентам)
   private var m_IsPart1      = IsPart1;
   private var m_P1BeginDate  = P1BeginDate;
   private var m_P1EndDate    = P1EndDate;
   private var m_IsPart2      = IsPart2;
   private var m_P2BeginDate  = P2BeginDate;
   private var m_P2EndDate    = P2EndDate;
   private var m_IsApp1       = IsApp1;
   private var m_App1EndDate  = App1EndDate;
   private var m_Clients      = Clients;
   //private var m_ClientName;
   private var m_IsBOCB       = IsBOCB;
   private var m_IsDepo       = IsDepo;
   private var m_IsVS         = IsVS;
   private var m_InXLS        = InXLS;
   private var m_InXML        = InXML;
   private var m_IsDetails    = IsDetails;
   private var m_IsSOFR       = IsSOFR;
   private var m_IsDiasoft    = IsDiasoft;
   private var m_RepDate      = RepDate;

   // Объекты для формирования данных отчета
   private var m_RepCalc = NULL;  ///< Раздел 1
   private var m_RepCalc2 = NULL; ///< Раздел 2

   // Вспомогательные переменные
   private var m_XMLFile = NULL; ///< Объект XML-файла
   private var m_PageNum = 1;    ///< Номер страницы отчета
   private var m_CurrNameNPTX2 = ""; ///< Название листа для приложения 1
   private var m_CurrNameApp2 = "";  ///< Название листа для приложения 2
   private var m_Part1PageCount = 0; ///< Количество страниц, необходимое для раздела 1
   private var m_Part2PageCount = 0;         ///< Количество страниц, необходимое для раздела 2
   private var m_Part2HighRatePageCount = 0; ///< Количество страниц, необходимое для повышенной ставки раздела 2
   private var m_NPTX2PageCount = 0;         ///< Количество страниц, необходимое приложения 1
   private var m_ByClientNumerator = ByClientNumerator(); ///< Нумератор клиентов
   private var m_IsCreatedXML = false;                    ///< Нужно создавать XML-файл
   private var NPTXPayerInfoArr = TArray();               ///< Массив с данными по клиентам

   var RateParmNPTX2Arr = TArray();

   private macro BeginReport()
      var partyNumber = 0;
      var NumberQuery, NumberCmd, NumberDS;
      var App1Year = 0;

      datesplit(m_App1EndDate, null, null, App1Year);

      SQL_Execute("DELETE FROM DNPTX6CLIENT_TMP");

      if(m_Clients[0] == -1)
         var BegDate = date(31,12,9999), EndDate = date(0,0,0);

         if(m_IsPart1)
           BegDate = m_P1BeginDate;
           EndDate = m_P1EndDate;
         end;
         
         if(m_IsPart2)
           BegDate = IIF(m_P2BeginDate < BegDate, m_P2BeginDate, BegDate);
           EndDate = IIF(m_P2EndDate > EndDate, m_P2EndDate, EndDate);
         elif(m_IsApp1)
           BegDate = IIF(date(1,1,App1Year) < BegDate, date(1,1,App1Year), BegDate);
           EndDate = IIF(m_App1EndDate > EndDate, m_App1EndDate, EndDate);
         end;
         
         InsertAllClientsToNPTX6CLIENT(BegDate, EndDate);
      else
         var i = 0;
         while(i < m_Clients.Size)
            InsertClientToNPTX6CLIENT(m_Clients[i]);
            i = i + 1;
         end;
      end;

      if((m_IsPart2) or (m_IsApp1) or (m_IsDetails))
        m_RepCalc2 = NPTXRepCalc_NPTXPIT6_NEW_2(IIF(m_IsPart2 == SET_CHAR, m_P2BeginDate, date(1,1,App1Year)),
                                                IIF(m_IsPart2 == SET_CHAR, m_P2EndDate, m_App1EndDate),
                                                m_IsBOCB,
                                                m_IsDepo,
                                                m_IsVS,
                                                m_IsPart2,
                                                m_RepDate,
                                                m_IsDetails,
                                                m_IsSOFR,
                                                m_IsDiasoft,
                                                m_IsApp1);
      end;

      SetIsShowAppl(false);

      CreateTotalBook();

      if(m_InXML == SET_CHAR)
         m_XMLFile.CreateXMLObj();
      end;

      NumberQuery = "select count(1) as t_Count " +
                    "from ddl_report_stat_dbt " +
                    "where t_ReportKind = " + string(NPTXPIT6NEW_REPORTKIND);

      NumberCmd = DL_RSDCommand(NumberQuery);
      /*NumberDS = NumberCmd.Execute();
      if(NumberDS.MoveNext())
         m_Number = Int(NumberDS.Count) + 1;
      end;*/

      Dl_CallInsertStat(m_OutMode);
   end;

   PRIVATE MACRO PrintTitle(PageCount)
      var Year;

      if(m_IsPart2 == SET_CHAR)
        DateSplit(m_P2EndDate, NULL, NULL, Year);
      elif(m_IsPart1 == SET_CHAR)
        DateSplit(m_P1EndDate, NULL, NULL, Year);
      else
        DateSplit(m_App1EndDate, NULL, NULL, Year);
      end;

      UseNewSheetInTotalBook();
      SetActiveSheet("Титульный лист");

      PrintOneRow("N1_OurInn", m_RepCalc2.OurInn(), 12);
      PrintOneRow("N1_OurKpp", m_RepCalc2.OurKPP(), 9);
      PrintOneRow("N1_Num", string(m_PageNum:3:o), 3);
      PrintOneRow("N1_PP", m_RepCalc2.PP(), 2);
      PrintOnERow("N1_Year", string(Year), 4);
      PrintOneRow("N1_OurFNSCode", m_RepCalc2.OurFNScode(), 4);
      PrintOneRow("N1_OurName", m_RepCalc2.OurName(), 160);
      PrintOneRow("N1_OKTMO", substr(m_RepCalc2.OurOKTMO(), 1, 11), 11);
      PrintOneRow("N1_OurPhone", m_RepCalc2.OurPhone(), 20);
      PrintOneRow("N1_Page", string(PageCount:3:o), 3);
      if((m_RepCalc2.FirstPersonLastName() != NULL) and (m_RepCalc2.FirstPersonLastName() != ""))
        PrintOneRow("N1_FIOPerson1", m_RepCalc2.FirstPersonLastName(), 20);
        PrintOneRow("N1_FIOPerson2", m_RepCalc2.FirstPersonFirstName(), 20);
        PrintOneRow("N1_FIOPerson3", m_RepCalc2.FirstPersonMiddleName(), 20);
      end;
      PrintOneDateRow("N1_Date", m_RepDate);

      CopyAllSheetInTotalBook("Титульный лист", false, "N1_PrintArea", 0, "Титульный лист");
   END;

   PRIVATE MACRO PrintPart1()
      var Part1Num = 0;
      var RetNumber = 0;
      var i = 0, j = 0;

      if(m_RepCalc.m_Part1Collect.ExistsData())
        InitProgress(m_Part1PageCount, "Печать раздела 1", "Печать раздела 1");

        while(i < m_RepCalc.m_Part1Collect.m_KBKDataArr.size)
          var KBKData = m_RepCalc.m_Part1Collect.m_KBKDataArr[i];
          
          m_PageNum = m_PageNum + 1;

          UseNewSheetInTotalBook();
          SetActiveSheet("Расчет Раздел 1");
          PrintOneRow("N2_OurInn", m_RepCalc2.OurINN(), 12);
          PrintOneRow("N2_OurKpp", m_RepCalc2.OurKPP(), 9);
          PrintOneRow("N2_Num", string(m_PageNum:3:o), 3);
          PrintOneRow("N2_KBK", KBKData.m_KBK, 20);

          PrintOneSumRow("N2_TaxPaid_Total", string(KBKData.m_SumTotal), 15, false);

          if(KBKData.m_Sum021 != 0)
             PrintOneSumRow("N2_TaxPaid1Date_", KBKData.m_Sum021, 15, false);
          end;
          if(KBKData.m_Sum022 != 0)
             PrintOneSumRow("N2_TaxPaid2Date_", KBKData.m_Sum022, 15, false);
          end;
          if(KBKData.m_Sum023 != 0)
             PrintOneSumRow("N2_TaxPaid3Date_", KBKData.m_Sum023, 15, false);
          end;
          if(KBKData.m_Sum024 != 0)
             PrintOneSumRow("N2_TaxPaid4Date_", KBKData.m_Sum024, 15, false);
          end;
          if(KBKData.m_Sum025 != 0)
             PrintOneSumRow("N2_TaxPaid5Date_", KBKData.m_Sum025, 15, false);
          end;
          if(KBKData.m_Sum026 != 0)
             PrintOneSumRow("N2_TaxPaid6Date_", KBKData.m_Sum026, 15, false);
          end;

          PrintOneSumRow("N2_TaxToReturnDue_Total_", string(KBKData.m_SumRetTotal), 15, false);

          if(KBKData.m_SumRet021 != 0)
             PrintOneSumRow("N2_TaxReturn1Date_", KBKData.m_SumRet021, 15, false);
          end;
          if(KBKData.m_SumRet022 != 0)
             PrintOneSumRow("N2_TaxReturn2Date_", KBKData.m_SumRet022, 15, false);
          end;
          if(KBKData.m_SumRet023 != 0)
             PrintOneSumRow("N2_TaxReturn3Date_", KBKData.m_SumRet023, 15, false);
          end;
          if(KBKData.m_SumRet024 != 0)
             PrintOneSumRow("N2_TaxReturn4Date_", KBKData.m_SumRet024, 15, false);
          end;
          if(KBKData.m_SumRet025 != 0)
             PrintOneSumRow("N2_TaxReturn5Date_", KBKData.m_SumRet025, 15, false);
          end;
          if(KBKData.m_SumRet026 != 0)
             PrintOneSumRow("N2_TaxReturn6Date_", KBKData.m_SumRet026, 15, false);
          end;


          PrintFormatString(NULL, "N2_Date", string(m_RepDate:f));

          i = i + 1;

          CopyAllSheetInTotalBook("Расчет Раздел 1", false, "N2_PrintArea", 0, "Расчет Раздел 1 " + string(Part1Num + 1));
          UseProgress(Part1Num = Part1Num + 1);
        end;

        RemProgress();
      end;
      
   END;

   PRIVATE MACRO PrintPart2(RateExists)
      var Part2Num = 1;
      var CurRate = 0;
      var IsHighRate = UNSET_CHAR;
      var taxDue, taxOver;

      if(RateExists)
         InitProgress(m_Part2PageCount, "Форма 6-НДФЛ 2024г", "Печать раздела 2");
         while(RateExists)
            if(m_InXLS == SET_CHAR)
              CurRate = m_RepCalc2.Rates().Value("t_Rate");
              IsHighRate = m_RepCalc2.Rates().Value("t_IsHighRate");
            
              m_PageNum = m_PageNum + 1;
              UseNewSheetInTotalBook();
              SetActiveSheet("Расчет Раздел 2");

              PrintOneRow("N3_OurInn", m_RepCalc2.OurINN(), 12);
              PrintOneRow("N3_OurKpp", m_RepCalc2.OurKPP(), 9);

              PrintOneRow("N3_Num", string(m_PageNum:3:o), 3);

              PrintOneSumRow("N3_Rate", CurRate, 2, false);
              PrintOneRow("N3_KBK", m_RepCalc2.Rates().Value("t_KBK"), 20);

              PrintOneSumRow("N3_Amount", m_RepCalc2.Rates().Value("t_CountFL"), 7, false);

              PrintOneSumRow("N3_TotalPlus", m_RepCalc2.Rates().Value("t_TotalPlus"), 14, true);
              PrintOneSumRow("N3_TotalMinus", m_RepCalc2.Rates().Value("t_TotalMinus"), 14, true);
              PrintOneSumRow("N3_TaxBaseSum", m_RepCalc2.Rates().Value("t_TaxBaseSum"), 14, true);

              PrintOneSumRow("N3_TaxCalculated", m_RepCalc2.Rates().Value("t_TaxCalculated"), 15, false);
              PrintOneSumRow("N3_TaxPaid", m_RepCalc2.Rates().Value("t_TaxPaid"), 15, false);

              PrintOneSumRow("N3_TaxPaid1Data_", m_RepCalc2.Rates().Value("t_TaxPaid1Data"), 15, false);
              PrintOneSumRow("N3_TaxPaid2Data_", m_RepCalc2.Rates().Value("t_TaxPaid2Data"), 15, false);
              PrintOneSumRow("N3_TaxPaid3Data_", m_RepCalc2.Rates().Value("t_TaxPaid3Data"), 15, false);
              PrintOneSumRow("N3_TaxPaid4Data_", m_RepCalc2.Rates().Value("t_TaxPaid4Data"), 15, false);
              PrintOneSumRow("N3_TaxPaid5Data_", m_RepCalc2.Rates().Value("t_TaxPaid5Data"), 15, false);
              PrintOneSumRow("N3_TaxPaid6Data_", m_RepCalc2.Rates().Value("t_TaxPaid6Data"), 15, false);

              PrintOneSumRow("N3_TaxDue", round(m_RepCalc2.Rates.Value("t_TaxDue"),0), 15, false);
              PrintOneSumRow("N3_TaxOver", round(m_RepCalc2.Rates.Value("t_TaxOver"),0), 15, false);
              PrintOneSumRow("N3_TaxToReturnDue", round(m_RepCalc2.Rates().Value("t_TaxToReturnDue"),0), 15, false);

              PrintOneSumRow("N3_TaxToReturnDue1Data_", m_RepCalc2.Rates().Value("t_TaxToReturn1Data"), 15, false);
              PrintOneSumRow("N3_TaxToReturnDue2Data_", m_RepCalc2.Rates().Value("t_TaxToReturn2Data"), 15, false);
              PrintOneSumRow("N3_TaxToReturnDue3Data_", m_RepCalc2.Rates().Value("t_TaxToReturn3Data"), 15, false);
              PrintOneSumRow("N3_TaxToReturnDue4Data_", m_RepCalc2.Rates().Value("t_TaxToReturn4Data"), 15, false);
              PrintOneSumRow("N3_TaxToReturnDue5Data_", m_RepCalc2.Rates().Value("t_TaxToReturn5Data"), 15, false);
              PrintOneSumRow("N3_TaxToReturnDue6Data_", m_RepCalc2.Rates().Value("t_TaxToReturn6Data"), 15, false);


              PrintFormatString(NULL, "N3_Date", string(m_RepDate:f));
              CopyAllSheetInTotalBook("Расчет Раздел 2", false, "N3_PrintArea", 0, "Расчет Раздел 2 " + Part2Num);
            end;

            UseProgress(Part2Num);
            Part2Num = Part2Num + 1;
            RateExists = m_RepCalc2.Rates().MoveNext();
         end;
         RemProgress();
      end;
   END;

   PRIVATE MACRO RegisterTableDetails()
      RegisterTable("N6_MainTable",
                    NULL,
                    "N6_Num",
                    "N6_TypeOper",
                    "N6_Client",
                    "N6_ClientCode",
                    "N6_DateTransfer",
                    "N6_DatePaid",
                    "N6_TaxPaid",
                    "N6_Base",
                    "N6_TotalMinus",
                    "N6_TaxCalculated",
                    "N6_TaxDue",
                    "N6_TaxOver",
                    "N6_TaxToReturnDue",
                    "N6_Rate");
   END;

   PRIVATE MACRO PrintDetailsPart2()
      SetActiveSheet("Раздел 2 - Расшифровка");

      var Num = 1;
      var NumProgress = 0;

      PrintFormatString(NULL, "N6_BeginDate", m_RepCalc2.BeginDate(),
                              "N6_EndDate", m_RepCalc2.EndDate());

      CopyAllSheetInTotalBook("Раздел 2 - Расшифровка", false, "N6_Header", 0);

      var QueryDetails = "select q.t_Count, " +
                         "       q.t_TypeOper, " +
                         "       q.t_Client, " +
                         "       q.t_ClientCode, " +
                         "       q.t_DateTransfer, " +
                         "       q.t_DatePaid, " +
                         "       q.t_TaxPaid, " +
                         "       q.t_Base, " +
                         "       q.t_TotalMinus, " +
                         "       q.t_TaxCalculated, " +
                         "       ( " +
                         "          case " +
                         "             when q.t_TaxPaid < q.t_TaxCalculated then q.t_TaxCalculated - (q.t_TaxPaid + q.t_Znp)" +
                         "             else 0 " +
                         "          end " +
                         "       ) t_TaxDue, " +
                         "       ( " +
                         "          case " +
                         "             when q.t_TaxPaid > q.t_TaxCalculated then q.t_TaxPaid - q.t_TaxCalculated"+
                         "             else 0 " +
                         "          end " +
                         "       ) t_TaxOver, " +
                         "       abs(q.t_TaxToReturnDue) as t_TaxToReturnDue, " +
                         "       q.t_Rate " +
                         "from ( " +
                         "        select COUNT(1) OVER() as t_Count, " +
                         "               ( " +
                         "                  case tmp.t_TypeOper " +
                         "                     when 0 " +
                         "                     then 'Пользовательский' " +
                         "                     when 1 " +
                         "                     then 'Выплата купона' " +
                         "                     when 2 " +
                         "                     then 'Выплаты в РЕПО' " +
                         "                     when 3 " +
                         "                     then 'Вывод д/с' " +
                         "                     when 4 " +
                         "                     then 'Вывод ц/б' " +
                         "                     when 5 " +
                         "                     then 'Материальная выгода' " +
                         "                     when 6 " +
                         "                     then 'Окончание года' " +
                         "                     when 7 " +
                         "                     then 'Выплата дивидендов' " +
                         "                     when 8 " +
                         "                     then 'Закрытие договора' " +
                         "                     when 9 " +
                         "                     then 'Выплата дохода' " +
                         "                     when 10 " +
                         "                     then 'Возврат налога' " +
                         "                     else '' " +
                         "                  end " +
                         "               ) as t_TypeOper, " +
                         "               persn.t_Name1 || ' ' || persn.t_Name2 || ' ' || persn.t_Name3 as t_Client, " +
                         "               tmp.t_ClientCode, " +
                         "               tmp.t_DateTransfer, " +
                         "               tmp.t_DatePaid, " +
                         "               NVL(SUM(tmp.t_TaxPaid), 0) as t_TaxPaid, " +
                         "               NVL(SUM(tmp.t_TotalPlus), 0) + NVL(SUM(tmp.t_Plus2), 0) + NVL(SUM(tmp.t_Plus3), 0) + NVL(SUM(tmp.t_Plus5), 0) + NVL(SUM(tmp.t_Plus9), 0) as t_Base, " +
                         "               NVL(SUM(tmp.t_TotalMinus), 0) + NVL(SUM(tmp.t_Minus2), 0) + NVL(SUM(tmp.t_Minus3), 0) + NVL(SUM(tmp.t_Minus5), 0) + NVL(SUM(tmp.t_Minus9), 0) as t_TotalMinus, " +
                         "               NVL(SUM(tmp.t_TaxCalculated), 0) as t_TaxCalculated, " +
                         "               NVL(SUM(tmp.t_TaxToReturnDue), 0) as t_TaxToReturnDue, " +
                         "               NVL(SUM(tmp.t_Znp), 0) as t_Znp, " +
                         "               t_Rate " +
                         "        from dnptx6calc1_tmp tmp, " +
                         "             dpersn_dbt persn " +
                         "        where persn.t_PersonID = tmp.t_ClientID " +
                         "        group by tmp.t_TypeOper, " +
                         "                 tmp.t_DateTransfer, " +
                         "                 tmp.t_DatePaid, " +
                         "                 tmp.t_Rate, " +
                         "                 tmp.t_IsHighRate, " +
                         "                 tmp.t_ClientID, " +
                         "                 tmp.t_ClientCode, " +
                         "                 persn.t_Name1, " +
                         "                 persn.t_Name2, " +
                         "                 persn.t_Name3 " +
                         "     ) q " +
                         "order by (case when q.t_DatePaid > "+GetSQLDate(date(0,0,0))+" then q.t_DatePaid else q.t_DateTransfer end), " +
                         "         (case when q.t_DateTransfer = "+GetSQLDate(date(0,0,0))+" then q.t_DatePaid else q.t_DateTransfer end), "  +
                         "         q.t_Rate ";

      var CmdDetails = DL_RSDCommand(QueryDetails);
      CmdDetails.AddParam(m_RepCalc2.EndDate());
      CmdDetails.AddParam(m_RepCalc2.BeginDate());
      var count = CmdDetails.GetCount();
      if(count > 0)
         var DSDetails = CmdDetails.Execute();

         InitProgress(count, "Форма 6-НДФЛ 2024г", "Печать расшифровок");
         RegisterTableDetails();
         while(DSDetails.MoveNext())
            PrintTableLine("N6_Num", Num, NULL,
                           "N6_TypeOper", DSDetails.TypeOper, NULL,
                           "N6_Client", DSDetails.Client, NULL,
                           "N6_ClientCode", DSDetails.ClientCode, NULL,
                           "N6_DateTransfer", string(Date(DSDetails.DateTransfer):f), NULL,
                           "N6_DatePaid", string(Date(DSDetails.DatePaid):f), NULL,
                           "N6_TaxPaid", DSDetails.TaxPaid, NULL,
                           "N6_Base", DSDetails.Base, NULL,
                           "N6_TotalMinus", DSDetails.TotalMinus, NULL,
                           "N6_TaxCalculated", DSDetails.TaxCalculated, NULL,
                           "N6_TaxDue", DSDetails.TaxDue, NULL,
                           "N6_TaxOver", DSDetails.TaxOver, NULL,
                           "N6_TaxToReturnDue", DSDetails.TaxToReturnDue, NULL,
                           "N6_Rate", DSDetails.Rate, NULL);

            Num = Num + 1;
            UseProgress(NumProgress = NumProgress + 1);
         end;
         RemProgress();

         EndTable();
         CopyAllSheetInTotalBook("Раздел 2 - Расшифровка", false, GetTableRange(), 0);
      end;
   END;

   PRIVATE MACRO PrintNPTXPit2(PayerInfo, RateIndex)
      m_PageNum = m_PageNum + 1;
      UseNewSheetInTotalBook();
      SetActiveSheet("Приложение 1(Справка о доходах)");

      PrintOneRow("N4_OurInn", m_RepCalc2.OurINN(), 12);
      PrintOneRow("N4_OurKpp", m_RepCalc2.OurKPP(), 9);
      PrintOneRow("N4_Num", string(m_PageNum:3:o), 3);
      PrintOneSumRow("N4_NumberRef", m_ByClientNumerator.GetNexNumbByClientId(PayerInfo.ClientID), 7, false);
      PrintOneRow("N4_ClientINN", PayerInfo.ClientINN, 12);
      PrintOneRow("N4_SecondName", PayerInfo.LastName, 35);
      PrintOneRow("N4_FirstName", PayerInfo.FirstName, 35);
      PrintOneRow("N4_MiddleName", PayerInfo.MiddleName, 35);
      PrintOneRow("N4_ResidenceStatus", string(PayerInfo.ResidenceStatus), 1);
      PrintOneDateRow("N4_DateBirth", PayerInfo.DateBirth);
      PrintOneRow("N4_Citizenship", PayerInfo.ResidenceCountry, 3);
      PrintOneRow("N4_DocumentType", PayerInfo.DocumentType, 2);
      PrintOneRow("N4_DocumentNumber", PayerInfo.DocumentNumber, 20);

      PrintOneSumRow("N4_Rate", Int(PayerInfo.ArrCodeParm[RateIndex].Rate), 2, false);
      PrintOneRow("N4_KBK", PayerInfo.ArrCodeParm[RateIndex].KBK, 20);

      var taxBase = PayerInfo.ArrCodeParm[RateIndex].PlusSum - PayerInfo.ArrCodeParm[RateIndex].MinusSum;
      PrintOneSumRow("N4_TotalPlus", PayerInfo.ArrCodeParm[RateIndex].PlusSum, 17, true);
      PrintOneSumRow("N4_TaxBaseSum", taxBase, 17, true);
      PrintOneSumRow("N4_TaxCalculated", PayerInfo.ArrCodeParm[RateIndex].TaxCalculated, 11, false);
      PrintOneSumRow("N4_TaxPaid1_", PayerInfo.ArrCodeParm[RateIndex].TaxPaid + PayerInfo.ArrCodeParm[RateIndex].TaxRefund, 11, false);
      PrintOneSumRow("N4_TaxOver", max(PayerInfo.ArrCodeParm[RateIndex].TaxPaid + PayerInfo.ArrCodeParm[RateIndex].TaxRefund - PayerInfo.ArrCodeParm[RateIndex].TaxCalculated,$0), 11, false);
      var n = 1;
      
      PrintOneSumRow("N4_TotalPlus_NoTax", ExtRound(ExtRound(PayerInfo.ArrCodeParm[RateIndex].TaxDue, 0) / PayerInfo.ArrCodeParm[RateIndex].Rate * 100.0), 17, true);
      PrintOneSumRow("N4_TaxDue", PayerInfo.ArrCodeParm[RateIndex].TaxDue, 11, false);

      PrintFormatString(NULL, "N4_Date", string(m_RepDate:f));
      CopyAllSheetInTotalBook("Приложение 1(Справка о доходах)", false, "N4_PrintArea", 0, m_CurrNameNPTX2);
   END;

   PRIVATE MACRO PrintApp2(PayerInfo, RateIndex)
      var i = 0;
      var IndexOfLastMinus = 0; //индекс последнего элемента массива NPTXCodeParmArr[i].MinusCodes, напечатанного на одной странице,
                                //нужен для перехода на следующую страницу, если у последнего кода NPTXCodeParmArr количество MinusCodes > 1
      var PageNum = 1;
      var IsMinus = false;
      if(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size() == 0)
        m_PageNum = m_PageNum + 1;
        UseNewSheetInTotalBook();
        SetActiveSheet("Приложение к Справке");

        PrintOneRow("N5_OurInn", m_RepCalc2.OurINN(), 12);
        PrintOneRow("N5_OurKpp", m_RepCalc2.OurKPP(), 9);

        PrintOneRow("N5_Num", string(m_PageNum:3:o), 3);

        PrintOneSumRow("N5_NumberRef", m_ByClientNumerator.GetNexNumbByClientId(PayerInfo.ClientID), 7, false);

        PrintOneSumRow("N5_Rate", Int(PayerInfo.ArrCodeParm[RateIndex].Rate), 2, false);
        PrintOneRow("N5_KBK", PayerInfo.ArrCodeParm[RateIndex].KBK, 20);

        if(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size() > CodesOnPageApp2)
           m_CurrNameApp2 = m_CurrNameApp2 + " " + string(PageNum);
        end;

        PrintFormatString(NULL, "N5_Date", string(m_RepDate:f));
        CopyAllSheetInTotalBook("Приложение к Справке", false, "N5_PrintArea", 0, m_CurrNameApp2);

        PageNum = PageNum + 1;
      else
      
        while(i < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size())
           m_PageNum = m_PageNum + 1;
           UseNewSheetInTotalBook();
           SetActiveSheet("Приложение к Справке");

           PrintOneRow("N5_OurInn", m_RepCalc2.OurINN(), 12);
           PrintOneRow("N5_OurKpp", m_RepCalc2.OurKPP(), 9);

           PrintOneRow("N5_Num", string(m_PageNum:3:o), 3);

           PrintOneSumRow("N5_NumberRef", m_ByClientNumerator.GetNexNumbByClientId(PayerInfo.ClientID), 7, false);

           PrintOneSumRow("N5_Rate", Int(PayerInfo.ArrCodeParm[RateIndex].Rate), 2, false);
           PrintOneRow("N5_KBK", PayerInfo.ArrCodeParm[RateIndex].KBK, 20);

           var j = 1; //нужно для перехода на новую страницу, если NPTXCodeParmArr.Size() > 15
           
           //Если для печати всех элементов NPTXCodeParmArr не хватает одной страницы, то создаем новую страницу
           while((i < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size()) and (j <= CodesOnPageApp2))
              //Для того случая, когда NPTXCodeParmArr[i].MinusCodes не помещаются на одной странице
              if(IndexOfLastMinus == 0)
                 //пропускаем если основной объект не показывается, плюс все его коды вычета
                 if (((not PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].IsShow) or (PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSCode == NULL)) and 
                     (filter(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes,@FindIsShowMinusCode).size == 0))
                   i = i + 1;
                   continue;
                 end;

                 PrintOneSumRow("N5_MonthTax" + string(j) + "_", Int(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].Month), 2, false);

                 if((PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn > 0.0) and (PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].IsShow))
                    PrintOneRow("N5_In_Code" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSCode, 4);
                    PrintOneSumRow("N5_In_Sum" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn, 17, true);
                 end;
              end;
              IsMinus = false;

              if(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes.Size > 0)
                 var k = IndexOfLastMinus;

                 //Для последнего NPTXCodeParmArr[i] на одной странице (j = 14), если NPTXCodeParmArr[i].MinusCodes.Size > 1, то сначала печатаем один
                 //NPTXCodeParmArr[i].MinusCodes[0], затем создаём новую страницу и печатаем остальные NPTXCodeParmArr[i].MinusCodes
                 while((k < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes.Size) and (j <= 15))
                    //печатаем, только те что показываются
                    if (PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes[k].IsShow)
                      PrintOneRow("N5_Off_code" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes[k].MSCode, 3);
                      PrintOneSumRow("N5_Off_sum" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes[k].MSnnn, 16, true);
                      j = j + 1;
                      IsMinus = true;
                    end;
                    k = k + 1;
                 end;
                 
                 IndexOfLastMinus = 0;
                 if(j > 15)
                    IndexOfLastMinus = k;
                 end;
              else
                 PrintOneRow("N5_Off_code" + string(j) + "_", "", 3);
                 PrintOneSumRow("N5_Off_sum" + string(j) + "_", "", 16, true);
              end;

              if(IndexOfLastMinus == 0)
                 i = i + 1;
              end;
              if(not IsMinus)
                 j = j + 1;
              end;
           end;

           if(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size() > CodesOnPageApp2)
              m_CurrNameApp2 = m_CurrNameApp2 + " " + string(PageNum);
           end;

           PrintFormatString(NULL, "N5_Date", string(m_RepDate:f));
           CopyAllSheetInTotalBook("Приложение к Справке", false, "N5_PrintArea", 0, m_CurrNameApp2);

           PageNum = PageNum + 1;
        end;
      end;
   END;

   private macro CreateNodeSvSumDoh(CodeParm:NPTXPlusCodeParm)
      var nodeSvSumDoh = NULL, nodeSvSumVych = NULL;

      if((((CodeParm.PSCode != NULL) and (CodeParm.PSCode != "")) or ((CodeParm.MinusCodes != NULL) and (CodeParm.MinusCodes.size > 0)) ) and (CodeParm.IsShow))
         nodeSvSumDoh = m_XMLFile.CreateNode("СвСумДох",
                                             "Месяц", string(int(CodeParm.Month):o:2),
                                             "КодДоход", substr(CodeParm.PScode, 1, 4),
                                             "СумДоход", substr(string(ExtRound(CodeParm.PSnnn):0:2), 1, 17));

         if(nodeSvSumDoh != NULL)
            var i = 0;
            while(i < CodeParm.MinusCodes.Size)
               if (CodeParm.MinusCodes[i].IsShow)
                  nodeSvSumVych = m_XMLFile.CreateNode("СвСумВыч",
                                                       "КодВычет", substr(CodeParm.MinusCodes[i].MSCode, 1, 4),
                                                       "СумВычет", substr(string(ExtRound(CodeParm.MinusCodes[i].MSnnn):0:2), 1, 17));
                  if(nodeSvSumVych != NULL)
                     nodeSvSumDoh.appendChild(nodeSvSumVych);
                  end;
               end;

               i = i + 1;
            end;
         end;
      end;

      return nodeSvSumDoh;
   end;

   private macro CreateNodeDohVych(RateParm:NPTXRateParm)
      var nodeDohVych = NULL, nodeSvSumDoh = NULL;

      nodeDohVych = m_XMLFile.CreateNode("ДохВыч");

      if(nodeDohVych != NULL)
         var i = 0;
         while(i < RateParm.NPTXCodeParmArr.Size())
            nodeSvSumDoh = CreateNodeSvSumDoh(RateParm.NPTXCodeParmArr[i]);
            if(nodeSvSumDoh != NULL)
               nodeDohVych.appendChild(nodeSvSumDoh);
            end;
            i = i + 1;
         end;
      end;

      return nodeDohVych;
   end;

   private macro CreateNodeNalVychSSI(RateParm:NPTXRateParm, PayerInfo:NPTXPayerInfo)
      var nodeNalVychSSI = NULL, nodePredVychSSI = NULL, nodeUvedVych = NULL;

      nodeNalVychSSI = m_XMLFile.CreateNode("НалВычССИ");

      if(nodeNalVychSSI != NULL)
         /*if(m_RepCalc2.MinusG_618(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus) > 0.0)
            nodePredVychSSI = m_XMLFile.CreateNode("ПредВычССИ",
                                                    "КодВычет", "618",
                                                    "СумВычет", substr(string(ExtRound(m_RepCalc2.MinusG_618(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus)):0:2), 1, 17));
            if(nodePredVychSSI != NULL)
               nodeNalVychSSI.appendChild(nodePredVychSSI);
            end;
         end;
         if(m_RepCalc2.MinusG_619(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus) > 0.0)
            nodePredVychSSI = m_XMLFile.CreateNode("ПредВычССИ",
                                                    "КодВычет", "619",
                                                    "СумВычет", substr(string(ExtRound(m_RepCalc2.MinusG_619(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus)):0:2), 1, 17));
            if(nodePredVychSSI != NULL)
               nodeNalVychSSI.appendChild(nodePredVychSSI);
            end;
         end;*/

         /*nodeUvedVych = m_XMLFile.CreateNode("УведВыч",
                                             "КодВидУвед", ...,
                                             "НомерУвед", ...,
                                             "ДатаУвед", ...,
                                             "НОУвед", ...);*/
         
      end;

      return nodeNalVychSSI;
   end;

   private macro CreateNodeSvedDoh(RateParm:NPTXRateParm, PayerInfo:NPTXPayerInfo)
      var nodeSvedDoh = NULL, nodeSumItNalPer = NULL, nodeNalVychSSI = NULL, nodeSumDohNeud = NULL, nodeDohVych = NULL;

      nodeSvedDoh = m_XMLFile.CreateNode("СведДох",
                                         "Ставка", substr(string(RateParm.Rate:0:0), 1, 2),
                                         "КБК", RateParm.KBK
                                        );

      if(nodeSvedDoh != NULL)
         var taxBase = RateParm.PlusSum - RateParm.MinusSum;
         nodeSumItNalPer = m_XMLFile.CreateNode("СумИтНалПер",
                                                "СумДохОбщ", substr(string(ExtRound(RateParm.PlusSum):0:2), 1, 17),
                                                "НалБаза", substr(string(ExtRound(taxBase):0:2), 1, 17),
                                                "НалИсчисл", substr(string(ExtRound(RateParm.TaxCalculated, 0):0:0), 1, 15),
                                                "АвансПлатФикс", "0",
                                                "СумНалПрибЗач", substr(string(ExtRound(RateParm.Znp, 0):0:0), 1, 15),
                                                "СумНалИнГос", "0",
                                                "НалУдерж", substr(string(ExtRound(RateParm.TaxPaid+RateParm.TaxRefund, 0):0:0), 1, 15),
                                                "НалУдержЛиш", substr(string(ExtRound(max(RateParm.TaxPaid+RateParm.TaxRefund-RateParm.TaxCalculated,$0), 0):0:0), 1, 15));
         if(nodeSumItNalPer)
            nodeSvedDoh.appendChild(nodeSumItNalPer);
         end;

         nodeNalVychSSI = CreateNodeNalVychSSI(RateParm, PayerInfo);
         if(nodeNalVychSSI != NULL)
            nodeSvedDoh.appendChild(nodeNalVychSSI);
         end;

         nodeSumDohNeUd = m_XMLFile.CreateNode("СумДохНеУд",
                                               "СумДохНеУдерж", substr(string(ExtRound(ExtRound(RateParm.TaxDue,0) / RateParm.Rate * 100.0):0:2), 1, 17),
                                               "СумНеУдНал", substr(string(ExtRound(RateParm.TaxDue, 0):0:0), 1, 17));
         if(nodeSvedDoh != NULL)
            nodeSvedDoh.appendChild(nodeSumDohNeUD);
         end;

         nodeDohVych = CreateNodeDohVych(RateParm);
         if(nodeDohVych != NULL)
            nodeSvedDoh.appendChild(nodeDohVych);
         end;
      end;

      return nodeSvedDoh;
   end;

   private macro CreateNodeSpravDoh(partyNum)
      var nodeSpravDoh = NULL, nodePoluchDoh = NULL, nodePoluchDohFIO = NULL, nodeUdLichnFL = NULL, nodeSvedDoh = NULL;
      
      if ((NPTXPayerInfoArr[partyNum].ArrCodeParm == NULL) or (NPTXPayerInfoArr[partyNum].ArrCodeParm.size == 0))
        return NULL;
      end;

      var i = 0;
      while(i < NPTXPayerInfoArr[partyNum].ArrCodeParm.Size())
         if((NPTXPayerInfoArr[partyNum].ArrCodeParm[i].PlusSum != 0) or
            (NPTXPayerInfoArr[partyNum].ArrCodeParm[i].MinusSum != 0) or
            (NPTXPayerInfoArr[partyNum].ArrCodeParm[i].TaxCalculated != 0) or
            (NPTXPayerInfoArr[partyNum].ArrCodeParm[i].TaxPaid != 0) or
            (NPTXPayerInfoArr[partyNum].ArrCodeParm[i].TaxOver != 0) or
            (NPTXPayerInfoArr[partyNum].ArrCodeParm[i].TaxDue != 0) or
            (NPTXPayerInfoArr[partyNum].ArrCodeParm[i].TaxRefund != 0) or
            (NPTXPayerInfoArr[partyNum].ArrCodeParm[i].NPTXCodeParmArr.size > 0)
           )

           if(nodeSpravDoh == NULL)
             nodeSpravDoh = m_XMLFile.CreateNode("СправДох",
                                                 "НомСпр", string(m_ByClientNumerator.GetNexNumbByClientId(NPTXPayerInfoArr[partyNum].ClientID)),
                                                 "НомКорр", "00");

             if(nodeSpravDoh != NULL)
               nodePoluchDoh = m_XMLFile.CreateNode("ПолучДох",
                                                    "ИННФЛ", substr(NPTXPayerInfoArr[partyNum].ClientINN, 1, 12),
                                                    "Статус", substr(string(NPTXPayerInfoArr[partyNum].ResidenceStatus:0:0), 1, 1),
                                                    "ДатаРожд", string(NPTXPayerInfoArr[partyNum].DateBirth:f),
                                                    "Гражд", NPTXPayerInfoArr[partyNum].ResidenceCountry);

               if(nodePoluchDoh != NULL)
                  nodePoluchDohFIO = m_XMLFile.CreateNode("ФИО",
                                                          "Фамилия", substr(NPTXPayerInfoArr[partyNum].LastName, 1, 60),
                                                          "Имя", substr(NPTXPayerInfoArr[partyNum].FirstName, 1, 60),
                                                          "Отчество", substr(NPTXPayerInfoArr[partyNum].MiddleName, 1, 60));
                  if(nodePoluchDohFIO != NULL)
                     nodePoluchDoh.appendChild(nodePoluchDohFIO);
                  end;

                  nodeUdLichnFL = m_XMLFile.CreateNode("УдЛичнФЛ",
                                                       "КодУдЛичн", substr(string(NPTXPayerInfoArr[partyNum].DocumentType), 1, 2),
                                                       "СерНомДок", substr(string(NPTXPayerInfoArr[partyNum].DocumentNumber), 1, 25));
                  if(nodeUdLichnFL != NULL)
                     nodePoluchDoh.appendChild(nodeUdLichnFL);
                  end;

                  nodeSpravDoh.appendChild(nodePoluchDoh);
               end;
             end;
           end;
         
           if(nodeSpravDoh != NULL)
             nodeSvedDoh = CreateNodeSvedDoh(NPTXPayerInfoArr[partyNum].ArrCodeParm[i], NPTXPayerInfoArr[partyNum]);
             if(nodeSvedDoh != NULL)
                nodeSpravDoh.appendChild(nodeSvedDoh);
             end;
          end;
         end;
         i = i + 1;
      end;
         
      return nodeSpravDoh;
   end;

   private macro CreateNodeRaschSumNal()
      var nodeRaschSumNal = NULL, nodeSumNachisl = NULL, nodeSumNachislDiv = NULL, nodeSumNalUderzh = NULL, nodeSumNalNeUderzh = NULL, nodeSumNalIzlUderzh = NULL;
      var nodeSumNalVozvr = NULL;

      nodeRaschSumNal = m_XMLFile.CreateNode("РасчСумНал",
                                             "Ставка",             substr(string(m_RepCalc2.Rates().Value("t_Rate"):0:0), 1, 2),
                                             "КБК",                m_RepCalc2.Rates().Value("t_KBK"),
                                             "КолФЛ",              substr(string(m_RepCalc2.Rates().Value("t_CountFL"):0:0), 1, 6),
                                             "КолКвал",            "0",
                                             "СумНачислНач",       substr(string(m_RepCalc2.Rates().Value("t_TotalPlus"):0:2), 1, 17),
                                             "СумНачислКвал",      "0",
                                             "СумВыч",             substr(string(m_RepCalc2.Rates().Value("t_TotalMinus"):0:2), 1, 17),
                                             "НалБаза",            substr(string(ExtRound(m_RepCalc2.Rates().Value("t_TaxBaseSum")):0:2), 1, 15),
                                             "СумНалИсч",          substr(string(ExtRound(m_RepCalc2.Rates().Value("t_TaxCalculated"), 0):0:0), 1, 15),
                                             "СумНалИсчКвал",      "0",
                                             "СумФикс",            "0",
                                             "СумНалПриб",         substr(string(m_RepCalc2.Rates().Value("t_Znp"):0:0), 1, 15),
                                             "СумНалИнГос",        "0",
                                             "СумНалУдерж",        substr(string((m_RepCalc2.Rates().Value("t_TaxPaid")):0:0), 1, 15),
                                             "СумНалУдерж1Мес",    substr(string((m_RepCalc2.Rates().Value("t_TaxPaid1Data")):0:0), 1, 15),
                                             "СумНалУдерж23_1Мес", substr(string((m_RepCalc2.Rates().Value("t_TaxPaid2Data")):0:0), 1, 15),
                                             "СумНалУдерж2Мес",    substr(string((m_RepCalc2.Rates().Value("t_TaxPaid3Data")):0:0), 1, 15),
                                             "СумНалУдерж23_2Мес", substr(string((m_RepCalc2.Rates().Value("t_TaxPaid4Data")):0:0), 1, 15),
                                             "СумНалУдерж3Мес",    substr(string((m_RepCalc2.Rates().Value("t_TaxPaid5Data")):0:0), 1, 15),
                                             "СумНалУдерж23_3Мес", substr(string((m_RepCalc2.Rates().Value("t_TaxPaid6Data")):0:0), 1, 15),
                                             "СумНалНеУдерж",      substr(string(m_RepCalc2.Rates().Value("t_TaxDue"):0:0), 1, 15),
                                             "СумНалИзлУдерж",     substr(string(m_RepCalc2.Rates().Value("t_TaxOver"):0:0), 1, 15),
                                             "СумНалВозвр",        substr(string(m_RepCalc2.Rates().Value("t_TaxToReturnDue"):0:0), 1, 15),
                                             "СумНалВозвр1Мес",    substr(string((m_RepCalc2.Rates().Value("t_TaxToReturn1Data")):0:0), 1, 15),
                                             "СумНалВозвр23_1Мес", substr(string((m_RepCalc2.Rates().Value("t_TaxToReturn2Data")):0:0), 1, 15),
                                             "СумНалВозвр2Мес",    substr(string((m_RepCalc2.Rates().Value("t_TaxToReturn3Data")):0:0), 1, 15),
                                             "СумНалВозвр23_2Мес", substr(string((m_RepCalc2.Rates().Value("t_TaxToReturn4Data")):0:0), 1, 15),
                                             "СумНалВозвр3Мес",    substr(string((m_RepCalc2.Rates().Value("t_TaxToReturn5Data")):0:0), 1, 15),
                                             "СумНалВозвр23_3Мес", substr(string((m_RepCalc2.Rates().Value("t_TaxToReturn6Data")):0:0), 1, 15)
                                             );


      return nodeRaschSumNal;
   end;

   private macro CreateNodeObyazNA(KBKData)
      var nodeObyazNA = NULL, nodeSvedSumNalUd = NULL, nodeSvedSumNalVoz = NULL;
      var TaxToReturnDue = $0.0;
      var i = 0;

      nodeObyazNA = m_XMLFile.CreateNode("ОбязНА",
                                         "КБК", KBKData.m_KBK, 
                                         "СумНалУд", substr(string(KBKData.m_SumTotal:0:0), 1, 15),
                                         "СумНалВоз", substr(string(KBKData.m_SumRetTotal:0:0), 1, 15));

      m_IsCreatedXML = true;
      nodeSvedSumNalUd = m_XMLFile.CreateNode("СведСумНалУд",
                                              "СумНал1Срок", substr(string(KBKData.m_Sum021:0:0), 1, 15),
                                              "СумНал2Срок", substr(string(KBKData.m_Sum022:0:0), 1, 15),
                                              "СумНал3Срок", substr(string(KBKData.m_Sum023:0:0), 1, 15),
                                              "СумНал4Срок", substr(string(KBKData.m_Sum024:0:0), 1, 15),
                                              "СумНал5Срок", substr(string(KBKData.m_Sum025:0:0), 1, 15),
                                              "СумНал6Срок", substr(string(KBKData.m_Sum026:0:0), 1, 15)
                                             );

      nodeObyazNA.appendChild(nodeSvedSumNalUd); 

      nodeSvedSumNalVoz = m_XmlFile.CreateNode("СведСумНалВоз",
                                               "СумНалВоз1Срок", substr(string(KBKData.m_SumRet021:0:0), 1, 15),
                                               "СумНалВоз2Срок", substr(string(KBKData.m_SumRet022:0:0), 1, 15),
                                               "СумНалВоз3Срок", substr(string(KBKData.m_SumRet023:0:0), 1, 15),
                                               "СумНалВоз4Срок", substr(string(KBKData.m_SumRet024:0:0), 1, 15),
                                               "СумНалВоз5Срок", substr(string(KBKData.m_SumRet025:0:0), 1, 15),
                                               "СумНалВоз6Срок", substr(string(KBKData.m_SumRet026:0:0), 1, 15)
                                              );
      nodeObyazNA.appendChild(nodeSvedSumNalVoz);

      return nodeObyazNA;
   end;

   private macro CreateNodeNDFL62(year:Integer)
      var nodeNDFL62 = NULL, nodeObyazNA = NULL, RateExists = false, nodeRaschSumNal = NULL, nodeSpravDoh = NULL, nodeObyazNAHighRate = NULL;
      var partyNum = 0, rateNum = 0, RatesExists = false;
      var Lnk1, Lnk2, LnkPrev1, LnkPrev2/*, year = 0*/;
      var TaxDueQuery, TaxDueCmd, TaxDueDS, TaxDuePrevQuery, TaxDuePrevCmd, TaxDuePrevDS;
      var TaxDueSum = 0.0, TaxDuePrevSum = 0.0;
      var i = 0;

      nodeNDFL62 = m_XMLFile.CreateNode("НДФЛ6.2");

      if(nodeNDFL62 != NULL)
         if(m_IsPart1 == SET_CHAR)
            if(m_RepCalc.m_StatPart1)
               i = 0;
               while(i < m_RepCalc.m_Part1Collect.m_KBKDataArr.size)
                 var KBKData = m_RepCalc.m_Part1Collect.m_KBKDataArr[i];
               
                 nodeObyazNA = CreateNodeObyazNA(KBKData);

                 if(nodeObyazNA != NULL)
                   nodeNDFL62.appendChild(nodeObyazNA);
                   m_IsCreatedXML = true;
                 end;
               
                 i = i + 1;
               end;
            end;
         end;

         if(m_IsApp1 == SET_CHAR)
            InitProgress(NPTXPayerInfoArr.Size(), "Форма 6-НДФЛ 2024г", "Формирование узлов СправДох");

            while(partyNum < NPTXPayerInfoArr.Size())
               nodeSpravDoh = CreateNodeSpravDoh(partyNum);
               if (nodeSpravDoh != NULL)
                 nodeNDFL62.appendChild(nodeSpravDoh);
                 m_IsCreatedXML = true;
               end;
               UseProgress(partyNum = partyNum + 1);
            end;
            RemProgress();
         end;

         if(m_IsPart2 == SET_CHAR)
           RatesExists = m_RepCalc2.Rates().MoveNext();
           if(RatesExists)
              InitProgress(Int(m_RepCalc2.Rates().Value("t_Count")), "Форма 6-НДФЛ 2024г", "Формирование узлов РасчСумНал");
              while(RatesExists)
                 nodeRaschSumNal = CreateNodeRaschSumNal();
                 if(nodeRaschSumNal != NULL)
                    nodeNDFL62.appendChild(nodeRaschSumNal);
                    m_IsCreatedXML = true;
                 end;
                 UseProgress(rateNum = rateNum + 1);
                 RatesExists = m_RepCalc2.Rates().MoveNext();
              end;
              RemProgress();
           end;
         end;
      end;

      return nodeNDFL62;
   end;

   private macro CreateNodeSigner()
      var nodeSigner = NULL, nodeSignerFIO = NULL;

      nodeSigner = m_XMLFile.CreateNode("Подписант",
                                        "ПрПодп", "1");

      nodeSignerFIO = m_XMLFile.CreateNode("ФИО",
                                           "Фамилия", substr(m_RepCalc2.FirstPersonLastName(), 1, 60),
                                           "Имя", substr(m_RepCalc2.FirstPersonFirstName(), 1, 60),
                                           "Отчество", substr(m_RepCalc2.FirstPersonMiddleName(), 1, 60));
      nodeSigner.appendChild(nodeSignerFIO);

      return nodeSigner;
   end;

   private macro CreateNodeSvNP()
      var nodeSvNP = NULL, nodeNPUL = NULL, KPP = m_RepCalc2.OurKPP();

      if(substr(KPP, 5, 2) == "50")
         KPP = NULL;
      end;
      nodeSvNP = m_XMLFile.CreateNode("СвНП",
                                      "ОКТМО", substr(m_RepCalc2.OurOKTMO(), 1, 11),
                                      "Тлф", substr(m_RepCalc2.OurPhone(), 1, 20));
      nodeNPUL = m_XMLFile.CreateNode("НПЮЛ",
                                      "НаимОрг", substr(m_RepCalc2.OurName(), 1, 1000),
                                      "ИННЮЛ", substr(m_RepCalc2.OurINN(), 1, 10),
                                      "КПП", substr(KPP, 1, 9));
      nodeSvNP.appendChild(nodeNPUL);

      return nodeSvNP;
   end;

   private macro CreateNodeDocument()
      var nodeDocument = NULL, nodeSvNP = NULL, nodeSigner = NULL, nodeNDFL62 = NULL, year = 0;

      DateSplit(m_RepCalc2.EndDate(), NULL, NULL, year);
      nodeDocument = m_XMLFile.CreateNode("Документ",
                                          "КНД", "1151100",
                                          "ДатаДок", date_as_string(1, m_RepDate, false),
                                          "Период", m_RepCalc2.PP(),
                                          "ОтчетГод", year,
                                          "КодНО", substr(m_RepCalc2.OurFNSCode(), 1, 4),
                                          "НомКорр", "0",
                                          "ПоМесту", "214");
      nodeSvNP = CreateNodeSvNP();
      nodeDocument.appendChild(nodeSvNP);
      nodeSigner = CreateNodeSigner();
      nodeDocument.appendChild(nodeSigner);
      nodeNDFL62 = CreateNodeNDFL62(year);
      nodeDocument.appendChild(nodeNDFL62);

      return nodeDocument;
   end;

   private macro CreateXML()
      var day, month, year;
      var refID, num = "";
      var nodeFile = NULL, nodeDocument = NULL;
      var FileName = "", IndexFileName = 0;

      m_RepCalc2.ClearDataClient();

      DateSplit(m_RepCalc2.EndDate(), day, month, year);
      GetReferenceIDByType(134, 1, refID);
      GenerateReference(refID, num);
      m_XMLFile.SetFileName("NO_NDFL6.2_1_231_00_05_05_" + num + ".xml");

      FileName = m_XMLFile.GetFileName();
      IndexFileName = Index(FileName, ".xml");
      if(IndexFileName > 0)
         FileName = substr(FileName, 1, IndexFileName - 1);
      end;
      nodeFile = m_XMLFile.CreateNode("Файл",
                                      "ИдФайл", FileName,
                                      "ВерсПрог", "RS-Bank",
                                      "ВерсФорм", "5.05");

      if(nodeFile != NULL)
         nodeDocument = CreateNodeDocument();

         nodeFile.appendChild(nodeDocument);
         m_XMLFile.GetXMLObj().appendChild(nodeFile);
      end;
   end;

   private macro GetDateOfIncomeOperation(MinDate:Date, MaxDate:Date)
      var DateOperQuery = "select nvl(max(q.t_OperDate), ?) as t_OperDate " /*1*/
                        + "from ( "
                        + "        select max(nptxop.t_OperDate) as t_OperDate "
                        + "        from dnptxop_dbt nptxop "
                        + "        where nptxop.t_CLient = ? " /*2*/
                        + "          and nptxop.t_OperDate between ? and ? " /*3, 4*/
                        + "          and nptxop.t_Status > 0 "
                        + "          and ( "
                        + "                 ( "
                        + "                    nptxop.t_DocKind = " + string(DL_WRTMONEY)
                        + "                    and nptxop.t_SubKind_Operation = " + string(DL_NPTXOP_WRTKIND_WRTOFF)
                        + "                 ) "
                        + "                 or ( "
                        + "                       nptxop.t_DocKind = " + string(DL_CALCNDFL)
                        + "                       and nptxop.t_SubKind_Operation in( " + string(DL_TXBASECALC_OPTYPE_ENDYEAR) + ", "
                                                                                       + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS)
                                                                                + ") "
                        + "                    ) "
                        + "              ) "
                        + "          and exists( "
                        + "                       select 1 "
                        + "                       from dnptxobdc_dbt obdc "
                        + "                       where obdc.t_DocID = nptxop.t_ID "
                        + "                    ) "
                        + "        union "
                        + "        select max(tick.t_DealDate) as t_OperDate "
                        + "        from ddl_tick_dbt tick "
                        + "        where tick.t_ClientID = ? " /*5*/
                        + "              and tick.t_DealDate between ? and ? " /*6, 7*/
                        + "              and tick.t_DealStatus > 0 "
                        + "              and ( "
                        + "                     ( "
                        + "                        tick.t_BOfficeKind = " + string(DL_AVRWRT)
                        + "                        and tick.t_DealType = 2010 "
                       + "                      ) "
                        + "                  or ( "
                        + "                        tick.t_BOfficeKind = " + string(DL_RETIREMENT_OWN)
                        + "                        and tick.t_DealType = 2052 "
                        + "                        and exists( "
                        + "                                     select 1 "
                        + "                                     from dnptxobj_dbt obj "
                        + "                                     where obj.t_AnaliticKind1 = 1020 "
                        + "                                       and obj.t_Analitic1 = tick.t_DealID "
                        + "                                       and obj.t_Client = ? " /*8*/
                        + "                                  ) "
                        + "                     ) "
                        + "                  or ( "
                        + "                        tick.t_BOfficeKind = " + string(DL_RETURN_DIVIDEND)
                        + "                        and tick.t_DealType = 12108 "
                        + "                        and exists( "
                        + "                                     select 1 "
                        + "                                     from dnptxobj_dbt obj "
                        + "                                     where obj.t_AnaliticKind1 = 1100 "
                        + "                                       and obj.t_Analitic1 = tick.t_DealID "
                        + "                                       and obj.t_Client = ? " /*9*/
                        + "                                  ) "
                        + "                     ) "
                        + "                  ) "
                        + "        union "
                        + "        select max(dl_order.t_SignDate) as t_OperDate "
                        + "        from ddl_order_dbt dl_order "
                        + "        where dl_order.t_Contractor = ? " /*10*/
                        + "          and dl_order.t_SignDate between ? and ? " /*11, 12*/
                        + "          and dl_order.t_DocKind = " + string(DL_VEKSELDRAWORDER)
                        + "          and dl_order.t_Kind_Operation = " + string(VSOP_REPAY)
                        + "          and dl_order.t_ContractStatus > 0 "
                        + "     ) q ";

      var DateOperCmd = DL_RSDCommand(DateOperQuery);
      DateOperCmd.AddParam(MaxDate); /*1*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*2*/
      DateOperCmd.AddParam(MinDate); /*3*/
      DateOperCmd.AddParam(MaxDate); /*4*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*5*/
      DateOperCmd.AddParam(MinDate); /*6*/
      DateOperCmd.AddParam(MaxDate); /*7*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*8*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*9*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*10*/
      DateOperCmd.AddParam(MinDate); /*11*/
      DateOperCmd.AddParam(MaxDate); /*12*/

      var DateOperDS = DateOperCmd.Execute();
      if(DateOperDS.MoveNext())
         return Date(DateOperDS.OperDate);
      else
         return Date(0, 0, 0);
      end;
   end;

   private macro Create()
      var partyNum = 0;
      var RateStr = "";
      var PayExists = false;
      var Part2RateExists = false;

      var Sym = "";
      var Sym_ = "";
      var OldSym = "";
      var PoiNum = 0;
      var isFirst = true;
      var RateIndex = -1;
      var i = 0;

      NPTXPayerInfoArr.Size = 0;
      var CountFLPart2 = 0;
      if((m_IsPart2 == SET_CHAR) or (m_IsApp1 == SET_CHAR))
         NPTXPayerInfoArr = m_RepCalc2.GetNPTXPayerInfoArr();

         CountFLPart2 = NPTXPayerInfoArr.Size;
         if((m_IsPart2 == SET_CHAR) and (CountFlPart2 == 0))
            MsgBox("За отчетный период нет данных для раздела 2");
         elif((m_IsApp1 == SET_CHAR) and (CountFlPart2 == 0))
            MsgBox("За отчетный период нет данных для Приложения 1");
         end;
      end;

      if(m_IsPart1 == SET_CHAR)
         m_RepCalc = NPTXRepCalc_NPTXPIT6_NEW(m_P1BeginDate,
                                              m_P1EndDate,
                                              m_IsBOCB,
                                              m_IsDepo,
                                              m_IsVS,
                                              m_IsSOFR,
                                              m_IsDiasoft
                                             );

         m_RepCalc.Calculate();
         m_Part1PageCount = 0;
         if(not m_RepCalc.m_Part1Collect.ExistsData())
            MsgBox("За отчетный период нет данных для раздела 1");
         else
            if(not m_RepCalc.m_StatPart1)
               MsgBox("Неверно задана дата окончания отчетного периода для раздела 1");
            else
              m_Part1PageCount = m_Part1PageCount + m_RepCalc.m_Part1Collect.m_KBKDataArr.size;
            end;
         end;
      end;

      if((m_InXLS == SET_CHAR) or (m_InXML == SET_CHAR))
         if(CountFLPart2 > 0)
            if(m_IsApp1 == SET_CHAR)
               var k = 0;
               while(k < NPTXPayerInfoArr.Size)
                  m_NPTX2PageCount = m_NPTX2PageCount + NPTXPayerInfoArr[k].ArrCodeParm.Size;
                  k = k + 1;
               end;
            end;

            if( m_IsPart2 == SET_CHAR )
               Part2RateExists = m_RepCalc2.Rates().MoveNext();
               if(Part2RateExists)
                  m_Part2PageCount = Int(m_RepCalc2.Rates().Value("t_Count"));
               else
                  m_Part2PageCount = 0;
               end;
            else
               m_Part2PageCount = 0;
               Part2RateExists = false;
            end;
         end;

         if(m_InXLS == SET_CHAR)
           PrintTitle(1 + m_Part1PageCount + m_Part2PageCount + m_NPTX2PageCount * 2);
           if(m_IsPart1 == SET_CHAR)
              if(m_RepCalc.m_Part1Collect.ExistsData())
                 if(m_RepCalc.m_StatPart1)
                    PrintPart1();
                 end;
              end;
           end;
         end;

         if(CountFLPart2 > 0)
            
            if( m_IsPart2 == SET_CHAR )
              PrintPart2(Part2RateExists);
            end;
            if(m_InXLS == SET_CHAR)
              if(m_IsDetails)
                 PrintDetailsPart2();
              end;
              PoiNum = PoiNum + m_PageNum;
            end;

            if((m_IsApp1 == SET_CHAR) and (m_InXLS == SET_CHAR))
               partyNum = 0;
               i = 0;
               InitProgress(NPTXPayerInfoArr.Size, "Форма 6-НДФЛ 2024г", IIF(m_InXLS, "Печать приложения №1", "Распределение доходов и вычетов"));
               SheetsNamesNPTX2.Size = 0;
               SheetsNamesAttach2.Size = 0;

               while(i < NPTXPayerInfoArr.Size)
                  var NPTXPayer1;
                  var NPTXArrCodeParm = TArray();
                  var j = 0;
                  while(j < NPTXPayerInfoArr[i].ArrCodeParm.Size)
                     
                     if((NPTXPayerInfoArr[i].ArrCodeParm[j].PlusSum != 0) or
                        (NPTXPayerInfoArr[i].ArrCodeParm[j].MinusSum != 0) or
                        (NPTXPayerInfoArr[i].ArrCodeParm[j].TaxCalculated != 0) or
                        (NPTXPayerInfoArr[i].ArrCodeParm[j].TaxPaid != 0) or
                        (NPTXPayerInfoArr[i].ArrCodeParm[j].TaxOver != 0) or
                        (NPTXPayerInfoArr[i].ArrCodeParm[j].TaxDue != 0) or
                        (NPTXPayerInfoArr[i].ArrCodeParm[j].TaxRefund != 0) or
                        (NPTXPayerInfoArr[i].ArrCodeParm[j].NPTXCodeParmArr.size > 0)
                       )
                       m_CurrNameNPTX2 = GetCurrNameNPTX2(NPTXPayerInfoArr[i].LastName, NPTXPayerInfoArr[i].FirstName, NPTXPayerInfoArr[i].MiddleName);
                       PrintNPTXPit2(NPTXPayerInfoArr[i], j);
                       m_CurrNameApp2 = GetCurrNameAttach2(NPTXPayerInfoArr[i].LastName, NPTXPayerInfoArr[i].FirstName, NPTXPayerInfoArr[i].MiddleName);
                       PrintApp2(NPTXPayerInfoArr[i], j);
                       if(POI_MODE)
                          if(isFirst)
                             Sym = Substr(m_CurrNameNPTX2, 1, 3);
                          end;
                          Sym_ = Substr(m_CurrNameNPTX2, 1, 3);
                          ItogSym = Sym + "-" + Sym_;
                          if(PoiNum >= POI_SIZE_PACK)
                             SaveSubTotalBook(ItogSym, false);
                             CreateTotalBook();
                             PoiNum = 1;
                             isFirst = true;
                          else
                             PoiNum = PoiNum + 2;
                             isFirst = false;
                          end;
                       end;
                     end;
                     j = j + 1;
                  end;
                  UseProgress(i = i + 1);
               end;
               RemProgress();
            end;
         end;
      end;

      if(m_InXML == SET_CHAR)
         CreateXML();
      end;
   end;

   private macro EndReport(numCopy:Integer)
      SaveTotalBook();
      if((m_InXML == SET_CHAR) and m_IsCreatedXML)
         m_XMLFile.Save();
         MsgBox("Сформирован файл " + m_XMLFile.GetFileName());

         var fileName = m_XMLFile.GetFileName();
         var ToDir   = GetSaveRepPath();
         var FromName, FromExt;
         var FromDir = SplitFile(fileName, FromName, FromExt);
         
         if((ToDir != "") and (ToDir != FromDir))
           if(SC_CopyFile(FromDir, ToDir, FromName+FromExt, FromName+FromExt) != 0)
             msgbox("Ошибка при сохранении xml-файла отчета");
           end;
         end;
      end;

      if((m_InXML != SET_CHAR) and (POI_MODE) and (ItogSym != NULL) and (ItogSym != ""))
         SetLastTotalBookName(ItogSym);
         ItogSym = "";
      end;
   end;

   macro CReport_Show( NumCopy:INTEGER )
      var TaxPeriod;
      var day, mon, year;
      var hour, min, sec;
      var ToDir   = GetSaveRepPath();

      CReport_Show(NumCopy);

      DateSplit(m_P2EndDate, null, null, TaxPeriod);
      DateSplit(m_RepDate, day, mon, year);
      TimeSplit(time(), hour, min, sec);

      //отображение в отдельных приложениях сформированных файлов
      //для этого ещё было выключено отображение в конце формирования отчёта
      //SetIsShowAppl(false);
      //сделано это т.к. у нас при формировании файлы бьются на части
      //и во время формирования банку не нравилось, что файлы появлялись постепенно
      //да ещё и моргали
      for (var fileName, GetFullReportFileNames())
        //CDAOMSExcel(fileName,true).Show();
        var FromName, FromExt;
        var FromDir = IIF(not IsStandAlone(), "$","")+SplitFile(fileName, FromName, FromExt);
        
        if(ToDir != "")
          var addName = "";
          if(index(FromName, "-") == 4)
            addName = "_"+substr(FromName, 1, 7);
          end;

          var NewName = "6_NDFL_"+m_RepCalc2.PP()+"_"+string(TaxPeriod)+"_"+string(day:o:2)+string(mon:o:2)+string((year-2000):o:2)+"_"+string(hour:o:2)+string(min:o:2)+string(sec:o:2)+addName+".xls";
          
          if(SC_CopyFile(FromDir, ToDir, FromName+FromExt, NewName) != 0)
            msgbox("Ошибка при сохранении файла отчета");
          else
            SC_ShowFile(ToDir, NewName);
          end;
        end;

      end;
   end;


   initDL_CReportTemplate(NULL, "Report_NPTXPit6_NEW_DET_2024.xls", NULL, NULL, NULL, POI_MODE);
   SetPrintMode(DL_OUTREPORT_EXCEL);
   m_XMLFile = NPTXPit6_NEW_XML();
END;

PRIVATE MACRO LoadClientsFromFile(LoadFile, ClientsArr:@TArray)
  var objExcel = CDAOMSExcel();

  ClientsArr.size = 0;
  
  if(objExcel.CreateApplication())
    if(objExcel.open(LoadFile))
      objExcel.Book.Sheets(1).Activate();

      var activeSheet = objExcel.Book.ActiveSheet;

      InitProgress(activeSheet.Rows.CurrentRegion.Rows.Count, "Ждите, выполняется удаление проводок...", "Выполняется удаление проводок");
      var curr_row = 1;
      while(curr_row <= activeSheet.Rows.CurrentRegion.Rows.Count)

        var PartyID = trim(string(activeSheet.Cells(int(curr_row), 1).Value));

        if((PartyID == "") or (PartyID == NULL) or (PartyID == "Undefined"))
          break;
        end;

        PartyID = int(StrSubSt(PartyID," ",""));

        ClientsArr[ClientsArr.size] = PartyID;

        UseProgress(curr_row = curr_row + 1);
      end;

      RemProgress();
    end;
  end;

  objExcel = null;

OnError(er)
  MsgBox(er.Message);

  if(objExcel)
    if(objExcel.Book)
      objExcel.Book.Close();
    end;

    objExcel = null;
  end;
END;

PRIVATE MACRO GetDatePart(SubDirName)
  var RegistryPath = "РСХБ\\6-НДФЛ 2023\\"+SubDirName;
  var DatePart = "";
  var stat = 0;
 
  GetRegistryValue(RegistryPath, V_STRING, DatePart, stat);
  if((stat) or (DatePart == "")) 
    msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
    DatePart = date(0,0,0);
  else
    DatePart = date(trim(DatePart));
  end;

  return DatePart;
END;

private macro LoadTMPRetConf()
  var query, ins;

  SQL_Execute("DELETE FROM DNPTXRETCONF_TMP", "", false );

  ins = DL_RSDCommand("INSERT INTO DNPTXRETCONF_TMP (T_TAXPERIOD, T_DATEPART1, T_DATEPART2) SELECT T_TAXPERIOD, T_DATEPART1, T_DATEPART2 FROM DNPTXRETCONF_DBT");

  ins.ExecuteCMD();
end;

Form = NPTX_Pit6_NEW_FORM_2024();
while(Form.Run())
   SQL_Execute("DELETE FROM DNPTX6CLIENT_TMP");

   var IsPart1           = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P1_CHECKBOX);
   var P1BeginDate       = Date(Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P1_BEGDATE));
   var P1EndDate         = Date(Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P1_ENDDATE));
   var IsPart2           = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_CHECKBOX);
   var P2BeginDate       = Date(Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_BEGDATE));
   var P2EndDate         = Date(Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_ENDDATE));
   var IsApp1            = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_APP1_CHECKBOX);
   var App1EndDate       = Date(Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_APP1_ENDDATE));
   var ClientRadio       = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_CLIENT_RADIO);
   var CLients           = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_CLIENTCODE);
   var LoadFileRadio     = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_LOADFILE_RADIO);
   var LoadFile          = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_LOADFILE);
   var IsBOCB            = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_BOCB_CHECKBOX);
   var IsDepo            = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DEPO_CHECKBOX);
   var IsVS              = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_VS_CHECKBOX);
   var InXLS             = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_XLS_CHECKBOX);
   var InXML             = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_XML_CHECKBOX);
   var IsDetails         = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_ISDETAILS);
   var IsSOFR            = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_SOFR_CHECKBOX);
   var IsDiasoft         = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DIASOFT_CHECKBOX);
   var RepDate           = Date(Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE));
   var IsSlice           = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_SLICE_CHECKBOX);
   var SliceNum          = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_SLICE_NUM);
   var IsSliceDel        = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DELSLICE_CHECKBOX);
   var SliceNumDel       = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DELSLICE_NUM);
   var newSliceNum       = SliceNum;

   var NumberQuery = "select count(1) as t_Count " +
                       "from ddl_report_stat_dbt " +
                       "where t_ReportKind = " + string(NPTXPIT6NEW_REPORTKIND);

   var NumberCmd = DL_RSDCommand(NumberQuery);
   var NumberDS = NumberCmd.Execute();
   var NumCount = 1;
   if(NumberDS.MoveNext())
      NumCount = SQL_ConvTypeInteger(NumberDS.Count) + 1;
   end;

   if((LoadFileRadio == SET_CHAR) and (LoadFile != ""))
     Clients = TArray();
     LoadClientsFromFile(LoadFile, @Clients);
   end;
   
   LoadTMPRetConf();

   NPTX_Pit6_NEW_Report(IsPart1, P1BeginDate, P1EndDate, IsPart2, P2BeginDate, P2EndDate, IsApp1, App1EndDate, Clients, IsBOCB, IsDepo, IsVS, InXLS,
                        InXML, IsDetails, IsSOFR, IsDiasoft, RepDate
                       ).Run();

   if(IsSliceDel)
     if(delSlice(SliceNumDel, P2BeginDate, P2EndDate))
       newSliceNum = SliceNumDel;
     end;
   end;  

   if(IsSlice)
     insertSlice(newSliceNum, P2BeginDate, P2EndDate, NPTXPIT6_2024);
   end;

end;

Exit(1);
