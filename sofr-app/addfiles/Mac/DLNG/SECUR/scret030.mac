/* Операция Погашение ц/б
   Шаг - Погашение ц/б
   вставка поручения депо для депозитария                     */
import InsCarryDoc, "sp_car2.mac";

macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step )

  record deal(dl_tick);
  var    FD, dat;
  var    rq_avoir = TRecHandler("dlrq.dbt");

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, false ); 

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat );

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( not УчетДвиженияЦенныхБумаг( FD, Doc, dat ) )  
     return 1;
  end;

  rq_avoir = FD.GetRQ(DLRQ_TYPE_DELIVERY);

  if( not ТОВНеттинге(rq_avoir)) 
     if( not ПроводкаПоКатегориямВнутреннегоУчета( 55, 
                                                   FD, 
                                                   Doc, 
                                                   dat, 
                                                   rq_avoir.rec.FIID,  
                                                   rq_avoir.rec.Amount
                                                 ) )
         return 1;
     end;
  end;

  return 0;

end;

