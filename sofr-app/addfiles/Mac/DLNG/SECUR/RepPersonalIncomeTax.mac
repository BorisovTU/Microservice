/*
$Name:        RepPersonalIncomeTax.mac
$Module:      Ценные бумаги
$Description: Общие классы и функции 2-НДФЛ
*/

IMPORT "secinter.mac", RsbDataSet, PtInter, CtInter, DPInter, "globals.mac", "nptxfun.mac", SfInter, "spRepFun.mac";

CONST NumOurCountry = "643";

CONST INFORATE9_15         = 1; //справка по ставке 9 (15) %
CONST INFORATE_TOTAL       = 2; //справка по общей ставке
CONST INFORATE_35          = 3; //справка по ставке 35%(только для резидентов)
CONST INFORATE9_NOTRES_DIV = 4; //9% / ставке по дивидендам для нерезидентов.
CONST INFORATE_HIGHRATE_15 = 5; //справка по повышенной ставке (15%)

CONST Max15 = 5000000;

VAR IIS_CONTRACTS   = SET_CHAR;
VAR OTHER_CONTRACTS = SET_CHAR;

macro ExtRound(val:variant, dec:integer, noneg:bool)
  if (ValType(dec) == V_UNDEF)
    dec = 2;
  end;
  if (ValType(noneg) == V_UNDEF)
    noneg = false;
  end;
  var roundVal = Round(val,dec);
  //выглядит бессмыслицой, но в RSL бывают -0, которые эквивалентны 0
  if ((roundVal == 0) or (noneg and (roundVal < 0.0)))
    roundVal = 0.0;
  end;
  return roundVal;
end;

macro SortMinusCodeByGrp(left:Variant, right:Variant, data:Variant)
  var leftIdx = find(data, left.MSCode);
  var rightIdx = find(data, right.MSCode);
  return IIF(leftIdx > rightIdx, 1, (IIF(leftIdx < rightIdx, -1, 0)));
end;

//Пересекаются ли значения массивов
macro DL_ArrInclValInArr(arr1:TArray,arr2:TArray)
  var i = -1;
  var retVal = false;
  if ((ValType(arr1) != V_GENOBJ) or
      (ValType(arr2) != V_GENOBJ) or
      (not IsEqClass( "TArray", arr1 )) or
      (not IsEqClass( "TArray", arr2 )))
    return false;
  end;
  while ((i=i+1) < arr1.size)
    retVal = find(arr2,arr1[i]) != -1;
    if (retVal)
      return true;
    end;
  end;
  return false;
end;

macro FindIsShowMinusCode(elem:variant)
  if ((ValType(elem) == V_GENOBJ) and
      (IsEqClass("NPTXMinusCodeParm", elem)))
    return elem.IsShow;
  end;
  return false;
end;

MACRO GetTypeContract()
  if ( (IIS_CONTRACTS == SET_CHAR) and (OTHER_CONTRACTS != SET_CHAR) )
    return 1;
  elif ( (IIS_CONTRACTS != SET_CHAR) and (OTHER_CONTRACTS == SET_CHAR) )
    return 0;
  else
    return null;  // суммируем все НДР, без учета типа договора
  end;
END;

CLASS TaxAgentParm()
  var m_OurFNScode            = "";
  var m_OurInnAndKPP          = "";
  var m_OurName               = "";
  var m_OurOKTMO              = "";
  var m_OurOKVED              = "";
  var m_OurPhone              = "";
  var m_FirstPersonName       = "";
  var m_FirstPersonLastName   = "";
  var m_FirstPersonFirstName  = "";
  var m_FirstPersonMiddleName = "";

  macro Load()
    var query, DataSet;

    query =   " select pt.t_Name as Name, "

            + "        NVL((case when pt.t_TaxInstitution > 0 then "
            + "                                           (select objcode.t_Code "
            + "                                              from dobjcode_dbt objcode "
            + "                                             where objcode.t_ObjectType = " + OBJTYPE_PARTY
            + "                                               and objcode.t_CodeKind = " + PTCK_MNS
            + "                                               and objcode.t_ObjectID = pt.t_TaxInstitution "
            + "                                               and objcode.t_State = 0 "
            + "                                           )"
            + "                  else CHR(1) end ), CHR(1)) as FNScode, "

            + "        NVL((select objcode.t_Code "
            + "               from dobjcode_dbt objcode "
            + "              where objcode.t_ObjectType = " + OBJTYPE_PARTY
            + "                and objcode.t_CodeKind = " + PTCK_INN
            + "                and objcode.t_ObjectID = pt.t_PartyID "
            + "                and objcode.t_State = 0 "
            + "            ), CHR(1)) as INNAndKPP, "
/*
            + "        NVL((select objattr.t_NumInList "
            + "               from dobjattr_dbt objattr, dobjatcor_dbt objatcor "
            + "              where objatcor.t_objecttype = " + OBJTYPE_PARTY
            + "                and objatcor.t_groupid = 55 "
            + "                and objatcor.t_Object = LTRIM(TO_CHAR(pt.t_PartyID,'0000000000'))"
            + "                and objattr.t_objecttype = objatcor.t_objecttype "
            + "                and objattr.t_groupid = objatcor.t_groupid "
            + "                and objattr.t_AttrID = objatcor.t_AttrID"
            + "            ), CHR(1)) as OKTMOcode, "
*/
            + "        NVL((select objcode.t_Code "
            + "               from dobjcode_dbt objcode "
            + "              where objcode.t_ObjectType = " + OBJTYPE_PARTY
            + "                and objcode.t_CodeKind = 74 "  //в перечислении пока нет
            + "                and objcode.t_ObjectID = pt.t_PartyID "
            + "                and objcode.t_State = 0 "
            + "            ), CHR(1)) as OKTMOcode, "

            + "        NVL((select objattr.t_NumInList "
            + "               from dobjattr_dbt objattr, dobjatcor_dbt objatcor "
            + "              where objatcor.t_objecttype = " + OBJTYPE_PARTY
            + "                and objatcor.t_groupid = 64 "
            + "                and objatcor.t_Object = LTRIM(TO_CHAR(pt.t_PartyID,'0000000000'))"
            + "                and objattr.t_objecttype = objatcor.t_objecttype "
            + "                and objattr.t_groupid = objatcor.t_groupid "
            + "                and objattr.t_AttrID = objatcor.t_AttrID"
            + "                and objatcor.t_GENERAL = 'X' "
            + "            ), CHR(1)) as OKVEDcode, "

            + "   agent.t_Name as FirstPersonName, "
            + "   NVL(prs.t_Name1, chr(0)) as t_Name1, "
            + "   NVL(prs.t_Name2, chr(0)) as t_Name2, "
            + "   NVL(prs.t_Name3, chr(0)) as t_Name3 "

            + "   from dparty_dbt pt"
            + "        left join dofficer_dbt ofc on ofc.t_PartyID = pt.t_PartyID and ofc.t_IsFirstPerson = 'X' "
            + "        left join dparty_dbt agent on agent.t_PartyID = ofc.t_PersonID "
            + "        left join dpersn_dbt prs on prs.t_PersonID = ofc.t_PersonID "
            + "  where pt.t_PartyID = " + {OurBank}
            + "    and rownum = 1";

    DataSet = TRsbDataSet(query);
    if(DataSet.moveNext())
      m_OurFNScode            = DataSet.FNScode;
      m_OurInnAndKPP          = DataSet.INNAndKPP;
      m_OurName               = DataSet.Name;
      m_OurOKTMO              = DataSet.OKTMOcode;
      m_OurOKVED              = DataSet.OKVEDcode;
      FindAdressContactValue({OurBank}, PTADDR_LEGAL, CNTADR_PHONENUMBER, m_OurPhone);
      m_FirstPersonName       = DataSet.FirstPersonName;
      m_FirstPersonLastName   = DataSet.Name1;
      m_FirstPersonFirstName  = DataSet.Name2;
      m_FirstPersonMiddleName = DataSet.Name3;
    end;
  end;

  macro OurFNScode()
    return m_OurFNScode;
  end;

  macro OurInnAndKPP()
    return m_OurInnAndKPP;
  end;

  macro OurName()
    return m_OurName;
  end;

  macro OurOKTMO()
    return m_OurOKTMO;
  end;

  macro OurOKVED()
    return m_OurOKVED;
  end;

  macro OurPhone()
    return m_OurPhone;
  end;

  macro FirstPerson();
    return m_FirstPersonName;
  end;

  macro FirstPersonLastName();
    return m_FirstPersonLastName;
  end;

  macro FirstPersonFirstName();
    return m_FirstPersonFirstName;
  end;

  macro FirstPersonMiddleName();
    return m_FirstPersonMiddleName;
  end;

END;

CLASS NPTXMinusCodeParm(_MSCode, _MSnnn, _IsShow)
   var MSCode = _MSCode;
   var MSnnn = _MSnnn;
   var IsShow = IIF((ValType(_IsShow) != V_BOOL), true, _IsShow);
END;

CLASS NPTXPlusCodeParm(_month, _PCode, _PSum, _ЧНБ, _NOBKind, _MinusCodes, _IsShow)
  var Month   = _month;
  var PSCode  = _PCode;
  var PSnnn   = _PSum; 
  var ЧНБ     = _ЧНБ;
  var NOBKind = _NOBKind;
  var IsShow = IIF((ValType(_IsShow) != V_BOOL), true, _IsShow);
  var MinusCodes;
  if(_MinusCodes != NULL)
     MinusCodes = _MinusCodes;
  else
     MinusCodes = TArray();
  end;

  MACRO IndexOfMinusCode(_MSCode)
     var i = 0;
     while(i < MinusCodes.Size)
        if(MinusCodes[i].MSCode == _MSCode)
           return i;
        end;
        i = i + 1;
     end;

     return -1;
  END;
  
  macro GetMinusSum(_exludeNotShow, _sumWithRound)
    var exludeNotShow = IIF((ValType(_exludeNotShow) != V_BOOL), false, _exludeNotShow);
    var sumWithRound = IIF((ValType(_sumWithRound) != V_BOOL), false, _sumWithRound);
    var itog = $0;
    var i = -1;
    if (MinusCodes != NULL)
      while ((i=i+1) < MinusCodes.size)
        if(MinusCodes[i] != NULL)
          if (not (exludeNotShow and (not MinusCodes[i].IsShow)))
            itog = itog + IIF(sumWithRound,ExtRound(MinusCodes[i].MSnnn),MinusCodes[i].MSnnn);
          end;
        end;
      end;
    end;
    return itog;
  end;
END;

CLASS NPTXRateParm(_Month, _PSCode, _PSnnn, _MSCode, _MSnnn, _TaxBaseSum, _TaxCalculated, _TaxPaid, _TaxToReturnDue, _TaxDue, _Rate, _ЧНБ,
                          _DivPlus, _TaxCalculatedDiv, _TaxOver, _IsHighRate, _Znp, _DepoMinus, _isShowPlus, _isShowMinus, _isForce, _rateType, _nobkind, _income15, _KBK, _TaxRefund, _GroupNum)
  var NPTXCodeParmArr  = TArray();
  var Rate             = _Rate;
  var PlusSum          = 0.0;
  var MinusSum         = 0.0;
  var TaxBaseSum       = 0.0;
  var TaxCalculated    = 0.0;
  var TaxPaid          = 0.0;
  var TaxToReturnDue   = 0.0;
  var TaxDue           = 0.0;
  var DivPlus          = 0.0;
  var TaxCalculatedDiv = 0.0;
  var TaxOver          = 0.0;
  var IsHighRate       = _IsHighRate;
  var Znp              = IIF(_Znp == NULL, 0.0, _Znp);
  var DepoMinus        = 0.0;
  var RateType         = IIF(_rateType == NULL, -1, _rateType);
  var Income15         = IIF(_income15 == NULL, TArray(), _income15);
  var KBK              = IIF(_KBK == NULL, "", _KBK);
  var TaxRefund        = 0.0;
  var GroupNum         = IIF(_GroupNum == NULL, 0, _GroupNum);

  macro Add(Month, PSCode, PSnnn, MSCode, MSnnn, _TaxBaseSum, _TaxCalculated, _TaxPaid, _TaxToReturnDue, _TaxDue, _ЧНБ, _DivPlus, _TaxCalculatedDiv,
             _TaxOver, _DepoMinus, _isShowPlus, _isShowMinus, _isForce, _nobkind, _KBK, _TaxRefund, _GroupNum)
    var IsNPTXCodeExists = false;
    var MinusCodeIndex;
    var i = 0;
    if (_isForce == NULL)
      _isForce = false;
    end;

    if((((PSCode != NULL) or (MSCode != NULL)) and ((PSnnn != 0.0) or (MSnnn != 0.0))) or (_isForce))
       while(i < NPTXCodeParmArr.Size)
         if((PSCode == "") and (NPTXCodeParmArr[i].Month == Month) and (MSnnn != 0.0) and (MSCode != NULL))
           MinusCodeIndex = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
           if(MinusCodeIndex >= 0)
             NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn = NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn + MSnnn;
             IsNPTXCodeExists = true;
             break;
           else
             if( ((MSCode == "201") and (NPTXCodeParmArr[i].PSCode == "1530")) or
                 ((MSCode == "202") and (NPTXCodeParmArr[i].PSCode == "1531")) or
                 ((MSCode == "203") and (NPTXCodeParmArr[i].PSCode == "1536")) or
                 ((MSCode == "225") and (NPTXCodeParmArr[i].PSCode == "1544")) or
                 ((MSCode == "226") and (NPTXCodeParmArr[i].PSCode == "1545")) or
                 ((MSCode == "227") and (NPTXCodeParmArr[i].PSCode == "1549")) 
               )
               NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, Msnnn, _isShowMinus);
               IsNPTXCodeExists = true;
               break;
             end;
           end;
         elif((NPTXCodeParmArr[i].PSCode == PSCode) and (NPTXCodeParmArr[i].Month == Month))
           NPTXCodeParmArr[i].PSnnn = NPTXCodeParmArr[i].PSnnn + PSnnn;
           NPTXCodeParmArr[i].ЧНБ = NPTXCodeParmArr[i].ЧНБ + _ЧНБ;

           if ((MSnnn != 0.0) and (MSCode != NULL))

             MinusCodeIndex = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
             if(MinusCodeIndex >= 0)
                NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn = NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn + MSnnn;
             else
                NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, Msnnn, _isShowMinus);
             end;
           end;

           IsNPTXCodeExists = true;
           break;
         end;
         i = i + 1;
       end;
    end;

    if((not IsNPTXCodeExists) and (((PSCode != NULL) and (PSnnn != 0.0) or (MSCode != NULL) and (MSnnn != 0)) or (_isForce)))
      //Сортировка по месяцам кодов дохода для печати вкладки Приложение 1
      if(Month != NULL)
         i = 0;
         while(i < NPTXCodeParmArr.Size)
            if(NPTXCodeParmArr[i].Month != NULL)
               if(NPTXCodeParmArr[i].Month > Month)
                  var j = NPTXCodeParmArr.Size;
                  while (j > i)
                     NPTXCodeParmArr[j] = NPTXCodeParmArr[j - 1];
                     j = j - 1;
                  end;
                  NPTXCodeParmArr[i] = NPTXPlusCodeParm(Month, PSCode, PSnnn, _ЧНБ, _nobkind, NULL, _isShowPlus);
                  if ((MSnnn != 0.0) and (MSCode != NULL))

                    MinusCodeIndex = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
                    if(MinusCodeIndex >= 0)
                       NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn = NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn + MSnnn;
                    else
                       NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, Msnnn, _isShowMinus);
                    end;
                  end;

                  break;
               end;
            end;
            i = i + 1;
         end;
      end;

      if(i == NPTXCodeParmArr.Size)
        NPTXCodeParmArr[i] = NPTXPlusCodeParm(Month, PSCode, PSnnn, _ЧНБ, _nobkind, NULL, _isShowPlus);
        if ((MSnnn != 0.0) and (MSCode != NULL))

          MinusCodeIndex = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
          if(MinusCodeIndex >= 0)
             NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn = NPTXCodeParmArr[i].MinusCodes[MinusCodeIndex].MSnnn + MSnnn;
          else
             NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, Msnnn, _isShowMinus);
          end;
        end;
      end;
    end;

    PlusSum = PlusSum + PSnnn;
    MinusSum = MinusSum + MSnnn;
    TaxBaseSum = TaxBaseSum + _TaxBaseSum;
    TaxCalculated = TaxCalculated + _TaxCalculated;
    TaxPaid = TaxPaid + _TaxPaid;
    TaxToReturnDue = TaxToReturnDue + _TaxToReturnDue;
    TaxDue = TaxDue + _TaxDue;
    TaxOver = TaxOver + _TaxOver;
    if(_DivPlus == NULL)
      _DivPlus = 0.0;
    end;
    DivPlus = DivPlus + _DivPlus;
    if(_TaxCalculatedDiv == NULL)
      _TaxCalculatedDiv = 0.0;
    end;
    TaxCalculatedDiv = TaxCalculatedDiv + _TaxCalculatedDiv;
    if (_DepoMinus == NULL)
      _DepoMinus = 0.0;
    end;
    DepoMinus = DepoMinus + _DepoMinus;
    if(_TaxRefund == NULL)
      _TaxRefund = 0.0;
    end;
    TaxRefund = TaxRefund + _TaxRefund;
  end;

  macro Clear()
    NPTXCodeParmArr.Size = 0;
    Rate            = 0.0;
    PlusSum         = 0.0;
    MinusSum        = 0.0;
    TaxBaseSum      = 0.0;
    TaxCalculated   = 0.0;
    TaxPaid         = 0.0;
    TaxToReturnDue  = 0.0;
    TaxDue          = 0.0;
    TaxOver         = 0.0;
    DivPlus         = 0.0;
    IshighRate      = false;
    DepoMinus       = 0.0;
    TaxRefund       = 0.0;
  end;

  macro IndexOfCode(Month, PlusCode)
    var i = 0;
    while(i < NPTXCodeParmArr.Size)
      if((NPTXCodeParmArr[i].Month == Month) and (NPTXCodeParmArr[i].PSCode == PlusCode))
         return i;
      end;
      i = i + 1;
    end;

    return -1;
  end;

  Add(_Month, _PSCode, _PSnnn, _MSCode, _MSnnn, _TaxBaseSum, _TaxCalculated, _TaxPaid, _TaxToReturnDue, _TaxDue, _ЧНБ, _DivPlus, _TaxCalculatedDiv,
      _TaxOver, _DepoMinus, _isShowPlus, _isShowMinus, _isForce, _nobkind, _KBK, _TaxRefund, _GroupNum);
END;

MACRO IndexOfRate(Arr, Rate, IsHighRate, KBK, GroupNum)
  if(IsHighRate == NULL)
     IsHighRate = false;
  end;

  if(KBK == NULL)
     KBK = "";
  end;

  if(GroupNum == NULL)
     GroupNum = 0;
  end;

  var i = 0;
  while(i < Arr.Size)
     if((Arr[i].Rate == Rate) and (Arr[i].IsHighRate == IsHighRate) and (Arr[i].KBK == KBK) and (Arr[i].GroupNum == GroupNum))
        return i;
     end;
     i = i + 1;
  end;

  return -1;
END;

MACRO AddInArrCodeParms(Arr, _Month, _PSCode, _PSnnn, _MSCode, _MSnnn, _TaxBaseSum, _TaxCalculated, _TaxPaid, _TaxToReturnDue, _TaxDue,
                               _Rate, _ЧНБ, _DivPlus, _TaxCalculatedDiv, _TaxOver, _IsHighRate, _Znp, _DepoMinus, _isShowPlus, _isShowMinus, _isForce, _rateType, _nobkind, _KBK, _TaxRefund, _GroupNum)

  if(_PSnnn == NULL)
     _PSnnn = 0.0;
  end;
  if(_MSnnn == NULL)
     _MSnnn = 0.0;
  end;
  if(_TaxBaseSum == NULL)
     _TaxBaseSum = 0.0;
  end;
  if(_TaxCalculated == NULL)
     _TaxCalculated = 0.0;
  end;
  if(_TaxPaid == NULL)
     _TaxPaid = 0.0;
  end;
  if(_TaxToReturnDue == NULL)
     _TaxToReturnDue = 0.0;
  end;
  if(_TaxDue == NULL)
     _TaxDue = 0.0;
  end;
  if(_ЧНБ == NULL)
     _ЧНБ = 0.0;
  end;
  if(_DivPlus == NULL)
     _DivPlus = 0.0;
  end;
  if(_TaxCalculatedDiv == NULL)
     _TaxCalculatedDiv = 0.0;
  end;
  if(_TaxOver == NULL)
     _TaxOver = 0.0;
  end;
  if(_IsHighRate == NULL)
     _IsHighRate = false;
  end;
  if(_Znp == NULL)
     _Znp = 0.0;
  end;
  if (_DepoMinus == NULL)
     _DepoMinus = 0.0;
  end;
  if (_isShowPlus == NULL)
    _isShowPlus = true;
  end;
  if (_isShowMinus == NULL)
    _isShowMinus = true;
  end;
  if (_isForce == NULL)
    _isForce = false;
  end;
  if(_KBK == NULL)
    _KBK = "";
  end;
  if(_TaxRefund == NULL)
    _TaxRefund = 0.0;
  end;
  if(_GroupNum == NULL)
    _GroupNum = 0;
  end;

  var index = IndexOfRate(Arr, _Rate, _IsHighRate, _KBK, _GroupNum);
  if((_PSnnn != 0) or (_MSnnn != 0) or (_TaxPaid > 0) or (_TaxCalculated > 0) or (_TaxToReturnDue > 0) or (_TaxDue > 0) or (_DivPlus > 0) or
     (_TaxCalculatedDiv > 0) or (_TaxOver > 0) or (_TaxRefund) or (_isForce))
     if(_ЧНБ == NULL)
       _ЧНБ = 0.0;
     end;

     if(index >= 0)
       Arr[index].Add(_Month, _PSCode, _PSnnn, _MSCode, _MSnnn, _TaxBaseSum, _TaxCalculated, _TaxPaid, _TaxToReturnDue, _TaxDue, _ЧНБ, _DivPlus,
                      _TaxCalculatedDiv, _TaxOver, _DepoMinus, _isShowPlus, _isShowMinus, _isForce, _nobkind, _KBK, _TaxRefund, _GroupNum);
       return index;
     else
       Arr[Arr.Size] = NPTXRateParm(_Month, _PSCode, _PSnnn, _MSCode, _MSnnn, _TaxBaseSum, _TaxCalculated, _TaxPaid, _TaxToReturnDue, _TaxDue, _Rate,
                                    _ЧНБ, _DivPlus, _TaxCalculatedDiv, _TaxOver, _IsHighRate, _Znp, _DepoMinus, _isShowPlus, _isShowMinus, _isForce, _rateType, _nobkind, NULL, _KBK, _TaxRefund, _GroupNum);
       return Arr.Size - 1;
     end;
  else
     return -1;
  end;
END;

CLASS NPTXRepCalcCommon( _RepDate, _Investor, _IsConsiderDEPO, _IsConsiderCB, _IsConsiderVS, _IsAttach2, _IsNPTXPhysIISInfo )
  private var m_RepDate, m_Investor, m_CurrYear, m_ResidenceStatus;
  private var m_query, m_RS;
  private var m_PrevName="", m_CntEqualNames=0;
  private var m_BeginDate;
  private var m_EndDate;
  private var m_InfoRate;
  private var m_CurrSign;
  private var m_LegalAdress = TBFile("adress.dbt");
  private var m_PersnIdcMain = TBFile("persnidc.dbt");
  private var m_TaxAgentParm = NULL;
  private var m_TaxPaid = $0, m_TaxBaseSum = $0, m_TaxCalculated = $0, m_DivPaySec, m_BaseSpecialDiv, m_TaxDue = $0, m_TaxToReturnDue = $0, m_MinusG_618;
  private var m_MinusG_619;
  private var m_PaidGeneral_0;
  private var m_PaidSpecial_0;
  private var m_DivPay_Sec_0;
  private var m_Paid35_0;
  private var m_WasFindLegalAdr = false;
  private var m_IsConsiderCB = true;
  private var m_IsConsiderDEPO = false;
  private var m_IsConsiderVS = true /*false*/;
  private var SheetsNames = TArray();
  private var m_query_tmp;
  private var m_tmp_ready:bool = false;
  /*эти данные являются открытыми*/
  var m_TaxDivValArray  = TArray();
  var m_TaxDivValArrayCurIndex = 0;
  var m_PlusSum = $0, m_MinusSum = $0;
  var m_ArrCodeParms = TArray();
  var m_ArrCodeParmsCurIndex = 0;
  var m_PrintArrCodeParms = TArray();
  var m_countOfNum = 0;
  var m_count = 0;
  var m_Pg, m_Pm, m_Ps, m_Pp;
  var m_MaxOperDate:Date;

  MACRO ПолучитьМассивПараметровДляПечати()
    return m_PrintArrCodeParms;
  END;

  PRIVATE MACRO BaseSpecialDiv():money
     if( m_BaseSpecialDiv == null )
        DL_GetNPTXOBJSumByClient(this.ClientID(),
                                 string(TXOBJ_BASESPECIAL_DIV),
                                 date(1,1,m_CurrYear),
                                 m_RepDate,
                                 null,
                                 null,
                                 @m_BaseSpecialDiv,
                                 null,
                                 GetTypeContract()
                                );
     end;
     return m_BaseSpecialDiv;
  END;

  PRIVATE MACRO DivPaySec():money
     if( m_DivPaySec == null )
        DL_GetNPTXOBJSumByClient(this.ClientID(),
                                 string(TXOBJ_DIVPAY_SEC),
                                 date(1,1,m_CurrYear),
                                 m_RepDate,
                                 null,
                                 null,
                                 @m_DivPaySec,
                                 null,
                                 GetTypeContract()
                                );
     end;
     return m_DivPaySec;
  END;

  MACRO PaidGeneral_0()
     if( m_PaidGeneral_0 == null )
        if( m_InfoRate == INFORATE_TOTAL)
           m_PaidGeneral_0 = GetRubSumByClientOperDocKind(this.ClientID(), string(TXOBJ_PAIDGENERAL_0), date(1,1,m_CurrYear), m_RepDate, null, null, GetTypeContract());
        else
           m_PaidGeneral_0 = $0;
        end;
     end;
     return m_PaidGeneral_0;
  END;

  MACRO PaidSpecial_0(IsAttach2)
     if( m_PaidSpecial_0 == null)
        if( (m_InfoRate == INFORATE9_15) or (IsAttach2 and (m_InfoRate == INFORATE9_NOTRES_DIV)))
           m_PaidSpecial_0 = GetRubSumByClientOperDocKind(this.ClientID(), string(TXOBJ_PAIDSPECIAL_0), date(1,1,m_CurrYear), m_RepDate, null, null, GetTypeContract());
        else
           m_PaidSpecial_0 = $0;
        end;
     end;
     return m_PaidSpecial_0;
  END;

  MACRO DivPay_Sec_0()
     if( m_DivPay_Sec_0 == null )
        if( (m_InfoRate == INFORATE_TOTAL) and (this.ResidenceStatus() == 1))
           m_DivPay_Sec_0 = GetRubSumByClientOperDocKind(this.ClientID(), string(TXOBJ_DIVPAY_SEC_0), date(1,1,m_CurrYear), m_RepDate, null, null, GetTypeContract());
        else
           m_DivPay_Sec_0 = $0;
        end;
     end;
     return m_DivPay_Sec_0;
  END;

  MACRO Paid35_0()
     if( m_Paid35_0 == null )
        if( (m_InfoRate == INFORATE_35) and (this.ResidenceStatus() == 1))
           m_Paid35_0 = GetRubSumByClientOperDocKind(this.ClientID(), string(TXOBJ_PAID35_0), date(1,1,m_CurrYear), m_RepDate, null, null, GetTypeContract());
        else
           m_Paid35_0 = $0;
        end;
     end;
     return m_Paid35_0;
  END;

  MACRO ClearData()
    m_LegalAdress.Clear();
    m_PersnIdcMain.Clear();

    m_Pg = NULL;
    m_Pm = NULL;
    m_Ps = NULL;
    m_Pp = NULL;

    var i = 0;
    while(i < m_ArrCodeParms.Size)
      m_ArrCodeParms[i].NPTXCodeParmArr.Size = 0;
      i = i + 1;
    end;
    m_ArrCodeParms.size = 0;
    i = 0;
    while(i < m_PrintArrCodeParms.Size)
      m_PrintArrCodeParms[i].NPTXCodeParmArr.Size = 0;
      i = i + 1;
    end;
    m_PrintArrCodeParms.size = 0;
    m_TaxPaid = $0;
    m_TaxBaseSum = $0;
    m_TaxCalculated = $0;
    m_BaseSpecialDiv = null;
    m_DivPaySec = null;
    m_MinusG_618 = null;
    m_MinusG_619 = null;
    m_TaxDue = $0;
    m_TaxToReturnDue = $0;
    m_WasFindLegalAdr = false;
    m_PaidGeneral_0 = $0;
    m_PaidSpecial_0 = $0;
    m_DivPay_Sec_0 = $0;
    m_Paid35_0 = $0;
  END;

  MACRO Init(RepDate, Investor, IsConsiderDEPO, IsConsiderCB, IsConsiderVS, IsAttach2, IsNPTXPhysIISInfo )
    m_RepDate = m_EndDate = RepDate;
    m_Investor = Investor;
    m_CurrSign = 0;

    if(IsConsiderCB != null)
       m_IsConsiderCB = IsConsiderCB;
    end;

    if(IsConsiderDEPO != null)
       m_IsConsiderDEPO = IsConsiderDEPO;
    end;

    if(IsConsiderVS != null)
       m_IsConsiderVS = IsConsiderVS;
    end;

    if(IsAttach2 == null)
       IsAttach2 = false;
    end;

    if(IsNPTXPhysIISInfo == null)
       IsNPTXPhysIISInfo = false;
    end;

    DateSplit(m_RepDate, null, null, m_CurrYear);

    m_BeginDate = date(1, 1, m_CurrYear);

    m_query = " SELECT "
                + " pt.t_PartyID "
               + " ,pt.t_Name AS ClientFIO "
               + " ,pt.t_NotResident "
               + " ,persn.t_Name1 AS Name1 "
               + " ,persn.t_Name2 AS Name2 "
               + " ,persn.t_Name3 AS Name3 "
               + " ,persn.t_Born AS BirthDate "
               + " ,persn.t_BirsPlase "
               + " ,NVL((CASE "
                         + " WHEN pt.t_NRCountry <> CHR(1) "
                         + " THEN "
                             + " (SELECT "
                                  + " cn.t_CodeNum3 "
                              + " FROM "
                                  + " dcountry_dbt cn "
                              + " WHERE "
                                  + " cn.t_CodeLat3 = pt.t_NRCountry) "
                         + " ELSE "
                             + " CHR(1) "
                     + " END), CHR(1)) AS t_Citizenship "
               + " ,NVL((CASE "
                         + " WHEN pt.t_NotResident = 'X' "
                           + " OR (pt.t_NRCountry <> CHR(1) "
                          +  " AND pt.t_NRCountry <> 'RUS') "
                         + " THEN "
                             + " (SELECT "
                                  + " cn.t_CodeNum3 "
                              + " FROM "
                                  + " dadress_dbt adr "
                                 + " ,dcountry_dbt cn "
                              + " WHERE "
                                  + " adr.t_PartyID = pt.t_PartyID "
                              + " AND adr.t_Type = " + PTADDR_REAL + " "
                              + " AND adr.t_Country <> CHR(1) "
                              + " AND cn.t_CodeLat3 = adr.t_Country) "
                         + " ELSE "
                             + " CHR(1) "
                     + " END), CHR(1)) AS t_ResidenceCountry "
               + " ,NVL((CASE "
                         + " WHEN pt.t_NotResident = 'X' "
                           + " OR (pt.t_NRCountry <> CHR(1) "
                           + " AND pt.t_NRCountry <> 'RUS') "
                         + " THEN "
                             + " (SELECT "
                                  + " adr.t_Adress "
                              + " FROM "
                                  + " dadress_dbt adr "
                              + " WHERE "
                                  + " adr.t_PartyID = pt.t_PartyID "
                              + " AND adr.t_Type = " + PTADDR_REAL + ") "
                         + " ELSE "
                             + " CHR(1) "
                     + " END), CHR(1)) AS t_ResidenceAdress "
               + " ,NVL((SELECT "
                         + " objcode.t_Code "
                     + " FROM "
                         + " dobjcode_dbt objcode "
                     + " WHERE "
                         + " objcode.t_ObjectType = " + OBJTYPE_PARTY + " "
                     + " AND objcode.t_CodeKind = " + PTCK_INN + " "
                     + " AND objcode.t_ObjectID = pt.t_PartyID "
                     + " AND objcode.t_State = 0), CHR(1)) AS t_ClientINN "
               + " ,COUNT(1) OVER () AS COUNT "
               + " , ("
                     + "CASE "
                     + "WHEN EXISTS(SELECT 1 "
                                 + "FROM DSFCONTR_DBT sfcontr "
                                 + "WHERE sfcontr.T_PARTYID = pt.t_PartyID "
                                 + "  AND sfcontr.T_SERVKIND = 7 "
                                 + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_RepDate)
                                 + "  AND ( "
                                 + "         sfcontr.T_DATECLOSE >= " + GetSQLDate(m_RepDate)
                                 + "      OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy') "
                                 + "      ) "
                                 + ") "
               + "       AND NOT EXISTS(SELECT 1 "
                                     + "FROM DSFCONTR_DBT sfcontr, DDLCONTR_DBT dlcontr "
                                     + "WHERE sfcontr.T_PARTYID = pt.t_PartyID"
                                     + "  AND dlcontr.t_SfContrID = sfcontr.t_ID "
                                     + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_RepDate)
                                     + "  AND ( "
                                     + "         sfcontr.T_DATECLOSE >= " + GetSQLDate(m_RepDate)
                                     + "      OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy')"
                                     + "      ) "
                                     + ") "
                     + "THEN 1 "
                     + "ELSE 0 "
                     + "END "
               + "   ) as t_IsDepoClient"
            + " FROM "
                + " dparty_dbt pt "
               + " ,dpersn_dbt persn "
             + " WHERE "
                + " pt.t_LegalForm = " + legal_form_phys + " "
            + " AND (1 = " + IIF(m_IsConsiderCB, 1, 0) + " "
             + " AND EXISTS (SELECT "
                             + " 1 "
                         + " FROM "
                             + " dclient_dbt client "
                         + " WHERE "
                             + " client.t_ServiceKind IN (" + PTSK_STOCKDL + ", " + PTSK_DV + ", " + PTSK_DEPOS + ", " + PTSK_SVO + ") "
                             + " and client.t_StartDate < " + GetSQLDate(m_RepDate)
                             + " and ( "
                             + "         client.t_FinishDate > " + GetSQLDate(m_RepDate)
                             + "         or client.t_FinishDate = to_date('01.01.0001', 'dd.mm.yyyy') "
                             + "     ) "
                         + " AND client.t_PartyID = pt.t_PartyID) "
             + " AND EXISTS (SELECT "
                             + " 1 "
             + "               FROM dnptxobj_dbt txobj "
             + "              WHERE txobj.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate)
             + "                AND txobj.t_Client = pt.t_PartyID "
             + "                AND txobj.t_level >= 5 "
             + "                AND txobj.t_kind IN "
             + "                     (SELECT DISTINCT "
             + "                             kind.t_element "
             + "                        FROM dnptxkind_dbt kind "
             + "                       WHERE LOWER (t_code) LIKE "
             + "                               ('plus%')) " ;

       if( (OTHER_CONTRACTS == SET_CHAR) AND (IIS_CONTRACTS == UNSET_CHAR) )
         m_query = m_query  + " AND (RSI_NPTO.CheckContrIIS(txobj.t_Analitic6) = 0 "
                          + " OR txobj.t_Analitickind6 = 0 )" ;
       elif( (OTHER_CONTRACTS == UNSET_CHAR) AND (IIS_CONTRACTS == SET_CHAR) )
         m_query = m_query  + " AND RSI_NPTO.CheckContrIIS(txobj.t_Analitic6) = 1 ";
       end;
       m_query = m_query + " OR 1 = " + IIF(IsNPTXPhysIISInfo == false, "0", "1")
                         + " ) "
             + "  OR /*AND*/ (1 = " + IIF(OTHER_CONTRACTS == SET_CHAR, 1, 0) + " "    
              + " AND EXISTS (SELECT "
                              + " 1 "
                          + " FROM "
                              + " dnptxobj_dbt txobj "
                          + " WHERE "
                              + " txobj.t_Kind IN (" + TXOBJ_BASEMATERIAL + ", " + TXOBJ_BASEGENERAL + ", " + TXOBJ_BASESPECIAL + IIF(IsAttach2, ", " + TXOBJ_BASESPECIAL_DIV, "") + ") "
                          + " AND (txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                           + " AND RSI_NPTO.CheckContrIIS(txobj.t_Analitic6) = 0 "
                            + " OR txobj.t_Analitickind6 = 0) "
                          + " AND txobj.t_Client = pt.t_PartyID "
                          + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                          + " AND txobj.t_User <> chr(88) "
              + "            ) "
               + " OR 1 = " + IIF(IIS_CONTRACTS == SET_CHAR, 1, 0) + " "
              + " AND EXISTS (SELECT "
                              + " 1 "
                          + " FROM "
                              + " dnptxobj_dbt txobj "
                          + " WHERE "
                              + " txobj.t_Kind IN (" + TXOBJ_BASEMATERIAL_IIS + ", " + TXOBJ_BASEGENERAL_IIS + ", " + TXOBJ_BASESPECIAL_IIS + ") "
                          + " AND txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                          + " AND RSI_NPTO.CheckContrIIS(txobj.t_Analitic6) = 1 "
                          + " AND txobj.t_Client = pt.t_PartyID "
                          + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                          + " AND txobj.t_User <> chr(88) "
              + "            ) "
               + " OR EXISTS (SELECT "
                              + " 1 "
                          + " FROM "
                              + " dnptxobj_dbt txobj "
                          + " WHERE "
                              + " txobj.t_Kind IN (" + TXOBJ_BASE_35 + ") "
                          + " AND txobj.t_Client = pt.t_PartyID "
                          + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                          + " AND txobj.t_User <> chr(88) "
               + "           )) "
              + " OR 1 = " + IIF(m_IsConsiderDEPO, 1, 0) + " "
             + " AND (1 = " + IIF(OTHER_CONTRACTS == SET_CHAR, 1, 0) + " "
              + " AND EXISTS (SELECT "
                              + " 1 "
                          + " FROM "
                              + " dnptxobj_dbt txobj "
                          + " WHERE "
                              + " txobj.t_Kind IN (" + TXOBJ_BASEMATERIAL + ", " + TXOBJ_BASEGENERAL + ", " + TXOBJ_BASESPECIAL + IIF(IsAttach2, ", " + TXOBJ_BASESPECIAL_DIV, "") + ") "
                          + " AND (txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                           + " AND RSI_NPTO.CheckContrIIS(txobj.t_Analitic6) = 0 "
                            + " OR txobj.t_Analitickind6 = 0) "
                          + " AND txobj.t_Client = pt.t_PartyID "
                          + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                          + " AND txobj.t_User <> chr(88) "
              + "            ) "
               + " OR 1 = " + IIF(IIS_CONTRACTS == SET_CHAR, 1, 0) + " "
              + " AND EXISTS (SELECT "
                              + " 1 "
                          + " FROM "
                              + " dnptxobj_dbt txobj "
                          + " WHERE "
                              + " txobj.t_Kind IN (" + TXOBJ_BASEMATERIAL_IIS + ", " + TXOBJ_BASEGENERAL_IIS + ", " + TXOBJ_BASESPECIAL_IIS + ") "
                          + " AND txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                          + " AND RSI_NPTO.CheckContrIIS(txobj.t_Analitic6) = 1 "
                          + " AND txobj.t_Client = pt.t_PartyID "
                          + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                          + " AND txobj.t_User <> chr(88) "
              + "            ) "
               + " OR EXISTS (SELECT "
                              + " 1 "
                          + " FROM "
                              + " dnptxobj_dbt txobj "
                          + " WHERE "
                              + " txobj.t_Kind IN (" + TXOBJ_BASE_35 + ") "
                          + " AND txobj.t_Client = pt.t_PartyID "
                          + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                          + " AND txobj.t_User <> chr(88) "
               + "           )) "
              + " OR 1 = " + IIF(m_IsConsiderVS, 1, 0) + " "
             + " AND EXISTS (SELECT "
                             + " 1 "
                         + " FROM "
                             + " dnptxobj_dbt txobj "
                         + " WHERE "
                             + " txobj.t_Kind IN (" + TXOBJ_BASEBILL + ") "
                         + " AND txobj.t_Client = pt.t_PartyID "
                         + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                         + " AND txobj.t_User <> chr(88) "
            + "             )) "
            + " AND persn.t_PersonID = pt.t_PartyID "
            + " AND (1 = " + IIF(((ValType(Investor) != V_GENOBJ) and (Investor > 0)) or ((ValType(Investor) == V_GENOBJ) and (Investor[0] > 0)), 0, 1) + IIF(ValType(Investor) != V_GENOBJ, " OR pt.t_PartyID = " + Investor, " OR pt.t_PartyID in (");
            if((ValType(Investor) == V_GENOBJ) and (Investor[0] > 0))
               m_query = m_query + Investor[0];
               var i = 1;
               while(i < Investor.Size())
                  m_query = m_query + ", " + Investor[i];
                  i = i + 1;
               end;
               m_query = m_query + ")";
            end;
            m_query = m_query + ") ";
            // + " ORDER BY "
            //     + " persn.t_Name1 ASC "
            //    + " ,persn.t_Name2 ASC "
            //    + " ,persn.t_Name3 ASC ";

      m_query_tmp = " select "
                + " t_PartyID "
               + " ,t_ClientFIO AS ClientFIO "
               + " ,t_NotResident "
               + " ,t_Name1 AS Name1 "
               + " ,t_Name2 AS Name2 "
               + " ,t_Name3 AS Name3 "
               + " ,t_BirthDate AS BirthDate "
               + " ,t_BirsPlase "
               + " ,t_Citizenship "
               + " ,t_ResidenceCountry "
               + " ,t_ResidenceAdress "
               + " ,t_ClientINN "
               + " ,t_Count AS COUNT "
               + " ,t_IsDepoClient "
               + " from DNPTXREPCALC1_TMP "
            + " ORDER BY "
                + " t_Name1 ASC "
               + " ,t_Name2 ASC "
               + " ,t_Name3 ASC ";


    m_TaxAgentParm = TaxAgentParm();
    m_TaxAgentParm.Load();
  END;

   private macro ClearTmpTable()
      //SQL_Truncate("DNPTXREPCALC1_TMP");
      // DEF-40913, DEF-41360 при одновременной обработке запроса SetPerson по одному и тому же субъекту здесь происходит преждевременная фиксация транзакции
      SQL_Execute("delete from DNPTXREPCALC1_TMP");
   end;

   private macro LoadTmpTable():bool
      var query = " insert into DNPTXREPCALC1_TMP "
                  + " ( "
                  + " t_PartyID             " 
                  + " , t_ClientFIO         "
                  + " , t_NotResident       "
                  + " , t_Name1             "
                  + " , t_Name2             "
                  + " , t_Name3             "
                  + " , t_BirthDate         "
                  + " , t_BirsPlase         "
                  + " , t_Citizenship       "
                  + " , t_ResidenceCountry  "
                  + " , t_ResidenceAdress   "
                  + " , t_ClientINN         "
                  + " , t_Count             "
                  + " , t_IsDepoClient      "
                  + " ) "
                  + m_query;

      var cmd = RsdCommand(query);
      cmd.execute();
      return true;
   OnError()   
      return false;
   end;

   private macro InitTmpTable():bool
      var ret:bool = false;
      if(not m_tmp_ready)
         ClearTmpTable();
         ret = LoadTmpTable();
         m_tmp_ready = ret;
         return ret;
      end;
      return true;
   end;

  MACRO Count()
   //  return SQL_GetNRecs(m_query);
    InitTmpTable();
    return SQL_GetNRecs(m_query_tmp);
  END;

  MACRO Next()
    if(m_RS == NULL)
      InitTmpTable();
      // m_RS = TRsbDataSet(m_query);
      m_RS = TRsbDataSet(m_query_tmp);
    end;

    m_ResidenceStatus = -1;
    return m_RS.moveNext();
  END;
  
  MACRO MaxOperDate()
     return m_EndDate;
  END;

  //Получение названия листа для 2-НДФЛ и приложения №2
  macro GetCurrName()
    var Name = substr(string(m_RS.Name1), 1, 20) + substr(string(m_RS.Name2), 1, 1) + substr(string(m_RS.Name3), 1, 1);
    var NameSheet = "";
    var CntEqualNames = 0;

    NameSheet = Name;
    var i = 0;
    while(i < SheetsNames.Size)
      if(StrUpr(NameSheet) == StrUpr(SheetsNames[i]))
        CntEqualNames = CntEqualNames + 1;
        NameSheet = substr(Name, 1, 31 - StrLen(" " + string(CntEqualNames))) + " " + string(CntEqualNames);
        i = 0;
      else
        i = i + 1;
      end;
    end;

    SheetsNames[SheetsNames.Size] = NameSheet;

    return NameSheet;
  end;

  macro OurFNScode()
    return m_TaxAgentParm.OurFNScode();
  end;

  macro OurInnAndKPP()
    return m_TaxAgentParm.OurInnAndKPP();
  end;

  macro OurINN()
    var INN = "", KPP = "";
    SplitFullINN(this.OurInnAndKPP(), INN, KPP);
    return INN;
  end;

  macro OurKPP()
    var INN = "", KPP = "";
    SplitFullINN(this.OurInnAndKPP(), INN, KPP);
    return KPP;
  end;

  macro OurName()
    return m_TaxAgentParm.OurName();
  end;

  macro OurOKTMO()
    return m_TaxAgentParm.OurOKTMO();
  end;

  macro OurOKVED()
    return m_TaxAgentParm.OurOKVED();
  end;

  macro OurPhone()
    return m_TaxAgentParm.OurPhone();
  end;

  macro FirstPerson()
    return m_TaxAgentParm.FirstPerson();
  end;

  macro FirstPersonLastName();
    return m_TaxAgentParm.FirstPersonLastName();
  end;

  macro FirstPersonFirstName();
    return m_TaxAgentParm.FirstPersonFirstName();
  end;

  macro FirstPersonMiddleName();
    return m_TaxAgentParm.FirstPersonMiddleName();
  end;

  MACRO CurrYear()
    return m_CurrYear;
  END;

  MACRO ClientID()
    return m_RS.PartyID;
  END;

  MACRO IsDepoClient()
    return m_RS.IsDepoClient == 1;
  END;

  private macro ДополнитьРазрядыНулем(number)
   var i = 0;
   var  strNumber:string;
   strNumber = number;
   var CountAddNul = ((m_countOfNum+1) - strlen(strNumber));
    while(i < CountAddNul)
      strNumber = "0" + strNumber;
      i = i + 1;
    end;

    return strNumber;
  end;

  private macro GetPrintNumber(opNum)
    var str = substr(opNum, 1, (strlen(opNum) - (m_countOfNum+1)) );
    var cur:integer;
    cur = substr(opNum, strlen(opNum) - m_countOfNum);
    cur = cur + m_count;

    return (str + ДополнитьРазрядыНулем(cur));
  end;

  MACRO LegalAdr():TBFile
    if( (m_LegalAdress.rec.PartyID <= 0) and (m_WasFindLegalAdr == false))
       m_LegalAdress.AddFilter("t_PartyID = " + m_RS.PartyID + " and t_Type = " + PTADDR_LEGAL + " and t_Country = 'RUS'" );
       if(not m_LegalAdress.Next())
         /*ErrLog.LogError( "Не найден юридический адрес субъекта ID = " + string(m_RS.PartyID)  );*/
         m_LegalAdress.Clear();
       end;
       m_LegalAdress.DropFilter();
       m_WasFindLegalAdr = true;
    end;
    return m_LegalAdress;
  END;

  MACRO ClientPersnIdcMain()
    if( m_PersnIdcMain.rec.PersonID <= 0 )
       m_PersnIdcMain.AddFilter("t_PersonID = " + m_RS.PartyID + " and t_IsMain = 'X'");
       if(not m_PersnIdcMain.Next())
         m_PersnIdcMain.Clear();
       end;
       m_PersnIdcMain.DropFilter();
    end;
    return m_PersnIdcMain;
  END;

  MACRO ClientINN():STRING
    var RetVal:string = "";
    if( this.Citizenship() == NumOurCountry )
       RetVal = m_RS.ClientINN;
    end;
    return RetVal;
  END;

  MACRO ClientINN2():STRING
    var RetVal:string = "";
    if( this.Citizenship() != NumOurCountry )
       RetVal = m_RS.ClientINN;
    end;
    return RetVal;
  END;

  MACRO FIO():STRING
    return m_RS.ClientFIO;
  END;

  MACRO LastName():STRING
    return m_RS.Name1;
  END;

  MACRO FirstName():STRING
    return m_RS.Name2;
  END;

  MACRO MiddleName():STRING
    return m_RS.Name3;
  END;

  MACRO ResidenceStatus():INTEGER
    var RStatus = 0;
    var party;
    var NumInList = "";

    if (m_ResidenceStatus == -1)
       party = TBFile("party.dbt");
       party.rec.PartyID = this.ClientID();

       if( GetMainObjAttr(null, OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 42/*Является плательщиком НДФЛ*/, null, null, NumInList, m_RepDate) )
          RStatus = int(NumInList);
       end;

       if( RStatus == 0 )
          if(m_RS.NotResident)
             RStatus = 2;
          else
             RStatus = 1;
          end;
       end;
       m_ResidenceStatus = RStatus;
    end;
    return m_ResidenceStatus;
  END;

  MACRO DateBirth():DATE
    var retBirthDate = SQL_ConvTypeDate(m_RS.BirthDate);
    return IIF(retBirthDate == date(0,0,0), date(01,01,2001), retBirthDate);
  END;

  MACRO DateBirthDD():integer
    var Day;
    DateSplit(DateBirth(), Day, null, null);
    return Day;
  END;

  MACRO DateBirthMM():integer
    var Month;
    DateSplit(DateBirth(), null, Month, null);
    return Month;
  END;

  MACRO DateBirthYYYY():integer
    var Year;
    DateSplit(DateBirth(), null, null, Year);
    return Year;
  END;

  MACRO BirthPlace():string
    return SQL_ConvTypeStr(m_RS.BIRSPLASE);
  END;

  MACRO Citizenship():STRING
    //если вдруг гражданство не определено, то возвращаем гражданство РФ, если ДУЛ = Паспорт РФ
    if (trim(SQL_ConvTypeStr(m_RS.Citizenship)) == "")
      if (this.DocumentType() == "21")
        return NumOurCountry;
      end;
    end;
    return m_RS.Citizenship;
  END;

  MACRO DocumentType():STRING
    var ppk = TBFile("paprkind.dbt");
    if( ClientPersnIdcMain().rec.PersonID > 0 )
      ppk.rec.PaperKind = ClientPersnIdcMain().rec.PaperKind;
      if( ppk.GetEQ() )
        return ppk.rec.CodeDocum;
      end;
    end;
    return "";
  END;

  MACRO DocumentName():STRING
    var ppk = TBFile("paprkind.dbt");
    if( ClientPersnIdcMain().rec.PersonID > 0 )
      ppk.rec.PaperKind = ClientPersnIdcMain().rec.PaperKind;
      if( ppk.GetEQ() )
        return ppk.rec.Name;
      end;
    end;
    return "";
  END;

  MACRO DocumentNumber()
    var SerNum = ClientPersnIdcMain().rec.PaperSeries;

    /*Серия и номер паспорта выводится в формате НН НН СССССС(С) */
    if( (ClientPersnIdcMain().rec.PaperKind == 0/*паспорт*/) and (strlen(SerNum) == 4) )
      SerNum = substr(SerNum, 1, 2)+ " " + Substr(SerNum, 3, 2);
    end;

    return trim(SerNum +" "+ClientPersnIdcMain().rec.PaperNumber);
  END;

  MACRO Country():STRING
    return LegalAdr().rec.Country;
  END;

  MACRO MailIndex():STRING
    return LegalAdr().rec.PostIndex;
  END;

  MACRO RegionCode()
    return LegalAdr().rec.RegionNum;
  END;

  /*Район*/
  MACRO District():STRING
    return LegalAdr().rec.Province;
  END;

  /*Код района по КЛАДР*/
  MACRO CodeDistrict():STRING
    return LegalAdr().rec.CodeProvince;
  END;

  /*Город*/
  MACRO City():STRING
    return LegalAdr().rec.District;
  END;

  /*Код города по КЛАДР*/
  MACRO CodeCity():STRING
    return LegalAdr().rec.CodeDistrict;
  END;

  /*Населенный пункт*/
  MACRO Town():STRING
    return LegalAdr().rec.Place;
  END;

  /*Код населенный пункт по КЛАДР   */
  MACRO CodeTown():STRING
    return LegalAdr().rec.CodePlace;
  END;

  MACRO Street():STRING
    return LegalAdr().rec.Street;
  END;

  MACRO CodeStreet():STRING
    return LegalAdr().rec.CodeStreet;
  END;

  MACRO House():STRING
    return LegalAdr().rec.House;
  END;

  MACRO Building():STRING
    return LegalAdr().rec.NumCorps;
  END;

  MACRO Appartment():STRING
    return LegalAdr().rec.Flat;
  END;

  MACRO ResidenceCountry():STRING
    return m_RS.ResidenceCountry;
  END;

  MACRO ResidenceAdress():STRING
    return m_RS.ResidenceAdress;
  END;

  MACRO Rate(InfoRate):DOUBLE
    var Rate = 0;
    if(IsDepoClient() and (InfoRate == 0))
      Rate = m_ArrCodeParms[m_ArrCodeParmsCurIndex].Rate;
    else
      if(InfoRate == INFORATE9_15)
        if(this.ResidenceStatus() == 1)
          Rate = 9;
        else
          Rate = 15;
        end;
      elif( InfoRate == INFORATE_35 )
        if(this.ResidenceStatus() == 1)
           Rate = 35;
        else
           Rate = 30;
        end;

      elif ( InfoRate == INFORATE9_NOTRES_DIV )
        if(this.ResidenceStatus() == 1)
          Rate = 9;
        else
          //57 - Налоговая ставка для дивидендов в депозитарии
          //поскольку список (массив) значений примечаний-ставок для дивидентов в депозитарии
          //уже посчитан для текущего клиента, постольку просто возвращаем текущий используемый
          //естественно, при его отсутствии, возвращаем ставку по НК РФ - 15%
          if ( ( m_TaxDivValArray.size > 0) and ( m_TaxDivValArrayCurIndex  < m_TaxDivValArray.size ) )
          //т.е. индекс предыдущего элемента (инкрементированный после операции расчёта)
            Rate = m_TaxDivValArray[m_TaxDivValArrayCurIndex];
          else
          //if ( ( ПолучитьЗначениеПримечанияНаДату(m_RS.PartyID, 57, m_RepDate, @Rate) ) != 0 )
            Rate = 15;
          end;
        end;
      elif(InfoRate == INFORATE_HIGHRATE_15)
        Rate = 15;
      else
        /*b.  Для доходов, облагаемых по общей ставке*/
        if(this.ResidenceStatus() == 1)
          Rate = 13;
        else
          /*согласно ТЗ, при наличии выводится последнее действующее значение примечание ставки на дату отчёта*/
          if ( ( ПолучитьЗначениеПримечанияНаДату(m_RS.PartyID, 77, m_RepDate, @Rate) ) != 0 )
            Rate = 30;
          end;
        end;
      end;
    end;
    return Rate;
  END;

  MACRO Month(SectDate):INTEGER
    var Month = 0;

    DateSplit( SectDate, null, Month, null );

    return Month;
  END;

  PRIVATE MACRO GetNDRStrKind(KindCode)
    var Query, sql, rsd;
    var Element = 0;

    Query =   "select t_Element "
            + "  from dnptxkind_dbt "
            + " where t_Code = ?";

    sql =  RsdCommand(Query);

    sql.addParam( "", RSDBP_IN, KindCode );

    rsd = TRsbDataSet(sql);
    if(rsd.moveNext())
      Element = rsd.Element;
    end;
    return Element;
  END;

  PRIVATE MACRO LoadPSnnn( InfoRate, CodeStr,NotRoundPaid, Rate):MONEY
     var PSsum = $0, PSsum1 = $0, PSsum2 = $0;
     var PSKind = "";
     if( CodeStr != null )
        if( (InfoRate == INFORATE9_15) or (InfoRate ==INFORATE9_NOTRES_DIV) )
           if(this.ResidenceStatus() == 1)
             PSKind = "Plus9_"+string(CodeStr);
           else
             PSKind = "Plus15_"+string(CodeStr);
           end;
        elif( (InfoRate == INFORATE_35) and (this.ResidenceStatus() == 1) )
           PSKind = "Plus35_"+string(CodeStr);
        else
           if( CodeStr == "3023" )
              if( this.ResidenceStatus() != 1 )
                 PSKind = "Plus35_"+string(CodeStr);
              end;
           else
              PSKind = "PlusG_"+string(CodeStr);
           end;
        end;

        var AddWhere1 = "";
        var AddWhere2 = "";

        if( (PSKind != "")  )
           if(OTHER_CONTRACTS == SET_CHAR)
              AddWhere1 = " ( " +
                          "    RSI_NPTO.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 0 " +
                          "    or obj.t_AnaliticKind1 in (" + string(TXOBJ_KIND1115) + ", "
                                                            + string(TXOBJ_KIND1130) + ", "
                                                            + string(TXOBJ_KIND1125) + ", "
                                                            + string(TXOBJ_KIND1120) +
                                                        ")" +
                          "    or exists( " +
                          "                select 1 " +
                          "                from dnptxobdc_dbt obdc, doproper_dbt oproper, doprstep_dbt oprstep " +
                          "                where obdc.t_ObjID = obj.t_ObjID " +
                          "                  and oproper.t_ID_Operation = obdc.t_DocID " +
                          "                  and oproper.t_DocKind = " + string(DL_RETIREMENT_OWN) +
                          "                  and oprstep.t_ID_Operation = oproper.t_ID_Operation " +
                          "                  and oprstep.t_ID_Step = obdc.t_Step " +
                          "             ) " +
                          " ) ";

              DL_GetNPTXOBJSumByClient(this.ClientID(),
                                       GetNDRStrKind(PSKind),
                                       m_BeginDate,
                                       m_EndDate,
                                       TXOBJ_DIR_ALL,
                                       NULL,
                                       @PSsum1,
                                       NULL,
                                       NULL,
                                       NULL,
                                       AddWhere1,NotRoundPaid,Rate);
           end;

           if(IIS_CONTRACTS == SET_CHAR)
               AddWhere2 = " ( "
                           "    obj.t_AnaliticKind1 in ( " + string(TXOBJ_KIND1095) + ", "
                                                           + string(TXOBJ_KIND1098) +
                                                      ")" +
                           "    or exists( " +
                           "                select 1 " +
                           "                from dnptxobdc_dbt obdc, doproper_dbt oproper, doprstep_dbt oprstep " +
                           "                where obdc.t_ObjID = obj.t_ObjID " +
                           "                  and oproper.t_ID_Operation = obdc.t_DocID " +
                           "                  and oproper.t_DocKind = " + string(DL_RETIREMENT_OWN) +
                           "                  and oprstep.t_ID_Operation = oproper.t_ID_Operation " +
                           "                  and oprstep.t_ID_Step = obdc.t_Step " +
                           "             ) " +
                           "    or ( "
                           "          exists( " +
                           "                   select 1 " +
                           "                   from dnptxop_dbt nptxop " +
                           "                   where nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                           "                     and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                           "                     and nptxop.t_Client = " + string(ClientID()) +
                           "                     and nptxop.t_Status > 0 " +
                           "                     and nptxop.t_OperDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                           "                ) " +
                           "          and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                           "          and ( " +
                           "                 select sfcontr.t_DateClose " +
                           "                 from dsfcontr_dbt sfcontr " +
                           "                 where sfcontr.t_ID = obj.t_Analitic6 " +
                           "              ) between " + GetSQLDate(date(1, 1, m_CurrYear)) + " and " + GetSQLDate(m_RepDate) +
                           "       ) " +
                           " ) ";
               DL_GetNPTXOBJSumByClient(this.ClientID(),
                                        GetNDRStrKind(PSKind),
                                        m_BeginDate,
                                        m_EndDate,
                                        TXOBJ_DIR_ALL,
                                        NULL,
                                        @PSsum2,
                                        NULL,
                                        1,
                                        NULL,
                                        AddWhere2,NotRoundPaid,Rate);
           end;

           PSsum = PSsum1 + PSsum2;
        end;
     end;

     return PSsum;
  END;

  PRIVATE MACRO LoadMSnnn( InfoRate, CodeStr ):MONEY
    var MSsum = $0;
    var MSKind = "";
    var MSsum1 = $0, MSsum2 = $0;

    if( CodeStr != null )
       if( InfoRate == INFORATE9_15 )
          if(this.ResidenceStatus() == 1)
             MSKind = "Minus9_"+string(CodeStr);
          else
             MSKind = "Minus15_"+string(CodeStr);
          end;
       else
          MSKind = "MinusG_"+string(CodeStr);
       end;

       var AddWhere1 = "";
       var AddWhere2 = "";

       if(MSKind != "")
          if(OTHER_CONTRACTS == SET_CHAR)
             AddWhere1 = " ( " +
                         "    RSI_NPTO.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 0 " +
                         "    or obj.t_AnaliticKind1 in (" + string(TXOBJ_KIND1115) + ", "
                                                           + string(TXOBJ_KIND1130) + ", "
                                                           + string(TXOBJ_KIND1125) + ", "
                                                           + string(TXOBJ_KIND1120) +
                                                       ")" +
                         "    or exists( " +
                         "                select 1 " +
                         "                from dnptxobdc_dbt obdc, doproper_dbt oproper, doprstep_dbt oprstep " +
                         "                where obdc.t_ObjID = obj.t_ObjID " +
                         "                  and oproper.t_ID_Operation = obdc.t_DocID " +
                         "                  and oproper.t_DocKind = " + string(DL_RETIREMENT_OWN) +
                         "                  and oprstep.t_ID_Operation = oproper.t_ID_Operation " +
                         "                  and oprstep.t_ID_Step = obdc.t_Step " +
                         "             ) " +
                         " ) ";

             DL_GetNPTXOBJSumByClient(this.ClientID(),
                                      GetNDRStrKind(MSKind),
                                      m_BeginDate,
                                      m_EndDate,
                                      TXOBJ_DIR_ALL,
                                      NULL,
                                      @MSsum1,
                                      NULL,
                                      0,
                                      NULL,
                                      AddWhere1 );
          END;

          if(IIS_CONTRACTS == SET_CHAR)
              AddWhere2 = " ( "
                          "    obj.t_AnaliticKind1 in ( " + string(TXOBJ_KIND1095) + ", "
                                                          + string(TXOBJ_KIND1098) +
                                                     ")" +
                          "    or exists( " +
                          "                select 1 " +
                          "                from dnptxobdc_dbt obdc, doproper_dbt oproper, doprstep_dbt oprstep " +
                          "                where obdc.t_ObjID = obj.t_ObjID " +
                          "                  and oproper.t_ID_Operation = obdc.t_DocID " +
                          "                  and oproper.t_DocKind = " + string(DL_RETIREMENT_OWN) +
                          "                  and oprstep.t_ID_Operation = oproper.t_ID_Operation " +
                          "                  and oprstep.t_ID_Step = obdc.t_Step " +
                          "             ) " +
                          "    or ( "
                          "          exists( " +
                          "                   select 1 " +
                          "                   from dnptxop_dbt nptxop " +
                          "                   where nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                          "                     and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                          "                     and nptxop.t_Client = " + string(ClientID()) +
                          "                     and nptxop.t_Status > 0 " +
                          "                     and nptxop.t_OperDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                          "                ) " +
                          "          and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                          "          and ( " +
                          "                 select sfcontr.t_DateClose " +
                          "                 from dsfcontr_dbt sfcontr " +
                          "                 where sfcontr.t_ID = obj.t_Analitic6 " +
                          "              ) between " + GetSQLDate(date(1, 1, m_CurrYear)) + " and " + GetSQLDate(m_RepDate) +
                          "       ) " +
                          " ) ";
             DL_GetNPTXOBJSumByClient(this.ClientID(),
                                   GetNDRStrKind(MSKind),
                                   m_BeginDate,
                                   m_EndDate,
                                   TXOBJ_DIR_ALL,
                                   NULL,
                                   @MSsum2,
                                   NULL,
                                   1,
                                   NULL,
                                   AddWhere2 );
          end;

          MSsum = MSsum1 + MSsum2;
       end;
    end;

    return MSsum;
  END;

  MACRO PSnnn( InfoRate, PSCode, PSCodeStr,NotRoundPaid, Rate ):MONEY
    var PSsum = $0;

    var CodeStr = "";

    if( PSCode != null )
      if( ValType(PSCodeStr) == V_STRING )
        var _index = Index(PSCodeStr, "+");

        if( _index > 0 )
          while( _index > 0 )

            CodeStr = substr(PSCodeStr, 1, _index - 1);
            PSsum = PSsum + LoadPSnnn(InfoRate, CodeStr,NotRoundPaid, Rate);

            PSCodeStr = substr(PSCodeStr, _index + 1);
            _index = Index(PSCodeStr, "+");
          end;
        end;

        CodeStr = PSCodeStr;
        PSsum = PSsum + LoadPSnnn(InfoRate, CodeStr,NotRoundPaid, Rate);
      else
        CodeStr = string(PSCode);
        PSsum = LoadPSnnn(InfoRate, CodeStr,NotRoundPaid, Rate);
      end;

    end;

    return PSsum;
  END;

  MACRO MSnnn( InfoRate, MSCode, MSCodeStr ):MONEY
    var MSsum = $0;

    var CodeStr = "";

    if( MSCode != null )
      if( ValType(MSCodeStr) == V_STRING )
        var _index = Index(MSCodeStr, "+");

        if( _index > 0 )
          while( _index > 0 )

            CodeStr = substr(MSCodeStr, 1, _index - 1);
            MSsum = MSsum + LoadMSnnn(InfoRate, CodeStr);

            MSCodeStr = substr(MSCodeStr, _index + 1);
            _index = Index(MSCodeStr, "+");
          end;
        end;

        CodeStr = MSCodeStr;
        MSsum = MSsum + LoadMSnnn(InfoRate, CodeStr);
      else
        CodeStr = string(MSCode);
        MSsum = LoadMSnnn(InfoRate, CodeStr);
      end;

    end;

    return MSsum;
  END;

  MACRO TPaidAll(objstr:string, BegDate, EndDate, PrevDate ):money
     var v_TPaid = 0;
     /*********************************************************************************************************/
     /*полная проверка на поиск по нужной ставке                                                              */
     /*спиоск ставок m_TaxDivValArray формируется в Refresh_TaxDivValArray и вызывается в отчётах-наследниках */
     /*и должен браться из соответсвующих значений примечания нал. ставок                                     */
     /*для плательщиков НДФЛ                                                                                  */
     /*********************************************************************************************************/

     /*Дивиденты физ.нерез*/
     /*по ставкам из примечаний*/
     if ( ( m_InfoRate == INFORATE9_NOTRES_DIV ) and
          ( this.ResidenceStatus() != 1 )        and
          ( m_TaxDivValArray.size  != 0 )        and
          ( m_TaxDivValArrayCurIndex  < m_TaxDivValArray.size )
        )

       if (m_TaxDivValArray[m_TaxDivValArrayCurIndex] != 15.00)//п. 3 ст. 224 НК РФ
         v_TPaid = GetRubSumByClientOperDocKindAndNotetextKindVal(this.ClientID(),
                                                        objstr,
                                                        BegDate,
                                                        EndDate,
                                                        IIF(PrevDate != null, DL_HOLDNDFL, null),
                                                        PrevDate, NULL, 
                                                        57/*нал.ст. див. в деп.*/, m_TaxDivValArray[m_TaxDivValArrayCurIndex]); 
       else
         v_TPaid = 0.0;//совпадение с ставкой в НК РФ, сбрасываем, считать не надо, посчитаем на последнем заходе.
       end;
     end;

     /*Дивиденты физ.нерез*/
     /*по НКРФ и совпадающей с НКРФ (15%) ставке из примечания */
     if ( ( m_InfoRate == INFORATE9_NOTRES_DIV ) and
          ( this.ResidenceStatus() != 1 )        and
          ( ( m_TaxDivValArray.size  == 0) or ( m_TaxDivValArrayCurIndex  >= m_TaxDivValArray.size ) )
        )
        v_TPaid = GetRubSumByClientOperDocKindAndNotetextKindVal(this.ClientID(),
                                                objstr,
                                                BegDate,
                                                EndDate,
                                                IIF(PrevDate != null, DL_HOLDNDFL, null),
                                                PrevDate, NULL,
                                                57/*нал.ст. див. в деп.*/, 15.00, true);
        v_TPaid = v_TPaid + GetRubSumByClientOperDocKindAndNotetextKindVal(this.ClientID(),
                                                objstr,
                                                BegDate,
                                                EndDate,
                                                IIF(PrevDate != null, DL_HOLDNDFL, null),
                                                PrevDate, NULL,
                                                57/*нал.ст. див. в деп.*/, 15.00, false);
     end;

     /*НЕ Дивиденты физ.нерез*/
     if (  m_InfoRate != INFORATE9_NOTRES_DIV )
       v_TPaid = GetRubSumByClientOperDocKind(this.ClientID(),
                                              objstr,
                                              BegDate,
                                              EndDate,
                                              IIF(PrevDate != null, DL_HOLDNDFL, null),
                                              PrevDate ); //все: пользовательские и непользовательские
     end;
     return v_TPaid;
  END;

  MACRO GetTaxPaid( InfoRate ):MONEY
    var Query, sql, rsd;
    var objstr = "";
    var _TaxPaid = $0;

    macro GetPaid( str_txobj:string )
       var RetVal = GetRubSumByClientOperDocKind(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate, DL_CALCNDFL) + //созданные в операциях расчета НОБ
                    GetRubSumByClientOperDocKind(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate, 0 /*только пользовательские*/) +
                    GetRubSumByClientFromDepo(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate) + /*созданные в операции "Расчет выплат по ц/б" в депозитарии*/
                    GetRubSumByClientOperDocKind(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate, DL_WRTMONEY) + /*созданные в операции "Списание д/с"*/
                    GetRubSumByClientOperDocKind(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate, DL_RETURN_DIVIDEND) + //созданные в операции "Возврат дивидендов"
                    GetRubSumByClientOperDocKind(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate, DL_RETIREMENT_OWN) + // ??? созданные в операции "Погашение выпуска СЭБ"
                    GetRubSumByClientFromVeksel(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate, string(DL_VEKSELDRAWORDER)); // ??? созданные в операциях с собственными векселями
       if( m_RepDate == date(31,12,m_CurrYear) )
          //отбираются все НДР, созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
          RetVal = RetVal + GetRubSumByClientOperDocKind(this.ClientID(), str_txobj, NULL, NULL, DL_HOLDNDFL, date(1,1,m_CurrYear));
       else
          //отбираются только НДР с начала года и по отчетную дату, созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
          RetVal = RetVal + GetRubSumByClientOperDocKind(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate, DL_HOLDNDFL, date(1,1,m_CurrYear));
       end;

       return RetVal;
    end;

    macro GetPaid_IIS( str_txobj:string )
      var whereCond = " not Exists (select 1 "
                   + "               from dnptxobdc_dbt dc, doproper_dbt opr "
                   + "              where dc.t_ObjID = obj.t_ObjID "
                   + "                and opr.t_ID_Operation = dc.t_DocID "
                   + "                and opr.t_DocKind = " + SP_DEPOPER_DEPOACNT
                   + "            ) ";
      var contrCond;

      var Select, Query, DataSet, oper_date, Contract, last_open_date;
      var RetVal = GetRubSumByClientFromDepo(this.ClientID(), str_txobj, date(1,1,m_CurrYear), m_RepDate);

      Select = " select nvl(t_operdate, to_date('01010001', 'ddmmyyyy')) oper_date from dnptxop_dbt " +
               "  where t_client = ? and t_operdate >= ? and t_operdate <= ? " +
               "    and t_IIS = 'X' and t_subkind_operation = " + DL_TXBASECALC_OPTYPE_CLOSE_IIS +
               " order by t_operdate desc";

      Query = DL_RSDCommand(Select);
      Query.addParam(this.ClientID());
      Query.addParam(date(1,1,m_CurrYear));
      Query.addParam(m_RepDate);
      DataSet = Query.execute();

      if (DataSet.MoveNext())
        if (DataSet.oper_date != zerodate)
          oper_date = DataSet.oper_date;

          Select =  " SELECT NVL(t_ID, -1) Contr "+
                    "    FROM DSFCONTR_DBT "+
                    "   WHERE (T_ServKind =  " + PTSK_STOCKDL +
                    "          OR T_ServKind =  " + PTSK_DV + ")" +
                    "     AND rsi_npto.CheckContrIIS(T_ID) = 1"+  /* "ИИC" */
                    "     AND T_PartyID =  ? " + // pClient
                    "     AND T_DateBegin <= ? "+    // OperDate
                    "     AND (T_DateClose >= ? " +
                    "      OR  T_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
                    "ORDER BY T_ServKind";

          Query = DL_RSDCommand(Select);
          Query.addParam(this.ClientID());
          Query.addParam(oper_date);
          Query.addParam(oper_date);
          DataSet = Query.execute();

          if (DataSet.MoveNext())
            if (DataSet.Contr != -1)
              Contract = DataSet.Contr;

              Select = "SELECT DL.t_IISTransfer, DL.t_iislastopendate " +
                       "  FROM DDLCONTR_DBT DL, DDLCONTRMP_DBT MP " +
                       " WHERE DL.T_DLCONTRID = MP.T_DLCONTRID " +
                         " AND MP.t_sfcontrid = ?";
              Query = DL_RSDCommand(Select);
              Query.addParam(Contract);
              DataSet = Query.execute();

              if (DataSet.MoveNext())
                if (DataSet.IISTransfer == "X")
                  last_open_date = DataSet.iislastopendate;
                  if (last_open_date != zerodate)
                    Select = "select sf.t_id " +
                             "  from DDLCONTR_DBT DL, DDLCONTRMP_DBT MP, dsfcontr_dbt SF " +
                             " where DL.T_DLCONTRID = MP.T_DLCONTRID " +
                               " and sf.t_id = mp.t_sfcontrid and dl.t_iis = 'X' " +
                               " and (exists (select 1 from dsfcontr_dbt sf1 " +
                                             " where DL.T_SFCONTRID = sf1.t_id " +
                                               " and sf1.t_datebegin = ?) " +
                                " or DL.t_iislastopendate = ?) and sf.t_partyid = ? ";
                    Query = DL_RSDCommand(Select);
                    Query.addParam(last_open_date);
                    Query.addParam(last_open_date);
                    Query.addParam(this.ClientID());
                    DataSet = Query.execute();

                    while (DataSet.MoveNext())
                      contrCond = whereCond + " and obj.t_Analitic6 = " + DataSet.ID + " and obj.t_Analitickind6 = 6020 ";
                      RetVal = RetVal +
                        GetRubSumByClient(this.ClientID(), str_txobj, null, null, null, 1, NULL, contrCond);
                    end;
                  end;
                else
                  whereCond = whereCond + " and obj.t_Analitic6 = " + Contract + " and obj.t_Analitickind6 = 6020 ";
                  RetVal = RetVal +
                    GetRubSumByClient(this.ClientID(), str_txobj, null, null, null, 1, NULL, whereCond);
                end;
              else
                whereCond = whereCond + " and obj.t_Analitic6 = " + Contract + " and obj.t_Analitickind6 = 6020 ";
                RetVal = RetVal +
                  GetRubSumByClient(this.ClientID(), str_txobj, null, null, null, 1, NULL, whereCond);
              end;

            end;
          end;
        end;
      end;

      return RetVal;
    end;

    if( InfoRate == INFORATE9_15 )
       if( OTHER_CONTRACTS == SET_CHAR )
          _TaxPaid = _TaxPaid + GetPaid(string(TXOBJ_PAIDSPECIAL));

          if( this.ResidenceStatus() != 1 )
             _TaxPaid = _TaxPaid + TPaidAll(string(TXOBJ_DIVPAY_SEC), date(1,1,m_CurrYear), m_RepDate);

             if( m_RepDate == date(31,12,m_CurrYear) )
                _TaxPaid = _TaxPaid + TPaidAll(string(TXOBJ_DIVPAY_SEC), null, null, date(1,1,m_CurrYear));
             end;
          end;
       end;

       if(IIS_CONTRACTS == SET_CHAR)
          _TaxPaid = _TaxPaid + GetPaid_IIS(string(TXOBJ_PAIDSPECIAL_IIS));
       end;

    elif( InfoRate == INFORATE9_NOTRES_DIV )
       if( OTHER_CONTRACTS == SET_CHAR )
          _TaxPaid = _TaxPaid + GetPaid(string(TXOBJ_PAIDSPECIAL));

          if( this.ResidenceStatus() != 1 )
             _TaxPaid = _TaxPaid + TPaidAll(string(TXOBJ_DIVPAY_SEC), date(1,1,m_CurrYear), m_RepDate);

             if( m_RepDate == date(31,12,m_CurrYear) )
                _TaxPaid = _TaxPaid + TPaidAll(string(TXOBJ_DIVPAY_SEC), null, null, date(1,1,m_CurrYear));
             end;
          end;
       end;

    elif( InfoRate == INFORATE_35 )
       if( this.ResidenceStatus() == 1 )
          if( OTHER_CONTRACTS == SET_CHAR )
             _TaxPaid = _TaxPaid + GetPaid(string(TXOBJ_PAID_35));
          end;
       end;
    else
       if( (OTHER_CONTRACTS == SET_CHAR) and (IIS_CONTRACTS == SET_CHAR) )
          _TaxPaid = _TaxPaid + GetPaid(string(TXOBJ_PAIDGENERAL)+", "+string(TXOBJ_PAIDMATERIAL) + ", " + string(TXOBJ_PAIDBILL) + "," + string(TXOBJ_PAIDGENERAL_IIS)+", "+string(TXOBJ_DIVPAY_SEC)+", "+string(TXOBJ_PAIDMATERIAL_IIS) );
       elif( OTHER_CONTRACTS == SET_CHAR )
          _TaxPaid = _TaxPaid + GetPaid(string(TXOBJ_PAIDGENERAL)+", "+string(TXOBJ_PAIDMATERIAL)+", "+string(TXOBJ_PAIDBILL));

          if( this.ResidenceStatus() == 1 )
             _TaxPaid = _TaxPaid + TPaidAll(string(TXOBJ_DIVPAY_SEC), date(1,1,m_CurrYear), m_RepDate );
          end;

       elif (IIS_CONTRACTS == SET_CHAR)
         _TaxPaid = _TaxPaid + GetPaid_IIS(string(TXOBJ_PAIDGENERAL_IIS)+", "+string(TXOBJ_DIVPAY_SEC)+", "+string(TXOBJ_PAIDMATERIAL_IIS));
       end;
    end;

/*
    if (IIS_CONTRACTS == SET_CHAR)
      _TaxPaid = _TaxPaid + GetPaid_IIS(string(TXOBJ_PAIDGENERAL_IIS)+", "+string(TXOBJ_DIVPAY_SEC)+", "+string(TXOBJ_PAIDMATERIAL_IIS));
    end;
*/
    return round(_TaxPaid, 0);
  END;

  MACRO TaxPaid(Index)
    return m_PrintArrCodeParms[index].TaxPaid;
  END;

  MACRO PlusSum(Index)
    return m_PrintArrCodeParms[Index].PlusSum;
  END;

  MACRO TaxBaseSum(Index)
    return m_PrintArrCodeParms[Index].TaxBaseSum;
  END;

  MACRO TaxCalculated(Index)
    return m_PrintArrCodeParms[Index].TaxCalculated;
  END;

  MACRO TaxDue(Index)
    return m_PrintArrCodeParms[Index].TaxDue;
  END;

  MACRO TaxToReturnDue(Index)
    return m_PrintArrCodeParms[Index].TaxToReturnDue;
  END;

  MACRO Znp(Index)
    return m_PrintArrCodeParms[Index].Znp;
  END;

  MACRO ДобавитьПараметры( InfoRate, PSCode, PSCodeStr, MSCode, MSCodeStr )
  END;

  private macro AddRateIndex(Arr, Index)
    var i = 0;
    var IsExistIndex = false;

    if(Index >= 0)
       while(i < Arr.Size)
         if(Arr[i] == Index)
           IsExistIndex = true;
           break;
         end;
         i = i + 1;
       end;
    
       if(not IsExistIndex)
         Arr[Arr.Size] = Index;
       end;
    end;
  end;

  MACRO ДобавитьВсеПараметры(IsAttach2:BOOL, RateIndexes)
    var OldSize = m_ArrCodeParms.Size;
    if(this.IsDepoClient() /*and (OTHER_CONTRACTS == SET_CHAR) */and (m_InfoRate == 0))
       var DepoClntQuery = "select nvl(sum(q.t_PlusSum), 0) as t_PlusSum," +
                           "       nvl(sum(q.t_MinusSum), 0) as t_MinusSum," +
                           "       nvl(sum(q.t_TaxPaid), 0) as t_TaxPaid," +
                           "       nvl(sum(q.t_Znp), 0) * q.t_Rate / 100 as t_Znp," +
                           "       q.t_Rate," +
                           "       q.t_Month" +
                           " from" +
                           "    (" +
                           "       select nvl(PlusObj.t_Sum0, 0) as t_PlusSum," +
                           "              nvl(MinusObj.t_Sum0, 0) as t_MinusSum," +
                           "              nvl(TaxPaidObj.t_Sum0, 0) as t_TaxPaid," +
                           "              nvl(BaseG1_13Obj.t_Sum0, 0) - nvl(BaseSpecial_DivObj.t_Sum0, 0) as t_Znp, " +
                           "              dppmacc.t_TaxRate / 100 as t_Rate," +
                           "              EXTRACT(MONTH FROM dpcorpop.t_Date) as t_Month" +
                           "        from dnptxobj_dbt PlusObj," +
                           "             ddpcorpop_dbt dpcorpop," +
                           "             dparty_dbt party," +
                           "             dnptxobj_dbt MinusObj," +
                           "             ddppmacc_dbt dppmacc, " +
                           "             dnptxobj_dbt TaxPaidObj, " +
                           "             dnptxobj_dbt BaseG1_13Obj, " +
                           "             dnptxobj_dbt BaseSpecial_DivObj " +
                           "        where PlusObj.t_Client(+) = ?" +
                           "          and PlusObj.t_Kind(+) in(" + string(TXOBJ_PLUSG_1010) + ", " + string(TXOBJ_PLUS15_1010) + ", " + string(TXOBJ_PLUSG_1011) + ")" +
                           "          and PlusObj.t_Date(+) between ? and ?" +
                           "          and PlusObj.t_AnaliticKind1(+) in(" +
                                                                          string(TXOBJ_KIND1095) + ", " +
                                                                          string(TXOBJ_KIND1098) +
                                                                      ")" +
                           "          and dpcorpop.t_DocumentID = PlusObj.t_Analitic1 (+)" +
                           "          and dppmacc.t_DocumentID = dpcorpop.t_DocumentID" +
                           "          and dppmacc.t_HolderID = party.t_PartyID"
                           "          and party.t_PartyID = ?" +
                           "          and MinusObj.t_Client(+) = ?" +
                           "          and MinusObj.t_Date(+) between ? and ?" +
                           "          and MinusObj.t_Kind(+) = " + string(TXOBJ_MINUSG_601) +
                           "          and MinusObj.t_AnaliticKind1(+) in(" +
                                                                           string(TXOBJ_KIND1095) + ", " +
                                                                           string(TXOBJ_KIND1098) +
                                                                       ")" +
                           "          and MinusObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                           "          and TaxPaidObj.t_Kind(+) in(" +
                                                                    string(TXOBJ_DIVPAY_SEC) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL) + ", " +
                                                                    string(TXOBJ_PAID_35) +
                                                                ")" +
                           "          and TaxPaidObj.t_Client (+) = ?" +
                           "          and TaxPaidObj.t_AnaliticKind1(+) in(" +
                                                                             string(TXOBJ_KIND1095) + ", " +
                                                                             string(TXOBJ_KIND1098) +
                                                                         ")" +
                           "          and TaxPaidObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                           "          and TaxPaidObj.t_Date(+) between ? and ?" +
                           "          and BaseG1_13Obj.t_Client(+) = ? " +
                           "          and BaseG1_13Obj.t_Date(+) between ? and ? " +
                           "          and BaseG1_13Obj.t_Kind(+) = " + string(TXOBJ_BASEG1_13) +
                           "          and BaseG1_13Obj.t_AnaliticKind1(+) in ( " +
                                                                                string(TXOBJ_KIND1095) + ", " +
                                                                                string(TXOBJ_KIND1098) +
                                                                           ") " +
                           "          and BaseG1_13Obj.t_Analitic1(+) = dpcorpop.t_DocumentID " +
                           "          and BaseSpecial_DivObj.t_Client(+) = ? " +
                           "          and BaseSpecial_DivObj.t_Date(+) between ? and ? " +
                           "          and BaseSpecial_DivObj.t_Kind(+) = " + string(TXOBJ_BASESPECIAL_DIV) +
                           "          and BaseSpecial_DivObj.t_AnaliticKind1(+) in( " +
                                                                                      string(TXOBJ_KIND1095) + ", " +
                                                                                      string(TXOBJ_KIND1098) +
                                                                                 ") " +
                           "          and BaseSpecial_DivObj.t_Analitic1(+) = dpcorpop.t_DocumentID " +
                           "    ) q" +
                           " group by q.t_Month, q.t_Rate";

       var DepoClntSelect = DL_RSDCommand(DepoClntQuery);
       DepoClntSelect.AddParam(this.ClientID());
       DepoClntSelect.AddParam(m_BeginDate);
       DepoClntSelect.AddParam(m_EndDate);
       DepoClntSelect.AddParam(this.ClientID());
       DepoClntSelect.AddParam(this.ClientID());
       DepoClntSelect.AddParam(m_BeginDate);
       DepoClntSelect.AddParam(m_EndDate);
       DepoClntSelect.AddParam(this.ClientID());
       DepoClntSelect.AddParam(m_BeginDate);
       DepoClntSelect.AddParam(m_EndDate);
       DepoClntSelect.AddParam(this.ClientID());
       DepoClntSelect.AddParam(m_BeginDate);
       DepoClntSelect.AddParam(m_EndDate);
       DepoClntSelect.AddParam(this.ClientID());
       DepoClntSelect.AddParam(m_BeginDate);
       DepoClntSelect.AddParam(m_EndDate);
       var DepoClntDS = DepoClntSelect.execute();
       while(DepoClntDS.MoveNext())
          var DepoRateIndex = AddInArrCodeParms(m_ArrCodeParms, DepoClntDS.Month, 1010, DepoClntDS.PlusSum, 601, DepoClntDS.MinusSum, 0.0, 0.0, DepoClntDS.TaxPaid, 0.0, 0.0, DepoClntDS.Rate, 0.0, 0.0, 0.0, 0.0);
          AddRateIndex(RateIndexes, DepoRateIndex);
          m_PlusSum = m_PlusSum + DepoClntDS.PlusSum;
          m_MinusSum = m_MinusSum + DepoClntDS.MinusSum;
       end;
    end;

    if(m_InfoRate == INFORATE9_15)

       if( (not IsDepoClient()) /*and (OTHER_CONTRACTS == SET_CHAR) and IsAttach2*/ )
          ДобавитьПараметры(m_InfoRate, IIF(m_CurrSign == 2, null, 1010), null, 601);
       end;

       if( (OTHER_CONTRACTS == SET_CHAR) and (IIS_CONTRACTS == SET_CHAR) )
          ДобавитьПараметры(m_InfoRate, 1110, "1110+1110_ИИС", 218);
          ДобавитьПараметры(m_InfoRate, null, null, 219);
          ДобавитьПараметры(m_InfoRate, null, null, 233);
          ДобавитьПараметры(m_InfoRate, null, null, 234);
       elif( OTHER_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 1110, null, 218);
          ДобавитьПараметры(m_InfoRate, null, null, 219);
       elif( IIS_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 1110, "1110_ИИС", 233);
          ДобавитьПараметры(m_InfoRate, null, null, 234);
       end;

    elif(m_InfoRate == INFORATE9_NOTRES_DIV)
       if( (not IsDepoClient()) /*and (OTHER_CONTRACTS == SET_CHAR) and IsAttach2 */)
          ДобавитьПараметры(m_InfoRate, IIF(m_CurrSign == 2, null, 1010), null, 601);
       end;

       if( (OTHER_CONTRACTS == SET_CHAR) and (IIS_CONTRACTS == SET_CHAR) )
          ДобавитьПараметры(m_InfoRate, 1110, "1110+1110_ИИС", 218);
          ДобавитьПараметры(m_InfoRate, null, null, 219);
          ДобавитьПараметры(m_InfoRate, null, null, 233);
          ДобавитьПараметры(m_InfoRate, null, null, 234);
       elif( OTHER_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 1110, null, 218);
          ДобавитьПараметры(m_InfoRate, null, null, 219);
       elif( IIS_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 1110, "1110_ИИС", 233);
          ДобавитьПараметры(m_InfoRate, null, null, 234);
       end;

    elif( m_InfoRate == INFORATE_35 )

       if( this.ResidenceStatus() == 1 )
          if( OTHER_CONTRACTS == SET_CHAR )
             ДобавитьПараметры(m_InfoRate, IIF(m_CurrSign == 2, null, 3023), null, null);
          end;
       end;

    elif(m_InfoRate != 0)

       if( (not IsDepoClient()) and (OTHER_CONTRACTS == SET_CHAR) /*and IsAttach2*/ )
         ДобавитьПараметры(m_InfoRate, IIF(m_CurrSign == 2, null, 1010), null, 601);
       end;

       if(m_CurrSign != 2)
          if( (OTHER_CONTRACTS == SET_CHAR) and (IIS_CONTRACTS == SET_CHAR) )
             ДобавитьПараметры(m_InfoRate, 1011, "1011+1011_ИИС", null);
          elif( OTHER_CONTRACTS == SET_CHAR )
             ДобавитьПараметры(m_InfoRate, 1011, null, null);
          elif( IIS_CONTRACTS == SET_CHAR )
             ДобавитьПараметры(m_InfoRate, 1011, "1011_ИИС", null);
          end;
       end;

       if( OTHER_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 1110, null, null);

          ДобавитьПараметры(m_InfoRate, 1530, null, 201, "201+214");
          ДобавитьПараметры(m_InfoRate, null, null, 208);
          ДобавитьПараметры(m_InfoRate, null, null, 212);
          ДобавитьПараметры(m_InfoRate, null, null, 218, "218+218_1");
          ДобавитьПараметры(m_InfoRate, null, null, 222);    
          ДобавитьПараметры(m_InfoRate, null, null, 618);    

          ДобавитьПараметры(m_InfoRate, 1531, null, 202);
          ДобавитьПараметры(m_InfoRate, null, null, 219, "219+219_1");
          ДобавитьПараметры(m_InfoRate, null, null, 223);
          ДобавитьПараметры(m_InfoRate, null, null, 620, "620_3");

          ДобавитьПараметры(m_InfoRate, 1532, null, 205);
          ДобавитьПараметры(m_InfoRate, null, null, 206);
          ДобавитьПараметры(m_InfoRate, null, null, 209);

          ДобавитьПараметры(m_InfoRate, 1533, null, 620, "620_2");
          ДобавитьПараметры(m_InfoRate, null, null, 220);

          ДобавитьПараметры(m_InfoRate, 1535, null, 207);
          ДобавитьПараметры(m_InfoRate, null, null, 210);

          ДобавитьПараметры(m_InfoRate, 1536, null, 203);
          ДобавитьПараметры(m_InfoRate, null, null, 620, "620_1");
          ДобавитьПараметры(m_InfoRate, null, null, 224);

          ДобавитьПараметры(m_InfoRate, 1537, null, 211);

          ДобавитьПараметры(m_InfoRate, 1539, null, 213);
          if(m_CurrSign != 2)
            ДобавитьПараметры(m_InfoRate, 2800, null, null); 
          end;
       end;

       if( IIS_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 1110, "1110_ИИС", null);

          ДобавитьПараметры(m_InfoRate, 1544, null, 225, "225+214_ИИС");
          ДобавитьПараметры(m_InfoRate, null, null, 251);
          ДобавитьПараметры(m_InfoRate, null, null, 233);
          ДобавитьПараметры(m_InfoRate, null, null, 239);
          ДобавитьПараметры(m_InfoRate, null, null, 619);    

          ДобавитьПараметры(m_InfoRate, 1545, null, 226);
          ДобавитьПараметры(m_InfoRate, null, null, 234);
          ДобавитьПараметры(m_InfoRate, null, null, 240);

          ДобавитьПараметры(m_InfoRate, 1546, null, 250);
          ДобавитьПараметры(m_InfoRate, null, null, 228);
          ДобавитьПараметры(m_InfoRate, null, null, 252);

          ДобавитьПараметры(m_InfoRate, 1547, null, 235);

          ДобавитьПараметры(m_InfoRate, 1548, null, 229);
          ДобавитьПараметры(m_InfoRate, null, null, 241);

          ДобавитьПараметры(m_InfoRate, 1549, null, 227);
          ДобавитьПараметры(m_InfoRate, null, null, 236);

          ДобавитьПараметры(m_InfoRate, 1551, null, 230);

          ДобавитьПараметры(m_InfoRate, 1553, null, 231);
       end;

       if( (OTHER_CONTRACTS == SET_CHAR) and (IIS_CONTRACTS == SET_CHAR) )
          ДобавитьПараметры(m_InfoRate, 2640, "2640+2640_ИИС", null);
          ДобавитьПараметры(m_InfoRate, 2641, "2641+2641_ИИС", null);
       elif( OTHER_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 2640, null, null);
          ДобавитьПараметры(m_InfoRate, 2641, null, null);
       elif( IIS_CONTRACTS == SET_CHAR )
          ДобавитьПараметры(m_InfoRate, 2640, "2640_ИИС", null);
          ДобавитьПараметры(m_InfoRate, 2641, "2641_ИИС", null);
       end;

       if( (OTHER_CONTRACTS == SET_CHAR) and (this.ResidenceStatus() != 1) )
          ДобавитьПараметры(m_InfoRate, IIF(m_CurrSign == 2, null, 3023), null, null);
       end;

       var BaseG1_13 = 0.0;
       DL_GetNPTXOBJSumByClient(this.ClientID(),
                                TXOBJ_BASEG1_13,
                                NULL,
                                m_EndDate,
                                TXOBJ_DIR_ALL,
                                NULL,
                                @BaseG1_13,
                                NULL,
                                1,
                                NULL,
                                "" );

       var BaseSpecial_Div = 0.0;
       DL_GetNPTXOBJSumByClient(this.ClientID(),
                                TXOBJ_BASESPECIAL_DIV,
                                NULL,
                                m_EndDate,
                                TXOBJ_DIR_ALL,
                                NULL,
                                @BaseSpecial_Div,
                                NULL,
                                1,
                                NULL,
                                "" );

       var TotalRateIndex = IndexOfRate(m_ArrCodeParms, 13, false);
       if(TotalRateIndex >= 0)
          m_ArrCodeParms[TotalRateIndex].Znp = (BaseG1_13 - BaseSpecial_Div) * m_ArrCodeParms[TotalRateIndex].Rate / 100;
       end;
    end;
    if( (Month(m_EndDate) == "12") and (m_ArrCodeParms.Size == 0) )
       var sum = 0;
       var PaidGeneral = 0;
       var PaidMaterial = 0;
       var PaidSpecial = 0;

       if(m_InfoRate == INFORATE_TOTAL)
         DL_GetNPTXOBJSumByClient(this.ClientID(),
                                  GetNDRStrKind("PaidGeneral_ИИС"),
                                  NULL,
                                  m_EndDate,
                                  TXOBJ_DIR_ALL,
                                  NULL,
                                  @PaidGeneral,
                                  NULL,
                                  1,
                                  NULL,
                                  "" );

         DL_GetNPTXOBJSumByClient(this.ClientID(),
                                  GetNDRStrKind("PaidMaterial_ИИС"),
                                  NULL,
                                  m_EndDate,
                                  TXOBJ_DIR_ALL,
                                  NULL,
                                  @PaidMaterial,
                                  NULL,
                                  1,
                                  NULL,
                                  "" );
       end;
       if(m_InfoRate == INFORATE9_15)
         DL_GetNPTXOBJSumByClient(this.ClientID(),
                                  GetNDRStrKind("PaidSpecial_ИИС"),
                                  NULL,
                                  m_EndDate,
                                  TXOBJ_DIR_ALL,
                                  NULL,
                                  @PaidSpecial,
                                  NULL,
                                  1,
                                  NULL,
                                  "" );

       end;

       sum = PaidGeneral + PaidMaterial + PaidSpecial;
       AddInArrCodeParms(m_ArrCodeParms, Month(m_BeginDate), null, null, null, null, 0.0, sum, 0.0, 0.0, 0.0, Rate(m_InfoRate), 0.0);
    end;

    if(OldSize < m_ArrCodeParms.Size)
       AddRateIndex(RateIndexes, OldSize);
    end;
  END;

  MACRO РассчитатьПараметрыДляПечати(RateIndexes)
    // Если коду дохода соответствуют несколько кодов вычетов и сумма вычета, стоящая в одной строке с доходом нулевая, то вместо вычета с нулевой суммой выводим следующий по порядку ненулевой вычет.
    var i = 0;
    while( i < RateIndexes.size() )

       var PrintRateIndex = IndexOfRate(m_PrintArrCodeParms, m_ArrCodeParms[RateIndexes[i]].Rate, m_ArrCodeParms[RateIndexes[i]].IsHighRate, m_ArrCodeParms[RateIndexes[i]].KBK, m_ArrCodeParms[RateIndexes[i]].GroupNum);
       if(PrintRateIndex >= 0)
          m_PrintArrCodeParms[PrintRateIndex] = m_ArrCodeParms[RateIndexes[i]];
       else
          m_PrintArrCodeParms[m_PrintArrCodeParms.size] = m_ArrCodeParms[RateIndexes[i]];
          PrintRateIndex = m_PrintArrCodeParms.size - 1;
       end;

       /*var j = 0;
       while(j < m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr.Size)
          if((m_PrintArrCodeParms[PrintRateIndex].NPTXCodeParmArr[j].PScode != NULL) and ((m_PrintArrCodeParms[PrintRateIndex].NPTXCodeParmArr[j].MSnnn == NULL) or (m_PrintArrCodeParms[PrintRateIndex].NPTXCodeParmArr[j].MSnnn == 0)))
             var k = j + 1;
             while(k < m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr.Size)
                if(m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].PSCode != NULL)
                   break;
                end;

                if((m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].MSnnn != NULL) and (m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].MSnnn != 0))
                   m_PrintArrCodeParms[PrintRateIndex].NPTXCodeParmArr[j].MSCode = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].MSCode;
                   m_PrintArrCodeParms[PrintRateIndex].NPTXCodeParmArr[j].MSnnn = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].MSnnn;
                   m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].MSCode = NULL;
                   m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].MSnnn = 0;  
                   if((m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].PSCode = NULL) or (m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[k].PSnnn == 0) )
                     // полностью пустая строка
                     var s = k;
                     while(s < m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr.Size)
                       if((s+1)< m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr.Size)
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].MSCode = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s+1].MSCode;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].MSnnn  = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s+1].MSnnn;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].PSCode = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s+1].PSCode;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].PSnnn  = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s+1].PSnnn;  
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].Month  = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s+1].Month;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].ЧНБ    = m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s+1].ЧНБ;  
                       else
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].MSCode = NULL;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].MSnnn  = 0;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].PSCode = NULL;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].PSnnn  = 0;  
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].Month  = NULL;
                         m_ArrCodeParms[RateIndexes[i]].NPTXCodeParmArr[s].ЧНБ    = 0;
                       end;
                       s=s+1;
                     end;
                   end;
                   j = k;
                end;

                k = k + 1;
             end;
          end;

          j = j + 1;
       end;*/

       if(m_CurrSign == 2)
          m_PrintArrCodeParms[PrintRateIndex].MinusSum = 0.0;
       end;

       i = i + 1;
    end;
  END;

  MACRO BeginDate()
    return m_BeginDate;
  END;

  MACRO EndDate()
    return m_EndDate;
  END;

  MACRO Refresh_TaxDivValArray()
    m_TaxDivValArrayCurIndex = 0;
    m_TaxDivValArray  = TArray();
    m_TaxDivValArray.size = 0;
    ПолучитьСписокЗначенийПримечанияЗаПериодПоКлиенту(this.ClientID(), 57/*Налоговая ставка для дивидендов в депозитарии*/, this.BeginDate(), this.EndDate(), @this.m_TaxDivValArray);
  END;

  this.Init(_RepDate, _Investor, _IsConsiderDEPO, _IsConsiderCB, _IsConsiderVS, _IsAttach2, _IsNPTXPhysIISInfo);
END;

CLASS (NPTXRepCalcCommon) NPTXRepCalc_NPTXPIT6(_Investors, _BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS, _RepDate)
   var m_ByCB = UNSET_CHAR;
   var m_ByDepo = UNSET_CHAR;
   var m_ByVS = UNSET_CHAR;
   var m_RepDate2 = ZeroDate;
   var m_Amount = 0;
   var m_Cmd2 = null;
   var m_Set2 = null;
   var m_Query2 = "";

   //костыль по корректной группировке 
   private var cCodeGroups;
   private var cCodeGroupsValue;

   macro InitCodeGroups()
      cCodeGroups = TArray();
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1530",makeArray("201","214","208","212","218","218_1","222", "618"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1531",makeArray("202","219","219_1","223","620_3"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1532",makeArray("205","206","209"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1533",makeArray("620_2","220"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1535",makeArray("207","210"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1536",makeArray("203","620_1","224"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1537",makeArray("211"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1539",makeArray("213"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1544",makeArray("225","214_IIS","251","233","239", "619"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1545",makeArray("226","234","240"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1546",makeArray("250","228","252"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1547",makeArray("235"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1548",makeArray("229","241"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1549",makeArray("227","236"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1551",makeArray("230"));
      cCodeGroups[cCodeGroups.size] = DL_KeyPair("1553",makeArray("231"));
      cCodeGroupsValue = map(cCodeGroups,@DL_KeyPairToValue);
   end;

   macro GetCodeGroups()
     if (ValType(cCodeGroups) == V_UNDEF)
       InitCodeGroups();
     end;
     return cCodeGroups;
   end;

   macro GetCodeGroupsValue()
     if (ValType(cCodeGroups) == V_UNDEF)
       InitCodeGroups();
     end;
     return cCodeGroupsValue;
   end;

   MACRO MinusG_618()
     if( m_MinusG_618 == null )
        if( (m_InfoRate == INFORATE_TOTAL) and (this.ResidenceStatus() == 1) )
           m_MinusG_618 = GetRubSumByClientOperDocKind(this.ClientID(), string(TXOBJ_MINUSG_618), date(1,1,m_CurrYear), m_RepDate, DL_CALCNDFL, null, GetTypeContract()) + //созданные в операциях расчета НОБ
                          GetRubSumByClientOperDocKind(this.ClientID(), string(TXOBJ_MINUSG_618), date(1,1,m_CurrYear), m_RepDate, 0 /*только пользовательские*/, null, GetTypeContract());
        else
           m_MinusG_618 = $0;
        end;
     end;
     return m_MinusG_618;
  END;

  MACRO MinusG_619()
    if (m_MinusG_619 == null)
      if ((m_InfoRate == INFORATE_TOTAL) and (this.ResidenceStatus() == 1) 
          and (IIS_CONTRACTS == SET_CHAR))
        m_MinusG_619 = GetRubSumByClientOperDocKind(this.ClientID(),
                                                    string(TXOBJ_MINUSG_619),
                                                    date(1,1,m_CurrYear),
                                                    m_RepDate,
                                                    DL_CALCNDFL,
                                                    null,
                                                    1)
                       + GetRubSumByClientOperDocKind(this.ClientID(),
                                                      string(TXOBJ_MINUSG_619),
                                                      date(1,1,m_CurrYear),
                                                      m_RepDate,
                                                      0,
                                                      null,
                                                      1);
        else
          m_MinusG_619 = $0;
        end;
     end;
     return m_MinusG_619;
  END;

   macro P()
      var mm = 0, p = 0;

      DateSplit(m_EndDate, null, mm, null);

      p = Int((mm - 1) / 3) + 1;

      return p;
   end;

   macro PP()
      var p1 = 0, pp = "";

      p1 = P();
      if(p1 == 1)
         pp = "21";
      elif(p1 == 2)
         pp = "31";
      elif(p1 == 3)
         pp = "33";
      elif(p1 == 4)
         pp = "34";
      end;
 
      return pp;
   end;

   private macro GetSum(ClientID:Integer,
                StrKind:String,
                MinDate:Date,
                MaxDate:Date,
                SumVal:@Variant,
                IIS:Integer,
                AddWhereCond:String,
                ContrNumbers:@String,
                NPTXCodeParmArr:@TArray,
                FromOuter:bool,
                nobkind)

    FromOuter = IIF((ValType(FromOuter) != V_BOOL), false, FromOuter); //делаем false, если не V_BOOL

    var IsMinus = false, IsPlus = false, IsExistsPlus = false, IsShow = true;

    SumVal = 0.0;

    if((m_ByCB == UNSET_CHAR)
    or (m_ByDepo == UNSET_CHAR)
    or (m_ByVS == UNSET_CHAR))
    AddWhereCond = AddWhereCond +
        IIF(AddWhereCond != "", " AND ( ", " ( ");

      if(m_ByCB == SET_CHAR)
          AddWhereCond = AddWhereCond +
            " NOT EXISTS (SELECT "
                          + " 1 "
                      + " FROM "
                          + " dnptxobdc_dbt dc "
                         + " ,doproper_dbt opr "
                      + " WHERE "
                          + " dc.t_ObjID = obj.t_ObjID "
                      + " AND opr.t_ID_Operation = dc.t_DocID "
                      + " AND opr.t_DocKind = " + SP_DEPOPER_DEPOACNT + ") "
      + " AND NOT EXISTS (SELECT "
                          + " 1 "
                      + " FROM "
                          + " ddppmobj_dbt dp "
                      + " WHERE "
                          + " dp.t_ObjID = obj.t_ObjID "
                      + " AND dp.t_ObjKind = " + OBJTYPE_NPTXOBJ + ") "
      + " AND NOT EXISTS (SELECT "
                          + " 1 "
                      + " FROM "
                          + " dnptxobdc_dbt dc "
                         + " ,doproper_dbt opr "
                      + " WHERE "
                          + " dc.t_ObjID = obj.t_ObjID "
                      + " AND opr.t_ID_Operation = dc.t_DocID "
                      + " AND opr.t_DocKind IN (" + DL_VEKSELDRAWORDER + ", " + DL_VSBARTERORDER + ", " + DL_VSINTERCHANGE + ")) ";
        end;

        if(m_ByDepo == SET_CHAR)
          if(m_ByCB == SET_CHAR)
             AddWhereCond = AddWhereCond + " OR ";
          end;
   
          AddWhereCond = AddWhereCond +
            " EXISTS (SELECT "
                      + " 1 "
                  + " FROM "
                      + " dnptxobdc_dbt dc "
                     + " ,doproper_dbt opr "
                  + " WHERE "
                      + " dc.t_ObjID = obj.t_ObjID "
                  + " AND opr.t_ID_Operation = dc.t_DocID "
                  + " AND opr.t_DocKind = " + SP_DEPOPER_DEPOACNT + ") "
       + " OR EXISTS (SELECT "
                      + " 1 "
                  + " FROM "
                      + " ddppmobj_dbt dp "
                  + " WHERE "
                      + " dp.t_ObjID = obj.t_ObjID "
                  + " AND dp.t_ObjKind = " + OBJTYPE_NPTXOBJ + ") ";
        end;

        if(m_ByVS == SET_CHAR)
          if((m_ByCB == SET_CHAR)
          or (m_ByDepo == SET_CHAR))
            AddWhereCond = AddWhereCond + " OR ";
          end;

          AddWhereCond = AddWhereCond +
            " EXISTS (SELECT "
                      + " 1 "
                  + " FROM "
                      + " dnptxobdc_dbt dc "
                     + " ,doproper_dbt opr "
                  + " WHERE "
                      + " dc.t_ObjID = obj.t_ObjID "
                  + " AND opr.t_ID_Operation = dc.t_DocID "
                  + " AND opr.t_DocKind IN (" + DL_VEKSELDRAWORDER + ", " + DL_VSBARTERORDER + ", " + DL_VSINTERCHANGE + ")) ";
        end;

        AddWhereCond = AddWhereCond + " AND (";
        if((IIS != NULL))
           AddWhereCond = AddWhereCond + " obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                                         " AND RSI_NPTO.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) <> 1";
        end;
        AddWhereCond = AddWhereCond + " )" +
                                   " ) ";
      end;

      if(IsDepoClient())
         if(AddWhereCond != "")
            AddWhereCond = AddWhereCond + " and ";
         end;
         AddWhereCond = AddWhereCond + " obj.t_AnaliticKind1 not in(" + string(TXOBJ_KIND1098) + ", " + string(TXOBJ_KIND1095) + ") ";
      end;

      var ObjQuery =  " select nvl(sum(q.t_S), 0) t_S, "
                      "        chr(0) as t_ContrNum, " +
                      "        q.t_Kind, " +
                      "        extract(month from q.t_Date) as t_Month " +
                      " from ( ";
      if((IIS == NULL) or (IIS == 0))
         ObjQuery = ObjQuery + "   select obj.t_Sum as t_S, " +
                               "             obj.t_Kind, " +
                               "             obj.t_Date " +
                               "   from dnptxobj_dbt obj " +
                               "   where obj.t_Kind in(" + StrKind + ") " +
                               IIF(MinDate != date(0, 0, 0), "  and obj.t_Date >= " + GetSQLDate(MinDate), "") +
                               "     and obj.t_Date <= " + GetSQLDate(MaxDate) +
                               IIF(ClientID > 0, "  and obj.t_Client = " + string(ClientID), "") +
                               IIF(AddWhereCond != "", "  and " + AddWhereCond, "") +
                               "     and obj.t_FromOutSyst " + IIF(FromOuter,"=","<>") +" chr(88) " +
                               "     and RSI_NPTO.CheckObjIIS(obj.t_AnaliticKind6, t_Analitic6) <> 1 " +
                               "     and ( " +
                               "                ROUND(obj.t_Sum0,2) >= 0.01 " +
                               "                or ROUND(obj.t_Sum0,2) <= -0.01 " +
                               "         ) ";
      end;
      if((IIS == NULL) or (IIS == 1))
         if(IIS == NULL)
            ObjQuery = ObjQuery + " UNION ALL ";
         end;

         var ObjDate = Date(0, 0, 0);

         var CloseContrQuery = " select ( " +
                               "           case " +
                               "              when q.t_FirstIISDate is not NULL" +
                               "              then q.t_FirstIISDate " +
                               "              else q.t_DateBegin " +
                               "           end " +
                               "        ) as t_FirstIISDate, " +
                               "        q.t_DateClose " +
                               " from (" +
                               //Определение даты первого договора ИИС для ДО
                               "         select RSI_NPTO.GetDateFromNoteText(" + string(OBJTYPE_SFCONTR) + ", sfcontr.t_ID, 3) as t_FirstIISDate, " +
                               "                sfcontr.t_DateBegin, " +
                               "                nptxop.t_OperDate as t_DateClose " +
                               "         from dnptxop_dbt nptxop, " +
                               "              dnptxobdc_dbt obdc, " +
                               "              dnptxobj_dbt obj, " +
                               "              dsfcontr_dbt sfcontr " +
                               "         where " + IIF(MinDate != Date(0, 0, 0), " nptxop.t_OperDate >= " + GetSQLDate(MinDate) + " and ", "") +
                               "               nptxop.t_OperDate <= " + GetSQLDate(MaxDate) +
                               "           and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                               "           and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                               "           and nptxop.t_Client = " + string(ClientID) +
                               "           and nptxop.t_Status > 0 " +
                               "           and obdc.t_DocID = nptxop.t_ID " +
                               "           and obj.t_ObjID = obdc.t_ObjID " +
                               "           and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                               "           and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                               "           and sfcontr.t_ID = obj.t_Analitic6 " +
                               IIF(MinDate != NULL, " and sfcontr.t_DateClose >= " + GetSQLDate(MinDate), "") +
                               "           and sfcontr.t_DateClose <= " + GetSQLDate(MaxDate) +
                               "           and not exists( " +
                               "                            select 1 " +
                               "                            from ddlcontrmp_dbt dlcontrmp " +
                               "                            where dlcontrmp.t_SfContrID = sfcontr.t_ID " +
                               "                         ) " +
                               //Определение даты первого договора ИИС для ДБО
                               "         union " +
                               "         select ( " +
                               "                   case " +
                               "                      when dlcontr.t_IISTransfer = chr(88) " +
                               "                      then dlcontr.t_IISLastOpenDate " +
                               "                      else sfcontr.t_DateBegin " +
                               "                   end " +
                               "                ) as t_FirstIISDate, " +
                               "                to_date('01.01.0001', 'dd.mm.yyyy') as t_DateBegin," +
                               "                nptxop.t_OperDate as t_DateClose " +
                               "         from ddlcontr_dbt dlcontr, " +
                               "              dsfcontr_dbt subcontr, " +
                               "              ddlcontrmp_dbt dlcontrmp, " +
                               "              dsfcontr_dbt sfcontr, " +
                               "              dnptxop_dbt nptxop, " +
                               "              dnptxobdc_dbt obdc, " +
                               "              dnptxobj_dbt obj " +
                               "         where " + IIF(MinDate != Date(0, 0, 0), " nptxop.t_OperDate >= " + GetSQLDate(MinDate) + " and ", "") +
                               "               nptxop.t_OperDate <= " + GetSQLDate(MaxDate) +
                               "           and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                               "           and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                               "           and nptxop.t_Client = " + string(ClientID) +
                               "           and obdc.t_DocID = nptxop.t_ID " +
                               "           and obj.t_ObjID = obdc.t_ObjID " +
                               "           and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                               "           and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                               "           and subcontr.t_ID = obj.t_Analitic6 " +
                               "           and " + IIF(MinDate != Date(0, 0, 0), " subcontr.t_DateClose >= " + GetSQLDate(MinDate) + " and ", "") +
                               "                  subcontr.t_DateClose <= " + GetSQLDate(MaxDate) +
                               "           and dlcontrmp.t_SfContrID = subcontr.t_ID " +
                               "           and dlcontr.t_DlContrID = dlcontrmp.t_DlContrID " +
                               "           and sfcontr.t_ID = dlcontr.t_SfContrID " +
                               "      ) q " +
                               " where ROWNUM = 1 " +
                               " order by q.t_FirstIISDate ";

            var CloseContrSleect = DL_RSDCommand(CloseContrQuery);
            var CloseContrDS = CloseContrSleect.Execute();
            if(CloseContrDS.MoveNext)
               MinDate = Date(CloseContrDS.FirstIISDate);
               ObjDate = CloseContrDS.DateClose;
            end;

            ObjQuery = ObjQuery + " select obj.t_Sum as t_S, " +
                                  "        obj.t_Kind, " +
                                  IIF(ObjDate != Date(0, 0, 0), GetSQLDate(ObjDate), " obj.t_Date") + " as t_Date " +
                                  " from dnptxobj_dbt obj " +
                                  " where obj.t_Kind in (" + StrKind + ") " +
                                  IIF(ClientID > 0, " and obj.t_Client = " + string(ClientID), "") +
                                  IIF(MinDate != Date(0, 0, 0), " and obj.t_Date >= " + GetSQLDate(MinDate), "") +
                                  "   and obj.t_Date <= " + GetSQLDate(MaxDate) +
                                  IIF(AddWhereCond != "", " and " + AddWhereCond, "") +
                                  "   and obj.t_FromOutSyst " + IIF(FromOuter, "=", "<>") + " chr(88) " +
                                  "   and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                                  "   and exists ( " +
                                  "                 select 1 " +
                                  "                 from dnptxop_dbt nptxop " +
                                  "                 where nptxop.t_Client = " + string(ClientID) +
                                  "                   and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                                  "                   and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                                  "                   and nptxop.t_OperDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                                  "                   and nptxop.t_Status > 0 " +
                                  "              ) " +
                                  "   and ( " +
                                  "          ROUND(obj.t_Sum0,2) >= 0.01 " +
                                  "          or ROUND(obj.t_Sum0,2) <= -0.01 " +
                                  "       ) ";
      end;

      ObjQuery = ObjQuery + " ) q " +
                   " group by extract(month from q.t_Date), q.t_Kind";

      var ObjCmd = DL_RSDCommand(ObjQuery);

      var groupInd = -1;

      var ObjDS = ObjCmd.Execute();
      while(ObjDS.MoveNext())
         var MSCode;
         var MSnnn = 0;
         var PSCode;
         var PSnnn = 0;
         IsMinus = IsPlus = false;
         IsShow = true;
         SumVal = SumVal + ExtRound(ObjDS.S);

         if(ObjDS.Kind == TXOBJ_MINUS9_218)
            MScode = "218";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUS9_219)
            MScode = "219";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUS9_234)
            MScode = "234";
            Msnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUS15_601)
            MScode = "601";
            MSnnn = ExtRound(ObJDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_201)
            Mscode = "201";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_202)
            Mscode = "202";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_203)
            Mscode = "203";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_206)
            Mscode = "206";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_207)
            Mscode = "207";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_205)
            Mscode = "205";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_208)
            Mscode = "208";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_209)
            Mscode = "209";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_210)
            Mscode = "210";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_201)
            Mscode = "201";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_211)
            Mscode = "211";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_222)
            Mscode = "222";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_213)
            Mscode = "213";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif((ObjDS.Kind == TXOBJ_MINUSG_214) or (ObjDS.Kind == TXOBJ_MINUSG_214_IIS))
            Mscode = "214";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_220)
            Mscode = "220";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_223)
            Mscode = "223";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_224)
            Mscode = "224";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif((ObjDS.Kind == TXOBJ_MINUSG_218))
            Mscode = "218";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif((ObjDS.Kind == TXOBJ_MINUSG_219))
            Mscode = "219";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_618)
            Mscode = "618";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
            IsShow = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_601)
            Mscode = "601";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_225)
            Mscode = "225";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_226)
            Mscode = "226";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_227)
            Mscode = "227";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_228)
            Mscode = "228";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_229)
            Mscode = "229";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_230)
            Mscode = "230";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_231)
            Mscode = "231";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_235)
            Mscode = "235";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_239)
            Mscode = "239";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_240)
            Mscode = "240";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_236)
            Mscode = "236";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
         elif(ObjDS.Kind == TXOBJ_MINUSG_619)
            Mscode = "619";
            MSnnn = ExtRound(ObjDS.S);
            IsMinus = true;
            IsShow = true;
         end;

         //если значение кода слишком мало, не работаем с кодом
         if (IsMinus and (MSnnn == 0))
           IsMinus = false;
         end;

         var i;
         var j;

         //если имеем дело с минусом, то ищем идентификатор групп, 
         //проверяя значения каждой группы, пока не найдём нужную
         if (IsMinus)
           i = -1;
           while ((i = i + 1) < GetCodeGroupsValue().size)
             if (find(GetCodeGroupsValue()[i],MSCode) != -1)
               groupInd = i;
               break;
             end;
           end;
         end;
         
         //ищем в определении по минусам
         
         if((NPTXCodeParmArr != NULL) and IsMinus)
            i = 0;
            j = 0;
            while(i < NPTXCodeParmArr.Size())
               if(NPTXCodeParmArr[i].Month == ObjDS.Month)
                  /*NPTXCodeParmArr[i].MScode = NPTXCode.MScode;
                  NPTXCodeParmArr[i].MSnnn = NPTXCode.MSnnn;*/
                  j = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
                  if(j >= 0)
                     NPTXCodeParmArr[i].MinusCodes[j].MSnnn = NPTXCodeParmArr[i].MinusCodes[j].MSnnn + MSnnn;
                     IsExistsPlus = true;
                     break;
                  else
                     //если код дохода ещё не задан, и вычетов ещё нет
                     //если код дохода задан и равен той группе, которую нашли среди кодов вычетов ранее
                     //если код дохода не задан и вычеты есть, но принадлежат нужной группе (достаточно проверить первый, т.к. все прочие будут добавляться также)
                     //в любых других случаях пропускаем, что смещает данный код в другой элемент массива
                     if(((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size == 0)) or
                        ((NPTXCodeParmArr[i].PScode != NULL) and (groupInd != -1) and (NPTXCodeParmArr[i].PScode == GetCodeGroups()[groupInd].Key)) or
                        ((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size > 0) and (groupInd != -1) and (find(GetCodeGroups()[groupInd].Value,NPTXCodeParmArr[i].MinusCodes[0].MSCode) >= 0))) 
                        NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, MSnnn, IsShow);
                        IsExistsPlus = true;

                        //Делаем сортировку, если кодов вычетов, больше чем один (т.е. больше чем тот что только что добавили)
                        if (NPTXCodeParmArr[i].MinusCodes.Size > 1)
                          //в сортировку передаём массив групп в их очередерности и по ним узнаем порядок того или иного элемента
                          NPTXCodeParmArr[i].MinusCodes.Sort(@SortMinusCodeByGrp, GetCodeGroups()[groupInd].Value);
                        end;
                        
                        break;
                     end;
                  end;
               end;
               i = i + 1;
            end;
            
            //Если дохода с соответствующим кодом не было в соответствующем месяце, но был в другом
            if(not IsExistsPlus)
               i = 0;
               j = 0;
               while(i < NPTXCodeParmArr.Size())
                  /*NPTXCodeParmArr[i].MScode = NPTXCode.MScode;
                  NPTXCodeParmArr[i].MSnnn = NPTXCode.MSnnn;*/
                  j = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
                  if(j >= 0)
                     NPTXCodeParmArr[i].MinusCodes[j].MSnnn = NPTXCodeParmArr[i].MinusCodes[j].MSnnn + MSnnn;
                     IsExistsPlus = true;
                     break;
                  else
                     //если код дохода ещё не задан, и вычетов ещё нет
                     //если код дохода задан и равен той группе, которую нашли среди кодов вычетов ранее
                     //если код дохода не задан и вычеты есть, но принадлежат нужной группе (достаточно проверить первый, т.к. все прочие будут добавляться также)
                     //в любых других случаях пропускаем, что смещает данный код в другой элемент массива
                     if(((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size == 0)) or
                        ((NPTXCodeParmArr[i].PScode != NULL) and (groupInd != -1) and (NPTXCodeParmArr[i].PScode == GetCodeGroups()[groupInd].Key)) or
                        ((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size > 0) and (groupInd != -1) and (find(GetCodeGroups()[groupInd].Value,NPTXCodeParmArr[i].MinusCodes[0].MSCode) >= 0))) 
                        NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, MSnnn, IsShow);
                        IsExistsPlus = true;

                        //Делаем сортировку, если кодов вычетов, больше чем один (т.е. больше чем тот что только что добавили)
                        if (NPTXCodeParmArr[i].MinusCodes.Size > 1)
                          //в сортировку передаём массив групп в их очередерности и по ним узнаем порядок того или иного элемента
                          NPTXCodeParmArr[i].MinusCodes.Sort(@SortMinusCodeByGrp, GetCodeGroups()[groupInd].Value);
                        end;
                     
                        break;
                     end;
                  end;

                  i = i + 1;
               end;
            end;
         end;

         if((ObjDS.Kind == TXOBJ_PLUS9_1110) or (ObjDS.Kind == TXOBJ_PLUS9_1110_IIS))
            PScode = "1110";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif((ObjDS.Kind == TXOBJ_PLUS15_1010) or (ObjDS.Kind == TXOBJ_PLUSG_1010))
            PScode = "1010";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUS35_3023)
            PScode = "3023";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif((ObjDS.Kind == TXOBJ_PLUSG_1011) or (ObjDS.Kind == TXOBJ_PLUSG_1011_IIS))
            PScode = "1011";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1530)
            PScode = "1530";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1531)
            PScode = "1531";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1536)
            PScode = "1536";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1532)
            PScode = "1532";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1533)
            PScode = "1533";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1535)
            PScode = "1535";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1537)
            PScode = "1537";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1539)
            PScode = "1539";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1110)
            PScode = "1110";
            PSnnn = ExtRound(ObjDS.S);;
            IsPlus = true;
         elif((ObjDS.Kind == TXOBJ_PLUSG_2640) or (ObjDS.Kind == TXOBJ_PLUSG_2640_IIS))
            PScode = "2640";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif((ObjDS.Kind == TXOBJ_PLUSG_2641) or (ObjDS.Kind == TXOBJ_PLUSG_2641_IIS))
            PScode = "2641";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_2800)
            PScode = "2800";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1544)
            PScode = "1544";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1545)
            PScode = "1545";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1549)
            PScode = "1549";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1546)
            PScode = "1546";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1547)
            PScode = "1547";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1548)
            PScode = "1548";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1551)
            PScode = "1551";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_PLUSG_1553)
            PScode = "1553";
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         elif(ObjDS.Kind == TXOBJ_BASEG1_13)
            PSCode = NULL;
            PSnnn = ExtRound(ObjDS.S);
            IsPlus = true;
         end;

         //если значение кода слишком мало, не работаем с кодом
         if (IsPlus and (PSnnn == 0))
           IsPlus = false;
         end;

         //если имеем дело с минусом, то ищем идентификатор групп, 
         //проверяя значения каждой группы, пока не найдём нужную
         if (IsPlus)
           groupInd = DL_FindKeyPairInArr(GetCodeGroups(),PSCode);
         end;

         if((NPTXCodeParmArr != NULL) and IsPlus)
            i = 0;
            while(i < NPTXCodeParmArr.Size())
               //проставляем код дохода в существующий элемент массива только
               //если совпал месяц среди существующих, и код дохода пуст
               //а также если вычетов нет, либо группа не была найдена, или если среди существующих вычетов вычеты нужной группы
               if((NPTXCodeParmArr[i].Month == ObjDS.Month) and (NPTXCodeParmArr[i].PScode == NULL))
                  if ((NPTXCodeParmArr[i].MinusCodes.Size == 0) or (groupInd == -1) or (find(GetCodeGroups()[groupInd].Value,NPTXCodeParmArr[i].MinusCodes[0].MSCode) >= 0))
                     NPTXCodeParmArr[i].PScode = PScode;
                     NPTXCodeParmArr[i].PSnnn = PSnnn;
                     IsExistsPlus = true;
                     break;
                  end;
               end;
               i = i + 1;
            end;
         end;

         if((NPTXCodeParmArr != NULL) and (not IsExistsPlus) and (IsPlus or IsMinus))
            //NPTXCode.Month = ObjDS.Month;
            NPTXCodeParmArr[NPTXCodeParmArr.Size] = NPTXPlusCodeParm(ObjDS.Month, PSCode, PSnnn, 0, nobkind, NULL, IsShow);
            if(IsMinus)
               NPTXCodeParmArr[NPTXCodeParmArr.Size - 1].MinusCodes[0] = NPTXMinusCodeParm(MSCode, MSnnn, IsShow);
            end;
         elif(IsExistsPlus)
            IsExistsPlus = false;
         end;

         if((ContrNumbers != NULL) and (Index(ContrNumbers, ObjDS.ContrNum) == 0) and (ObjDS.ContrNum != ""))
            ContrNumbers = ContrNumbers + IIF(ContrNumbers != "", ", ", "") + ObjDS.ContrNum;
         end;
      end;
   end;

   private macro AddRateIndex(RateIndexes:@TArray, Index)
     var i = 0;
     var IsExistIndex = false;

     if(Index >= 0)
        while(i < RateIndexes.Size)
          if(RateIndexes[i] == Index)
            IsExistIndex = true;
            break;
          end;
          i = i + 1;
        end;
  
        if(not IsExistIndex)
          RateIndexes[RateIndexes.Size] = Index;
        end;
     end;
   end;

   private macro ДобавитьВсеПараметры(ContrNumbers:@String, RateIndexes:TArray)
      var sum = $0;
      var PlusSum = 0.0, MinusSum = 0.0, TaxCalculated = 0.0, TaxCalculatedDiv = 0.0, DivPlus = 0.0, TaxPaid = 0.0, TaxDue = 0.0, TaxOver = 0.0;
      var TaxToReturnDue = 0.0;
      var RateIndex = -1;
      var NPTXCodeArr = TArray(), NPTXCodeArr15 = TArray();
      var i;
      var j;
      var index;
      var CurRate;
      var BaseSpecial_Div = $0.0, PaidGeneral_0 = $0.0, DivPaySec_0 = $0.0;
      var PaidGeneral_15_1_0 = $0.0, TaxPaid15 = $0.0, TaxToReturnDue15 = $0.0, TaxDue15 = $0.0, TaxOver15 = $0.0, BaseSpecial_Div_15 = $0.0;
      var TaxCalculated15 = $0.0, TaxCalculatedDiv15 = $0.0, Znp15 = $0.0, DivPlus15 = $0.0, BaseG1_15 = $0.0;
      var Paid = $0.0;
      var MSnnn = 0;
      var DepoMinus = 0.0;
      var Income15 = TArray();
      var Year;

      if((MaxOperDate == null) or (MaxOperDate == Date(0, 0, 0)))
         MaxOperDate = m_EndDate;
      end;

      if((m_InfoRate == INFORATE9_15)
      or (m_InfoRate == INFORATE9_NOTRES_DIV))

        CurRate = Rate(m_InfoRate);
        if(ResidenceStatus() == 1)
          GetSum(ClientID(), "" + TXOBJ_PLUS9_1110 + ", " + TXOBJ_PLUS9_1110_IIS, m_BeginDate, MaxOperDate(), @PlusSum, NULL, "", @ContrNumbers, @NPTXCodeArr);
          m_PlusSum = m_PlusSum + PlusSum;

          GetSum(ClientID(), "" + TXOBJ_MINUS9_218
                          + "," + TXOBJ_MINUS9_219
                          + "," + TXOBJ_MINUS9_233
                          + "," + TXOBJ_MINUS9_234, m_BeginDate, MaxOperDate(), @MinusSum, NULL, "", @ContrNumbers, @NPTXCodeArr);
          m_MinusSum = m_MinusSum + MinusSum;
          GetSum(ClientID(), "" + TXOBJ_BASESPECIAL + ", " + TXOBJ_BASESPECIAL_IIS, m_BeginDate, MaxOperDate(), @sum, NULL, "",  @ContrNumbers);
          m_TaxCalculated = m_TaxCalculated + ExtRound(sum) * CurRate / 100.0;
          TaxCalculated = TaxCalculated + ExtRound(sum) * CurRate / 100.0;
          GetSum(ClientID(), "" + TXOBJ_PAIDSPECIAL_0, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
          m_TaxCalculated = m_TaxCalculated - ExtRound(sum);
          TaxCalculated = TaxCalculated - ExtRound(sum);
          GetSum(ClientID(), "" + TXOBJ_PAIDSPECIAL + ", " + TXOBJ_PAIDSPECIAL_IIS + ", " + TXOBJ_DIVPAY_SEC, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
          TaxPaid = TaxPaid + IIF(sum > $0, ABS(sum), $0);
          TaxToReturnDue = TaxPaid + IIF(sum < $0, ABS(sum), $0);
          TaxDue = ExtRound(TaxCalculated,0) + ExtRound(-TaxPaid + TaxToReturnDue,0);
          
          if(TaxDue >= 0.0)
            TaxOver = 0.0;
          else
            TaxOver = -TaxDue;
            TaxDue = 0.0;
          end;
        else
          GetSum(ClientID(), "" + TXOBJ_PLUS15_1010, m_BeginDate, MaxOperDate(), @PlusSum, NULL, "", @ContrNumbers, @NPTXCodeArr);
          m_PlusSum = m_PlusSum + PlusSum;
          DivPlus = DivPlus + PlusSum;

          GetSum(ClientID(), "" + TXOBJ_MINUS15_601, m_BeginDate, MaxOperDate(), @MinusSum, NULL, "", @ContrNumbers, @NPTXCodeArr);
          m_MinusSum = m_MinusSum + MinusSum;
          GetSum(ClientID(), "" + TXOBJ_DIVPAY_SEC, m_BeginDate, MaxOperDate(), @sum, NULL, "");
          m_TaxCalculated = m_TaxCalculated + ExtRound(sum);
          TaxCalculated = TaxCalculated + ExtRound(sum);
          TaxCalculatedDiv = TaxCalculatedDiv + ExtRound(sum);
          TaxPaid = TaxPaid + IIF(sum > $0, ABS(sum), $0);
          TaxToReturnDue = TaxToReturnDue + IIF(sum < $0, ABS(sum), $0);
          GetSum(ClientID(), "" + TXOBJ_DIVPAY_SEC_0, m_BeginDate, MaxOperDate(), @sum, NULL, "", @ContrNumbers);
          m_TaxCalculated = m_TaxCalculated - ExtRound(sum);
          TaxCalculated = TaxCalculated - ExtRound(sum);
          TaxCalculatedDiv = TaxCalculatedDiv - ExtRound(sum);

          TaxDue = ExtRound(TaxCalculated,0) + ExtRound(-TaxPaid + TaxToReturnDue,0);

          if(TaxDue >= 0.0)
            TaxOver = 0.0;
          else
            TaxOver = -TaxDue;
            TaxDue = 0.0;
          end;
        end;

        i = 0;
        while(i < NPTXCodeArr.Size())
           //вставляем пустой код дохода в случае если есть вычеты
           RateIndex = AddInArrCodeParms(m_ArrCodeParms, NPTXCodeArr[i].Month, NPTXCodeArr[i].PSCode, NPTXCodeArr[i].PSnnn, NULL,
                                         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, CurRate, 0.0, 0.0, 0.0, 0.0, false, NULL, NULL, NPTXCodeArr[i].IsShow, NULL, 
                                         ((NPTXCodeArr[i].PSCode == NULL) AND (NPTXCodeArr[i].MinusCodes.Size > 0)),m_InfoRate);

           if(RateIndex >= 0)
              index = m_ArrCodeParms[RateIndex].IndexOfCode(NPTXCodeArr[i].Month, NPTXCodeArr[i].PSCode);
              if(index >= 0)
                 j = 0;
                 while(j < NPTXCodeArr[i].MinusCodes.Size)
                    if (ExtRound(NPTXCodeArr[i].MinusCodes[j].MSnnn) != $0)
                       m_ArrCodeParms[RateIndex].NPTXCodeParmArr[index].MinusCodes[m_ArrCodeParms[RateIndex].NPTXCodeParmArr[index].MinusCodes.Size] = 
                                                                        NPTXMinusCodeParm(NPTXCodeArr[i].MinusCodes[j].MSCode, NPTXCodeArr[i].MinusCodes[j].MSnnn, NPTXCodeArr[i].MinusCodes[j].IsShow);
                    end;
                    j = j + 1;
                 end;
              end;
           end;

           i = i + 1;
        end;
        if(RateIndex >= 0)
           m_ArrCodeParms[RateIndex].TaxCalculated = TaxCalculated;
           m_ArrCodeParms[RateIndex].TaxPaid = TaxPaid;
           m_ArrCodeParms[RateIndex].TaxToReturnDue = TaxToReturnDue;
           m_ArrCodeParms[RateIndex].TaxDue = TaxDue;
           m_ArrCodeParms[RateIndex].DivPlus = DivPlus;
           m_ArrCodeParms[RateIndex].TaxCalculatedDiv = TaxCalculatedDiv;
           m_ArrCodeParms[RateIndex].TaxOver = TaxOver;
           m_ArrCodeParms[RateIndex].Znp = 0.0;
        end;

        AddRateIndex(@RateIndexes, RateIndex);
      elif(m_InfoRate == INFORATE_TOTAL)
        var Znp = 0.0;
        CurRate = Rate(m_InfoRate);

        if(ResidenceStatus() != 1)
           GetSum(ClientID(), "" + TXOBJ_PLUSG_1530
                           + "," + TXOBJ_PLUSG_1531
                           + "," + TXOBJ_PLUSG_1536
                           + "," + TXOBJ_PLUSG_1532
                           + "," + TXOBJ_PLUSG_1533
                           + "," + TXOBJ_PLUSG_1535
                           + "," + TXOBJ_PLUSG_1537
                           + "," + TXOBJ_PLUSG_1539
                           + "," + TXOBJ_PLUSG_2640
                           + "," + TXOBJ_PLUSG_2641
                           + "," + TXOBJ_PLUSG_2800
                           + "," + TXOBJ_BASEG1_13, m_BeginDate, MaxOperDate(), @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
           m_PlusSum = m_PlusSum + sum;
           PlusSum = PlusSum + sum;

           GetSum(ClientID(), "" + TXOBJ_PLUSG_1011_IIS
                           + "," + TXOBJ_PLUSG_1011
                           + "," + TXOBJ_PLUSG_1544
                           + "," + TXOBJ_PLUSG_1545
                           + "," + TXOBJ_PLUSG_1549
                           + "," + TXOBJ_PLUSG_1546
                           + "," + TXOBJ_PLUSG_1547
                           + "," + TXOBJ_PLUSG_1548
                           + "," + TXOBJ_PLUSG_1551
                           + "," + TXOBJ_PLUSG_1553
                           + "," + TXOBJ_PLUSG_2640_IIS
                           + "," + TXOBJ_PLUSG_2641_IIS, m_BeginDate, MaxOperDate(), @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
           m_PlusSum = m_PlusSum + sum;
           PlusSum = PlusSum + sum;

           GetSum(ClientID(), "" + TXOBJ_BASEGENERAL
                           + "," + TXOBJ_BASEMATERIAL
                           + "," + TXOBJ_BASEBILL, m_BeginDate, MaxOperDate(), @sum, NULL, "", @ContrNumbers);
           m_TaxCalculated = m_TaxCalculated + ExtRound(sum) * CurRate / 100.0;
           TaxCalculated = TaxCalculated + ExtRound(sum) * CurRate / 100.0;
           GetSum(ClientID(), "" + TXOBJ_BASEGENERAL_IIS
                           + "," + TXOBJ_BASEMATERIAL_IIS, m_BeginDate, MaxOperDate(), @sum, NULL, "", @ContrNumbers);
           TaxCalculated = TaxCalcuLated + ExtRound(sum * CurRate / 100.0);
           m_TaxCalculated = m_TaxCalculated + ExtRound(sum * CurRate / 100.0);

           GetSum(ClientID(), "" + TXOBJ_PAIDGENERAL_0, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
           m_TaxCalculated = m_TaxCalculated - ExtRound(sum);
           TaxCalculated = TaxCalculated - ExtRound(sum);

           GetSum(ClientID(), "" + TXOBJ_MINUSG_201
                           + "," + TXOBJ_MINUSG_202
                           + "," + TXOBJ_MINUSG_203
                           + "," + TXOBJ_MINUSG_206
                           + "," + TXOBJ_MINUSG_207
                           + "," + TXOBJ_MINUSG_205
                           + "," + TXOBJ_MINUSG_208
                           + "," + TXOBJ_MINUSG_209
                           + "," + TXOBJ_MINUSG_210
                           + "," + TXOBJ_MINUSG_211
                           + "," + TXOBJ_MINUSG_222
                           + "," + TXOBJ_MINUSG_213
                           + "," + TXOBJ_MINUSG_214
                           + "," + TXOBJ_MINUSG_220
                           + "," + TXOBJ_MINUSG_223
                           + "," + TXOBJ_MINUSG_224
                           + "," + TXOBJ_MINUSG_218
                           + "," + TXOBJ_MINUSG_219
                           + "," + TXOBJ_MINUSG_218_1
                           + "," + TXOBJ_MINUSG_219_1
                           + "," + TXOBJ_MINUSG_225
                           + "," + TXOBJ_MINUSG_226
                           + "," + TXOBJ_MINUSG_227
                           + "," + TXOBJ_MINUSG_228
                           + "," + TXOBJ_MINUSG_229
                           + "," + TXOBJ_MINUSG_250
                           + "," + TXOBJ_MINUSG_251
                           + "," + TXOBJ_MINUSG_252
                           + "," + TXOBJ_MINUSG_241
                           + "," + TXOBJ_MINUSG_230
                           + "," + TXOBJ_MINUSG_239
                           + "," + TXOBJ_MINUSG_231
                           + "," + TXOBJ_MINUSG_214_IIS
                           + "," + TXOBJ_MINUSG_235
                           + "," + TXOBJ_MINUSG_240
                           + "," + TXOBJ_MINUSG_236
                           + "," + TXOBJ_MINUSG_233
                           + "," + TXOBJ_MINUSG_234, m_BeginDate, MaxOperDate(), @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
           MinusSum = MinusSum + sum;

           GetSum(ClientID(), "" + TXOBJ_PAIDMATERIAL
                           + "," + TXOBJ_PAIDGENERAL
                           + "," + TXOBJ_PAIDSPECIAL
                           + "," + TXOBJ_PAIDMATERIAL_IIS
                           + "," + TXOBJ_PAIDGENERAL_IIS
                           + "," + TXOBJ_PAIDSPECIAL_IIS
                           + "," + TXOBJ_PAIDBILL, m_BeginDate, m_EndDate, @sum, NULL, "", @ContrNumbers);
           TaxPaid = TaxPaid + IIF(sum > $0, ABS(sum), $0);
           TaxToReturnDue = TaxToReturnDue + IIF(sum < $0, ABS(sum), $0);

           Znp = 0.0;
        else
           var Plus = 0;
           var Minus = 0;
           var Доход15_2 = $0.0, Доход15_3 = $0.0, Доход15_5 = $0.0, Доход15_9 = $0.0;
           var Доход13 = 0;
           var baseDepo = 0;

           //Расчитываем Доход_i и Расход_i с i = 2
           GetSum(ClientID(), "" + TXOBJ_PLUSG_1011
                           + "," + TXOBJ_PLUSG_1530
                           + "," + TXOBJ_PLUSG_1531
                           + "," + TXOBJ_PLUSG_1536
                           + "," + TXOBJ_PLUSG_1532
                           + "," + TXOBJ_PLUSG_1533
                           + "," + TXOBJ_PLUSG_1535
                           + "," + TXOBJ_PLUSG_2640
                           + "," + TXOBJ_PLUSG_2641, m_BeginDate, MaxOperDate(), @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr, NULL, 2);

           GetSum(ClientID(), "" + TXOBJ_MINUSG_201
                           + "," + TXOBJ_MINUSG_202
                           + "," + TXOBJ_MINUSG_203
                           + "," + TXOBJ_MINUSG_206
                           + "," + TXOBJ_MINUSG_207
                           + "," + TXOBJ_MINUSG_222
                           + "," + TXOBJ_MINUSG_223
                           + "," + TXOBJ_MINUSG_205
                           + "," + TXOBJ_MINUSG_208
                           + "," + TXOBJ_MINUSG_209
                           + "," + TXOBJ_MINUSG_210
                           + "," + TXOBJ_MINUSG_224
                           + "," + TXOBJ_MINUSG_220
                           + "," + TXOBJ_MINUSG_618, m_BeginDate, MaxOperDate(), @Minus, NULL, "", @ContrNumbers, @NPTXCodeArr, NULL, 2);

           GetSum(ClientID(), TXOBJ_BASEG2, m_BeginDate, MaxOperDate, @baseDepo, NULL, "", NULL, NULL, true);
           baseDepo = Min(Max15, baseDepo);
           Доход13 = (Plus - Minus + baseDepo);
           //DepoMinus = DepoMinus + IIF(Доход13 > Max15, baseDepo, 0);
           Доход13 = ExtRound(Min(Max15, Доход13) - baseDepo);
           Доход15_2 = ExtRound(Max((Plus - Minus - Доход13),0));
           if (Доход15_2 > $0) 
             Income15[Income15.size] = DL_KeyPair(2, Доход15_2);
           end;
           sum = Доход13 + Minus;
           
           m_PlusSum = m_PlusSum + sum;
           PlusSum = PlusSum + sum;
           m_MinusSum = m_MinusSum + Minus;
           MinusSum = MinusSum + Minus;


           //Расчитываем Доход_i и Расход_i с i = 3
           GetSum(ClientID(), "" + TXOBJ_PLUSG_1537
                           + "," + TXOBJ_PLUSG_1539, m_BeginDate, MaxOperDate(), @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr, NULL, 3);

           GetSum(ClientID(), "" + TXOBJ_MINUSG_211
                           + "," + TXOBJ_MINUSG_213
                           + "," + TXOBJ_MINUSG_218
                           + "," + TXOBJ_MINUSG_219
                           + "," + TXOBJ_MINUSG_214, m_BeginDate, MaxOperDate(), @Minus, NULL, "", @ContrNumbers, @NPTXCodeArr, NULL, 3);

           GetSum(ClientID(), TXOBJ_BASEG3, m_BeginDate, MaxOperDate(), @baseDepo, NULL, "", NULL, NULL, true);
           baseDepo = Min(Max15, baseDepo);
           Доход13 = (Plus - Minus + baseDepo);
           //DepoMinus = DepoMinus + IIF(Доход13 > Max15, baseDepo, 0);
           Доход13 = ExtRound(Min(Max15, Доход13) - baseDepo);
           Доход15_3 = ExtRound(Max((Plus - Minus - Доход13),0));
           if (Доход15_3 > $0)
             Income15[Income15.size] = DL_KeyPair(3, Доход15_3);
           end;
           sum = Доход13 + Minus;

           m_PlusSum = m_PlusSum + sum;
           PlusSum = PlusSum + sum;
           m_MinusSum = m_MinusSum + Minus;
           MinusSum = MinusSum + Minus;

           //Расчитываем Доход_i и Расход_i с i = 5
           GetSum(ClientID(), "" + TXOBJ_PLUSG_1011_IIS
                           + "," + TXOBJ_PLUSG_1544
                           + "," + TXOBJ_PLUSG_1545
                           + "," + TXOBJ_PLUSG_1546
                           + "," + TXOBJ_PLUSG_1547
                           + "," + TXOBJ_PLUSG_1548
                           + "," + TXOBJ_PLUSG_1549
                           + "," + TXOBJ_PLUSG_1551
                           + "," + TXOBJ_PLUSG_1553
                           + "," + TXOBJ_PLUSG_2640_IIS
                           + "," + TXOBJ_PLUSG_2641_IIS, m_BeginDate, MaxOperDate(), @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr, NULL, 5);

           GetSum(ClientID(), "" + TXOBJ_MINUSG_225
                           + "," + TXOBJ_MINUSG_226
                           + "," + TXOBJ_MINUSG_227
                           + "," + TXOBJ_MINUSG_228
                           + "," + TXOBJ_MINUSG_229
                           + "," + TXOBJ_MINUSG_230
                           + "," + TXOBJ_MINUSG_239
                           + "," + TXOBJ_MINUSG_240
                           + "," + TXOBJ_MINUSG_231
                           + "," + TXOBJ_MINUSG_233
                           + "," + TXOBJ_MINUSG_234
                           + "," + TXOBJ_MINUSG_214_IIS
                           + "," + TXOBJ_MINUSG_250
                           + "," + TXOBJ_MINUSG_251
                           + "," + TXOBJ_MINUSG_252
                           + "," + TXOBJ_MINUSG_241
                           + "," + TXOBJ_MINUSG_236
                           + "," + TXOBJ_MINUSG_235
                           + "," + TXOBJ_MINUSG_619, m_BeginDate, MaxOperDate(), @Minus, NULL, "", @ContrNumbers, @NPTXCodeArr, NULL, 5);

           GetSum(ClientID(), TXOBJ_BASEG5, m_BeginDate, MaxOperDate(), @baseDepo, NULL, "", NULL, NULL, true);
           baseDepo = Min(Max15, baseDepo);
           Доход13 = (Plus - Minus + baseDepo);
           //DepoMinus = DepoMinus + IIF(Доход13 > Max15, baseDepo, 0);
           Доход13 = ExtRound(Min(Max15, Доход13) - baseDepo);
           Доход15_5 = ExtRound(Max((Plus - Minus - Доход13),0));
           if (Доход15_5 > $0)
             Income15[Income15.size] = DL_KeyPair(5, Доход15_5);
           end;
           sum = Доход13 + Minus;

           m_PlusSum = m_PlusSum + sum;
           PlusSum = PlusSum + sum;
           m_MinusSum = m_MinusSum + Minus;
           MinusSum = MinusSum + Minus;

           //Расчитываем Доход_i с i = 9
           GetSum(ClientID(), "" + TXOBJ_PLUSG_2800, m_BeginDate, MaxOperDate(), @Plus, NULL, "", @ContrNumbers, @NPTXCodeArr, NULL, 9);

           GetSum(ClientID(), TXOBJ_BASEG9, m_BeginDate, MaxOperDate(), @baseDepo, NULL, "", NULL, NULL, true);
           Minus = $0.0;
           baseDepo = Min(Max15, baseDepo);
           Доход13 = (Plus - Minus + baseDepo);
           //DepoMinus = DepoMinus + IIF(Доход13 > Max15, baseDepo, 0);
           Доход13 = ExtRound(Min(Max15, Доход13) - baseDepo);
           Доход15_9 = ExtRound(Max((Plus - Minus - Доход13),0));
           if (Доход15_9 > $0)
             Income15[Income15.size] = DL_KeyPair(9, Доход15_9);
           end;
           sum = Доход13;
           
           m_PlusSum = m_PlusSum + sum;
           PlusSum = PlusSum + sum;

           GetSum(ClientID(), "" + TXOBJ_BASEG1_13, m_BeginDate, MaxOperDate(), @sum, NULL, "", @ContrNumbers, @NPTXCodeArr);
           m_PlusSum = m_PlusSum + sum;
           PlusSum = PlusSum + sum;
           DivPlus = DivPlus + sum;
           Znp = Znp + sum * CurRate / 100;

           m_TaxCalculated = m_TaxCalculated + ExtRound(CurRate / 100 * (PlusSum - MinusSum), 0);
           TaxCalculated = TaxCalculated + ExtRound(CurRate / 100 * (PlusSum - MinusSum), 0);

           GetSum(ClientID(), "" + TXOBJ_DIVPAY_SEC_0, m_BeginDate, m_EndDate, @DivPaySec_0, NULL, "");
           GetSum(ClientID(), "" + TXOBJ_PAIDGENERAL_0, m_BeginDate, m_EndDate, @PaidGeneral_0, NULL, "");
           m_TaxCalculated = m_TaxCalculated - ExtRound(DivPaySec_0, 0) - ExtRound(PaidGeneral_0, 0);
           TaxCalculated = TaxCalculated - ExtRound(DivPaySec_0, 0) - ExtRound(PaidGeneral_0, 0);

           GetSum(ClientID(), "" + TXOBJ_BASESPECIAL_DIV, m_BeginDate, MaxOperDate(), @BaseSpecial_Div, NULL, "");
           TaxCalculatedDiv = TaxCalculatedDiv + CurRate / 100 * ExtRound(BaseSpecial_Div) - ExtRound(DivPaySec_0);
           Znp = Znp - BaseSpecial_Div * CurRate / 100;
         end;

         if((m_Pg == NULL) or (m_Pm == NULL) or (m_Pp == NULL))
            DateSplit(m_BeginDate, NULL, NULL, Year);
            var Rp = Rate(INFORATE_HIGHRATE_15);
            GetTAXCalculatedDue(ClientID(), ResidenceStatus(), m_BeginDate, m_EndDate, Year, NULL, CurRate / 100, 0.0, Rp / 100.0, 0.0, NULL, NULL, NULL, NULL, @m_Pg,  @m_Pm, @m_Pp, NULL, false);
         end;

         sum = m_Pg + m_Pm;
         TaxPaid = TaxPaid + IIF(sum > $0, ABS(sum), $0);
         TaxToReturnDue = TaxToReturnDue + IIF(sum < $0, ABS(sum), $0);

        TaxDue = ExtRound(TaxCalculated,0) + ExtRound(-TaxPaid - TaxToReturnDue,0);

        if(TaxDue >= 0)
          TaxOver = 0;
        else
          TaxOver = TaxPaid - TaxCalculated + TaxToreturnDue;
          TaxDue = 0;
        end;

        if(ResidenceStatus() == 1)
           var TotalPlus15 = Доход15_2 + Доход15_3 + Доход15_5 + Доход15_9;

           GetSum(ClientID(), "" + TXOBJ_BASEG1_15, m_BeginDate, MaxOperDate(), @DivPlus15, NULL, "");
           DivPlus15 = ExtRound(DivPlus15, 2);

           GetSum(ClientID(), "" + TXOBJ_PAIDGENERAL_15_1_0, m_BeginDate, MaxOperDate(), @PaidGeneral_15_1_0, NULL, "");
           TaxCalculated15 = 0.15 * TotalPlus15 - PaidGeneral_15_1_0;
           TaxCalculated15 = ExtRound(TaxCalculated15);

           GetSum(ClientID(), "" + TXOBJ_BASESPECIAL_DIV_15, m_BeginDate, MaxOperDate(), @BaseSpecial_Div_15, NULL, "");
           TaxCalculatedDiv15 = 0.15 * BaseSpecial_Div_15 - PaidGeneral_15_1_0;
           TaxCalculatedDiv15 = ExtRound(TaxCalculatedDiv15, 2);

           if(m_Pp > 0)
              TaxPaid15 = m_Pp;
              TaxToReturnDue15 = 0.0;
           else
              TaxPaid15 = 0.0;
              TaxToReturnDue15 = -m_Pp;
           end;

           TaxDue15 = TaxCalculated15 - TaxPaid15;
           if(TaxDue15 >= 0.0)
              TaxOver15 = 0.0;
           else
              TaxOver15 = -TaxDue15;
              TaxDue15 = 0.0;
           end;

           Znp15 = 0.15 * (BaseG1_15 - BaseSpecial_Div_15);

           if((TotalPlus15 != 0.0) or (TaxCalculated15 != 0.0))
              var HighRateIndex = AddInArrCodeParms(m_ArrCodeParms, NULL, NULL, TotalPlus15, NULL, 0.0, TotalPlus15, TaxCalculated15, TaxPaid15,
                                                    TaxToReturnDue15, TaxDue15, 15, 0.0, DivPlus15, TaxCalculatedDiv15, TaxOver15, true, Znp15);
              AddRateIndex(@RateIndexes, HighRateIndex);
           else
              TaxPaid = TaxPaid + TaxPaid15;
              TaxToReturnDue = TaxToReturnDue + TaxToReturnDue15;
           end;
        end;

        i = 0;
        while(i < NPTXCodeArr.Size())
           //вставляем только если доход существует, иначе 
           RateIndex = AddInArrCodeParms(m_ArrCodeParms, NPTXCodeArr[i].Month, NPTXCodeArr[i].PSCode, NPTXCodeArr[i].PSnnn, NULL/*NPTXCodeArr[i].MSCode*/,
                                         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, CurRate, 0.0, 0.0, 0.0, 0.0, false, NULL, NULL, NPTXCodeArr[i].IsShow, NULL,
                                         ((NPTXCodeArr[i].PSCode == NULL) AND (NPTXCodeArr[i].MinusCodes.Size > 0)), m_InfoRate, NPTXCodeArr[i].NOBKind);

           j = 0;
           MSnnn = 0.0;
           if(RateIndex >= 0)
              index = m_ArrCodeParms[RateIndex].IndexOfCode(NPTXCodeArr[i].Month, NPTXCodeArr[i].PSCode);
              if(index >= 0)
                 j = 0;
                 MSnnn = 0.0;
                 while(j < NPTXCodeArr[i].MinusCodes.Size)
                    if (ExtRound(NPTXCodeArr[i].MinusCodes[j].MSnnn) != $0)
                       MSnnn = MSnnn + NPTXCodeArr[i].MinusCodes[j].MSnnn;
                       m_ArrCodeParms[RateIndex].NPTXCodeParmArr[index].MinusCodes[m_ArrCodeParms[RateIndex].NPTXCodeParmArr[index].MinusCodes.Size] = 
                                                                        NPTXMinusCodeParm(NPTXCodeArr[i].MinusCodes[j].MSCode, NPTXCodeArr[i].MinusCodes[j].MSnnn, NPTXCodeArr[i].MinusCodes[j].IsShow);
                       m_ArrCodeParms[RateIndex].NPTXCodeParmArr[index].ЧНБ = NPTXCodeArr[i].PSnnn - MSnnn;
                    end;
                    j = j + 1;
                 end;
              end;
           end;

           i = i + 1;
        end;

        if(RateIndex >= 0)
           m_ArrCodeParms[RateIndex].PlusSum = PlusSum;
           m_ArrCodeParms[RateIndex].MinusSum = MinusSum;
           m_ArrCodeParms[RateIndex].TaxCalculated = TaxCalculated;
           m_ArrCodeParms[RateIndex].TaxPaid = TaxPaid;
           m_ArrCodeParms[RateIndex].TaxToReturnDue = TaxToReturnDue;
           m_ArrCodeParms[RateIndex].TaxDue = TaxDue;
           m_ArrCodeParms[RateIndex].DivPlus = DivPlus;
           m_ArrCodeParms[RateIndex].TaxCalculatedDiv = TaxCalculatedDiv;
           m_ArrCodeParms[RateIndex].TaxOver = TaxOver;
           m_ArrCodeParms[RateIndex].Znp = Znp;
           m_arrCodeParms[RateIndex].DepoMinus = DepoMinus;
           if (Income15.size > 0)
             m_arrCodeParms[RateIndex].Income15 = Income15;
           end;
        elif((TaxCalculated > 0.0) or (TaxPaid > 0.0) or (TaxDue > 0.0) or (TaxCalculatedDiv > 0.0) or (((TaxOver > 0.0) or (TaxToReturnDue > 0.0)) and (TaxCalculated > 0.0))or (Znp > 0.0))
           RateIndex = AddInArrCodeParms(m_ArrCodeParms, NULL, NULL, 0.0, NULL, 0.0, 0.0, TaxCalculated, TaxPaid, TaxToReturnDue, TaxDue,
                                         CurRate, 0.0, 0.0, TaxCalculatedDiv, TaxOver, false, Znp, 0.0, false, false, false, 0, 0);
        end;
        AddRateIndex(@RateIndexes, RateIndex);
      elif(m_InfoRate == 0)
        if(IsDepoClient() and (OTHER_CONTRACTS == SET_CHAR))
          //Для выплат дивидендов и купонов в Депозитарии ставка налога указывается в каждой операции своя, поэтому нужно брать не фиксированные ставки,
          //а смотреть ставки в каждой операции, но это только в том случае, когда клиент является депоклиентом.
          var DepoClntQuery = "select nvl(sum(q.t_PlusSum), 0) as t_PlusSum," +
                              "       nvl(sum(q.t_MinusSum), 0) as t_MinusSum," +
                              "       nvl(sum(q.t_TaxPaid), 0) as t_TaxPaid," +
                              "       nvl(sum(q.t_DivPlus), 0) as t_DivPlus," +
                              "       (nvl(sum(q.t_TaxCalculated), 0) + nvl(sum(q.t_TaxCalculatedObjSum), 0)) as t_TaxCalculated," +
                              "       nvl(sum(q.t_TaxCalculatedDiv), 0) as t_TaxCalculatedDiv," +
                              "       nvl(sum(q.t_TaxToReturnDue), 0) as t_TaxToReturnDue," +
                              "       nvl(sum(q.t_Znp), 0) as t_Znp, " +
                              "       q.t_Rate," +
                              "       q.t_Month," +
                              "       q.t_PlusCode" +
                              " from" +
                              "    (" +
                              "       select nvl(PlusObj.t_Sum0, 0) as t_PlusSum, " +
                              "              nvl(MinusObj.t_Sum0, 0) as t_MinusSum, " +
                              "              nvl(TaxPaidObj.t_Sum0, 0) as t_TaxPaid, " +
                              "              nvl(DivPlusObj.t_Sum0, 0) as t_DivPlus, " +
                              "              nvl(BaseObj.t_Sum0, 0) * dppmacc.t_TaxRate / 100 / 100 as t_TaxCalculated, " +
                              "              nvl(TaxCalculatedDivObj.t_Sum0, 0) as t_TaxCalculatedDiv, " +
                              "              nvl(TaxToReturnDueObj.t_Sum0, 0) as t_TaxToReturnDue, " +
                              "              nvl(TaxCalculatedDivObj.t_Sum0, 0) - (nvl(BaseSpecialDivObj.t_Sum0, 0)) * dppmacc.t_TaxRate / 100 / 100 as t_Znp, " +
                              "              dppmacc.t_TaxRate / 100 as t_Rate," +
                              "              EXTRACT(MONTH FROM dpcorpop.t_Date) as t_Month," +
                              "              (" +
                              "                 case nvl(PlusObj.t_Kind, 0)" +
                              "                 when " + string(TXOBJ_PLUSG_1010) +
                              "                    then '1010'" +
                              "                 when " + string(TXOBJ_PLUS15_1010) +
                              "                    then '1010'" +
                              "                 when " + string(TXOBJ_PLUSG_1110) +
                              "                    then '1110'" +
                              "                 when " + string(TXOBJ_PLUSG_1011) +
                              "                    then '1011'" +
                              "                 when " + string(TXOBJ_PLUS9_1110) +
                              "                    then '1110'" +
                              "                 else ''" +
                              "                 end" +
                              "              ) as t_PlusCode, " +
                              "              TaxCalculatedObj.t_Sum0 as t_TaxCalculatedObjSum " +
                              "        from ddpcorpop_dbt dpcorpop," +
                              "             dparty_dbt party," +
                              "             ddppmacc_dbt dppmacc," +
                              "             dnptxobj_dbt PlusObj," +
                              "             dnptxobj_dbt MinusObj," +
                              "             dnptxobj_dbt TaxPaidObj," +
                              "             dnptxobj_dbt DivPlusObj," +
                              "             dnptxobj_dbt BaseObj," +
                              "             dnptxobj_dbt TaxCalculatedDivObj," +
                              "             dnptxobj_dbt TaxToReturnDueObj," +
                              "             dnptxobj_dbt TaxCalculatedObj," +
                              "             dnptxobj_dbt BaseSpecialDivObj, " +
                              "             dnptxobj_dbt BaseSpecialDivObjHigh" +
                              "        where dppmacc.t_DocumentID = dpcorpop.t_DocumentID" +
                              "          and dppmacc.t_HolderID = party.t_PartyID"
                              "          and dpcorpop.t_Date between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and party.t_PartyID = " + string(ClientID()) +
                              "          and PlusObj.t_Kind(+) in(" + string(TXOBJ_PLUSG_1010) + ", " +
                                                                      string(TXOBJ_PLUS15_1010) + ", " +
                                                                      string(TXOBJ_PLUSG_1110) + ", " +
                                                                      string(TXOBJ_PLUSG_1011) + ", " +
                                                                      string(TXOBJ_PLUS9_1110) +
                                                                ")" +
                              "          and PlusObj.t_Client(+) = " + string(ClientID()) +
                              "          and PlusObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and PlusObj.t_Analitic1(+) = dpcorpop.t_DocumentID " +
                              "          and PlusObj.t_AnaliticKind1(+) in(" +
                                                                             string(TXOBJ_KIND1095) + ", " +
                                                                             string(TXOBJ_KIND1098) +
                                                                         ")" +
                              "          and PlusObj.t_FromOutSyst(+) <> 'X' " +
                              "          and MinusObj.t_Kind(+) = " + string(TXOBJ_MINUSG_601) +
                              "          and MinusObj.t_Client(+) = " + string(ClientID()) +
                              "          and MinusObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and MinusObj.t_AnaliticKind1(+) in(" +
                                                                              string(TXOBJ_KIND1095) + ", " +
                                                                              string(TXOBJ_KIND1098) +
                                                                          ")" +
                              "          and MinusObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                              "          and MinusObj.t_FromOutSyst(+) <> 'X' " +
                              "          and TaxPaidObj.t_Kind(+) in(" +
                                                                       string(TXOBJ_PAIDGENERAL) + ", " +
                                                                       string(TXOBJ_PAIDSPECIAL) +
                                                                   ")" +
                              "          and TaxPaidObj.t_Client(+) = " + string(ClientID()) +
                              "          and TaxPaidObj.t_AnaliticKind1(+) in(" +
                                                                                string(TXOBJ_KIND1095) + ", " +
                                                                                string(TXOBJ_KIND1098) +
                                                                            ")" +
                              "          and TaxPaidObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                              "          and TaxPaidObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and TaxPaidObj.t_Sum(+) > 0" +
                              "          and TaxPaidObj.t_FromOutSyst(+) <> 'X' " +
                              "          and DivPlusObj.t_Kind(+) in(" +
                                                                       string(TXOBJ_PLUSG_1010) + ", " +
                                                                       string(TXOBJ_PLUS15_1010) +
                                                                   ")" +
                              "          and DivPlusObj.t_Client(+) = " + string(ClientID()) +
                              "          and DivPlusObj.t_AnaliticKind1(+) in(" +
                                                                                string(TXOBJ_KIND1095) + ", " +
                                                                                string(TXOBJ_KIND1098) +
                                                                            ")" +
                              "          and DivPlusObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                              "          and DivPlusObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and DivPlusObj.t_FromOutSyst(+) <> 'X' " +
                              "          and BaseObj.t_Kind(+) in(" +
                                                                    string(TXOBJ_BASEGENERAL) + ", " +
                                                                    string(TXOBJ_BASESPECIAL) +
                                                                ")" +
                              "          and BaseObj.t_Client(+) = " + string(ClientID()) +
                              "          and BaseObj.t_AnaliticKind1(+) in(" +
                                                                             string(TXOBJ_KIND1095) + ", " +
                                                                             string(TXOBJ_KIND1098) +
                                                                         ")" +
                              "          and BaseObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                              "          and BaseObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and BaseObj.t_FromOutSyst(+) <> 'X' " +
                              "          and TaxCalculatedDivObj.t_Kind(+) = " + string(TXOBJ_DIVPAY_SEC) +
                              "          and TaxCalculatedDivObj.t_Client(+) = " + string(ClientID()) +
                              "          and TaxCalculatedDivObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and TaxCalculatedDivObj.t_AnaliticKind1(+) in(" +
                                                                                         string(TXOBJ_KIND1095) + ", " +
                                                                                         string(TXOBJ_KIND1098) +
                                                                                     ")" +
                              "          and TaxCalculatedDivObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                              "          and TaxCalculatedDivObj.t_FromOutSyst(+) <> 'X' " +
                              "          and TaxToReturnDueObj.t_Client(+) = " + string(ClientID()) +
                              "          and TaxToReturnDueObj.t_Kind(+) in (" +
                                                                               string(TXOBJ_PAIDGENERAL) + ", " +
                                                                               string(TXOBJ_PAIDSPECIAL) +
                                                                           ")" +
                              "          and TaxToReturnDueObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and TaxToReturnDueObj.t_AnaliticKind1(+) in(" +
                                                                                       string(TXOBJ_KIND1095) + ", " +
                                                                                       string(TXOBJ_KIND1098) +
                                                                                   ")" +
                              "          and TaxToReturnDueObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                              "          and TaxToReturnDueObj.t_Sum(+) < 0" +
                              "          and TaxCalculatedObj.t_Kind(+) in(" +
                                                                             string(TXOBJ_DIVPAY_SEC) +
                                                                         ")" +
                              "          and TaxCalculatedObj.t_Client(+) = " + string(ClientID()) +
                              "          and TaxCalculatedObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and TaxCalculatedObj.t_AnaliticKind1(+) in (" +
                                                                                       string(TXOBJ_KIND1095) + ", " +
                                                                                       string(TXOBJ_KIND1098) +
                                                                                   ")" +
                              "          and TaxCalculatedObj.t_Analitic1(+) = dpcorpop.t_DocumentID" +
                              "          and TaxCalculatedObj.t_FromOutSyst(+) <> 'X' " +
                              "          and BaseSpecialDivObj.t_Kind(+) in(" +
                                                                              string(TXOBJ_BASESPECIAL_DIV) +
                                                                          ")" +
                              "          and BaseSpecialDivObj.t_Client(+) = " + string(ClientID()) +
                              "          and BaseSpecialDivObj.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and BaseSpecialDivObj.t_AnaliticKind1(+) in ( " +
                                                                                         string(TXOBJ_KIND1095) + ", " +
                                                                                         string(TXOBJ_KIND1098) +
                                                                                    ") " +
                              "          and BaseSpecialDivObj.t_Analitic1(+) = dpcorpop.t_DocumentID " +
                              "          and BaseSpecialDivObj.t_FromOutSyst(+) <> 'X' " +
                              "          and BaseSpecialDivObjHigh.t_Kind(+) in(" +
                                                                                  string(TXOBJ_BASESPECIAL_DIV_15) +
                                                                              ")" +
                              "          and BaseSpecialDivObjHigh.t_Client(+) = " + string(ClientID()) +
                              "          and BaseSpecialDivObjHigh.t_Date(+) between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(MaxOperDate()) +
                              "          and BaseSpecialDivObjHigh.t_AnaliticKind1(+) in ( " +
                                                                                             string(TXOBJ_KIND1095) + ", " +
                                                                                             string(TXOBJ_KIND1098) +
                                                                                        ") " +
                              "          and BaseSpecialDivObjHigh.t_Analitic1(+) = dpcorpop.t_DocumentID " +
                              "          and BaseSpecialDivObjHigh.t_FromOutSyst(+) <> 'X' " +
                              "    ) q " +
                              "group by q.t_Rate, q.t_Month, q.t_PlusCode";

          var DepoClntSelect = DL_RSDCommand(DepoClntQuery);
          var DepoClntDS = DepoClntSelect.execute();
          while(DepoClntDS.MoveNext())
             if((DepoClntDS.PlusSum > 0) or (DepoClntDS.MinusSum > 0))
                var DepoRateIndex = AddInArrCodeParms(m_ArrCodeParms, DepoClntDS.Month, DepoClntDS.PlusCode, DepoClntDS.PlusSum, "601", DepoClntDS.MinusSum, 0.0,
                                                      DepoClntDS.TaxCalculated, DepoClntDS.TaxPaid, DepoClntDS.TaxToReturnDue, 0.0,
                                                      DepoClntDS.Rate, 0.0, DepoClntDS.DivPlus, DepoClntDS.TaxCalculatedDiv, 0.0, false, DepoClntDS.Znp);

                //Заносим индекс добавленной/скорректированной ставки в отдельный массив для того, чтобы вставить/обновить только изменённые данные
                //в таблицу dnptx6calc1_dbt
                AddRateIndex(@RateIndexes, DepoRateIndex);
                m_PlusSum = m_PlusSum + DepoClntDS.PlusSum;
                m_MinusSum = m_MinusSum + DepoClntDS.MinusSum;
             end;
          end;
        end;
      end;
   end;

   private macro InsertNPTX6Calc1(RateIndex)
      var QueryExists =   "select 1 "
                        + "from dnptx6calc1_tmp "
                        + "where t_ClientID = ? "
                        + "  and t_Rate = ?"
                        + "  and t_IsHighRate = ?";
  
      var CmdExists = DL_RSDCommand(QueryExists);
      CmdExists.AddParam(ClientID());
      CmdExists.AddParam(m_ArrCodeParms[RateIndex].Rate);
      CmdExists.AddParam(IIF(m_ArrCodeParms[RateIndex].IsHighRate, SET_CHAR, UNSET_CHAR));
      var DSExists = CmdExists.Execute();
  
      if(DSExists.MoveNext())
        var QueryUpdate =   "UPDATE dnptx6calc1_tmp "
                          + "SET t_TotalPlus = ?, "
                          + "    t_DivPlus = ?, "
                          + "    t_TotalMinus = ?, "
                          + "    t_TaxCalculated = ?, "
                          + "    t_TaxCalculatedDiv = ?, "
                          + "    t_TaxPaid = ?,"
                          + "    t_TaxDue = ?, "
                          + "    t_TaxOver = ?, "
                          + "    t_TaxToReturnDue = ?, "
                          + "    t_Znp = ? "
                          + "WHERE t_ClientID = ? "
                          + "  and t_Rate = ?"
                          + "  and t_IsHighRate = ?";
  
        var CmdUpdate = RsdCommand(QueryUpdate);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].PlusSum);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].DivPlus);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].MinusSum);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxCalculated);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxCalculatedDiv);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxPaid);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxDue);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxOver);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxToReturnDue);
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].Znp);
        CmdUpdate.AddParam("", RSDBP_IN, ClientID());
        CmdUpdate.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].Rate);
        CmdUpdate.AddParam("", RSDBP_IN, IIF(m_ArrCodeParms[RateIndex].IsHighRate, SET_CHAR, UNSET_CHAR));
        CmdUpdate.Execute();
      else
        var QueryInsert = " INSERT INTO "
                        + " dnptx6calc1_tmp(t_ClientID "
                                       + " ,t_Rate "
                                       + " ,t_TotalPlus "
                                       + " ,t_DivPlus "
                                       + " ,t_TotalMinus "
                                       + " ,t_TaxCalculated "
                                       + " ,t_TaxCalculatedDiv"
                                       + " ,t_TaxPaid"
                                       + " ,t_TaxDue"
                                       + " ,t_TaxOver"
                                       + " ,t_TaxToReturnDue"
                                       + " ,t_Znp"
                                       + " ,t_IsHighRate) "
                    + " VALUES "
                        + " (? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,? "
                        + " ,?) ";
        var CmdInsert = RsdCommand(QueryInsert);
        CmdInsert.NullConversion = true;
        CmdInsert.AddParam("", RSDBP_IN, ClientID());
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].Rate);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].PlusSum);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].DivPlus);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].MinusSum);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxCalculated);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxCalculatedDiv);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxPaid);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxDue);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxOver);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].TaxToReturnDue);
        CmdInsert.AddParam("", RSDBP_IN, m_ArrCodeParms[RateIndex].Znp);
        CmdInsert.AddParam("", RSDBP_IN, IIF(m_ArrCodeParms[RateIndex].IsHighRate, SET_CHAR, UNSET_CHAR));
        CmdInsert.Execute();
      end;
   end;

   macro РассчитатьДоходыИВычеты()
      var RateIndexes = TArray();
      var PlusSum = 0.0, DivPlus = 0.0, MinusSum = 0.0, TaxCalculated = 0.0, TaxCalculatedDiv = 0.0, TaxPaid = 0.0, TaxDue = 0.0, TaxOver = 0.0, TaxToreturnDue = 0.0;

      ДобавитьВсеПараметры(NULL, RateIndexes);
      var i = 0;
      while(i < RateIndexes.Size())
         PlusSum = PlusSum + m_ArrCodeParms[RateIndexes[i]].PlusSum;
         DivPlus = DivPlus + m_ArrCodeParms[RateIndexes[i]].DivPlus;
         MinusSum = MinusSum + m_ArrCodeParms[RateIndexes[i]].MinusSum;
         TaxCalculated = TaxCalculated + m_ArrCodeParms[RateIndexes[i]].TaxCalculated;
         TaxCalculatedDiv = TaxCalculatedDiv + m_ArrCodeParms[RateIndexes[i]].TaxCalculatedDiv;
         TaxPaid = TaxPaid + m_ArrCodeParms[RateIndexes[i]].TaxPaid;
         TaxDue = TaxDue + m_ArrCodeParms[RateIndexes[i]].TaxDue;
         TaxOver = TaxOver + m_ArrCodeParms[RateIndexes[i]].TaxOver;
         TaxToReturnDue = TaxToReturnDue + m_ArrCodeParms[RateIndexes[i]].TaxToReturnDue;

         if((m_ArrCodeParms[RateIndexes[i]].PlusSum != $0) or (m_ArrCodeParms[RateIndexes[i]].DivPlus != $0) or (m_ArrCodeParms[RateIndexes[i]].MinusSum != $0) or
            (m_ArrCodeParms[RateIndexes[i]].TaxCalculated != $0) or (m_ArrCodeParms[RateIndexes[i]].TaxCalculatedDiv != $0) or (m_ArrCodeParms[RateIndexes[i]].TaxPaid != $0) or
            (m_ArrCodeParms[RateIndexes[i]].TaxDue != $0) or (m_ArrCodeParms[RateIndexes[i]].TaxOver != $0) or (m_ArrCodeParms[RateIndexes[i]].TaxToReturnDue != $0))
            InsertNPTX6Calc1(RateIndexes[i]);
         end;

         i = i + 1;
      end;
   end;

   macro CalcData(infoRate)
      m_InfoRate = infoRate;
      РассчитатьДоходыИВычеты();
   end;

   macro Rates()
      if(m_Set2 == null)
         m_Query2 = " SELECT "
                      + " COUNT(1) OVER () AS t_Count "
                     + " ,q.t_CountFL "
                     + " ,q.t_Rate "
                     + " ,SUM(q.t_TotalPlus) as t_TotalPlus "
                     + " ,SUM(q.t_DivPlus) as t_DivPlus "
                     + " ,SUM(q.t_TotalMinus) as t_TotalMinus "
                     + " ,SUM(q.t_TaxCalculated) as t_TaxCalculated "
                     + " ,SUM(q.t_TaxCalculatedDiv) as t_TaxCalculatedDiv "
                     + " ,SUM(q.t_TaxPaid) as t_TaxPaid "
                     + " ,SUM(q.t_TaxDue) as t_TaxDue "
                     + " ,SUM(q.t_TaxOver) as t_TaxOver "
                     + " ,SUM(q.t_TaxToReturnDue) as t_TaxToReturnDue "
                     + " ,SUM(q.t_Znp) as t_Znp "
                     + " ,q.t_IsHighRate "
                     + " ,(CASE WHEN q.t_IsHighRate = 'X' THEN '18210102080011000110' ELSE '18210102010011000110' END) as t_KBK "
                  + " FROM ( "
                     + "      SELECT qq.t_Rate "
                     + "            ,qq.t_CountFL "
                     + "            ,qq.t_TotalPlus "
                     + "            ,qq.t_DivPlus "
                     + "            ,qq.t_TotalMinus "
                     + "            ,qq.t_TaxCalculated "
                     + "            ,qq.t_TaxCalculatedDiv "
                     + "            ,qq.t_TaxPaid "
                     + "            ,( "
                     + "                case "
                     + "                   when qq.t_TaxPaid <= qq.t_TaxCalculated "
                     + "                     then qq.t_TaxCalculated -(qq.t_TaxPaid + qq.t_Znp) - qq.t_TaxToReturnDue "
                     + "                     else 0 "
                     + "                  end "
                     + "             ) as t_TaxDue "
                     + "            ,( "
                     + "                case "
                     + "                   when qq.t_TaxPaid > qq.t_TaxCalculated "
                     + "                   then qq.t_TaxPaid - qq.t_TaxCalculated + qq.t_TaxToReturnDue "
                     + "                   else 0 "
                     + "                end "
                     + "             ) as t_TaxOver "
                     + "            ,abs(qq.t_TaxToReturnDue) as t_TaxToReturnDue "
                     + "            ,qq.t_Znp "
                     + "            ,qq.t_IsHighRate "
                     + "      FROM ( "
                  + "                 SELECT tmp.t_Rate "
                     + "                    ,count(1) over(partition by tmp.t_RateType, tmp.t_IsHighRate, tmp.t_Rate) as t_CountFL "
                     + "                    ,NVL(SUM(tmp.t_TotalPlus), 0) + NVL(SUM(tmp.t_Plus2), 0) + NVL(SUM(tmp.t_Plus3), 0) + NVL(SUM(tmp.t_Plus5), 0) + NVL(SUM(tmp.t_Plus9), 0) AS t_TotalPlus "
                     + "                    ,SUM(t_DivPlus) AS t_DivPlus "
                     + "                    ,NVL(SUM(tmp.t_TotalMinus), 0) + NVL(SUM(tmp.t_Minus2), 0) + NVL(SUM(tmp.t_Minus3), 0) + NVL(SUM(tmp.t_Minus5), 0) + NVL(SUM(tmp.t_Minus9), 0) AS t_TotalMinus "
                     + "                    ,SUM(tmp.t_TaxCalculated) AS t_TaxCalculated "
                     + "                    ,SUM(tmp.t_TaxCalculatedDiv) AS t_TaxCalculatedDiv "
                     + "                    ,SUM(tmp.t_TaxPaid) AS t_TaxPaid"
                     + "                    ,SUM(tmp.t_TaxToReturnDue) AS t_TaxToReturnDue "
                     + "                    ,SUM(tmp.t_Znp) AS t_Znp "
                     + "                    ,tmp.t_IsHighRate "
                     + "              FROM "
                      + "                  dnptx6calc1_tmp tmp "
                     + "              GROUP BY tmp.t_ClientID, tmp.t_RateType, tmp.t_IsHighRate, tmp.t_Rate "
                     + "           ) qq "
                     + "   ) q "
                  + " GROUP BY "
                      + " q.t_Rate, "
                      + " q.t_IsHighRate, "
                      + " q.t_CountFL, "
                      + " (CASE WHEN q.t_IsHighRate = 'X' THEN '18210102080011000110' ELSE '18210102010011000110' END) "
                  + " ORDER BY "
                      + " q.t_Rate ASC, "
                      + " q.t_IsHighRate, "
                      + " (CASE WHEN q.t_IsHighRate = 'X' THEN '18210102080011000110' ELSE '18210102010011000110' END)";
   
         m_Cmd2 = RsdCommand(m_Query2);
         m_Cmd2.NullConversion = true;
         m_Cmd2.Execute();
   
         m_Set2 = RsdRecordset(m_Cmd2, RSDVAL_CLIENT, RSDVAL_STATIC);
      end;

      return m_Set2;
   end;

   if(_ByCB != null)
     m_ByCB = _ByCB;
   end;

   if(_ByDepo != null)
     m_ByDepo = _ByDepo;
   end;
 
   if(_ByVS != null)
     m_ByVS = _ByVS;
   end;
 
   if(_RepDate != null)
     m_RepDate2 = _RepDate;
   end;
 
   InitNPTXRepCalcCommon(_EndDate, _Investors, (m_ByDepo == SET_CHAR), (m_ByCB == SET_CHAR), (m_ByVS == SET_CHAR), false, false);
 
   if(_BeginDate != null)
     m_BeginDate = _BeginDate;
   end;
 
   if(_EndDate != null)
     m_EndDate = _EndDate;
   end;
 
   SQL_Truncate("dnptx6calc1_tmp");
END;

class NPTXRepCalc2_NPTXPIT6(_BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS)
  private const TypeOperCashWithdrawal = "Вывод д/с";
  private const TypeOperSecuritiesWithdrawal = "Вывод ц/б";
  private const TypeOperMaterialBenefits = "Материальная выгода";
  private const TypeOperEndOfYear = "Окончание года";
  private const TypeOperContractClosing = "Закрытие договора";
  private const TypeOperREPOPayments = "Выплаты в РЕПО";
  private const TypeOperCouponPayment = "Выплата купона";
  private const TypeOperIncomePayment = "Выплата дохода";
  private const TypeOperDividendPayment = "Выплата дивидендов";
  private const TypeOperCouponPayment2018 = "Выплата купона (2018)";

  private var m_BeginDate = ZeroDate;
  private var m_EndDate = ZeroDate;
  private var m_ByCB = UNSET_CHAR;
  private var m_ByDepo = UNSET_CHAR;
  private var m_ByVS = UNSET_CHAR;
  private var m_Query = "";
  private var m_Cmd = null;
  private var m_Set = null;
  private var m_QueryPrev = "";
  private var m_CmdPrev = null;
  private var m_SetPrev = null;
  private var m_Query2 = "";
  private var m_Cmd2 = null;
  private var m_Set2 = null;
  private var m_QueryRet = "";
  private var m_CmdRet = null;
  private var m_SetRet = null;

  macro Calculate()
    var payFaceValueIISAccType = 0, tipiCoupInDepoForIIS = UNSET_CHAR, dateOfIncomeInEurobond = 0;
    var query = "", cmd = null;
    var querylnk = "", cmdlnk = null;

    GetRegistryValue("DEPO\\ВЫПЛАТА НОМИНАЛА НА ИИС", V_INTEGER, payFaceValueIISAccType);
    GetRegistryValue("DEPO\\НДФЛ ПО КУПОНАМ В ДЕП. ДЛЯ ИИС", V_BOOL, tipiCoupInDepoForIIS);
    GetRegistryValue("COMMON\\НДФЛ\\ДАТА ДОХОДА ПО ЕВРОБОНДАМ", V_INTEGER, dateOfIncomeInEurobond);

    SQL_Truncate("dnptxop2oplnk_tmp");

    querylnk =   "insert into dnptxop2oplnk_tmp "
               + "( "
               + "   t_DocID "
               + "  ,t_Parent_DocID "
               + ") "
               + "SELECT nptxop.t_ID "
               + "      ,( "
               + "          SELECT MIN(nptxop2.t_ID) "
               + "          FROM dnptxop_dbt nptxop2 "
               + "          WHERE ( "
               + "                   nptxop2.t_DocKind = " + DL_HOLDNDFL + " "
               + "                   AND nptxop2.t_SubKind_Operation IN ("
                                                                           + DL_TXHOLD_OPTYPE_ENDYEAR
                                                                    + ", " + DL_TXHOLD_OPTYPE_OUTMONEY
                                                                    + ", " + DL_TXHOLD_OPTYPE_OUTAVOIR
                                                                    + ", " + DL_TXHOLD_OPTYPE_LUCRE
                                                                    + ", " + DL_TXHOLD_OPTYPE_CLOSE
                                                                     + ") "
               + "                   AND ( "
               + "                          nptxop2.t_OperDate between ( "
               + "                                                        CASE "
               + "                                                           WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
               + "                                                           THEN " + GetSQLDate(m_BeginDate)
               + "                                                           ELSE ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
               + "                                                        END "
               + "                                                     ) AND " + GetSQLDate(m_EndDate)
               + "                          OR nptxop2.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_ENDYEAR + " "
               + "                          AND EXTRACT(YEAR FROM nptxop2.t_PrevDate) = EXTRACT(YEAR FROM " + GetSQLDate(m_EndDate) + ")"
               + "                       ) "
               + "                   OR nptxop2.t_DocKind = " + DL_WRTMONEY + " "
               + "                   AND nptxop2.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
               + "                   AND nptxop2.t_FlagTax = " + GetSQLChar(SET_CHAR) + " "
               + "                   AND nptxop2.t_OperDate between ( "
               + "                                                     CASE "
               + "                                                        WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
               + "                                                        THEN " + GetSQLDate(m_BeginDate)
               + "                                                        ELSE ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
               + "                                                     END "
               + "                                                  ) AND " + GetSQLDate(m_EndDate) 
               + "                ) "
               + "                AND EXISTS ( "
               + "                              SELECT 1 "
               + "                              FROM dnptxobj_dbt nptxobj "
               + "                                  ,dnptxobdc_dbt nptxobdc "
               + "                              WHERE nptxobj.t_ObjID = nptxobdc.t_ObjID "
               + "                                AND nptxobdc.t_DocID = nptxop2.t_ID"
               + "                           ) "
               + "                AND nptxop2.t_Client = nptxop.t_Client "
               + "                AND nptxop2.t_OperDate >= nptxop.t_OperDate "
               + "       ) AS t_PID "
               + " FROM dnptxop_dbt nptxop "
               + "     ,("
               + "         SELECT q.t_Client "
               + "               ,MIN(q.t_EarlyDate) AS t_EarlyDate "
               + "               ,MAX(q.t_OperDate) AS t_LateDate "
               + "         FROM ("
               + "                 SELECT nptxop.t_DocKind "
               + "                       ,nptxop.t_SubKind_Operation "
               + "                       ,nptxop.t_Client "
               + "                       ,nptxop.t_OperDate "
               + "                       ,nptxop.t_PrevDate "
               + "                       ,nptxop.t_FlagTax "
               + "                       ,NVL(LEAD(nptxop.t_OperDate) OVER ("
               + "                                                            PARTITION BY nptxop.t_Client"
               + "                                                            ORDER BY nptxop.t_OperDate DESC, nptxop.t_ID DESC"
               + "                                                         ), " + GetSQLDate(ZeroDate)+ ") AS t_EarlyDate "
               + "                 FROM dnptxop_dbt nptxop "
               + "                 WHERE ( "
               + "                          nptxop.t_DocKind = " + DL_HOLDNDFL + " "
               + "                          AND nptxop.t_SubKind_Operation IN (" + DL_TXHOLD_OPTYPE_ENDYEAR
                                                                          + ", " + DL_TXHOLD_OPTYPE_OUTMONEY
                                                                          + ", " + DL_TXHOLD_OPTYPE_OUTAVOIR
                                                                          + ", " + DL_TXHOLD_OPTYPE_LUCRE
                                                                          + ", " + DL_TXHOLD_OPTYPE_CLOSE
                                                                           + ") "
               + "                          OR nptxop.t_DocKind = " + DL_WRTMONEY + " "
               + "                          AND nptxop.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
               + "                          AND nptxop.t_FlagTax = " + GetSQLChar(SET_CHAR)
               + "                       ) "
               + "                       AND EXISTS ("
               + "                                     SELECT 1 "
               + "                                     FROM dnptxobj_dbt nptxobj "
               + "                                         ,dnptxobdc_dbt nptxobdc "
               + "                                     WHERE nptxobj.t_ObjID = nptxobdc.t_ObjID "
               + "                                       AND nptxobdc.t_DocID = nptxop.t_ID"
               + "                                  )"
               + "              ) q "
               + "         WHERE q.t_DocKind = " + DL_HOLDNDFL + " "
               + "           AND q.t_SubKind_Operation IN (" + DL_TXHOLD_OPTYPE_ENDYEAR
                                                      + ", " + DL_TXHOLD_OPTYPE_OUTMONEY
                                                      + ", " + DL_TXHOLD_OPTYPE_OUTAVOIR
                                                      + ", " + DL_TXHOLD_OPTYPE_LUCRE
                                                      + ", " + DL_TXHOLD_OPTYPE_CLOSE
                                                       + ") "
               + "           AND ("
               + "                  q.t_OperDate between ( "
               + "                                          CASE "
               + "                                             WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
               + "                                             THEN " + GetSQLDate(m_BeginDate)
               + "                                             ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
               + "                                          END "
               + "                                       ) AND " + GetSQLDate(m_EndDate) 
               + "                  OR q.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_ENDYEAR + " "
               + "                  AND EXTRACT(YEAR FROM q.t_PrevDate) = EXTRACT(YEAR FROM " + GetSQLDate(m_EndDate) + ")"
               + "               ) "
               + "           OR q.t_DocKind = " + DL_WRTMONEY + " "
               + "           AND q.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
               + "           AND q.t_FlagTax = " + GetSQLChar(SET_CHAR) + " "
               + "           AND q.t_OperDate between ("
               + "                                       CASE "
               + "                                          WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
               + "                                          THEN " + GetSQLDate(m_BeginDate)
               + "                                          ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
               + "                                       END"
               + "                                    ) AND " + GetSQLDate(m_EndDate) 
               + "         GROUP BY q.t_Client "
               + "      ) q2 "
               + " WHERE nptxop.t_DocKind = " + DL_CALCNDFL + " "
               + "   AND EXISTS ( "
               + "                 SELECT 1 "
               + "                 FROM dnptxobj_dbt nptxobj "
               + "                     ,dnptxobdc_dbt nptxobdc "
               + "                 WHERE nptxobj.t_ObjID = nptxobdc.t_ObjID "
               + "                   AND nptxobdc.t_DocID = nptxop.t_ID "
               + "              ) "
               + "   AND nptxop.t_Client = q2.t_Client "
               + "   AND nptxop.t_OperDate > q2.t_EarlyDate "
               + "   AND nptxop.t_OperDate <= q2.t_LateDate ";

    cmdlnk = RSDCommand(querylnk);
    cmdlnk.NullConversion = true;
    cmdlnk.Execute();

    SQL_Truncate("dnptx6calc2_tmp");

    query = " INSERT INTO "
              + " dnptx6calc2_tmp(t_Module "
                             + " ,t_Num "
                             + " ,t_TypeOper "
                             + " ,t_ClientID "
                             + " ,t_Client "
                             + " ,t_ClientCode "
                             + " ,t_DatePlusFact "
                             + " ,t_DatePaid "
                             + " ,t_DateTransfer "
                             + " ,t_BaseDate "
                             + " ,t_TaxPaidDate "
                             + " ,t_DateOper "
                             + " ,t_DocKind "
                             + " ,t_DocID "
                             + " ,t_NumOper "
                             + " ,t_Rate "
                             + " ,t_TotalPlus "
                             + " ,t_TotalMinus "
                             + " ,t_TaxCalculated "
                             + " ,t_TaxDue "
                             + " ,t_TaxToReturnDue "
                             + " ,t_DateTaxReturn "
                             + " ,t_IsHighRate "
              + ")"
              + " SELECT "
                  + " CAST(t_Module AS NUMBER(5)) AS t_Module "
                 + " ,ROW_NUMBER() OVER (PARTITION BY t_Module ORDER BY t_DatePlusFact ASC, t_DatePaid ASC, t_DateTransfer ASC, TO_NUMBER(REGEXP_SUBSTR(t_Rate, '([^/]+)')) ASC) AS t_Num "
                 + " ,CAST(t_TypeOper AS VARCHAR2(21)) AS t_TypeOper "
                 + " ,CAST(t_ClientID AS NUMBER(10)) AS t_ClientID "
                 + " ,CAST(t_Client AS VARCHAR2(320)) AS t_Client "
                 + " ,CAST(t_ClientCode AS VARCHAR2(35)) AS t_ClientCode "
                 + " ,CAST(t_DatePlusFact AS DATE) AS t_DatePlusFact "
                 + " ,CAST(t_DatePaid AS DATE) AS t_DatePaid "
                 + " ,CAST(t_DateTransfer AS DATE) AS t_DateTransfer "
                 + " ,CAST(t_BaseDate AS NUMBER(32, 12)) AS t_BaseDate "
                 + " ,CAST(t_TaxPaidDate AS NUMBER(32, 12)) AS t_TaxPaidDate "
                 + " ,CAST(t_DateOper AS DATE) AS t_DateOper "
                 + " ,CAST(t_DocKind AS NUMBER(5)) AS t_DocKind "
                 + " ,CAST(t_DocID AS NUMBER(10)) AS t_DocID "
                 + " ,CAST(t_NumOper AS VARCHAR2(30)) AS t_NumOper "
                 + " ,CAST(t_Rate AS VARCHAR2(300)) AS t_Rate "
                 + " ,CAST(t_TotalPlus AS NUMBER(32, 12)) AS t_TotalPlus "
                 + " ,CAST("
                 + "         CASE"
                 + "            WHEN t_TotalMinus > t_TotalPlus"
                 + "            THEN t_TotalPlus"
                 + "            ELSE t_TotalMinus"
                 + "        END AS NUMBER(32, 12)"
                 + "      ) AS t_TotalMinus "
                 + " ,CAST(t_TaxCalculated AS NUMBER(32, 12)) AS t_TaxCalculated "
                 + " ,CAST(t_TaxDue AS NUMBER(32, 12)) AS t_TaxDue "
                 + " ,CAST(t_TaxToReturnDue AS NUMBER(32, 12)) AS t_TaxToReturnDue "
                 + " ,CAST(t_DateTaxReturn AS DATE) AS t_DateTaxReturn "
                 + " ,CAST(t_IsHighRate AS CHAR(1)) AS t_IsHighRate "
              + " FROM "
                  + " (SELECT "
                       + " q.t_Module "
                      + " ,q.t_TypeOper "
                      + " ,q.t_ClientID "
                      + " ,q.t_Client "
                      + " ,q.t_ClientCode "
                      + " ,q.t_DatePlusFact "
                      + " ,CASE "
                           + " WHEN q.t_Module = 2 "
                            + " AND q.t_TypeOper = " + GetSQLString(TypeOperCouponPayment) + " "
                            + " AND EXISTS (SELECT "
                                            + " 1 "
                                        + " FROM "
                                            + " dnptxobj_dbt nptxobj "
                                           + " ,ddppmobj_dbt dppmobj "
                                           + " ,ddppmacc_dbt dppmacc "
                                           + " ,ddpcorpop_dbt dpcorpop "
                                           + " ,ddpregstr_dbt dpregstr "
                                        + " WHERE "
                                            + " nptxobj.t_ObjID = dppmobj.t_ObjID "
                                        + " AND dppmobj.t_ObjKind = " + OBJTYPE_NPTXOBJ + " "
                                        + " AND dppmobj.t_PmAccID = dppmacc.t_ID "
                                        + " AND dppmacc.t_DocumentID = dpcorpop.t_DocumentID "
                                        + " AND dpcorpop.t_DocKind = " + SP_DEPOPER_DIVIDEND + " "
                                        + " AND dpcorpop.t_Department = " + {OperDprt} + " "
                                        + " AND dpcorpop.t_TransferTax = " + GetSQLChar(SET_CHAR) + " "
                                        + " AND dpregstr.t_DocumentID = dpcorpop.t_DocumentID "
                                        + " AND rsi_nptx.ResidenceStatus(dpregstr.t_Issuer, " + GetSQLDate(m_EndDate) + ") <> 1 "
                                        + " AND dpcorpop.t_Currency <> " + NATCUR + ") "
                            + " AND 1 = " + IIF(dateOfIncomeInEurobond == 0, 1, 0) + " "
                           + " THEN "
                               + " CASE "
                                   + " WHEN NOT q2.t_Flag IS NULL "
                                   + " THEN "
                                       + " q.t_DatePlusFact "
                                   + " ELSE "
                                       + " " + GetSQLDate(ZeroDate) + " "
                               + " END "
                           + " ELSE "
                               + " q.t_DatePaid "
                       + " END AS t_DatePaid "
                      + " ,CASE "
                           + " WHEN q2.t_Flag = 0 "
                           + " THEN "
                               + " q2.t_Date "
                           + " ELSE "
                               + " q.t_DateTransfer "
                       + " END AS t_DateTransfer "
                      + " ,CASE "
                           + " WHEN q2.t_Flag IS NULL "
                           + " THEN "
                               + " q.t_BaseDate "
                           + " ELSE "
                               + " ROUND(q.t_BaseDate "
                                   + " * CASE "
                                         + " WHEN q2.t_Flag = 0 "
                                         + " THEN "
                                             + " q2.t_Sum "
                                         + " ELSE "
                                             + " q.t_TaxPaidDate "
                                     + " END "
                                   + " / q2.t_AllSum, 2) "
                       + " END AS t_BaseDate "
                      + " ,CASE "
                           + " WHEN q2.t_Flag = 0 "
                           + " THEN "
                               + " q2.t_Sum "
                           + " ELSE "
                               + " q.t_TaxPaidDate "
                       + " END AS t_TaxPaidDate "
                      + " ,q.t_DateOper "
                      + " ,q.t_DocKind "
                      + " ,q.t_DocID "
                      + " ,q.t_NumOper "
                      + " ,NVL(rsi_nptx.LISTAGG_DISTINCT(q.t_Rate, '/'), CHR(1)) AS t_Rate "
                      + " ,q.t_TotalPlus "
                      + " ,q.t_TotalMinus "
                      + " ,q.t_TaxCalculated "
                      + " ,q.t_TaxCalculated - q.t_TaxPaidDate AS t_TaxDue "
                      + " ,q.t_TaxToReturnDue "
                      + " ,q.t_DateTaxReturn "
                      + " ,q.t_IsHighRate "
                   + " FROM "
                       + " (SELECT "
                            + " t_Module "
                           + " ,t_TypeOper "
                           + " ,t_ClientID "
                           + " ,(SELECT "
                                 + " party.t_Name "
                             + " FROM "
                                 + " dparty_dbt party "
                             + " WHERE "
                                 + " party.t_PartyID = t_ClientID) AS t_Client "
                           + " ,rsi_rsbparty.GetPartyCode(t_ClientID, 1) AS t_ClientCode "
                           + " ,t_DatePlusFact "
                           + " ,t_DatePaid "
                           + " ,t_DateTransfer "
                           + " ,SUM(t_BaseDate) AS t_BaseDate "
                           + " ,SUM(t_TaxPaidDate) AS t_TaxPaidDate "
                           + " ,t_DateOper "
                           + " ,t_DocKind "
                           + " ,t_DocID "
                           + " ,t_NumOper "
                           + " ,LISTAGG(t_Rate, '/') WITHIN GROUP (ORDER BY t_Rate ASC) AS t_Rate "
                           + " ,SUM(t_TotalPlus) AS t_TotalPlus "
                           + " ,SUM(t_TotalMinus) AS t_TotalMinus "
                           + " ,SUM(t_TaxCalculated) AS t_TaxCalculated "
                           + " ,SUM(t_TaxToReturnDue) AS t_TaxToReturnDue "
                           + " ,t_DateTaxReturn "
                           + " ,t_IsHighRate "
                        + " FROM "
                            + " (SELECT "
                                 + " t_Module "
                                + " ,t_TypeOper "
                                + " ,t_ClientID "
                                + " ,t_DatePlusFact "
                                + " ,t_DatePaid "
                                + " ,t_DateTransfer "
                                + " ,t_BaseDate "
                                + " ,t_TaxPaidDate "
                                + " ,t_DateOper "
                                + " ,t_DocKind "
                                + " ,t_DocID "
                                + " ,t_NumOper "
                                + " ,t_Rate "
                                + " ,t_TotalPlus "
                                + " ,t_TotalMinus "
                                /*+ " ,CASE "
                                + " WHEN t_TotalPlus - t_TotalMinus >= 0 "
                                + "  THEN "
                                + "    round( (t_TotalPlus - t_TotalMinus) * TO_NUMBER(t_Rate) / 100 , 0) "  /*Def: 14886*/
                                + "  ELSE "
                                + "     0 "
                                + "  END AS t_TaxCalculated "*/
                                + " ,t_TaxCalculated "
                                + " ,t_TaxToReturnDue "
                                 + " ,t_DateTaxReturn "
                                + " ,t_IsHighRate "
                             + " FROM "
                                 + " ( "
                                    + " SELECT "
                                        + " t_Module "
                                       + " ,t_TypeOper "
                                       + " ,t_ClientID "
                                       + " ,t_DatePlusFact "
                                       + " ,t_DatePaid "
                                       + " ,t_DateTransfer "
                                       + " ,t_BaseDate "
                                       + " ,t_TaxPaidDate "
                                       + " ,t_DateOper "
                                       + " ,t_DocKind "
                                       + " ,t_DocID "
                                       + " ,t_NumOper "
                                       + " ,t_Rate "
                                       + " ,t_TotalPlus "
                                       + " ,t_TotalMinus "
                                + " ,CASE "
                                     + " WHEN t_TotalPlus - t_TotalMinus >= 0 "
                                     + " THEN "
                                         + " Round((t_TotalPlus - t_TotalMinus) * TO_NUMBER(t_Rate) / 100, 0) "/*Def: 14886*/
                                     + " ELSE "
                                         + " 0 "
                                       + "  END AS t_TaxCalculated "
                                       + " ,t_TaxToReturnDue "
                                       + " ,t_DateTaxReturn "
                                       + " ,t_IsHighRate "
                                    + " FROM "
                                        + " ("
                                         + " SELECT q.t_Module AS t_Module "
                                         + " ,q.t_TypeOper "
                                         + " ,q.t_ClientID "
                                         + " ,q.t_DatePlusFact "
                                         + " ,q.t_DatePaid "
                                         + " ,q.t_DateTransfer "
                                            + " ,CASE "
                                               + " WHEN q.t_IsHighRate <> chr(88) "
                                               + " THEN q.t_BaseDate "
                                               + " WHEN q.t_IsHighRate = chr(88) and q.t_TotalPlus - q.t_TotalMinus > " + Max15
                                               + " THEN q.t_TotalPlus - q.t_TotalMinus - " + Max15
                                               + " ELSE 0 "
                                             + " END AS t_BaseDate "
                                            + " ,q.t_TaxPaidDate AS t_TaxPaidDate "
                                            + " ,q.t_DateOper "
                                            + " ,q.t_DocKind "
                                            + " ,q.t_DocID "
                                            + " ,q.t_NumOper "
                                            + " ,q.t_Rate "
                                            + " ,CASE "
                                               + " WHEN q.t_IsHighRate <> chr(88) AND q.t_TotalPlus - q.t_TotalMinus <= " + Max15
                                               + " THEN q.t_TotalPlus "
                                               + " WHEN q.t_IsHighRate <> chr(88) AND q.t_TotalPlus - q.t_TotalMinus > " + Max15
                                               + " THEN q.t_TotalMinus + " + Max15
                                               + " WHEN q.t_IsHighRate = chr(88) AND q.t_TotalPlus - q.t_TotalMinus > " + Max15
                                               + " THEN q.t_TotalPlus - q.t_TotalMinus - " + Max15
                                               + " ELSE 0 "
                                             + " END AS t_TotalPlus "
                                            + " ,CASE "
                                                + " WHEN q.t_IsHighRate <> chr(88) "
                                                + " THEN q.t_TotalMinus "
                                                + " ELSE 0 "
                                             + " END AS t_TotalMinus "
                                            + " ,q.t_TaxToReturnDue "
                                            + " ,q.t_DateTaxReturn "
                                            + " ,q.t_IsHighRate "
                                         + " FROM ( "
                                                 + " SELECT "
                                                + " NVL2(dppmobj.t_ID, 2, 1) AS t_Module "
                                                    + " ,CASE "
                                                         + " WHEN nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                         + " THEN "
                                                             + " CASE "
                                                                 + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_OUTMONEY + " "
                                                                 + " THEN "
                                                                     + " " + GetSQLString(TypeOperCashWithdrawal) + " "
                                                                 + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_OUTAVOIR + " "
                                                                 + " THEN "
                                                                     + " " + GetSQLString(TypeOperSecuritiesWithdrawal) + " "
                                                                 + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE + " "
                                                                 + " THEN "
                                                                     + " " + GetSQLString(TypeOperMaterialBenefits) + " "
                                                                 + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_ENDYEAR + " "
                                                                 + " THEN "
                                                                     + " " + GetSQLString(TypeOperEndOfYear) + " "
                                                                 + " ELSE "
                                                                     + " " + GetSQLString(TypeOperContractClosing) + " "
                                                             + " END "
                                                         + " ELSE "
                                                             + " " + GetSQLString(TypeOperCashWithdrawal) + " "
                                                     + " END AS t_TypeOper "
                                                    + " ,nptxop.t_Client AS t_ClientID "
                                                    + " ,nptxop.t_OperDate AS t_DatePlusFact "
                                                    + " ,nptxop.t_OperDate AS t_DatePaid "
                                                    + " ,CASE "
                                                         + " WHEN nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                          + " AND nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_ENDYEAR + " "
                                                         + " THEN "
                                                             + " TO_DATE('31.03.' || TO_CHAR(EXTRACT(YEAR FROM nptxop.t_PrevDate) + 1, '9999'), 'DD.MM.YYYY') "
                                                         + " ELSE "
                                                             + " nptxop.t_OperDate "
                                                     + " END AS t_DateTransfer "
                                                    + " ,CASE "
                                                         + " WHEN nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                         + " THEN "
                                                             + " CASE "
                                                                 + " WHEN nptxop.t_SubKind_Operation IN (" + DL_TXHOLD_OPTYPE_OUTMONEY
                                                                                                    + ", " + DL_TXHOLD_OPTYPE_OUTAVOIR + ") "
                                                                 + " THEN "
                                                                     + " nptxop.t_TOut "
                                                                 + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE + " "
                                                                 + " THEN "
                                                                     + " NVL((SELECT "
                                                                              + " SUM(nptxobj.t_Sum) "
                                                                          + " FROM "
                                                                              + " dnptxobj_dbt nptxobj "
                                                                          + " WHERE "
                                                                              + " (nptxobj.t_Kind = " + TXOBJ_BASEMATERIAL + " "
                                                                            + " OR nptxobj.t_Kind = " + TXOBJ_BASEMATERIAL_IIS + " "
                                                                           + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1) "
                                                                          + "AND nptxobj.t_Date between nptxop.t_PrevDate and "
                                                                                                                              + " CASE "
                                                                                                                                 + " WHEN TO_DATE('31.12.' || extract(year from nptxop.t_PrevDate), 'dd.mm.yyyy') > nptxop.t_OperDate "
                                                                                                                                 + " THEN nptxop.t_OperDate "
                                                                                                                                 + " ELSE TO_DATE('31.12.' || extract(year from nptxop.t_PrevDate), 'dd.mm.yyyy')"
                                                                                                                              + " END), 0) "
                                                                 + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_CLOSE + " "
                                                                 + " THEN "
                                                                     + " nptxop.t_TOut "
                                                                 + " ELSE "
                                                                     + " nptxop.t_TaxBase "
                                                             + " END "
                                                         + " WHEN nptxop.t_DocKind = " + DL_WRTMONEY + " and nptxop.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
                                                         + " THEN "
                                                             + " rsb_fiinstr.ConvSum(nptxop.t_OutSum, nptxop.t_Currency, " + NATCUR + ", nptxop.t_OperDate) "
                                                         + " ELSE "
                                                             + " nptxop.t_TaxSum2 "
                                                     + " END AS t_BaseDate "
                                                    + " ,( "
                                                    + "     select nvl(sum(nptxobj.t_Sum0), 0) "
                                                    + "     from dnptxobj_dbt nptxobj, dnptxobdc_dbt nptxobdc "
                                                    + "     where ( "
                                                    + "              ( "
                                                    + "                 not ( "
                                                    + "                        nptxop.t_DocKind = " + DL_HOLDNDFL
                                                    + "                        and nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE
                                                    + "                     ) "
                                                    + "                 and ( "
                                                    + "                        nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL
                                                    + "                        or ( "
                                                    + "                              nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_IIS
                                                    + "                              and nptxobj.t_Analitickind6 = " + TXOBJ_KIND6020
                                                    + "                              and rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                                    + "                           ) "
                                                    + "                     ) "
                                                    + "              ) "
                                                    + "           or ( "
                                                    + "                 ( "
                                                    + "                    nptxop.t_DocKind = " + DL_HOLDNDFL
                                                    + "                    and nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE
                                                    + "                 ) "
                                                    + "                 and ( "
                                                    + "                        nptxobj.t_Kind = " + TXOBJ_PAIDMATERIAL
                                                    + "                        or ( "
                                                    + "                              nptxobj.t_Kind = " + TXOBJ_PAIDMATERIAL_IIS
                                                    + "                              and nptxobj.t_AnaliticKind6 = " + TXOBJ_KIND6020
                                                    + "                              and rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1"
                                                    + "                           ) "
                                                    + "                     ) "
                                                    + "              ) "
                                                    + "           ) "
                                                    + "        and nptxobj.t_Sum0 > 0 "
                                                    + "        and nptxobdc.t_ObjID = nptxobj.t_ObjID "
                                                    + "        and nptxobdc.t_DocID = nptxop.t_ID "
                                                    + "  ) AS t_TaxPaidDate "
                                                    + " ,nptxop.t_OperDate AS t_DateOper "
                                                    + " ,nptxop.t_DocKind AS t_DocKind "
                                                    + " ,nptxop.t_ID AS t_DocID "
                                                    + " ,nptxop.t_Code AS t_NumOper "
                                                    + " ,CASE "
                                                         + " WHEN rsi_nptx.ResidenceStatus(nptxop.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                                         + " THEN "
                                                             + " TO_CHAR(" + 13 + ") "
                                                         + " ELSE "
                                                             + " CASE "
                                                                 + " WHEN EXISTS (SELECT "
                                                                                  + " 1 "
                                                                              + " FROM "
                                                                                  + " dnotetext_dbt notetext "
                                                                              + " WHERE "
                                                                                  + " notetext.t_ObjectType = " + OBJTYPE_PARTY + " "
                                                                              + " AND notetext.t_DocumentID = LPAD(nptxop.t_Client, 10, '0') "
                                                                              + " AND notetext.t_NoteKind = " + 77 + " "
                                                                              + " AND " + GetSQLDate(m_EndDate) + " BETWEEN notetext.t_Date AND notetext.t_ValidToDate) "
                                                                 + " THEN "
                                                                     + " TO_CHAR(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + OBJTYPE_PARTY + ", LPAD(nptxop.t_Client, 10, '0'), " + 77 + ", " + GetSQLDate(m_EndDate) + "))) "
                                                                 + " ELSE "
                                                                     + " TO_CHAR(" + 30 + ") "
                                                             + " END "
                                                     + " END AS t_Rate "
                                                    + " ,NVL((SELECT "
                                                              + " SUM(t_Sum) "
                                                          + " FROM "
                                                              + " dnptxobj_dbt nptxobj "
                                                             + " ,dnptxobdc_dbt nptxobdc "
                                                          + " WHERE "
                                                              + " nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                          + " AND nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE + " "
                                                          + " AND (nptxobj.t_Kind = " + TXOBJ_BASEMATERIAL + " "
                                                            + " OR nptxobj.t_Kind = " + TXOBJ_BASEMATERIAL_IIS + " "
                                                           + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1) "
                                                          + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                          + " AND nptxobdc.t_DocID IN (SELECT "
                                                                                        + " nptxop2oplnk.t_DocID "
                                                                                    + " FROM "
                                                                                        + " dnptxop2oplnk_tmp nptxop2oplnk "
                                                                                    + " WHERE "
                                                                                        + " nptxop2oplnk.t_Parent_DocID = nptxop.t_ID) "
                                                           + " OR (nptxop.t_DocKind <> " + DL_HOLDNDFL + " "
                                                            + " OR nptxop.t_SubKind_Operation <> " + DL_TXHOLD_OPTYPE_LUCRE + ") "
                                                           + " AND (nptxobj.t_Kind IN (" + TXOBJ_PLUSG_1010
                                                                                 + ", " + TXOBJ_PLUSG_1011
                                                                                 + ", " + TXOBJ_PLUSG_1530
                                                                                 + ", " + TXOBJ_PLUSG_1531
                                                                                 + ", " + TXOBJ_PLUSG_1536
                                                                                 + ", " + TXOBJ_PLUSG_1532
                                                                                 + ", " + TXOBJ_PLUSG_1533
                                                                                 + ", " + TXOBJ_PLUSG_1535
                                                                                 + ", " + TXOBJ_PLUSG_1537
                                                                                 + ", " + TXOBJ_PLUSG_1539
                                                                                 + ", " + TXOBJ_PLUSG_1110
                                                                                 + ", " + TXOBJ_PLUSG_2640
                                                                                 + ", " + TXOBJ_PLUSG_2641
                                                                                 + ", " + TXOBJ_PLUSG_2800 + ") "
                                                            + " OR nptxobj.t_Kind = " + TXOBJ_PLUS35_3023 + " "
                                                           + " AND rsi_nptx.ResidenceStatus(nptxop.t_Client, " + GetSQLDate(m_EndDate) + ") <> 1 "
                                                            + " OR nptxobj.t_Kind IN (" + TXOBJ_PLUSG_1011_IIS
                                                                                 + ", " + TXOBJ_PLUSG_1544
                                                                                 + ", " + TXOBJ_PLUSG_1545
                                                                                 + ", " + TXOBJ_PLUSG_1549
                                                                                 + ", " + TXOBJ_PLUSG_1546
                                                                                 + ", " + TXOBJ_PLUSG_1547
                                                                                 + ", " + TXOBJ_PLUSG_1548
                                                                                 + ", " + TXOBJ_PLUSG_1551
                                                                                 + ", " + TXOBJ_PLUSG_1553
                                                                                 + ", " + TXOBJ_PLUSG_2640_IIS
                                                                                 + ", " + TXOBJ_PLUSG_2641_IIS + ") "
                                                           + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1) "
                                                          + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                          + " AND (nptxobdc.t_DocID = nptxop.t_ID "
                                                            + " OR nptxobdc.t_DocID IN (SELECT "
                                                                                        + " nptxop2oplnk.t_DocID "
                                                                                    + " FROM "
                                                                                        + " dnptxop2oplnk_tmp nptxop2oplnk "
                                                                                    + " WHERE "
                                                                                        + " nptxop2oplnk.t_Parent_DocID = nptxop.t_ID))), 0) AS t_TotalPlus "
                                                    + " ,NVL((SELECT "
                                                              + " SUM(t_Sum) "
                                                          + " FROM "
                                                              + " dnptxobj_dbt nptxobj "
                                                             + " ,dnptxobdc_dbt nptxobdc "
                                                          + " WHERE "
                                                              + " (nptxop.t_DocKind <> " + DL_HOLDNDFL + " "
                                                            + " OR nptxop.t_SubKind_Operation <> " + DL_TXHOLD_OPTYPE_LUCRE + ") "
                                                          + " AND (nptxobj.t_Kind IN (" + TXOBJ_MINUSG_201
                                                                                 + ", " + TXOBJ_MINUSG_202
                                                                                 + ", " + TXOBJ_MINUSG_203
                                                                                 + ", " + TXOBJ_MINUSG_206
                                                                                 + ", " + TXOBJ_MINUSG_207
                                                                                 + ", " + TXOBJ_MINUSG_205
                                                                                 + ", " + TXOBJ_MINUSG_208
                                                                                 + ", " + TXOBJ_MINUSG_209
                                                                                 + ", " + TXOBJ_MINUSG_210
                                                                                 + ", " + TXOBJ_MINUSG_211
                                                                                 + ", " + TXOBJ_MINUSG_222
                                                                                 + ", " + TXOBJ_MINUSG_213
                                                                                 + ", " + TXOBJ_MINUSG_214
                                                                                 + ", " + TXOBJ_MINUSG_220
                                                                                 + ", " + TXOBJ_MINUSG_223
                                                                                 + ", " + TXOBJ_MINUSG_224
                                                                                 + ", " + TXOBJ_MINUSG_218
                                                                                 + ", " + TXOBJ_MINUSG_219
                                                                                 + ", " + TXOBJ_MINUSG_218_1
                                                                                 + ", " + TXOBJ_MINUSG_219_1
                                                                                 + ", " + TXOBJ_MINUSG_618
                                                                                 + ", " + TXOBJ_MINUSG_601 + ") "
                                                             + " OR nptxobj.t_Kind IN (" + TXOBJ_MINUSG_225
                                                                                 + ", " + TXOBJ_MINUSG_226
                                                                                 + ", " + TXOBJ_MINUSG_227
                                                                                 + ", " + TXOBJ_MINUSG_228
                                                                                 + ", " + TXOBJ_MINUSG_229
                                                                                 + ", " + TXOBJ_MINUSG_250
                                                                                 + ", " + TXOBJ_MINUSG_251
                                                                                 + ", " + TXOBJ_MINUSG_252
                                                                                 + ", " + TXOBJ_MINUSG_241
                                                                                 + ", " + TXOBJ_MINUSG_230
                                                                                 + ", " + TXOBJ_MINUSG_239
                                                                                 + ", " + TXOBJ_MINUSG_231
                                                                                 + ", " + TXOBJ_MINUSG_214_IIS
                                                                                 + ", " + TXOBJ_MINUSG_235
                                                                                 + ", " + TXOBJ_MINUSG_240
                                                                                 + ", " + TXOBJ_MINUSG_236
                                                                                 + ", " + TXOBJ_MINUSG_233
                                                                                 + ", " + TXOBJ_MINUSG_234
                                                                                 + ", " + TXOBJ_MINUSG_619 + ") "
                                                           + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1) "
                                                          + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                          + " AND (nptxobdc.t_DocID = nptxop.t_ID "
                                                            + " OR nptxobdc.t_DocID IN (SELECT "
                                                                                        + " nptxop2oplnk.t_DocID "
                                                                                    + " FROM "
                                                                                        + " dnptxop2oplnk_tmp nptxop2oplnk "
                                                                                    + " WHERE "
                                                                                        + " nptxop2oplnk.t_Parent_DocID = nptxop.t_ID))), 0) AS t_TotalMinus "
                                                    + " ,( "
                                                    + "     select nvl(sum(nptxobj.t_Sum0), 0) "
                                                    + "     from dnptxobj_dbt nptxobj, dnptxobdc_dbt nptxobdc "
                                                    + "     where ( "
                                                    + "              ( "
                                                    + "                 not ( "
                                                    + "                        nptxop.t_DocKind = " + DL_HOLDNDFL
                                                    + "                        and nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE
                                                    + "                     ) "
                                                    + "                 and ( "
                                                    + "                        nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL
                                                    + "                        or ( "
                                                    + "                              nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_IIS
                                                    + "                              and nptxobj.t_Analitickind6 = " + TXOBJ_KIND6020
                                                    + "                              and rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                                    + "                           ) "
                                                    + "                     ) "
                                                    + "              ) "
                                                    + "          or ( "
                                                    + "                ( "
                                                    + "                   nptxop.t_DocKind = " + DL_HOLDNDFL
                                                    + "                   and nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE
                                                    + "                ) "
                                                    + "                and ( "
                                                    + "                       nptxobj.t_Kind = " + TXOBJ_PAIDMATERIAL
                                                    + "                       or ( "
                                                    + "                             nptxobj.t_Kind = " + TXOBJ_PAIDMATERIAL_IIS
                                                    + "                             and nptxobj.t_AnaliticKind6 = " + TXOBJ_KIND6020
                                                    + "                             and rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1"
                                                    + "                          ) "
                                                    + "                    ) "
                                                    + "             ) "
                                                    + "          ) "
                                                    + "       and nptxobj.t_Sum0 < 0 "
                                                    + "       and nptxobdc.t_ObjID = nptxobj.t_ObjID "
                                                    + "       and nptxobdc.t_DocID = nptxop.t_ID "
                                                    + "  ) AS t_TaxToReturnDue "
                                                    + " ,CASE "
                                                    + "      WHEN nptxop.t_Tax < 0 "
                                                         + " THEN "
                                                             + " rsi_rsbcalendar.GetDateAfterWorkDay(CASE "
                                                                                                    + " WHEN TO_CHAR(ADD_MONTHS(nptxop.t_OperDate, 1), 'DD.MM.YYYY') = '00.00.0000' "
                                                                                                    + " THEN "
                                                                                                        + " TO_DATE('31.12.9999', 'DD.MM.YYYY') "
                                                                                                    + " ELSE "
                                                                                                        + " ADD_MONTHS(nptxop.t_OperDate, 1) "
                                                                                                + " END, 0) "
                                                         + " ELSE "  
                                                             + " to_date('01.01.0001', 'dd.mm.yyyy') "
                                                    + " END AS t_DateTaxReturn "
                                                    + " ,nptxop.t_ID "
                                                    + " ,chr(0) AS t_IsHighRate"
                                                  + " FROM "
                                                      + " dnptxop_dbt nptxop "
                                                     + " ,ddppmobj_dbt dppmobj "
                                                  + " WHERE "
                                                      + " (nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                   + " AND nptxop.t_SubKind_Operation IN (" + DL_TXHOLD_OPTYPE_ENDYEAR
                                                                                     + ", " + DL_TXHOLD_OPTYPE_OUTMONEY
                                                                                     + ", " + DL_TXHOLD_OPTYPE_OUTAVOIR
                                                                                     + ", " + DL_TXHOLD_OPTYPE_LUCRE
                                                                                     + ", " + DL_TXHOLD_OPTYPE_CLOSE + ") "
                                                   + " AND nptxop.t_OperDate between ( CASE "
                                                                                      + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                                      + " THEN " + GetSQLDate(m_BeginDate)
                                                                                      + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                                   + " END ) AND " + GetSQLDate(m_EndDate) 
                                                    + " OR nptxop.t_DocKind = " + DL_WRTMONEY + " "
                                                   + " AND nptxop.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
                                                   + " AND nptxop.t_FlagTax = " + GetSQLChar(SET_CHAR) + " "
                                                   + " AND nptxop.t_OperDate between ( CASE "
                                                                                      + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                                      + " THEN " + GetSQLDate(m_BeginDate)
                                                                                      + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                                   + " END ) AND " + GetSQLDate(m_EndDate) 
                                                  + ") "          
                                                  + " AND EXISTS (SELECT "
                                                                  + " 1 "
                                                              + " FROM "
                                                                  + " dnptxobj_dbt nptxobj "
                                                                 + " ,dnptxobdc_dbt nptxobdc "
                                                              + " WHERE "
                                                                  + " nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                              + " AND nptxobdc.t_DocID = nptxop.t_ID) "
                                                  + " AND dppmobj.t_ObjKind(+) = nptxop.t_DocKind "
                                                  + " AND dppmobj.t_ObjID(+) = nptxop.t_ID "
                                                  + " AND (1 = " + IIF(m_ByCB == SET_CHAR, 1, 0) + " "
                                                   + " AND dppmobj.t_ID IS NULL "
                                                    + " OR 1 = " + IIF(m_ByDEPO == SET_CHAR, 1, 0) + " "
                                                   + " AND NOT dppmobj.t_ID IS NULL) "
                                            // для повышенной ставки 15%
                                            + " union all "
                                            + " SELECT "
                                                + " NVL2(dppmobj.t_ID, 2, 1) AS t_Module "
                                               + " ,CASE "
                                                    + " WHEN nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                    + " THEN "
                                                        + " CASE "
                                                            + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_OUTMONEY + " "
                                                            + " THEN "
                                                                + " " + GetSQLString(TypeOperCashWithdrawal) + " "
                                                            + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_OUTAVOIR + " "
                                                            + " THEN "
                                                                + " " + GetSQLString(TypeOperSecuritiesWithdrawal) + " "
                                                            + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE + " "
                                                            + " THEN "
                                                                + " " + GetSQLString(TypeOperMaterialBenefits) + " "
                                                            + " WHEN nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_ENDYEAR + " "
                                                            + " THEN "
                                                                + " " + GetSQLString(TypeOperEndOfYear) + " "
                                                            + " ELSE "
                                                                + " " + GetSQLString(TypeOperContractClosing) + " "
                                                        + " END "
                                                    + " ELSE "
                                                        + " " + GetSQLString(TypeOperCashWithdrawal) + " "
                                                + " END AS t_TypeOper "
                                               + " ,nptxop.t_Client AS t_ClientID "
                                               + " ,nptxop.t_OperDate AS t_DatePlusFact "
                                               + " ,nptxop.t_OperDate AS t_DatePaid "
                                               + " ,CASE "
                                                    + " WHEN nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                     + " AND nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_ENDYEAR + " "
                                                    + " THEN "
                                                        + " TO_DATE('31.03.' || TO_CHAR(EXTRACT(YEAR FROM nptxop.t_PrevDate) + 1, '9999'), 'DD.MM.YYYY') "
                                                    + " ELSE "
                                                        + " nptxop.t_OperDate "
                                                + " END AS t_DateTransfer "
                                               + " ,0 AS t_BaseDate "
                                                + " ,( "
                                                + "     select nvl(sum(nptxobj.t_Sum0), 0) "
                                                + "     from dnptxobj_dbt nptxobj, dnptxobdc_dbt nptxobdc "
                                                + "     where nptxobj.t_Kind in (" + TXOBJ_PAIDGENERAL_15_1
                                                                            + ", " + TXOBJ_PAIDGENERAL_15_2
                                                                            + ", " + TXOBJ_PAIDGENERAL_15_9
                                                                            + ", " + TXOBJ_PAIDGENERAL_15_IIS
                                                                            + " ) "
                                                + "       and nptxobj.t_Sum0 > 0 "
                                                + "       and nptxobdc.t_ObjID = nptxobj.t_ObjID "
                                                + "       and nptxobdc.t_DocID = nptxop.t_ID "
                                                + "  ) AS t_TaxPaidDate "
                                               + " ,nptxop.t_OperDate AS t_DateOper "
                                               + " ,nptxop.t_DocKind AS t_DocKind "
                                               + " ,nptxop.t_ID AS t_DocID "
                                               + " ,nptxop.t_Code AS t_NumOper "
                                               + " ,'15' AS t_Rate "
                                               + " ,NVL((SELECT "
                                                         + " SUM(t_Sum) "
                                                     + " FROM "
                                                         + " dnptxobj_dbt nptxobj "
                                                        + " ,dnptxobdc_dbt nptxobdc "
                                                     + " WHERE "
                                                         + " nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                                     + " AND nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_LUCRE + " "
                                                     + " AND (nptxobj.t_Kind = " + TXOBJ_BASEMATERIAL + " "
                                                       + " OR nptxobj.t_Kind = " + TXOBJ_BASEMATERIAL_IIS + " "
                                                      + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1) "
                                                     + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                     + " AND nptxobdc.t_DocID IN (SELECT "
                                                                                   + " nptxop2oplnk.t_DocID "
                                                                               + " FROM "
                                                                                   + " dnptxop2oplnk_tmp nptxop2oplnk "
                                                                               + " WHERE "
                                                                                   + " nptxop2oplnk.t_Parent_DocID = nptxop.t_ID) "
                                                      + " OR (nptxop.t_DocKind <> " + DL_HOLDNDFL + " "
                                                       + " OR nptxop.t_SubKind_Operation <> " + DL_TXHOLD_OPTYPE_LUCRE + ") "
                                                      + " AND (nptxobj.t_Kind IN (" + TXOBJ_PLUSG_1010
                                                                            + ", " + TXOBJ_PLUSG_1011
                                                                            + ", " + TXOBJ_PLUSG_1530
                                                                            + ", " + TXOBJ_PLUSG_1531
                                                                            + ", " + TXOBJ_PLUSG_1536
                                                                            + ", " + TXOBJ_PLUSG_1532
                                                                            + ", " + TXOBJ_PLUSG_1533
                                                                            + ", " + TXOBJ_PLUSG_1535
                                                                            + ", " + TXOBJ_PLUSG_1537
                                                                            + ", " + TXOBJ_PLUSG_1539
                                                                            + ", " + TXOBJ_PLUSG_1110
                                                                            + ", " + TXOBJ_PLUSG_2640
                                                                            + ", " + TXOBJ_PLUSG_2641
                                                                            + ", " + TXOBJ_PLUSG_2800 + ") "
                                                       + " OR nptxobj.t_Kind = " + TXOBJ_PLUS35_3023 + " "
                                                      + " AND rsi_nptx.ResidenceStatus(nptxop.t_Client, " + GetSQLDate(m_EndDate) + ") <> 1 "
                                                       + " OR nptxobj.t_Kind IN (" + TXOBJ_PLUSG_1011_IIS
                                                                            + ", " + TXOBJ_PLUSG_1544
                                                                            + ", " + TXOBJ_PLUSG_1545
                                                                            + ", " + TXOBJ_PLUSG_1549
                                                                            + ", " + TXOBJ_PLUSG_1546
                                                                            + ", " + TXOBJ_PLUSG_1547
                                                                            + ", " + TXOBJ_PLUSG_1548
                                                                            + ", " + TXOBJ_PLUSG_1551
                                                                            + ", " + TXOBJ_PLUSG_1553
                                                                            + ", " + TXOBJ_PLUSG_2640_IIS
                                                                            + ", " + TXOBJ_PLUSG_2641_IIS + ") "
                                                      + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1) "
                                                     + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                     + " AND (nptxobdc.t_DocID = nptxop.t_ID "
                                                       + " OR nptxobdc.t_DocID IN (SELECT "
                                                                                   + " nptxop2oplnk.t_DocID "
                                                                               + " FROM "
                                                                                   + " dnptxop2oplnk_tmp nptxop2oplnk "
                                                                               + " WHERE "
                                                                                   + " nptxop2oplnk.t_Parent_DocID = nptxop.t_ID))), 0) AS t_TotalPlus "
                                               + " ,NVL((SELECT "
                                                        + " SUM(t_Sum) "
                                                       + " FROM "
                                                          + " dnptxobj_dbt nptxobj "
                                                         + " ,dnptxobdc_dbt nptxobdc "
                                                       + " WHERE "
                                                           + " (nptxop.t_DocKind <> " + DL_HOLDNDFL + " "
                                                         + " OR nptxop.t_SubKind_Operation <> " + DL_TXHOLD_OPTYPE_LUCRE + ") "
                                                       + " AND (nptxobj.t_Kind IN (" + TXOBJ_MINUSG_201
                                                                              + ", " + TXOBJ_MINUSG_202
                                                                              + ", " + TXOBJ_MINUSG_203
                                                                              + ", " + TXOBJ_MINUSG_206
                                                                              + ", " + TXOBJ_MINUSG_207
                                                                              + ", " + TXOBJ_MINUSG_205
                                                                              + ", " + TXOBJ_MINUSG_208
                                                                              + ", " + TXOBJ_MINUSG_209
                                                                              + ", " + TXOBJ_MINUSG_210
                                                                              + ", " + TXOBJ_MINUSG_211
                                                                              + ", " + TXOBJ_MINUSG_222
                                                                              + ", " + TXOBJ_MINUSG_213
                                                                              + ", " + TXOBJ_MINUSG_214
                                                                              + ", " + TXOBJ_MINUSG_220
                                                                              + ", " + TXOBJ_MINUSG_223
                                                                              + ", " + TXOBJ_MINUSG_224
                                                                              + ", " + TXOBJ_MINUSG_218
                                                                              + ", " + TXOBJ_MINUSG_219
                                                                              + ", " + TXOBJ_MINUSG_218_1
                                                                              + ", " + TXOBJ_MINUSG_219_1
                                                                              + ", " + TXOBJ_MINUSG_618
                                                                              + ", " + TXOBJ_MINUSG_601 + ") "
                                                         + " OR nptxobj.t_Kind IN (" + TXOBJ_MINUSG_225
                                                                              + ", " + TXOBJ_MINUSG_226
                                                                              + ", " + TXOBJ_MINUSG_227
                                                                              + ", " + TXOBJ_MINUSG_228
                                                                              + ", " + TXOBJ_MINUSG_229
                                                                              + ", " + TXOBJ_MINUSG_250
                                                                              + ", " + TXOBJ_MINUSG_251
                                                                              + ", " + TXOBJ_MINUSG_252
                                                                              + ", " + TXOBJ_MINUSG_241
                                                                              + ", " + TXOBJ_MINUSG_230
                                                                              + ", " + TXOBJ_MINUSG_239
                                                                              + ", " + TXOBJ_MINUSG_231
                                                                              + ", " + TXOBJ_MINUSG_214_IIS
                                                                              + ", " + TXOBJ_MINUSG_235
                                                                              + ", " + TXOBJ_MINUSG_240
                                                                              + ", " + TXOBJ_MINUSG_236
                                                                              + ", " + TXOBJ_MINUSG_233
                                                                              + ", " + TXOBJ_MINUSG_234
                                                                              + ", " + TXOBJ_MINUSG_619 + ") "
                                                        + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1) "
                                                       + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                       + " AND (nptxobdc.t_DocID = nptxop.t_ID "
                                                         + " OR nptxobdc.t_DocID IN (SELECT "
                                                                                     + " nptxop2oplnk.t_DocID "
                                                                                 + " FROM "
                                                                                     + " dnptxop2oplnk_tmp nptxop2oplnk "
                                                                                 + " WHERE "
                                                                                     + " nptxop2oplnk.t_Parent_DocID = nptxop.t_ID))), 0) AS t_TotalMinus "
                                               + " ,("
                                               + "     select nvl(sum(nptxobj.t_Sum0), 0) "
                                               + "     from dnptxobj_dbt nptxobj, dnptxobdc_dbt nptxobdc "
                                               + "     where nptxobj.t_Kind in (" + TXOBJ_PAIDGENERAL_15
                                                                           + ", " + TXOBJ_PAIDGENERAL_15_1
                                                                           + ", " + TXOBJ_PAIDGENERAL_15_2
                                                                           + ", " + TXOBJ_PAIDGENERAL_15_9
                                                                           + " ) "
                                               + "       and nptxobj.t_Sum0 < 0 "
                                               + "       and nptxobdc.t_ObjID = nptxobj.t_ObjID "
                                               + "       and nptxobdc.t_DocID = nptxop.t_ID "
                                               + "  ) AS t_TaxToReturnDue "
                                               + " ,CASE "
                                               + "      WHEN nptxop.t_Tax < 0 "
                                                    + " THEN "
                                                        + " rsi_rsbcalendar.GetDateAfterWorkDay(CASE "
                                                                                               + " WHEN TO_CHAR(ADD_MONTHS(nptxop.t_OperDate, 1), 'DD.MM.YYYY') = '00.00.0000' "
                                                                                               + " THEN "
                                                                                                   + " TO_DATE('31.12.9999', 'DD.MM.YYYY') "
                                                                                               + " ELSE "
                                                                                                   + " ADD_MONTHS(nptxop.t_OperDate, 1) "
                                                                                           + " END, 0) "
                                                    + " ELSE "  
                                                        + " to_date('01.01.0001', 'dd.mm.yyyy') "
                                               + " END AS t_DateTaxReturn "
                                               + " ,nptxop.t_ID "
                                               + " ,chr(88) as t_IsHighRate"
                                            + " FROM "
                                                + " dnptxop_dbt nptxop "
                                               + " ,ddppmobj_dbt dppmobj "
                                            + " WHERE "
                                                + " (nptxop.t_DocKind = " + DL_HOLDNDFL + " "
                                             + " AND nptxop.t_SubKind_Operation IN (" + DL_TXHOLD_OPTYPE_ENDYEAR
                                                                               + ", " + DL_TXHOLD_OPTYPE_OUTMONEY
                                                                               + ", " + DL_TXHOLD_OPTYPE_OUTAVOIR
                                                                               + ", " + DL_TXHOLD_OPTYPE_LUCRE
                                                                               + ", " + DL_TXHOLD_OPTYPE_CLOSE + ") "
                                             + " AND nptxop.t_OperDate between ( CASE "
                                                                                + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                                + " THEN " + GetSQLDate(m_BeginDate)
                                                                                + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                             + " END ) AND " + GetSQLDate(m_EndDate) 
                                              + " OR nptxop.t_DocKind = " + DL_WRTMONEY + " "
                                             + " AND nptxop.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
                                             + " AND nptxop.t_FlagTax = " + GetSQLChar(SET_CHAR) + " "
                                             + " AND nptxop.t_OperDate between ( CASE "
                                                                                + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                                + " THEN " + GetSQLDate(m_BeginDate)
                                                                                + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                             + " END ) AND " + GetSQLDate(m_EndDate) 
                                            + ") "          
                                            + " AND EXISTS (SELECT "
                                                            + " 1 "
                                                        + " FROM "
                                                            + " dnptxobj_dbt nptxobj "
                                                           + " ,dnptxobdc_dbt nptxobdc "
                                                        + " WHERE "
                                                            + " nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                                        + " AND nptxobdc.t_DocID = nptxop.t_ID) "
                                            + " AND dppmobj.t_ObjKind(+) = nptxop.t_DocKind "
                                            + " AND dppmobj.t_ObjID(+) = nptxop.t_ID "
                                            + " AND (1 = " + IIF(m_ByCB == SET_CHAR, 1, 0) + " "
                                             + " AND dppmobj.t_ID IS NULL "
                                              + " OR 1 = " + IIF(m_ByDEPO == SET_CHAR, 1, 0) + " "
                                             + " AND NOT dppmobj.t_ID IS NULL) "
                                               + ") q "
                             + "            ) "
                             + " UNION ALL "
                             + " SELECT "
                                 + " 1 AS t_Module "
                                + " ," + GetSQLString(TypeOperREPOPayments) + " AS t_TypeOper "
                                + " ,q.t_ClientID "
                                + " ,q.t_DatePlusFact "
                                + " ,q.t_DatePaid "
                                + " ,q.t_DateTransfer "
                                + " ,q.t_BaseDate "
                                + " ,q.t_TaxPaidDate "
                                + " ,q.t_DateOper "
                                + " ,q.t_DocKind "
                                + " ,q.t_DocID "
                                + " ,q.t_NumOper "
                                + " ,q.t_Rate "
                                + " ,CASE "
                                    + " WHEN q.t_IsHighRate <> chr(88) and rsi_nptx.ResidenceStatus(q.t_ClientID, " + GetSQLDate(m_EndDate) + ") = 1 and q.t_TotalPlus - q.t_TotalMinus <= " + Max15
                                    + " THEN q.t_TotalPlus "
                                    + " WHEN q.t_IsHighRate <> chr(88) and rsi_nptx.ResidenceStatus(q.t_ClientID, " + GetSQLDate(m_EndDate) + ") = 1 and q.t_TotalPlus - q.t_TotalMinus > " + Max15
                                    + " THEN " + Max15
                                    + " WHEN rsi_nptx.ResidenceStatus(q.t_ClientID, " + GetSQLDate(m_EndDate) + ") = 0 "
                                    + " THEN q.t_TotalPlus "
                                    + " WHEN q.t_IsHighRate <> chr(88) "
                                    + " THEN q.t_TotalPlus - q.t_TotalMinus - " + Max15
                                 + " END as t_TotalPlus "
                                + " ,q.t_TotalMinus "
                                + " ,q.t_TaxCalculated "
                                + " ,q.t_TaxToReturnDue "
                                + " ,q.t_DateTaxReturn "
                                + " ,q.t_IsHighRate "
                             + " FROM "
                             + "     ( "
                                    + " SELECT "
                                       + " nptxobj.t_Client AS t_ClientID "
                                       + " ,dl_leg.t_Expiry AS t_DatePlusFact "
                                       + " ,dl_leg.t_Expiry AS t_DatePaid "
                                       + " ,dl_leg.t_Expiry AS t_DateTransfer "
                                       + " ,dl_leg.t_Cost AS t_BaseDate"
                                       + " ,CASE "
                                            + " WHEN nptxobj.t_Kind = " + TXOBJ_DIVPAY_SEC + " "
                                            + " THEN "
                                                + " nptxobj.t_Sum0 "
                                            + " ELSE "
                                                + " 0 "
                                        + " END AS t_TaxPaidDate "
                                       + " ,dl_leg.t_Expiry AS t_DateOper "
                                       + " ,dl_tick.t_BofficeKind AS t_DocKind "
                                       + " ,dl_tick.t_DealID AS t_DocID "
                                       + " ,dl_tick.t_DealCode AS t_NumOper "
                                       + " ,CASE "
                                            + " WHEN rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                            + " THEN "
                                                + " TO_CHAR(" + 13 + ") "
                                            + " ELSE "
                                                + " CASE "
                                                    + " WHEN EXISTS (SELECT "
                                                                     + " 1 "
                                                                 + " FROM "
                                                                     + " dnotetext_dbt notetext "
                                                                 + " WHERE "
                                                                     + " notetext.t_ObjectType = " + OBJTYPE_PARTY + " "
                                                                 + " AND notetext.t_DocumentID = LPAD(nptxobj.t_Client, 10, '0') "
                                                                 + " AND notetext.t_NoteKind = " + 57 + " "
                                                                 + " AND dl_leg.t_Expiry BETWEEN notetext.t_Date AND notetext.t_ValidToDate) "
                                                    + " THEN "
                                                        + " TO_CHAR(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + OBJTYPE_PARTY + ", LPAD(nptxobj.t_Client, 10, '0'), " + 57 + ", dl_leg.t_Expiry))) "
                                                    + " ELSE "
                                                        + " TO_CHAR(" + 15 + ") "
                                                + " END "
                                        + " END AS t_Rate "
                                       + " ,CASE "
                                            + " WHEN ( "
                                                    + " nptxobj.t_Kind = " + TXOBJ_PLUSG_1010
                                                + " and rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                                 + " ) "
                                                 + " or ( "
                                                       + " nptxobj.t_Kind = " + TXOBJ_PLUS15_1010
                                                   + " and rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 0 "
                                                    + " ) "
                                            + " THEN "
                                                + " nptxobj.t_Sum0 "
                                            + " ELSE "
                                                + " 0 "
                                        + " END AS t_TotalPlus "
                                       + " ,CASE "
                                            + " WHEN ( "
                                                    + " nptxobj.t_Kind = " + TXOBJ_MINUSG_601
                                                + " and rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                                 + " ) "
                                                 + " or ( "
                                                       + " nptxobj.t_Kind = " + TXOBJ_MINUS15_601
                                                   + " and rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 0 "
                                                    + " ) "
                                            + " THEN "
                                                + " nptxobj.t_Sum0 "
                                            + " ELSE "
                                                + " 0 "
                                        + " END AS t_TotalMinus "
                                       + " ,CASE "
                                            + " WHEN nptxobj.t_Kind = " + TXOBJ_DIVPAY_SEC + " "
                                            + " THEN "
                                                + " nptxobj.t_Sum0 "
                                            + " ELSE "
                                                + " 0 "
                                        + " END AS t_TaxCalculated "
                                       + " ,0 AS t_TaxToReturnDue "
                                       + " ,to_date('01.01.0001', 'dd.mm.yyyy') AS t_DateTaxReturn "
                                       + " ,chr(0) as t_IsHighRate "
                                       + " ,dl_tick.t_DealID "
                                    + " FROM "
                                        + " dnptxobj_dbt nptxobj "
                                       + " ,dnptxobdc_dbt nptxobdc "
                                       + " ,doproper_dbt oproper "
                                       + " ,doprstep_dbt oprstep "
                                       + " ,ddl_tick_dbt dl_tick "
                                       + " ,ddl_leg_dbt dl_leg "
                                    + " WHERE "
                                        + " 1 = " + IIF(m_ByCB == SET_CHAR, 1, 0) + " "
                                    + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                    + " AND nptxobdc.t_DocID = oproper.t_ID_Operation "
                                    + " AND nptxobdc.t_Step = oprstep.t_ID_Step "
                                    + " AND oproper.t_DocKind = dl_tick.t_BofficeKind "
                                    + " AND oproper.t_DocumentID = LPAD(dl_tick.t_DealID, 34, '0') "
                                    + " AND oprstep.t_ID_Operation = oproper.t_ID_Operation "
                                    + " AND dl_tick.t_BofficeKind = " + DL_RETURN_DIVIDEND + " "
                                    + " AND rsb_secur.IsDividendReturnRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind))) = 1 "
                                    + " AND dl_leg.t_DealID = dl_tick.t_DealID "
                                    + " AND dl_leg.t_LegKind = 0 "
                                    + " AND dl_leg.t_LegID = 0 "
                                    + " AND dl_leg.t_Expiry between ( CASE "
                                                                     + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                     + " THEN " + GetSQLDate(m_BeginDate)
                                                                     + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                  + " END ) AND " + GetSQLDate(m_EndDate)
                                    + " union all "
                                    + " SELECT "
                                       + " nptxobj.t_Client as t_ClientID "
                                      + " ,dl_leg.t_Expiry as t_DatePlusFact "
                                      + " ,dl_leg.t_Expiry as t_DatePaid "
                                      + " ,dl_leg.t_Expiry as t_DateTransfer "
                                      + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_BASESPECIAL_DIV_15
                                           + " THEN nptxobj.t_Sum0 "
                                           + " ELSE 0 "
                                       + " END AS t_BaseDate "
                                      + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_15_1
                                           + " THEN nptxobj.t_Sum0 "
                                           + " ELSE 0 "
                                       + " END AS t_TaxPaidDate "
                                      + " ,dl_leg.t_Expiry AS t_DateOper "
                                      + " ,dl_tick.t_BofficeKind AS t_DocKind "
                                      + " ,dl_tick.t_DealID AS t_DocID "
                                      + " ,dl_tick.t_DealCode AS t_NumOper "
                                      + " ,'15' as t_Rate "
                                      + " ,CASE "
                                         + " WHEN nptxobj.t_Kind = " + TXOBJ_PLUSG_1010
                                         + " THEN nptxobj.t_Sum0 "
                                       + " END AS t_TotalPlus "
                                      + " ,0 AS t_TotalMinus "
                                      + " ,CASE "
                                         + " WHEN nptxobj.t_Kind = " + TXOBJ_BASESPECIAL_DIV_15
                                         + " THEN nptxobj.t_Sum0 * 0.15 "
                                         + " ELSE 0 "
                                       + " END AS t_TaxCalculated "
                                      + " ,0 AS t_TaxToReturnDue "
                                      + " ,to_date('01.01.0001', 'dd.mm.yyyy') as t_DateTaxReturn "
                                      + " ,chr(88) as t_IsHighRate "
                                      + " ,dl_tick.t_DealID "
                                    + " FROM "
                                        + " dnptxobj_dbt nptxobj "
                                       + " ,dnptxobdc_dbt nptxobdc "
                                       + " ,doproper_dbt oproper "
                                       + " ,doprstep_dbt oprstep "
                                       + " ,ddl_tick_dbt dl_tick "
                                       + " ,ddl_leg_dbt dl_leg "
                                    + " WHERE "
                                        + " 1 = " + IIF(m_ByCB == SET_CHAR, 1, 0) + " "
                                    + " AND rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                    + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                    + " AND nptxobdc.t_DocID = oproper.t_ID_Operation "
                                    + " AND nptxobdc.t_Step = oprstep.t_ID_Step "
                                    + " AND oproper.t_DocKind = dl_tick.t_BofficeKind "
                                    + " AND oproper.t_DocumentID = LPAD(dl_tick.t_DealID, 34, '0') "
                                    + " AND oprstep.t_ID_Operation = oproper.t_ID_Operation "
                                    + " AND dl_tick.t_BofficeKind = " + DL_RETURN_DIVIDEND + " "
                                    + " AND rsb_secur.IsDividendReturnRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BofficeKind))) = 1 "
                                    + " AND dl_leg.t_DealID = dl_tick.t_DealID "
                                    + " AND dl_leg.t_LegKind = 0 "
                                    + " AND dl_leg.t_LegID = 0 "
                                    + " AND dl_leg.t_Expiry between ( CASE "
                                                                     + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                     + " THEN " + GetSQLDate(m_BeginDate)
                                                                     + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                  + " END ) AND " + GetSQLDate(m_EndDate)
                                 + " ) q "
                             + " UNION ALL "
                             + " SELECT "
                                 + " 1 AS t_Module "
                                 + " ," + GetSQLString(TypeOperCouponPayment) + " AS t_TypeOper "
                                 + " ,q.t_ClientID "
                                 + " ,q.t_DatePlusFact "
                                 + " ,q.t_DatePaid "
                                 + " ,q.t_DateTransfer "
                                 + " ,q.t_BaseDate "
                                 + " ,q.t_TaxPaidDate AS t_TaxPaidDate "
                                 + " ,q.t_DateOper "
                                 + " ,q.t_DocKind "
                                 + " ,q.t_DocID "
                                 + " ,q.t_NumOper "
                                 + " ,q.t_Rate "
                                 + " ,q.t_TotalPlus "
                                 + " ,q.t_TotalMinus "
                                 + " ,q.t_TaxCalculated "
                                 + " ,q.t_TaxToReturnDue "
                                 + " ,q.t_DateTaxReturn "
                                 + " ,q.t_IsHighRate "
                             + " FROM ( "
                                     + " SELECT "
                                         + " nptxobj.t_Client AS t_ClientID "
                                         + " ,dl_leg.t_Expiry AS t_DatePlusFact "
                                         + " ,dl_leg.t_Expiry AS t_DatePaid "
                                         + " ,dl_leg.t_Expiry AS t_DateTransfer "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_PLUSG_1011 + " "
                                               + " OR nptxobj.t_Kind = " + TXOBJ_PLUSG_1011_IIS + " "
                                              + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                             + " THEN "
                                                 + " nptxobj.t_Sum0 "
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_BaseDate "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL + " "
                                               + " OR nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_IIS + " "
                                              + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                             + " THEN "
                                                 + " nptxobj.t_Sum0 "
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_TaxPaidDate "
                                        + " ,dl_leg.t_Expiry AS t_DateOper "
                                        + " ,dl_tick.t_BofficeKind AS t_DocKind "
                                        + " ,dl_tick.t_DealID AS t_DocID "
                                        + " ,dl_tick.t_DealCode AS t_NumOper "
                                        + " ,CASE "
                                             + " WHEN rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                             + " THEN "
                                                 + " TO_CHAR(" + 13 + ") "
                                             + " ELSE "
                                                 + " CASE "
                                                     + " WHEN EXISTS (SELECT "
                                                                      + " 1 "
                                                                  + " FROM "
                                                                      + " dnotetext_dbt notetext "
                                                                  + " WHERE "
                                                                      + " notetext.t_ObjectType = " + OBJTYPE_PARTY + " "
                                                                  + " AND notetext.t_DocumentID = LPAD(nptxobj.t_Client, 10, '0') "
                                                                  + " AND notetext.t_NoteKind = " + 77 + " "
                                                                  + " AND " + GetSQLDate(m_EndDate) + " BETWEEN notetext.t_Date AND notetext.t_ValidToDate) "
                                                     + " THEN "
                                                         + " TO_CHAR(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + OBJTYPE_PARTY + ", LPAD(nptxobj.t_Client, 10, '0'), " + 77 + ", " + GetSQLDate(m_EndDate) + "))) "
                                                     + " ELSE "
                                                         + " TO_CHAR(" + 30 + ") "
                                                 + " END "
                                         + " END AS t_Rate "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_PLUSG_1011 + " "
                                               + " OR nptxobj.t_Kind = " + TXOBJ_PLUSG_1011_IIS + " "
                                              + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                             + " THEN "
                                                 + " nptxobj.t_Sum0 "
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_TotalPlus "
                                       + " ,0 AS t_TotalMinus "
                                       + " ,dl_tick.t_DealID "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL + " "
                                               + " OR nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_IIS + " "
                                              + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                             + " THEN "
                                                 + " nptxobj.t_Sum0 "
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_TaxCalculated "
                                        + " ,0 AS t_TaxToReturnDue "
                                        + " ,to_date('01.01.0001', 'dd.mm.yyyy') AS t_DateTaxReturn "
                                        + " ,chr(0) as t_IsHighRate "
                                     + " FROM "
                                         + " dnptxobj_dbt nptxobj "
                                        + " ,dnptxobdc_dbt nptxobdc "
                                        + " ,doproper_dbt oproper "
                                        + " ,doprstep_dbt oprstep "
                                        + " ,ddl_tick_dbt dl_tick "
                                        + " ,ddl_leg_dbt dl_leg "
                                     + " WHERE "
                                         + " nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                     + " AND nptxobdc.t_DocID = oproper.t_ID_Operation "
                                     + " AND nptxobdc.t_Step = oprstep.t_ID_Step "
                                     + " AND oproper.t_DocKind = dl_tick.t_BofficeKind "
                                     + " AND oproper.t_DocumentID = LPAD(dl_tick.t_DealID, 34, '0') "
                                     + " AND oprstep.t_ID_Operation = oproper.t_ID_Operation "
                                     + " AND dl_tick.t_BofficeKind = " + DL_RETIREMENT_OWN + " "
                                     + " AND dl_tick.t_DealID = dl_leg.t_DealID "
                                     + " AND dl_leg.t_LegKind = 0 "
                                     + " AND dl_leg.t_LegID = 0 "
                                     + " AND dl_leg.t_Expiry between ( CASE "
                                                                      + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                      + " THEN " + GetSQLDate(m_BeginDate)
                                                                      + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                   + " END ) AND " + GetSQLDate(m_EndDate)
                                     + " union all "
                                     + " SELECT "
                                         + " nptxobj.t_Client AS t_ClientID "
                                         + " ,dl_leg.t_Expiry AS t_DatePlusFact "
                                         + " ,dl_leg.t_Expiry AS t_DatePaid "
                                         + " ,dl_leg.t_Expiry AS t_DateTransfer "
                                        + " ,scowntax.t_TaxBaseSum15 as t_BaseDate "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind in (" + TXOBJ_PAIDGENERAL_15 + ", " + TXOBJ_PAIDGENERAL_15_IIS + ") "
                                           + " THEN nptxobj.t_Sum0 "
                                           + " ELSE 0 "
                                         + " END as t_TaxPaidDate "
                                         + " ,dl_leg.t_Expiry AS t_DateOper "
                                         + " ,dl_tick.t_BOfficeKind AS t_DocKind "
                                         + " ,dl_tick.t_DealID AS t_DocID "
                                         + " ,dl_tick.t_DealCode AS t_NumOper "
                                        + " ,'15' as t_Rate "
                                        + " ,scowntax.t_TaxBaseSum15 as t_TotalPlus "
                                        + " ,0 as t_TotalMinus "
                                        + " ,dl_tick.t_DealID "
                                        + " ,scowntax.t_TaxBaseSum15 * 0.15 as t_TaxCalculated "
                                        + " ,0 as t_TaxToReturnDue "
                                        + " ,to_date('01.01.0001', 'dd.mm.yyyy') as t_DateTaxReturn "
                                        + " ,chr(88) as t_IsHighRate "
                                     + " FROM "
                                         + " dnptxobj_dbt nptxobj "
                                        + " ,dnptxobdc_dbt nptxobdc "
                                        + " ,doproper_dbt oproper "
                                        + " ,doprstep_dbt oprstep "
                                        + " ,ddl_tick_dbt dl_tick "
                                        + " ,ddl_leg_dbt dl_leg "
                                        + " ,dscowntax_dbt scowntax "
                                        + " ,dscownlist_dbt ls "
                                        + " ,dscownhist_dbt sh "
                                     + " WHERE "
                                         + " nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                     + " AND nptxobdc.t_DocID = oproper.t_ID_Operation "
                                     + " AND nptxobdc.t_Step = oprstep.t_ID_Step "
                                     + " AND oproper.t_DocKind = dl_tick.t_BOfficeKind "
                                     + " AND oproper.t_DocumentID = LPAD(dl_tick.t_DealID, 34, '0') "
                                     + " AND oprstep.t_ID_Operation = oproper.t_ID_Operation "
                                     + " AND dl_tick.t_DealID = dl_leg.t_DealID "
                                     + " AND rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                     + " AND ls.t_FIID = dl_tick.t_PFI "
                                     + " AND ls.t_Number_Coupon = dl_tick.t_Number_Coupon "
                                     + " AND sh.t_ListID = ls.t_ListID "
                                     + " AND scowntax.t_SHID = sh.t_ID "
                                     + " AND scowntax.t_TaxSum15 > 0 "
                                     + " AND dl_tick.t_BofficeKind = " + DL_RETIREMENT_OWN + " "
                                     + " AND dl_tick.t_DealID = dl_leg.t_DealID "
                                     + " AND dl_leg.t_LegKind = 0 "
                                     + " AND dl_leg.t_LegID = 0 "
                                     + " AND dl_leg.t_Expiry between ( CASE "
                                                                      + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                      + " THEN " + GetSQLDate(m_BeginDate)
                                                                      + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                   + " END ) AND " + GetSQLDate(m_EndDate)
                                  + " ) q "
                             + " WHERE "
                                + " 1 = " + IIF(m_ByCB == SET_CHAR, 1, 0)
                             + " UNION ALL "
                             + " SELECT "
                                 + " t_Module "
                                + " ,t_TypeOper "
                                + " ,t_ClientID "
                                + " ,t_DatePlusFact "
                                + " ,t_DatePaid "
                                + " ,t_DateTransfer "
                                + " ,CASE "
                                     + " WHEN t_Kind IN (" + TXOBJ_PLUS9_1110
                                                    + ", " + TXOBJ_PLUSG_1110
                                                    + ", " + TXOBJ_PLUSG_1011 + ") "
                                       + " OR t_Kind IN (" + TXOBJ_PLUS9_1110_IIS
                                                    + ", " + TXOBJ_PLUSG_1011_IIS + ") "
                                      + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1 "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_BaseDate "
                                + " ,CASE "
                                     + " WHEN t_Kind IN (" + TXOBJ_PAIDSPECIAL
                                                    + ", " + TXOBJ_PAIDGENERAL + ") "
                                       + " OR t_Kind IN (" + TXOBJ_PAIDSPECIAL_IIS
                                                    + ", " + TXOBJ_PAIDGENERAL_IIS + ") "
                                      + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1 "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_TaxPaidDate "
                                + " ,t_DateOper "
                                + " ,t_DocKind "
                                + " ,t_DocID "
                                + " ,t_NumOper "
                                + " ,CASE "
                                     + " WHEN rsi_nptx.ResidenceStatus(t_ClientID, " + GetSQLDate(m_EndDate) + ") = 1 "
                                     + " THEN "
                                         + " CASE "
                                             + " WHEN t_PaidSpecialSum <> 0 "
                                              + " AND t_PaidGeneralSum = 0 "
                                             + " THEN "
                                                 + " TO_CHAR(" + 9 + ") "
                                             + " WHEN t_PaidSpecialSum = 0 "
                                              + " AND t_PaidGeneralSum <> 0 "
                                             + " THEN "
                                                 + " TO_CHAR(" + 13 + ") "
                                             + " ELSE "
                                                 + " TO_CHAR(" + 9 + ") || '/' || TO_CHAR(" + 13 + ") "
                                         + " END "
                                     + " ELSE "
                                         + " CASE "
                                             + " WHEN EXISTS (SELECT "
                                                              + " 1 "
                                                          + " FROM "
                                                              + " dnotetext_dbt notetext "
                                                          + " WHERE "
                                                              + " notetext.t_ObjectType = " + OBJTYPE_PARTY + " "
                                                          + " AND notetext.t_DocumentID = LPAD(t_ClientID, 10, '0') "
                                                          + " AND notetext.t_NoteKind = " + 77 + " "
                                                          + " AND " + GetSQLDate(m_EndDate) + " BETWEEN notetext.t_Date AND notetext.t_ValidToDate) "
                                             + " THEN "
                                                 + " TO_CHAR(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + OBJTYPE_PARTY + ", LPAD(t_ClientID, 10, '0'), " + 77 + ", " + GetSQLDate(m_EndDate) + "))) "
                                             + " ELSE "
                                                 + " CASE "
                                                     + " WHEN t_PaidSpecialSum <> 0 "
                                                      + " AND t_PaidGeneralSum = 0 "
                                                     + " THEN "
                                                         + " TO_CHAR(" + 15 + ") "
                                                     + " WHEN t_PaidSpecialSum = 0 "
                                                      + " AND t_PaidGeneralSum <> 0 "
                                                     + " THEN "
                                                         + " TO_CHAR(" + 30 + ") "
                                                     + " ELSE "
                                                         + " TO_CHAR(" + 15 + ") || '/' || TO_CHAR(" + 30 + ") "
                                                 + " END "
                                         + " END "
                                 + " END AS t_Rate "
                                + " ,CASE "
                                     + " WHEN t_Kind IN (" + TXOBJ_PLUS9_1110
                                                    + ", " + TXOBJ_PLUSG_1110
                                                    + ", " + TXOBJ_PLUSG_1011 + ") "
                                       + " OR t_Kind IN (" + TXOBJ_PLUS9_1110_IIS
                                                    + ", " + TXOBJ_PLUSG_1011_IIS + ") "
                                      + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1 "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_TotalPlus "
                                + " ,0 AS t_TotalMinus "
                                + " ,CASE "
                                     + " WHEN t_Kind IN (" + TXOBJ_PAIDSPECIAL
                                                    + ", " + TXOBJ_PAIDGENERAL + ") "
                                       + " OR t_Kind IN (" + TXOBJ_PAIDSPECIAL_IIS
                                                    + ", " + TXOBJ_PAIDGENERAL_IIS + ") "
                                      + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1 "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_TaxCalculated "
                                + " ,0 AS t_TaxToReturnDue "
                                + " ,to_date('01.01.0001', 'dd.mm.yyyy') AS t_DateTaxReturn "
                                + " ,chr(0) AS t_IsHighRate "
                             + " FROM "
                                 + " (SELECT "
                                      + " 1 AS t_Module "
                                     + " ," + GetSQLString(TypeOperREPOPayments) + " AS t_TypeOper "
                                     + " ,nptxobj.t_Client AS t_ClientID "
                                     + " ,oprstep.t_Fact_Date AS t_DatePlusFact "
                                     + " ,oprstep.t_Fact_Date AS t_DatePaid "
                                     + " ,oprstep.t_Fact_Date AS t_DateTransfer "
                                     + " ,nptxobj.t_Kind "
                                     + " ,nptxobj.t_Analitic6 "
                                     + " ,nptxobj.t_Sum "
                                     + " ,SUM(CASE "
                                              + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDSPECIAL + " "
                                                + " OR nptxobj.t_Kind = " + TXOBJ_PAIDSPECIAL_IIS + " "
                                               + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                              + " THEN "
                                                  + " nptxobj.t_Sum "
                                              + " ELSE "
                                                  + " 0 "
                                          + " END) OVER (PARTITION BY dl_tick.t_BofficeKind, dl_tick.t_DealID, nptxobj.t_Client) AS t_PaidSpecialSum "
                                     + " ,SUM(CASE "
                                              + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL + " "
                                                + " OR nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_IIS + " "
                                               + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                              + " THEN "
                                                  + " nptxobj.t_Sum "
                                              + " ELSE "
                                                  + " 0 "
                                          + " END) OVER (PARTITION BY dl_tick.t_BofficeKind, dl_tick.t_DealID, nptxobj.t_Client) AS t_PaidGeneralSum "
                                     + " ,oprstep.t_Fact_Date AS t_DateOper "
                                     + " ,dl_tick.t_BofficeKind AS t_DocKind "
                                     + " ,dl_tick.t_DealID AS t_DocID "
                                     + " ,dl_tick.t_DealCode AS t_NumOper "
                                  + " FROM "
                                      + " dnptxobj_dbt nptxobj "
                                     + " ,dnptxobdc_dbt nptxobdc "
                                     + " ,doproper_dbt oproper "
                                     + " ,doprstep_dbt oprstep "
                                     + " ,ddl_tick_dbt dl_tick "
                                  + " WHERE "
                                      + " 1 = " + IIF(m_ByCB == SET_CHAR, 1, 0) + " "
                                  + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                  + " AND nptxobdc.t_DocID = oproper.t_ID_Operation "
                                  + " AND nptxobdc.t_Step = oprstep.t_ID_Step "
                                  + " AND oproper.t_DocKind = dl_tick.t_BofficeKind "
                                  + " AND oproper.t_DocumentID = LPAD(dl_tick.t_DealID, 34, '0') "
                                  + " AND oprstep.t_ID_Operation = oproper.t_ID_Operation "
                                  + " AND oprstep.t_Symbol = " + GetSQLChar("ф") + " "
                                  + " AND oprstep.t_Fact_Date between ( CASE "
                                                                       + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                       + " THEN " + GetSQLDate(m_BeginDate)
                                                                       + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                    + " END ) AND " + GetSQLDate(m_EndDate) 
                                  + " AND dl_tick.t_BofficeKind = " + DL_SECURITYDOC
                                  + ") "
                             + " UNION ALL "
                             + " SELECT "
                                 + " t_Module "
                                + " ,t_TypeOper "
                                + " ,t_ClientID "
                                + " ,t_DatePlusFact "
                                + " ,t_DatePaid "
                                + " ,t_DateTransfer "
                                + " ,CASE "
                                   + " WHEN t_TypeOper = " + GetSQLString(TypeOperDividendPayment) + " "
                                    + " AND t_Kind in (" + TXOBJ_PLUSG_1010 + ", " + TXOBJ_PLUS15_1010 + ") "
                                     + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment) + " "
                                    + " AND (t_Kind IN (" + TXOBJ_PLUS9_1110
                                                   + ", " + TXOBJ_PLUSG_1110
                                                   + ", " + TXOBJ_PLUSG_1011 + ") "
                                      + " OR t_Kind IN (" + TXOBJ_PLUS9_1110_IIS
                                                   + ", " + TXOBJ_PLUSG_1011_IIS + ") "
                                     + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1) "
                                     + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment2018) + " "
                                    + " AND t_Kind IN (" + TXOBJ_COUP0_GROUP
                                                  + ", " + TXOBJ_PLUS35_3023 + ") "
                                   + " THEN "
                                       + " t_Sum "
                                   + " ELSE "
                                       + " 0 "
                                 + " END AS t_BaseDate "
                                + " ,CASE "
                                     + " WHEN t_TypeOper = " + GetSQLString(TypeOperDividendPayment) + " "
                                      + " AND t_Kind = " + TXOBJ_DIVPAY_SEC + " "
                                       + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment) + " "
                                      + " AND (t_Kind IN (" + TXOBJ_PAIDSPECIAL
                                                     + ", " + TXOBJ_PAIDGENERAL + ") "
                                        + " OR t_Kind IN (" + TXOBJ_PAIDSPECIAL_IIS
                                                     + ", " + TXOBJ_PAIDGENERAL_IIS + ") "
                                       + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1) "
                                       + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment2018) + " "
                                      + " AND t_Kind IN (" + TXOBJ_PAID_35
                                                    + ", " + TXOBJ_PAIDGENERAL + ") "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_TaxPaidDate "
                                + " ,t_DateOper "
                                + " ,t_DocKind "
                                + " ,t_DocID "
                                + " ,t_NumOper "
                                + " ,CASE "
                                     + " WHEN t_TypeOper = " + GetSQLString(TypeOperDividendPayment) + " AND t_IsDepoClient = 0"
                                     + " THEN "
                                         + " CASE "
                                             + " WHEN rsi_nptx.ResidenceStatus(t_ClientID, " + GetSQLDate(m_EndDate) + ") = 1 "
                                             + " THEN "
                                                 + " TO_CHAR(" + 13 + ") "
                                             + " ELSE "
                                                 + " CASE "
                                                     + " WHEN EXISTS (SELECT "
                                                                      + " 1 "
                                                                  + " FROM "
                                                                      + " dnotetext_dbt notetext "
                                                                  + " WHERE "
                                                                      + " notetext.t_ObjectType = " + OBJTYPE_PARTY + " "
                                                                  + " AND notetext.t_DocumentID = LPAD(t_ClientID, 10, '0') "
                                                                  + " AND notetext.t_NoteKind = " + 57 + " "
                                                                  + " AND t_DateOper BETWEEN notetext.t_Date AND notetext.t_ValidToDate) "
                                                     + " THEN "
                                                         + " TO_CHAR(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + OBJTYPE_PARTY + ", LPAD(t_ClientID, 10, '0'), " + 57 + ", t_DateOper))) "
                                                     + " ELSE "
                                                         + " TO_CHAR(" + 15 + ") "
                                                 + " END "
                                         + " END "
                                     + " WHEN t_TypeOper = " + GetSQLString(TypeOperCouponPayment) + " AND t_IsDepoClient = 0"
                                     + " THEN "
                                         + " CASE "
                                             + " WHEN rsi_nptx.ResidenceStatus(t_ClientID, " + GetSQLDate(m_EndDate) + ") = 1 "
                                             + " THEN "
                                                 + " CASE "
                                                     + " WHEN t_PaidSpecialSum <> 0 "
                                                      + " AND t_PaidGeneralSum = 0 "
                                                     + " THEN "
                                                         + " TO_CHAR(" + 9 + ") "
                                                     + " WHEN t_PaidSpecialSum = 0 "
                                                      + " AND t_PaidGeneralSum <> 0 "
                                                     + " THEN "
                                                         + " TO_CHAR(" + 13 + ") "
                                                     + " ELSE "
                                                         + " TO_CHAR(" + 9 + ") || '/' || TO_CHAR(" + 13 + ") "
                                                 + " END "
                                             + " ELSE "
                                                 + " CASE "
                                                     + " WHEN EXISTS (SELECT "
                                                                      + " 1 "
                                                                  + " FROM "
                                                                      + " dnotetext_dbt notetext "
                                                                  + " WHERE "
                                                                      + " notetext.t_ObjectType = " + OBJTYPE_PARTY + " "
                                                                  + " AND notetext.t_DocumentID = LPAD(t_ClientID, 10, '0') "
                                                                  + " AND notetext.t_NoteKind = " + 77 + " "
                                                                  + " AND " + GetSQLDate(m_EndDate) + " BETWEEN notetext.t_Date AND notetext.t_ValidToDate) "
                                                     + " THEN "
                                                         + " TO_CHAR(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + OBJTYPE_PARTY + ", LPAD(t_ClientID, 10, '0'), " + 77 + ", " + GetSQLDate(m_EndDate) + "))) "
                                                     + " ELSE "
                                                         + " CASE "
                                                             + " WHEN t_PaidSpecialSum <> 0 "
                                                              + " AND t_PaidGeneralSum = 0 "
                                                             + " THEN "
                                                                 + " TO_CHAR(" + 15 + ") "
                                                             + " WHEN t_PaidSpecialSum = 0 "
                                                              + " AND t_PaidGeneralSum <> 0 "
                                                             + " THEN "
                                                                 + " TO_CHAR(" + 30 + ") "
                                                             + " ELSE "
                                                                 + " TO_CHAR(" + 15 + ") || '/' || TO_CHAR(" + 30 + ") "
                                                         + " END "
                                                 + " END "
                                         + " END "
                                     + " WHEN t_TypeOper = " + GetSQLString(TypeOperCouponPayment2018) + " AND t_IsDepoClient = 0"
                                     + " THEN "
                                         + " TO_CHAR(" + 35 + ") "
                                     + " WHEN t_IsDepoClient = 1"
                                     + " THEN "
                                     + "     TO_CHAR(t_TaxRate)"
                                     + " ELSE "
                                         + " CHR(1) "
                                 + " END AS t_Rate "
                                + " ,CASE "
                                     + " WHEN t_TypeOper = " + GetSQLString(TypeOperDividendPayment) + " "
                                      + " AND t_Kind IN (" + TXOBJ_PLUSG_1010
                                                    + ", " + TXOBJ_PLUS15_1010 + ") "
                                       + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment) + " "
                                      + " AND (t_Kind IN (" + TXOBJ_PLUS9_1110
                                                     + ", " + TXOBJ_PLUSG_1110
                                                     + ", " + TXOBJ_PLUSG_1011 + ") "
                                        + " OR t_Kind IN (" + TXOBJ_PLUS9_1110_IIS
                                                     + ", " + TXOBJ_PLUSG_1011_IIS + ") "
                                       + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1) "
                                       + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment2018) + " "
                                      + " AND t_Kind IN (" + TXOBJ_COUP0_GROUP
                                                    + ", " + TXOBJ_PLUS35_3023 + ") "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_TotalPlus "
                                + " ,CASE "
                                     + " WHEN t_TypeOper = " + GetSQLString(TypeOperDividendPayment) + " "
                                      + " AND t_Kind IN (" + TXOBJ_MINUSG_601
                                                    + ", " + TXOBJ_MINUS15_601 + ") "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_TotalMinus "
                                + " ,CASE "
                                     + " WHEN t_TypeOper = " + GetSQLString(TypeOperDividendPayment) + " "
                                      + " AND t_Kind = " + TXOBJ_DIVPAY_SEC + " "
                                       + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment) + " "
                                      + " AND (t_Kind IN (" + TXOBJ_PAIDSPECIAL
                                                     + ", " + TXOBJ_PAIDGENERAL + ") "
                                        + " OR t_Kind IN (" + TXOBJ_PAIDSPECIAL_IIS
                                                     + ", " + TXOBJ_PAIDGENERAL_IIS + ") "
                                       + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", t_Analitic6) = 1) "
                                       + " OR t_TypeOper = " + GetSQLString(TypeOperCouponPayment2018) + " "
                                      + " AND t_Kind IN (" + TXOBJ_PAID_35
                                                    + ", " + TXOBJ_PAIDGENERAL + ") "
                                     + " THEN "
                                         + " t_Sum "
                                     + " ELSE "
                                         + " 0 "
                                 + " END AS t_TaxCalculated "
                                + " ,0 AS t_TaxToReturnDue "
                                + " ,to_date('01.01.0001', 'dd.mm.yyyy') AS t_DateTaxReturn "
                                + " ,chr(0) AS t_IsHighRate "
                             + " FROM "
                                 + " (SELECT "
                                      + " 2 AS t_Module "
                                     + " ,CASE "
                                          + " WHEN dpcorpop.t_PaymentType = " + DP_CRPPAYMENTTYPE_DIVIDENDS + " "
                                          + " THEN "
                                              + " " + GetSQLString(TypeOperDividendPayment) + " "
                                          + " WHEN dpcorpop.t_PaymentType = " + DP_CRPPAYMENTTYPE_COUPON + " "
                                          + " THEN "
                                              + " CASE "
                                                  + " WHEN 1 = 0 "
                                                  + " THEN "
                                                      + " " + GetSQLString(TypeOperCouponPayment2018) + " "
                                                  + " WHEN 1 = 0  "
                                                  + " THEN "
                                                      + " " + GetSQLString(TypeOperCashWithdrawal) + " "
                                                  + " ELSE "
                                                      + " " + GetSQLString(TypeOperCouponPayment) + " "
                                              + " END "
                                          + " ELSE "
                                              + " " + GetSQLString(TypeOperCashWithdrawal) + " "
                                      + " END AS t_TypeOper "
                                     + " ,nptxobj.t_Client AS t_ClientID "
                                     + " ,spground.t_RegistrDate AS t_DatePlusFact "
                                     + " ,spground.t_RegistrDate AS t_DatePaid "
                                     + " ,spground.t_RegistrDate AS t_DateTransfer "
                                     + " ,nptxobj.t_Kind "
                                     + " ,nptxobj.t_Analitic6 "
                                     + " ,nptxobj.t_Sum "
                                     + " ,SUM(CASE "
                                              + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDSPECIAL + " "
                                                + " OR nptxobj.t_Kind = " + TXOBJ_PAIDSPECIAL_IIS + " "
                                               + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                              + " THEN "
                                                  + " nptxobj.t_Sum "
                                              + " ELSE "
                                                  + " 0 "
                                          + " END) OVER (PARTITION BY dpcorpop.t_DocKind, dpcorpop.t_DocumentID, nptxobj.t_Client) AS t_PaidSpecialSum "
                                     + " ,SUM(CASE "
                                              + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL + " "
                                                + " OR nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_IIS + " "
                                               + " AND rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 1 "
                                              + " THEN "
                                                  + " nptxobj.t_Sum "
                                              + " ELSE "
                                                  + " 0 "
                                          + " END) OVER (PARTITION BY dpcorpop.t_DocKind, dpcorpop.t_DocumentID, nptxobj.t_Client) AS t_PaidGeneralSum "
                                     + " ,spground.t_RegistrDate AS t_DateOper "
                                     + " ,dpcorpop.t_DocKind AS t_DocKind "
                                     + " ,dpcorpop.t_DocumentID AS t_DocID "
                                     + " ,spground.t_Xld AS t_NumOper "
                                     + " ,("
                                          + "CASE "
                                          + "WHEN EXISTS(SELECT 1 "
                                                      + "FROM DSFCONTR_DBT sfcontr "
                                                      + "WHERE sfcontr.T_PARTYID = party.t_PartyID "
                                                      + "  AND sfcontr.T_SERVKIND = 7 "
                                                      + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_EndDate)
                                                      + "  AND ( "
                                                      + "         sfcontr.T_DATECLOSE >= " + GetSQLDate(m_EndDate)
                                                      + "      OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy') "
                                                      + "      ) "
                                                      + ") "
                                    + "       AND NOT EXISTS(SELECT 1 "
                                                          + "FROM DSFCONTR_DBT sfcontr, DDLCONTR_DBT dlcontr "
                                                          + "WHERE sfcontr.T_PARTYID = party.t_PartyID"
                                                          + "  AND dlcontr.t_SfContrID = sfcontr.t_ID "
                                                          + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_EndDate)
                                                          + "  AND ( "
                                                          + "         sfcontr.T_DATECLOSE >= " + GetSQLDate(m_EndDate)
                                                          + "      OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy')"
                                                          + "      ) "
                                                          + ") "
                                          + "THEN 1 "
                                          + "ELSE 0 "
                                          + "END "
                                    + "   ) as t_IsDepoClient"
                                    + " ,dppmacc.t_TaxRate / 100 as t_TaxRate"
                                  + " FROM "
                                      + " dnptxobj_dbt nptxobj "
                                     + " ,ddppmobj_dbt dppmobj "
                                     + " ,ddppmacc_dbt dppmacc "
                                     + " ,ddpcorpop_dbt dpcorpop "
                                     + " ,dspground_dbt spground "
                                     + " ,dparty_dbt party "
                                     + " ,ddpregstr_dbt dpregstr "
                                  + " WHERE "
                                      + " 1 = " + IIF(m_ByDepo == SET_CHAR, 1, 0) + " "
                                  + " AND nptxobj.t_ObjID = dppmobj.t_ObjID "
                                  + " AND dppmobj.t_ObjKind = " + OBJTYPE_NPTXOBJ + " "
                                  + " AND dppmobj.t_PmAccID = dppmacc.t_ID "
                                  + " AND dppmacc.t_DocumentID = dpcorpop.t_DocumentID "
                                  + " AND dpcorpop.t_DocKind = " + SP_DEPOPER_DIVIDEND + " "
                                  + " AND dpcorpop.t_Department = " + {OperDprt} + " "
                                  + " AND dpcorpop.t_TransferTax = " + GetSQLChar(SET_CHAR) + " "
                                  + " AND spground.t_SPGroundID = dpcorpop.t_SPGroundID "
                                  + " AND spground.t_RegistrDate between ( CASE "
                                                                          + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                          + " THEN " + GetSQLDate(m_BeginDate)
                                                                          + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                       + " END ) AND " + GetSQLDate(m_EndDate) 
                                  + " AND party.t_PartyID = dppmacc.t_HolderID "
                                  + " AND dpregstr.t_DocumentID = dpcorpop.t_DocumentID "
                                  + " AND (party.t_LegalForm = " + PTLEGF_INST + " "
                                   + " AND rsi_nptx.ResidenceStatus(party.t_PartyID, " + GetSQLDate(m_EndDate) + ") <> 1 "
                                   + " AND EXISTS (SELECT "
                                                   + " 1 "
                                               + " FROM "
                                                   + " dparty_dbt party "
                                               + " WHERE "
                                                   + " party.t_PartyID = dppmacc.t_BeneficiarID "
                                               + " AND party.t_LegalForm = " + PTLEGF_PERSN + ") "
                                    + " OR party.t_LegalForm = " + PTLEGF_PERSN + " "
                                   + " AND (dpcorpop.t_PaymentType = " + DP_CRPPAYMENTTYPE_DIVIDENDS + " "
                                    + " AND rsi_nptx.ResidenceStatus(dpregstr.t_Issuer, " + GetSQLDate(m_EndDate) + ") = 1 "
                                     + " OR dpcorpop.t_PaymentType = " + DP_CRPPAYMENTTYPE_COUPON + " "
                                    + " AND (rsi_nptx.ResidenceStatus(dpregstr.t_Issuer, " + GetSQLDate(m_EndDate) + ") = 1 "
                                     + " AND (rsi_npto.CheckObjIIS(" + TXOBJ_KIND6020 + ", nptxobj.t_Analitic6) = 0 "
                                         " OR 1 = " + IIF(tipiCoupInDepoForIIS == UNSET_CHAR, 0, 1) + ") "
                                      + " OR rsi_nptx.ResidenceStatus(dpregstr.t_Issuer, " + GetSQLDate(m_EndDate) + ") <> 1 "
                                     + " AND rsb_depo.IsTradeDepoAcnt(dppmacc.t_HolderAccID) = 1 "
                                     + " AND EXISTS (SELECT "
                                                     + " 1 "
                                                 + " FROM "
                                                     + " ddppmrac_dbt dppmrac "
                                                    + " ,daccount_dbt account "
                                                 + " WHERE "
                                                     + " dppmrac.t_DocumentID = dppmacc.t_DocumentID "
                                                 + " AND dppmrac.t_HolderAccID = dppmacc.t_HolderAccID "
                                                 + " AND dppmrac.t_BankIC = " + {OurBank} + " "
                                                 + " AND NOT dppmrac.t_Currency IN (" + NATCUR + ", " + ALLFININSTR + ") "
                                                 + " AND account.t_Account = dppmrac.t_Account "
                                                 + " AND account.t_Code_Currency = dppmrac.t_Currency "
                                                 + " AND account.t_Chapter = dppmrac.t_Chapter) "
                                     + " AND EXISTS (SELECT "
                                                     + " sfcontr.t_ID "
                                                 + " FROM "
                                                     + " dsfcontr_dbt sfcontr "
                                                    + " ,ddepoacnt_dbt depoacnt "
                                                 + " WHERE "
                                                     + " depoacnt.t_AutoKey = dppmacc.t_HolderAccID "
                                                 + " AND sfcontr.t_ObjectType = " + SF_DEPOACC + " "
                                                 + " AND sfcontr.t_ServKind = " + PTSK_DEPOS + " "
                                                 + " AND sfcontr.t_Object = depoacnt.t_Code "
                                                 + " AND sfcontr.t_PartyID = depoacnt.t_Owner "
                                                 + " AND NOT rsb_secur.GetMainObjAttrNoDate(" + OBJTYPE_SFCONTR + ", LPAD(sfcontr.t_ID, 10, '0'), " + OBJGROUP_SFCONTR_IIS + ") = 1)) "
                                     + " OR dpcorpop.t_PaymentType IN (" + DP_CRPPAYMENTTYPE_NOMINAL + ", " + DP_CRPPAYMENTTYPE_ISSUE + ") "
                                    + " AND (rsi_nptx.ResidenceStatus(dpregstr.t_Issuer, " + GetSQLDate(m_EndDate) + ") = 1 "
                                     + " AND EXISTS (SELECT "
                                                     + " 1 "
                                                 + " FROM "
                                                     + " ddppmrac_dbt dppmrac "
                                                    + " ,daccount_dbt account "
                                                 + " WHERE "
                                                     + " dppmrac.t_DocumentID = dppmacc.t_DocumentID "
                                                 + " AND dppmrac.t_HolderAccID = dppmacc.t_HolderAccID "
                                                 + " AND dppmrac.t_BankIC = " + {OurBank} + " "
                                                 + " AND account.t_Account = dppmrac.t_Account "
                                                 + " AND account.t_Code_Currency = dppmrac.t_Currency "
                                                 + " AND account.t_Chapter = dppmrac.t_Chapter "
                                                 + " AND NOT account.t_Balance IN (" + GetSQLString("30601") + ", " + GetSQLString("30606") + ")) "
                                      + " OR rsi_nptx.ResidenceStatus(dpregstr.t_Issuer, " + GetSQLDate(m_EndDate) + ") <> 1 "
                                     + " AND rsb_depo.IsTradeDepoAcnt(dppmacc.t_HolderAccID) = 1 "
                                     + " AND EXISTS (SELECT "
                                                     + " 1 "
                                                 + " FROM "
                                                     + " ddppmrac_dbt dppmrac "
                                                    + " ,daccount_dbt account "
                                                 + " WHERE "
                                                     + " dppmrac.t_DocumentID = dppmacc.t_DocumentID "
                                                 + " AND dppmrac.t_HolderAccID = dppmacc.t_HolderAccID "
                                                 + " AND dppmrac.t_BankIC = " + {OurBank} + " "
                                                 + " AND NOT dppmrac.t_Currency IN (" + NATCUR + ", " + ALLFININSTR + ") "
                                                 + " AND account.t_Account = dppmrac.t_Account "
                                                 + " AND account.t_Code_Currency = dppmrac.t_Currency "
                                                 + " AND account.t_Chapter = dppmrac.t_Chapter "
                                                 + " AND NOT account.t_Balance IN (" + GetSQLString("30601") + ", " + GetSQLString("30606") + ")))))"
                                  + ") "
                             + " UNION ALL "
                             + " SELECT "
                                 + " 3 AS t_Module "
                                + " ," + GetSQlString(TypeOperIncomePayment) + " AS t_TypeOper "
                                + " ,q.t_ClientID "
                                + " ,q.t_DatePlusFact "
                                + " ,q.t_DatePaid "
                                + " ,q.t_DateTransfer "
                                + " ,q.t_BaseDate "
                                + " ,q.t_TaxPaidDate "
                                + " ,q.t_DateOper "
                                + " ,q.t_DocKind "
                                + " ,q.t_DocID "
                                + " ,q.t_NumOper "
                                + " ,q.t_Rate "
                                + " ,q.t_TotalPlus "
                                + " ,q.t_TotalMinus "
                                + " ,q.t_TaxCalculated "
                                + " ,q.t_TaxToReturnDue "
                                + " ,q.t_DateTaxReturn "
                                + " ,q.t_IsHighRate "
                             + " FROM ( "
                                     + " SELECT "
                                         + " nptxobj.t_Client AS t_ClientID "
                                        + " ,oprstep.t_Fact_Date AS t_DatePlusFact "
                                        + " ,oprstep.t_Fact_Date AS t_DatePaid "
                                        + " ,oprstep.t_Fact_Date AS t_DateTransfer "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_BASEBILL + " AND nptxobj.t_Sum0 <= " + Max15
                                             + " THEN "
                                                 + " nptxobj.t_Sum0 "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_BASEBILL + " AND nptxobj.t_Sum0 > " + Max15
                                             + " THEN "
                                                 + Max15
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_BaseDate "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDBILL + " AND nptxobj.t_Sum0 > 0 "
                                             + " THEN "
                                                 + " nptxobj.t_Sum0 "
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_TaxPaidDate "
                                        + " ,oprstep.t_Fact_Date AS t_DateOper "
                                        + " ,dl_order.t_DocKind AS t_DocKind "
                                        + " ,dl_order.t_ContractID AS t_DocID "
                                        + " ,dl_order.t_OrderNumber AS t_NumOper "
                                        + " ,CASE "
                                             + " WHEN rsi_nptx.ResidenceStatus(nptxobj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 "
                                             + " THEN "
                                                 + " TO_CHAR(" + 13 + ") "
                                             + " ELSE "
                                                 + " CASE "
                                                     + " WHEN EXISTS (SELECT "
                                                                      + " 1 "
                                                                  + " FROM "
                                                                      + " dnotetext_dbt notetext "
                                                                  + " WHERE "
                                                                      + " notetext.t_ObjectType = " + OBJTYPE_PARTY + " "
                                                                  + " AND notetext.t_DocumentID = LPAD(nptxobj.t_Client, 10, '0') "
                                                                  + " AND notetext.t_NoteKind = " + 77 + " "
                                                                  + " AND " + GetSQLDate(m_EndDate) + " BETWEEN notetext.t_Date AND notetext.t_ValidToDate) "
                                                     + " THEN "
                                                         + " TO_CHAR(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + OBJTYPE_PARTY + ", LPAD(nptxobj.t_Client, 10, '0'), " + 77 + ", " + GetSQLDate(m_EndDate) + "))) "
                                                     + " ELSE "
                                                         + " TO_CHAR(" + 30 + ") "
                                                 + " END "
                                         + " END AS t_Rate "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_BASEBILL + " AND nptxobj.t_Sum0 <= " + Max15
                                             + " THEN "
                                                 + " nptxobj.t_Sum0 "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_BASEBILL + " AND nptxobj.t_Sum0 > " + Max15
                                             + " THEN "
                                                 + Max15
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_TotalPlus "
                                        + " ,0 AS t_TotalMinus "
                                        + " ,CASE "
                                             + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDBILL + " "
                                             + " THEN "
                                                 + " nptxobj.t_Sum "
                                             + " ELSE "
                                                 + " 0 "
                                         + " END AS t_TaxCalculated "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDBILL + " AND nptxobj.t_Sum0 < 0 "
                                           + " THEN "
                                              + " -nptxobj.t_Sum0 "
                                           + " ELSE "
                                              + " 0 "
                                         + " END AS t_TaxToReturnDue "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDBILL + " AND nptxobj.t_Sum0 < 0 "
                                           + " THEN "
                                              + " nptxobj.t_Date "
                                           + " ELSE "
                                              + " to_date('01.01.0001', 'dd.mm.yyyy') "
                                         + " END AS t_DateTaxReturn "
                                        + " ,chr(0) as t_IsHighRate "
                                     + " FROM "
                                         + " dnptxobj_dbt nptxobj "
                                        + " ,dnptxobdc_dbt nptxobdc "
                                        + " ,doproper_dbt oproper "
                                        + " ,doprkoper_dbt oprkoper "
                                        + " ,doprstep_dbt oprstep "
                                        + " ,ddl_order_dbt dl_order "
                                     + " WHERE "
                                         + " 1 = " + IIF(m_ByVS == SET_CHAR, 1, 0) + " "
                                     + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                     + " AND EXISTS (SELECT "
                                                     + " 1 "
                                                 + " FROM "
                                                     + " dparty_dbt party "
                                                 + " WHERE "
                                                     + " party.t_PartyID = nptxobj.t_Client "
                                                 + " AND party.t_LegalForm = " + PTLEGF_PERSN + ") "
                                     + " AND nptxobdc.t_DocID = oproper.t_ID_Operation "
                                     + " AND nptxobdc.t_Step = oprstep.t_ID_Step "
                                     + " AND oproper.t_DocKind = dl_order.t_DocKind "
                                     + " AND oproper.t_DocumentID = LPAD(dl_order.t_ContractID, 10, '0') "
                                     + " AND oprstep.t_ID_Operation = oproper.t_ID_Operation "
                                     + " AND oprstep.t_Fact_Date between ( CASE "
                                                                          + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                          + " THEN " + GetSQLDate(m_BeginDate)
                                                                          + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                       + " END ) AND " + GetSQLDate(m_EndDate) 
                                     + " AND (dl_order.t_DocKind = " + DL_VEKSELDRAWORDER + " "
                                      + " AND INSTR(oprkoper.t_SysTypes, " + GetSQLChar("Ф") + ") = 0 "
                                       + " OR dl_order.t_DocKind = " + DL_VSBARTERORDER + " "
                                       + " OR dl_order.t_DocKind = " + DL_VSINTERCHANGE + ") "
                                     + " AND oprkoper.t_Kind_Operation = oproper.t_Kind_Operation"
                                     + " union all "
                                     + " SELECT "
                                         + " nptxobj.t_Client AS t_ClientID "
                                        + " ,oprstep.t_Fact_Date AS t_DatePlusFact "
                                        + " ,oprstep.t_Fact_Date AS t_DatePaid "
                                        + " ,oprstep.t_Fact_Date AS t_DateTransfer "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_BASEBILL + " AND nptxobj.t_Sum0 > " + Max15
                                           + " THEN "
                                               + " nptxobj.t_Sum0 - " + Max15
                                           + " ELSE "
                                              + " 0 "
                                         + " END AS t_BaseDate "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind in (" + TXOBJ_PAIDGENERAL_15 + ", " + TXOBJ_PAIDGENERAL_15_IIS + ") "
                                           + " THEN "
                                              + " nptxobj.t_Sum0 "
                                           + " ELSE "
                                              + " 0 "
                                         + " END AS t_TaxPaidDate "
                                        + " ,oprstep.t_Fact_Date AS t_DateOper "
                                        + " ,dl_order.t_DocKind AS t_DocKind "
                                        + " ,dl_order.t_ContractID AS t_DocID "
                                        + " ,dl_order.t_OrderNumber AS t_NumOper "
                                        + " ,'15' AS t_Rate "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_BASEBILL + " AND nptxobj.t_Sum0 > " + Max15
                                           + " THEN "
                                              + " nptxobj.t_Sum0 - " + Max15
                                           + " ELSE "
                                              + " 0 "
                                         + " END AS t_TotalPlus "
                                        + " ,0 AS t_TotalMinus "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_BASEBILL + " AND nptxobj.t_Sum0 > " + Max15
                                           + " THEN "
                                              + " (nptxobj.t_Sum0 - " + Max15 + ") * 0.15 "
                                           + " ELSE "
                                              + " 0 "
                                         + " END AS t_TaxCalculated "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_15_9 + " AND nptxobj.t_Sum0 < 0 "
                                           + " THEN "
                                              + " -nptxobj.t_Sum0 "
                                           + " ELSE "
                                              + " 0 "
                                         + " END AS t_TaxToReturnDue "
                                        + " ,CASE "
                                           + " WHEN nptxobj.t_Kind = " + TXOBJ_PAIDGENERAL_15_9 + " AND nptxobj.t_Sum0 < 0 "
                                           + " THEN "
                                              + " nptxobj.t_Date "
                                           + " ELSE "
                                              + " to_date('01.01.0001', 'dd.mm.yyyy') "
                                         + " END AS t_DateTaxReturn "
                                        + " ,chr(88) as t_IsHighRate "
                                     + " FROM "
                                         + " dnptxobj_dbt nptxobj "
                                        + " ,dnptxobdc_dbt nptxobdc "
                                        + " ,doproper_dbt oproper "
                                        + " ,doprstep_dbt oprstep "
                                        + " ,doprkoper_dbt oprkoper "
                                        + " ,ddl_order_dbt dl_order "
                                     + " WHERE "
                                         + " 1 = " + IIF(m_ByVS == SET_CHAR, 1, 0) + " "
                                     + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
                                     + " AND rsi_nptx.ResidenceStatus(nptxobj.t_Client," + GetSQLDate(m_EndDate) + ") = 1 "
                                     + " AND EXISTS (SELECT "
                                                     + " 1 "
                                                 + " FROM "
                                                     + " dparty_dbt party "
                                                 + " WHERE "
                                                     + " party.t_PartyID = nptxobj.t_Client "
                                                 + " AND party.t_LegalForm = " + PTLEGF_PERSN + ") "
                                     + " AND nptxobdc.t_DocID = oproper.t_ID_Operation "
                                     + " AND nptxobdc.t_Step = oprstep.t_ID_Step "
                                     + " AND oproper.t_DocKind = dl_order.t_DocKind "
                                     + " AND oproper.t_DocumentID = LPAD(dl_order.t_ContractID, 10, '0') "
                                     + " AND oprstep.t_ID_Operation = oproper.t_ID_Operation "
                                     + " AND oprstep.t_Fact_Date between ( CASE "
                                                                          + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                                          + " THEN " + GetSQLDate(m_BeginDate)
                                                                          + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                                       + " END ) AND " + GetSQLDate(m_EndDate) 
                                     + " AND (dl_order.t_DocKind = " + DL_VEKSELDRAWORDER + " "
                                      + " AND INSTR(oprkoper.t_SysTypes, " + GetSQLChar("Ф") + ") = 0 "
                                       + " OR dl_order.t_DocKind = " + DL_VSBARTERORDER + " "
                                       + " OR dl_order.t_DocKind = " + DL_VSINTERCHANGE + ") "
                                     + " AND oprkoper.t_Kind_Operation = oproper.t_Kind_Operation"
                                 + " ) q "
                             + ") "
                         + ") "    
                        + " WHERE "
                            + " t_BaseDate <> 0 "
                         + " OR t_TaxPaidDate <> 0 "
                         + " OR t_TotalPlus <> 0 "
                         + " OR t_TotalMinus <> 0 "
                         + " OR t_TaxCalculated <> 0 "
                         + " OR t_TaxToReturnDue <> 0 "
                        + " GROUP BY "
                            + " t_Module "
                           + " ,t_TypeOper "
                           + " ,t_ClientID "
                           + " ,t_DocKind "
                           + " ,t_DatePlusFact "
                           + " ,t_DatePaid "
                           + " ,t_DateTransfer "
                           + " ,t_DateOper "
                           + " ,t_DocID "
                           + " ,t_NumOper "
                           + " ,t_DateTaxReturn "
                           + " ,t_IsHighRate) q "
                      + " ,(SELECT "
                            + " nptx6lnk.t_DocKind1 AS t_DocKind "
                           + " ,nptx6lnk.t_DocID1 AS t_DocID "
                           + " ,nptx6lnk.t_ClientID1 AS t_ClientID "
                           + " ,nptx6lnk.t_Date AS t_Date "
                          + " ,SUM(nptx6lnk.t_Sum) AS t_Sum "
                           + " ,MAX(nptx6lnk.t_AllSum) AS t_AllSum "
                           + " ,GROUPING(nptx6lnk.t_DocKind2) "
                          + " * GROUPING(nptx6lnk.t_DocID2) "
                          + " * GROUPING(nptx6lnk.t_ClientID2) AS t_Flag "
                        + " FROM "
                            + " dnptx6lnk_tmp nptx6lnk "
                        + " WHERE "
                            + " nptx6lnk.t_Date between ( CASE "
                                                         + " WHEN MONTHS_BETWEEN (" + GetSQLDate(m_BeginDate) + ", " + GetSQLDate(m_EndDate) + ") >= -3"
                                                         + " THEN " + GetSQLDate(m_BeginDate)
                                                         + " ELSE " + "ADD_MONTHS(" + GetSQLDate(m_EndDate) + ", -3)"
                                                      + " END ) AND " + GetSQLDate(m_EndDate) 
                        + " GROUP BY "
                            + " nptx6lnk.t_DocKind1 "
                           + " ,nptx6lnk.t_DocID1 "
                           + " ,nptx6lnk.t_ClientID1 "
                           + " ,nptx6lnk.t_Date "
                           + " ,ROLLUP((nptx6lnk.t_DocKind2 "
                                   + " ,nptx6lnk.t_DocID2 "
                                   + " ,nptx6lnk.t_ClientID2))) q2 "
                   + " WHERE "
                       + " q.t_DocKind = q2.t_DocKind(+) "
                   + " AND q.t_DocID = q2.t_DocID(+) "
                   + " AND q.t_ClientID = q2.t_ClientID(+) "
                   + ")";

    cmd = RSDCommand(query);
    cmd.NullConversion = true;
    cmd.Execute();
  end;

  macro Pays()
    if(m_Set == null)
      m_Query = " SELECT "
                   + " COUNT(1) OVER () AS t_Count "
                  + " ,t_Module "
                  + " ,LISTAGG(t_Num, ', ') WITHIN GROUP (ORDER BY t_Num) as t_Num "
                  + " ,t_TypeOper "
                  + " ,t_ClientID "
                  + " ,t_Client "
                  + " ,t_ClientCode "
                  + " ,t_DatePlusFact "
                  + " ,t_DatePaid "
                  + " ,t_DateTransfer "
                  + " ,NVL(SUM(t_BaseDate), 0) as t_BaseDate "
                  + " ,NVL(SUM(t_TaxPaidDate), 0) as t_TaxPaidDate "	
                  + " ,t_DateOper "
                  + " ,t_DocKind "
                  + " ,LISTAGG(t_NumOper, ', ') WITHIN GROUP (ORDER BY t_NumOper) as t_NumOper "
                  + " ,t_Rate "
                  + " ,NVL(SUM(t_TotalPlus), 0) t_TotalPlus "
                  + " ,NVL(SUM(t_TotalMinus), 0) t_TotalMinus "
                  + " ,NVL(SUM(t_TaxCalculated), 0) t_TaxCalculated "
                  + " ,NVL(SUM(t_TaxDue), 0) as t_TaxDue "
                  + " ,NVL(SUM(t_TaxToReturnDue), 0) t_TaxToReturnDue "
                  + " ,t_DateTaxReturn "
               + " FROM "
                   + " dnptx6calc2_tmp "
               + " GROUP BY t_Module "
               + "        , t_TypeOper "
               + "        , t_ClientID "
               + "        , t_Client "
               + "        , t_ClientCode "
               + "        , t_DatePlusFact "
               + "        , t_DatePaid "
               + "        , t_DateTransfer "
               + "        , t_DateOper "
               + "        , t_DocKind "
               + "        , t_Rate "
               + "        , t_DateTaxReturn "
               + " ORDER BY "
                  + "  t_Module ASC "
                  + " ,t_Num ASC ";

      m_Cmd = RsdCommand(m_Query);
      m_Cmd.NullConversion = true;
      m_Cmd.Execute();

      m_Set = RsdRecordset(m_Cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
    end;

    return m_Set;
  end;

  macro Returns()
     if(m_SetRet == NULL)
        m_QueryRet = " SELECT "
                      + " COUNT(1) OVER() as t_Count "
                     + " ,t_DateTaxReturn as t_DateTaxReturn "
                     + " ,t_TaxToReturnDue as t_TaxToReturnDue "
                   + " FROM "
                      + " dnptx6calc2_tmp "
                   + " WHERE "
                      + " t_TaxToReturnDue > 0 "
                   + " ORDER BY "
                      + "  t_Module ASC "
                      + " ,t_Num ASC ";

        m_CmdRet = RsdCommand(m_QueryRet);
        m_CmdRet.NullConversion = true;
        m_CmdRet.Execute();

        m_SetRet = RsdRecordset(m_CmdRet, RSDVAL_CLIENT, RSDVAL_STATIC);
     end;

     return m_SetRet;
  end;

  macro Rates()
    if(m_Set2 == null)
      m_Query2 =  " SELECT q.t_Count "
                 + " ,q.t_Rate "
                 + " ,q.t_DatePlusFact "
                 + " ,q.t_DatePaid "
                 + " ,q.t_DateTransfer "
                 + " ,q.t_BaseDate "
                 + " ,q.t_TaxPaidDate "
                 + " ,q.t_TotalPlus "
                 + " ,q.t_TotalMinus "
                 + " ,q.t_TaxCalculated "
                 + " ,CASE "
                 + "     WHEN q.t_TaxDue > 0 "
                 + "     THEN q.t_TaxDue "
                 + "     ELSE 0 "
                 + "  END t_TaxDue "
                 + " ,CASE "
                 + "     WHEN q.t_TaxDue < 0 "
                 + "     THEN q.t_TaxDue "
                 + "     ELSE 0 "
                 + "  END t_TaxOver "
                 + " ,q.t_TaxToReturnDue "
               + " FROM ("
                       + " SELECT "
                        + " COUNT(1) OVER () AS t_Count "
                       + " ,t_Rate "
                       + " ,t_DatePlusFact "
                       + " ,t_DatePaid "
                       + " ,t_DateTransfer "
                       + " ,NVL(SUM(t_BaseDate), 0) as t_BaseDate "
                       + " ,NVL(SUM(t_TaxPaidDate), 0) as t_TaxPaidDate "
                       + " ,NVL(SUM(t_TotalPlus), 0) as t_TotalPlus "
                       + " ,NVL(SUM(t_TotalMinus), 0) as t_TotalMinus "
                       + " ,NVL(SUM(t_TaxCalculated), 0) as t_TaxCalculated "
                       + " ,NVL(SUM(t_TaxDue), 0) as t_TaxDue "
                       + " ,NVL(SUM(t_TaxToReturnDue), 0) as t_TaxToReturnDue "
                      + " FROM "
                          + " dnptx6calc2_tmp "
                      + " GROUP BY "
                          + " t_Rate, "
                          + " t_DatePlusFact, "
                          + " t_DatePaid, "
                          + " t_DateTransfer "
               + "      ) q"
               + " WHERE q.t_BaseDate > 0"
               + " ORDER BY "
                   + " q.t_Rate ASC, "
                   + " q.t_DatePlusFact ASC, "
                   + " q.t_DatePaid ASC, "
                   + " q.t_DateTransfer ASC ";

      m_Cmd2 = RsdCommand(m_Query2);
      m_Cmd2.NullConversion = true;
      m_Cmd2.Execute();

      m_Set2 = RsdRecordset(m_Cmd2, RSDVAL_CLIENT, RSDVAL_STATIC);
    end;

    return m_Set2;
  end;

  macro BeginDate()
    return m_BeginDate;
  end;

  macro EndDate()
    return m_EndDate;
  end;

  if(_BeginDate != null)
    m_BeginDate = _BeginDate;
  end;

  if(_EndDate != null)
    m_EndDate = _EndDate;
  end;

  if(_ByCB != null)
    m_ByCB = _ByCB;
  end;

  if(_ByDepo != null)
    m_ByDepo = _ByDepo;
  end;

  if(_ByVS != null)
    m_ByVS = _ByVS;
  end;
end;
