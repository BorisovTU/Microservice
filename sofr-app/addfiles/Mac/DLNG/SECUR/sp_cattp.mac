/*
$Name:        sp_cattp.mac
$Module:      Ценные бумаги
$Description: Процедуры для получения параметров шаблонов счетов параметры - это значения из llvalues.dbt для заданных  справочников (objects.dbt) и классификаторов (llclass.dbt)
*/

/*********************************************************************************/
/*         Автоматизированная банковская система RS-Bank v5.1                    */
/*                 Copyright (c) R-Style Software Lab 2001                       */
/*                                                                               */
/*  Имя файла        : sp_cattp.mac                                              */
/*                                                                               */
/*  Описание         : Процедуры для получения параметров шаблонов счетов        */
/*                     параметры - это значения из llvalues.dbt для заданных     */
/*                     справочников (objects.dbt) и классификаторов (llclass.dbt)*/
/*                                                                               */
/*  Программист      : Азарцов В.В.                                              */
/*                                                                               */
/*  Создан           : //AV 26.02.01                                             */
/*                                                                               */
/*********************************************************************************/
IMPORT OprInter, CTInter, FIInter, PaymInter, DealsInter, "dlcnst.inc", "mctplprm.mac", "sp_catfn.mac", "secinter.mac", "dlcontrfunc.mac";

/*DAN Возвращает 1 если ФИ является Биржевой Инвестиционной облигацией*/
private macro FI_IsBIO(fiid)
   var query = " begin\n ? := RSI_RSB_FIInstr.FI_IsBIO(?);\n end; ";
   var cmd = RSDCommand(query);
   cmd.AddParam("n_Retval", RSDBP_OUT, V_INTEGER);
   cmd.AddParam("p_fiid", RSDBP_IN, fiid);
   cmd.Execute();
   return SQL_ConvTypeInteger(cmd.value("n_Retval"));
end;
/*DAN*/

private macro FI_IsCurrency(fiid)
   var query = " begin\n ? := RSI_RSB_FIInstr.FI_IsCurrency(?);\n end; ";
   var cmd = RSDCommand(query);
   cmd.AddParam("n_Retval", RSDBP_OUT, V_INTEGER);
   cmd.AddParam("p_fiid", RSDBP_IN, fiid);
   cmd.Execute();
   return SQL_ConvTypeInteger(cmd.value("n_Retval"));
end;


PRIVATE MACRO SC_GetKindCbPortf( FIID ):integer
  record fin("fininstr.dbt");

  if( (FIID >= 0) AND (ПолучитьФинИн(FIID, fin) == 0) ) 
     if( FI_IsShare(fin) OR FI_IsInvestmentShare(fin) )
        return 102; /*Долевая ц/б*/
     elif( FI_IsBond(fin) == true )
        return 3; /*Долговое обязательство*/
     end;
  end;

  return -1;
END;

PRIVATE MACRO GetCatCurrency(FD, CatCode:string)
  var query, cmd, DataSet;
  var Currency = -1;

  query =   " select t_CurType "
          + "   from dmccateg_dbt "
          + "  where t_LevelType = 1 "
          + "    and t_Code = ? ";
  cmd = DL_RSDCommand(query);

  cmd.AddParam(CatCode);

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    if(DataSet.CurType == 0) //MC_CURTYPE_NATCUR
      Currency = NATCUR;
    elif(DataSet.CurType == 1) //MC_CURTYPE_FININSTR
      Currency = FD.GetParametr(MC_TYPE_PARAMETR_FIID);
    elif(DataSet.CurType == 2) //MC_CURTYPE_NOMINAL
      Currency = FD.GetParametr(MC_TYPE_PARAMETR_CURRENCY);
    elif(DataSet.CurType == 3) //MC_CURTYPE_PAYMENT
      Currency = FD.GetParametr(MC_TYPE_PARAMETR_PAYCURRENCY);
    end;
  end;

  return Currency;
END;


/****************************************************************************/
/*  Общая процедура получения параметров шаблонов для категорий учета       */
/****************************************************************************/
MACRO MC_GetParametrTemplate( FD, ObjectID, Classificator, OperDate, FIRole )

   var Parametr = -1;           /*по умолчанию*/
   var Market, Group, FIID, Issuer, Client, BuyGoal, Contragent, IsRes, DecisionDate = date(0,0,0);
   var fin = TRecHandler("fininstr.dbt");
   var avr = TRecHandler("avoiriss.dbt");
   var finParent = TRecHandler("fininstr.dbt");

   FIRole = FD.GetBasisFIRole( FIRole );

   FIID     = FD.GetParametr( MC_TYPE_PARAMETR_FIID, OperDate, null, FIRole );
   Issuer   = FD.GetParametr( MC_TYPE_PARAMETR_ISSUER, OperDate, null, FIRole );
   Client   = FD.GetParametr( MC_TYPE_PARAMETR_CLIENT, OperDate, null, FIRole );
   Contragent = FD.GetParametr( MC_TYPE_PARAMETR_PARTY, OperDate, null, FIRole );
   /*портфель(вид)*/
   if( (ObjectID == OBJTYPE_KINDPORT) AND (Classificator == LLCLASS_KINDPORT) )      

      Parametr = GetPortfolioByFIRole( FD, FIRole );
    elif ((Classificator == 5004) and ((FD.Kind == 4830) or (FD.Kind == 4832)))  //DAN Добавленио 4832
      if (FD.GetParmForCateg24828("+Эмиссия, ОЭБ") == "05")
        Parametr = 5;
      else
        Parametr = 2;
      end;
/*KD*/
    elif( Classificator == 505) 
      If((FD.kind == 176) OR (FD.kind == 101) OR (FD.kind == 117) OR (FD.kind == 4832)) // Golovkin 17.12.2019 + 4832 Погашение СЭБ
         If(FD.dl_leg.rec.cfi !=0)
            Parametr = 0;
         else
            Parametr = 1;
         end;
      elif (FD.kind == 5) 
	     DecisionDate = readNoteForObject( OBJTYPE_AVOIRISS, L_Z( Int(FD.fininstr.rec.FIID), 10 ), 108 );
         if ((ValType(DecisionDate) == V_DATE) and (DecisionDate != date(0,0,0)))
            Parametr = 1;
         elif(FD.fininstr.rec.facevaluefi !=0)
            Parametr = 0;
         else
            Parametr = 1;
         end;
      elif (FD.kind == 4830)
        if(FD.GetCurrentCatCode() == "Затраты, ОЭБ")
            return 1;
        else
          If(/*FD.fininstr.rec.facevaluefi*/FD.dl_leg.rec.cfi !=0)
            Parametr = 0;
           else
            Parametr = 1;
           end;
        end;
      elif (FD.kind == 4607) 
         if(FD.nptxop.rec.currency != 0)
            Parametr = 0;
         else
            Parametr = 1;
         end;
      else
            Parametr = 1;
      end;

   /*вид цб - вид цб портфеля*/
   elif( (ObjectID == OBJTYPE_KINDCB) AND (Classificator == LLCLASS_KINDCB_PORTF) )
      if( (FIID >= 0) AND (ПолучитьФинИн( FIID, fin ) == 0) AND (FI_IsDeposReceipt( fin ) == true))
        if(FD.GetCurrentCatCode() == "-КВ, затраты, ц/б")
          Parametr = 7; /*Депозитарная расписка*/
        else
          if(ПолучитьФинИн( fin.rec.parentfi, finParent ) == 0)
            if( FI_IsBond(finParent.rec.FIID) )
              Parametr = 3; /*Долговое обязательство*/  
            else
              Parametr = 102; /*Долевая ц/б*/
            end;
          end;
        end;
      else
        Parametr = MC_GetKindCbPortf( FIID, FIRole );
      end;
   elif( (ObjectID == OBJTYPE_KINDCB) AND (Classificator == LLCLASS_KINDCB_INVESTMENT) )
      Parametr = SC_GetKindCbPortf(FIID);
   /*вид цб - вид цб резерва*/
   elif( (ObjectID == OBJTYPE_KINDCB) AND  (Classificator == LLCLASS_KINDCB_RESERV) )
      Parametr = MC_GetKindCbReserve( FIID );                                       

   /*вид цб - вид цб расходы по облигациям */
   elif( (ObjectID == OBJTYPE_KINDCB) AND  (Classificator == LLCLASS_KINDCB_RASHOD) )
      Parametr = MC_GetKindCbRashod( FIID );

   /*вид субъекта - категория эмитента*/
   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND  (Classificator == LLCLASS_KINDSUBJ_ISSUER) )
      Parametr = MC_GetKindIssuer( Issuer, false );

   /*вид субъекта - категория эмитента доходы\расходы*/
   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND ((Classificator == LLCLASS_KINDSUBJ_ISSUER_DR) OR (Classificator == LLCLASS_KINDSUBJ_SHARE_ISSUER_DR)) )
      Parametr = MC_GetKindIssuerDR( Issuer, false, FIRole );

   /*вид субъекта - категория субсидиария*/
   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND  (Classificator == LLCLASS_KINDSUBJ_SUB) )
      Parametr = MC_GetKindSubsidiary( Issuer );

   elif ( (ObjectID == OBJTYPE_KINDSUBJ) and (Classificator == LLCLASS_KINDSUBJ_DEPONENT) )
      Parametr =  MC_GetDeponent(Issuer);   

   elif( (ObjectID == OBJTYPE_DIRECTION) AND  (Classificator == LLCLASS_DIRECTION_MM) )
      /*Направление сделки*/
      if( IsBUY(FD.Group) )
         Parametr = 1; /*Привлечение*/
      else
         Parametr = 2; /*Размещение*/
      end;

   elif( (ObjectID == OBJTYPE_DIRECTION) AND  (Classificator == LLCLASS_DIRECTION_PAYMM) )
      if( (FD.nptxop != NULL) AND (FD.nptxop.rec.DocKind == DL_HOLDNDFL) AND (FD.nptxop.rec.SubKind_Operation == DL_TXHOLD_OPTYPE_TAXREF) )
         Parametr = 3; /*Поступления*/
      end;
   elif( (ObjectID == OBJTYPE_STATECONT) AND  (Classificator == LLCLASS_STATECONT_DEALMM) )
      /*Состояние сделки*/
      Parametr = 1; /*Не пролонгирован*/

   elif( (ObjectID == OBJTYPE_TOOLCATEGORY) AND  (Classificator == LLCLASS_TOOLCATEG_DEBTS) )
      /*Категории средств по задолженности*/
      Parametr = 1; /*Кредит*/

   /*вид субъекта - Категория дебитора/кредитора в сделках ц/б */
   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND (Classificator == LLCLASS_KINDSUBJ_KONTRMM) )
      /*Возвращать значения по тому же адгоритму, что и для КатегКонтрТреб, кроме:
      - возвращать Центоробанк, если субъект - центробанк 
      - возвращать Кредитн. орг. - резидент для всех кредитных организаций - резидентов, кроме Центробанка*/
      if( (FIRole == FIROLE_RESERV_RSS) or
          (FIRole == FIROLE_RESERV_RPT) or
          (FIRole == FIROLE_RESERV_RPOR) or
          (FIRole == FIROLE_RESERV_RPTP) or
          (FIRole == FIROLE_RESERV_RUOKXOR) or
          (FIRole == FIROLE_RESERV_RSOP) or
          (FIRole == FIROLE_BA_RESERV_REQ)           
        )
         Parametr = -1;
      else
         Parametr = MC_GetKindSecurCredit( Contragent );/*Проверить ЦентробанкРФ или КредОргРез*/
         if( (Parametr != 1) AND (Parametr != 2) AND (Parametr != 8) AND (Parametr != 10) ) /*ЦентробанкРФ или КредОргРез*/
            Parametr = MC_GetKindSecurDebet( Contragent );
         end;
      end;

   /*вид субъекта - Категория дебитора/кредитора в сделках ц/б */
   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND (Classificator == LLCLASS_KINDSUBJ_DEBETSECUR) )
      if((FIRole == FIROLE_RORPOR) or (FIRole == FIROLE_ROZ) or (FIRole == FIROLE_ROKOR) or (FIRole == FIROLE_RORPTP))
         Parametr = -1;
      else
         Parametr = MC_GetKindSecurDebet( Contragent );
      end;

   elif( (ObjectID == OBJTYPE_CAT_CONTR) AND (Classificator == LLCLASS_CAT_CONTR) )
      if (FD.kind == 4607)
         if (FD.nptxop.rec.client != -1)
             Parametr = MC_GetKindSecurCatContr(FD.nptxop.rec.client);
         else
             Parametr = MC_GetKindSecurCatContr(Contragent);
         end; 
      else
        Parametr = MC_GetKindSecurCatContr(Contragent);
     end; 

   /*вид субъекта - Категория контрагента в доходах/расходах по процентам*/
   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND (Classificator == LLCLASS_KINDSUBJ_KDRMM) )
      Parametr = MC_GetKindContragentByPC( Contragent );

   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND (Classificator == LLCLASS_KINDSUBJ_CREDITSECUR) )
      Parametr = MC_GetKindSecurCredit( Contragent );

   /*вид субъекта - Вид контрагента в биржевой сделке */
   elif( (ObjectID == OBJTYPE_KINDSUBJ) AND (Classificator == LLCLASS_CONTR_MARKETDEAL) )
   /*Выглядеть это должно так:
      - Вид контрагента в бирж. сделках - определяется по схеме расчетов в сделке:
      - если в схеме расчетов указан б/с 304  то "РЦ ОРЦБ"
      - если указан б/с 302 - то "РНКО"
   */                                                                             
      if( FD.Is304() == true )
         Parametr = 401;
      else
         Parametr = 400;      
      end;
   /*резидентность - резидентность эмитента*/
   elif( (ObjectID == OBJTYPE_RESIDENT) AND  (Classificator == LLCLASS_RESIDENT_ISS) )
      Parametr = MC_IsResident( Issuer );

   /*резидентность - клиента по сделкам с ц/б*/
   elif( (ObjectID == OBJTYPE_RESIDENT) AND  (Classificator == LLCLASS_RESIDENT_CLCB) )      
      Parametr = MC_IsResident( Client );

   /*резидентность - контрагента по сделкам с ц/б*/
   elif( (ObjectID == OBJTYPE_RESIDENT) AND  (Classificator == LLCLASS_RESD_CONTRACTOR) )      
      if( FIRole == FIROLE_RESERV_ROR )
         Parametr = -1;
      else
         Parametr = MC_IsResident( Contragent );
      end;

   /* вид клиента по расчетам с ц/б*/
   elif( (ObjectID == OBJTYPE_KINDCLCB) AND (Classificator == LLCLASS_KINDCLCB) )
      if( Client != Issuer )
         Parametr = 1; /*клиент*/
      else
         Parametr = 2; /*эмитент*/
      end;

   /* вид налога */
   elif( (ObjectID == OBJTYPE_KINDTAX) AND (Classificator == LLCLASS_KINDTAX) )
      Parametr = 1; /*НДС - в сделках по ц/б всегда это значение*/

   /* вид депонента */
   elif( ( ObjectID == OBJTYPE_KINDOWNER) AND (Classificator == LLCLASS_OWNER_AVOIR))      
      if( (FIRole == FIROLE_SRCA) OR (FIRole == FIROLE_DSTA) ) 
         Parametr = MC_GetKindOwnerCB( Contragent );
      else
         Parametr = MC_GetKindOwnerCB( Client );
      end;

   /*Контрагент-КредОрг?*/
   elif( ( ObjectID == OBJTYPE_BOOLEAN) AND (Classificator == LLCLASS_CONTRCREDIT_ORG))      
      if( (FIRole == FIROLE_RESERV_ROR) or (FIRole == FIROLE_OTHPLACEDMONEY) or (FIRole == FIROLE_RORPOR) or (FIRole == FIROLE_ROZ) or (FIRole == FIROLE_ROKOR) )
         Parametr = -1;
      else
         if( MC_GetKindParty( Contragent, IsRes ) == 1 ) /*банк*/  
            Parametr = 1; /*Да*/
         else
            Parametr = 0; /*Нет*/
         end;
      end;

   /*вид резерва по договорам с ц/б*/
   elif( ObjectID == OBJTYPE_KINDRESERV )
       if( FIRole == FIROLE_RESERV_RVCB) 
          Parametr = KINDRES_AVOIR; /* РВЦБ Резерв по вложениям в ЦБ*/
       elif( (FIRole == FIROLE_RESERV_SALEREPO2_TP) or (FIRole == FIROLE_RESERV_SALEREPO2_PPR) or (FIRole == FIROLE_RESERV_SALEREPO2_PUDP) or (FIRole == FIROLE_RESERV_SALEREPO2_CONTR) or (FIRole == FIROLE_RESERV_SALEREPO2_PVO))
          Parametr = KINDRES_SALEREPO2; /*РПР Резерв по требованиям по 2 части сделок пр. РЕПО*/
       elif( FIRole == FIROLE_RESERV_RSS )
          Parametr = KINDRES_DEAL; /* РСС  Резерв по срочным сделкам*/
       elif( (FIRole == FIROLE_RESERV_RPT) OR (FIRole == FIROLE_BA_RESERV_REQ) )
          Parametr = KINDRES_EXPREQ; /*РПТ По просроченным требованиям*/
       elif( FIRole == FIROLE_RESERV_ROR )
          Parametr = KINDRES_REPO; /*РОР Резерв по сделкам обратного Репо*/
       elif( FIRole == FIROLE_RESERV_RSOP )
          Parametr = KINDRES_DELAYPAY; /* РСОП Резерв по сделкам с отсрочкой платежа*/
       elif( FIRole == FIROLE_RESERV_RVPCB )
          Parametr = KINDRES_RVPCB; /* РВПЦБ Резерв по начисленному ПДД по ц/б*/
       elif( FIRole == FIROLE_RESERV_RUOKXOR )
          Parametr = KINDRES_RUOKXOR; /* РУОКХОР Резерв по условным обязятельствам кред. характер сделок ОР*/
       elif( FIRole == FIROLE_RESERV_RPTP )
          Parametr = KINDRES_RPTP; /* РПТП Резерв по просроченным процентным требованиям по сделкам ОР  */
       elif( (FIRole == FIROLE_RESERV_RPTP) or (FIRole == FIROLE_RESERV_RPOR) )
          Parametr = KINDRES_RPOR; /* РПОР Резерв по требованиям по получениям процентных доходов по сделкам ОР  */
       elif(FIRole == FIROLE_OTHPLACEDMONEY)
          Parametr = KINDRES_OTHPLACEDMONEY;
       elif(FIRole == FIROLE_RORPT)
          Parametr = KINDRES_RORPT;
       elif(FIRole == FIROLE_RORPTP)
          Parametr = KINDRES_RORPTP;
       elif(FIRole == FIROLE_RORPOR)
          Parametr = KINDRES_RORPOR;
       elif(FIRole == FIROLE_ROZ)
          Parametr = KINDRES_ROZ;
       elif(FIRole == FIROLE_ROKOR)
          Parametr = KINDRES_ROKOR;
       elif( (FIRole == FIROLE_BA_PPR) OR
                (FIRole == FIROLE_BA_PPR_BPP) OR
                (FIRole == FIROLE_BA_PUDP) OR
                (FIRole == FIROLE_BA_ASCB_BPP) OR
                (FIRole == FIROLE_BAINPROMISSORY) OR
                (FIRole == FIROLE_BAINCONTR) 
              )
          Parametr = KINDRES_AVOIR; /* РВЦБ Резерв по вложениям в ЦБ*/
       elif( (FIRole == FIROLE_PD_PPR) OR
                (FIRole == FIROLE_PD_PUDP) OR
                (FIRole == FIROLE_PD_PDO) OR
                (FIRole == FIROLE_PD_PKU) 
              )
          Parametr = KINDRES_RVPCB; /* РВПЦБ Резерв по начисленному ПДД по ц/б*/
       elif( FIRole == FIROLE_AVOIR_UC )
          Parametr = KINDRES_RCBUC; /* РВЦННДР Резерв по вложениям в ценные бумаги, учитываемых в ненадежных депозитариях*/
       else
          if( (FD != NULL) AND (FD.KindReserv != null) )
             Parametr = FD.KindReserv;
          end;
       end;

   /*балансовый счет расчетной базы*/
   elif( ( ObjectID == OBJTYPE_BALANCE_ACCOUNT) AND ( Classificator == LLCLASS_BALANCE_ACCOUNT) ) 
       if( FIRole == FIROLE_CALC_ANOTHER_OPER ) /*Расчеты по прочим операциям*/
          Parametr = 2;
       elif( FIRole == FIROLE_CALC_AVOIRISS_OPER ) /*Расчеты по операциям с ЦБ*/
          Parametr = 1;
       else
          Parametr = -1;
       end;

   /* вид принадлежности ц/б (свои\чужие) */
   elif( ( ObjectID ==  OBJTYPE_SECURITY_OWN) AND (Classificator == LLCLASS_SECUR_OWNERSHIP_SEPARATE) )
      Parametr = MC_GetKindSecOwn( Client );      

   /*продукт - продукт РКО*/
   elif( (ObjectID == OBJTYPE_PRODUCT) AND  (Classificator == LLCLASS_PRODUCT_RKO)  )
      Parametr = 1000; /*другие операции*/

   /*продукт - другие расходы*/
   elif( (ObjectID ==  OBJTYPE_PRODUCT) AND (Classificator == LLCLASS_PRODUCT_ANRAS) )
      Parametr = 1000; /*Другие операции*/ 

   /*продукт - подвид доходов/расходов*/
   elif( (ObjectID ==  OBJTYPE_PRODUCT) AND (Classificator == LLCLASS_PRODUCT_DR) )
        Parametr = -1; 

   /*продукт - продукт в затратах*/
   elif( (ObjectID == OBJTYPE_PRODUCT) AND (Classificator == LLCLASS_PRODUCT_OUTLAY) )
      if( FD.tick != NULL )
         if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_BUY )
            Parametr = 500; /*приобретение*/
         else
            Parametr = 501; /*реализация*/
         end;
      else
         if( FIRole == FIROLE_BUYACTIVE )
            Parametr = 500; /*приобретение*/
         elif( FIRole == FIROLE_SALEACTIVE )
            Parametr = 501; /*реализация*/
         end;
      end;

   /*продукт - продукт сделок с ц/б*/
   elif( (ObjectID == OBJTYPE_PRODUCT) AND (Classificator == LLCLASS_PRODUCT_DEAL_AVR) )
      if( FD.tick != null )
         if( FD.tick.rec.BofficeKind == DL_CONVAVR )
            Parametr = 1;  /*сделка покупки\продажи*/

         elif( FD.IsOperLOAN == true )
            if( FIRole == FIROLE_BA )
               Parametr = 11; /*займ*/
            elif( FIRole == FIROLE_BA_RESALE )
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            elif( FIRole == FIROLE_BA_INVEST )
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            elif( FIRole == FIROLE_BAININVEST ) 
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            elif( FIRole == FIROLE_BAINCONTR ) 
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            elif( FIRole == FIROLE_BAINPROMISSORYSALE) 
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            elif( FIRole == FIROLE_BAINPROMISSORYINVEST) 
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            elif( FIRole == FIROLE_BAINPROMISSORY) 
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            elif( FIRole == FIROLE_BA_REPO ) 
               Parametr = 10; /*сделка с обр. прод*/
            end;

         elif( FD.ExistBack == true ) /*Сделки с обр. частью */

            /*часть покупки (первая или вторая)*/
            if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_BUY )
               /*покупка с обратной продажей, покупка РЕПО*/
               if( IsBUY(FD.Group) OR IsREPO(FD.Group) ) 
                  Parametr = 10; /*обратная продажа*/
               else
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               end;
            else /*по второй части*/
               if( FIRole == FIROLE_BA )
                  Parametr = 10; /*сделка с обр. прод*/
               elif( FIRole == FIROLE_BA_RESALE )
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               elif( FIRole == FIROLE_BA_INVEST )
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               elif( FIRole == FIROLE_BAININVEST )
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               elif( FIRole == FIROLE_BAINCONTR )
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               elif( FIRole == FIROLE_BAINPROMISSORYSALE)
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               elif( FIRole == FIROLE_BAINPROMISSORYINVEST )
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               elif( FIRole == FIROLE_BAINPROMISSORY )
                  Parametr = 1;  /*сделка покупки\продажи\погашения*/
               elif( FIRole == FIROLE_BA_REPO)
                  Parametr = 10; /*сделка с обр. прод*/
               elif( FIRole == FIROLE_BA_LOAN)
                  Parametr = 11; /*займ*/
               end;
            end;
         else
            if( FIRole == FIROLE_BA_REPO)
               Parametr = 10; /*сделка с обр. прод*/
            elif( FIRole == FIROLE_BA_LOAN)
               Parametr = 11; /*займ*/
            else
               Parametr = 1;  /*сделка покупки\продажи\погашения*/
            end;
         end;
      else   
         if( FIRole == FIROLE_BA_REPO )
            Parametr = 304; /*обр. продажа*/
         elif( FIRole == FIROLE_BA_LOAN )
            Parametr = 11; /*займ*/
         else
            Parametr = 1;  /*сделка покупки\продажи\погашения*/
         end;
      end;

   /*отнесение на себестоимость - отнесение на себестоимость*/
   elif( (ObjectID == OBJTYPE_OTNSEBEST) AND (Classificator == LLCLASS_OTNSEBEST_SEBEST) )
      Parametr = -1;  /*не задано*/

   /*котируемость*/
   elif( (ObjectID == OBJTYPE_BOOLEAN) AND (Classificator == LLCLASS_QUOTED) )

      if( IsTransferFIRole( FIRole ) == false )      

         if( FD.Quoted == null )/*Если напрямую не задан, берем из ц/б*/
            if( FI_IsQuoted( FIID, OperDate ) ) 
               Parametr = 1; /*Да*/
            else 
               Parametr = 0; /*Нет*/  
            end;
         else
            if( FD.Quoted != "" )   
               Parametr = 1; /*Да*/
            else                    
               Parametr = 0; /*Нет*/
            end;
         end;
      else     /*для операции перемещения ц/б*/
         Parametr = Transfer_GetQuoted( FD, FIID, FIRole );         
      end;

   /*цель приобретения - цель приобретения ц/б*/
   elif( (ObjectID == OBJTYPE_BUYGOAL) AND (Classificator == LLCLASS_BUYGOAL_CB) ) 
      Parametr = GetBuyGoal( FD, FIID, FIRole );

   /*вид ФИ - активы банка*/
   elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK)  )

      Parametr = GetActiveBank( FIRole );

   /*вид ФИ - активы требований*/
   elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_REQ)  )
      Parametr = GetActiveBank( FD.GetBasisFIRole( FIROLE_FIREQ ) );      
   /*вид ФИ - активы обязательств*/
   elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_COMM) )
      Parametr = GetActiveBank( FD.GetBasisFIRole( FIROLE_FICOM ) );      

   elif( (ObjectID == OBJTYPE_BACKOFFICE) AND (Classificator == LLCLASS_BACKOFFICE) )
      Parametr = 5; /*Ценные бумаги*/
      if( FD.tick != null )
         if((FD.tick.rec.BofficeKind == DL_SECUROWN) or (FD.tick.rec.BofficeKind == DL_AVRWRTOWN) or (FD.tick.rec.BofficeKind == DL_RETIREMENT_OWN))
           Parametr = 0; /*Выпущенные облигации*/
         end;
      else 
        if (FIRole == FIROLE_AJUSTVALOEB)
          Parametr = 0; /*Выпущенные облигации*/
        end;
      end;

   elif( (ObjectID == OBJTYPE_PRODUCT) AND (Classificator == LLCLASS_PRODUCT_FOREX))
      if( FD.tick != null )
         if( FD.IsBack == false )

            Parametr = 1; /*Покупка\Продажа*/

         else
            if( FD.BuySale == DEAL_TYPE_BUY )
               Parametr = 305; /*обратный выкуп*/
            else
               Parametr = 304; /*обратная продажа*/
            end;
         end;
      end; 

   elif( (ObjectID == OBJTYPE_DEALKINDFORVARD) AND (Classificator == LLCLASS_DEALKINDFORVARD) )
      if( FD.tick != null )
         Parametr = FD.ВидСрочностиСделки(); 
      end;

   elif( (ObjectID == OBJTYPE_SERVKIND) AND (Classificator == LLCLASS_SERVKIND_INNER) )
     // Parametr = 1;
     //bpv SPFirstDocContract
      if (StrUpr(GenClassName(FD)) == StrUpr("SPFirstDocContract"))/*ВУ перевод по субдоговорам*/
         if (ДоговорЕДП(null,FD.Contr.rec.id))
            Parametr = 7;
         elif (FD.Contr.rec.ServKind == PTSK_STOCKDL)
             Parametr = 1;
          elif (FD.Contr.rec.ServKind == 15) // срочный
             Parametr = 3;
          elif (FD.Contr.rec.ServKind == 21) // валютный
             Parametr = 6;
          else
             Parametr = 1;
          end;
      else
         if (StrUpr( GenClassName( FD )) == StrUpr("SPFirstDoc"))
            if ( (ДоговорЕДП(null,FD.tick.rec.clientcontrid)) and FI_IsCurrency(GetCatCurrency(FD, FD.GetCatCode)))
               Parametr = 7;
            else
               Parametr = 1;
            end;
         else
            Parametr = 1;
         end;
      end;
   /*вид дохода (процентный/дисконтный)*/
   elif( (ObjectID == OBJTYPE_KIND_ACCOUNT_SECUR) AND (Classificator == LLCLASS_KIND_ACC_PDD) )      

      if ((FIRole == FIROLE_PD_TP  ) or
          (FIRole == FIROLE_PD_PPR ) or
          (FIRole == FIROLE_PD_TP_BPP  ) or
          (FIRole == FIROLE_PD_PPR_BPP ) or
          (FIRole == FIROLE_PD_PUDP) or
          (FIRole == FIROLE_PD_PUDP_BPP) or
          (FIRole == FIROLE_PD_PDO)
         )
         Parametr = 1; /*процентный*/

      elif ((FIRole == FIROLE_DD_TP  ) or
            (FIRole == FIROLE_DD_PPR ) or
            (FIRole == FIROLE_DD_TP_BPP  ) or
            (FIRole == FIROLE_DD_PPR_BPP ) or
            (FIRole == FIROLE_DD_PUDP) or
            (FIRole == FIROLE_DD_PUDP_BPP) or
            (FIRole == FIROLE_DD_PDO)
           )
         Parametr = 2; /*дисконтный*/

      elif ((FIRole == FIROLE_BONUS_TP  ) or
            (FIRole == FIROLE_BONUS_PPR ) or
            (FIRole == FIROLE_BONUS_TP_BPP  ) or
            (FIRole == FIROLE_BONUS_PPR_BPP ) or
            (FIRole == FIROLE_BONUS_PUDP) or
            (FIRole == FIROLE_BONUS_PUDP_BPP)
           )
         Parametr = 10; /*премия*/

      elif ((FIRole == FIROLE_BONUS_TP_PAID ) or
            (FIRole == FIROLE_BONUS_PPR_PAID ) or
            (FIRole == FIROLE_BONUS_TP_BPP_PAID ) or
            (FIRole == FIROLE_BONUS_PPR_BPP_PAID ) or
            (FIRole == FIROLE_BONUS_PUDP_PAID ) or
            (FIRole == FIROLE_BONUS_PUDP_BPP_PAID )
           )
         Parametr = 6; /*уплаченная премия*/

      end;

   elif( (ObjectID == OBJTYPE_IST_DOH_RASH) AND (Classificator == LLCLASS_KIND_COURCE_DIF) )
      if( ((FIRole == FIROLE_OVERVALUE_REQ) or
           (FIRole == FIROLE_OVERVALUE_COM)) and
           (FIID   != NATCUR) )
         Parametr = 1;
      else
         Parametr = 3;
      end;

   /*Вид счета расчетов*/
   elif( (ObjectID == OBJTYPE_KIND_ACCOUNT_CALC) AND (Classificator == LLCLASS_KIND_ACC_IN_FUTURES) )
      if( FD.IsBack )
         Parametr = 2;
      else
         Parametr = 1;
      end;

   /*признак передачи без прекращения признания*/
   elif( (ObjectID == OBJTYPE_BOOLEAN) AND (Classificator == LLCLASS_IS_AVOIR_BPP) )      
      if( (FIRole == FIROLE_PD_TP_BPP) or
          (FIRole == FIROLE_DD_TP_BPP) or
          (FIRole == FIROLE_BONUS_TP_BPP) or
          (FIRole == FIROLE_BONUS_TP_BPP_PAID) or
          (FIRole == FIROLE_PD_PPR_BPP) or
          (FIRole == FIROLE_DD_PPR_BPP) or
          (FIRole == FIROLE_BONUS_PPR_BPP) or
          (FIRole == FIROLE_BONUS_PPR_BPP_PAID) or
          (FIRole == FIROLE_PD_PUDP_BPP) or
          (FIRole == FIROLE_DD_PUDP_BPP) or
          (FIRole == FIROLE_BONUS_PUDP_BPP) or
          (FIRole == FIROLE_BONUS_PUDP_BPP_PAID) or
          (FIRole == FIROLE_BA_SSSD_BPP) or
          (FIRole == FIROLE_BA_SSSD_BPP_OVERDUE) or
          (FIRole == FIROLE_BA_SSPU_BPP) or
          (FIRole == FIROLE_BA_SSPU_BPP_OVERDUE) or
          (FIRole == FIROLE_BA_ASCB_BPP) or
          (FIRole == FIROLE_BA_ASCB_BPP_OVERDUE) or
          (FIRole == FIROLE_BA_CONTR_BPP) or
          (FIRole == FIROLE_BA_CONTR_BPP_OVERDUE)
        )
         Parametr = 1;
      else
         Parametr = 0;
      end;

   elif( (ObjectID == OBJTYPE_SIDEBALANCE) AND (Classificator == LLCLASS_SIDEBALANCE_CORACCKIND) )
      if( (FIRole == FIROLE_CA) OR (FIRole == FIROLE_CORACC_ACTIVE) )
         Parametr = 1;/*актив*/
      else
         Parametr = 2;
      end;
   
   elif( (ObjectID == OBJTYPE_KIND_TO) AND (Classificator == LLCLASS_KIND_TO) )
      if ((FIRole == FIROLE_EMIT_INC_TR) or (FIRole == FIROLE_EMIT_INC_OB))
         Parametr = 1;
      else
         Parametr = 0;
      end;

   elif( (ObjectID == OBJTYPE_IST_DOH_RASH) AND (Classificator == LLCLASS_KIND_MARG_FUTURES) )
      Parametr = 6;
   elif( (ObjectID == OBJTYPE_DEALSTATE) AND (Classificator == LLCLASS_KIND_DEAL_DELAY) )
      
      if( (FIRole == FIROLE_BA_TP_OVERDUE) or
          (FIRole == FIROLE_BA_PPR_OVERDUE) or
          (FIRole == FIROLE_BA_CONTR_OVERDUE) or
          (FIRole == FIROLE_BA_PUDP_OVERDUE) or
          (FIRole == FIROLE_BA_OVERDUE) or
          (FIRole == FIROLE_BA_SSSD_BPP_OVERDUE) or
          (FIRole == FIROLE_BA_SSPU_BPP_OVERDUE) or
          (FIRole == FIROLE_BA_ASCB_BPP_OVERDUE) or
          (FIRole == FIROLE_BA_CONTR_BPP_OVERDUE) 
        )
         Parametr = 1;
      else
         Parametr = 2;
      end;

   /*Категория заемщика - категория заемщика*/
   elif((ObjectID == OBJTYPE_CATEGZAEM) AND (Classificator == LLCLASS_CATEGZAEM_ZAEM))
       Parametr = GetCategZaemByParty( Contragent );

   /*Происхождение средств (собственные/клиентские)*/
   elif( (ObjectID == OBJTYPE_MONEYSOURCE) AND (Classificator == LLCLASS_MONEYSOURCE) )      
      if( (FIRole == FIROLE_MONEYSOURCE_TRUST) or (FIRole == FIROLE_ORCB_OTHCLIRACC_TRUST) )/*ДУ*/
         Parametr = ALG_SP_MONEY_SOURCE_TRUST;
      elif( (FIRole == FIROLE_MONEYSOURCE_CLIENT) or (FIRole == FIROLE_ORCB_OTHCLIRACC_CLIENT) )/*клиентские*/
         Parametr = ALG_SP_MONEY_SOURCE_CLIENT;
      else/*собственные*/
         if( FD.tick != NULL )
            if( IsClientDeal(FD.tick.rec))
               Parametr = ALG_SP_MONEY_SOURCE_CLIENT;
            else
               Parametr = ALG_SP_MONEY_SOURCE_OWN;
            end;
         else
         Parametr = ALG_SP_MONEY_SOURCE_OWN;
      end;
      end;

   /*Возможность надежного определения ТСС - Признак возможности определения ТСС*/
   elif( (ObjectID == OBJTYPE_SECUR_TSS) AND  (Classificator == LLCLASS_SECUR_TSS) )
      /*определим, долевая(акции, деп\расписки и паи) или нет*/
      if( ДолеваяЦБ(FIID,FIRole) )/*долевая*/
         /*если передали роль FIROLE_BA_PPR_TSS_YES, значит нужен счет с признаком ТСС*/
         if( FIRole == FIROLE_BA_PPR_TSS_YES )
            Parametr = 1;
         /*если передали роль FIROLE_BA_PPR_TSS_NO, значит нужен счет без признака ТСС*/
         elif( FIRole == FIROLE_BA_PPR_TSS_NO )
            Parametr = 0;
         /*если роль ни FIROLE_BA_PPR_TSS_NO и ни FIROLE_BA_PPR_TSS_YES, значит открываем по шаблону в зависимости от наличия признака ТСС за дату*/
         elif( (FIRole == FIROLE_BA_PPR) or (FIRole == FIROLE_BA) or (FIRole == FIROLE_BA_BACK) )
            if( ExistNOSS( FD.avoiriss, OperDate ) == true )
               Parametr = 1;
            else
               Parametr = 0;
            end;
         else
            Parametr = -1;
         end;
      else
         Parametr = -1;
      end;

   elif( (ObjectID == OBJTYPE_PARAM_OFR) AND (Classificator == LLCLASS_PARAM_OFR) )
      Parametr = 1;
    /*  */
   elif( (ObjectID == OBJTYPE_DIVID_EXPIRED) and (Classificator == LLCLASS_DIVID_EXPIRED) )
       if ( FiRole == FIROLE_DEALS_OVERDUE ) /*Просрочка */  
           Parametr = 1;
       else
           Parametr = 0;
       end;

   elif( (ObjectID == OBJTYPE_KINDDEPOPAY) and (Classificator == LLCLASS_KINDDEPOPAY) )
        Parametr = 1;
   
   elif( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
      Parametr = 3; /*Ценная бумага*/
      if(FI_IsBIO(FD.ID)) 
        Parametr = 4; /*Драг металл для первой реализации БИО*/
      end;
   elif( (ObjectID == OBJTYPE_KIND_OPER_DV) AND (Classificator == LLCLASS_KIND_DV) )
      Parametr = 2;//Форвард
      if(FI_IsBIO(FD.ID)) 
        Parametr = 3; /*Опцион для БИО*/
      end;
   elif( ( ObjectID == OBJTYPE_KINDDVOPER ) AND ( Classificator == LLCLASS_KINDCB_DVOPER ) )
      Parametr = 2;// для внебиржевых операций с ПИ    
   elif( ( Classificator == 5024 ) )
      var _sql,_cmd,_rs;
      _sql = "select * from davrserv_dbt where t_fiid = ? and t_taxagent = chr(88)";
      _cmd = RSDCommand(_sql);
      _cmd.AddParam("",rsdbp_in, FIID);
      _rs = RSDRecordset(_cmd, rsdval_client, rsdval_static);

      if (_rs.MoveNext())
        Parametr = 2   
      else
        Parametr = 1;  
      end;

   elif( Classificator == 5021 ) // Golovkin для единого пула
      if( FIID == NATCUR)
        Parametr = 0;
      else
        Parametr = 1;
      end;
   elif((ObjectID == OBJTYPE_KINDMARKETOPCL) AND(Classificator == LLCLASS_KINDMARKETOPCL))

      if(FiRole == FIROLE_OPCL_MOEX_NAT)
        Parametr = 17;
      elif(FiRole == FIROLE_OPCL_MOEX_FRG)
        Parametr = 18;
      elif(FiRole == FIROLE_OPCL_SPB_NAT) 
        Parametr = 19;
      elif(FiRole == FIROLE_OPCL_SPB_FRG)
        Parametr = 20;
      end; 
   elif((ObjectID == OBJTYPE_SUBOWNBOND_DRAWKIND) AND(Classificator == LLCLASS_SUBOWNBOND_DRAWKIND))
      Parametr = 1; //Срок погашения установлен
      if((FIID >= 0) AND (ПолучитьФинИн(FIID, fin, avr) == 0) AND (avr.rec.Termless == SET_CHAR))
        Parametr = 2; //Срок погашения НЕ установлен
      end;
   elif( (ObjectID == OBJTYPE_POOLKSU) AND (Classificator == LLCLASS_POOLKSU) )
      var pool_code = FD.GetPoolCode();
          
      if(pool_code == "10")
         Parametr = 10;
      elif(pool_code == "11")
         Parametr = 11;
      elif(pool_code == "12")
         Parametr = 12;
      elif(pool_code == "13")
         Parametr = 13;
      end;
   elif ((ObjectID==OBJTYPE_PAYMTYPE))
     if (Classificator == LLCLASS_OUT_SECURITIES)
       if (FD.GetParmForCateg24828("-Эмиссия, ОЭБ") == "02")
         Parametr = 9;
       else
         Parametr = 8;
       end;
     end;
   end;

 

   return Parametr;
END;
