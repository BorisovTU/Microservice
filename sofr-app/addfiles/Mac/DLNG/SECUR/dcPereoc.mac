/*****************************************************************************/ 
/*                                                           R-Style Softlab */ 
/*                                                                           */ 
/*               Данные по ценам, применяемым для переоценки ценных бумаг    */
/*                        на конец отчетного периода.                        */
/*                                                                           */ 
/*  Create : Punyaev D.V.                                                    */ 
/*  Date   : 05.08.2019                                                      */ 
/*****************************************************************************/ 

import RsbFormsInter, Global, or_rep_h, "DLReport_h.mac";

PRIVATE CLASS (DL_CReportTemplate) Report_dcPereoc(_BegDate:Date, _EndDate:Date)
   private var BegDate = _BegDate, EndDate = _EndDate;

   macro PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
   end;

   macro BeginReport()
   end;

   macro Create()
      var SQL, cmd, rs;
      var ExistData = true;
      var num = 0;

      SetActiveSheet("Данные по ценам, применяемым _1");
      PrintFormatString(NULL, "За период: " + string(BegDate:f) +  " - "+ string(EndDate:f));

      RegisterTable("N1_MainTable", NULL,
                    "N1_FI_Kind",
                    "N1_FI_Code",
                    "N1_FI_Name",
                    "N1_ISIN",
                    "N1_LSIN",
                    "N1_Date",
                    "N1_Sum");

      InitProgress(-1, "Отбор данных", "Отбор данных");
      SQL ="  SELECT knd.t_name nam1 /*Вид цб*/,                                         "+
           "         t_fi_code ficod /*Код*/,                                                 "+
           "         fi.t_name  namv /*Наименование выпуска*/,                                "+
           "         avr.t_isin isin /*ISIN*/,                                                "+
           "        nvl(avr.t_lsin,0) lsin /*Номер гос.регистрации*/,                         "+
           "        nvl (TO_CHAR (                                                            "+
           "            (CASE                                                                 "+
           "                WHEN s_ratedate (fi.t_fiid,                                       "+
           "                                 1,                                               "+
           "                                 :dateend1 )                                      "+
           "                        IS NOT NULL                                               "+
           "                THEN                                                              "+
           "                   s_ratedate (fi.t_fiid,                                         "+
           "                               1,                                                 "+
           "                               :dateend2 )                                        "+
           "                ELSE                                                              "+
           "                   NULL                                                           "+
           "             END),                                                                "+
           "            'dd.mm.yyyy'),0) dat                                                  "+
           "            /*Дата котировки*/,                                                   "+
           "        nvl((CASE                                                                 "+
           "             WHEN s_rate (fi.t_fiid, 1, :dateend3 ) >                             "+
           "                     0                                                            "+
           "             THEN                                                                 "+
           "                s_rate (fi.t_fiid, 1, :dateend4 )                                 "+
           "             ELSE                                                                 "+
           "                NULL                                                              "+
           "          END),0) zn,                                                             "+
           "            /*Значение котировки (для облигаций в процентах от номинала)*/        "+
           "        count(1) over() as t_Count                                                "+
           "    FROM davoiriss_dbt avr, dfininstr_dbt fi, davrkinds_dbt knd                   "+
           "   WHERE avr.t_fiid = fi.t_fiid AND fi.t_avoirkind = knd.t_avoirkind              "+
           "         AND fi.t_fiid IN                                                         "+
           "                (SELECT TK.T_PFI                                                  "+
           "                   FROM ddl_tick_dbt tk                                           "+
           "                  WHERE t_dealdate >  :datebeg2                                   "+
           "                        AND t_bofficekind = 101)                                  "+
           "         AND fi.t_avoirkind = knd.t_avoirkind                                     "+
           "         AND knd.t_fi_kind = 2                                                    "+
           "         AND fi.t_fiid IN                                                         "+
           "                (SELECT TK.T_PFI                                                  "+
           "                   FROM ddl_tick_dbt tk                                           "+
           "                  WHERE t_dealdate > :datebeg2                                    "+
           "                        AND t_bofficekind = 101)                                  "+
           "ORDER BY 2                                                                        ";

      cmd = RSDCommand(SQL);
      cmd.AddParam("dateend1", RSDBP_IN, EndDate);
      cmd.AddParam("dateend2", RSDBP_IN, EndDate);
      cmd.AddParam("dateend3", RSDBP_IN, EndDate);
      cmd.AddParam("dateend4", RSDBP_IN, EndDate);
      cmd.AddParam("datebeg1", RSDBP_IN, BegDate);
      cmd.AddParam("datebeg2", RSDBP_IN, BegDate);

      rs = RSDRecordset(cmd);

      if(rs.MoveNext())
         RemProgress();

         InitProgress(Int(rs.value("t_Count")), "Печать отчета", "Печать отчета");
         while(ExistData)

            PrintTableLine("N1_FI_Kind", string(rs.value("nam1")), NULL,
                           "N1_FI_Code", string(rs.value("ficod")), NULL,
                           "N1_FI_Name", string(rs.value("namv")), NULL,
                           "N1_ISIN", string(rs.value("isin")), NULL,
                           "N1_LSIN", string(rs.value("lsin")), NULL,
                           "N1_Date", string(date(rs.value("dat")):f), NULL,
                           "N1_Sum", string(rs.value("zn"):0:2), NULL);

            UseProgress(num = num + 1);
            ExistData = rs.MoveNext();
         end;
         RemProgress();
      else
         RemProgress();
      end;

      EndTable();
   end;

   macro EndReport()
   end;

   InitDL_CReportTemplate(NULL, "Report_dcPereoc.xlsx", true, false, NULL, true, false, NULL);
END;

CLASS (TRsbPanel) Pan
    initTRsbPanel();


    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;
    const EndCalcDate_ID = 2;
    var curstr = 1;
    Caption = "Данные по ценам, применяемым для переоценки ценных бумаг на конец отчетного периода.";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, EndCalcDate, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    EndCalcDate = TRsbEditField(V_DATE);
    EndCalcDate.setPosition(27,curstr);
    EndCalcDate.setSize(8,1);
    EndCalcDate.name = "endincalcdate";
    EndCalcDate.value = {curdate};
    addControl(EndCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr," За период:");
    addLabel (m_LabelCD);

    var m_LabelT:TrsbLabel = TRsbLabel(25,curstr,"~");
    addLabel (m_LabelT);
 
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));


    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if ((ev.id == BeginCalcDate_ID) or (ev.id == EndCalcDate_ID ))
            BeginCalcDate.value = GetDateByCalendar({CurDate});
//            EndCalcDate.value   = BeginCalcDate.value + Delta;
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
//            EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
  //       EndCalcDate.value   = BeginCalcDate.value + Delta;
        
         var myRep = Report_dcPereoc(BeginCalcDate.value, EndCalcDate.value);
         myRep.run;
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);
