/*
$Name:        sp_carsacc.mac
$Module:      Ценные бумаги
$Description: Функции для проводок в операциях продажи ценных бумаг
*/
IMPORT "sp_caracc.mac", "sp_cars.mac", "sp_catac.mac", "sp_carrl.mac", "sp_carcmacc.mac","insdpdr.mac", "scservop.mac";

MACRO БУ_УчетБалансовойСтоимостиБумагПриПродаже( FD, Dп, _chapter )
  
  var CatDeb:string = "", CatCred:string = "",
      FIRoleDeb:integer = NULL, FIRoleCred:integer = NULL,
      PayFIID = FD.GetPayFIID(), RetSumma, pmNKD,
      dS = $0, СуммаУчетаВБалансе_ВР = $0, СуммаСделкиНаДатуУчета_ВЦ = $0, СуммаСделкиНаДатуПоставки_ВР = $0, 
      Dу;  /* дата учета */

  var chapter:integer = 1;
  var Cred_FIID = NULL, CredSum = NULL;
  var CFIDeb = false, CFICred = false;
  var BaseSum = $0;
  var Ground = "";
  PRIVATE VAR fininstr = TRecHandler( "fininstr" );

  if( _chapter != null )
     chapter = _chapter;
  end;

  if( FD.tick.rec.BofficeKind != DL_RETIREMENT ) 
    Dу = FD.DateArray[DATE_DEALBEGINEXEC];
  else 
    Dу = FD.DateArray[DATE_DEALSETAVOIRISS];
  end; 

  if( FD.Kind != DL_TRUSTDOC )
     if( not ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_DELIVERY)) ) 
        if( FD.IsOperLoan == true ) /*для займов*/
           CatDeb = "ОД";
        else
           CatDeb = "-Форвард, расчеты";
        end;
     else
        CatDeb = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
     end; 

     CatCred = "Реализация, ц/б";

     FIRoleDeb = FIRoleCred = NULL;

     Cred_FIID = NATCUR;

     if( FD.dl_leg.rec.CFI == PayFIID )
        CFIDeb = true;
     end;
    
     if(FD.dl_leg.rec.CFI == Cred_FIID)
        CFICred = true;
     end;

  /*сделки с ц/б ДУ*/
  else
     CatDeb    =  "-Расчеты, ДУ";
     FIRoleDeb =  FIROLE_FICOM;
     CatCred   =  "-Расчеты, ДУ";
     FIRoleCred=  FIROLE_BA;
     Cred_FIID = FD.FaceFIID;
  end;

  if( FD.ExistRqMoney == true )
     BaseSum = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.Amount;
     if(FD.ExistAvance)
       BaseSum = BaseSum + FD.GetRQ(DLRQ_TYPE_AVANCE).rec.Amount;
     elif(FD.ExistDeposit)
       BaseSum = BaseSum + FD.GetRQ(DLRQ_TYPE_DEPOSIT).rec.Amount;
     end;

     /*отконвертить сумму базовых сумм платежей аванса/задатка и контрактива из ВЦ в ВР по курсу даты учета*/
     if( SmartConvertSum( СуммаУчетаВБалансе_ВР, BaseSum, Dу, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayFIID, true ) != true )
        return 1;
     end;    

     if( CFICred )
        CredSum = BaseSum;
     end;

     /*  Получаем сумму сделки на дату учета (сумма которая ставится на баланс).      */
     if( ПолучитьЦеновыеУсловияСделки( FD.tick, Dу-1, FD.IsBack, null, null, null, СуммаСделкиНаДатуУчета_ВЦ ) == false )
        return 1;
     end; 

     if( СуммаСделкиНаДатуУчета_ВЦ != FD.dl_leg.rec.TotalCost )

        /*был пересчет параметров сделки при изменении сроков уже после постановки сделки на баланс*/
        if( SmartConvertSum( СуммаСделкиНаДатуПоставки_ВР, FD.dl_leg.rec.TotalCost, Dп, FD.dl_leg.rec.CFI, PayFIID, true ) != true )
           return 1;
        end;    

        dS = СуммаУчетаВБалансе_ВР - СуммаСделкиНаДатуПоставки_ВР;
        СуммаУчетаВБалансе_ВР = СуммаСделкиНаДатуПоставки_ВР;

        if( CFICred )
           CredSum = FD.dl_leg.rec.TotalCost;
        end;

        if( dS > 0 )
           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                CatDeb, "Прочие доходы", /* Деб, КатегКредит*/
                                                Dп,                      /* Дата */
                                                chapter,                 /* Глава */
                                                PayFIID,                 /* Валюта */
                                                ABS(dS),                 /* Сумма дебет*/
                                                INPCARRY,                /* Result_Carry */
                                                " 1",                    /* Kind_Oper */
                                                FD.tick.rec.DealCode,    /* Numb_Document */
                                                "Учет доходов от изменения сроков поставки после постановки сделки на баланс" /* Ground */
                                              )
           )
               return 1;
           end;
        elif( dS < 0 )
           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                "Прочие расходы", CatDeb, /* Деб, КатегКредит*/
                                                Dп,                       /* Дата */
                                                chapter,                  /* Глава */
                                                null,                     /* Валюта */
                                                null,                     /* Сумма дебет*/
                                                INPCARRY,                 /* Result_Carry */
                                                " 1",                     /* Kind_Oper */
                                                FD.tick.rec.DealCode,     /* Numb_Document */
                                                "Учет расходов от изменения сроков поставки после постановки сделки на баланс", /* Ground */
                                                null, 
                                                null, null,
                                                NATCUR, PayFIID,
                                                PayFIID, ABS(dS)
                                              )
           )
               return 1;
           end;
        end;
     end;
  else
     RetSumma = FD.dl_leg.rec.TotalCost;
     if( FD.IsOperLoan == true ) /*для займов*/
        /*если в сделке не установлен признак возврата доходов или не было возврата доходов 
          по купонам, то dl_leg.TotalCost, иначе dl_leg.Cost*/
        pmNKD = Trechandler( "pmpaym.dbt" ); /* платеж НКД*/
        if( FindPayment( null, INi, 0, FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, true, pmNKD ) == 0 )
           RetSumma = FD.dl_leg.rec.Cost;
        else
           RetSumma = FD.dl_leg.rec.TotalCost;
        end;
     end;

     if( SmartConvertSum( СуммаУчетаВБалансе_ВР, RetSumma, Dп, FD.dl_leg.rec.CFI, PayFIID, true ) != true )
        return 1;
     end;    

     if( CFICred )
        CredSum = RetSumma;
     end;
  end;

  if( CFICred )
    СуммаУчетаВБалансе_ВР = null;
  end;


  if( FD.ВедетсяБалансУчетПоСделке() OR (FD.BuySale == DEAL_TYPE_SALE) )
     
     ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
     Ground = "Расчеты по обязательствам по поставке ценных бумаг при продаже " + " по сделке № "+ UserGetDealCode(FD) + ". Контрагент "  + UserGetPartyShortName(FD.tick.rec.partyid);/*20.11.19 RAS 499656*/
     //Ground = "Расчеты по обязательствам по поставке ценных бумаг при продаже. Контрагент "  + UserGetPartyShortName(FD.tick.rec.partyid); /*PDV 493705*/

     if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           CatDeb, CatCred,       /* Деб, КатегКредит*/
                                           Dп,                    /* Дата */
                                           chapter,               /* Глава */
                                           PayFIID,               /* Валюта */
                                           СуммаУчетаВБалансе_ВР, /* Сумма */
                                           INPCARRY,              /* Result_Carry */
                                           " 1",                  /* Kind_Oper */
                                           FD.tick.rec.DealCode,  /* Numb_Document */
                                           Ground/*"Исполнение обязательств по поставке ц/б"*/, /* Ground */
                                           null, FIRoleDeb, FIRoleCred,
                                           PayFIID, Cred_FIID,
                                           Cred_FIID, CredSum
                                         )
       )
        return 1;
     end;
  end;

  return 0; 
END;

MACRO БУ_УчетКорректировкиССвРЕПО( FD, dat )
  var CatDeb = "", CatCred = "";

  if( (not IsREPO(FD.Group)) or IsClientDeal(FD.tick.rec) or FD.IsBack )
     return 0; 
  end;

  if( (Get_Deal_ObservedBaselineDataAttrID(FD.tick.rec.DealID) == 1) and FD.IsExistWrtSumCurr() and (FD.pmwrtsum_curr().rec.CORRVALUE != 0) )
    if( FD.pmwrtsum_curr().rec.CORRVALUE > 0 )
       if( IsSALE(FD.Group) )
          CatDeb = "+Корр, ПРепо";
          CatCred = "+Дох, ПривлСр";
       else
          CatDeb = "+Корр, ОРепо";
          CatCred = "+Дох, РазмещСр";
       end;
       if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             CatDeb, CatCred,       /* Деб, КатегКредит*/
                                             dat,                    /* Дата */
                                             1,               /* Глава */
                                             NATCUR,               /* Валюта */
                                             FD.pmwrtsum_curr().rec.CORRVALUE, /* Сумма */
                                             INPCARRY,              /* Result_Carry */
                                             " 1",                  /* Kind_Oper */
                                             FD.tick.rec.DealCode,  /* Numb_Document */
                                             "Корректировка СС"     /* Ground */
                                           )
         )
          return 1;
       end;
    else
       if( IsSALE(FD.Group) )
          CatDeb = "-Расх, ПривлСр";
          CatCred = "-Корр, ПРепо";
       else
          CatDeb = "-Расх, РазмещСр";
          CatCred = "-Корр, ОРепо";
       end;
       if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             CatDeb, CatCred,       /* Деб, КатегКредит*/
                                             dat,                    /* Дата */
                                             1,               /* Глава */
                                             NATCUR,               /* Валюта */
                                             abs(FD.pmwrtsum_curr().rec.CORRVALUE), /* Сумма */
                                             INPCARRY,              /* Result_Carry */
                                             " 1",                  /* Kind_Oper */
                                             FD.tick.rec.DealCode,  /* Numb_Document */
                                             "Корректировка СС"     /* Ground */
                                           )
         )
          return 1;
       end;
    end;
  end;

  return 0; 
END;

private record acnt_ov_negative(account);
private record acnt_ov_positive(account);
private record acnt_dk_negative(account);
private record acnt_dk_positive(account);

private macro CarryError( deal, Acc1, Acc2 )
   if( SC_GetCarryError() != "" )
      SayErrorBuySale( deal, SC_GetCarryError() );
   else
      SayErrorBuySale( deal, "Ошибка при выполении проводки по категориям \"" + Acc1 + "\" - \"" + Acc2 + "\"");
   end;
   return false;
end;

/* Делаем проводки по оплате ц/б (без просрочки) при продаже.
   Платеж по контрактиву должен быть актуализирован, счет контрагента заполнен.
   Если по собственной сделке ведется балансовый учет, то делаем проводку
   на счёт категории "+Форвард, расчеты", иначе на счет категории
   "Реализация, ц/б". Если клиентская сделка, то делаем проводку на счет
   клиента.
   Возвращаем false в случае ошибки.
      FD          -  SPFirstDoc по сделке
      ChangeDate  -  дата изменения */
macro БУ_СделатьПроводкиПоОплате_БезПросрочки_ПриПродаже( FD, ChangeDate )

   if( БУ_ОбработатьТОПоОплате( FD, ChangeDate ) != 0 )
      return 1;
   end;

   return 0;
end;

MACRO БУ_ВыполнитьПереоценкуПриПродаже (FD, Group:INTEGER, OverAmountAdd:MONEY, CarDate:DATE):BOOL 
    private record CheckAcc(account);
    private record OverAcc(account);
    private record PosOvervlAcc( account );
    private record NegOvervlAcc( account );
    private record PODK( account );
    var  SumOnOvervlPos = $0, SumOnOvervlNeg = $0;
    var FIRole = -1;
    var DebAccNumber = "", CredAccNumber = "";
    var accTrnData = RsbAccTransactionData;
    var Mode, ModePODK;
    var OverMain = $0, OverRen = $0;
    var OverSum = $0, CheckSum = $0, ResultSum = $0;
    var DebCat, CredCat, OverDeb, OverCred, ChecAccCat;
    var СпецСчетПереоценки = IIF(Group == KINDPORT_SSPU, true, ПарностьСчетовПереоценки()); //Для ССПУ всегда используем счет с постфикском ССПУ_ЦБ. Для СССД по настройке парности
    var МинусПереоценкаЦБ:string = IIF(СпецСчетПереоценки==true, IIF(Group == KINDPORT_SSPU, "-Переоценка, ц/б ССПУ_ЦБ", "-Переоценка, ц/б СССД_ЦБ"), "-Переоценка, ц/б");
    var ПлюсПереоценкаЦБ:string  = IIF(СпецСчетПереоценки==true, IIF(Group == KINDPORT_SSPU, "+Переоценка, ц/б ССПУ_ЦБ", "+Переоценка, ц/б СССД_ЦБ"), "+Переоценка, ц/б");
    var МинусМаржаПОДК:string    = IIF(Group == KINDPORT_SSPU, "-МаржаП, ц/б",  "-ПО ДК 2014"  );
    var ПлюсМаржаПОДК:string     = IIF(Group == KINDPORT_SSPU, "+МаржаП, ц/б",  "+ПО ДК 2014"  );
    var ValueKind;
    var groundP = ""; 
    if ( (OverAmountAdd == NULL) OR (OverAmountAdd == 0) ) 
       return true;
    elif (OverAmountAdd > 0)
       DebCat  = ПлюсПереоценкаЦБ;
       CredCat = ПлюсМаржаПОДК;
       OverDeb = МинусПереоценкаЦБ;
       ValueKind = IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_MINUSTP, DL_VALUE_KIND_MINUSPPR);
       OverCred = IIF(Group == KINDPORT_TRADE, ПлюсМаржаПОДК, МинусМаржаПОДК);
    else
       DebCat  = МинусМаржаПОДК;
       CredCat = МинусПереоценкаЦБ;
       OverDeb = IIF(Group == KINDPORT_TRADE, МинусМаржаПОДК, ПлюсМаржаПОДК);
       OverCred = ПлюсПереоценкаЦБ;
       ValueKind = IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_PLUSTP, DL_VALUE_KIND_PLUSPPR);
    end;

    if (OverAmountAdd > 0)
      ChecAccCat = OverDeb;
    else
      ChecAccCat = OverCred;
    end;
    if( FD.IsExistAccount( ChecAccCat, null, true, null, OverAcc, null, CarDate, NATCUR ) )
      //OverSum = money(GetRestAccount(OverAcc, CarDate) );
OverSum = ПроводкиБУ.GetOverRegistrValue(ValueKind, CarDate, OverAcc.Account);
    end;
    if( Group == KINDPORT_TRADE )
       FIRole = FIROLE_BA_TP;
    elif( Group == KINDPORT_SALE )
       FIRole = FIROLE_BA_PPR;
    end;

    if( FD.ActualAccount(IIF(СпецСчетПереоценки==true, IIF(Group == KINDPORT_SSPU, "+Переоценка, ц/б ССПУ_ЦБ", "+Переоценка, ц/б СССД_ЦБ"), "+Переоценка, ц/б"),
                         null, true, FIRole, PosOvervlAcc, CarDate, null, null, MC_PAIRACCMODE_MANUAL) )
       //SumOnOvervlPos = GetRestAccount( PosOvervlAcc, CarDate );
SumOnOvervlPos = ПроводкиБУ.GetOverRegistrValue(IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_PLUSTP, DL_VALUE_KIND_PLUSPPR), CarDate, PosOvervlAcc.Account);

    end;
    
    if( FD.ActualAccount(IIF(СпецСчетПереоценки==true, IIF(Group == KINDPORT_SSPU, "-Переоценка, ц/б ССПУ_ЦБ", "-Переоценка, ц/б СССД_ЦБ"), "-Переоценка, ц/б"),
                         null, true, FIRole, NegOvervlAcc, CarDate, null, null, MC_PAIRACCMODE_MANUAL) )
       //SumOnOvervlNeg = GetRestAccount( NegOvervlAcc, CarDate );
SumOnOvervlNeg = ПроводкиБУ.GetOverRegistrValue(IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_MINUSTP, DL_VALUE_KIND_MINUSPPR), CarDate, NegOvervlAcc.Account);
    end;                                                                                                                                    
    if( (SumOnOvervlPos != 0 ) and (OverAmountAdd < 0 ) )
      OverSum =  SumOnOvervlPos;
    elif((SumOnOvervlNeg != 0 ) and (OverAmountAdd > 0 ))
      OverSum =  SumOnOvervlNeg;
    end;
    if(Group == KINDPORT_SSPU)
      if( OverAmountAdd > 0 )
        if((OverSum != 0) and ( ABS(OverAmountAdd) <= ABS(OverSum)))
          Mode = USED_MINUSTP_DEBET;
        else
          Mode = USED_PLUSTP_DEBET;
        end;
      else
        if((OverSum != 0) and ( ABS(OverAmountAdd) <= ABS(OverSum)))
          Mode = USED_PLUSTP_CREDIT;          
        else
          Mode = USED_MINUSTP_CREDIT;
        end;
      end;
    else
      if( OverAmountAdd > 0 )
        if((OverSum != 0) and ( ABS(OverAmountAdd) <= ABS(OverSum)))
          Mode = USED_MINUSPPR_DEBET;
          ModePODK = USED_MINUSDK_CREDIT;
        else
          Mode = USED_PLUSPPR_DEBET;
          ModePODK = USED_PLUSDK_CREDIT;
        end;
      else
        if((OverSum != 0) and ( ABS(OverAmountAdd) <= ABS(OverSum)))
          Mode = USED_PLUSPPR_CREDIT;
          ModePODK = USED_PLUSDK_DEBET;
        else
          Mode = USED_MINUSPPR_CREDIT;
          ModePODK = USED_MINUSDK_DEBET;
        end;
      end;
    end;
    ResultSum = OverAmountAdd;
    GroundP = "Переоценка ценной бумаги " + GetFinName(FD.fininstr.rec) + " при выбытии по сделке продажи " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
    if ( (Group == KINDPORT_SSPU) or ( (Group == KINDPORT_SSSD) and (not ПарностьСчетовПереоценки() ) )  )
       if ( (OverSum != 0) and ( ABS(OverAmountAdd) <= ABS(OverSum)) )
          DebCat = OverDeb;
          CredCat = OverCred;
       elif ( (OverSum != 0) and ( ABS(OverAmountAdd) > ABS(OverSum)) )

          if(not БУ_ПроводкаПоКатегориямУчета( FD, 
              OverDeb, OverCred,           /* КатегДеб , КатегКредит*/
              CarDate,                     /* Дата */
              1,                           /* Глава */
              NATCUR,                      /* Валюта */
              abs(OverSum),                /* Сумма переоценки*/
              INPCARRY,                    /* Result_Carry */
              " 1",                        /* Kind_Oper */
              "",                          /* Numb_Document */
              GroundP/*"Переоценка ц/б"*/,
              IIF((Group == KINDPORT_SSPU), IIF (OverAmountAdd > 0, USED_MINUSTP_DEBET, USED_PLUSTP_CREDIT ) , IIF(OverAmountAdd > 0, USED_MINUSPPR_DEBET, USED_PLUSPPR_CREDIT)),
              FIRole,
              FIRole                                             ) 
            )
               return false;
           end;
           if(Group == KINDPORT_SSSD)

             accTrnData.FIIDPayer       = NATCUR;
             accTrnData.FIIDReceiver    = NATCUR;
             accTrnData.SumPayer        = 0 ; //abs(OverSum);
             accTrnData.SumReceiver     = 0 ; //abs(OverSum);
             accTrnData.Date_Carry      = CarDate;
             ПроводкиБУ.AddRegValOver(IIF(OverAmountAdd > 0, USED_MINUSDK_CREDIT, USED_PLUSDK_DEBET), accTrnData);
           end;

           ResultSum = abs(OverAmountAdd) - ABS(OverSum);  
       end;

       if(not БУ_ПроводкаПоКатегориямУчета( FD, 
           DebCat, CredCat,             /* КатегДеб , КатегКредит*/
           CarDate,                     /* Дата */
           1,                           /* Глава */
           NATCUR,                      /* Валюта */
           abs(ResultSum),              /* Сумма переоценки*/
           INPCARRY,                    /* Result_Carry */
           " 1",                        /* Kind_Oper */
           "",                          /* Numb_Document */
           GroundP/*"Переоценка ц/б"*/,
           Mode,
           FIRole,
           FIRole
                                           ) 
          )
            return false;
       end; 

       if(Group == KINDPORT_SSSD)
             
             accTrnData.FIIDPayer       = NATCUR;
             accTrnData.FIIDReceiver    = NATCUR;
             accTrnData.SumPayer        = abs(ResultSum);
             accTrnData.SumReceiver     = abs(ResultSum);
             accTrnData.Date_Carry      = CarDate;
             ПроводкиБУ.AddRegValOver(ModePODK, accTrnData);
       end; 
    else
       if (OverAmountAdd > 0)
         ChecAccCat = DebCat;
         OverMain = SumOnOvervlPos;
         OverRen  = SumOnOvervlNeg;

ValueKind = IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_PLUSTP, DL_VALUE_KIND_PLUSPPR);
       else
         ChecAccCat = CredCat;
         OverMain = SumOnOvervlNeg;
         OverRen  = SumOnOvervlPos;

ValueKind = IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_MINUSTP, DL_VALUE_KIND_MINUSPPR);
       end;
       if( FD.IsExistAccount( ChecAccCat, null, true, null, CheckAcc, null, CarDate, NATCUR ) )
         //CheckSum = money(GetRestAccount(CheckAcc, CarDate) );
         CheckSum = ПроводкиБУ.GetOverRegistrValue(ValueKind, CarDate, CheckAcc.Account);
       end;
       if ( ((OverMain == 0) and (OverRen == 0)) or (OverMain != 0) )

           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
              DebCat, CredCat,             /* КатегДеб , КатегКредит*/
              CarDate,                     /* Дата */
              1,                           /* Глава */
              NATCUR,                      /* Валюта */
              abs(ResultSum),              /* Сумма переоценки*/
              INPCARRY,                    /* Result_Carry */
              " 1",                        /* Kind_Oper */
              "",                          /* Numb_Document */
              GroundP/*"Переоценка ц/б"*/,
              IIF(OverAmountAdd > 0, USED_PLUSPPR_DEBET, USED_MINUSPPR_CREDIT ),
              FIRole,
              FIRole
                                             ) 
            )
               return false;
           end; 
           ModePODK = IIF(OverAmountAdd > 0, USED_PLUSDK_CREDIT, USED_MINUSDK_DEBET );

       else
           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
              OverDeb, OverCred,           /* КатегДеб , КатегКредит*/
              CarDate,                     /* Дата */
              1,                           /* Глава */
              NATCUR,                      /* Валюта */
              abs(ResultSum),              /* Сумма переоценки*/
              INPCARRY,                    /* Result_Carry */
              " 1",                        /* Kind_Oper */
              "",                          /* Numb_Document */
              GroundP/*"Переоценка ц/б"*/,
              IIF(OverAmountAdd > 0, USED_MINUSPPR_DEBET, USED_PLUSPPR_CREDIT ),
              FIRole,
              FIRole
                                             ) 
            )
               return false;
           end; 
           ModePODK = IIF(OverAmountAdd > 0, USED_MINUSDK_CREDIT, USED_PLUSDK_DEBET );

       end;    

       accTrnData.FIIDPayer       = NATCUR;
       accTrnData.FIIDReceiver    = NATCUR;
       accTrnData.SumPayer        = abs(ResultSum);
       accTrnData.SumReceiver     = abs(ResultSum);
       accTrnData.Date_Carry      = CarDate;
       ПроводкиБУ.AddRegValOver(ModePODK, accTrnData);
    end;
    return true;
END;

MACRO БУ_ВыполнитьСписаниеПереоценки( FD, Group:INTEGER, Sпрц:MONEY, CarDate:DATE ):BOOL

  private record CheckAcc(account);
  
  VAR Sпол_ост = $0, Sотр_ост = $0, CheckSumProfit = $0, CheckSumLoss = $0;
    VAR sum_dk_negative = $0, sum_dk_positive = $0;
  var ProfitLossCateg = "";
  var СпецСчетПереоценки = IIF(Group == KINDPORT_SSPU, true, ПарностьСчетовПереоценки()); //Для ССПУ всегда используем счет с постфикском ССПУ_ЦБ. Для СССД по настройке парности
  var МинусПереоценкаЦБ:string = IIF(СпецСчетПереоценки==true, IIF(Group == KINDPORT_SSPU, "-Переоценка, ц/б ССПУ_ЦБ", "-Переоценка, ц/б СССД_ЦБ"), "-Переоценка, ц/б");
  var ПлюсПереоценкаЦБ:string  = IIF(СпецСчетПереоценки==true, IIF(Group == KINDPORT_SSPU, "+Переоценка, ц/б ССПУ_ЦБ", "+Переоценка, ц/б СССД_ЦБ"), "+Переоценка, ц/б");
  var МинусПОДК:string = "-ПО ДК 2014";
  var ПлюсПОДК:string  = "+ПО ДК 2014";
  var СпособСписания = 1; //10801 или 10901 в зависимости от остатка
  var ErrCode = 0;
  
  if( (Sпрц == null) OR (Sпрц == 0) )
     return true;
  end;

  GetRegistryValue( "SECUR\\МСФО\\СПИС. ПЕРЕОЦ. ДОЛ. ЦБ ПРИ ВЫБ.", V_INTEGER, СпособСписания, ErrCode );
  if ( (ErrCode != 0) OR ((СпособСписания != 1) AND (СпособСписания != 2)))
     СпособСписания = 1;
  end;

  var Ground = "";
  PRIVATE VAR fininstr = TRecHandler( "fininstr" );

  /*остаток на счете категории "-Переоценка"*/
  if( FD.IsExistAccount( МинусПереоценкаЦБ, null, true, GetFIRoleByPortfolio( Group ), acnt_ov_negative, MC_PAIRACCMODE_MANUAL, CarDate ))
     Sотр_ост = ABS( ПроводкиБУ.GetOverRegistrValue(IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_MINUSTP, DL_VALUE_KIND_MINUSPPR), CarDate, acnt_ov_negative.Account) );
  end;

  /*остаток на счете категории "+Переоценка"*/
  if( FD.IsExistAccount( ПлюсПереоценкаЦБ, null, true, GetFIRoleByPortfolio( Group ), acnt_ov_positive, MC_PAIRACCMODE_MANUAL, CarDate ) )
     Sпол_ост = ABS( ПроводкиБУ.GetOverRegistrValue(IIF((Group == KINDPORT_SSPU), DL_VALUE_KIND_PLUSTP, DL_VALUE_KIND_PLUSPPR), CarDate, acnt_ov_positive.Account) );
  end;
   
    if(Group == KINDPORT_SSPU)
       if(Sпол_ост > 0)
          if(Sпрц > 0)
             Ground = "Списание положительной переоценки по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;

             if(not БУ_ПроводкаПоКатегориямУчета( FD,
                                                  "Реализация, ц/б", ПлюсПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  NATCUR,                      /* Валюта */
                                                  ABS(Min(Sпрц,Sпол_ост)),     /* Сумма  */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  Ground/*"Списание положительной переоценки"*/,
                                                  USED_PLUSTP_CREDIT,
                                                  null,
                                                  GetFIRoleByPortfolio( Group ),
                                                  null, null, null, null, null, null, null, null, null, null, null,
                                                  null, null
                                                )
               )
                 return false;
             end;

             if(Sпрц > Sпол_ост)
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                    "Реализация, ц/б", МинусПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                                    CarDate,                     /* Дата */
                                                    1,                           /* Глава */
                                                    NATCUR,                      /* Валюта */
                                                    Sпрц-Sпол_ост,               /* Сумма  */
                                                    INPCARRY,                    /* Result_Carry */
                                                    " 1",                        /* Kind_Oper */
                                                    "",                          /* Numb_Document */
                                                    Ground/*"Списание положительной переоценки"*/,
                                                    USED_MINUSTP_CREDIT,
                                                    null,
                                                    GetFIRoleByPortfolio( Group ),
                                                    null, null, null, null, null, null, null, null, null, null, null,
                                                    null, null
                                                  )
                 )
                   return false;
               end;
             end;

          elif(Sпрц < 0)
             Ground = "Списание отрицательной переоценки по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;

             if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             ПлюсПереоценкаЦБ, "Реализация, ц/б",/* КатегДеб , КатегКредит*/
                                                CarDate,                     /* Дата */
                                                1,                           /* Глава */
                                                NATCUR,                      /* Валюта */
                                                abs(Sпрц),                   /* Сумма  */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                "",                          /* Numb_Document */
                                                Ground/*"Списание отрицательной переоценки"*/,
                                                USED_PLUSTP_DEBET,
                                                GetFIRoleByPortfolio( Group ), null,
                                                null, null, null, null, null, null, null, null, null, null, null,
                                                null, null
                                              )
               )
                return false;
             end;
          end;

       elif( Sотр_ост > 0 )
          if(Sпрц > 0)
             Ground = "Списание положительной переоценки по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;

              if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                   "Реализация, ц/б", МинусПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                                   CarDate,                     /* Дата */
                                                   1,                           /* Глава */
                                                   NATCUR,                      /* Валюта */
                                                   Sпрц,                        /* Сумма  */
                                                   INPCARRY,                    /* Result_Carry */
                                                   " 1",                         /* Kind_Oper */
                                                   "",                          /* Numb_Document */
                                                   Ground/*"Списание положительной переоценки"*/,
                                                   USED_MINUSTP_CREDIT,
                                                   null,
                                                   GetFIRoleByPortfolio( Group ),
                                                   null, null, null, null, null, null, null, null, null, null, null,
                                                   null, null
                                                 )
                )
                  return false;
              end;
          elif(Sпрц < 0)
             Ground = "Списание отрицательной переоценки по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;

             if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                  МинусПереоценкаЦБ, "Реализация, ц/б",/* КатегДеб , КатегКредит*/
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  NATCUR,                      /* Валюта */
                                                  Min( Abs(Sпрц), Sотр_ост ),  /* Сумма  */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  Ground/*"Списание отрицательной переоценки"*/,
                                                  USED_MINUSTP_DEBET,
                                                  GetFIRoleByPortfolio( Group ), null,
                                                  null, null, null, null, null, null, null, null, null, null, null,
                                                  null, null
                                                 ) 
               )
                 return false;
             end;

             if( abs(Sпрц) > Sотр_ост)
                Ground = "Списание отрицательной переоценки по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;

                if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     ПлюсПереоценкаЦБ, "Реализация, ц/б",/* КатегДеб , КатегКредит*/
                                                     CarDate,                     /* Дата */
                                                     1,                           /* Глава */
                                                     NATCUR,                      /* Валюта */
                                                     abs(Sпрц)- Sотр_ост,         /* Сумма  */
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Списание отрицательной переоценки"*/,
                                                     USED_PLUSTP_DEBET,
                                                     GetFIRoleByPortfolio( Group ), null,
                                                     null, null, null, null, null, null, null, null, null, null, null,
                                                     null, null
                                                   )
                  )
                    return false;
                end;
             end;
          end;
    end;

  elif(Group == KINDPORT_SSSD)
    if(Sпрц > 0)
      Ground = "Списание положительной переоценки по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;

      if(not БУ_ПроводкаПоКатегориямУчета( FD,
                                           "Реализация, ц/б", ПлюсПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                             CarDate,                     /* Дата */
                                             1,                           /* Глава */
                                             NATCUR,                      /* Валюта */
                                           ABS(Min(Sпрц,Sпол_ост)),     /* Сумма  */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             Ground/*"Списание положительной переоценки"*/,
                                             USED_PLUSPPR_CREDIT,
                                             null,
                                             GetFIRoleByPortfolio( Group ),
                                             null, null, null, null, null, null, null, null, null, null, null,
                                               null, null
                                           )
             )
               return false;
           end;

      if(СпособСписания == 2)
        ProfitLossCateg = "Нераспределенная прибыль";
      else
      if( FD.IsExistAccount( "Нераспределенная прибыль", null, true, null, CheckAcc, null, CarDate ) )
         CheckSumProfit = money(GetRestAccount(CheckAcc, CarDate) );
      end;
      if( FD.IsExistAccount( "Непокрытый убыток", null, true, null, CheckAcc, null, CarDate ) )
           CheckSumLoss = abs(money(GetRestAccount(CheckAcc, CarDate) ));
      end;
      ProfitLossCateg = IIF( ( (CheckSumProfit > 0) or ( (CheckSumProfit == 0) and (CheckSumLoss == 0) ) ), "Нераспределенная прибыль", "Непокрытый убыток" );
      end;

      if(FD.IsExistAccount( ПлюсПОДК, null, true, null, acnt_dk_positive, MC_PAIRACCMODE_MANUAL, CarDate ))  

         sum_dk_positive = ПроводкиБУ.GetOverRegistrValue(DL_VALUE_KIND_PLUSDK, CarDate, acnt_dk_positive.Account);
         if( sum_dk_positive != 0 )
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                 acnt_dk_positive, /* КатегДеб*/
                                                 IIF( FI_IsBond(FD.GetBaseFIID()), "+Маржа, ц/б", ProfitLossCateg), /*КатегКредит*/
                                                 CarDate,                     /* Дата */
                                                 1,                           /* Глава */
                                                 NATCUR,                      /* Валюта */
                                                 ABS( Min(Sпрц,Sпол_ост) ),   /* Сумма  */
                                                 INPCARRY,                    /* Result_Carry */
                                                 " 1",                        /* Kind_Oper */
                                                 "",                          /* Numb_Document */
                                                 Ground/*"Списание положительной переоценки"*/,
                                                 USED_PLUSDK_DEBET,
                                                 null,
                                                 GetFIRoleByPortfolio( Group )
                                               )
              )
                return false;
            end;
         end;
      end;

      if(Sпрц > Sпол_ост)
           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                              "Реализация, ц/б", МинусПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                                CarDate,                     /* Дата */
                                                1,                           /* Глава */
                                                NATCUR,                      /* Валюта */
                                              Sпрц-Sпол_ост,               /* Сумма  */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                "",                          /* Numb_Document */
                                                Ground/*"Списание положительной переоценки"*/,
                                                USED_MINUSPPR_CREDIT,
                                                null,
                                                GetFIRoleByPortfolio( Group ),
                                                null, null, null, null, null, null, null, null, null, null, null,
                                                null, null
                                               ) 
             )
               return false;
           end;

           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           МинусПОДК, IIF( FI_IsBond(FD.GetBaseFIID()), "+Маржа, ц/б", ProfitLossCateg),/* КатегДеб , КатегКредит*/
                                                CarDate,                     /* Дата */
                                                1,                           /* Глава */
                                                NATCUR,                      /* Валюта */
                                                Sпрц-Sпол_ост,               /* Сумма  */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                "",                          /* Numb_Document */
                                                Ground/*"Списание положительной переоценки"*/,
                                                USED_MINUSDK_DEBET,
                                                null, GetFIRoleByPortfolio( Group ), null, null, null, null, null, null, null, null, null, null, null,
                                                null, null
                                               ) 
             )
               return false;
           end;
      end;

    elif(Sпрц < 0)
      Ground = "Списание отрицательной переоценки по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             МинусПереоценкаЦБ, "Реализация, ц/б",/* КатегДеб , КатегКредит*/
                                             CarDate,                     /* Дата */
                                             1,                           /* Глава */
                                             NATCUR,                      /* Валюта */
                                             Min( Abs(Sпрц), Sотр_ост ),  /* Сумма  */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             Ground/*"Списание отрицательной переоценки1"*/,
                                             USED_MINUSPPR_DEBET,
                                             GetFIRoleByPortfolio( Group ), null,
                                             null, null, null, null, null, null, null, null, null, null, null,
                                             null, null
                                            ) 
          )
            return false;
        end;

      if(СпособСписания == 2)
        ProfitLossCateg = "Непокрытый убыток";
      else
     if( FD.IsExistAccount( "Нераспределенная прибыль", null, true, null, CheckAcc, null, CarDate, NATCUR ) )
        CheckSumProfit = money(GetRestAccount(CheckAcc, CarDate) );
     end;
     if( FD.IsExistAccount( "Непокрытый убыток", null, true, null, CheckAcc, null, CarDate, NATCUR ) )
           CheckSumLoss = abs(money(GetRestAccount(CheckAcc, CarDate) ));
     end;
     ProfitLossCateg = IIF( ( (CheckSumLoss > 0) or ( (CheckSumProfit == 0) and (CheckSumLoss == 0) ) ), "Непокрытый убыток", "Нераспределенная прибыль" );
      end;
     
      if(FD.IsExistAccount( МинусПОДК, null, true, null, acnt_dk_negative, MC_PAIRACCMODE_MANUAL, CarDate ) )
        sum_dk_negative = ПроводкиБУ.GetOverRegistrValue(DL_VALUE_KIND_MINUSDK, CarDate, acnt_dk_negative.Account);
        if( sum_dk_negative != 0 )
           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                IIF( FI_IsBond(FD.GetBaseFIID()), "-Маржа, ц/б", ProfitLossCateg), acnt_dk_negative,/* КатегДеб , КатегКредит*/
                                                CarDate,                     /* Дата */
                                                1,                           /* Глава */
                                                NATCUR,                      /* Валюта */
                                                 Min( Abs(Sпрц), Sотр_ост ),  /* Сумма */
                                                INPCARRY,                    /* Result_Carry */
                                                " 1",                        /* Kind_Oper */
                                                "",                          /* Numb_Document */
                                                Ground/*"Списание отрицательной переоценки"*/,
                                                USED_MINUSDK_CREDIT,
                                                GetFIRoleByPortfolio( Group )
                                              )
             )
               return false;
           end;
        end;
     end;

      if( abs(Sпрц) > Sотр_ост)
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             ПлюсПереоценкаЦБ, "Реализация, ц/б",/* КатегДеб , КатегКредит*/
                                             CarDate,                     /* Дата */
                                             1,                           /* Глава */
                                             NATCUR,                      /* Валюта */
                                              abs(Sпрц)- Sотр_ост,         /* Сумма  */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             Ground/*"Списание отрицательной переоценки"*/,
                                              USED_PLUSPPR_DEBET,
                                             GetFIRoleByPortfolio( Group ), null,
                                             null, null, null, null, null, null, null, null, null, null, null,
                                             null, null
                                           )
          )
            return false;
        end;

           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             IIF( FI_IsBond(FD.GetBaseFIID()), "-Маржа, ц/б", ProfitLossCateg), ПлюсПОДК,/* КатегДеб , КатегКредит*/
                                             CarDate,                     /* Дата */
                                             1,                           /* Глава */
                                             NATCUR,                      /* Валюта */
                                           abs(Sпрц)- Sотр_ост,         /* Сумма */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             Ground/*"Списание отрицательной переоценки"*/,
                                             USED_PLUSDK_CREDIT,
                                             GetFIRoleByPortfolio( Group ), null, null, null, null, null, null, null, null, null, null, null, null,
                                             null, null
                                              )
             )
               return false;
           end;
        end;
     end;
  end;

  return true;
END;

private macro СвойЛотБылПроданПРЕПО(SumID:integer, //Лот продаже 2ч ОРЕПО
                                    IsAfter:bool //true, если 2ч ПРЕПО исполняется после 2ч ОРЕПО, false, если не позже
                                   )
  var cmd, query;
  
  query =   " SELECT 1 "
          + "   FROM DPMWRTLNK_DBT Lnk, DPMWRTSUM_DBT Sale2, DPMWRTSUM_DBT Sale "
          + "  WHERE Sale2.t_SumID = ? "
          + "    AND Lnk.t_BuyID = Sale2.t_Parent "
          + "    AND Sale.t_SumID = Lnk.t_SaleID "
          + "    AND Sale.t_Source = 0 ";

  if(IsAfter)
    query = query + "    AND Sale2.t_Date < NVL((SELECT MIN(Buy2.t_Date) FROM DPMWRTSUM_DBT Buy2 WHERE Buy2.t_Parent = Lnk.t_SaleID), "+GetSQLDate(date(0,0,0))+")";
  else
    query = query + "    AND Sale2.t_Date >= (SELECT MIN(Buy2.t_Date) FROM DPMWRTSUM_DBT Buy2 WHERE Buy2.t_Parent = Lnk.t_SaleID)";
  end;

  cmd = DL_RSDCommand(query);
  cmd.AddParam(SumID);

  if(cmd.GetCount() > 0)
    return true;
  end;
    
  return false;
end;

private class SummFR( _Portofolio:integer )
  var Portofolio:integer = _Portofolio;
  var Amount:money = 0;
  var CostSum:money = 0;
  var InterestIncomeSum:money = 0;
  var DiscountIncomeSum:money = 0;
  var OverAmountBuy:money = 0;
  var CorrSum:money = 0;
  var ReservSum:money = 0;
end;

private macro AddCostSummFR( SummFRArr:TArray, Portofolio:integer, CostSum:money )
  var i = 0;
  while( i < SummFRArr.Size )
     if( SummFRArr[i].Portofolio == Portofolio )
        SummFRArr[i].CostSum = SummFRArr[i].CostSum + CostSum;
     end;
     i = i + 1;
  end;
end;

private macro DecAmountSummFR( SummFRArr:TArray, Portofolio:integer, Amount:money )
  var i = 0;
  while( i < SummFRArr.Size )
     if( SummFRArr[i].Portofolio == Portofolio )
        SummFRArr[i].Amount = SummFRArr[i].Amount - Amount;
     end;
     i = i + 1;
  end;
end;

private macro ОтнесениеФинРезультата( FD, FR, CarDate, Portofolio ):bool
  Var Ground = "";
  PRIVATE VAR fininstr = TRecHandler( "fininstr" );

  if( FR  > 0 )
     ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
     Ground = "Положительный финансовый результат по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;

     if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                           "Реализация, ц/б", "+Маржа, ц/б", /* КатегДеб, КатегКредит*/
                                           CarDate,                     /* Дата */
                                           1,                           /* Глава */
                                           NATCUR,                      /* Валюта */
                                           ABS(FR),                     /* Сумма */
                                           INPCARRY,                    /* Result_Carry */
                                           " 1",                        /* Kind_Oper */
                                           "",                          /* Numb_Document */
                                           Ground/*"Отнесение фин. результата на доходы"*/,
                                           null, 
                                           null,
                                           IIF((Portofolio == KINDPORT_BACK) or (Portofolio == KINDPORT_PROMISSORY), GetFIRoleByPortfolio(KINDPORT_SALE), GetFIRoleByPortfolio(Portofolio))
                                         )
       )
        return false;
     end;
  elif( FR  < 0 )
     Ground = "Отрицательный финансовый результат по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;

     if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                           "-Маржа, ц/б", "Реализация, ц/б", /* КатегДеб, КатегКредит*/
                                           CarDate,                     /* Дата */
                                           1,                           /* Глава */
                                           NATCUR,                      /* Валюта */
                                           ABS(FR),                     /* Сумма */
                                           INPCARRY,                    /* Result_Carry */
                                           " 1",                        /* Kind_Oper */
                                           "",                          /* Numb_Document */
                                           Ground/*"Отнесение фин. результата на расходы"*/,
                                           null, 
                                           IIF((Portofolio == KINDPORT_BACK) or (Portofolio == KINDPORT_PROMISSORY), GetFIRoleByPortfolio(KINDPORT_SALE), GetFIRoleByPortfolio(Portofolio)),
                                           null 
                                         )
       )
        return false;
     end;
  end;

  return true;
end;


PRIVATE MACRO СписатьКорректировкиХедж(FD, dat, SumCorr, IsAmortSum:bool)
  var CorrAcc = TRecHandler("account.dbt");
  var RestSumCorr = $0;
  var SumRest = $0;
  var q, c, ds;
  var cntHdi = 0;
  
  if(SumCorr != 0)
    SumRest = $0;

    q =   " select NVL(SUM(rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null)), 0) as SumRest, count(distinct hdr.t_ID) as CntHdi "
        + "   from dmccateg_dbt cat, dmcaccdoc_dbt accdoc, ddlhdgrelation_dbt hdr "
        + "  where cat.t_LevelType = 1 "
        + "    and cat.t_Code IN ('-Корректировка, ц/б_Хедж','+Корректировка, ц/б_Хедж') "
        + "    and accdoc.t_CatID = cat.t_ID "
        + "    and accdoc.t_FIID = ? "
        + "    and accdoc.t_DocKind = " + SP_AVRHDGRELATION
        + "    and rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null) <> 0"
        + "    and hdr.t_ID = accdoc.t_DocID "
        + "    and hdr.t_EndDate <= ? "
        + "    and "+IIF(IsAmortSum==false, "NOT", "")+" Exists(select 1 "
        + "                     from doproper_dbt opr, doprstep_dbt st "
        + "                    where opr.t_DocKind = " + DLDOC_ISSUE
        + "                      and opr.t_DocumentID = LPAD(to_char(accdoc.t_FIID), 34, '0') "
        + "                      and st.t_ID_Operation = opr.t_ID_Operation "
        + "                      and st.t_ServDocKind = " + SP_AMORTHEDGCORR
        + "                  )";

    c = DL_RSDCommand(q);

    c.AddParam(dat);
    c.AddParam(FD.fininstr.rec.FIID);
    c.AddParam(dat);
    c.AddParam(dat);
    
    ds = c.Execute();
    if(ds.moveNext())
      SumRest = money(ds.SumRest);
      cntHdi  = ds.CntHdi;
    end;

    if(abs(SumRest) < abs(SumCorr))
      msgbox("Сумма остатков на счетах корректировок хеджирования меньше суммы списания");
      return 1;
    end;

    RestSumCorr = abs(SumCorr);

    q =   " select hdr.t_ID, rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null) RestCorr "
        + "   from dmccateg_dbt cat, dmcaccdoc_dbt accdoc, ddlhdgrelation_dbt hdr "
        + "  where cat.t_LevelType = 1 "
        + "    and cat.t_Code IN ('-Корректировка, ц/б_Хедж','+Корректировка, ц/б_Хедж') "
        + "    and accdoc.t_CatID = cat.t_ID "
        + "    and accdoc.t_FIID = ? "
        + "    and accdoc.t_DocKind = " + SP_AVRHDGRELATION
        + "    and rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null) <> 0"
        + "    and hdr.t_ID = accdoc.t_DocID "
        + "    and hdr.t_EndDate <= ? "
        + "    and "+IIF(IsAmortSum==false, "NOT", "")+" Exists(select 1 "
        + "                     from doproper_dbt opr, doprstep_dbt st "
        + "                    where opr.t_DocKind = " + DLDOC_ISSUE
        + "                      and opr.t_DocumentID = LPAD(to_char(accdoc.t_FIID), 34, '0') "
        + "                      and st.t_ID_Operation = opr.t_ID_Operation "
        + "                      and st.t_ServDocKind = " + SP_AMORTHEDGCORR
        + "                  )";

    c = DL_RSDCommand(q);

    c.AddParam(dat);
    c.AddParam(FD.fininstr.rec.FIID);
    c.AddParam(dat);
    c.AddParam(dat);
    
    ds = c.Execute();
    
    var FDhdi = NULL;
    var CarrySum = $0;
    var i = 1;
    while(ds.moveNext())
      FDhdi = SP_AvrHdRelationFD(ds.ID);

      if(i == CntHdi)
        CarrySum = abs(RestSumCorr);
      else
        CarrySum = money(round((abs(SumCorr) * abs(ds.RestCorr)/abs(SumRest)), 2)); 
      end;
      
      if( (FDhdi.IsExistAccount("-Корректировка, ц/б_Хедж", null, true, NULL, CorrAcc, MC_PAIRACCMODE_MANUAL, dat)) and
        (abs(GetRestAccount(CorrAcc.rec, dat)) > 0) 
      )
        if(not БУ_ПроводкаПоКатегориямУчета( FDhdi, 
                                            CorrAcc, "Доходы_хедж, ПФИ",     /* КатегДеб, КатегКредит*/
                                            dat,                             /* Дата */
                                            1,                               /* Глава */
                                            NATCUR,                          /* Валюта */
                                            CarrySum,                        /* Сумма  */
                                            INPCARRY,                        /* Result_Carry */
                                            " 1",                            /* Kind_Oper */
                                            FD.tick.rec.DealCode,            /* Numb_Document */
                                            "Списание корректировок хеджирования",
                                            null,
                                            null,
                                            null,
                                            NATCUR, NATCUR  
                                          )
           )
          return 1;
        end;
      elif( (FDhdi.IsExistAccount("+Корректировка, ц/б_Хедж", null, true, NULL, CorrAcc, MC_PAIRACCMODE_MANUAL, dat)) and
            (abs(GetRestAccount(CorrAcc.rec, dat)) > 0) 
          )
        if(not БУ_ПроводкаПоКатегориямУчета( FDhdi, 
                                            "Расходы_хедж, ПФИ", CorrAcc,    /* КатегДеб, КатегКредит*/
                                            dat,                             /* Дата */
                                            1,                               /* Глава */
                                            NATCUR,                          /* Валюта */
                                            CarrySum,                        /* Сумма  */
                                            INPCARRY,                        /* Result_Carry */
                                            " 1",                            /* Kind_Oper */
                                            FD.tick.rec.DealCode,            /* Numb_Document */
                                            "Списание корректировок хеджирования",
                                            null,
                                            null,
                                            null,
                                            NATCUR, NATCUR  
                                          )
              )
          return 1;
        end;
      end;

      i = i + 1;

      RestSumCorr = RestSumCorr - CarrySum;
    end;
  end;

  return 0;
END;

private record CredCatAcc(account);
private record DebCatAcc(account);
private record CredCatAccBD(account);
private record DebCatAccBD(account);

MACRO БУ_СписаниеСебестоимостиПриПродаже( FD:SPFirstDoc, CarDate:DATE, IsCompensWrt:BOOL, GrDealID:integer ):BOOL
   var PmWrtSum = Trechandler( "pmwrtsum.dbt" );
   VAR i = 0, Groups = TArray(),
       AccCredit, FIIDCredit, AccDebet, FIIDDebet,
       FR = $0, CommSum = $0, CommSumFIID;
   VAR RSD, SQLQuery, FD_buy, RatePVO, FIRole;
   VAR DebCat, CredCat, DebCatBD, CarFIID, CarFIID2, CarSumm, CarSumm_od = $0, Capter, CarSummBD, TotalCost = $0, 
       Amount = $0, PreoutlayNotPVO, DVSSCost = $0, ForRestAcc = 0, WrtCostSum, RestoreSumm_od = $0, CarSummBD_Natcur = $0;
   var NeedThisTrnAcc = true;
   var SummFRArr = TArray();
   PRIVATE VAR fininstr = TRecHandler( "fininstr" );
   var Ground = "";

   VAR ALL_CostBuy             = $0, CostBuy             = $0, /* Списанная чистая стоимость (Счист) */
       ALL_BalanceCostBuy      = $0, BalanceCostBuy      = $0, /* Списанная текущая стоимость */
       ALL_NKDBuy              = $0, NKDBuy              = $0, /* НКД ( S(НКД упл.)) */
       ALL_InterestIncomeBuy   = $0, InterestIncomeBuy   = $0, /* Списанный начисленный ПД */
       ALL_DiscountIncomeBuy   = $0, DiscountIncomeBuy   = $0, /* Cписанный начисленный ДД */
       ALL_NotCarryInterestBuy = $0, NotCarryInterestBuy = $0, /* Списанный не отнесенный на доходы ПД */
       ALL_NotCarryDiscountBuy = $0, NotCarryDiscountBuy = $0, /* Списанный не отнесенный на доходы ДД */
       ALL_InterestIncomeAdd   = $0, InterestIncomeAdd   = $0, /* Доначисленный ПД S(Sдонач.ПДi) */
       ALL_DiscountIncomeAdd   = $0, DiscountIncomeAdd   = $0, /* Доначисленный ДД S(Sдонач.ДДi) */
       ALL_NotCarryInterestAdd = $0, NotCarryInterestAdd = $0, /* Доначисленный не отнесенный на доходы ПД */
       ALL_NotCarryDiscountAdd = $0, NotCarryDiscountAdd = $0, /* Доначисленный не отнесенный на доходы ДД */
                                     InterestIncomeSum   = $0, /* Суммарный начисленный ПД S(ПДначисл) */
                                     DiscountIncomeSum   = $0, /* Суммарный начисленный ДД S(ДДначисл) */
                                     NotCarryInterestSum = $0, /* Суммарный не отнесенный на доходы ПД  S(ПДне_отн) */
                                     NotCarryDiscountSum = $0, /* Суммарный не отнесенный на доходы ДД  S(ДДне_отн) */
       ALL_BalanceCostSum      = $0, BalanceCostSum      = $0, /* Суммарная текущая стоимость (Стек) */
       ALL_BalanceCostBD       = $0,                           /* Списанная стоимость в ОД (Часть остатка счета "- ОД", пропорциональная количеству ц/б, проданно-му из ТП и ППР) */
       ALL_OutlayBuy           = $0, OutlayBuy           = $0, /* Списанные затраты */
       OverAmountSum           = $0, OverAmountBuy       = $0, /* Списанная сумма переоценки S(ПО) */
       ReservAmountBuy         = $0,                           /* Списанная сумма резерва (Сумма созданного резерва) */
       ALL_AmountNotPVO        = $0, ALL_Amount          = $0,
       IncomeReservBuy         = $0,
       BonusAdd                = $0, NotWrtBonus         = $0,
                                     CostSum             = $0,
       CorrIntToEIRAdd         = $0, CorrIntToEIRSum     = $0, /*Добавленная и суммарная корректировки % до ЭСП*/
       ReservAmountAdd         = $0, IncomeReservAdd     = $0, /*Доначисленные резерв и резерв по ПДД*/
       ReservAmountSum         = $0, IncomeReservSum     = $0, /*Сумма списываемого резерва и резерва по ПДД*/
       EstReserveAdd           = $0, CorrEstReserveAdd   = $0, /*Доначисленные оценочный резерв и корректировка резерва*/
       EstReserveSum           = $0, CorrEstReserveSum   = $0, /*Суммарный списываемый оценочный резерв и его корректировка*/
       AccounttedDefDiffAdd    = $0,                           /*Доначисленная отсроченная разница*/
                                     OverAmountAdd       = $0, /*Доначисленная переоценка*/    
       CorrValueBuy            = $0,                           /*Списанная сумма корректировки СС*/
       HedgCorrSum             = $0, AmortHedgCorrSum    = $0;
   VAR BalanceCostBD = $0, CostSale = $0, SСпво = $0, SСакт = $0, BonusRest = $0, NKDRest = $0, NotWrtBonusBuy = $0, SumReservFR = $0;
   VAR err = 0, AccDebetFIRole, AccCreditFIRole;
   var Bpp = false;
   Var FDMGR;
   if( IsClientDeal(FD.tick.rec) )
      return true;
   end;

   if( IsCompensWrt )
      var Query = RSDCommand(" Select wrtsum.* " +
                             "   From dpmwrtsum_dbt wrtsum, ddlgrdoc_dbt doc " +
                             "  Where doc.t_grdealid   = ? " +
                             "    and doc.t_dockind    = ? " +
                             "    and doc.t_sourcetype = ? " +
                             "    and wrtsum.t_DocKind = ? " +
                             "    and wrtsum.t_DocID   = doc.t_docid " +
                             "  Order by t_PartNum ");

      Query.addParam( "", RSDBP_IN, GrDealID );
      Query.addParam( "", RSDBP_IN, DLDOC_PAYMENT );
      Query.addParam( "", RSDBP_IN, DLGR_SOURCETYPE_DLRQ );
      Query.addParam( "", RSDBP_IN, DLDOC_PAYMENT );
      Query.execute();

      var DataSet = TRsbDataSet(Query);
      if( DataSet.MoveNext() )
         DataSet.GetRecord().CopyTo(PmWrtSum.rec);
      else
         MsgBox("Не найден компенсационный лот");
         return false;
      end;
   else
      copy(PmWrtSum, FD.pmwrtsum);
   end;

   var UsingNewRepo = false;

   if( IsBUY(FD.Group) AND IsTwoPart(FD.Group) AND // ОРЕПО
       (GetSecurNewRepoDate() <= CarDate)       // если в режиме новых сделок РЕПО
     )
     UsingNewRepo = true;
   end;
   
   if( IsTwoPart(FD.Group) and (IsSALE(FD.Group) OR UsingNewRepo) )

      if(IsBUY(FD.Group))
        var q = "select t_DealID from dpmwrtsum_dbt where t_Source = ? ";
        var cmd2 = DL_RSDCommand(q);

        cmd2.AddParam(PmWrtSum.rec.SumID);

        DataSet = cmd2.Execute();

        while(DataSet.moveNext())
          var FD1s = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.rec.DealID );
          
          if( not БУ_ВыполнитьПроводкиПереводаНачисленногоДоходаВПрямомРЕПО(FD1s, CarDate, false, GrDealID) )
            return false;
          end;
        end;

      else
        if( not БУ_ВыполнитьПроводкиПереводаНачисленногоДоходаВПрямомРЕПО(FD, CarDate, false, GrDealID) )
           return false;
        end;
      end;
   end;

   ПолучитьГруппыСписания(FD, Groups);


   while( i < Groups.Size )

      AccDebet  = "Начисл.ПДД, ц/б";
      FIIDDebet = FD.FaceFIID();

      AccCredit  = "+%ДЦ/б";
      FIIDCredit = NATCUR;

      SummFRArr[i] = SummFR(Groups[i]);
      if( WRT_GetSaleFinResult_EX( PmWrtSum.rec.SumID, 
                                   Groups[i],
                                   0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   @OverAmountAdd      ,
                                   @OverAmountSum      ,
                                   @ReservAmountBuy    ,
                                   @ReservAmountAdd    ,
                                   @ReservAmountSum    ,
                                   @BalanceCostBD      ,
                                   @CostSale           ,
                                   NULL                ,
                                   @Amount             ,
                                   @IncomeReservBuy    ,
                                   @IncomeReservAdd    ,
                                   @IncomeReservSum    ,
                                   @BonusAdd           ,
                                   @CostSum            ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   @BonusRest          ,
                                   @NotWrtBonus        ,
                                   NULL,
                                   @AccounttedDefDiffAdd,
                                   NULL,
                                   @CorrValueBuy       ,
                                   NULL,
                                   @CorrIntToEIRAdd    ,
                                   @CorrIntToEIRSum    ,
                                   NULL,
                                   @EstReserveAdd      ,
                                   @EstReserveSum      ,
                                   NULL,
                                   @CorrEstReserveAdd  ,
                                   @CorrEstReserveSum  ,
                                   @HedgCorrSum        ,
                                   @AmortHedgCorrSum
                                 ) != true )
         return false;
      end;

      ALL_BalanceCostBuy      = ALL_BalanceCostBuy       + BalanceCostBuy     ;
      ALL_InterestIncomeBuy   = ALL_InterestIncomeBuy    + InterestIncomeBuy  ;
      ALL_DiscountIncomeBuy   = ALL_DiscountIncomeBuy    + DiscountIncomeBuy  ;
      ALL_NotCarryInterestBuy = ALL_NotCarryInterestBuy  + NotCarryInterestBuy;
      ALL_NotCarryDiscountBuy = ALL_NotCarryDiscountBuy  + NotCarryDiscountBuy;
      ALL_InterestIncomeAdd   = ALL_InterestIncomeAdd    + InterestIncomeAdd  ;
      ALL_DiscountIncomeAdd   = ALL_DiscountIncomeAdd    + DiscountIncomeAdd  ;
      ALL_NotCarryInterestAdd = ALL_NotCarryInterestAdd  + NotCarryInterestAdd;
      ALL_NotCarryDiscountAdd = ALL_NotCarryDiscountAdd  + NotCarryDiscountAdd;
      ALL_OutlayBuy           = ALL_OutlayBuy            + OutlayBuy          ;
      ALL_Amount              = ALL_Amount               + Amount;

      SummFRArr[i].Amount = SummFRArr[i].Amount + Amount;
      if( (Groups[i] == KINDPORT_SALE) or (Groups[i] == KINDPORT_TRADE) ) /*/*ППР*/*/
      SummFRArr[i].OverAmountBuy = SummFRArr[i].OverAmountBuy + OverAmountSUM ;
      end;

      SummFRArr[i].CorrSum = SummFRArr[i].CorrSum + CorrValueBuy + CorrIntToEIRSum;

      if( (Groups[i] != KINDPORT_BACK) AND (Groups[i] != KINDPORT_BACK_KSU)) /*не ПВО*/
         ALL_AmountNotPVO   = ALL_AmountNotPVO + Amount;
         ALL_BalanceCostSum = ALL_BalanceCostSum + BalanceCostSum;
      end;

ALL_BalanceCostBD  = ALL_BalanceCostBD  + BalanceCostBD;

      if (EstReserveAdd == 0)
         EstReserveAdd = CorrEstReserveAdd;
      end;
      if (EstReserveSum == 0)
        EstReserveSum = CorrEstReserveSum;
      end;
      CorrValueBuy = CorrValueBuy + CorrIntToEIRSum;

         if( (IsTwoPart(FD.Group) and IsBUY(FD.Group)) or
          (IsTwoPart(FD.Group) == false) )
       
         if( InterestIncomeAdd != 0 )
               // Ground = "";

              ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
              Ground = "Начисление купонного дохода по ЦБ " + GetFinName(fininstr.rec) + ", портфель " + Groups[i] + "-я категория, количество " + UserGetKol(Amount, fininstr.rec.avoirkind) + ".";

               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                                                     CarDate,                     /* Дата */
                                                     1,                           /* Глава */
                                                     FD.FaceFIID(),               /* Валюта */
                                                     InterestIncomeAdd,           /* Сумма Sдонач.ДДi*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Доначисление процентного дохода1"*/,
                                                     null,
                                                     GetFIRoleByPortfolio(Groups[i], false, true),
                                                     GetFIRoleByPortfolio(Groups[i], false, true),
                                                     FIIDDebet, FIIDCredit
                                                    ) 
                 )
                  return false;
               end;
            end;

         if( InterestIncomeSum != 0 )
           ПолучитьФинИн( FD.tick.rec.PFI, fininstr );

           Ground = "Списание ПКД по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;

               if( not БУ_ПроводкаПоКатегориямУчета( FD,
                      "Реализация, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                                                     CarDate,                     /* Дата */
                                                     1,                           /* Глава */
                                                     FD.FaceFIID(),               /* Валюта */
                                                     InterestIncomeSum,           /* Сумма  ПДначисл*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Списание процентного дохода1"*/,
                                                     null,
                                                     null,
                                                     GetFIRoleByPortfolio( Groups[i], false, true )
                                                   )
                 )
                  return false;
               end;
             /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
             if( SmartConvertSum( InterestIncomeSum, InterestIncomeSum, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                return false;
             end;                      
             SummFRArr[i].InterestIncomeSum = SummFRArr[i].InterestIncomeSum + InterestIncomeSum;
            end;

         if((Groups[i] == KINDPORT_TRADE) or
            (Groups[i] == KINDPORT_SALE ) or
            (Groups[i] == KINDPORT_UNADMITTED) or
            (Groups[i] == KINDPORT_RETIRE) ) /*Если списание из ССПУ_ЦБ, ССПД_ЦБ, БПП или АС_ЦБ*/
             
            if( DiscountIncomeAdd != 0 )
              Ground = "Начисление дисконтного дохода по ЦБ " + GetFinName(fininstr.rec) + ", портфель " + Groups[i] + "-я категория, количество " + UserGetKol(Amount, fininstr.rec.avoirkind) + ".";

               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     AccDebet, AccCredit,         /* КатегДеб, КатегКредит*/
                                                     CarDate,                     /* Дата */
                                                     1,                           /* Глава */
                                                     FD.FaceFIID(),               /* Валюта */
                                                     DiscountIncomeAdd,           /* Сумма  Sдонач.ДДi*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Доначисление дисконтного дохода"*/,
                                                     null,
                                                     GetFIRoleByPortfolio(Groups[i], true),
                                                     GetFIRoleByPortfolio(Groups[i], true),
                                                     FIIDDebet, FIIDCredit
                                                   )
                 )
                  return false;
               end;
            end;

            if( BonusAdd != 0 )
               /* ОР 2НБ1, продажа 1НБА */
              ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
              Ground = "Списание премии по ЦБ " + GetFinName(fininstr.rec) + ", портфель " + Groups[i] + "-я категория, количество " + UserGetKol(Amount, fininstr.rec.avoirkind) + ".";

               if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                     "-Премия, ц/б", "Премия, ц/б", /* КатегДеб, КатегКредит */
                                                     CarDate,                     /* Дата */
                                                     1,                                 /* Глава */
                                                     FD.FaceFIID(),               /* Валюта */
                                                     BonusAdd,                          /* Сумма */
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Списание начисленной премии на расходы1"*/,
                                                     null,
                                                     GetFIRoleByPortfolio(Groups[i], false, false, false, false, true),
                                                     GetFIRoleByPortfolioBonus(Groups[i])
                                                   )
                 )
                  return false;
               end;
            end;

            if( DiscountIncomeSum != 0 )
            Ground = "Списание дисконтного дохода по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;

               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      "Реализация, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      FD.FaceFIID(),               /* Валюта */
                      DiscountIncomeSum,           /* Сумма  ДДначисл*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      Ground/*"Списание дисконтного дохода"*/,
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i], true )
                     ) 
                 )
                   return false;
               end;
               /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
               if( SmartConvertSum( DiscountIncomeSum, DiscountIncomeSum, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                  return false;
               end;                      
               SummFRArr[i].DiscountIncomeSum = SummFRArr[i].DiscountIncomeSum + DiscountIncomeSum;
            end;
         end;

         if( CorrIntToEIRAdd != 0 ) 

//Ground = "";
              ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
              Ground = "Корректировка % до ЭПС по ЦБ " + GetFinName(fininstr.rec) + ", портфель " + Groups[i] + "-я категория, количество " + UserGetKol(Amount, fininstr.rec.avoirkind) + ".";

            AccDebet  = IIF(CorrIntToEIRAdd > 0, "+Корректировка, ц/б", "-КорЭПС_%, ц/б");
            AccCredit = IIF(CorrIntToEIRAdd > 0, "+КорЭПС_%, ц/б", "-Корректировка, ц/б");  
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   NATCUR,                      /* Валюта */
                   abs(CorrIntToEIRAdd),        /* Сумма корректировки до ЭПС*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   Ground/*"Корректировка % до ЭПС"*/,
                   null,
                   iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i])),
                   iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i]))
                  ) 
              )
                return false;
            end;            
         end;
         if( AccounttedDefDiffAdd != 0 )
            AccDebet  = IIF(AccounttedDefDiffAdd > 0, "-КорЭПС_%, ц/б", "-Маржа, ц/б");   
            AccCredit = IIF(AccounttedDefDiffAdd > 0, "+Маржа, ц/б", "+КорЭПС_%, ц/б"); 
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   NATCUR,                      /* Валюта */
                   abs(AccounttedDefDiffAdd),   /* Сумма корректировки до ЭПС*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Корректировка отсроченной разницы",
                   null,
                   iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i])),
                   iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i]))
                  ) 
              )
                return false;
            end;   
         end;
         if ( (Groups[i] == KINDPORT_SALE) or (Groups[i] == KINDPORT_TRADE) ) /*продажа лота из ССПУ_ЦБ или ССПД_ЦБ*/ 
            if (БУ_ВыполнитьПереоценкуПриПродаже(FD, Groups[i], OverAmountAdd, CarDate ) == false )
               return false;
            end;
         end;

         if( not (IsSALE(FD.Group) and IsTwoPart(FD.Group)) )
            if( (Groups[i] == KINDPORT_SALE) or (Groups[i] == KINDPORT_TRADE) ) /*продажа лота из ССПУ_ЦБ или ССПД_ЦБ*/ 
               if( БУ_ВыполнитьСписаниеПереоценки( FD, Groups[i], OverAmountSum, CarDate ) == false) 
                  return false;
               end;
            end;
         end;

         if(HedgCorrSum != 0)
           if(СписатьКорректировкиХедж(FD, CarDate, HedgCorrSum, false) != 0)
             return 1;
           end;
         end;

         if(AmortHedgCorrSum != 0)
           if(СписатьКорректировкиХедж(FD, CarDate, AmortHedgCorrSum, true) != 0)
             return 1;
           end;
         end;
      end;   

      if( not (IsSALE(FD.Group) and IsTwoPart(FD.Group)) )
         if (CorrValueBuy != 0)
         
            if(FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind)) // долговые
              AccDebet  = IIF( CorrValueBuy > 0, "Реализация, ц/б", "-Корректировка, ц/б" );
              AccCredit = IIF( CorrValueBuy > 0, "+Корректировка, ц/б", "Реализация, ц/б" );
            else                                 // долевые
              AccDebet  = IIF( CorrValueBuy > 0, "-Маржа, ц/б", "-Корректировка, ц/б" );
              AccCredit = IIF( CorrValueBuy > 0, "+Корректировка, ц/б", "+Маржа, ц/б" );
            end;
            ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
            Ground = "Списание корректировок по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;
         
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                         AccDebet, AccCredit,          /* КатегДеб , КатегКредит*/
                         CarDate,                         /* Дата */
                         1,                               /* Глава */
                         NATCUR,                          /* Валюта */
                         abs(CorrValueBuy),               /* Сумма  Счист*/
                         INPCARRY,                        /* Result_Carry */
                         " 1",                            /* Kind_Oper */
                         "",                              /* Numb_Document */
                         Ground/*"Списание корректировок1"*/,
                         null,
                         IIF((AccDebet=="Реализация, ц/б"),null,iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i]))),
                         IIF((AccCredit=="Реализация, ц/б"),null,iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i])))
                       ) 
                    )
                   return false;
             end;

/*    КД*/
                  //SummFRArr[i].CorrValueBuy = SummFRArr[i].CorrValueBuy + CorrValueBuy;
                 //AddCostSummFR(SummFRArr, Groups[i], abs(CorrValueBuy));
         end;
      end;   

      if( not (IsSALE(FD.Group) and IsTwoPart(FD.Group)) )
      if( БУ_СписаниеРезерваПоЦБ( FD, CarDate, Groups[i], ReservAmountSum, IncomeReservSum, EstReserveSum , @SumReservFR) == false )
         return false;
      end;
      end;
      SummFRArr[i].ReservSum = SummFRArr[i].ReservSum + SumReservFR; // сумма списаного резерва (на реализацию)
      i = i + 1;
   end;

   /*списание обязательств по обр. поставке своей сделки ОРЕПО. Проводка 2КА2*/
   if( IsTwoPart(FD.Group) and IsBUY(FD.Group) )
      
      var SaveBeforeProlong = FD.BeforeProlong;

      if(ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_DELIVERY)))
         DebCatBD = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
      else
         DebCatBD = IIF(IsBasket(FD.Group), "-ОД, Корзина", "-ОД");

         if( FD.БылоДосрочноеИсполнение() )
            FD.BeforeProlong = true; //чтобы взять существующий срочный счет
         end;
      end;

      ForRestAcc = 0;

      if( FD.IsExistAccount( DebCatBD, null, true, null, DebCatAccBD, null, CarDate, FD.FaceFIID() ) )
         if( IsCompensWrt )
            CarSumm_od = money( ALL_BalanceCostBD );
         else
            CarSumm_od = money( ALL_BalanceCostBD );
            /*учтем сумму восстановления ПВО*/
            var LastDateRestorePVO = date(0,0,0);
            RestoreSumm_od = БУ_ПолучитьПоследнююСумму( FD.tick.rec.BofficeKind, FD.tick.rec.DealID, DLSUM_KIND_SUM_RESTORE_PVO, LastDateRestorePVO );
            if( LastDateRestorePVO == CarDate )/*сумму берем только за дату CarDate*/
               CarSumm_od = CarSumm_od - RestoreSumm_od;
            end;
            ForRestAcc = 1;
         end;
         
         //if( CarSumm_od > 0 )
            ground = "Списание обязательств по возврату ц/б " + GetFinName(FD.fininstr.rec) + " по сделке РЕПО " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate; 
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   DebCatAccBD, "Реализация, ц/б",       /* КатегДеб , КатегКредит*/
                   CarDate,                        /* Дата */
                   1,                              /* Глава */
                   FD.FaceFIID(),                  /* Валюта */
                   money( IIF( (ForRestAcc == 1), $0, CarSumm_od )),            /* Сумма  Счист*/
                   INPCARRY,                       /* Result_Carry */
                   " 1",                           /* Kind_Oper */
                   "",                             /* Numb_Document */
                   ground/*"Списание обязательств по возврату ц/б"*/,
                   ForRestAcc,
                   null,
                   null,
                   FD.FaceFIID()
                  ) 
              )
                return false;
            end;
         //end;
      end;

      FD.BeforeProlong = SaveBeforeProlong;
   end;
   if(IsTwoPart(FD.Group) AND (not(IsSALE(FD.Group) AND (GetSecurNewRepoDate() <= CarDate))) and (not IsCompensWrt))  // Для ПРЕПО не нужна в новом БУ

     if( ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_DELIVERY)) )
        FIRole = FIROLE_BA_OVERDUE;
     else
        FIRole = FIROLE_BA;
     end;
/*KD*/ 

/*

        iF(FD.TICK.rec.dealdate < MGRDate)
           FDMGR = SpFirstDoc(FD.tick, false);
           FDMGR.IsExistAccount(IIF(IsBasket(FDMGR.Group), "Ц/б, Корзина БПП", "Ц/б, БПП"), null, true, GetFIRoleByPortfolio(KINDPORT_SALE, null, null, null, IsOverdue), CredAcc, null, dat)
        END;

*/    
   IF(FD.TICK.rec.dealdate < MGRDate)
       FDMGR = SpFirstDoc(FD.tick, false);
     if( FD.IsExistAccount( "ВнебалСчетКорресп", null, true, null, CredCatAcc, null, CarDate, NATCUR ) and
         FDMGR.IsExistAccount(IIF(IsBasket(FDMGR.Group), "Ц/б, Корзина ПВО", "Ц/б, ПВО"), null, true, FIRole, DebCatAcc, null, CarDate, FDMGR.FaceFIID()) 
       )
        Ground = "Списание стоимости заимствованных ЦБ " + GetFinName(FD.fininstr.rec) + " по сделке обратного РЕПО " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + " без первоначального признания с внебаланса при закрытии сделки РЕПО";                     
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            DebCatAcc, CredCatAcc,             /* КатегДеб , КатегКредит*/
            CarDate,                        /* Дата */
            3,                              /* Глава */
            FD.FaceFIID(),                  /* Валюта */
            $0,                             /* Сумма  Счист*/
            INPCARRY,                       /* Result_Carry */
            " 1",                           /* Kind_Oper */
            "",                             /* Numb_Document */
            Ground/*"Списание балансовой стоимости1"*/,
            GETRESTACC_DEBET,
            null,
            null,
            NULL, NULL 
           ) 
          )
            return false;
        end;
     end; 
   ELSE
     if( FD.IsExistAccount( "ВнебалСчетКорресп", null, true, null, CredCatAcc, null, CarDate, NATCUR ) and
         FD.IsExistAccount(IIF(IsBasket(FD.Group), "Ц/б, Корзина ПВО", "Ц/б, ПВО"), null, true, FIRole, DebCatAcc, null, CarDate, FD.FaceFIID()) 
       )
        Ground = "Списание стоимости заимствованных ЦБ " + GetFinName(FD.fininstr.rec) + " по сделке обратного РЕПО " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + " без первоначального признания с внебаланса при закрытии сделки РЕПО";                     
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            DebCatAcc, CredCatAcc,             /* КатегДеб , КатегКредит*/
            CarDate,                        /* Дата */
            3,                              /* Глава */
            FD.FaceFIID(),                  /* Валюта */
            $0,                             /* Сумма  Счист*/
            INPCARRY,                       /* Result_Carry */
            " 1",                           /* Kind_Oper */
            "",                             /* Numb_Document */
            Ground/*"Списание балансовой стоимости1"*/,
            GETRESTACC_DEBET,
            null,
            null,
            NULL, NULL 
           ) 
          )
            return false;
        end;
     end; 
   END;

   end;
 /* is :513287 
   query = "select NVL(sum((CASE WHEN buylot.t_Kind = "+PM_WRTSUM_KIND_RRWAB2+" THEN lnk.t_BalanceCostBD ELSE 0 END)), 0) BalanceCostBD "
           "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot " +
           " where buylot.t_SumID  = lnk.t_BuyID " +
           "   and lnk.t_SaleID = ? " +
           "   and buylot.t_Portfolio IN ("+KINDPORT_BACK+", "+KINDPORT_BACK_KSU+") "; 

   SQLQuery = DL_RSDCommand(query);

   SQLQuery.addParam(PmWrtSum.rec.SumID );
   RSD = SQLQuery.execute();
   if(RSD.MoveNext())
     if( SmartConvertSum( CarSummBD_Natcur, money(RSD.BalanceCostBD), CarDate, FD.FaceFIID(), NATCUR, true ) == false )
        return false;
     end;                      
     SСпво = SСпво + CarSummBD_Natcur;
   end; */
  
   query = "select buylot.t_DealID, buylot.t_Portfolio, NVL(sum(lnk.t_BalanceCostBuy), 0) t_BalanceCostBuy, NVL(sum(lnk.t_BalanceCostSale), 0) t_BalanceCostSale, NVL(sum(lnk.t_Amount), 0) t_Amount, NVL(SUM(LNK.T_OVERAMOUNTADD), 0) T_OVERAMOUNTADD, " +
           " NVL(sum((CASE WHEN buylot.t_Kind = "+PM_WRTSUM_KIND_RRWAB2+" AND ? = buylot.t_DealID THEN 0 ELSE lnk.t_BalanceCostBD END)), 0) t_BalanceCostBD "/*is :513287 */
           "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot " +
           " where buylot.t_SumID  = lnk.t_BuyID " +
           "   and lnk.t_SaleID = ? " +
           "   and buylot.t_Portfolio IN ("+KINDPORT_BACK+", "+KINDPORT_BACK_KSU+") " +
           " group by buylot.t_DealID, buylot.t_Portfolio" +
           " order by (case when ? = buylot.t_DealID then 0 else 1 end) asc "; //сначала свои

   SQLQuery = DL_RSDCommand(query);

   SQLQuery.addParam(PmWrtSum.rec.DealID );/*is :513287 */
   SQLQuery.addParam(PmWrtSum.rec.SumID );
   SQLQuery.addParam(PmWrtSum.rec.DealID );
   
   var cntRec = SQLQuery.GetCount();
   var PrevDebAcc = "";

   /*Если списание из ПВО, то проводки посделочные. Иначе - группируем по портфелям.*/   
   RSD = SQLQuery.execute();
   i = 0;
   while( RSD.MoveNext() )
      
      i = i + 1;

      if( (IsTwoPart(FD.Group) and IsBUY(FD.Group)) and  (PmWrtSum.rec.DealID == RSD.rec.DealID)  )
        FD_buy = FD; //потому что счета ПВО должны быть по этой же ОРЕПО
      else
        FD_buy = SPFirstDoc( LEG_KIND_DL_TICK, RSD.rec.DealID );
      end;

      FD_buy.SetCurPFI(PmWrtSum.rec.FIID);
      
      if( ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_DELIVERY)) )
         FIRole = FIROLE_BA_OVERDUE;
      else
         FIRole = FIROLE_BA;
      end;
       /*продажа "своего" лота или его части*/
       if( PmWrtSum.rec.DealID == RSD.rec.DealID )
         /*списание стоимости ц/б*/
          CredCat  = "ВнебалСчетКорресп";
          CarFIID  = NATCUR;
          CarFIID2 = FD_buy.FaceFIID();
          CarSumm = money( RSD.rec.BalanceCostBuy );
          Capter   = 3;

          /* Отнимем из ПВО количество по "своим" лотам */
          DecAmountSummFR(SummFRArr, RSD.rec.Portfolio, RSD.rec.Amount);

       /*продажа чужого лота или его части из ПВО*/
       else
          
          NeedThisTrnAcc = true;

          /*списание стоимости чужого лота*/
          CredCat  = "ВнебалСчетКорресп";
          CarFIID  = NATCUR;
          CarFIID2 = FD_buy.FaceFIID();
          CarSumm  = money( RSD.rec.BalanceCostBuy );
          Capter   = 3;

          if( IsTwoPart(FD.Group) and IsSALE(FD.Group) )
             DebCatBD = IIF(IsBasket(FD.Group), "+ОД, Корзина", "+ОД");
             if(GetSecurNewRepoDate() <= CarDate)
               NeedThisTrnAcc = false; //В новом РЕПО проводка не нужна
             end;
          else
             DebCatBD = "Реализация, ц/б";
          end;

          if( IsTwoPart(FD.Group) )
            CarSummBD = money( RSD.rec.BalanceCostBD );
          else
            if(ЦЕНА_ОТРАЖ_НА_КУ_МИНУС_ОД_ПРИ_ПРОДАЖЕ_ИЗ_ПВО() == 2)
              CarSummBD = money( RSD.rec.BalanceCostBuy );
            else
            CarSummBD = money( RSD.rec.BalanceCostSale );
          end;
          end;
          
          if((NeedThisTrnAcc == true) and (CarSummBD > 0))
            if( FD_buy.OpenAccount( IIF(IsBasket(FD_buy.Group), "-ОД, Корзина", "-ОД"), null, null, null, CredCatAccBD, CarDate, FD_buy.FaceFIID() ) )
               ground = " Учет обязательств по возврату "  +  GetFinName(FD.fininstr.rec) +   " по сделке обратного РЕПО " + UserGetDealCode(FD_buy) + " от " + FD_buy.tick.rec.dealdate + "  при выбытии бумаг со сделки  " + FD.tick.rec.dealcode + " от " +  FD.tick.rec.dealdate + " Кол-во бумаг " + UserGetKol(RSD.rec.Amount) +   "шт."; /*PDV 493428*/
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      DebCatBD, CredCatAccBD,          /* КатегДеб , КатегКредит*/
                      CarDate,                         /* Дата */
                      1,                               /* Глава */
                      FD.FaceFIID(),                   /* Валюта */
                      CarSummBD,                       /* Сумма  Счист*/
                      INPCARRY,                        /* Result_Carry */
                      " 1",                            /* Kind_Oper */
                      "",                              /* Numb_Document */
                      ground/*"Учет обязательств по возврату ц/б"*/,
                      null,
                      null,
                      null,
                      IIF(DebCatBD != "Реализация, ц/б", FD.FaceFIID(), NATCUR)
                    ) 
                 )
                   return false;
               end;
               /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
               if( SmartConvertSum( CarSummBD_Natcur, CarSummBD, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                  return false;
               end;                      
               SСпво = SСпво + CarSummBD_Natcur;
            end;
          end;

          if( IsTwoPart(FD.Group) and IsBuy(FD.Group) ) // ОРЕПО
              if( FD_buy.IsExistAccount( CredCat, null, true, null, CredCatAcc, null, CarDate, NATCUR ) and
                  FD_buy.OpenAccount( IIF(IsBasket(FD_buy.Group), "Ц/б, Корзина ПВО", "Ц/б, ПВО"), null, null, GetFIRoleByPortfolio( RSD.rec.Portfolio ), DebCatAcc, CarDate, FD_buy.FaceFIID() ) 
//                  FD_buy.IsExistAccount(IIF(IsBasket(FD_buy.Group), "Ц/б, Корзина ПВО", "Ц/б, ПВО"), null, true, GetFIRoleByPortfolio( RSD.rec.Portfolio ), DebCatAcc, null, CarDate, FD_buy.FaceFIID()) 
                 ) 
                    if (RSD.rec.OveramountAdd > 0)
                      if(not БУ_ПроводкаПоКатегориямУчета( FD_buy, 
                                                        CredCatAcc, DebCatAcc,          /* КатегДеб , КатегКредит*/
                                                        CarDate,                        /* Дата */
                                                        3,                              /* Глава */
                                                        FD_buy.FaceFIID(),              /* Валюта */
                                                        abs(RSD.rec.OveramountAdd),     /* Сумма  Стек*/
                                                        INPCARRY,                       /* Result_Carry */
                                                        " 1",                           /* Kind_Oper */
                                                        "",                             /* Numb_Document */
                                                        "Переоценка ПВО"
                                                       ) 
                        )
                          return false;
                      end;
                   elif (RSD.rec.OveramountAdd < 0)
                      if(not БУ_ПроводкаПоКатегориямУчета( FD_buy, 
                                                        DebCatAcc, CredCatAcc,          /* КатегДеб , КатегКредит*/
                                                        CarDate,                        /* Дата */
                                                        3,                              /* Глава */
                                                        FD_buy.FaceFIID(),              /* Валюта */
                                                        abs(RSD.rec.OveramountAdd),     /* Сумма  Стек*/
                                                        INPCARRY,                       /* Result_Carry */
                                                        " 1",                           /* Kind_Oper */
                                                        "",                             /* Numb_Document */
                                                        "Переоценка ПВО"
                                                       ) 
                        )
                          return false;
                      end;
                   end;

                   Ground = "Списание балансовой стоимости бумаг " + GetFinName(FD.fininstr.rec) + " по сделке Репо " + FD_buy.tick.rec.dealcode + " от " + FD_buy.tick.rec.dealdate + " при выбытии по сделке РЕПО " + UserGetDealCode(FD) /*GAA: 505216 */+ ", кол-во бумаг " + UserGetKol(RSD.rec.Amount) + " шт. " ; 
          
                   if(not БУ_ПроводкаПоКатегориямУчета( FD_buy, 
                                                        DebCatAcc, CredCatAcc,          /* КатегДеб , КатегКредит*/
                                                        CarDate,                            /* Дата */
                                                        3,                              /* Глава */
                                                        FD_buy.FaceFIID(),              /* Валюта */
                                                        money( RSD.rec.BalanceCostBuy ) /*CarSummBD*/,                      /* Сумма  Стек*/
                                                        INPCARRY,                       /* Result_Carry */
                                                        " 1",                           /* Kind_Oper */
                                                        "",                             /* Numb_Document */
                                                        ground /*"Списание балансовой стоимости2"*/
                                                       ) 
                     )
                       return false;
                   end;   
              end;                              
          end;
       end;

       if( (IsCompensWrt or (not IsTwoPart(FD.Group))) and FD_buy.IsExistAccount(IIF(IsBasket(FD_buy.Group), "Ц/б, Корзина ПВО", "Ц/б, ПВО"), null, true, FIRole, DebCatAcc, null, CarDate, FD_buy.FaceFIID() ) )
         
         if(not(IsTwoPart(FD.Group) AND IsSALE(FD.Group) AND (GetSecurNewRepoDate() <= CarDate)))  // Для ПРЕПО не нужна в новом БУ
           if( (not ForRestAcc) OR (PrevDebAcc != DebCatAcc.Account)) //т.к. связей может быть несколько, а проводку на остаток нужно сделать только один раз
             // Ground = "Списание балансовой стоимости переданных в Репо бумаг " + GetFinName(FD.fininstr.rec) + " по сделке Репо " + FD_buy.tick.rec.dealcode + " от " + FD_buy.tick.rec.dealdate + " Кол-во бумаг " + UserGetKol(RSD.rec.Amount) + " шт. " ; 
                Ground = "Списание стоимости ЦБ " + GetFinName(FD.fininstr.rec) +  " по сделке обратного РЕПО " + UserGetDealCode(FD_buy) + " при выбытии по сделке продажи/РЕПО_1 "  + FD.tick.rec.dealcode +  " от " + FD.tick.rec.dealdate + " Кол-во бумаг " + UserGetKol(RSD.rec.Amount) + " шт. " ;/*510107 PDV*/ 
	 if( FD_buy.IsExistAccount(CredCat, null, true, GetFIRoleByPortfolio(RSD.rec.Portfolio), CredCatAcc, null, CarDate, CarFIID) )
                                     
                if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                    DebCatAcc, CredCatAcc,             /* КатегДеб , КатегКредит*/
                    CarDate,                        /* Дата */
                    Capter,                         /* Глава */
                    FD.FaceFIID(),                  /* Валюта */
                    CarSumm,                        /* Сумма  Счист*/
                    INPCARRY,                       /* Result_Carry */
                    " 1",                           /* Kind_Oper */
                    "",                             /* Numb_Document */
                    Ground/*"Списание балансовой стоимости3"*/,
                    ForRestAcc,
                    GetFIRoleByPortfolio( RSD.rec.Portfolio ),
                    null,
                    CarFIID2, CarFIID 
                   ) 
                  )
                    return false;
                end;
                 
                PrevDebAcc = DebCatAcc.Account;
             end; 
           end;
         end;

      end;

      if( IsTwoPart(FD.Group) and IsSALE(FD.Group) ) /*Прямое РЕПО*/

         IF(FD.TICK.rec.dealdate < MGRDate)
            FDMGR = SpFirstDoc(FD.tick, false);
              if( not FDMGR.IsExistAccount(IIF(IsBasket(FD.Group), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП"), null, true, GetFIRoleByPortfolio(RSD.rec.Portfolio), DebCatAcc, null, CarDate, FDMGR.FaceFIID()) ) 
                 if( not FDMGR.OpenAccount(IIF(IsBasket(FD.Group), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП"), null, null, GetFIRoleByPortfolio(RSD.rec.Portfolio), DebCatAcc, CarDate, FDMGR.FaceFIID()) )
                    return 1;
                 end;
              end;

             // Ground = "Списание балансовой стоимости переданных в репо бумаг " + GetFinName(FD.fininstr.rec) + " по сделке Репо " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + " Кол-во бумаг " + UserGetKol(RSD.rec.Amount) + " шт. " ;/*510107 PDV*/ 
	        Ground = "Списание стоимости ЦБ " + GetFinName(FD.fininstr.rec) +  " по сделке обратного РЕПО " + UserGetDealCode(FD_buy) + " при выбытии по сделке продажи/РЕПО_1 "  + FD.tick.rec.dealcode +  " от " + FD.tick.rec.dealdate + " Кол-во бумаг " + UserGetKol(RSD.rec.Amount) + " шт. " ;
              if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                    DebCatAcc, /* КатегДеб */
                                                    "ВнебалСчетКорресп",            /* КатегКредит */
                                                    CarDate,                        /* Дата */
                                                    3,                              /* Глава */
                                                    FD.FaceFIID(),                  /* Валюта */
                                                    money(RSD.rec.BalanceCostBuy),  /* Сумма Счист */
                                                    INPCARRY,                       /* Result_Carry */
                                                    " 1",                           /* Kind_Oper */
                                                    "",                             /* Numb_Document */
                                                    ground, /*"Списание балансовой стоимости4",*/
                                                    0,
                                                    null,
                                                    FIROLE_CA,
                                                    null, NATCUR
                                                  )
                )
                  return false;
              end;
         else
              if( not FD.IsExistAccount(IIF(IsBasket(FD.Group), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП"), null, true, GetFIRoleByPortfolio(RSD.rec.Portfolio), DebCatAcc, null, CarDate, FD.FaceFIID()) ) 
                 if( not FD.OpenAccount(IIF(IsBasket(FD.Group), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП"), null, null, GetFIRoleByPortfolio(RSD.rec.Portfolio), DebCatAcc, CarDate, FD.FaceFIID()) )
                    return 1;
                 end;
              end;

            //  Ground = "Списание балансовой стоимости переданных в Репо бумаг " + GetFinName(FD.fininstr.rec) + " по сделке Репо " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + " Кол-во бумаг " + UserGetKol(RSD.rec.Amount) + " шт. " ; 
	          Ground = "Списание стоимости ЦБ " + GetFinName(FD.fininstr.rec) +  " по сделке обратного РЕПО " + UserGetDealCode(FD_buy) + " при выбытии по сделке продажи/РЕПО_1 "  + FD.tick.rec.dealcode +  " от " + FD.tick.rec.dealdate + " Кол-во бумаг " + UserGetKol(RSD.rec.Amount) + " шт. " ;/*510107 PDV*/ 
            
	 if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                    DebCatAcc, /* КатегДеб */
                                                    "ВнебалСчетКорресп",            /* КатегКредит */
                                                    CarDate,                        /* Дата */
                                                    3,                              /* Глава */
                                                    FD.FaceFIID(),                  /* Валюта */
                                                    money(RSD.rec.BalanceCostBuy),  /* Сумма Счист */
                                                    INPCARRY,                       /* Result_Carry */
                                                    " 1",                           /* Kind_Oper */
                                                    "",                             /* Numb_Document */
                                                    ground, /*"Списание балансовой стоимости4",*/
                                                    0,
                                                    null,
                                                    FIROLE_CA,
                                                    null, NATCUR
                                                  )
                )
                  return false;
              end;
         end;
      end;
   end;

   if( UsingNewRepo ) /*Обрабатываем 2ч ОРЕПО*/
     var cmd; 
     var FDsale; /*1ч ПРЕПО*/
     var FDBuy;
     var PVOAcc = TRecHandler( "account.dbt" );
     /*линки покупки и 2ч ОРЕПО*/

     query =   " select salelot2.t_DealID SaleDealID, buylot.t_Portfolio, SUM(lnk.t_BalanceCostSale) BalanceCostSale, SUM(lnk.t_Amount) Amount, "
             + "        SUM(lnk.t_CostBuy + lnk.t_NKDBuyAmount - lnk.t_BonusAdd) CarSumm, "
             + "        SUM(ROUND(NVL(lnk.T_BEGBONUSCHANGE, 0),2) - ROUND(NVL(lnk.T_BONUSBUY, 0),2) - ROUND(NVL(lnk.T_BONUSADD, 0),2) + ROUND(NVL(lnk.T_OLDBONUSBUY, 0),2)) BonusRest, "
             + "        SUM(lnk.t_NKDBuyAmount) NKDRest, "
             + "        SUM(lnk.t_NotWrtBonusBuy) NotWrtBonusBuy "
             + "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot, dpmwrtsum_dbt salelot2 "
             + "  where lnk.t_SaleID = salelot2.t_SumID "
             + "    and salelot2.t_Source = ? "
             + "    and salelot2.t_Kind = " + PM_WRTSUM_KIND_RRWAS1
             + "    and buylot.t_SumID = lnk.t_BuyID "
             + "    and buylot.t_Portfolio not in( " + KINDPORT_BACK + ", "+KINDPORT_BASICDEBT+", "+ KINDPORT_BACK_KSU+ ", " + KINDPORT_BACK_BPP_KSU + ")"
             + "  group by salelot2.t_DealID, buylot.t_Portfolio ";

     cmd = DL_RSDCommand(query);
     cmd.AddParam(PmWrtSum.rec.SumID); 

     DataSet = cmd.Execute();
     while( DataSet.moveNext() )
   
       FDsale = SPFirstDoc(LEG_KIND_DL_TICK, DataSet.SaleDealID);
       FDsale.SetCurPFI(PmWrtSum.rec.FIID);

       var SaleIsOverdue:bool = false;
       if( ТОБылоПросрочено(FDsale.GetRQ(DLRQ_TYPE_DELIVERY,2)) )
          SaleIsOverdue = true;
       end;

       if(IsTwoPart(FD.Group) )
         Bpp = true;
         
         if(ВедениеСчетовБПППоВыпуску() == true)
           DebCat   = "Наш портфель ц/б";
           CarFIID2 = FDsale.GetAccFIID(DebCat);
         else
         if( IsBasket(FDsale.Group) )
            DebCat = "Ц/б, Корзина БПП";
         else
            DebCat = "Ц/б, БПП";
         end;
         CarFIID2 = FDsale.FaceFIID();
         end;

         CredCat  = "Наш портфель ц/б";
         CarFIID  = FDsale.GetAccFIID(CredCat);
       else
         Bpp = false;
         
         DebCat   = "Реализация, ц/б";
         CarFIID2 = NATCUR;

         CredCat = "Наш портфель ПКУ, ц/б";
         CarFIID = NATCUR;
       end;

       CarSumm  = money(DataSet.CarSumm);
       BonusRest= money(DataSet.BonusRest);
       NKDRest  = money(DataSet.NKDRest);
       NotWrtBonusBuy = money(DataSet.NotWrtBonusBuy);
       Capter   = 1;

       if(not FDsale.IsExistAccount( DebCat, null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, Bpp, SaleIsOverdue), DebCatAcc, null, CarDate, CarFIID2 ))
         if( not FDsale.OpenAccount( DebCat, null, null, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, Bpp, SaleIsOverdue), DebCatAcc, CarDate, CarFIID2 ) )
           return 1;
         end;
       end;

       if(not FD.IsExistAccount( CredCat, null, true, GetFIRoleByPortfolio(DataSet.Portfolio), CredCatAcc, null, CarDate, CarFIID ))
         if( not FD.OpenAccount( CredCat, null, null, GetFIRoleByPortfolio(DataSet.Portfolio), CredCatAcc, CarDate, CarFIID ) )
           return 1;
         end;
       end;

       WrtCostSum = CarSumm - BonusRest;

       if( ОтдельныйУчетУплНКД() )
          WrtCostSum = WrtCostSum - NKDRest;
       end;

       if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            DebCatAcc, CredCatAcc,          /* КатегДеб , КатегКредит*/
                                            CarDate,                        /* Дата */
                                            Capter,                         /* Глава */
                                            CarFIID,                        /* Валюта */
                                            WrtCostSum,                     /* Сумма  Счист*/
                                            INPCARRY,                       /* Result_Carry */
                                            " 1",                           /* Kind_Oper */
                                            "",                             /* Numb_Document */
                                            "Списание балансовой стоимости5",
                                            null,
                                            null,
                                            GetFIRoleByPortfolio( DataSet.Portfolio ),
                                            CarFIID2, CarFIID 
                                          )
         )
           return false;
       end;

       if( (NKDRest) and (ОтдельныйУчетУплНКД()) )
         CarFIID = FDsale.FaceFIID();
         
         if(ВедениеСчетовБПППоВыпуску() == true)
           DebCat = "Уплаченный НКД";
         else
           DebCat = IIF(IsBasket(FDsale.Group), "Уплач. НКД, Корзина БПП", "Уплаченный НКД, БПП");
         end;
         
         if(not FDsale.IsExistAccount( DebCat, null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, true, SaleIsOverdue), DebCatAcc, null, CarDate, CarFIID ))
           if( not FDsale.OpenAccount( DebCat, null, null, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, true, SaleIsOverdue), DebCatAcc, CarDate, CarFIID ) )
             return 1;
           end;
         end;

         if(not FD.IsExistAccount( "Уплаченный НКД", null, true, GetFIRoleByPortfolio(DataSet.Portfolio), CredCatAcc, null, CarDate, CarFIID ))
           if( not FD.OpenAccount( "Уплаченный НКД", null, null, GetFIRoleByPortfolio(DataSet.Portfolio), CredCatAcc, CarDate, CarFIID ) )
             return 1;
           end;
         end;

         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                              DebCatAcc, CredCatAcc,          /* КатегДеб , КатегКредит*/
                                              CarDate,                        /* Дата */
                                              Capter,                         /* Глава */
                                              CarFIID,                        /* Валюта */
                                              NKDRest,                        /* Сумма  */
                                              INPCARRY,                       /* Result_Carry */
                                              " 1",                           /* Kind_Oper */
                                              "",                             /* Numb_Document */
                                              "Перевод НКД"
                                            ) 
           )
             return false;
         end;
       end;

       CarSumm = BonusRest;

       if( CarSumm != 0 )
          CarFIID = FDsale.FaceFIID();

          if(not FDsale.IsExistAccount( "Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(DataSet.Portfolio, true), DebCatAcc, null, CarDate, CarFIID ))
            if( not FDsale.OpenAccount( "Премия, ц/б", null, null, GetFIRoleByPortfolioBonus(DataSet.Portfolio, true), DebCatAcc, CarDate, CarFIID ) )
              return 1;
            end;
          end;

          if(not FD.IsExistAccount( "Премия, ц/б", null, true, GetFIRoleByPortfolioBonus(DataSet.Portfolio), CredCatAcc, null, CarDate, CarFIID ))
            if( not FD.OpenAccount( "Премия, ц/б", null, null, GetFIRoleByPortfolioBonus(DataSet.Portfolio), CredCatAcc, CarDate, CarFIID ) )
              return 1;
            end;
          end;
          
          if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                               DebCatAcc, CredCatAcc,          /* КатегДеб , КатегКредит*/
                                               CarDate,                        /* Дата */
                                               Capter,                         /* Глава */
                                               FD.FaceFIID(),                  /* Валюта */
                                               CarSumm,                        /* Сумма  */
                                               INPCARRY,                       /* Result_Carry */
                                               " 1",                           /* Kind_Oper */
                                               "",                             /* Numb_Document */
                                               "Перевод остатка уплаченной премии"
                                             )
            )
              return false;
          end;
       end;

       if( (NotWrtBonusBuy != 0) and (not IsLOAN(FD.Group)) )
          CarFIID = FDsale.FaceFIID();

          if(not FDsale.IsExistAccount( "Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, true , false, true), DebCatAcc, null, CarDate, CarFIID ))
            if( not FDsale.OpenAccount( "Начисл.ПДД, ц/б", null, null, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, true , false, true), DebCatAcc, CarDate, CarFIID ) )
              return 1;
            end;
          end;

          if(not FD.IsExistAccount( "Начисл.ПДД, ц/б", null, true, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, false, false, true), CredCatAcc, null, CarDate, CarFIID ))
            if( not FD.OpenAccount( "Начисл.ПДД, ц/б", null, null, GetFIRoleByPortfolio(DataSet.Portfolio, false, false, false, false, true), CredCatAcc, CarDate, CarFIID ) )
              return 1;
            end;
          end;
          
          if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                               DebCatAcc, CredCatAcc,          /* КатегДеб , КатегКредит*/
                                               CarDate,                        /* Дата */
                                               Capter,                         /* Глава */
                                               FD.FaceFIID(),                  /* Валюта */
                                               NotWrtBonusBuy,                 /* Сумма  */
                                               INPCARRY,                       /* Result_Carry */
                                               " 1",                           /* Kind_Oper */
                                               "",                             /* Numb_Document */
                                               "Перевод начисленной премии"
                                             )
            )
              return false;
          end;
       end;

       CarSumm  = money(DataSet.BalanceCostSale);
       if(CarSumm > 0)
         if( FDsale.IsExistAccount(IIF(IsBasket(FDsale.Group), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП"), null, true, IIF(SaleIsOverdue, FIROLE_BA_OVERDUE, FIROLE_BA), PVOAcc, null, CarDate) )

            if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                  "ВнебалСчетКорресп",            /* КатегДеб */
                                                  PVOAcc,                         /* КатегКредит */
                                                  CarDate,                        /* Дата */
                                                  3,                              /* Глава */
                                                  FD.FaceFIID(),                  /* Валюта */
                                                  CarSumm,                        /* Сумма */
                                                  INPCARRY,                       /* Result_Carry */
                                                  " 1",                           /* Kind_Oper */
                                                  "",                             /* Numb_Document */
                                                  "Списание требований по обратной поставке",
                                                  0,
                                                  IIF(SaleIsOverdue, FIROLE_BA_OVERDUE, FIROLE_BA), 
                                                  FIROLE_CA, 
                                                  FD.FaceFIID(), 
                                                  NATCUR
                                                )

              )
                return false;
            end;
         end;
       end;
     end;

     if (IsTwoPart(FD.Group) and IsBUY(FD.Group))
        // По связям, где продажа = лот 1ч ПР у которого исходный лот 2ч ОР == PmWrtSum.rec.SumID
        query = " select NVL(sum(lnk.t_BalanceCostBuy), 0) t_BalanceCostBuy, salelotPR.t_DealID, "
                + "(select NVL(sum(lotPR2.t_BalanceCost), 0) "
                + "   from dpmwrtsum_dbt lotPR2, ddlrq_dbt rq "
                + "  where lotPR2.t_DocID = rq.t_ID "
                + "    and lotPR2.t_Source = ? " //1ч ОР
                + "    and lotPR2.t_Portfolio = " + KINDPORT_BASICDEBT
                + "    and lotPR2.t_State = " + PM_WRTSUM_CANCEL
                + "    and lotPR2.t_FIID = ? "
                + "    and rq.t_DocID = salelotPR.t_DealID "
                + ") t_BalanceCost "
              + "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot, dpmwrtsum_dbt salelotPR "
              + "  where lnk.t_SaleID = salelotPR.t_SumID "
              + "    and salelotPR.t_Source = ? "
              + "    and salelotPR.t_FIID = ? "
              + "    and salelotPR.t_Kind = " + PM_WRTSUM_KIND_RRWAS1
              + "    and buylot.t_SumID = lnk.t_BuyID "
              + "    and buylot.t_Portfolio = " + KINDPORT_BACK
              + "  group by salelotPR.t_DealID ";

        cmd = DL_RSDCommand(query);
        cmd.AddParam(PmWrtSum.rec.Parent); 
        cmd.AddParam(PmWrtSum.rec.FIID); 
        cmd.AddParam(PmWrtSum.rec.SumID); 
        cmd.AddParam(PmWrtSum.rec.FIID); 

        DataSet = cmd.Execute();
        while( DataSet.moveNext() )

           FDsale = SPFirstDoc(LEG_KIND_DL_TICK, DataSet.DealID); // ПР
           FDsale.SetCurPFI(PmWrtSum.rec.FIID);

           SaleIsOverdue = false;
           if( ТОБылоПросрочено(FDsale.GetRQ(DLRQ_TYPE_DELIVERY,2)) )
              SaleIsOverdue = true;
           end;

           var CarSum = money(DataSet.BalanceCostBuy) - money(DataSet.BalanceCost);

           if( FDsale.IsExistAccount(IIF(IsBasket(FDsale.Group), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП"), null, true, IIF(SaleIsOverdue, FIROLE_BA_OVERDUE, FIROLE_BA), PVOAcc, null, CarDate) )

              if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                    IIF(CarSum > $0, PVOAcc, "ВнебалСчетКорресп"), /* КатегДеб */
                                                    IIF(CarSum > $0, "ВнебалСчетКорресп", PVOAcc), /* КатегКредит */
                                                    CarDate,                        /* Дата */
                                                    3,                              /* Глава */
                                                    FD.FaceFIID(),                  /* Валюта */
                                                    abs(CarSum),                    /* Сумма */
                                                    INPCARRY,                       /* Result_Carry */
                                                    " 1",                           /* Kind_Oper */
                                                    "",                             /* Numb_Document */
                                                    "Корректировка балансовой стоимости",
                                                    0,
                                                    IIF(CarSum > $0, IIF(SaleIsOverdue, FIROLE_BA_OVERDUE, FIROLE_BA), FIROLE_CA),
                                                    IIF(CarSum > $0, FIROLE_CA, IIF(SaleIsOverdue, FIROLE_BA_OVERDUE, FIROLE_BA)),
                                                    IIF(CarSum > $0, FD.FaceFIID(), NATCUR),
                                                    IIF(CarSum > $0, NATCUR, FD.FaceFIID())
                                                  )

                )
                  return false;
              end;
           end;
        end;
     end;
   end; 
   
   if((not UsingNewRepo) OR (not СвойЛотБылПроданПРЕПО(PmWrtSum.rec.SumID, true)))

     var AcCurSec = УЧЕТ_ВАЛЮТНЫХ_ДОЛЕВЫХ_ЦБ(),
         IsBondFI = FI_IsBond(FD.fininstr),
         SumDeb = 0, SumCred = 0;
     var SumEquivalentCarry = null;

     // *Если ц/б с идентификаторм T_FIID текущего лота продажи НЕ является облигацией И её валюта номинала НЕ равна НацВ,
     // Продажа:
     //   то сумма для проводки <Списание стоимости покупки> (Реализация, ц/б - Наш портфель, ц/б) из портфелей ССПУ_ЦБ или СССД_ЦБ определяется следующим образом:
     // ПРЕПО:
     //   И <Учет валютных долевых ц/б> имеет значение 0 (т.е. в рублях),
     //   то сумма для проводки <Перевод основной стоимости> (ЦБ_БПП (ВН) - Наш портфель (ВУ)) определяется следующим образом:
     if( (((not IsTwoPart(FD.Group)) and IsSALE(FD.Group))
             or (IsREPO(FD.Group) and IsSALE(FD.Group) and (AcCurSec == 0))) and
          (IsBondFI == false) and (FD.FaceFIID() != NATCUR) )
        SQLQuery = RSDCommand("select buylot.t_Portfolio, " +
                              "       NVL(SUM(lnk.t_CostBuy), 0) Svib, " +
                              "       NVL(SUM(lnk.t_CostBuyNat), 0) Svibrub " +
                              "  from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot " +
                              " where lnk.t_SaleID   = ? " +
                              "   and buylot.t_SumID = lnk.t_BuyID " +
                              "   and buylot.t_Portfolio in (?, ?) " +
                              " group by buylot.t_Portfolio ");

        SQLQuery.addParam( "", RSDBP_IN, PmWrtSum.rec.SumID );
        SQLQuery.addParam( "", RSDBP_IN, KINDPORT_TRADE );
        SQLQuery.addParam( "", RSDBP_IN, KINDPORT_SALE );
        SQLQuery.execute();

        RSD = TRsbDataSet(SQLQuery);

        while( RSD.MoveNext() )
           if( IsREPO(FD.Group))
              Bpp = true;
              if(ВедениеСчетовБПППоВыпуску() == true)
                DebCat = "Наш портфель ц/б";
                CarFIID = FD.GetAccFIID(DebCat);
                if(CarFIID == FD.FaceFIID())
                  SumDeb = RSD.rec.Svib;
                else
                  SumDeb = RSD.rec.Svibrub;
                end;
              else
              DebCat = IIF(IsBasket(FD.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
                CarFIID = FD.FaceFIID();
              SumDeb = RSD.rec.Svib;
              end;
              
              SumCred = RSD.rec.Svibrub;
              CarFIID2 = NATCUR;
           else
              Bpp = false;
              DebCat   = "Реализация, ц/б";

              if(AcCurSec == 0)
                 SumDeb = SumCred = RSD.rec.Svibrub;
                 CarFIID = CarFIID2 = NATCUR;
              else
                 SumDeb = money(RSD.rec.Svibrub);
                 SumCred = RSD.rec.Svib;
                 CarFIID = NATCUR;
                 CarFIID2 = FD.FaceFIID();
              end;
           end;
           CredCat  = "Наш портфель ц/б";

           SumEquivalentCarry = null;
           if((AcCurSec != 0) and (IsBondFI == false) and (FD.FaceFIID() != NATCUR))
             SumEquivalentCarry = money(RSD.rec.Svibrub);
           end;

           if( SumDeb != 0 )
              if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                   DebCat, CredCat,                /* КатегДеб , КатегКредит*/
                                                   CarDate,                        /* Дата */
                                                   Capter,                         /* Глава */
                                                   CarFIID,                        /* Валюта */
                                                   SumDeb,                         /* Сумма*/
                                                   INPCARRY,                       /* Result_Carry */
                                                   " 1",                           /* Kind_Oper */
                                                   "",                             /* Numb_Document */
                                                   "Списание балансовой стоимости6",
                                                   null,
                                                   GetFIRoleByPortfolio( RSD.rec.Portfolio, false, false, Bpp ),
                                                   GetFIRoleByPortfolio( RSD.rec.Portfolio ),
                                                   CarFIID, CarFIID2,
                                                   CarFIID2,                       /* Валюта2 */
                                                   SumCred,                        /* Сумма2 */
                                                   null, null, null, null, null, null, null,
                                                   null, null, null, null,
                                                   SumEquivalentCarry
                                                 )
                )
                  return false;
              end;

              if( not (IsTwoPart(FD.Group) and IsSALE(FD.Group)) ) // не ПРЕПО
                 AddCostSummFR(SummFRArr, RSD.rec.Portfolio, money(RSD.rec.Svibrub));
              end;
           end;
        end;
     end;

     query = "select buylot.t_Portfolio, " +
                           "       NVL(SUM(lnk.t_CostBuy + lnk.t_NKDBuyAmount - lnk.t_BonusAdd), 0) CarSumm, NVL(SUM(lnk.t_CostPFIBuy), 0) CostPFIBuy, " +
             "       NVL(SUM(  ROUND(NVL(lnk.T_BEGBONUSCHANGE, 0),2) "+
             "               - ROUND(NVL(lnk.T_BONUSBUY, 0),2) "+
             "               - ROUND(NVL(lnk.T_BONUSADD, 0),2) "+
             "               + ROUND(NVL(lnk.T_OLDBONUSBUY, 0),2) "+
             "              ), 0) BonusRest, " +
                           "       NVL(SUM(lnk.t_NKDBuyAmount), 0) NKDRest, " +
                           "       NVL(SUM(lnk.t_NotWrtBonusBuy), 0) NotWrtBonusBuy, " +
                           "       NVL(SUM(lnk.t_CostBuyNat), 0) CostBuyNat " +
             "  from dpmwrtlnk_dbt lnk, v_scwrthistex buylot " +
                           " where buylot.t_SumID = lnk.t_BuyID " +
             "   and buylot.t_Instance = lnk.t_BuyInstance-1 " +
                           "   and lnk.t_SaleID   = ? " +
                           "   and buylot.t_Portfolio not in (?, ?, ?, ?) " +
             " group by buylot.t_Portfolio ";

     cmd = DL_RSDCommand(query);

     cmd.addParam(PmWrtSum.rec.SumID );
     cmd.addParam(KINDPORT_BACK );
     cmd.addParam(KINDPORT_BASICDEBT );
     cmd.addParam(KINDPORT_BACK_KSU );
     cmd.addParam(KINDPORT_BACK_BPP_KSU );
     RSD = cmd.execute();

     /*Иначе - группируем проводки по портфелям, кроме ПВО.
       Эту проводку наверное можно внести выше и получать сумму в WRT_GetSaleFinResult_EX. 
       Возможно, так не сделано потому что в WRT_GetSaleFinResult_EX перебираются не все портфели 
       и чтобы не ломать там логику.
     */
     while( RSD.MoveNext() )
        if( IsTwoPart(FD.Group) and IsSALE(FD.Group) ) // ПРЕПО
           Bpp = true;
           if( RSD.rec.Portfolio == KINDPORT_CONTR )
              if(ВедениеСчетовБПППоВыпуску() == true)
                DebCat = "Наш портфель ПКУ, ц/б";
              else
              DebCat   = IIF(IsBasket(FD.Group), "Ц/б, Корзина ПКУ БПП", "Ц/б, ПКУ БПП");
              end;
              CarFIID2 = NATCUR;
           else
              if(ВедениеСчетовБПППоВыпуску() == true)
                DebCat   = "Наш портфель ц/б";
                CarFIID2 = FD.GetAccFIID(DebCat);
              else
              DebCat   = IIF(IsBasket(FD.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
              CarFIID2 = FD.FaceFIID();
           end;
           end;
        else
           Bpp = false;
           DebCat   = "Реализация, ц/б";
           CarFIID2 = NATCUR;
        end;

        if( (IsTwoPart(FD.Group) and IsSALE(FD.Group) and (RSD.rec.Portfolio == KINDPORT_CONTR)) or // ПРЕПО
            ((not IsTwoPart(FD.Group)) and (FD.ТипПортфеля() == KINDPORT_CONTR))
          )
           CredCat = "Наш портфель ПКУ, ц/б";
           CarFIID = NATCUR;
        else
           CredCat  = "Наш портфель ц/б";
           CarFIID  = FD.GetAccFIID(CredCat);
        end;

        CarSumm  = money(RSD.rec.CarSumm);
        BonusRest= money(RSD.rec.BonusRest);
        NotWrtBonusBuy= money(RSD.rec.NotWrtBonusBuy);
        NKDRest  = money(RSD.rec.NKDRest);
        Capter   = 1;

        // *Для остальных ц/б остается имеющаяся реализация
        if(not((((not IsTwoPart(FD.Group)) and IsSALE(FD.Group))
                   or (IsREPO(FD.Group) and IsSALE(FD.Group) and (AcCurSec == 0))) and
                (IsBondFI == false) and
                (FD.FaceFIID() != NATCUR) and
                ((RSD.rec.Portfolio == KINDPORT_TRADE) or (RSD.rec.Portfolio == KINDPORT_SALE)))
          )        

           if((AcCurSec == 0) and (IsBondFI == false) and (FD.FaceFIID() != NATCUR))
             WrtCostSum = RSD.rec.CostBuyNat;
           else
           WrtCostSum = CarSumm - BonusRest + money(RSD.rec.CostPFIBuy);
           end;


           if( ОтдельныйУчетУплНКД() )
              WrtCostSum = WrtCostSum - NKDRest;
           end;

           SumEquivalentCarry = null;
           if((AcCurSec != 0) and (IsBondFI == false) and (FD.FaceFIID() != NATCUR))
             SumEquivalentCarry = money(RSD.rec.CostBuyNat);
           end;

           if( WrtCostSum != 0 )

           If(IsBasket(FD.Group))
              ПолучитьФинИн( FD.avoiriss.rec.fiid, fininstr );
           else
              ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
           end;
           If(IsREPO(FD.Group) and IsSALE(FD.Group))
              If(IsBasket(FD.Group))
                 Ground = "Перенос балансовой стоимости ЦБ " + GetFinName(fininstr.rec) + " со счета вложений на счет вложений для проданных без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate/* + ", кол-во бумаг ?"*/;
              else
                 Ground = "Перенос балансовой стоимости ЦБ " + GetFinName(fininstr.rec) + " со счета вложений на счет вложений для проданных без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate/* + ", кол-во бумаг ?"*/;
              end;
           else
              Ground = "Списание балансовой стоимости по сделке " + UserGetDealCode(FD) + " со счета вложений при выбытии ценной бумаги " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;
           end;

              if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                   DebCat, CredCat,                /* КатегДеб , КатегКредит*/
                                                   CarDate,                        /* Дата */
                                                   Capter,                         /* Глава */
                                                   CarFIID,                        /* Валюта */
                                                   WrtCostSum,                     /* Сумма  Счист*/
                                                   INPCARRY,                       /* Result_Carry */
                                                   " 1",                           /* Kind_Oper */
                                                   "",                             /* Numb_Document */
                                                   Ground/*"Списание балансовой стоимости8"*/,
                                                   null,
                                                   GetFIRoleByPortfolio( RSD.rec.Portfolio, false, false, Bpp ),
                                                   GetFIRoleByPortfolio( RSD.rec.Portfolio ),
                                                   CarFIID2, CarFIID,
                                                   null, null, null, null, null, null, null, null, null,
                                                   null, null, null, null,
                                                   SumEquivalentCarry
                                                 )
                )
                  return false;
              end;

              if( not (IsTwoPart(FD.Group) and IsSALE(FD.Group)) ) // не ПРЕПО
                 /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
                 if( SmartConvertSum( WrtCostSum, WrtCostSum, CarDate, CarFIID, NATCUR, true ) == false )
                    return false;
                 end;                      
                 AddCostSummFR(SummFRArr, RSD.rec.Portfolio, WrtCostSum);
              end;
           end;
        end;

        if (ОтдельныйУчетУплНКД())
           if( IsTwoPart(FD.Group) and IsSALE(FD.Group) ) // ПРЕПО
              var Cat = "";

              if(ВедениеСчетовБПППоВыпуску() == true)
                Cat = "Уплаченный НКД";
              else
                Cat = IIF(IsBasket(FD.Group), "Уплач. НКД, Корзина БПП", "Уплаченный НКД, БПП");
              end;
              /* ПР 1КА1б2 */
              Ground = "Перенос УНКД по " + GetFinName(FD.fininstr.rec) + " на счет вложений для УНКД по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                     Cat, "Уплаченный НКД",  /* КатегДеб , КатегКредит*/
                     CarDate,                        /* Дата */
                     Capter,                         /* Глава */
                     FD.FaceFIID(),                  /* Валюта */
                     NKDRest,                        /* Сумма  */
                     INPCARRY,                       /* Result_Carry */
                     " 1",                           /* Kind_Oper */
                     "",                             /* Numb_Document */
                     Ground /*"Перевод НКД 3"*/,
                     null,
                     GetFIRoleByPortfolio( RSD.rec.Portfolio, false, false, true), /* БПП */
                     GetFIRoleByPortfolio( RSD.rec.Portfolio )
                    ) 
                )
                  return false;
              end;
           else
              /* ОР 2КВБАб2, продажа 1ЛАБб2 # */
              CredCat  = "Уплаченный НКД";
              if( FD.IsExistAccount( CredCat, null, true, GetFIRoleByPortfolio( RSD.rec.Portfolio ), 
                                     CredCatAcc, null, CarDate, CarFIID ) )
                 Ground = "Списание УНКД по сделке " + UserGetDealCode(FD)  + " при выбытии ценной бумаги " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;
                 if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                        DebCat, CredCatAcc,             /* КатегДеб , КатегКредит*/
                        CarDate,                        /* Дата */
                        Capter,                         /* Глава */
                        FD.FaceFIID(),                  /* Валюта */
                        NKDRest,                        /* Сумма  */
                        INPCARRY,                       /* Result_Carry */
                        " 1",                           /* Kind_Oper */
                        "",                             /* Numb_Document */
                        Ground/*"Учет НКД"*/,
                        null,
                        GetFIRoleByPortfolio( RSD.rec.Portfolio ),
                        null,
                        CarFIID2, CarFIID 
                       ) 
                   )
                     return false;
                 end;
                 /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
                 if( SmartConvertSum( NKDRest, NKDRest, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                    return false;
                 end;
                 AddCostSummFR(SummFRArr, RSD.rec.Portfolio, NKDRest);
              end;
           end;
        end;

        if( IsTwoPart(FD.Group) and IsSALE(FD.Group) ) // ПРЕПО
           /* ПР 1КА1б2 */
              If(IsBasket(FD.Group))
                 Ground = "Перенос Премии по " + GetFinName(FD.fininstr.rec) + " на счет премии по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              else
                 Ground = "Перенос Премии по " + GetFinName(FD.fininstr.rec) + " на счет премии по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              end;
           if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                 "Премия, ц/б", "Премия, ц/б",   /* КатегДеб , КатегКредит*/
                                                 CarDate,                        /* Дата */
                                                 Capter,                         /* Глава */
                                                 FD.FaceFIID(),                  /* Валюта */
                                                 BonusRest,                      /* Сумма  */
                                                 INPCARRY,                       /* Result_Carry */
                                                 " 1",                           /* Kind_Oper */
                                                 "",                             /* Numb_Document */
                                                 Ground/*"Перевод остатка уплаченной премии"*/,
                                                 null,
                                                 GetFIRoleByPortfolioBonus(RSD.rec.Portfolio, true), /* БПП */
                                                 GetFIRoleByPortfolioBonus(RSD.rec.Portfolio)
                                               )
             )
              return false;
           end;
        else
           /* ОР 2КВБАб2, продажа 1ЛАБб2 # */
           CredCat = "Премия, ц/б";
           if( FD.IsExistAccount( CredCat, null, true, GetFIRoleByPortfolioBonus(RSD.rec.Portfolio), CredCatAcc, null, CarDate, CarFIID ) )
//              ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
//              Ground = "Корректировка % до ЭПС по ЦБ " + GetFinName(fininstr.rec) + ", портфель " + Groups[i] + "-я категория, количество " + UserGetKol(Amount, fininstr.rec.avoirkind) + ".";
                ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
                Ground = "Списание начисленной премии по сделке " + UserGetDealCode(FD) + " при выбытии ценной бумаги " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;

              if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                     DebCat, CredCatAcc,             /* КатегДеб , КатегКредит*/
                     CarDate,                        /* Дата */
                     Capter,                         /* Глава */
                     FD.FaceFIID(),                  /* Валюта */
                     BonusRest,                      /* Сумма  */
                     INPCARRY,                       /* Result_Carry */
                     " 1",                           /* Kind_Oper */
                     "",                             /* Numb_Document */
                     Ground/*"Учет премии"*/,
                     null,
                     GetFIRoleByPortfolio( RSD.rec.Portfolio ),
                     null,
                     CarFIID2, CarFIID 
                    ) 
                )
                  return false;
              end;
              /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
              if( SmartConvertSum( BonusRest, BonusRest, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
                 return false;
              end;                      
              AddCostSummFR(SummFRArr, RSD.rec.Portfolio, BonusRest);
           end;
        end;
     end;
   end;
   if( (not (IsSALE(FD.Group) and IsTwoPart(FD.Group))) and (ALL_Amount != 0) ) /*в ПРЕПО нет ФР*/

      if( IsTwoPart(FD.Group) )

         if( SmartConvertSum(CarSumm_od, CarSumm_od, CarDate, FD.FaceFIID(), NATCUR, true) == false )
            return false;
         end;

         var ALLAmountOD = $0, j = 0;
         while( j < SummFRArr.Size )
            ALLAmountOD = ALLAmountOD + SummFRArr[j].Amount;
            j = j + 1;
         end;
         if( ALLAmountOD != 0 )

            i = 0;
            while( i < SummFRArr.Size )
               if( (SummFRArr[i].Portofolio == KINDPORT_BACK) OR (SummFRArr[i].Portofolio == KINDPORT_BACK_KSU))
                  FR = CarSumm_od * (SummFRArr[i].Amount / ALLAmountOD)
                     - SСпво;
               else
                  SСакт = SummFRArr[i].CostSum + SummFRArr[i].InterestIncomeSum + SummFRArr[i].DiscountIncomeSum;
               
                  FR = CarSumm_od * (SummFRArr[i].Amount / ALLAmountOD)
                     - SСакт
                     - SummFRArr[i].OverAmountBuy
                     - IIF(FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind), SummFRArr[i].CorrSum, 0)    // если долговая, тогда списываем корректировку;
               end;

               if( not ОтнесениеФинРезультата(FD, FR, CarDate, SummFRArr[i].Portofolio) )
                  return false;
               end;

               i = i + 1;
            end;
         end;

      else

         RatePVO = ALL_AmountNotPVO / ALL_Amount;
         if( БУ_УчетЗатратПоКомиссиямСделки(FD, CarDate, RatePVO, @CommSum, @CommSumFIID) != 0 )
            return false;
         end;

         if( SmartConvertSum(CommSum, CommSum, CarDate, CommSumFIID, NATCUR, true) == false )
            return false;
         end;

         PreoutlayNotPVO = ROUND(FD.tick.rec.PreOutlay * RatePVO, 2);
         if( БУ_УчетПредварительныхЗатрат(FD, CarDate, PreoutlayNotPVO, FD.tick.rec.PreOutlayFIID, "Реализация, ц/б", NATCUR, "Списание предв. затрат сделки продажи приходящихся на ц/б, проданные не из ПВО") == false )
            return false;
         end;

         if( БУ_УчетПредварительныхЗатрат(FD, CarDate, FD.tick.rec.PreOutlay - PreoutlayNotPVO, FD.tick.rec.PreOutlayFIID, "-КВ, ц/б", NATCUR, "Списание предв. затрат сделки продажи приходящихся на ц/б, проданные из ПВО") == false )
            return false;
         end;

         if( SmartConvertSum(TotalCost, FD.dl_leg.rec.TotalCost, CarDate, FD.dl_leg.rec.CFI, NATCUR, true) == false )
            return false;
         end;

         var PreoutlayNatCur = FD.tick.rec.PreOutlay;
         if( SmartConvertSum(PreoutlayNatCur, PreoutlayNatCur, CarDate, FD.tick.rec.PreOutlayFIID, NATCUR, true) == false )
            return false;
         end;
         
         /* справедливая стоимость ПФИ всегда в рублях */
         DVSSCost = $0;
         if( FD.tick.rec.IsPFI )
            DVSSCost = FD.GetDVSSCostOnDate(CarDate);
         end;

         i = 0;
         while( i < SummFRArr.Size )

            var RatePort = SummFRArr[i].Amount / ALL_Amount;
            var RatePortNotPVO = 0;
            
            if( (ALL_AmountNotPVO != 0) and (SummFRArr[i].Portofolio != KINDPORT_BACK) )
               RatePortNotPVO = SummFRArr[i].Amount / ALL_AmountNotPVO;
            end;

            SСакт = SummFRArr[i].CostSum + SummFRArr[i].InterestIncomeSum + SummFRArr[i].DiscountIncomeSum;
/*
КД Для переходящих сделок
*/
        iF(FD.TICK.rec.dealdate < MGRDate)
            CommSum = 0;
        end;
            
            FR = TotalCost * RatePort
               - IIF(SummFRArr[i].Portofolio == KINDPORT_BACK, SСпво, SСакт)
               - IIF(SummFRArr[i].Portofolio == KINDPORT_BACK, 0.0, PreoutlayNatCur * RatePort)
               - CommSum * RatePort
               - SummFRArr[i].OverAmountBuy
               - IIF(FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind), SummFRArr[i].CorrSum, 0)    // если долговая, тогда списываем корректировку
               - SummFRArr[i].ReservSum                                                       // резервы
               - DVSSCost * RatePort;

            if( not ОтнесениеФинРезультата(FD, FR, CarDate, SummFRArr[i].Portofolio) )
               return false;
            end;

            i = i + 1;
         end;
      end;
   end;

   return true; 
END;


/*Если NoDocsByPmPc = true - не будет проводки по платежу по процентам*/
macro БУ_ВыполнитьПроводкиПроцентовВРепо(FD, dat, NoDocsByPmPc, WasExecRQ:@BOOL)

   var CatDebet = "", CatCredit = "", ground, IsOverdue = false, In, Sum = $0, SumPC = $0, R = $0;
   var DebFIID, CredFIID, CatDebPM = "", CatCredPM = "", groundPM = "";
   var Sum_б = $0;
   var PayerAccountBuffPC = TRecHandler( "account" );
   var ReceiverAccountBuffPC = TRecHandler( "account" );
   var FIRole = FIROLE_CA;

   WasExecRQ = false;
   if( ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_INCREPO) ) )
      IsOverdue = true;
   end;

   if( not IsClientDeal(FD.tick.rec) )
      R = FD.dl_leg.rec.IncomeRate;
      if(not БУ_ВыполнитьДоначислениеПроцентовВРепо(FD, dat, 1))
        return false;
      end;    
   end;

   if (NoDocsByPmPc)
      return true;
   end;

   if (FD.dl_leg.rec.IncomeRate > 0.0)
      if (IsOverdue == false)
//         ground = "Выплата процентов без просрочки";
         ground = "Обязательства по процентам по сделке прямого РЕПО без прек. признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec)  + " от " + FD.tick.rec.dealdate;
      else
         ground = "Выплата просроченных процентов";
      end;
   else
      if (IsOverdue == false)
//         ground = "Получение процентов без просрочки";
		 ground = "Обязательства по процентам по сделке обратного РЕПО без признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec)  + " от " + FD.tick.rec.dealdate;
      
      else
         ground = "Получение просроченных процентов";
      end;
   end;


   if ((( FD.BuySale == DEAL_TYPE_BUY  ) and (FD.dl_leg.rec.IncomeRate > 0.0)) or
       (( FD.BuySale == DEAL_TYPE_SALE ) and (FD.dl_leg.rec.IncomeRate < 0.0))
      )
      In = false;
   else
      In = true;
   end;

   if(ПолучитьСчетаТОПоПроцентам( FD.GetRQ(DLRQ_TYPE_INCREPO), FD, dat, In, PayerAccountBuffPC, ReceiverAccountBuffPC ) != 0)
     return false;
   end;
      
   if( IsClientDeal(FD.tick.rec) )

      if( not In )                                                                
         ground = "Выплата процентов по сделке № "+string(FD.tick.rec.DealCode);                                
      else                                                                          
         ground = "Получение процентов по сделке №"+string(FD.tick.rec.DealCode);                               
      end;                                                                          
       
      if( БУ_ОбработатьДенежноеТО( FD.GetRQ(DLRQ_TYPE_INCREPO), PayerAccountBuffPC, ReceiverAccountBuffPC, FD, dat, ground, NULL, NULL, (not IsControlOrg(FD.tick.rec.ClientID)) ) != 0 )
         return false;
      end;                                                                                                                 
      WasExecRQ = true;
                                                                                                                                        
   elif( IsBUY(FD.Group) or (IsSALE(FD.Group) and IsEXCHANGE(FD.Group)) )
      
      if( (IsSALE(FD.Group) and (FD.dl_leg.rec.IncomeRate > 0.0)) or
          (IsBUY(FD.Group)  and (FD.dl_leg.rec.IncomeRate < 0.0)) 
        )

         if( БУ_ОбработатьДенежноеТО( FD.GetRQ(DLRQ_TYPE_INCREPO), PayerAccountBuffPC, ReceiverAccountBuffPC, FD, dat, ground ) != 0 )
           return false;
         end;
         WasExecRQ = true;
      else
         if( IsOverdue and
             (((R > 0.0) and IsBUY(FD.Group)) or
              ((R < 0.0) and IsSALE(FD.Group))
             ) 
           )
            Sum_б = БУ_ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT_CFI);
         else
            Sum_б = FD.GetRQ(DLRQ_TYPE_INCREPO).rec.Amount;
         end;

         /* Проценты в валюте цены. Переведем в валюту расчетов */
         if( SmartConvertSum(Sum_б, Sum_б, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), true) != true )
            return false;
         end;

         if( not ТОСквитовано(FD.GetRQ(DLRQ_TYPE_INCREPO)) )
            if( НеФормироватьПроводкиПоТО(FD.GetRQ(DLRQ_TYPE_INCREPO)) == false )
			   if (IsBuy(FD.Group)) //обратное РЕПО
			      Ground = "Требования по процентам по сделке обратного РЕПО без прек. признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;
			   else
			      Ground = "Требования по процентам по сделке прямого РЕПО без прек. признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec) + " от " + FD.tick.rec.dealdate;
			   end;
                if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     PayerAccountBuffPC, ReceiverAccountBuffPC,/* КатегДеб , КатегКредит*/
                                                     dat,                  /* Дата */
                                                     1,                    /* Глава */
                                                     FD.GetPayFIID(),      /* Валюта */
                                                     Sum_б,                /* Сумма  */
                                                     INPCARRY,             /* Result_Carry */
                                                     " 1",                 /* Kind_Oper */
                                                     "",                   /* Numb_Document */
                                                     Ground/*"Проценты на балансе по сделке № " + string(FD.tick.rec.DealCode)*/, null,null,null,
                                                     PayerAccountBuffPC.rec.Code_Currency, ReceiverAccountBuffPC.rec.Code_Currency     /* валюты счетов: Дт - Кт */ 
                                                   )
                 )
                  return false;
               end;
            end;
         end;

      end;

   end;

   return true;
end;

macro БУ_ПроводкиПоОплатеПриПродаже(FD, dat)
  var rq_money = TRecHandler("dlrq.dbt");

  rq_money = FD.GetRQ(DLRQ_TYPE_PAYMENT);
  
  /*внебиржевая*/
  if(IsOUTEXCHANGE(FD.Group))
    if( (not IsClientDeal(FD.tick.rec)) AND 
        (FD.ExistDeposit == true) AND /*есть платеж задатка - выполним его зачет*/
        (not ТОБылоПросрочено(rq_money)) AND
        (rq_money.rec.State != DLRQ_STATE_OVERDUE) 
      )
       if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            "-Расчеты", "+Форвард, расчеты", /* КатегДеб , КатегКредит*/
                                            dat,                    /* Дата  */
                                            1 ,                     /* Глава */
                                            FD.GetPayFIID(),   /* Валюта*/
                                            FD.GetRQPayAmount(DLRQ_TYPE_DEPOSIT, dat), /* Сумма */
                                            INPCARRY,               /* Result_Carry   */
                                            " 1",                   /* Kind_Oper      */
                                            FD.tick.rec.DealCode,        /* Numb_Document */
                                            "Зачет суммы уплаченного задатка", /* Ground */
                                            null, null, null
                                          )
         )
           return 1;
       end;
    end;
  end;

  if( not БУ_СписатьРезерв( FD, Dat ) )
     return 1;
  end;

  if( БУ_СделатьПроводкиПоОплате_БезПросрочки_ПриПродаже(FD, dat) != 0)
     return 1;
  end;

  return 0;
end;

/* RealizSumm - сумма ПД и НКДУпл, кот. прошла(или могла пройти) по счету "Реализация, ц/б" в проводках погашения посл. купона (нужна для расчета ФР) */
MACRO БУ_СписаниеСебестоимостиПриПогашении( FD:SPFirstDoc, CarDate:DATE, RealizSumm:TArray ):BOOL
   VAR i = 0, Groups = TArray(), SQLQuery, RSD,
       AccCredit, FIIDCredit, AccDebet, FIIDDebet,
       FR = $0, SСакт = $0,
       sum_ov_negative = $0, sum_dk_negative = $0,
       sum_ov_positive = $0, sum_dk_positive = $0,
       TotalCost = $0, Cost = $0, BonusRest = $0;
   var cmd, query, DataSet;

   VAR ALL_CostBuy             = $0, CostBuy             = $0, // Списанная чистая стоимость (Счист)
       ALL_BalanceCostBuy      = $0, BalanceCostBuy      = $0, // Списанная текущая стоимость 
       ALL_NKDBuy              = $0, NKDBuy              = $0, // НКД ( S(НКД упл.))
       ALL_InterestIncomeBuy   = $0, InterestIncomeBuy   = $0, // Списанный начисленный ПД 
       ALL_DiscountIncomeBuy   = $0, DiscountIncomeBuy   = $0, // Cписанный начисленный ДД 
       ALL_NotCarryInterestBuy = $0, NotCarryInterestBuy = $0, // Списанный не отнесенный на доходы ПД  
       ALL_NotCarryDiscountBuy = $0, NotCarryDiscountBuy = $0, // Списанный не отнесенный на доходы ДД  
       ALL_InterestIncomeAdd   = $0, InterestIncomeAdd   = $0, // Доначисленный ПД S(Sдонач.ПДi)
       ALL_DiscountIncomeAdd   = $0, DiscountIncomeAdd   = $0, // Доначисленный ДД S(Sдонач.ДДi)
       ALL_NotCarryInterestAdd = $0, NotCarryInterestAdd = $0, // Доначисленный не отнесенный на доходы ПД  
       ALL_NotCarryDiscountAdd = $0, NotCarryDiscountAdd = $0, // Доначисленный не отнесенный на доходы ДД  
                                     InterestIncomeSum   = $0, // Суммарный начисленный ПД S(ПДначисл)
                                     DiscountIncomeSum   = $0, // Суммарный начисленный ДД S(ДДначисл)
                                     NotCarryInterestSum = $0, // Суммарный не отнесенный на доходы ПД  S(ПДне_отн)
                                     NotCarryDiscountSum = $0, // Суммарный не отнесенный на доходы ДД  S(ДДне_отн)
       ALL_BalanceCostSum      = $0, BalanceCostSum      = $0, // Суммарная текущая стоимость ( (Стек))
       ALL_OutlayBuy           = $0, OutlayBuy           = $0, // Списанные затраты
       ALL_OverAmountBuy       = $0, OverAmountBuy       = $0, // Списанная сумма переоценки S(ПО)
       ReservAmountBuy         = $0, // Списанная сумма резерва (Сумма созданного резерва)
       IncomeReservBuy         = $0, BonusAdd            = $0, 
       CostSum                 = $0,
       ALL_CostSum             = $0,
       ALL_BonusAdd            = $0, Amount = $0,
       ReservAmountAdd         = $0, IncomeReservAdd     = $0, // Доначисленные резерв и резерв по ПДД
       ReservAmountSum         = $0, IncomeReservSum     = $0, // Суммарные резерв и резерв по ПДД
       EstReserveAdd           = $0, CorrEstReserveAdd   = $0, // Доначисленные оценочный резерв и корректировка резерва
       EstReserveSum           = $0, CorrEstReserveSum   = $0, // Суммарный списываемый оценочный резерв и его корректировка
       OverAmountAdd           = $0, OverAmountSum       = $0, // Доначисленная и суммарная переоценки
       CorrValueBuy            = $0,                           // Списанная сумма корректировки СС
                                     CorrIntToEIRSum     = $0; // Суммарная списываемая корректировка % до ЭПС
   VAR AccDebetFIRole, AccCreditFIRole;
   var SumReservFR = $0;

   var IsCouponAvoiriss = FI_IsCouponAvoiriss(FD.fininstr);
   var SummFRArr = TArray();
   Var Ground = "";
   var err = 0;
   if( IsClientDeal(FD.tick.rec) )
      return true;
   end;

   if( SmartConvertSum(TotalCost, FD.dl_leg.rec.TotalCost, CarDate, FD.dl_leg.rec.CFI, NATCUR, true) == false )
      return false;
   end;

   ПолучитьГруппыСписания( FD, Groups );


   while( i < Groups.Size )

      AccDebet  = "Начисл.ПДД, ц/б";
      FIIDDebet = FD.FaceFIID();

      AccCredit  = "+%ДЦ/б";
      FIIDCredit = NATCUR;

      ALL_CostSum = $0;
      ALL_OverAmountBuy = $0;
      SumReservFR = $0;
      SummFRArr[i] = SummFR(Groups[i]);

      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                                   @CostBuy,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   @OverAmountAdd      ,
                                   @OverAmountSum      ,
                                   @ReservAmountBuy    ,
                                   @ReservAmountAdd    ,
                                   @ReservAmountSum    ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   @Amount             ,
                                   @IncomeReservBuy    ,
                                   @IncomeReservAdd    ,
                                   @IncomeReservSum    ,
                                   @BonusAdd           ,
                                   @CostSum            ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   null                ,
                                   @BonusRest          ,
                                   NULL                ,
                                   NULL,
                                   NULL,
                                   NULL,
                                   @CorrValueBuy       ,
                                   NULL,
                                   NULL,
                                   @CorrIntToEIRSum    ,
                                   NULL,
                                   @EstReserveAdd      ,
                                   @EstReserveSum      ,
                                   NULL,
                                   @CorrEstReserveAdd  ,
                                   @CorrEstReserveSum  ,
                                   NULL,
                                   NULL
                                 ) != true )
         return false;
      end;

      ALL_CostBuy             = ALL_CostBuy              + CostBuy            ;
      ALL_BalanceCostBuy      = ALL_BalanceCostBuy       + BalanceCostBuy     ;
      ALL_NKDBuy              = ALL_NKDBuy               + NKDBuy             ;
      ALL_InterestIncomeBuy   = ALL_InterestIncomeBuy    + InterestIncomeBuy  ;
      ALL_DiscountIncomeBuy   = ALL_DiscountIncomeBuy    + DiscountIncomeBuy  ;
      ALL_NotCarryInterestBuy = ALL_NotCarryInterestBuy  + NotCarryInterestBuy;
      ALL_NotCarryDiscountBuy = ALL_NotCarryDiscountBuy  + NotCarryDiscountBuy;
      ALL_InterestIncomeAdd   = ALL_InterestIncomeAdd    + InterestIncomeAdd  ;
      ALL_DiscountIncomeAdd   = ALL_DiscountIncomeAdd    + DiscountIncomeAdd  ;
      ALL_NotCarryInterestAdd = ALL_NotCarryInterestAdd  + NotCarryInterestAdd;
      ALL_NotCarryDiscountAdd = ALL_NotCarryDiscountAdd  + NotCarryDiscountAdd;
      ALL_OutlayBuy           = ALL_OutlayBuy            + OutlayBuy          ;
      ALL_BonusAdd            = ALL_BonusAdd             + BonusAdd           ;

      SummFRArr[i].OverAmountBuy = SummFRArr[i].OverAmountBuy + OverAmountSUM ;
      SummFRArr[i].CorrSum = SummFRArr[i].CorrSum + CorrValueBuy + CorrIntToEIRSum;

      //if( Groups[i] == KINDPORT_SALE ) /*СССД_ЦБ*/
         ALL_OverAmountBuy = ALL_OverAmountBuy + OverAmountSUM;
      //end;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE) OR  /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE)   /*АС_ЦБ*/
        )
         if( DiscountIncomeAdd != 0 )
/* Временно до разбора
            if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                               AccDebet, AccCredit,         /* КатегДеб, КатегКредит*/
                                               CarDate,                     /* Дата */
                                               1,                           /* Глава */
                                               FD.FaceFIID(),               /* Валюта */
                                               DiscountIncomeAdd,           /* Сумма Sдонач.ДДi*/
                                               INPCARRY,                    /* Result_Carry */
                                               " 1",                        /* Kind_Oper */
                                               "",                          /* Numb_Document */
                                               "Доначисление ПДД для ц/б, купленных по цене ниже номинала",
                                               null,
                                               GetFIRoleByPortfolio(Groups[i], true),
                                               GetFIRoleByPortfolio(Groups[i], true),
                                               FIIDDebet, FIIDCredit
                                             )
              )
               return false;
            end;
*/
         end;

         if (BonusAdd != 0) 
            if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                               "-Премия, ц/б", "Премия, ц/б", /* КатегДеб, КатегКредит */
                                               CarDate,                     /* Дата */
                                               1,                           /* Глава */
                                               FD.FaceFIID(),               /* Валюта */
                                               BonusAdd,                          /* Сумма */
                                               INPCARRY,                    /* Result_Carry */
                                               " 1",                        /* Kind_Oper */
                                               "",                          /* Numb_Document */
                                               "Списание начисленной премии на расходы",
                                               null,
                                               GetFIRoleByPortfolio(Groups[i], false, false, false, false, true),
                                               GetFIRoleByPortfolioBonus(Groups[i])
                                             )
              )
               return false;
            end;
         end;
      end;
      if( not IsCouponAvoiriss )
         if( InterestIncomeAdd != 0 )
            if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                  AccDebet, AccCredit,         /* КатегДеб, КатегКредит*/
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  FD.FaceFIID(),               /* Валюта */
                                                  InterestIncomeAdd,           /* Сумма Sдонач.ПДi*/
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  "Доначисление ПДД для процентных облигаций",
                                                  null,
                                                  GetFIRoleByPortfolio(Groups[i], false, true),
                                                  GetFIRoleByPortfolio(Groups[i], false, true),
                                                  FIIDDebet, FIIDCredit
                                                )
              )
               return false;
            end;
         end;
      end;
      if ( (Groups[i] == KINDPORT_TRADE) or (Groups[i] == KINDPORT_SALE) )
         if (БУ_ВыполнитьПереоценкуПриПродаже(FD, Groups[i], OverAmountAdd, CarDate ) == false )
            return false;
         end;
      end;

      if( DiscountIncomeSum != 0 )
         Ground = "Списание дисконтного дохода при выбытии по ЦБ " + GetFinName(Fd.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                "Реализация, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                CarDate,                     /* Дата */
                1,                           /* Глава */
                FD.FaceFIID(),               /* Валюта */
                DiscountIncomeSum,           /* Сумма  ДДначисл*/
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                Ground/*"Списание дисконтного дохода"*/,
                null,
                null,
                GetFIRoleByPortfolio( Groups[i], true )
               ) 
           )
             return false;
         end;
      end;

      if( not IsCouponAvoiriss )
         if( InterestIncomeSum != 0 )
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   "Реализация, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   InterestIncomeSum,           /* Сумма  ПДначисл*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание процентного дохода",
                   null,
                   null,
                   GetFIRoleByPortfolio( Groups[i], false, true )
                  ) 
              )
                return false;
            end;
         end;
      end;

      var CorrSum = CorrValueBuy + CorrIntToEIRSum;
      if (CorrSum != 0)
         AccDebet  = IIF(CorrSum > 0, "-Маржа, ц/б", "-Корректировка, ц/б");
         AccCredit = IIF(CorrSum > 0, "+Корректировка, ц/б", "+Маржа, ц/б");
         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      AccDebet, AccCredit,       /* КатегДеб , КатегКредит*/
                      CarDate,                   /* Дата */
                      1,                         /* Глава */
                      NATCUR,                    /* Валюта */
                      abs(CorrSum),         /* Сумма  Счист*/
                      INPCARRY,                  /* Result_Carry */
                      " 1",                      /* Kind_Oper */
                      "",                        /* Numb_Document */
                      "Списание корректировок",
                      null,
                      iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i])),
                      iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i]))
                    ) 
                 )
                return false;
          end;
      end;

         Cost = CostSum;

      var WrtCostSum = money(Cost - BonusRest);


      query = "select NVL(SUM(lnk.t_CostPFIBuy), 0) CostPFIBuy " +
              "  from dpmwrtlnk_dbt lnk, v_scwrthistex buylot " +
              " where buylot.t_SumID = lnk.t_BuyID " +
              "   and buylot.t_Instance = lnk.t_BuyInstance-1 " +
              "   and lnk.t_SaleID   = ? " +
              "   and buylot.t_Portfolio = ? ";

      cmd = DL_RSDCommand(query);

      cmd.addParam(FD.pmwrtsum.rec.SumID);
      cmd.addParam(Groups[i] );
      DataSet = cmd.execute();

      if(DataSet.moveNext())
        WrtCostSum = WrtCostSum + DataSet.CostPFIBuy;
      end;


      if( WrtCostSum != 0 )
         Ground = "Списание вложений при выбытии по ЦБ " + GetFinName(Fd.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                "Реализация, ц/б", "Наш портфель ц/б",/* КатегДеб , КатегКредит*/
                CarDate,                     /* Дата */
                1,                           /* Глава */
                FD.GetAccFIID("Наш портфель ц/б"), /* Валюта */
                WrtCostSum,            /* Сумма  Счист*/
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                Ground/*"Списание балансовой стоимости9"*/,
                null,
                null,
                GetFIRoleByPortfolio( Groups[i] )
               ) 
           )
             return false;
         end;
         /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
         if( SmartConvertSum( WrtCostSum, WrtCostSum, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
            return false;
         end;                      
         ALL_CostSum = ALL_CostSum + WrtCostSum;
      end;

      if( BonusRest != 0 )
         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                "Реализация, ц/б", "Премия, ц/б",/* КатегДеб , КатегКредит*/
                CarDate,                     /* Дата */
                1,                           /* Глава */
                FD.FaceFIID(),               /* Валюта */
                BonusRest,                   /* Сумма  Счист*/
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                "Списание премии",
                null,
                null,
                GetFIRoleByPortfolioBonus(Groups[i])
               ) 
           )
             return false;
         end;
         /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
         if( SmartConvertSum( BonusRest, BonusRest, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
            return false;
         end;                      
         ALL_CostSum = ALL_CostSum + BonusRest;
      end;
      if( (Groups[i] == KINDPORT_SALE) or (Groups[i] == KINDPORT_TRADE) ) /*продажа лота из ССПУ_ЦБ или ССПД_ЦБ*/ 
         if( БУ_ВыполнитьСписаниеПереоценки( FD, Groups[i], OverAmountSum, CarDate ) == false) 
            return false;
         end;
      end;

      if (EstReserveSum == 0)
        EstReserveSum = CorrEstReserveSum;
            end;

      if( БУ_СписаниеРезерваПоЦБ( FD, CarDate, Groups[i], ReservAmountSum, IncomeReservSum, EstReserveSum, @SumReservFR) == false )
         return false;
      end;
      SummFRArr[i].ReservSum = SummFRArr[i].ReservSum + SumReservFR; // сумма списаного резерва

      /* для ФР сконвертированные данные из ВН в НацВ, округленные до копеек */
      if( SmartConvertSum(InterestIncomeSum, InterestIncomeSum, CarDate, FD.FaceFIID(), NATCUR, true) == false )
         return false;
      end;

      if( SmartConvertSum(DiscountIncomeSum, DiscountIncomeSum, CarDate, FD.FaceFIID(), NATCUR, true) == false )
         return false;
      end;                      

      SСакт = ALL_CostSum + InterestIncomeSum + DiscountIncomeSum;

      var RealizSummI:money = $0.0;
      if( (RealizSumm != null) and (RealizSumm[i] != NULL) )
         RealizSummI = RealizSumm[i];
      end;

      FR = TotalCost * (Amount / FD.dl_leg.rec.Principal)
         - SСакт
         - RealizSummI
//         - SummFRArr[i].CorrSum 
         - ALL_OverAmountBuy
         - SummFRArr[i].ReservSum;

      if( not ОтнесениеФинРезультата(FD, FR, CarDate, Groups[i]) )
         return false;
      end;

      i = i + 1;
   end;

   return true; 
END;

PRIVATE MACRO БУ_УчетРЕПО_ДляПогашений( FD:SPFirstDoc, CarDate:DATE, IsRetCoupon:BOOL ):BOOL
  var cmd, DS, Sum = $0, CatCredit = "",CatCreditMi = "",  FiRoleCredit,FiRoleCreditMi, FIIDCredit:integer = ALLFININSTR, FIIDCreditMi:integer = ALLFININSTR;
  var WrtRetAcc = TRecHandler( "account" ); 
  Var AllSumORCOup = 0, IsRasch = false;
  if( IsClientDeal(FD.tick.rec) )
     return true;
  end;

  if( not FD.OpenAccount(СчетСписанияСредствЗаПогашение(FD), null, null, null, WrtRetAcc, CarDate, FD.GetPayFIID()) )
     return false;
  end;

  cmd = RSDCommand( "SELECT Link.t_CostSale CostSale, Link.t_NKDSaleAmount NKDSaleAmount, deal.t_Flag5, deal.t_DealID "+
                    "  FROM DPMWRTLNK_DBT Link, DPMWRTSUM_DBT LotBuy, DDL_TICK_DBT Deal "+
                    " WHERE     Link.T_SALEID      = ? "+
                    "       AND LotBuy.T_SUMID     = Link.T_BUYID  "+
                    "       AND LotBuy.t_Portfolio = 6 /*ПВО*/ "+
                    "       AND LotBuy.t_DealID > 0 " +
                    "       AND LotBuy.t_DocKind = 29 /*DLDOC_PAYMENT*/ " +
                    "       AND deal.t_DealID = LotBuy.t_DealID " 
        );
  cmd.addParam( "", RSDBP_IN, FD.pmwrtsum.rec.SumID );
  cmd.execute();
  DS = TRsbDataSet(cmd);
  while( DS.movenext() )
     if (IsRetCoupon)
        Sum = SQL_ConvTypeSum(DS.NKDSaleAmount);
     else
        Sum = SQL_ConvTypeSum(DS.CostSale);
     end;

     if( DS.Flag5 == "X" )
        IsRasch = true;
//        CatCredit = "+Расчеты";
        CatCredit = "+РасчетыПогОР";
        FIIDCredit = FD.FaceFIID();
        FiRoleCredit = FIROLE_EMIT_INC_TR;

//        CatCreditMi = "-Расчеты";
        CatCreditMi = "-РасчетыПогОР";
        FIIDCreditMi = FD.FaceFIID();
        FiRoleCreditMi = FIROLE_EMIT_INC_TR;

     else
        CatCredit = "+Маржа, проч.";
        FIIDCredit = NATCUR;
        FiRoleCredit = null;
     end;

     if (Sum != 0)
        var summa = $0, currency = NATCUR;
        if( FD.FaceFIID() != FD.GetPayFIID() )
           if( not SmartConvertSum(summa, Sum, CarDate, FD.FaceFIID(), FD.GetPayFIID(), true) )
              return false;
           end;
           currency = FD.GetPayFIID();
        else
           summa = Sum;
           currency = FD.FaceFIID();
        end;

        AllSumORCOup = AllSumORCOup + summa;

        if( not БУ_ПроводкаПоКатегориямУчета( SPFirstDoc(LEG_KIND_DL_TICK, DS.DealID), /*Из SPFirstDoc только к/агент нужен, поэтому часть сделки не важна*/
                                              WrtRetAcc, CatCredit, /* КатегДеб , КатегКредит*/
                                              CarDate,              /* Дата */
                                              1,                    /* Глава */
                                              currency,             /* Валюта */
                                              summa,                /* Сумма  */
                                              INPCARRY,             /* Result_Carry */
                                              " 1",                 /* Kind_Oper */
                                              "",                   /* Numb_Document */
                                              IIF(IsRetCoupon,"Купоны","ЧП") + " по ц/б, полученным без первоначального признания по договорам займа и РЕПО",
                                              null,
                                              null, FiRoleCredit,
                                              null, FIIDCredit
                                             )
          )
           return false;
        end;
     end;
  end;
      If(IsRasch)
        if( not БУ_ПроводкаПоКатегориямУчета( SPFirstDoc(LEG_KIND_DL_TICK, DS.DealID), /*Из SPFirstDoc только к/агент нужен, поэтому часть сделки не важна*/
                                              CatCredit, CatCreditMi, /* КатегДеб , КатегКредит*/
                                              CarDate,              /* Дата */
                                              1,                    /* Глава */
                                              currency,             /* Валюта */
                                              AllSumORCOup,                /* Сумма  */
                                              INPCARRY,             /* Result_Carry */
                                              " 1",                 /* Kind_Oper */
                                              "",                   /* Numb_Document */
                                              "Требования по " + IIF(IsRetCoupon,"купону","ЧП") + " по ц/б, полученным без первоначального признания по договорам займа и РЕПО",
                                              null,
                                              FiRoleCredit, FiRoleCreditMi,
                                              FIIDCredit, FIIDCreditMi
                                             )
          )
           return false;
        end;
      end;

  return true;
END;

PRIVATE MACRO БУ_СписаниеДохПоКуплДоДатыПеречняИпрод_ДляПогашений( FD:SPFirstDoc, CarDate:DATE, Portfolio:integer, Amount:MONEY, IsRetCoupon:BOOL ):BOOL

  var PayerAccountBuff = TRecHandler( "account" );
  var wrtcalc = TRecHandler( "pmwrtsum.dbt" ); 
  var СумПрод = $0, КолвоНаДсост = $0;
  var AccCredit = "", AccDebet = "";
  var ground = "";
  
  if( FD.dl_leg.rec.Start != FD.tick.rec.DealDate )

     wrtcalc.Clear();
     if( WRT_Calc( FD.tick.rec.Department, FD.fininstr.rec.FIID, -1, 0, Portfolio, FD.dl_leg.rec.Start, wrtcalc, true, false ) == true )
        КолвоНаДсост = wrtcalc.rec.Amount;

        //За период с даты составления перечня до даты выполнения погашения бумаги могли быть не проданы, а перемещены в другой портфель
        //Тогда надо это значение скомпенсировать, чтобы они не считались проданными и не было проводки
        var query, cmd, DataSet;

        query =   " select NVL(SUM(lnk.t_Amount*(CASE WHEN cm.t_SrcPortfolio = ? THEN -1 ELSE 1 END)), 0) as AddAmount "
                + "   from ddl_comm_dbt cm, doproper_dbt op, dpmwrtlnk_dbt lnk "
                + "  where cm.t_DocKind = " + DL_MOVINGDOC
                + "    and cm.t_CommDate >= ? "
                + "    and cm.t_CommDate <= ? "
                + "    and cm.t_FIID = ? "
                + "    and (cm.t_SrcPortfolio = ? or cm.t_DestPortofolio = ?) "
                + "    and op.t_DocKind = cm.t_DocKind "
                + "    and op.t_DocumentID = LPAD(cm.t_DocumentID, 34, '0') "
                + "    and lnk.t_ID_Operation = op.t_ID_Operation ";


        cmd = DL_RSDCommand(query);

        cmd.AddParam(Portfolio);
        cmd.AddParam(FD.dl_leg.rec.Start);
        cmd.AddParam(FD.tick.rec.DealDate);
        cmd.AddParam(FD.tick.rec.PFI);
        cmd.AddParam(Portfolio);
        cmd.AddParam(Portfolio);

        DataSet = cmd.Execute();

        if(DataSet.moveNext())
          //DataSet.AddAmount будет со знаком "-" для исходного портфеля, т.к. сейчас в Amount уже эти бумаги отсутствуют, т.к. из него бумаги уже ушли. Но выбытием это не считаем
          //А в целевой портфель они уже пришли, т.е. в Amount они есть, поэтому добавим их со знаком "+" в КолвоНаДсост 
          КолвоНаДсост = КолвоНаДсост + DataSet.AddAmount;
        end;
     end;

     if( КолвоНаДсост > $0 )
        СумПрод = (iif(IsRetCoupon,FD.dl_leg.rec.NKD,FD.dl_leg.rec.Cost) / FD.dl_leg.rec.Principal) * (КолвоНаДсост - Amount);
     end;

  end;

  if( СумПрод > $0 )
  
      AccDebet = СчетСписанияСредствЗаПогашение( FD );
      if( AccDebet == "Корсчет" )
         if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayerAccountBuff) != 0)
            Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(FD.tick.rec.PartyID) );
            return false;
         end; 
      end;

     
/*КД: на 47422 */  
      ground = "Требования по погашению купона по ЦБ " + GetFinName(Fd.fininstr.rec) + ", количество " + UserGetKol(КолвоНаДсост - Amount, FD.fininstr.rec.avoirkind)+ " шт, по внебиржевым сделкам ";
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             IIF((AccDebet == "Корсчет"),PayerAccountBuff,AccDebet), "-РасчетыПогаш",/*iif(Portfolio == KINDPORT_BACK,"+Маржа, проч.","+%ДЦ/б"),*//* КатегДеб , КатегКредит*/
             CarDate,                     /* Дата */
             1,                           /* Глава */
             iif(IsRetCoupon,FD.NKDFIID(),FD.FaceFIID()),               /* Валюта */
             СумПрод,                     /* Сумма  ДДначисл*/
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             ground/*"Списание дохода по ц/б, купленным до даты составления перечня и проданным между датой составления перечня и датой погашения. ЦБ " + GetFinName(Fd.fininstr.rec)*/ ,
             null,
             null,
             iif(Portfolio == KINDPORT_BACK, null, GetFIRoleByPortfolio(Portfolio))
            ) 
        )
          return false;
      end;

  end;

  return true;
END;

MACRO БУ_ПроводкиЧастичногоПогашения( FD:SPFirstDoc, CarDate:DATE ):BOOL

   var PayerAccountBuff = TRecHandler( "account" );
   VAR i = 0, Groups = TArray(),
       AccCredit, FIIDCredit, AccDebet = "", FIIDDebet, SumKind, Дисконт0_корр = $0, DefDiff0_корр = $0,
       AccDebetFIRole, AccCreditFIRole;

   VAR Amount = $0,
       CostBuy             = $0, // Списанная чистая стоимость (Счист)
       BalanceCostBuy      = $0, // Списанная текущая стоимость 
       NKDBuy              = $0, // НКД ( S(НКД упл.))
       InterestIncomeBuy   = $0, // Списанный начисленный ПД 
       DiscountIncomeBuy   = $0, // Cписанный начисленный ДД 
       NotCarryInterestBuy = $0, // Списанный не отнесенный на доходы ПД  
       NotCarryDiscountBuy = $0, // Списанный не отнесенный на доходы ДД  
       InterestIncomeAdd   = $0, // Доначисленный ПД S(Sдонач.ПДi)
       DiscountIncomeAdd   = $0, // Доначисленный ДД S(Sдонач.ДДi)
       NotCarryInterestAdd = $0, // Доначисленный не отнесенный на доходы ПД  
       NotCarryDiscountAdd = $0, // Доначисленный не отнесенный на доходы ДД  
       InterestIncomeSum   = $0, // Суммарный начисленный ПД S(ПДначисл)
       DiscountIncomeSum   = $0, // Суммарный начисленный ДД S(ДДначисл)
       NotCarryInterestSum = $0, // Суммарный не отнесенный на доходы ПД  S(ПДне_отн)
       NotCarryDiscountSum = $0, // Суммарный не отнесенный на доходы ДД  S(ДДне_отн)
       BalanceCostSum      = $0, // Суммарная текущая стоимость ( (Стек))
       OutlayBuy           = $0, // Списанные затраты
       OverAmountBuy       = $0, // Списанная сумма переоценки S(ПО)
       BalanceCostBD       = $0,
       CostSale            = $0, 
       CostSum             = $0,
       BonusAdd            = $0,
       AccounttedDefDiffAdd= $0,
       CorrIntToEIRAdd     = $0,
       EstReserveAdd = $0, CorrEstReserveAdd = $0; //Доначисленные оценочный резерв и корректировка резерва
   Var Ground = ""; 


   if( IsClientDeal(FD.tick.rec) )

      AccDebet = СчетСписанияСредствЗаПогашение( FD );
      if( AccDebet == "Корсчет" )
         if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayerAccountBuff) != 0)
            Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(FD.tick.rec.PartyID) );
            return false;
         end;
      end;

      var summa = $0, currency = NATCUR;
      if( FD.FaceFIID() != FD.GetPayFIID())
        if( not SmartConvertSum( summa, FD.dl_leg.rec.Cost, CarDate, FD.FaceFIID, FD.GetPayFIID(), true))
           return false;
        end;
        currency = FD.GetPayFIID();
      else
          summa = FD.dl_leg.rec.Cost;
          currency = FD.FaceFIID();
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             IIF((AccDebet == "Корсчет"),PayerAccountBuff,AccDebet), FD.pm_money.ReceiverAccountRec(),/* КатегДеб , КатегКредит*/
             CarDate,                     /* Дата */
             1,                           /* Глава */
             currency,                    /* Валюта */
             summa,                       /* Сумма*/
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             "Частичное погашение для клиента"
            ) 
        )
          return false;
      end;

      return true;
   end;

   ПолучитьГруппыСписания( FD, Groups );

   while( i < Groups.Size )
      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                               @CostBuy            ,
                               @BalanceCostBuy     ,
                               @NKDBuy             ,
                               @InterestIncomeBuy  ,
                               @DiscountIncomeBuy  ,
                               @NotCarryInterestBuy,
                               @NotCarryDiscountBuy,
                               @InterestIncomeAdd  ,
                               @DiscountIncomeAdd  ,
                               @NotCarryInterestAdd,
                               @NotCarryDiscountAdd,
                               @InterestIncomeSum  ,
                               @DiscountIncomeSum  ,
                               @NotCarryInterestSum,
                               @NotCarryDiscountSum,
                               @BalanceCostSum     ,
                               @OutlayBuy          ,
                               @OverAmountBuy      ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @BalanceCostBD      ,
                               @CostSale           ,
                               NULL                ,
                               @Amount             ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @BonusAdd           ,
                               @CostSum            ,
                               NULL,
                               NULL,
                               NULL,
                               NULL,
                               NULL,
                               NULL,
                               NULL,
                               NULL,
                               @AccounttedDefDiffAdd,
                               NULL,
                               NULL,
                               NULL,
                               @CorrIntToEIRAdd,
                               NULL,
                               NULL,
                               @EstReserveAdd      ,
                               NULL,
                               NULL,
                               @CorrEstReserveAdd  
                             ) != true )
         return false;
      end;

      AccDebet  = "Начисл.ПДД, ц/б";
      FIIDDebet = FD.FaceFIID();

      AccCredit  = "+%ДЦ/б";
      FIIDCredit = NATCUR;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE) OR  /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE)   /*АС_ЦБ*/
        )
         if( DiscountIncomeAdd != 0 )
            if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                  AccDebet, AccCredit,         /* КатегДеб, КатегКредит*/
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  FD.FaceFIID(),               /* Валюта */
                                                  DiscountIncomeAdd,           /* Сумма Sдонач.ДДi*/
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  "Доначисление дисконтного дохода",
                                                  null,
                                                  GetFIRoleByPortfolio(Groups[i], true),
                                                  GetFIRoleByPortfolio(Groups[i], true),
                                                  FIIDDebet, FIIDCredit
                                                ) 
              )
               return false;
            end;
         end;

         if( CheckCalcDiscountWithoutPartly() )

            if( Groups[i] == KINDPORT_TRADE )
               SumKind = DLSUM_KIND_SUM_DISCOUNT0_KORR_TP;
            elif( Groups[i] == KINDPORT_SALE )
               SumKind = DLSUM_KIND_SUM_DISCOUNT0_KORR_PPR;
            elif( Groups[i] == KINDPORT_RETIRE )
               SumKind = DLSUM_KIND_SUM_DISCOUNT0_KORR_PUDP;
            end;

            Дисконт0_корр = БУ_ПолучитьПоследнююСумму( FD.tick.rec.BofficeKind, FD.tick.rec.DealID, SumKind, CarDate, null, FD.GetBaseFIID() );

            if( Дисконт0_корр != 0 )
               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     AccDebet, AccCredit,         /* КатегДеб, КатегКредит*/
                                                     CarDate,                     /* Дата */
                                                     1,                           /* Глава */
                                                     FD.FaceFIID(),               /* Валюта */
                                                     Дисконт0_корр,               /* Сумма Дисконт0_корр*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     "Дополнительное начисление дисконтного дохода",
                                                     null,
                                                     GetFIRoleByPortfolio(Groups[i], true),
                                                     GetFIRoleByPortfolio(Groups[i], true),
                                                     FIIDDebet, FIIDCredit
                                                   ) 
                 )
                  return false;
               end;
            end;

         end;

         if (BonusAdd != 0) 
            Ground = "Списание начисленной премии на расходы по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
            if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                  "-Премия, ц/б", "Премия, ц/б", /* КатегДеб, КатегКредит */
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  FD.FaceFIID(),               /* Валюта */
                                                  BonusAdd,                          /* Сумма */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  Ground/*"Списание начисленной премии на расходы"*/,
                                                  null,
                                                  GetFIRoleByPortfolio(Groups[i], false, false, false, false, true),
                                                  GetFIRoleByPortfolioBonus(Groups[i])
                                                )
              )
               return false;
            end;
         end;

         if( AccounttedDefDiffAdd != 0)
            AccDebet  = IIF(AccounttedDefDiffAdd > 0, "-КорЭПС_%, ц/б", "-Маржа, ц/б");   
            AccCredit = IIF(AccounttedDefDiffAdd > 0, "+Маржа, ц/б", "+КорЭПС_%, ц/б"); 
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   NATCUR,                      /* Валюта */
                   abs(AccounttedDefDiffAdd),    /* Сумма корректировки до ЭПС*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Корректировка отсроченной разницы",
                   null,
                   GetFIRoleByPortfolio(Groups[i]),
                   GetFIRoleByPortfolio(Groups[i])
                  ) 
              )
                return false;
            end;   
         end;

         if(CheckCalcDefDiffWithoutPartly())

           if( Groups[i] == KINDPORT_SSPU )
              SumKind = DLSUM_SUM_DEFDIFF0_KORR_TP;
           elif( Groups[i] == KINDPORT_SSSD )
              SumKind = DLSUM_SUM_DEFDIFF0_KORR_PPR;
           elif( Groups[i] == KINDPORT_ASCB )
              SumKind = DLSUM_SUM_DEFDIFF0_KORR_PUDP;
           end;

           DefDiff0_корр = БУ_ПолучитьПоследнююСумму( FD.tick.rec.BofficeKind, FD.tick.rec.DealID, SumKind, CarDate, null, FD.GetBaseFIID() );

           if(DefDiff0_корр != 0)
             AccDebet  = IIF(DefDiff0_корр > 0, "-КорЭПС_%, ц/б", "-Маржа, ц/б");   
             AccCredit = IIF(DefDiff0_корр > 0, "+Маржа, ц/б", "+КорЭПС_%, ц/б"); 
             if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                    AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                    CarDate,                     /* Дата */
                    1,                           /* Глава */
                    NATCUR,                      /* Валюта */
                    abs(DefDiff0_корр),          /* Сумма корректировки до ЭПС*/
                    INPCARRY,                    /* Result_Carry */
                    " 1",                        /* Kind_Oper */
                    "",                          /* Numb_Document */
                    "Дополнительная корректировка отсроченной разницы",
                    null,
                    GetFIRoleByPortfolio(Groups[i]),
                    GetFIRoleByPortfolio(Groups[i])
                   ) 
               )
                 return false;
             end;
           end;
         end;
         
         if( CorrIntToEIRAdd != 0 )
            AccDebet  = IIF(CorrIntToEIRAdd > 0, "+Корректировка, ц/б", "-КорЭПС_%, ц/б");
            AccCredit = IIF(CorrIntToEIRAdd > 0, "+КорЭПС_%, ц/б", "-Корректировка, ц/б");  
            Ground = "Корректировка % до ЭПС по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";

            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   NATCUR,                      /* Валюта */
                   abs(CorrIntToEIRAdd),        /* Сумма корректировки до ЭПС*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground/*"Корректировка % до ЭПС"*/,
                   null,
                   GetFIRoleByPortfolio(Groups[i]),
                   GetFIRoleByPortfolio(Groups[i])
                  ) 
              )
                return false;
            end;            
         end;
      end;

      if (EstReserveAdd == 0)
        EstReserveAdd = CorrEstReserveAdd;
      end;
      if( EstReserveAdd != 0 )
         var isReserv  = true;
         if ( (Groups[i] == KINDPORT_PROMISSORY) )
            AccDebet  = IIF (EstReserveAdd > 0, "-КОР_РС, д/с", "+Кор_Резерв, ЦБ");
            AccCredit = IIF (EstReserveAdd > 0, "-Кор_Резерв, ЦБ", "+КОР_РС, д/с");
            AccDebetFIRole = IIF (AccDebet == "-КОР_РС, д/с", null, GetFIRoleByPortfolio(KINDPORT_PROMISSORY));
            AccCreditFIRole = IIF (AccCredit == "+КОР_РС, д/с", null, GetFIRoleByPortfolio(KINDPORT_PROMISSORY));
         elif ( Groups[i] == KINDPORT_SALE )
            AccDebet  = IIF (EstReserveAdd > 0, "-КорОР_ЦБ", "Оценочный резерв, СССД_ЦБ");
            AccCredit = IIF (EstReserveAdd > 0, "Оценочный резерв, СССД_ЦБ", "+КорОР_ЦБ");
            AccDebetFIRole = IIF (AccDebet == "Оценочный резерв, СССД_ЦБ", null, GetFIRoleByPortfolio(KINDPORT_SALE));
            AccCreditFIRole = IIF (AccCredit == "Оценочный резерв, СССД_ЦБ", null, GetFIRoleByPortfolio(KINDPORT_SALE));
         elif ( Groups[i] == KINDPORT_RETIRE )
            AccDebet  = IIF (EstReserveAdd > 0, "-КорОР_ЦБ", "+Кор_Резерв, ЦБ");
            AccCredit = IIF (EstReserveAdd > 0, "-Кор_Резерв, ЦБ", "+КорОР_ЦБ");
            AccDebetFIRole = GetFIRoleByPortfolio(KINDPORT_RETIRE);
            AccCreditFIRole = GetFIRoleByPortfolio(KINDPORT_RETIRE);
         else
            isReserv = false;   
         end;
        
         if (isReserv)
            if( not БУ_ПроводкаПоКатегориямУчета( FD,
                 AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                 CarDate,                     /* Дата */
                 1,                           /* Глава */
                 NATCUR,                      /* Валюта */
                 abs(EstReserveAdd),          /* Сумма корректировки до ЭПС*/
                 INPCARRY,                    /* Result_Carry */
                 " 1",                        /* Kind_Oper */
                 "",                          /* Numb_Document */
                 "Корректировка оценочного резерва",
                 null,
                 AccDebetFIRole,
                 AccCreditFIRole
               )
              )
               return false;
            end;
         end;
      end;

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным до даты составления списка*/
   i = 0;
   while( i < Groups.Size )
      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                               @CostBuy            ,
                               @BalanceCostBuy     ,
                               @NKDBuy             ,
                               @InterestIncomeBuy  ,
                               @DiscountIncomeBuy  ,
                               @NotCarryInterestBuy,
                               @NotCarryDiscountBuy,
                               @InterestIncomeAdd  ,
                               @DiscountIncomeAdd  ,
                               @NotCarryInterestAdd,
                               @NotCarryDiscountAdd,
                               @InterestIncomeSum  ,
                               @DiscountIncomeSum  ,
                               @NotCarryInterestSum,
                               @NotCarryDiscountSum,
                               @BalanceCostSum     ,
                               @OutlayBuy          ,
                               @OverAmountBuy      ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @BalanceCostBD      ,
                               @CostSale           ,
                               NULL                ,
                               @Amount             ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @CostSum            ,
                               FD.dl_leg.rec.Start ,
                               0
                             ) != true )
         return false;
      end;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE) OR  /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE)   /*АС_ЦБ*/
        )
         if( DiscountIncomeSum != 0 )
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   СчетСписанияСредствЗаПогашение( FD ), "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   DiscountIncomeSum,           /* Сумма  ДДначисл*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание начисленного дисконтного дохода",
                   null,
                   null,
                   GetFIRoleByPortfolio( Groups[i], true ), 
                   IIF(СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш", FD.FaceFIID(), NULL)
                  ) 
              )
                return false;
            end;
         end;

         if( CostSum != 0 )
            Ground = "Списание погашенной части балансовой стоимости по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";

            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   СчетСписанияСредствЗаПогашение( FD ), "Наш портфель ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.GetAccFIID("Наш портфель ц/б"),               /* Валюта */
                   CostSum,                     /* Сумма  ДДначисл*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   ground/*"Списание погашенной части балансовой стоимости"*/,
                   null,
                   null,
                   GetFIRoleByPortfolio( Groups[i] ), 
                   IIF(СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш", FD.FaceFIID(), NULL)
                  ) 
              )
                return false;
            end;
         end;
      end;

      if( (Groups[i] == KINDPORT_TRADE)  OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE)   OR /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE) OR /*АС_ЦБ*/
          (Groups[i] == KINDPORT_BACK)      /*ПВО*/
        )
         if( not БУ_СписаниеДохПоКуплДоДатыПеречняИпрод_ДляПогашений( FD, CarDate, Groups[i], Amount, false ) )
             return false;
         end;
      end;

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным после даты составления списка*/
   i = 0;
   while( i < Groups.Size )
      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                               @CostBuy            ,
                               @BalanceCostBuy     ,
                               @NKDBuy             ,
                               @InterestIncomeBuy  ,
                               @DiscountIncomeBuy  ,
                               @NotCarryInterestBuy,
                               @NotCarryDiscountBuy,
                               @InterestIncomeAdd  ,
                               @DiscountIncomeAdd  ,
                               @NotCarryInterestAdd,
                               @NotCarryDiscountAdd,
                               @InterestIncomeSum  ,
                               @DiscountIncomeSum  ,
                               @NotCarryInterestSum,
                               @NotCarryDiscountSum,
                               @BalanceCostSum     ,
                               @OutlayBuy          ,
                               @OverAmountBuy      ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @BalanceCostBD      ,
                               @CostSale           ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @CostSum            ,
                               FD.dl_leg.rec.Start ,
                               1
                             ) != true )
         return false;
      end;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE)  OR /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE)   /*АС_ЦБ*/
        )
         if( DiscountIncomeSum != 0 )
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   DiscountIncomeSum,           /* Сумма  ДДначисл*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание начисленного дисконтного дохода по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i], true ),
                   FD.GetPayFIID(), FD.FaceFIID()
                  ) 
              )
                return false;
            end;
         end;

         if( CostSum != 0 )
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", "Наш портфель ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.GetAccFIID("Наш портфель ц/б"), /* Валюта */
                   CostSum,                     /* Сумма  ДДначисл*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание погашенной части балансовой стоимости по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i] ),
                   FD.GetPayFIID(), FD.GetAccFIID("Наш портфель ц/б")
                  ) 
              )
                return false;
            end;
         end;
      end;

      i = i + 1;
   end;

   if( БУ_УчетРЕПО_ДляПогашений( FD, CarDate, false ) != true )
      return false;
   end;

   return true; 
END;

/*RealizSumm - сумма ПД и НКДУпл, кот. прошла(или могла пройти) по счету "Реализация, ц/б" в проводках погашения посл. купона (нужна для расчета ФР) */
MACRO БУ_ПроводкиПогашенияКупона( FD:SPFirstDoc, CarDate:DATE, RealizSumm:TArray ):BOOL

   var ReceiverAccount = TRecHandler( "account" );
   var PayerAccountBuff = TRecHandler( "account" );
   var CredNKDcateg = IIF(ОтдельныйУчетУплНКД(),"Уплаченный НКД","Наш портфель ц/б");
   VAR i = 0, Groups = TArray(),
       AccCredit, FIIDCredit, AccDebet = "", FIIDDebet, Глава, 
       DecisionDate = date(0,0,0), // Дата принятия решения по невозмещаемым активам 
       NonRefundActive = false;    // Невозмещаемый актив CCBO-8438

   VAR CostBuy             = $0, // Списанная чистая стоимость (Счист)
       BalanceCostBuy      = $0, // Списанная текущая стоимость 
       NKDBuy              = $0, // НКД ( S(НКД упл.))
       InterestIncomeBuy   = $0, // Списанный начисленный ПД 
       DiscountIncomeBuy   = $0, // Cписанный начисленный ДД 
       NotCarryInterestBuy = $0, // Списанный не отнесенный на доходы ПД  
       NotCarryDiscountBuy = $0, // Списанный не отнесенный на доходы ДД  
       InterestIncomeAdd   = $0, // Доначисленный ПД S(Sдонач.ПДi)
       DiscountIncomeAdd   = $0, // Доначисленный ДД S(Sдонач.ДДi)
       NotCarryInterestAdd = $0, // Доначисленный не отнесенный на доходы ПД  
       NotCarryDiscountAdd = $0, // Доначисленный не отнесенный на доходы ДД  
       InterestIncomeSum   = $0, // Суммарный начисленный ПД S(ПДначисл)
       DiscountIncomeSum   = $0, // Суммарный начисленный ДД S(ДДначисл)
       NotCarryInterestSum = $0, // Суммарный не отнесенный на доходы ПД  S(ПДне_отн)
       NotCarryDiscountSum = $0, // Суммарный не отнесенный на доходы ДД  S(ДДне_отн)
       BalanceCostSum      = $0, // Суммарная текущая стоимость ( (Стек))
       OutlayBuy           = $0, // Списанные затраты
       OverAmountBuy       = $0, // Списанная сумма переоценки S(ПО)
       BalanceCostBD       = $0,
       CostSale            = $0,
       NKDSale             = $0,
       Amount              = $0,
       BonusAdd            = $0, //Доначисление премии
       AccounttedDefDiffAdd= $0, //Доначисление отсроченной разницы
       CorrIntToEIRAdd     = $0; //Корректировка % до ЭПС
   var Ground = "";
   var err = 0;
   var Note102RetSum = $0;
   var fiw = TRecHandler("fiwarnts.dbt");

   DecisionDate = readNoteForObject( OBJTYPE_AVOIRISS, L_Z( Int(FD.fininstr.rec.FIID), 10 ), 108 );
   if ((ValType(DecisionDate) == V_DATE) and (DecisionDate != date(0,0,0)))
      NonRefundActive = true;
   end;

   if( IsClientDeal(FD.tick.rec) )

      if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), ReceiverAccount) != 0)
         return false;
      end;

      AccDebet = СчетСписанияСредствЗаПогашение( FD );
      if( AccDebet == "Корсчет" )
         if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayerAccountBuff) != 0)
            Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(FD.tick.rec.PartyID) );
            return false;
         end; 
      end;

      var summa = $0, currency = NATCUR;
      if( FD.NKDFIID() != FD.GetPayFIID())
        if( not SmartConvertSum( summa, FD.dl_leg.rec.NKD, CarDate, FD.NKDFIID(), FD.GetPayFIID(), true))
           return false;
        end;
        currency = FD.GetPayFIID();
      else
        summa = FD.dl_leg.rec.NKD;
        currency = FD.NKDFIID();
      end;
/*
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             IIF((AccDebet == "Корсчет"),PayerAccountBuff,AccDebet), ReceiverAccount,/* КатегДеб , КатегКредит*/
             CarDate,                     /* Дата */
             1,                           /* Глава */
             currency,                    /* Валюта */ 
             summa,                       /* Сумма */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             "Погашение купона по ц/б, принадлежащим клиенту"
            ) 
        )
          return false;
      end;
*/
      return true;
   end;

   ПолучитьГруппыСписания( FD, Groups );


   while( i < Groups.Size )

      AccDebet  = "Начисл.ПДД, ц/б";
      FIIDDebet = FD.FaceFIID();
  
      if (NonRefundActive)
        FIIDDebet = NATCUR;
      end;

      AccCredit  = "+%ДЦ/б";
      FIIDCredit = NATCUR;

      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   @Amount            ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   @BonusAdd          ,
                                   NULL,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL,
                                   @AccounttedDefDiffAdd,
                                   NULL,
                                   NULL,
                                   NULL,
                                   @CorrIntToEIRAdd                      
                                 ) != true )
         return false;
      end;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE) OR  /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE)   /*АС_ЦБ*/
        )

         if( (not IsRET_ISSUE(FD.Group) and (not IsRET_PARTLY(FD.Group))) // проводка будет в БУ_СписаниеСебестоимостиПриПогашении
              and (BonusAdd != 0) )

            if (NonRefundActive)
               SmartConvertSum (BonusAdd,  Money(BonusAdd), DecisionDate, FD.FaceFIID(), NATCUR, true)
            end;

            Ground = "Списание начисленной премии на расходы по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
            if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                  "-Премия, ц/б", "Премия, ц/б", /* КатегДеб, КатегКредит */
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  IIF(NonRefundActive, NATCUR, FD.FaceFIID()),  /* Валюта */
                                                  BonusAdd,                    /* Сумма */
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  ground/*"Списание начисленной премии на расходы"*/,
                                                  null,
                                                  GetFIRoleByPortfolio( Groups[i], false, false, false, false, true),
                                                  GetFIRoleByPortfolioBonus(Groups[i]),
                                                  IIF(NonRefundActive, NATCUR, NULL),
                                                  IIF(NonRefundActive, NATCUR, NULL)
                                                 ) 
              )
               return false;
            end;
         end;

         if( InterestIncomeAdd != 0 )
		 
            if (NonRefundActive)
               SmartConvertSum (InterestIncomeAdd,  Money(InterestIncomeAdd), DecisionDate, FD.FaceFIID(), NATCUR, true)
            end;
                      
            Ground = "Начисление купонного дохода по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
            if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                  AccDebet, AccCredit,         /* КатегДеб, КатегКредит*/
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  IIF(NonRefundActive, NATCUR, FD.FaceFIID()), /* Валюта */
                                                  InterestIncomeAdd,           /* Сумма Sдонач.ДДi*/
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  Ground/*"Доначисление процентного дохода"*/,
                                                  2,                            /* Mode, для выполнения проводки на остаток по счету (1 - по счету дебета, 2 - по счету кредита, иначе на переданную сумму )*/
                                                  GetFIRoleByPortfolio(Groups[i], false, true),
                                                  GetFIRoleByPortfolio(Groups[i], false, true),
                                                  FIIDDebet, FIIDCredit
                                                ) 
              )
               return false;
            end; 
         end;

         if( (DiscountIncomeAdd != 0) /*and (not IsRET_ISSUE(FD.Group))*/ and (not IsRET_PARTLY(FD.Group)))
		 
            if (NonRefundActive)
               SmartConvertSum (DiscountIncomeAdd,  Money(DiscountIncomeAdd), DecisionDate, FD.FaceFIID(), NATCUR, true)
            end;
			
            Ground = "Начисление дисконтного дохода по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
            if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                  AccDebet, AccCredit,         /* КатегДеб, КатегКредит*/
                                                  CarDate,                     /* Дата */
                                                  1,                           /* Глава */
                                                  IIF(NonRefundActive, NATCUR, FD.FaceFIID()), /* Валюта */
                                                  DiscountIncomeAdd,           /* Сумма Sдонач.ДДi*/
                                                  INPCARRY,                    /* Result_Carry */
                                                  " 1",                        /* Kind_Oper */
                                                  "",                          /* Numb_Document */
                                                  Ground/*"Доначисление дисконтного дохода"*/,
                                                  null,
                                                  GetFIRoleByPortfolio(Groups[i], true),
                                                  GetFIRoleByPortfolio(Groups[i], true),
                                                  FIIDDebet, FIIDCredit
                                                ) 
              )
               return false;
            end;
         end;
      end;

      if( (AccounttedDefDiffAdd != 0) and (not IsRET_PARTLY(FD.Group)) )
         AccDebet  = IIF(AccounttedDefDiffAdd > 0, "-КорЭПС_%, ц/б", "-Маржа, ц/б");   
         AccCredit = IIF(AccounttedDefDiffAdd > 0, "+Маржа, ц/б", "+КорЭПС_%, ц/б"); 
         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                CarDate,                     /* Дата */
                1,                           /* Глава */
                NATCUR,                      /* Валюта */
                abs(AccounttedDefDiffAdd),    /* Сумма корректировки до ЭПС*/
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                "Корректировка отсроченной разницы",
                null,
                iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i])),
                iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i]))
               ) 
           )
             return false;
         end;   
      end;

      if( (CorrIntToEIRAdd != 0) and (not IsRET_PARTLY(FD.Group)) )
            AccDebet  = IIF(CorrIntToEIRAdd > 0, "+Корректировка, ц/б", "-КорЭПС_%, ц/б");
            AccCredit = IIF(CorrIntToEIRAdd > 0, "+КорЭПС_%, ц/б", "-Корректировка, ц/б");  
            Ground = "Корректировка % до ЭПС по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   NATCUR,                      /* Валюта */
                   abs(CorrIntToEIRAdd),        /* Сумма корректировки до ЭПС*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   Ground/*"Корректировка % до ЭПС"*/,
                   null,
                   iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i])),
                   iif((Groups[i]==KINDPORT_BACK),GetFIRoleByPortfolio(KINDPORT_SALE),GetFIRoleByPortfolio(Groups[i]))
                  ) 
              )
                return false;
            end;            
         end;         

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным до даты составления списка*/
   i = 0;
   while( i < Groups.Size )

      if( RealizSumm != null )
         RealizSumm[i] = 0;
      end;

      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   @Amount             ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   @BonusAdd           ,
                                   NULL                ,
                                   FD.dl_leg.rec.Start ,
                                   0
                                 ) != true )
         return false;
      end;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE) OR  /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE)   /*АС_ЦБ*/
        )

         if( InterestIncomeSum != 0 )

            if (NonRefundActive)
               SmartConvertSum (InterestIncomeSum,  Money(InterestIncomeSum), DecisionDate, FD.FaceFIID(), NATCUR, true);
            end;
            
            var InterestIncomeSumRUB = $0;
            if ((СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш") and (FD.GetPayFIID() != FD.FaceFIID()))
                Note102RetSum = readNoteForObject( OBJTYPE_RETIRE, L_Z( Int(FD.tick.rec.DealID), 34 ), 102 );
                if ((ValType(Note102RetSum) == V_MONEY) and (Note102RetSum != 0))
                    if (NKDBuy != 0)
                      InterestIncomeSumRUB = Note102RetSum * InterestIncomeSum / (InterestIncomeSum + NKDBuy);
                    else
                      InterestIncomeSumRUB = Note102RetSum;
                    end;
                else
                    
                    if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
                       msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
                       return 1;
                    end;
                    SmartConvertSum (InterestIncomeSumRUB,  Money(InterestIncomeSum), fiw.rec.DrawingDate, FD.FaceFIID(), NATCUR, true);
                end;
            end;

            Ground = "Списание начисленного ПД по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
            if( IsRET_ISSUE(FD.Group) ) // в погашении ц/б можно задать только последний купон
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      "Реализация, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      IIF(NonRefundActive, NATCUR, FD.FaceFIID()), /* Валюта */
                      InterestIncomeSum,           /* Сумма  ДДначисл*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      Ground/*"Списание начисленного ПД"*/,
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i], false, true ),
                      IIF(NonRefundActive, NATCUR, NULL),
                      IIF(NonRefundActive, NATCUR, NULL)
                     ) 
                 )
                   return false;
               end;
            else
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      СчетСписанияСредствЗаПогашение( FD ), "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      IIF(NonRefundActive, NATCUR, FD.FaceFIID()), /* Валюта */
                      InterestIncomeSum,           /* Сумма  ДДначисл*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      Ground/*"Списание начисленного ПД"*/,
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i], false, true ),
                      IIF(NonRefundActive, NATCUR, IIF(СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш" , IIF(FD.GetPayFIID() != FD.FaceFIID(), FD.GetPayFIID(), FD.FaceFIID()), NULL)),
                      IIF(NonRefundActive, NATCUR, NULL),
                      IIF(InterestIncomeSumRUB != 0, FD.GetPayFIID(), NULL),
                      IIF(InterestIncomeSumRUB != 0, InterestIncomeSumRUB, NULL)
                     ) 
                 )
                   return false;
               end;
            end;
         end;

         if( NKDBuy != 0 )

            if (NonRefundActive)
               SmartConvertSum (NKDBuy,  Money(NKDBuy), DecisionDate, FD.GetAccFIID(CredNKDcateg), NATCUR, true);
            end;
            
            var NKDBuyRUB = $0;
            if ((СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш") and (FD.GetPayFIID() != FD.FaceFIID()))
                Note102RetSum = readNoteForObject( OBJTYPE_RETIRE, L_Z( Int(FD.tick.rec.DealID), 34 ), 102 );
                if ((ValType(Note102RetSum) == V_MONEY) and (Note102RetSum != 0))
                    if (InterestIncomeSum != 0)
                      NKDBuyRUB = Note102RetSum - InterestIncomeSumRUB;
                    else
                      NKDBuyRUB = Note102RetSum;
                    end;
                else
                    if(ПолучитьКупон( FD.CurPFI(), FD.tick.rec.Number_Coupon, UNSET_CHAR, fiw ) == false)
                       msgbox("Не найден купон с номером \""+FD.tick.rec.Number_Coupon+"\"");
                       return 1;
                    end;
                    SmartConvertSum (NKDBuyRUB,  Money(NKDBuy), fiw.rec.DrawingDate, FD.FaceFIID(), NATCUR, true);
                end;
            end;

            Ground = "Списание уплаченного НКД по ЦБ " + GetFinName(FD.fininstr.rec) + ", количество " + UserGetKol(Amount, FD.fininstr.rec.avoirkind) + ".";
            // последний купон гасится совместно с выпуском
            if ( IsRET_ISSUE(FD.Group) ) // в погашении ц/б можно задать только последний купон
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      "Реализация, ц/б", CredNKDcateg,/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      IIF(NonRefundActive, NATCUR, FD.GetAccFIID(CredNKDcateg)), /* Валюта */
                      NKDBuy,                      /* Сумма  ДДначисл*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      Ground/*"Списание уплаченного НКД"*/,
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i] ),
                      NATCUR, 
                      IIF(NonRefundActive, NATCUR, FD.GetAccFIID(CredNKDcateg))
                     ) 
                 )
                   return false;
               end;
            else
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      СчетСписанияСредствЗаПогашение( FD ), CredNKDcateg,/* КатегДеб , КатегКредит*/
                      //ЮзерСчетСписанияСредствЗаПогашениеКупона( FD ), CredNKDcateg,/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      IIF(NonRefundActive, NATCUR, FD.GetAccFIID(CredNKDcateg)), /* Валюта */
                      NKDBuy,                      /* Сумма  ДДначисл*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      Ground/*"Списание уплаченного НКД"*/,
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i] ),
                      IIF(NonRefundActive, NATCUR, IIF(СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш", IIF(FD.GetPayFIID() != FD.FaceFIID(), FD.GetPayFIID(), FD.FaceFIID()), NULL)),
                      IIF(NonRefundActive, NATCUR, NULL),
                      IIF(NKDBuyRUB != 0, FD.GetPayFIID(), NULL),
                      IIF(NKDBuyRUB != 0, NKDBuyRUB, NULL)
                     ) 
                 )
                   return false;
               end;
            end;
            /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
            if (not NonRefundActive)
               if( SmartConvertSum( NKDBuy, NKDBuy, CarDate, FD.GetAccFIID(CredNKDcateg), NATCUR, true ) == false )
                  return false;
               end;   
            end;			   
            if( RealizSumm != null )          
               RealizSumm[i] = RealizSumm[i] + NKDBuy;
            end;
         end;
      end;

      if( (Groups[i] == KINDPORT_TRADE)  OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE)   OR /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE) OR /*АС_ЦБ*/
          (Groups[i] == KINDPORT_BACK)      //ПВО
        )
         if( not БУ_СписаниеДохПоКуплДоДатыПеречняИпрод_ДляПогашений( FD, CarDate, Groups[i], Amount, true ) )
             return false;
         end;
      end;

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным после даты составления списка*/
   i = 0;
   while( i < Groups.Size )

      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   NULL                ,
                                   @BonusAdd           ,
                                   NULL                ,
                                   FD.dl_leg.rec.Start ,
                                   1
                                 ) != true )
         return false;
      end;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ССПУ_ЦБ*/
          (Groups[i] == KINDPORT_SALE) OR  /*СССД_ЦБ*/
          (Groups[i] == KINDPORT_RETIRE)   /*АС_ЦБ*/
        )
         if( InterestIncomeSum != 0 )
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   InterestIncomeSum,           /* Сумма  ДДначисл*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание начисленного ПД по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i], false, true ),
                   FD.GetPayFIID(), FD.FaceFIID()
                  ) 
              )
                return false;
            end;
         end;

         if( NKDBuy != 0 )
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", CredNKDcateg,    /* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.GetAccFIID(CredNKDcateg), /* Валюта */
                   NKDBuy,                      /* Сумма  ДДначисл*/
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание уплаченного НКД по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i] ),
                   FD.GetPayFIID(), FD.GetAccFIID(CredNKDcateg)
                  ) 
              )
                return false;
            end;
         end;
      end;

      i = i + 1;
   end;

   if( БУ_УчетРЕПО_ДляПогашений( FD, CarDate, true ) != true )
      return false;
   end;

   return true; 
END;

macro БУ_ПроводкиОплатыКупонаЧП(FD, dat)
  var     rq_money = TRecHandler("dlrq.dbt");
  var     DtAccount = TRecHandler("account.dbt");
  var     CtAccount = TRecHandler("account.dbt");
  var ground = "";

  if( FD.tick.rec.CarryWrt == SET_CHAR )

     rq_money = FD.GetRQ(DLRQ_TYPE_PAYMENT);

     DtAccount.Clear();
     CtAccount.Clear();
     if( ПолучитьНашСчетТОПоОплате(rq_money, FD, dat, DtAccount, CtAccount) != 0 )
        return 1;
     end;

     if( ПолучитьСчетКонтрагентаПоТООплаты(rq_money, FD, dat, DtAccount, CtAccount) != 0 )
        return 1;
     end;

     if( (not ТОСквитовано(rq_money)) and (not IsBROKER(FD.Group)) and (not FD.СделкаОРЦБ()) )
        if( not IsClientDeal(FD.tick.rec) and not ( IsRET_ISSUE(FD.Group) ))
            Ground = "Выплата купонного дохода по ЦБ " + GetFinName(FD.fininstr.rec) + ", гос. рег. " + User_GetLsin(FD.fininstr.rec.fiid);

           if( БУ_ОбработатьДенежноеТО( rq_money, DtAccount, CtAccount, FD, dat, Ground/*"Поступление средств от платежного агента"*/ ) != 0 )
              return 1;
           end;
        end;
     end;

    if( IsClientDeal(FD.tick.rec) )
       if( IsRET_COUPON(FD.Group) OR (FD.tick.rec.Number_Coupon != "") )
          if( not БУ_ПроводкиПогашенияКупона(FD, dat) )
             return 1;
          end;
       end;

       if( IsRET_PARTLY(FD.Group) )
          if( not БУ_ПроводкиЧастичногоПогашения(FD, dat) )
             return 1;
          end;
       end;
    end;
  end;

  return 0;
end;

MACRO БУ_ПополнениеОбеспеченияПР( FD:SPFirstDoc, CarDate:DATE, DlRq:TRecHandler ):BOOL
  VAR i:integer = 0, Groups = TArray();
  VAR RSD, SQLQuery, FD_buy;
  VAR DebCat, CredCat, CarFIID, CarFIID2, CarSumm, Capter, NKDSumm;
  VAR SumID:integer = -1, BonusSum = 0;

  VAR Ground = "";

  VAR CostBuy             = $0, /* Списанная чистая стоимость (Счист) */
      BalanceCostBuy      = $0, /* Списанная текущая стоимость */
      NKDBuy              = $0, /* НКД ( S(НКД упл.)) */
      InterestIncomeBuy   = $0, /* Списанный начисленный ПД */
      DiscountIncomeBuy   = $0, /* Cписанный начисленный ДД */
      InterestIncomeAdd   = $0, /* Доначисленный ПД S(Sдонач.ПДi) */
      DiscountIncomeAdd   = $0, /* Доначисленный ДД S(Sдонач.ДДi) */
      InterestIncomeSum   = $0, /* Суммарный начисленный ПД S(ПДначисл) */
      DiscountIncomeSum   = $0, /* Суммарный начисленный ДД S(ДДначисл) */
      BalanceCostSum      = $0, /* Суммарная текущая стоимость (Стек) */
      OutlayBuy           = $0, /* Списанные затраты */
      OverAmountBuy       = $0, /* Списанная сумма переоценки S(ПО) */
      ReservAmountBuy     = $0, /* Списанная сумма резерва (Сумма созданного резерва) */
      IncomeReservBuy     = $0, /* Доначисленный резерв по ПДД */
      BonusAdd            = $0, /* Доначисленная премия (?(SдоначПрi))*/
      CostSum             = $0, /* Суммарная списанная чистая стоимость (Счист)*/
      Amount              = $0, /* Списанное количество*/
      BalanceCostBD       = $0, /* Списанная стоимость в ОД */
      CostSale            = $0, /* Проданная чистая стоимость (в ЧП - Sчпл)*/
      BonusRest           = $0; /* Остаток премии (?(ост. премии))*/

   PRIVATE VAR fininstr = TRecHandler( "fininstr" );


  if( IsClientDeal(FD.tick.rec) )
     return true;
  end;

  /* найдем SumID */
  SQLQuery = RSDCommand( " select lot.t_SumID " +
                         "   from dpmwrtsum_dbt lot " +
                         "  where lot.t_DocKind = ? " +
                         "    and lot.t_DocID   = ? " +
                         "    and lot.t_PartNum = 1 " );
  SQLQuery.addParam( "", RSDBP_IN, DLDOC_PAYMENT );
  SQLQuery.addParam( "", RSDBP_IN, DlRq.rec.ID );
  SQLQuery.execute();

  RSD = TRsbDataSet(SQLQuery);
  if( RSD.MoveNext() )
     SumID = SQL_ConvTypeInteger(RSD.rec.SumID);
  end;

  if( SumID <= 0 )
     MsgBox("Не найден лот компенсационной поставки");
     return false;
  end;

  Groups[0] = KINDPORT_TRADE;
  Groups[1] = KINDPORT_SALE;
  Groups[2] = KINDPORT_RETIRE;
  Groups[3] = KINDPORT_CONTR;

  while( i < Groups.Size )
     if( WRT_GetSaleFinResult_EX( SumID,
                                  Groups[i],
                                  0,
                                  @CostBuy,
                                  @BalanceCostBuy,
                                  @NKDBuy,
                                  @InterestIncomeBuy,
                                  @DiscountIncomeBuy,
                                  NULL,
                                  NULL,
                                  @InterestIncomeAdd,
                                  @DiscountIncomeAdd,
                                  NULL,
                                  NULL,
                                  @InterestIncomeSum,
                                  @DiscountIncomeSum,
                                  NULL,
                                  NULL,
                                  @BalanceCostSum,
                                  @OutlayBuy,
                                  @OverAmountBuy,
                                  NULL,
                                  NULL,
                                  @ReservAmountBuy,
                                  NULL,
                                  NULL,
                                  @BalanceCostBD,
                                  @CostSale,
                                  NULL,
                                  @Amount,
                                  @IncomeReservBuy,
                                  NULL,
                                  NULL,
                                  @BonusAdd,
                                  @CostSum,
                                  NULL,
                                  NULL,
                                  NULL,
                                  NULL,
                                  NULL,
                                  @BonusRest
                                ) != true )
        return false;
     end;

     if( Groups[i] == KINDPORT_CONTR )
        if(ВедениеСчетовБПППоВыпуску() == true)
          DebCat = "Наш портфель ПКУ, ц/б";
        else
        DebCat   = IIF(IsBasket(FD.Group), "Ц/б, Корзина ПКУ БПП", "Ц/б, ПКУ БПП");
        end;
        CredCat  = "Наш портфель ПКУ, ц/б";
        CarFIID  = NATCUR;
        CarFIID2 = NATCUR;
     else
        if(ВедениеСчетовБПППоВыпуску() == true)
          DebCat  = "Наш портфель ц/б";
          CarFIID = FD.GetAccFIID(DebCat);
        else
        DebCat   = IIF(IsBasket(FD.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
          CarFIID  = FD.FaceFIID();
        end;
        CredCat  = "Наш портфель ц/б";
        
        CarFIID2 = FD.GetAccFIID(CredCat);
     end;

     CarSumm  = CostBuy - BonusRest;
     NKDSumm  = NKDBuy;
     Capter   = 1;

     if( not ОтдельныйУчетУплНКД() )
        CarSumm = CarSumm + NKDSumm;
     end;

     If(IsBasket(FD.Group))
        ПолучитьФинИн( FD.avoiriss.rec.fiid, fininstr );
     else
        ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
     end;


     if( CarSumm != 0 )
        if( FD.IsExistAccount(CredCat, null, true, GetFIRoleByPortfolio(Groups[i]), CredCatAcc, null, CarDate, CarFIID2) )

           if( Groups[i] == KINDPORT_TRADE )
              ПроводкиБУ.ДобавитьCуммыПоПортфелюПоСделке(FD.tick.rec.DealID, CarSumm, 0, 0, 0);
           elif( Groups[i] == KINDPORT_SALE )
              ПроводкиБУ.ДобавитьCуммыПоПортфелюПоСделке(FD.tick.rec.DealID, 0, CarSumm, 0, 0);
           elif( Groups[i] == KINDPORT_RETIRE )
              ПроводкиБУ.ДобавитьCуммыПоПортфелюПоСделке(FD.tick.rec.DealID, 0, 0, CarSumm, 0);
           elif( Groups[i] == KINDPORT_CONTR )
              ПроводкиБУ.ДобавитьCуммыПоПортфелюПоСделке(FD.tick.rec.DealID, 0, 0, 0, CarSumm);
           end;



              If(IsBasket(FD.Group))
                 Ground = "Перенос балансовой стоимости ЦБ " + GetFinName(fininstr.rec) + " со счета вложений на счет вложений для проданных без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate/* + ", кол-во бумаг ?"*/;
              else
                 Ground = "Перенос балансовой стоимости ЦБ " + GetFinName(fininstr.rec) + " со счета вложений на счет вложений для проданных без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate/* + ", кол-во бумаг ?"*/;
              end;

           if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                 DebCat, CredCatAcc,       /* КатегДеб, КатегКредит */
                                                 CarDate,                  /* Дата */
                                                 Capter,                   /* Глава */
                                                 CarFIID,                  /* Валюта */
                                                 CarSumm,                  /* Сумма */
                                                 INPCARRY,                 /* Result_Carry */
                                                 " 1",                     /* Kind_Oper */
                                                 "",                       /* Numb_Document */
                                                 Ground/*"Перевод стоимости ц/б"*/,
                                                 null,
                                                 GetFIRoleByPortfolio(Groups[i], false, false, true), null, 
                                                 CarFIID, CarFIID2
                                               )
             )
              return false;
           end;
        end;
     end;

     if( NKDSumm != 0.0 )
        if( ОтдельныйУчетУплНКД() )
              If(IsBasket(FD.Group))
                 Ground = "Перенос УНКД по " + GetFinName(FD.fininstr.rec) + " на счет вложений для УНКД по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              else
                 Ground = "Перенос УНКД по " + GetFinName(FD.fininstr.rec) + " на счет вложений для УНКД по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              end;
           var Cat = "";

           if(ВедениеСчетовБПППоВыпуску() == true)
             Cat = "Уплаченный НКД";
           else
             Cat = IIF(IsBasket(FD.Group), "Уплач. НКД, Корзина БПП", "Уплаченный НКД, БПП");
           end;

           if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                 Cat, "Уплаченный НКД", /* КатегДеб, КатегКредит */
                                                 CarDate,                                     /* Дата */
                                                 Capter,                                      /* Глава */
                                                 FD.FaceFIID(),                               /* Валюта */
                                                 NKDSumm,                                     /* Сумма */
                                                 INPCARRY,                                    /* Result_Carry */
                                                 " 1",                                        /* Kind_Oper */
                                                 "",                                          /* Numb_Document */
                                                 Ground/*"Перевод НКД"*/,
                                                 null,
                                                 GetFIRoleByPortfolio(Groups[i], false, false, true),
                                                 GetFIRoleByPortfolio(Groups[i])
                                               )
             )
              return false;
           end;
        end;
     end;

     BonusSum = BonusRest;
              If(IsBasket(FD.Group))
                 Ground = "Перенос Премии по " + GetFinName(FD.fininstr.rec) + " на счет премии по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              else
                 Ground = "Перенос Премии по " + GetFinName(FD.fininstr.rec) + " на счет премии по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              end;

     if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                           "Премия, ц/б", "Премия, ц/б",   /* КатегДеб , КатегКредит*/
                                           CarDate,                        /* Дата */
                                           Capter,                         /* Глава */
                                           FD.FaceFIID(),                  /* Валюта */
                                           BonusSum,                       /* Сумма  */
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           Ground/*"Перевод остатка уплаченной премии"*/,
                                           null,
                                           GetFIRoleByPortfolioBonus(Groups[i], true), /* БПП */
                                           GetFIRoleByPortfolioBonus(Groups[i])
                                         )
       )
        return false;
     end;

     if( InterestIncomeBuy != 0.0 )
              If(IsBasket(FD.Group))
                 Ground = "Перенос начисленного купона по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного купона по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              else
                 Ground = "Перенос начисленного купона по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного купона по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              end;

        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                              "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б", /* КатегДеб, КатегКредит */
                                              CarDate,                              /* Дата */
                                              1,                                    /* Глава */
                                              FD.FaceFIID(),                        /* Валюта */
                                              InterestIncomeBuy,                    /* Сумма */
                                              INPCARRY,                             /* Result_Carry */
                                              " 1",                                 /* Kind_Oper */
                                              "",                                   /* Numb_Document */
                                              Ground/*"Перевод начисленного ПД"*/,
                                              null,
                                              GetFIRoleByPortfolio(Groups[i], false, true, true),
                                              GetFIRoleByPortfolio(Groups[i], false, true, false)
                                            ) 
          )
           return false;
        end;
     end;

     if( DiscountIncomeBuy != 0.0 )
              If(IsBasket(FD.Group))
                 Ground = "Перенос начисленного дисконта по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного дисконта по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              else
                 Ground = "Перенос начисленного дисконта по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного дисконта по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD)  + " от " + FD.tick.rec.dealdate;
              end;

        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                              "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б", /* КатегДеб, КатегКредит */
                                              CarDate,                              /* Дата */
                                              1,                                    /* Глава */
                                              FD.FaceFIID(),                        /* Валюта */
                                              DiscountIncomeBuy,                    /* Сумма */
                                              INPCARRY,                             /* Result_Carry */
                                              " 1",                                 /* Kind_Oper */
                                              "",                                   /* Numb_Document */
                                              Ground/*"Перевод начисленного ДД"*/,
                                              null,
                                              GetFIRoleByPortfolio(Groups[i], true, false, true),
                                              GetFIRoleByPortfolio(Groups[i], true, false, false)
                                            )
          )
           return false;
        end;
     end;

     i = i + 1;
  end;

  SQLQuery = RSDCommand(" select buylot.t_DealID, buylot.t_Portfolio, lnk.t_BalanceCostBuy " +
                        "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt buylot " +
                        "  where buylot.t_SumID     = lnk.t_BuyID " +
                        "    and lnk.t_SaleID       = ? " +
                        "    and buylot.t_Portfolio in (?, ?) ");
  SQLQuery.addParam( "", RSDBP_IN, SumID );
  SQLQuery.addParam( "", RSDBP_IN, KINDPORT_BACK );
  SQLQuery.addParam( "", RSDBP_IN, KINDPORT_BACK_KSU );
  SQLQuery.execute();

  RSD = TRsbDataSet(SQLQuery);
  /* Если списание из ПВО, то проводки посделочные */
  while( RSD.MoveNext() )

     CarSumm = SQL_ConvTypeSum(RSD.rec.BalanceCostBuy);

     if( CarSumm != 0.0 )

        FD_buy = SPFirstDoc(LEG_KIND_DL_TICK, RSD.rec.DealID);
        FD_buy.SetCurPFI(FD.CurPFI());

        if( FD_buy.IsExistAccount("ВнебалСчетКорресп", null, true, FIROLE_CA, CredCatAcc, null, CarDate, NATCUR) )
           if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                 IIF(IsBasket(FD.Group), "Ц/б, ПВО_БПП, Корзина", "Ц/б, ПВО_БПП"), CredCatAcc,    /* КатегДеб, КатегКредит */
                                                 CarDate,                  /* Дата */
                                                 3,                        /* Глава */
                                                 FD.FaceFIID(),            /* Валюта */
                                                 CarSumm,                  /* Сумма */
                                                 INPCARRY,                 /* Result_Carry */
                                                 " 1",                     /* Kind_Oper */
                                                 "",                       /* Numb_Document */
                                                 "Списание из ПВО",
                                                 null,
                                                 FIROLE_BA,
                                                 null,
                                                 FD_buy.FaceFIID(), NATCUR
                                               )
             )
              return false;
           end;
        end;
     end;
  end;

  return true; 
END;

MACRO БУ_ПополнениеОбеспеченияОР( FD:SPFirstDoc, CarDate:DATE, DlRq:TRecHandler ):BOOL
  var Sum:money = $0.0;
  var cmd2 = DL_RSDCommand();
  var query2= " SELECT T_TOTALCOST " +
              "   FROM DDL_TICK_ENS_DBT " +
              "  WHERE T_DEALID = ? " +
              "    AND T_DATE   = ? " +
              "    AND T_FIID   = ? " +
              "    AND T_KIND   = ? ";
  cmd2.AddParam(FD.tick.rec.DealID);
  cmd2.AddParam(CarDate);
  cmd2.AddParam(FD.CurPFI());
  cmd2.AddParam(TICKENS_KIND_IN);

  var DataSet2 = cmd2.Execute(query2);
  if( DataSet2.moveNext() )
     Sum = SQL_ConvTypeSum(DataSet2.TotalCost);
  end;

  if( Sum != 0.0 )
     if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           "ВнебалСчетКорресп", IIF(IsBasket(FD.Group), "Ц/б, Корзина ПВО", "Ц/б, ПВО"), /* Деб, КатегКредит */
                                           CarDate,                                 /* Дата */
                                           3,                                       /* Глава */
                                           FD.FaceFIID,                             /* Валюта */
                                           Sum,                                     /* Сумма дебет*/
                                           INPCARRY,                                /* Result_Carry */
                                           " 1",                                    /* Kind_Oper */
                                           FD.tick.rec.DealCode,                    /* Numb_Document */
                                           "Учет стоимости ц/б",                    /* Ground */
                                           null, null, null,
                                           NATCUR, FD.FaceFIID()
                                         )
       )
        return false;
     end;
  end;

  return true;
END;
