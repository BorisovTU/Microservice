/* Операция удержания НДФЛ
   Шаг "Закрытие"*/
IMPORT "secinter.mac", "SpRepFun.mac", "nptxstbfun.mac";

PRIVATE VAR Oper = TRecHandler( "nptxop.dbt" );

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(Oper)
  var nptxop_new = TRecHandler( "nptxop" );
  var RefID, TaxPeriod;
  var err = 0;

  datesplit(Oper.rec.OperDate, null, null, TaxPeriod);

  if((Oper.rec.SubKind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY) and (NeedNptxNettOp(Oper.rec.Client, TaxPeriod, Oper.rec.OperDate)))

    nptxop_new.Clear();

    GenerateNumberByReference( OBJTYPE_NPTXNETTOP, 1 /*REFOBJ_NPTXNETTOP*/, @RefID, @nptxop_new.rec.Code );
        
    nptxop_new.rec.DocKind           = DL_NPTXNETTOP;
    nptxop_new.rec.OperDate          = Oper.rec.OperDate;
    nptxop_new.rec.Time              = time();
    nptxop_new.rec.Department        = {OperDprt};
    nptxop_new.rec.Oper              = Oper.rec.Oper;
    nptxop_new.rec.Status            = 0/*DL_TXOP_Prep*/;
    nptxop_new.rec.Recalc            = UNSET_CHAR;
    nptxop_new.rec.FIID              = ALLFININSTR;
    nptxop_new.rec.Client            = Oper.rec.Client;

    nptxop_new.rec.PrevDate          = date(1,1,TaxPeriod);

    nptxop_new.rec.Kind_Operation    = 2046;//Зачет удержанного НДФЛ

    if ( not CreateNptxOpStep(nptxop_new, true))
      err = 1;
    end;
  end;

  return err;
end;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR Stat = 0;

  Oper.SetRecordAddr( FDoc );

  stat = DL_NPTX_PutMsg( "Закрытие" );
  if( not stat )
     stat = RunAction(Oper);
     DL_NPTX_SaveOperLog( Oper.rec.ID, 60 );
  end;

  return stat;
END;
