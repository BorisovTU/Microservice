/*
$Name:         scrou0010.mac 
$Module:       Ценные бумаги
$Description:  Операция РЕПО без признания ц/б (не ОРЦБ).Шаг настройки операции
*/
import InsCarryDoc, "sp_class.mac", "sp_car2.mac", "SPQICheckOper.mac";

macro executeParamStep( kind_oper, BOf_kind, FDoc, ID_Operation, ID_Step )
  record  deal(dl_tick);
  var     FD, FD2, NeedInsertDepoDraft = false, NeedInsertDepoDraft2 = false, err = 0;

  SetBuff( deal, FDoc ); 
  FD  = SPFirstDoc( deal, false, true );
  FD2 = SPFirstDoc( deal, true, true );

  if( ИнициализироватьОперациюРЕПО( FD, FD2 ) == false )
     return 1;
  end;

  if(ПроверитьПринадлежностьКИ( FD ) == false)
     return 1;
  end;

  if( FD.ExistAvance == true ) 
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A1, SP_OPERSTATUS_SECURDEALS_A1_PAY) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 1 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A1, SP_OPERSTATUS_SECURDEALS_A1_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 1 ч> операции" );
        return 1;
     end;
  end;


  NeedInsertDepoDraft = НужноПредФормПоручДЕПО(FD, err);
  if (err > 0)
     msgbox( "Ошибка при определении необходимости предварительного формирования поручения" );
     return 1;
  end;

  if (NeedInsertDepoDraft == true)
     DefineOprDate( FD.GetKindDate(DATE_DEALINSDEPODRAFT), GetDateInsDepoDraft( FD ) );

     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D1, SP_OPERSTATUS_SECURDEALS_D1_FORM) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 1 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D1, SP_OPERSTATUS_SECURDEALS_D1_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 1 ч> операции" );
        return 1;
     end;
  end;

  if( FD2.ExistAvance == true ) 
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A2, SP_OPERSTATUS_SECURDEALS_A2_PAY) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 2 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A2, SP_OPERSTATUS_SECURDEALS_A2_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 2 ч> операции" );
        return 1;
     end;
  end;

  NeedInsertDepoDraft2 = НужноПредФормПоручДЕПО(FD2, err);
  if (err > 0)
     msgbox( "Ошибка при определении необходимости предварительного формирования поручения" );
     return 1;
  end;

  if (NeedInsertDepoDraft2 == true)
     /*Переинитим дату вставки поручения*/
     DefineOprDate( FD2.GetKindDate(DATE_DEALINSDEPODRAFT), GetDateInsDepoDraft( FD2 ) );

     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D2, SP_OPERSTATUS_SECURDEALS_D2_FORM) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 2 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D2, SP_OPERSTATUS_SECURDEALS_D2_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 2 ч> операции" );
        return 1;
     end;
  end;

  return 0;
end;
