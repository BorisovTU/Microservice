  /*
$Name:         dividend_emit_040.mac
$Module:       Ценные бумаги
$Description:  Операция получения дивидендов по РЕПО (от Контрагента)
*/
/*  Планирование (40): шаг планирования  */

import InsCarryDoc, "sp_class.mac", "sp_car2.mac", "spservsql.mac", "SPQICheckOper.mac";
 
//macro ExecuteStep
//( Doc, FDoc,  /*доп.параметры*/ 
 //                               DocKind, ID_Operation, ID_Step ) 

macro ExecuteCaseStep( Kind_Operation, Number_Step, FDoc, KindDoc)

    record deal(DL_TICK);
    SetBuff( deal, FDoc ); 

    VAR FD = SPFirstDoc( deal );
    var leg = FD.dl_leg.rec;
    var tick = FD.tick.rec;  

    // Проверяется, была ли сумма всех Qstep ц\б, указанных на шагах, меньше Qdepo
    var cmd = DL_RSDCommand( "select Nvl(Sum(dl.t_Nds),0) QSteps from ddlsum_dbt dl"
                            + " where dl.t_DocKind = ?"
                            + " and dl.t_DocID = ?"
                            + " and dl.t_Kind = ?" 
                            + " and dl.t_Date >= ? ");  
    cmd.AddParam( tick.BOfficeKind );
    cmd.AddParam( tick.DealID );
    cmd.AddParam( DLSUM_KIND_BANK_PERIOD );
    cmd.AddParam( tick.DealDate );
    var DataSet = cmd.Execute(); 
    
    var QSteps = 0;

    if ( DataSet.moveNext() )
         QSteps = DataSet.QSteps;
    end;

    if ( QSteps <leg.Principal /*Qdepo*/ )
        // то планируется повторное выполнение шага 30
        return "30";
    else
        // то операция закрывается, при этом невыполненный шаг 50 удаляется, 
        //   если дата шага планирования меньше, чем Dmax
        var plandate ;
        GetOprDate(100, plandate );
        if ( plandate <= /*Dmax*/leg.DmaxPay )
            return "50";
        end;

    end;

    return 0;  
end;