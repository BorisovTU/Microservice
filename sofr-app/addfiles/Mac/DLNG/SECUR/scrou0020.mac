/*
$Name:         scrou0020.mac 
$Module:       Ценные бумаги
$Description:  Операция РЕПО без признания ц/б (не ОРЦБ) Шаг подтверждения сделки
*/
import InsCarryDoc, secinter, "dlcnst.inc","sp_class.mac", "sp_car.mac", "sprconf.mac", "boswift.mac";
macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);


  var query, DataSet, cmd;
  var  FD, dat;
  var AttrID = 0;
  var flag = false;
  var stat = -1;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );
  if( IsOUTEXCHANGE(FD.Group))
    if(FD.tick.rec.GenagrID > 0)   // если в ген. соглашении Основной способ подтверждения = SWIFT
      query = "Select gen.T_CONFIRMMETHOD Method From ddl_genagr_dbt gen Where gen.t_GenagrID = ?" ;
      cmd = DL_RSDCommand(query);
      cmd.AddParam(FD.tick.rec.GenagrID);
      DataSet = cmd.Execute();
      if( (DataSet.moveNext()) and (DataSet.Method == 0) )    // метод подтверждения- Swift
        if( ( not DisconnectObjAttr(OBJTYPE_SECDEAL,  UniID( FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT) ) OR
            ( not ConnectObjAttr(stat, OBJTYPE_SECDEAL, UniID( FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT, 1, null, null, {curdate}) ) OR
            ( stat != 0 ) )
             msgbox( "Ошибка при установке Категории <Формировать SWIFT>" );
             return 1;
          
        end;
      end;
/*КД. простановка категории для всех сделок с контрагентами - нерезидентами */

    else
       If(ПолучитьКодСубъекта(FD.tick.rec.partyid, 6) !="")
          if( ( not DisconnectObjAttr(OBJTYPE_SECDEAL,  UniID( FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT) ) OR
              ( not ConnectObjAttr(stat, OBJTYPE_SECDEAL, UniID( FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT, 1, null, null, {curdate}) ) OR
              ( stat != 0 ) )
               msgbox( "Ошибка при установке Категории <Формировать SWIFT>" );
               return 1;
            
          end;
       end;
/* END КД. простановка категории для всех сделок с контрагентами - нерезидентами */

    end;
    if( GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID(FD.tick, OBJTYPE_SECDEAL), OBJGROUP_FORMSWIFT, AttrID ) )
      if(AttrID == 1)
        flag = true;
      end;
    end;
    if(flag)
      if( DL_CreateMsgInf(deal) )
        return 1;
      elif( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KC, SP_OPERSTATUS_SECURDEALS_KC_RUN) ) 
         msgbox( "Ошибка при установке статуса <Квитовка подтверждений> операции" );
         return 1;
      end;
    else
      if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KC, SP_OPERSTATUS_SECURDEALS_KC_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Квитовка подтверждений> операции" );
        return 1;
      end;
    end;
  end;

/*!!! здесь должен быть основной код шага*/
  /* Если необходимо оформлять договор, ОД = "Оформить", иначе ОД = "Завершить"
     КО = "Рассчитать"
  */
  if (deal.Flag2 == SET_CHAR)
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_OD, SP_OPERSTATUS_SECURDEALS_OD_FORM) ) 
        msgbox( "Ошибка при установке статуса <Оформление договора> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_OD, SP_OPERSTATUS_SECURDEALS_OD_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оформление договора> операции" );
        return 1;
     end;
  end;

  return 0;
end;
