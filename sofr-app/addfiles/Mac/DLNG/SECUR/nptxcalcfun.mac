/*
$Name:        nptxcalcfun.mac
$Module:      Ценные бумаги
$Description: Расчет объектов НДР
*/
import Проценты, "secinter.mac", "nptxfun.mac", "SpRepFun.mac", DVInter, "sp_car.mac", DPInter, "nptxstbfun.mac";
                      
/*Общие переменные для всех расчетов*/
private var DataSet, Query, QueryCond, QuerySelect, stat = 0,
            Num = 0, Count, Progress = TProgressBar;

private var NotUserWhereCond = "obj.t_User != 'X'";
private var FrobOutSystCode = "др.ПУ";
private var NotUserWhereCond5 = NotUserWhereCond + " and obj.t_OutSystCode <> '"+FrobOutSystCode+"' and obj.t_ChangeCode <> 'X' ";

private var pDocKind, pBegDate, pEndDate, pClient, pContract, pDocID, pSubKindOperation, PtIsRes, pBeg, pEnd, pIIS, pFIID, pTechnical, pExistEarlyTechCalc, pTransfDate, pTransfKind, pDateNDR;

MACRO ClearGTT_DNPTXOBJ_TMP()
   SQL_Execute("DELETE FROM " + SQL_GetTableName("DNPTXOBJ_TMP"));
END;

private const InsertObject = 1, InsertObjectWD = 2; // типы ф-й, которые будут вызываться при вставке объектов
private const EndDate2011 = Date(31, 12, 2011), EndDate2011SQL = " TO_DATE('31.12.2011', 'DD.MM.YYYY') ";
private const EndDate2013 = Date(31, 12, 2013), EndDate2013SQL = " TO_DATE('31.12.2013', 'DD.MM.YYYY') ";

const NPTXOPSTEP5 = 5,
      NPTXOPSTEP6 = 6,
      NPTXOPSTEP7 = 7,
      NPTXOPSTEP8 = 8,
      NPTXOPSTEP9 = 9;
const WRTMONEYKIND  = 2037;

const IISTYPEA = 0,
      IISTYPEB = 1,
      IISTYPEC = 2,
      IISTYPED = 3,
      IISTYPEE = 4,
      IISTYPEF = 5,
      IISTYPEG = 6;

macro GetIncomeDateQuery(RecalOperID, Action, EndDate):string
  var Query = "";
  var TaxPeriod = 0, TaxTeriodToLucre;

  datesplit(EndDate, null, null, TaxPeriod);

  TaxTeriodToLucre = CheckTaxTeriodToLucre(TaxPeriod);

  Query =   " SELECT  *  "
          + "  FROM(with parm as (select t_client as p_clientid, t_id as p_id, t_operdate as p_operdate, t_IIS as p_IIS, t_SubKind_Operation as p_SubKind_Operation from dnptxop_dbt where t_id = " + RecalOperID + ") "
          + "       select DISTINCT t_operdate "
          + "         from ( select op_s.t_operdate "
          + "                  from parm, dnptxop_dbt op_m, dnptxop_dbt op_s "
          + "                 where parm.p_IIS = CHR(0) "
          + IIF(TaxTeriodToLucre, " and parm.p_SubKind_Operation <> " + DL_TXBASECALC_OPTYPE_LUCRE, "")
          + "                   and op_m.t_id = parm.p_id "
          + "                   and OP_S.T_CLIENT = op_m.t_client "
          + "                   and OP_S.T_IIS = op_m.T_IIS "
          + "                   and trunc (op_m.t_operdate,'year') = trunc (op_s.t_operdate,'year') "
          + "                   and op_m.t_operdate <= " + GetSQLDate(EndDate)
          + "                   and OP_S.T_DOCKIND = " + DL_WRTMONEY 
          + "                   and OP_S.T_KIND_OPERATION = " + WRTMONEYKIND 
          + "                   and OP_S.T_SUBKIND_OPERATION = " + DL_NPTXOP_WRTKIND_WRTOFF
          + "                   and OP_S.T_STATUS = " + DL_TXOP_Close
          + "                   and (   trim(NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote("+OBJTYPE_WRTMONEY+", LPAD(OP_S.t_ID, 34, '0'), 103/*Отметка об отказе в исполнении*/, OP_S.t_OperDate)), CHR(1))) = CHR(1) "
          + "                        or ascii(trim(NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote("+OBJTYPE_WRTMONEY+", LPAD(OP_S.t_ID, 34, '0'), 103/*Отметка об отказе в исполнении*/, OP_S.t_OperDate)), CHR(1)))) = 0"
          + "                       ) "
          + "                 union "
          + "                select " + GetSQLDate(EndDate) + " as t_operdate from dual "
          + "                 union "
          + "                select SFC.T_DATECLOSE as t_operdate "
          + "                  from ddlcontr_dbt dlc, dsfcontr_dbt sfc, parm "
          + "                 where DLC.T_SFCONTRID = SFC.T_ID "
          + "                   and SFC.T_PARTYID = parm.p_clientid "
          + "                   and DLC.t_IIS = parm.p_IIS "
          + IIF(TaxTeriodToLucre, " and parm.p_SubKind_Operation <> " + DL_TXBASECALC_OPTYPE_LUCRE, "")
          + "                   and sfc.t_dateclose != to_date('01010001','ddmmyyyy') "
          + "                   and trunc (sfc.t_dateclose,'year') = trunc (parm.p_operdate,'year')) "
          + IIF(TaxTeriodToLucre, " union "
          + "                select op.t_OperDate "
          + "                  from parm, dnptxop_dbt op "
          + "                 where parm.p_SubKind_Operation = " + DL_TXBASECALC_OPTYPE_LUCRE
          + "                   and parm.p_IIS = CHR(0) "
          + "                   and op.t_Client = parm.p_ClientID "
          + "                   and op.t_DocKind = " + DL_CALCNDFL
          + "                   and op.t_IIS = parm.p_IIS "
          + "                   and op.t_SubKind_Operation = parm.p_SubKind_Operation "
          + "                   and op.t_Recalc = CHR(0) "
          + "                   and op.t_Status = " + DL_TXOP_Close
          + "                   and op.t_OperDate <= " + GetSQLDate(EndDate)
          + "                   and trunc(op.t_operdate,'year') = trunc("+GetSQLDate(EndDate)+",'year') ", "")
          + "            )  OutDate "
          + " WHERE OutDate.t_operdate > (SELECT NVL(MAX (TO_DATE (T_MESSAGE,'DD.MM.YYYY')) , TO_DATE( ' 01.01.0001', 'DD.MM.YYYY' ) ) "
          + "                               FROM DNPTXMES_DBT mes "
          + "                              WHERE mes.T_DOCID = " + RecalOperID + " AND T_TYPE > 1000 "
          + "                                AND ROUND((T_ACTION/1000),0) = " + Action 
          + "                            ) "
          + " order by OutDate.t_operdate asc ";

  return Query;
end;

macro GetBegPeriodDateInRecalcOper(RecalcOperID, CurAction, BegRecalcDate)
  var query, cmd, DataSet;
  var BegPeriodDate = BegRecalcDate;

  query =   " select ms.t_Message "
          + "   from dnptxmes_dbt ms "
          + "  where ms.t_DocID = ? "
          + "    and ms.t_Action = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(RecalcOperID);
  cmd.AddParam(CurAction + 1);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    BegPeriodDate = date(DataSet.Message) + 1;
  end;

  return BegPeriodDate;
end;

macro GetDateCalcIIS37(Oper:TRecHandler, Action, BegDate:@date, EndDate:@date, IsEndPeriod:@integer)
  var query, cmd, DataSet;
  var MaxPrevDate = date(0,0,0);
  var EndCalcDate = date(0,0,0);
  var Year = 0;

  BegDate = date(0,0,0);
  EndDate = date(0,0,0);
  IsEndPeriod = 0;

  cmd = DL_RSDCommand();
  query =   " select sf.t_DateClose "
          + "   from ddlcontr_dbt dlc, dsfcontr_dbt sf "
          + "  where dlc.t_DlContrID = " + cmd.AddParam(Oper.rec.Contract)
          + "    and sf.t_ID = dlc.t_SfContrID ";

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    EndCalcDate = date(DataSet.DateClose);
  end;

  if(EndCalcDate == date(0,0,0))
    if(Oper.rec.BegRecalcDate != date(0,0,0))
      EndCalcDate = Oper.rec.EndRecalcDate;
    else
      EndCalcDate = Oper.rec.OperDate;
    end;
  end;   

  cmd = DL_RSDCommand();

  query =   " SELECT NVL(MAX(TO_DATE(T_MESSAGE,'DD.MM.YYYY')), "+GetSQLDate(date(0,0,0))+" ) as MaxPrevDate "
          + "   FROM DNPTXMES_DBT mes "
          + "  WHERE mes.T_DOCID = " + cmd.AddParam(Oper.rec.ID) + " AND T_TYPE > 1000 "
          + "    AND ROUND((T_ACTION/1000),0) = " + cmd.AddParam(Action);

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    MaxPrevDate = date(DataSet.MaxPrevDate);
  end;

  if(MaxPrevDate == date(0,0,0)) //1-й период
    if(Oper.rec.BegRecalcDate != date(0,0,0))
      BegDate = Oper.rec.BegRecalcDate;
    else
      BegDate = GetFirstDateIIS(Oper.rec.Client, Oper.rec.Contract);
    end;

    datesplit(BegDate, null, null, Year);

    EndDate = date(31,12,Year);
    if(EndDate > EndCalcDate)
      EndDate = EndCalcDate;
    end;
  else
    datesplit(MaxPrevDate, null, null, Year);

    BegDate = date(1,1,Year+1);
    EndDate = date(31,12,Year+1);
    if(EndDate > EndCalcDate)
      EndDate = EndCalcDate;
    end;
  end;

  if(EndDate == EndCalcDate)
    IsEndPeriod = 1;
  end;

end;

private macro ConsRepaymPit()
   var ErrCode, OptionValue;

   // 0 - нет, 1 - да
   GetRegistryValue( "COMMON\\НДФЛ\\УЧИТЫВАТЬ ПОГАШЕНИЯ В НДФЛ", V_BOOL,
                  OptionValue, ErrCode );

   if (ErrCode != 0)
      return true;
   else
      if (OptionValue == 0)
         return false;
      else
         return true;
      end;
   end;
end;

private macro RepoPaysFact()
   var ErrCode, OptionValue;

   // 0 - расчетные, 1 - фактические
   GetRegistryValue( "COMMON\\НДФЛ\\ПРОМЕЖУТОЧНЫЕ ПЛАТЕЖИ ПО РЕПО", V_INTEGER,
                  OptionValue, ErrCode );

   if (ErrCode != 0)
      return true;
   else
      if (OptionValue == 0)
         return false;
      else
         return true;
      end;
   end;
end;

private macro ПроводитьПеретасовкуДляНДФЛ()
   var ErrCode, OptionValue;

   // 0 - Нет, 1 - Да
   GetRegistryValue( "COMMON\\НДФЛ\\ПРОВОДИТЬ ПЕРЕТАСОВКУ ДЛЯ НДФЛ", V_INTEGER,
                  OptionValue, ErrCode );

   if (ErrCode != 0)
      return true;
   else
      if (OptionValue == 0)
         return true;
      else
         return false;
      end;
   end;
end;

private macro УчитыватьНераспределенныеЗатратыПрошлыхЛет(OnDate:date)
   var ErrCode, Mode;

   if(OnDate == NULL)
     OnDate = {curdate};
   end;

   GetTaxRegValue("COMMON\\НДФЛ\\УЧЕТ ЗАТРАТ ПРОШЛЫХ ЛЕТ", OnDate, @Mode, @ErrCode);

   return Mode and (ErrCode == 0);
end;

private var IsIncludeMaterialInOut = NULL;
private macro УчитыватьМатВыгодуВзатратах()
   var ErrCode;

   if( IsIncludeMaterialInOut == NULL )
      GetRegistryValue( "COMMON\\НДФЛ\\УЧИТЫВАТЬ МАТ.ВЫГОДУ В ЗАТРАТАХ", V_BOOL, IsIncludeMaterialInOut, ErrCode );
      if( ErrCode != 0 )
         IsIncludeMaterialInOut = true;
      end;
   end;

   return IsIncludeMaterialInOut;
end;

private var IsIncludeTaxMaterial = NULL;
private macro УчитыватьНалогНаМатВыгоду()
   var ErrCode;

   if( IsIncludeTaxMaterial == NULL )
      GetRegistryValue( "COMMON\\НДФЛ\\УЧИТЫВАТЬ НАЛОГ НА МАТ. ВЫГОДУ", V_BOOL, IsIncludeTaxMaterial, ErrCode );
      if( ErrCode != 0 )
         IsIncludeTaxMaterial = true;
      end;
   end;

   return IsIncludeTaxMaterial;
end;

private macro УчетУбытковВТечениеГода()
  var УчетУбытковВТечениеГода_ = false;
  var ErrCode;
  
   GetRegistryValue("SECUR\\УЧЕТ УБЫТКОВ В ТЕЧЕНИЕ ГОДА", V_BOOL, УчетУбытковВТечениеГода_, ErrCode);
   if( ErrCode != 0 )
      УчетУбытковВТечениеГода_ = true;
   end;

  return УчетУбытковВТечениеГода_;
end;

macro IsCalcNOBCloseISS()
   var ErrCode, useCalcNOBEndIIS;

   GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\РАСЧЕТ_НОБ_ЗАКРЫТИЕ_ИИС3", V_BOOL, useCalcNOBEndIIS, ErrCode );

   return useCalcNOBEndIIS and (ErrCode == 0);
end;

private macro YearsDepIISBefTransf()
   var ErrCode, Years = 3;

   GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\ЗАЧЕТ_СРОК_ВЛАД_ИИС_ДО_ТРАНСФ", V_INTEGER, Years, ErrCode );

   return Years;
end;

private macro CуммаВычетаИИС3()
   var ErrCode, Sum = 30000000;

   GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\СУММА_МАКС_ВЫЧЕТА_ИИС3", V_INTEGER, Sum, ErrCode );

   return Sum;
end;

private macro ТочностьКЦБ()
   var ErrCode, posValue = 2;

   GetRegistryValue( "COMMON\\НДФЛ\\ТОЧНОСТЬ_КЦБ_ДЛЯ_ИНВЕСТВЫЧЕТА", V_INTEGER, posValue, ErrCode );

    if(ErrCode != 0)
      posValue = 2;
    end;

   return posValue;
end;

private macro РассчитыватьИнвестиционныйВычет():bool

   var RetVal:bool = false;
   var Year:integer = 0;

   DateSplit(pEndDate, null, null, Year);

   // значение категории "Рассчитывать инвестиционный вычет по НДФЛ" = "да" (незаданное значение категории трактуется как "Да") за весь период времени с 1 янв. года даты pEndDate до даты pEndDate

   var Select = " SELECT (CASE WHEN (NPTO.IsExistsAttr(?, LPAD(?, 10, '0'), 73, ?, ?, '2') = 0) " +
                "              THEN 1 ELSE 0 END) as RetVal " +
                "   FROM DUAL ";

    var Query = DL_RSDCommand(Select);
    Query.addParam(OBJTYPE_PARTY);
    Query.addParam(pClient);
    Query.addParam(date(1, 1, Year));
    Query.addParam(pEndDate);
    Query.addParam(OBJTYPE_PARTY);
    Query.addParam(pClient);
    Query.addParam(date(1, 1, Year));
    Query.addParam(pEndDate);

    var DataSet = Query.execute();

    if( DataSet.MoveNext() )
       RetVal = IIF((int(DataSet.RetVal)) == 1, true, false);
    end;

    return RetVal;
end;

private macro получитьВалютуНДР(Client, Date, Kind, Analitic5, AnaliticKind1N, Analitic1N , Analitic3N );
   var CurId = 0;

   var Select =  "  select t_Cur " +
                 "          from dnptxobj_dbt " +
                 "         where t_Client = ? " +
                 "           and t_Date  = ? "
                 "           and t_Kind  = ? "
                 "           and t_Analitic5  = ? "
                 "           and t_AnaliticKind1  = ? "
                 "           and t_Analitic1  = ? ";

   if( Analitic3N != null )
      Select = Select + "    and t_Analitic3  = ? "
   end;
   Select = Select + "       and ROWNUM = 1    ";

   var Query = DL_RSDCommand(Select);
   Query.addParam(Client);
   Query.addParam(Date);
   Query.addParam(Kind);
   Query.addParam(Analitic5);
   Query.addParam(AnaliticKind1N);
   Query.addParam(Analitic1N);
   if( Analitic3N != null )
      Query.addParam(Analitic3N);
   end;
   var DataSet = Query.execute();

   if( DataSet.MoveNext() )
      CurId = DataSet.Cur;
   end;

   return CurId;
end;

private macro IsCloseDBO(onDate, Client, IIS)
  var query, cmd, DataSet, Flag = false;
   
  query = "select RSI_NPTXCALC.IsCloseDBO(?, ?, ?) as fl from dual ";
  
  cmd = DL_RSDCommand(query);
  cmd.AddParam(onDate);
  cmd.AddParam(Client);
  cmd.AddParam(IIS);
  DataSet = cmd.Execute();
  
  if(DataSet.MoveNext())
    Flag = DataSet.fl == 1;
  end;
  
  return Flag;
end;

/**
@brief [in] Для объектов НДР, создаваемых в операциях пересчета НОБ, определяем признак "Технический расчет"
@param [in] pBegDate Дата начала
@param [in] pEndDate Дата окончания
@param [in] pClient ID клиента
@param [in] pKind Вид объектов НДР
@param [in] pAnaliticKind1 Вид аналитики 1
@param [in] pAnalitic1 Значение аналитики 1
@param [in] pAnalitickind2 Вид аналитики 2
@param [in] pAnalitic2 Значение аналитики 2
@param [in] pAnaliticKind3 Вид аналитики 3
@param [in] pAnalitic3 Значение аналитики 3
@param [in] pAnaliticKind4 Вид аналитики 4
@param [in] pAnalitic4 Значение аналитики 4
@param [in] pAnaliticKind5 Вид аналитики 5
@param [in] pAnalitic5 Значение аналитики 5
@param [in] pAnaliticKind6 Вид аналитики 6
@param [in] pAnalitic6 Значение аналитики 6
@param [in] pTechnical Признак технического расчета, установленный на операции расчета НОБ
@param [in] pRecalc Признак "Пересчет", установленный на операции расчета НОБ
*/
PRIVATE MACRO IsTechnicalOldNPTXOBJ(pDocID:INTEGER,
                                    pBegDate:DATE,
                                    pEndDate:DATE,
                                    pClient:INTEGER,
                                    pKind:INTEGER,
                                    pLevel:INTEGER,
                                    pAnaliticKind1:INTEGER,
                                    pAnalitic1:INTEGER,
                                    pAnalitickind2:INTEGER,
                                    pAnalitic2:INTEGER,
                                    pAnaliticKind3:INTEGER,
                                    pAnalitic3:INTEGER,
                                    pAnaliticKind4:INTEGER,
                                    pAnalitic4:INTEGER,
                                    pAnaliticKind5:INTEGER,
                                    pAnalitic5:INTEGER,
                                    pAnaliticKind6:INTEGER,
                                    pAnalitic6:INTEGER,
                                    pRecalc:String,
                                    pOutSystCode:String)

   if(pOutSystCode == NULL)
     pOutSystCode = "";
   end;

   if(pRecalc == SET_CHAR)
      var Technical = pTechnical;
      var query = "select RSI_NPTXCALC.IsTechnicalOldNPTXOBJ(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) as t_Technical " +
                  "from dual ";

      var cmd = DL_RSDCommand(query);
      cmd.AddParam(pDocID);
      cmd.AddParam(pBegDate);
      cmd.AddParam(pEndDate);
      cmd.AddParam(pClient);
      cmd.AddParam(pKind);
      cmd.AddParam(pLevel);
      cmd.AddParam(pAnaliticKind1);
      cmd.AddParam(pAnalitic1);
      cmd.AddParam(pAnaliticKind2);
      cmd.AddParam(pAnalitic2);
      cmd.AddParam(pAnaliticKind3);
      cmd.AddParam(pAnalitic3);
      cmd.AddParam(pAnaliticKind4);
      cmd.AddParam(pAnalitic4);
      cmd.AddParam(pAnaliticKind5);
      cmd.AddParam(pAnalitic5);
      cmd.AddParam(pAnaliticKind6);
      cmd.AddParam(pAnalitic6);
      cmd.AddParam(pTechnical);
      cmd.AddParam(pRecalc);
      cmd.AddParam(pOutSystCode);

      var DataSet = cmd.Execute();
      if(DataSet.MoveNext())
         return DataSet.Technical;
      end;
   end;

   return IIF(pTechnical > 0, SET_CHAR, UNSET_CHAR);
END;


PRIVATE VAR TaxObj = NULL;


/**
@brief Вставка объекта НДР в таблицу DNPTXOBJ_TMP
@param [in] Date Дата
@param [in] Client ID клиента
@param [in] Direction Направление
@param [in] Level Уровень 
@param [in] User Признак "Пользовательский"
@param [in] Kind Вид объекта НДР
@param [in] Sum Сумма объекта НДР
@param [in] Cur Валюта объекта НДР
@param [in] AnaliticKind1 Вид аналитики 1
@param [in] Analitic1 Значение аналитики 1
@param [in] AnaliticKind2 Вид аналитики 2
@param [in] Analitic2 Значение аналитики 2
@param [in] AnaliticKind3 Вид аналитики 3
@param [in] Analitic3 Значение аналитики 3
@param [in] AnaliticKind4 Вид аналитики 4
@param [in] Analitic4 Значение аналитики 4
@param [in] AnaliticKind5 Вид аналитики 5
@param [in] Analitic5 Значение аналитики 5
@param [in] AnaliticKind6 Вид аналитики 6
@param [in] Analitic6 Значение аналитики 6
@param [in] Comment Комментарий
@param [in] DocID ID текущей операии
@param [in] Step ID шага операции
@param [in] SumReestr
@param [in] Technical Признак "Технический"
@param [in] Recalc Признак "Пересчет"
@param [in] pTransfDate Дата трансформации ИИС в ИИС-3
@param [in] pTransfKind Период расчета
@param [in] ChangeCode Период расчета
*/
PRIVATE MACRO InsertTaxObjectTmp(Date, 
                                 Client,
                                 Direction,
                                 Level, 
                                 User,
                                 Kind,
                                 Sum,
                                 Cur,
                                 AnaliticKind1,
                                 Analitic1,
                                 AnaliticKind2,
                                 Analitic2,
                                 AnaliticKind3,
                                 Analitic3,
                                 AnaliticKind4,
                                 Analitic4,
                                 AnaliticKind5,
                                 Analitic5,
                                 AnaliticKind6,
                                 Analitic6,
                                 Comment,
                                 DocID,
                                 Step,
                                 SumReestr,
                                 Recalc,
                                 FromOutSyst,
                                 OutSystCode,
                                 OutObjID,
                                 TransfDate, 
                                 TransfKind,
                                 ChangeCode
                                )
   var cmd;
   var vTechnical = UNSET_CHAR;

   if((level >= 3) and (Level <= 7))
      vTechnical = IsTechnicalOldNPTXOBJ(DocID,
                                         pBegDate,
                                         pEndDate,
                                         pClient,
                                         Kind,
                                         Level,
                                         AnaliticKind1,
                                         Analitic1,
                                         Analitickind2,
                                         Analitic2,
                                         AnaliticKind3,
                                         Analitic3,
                                         AnaliticKind4,
                                         Analitic4,
                                         AnaliticKind5,
                                         Analitic5,
                                         AnaliticKind6,
                                         Analitic6,
                                         Recalc,
                                         OutSystCode,
                                         TransfDate, 
                                         TransfKind);
   end;

   if(TaxObj != NULL)
     TaxObj.Add( InsertObject,
                 Date,         
                 Client,       
                 Direction,    
                 Level,        
                 User,         
                 Kind,         
                 Sum,          
                 Cur,          
                 AnaliticKind1,
                 Analitic1,    
                 AnaliticKind2,
                 Analitic2,    
                 AnaliticKind3,
                 Analitic3,    
                 AnaliticKind4,
                 Analitic4,    
                 AnaliticKind5,
                 Analitic5,    
                 AnaliticKind6,
                 Analitic6,    
                 Comment,      
                 DocID,        
                 Step,         
                 SumReestr,
                 vTechnical,
                 FromOutSyst,
                 OutSystCode,
                 OutObjID,
                 TransfDate,
                 TransfKind,
                 ChangeCode
               );
   else

     if(ValType( SumReestr ) == V_UNDEF)
       SumReestr = 0;
     end;

     cmd = RSDCommand( " INSERT INTO DNPTXOBJ_TMP( T_FUNCTIONKIND , " +
                                               "   T_DATE         , " +
                                               "   T_CLIENT       , " +
                                               "   T_DIRECTION    , " +
                                               "   T_LEVEL        , " +
                                               "   T_USER         , " +
                                               "   T_KIND         , " +
                                               "   T_SUM          , " +
                                               "   T_CUR          , " +
                                               "   T_ANALITICKIND1, " +
                                               "   T_ANALITIC1    , " +
                                               "   T_ANALITICKIND2, " +
                                               "   T_ANALITIC2    , " +
                                               "   T_ANALITICKIND3, " +
                                               "   T_ANALITIC3    , " +
                                               "   T_ANALITICKIND4, " +
                                               "   T_ANALITIC4    , " +
                                               "   T_ANALITICKIND5, " +
                                               "   T_ANALITIC5    , " +
                                               "   T_ANALITICKIND6, " +
                                               "   T_ANALITIC6    , " +
                                               "   T_COMMENT      , " +
                                               "   T_DOCID        , " +
                                               "   T_STEP         , " +
                                               "   T_REESTRSUM    , " +
                                               "   T_FROMOUTSYST  , " +
                                               "   T_OUTSYSTCODE  , " +  
                                               "   T_OUTOBJID     , " +
                                               "   T_SOURCEOBJID  , " +
                                               "   T_TECHNICAL    , " +
                                               "   T_ACTION       , " +
                                               "   T_REALOBJID    , " +
                                               "   T_TRANSFDATE   , " +
                                               "   T_TRANSFKIND   , " +
                                               "   T_CHANGECODE   , " +
                                               "   T_HOLDING_PERIOD " +
                                               " )                  " +
                       " VALUES( ?, ?, ?, ?, ?, CHR(0), ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, "+IIF(FromOutSyst==SET_CHAR, "CHR(88)", "CHR(0)")+", "+IIF(OutSystCode==NULL, "CHR(1)", "?")+", "+IIF(OutObjID==NULL, "CHR(1)", "?")+", 0, ?, 0, 0, ?, ?, "+IIF(ChangeCode==SET_CHAR, "CHR(88)", "CHR(0)")+", 0) "
                     );

     cmd.addParam( "", RSDBP_IN, InsertObject ); 
     cmd.addParam( "", RSDBP_IN, Date         ); 
     cmd.addParam( "", RSDBP_IN, Client       ); 
     cmd.addParam( "", RSDBP_IN, Direction    ); 
     cmd.addParam( "", RSDBP_IN, Level        ); 
  //   cmd.addParam( "", RSDBP_IN, User         );
     cmd.addParam( "", RSDBP_IN, Kind         ); 
     cmd.addParam( "", RSDBP_IN, Sum          ); 
     cmd.addParam( "", RSDBP_IN, Cur          ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind1); 
     cmd.addParam( "", RSDBP_IN, Analitic1    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind2); 
     cmd.addParam( "", RSDBP_IN, Analitic2    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind3); 
     cmd.addParam( "", RSDBP_IN, Analitic3    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind4); 
     cmd.addParam( "", RSDBP_IN, Analitic4    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind5); 
     cmd.addParam( "", RSDBP_IN, Analitic5    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind6); 
     cmd.addParam( "", RSDBP_IN, Analitic6    ); 
     cmd.addParam( "", RSDBP_IN, Comment      ); 
     cmd.addParam( "", RSDBP_IN, DocID        ); 
     cmd.addParam( "", RSDBP_IN, Step         ); 
     cmd.addParam( "", RSDBP_IN, SumReestr    );
     if(OutSystCode != NULL)
       cmd.addParam( "", RSDBP_IN, OutSystCode  );
     end;
     if(OutObjID != NULL)
       cmd.addParam( "", RSDBP_IN, OutObjID     );
     end;
     cmd.addParam( "", RSDBP_IN, vTechnical   ); 
     if(TransfDate != NULL)
       cmd.addParam( "", RSDBP_IN, TransfDate  );
     else
       cmd.addParam( "", RSDBP_IN, ZeroDate  );
     end;
     if(TransfKind != NULL)
       cmd.addParam( "", RSDBP_IN, TransfKind  );
     else
       cmd.addParam( "", RSDBP_IN, 0 );
     end;
     cmd.execute();
  end;

END;


PRIVATE MACRO InsertTaxObjectWDTmp(Date, 
                                   Client,
                                   Direction,
                                   Level, 
                                   User,
                                   Kind,
                                   Sum,
                                   Cur,
                                   AnaliticKind1,
                                   Analitic1,
                                   AnaliticKind2,
                                   Analitic2,
                                   AnaliticKind3,
                                   Analitic3,
                                   AnaliticKind4,
                                   Analitic4,
                                   AnaliticKind5,
                                   Analitic5,
                                   AnaliticKind6,
                                   Analitic6,
                                   Comment,
                                   DocID,
                                   Step
                                  )
   var cmd;

   if(TaxObj != NULL)
     TaxObj.Add( InsertObjectWD,
                 Date,         
                 Client,       
                 Direction,    
                 Level,        
                 User,         
                 Kind,         
                 Sum,          
                 Cur,          
                 AnaliticKind1,
                 Analitic1,    
                 AnaliticKind2,
                 Analitic2,    
                 AnaliticKind3,
                 Analitic3,    
                 AnaliticKind4,
                 Analitic4,    
                 AnaliticKind5,
                 Analitic5,    
                 AnaliticKind6,
                 Analitic6,    
                 Comment,      
                 DocID,        
                 Step,
                 0
               );
   else

     cmd = RSDCommand( " INSERT INTO DNPTXOBJ_TMP( T_FUNCTIONKIND , " +
                                               "   T_DATE         , " +
                                               "   T_CLIENT       , " +
                                               "   T_DIRECTION    , " +
                                               "   T_LEVEL        , " +
                                               "   T_USER         , " +
                                               "   T_KIND         , " +
                                               "   T_SUM          , " +
                                               "   T_CUR          , " +
                                               "   T_ANALITICKIND1, " +
                                               "   T_ANALITIC1    , " +
                                               "   T_ANALITICKIND2, " +
                                               "   T_ANALITIC2    , " +
                                               "   T_ANALITICKIND3, " +
                                               "   T_ANALITIC3    , " +
                                               "   T_ANALITICKIND4, " +
                                               "   T_ANALITIC4    , " +
                                               "   T_ANALITICKIND5, " +
                                               "   T_ANALITIC5    , " +
                                               "   T_ANALITICKIND6, " +
                                               "   T_ANALITIC6    , " +
                                               "   T_COMMENT      , " +
                                               "   T_DOCID        , " +
                                               "   T_STEP         , " +
                                               "   T_FROMOUTSYST  , " +
                                               "   T_OUTSYSTCODE  , " +
                                               "   T_OUTOBJID     , " +
                                               "   T_SOURCEOBJID    " +
                                               " )                  " +
                       " VALUES( ?, ?, ?, ?, ?, CHR(1), ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CHR(0), CHR(1), CHR(1), 0 ) "
                     );

     cmd.addParam( "", RSDBP_IN, InsertObjectWD ); 
     cmd.addParam( "", RSDBP_IN, Date         ); 
     cmd.addParam( "", RSDBP_IN, Client       ); 
     cmd.addParam( "", RSDBP_IN, Direction    ); 
     cmd.addParam( "", RSDBP_IN, Level        ); 
  //   cmd.addParam( "", RSDBP_IN, User         );
     cmd.addParam( "", RSDBP_IN, Kind         ); 
     cmd.addParam( "", RSDBP_IN, Sum          ); 
     cmd.addParam( "", RSDBP_IN, Cur          ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind1); 
     cmd.addParam( "", RSDBP_IN, Analitic1    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind2); 
     cmd.addParam( "", RSDBP_IN, Analitic2    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind3); 
     cmd.addParam( "", RSDBP_IN, Analitic3    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind4); 
     cmd.addParam( "", RSDBP_IN, Analitic4    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind5); 
     cmd.addParam( "", RSDBP_IN, Analitic5    ); 
     cmd.addParam( "", RSDBP_IN, AnaliticKind6); 
     cmd.addParam( "", RSDBP_IN, Analitic6    ); 
     cmd.addParam( "", RSDBP_IN, Comment      ); 
     cmd.addParam( "", RSDBP_IN, DocID        ); 
     cmd.addParam( "", RSDBP_IN, Step         ); 
     cmd.execute();
   end;

END;

PRIVATE MACRO GetpContract(Oper)
   var pContr = -1;
   var Select, Query, DataSet;

   if((Oper.rec.DocKind == DL_HOLDNDFL) or ((Oper.rec.DocKind == DL_WRTMONEY) and (Oper.rec.SubKind_Operation == 20))) //для операции удержания НДФЛ и списания д/с
      if(Oper.rec.Contract > 0) //берём договор из панели операции, если задан
         pContr = Oper.rec.Contract;
      elif(Oper.rec.Account != "") //берём первый договор, в СПИ которого указан счет, выбранный в панели операции
         Select = "select sfcontr.t_ID as t_SfContrID " +
                  "from dsfssi_dbt sfssi, dsettacc_dbt settacc, dsfcontr_dbt sfcontr " +
                  "where settacc.t_Account = ? " +
                  "  and sfssi.t_SetAccID = settacc.t_SettAccID " +
                  "  and sfssi.t_ObjectType = " + string(OBJTYPE_SFCONTR) +
                  "  and sfcontr.t_ID = to_number(sfssi.t_ObjectID) " +
                  "  and sfcontr.t_PartyID = ? ";

         Query = DL_RSDCommand(Select);
         Query.AddParam(Oper.rec.Account);
         Query.AddParam(Oper.rec.Client);

         DataSet = Query.Execute();

         if(DataSet.MoveNext())
            pContr = DataSet.SfContrID;
         end;
      end;
   end;

   if(pContr < 0)
      Select = 
               " SELECT NVL (MIN (Obj.t_Analitic6), -1) Contr"+
               "  FROM dnptxobdc_dbt odc, DNPTXOBJ_DBT Obj "+
               " WHERE odc.t_ObjID = obj.t_ObjID "+
               "   AND odc.t_DocID = ? " + 
               "   AND rsi_npto.CheckContrIIS(Obj.t_Analitic6) = "+IIF(Oper.rec.IIS == SET_CHAR, "1", "0");

      Query = DL_RSDCommand(Select);
      Query.addParam( pDocID );
      DataSet = Query.execute();

      if( (DataSet.MoveNext()) and (DataSet.Contr > 0) )
         pContr = DataSet.Contr;
      end;

      if( (pContr == -1) )
         Select = 
          " SELECT NVL(t_ID, -1) Contr "+
          "    FROM DSFCONTR_DBT "+
          "   WHERE (T_ServKind =  " + PTSK_STOCKDL +
          "          OR T_ServKind =  " + PTSK_DV + ")" +
          "     AND rsi_npto.CheckContrIIS(T_ID) = "+IIF(Oper.rec.IIS == SET_CHAR, "1", "0")+  
          "     AND T_PartyID =  ? " + // pClient 
          "     AND T_DateBegin <= ? "+    // OperDate
          "     AND (T_DateClose >= ? " +
          "          OR T_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
          "ORDER BY T_ServKind";

         Query = DL_RSDCommand(Select);
         Query.addParam( pClient );
         Query.addParam( pEndDate );
         Query.addParam( pEndDate );
         DataSet = Query.execute();

         if( DataSet.MoveNext()  )
            pContr = DataSet.Contr;
         end;
      end;
   end;

   return pContr;
END;

MACRO GetPtContrIDForNDR(ClientID:integer, dat:date, IIS:integer)
  var query, cmd, DataSet;
  var ContrID = -1;

  query =   " select sf.t_ID "
          + "   from dsfcontr_dbt sf "
          + "  where sf.t_ServKind = " + PTSK_STOCKDL
          + "    and sf.t_PartyID = ? "
          + "    and sf.t_DateBegin <= ? "
          + "    and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ?) "
          + "    and rsi_npto.CheckContrIIS(sf.t_ID) = ? "
          + "    and rownum = 1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(dat);
  cmd.AddParam(dat);
  cmd.AddParam(IIS);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    ContrID = DataSet.ID;
  end;

  return ContrID;
END;


/**
@brief Возвращает значение категории "Признак технческого расчета"
@param [in] DocKind вид первичного документа
@param [in] OperID ID операции расчета НОБ
@return если значение категории "Признак технческого расчета" найдено, то AttrID значения
@return иначе -1
*/
MACRO IsTechnical(DocKind:Integer, DocID:Integer):INTEGER
   if(DocKind == DL_CALCNDFL)
      var queryObjAtCor = "select ( " +
                          "          case objatcor.t_AttrID " +
                          "             when 1 " +
                          "             then 1 " +
                          "             else 0 " +
                          "          end " +
                          "       ) as t_Technical " +
                          "from dobjatcor_dbt objatcor " +
                          "where objatcor.t_ObjectType = " + string(OBJTYPE_NPTXCALC) +
                          "  and objatcor.t_Object = LPAD(?, 34, '0') " +
                          "  and objatcor.t_GroupID = 1 ";
   
      var cmdObjAtCor = DL_RSDCommand(queryObjAtCor);
      cmdObjAtCor.AddParam(DocID);
      var dsObjAtCor = cmdObjAtCor.Execute();
      
      if(dsObjAtCor.MoveNext())
         return dsObjAtCor.Technical;
      end;
   end;

   return 0;
END;


MACRO ОпределитьТипИИС(ContractID:integer, Type:@integer, DateBegin:@date, DateEnd:@date, Dtransf:@date, OpenDate:@date, DateOpr:date)
  private const IISType  = 1;
  private const IIS3Type = 2;
  var dlcontr = TRecHandler("DLCONTR.DBT");
  var sfcontr = TBFile("SFCONTR.DBT");
  var vDtransf = ZeroDate;
  var query;
  var cmd;
  var data_set;
  var year = 0;

  query = "SELECT DL.* FROM DDLCONTR_DBT DL " + 
          " WHERE DL.T_DLCONTRID = ? ";
          
  cmd = DL_RSDCommand(query);
  cmd.addParam(ContractID);
  data_set = cmd.Execute();

  if( data_set.MoveNext() )
    data_set.GetRecord().CopyTo(dlcontr.rec);
  else
    return 1;
  end;

  sfcontr.Clear();
  sfcontr.rec.ID = dlcontr.rec.SFCONTRID;
  
  if( not sfcontr.GetEQ() )
    return 1;
  end;

  if(dlcontr.rec.iistype == 0) 
    dlcontr.rec.iistype = 1;
  end;

  OpenDate = sfcontr.rec.DateBegin;

  if( (dlcontr.rec.iistransformdatefns >= date(01,01,2025)) and 
      (dlcontr.rec.iistransformdatefns <= date(31,01,2025))
    )
      vDtransf = date(01,01,2024);
  else
    DateSplit(dlcontr.rec.iistransformdatefns, null, null, Year);
    if(Year > 0)
      vDtransf = date(01,01,Year);
    end;
  end;

  if( ((dlcontr.rec.iistype == IISType) and 
       (dlcontr.rec.iistransfer != SET_CHAR) and 
       (dlcontr.rec.iisistransformed != SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns == ZeroDate) 
      ) OR 
      ((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer != SET_CHAR) and 
       (dlcontr.rec.iisistransformed == SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns == ZeroDate)
      )
    )
    Type = IISTYPEA;
    DateBegin = sfcontr.rec.DateBegin;
    DateEnd = IIF(sfcontr.rec.DateClose != ZeroDate, sfcontr.rec.DateClose, DateOpr);
    Dtransf = ZeroDate;
  elif(((dlcontr.rec.iistype == IISType) and 
       (dlcontr.rec.iistransfer == SET_CHAR) and 
       (dlcontr.rec.iisistransformed != SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns == ZeroDate)
      ) OR 
      ((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer == SET_CHAR) and 
       (dlcontr.rec.iisistransformed == SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns == ZeroDate)
      ) OR 
      ((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer == SET_CHAR) and 
       (dlcontr.rec.iisistransformed != SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent != ZeroDate) and 
       (dlcontr.rec.iistransformdatefns == ZeroDate)
      )
    )
    Type = IISTYPEB;
    DateBegin = dlcontr.rec.iisfirstdate;
    DateEnd = IIF(sfcontr.rec.DateClose != ZeroDate, sfcontr.rec.DateClose, DateOpr);
    Dtransf = ZeroDate;
  elif((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer != SET_CHAR) and 
       (dlcontr.rec.iisistransformed != SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns == ZeroDate) 
    )
    Type = IISTYPEC;
    DateBegin = sfcontr.rec.DateBegin;
    DateEnd = IIF(sfcontr.rec.DateClose != ZeroDate, sfcontr.rec.DateClose, DateOpr);
    Dtransf = ZeroDate;
  elif((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer != SET_CHAR) and 
       (dlcontr.rec.iisistransformed == SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns != ZeroDate) 
    )
    Type = IISTYPED;
    DateBegin = sfcontr.rec.DateBegin;
    DateEnd = IIF(sfcontr.rec.DateClose != ZeroDate, sfcontr.rec.DateClose, DateOpr);
    Dtransf = vDtransf;
  elif((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer == SET_CHAR) and 
       (dlcontr.rec.iisistransformed != SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent != ZeroDate) and 
       (dlcontr.rec.iistransformdatefns != ZeroDate) 
    )
    Type = IISTYPEE;
    DateBegin = dlcontr.rec.iisfirstdate;
    DateEnd = IIF(sfcontr.rec.DateClose != ZeroDate, sfcontr.rec.DateClose, DateOpr);
    Dtransf = vDtransf;
  elif((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer == SET_CHAR) and 
       (dlcontr.rec.iisistransformed == SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns != ZeroDate) 
    )
    Type = IISTYPEF;
    DateBegin = dlcontr.rec.iisfirstdate;
    DateEnd = IIF(sfcontr.rec.DateClose != ZeroDate, sfcontr.rec.DateClose, DateOpr);
    Dtransf = vDtransf;
  elif((dlcontr.rec.iistype == IIS3Type) and 
       (dlcontr.rec.iistransfer == SET_CHAR) and 
       (dlcontr.rec.iisistransformed != SET_CHAR) and 
       (dlcontr.rec.iistransformdatetaxagent == ZeroDate) and 
       (dlcontr.rec.iistransformdatefns == ZeroDate) 
    )
    Type = IISTYPEG;
    DateBegin = dlcontr.rec.iisfirstdate;
    DateEnd = IIF(sfcontr.rec.DateClose != ZeroDate, sfcontr.rec.DateClose, DateOpr);
    Dtransf = ZeroDate;
  end;

  return 0;
END;

PRIVATE MACRO ОпределитьПараметрыРасчета( Oper, NeedContr:bool )
   var Year;
   var ObjAttrNum;
   var TaxTeriodToLucre;

   if(NeedContr == NULL)
     NeedContr = false;
     if(Oper.rec.IIS == SET_CHAR)
       NeedContr = true;
     end;
   end;

   pIIS = IIF((Oper.rec.IIS == SET_CHAR), 1, 0);

   pFIID = Oper.rec.FIID;

/******** Сурен. ********/  
   if (pFIID == 0) pFIID = -1;
   end;
/****************/
   pDocKind = Oper.rec.DocKind;
   DateSplit( Oper.rec.OperDate, null, null, Year );
   TaxTeriodToLucre = CheckTaxTeriodToLucre(Year);
   if( (pDocKind == DL_CALCNDFL) and (Oper.rec.Recalc == SET_CHAR) )
      //pBegDate = Oper.rec.BegRecalcDate;
      pBeg     = Oper.rec.BegRecalcDate;
      pEndDate = Oper.rec.EndRecalcDate;
      pEnd     = Oper.rec.EndRecalcDate;
   else
      /*pBegDate = IIF(pDocKind == DL_HOLDNDFL, Oper.rec.PrevDate,
                                              IIF(((Oper.rec.PrevDate == Date (0,0,0)) OR (Oper.rec.PrevDate == null)), 
                                                  date(1, 1, Year), Oper.rec.PrevDate + 1
                                                 )
                    );*/
      pBeg = IIF(pDocKind == DL_HOLDNDFL, Oper.rec.PrevDate, date(1, 1, Year));
      pEndDate = Oper.rec.OperDate;
     
      if (pDocKind == DL_HOLDNDFL)
         DateSplit( Oper.rec.PrevDate, null, null, Year );
         pEnd = date(31, 12, Year);
      else
         pEnd = Oper.rec.OperDate;
      end;
   end;

   pClient  = Oper.rec.Client;
   pDocID   = Oper.rec.ID;
   pSubKindOperation = Oper.rec.SubKind_Operation;

   pContract = -1;
   if(NeedContr)
     pContract = GetpContract(Oper);
   end;

   PtIsRes = DL_GetPartyResident(pClient);

   if(Oper.rec.DocKind == DL_CALCNDFL)
      pTechnical = IsTechnical(Oper.rec.DocKind, Oper.rec.ID);

      var queryEarlyTechCalc = "SELECT 1 " +
                               "FROM DNPTXOP_DBT nptxop " +
                               "WHERE nptxop.t_Client = ? " +
                               "  AND nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                               "  AND nptxop.t_Contract = ? " + 
                               "  AND nptxop.t_Kind_Operation = 2035 " +
                               "  AND nptxop.t_OperDate <= ? " +
                               "  AND EXTRACT(YEAR FROM nptxop.t_OperDate) = EXTRACT(YEAR FROM ?) " +
                               "  AND RSB_SECUR.GetMainObjAttr(132 /*OBJTYPE_NPTXCALC*/, LPAD(nptxop.t_ID, 34, '0'), 1, nptxop.t_OperDate) = 1 " +
                               "  AND EXISTS( " +
                               "               SELECT 1 " +
                               "               FROM DNPTXOBDC_DBT obdc " +
                               "               WHERE obdc.t_DocID = nptxop.t_ID " +
                               "            ) " +
                               IIF(TaxTeriodToLucre, "  AND nptxop.t_SubKind_Operation " + IIF(Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_LUCRE, " = ", " <> ") + DL_TXBASECALC_OPTYPE_LUCRE +
                                                     "  AND nptxop.t_ID <> ? ", "") +
                               "  AND ROWNUM  = 1 ";
   
      var cmdEarlyTechCalc = DL_RSDCommand(queryEarlyTechCalc);
      cmdEarlyTechCalc.AddParam(pClient);
      cmdEarlyTechCalc.AddParam(Oper.rec.Contract);
      cmdEarlyTechCalc.AddParam(Oper.rec.OperDate);
      cmdEarlyTechCalc.AddParam(Oper.rec.OperDate);
      if(TaxTeriodToLucre)
        cmdEarlyTechCalc.AddParam(Oper.rec.ID);
      end;
   
      var DSEarlyTechCalc = cmdEarlyTechCalc.Execute();
      if(DSEarlyTechCalc.MoveNext())
         pExistEarlyTechCalc = 1;
      else
         pExistEarlyTechCalc = 0;
      end;
   else
      pTechnical = -1;
      pExistEarlyTechCalc = 0;
   end;
   
   pTransfDate = ZeroDate;
   pTransfKind = 0;
   pDateNDR = NULL;
END;

PRIVATE MACRO GetDlContrID(SfContrID:integer)
  var query, cmd, DataSet;
  var DlContrID = 0;

  if(SfContrID > 0)
    cmd = DL_RSDCommand();

    query = "select dlc.t_DlContrID from ddlcontr_dbt dlc where dlc.t_SfContrID = " + cmd.AddParam(SfContrID);

    DataSet = cmd.Execute(query);

    if(DataSet.moveNext())
      DlContrID = DataSet.DlContrID;
    end;

    if(DlCOntrID == 0)
      cmd = DL_RSDCommand();

      query = "select mp.t_DlContrID from ddlcontrmp_dbt mp where mp.t_SfContrID = " + cmd.AddParam(SfContrID);

      DataSet = cmd.Execute(query);

      if(DataSet.moveNext())
        DlContrID = DataSet.DlContrID;
      end;
    end;
  end;

  return DlContrID;
END;

PRIVATE MACRO GetDlCOntrIDByNPTXOP(nptxop)
  var op = TRecHandler("nptxop.dbt");
  var DlContrID = 0;

  copy(op, nptxop);

  if(op.rec.DocKind == DL_CALCNDFL)
    DlContrID = op.rec.Contract;
  else
    DlContrID = GetDlContrID(op.rec.Contract);
  end;

  return DlContrID;
END;

PRIVATE MACRO GetBegDate( Oper, SetBegYear:bool )

  var Year, TaxTeriodToLucre;

  DateSplit(Oper.rec.OperDate, null, null, Year);

  TaxTeriodToLucre = CheckTaxTeriodToLucre(Year);

  if(pDocKind == DL_CALCNDFL)
     if(Oper.rec.Recalc == SET_CHAR)
        pBegDate = Oper.rec.BegRecalcDate;
     elif((pIIS == 1) and (Oper.rec.SubKind_Operation != DL_TXBASECALC_OPTYPE_NORMAL))
        pBegDate = GetFirstDateIIS(pClient, GetDlCOntrIDByNPTXOP(Oper));
     elif((Oper.rec.PrevDate == NULL) or (Oper.rec.PrevDate == Date(0, 0, 0)))
        pBegDate = Date(1, 1, Year);
        if(pIIS == 1)
          pBegDate = GetFirstDateIIS(pClient, GetDlCOntrIDByNPTXOP(Oper));
        end;
     else
        if(SetBegYear)
          pBegDate = date(1, 1, Year);
        else
          pBegDate = Date(Oper.rec.PrevDate);
          if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_LUCRE) and (TaxTeriodToLucre == true))
            pBegDate = pBegDate + 1;
          end;
        end;
     end;
  elif(pDocKind == DL_HOLDNDFL)
     pBegDate = Oper.rec.PrevDate;
  else
     if((Oper.rec.PrevDate == NULL) or (Oper.rec.PrevDate == Date(0, 0, 0)))
        pBegDate = Date(1, 1, Year);
     else
        pBegDate = Oper.rec.PrevDate;
     end;
  end;

END;

/*Общие ф-и для расчета*/
PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

//курс ЦБ РФ валюты v к НацВ на дату d
PRIVATE MACRO К (v, d)
   var RetVal = 0.0;
   SmartConvertSumDbl(RetVal, 1.0, d, v, NATCUR, false);

   RETURN RetVal;
END;

private macro IsBuy( Type, Pos )
   if( Type == "B" )
      return true;
   elif( Type == "S" )
      return false;
   elif( Type == "E" )
      if( Pos == 1 )
         return true;
      elif( Pos == 2 )
         return false;
      end;
   end;
   return false;
end;                           

PRIVATE MACRO PrDeriv(DataSet, DataSet2)

   if( DataSet.AvoirKind == DERIVATIVE_FUTURES )
      if (DataSet.PriceMode == 0)  // DERIVATIVE_MODE_TICKFI = 0,   //В валюте шага цены
         return DataSet2.Price * DV_TickCost(DataSet.FIID, date(DataSet.Date)) / DataSet.Tick;

      elif (DataSet.PriceMode == 1)  // DERIVATIVE_MODE_PARENTFI = 1  //В валюте стоимости шага цены
         return DataSet2.Cost;
      end;
   else
      return DataSet2.Bonus;
   end;
END;

private var prevFIID = NULL, prevValueDate = NULL, prevFaceValue = NULL;
PRIVATE MACRO GetFaceValue_Ex(FIID, ValueDate)
   var FaceValue = 0.0;
   
   if((prevFIID == FIID) and (prevValueDate == ValueDate))
     FaceValue = prevFaceValue;
   else
     FaceValue = prevFaceValue = GetFaceValue(FIID, ValueDate);
     prevFIID = FIID;
     prevValueDate = ValueDate;
   end;

   if (FaceValue == 0.0)
      return 1.0;
   else
      return FaceValue;
   end;
END;

private var _f = TRecHandler("fininstr");
private var _FIID = NULL;
PRIVATE MACRO GetFininsrt(FIID, fin)
  var stat = 0;
  
  if(_FIID != FIID)
    stat = ПолучитьФинИн( FIID, _f );
  end; 

  if(stat == 0)
    copy(fin, _f);
    _FIID = FIID;
  end;

  return stat;
END;

private var prevBondFIID = NULL;
private var prevIsBond = null;
PRIVATE MACRO FininstrIsBond(fin)
  var IsBond = false;
  if(prevBondFIID == fin.rec.FIID)
    IsBond = prevIsBond;
  else
    IsBond = FI_IsBond(fin);
    prevIsBond = IsBond;
    prevBondFIID = fin.rec.FIID;
  end;

  return IsBond;
END;

PRIVATE MACRO KN(FIID, ValueDate, RetVal:@variant )
   var fininstr = TRecHandler( "fininstr" );

   RetVal = 0;

   if (GetFininsrt( FIID, fininstr ) == 0)
      if (FininstrIsBond(fininstr))
         RetVal = GetFaceValue_Ex(FIID, ValueDate) / 100.0;
      else
         RetVal = 1;
      end;
   else
      return Error( "Не найден финансовый инструмент FIID = " + string(FIID) + " при определении параметра KN" );
   end;

   return 0;
END;

PRIVATE MACRO PrDeal(DocKind, DocID, FIID, CFI, LegPrice, DealDate, ValueDate, RelativePrice, RetVal:@variant )
   var fininstr = TRecHandler( "fininstr" );
   var deal     = TBfile("dl_tick", "R"), v_KN; 

   RetVal = 0;
   if (DocKind == DL_AVRWRT)
      RetVal = LegPrice; // Считается в ХП-шке, здесь уже готовая величина
      if (GetFininsrt( FIID, fininstr ) == 0)
         if ( (not FininstrIsBond(fininstr)) and (fininstr.rec.FaceValueFI != CFI) )
            RetVal = RetVal * К( CFI, DealDate) / К( fininstr.rec.FaceValueFI, DealDate);
         end;
      else
         return Error( "Не найден финансовый инструмент FIID = " + string(FIID) + " при определении параметра PrDeal" );
      end;
   else
      if (GetFininsrt( FIID, fininstr ) == 0)
         RetVal = LegPrice;
         if( FininstrIsBond(fininstr) and (RelativePrice == "X") )
            if( KN(DataSet.PFI, date(DataSet.FactDate), @v_KN ) == 0 )
                RetVal = RetVal * v_KN;
            end;
         elif (fininstr.rec.FaceValueFI != CFI)
            RetVal = RetVal * К( CFI, DealDate) / К( fininstr.rec.FaceValueFI, DealDate);
         end;
      else
         return Error( "Не найден финансовый инструмент FIID = " + string(FIID) + " при определении параметра PrDeal" );
      end;
   end;

   return 0;
END;

PRIVATE MACRO CL(pDate, A, D1, D2, FIID)
   return GetCouponSumByPeriod_Rub( FIID, A, D1 + 1, D2 );
END;

PRIVATE MACRO Get_str_RQDate()
   var sql_PlanDate:String = 
      " (NVL( (SELECT min(rq.t_PlanDate) " +
      "  FROM ddlrq_dbt rq " + 
      "  WHERE rq.t_DocKind    = Tick.t_BOfficeKind " +
      "     AND rq.t_DocID      = Tick.t_DealID " +
      "     AND rq.t_State     <> " + string(DLRQ_STATE_EXEC) + 
      "     AND rq.t_SubKind    = " + string(DLRQ_SUBKIND_AVOIRISS) +
      "     AND rq.t_Type       = " + string(DLRQ_TYPE_DELIVERY) +
      "     AND rq.t_DealPart   = 1 " +
      "     ), TO_DATE('01-01-0001','DD-MM-YYYY') )" +
      " ) ";

   var sql_FactDate:String = 
      " (NVL( (SELECT min(rq.t_FactDate) " +
      "  FROM ddlrq_dbt rq " + 
      "  WHERE rq.t_DocKind    = Tick.t_BOfficeKind " +
      "     AND rq.t_DocID      = Tick.t_DealID " +
      "     AND rq.t_State      = " + string(DLRQ_STATE_EXEC) + 
      "     AND rq.t_SubKind    = " + string(DLRQ_SUBKIND_AVOIRISS) +
      "     AND rq.t_Type       = " + string(DLRQ_TYPE_DELIVERY) +
      "     AND rq.t_DealPart   = 1 " +
      "     ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
      " ) ";

   return 
      " (DECODE( " +
           sql_FactDate + ", " +                   // Выражение
      "    TO_DATE('01-01-0001','DD-MM-YYYY'), " + // search1
           sql_PlanDate + ", " +                   // result1
           sql_FactDate + ") " +                   // default
      " ) ";
END;

PRIVATE MACRO GetSumDLSUM(DocKind, DocID, EndDate, Client)
   var Select, Query, DataSet, Sum = $0;
    
   Select = "select NVL( Sum( RSB_FIInstr.ConvSum(Comis.t_Sum, M.T_FIID_COMM, " + string(NATCUR) + ", Comis.t_FactPayDate)),0) v_Sum " +
            "  from  DNPTXCOMM_TMP Comis, DSFCOMISS_DBT M, DSFCONTR_DBT Contr " +
            " where Comis.t_DocKind = ? " +
            "   and Comis.t_DocID = ? " +
            "   and Contr.T_ID = Comis.T_Contract " +
            "   and Contr.T_PARTYID = ? ";
  
            if(not CheckTaxDepositoryMode() ) 
              Select =    Select +  
              "   and rsb_secur.CheckExistGrDealByCom(Comis.t_DocKind, Comis.t_DocID, Contr.T_ID, Comis.T_PLANPAYDATE, "+string(DLGRACC_STATE_PLAN)+") = 0 " ;
            end;

            Select =    Select +
            "   and Comis.t_FactPayDate <= ? " +
            "   and M.T_FEETYPE = Comis.T_FEETYPE " +  
            "   and M.T_NUMBER  = Comis.T_COMNUMBER ";

   Query = DL_RSDCommand(Select);
   Query.addParam( DocKind );
   Query.addParam( DocID );
   Query.addParam( Client );
   Query.addParam( EndDate );
   DataSet = Query.execute();
   
   if( DataSet.MoveNext() )
      Sum = DataSet.v_Sum;
   end;

   return Sum;
END;

PRIVATE MACRO GetSumBASOBJ(DocKind, DocID, EndDate, Client)
   var Select, Query, DataSet, Sum = $0;

   Select = "select NVL( Sum( RSB_FIInstr.ConvSum(BasObj.t_CommSum, DefCom.t_FIID_commSum, " + string(NATCUR) + ", DefCom.t_DatePay)),0) v_Sum " +
            "  from dsfbasobj_dbt BasObj, dsfdefcom_dbt DefCom, dsfcomiss_dbt comiss, ddl_tick_dbt Tick, DSFCONTR_DBT Contr " +
            " where Tick.t_DealID = ? " +
            "   and Tick.t_BOfficeKind = ? " +
            "   and DefCom.t_ConID = Contr.T_ID " +
            "   and Contr.T_PARTYID = ? "
            "   and ((Contr.T_PARTYID = Tick.t_ClientID) OR " +
            "        (Tick.t_IsPartyClient = 'X' AND Contr.T_PARTYID = Tick.t_PartyID)) " +
            "   and DefCom.t_DatePay <= ? " +
            "   and comiss.t_feeType = DefCom.t_feeType " +
            "   and comiss.t_number  = DefCom.t_commNumber " +
            "   and comiss.t_FormAlg = " + string(SFCOMISS_FORMALG_MANUAL) +
            "   and comiss.t_feeType = " + string(SF_FEE_TYPE_PERIOD) +
            "   and BasObj.t_FeeType = comiss.t_feeType " +
            "   and BasObj.t_DefCommID = DefCom.t_ID " +
            "   and BasObj.t_BaseObjectType = Tick.t_BOfficeKind " +
            "   and BasObj.t_BaseObjectID = Tick.t_DealID " +
            "   and BasObj.t_AccountedInIncluded <> 1 ";

   Query = DL_RSDCommand(Select);
   Query.addParam( DocID );
   Query.addParam( DocKind );
   Query.addParam( Client );
   Query.addParam( EndDate );
   DataSet = Query.execute();
   
   if( DataSet.MoveNext() )
      Sum = DataSet.v_Sum;
   end;

   return Sum;
END;

/*фактическое число календарных дней в периоде от Д1 до Д2, приходящихся на високосный/невисокосный год*/
PRIVATE MACRO T36X( D1:DATE, D2:DATE, DaysInYear:INTEGER ):INTEGER
   VAR CY, Y1, Y2, T1 = 0, T2 = 0, T3 = 0;
   DateSplit( D1, null, null, Y1 );
   DateSplit( D2, null, null, Y2 );

   if( Y1 == Y2 )
      if( GetDaysInYear(Y1) == DaysInYear )
         return D2-D1;
      else
         return 0;
      end;
   else
      if( GetDaysInYear(Y1) == DaysInYear )
         T1 = DATE(31,12,Y1)-D1;
      end;
      if( GetDaysInYear(Y2) == DaysInYear )
         T2 = D2-DATE(31,12,Y2-1); // если даты за разные годы, то начало интервала не учитываем, но учитываем конец. Следовательно, к кусочку за год окончания интервала, +1 день.
      end;

      CY = Y1+1;
      while( CY <= Y2-1 )
         if( GetDaysInYear(CY) == DaysInYear )
            T3 = T3 + DaysInYear;
         end;
         CY = CY + 1;
      end;

      return T1 + T2 + T3;
   end;
END;

PRIVATE MACRO Kyear( Basis:INTEGER, D1:DATE, D2:DATE ):DOUBLE
  var Y1, Y2, CY;
  var TX1 = 0, TX2 = 0;

  if (D1 == D2)
     if ((Basis == SP_KINDBASISCALC_CAL_CAL) or (Basis == SP_KINDBASISCALC_CAL_30))
        return 1.0/GetDaysInYear(D2);

     elif ((Basis == SP_KINDBASISCALC_360_30) or (Basis == SP_KINDBASISCALC_360_CAL))
        return 1.0/360.0;

     elif ((Basis == SP_KINDBASISCALC_365_CAL) or (Basis == SP_KINDBASISCALC_365_30))
        return 1.0/365.0;

     end;
  else
     if( Basis == SP_KINDBASISCALC_365_CAL )
        return (D2-D1)/365.0;

     elif( Basis == SP_KINDBASISCALC_CAL_CAL )
        TX1 = T36X(D1, D2, 366);
        TX2 = T36X(D1, D2, 365);

        return ( TX1/366.0)+(TX2/365.0);

     elif( Basis == SP_KINDBASISCALC_CAL_30 )
        DateSplit(D1,null,null,Y1);
        DateSplit(D2,null,null,Y2);
        CY = Y1;
        while(CY<=Y2)
          if(GetDaysInYear(CY) == 366) //високосный год
            if((date(29,02,CY) >= D1) AND (date(29,02,CY) <= D2))
              //если между датами Д1 и Д2 есть 29 февраля, то делим на 366
              return NDays30Correct( D1, D2 )/366.0;
            end;
          end;
          CY = CY + 1;
        end;

        return NDays30Correct( D1, D2 )/365.0;

     elif( Basis == SP_KINDBASISCALC_360_30 )
        return NDays30Correct( D1, D2 )/360.0;

     elif( Basis == SP_KINDBASISCALC_360_CAL )
        return (D2-D1)/360.0;

     elif( Basis == SP_KINDBASISCALC_365_30 )
        return NDays30Correct( D1, D2 )/365.0;
     end;
  end;
END;

PRIVATE MACRO FRepo_Ex( DealID:INTEGER, D2:DATE, CFI:INTEGER, Direction:INTEGER, Client:INTEGER ):MONEY
   var Query, sql, rsd;

   Query =   "select NVL(sum(RSB_FIInstr.ConvSum(t_Sum, t_Cur, ?, t_date)),0) as S "
           + "  from dnptxobj_dbt "
           + " where t_Kind IN ( " + string(TXOBJ_MAIN) + ", " + string(TXOBJ_NKD) + ", " + string(TXOBJ_PAY) + ", " + string(TXOBJ_PROCREPOPAY) + " )"
           + "   and t_AnaliticKind1 = ? "
           + "   and t_Analitic1 = ? "
           + "   and t_Direction = ? "
           + "   and t_Client = ? ";

   sql =  DL_RsdCommand(Query);
   sql.addParam( CFI );
   sql.addParam( TXOBJ_KIND1010 );
   sql.addParam( DealID );
   sql.addParam( Direction );
   sql.addParam( Client );

   rsd = sql.execute();

   if(rsd.moveNext())
      return rsd.S;
   else
      return $0;
   end;
END;


PRIVATE MACRO FRepo( DealID:INTEGER, D2:DATE, CFI:INTEGER, Client:INTEGER ):MONEY
   return FRepo_Ex( DealID, D2, CFI, TXOBJ_DIR_IN, Client ) - FRepo_Ex( DealID, D2, CFI, TXOBJ_DIR_OUT, Client );
END;

PRIVATE MACRO SumYear( DealID:INTEGER, D2:DATE, CFI:INTEGER, Dir1:INTEGER, Basis:INTEGER, Client:INTEGER, IsBuy:INTEGER ):MONEY
   var Query, sql, rsd, RetVal = $0, prevDate = NULL, _Kyear = NULL;

   Query =   "select obj.*, NVL(RSB_FIInstr.ConvSum(t_Sum, t_Cur, ?, t_Date),0) as S "
           + "  from dnptxobj_dbt obj "
           + " where obj.t_Kind IN ( " + string(TXOBJ_MAIN) + ", " + string(TXOBJ_NKD) + " )"
           + "   and obj.t_AnaliticKind1 = ? "
           + "   and obj.t_Analitic1 = ? "
           + "   and obj.t_Direction = ? "
           + "   and obj.t_Client = ? "
           + " order by obj.t_Date";

   sql =  DL_RsdCommand(Query);
   sql.addParam( CFI );
   sql.addParam( TXOBJ_KIND1010 );
   sql.addParam( DealID );
   sql.addParam( Dir1 );
   sql.addParam( Client );

   rsd = sql.execute();

   while(rsd.moveNext())
      if(prevDate != date(rsd.Date))
        _Kyear = Kyear( Basis, date(rsd.Date), D2 );
        prevDate  = date(rsd.Date);
      end;

      RetVal = RetVal + rsd.S * _Kyear;
   end;

   Query =   "select obj.*, NVL(RSB_FIInstr.ConvSum(t_Sum, t_Cur, ?, t_Date),0) as S "
           + "  from dnptxobj_dbt obj "
           + " where obj.t_Kind = " + string(TXOBJ_PAY)
           + "   and obj.t_AnaliticKind1 = ? "
           + "   and obj.t_Analitic1 = ? "
           + "   and obj.t_Client = ? "
           + " order by obj.t_Date";

   sql =  DL_RsdCommand(Query);
   sql.addParam( CFI );
   sql.addParam( TXOBJ_KIND1010 );
   sql.addParam( DealID );
   sql.addParam( Client );

   rsd = sql.execute();

   while(rsd.moveNext())
      var Ki:integer = 1;
      if( ((rsd.S == TXOBJ_DIR_OUT) and (IsBuy != 1)) or ((rsd.S == TXOBJ_DIR_IN) and (IsBuy == 1)) )
         Ki = -1;
      end;

      if(prevDate != date(rsd.Date))
        _Kyear = Kyear( Basis, date(rsd.Date), D2 );
        prevDate  = date(rsd.Date);
      end;

      RetVal = RetVal + (Ki * rsd.S * _Kyear);
   end;

   return RetVal;
END;

// Получить суммарные параметры НДР по вставленным объектам по записям ТС
// Flag_Buy: для покупок, кроме того, берём сумму НДР в валюте
// ExcludeKind - НДР, кол-во связи по которым надо исключить из подсчета кол-ва ц\б в связи для Kind 
private macro GetSumNdrByTS(LotID, Flag_Buy, Kind, DocID, Step, SumAmount:@money, SumNDR:@money, SumNDR_DelNom:@money, NeedDelNom:bool, ExcludeKind)
   var Select, Query, DataSet, Select2, Query2, DataSet2, NDR, NDR_DelNom;

   SumAmount = $0;
   SumNDR = $0;
   SumNDR_DelNom = $0;

   Query = DL_RSDCommand();

   Select = 
   " SELECT (NDR1.sum+NDR2.sum) SumNDR, (NDR1.Amount+NDR2.Amount) SumAmount ";

   if(Flag_Buy == true)
      Select = Select +
      ", (NDR1.NDR_DelNom1+NDR2.NDR_DelNom2) SumNDR_DelNom ";
   end;

   Select = Select + " From ";

   Select = Select + "(" +
   IIF(Flag_Buy == true, 
      "  SELECT nvl(sum(TXOBJ.t_sum0),0) sum, " +
      IIF(NeedDelNom == true,
         "         nvl(sum(TXOBJ.t_sum0/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom1, ",
         "         0 NDR_DelNom1, "
         ),
      "  SELECT nvl(sum(TXOBJ.t_sum),0) sum, "
      );

   if( ExcludeKind != null )
      Select = Select +
      "         nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ "+
      "                                    WHERE OBJ.T_KIND = ? "+
      "                                      AND OBJ.T_ANALITICKIND2 = ? "+
      "                                      AND OBJ.T_ANALITIC2 = TS.T_ID " +
      "                                 ) then 0 else TS.t_Amount end),0) Amount ";
      Query.addParam( ExcludeKind );
      Query.addParam( TXOBJ_KIND2020 );
   else
      Select = Select +
      "         nvl(sum(TS.t_Amount),0) Amount ";
   end;

   Select = Select +
      "    FROM DNPTXOBJ_DBT TXOBJ, DNPTXTS_DBT TS "+
   IIF(Flag_Buy == true, "   WHERE TS.T_BUYID = ? ", "   WHERE TS.T_SALEID = ? ")+
      "     AND TXOBJ.T_KIND = ? "+
      "     AND TXOBJ.T_ANALITICKIND2 = ? "+
      "     AND TXOBJ.T_ANALITIC2 = TS.T_ID " +
      ") NDR1 ";

   Query.addParam( LotID );
   Query.addParam( Kind );
   Query.addParam( TXOBJ_KIND2020 );

   Select = Select + ", (" +
   IIF(Flag_Buy == true, 
      "   SELECT nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )),0) sum, "+
      IIF(NeedDelNom == true,
          "          nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom2, ",
          "          0 NDR_DelNom2, "
         ),
      "   SELECT nvl(sum(TXOBJ.t_sum),0) sum, "
      );

   if( ExcludeKind != null )
      Select = Select +
      "         nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ "+
      "                                    WHERE OBJ.T_KIND = ? "+
      "                                      AND OBJ.T_ANALITICKIND2 = ? "+
      "                                      AND OBJ.T_ANALITIC2 = TS.T_ID " +
      "                                 ) then 0 else TS.t_Amount end),0) Amount ";
      Query.addParam( ExcludeKind );
      Query.addParam( TXOBJ_KIND2020 );
   else
      Select = Select +
      "         nvl(sum(TS.t_Amount),0) Amount ";
   end;

   Select = Select +
      "    FROM DNPTXOBJ_TMP TXOBJ, DNPTXTS_DBT TS "+
   IIF(Flag_Buy == true, "   WHERE TS.T_BUYID = ? ", "   WHERE TS.T_SALEID = ? ")+
      "     AND TXOBJ.T_KIND = ? "+
      "     AND TXOBJ.T_ANALITICKIND2 = ? "+
      "     AND TXOBJ.T_ANALITIC2 = TS.T_ID "+
      "     AND TXOBJ.T_DOCID = ? "+
      "     AND TXOBJ.T_STEP  = ? " +
      ") NDR2 ";

   Query.addParam( LotID );
   Query.addParam( Kind );
   Query.addParam( TXOBJ_KIND2020 );
   Query.addParam( DocID );
   Query.addParam( Step  );

   DataSet = Query.execute(Select);

   if(DataSet.moveNext())
     SumAmount     = DataSet.SumAmount;
     SumNDR        = DataSet.SumNDR;
     if(Flag_Buy == true)
       SumNDR_DelNom = DataSet.SumNDR_DelNom;
     end;
   end;

end;

// Получить суммарные параметры НДР по вставленным объектам по связям
// Flag_Buy: для покупок, кроме того, берём сумму НДР в валюте
// ExcludeKind - НДР, кол-во связи по которым надо исключить из подсчета кол-ва ц\б в связи для Kind 
private macro GetSumNdrByLink(LotID, Flag_Buy, Kind, DocID, Step, SumAmount:@money, SumNDR:@money, SumNDR_DelNom:@money, NeedDelNom:bool, ExcludeKind)
   var Select, Query, DataSet, Select2, Query2, DataSet2, NDR, NDR_DelNom;

   SumAmount = $0;
   SumNDR = $0;
   SumNDR_DelNom = $0;

   Query = DL_RSDCommand();

   Select = 
   " SELECT (NDR1.sum+NDR2.sum) SumNDR, (NDR1.Amount+NDR2.Amount) SumAmount ";

   if(Flag_Buy == true)
      Select = Select +
      ", (NDR1.NDR_DelNom1+NDR2.NDR_DelNom2) SumNDR_DelNom ";
   end;

   Select = Select + " From ";

   Select = Select + "(" +
   IIF(Flag_Buy == true, 
      "  SELECT nvl(sum(TXOBJ.t_sum0),0) sum, " +
      IIF(NeedDelNom == true,
         "         nvl(sum(TXOBJ.t_sum0/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom1, ",
         "         0 NDR_DelNom1, "
         ),
      "  SELECT nvl(sum(TXOBJ.t_sum),0) sum, "
      );

   if( ExcludeKind != null )
      Select = Select +
      "         nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ "+
      "                                    WHERE OBJ.T_KIND = ? "+
      "                                      AND OBJ.T_ANALITICKIND2 = ? "+
      "                                      AND OBJ.T_ANALITIC2 = LNK.T_ID " +
      "                                 ) then 0 else LNK.t_Amount end),0) Amount ";
      Query.addParam( ExcludeKind );
      Query.addParam( TXOBJ_KIND2010 );
   else
      Select = Select +
      "         nvl(sum(LNK.t_Amount),0) Amount ";
   end;

   Select = Select +
      "    FROM DNPTXOBJ_DBT TXOBJ, DNPTXLNK_DBT LNK "+
   IIF(Flag_Buy == true, "   WHERE LNK.T_BUYID = ? ", "   WHERE LNK.T_SALEID = ? ")+
      "     AND TXOBJ.T_KIND = ? "+
      "     AND TXOBJ.T_ANALITICKIND2 = ? "+
      "     AND TXOBJ.T_ANALITIC2 = LNK.T_ID " +
      ") NDR1 ";

   Query.addParam( LotID );
   Query.addParam( Kind );
   Query.addParam( TXOBJ_KIND2010 );

   Select = Select + ", (" +
   IIF(Flag_Buy == true, 
      "   SELECT nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )),0) sum, "+
      IIF(NeedDelNom == true,
          "          nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom2, ",
          "          0 NDR_DelNom2, "
         ),
      "   SELECT nvl(sum(TXOBJ.t_sum),0) sum, "
      );

   if( ExcludeKind != null )
      Select = Select +
      "         nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ "+
      "                                    WHERE OBJ.T_KIND = ? "+
      "                                      AND OBJ.T_ANALITICKIND2 = ? "+
      "                                      AND OBJ.T_ANALITIC2 = LNK.T_ID " +
      "                                 ) then 0 else LNK.t_Amount end),0) Amount ";
      Query.addParam( ExcludeKind );
      Query.addParam( TXOBJ_KIND2010 );
   else
      Select = Select +
      "         nvl(sum(LNK.t_Amount),0) Amount ";
   end;

   Select = Select +
      "    FROM DNPTXOBJ_TMP TXOBJ, DNPTXLNK_DBT LNK "+
   IIF(Flag_Buy == true, "   WHERE LNK.T_BUYID = ? ", "   WHERE LNK.T_SALEID = ? ")+
      "     AND TXOBJ.T_KIND = ? "+
      "     AND TXOBJ.T_ANALITICKIND2 = ? "+
      "     AND TXOBJ.T_ANALITIC2 = LNK.T_ID "+
      "     AND TXOBJ.T_DOCID = ? "+
      "     AND TXOBJ.T_STEP  = ? " +
      ") NDR2 ";

   Query.addParam( LotID );
   Query.addParam( Kind );
   Query.addParam( TXOBJ_KIND2010 );
   Query.addParam( DocID );
   Query.addParam( Step  );

   DataSet = Query.execute(Select);

   if(DataSet.moveNext())
     SumAmount     = DataSet.SumAmount;
     SumNDR        = DataSet.SumNDR;
     if(Flag_Buy == true)
       SumNDR_DelNom = DataSet.SumNDR_DelNom;
     end;
   end;

end;

PRIVATE MACRO IsPartyResident()
   if (PtIsRes == NPTXPARTY_RESIDENT)
      return true;
   else
      return false;
   end;
END;

PRIVATE MACRO Rs()
   if (IsPartyResident())
      return 9.0;
   else
      return 15.0;
   end;
END;

PRIVATE MACRO Rg()
   var retval;
   if (IsPartyResident())
      retval = 13.0;
   else
     //Если вдруг на клиенте физлице нерезиденте задано примечание "Налоговая ставка для физического лица - нерезидента по общим доходам"
     var _stat = ПолучитьЗначениеПримечанияНаДату(pClient, PARTY_NOTE_KIND_NPTX_RATE_NOTRES /*налоговая ставка физикаНерезидента*/, pEndDate, @retval);
     if (_stat != 0)
       retval = 30.0;
     end;
   end;
   return retval;
END;

PRIVATE MACRO Rp()
   var retval;
   if (IsPartyResident())
      retval = 15.0;
   else
     retval = 0.0;
   end;
   return retval;
END;

PRIVATE MACRO ПосчитатьРубСуммуПоСвязиСоЗнаком(ID:integer, StrKind:string, MinDate:date, MaxDate:date)
   var C1 = 0, SumVal, SumRub;

   DL_GetNPTXOBJSumByLink(ID, StrKind, MinDate, MaxDate, TXOBJ_DIR_IN, @SumVal, @SumRub);
   C1 = SumRub;

   DL_GetNPTXOBJSumByLink(ID, StrKind, MinDate, MaxDate, TXOBJ_DIR_OUT, @SumVal, @SumRub);
   C1 = C1 - SumRub;

   return C1;
END;

PRIVATE MACRO ПосчитатьРубСуммуПоСделкеСоЗнаком(DealID:integer, StrKind:string, MinDate:date, MaxDate:date, ClientID)
   var C1 = 0, SumVal, SumRub;

   DL_GetNPTXOBJSumByDeal(DealID, StrKind, MinDate, MaxDate, TXOBJ_DIR_IN, @SumVal, @SumRub, null, ClientID);
   C1 = SumRub;

   DL_GetNPTXOBJSumByDeal(DealID, StrKind, MinDate, MaxDate, TXOBJ_DIR_OUT, @SumVal, @SumRub, null, ClientID);
   C1 = C1 - SumRub;

   return C1;
END;

PRIVATE MACRO DSC( S_ID:integer, pEndDate:date )
  return ПосчитатьРубСуммуПоСвязиСоЗнаком(S_ID, string(TXOBJ_DISCOUNT_LINK), pBegDate, pEndDate);
END;

PRIVATE MACRO NPS( S_ID:integer, pEndDate:date )

   var NkdS, NkdS0;

   DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_NKDS) + ", " + string(TXOBJ_NKDS_SHORT), null, pEndDate, null, @NkdS, @NkdS0);

   return NkdS0;
END;

PRIVATE MACRO NPS_0( S_ID:integer, pEndDate:date )

   var NkdS, NkdS0;

   DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_NKDS), null, pEndDate, null, @NkdS, @NkdS0);

   return NkdS0;
END;

PRIVATE MACRO NPB( S_ID:integer, pEndDate:date )

   var NkdB, NkdB0;

   DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_NKDB) + ", " + string(TXOBJ_NKDB_SHORT), null, pEndDate, null, @NkdB, @NkdB0);

   return NkdB0;
END;

PRIVATE MACRO NPB_0( S_ID:integer, pEndDate:date )

   var NkdB, NkdB0;

   DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_NKDB), null, pEndDate, null, @NkdB, @NkdB0);

   return NkdB0;
END;

PRIVATE MACRO CM( S_ID:integer, pEndDate:date )

   var S, S0, MaterialB, MaterialB0;

   if( УчитыватьМатВыгодуВзатратах() )
      DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_MATERIALB), null, pEndDate, null, @MaterialB, @MaterialB0);
   else
      MaterialB = MaterialB0 = $0.0;
   end;

   DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_TAXPM_LINK)+", "+string(TXOBJ_COMS)+", "+string(TXOBJ_COMB), null, pEndDate, null, @S, @S0);

   return S0 + MaterialB0;
END;

PRIVATE MACRO CM_Short( S_ID:integer, pEndDate:date )

   var S, S0, MaterialB, MaterialB0;

   if( УчитыватьМатВыгодуВзатратах() )
      DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_MATERIALB_SHORT), null, pEndDate, null, @MaterialB, @MaterialB0);
   else
      MaterialB = MaterialB0 = $0.0;
   end;

   DL_GetNPTXOBJSumByLink(S_ID, string(TXOBJ_TAXPM_LINK_SHORT)+", "+string(TXOBJ_COMS_SHORT)+", "+string(TXOBJ_COMB_SHORT), null, pEndDate, null, @S, @S0);

   return S0 + MaterialB0;
END;

PRIVATE MACRO ПолучитьСуммы( C1, C2, D:@variant, R:@variant )
   D = R = 0;
   if ((C2 < 0) and (C1 > 0))
      D = -C1;
      R = abs(C2);
   elif ((C2 > 0) and (C1 < 0))
      D = C2;
      R = C1;
   elif ((C2 < 0) and (C1 < 0) and (abs(C1) > abs(C2)))
      R = abs(C2) - abs(C1); // сума получается отрицательная
   elif ((C2 > 0) and (C1 > 0) and (C1 > C2))
      D = C2 - C1; // сумма - отрицательная
   elif ((C2 < 0) and (C1 < 0) and (abs(C2) > abs(C1)))
      R = abs(C2) - abs(C1); // положительная
   elif ((C2 > 0) and (C1 > 0) and (C2 > C1))
      D = C2 - C1; // положительная
   elif ((C2 > 0) and (C1 == 0))
      D = C2;
   elif ((C2 < 0) and (C1 == 0))
      R = abs(C2);
   elif ((C2 == 0) and (C1 > 0))
      D = -C1; // отрицательная сумма
   elif ((C2 == 0) and (C1 < 0))
      R = C1; // отрицательная сумма
   end;
END;


CLASS TCalcPaidParams()
  var НОБ_осн           = $0;
  var НОБ_повыш         = $0;
  var Налог_осн         = $0;
  var Налог_повыш       = $0;
  var КоррНалог0207     = $0;
  var КоррНалог0201     = $0;
  var КоррНалог0208     = $0;
                      
  var НОБ_осн_ИИС       = $0;
  var НОБ_повыш_ИИС     = $0;
  var Налог_осн_ИИС     = $0;
  var Налог_повыш_ИИС   = $0;
  var КоррНалог0207_ИИС = $0;
  var КоррНалог0201_ИИС = $0;
  var КоррНалог0208_ИИС = $0;

  var НОБ_ДЕПО_КБК0201       = $0;
  var НОБ_ДЕПО_КБК0207       = $0;
  var НОБ_ДЕПО_КБК0208       = $0;
  var Налог_ДЕПО_КБК0201     = $0;
  var Налог_ДЕПО_КБК0207     = $0;
  var Налог_ДЕПО_КБК0208     = $0;
                           
  var НОБ_ДЕПО_КБК0201_ИИС   = $0;
  var НОБ_ДЕПО_КБК0207_ИИС   = $0;
  var НОБ_ДЕПО_КБК0208_ИИС   = $0;
  var Налог_ДЕПО_КБК0201_ИИС = $0;
  var Налог_ДЕПО_КБК0207_ИИС = $0;
  var Налог_ДЕПО_КБК0208_ИИС = $0;


  var Bg_SOFR_IIS = $0;
  var Bp_SOFR_IIS = $0;
  var Bg_SOFR     = $0;
  var Bp_SOFR     = $0;
                
  var Bg_DEPO_IIS = $0;
  var Bp_DEPO_IIS = $0;
  var Bg_DEPO     = $0;
  var Bp_DEPO     = $0;

  var Dg_0201_IIS = $0;
  var Dg_0207_IIS = $0;
  var Dp_0208_IIS = $0;
                     
  var Dg_IIS = $0;
  var Dp_IIS = $0;
                     
  var DEPO_Dg_0201_IIS = $0;
  var SOFR_Dg_0201_IIS = $0;
  var DEPO_Dg_0207_IIS = $0;
  var SOFR_Dg_0207_IIS = $0;
  var DEPO_Dp_0208_IIS = $0;
  var SOFR_Dp_0208_IIS = $0;
                     
  var Dg_0201 = $0;
  var Dg_0207 = $0;
  var Dp_0208 = $0;
                     
  var Dg = $0;
  var Dp = $0;
                     
  var DEPO_Dg_0201 = $0;
  var SOFR_Dg_0201 = $0;
  var DEPO_Dg_0207 = $0;
  var SOFR_Dg_0207 = $0;
  var DEPO_Dp_0208 = $0;
  var SOFR_Dp_0208 = $0;

END;

CLASS CPriorNDFL()
  var ArrPrior = TArray();
  
  class cPriorPrm(_Rate, _TypeNOB, _SpecTag, _Sys, _KBK, _Priority)
    var Rate = _Rate, 
        TypeNOB = _TypeNOB, 
        SpecTag = _SpecTag, 
        Sys = _Sys, 
        KBK = _KBK,
        Priority = _Priority;
  end;
  
  private macro loadPriorFromDB()
    var cmd, query, ds;
    
    query = "Select * from dnptxpriorityndfl_dbt";
    
    cmd = DL_RSDCommand(query);
    
    ds = cmd.Execute();

    ArrPrior.size = 0;

    while(ds.MoveNext)
      ArrPrior[ArrPrior.size] = cPriorPrm(ds.Rate, ds.TypeNOB, ds.SpecialTag, ds.Sys, ds.KBK, ds.Priority);
    end;
  end;
  
  macro getPriorForObj(_Rate, _TypeNOB, _SpecTag, _Sys, _KBK)
    var i = 0;
    var KBK = _KBK;

    if(StrLen(_KBK) > 3)
      KBK = substr(_KBK,8,3);
    end;

    while(i < ArrPrior.size)
      if( (ArrPrior[i].Rate == _Rate) and 
          (ArrPrior[i].TypeNOB == _TypeNOB) and
          (ArrPrior[i].SpecTag == _SpecTag) and
          (ArrPrior[i].Sys == _Sys) and
          (ArrPrior[i].KBK == KBK)
        )
        return ArrPrior[i].Priority;
      end;
      i = i + 1;
    end;
    
    return 0;
  end;
  
  loadPriorFromDB();
END;

//////////////////////////////////////////////////////////////////
//Процедура получения суммы удержанного налога
//////////////////////////////////////////////////////////////////
MACRO CalcPaidSum( pClient, pContract, pDocKind, pSubKindOperation, pBegDate, pEndDate, pSO, pSZ, pTO, //IN
                   Bg:@variant, Bm:@variant, Bs:@variant, Dm:@variant, Ds:@variant, Dg:@variant,   //OUT
                   IIS, p_Po:@variant, Bd:@variant, Bp:@variant, Dp:@variant, Pg:@variant, Pm:@variant, Ps:@variant, Pp:@variant, Pd:@variant,
                   Rg:@variant, Rs:@variant, Rp:@variant, ByKBK:@bool, DgKBK1:@variant, DgKBK2:@variant, CalcParams:@TCalcPaidParams )

  var /*Pg=$0, Pm=$0, Ps=$0,*/ Po=$0, /*Pp=$0, Pd=$0,*/ /*Bo,*/ vBegDate, Year;
  var Bg1 = $0, Bg2 = $0, Bg3 = $0, Bg4 = $0, Bg5 = $0, Bg6 = $0, Bg7 = $0, Bg8 = $0, Bg9 = $0;
  var ClientResident = false;                     
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";                     
  var AddWhereFromOut = " obj.t_FromOutSyst = 'X'";
  
  //file notetext("notetext.dbt") key 5; /*по автоинкременту*/
  var notetext:TBFile = TBFile("notetext.dbt", "R", 5);/*по автоинкременту*/

  ByKBK = false;

  Rg = 0.0;
  Dm = $0;
  Ds = $0;
  Dg = $0;
  Dp = $0;
  DgKBK1 = $0; 
  DgKBK2 = $0;

  Bg = $0;
  Bm = $0;
  Bs = $0;
  Bp = $0;
  Bd = $0;

  Pg = $0; 
  Pm = $0; 
  Ps = $0;
  Pp = $0; 
  Pd = $0;

  Rg=0.0; 
  Rs=0.0; 
  Rp=0.0;

  if(CalcParams == NULL)
    CalcParams = TCalcPaidParams();
  end;

  var vIIS = IIF( (IIS == SET_CHAR), 1 , 0 );
  if( vIIS == 1 )
     vBegDate = GetFirstDateIIS(pClient, GetDlContrID(pContract));
  else
     vBegDate = pBegDate;
  end;

  DateSplit(pEndDate, NULL, NULL, Year);

  if( DL_GetPartyResident(pClient) == NPTXPARTY_RESIDENT )
    ClientResident = true;
  end;

  ПолучитьСтавкиНалога(pClient, ClientResident, pEndDate, @Rg, @Rp, @Rs);

  if((Year == 2022) and (vIIS == 0) and (pDocKind == DL_HOLDNDFL) and (pSubKindOperation == DL_TXHOLD_OPTYPE_ENDYEAR))
    
    Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL), vBegDate, pEndDate, null, vIIS);

    Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
         GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, 0 /*только пользовательские*/,null, vIIS) +
         GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), NULL, NULL, DL_HOLDNDFL, NULL, vIIS) + //созданные в операциях удержания НДФЛ
         GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDSPECIAL), vBegDate, pEndDate) + //созданные в операции "Расчет и начисление дохода" в депозитарии
         GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, DL_RETIREMENT_OWN,null, vIIS) + //созданные в операциях погашения ОЭБ
         /*плюс операции в ПС <Векселя банка>*/
         GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                                  string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                                  string(DL_VSINTERCHANGE) );      //зачет взаимных требований

    Ds = Rs * Bs - Ps;

    var НОБ_ДЕПО, НОБ_ДЕПО_КБК1, НОБ_ДЕПО_КБК2, НОБ_ДЕПО_КБК3;
    var Налог_ДЕПО_КБК1, Налог_ДЕПО_КБК2, Налог_ДЕПО_КБК3; 
    var НОБ_СОФР = $0, НОБ15_СОФР = $0, Налог_СОФР = $0, Налог15_СОФР = $0;
    var Налог_КБК1 = $0, Налог_КБК2 = $0, Налог_КБК3 = $0;

    ПолучитьЗначенияДЕПО_СОФР_2022(pClient,
                                   ClientResident,
                                   Year,
                                   vBegDate,
                                   pEndDate,
                                   vIIS,
                                   @НОБ_СОФР, @НОБ15_СОФР,
                                   @Налог_СОФР, @Налог15_СОФР,
                                   @НОБ_ДЕПО, @НОБ_ДЕПО_КБК1, @НОБ_ДЕПО_КБК2, @НОБ_ДЕПО_КБК3,
                                   @Налог_ДЕПО_КБК1, @Налог_ДЕПО_КБК2, @Налог_ДЕПО_КБК3,
                                   @Налог_КБК1, @Налог_КБК2, @Налог_КБК3
                                  );

    DgKBK1 = Налог_КБК1;
    DgKBK2 = Налог_КБК2;
    ByKBK  = true;
    
    Dg  = DgKBK1 + DgKBK2; 
    Dp  = Налог_КБК3;

    Po = Dg + Dp + Ds;

    Dg = round(Dg,0);
    Dm = round(Dm,0);         
    Ds = round(Ds,0);
    Dp = round(Dp,0);
    p_Po = round(Po,0);

    return;

  elif((РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ()) and (GetStartSTBDate() != date(0,0,0)) and (pEndDate >= GetStartSTBDate()))
    var q, DataSet, select;
    var y = 0;
    var НОБ_осн = $0, НОБ_повыш = $0, Налог_осн = $0, Налог_повыш = $0;

    q =   " select NVL(SUM((CASE WHEN t_RateHoldPITax != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " AND t_TaxBaseCurrPay > 0 THEN t_TaxBaseCurrPay ELSE 0 END)), 0) as SumTaxBaseCurrPay_Main, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " AND t_TaxBaseCurrPay > 0 THEN t_TaxBaseCurrPay ELSE 0 END)), 0) as SumTaxBaseCurrPay_15, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND instr(UPPER(t_Description), UPPER('Диасофт')) = 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumHoldPITax_Main, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND instr(UPPER(t_Description), UPPER('Диасофт')) = 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumHoldPITax_15, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_TaxBaseCurrPay ELSE 0 END)), 0) as SumTaxBaseCurrPay_Main_IIS, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_TaxBaseCurrPay ELSE 0 END)), 0) as SumTaxBaseCurrPay_15_IIS, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND instr(UPPER(t_Description), UPPER('Диасофт')) = 0 AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumHoldPITax_Main_IIS, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND instr(UPPER(t_Description), UPPER('Диасофт')) = 0 AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumHoldPITax_15_IIS, "
        + "        NVL(SUM((CASE WHEN instr(t_BCCHoldPITax, '0207') > 0 AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumCorrTax0207, "
        + "        NVL(SUM((CASE WHEN instr(t_BCCHoldPITax, '0201') > 0 AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumCorrTax0201, "
        + "        NVL(SUM((CASE WHEN instr(t_BCCHoldPITax, '0208') > 0 AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumCorrTax0208, "
        + "        NVL(SUM((CASE WHEN instr(t_BCCHoldPITax, '0207') > 0 AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumCorrTax0207_IIS, "
        + "        NVL(SUM((CASE WHEN instr(t_BCCHoldPITax, '0201') > 0 AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumCorrTax0201_IIS, "
        + "        NVL(SUM((CASE WHEN instr(t_BCCHoldPITax, '0208') > 0 AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_HoldPITax ELSE 0 END)), 0) as SumCorrTax0208_IIS, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_BCCHoldPiTax = '"+NPTXKBK_MAIN+"' AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " AND t_TaxBaseCurrPay < 0 THEN t_TaxBaseCurrPay ELSE 0 END)), 0) as SumTaxBaseNegDEPO_201, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_BCCHoldPiTax = '"+NPTXKBK_PROC+"' AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " AND t_TaxBaseCurrPay < 0 THEN t_TaxBaseCurrPay ELSE 0 END)), 0) as SumTaxBaseNegDEPO_207, "
        + "        NVL(SUM((CASE WHEN t_RateHoldPITax = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_BCCHoldPiTax = '"+NPTXKBK_INCR+"' AND instr(UPPER(t_Description), UPPER('Диасофт')) <> 0 AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " AND t_TaxBaseCurrPay < 0 THEN t_TaxBaseCurrPay ELSE 0 END)), 0) as SumTaxBaseNegDEPO_208 "
        + "   from dnptxtotalbase_dbt "
        + "  where t_ClientID = ? "
        + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
        + "    and t_Type in (1, 2, 3, 4) "
        + "    and ((t_IncDate BETWEEN ? and ? and t_TaxPeriod = ?) or (t_TaxPeriod = ?)) ";

    select = DL_RSDCommand();

    select.AddParam(pClient);
    select.AddParam(vBegDate);
    select.AddParam(pEndDate);
    select.AddParam(Year);
    select.AddParam(Year);

    if(pSubKindOperation != DL_TXHOLD_OPTYPE_ENDYEAR) //НЕ окончание года
      //Если тип операции != "окончание года", то исключаем из отбора записи, в которых Описание события содержит слово "Диасофт", 
      //иначе используем их для учета зачета переплаты по СИ, сделанной в предыдущем расчете НДФЛ за этот же налоговый период

      q = q + " and instr(UPPER(t_Description), UPPER('Диасофт')) = 0 ";

      if(vIIS)
        q = q + " and t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS;
      else
        if(РАБОТА_В_РЕЖИМЕ_СНОБ() == true)
          q = q + " and t_TaxBaseKind IN (" + NPTXTOTALBASE_TAXBASEKIND_ONB + ","+NPTXTOTALBASE_TAXBASEKIND_BROK+")";
        else
          q = q + " and t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_BROK;
        end;
      end;
    else //Окончание года
      q = q + " and t_TaxBaseKind IN (0, " + NPTXTOTALBASE_TAXBASEKIND_ONB + ","+NPTXTOTALBASE_TAXBASEKIND_BROK+", " + NPTXTOTALBASE_TAXBASEKIND_IIS + ")";

    end;
    
    DataSet = select.Execute(q);
    if(DataSet.moveNext())
      CalcParams.НОБ_осн           = DataSet.SumTaxBaseCurrPay_Main;
      CalcParams.НОБ_повыш         = DataSet.SumTaxBaseCurrPay_15;
      CalcParams.Налог_осн         = DataSet.SumHoldPITax_Main;
      CalcParams.Налог_повыш       = DataSet.SumHoldPITax_15;
      CalcParams.КоррНалог0207     = DataSet.SumCorrTax0207;
      CalcParams.КоррНалог0201     = DataSet.SumCorrTax0201;
      CalcParams.КоррНалог0208     = DataSet.SumCorrTax0208;

      CalcParams.НОБ_осн_ИИС       = DataSet.SumTaxBaseCurrPay_Main_IIS;
      CalcParams.НОБ_повыш_ИИС     = DataSet.SumTaxBaseCurrPay_15_IIS;
      CalcParams.Налог_осн_ИИС     = DataSet.SumHoldPITax_Main_IIS;
      CalcParams.Налог_повыш_ИИС   = DataSet.SumHoldPITax_15_IIS;
      CalcParams.КоррНалог0207_ИИС = DataSet.SumCorrTax0207_IIS;
      CalcParams.КоррНалог0201_ИИС = DataSet.SumCorrTax0201_IIS;
      CalcParams.КоррНалог0208_ИИС = DataSet.SumCorrTax0208_IIS;

      CalcParams.НОБ_ДЕПО_КБК0201  = DataSet.SumTaxBaseNegDEPO_201;
      CalcParams.НОБ_ДЕПО_КБК0207  = DataSet.SumTaxBaseNegDEPO_207;
      CalcParams.НОБ_ДЕПО_КБК0208  = DataSet.SumTaxBaseNegDEPO_208;
    end;


    if(pSubKindOperation == DL_TXHOLD_OPTYPE_ENDYEAR) // окончание года
      q =   "select NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_MAIN+"' AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NOBAmount ELSE 0 END)), 0) as SumNOB0201, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_PROC+"' AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NOBAmount ELSE 0 END)), 0) as SumNOB0207, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_15+"' AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NOBAmount ELSE 0 END)), 0) as SumNOB0208, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_MAIN+"' AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NdflKeepAmount ELSE 0 END)), 0) as SumTax0201, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_PROC+"' AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NdflKeepAmount ELSE 0 END)), 0) as SumTax0207, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_15+"' AND t_TaxBaseKind <> " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NdflKeepAmount ELSE 0 END)), 0) as SumTax0208, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_MAIN+"' AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NOBAmount ELSE 0 END)), 0) as SumNOB0201_IIS, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_PROC+"' AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NOBAmount ELSE 0 END)), 0) as SumNOB0207_IIS, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_15+"' AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NOBAmount ELSE 0 END)), 0) as SumNOB0208_IIS, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_MAIN+"' AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NdflKeepAmount ELSE 0 END)), 0) as SumTax0201_IIS, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate != "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_PROC+"' AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NdflKeepAmount ELSE 0 END)), 0) as SumTax0207_IIS, "
          + "       NVL(SUM((CASE WHEN t_NdflKeepRate = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" AND t_KBKKeep = '"+NPTXKBK_15+"' AND t_TaxBaseKind = " + NPTXTOTALBASE_TAXBASEKIND_IIS + " THEN t_NdflKeepAmount ELSE 0 END)), 0) as SumTax0208_IIS "
          + "  from dnptxtbext_dbt "
          + " where t_ClientID = ? "
          + "   and (t_TaxPeriod = ? or (t_IncDate BETWEEN ? and ? )) "
          + "   and t_TaxBaseKind IN (0, " + NPTXTOTALBASE_TAXBASEKIND_ONB + ","+NPTXTOTALBASE_TAXBASEKIND_BROK+", " + NPTXTOTALBASE_TAXBASEKIND_IIS + ")";

      select = DL_RSDCommand();

      select.AddParam(pClient);
      select.AddParam(Year);
      select.AddParam(vBegDate);
      select.AddParam(pEndDate);

      DataSet = select.Execute(q);
      if(DataSet.moveNext()) 
        CalcParams.НОБ_ДЕПО_КБК0201       = CalcParams.НОБ_ДЕПО_КБК0201 + DataSet.SumNOB0201;
        CalcParams.НОБ_ДЕПО_КБК0207       = CalcParams.НОБ_ДЕПО_КБК0207 + DataSet.SumNOB0207;
        CalcParams.НОБ_ДЕПО_КБК0208       = CalcParams.НОБ_ДЕПО_КБК0208 + DataSet.SumNOB0208;
        CalcParams.Налог_ДЕПО_КБК0201     = DataSet.SumTax0201;
        CalcParams.Налог_ДЕПО_КБК0207     = DataSet.SumTax0207;
        CalcParams.Налог_ДЕПО_КБК0208     = DataSet.SumTax0208;

        CalcParams.НОБ_ДЕПО_КБК0201_ИИС   = DataSet.SumNOB0201_IIS;
        CalcParams.НОБ_ДЕПО_КБК0207_ИИС   = DataSet.SumNOB0207_IIS;
        CalcParams.НОБ_ДЕПО_КБК0208_ИИС   = DataSet.SumNOB0208_IIS;
        CalcParams.Налог_ДЕПО_КБК0201_ИИС = DataSet.SumTax0201_IIS;
        CalcParams.Налог_ДЕПО_КБК0207_ИИС = DataSet.SumTax0207_IIS;
        CalcParams.Налог_ДЕПО_КБК0208_ИИС = DataSet.SumTax0208_IIS;
      end;
    end;

    if(pSubKindOperation == DL_TXHOLD_OPTYPE_ENDYEAR) // окончание года
      CalcParams.Bg_SOFR_IIS = CalcParams.НОБ_осн_ИИС;
      CalcParams.Bp_SOFR_IIS = CalcParams.НОБ_повыш_ИИС;
      CalcParams.Bg_SOFR     = CalcParams.НОБ_осн;
      CalcParams.Bp_SOFR     = CalcParams.НОБ_повыш;

      CalcParams.Bg_DEPO_IIS = CalcParams.НОБ_ДЕПО_КБК0201_ИИС + CalcParams.НОБ_ДЕПО_КБК0207_ИИС;
      CalcParams.Bp_DEPO_IIS = CalcParams.НОБ_ДЕПО_КБК0208_ИИС;
      CalcParams.Bg_DEPO     = CalcParams.НОБ_ДЕПО_КБК0201 + CalcParams.НОБ_ДЕПО_КБК0207;
      CalcParams.Bp_DEPO     = CalcParams.НОБ_ДЕПО_КБК0208;

    else
      if(vIIS)
        CalcParams.Bg_SOFR_IIS = CalcParams.НОБ_осн_ИИС;
        CalcParams.Bp_SOFR_IIS = CalcParams.НОБ_повыш_ИИС;
      else
        CalcParams.Bg_SOFR     = CalcParams.НОБ_осн;
        CalcParams.Bp_SOFR     = CalcParams.НОБ_повыш;
      end;
    end;

    CalcParams.Dg_0201_IIS = round((CalcParams.Bg_SOFR_IIS + CalcParams.Bg_DEPO_IIS)* Rg, $0) - CalcParams.Налог_осн_ИИС - CalcParams.Налог_ДЕПО_КБК0201_ИИС - round(CalcParams.НОБ_ДЕПО_КБК0207_ИИС* Rg, $0) - CalcParams.КоррНалог0201_ИИС; 
    CalcParams.Dg_0207_IIS = round(CalcParams.НОБ_ДЕПО_КБК0207_ИИС*Rg, $0) - CalcParams.Налог_ДЕПО_КБК0207_ИИС - CalcParams.КоррНалог0207_ИИС;
    CalcParams.Dp_0208_IIS = round((CalcParams.Bp_SOFR_IIS + CalcParams.Bp_DEPO_IIS)* Rp, $0) - CalcParams.Налог_повыш_ИИС - CalcParams.Налог_ДЕПО_КБК0208_ИИС - CalcParams.КоррНалог0208_ИИС; 

    CalcParams.Dg_IIS = CalcParams.Dg_0201_IIS + CalcParams.Dg_0207_IIS;
    CalcParams.Dp_IIS = CalcParams.Dp_0208_IIS;

    CalcParams.DEPO_Dg_0201_IIS = round(CalcParams.НОБ_ДЕПО_КБК0201_ИИС * Rg, $0) - CalcParams.Налог_ДЕПО_КБК0201_ИИС - CalcParams.КоррНалог0201_ИИС;
    CalcParams.SOFR_Dg_0201_IIS = CalcParams.Dg_0201_IIS - CalcParams.DEPO_Dg_0201_IIS;
    CalcParams.DEPO_Dg_0207_IIS = CalcParams.Dg_0207_IIS;
    CalcParams.SOFR_Dg_0207_IIS = $0;
    CalcParams.DEPO_Dp_0208_IIS = round(CalcParams.НОБ_ДЕПО_КБК0208_ИИС * Rp, $0) - CalcParams.Налог_ДЕПО_КБК0208_ИИС - CalcParams.КоррНалог0208_ИИС;
    CalcParams.SOFR_Dp_0208_IIS = CalcParams.Dp_0208_IIS - CalcParams.DEPO_Dp_0208_IIS;


    CalcParams.Dg_0201 = round((CalcParams.НОБ_осн + CalcParams.НОБ_ДЕПО_КБК0201)* Rg, $0) - CalcParams.Налог_осн - CalcParams.Налог_ДЕПО_КБК0201 - CalcParams.КоррНалог0201; 
    CalcParams.Dg_0207 = round(CalcParams.НОБ_ДЕПО_КБК0207* Rg, $0) - CalcParams.Налог_ДЕПО_КБК0207 - CalcParams.КоррНалог0207;
    CalcParams.Dp_0208 = round((CalcParams.Bp_SOFR + CalcParams.Bp_DEPO)* Rp, $0) - CalcParams.Налог_повыш - CalcParams.Налог_ДЕПО_КБК0208 - CalcParams.КоррНалог0208;
        
    CalcParams.Dg = CalcParams.Dg_0201 + CalcParams.Dg_0207;
    CalcParams.Dp = CalcParams.Dp_0208;

    CalcParams.DEPO_Dg_0201 = round(CalcParams.НОБ_ДЕПО_КБК0201 * Rg, $0) - CalcParams.Налог_ДЕПО_КБК0201 - CalcParams.КоррНалог0201;
    CalcParams.SOFR_Dg_0201 = CalcParams.Dg_0201 - CalcParams.DEPO_Dg_0201;
    CalcParams.DEPO_Dg_0207 = CalcParams.Dg_0207; 
    CalcParams.SOFR_Dg_0207 = $0;
    CalcParams.DEPO_Dp_0208 = round(CalcParams.НОБ_ДЕПО_КБК0208 * Rp, $0) - CalcParams.Налог_ДЕПО_КБК0208 - CalcParams.КоррНалог0208;
    CalcParams.SOFR_Dp_0208 = CalcParams.Dp_0208 - CalcParams.DEPO_Dp_0208;

    Dg = CalcParams.Dg;
    Dp = CalcParams.Dp;

    if(vIIS)
      Dg = CalcParams.Dg_IIS;
      Dp = CalcParams.Dp_IIS;
    end;

    Po = Dg + Dp + Ds;

  else //До 2023
    if((Year >= 2021) and (ClientResident == true))
      if(pSubKindOperation == DL_TXHOLD_OPTYPE_DIVIDEND)
        Bg = Bm = Bs = $0;
        Bd = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_DIV), vBegDate, pEndDate, null, null);
        Bp = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_DIV_15), vBegDate, pEndDate, null, null);

        Pg = Pm = Ps = $0;
        Pd = GetRubSumByClient(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate, null, null, null, AddWhereNotOut);
        Pp = GetRubSumByClient(pClient, string(TXOBJ_PAIDGENERAL_15_1) + ", " + string(TXOBJ_PAIDGENERAL_15_1_0), vBegDate, pEndDate, null, null, null, AddWhereNotOut);
      else
        if( vIIS == 0 )
           Bg1 = GetRubSumByClient(pClient, string(TXOBJ_BASEG1), vBegDate, pEndDate, null, vIIS, null, AddWhereNotOut);
           Bg2 = GetRubSumByClient(pClient, string(TXOBJ_BASEG2), vBegDate, pEndDate, null, vIIS);
           Bg3 = GetRubSumByClient(pClient, string(TXOBJ_BASEG3), vBegDate, pEndDate, null, vIIS);
           Bg4 = GetRubSumByClient(pClient, string(TXOBJ_BASEG4), vBegDate, pEndDate, null, vIIS);
           Bg6 = GetRubSumByClient(pClient, string(TXOBJ_BASEG6), vBegDate, pEndDate, null, vIIS);
           Bg7 = GetRubSumByClient(pClient, string(TXOBJ_BASEG7), vBegDate, pEndDate, null, vIIS);
           Bg8 = GetRubSumByClient(pClient, string(TXOBJ_BASEG8), vBegDate, pEndDate, null, vIIS);
           Bg9 = GetRubSumByClient(pClient, string(TXOBJ_BASEG9), vBegDate, pEndDate, null, vIIS);
           
           Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL), vBegDate, pEndDate, null, vIIS);
           Bd = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_DIV), vBegDate, pEndDate, null, vIIS);

           Pg = GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL, vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) + //Пользовательские любые
                GetRubSumByClientOperDocKind(pClient, TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS, AddWhereNotOut) + //Пользовательские НЕ внешние
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, date(1, 1, Year), NULL /*pEndDate*/, DL_HOLDNDFL, NULL, vIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, date(1, 1, Year), pEndDate, DL_WRTMONEY, NULL, vIIS) + //созданные в операциях списания денежных средств с T_PREVDATE такой же, как и текушей операции
                GetRubSumByClientFromDepo(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, vBegDate, pEndDate)+ //созданные в операции "Расчет и начисление дохода" в депозитарии
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, vBegDate, pEndDate, DL_RETIREMENT_OWN,null, vIIS) + //созданные в операциях погашения ОЭБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL, vBegDate, pEndDate, DL_NPTXSTBOP, null, vIIS) + //созданные в операциях корректировки события СНОБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDBILL, vBegDate, pEndDate, DL_NPTXNETTOP, null, vIIS) + //созданные в операциях зачета СНОБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDCOMP, vBegDate, pEndDate, DL_NPTXCRNSET, null, vIIS) + //созданные в операциях компенсации
                /*плюс операции в ПС <Векселя банка>*/
                GetRubSumByClientFromVeksel(pClient, TXOBJ_PAIDGENERAL+", "+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL+","+TXOBJ_PAIDBILL+","+TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, vBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                                                                                                           string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                                                                                                           string(DL_VSINTERCHANGE) );      //зачет взаимных требований

          
           Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, 0 /*только пользовательские*/,null, vIIS) +
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), NULL, NULL, DL_HOLDNDFL, NULL, vIIS) + //созданные в операциях удержания НДФЛ
                GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDSPECIAL), vBegDate, pEndDate) + //созданные в операции "Расчет и начисление дохода" в депозитарии
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, DL_RETIREMENT_OWN,null, vIIS) + //созданные в операциях погашения ОЭБ
                /*плюс операции в ПС <Векселя банка>*/
                GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0), vBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                                         string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                                         string(DL_VSINTERCHANGE) );      //зачет взаимных требований

      
           Pp = GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, vBegDate, pEndDate, DL_CALCNDFL,null, vIIS, AddWhereNotOut) + //созданные в операциях расчета НОБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS, AddWhereNotOut) +
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, date(1, 1, Year), NULL /*pEndDate*/, DL_HOLDNDFL, NULL, vIIS, AddWhereNotOut) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, date(1, 1, Year), pEndDate, DL_WRTMONEY, NULL, vIIS, AddWhereNotOut) + //созданные в операциях списания денежных средств с T_PREVDATE такой же, как и текушей операции
                GetRubSumByClientFromDepo(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0, vBegDate, pEndDate) +//созданные в операции "Расчет и начисление дохода" в депозитарии
                GetRubSumByClient(pClient, string(TXOBJ_PAIDGENERAL_15), vBegDate, pEndDate, null, vIIS, null, AddWhereFromOut) + 
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, vBegDate, pEndDate, DL_RETIREMENT_OWN,null, vIIS) + //созданные в операциях погашения ОЭБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15, vBegDate, pEndDate, DL_NPTXSTBOP, null, vIIS) + //созданные в операциях корректировки события СНОБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDGENERAL_15, vBegDate, pEndDate, DL_NPTXNETTOP, null, vIIS) + //созданные в операциях зачета СНОБ
                GetRubSumByClientOperDocKind(pClient, TXOBJ_PAIDCOMP_15, vBegDate, pEndDate, DL_NPTXCRNSET,null, vIIS) + //созданные в операциях компенсации
                /*плюс операции в ПС <Векселя банка>*/
                GetRubSumByClientFromVeksel(pClient, TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0+","+TXOBJ_PAIDGENERAL_15_2, vBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                                                         string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                                                         string(DL_VSINTERCHANGE) );      //зачет взаимных требований

        else
           Bg5 = GetRubSumByClient(pClient, string(TXOBJ_BASEG5), vBegDate, pEndDate, null, vIIS);
           Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_IIS), vBegDate, pEndDate, null, vIIS);
           Bd = $0;

           Pg = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) +
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, NULL/*pEndDate*/, DL_HOLDNDFL, null, vIIS) + //созданные в операциях удержания НДФЛ
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, DL_WRTMONEY, null, vIIS) + //созданные в операциях списания денежных средств
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, DL_RETIREMENT_OWN,null, vIIS) + //созданные в операциях погашения ОЭБ
                /*плюс операции в ПС <Векселя банка>*/
                GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                        string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                        string(DL_VSINTERCHANGE) );      //зачет взаимных требований

          
           Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), vBegDate, pEndDate, 0 /*только пользовательские*/,null, vIIS) +
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), NULL, NULL, DL_HOLDNDFL, NULL, vIIS) + //созданные в операциях удержания НДФЛ
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), vBegDate, pEndDate, DL_RETIREMENT_OWN,null, vIIS) + //созданные в операциях погашения ОЭБ
                /*плюс операции в ПС <Векселя банка>*/
                GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDSPECIAL_IIS), vBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                        string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                        string(DL_VSINTERCHANGE) );      //зачет взаимных требований


           Pp = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) +
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), vBegDate, NULL /*pEndDate*/, DL_HOLDNDFL, null, vIIS) + //созданные в операциях удержания НДФЛ
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), vBegDate, pEndDate, DL_WRTMONEY, null, vIIS) + //созданные в операциях списания денежных средств
                GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), vBegDate, pEndDate, DL_RETIREMENT_OWN,null, vIIS) + //созданные в операциях погашения ОЭБ
                /*плюс операции в ПС <Векселя банка>*/
                GetRubSumByClientFromVeksel(pClient, string(TXOBJ_PAIDGENERAL_15_IIS), vBegDate, pEndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                           string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                           string(DL_VSINTERCHANGE) );      //зачет взаимных требований
                 
        end;

        Bg =   Min(Bg1, NPTX_LIMINCOME_MAX15)
             + Min(Bg2, NPTX_LIMINCOME_MAX15)
             + Min(Bg3, NPTX_LIMINCOME_MAX15)
             + Min(Bg4, NPTX_LIMINCOME_MAX15)
             + Min(Bg5, NPTX_LIMINCOME_MAX15)
             + Min(Bg6, NPTX_LIMINCOME_MAX15)
             + Min(Bg7, NPTX_LIMINCOME_MAX15)
             + Min(Bg8, NPTX_LIMINCOME_MAX15)
             + Min(Bg9, NPTX_LIMINCOME_MAX15);

        Bp =   Max(Bg1-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg2-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg3-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg4-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg5-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg6-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg7-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg8-NPTX_LIMINCOME_MAX15, $0)
             + Max(Bg9-NPTX_LIMINCOME_MAX15, $0);
      end;
    elif((ClientResident == false) and (pSubKindOperation == DL_TXHOLD_OPTYPE_DIVIDEND))
      Bd = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_DIV), vBegDate, pEndDate, null, null);
      Pd = GetRubSumByClient(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate, null, null, null, AddWhereNotOut);
    else

      if( vIIS == 0 )
         Bg =   GetRubSumByClient(pClient, string(TXOBJ_BASEGENERAL), vBegDate, pEndDate, null, vIIS, null, AddWhereNotOut)
              + GetRubSumByClient(pClient, string(TXOBJ_BASEG2), vBegDate, pEndDate, null, vIIS, null, AddWhereFromOut);
         Bm = GetRubSumByClient(pClient, string(TXOBJ_BASEMATERIAL), vBegDate, pEndDate, null, vIIS);
         Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL), vBegDate, pEndDate, null, vIIS);
         Bd = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_DIV), vBegDate, pEndDate, null, vIIS);
      else
         Bg = GetRubSumByClient(pClient, string(TXOBJ_BASEGENERAL_IIS), vBegDate, pEndDate, null, vIIS);
         Bm = GetRubSumByClient(pClient, string(TXOBJ_BASEMATERIAL_IIS), vBegDate, pEndDate, null, vIIS);
         Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_IIS), vBegDate, pEndDate, null, vIIS);
         Bd = $0;
      end;


      if( vIIS == 0 )
         Pg = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL) + ", " + string(TXOBJ_PAIDGENERAL_0), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL) + ", " + string(TXOBJ_PAIDGENERAL_0), vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) +
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL) + ", " + string(TXOBJ_PAIDGENERAL_0), date(1, 1, Year), NULL /*pEndDate*/, DL_HOLDNDFL, NULL, vIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL), date(1, 1, Year), pEndDate, DL_WRTMONEY, NULL, vIIS) + //созданные в операциях списания денежных средств с T_PREVDATE такой же, как и текушей операции
              GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDGENERAL), vBegDate, pEndDate); //созданные в операции "Расчет и начисление дохода" в депозитарии
        
         Pm = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL), vBegDate, pEndDate, DL_CALCNDFL, null, vIIS) + //созданные в операциях расчета НОБ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL), vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) +
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL), NULL, NULL, DL_HOLDNDFL, NULL, vIIS) + //созданные в операциях удержания НДФЛ
              GetRubSumByClientFromDepo(pClient, string(TXOBJ_PAIDMATERIAL), vBegDate, pEndDate); //созданные в операции "Расчет и начисление дохода" в депозитарии
        
         Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS, AddWhereNotOut) + //созданные в операциях расчета НОБ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate, 0 /*только пользовательские*/,null, vIIS, AddWhereNotOut) +
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), NULL, NULL, DL_HOLDNDFL, NULL, vIIS, AddWhereNotOut) + //созданные в операциях удержания НДФЛ
              GetRubSumByClientFromDepo(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate); //созданные в операции "Расчет и начисление дохода" в депозитарии

         Pd = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) +
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), date(1, 1, Year), NULL /*pEndDate*/, DL_HOLDNDFL, NULL, vIIS) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
              GetRubSumByClientOperDocKind(pClient,string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), date(1, 1, Year), pEndDate, DL_WRTMONEY, NULL, vIIS) + //созданные в операциях списания денежных средств с T_PREVDATE такой же, как и текушей операции
              GetRubSumByClientFromDepo(pClient, string(TXOBJ_DIVPAY_SEC) + ", " + string(TXOBJ_DIVPAY_SEC_0), vBegDate, pEndDate); //созданные в операции "Расчет и начисление дохода" в депозитарии

      else
         Pg = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) +
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, NULL /*pEndDate*/, DL_HOLDNDFL, null, vIIS) + //созданные в операциях удержания НДФЛ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDGENERAL_IIS), vBegDate, pEndDate, DL_WRTMONEY, null, vIIS); //созданные в операциях списания денежных средств
        
         Pm = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL_IIS), vBegDate, pEndDate, DL_CALCNDFL, null, vIIS) + //созданные в операциях расчета НОБ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL_IIS), vBegDate, pEndDate, 0 /*только пользовательские*/, null, vIIS) +
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDMATERIAL_IIS), NULL, NULL, DL_HOLDNDFL, NULL, vIIS); //созданные в операциях удержания НДФЛ
        
         Ps = GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), vBegDate, pEndDate, DL_CALCNDFL,null, vIIS) + //созданные в операциях расчета НОБ
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), vBegDate, pEndDate, 0 /*только пользовательские*/,null, vIIS) +
              GetRubSumByClientOperDocKind(pClient, string(TXOBJ_PAIDSPECIAL_IIS), NULL, NULL, DL_HOLDNDFL, NULL, vIIS); //созданные в операциях удержания НДФЛ
      end;

    end;

    Po = Rg * Bg + Rs * Bs + Rp * Bp - Pg - Ps - Pp;

    if(pSubKindOperation == DL_TXHOLD_OPTYPE_LUCRE) //материальная выгода
      Dg = 0;
      Dm = Bm*Rg-Pm;
      Ds = 0;
      Dp = 0;
    elif( (pSubKindOperation == DL_TXHOLD_OPTYPE_OUTMONEY) or (pSubKindOperation == DL_TXHOLD_OPTYPE_OUTAVOIR) ) //вывод д/с или вывод ц/б

      Dm = $0.0;

      if (Po > pTO)
          Dg = min (pTO * Rg, Bg * Rg - Pg);
          Ds = Rs * min (pTO - min (pTO, Bg-Pg/Rg), Bs-Ps/Rs);
        Dp = 0;
        if(Rp != 0)
          Dp = Rp * min (pTO - Dg/Rg - Ds/Rs, Bp-Pp/Rp);
        end;
      else
        Dg = Rg*Bg - Pg;
        Ds = Rs*Bs - Ps;
        Dp = Bp*Rp - Pp;
      end; 

    elif(pSubKindOperation == DL_TXHOLD_OPTYPE_ENDYEAR) //окончание года
      Dg = Rg*Bg - Pg;
      Dm = Bm*Rg - Pm;
      Ds = Rs*Bs - Ps;
      Dp = Bp*Rp - Pp;
    elif(pSubKindOperation == DL_TXHOLD_OPTYPE_CLOSE) //закрытие договора
      Dg = Rg*Bg - Pg;
      Ds = Rs*Bs - Ps;
      Dm = Bm*Rg - Pm;
      Dp = Bp*Rp - Pp;
    elif(pSubKindOperation == DL_TXHOLD_OPTYPE_TAXREF) //возврат налога
      Dg = Rg*Bg - Pg;
      Dm = Bm*Rg - Pm;
      Ds = Rs*Bs - Ps;
      Dp = Bp*Rp - Pp;
    end;
  end;

  Dg = round(Dg,0);
  Dm = round(Dm,0);         
  Ds = round(Ds,0);
  Dp = round(Dp,0);
  p_Po = round(Po,0);

END;

PRIVATE MACRO LoadDataToTMP(Client:integer, BegDate:date, EndDate:date)
  var query, cmd;

  cmd = RsdCommand( "{ CALL RSI_NPTXCALC.LoadNptxData(?, ?, ?) }" );

  cmd.addParam( "", RSDBP_IN, Client );
  cmd.addParam( "", RSDBP_IN, BegDate );
  cmd.addParam( "", RSDBP_IN, EndDate );

  SQL_Execute( cmd, "Подготовка данных", true );
END;

/**
@brief Получение суммы объектов НДР с признаком "Технический", которые были созданы ранее даты текущей операции
@param [in] pDocID ID текущей операции
@param [in] pOperDate Дата текущей операции
@param [in] pClientID ID клиента
@param [in] pKind Вид объектов НДР
@param [in] pAnaliticKind1 Вид аналитики 1
@param [in] pAnalitic1 Значение аналитики 1
@param [in] pAnaliticKind2 Вид аналитики 2
@param [in] pAnalitic2 Значение аналитики 2
@param [in] pAnaliticKind3 Вид аналитики 3
@param [in] pAnalitic3 Значение аналитики 3
@param [in] pAnaliticKind4 Вид аналитики 4
@param [in] pAnalitic4 Значение аналитики 4
@param [in] pAnaliticKind5 Вид аналитики 5
@param [in] pAnalitic5 Значение аналитики 5
@param [in] pAnaliticKind1 Вид аналитики 6
@param [in] pAnalitic1 Значение аналитики 6
@param [in] pRecalc Значение признака "Пересчет" из панели текущей операции
@return NUMBER
*/
PRIVATE MACRO GetSumNPTXOBJTech(pDocID:INTEGER,
                                pStep:INTEGER,
                                pOperDate:DATE,
                                pClientID:INTEGER,
                                pKind:INTEGER,
                                pAnaliticKind1:INTEGER,
                                pAnalitic1:INTEGER,
                                pAnaliticKind2:INTEGER,
                                pAnalitic2:INTEGER,
                                pAnaliticKind3:INTEGER,
                                pAnalitic3:INTEGER,
                                pAnaliticKind4:INTEGER,
                                pAnalitic4:INTEGER,
                                pAnaliticKind5:INTEGER,
                                pAnalitic5:INTEGER,
                                pAnaliticKind6:INTEGER,
                                pAnalitic6:INTEGER,
                                pRecalc:String,
                                pTransfKind:INTEGER,
                                pOutSystCode:String
                               )
   if(pOutSystCode == NULL)
     pOutSystCode = "";
   end;

   if(pTransfKind == NULL)
     pTransfKind = 0;
   end;

   if(pAnalitic6 <= 0)
     pAnaliticKind6 = 0;
   end;
    
   if(pExistEarlyTechCalc == 1)
      var query = "select RSI_NPTXCALC.GetSumNPTXOBJTech(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) as t_Sum " +
                  "from dual ";

      var cmd = DL_RSDCommand(query);
      cmd.AddParam(pDocID);
      cmd.AddParam(pOperDate);
      cmd.AddParam(pClientID);
      cmd.AddParam(pKind);
      cmd.AddParam(pAnaliticKind1);
      cmd.AddParam(pAnalitic1);
      cmd.AddParam(pAnaliticKind2);
      cmd.AddParam(pAnalitic2);
      cmd.AddParam(pAnaliticKind3);
      cmd.AddParam(pAnalitic3);
      cmd.AddParam(pAnaliticKind4);
      cmd.AddParam(pAnalitic4);
      cmd.AddParam(pAnaliticKind5);
      cmd.AddParam(pAnalitic5);
      cmd.AddParam(pAnaliticKind6);
      cmd.AddParam(pAnalitic6);
      cmd.AddParam(pExistEarlyTechCalc);
      cmd.AddParam(pRecalc);
      cmd.AddParam(pOutSystCode);
      cmd.AddParam(pTransfKind);

      var DataSet = cmd.Execute();
      if(DataSet.MoveNext())
         var cmdDelete = RSDCommand("CALL RSI_NPTXCALC.DeleteNPTXOBJTech(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
         cmdDelete.addParam("", RSDBP_IN,  pDocID);
         cmdDelete.addParam("", RSDBP_IN,  pStep);
         cmdDelete.addParam("", RSDBP_IN,  pOperDate);
         cmdDelete.addParam("", RSDBP_IN,  pClientID);
         cmdDelete.addParam("", RSDBP_IN,  pKind);
         cmdDelete.AddParam("", RSDBP_IN,  pAnaliticKind1);
         cmdDelete.AddParam("", RSDBP_IN,  pAnalitic1);
         cmdDelete.AddParam("", RSDBP_IN,  pAnaliticKind2);
         cmdDelete.AddParam("", RSDBP_IN,  pAnalitic2);
         cmdDelete.AddParam("", RSDBP_IN,  pAnaliticKind3);
         cmdDelete.AddParam("", RSDBP_IN,  pAnalitic3);
         cmdDelete.AddParam("", RSDBP_IN,  pAnaliticKind4);
         cmdDelete.AddParam("", RSDBP_IN,  pAnalitic4);
         cmdDelete.AddParam("", RSDBP_IN,  pAnaliticKind5);
         cmdDelete.AddParam("", RSDBP_IN,  pAnalitic5);
         cmdDelete.AddParam("", RSDBP_IN,  pAnaliticKind6);
         cmdDelete.AddParam("", RSDBP_IN,  pAnalitic6);
         cmdDelete.addParam("", RSDBP_IN,  pExistEarlyTechCalc);
         cmdDelete.addParam("", RSDBP_IN,  pRecalc);
         cmdDelete.addParam("", RSDBP_IN,  pOutSystCode);
         cmdDelete.addParam("", RSDBP_IN,  pTransfKind);

         SQL_Execute(cmdDelete);
      
         return DataSet.Sum;
      end;
   end;

   return 0;
END;

//////////////////////////////////////////////////////////////////
//НДР 1 
//////////////////////////////////////////////////////////////////

MACRO CreateTaxObjects1( Oper:TRecHandler/*NPTXOP*/, pStep )
  var stat = 0;

  PRIVATE MACRO CalcLevel1(Step:integer, IndStr:string)
    var cmd;
    
    if(stat == 0)
      cmd = RsdCommand( "{ CALL RSI_NPTXCALC.CreateTaxObjects1_"+Step+"(?, ?, ?, ?, ?, ?, ?, ?, ?) }" );

      cmd.addParam("", RSDBP_IN,  pBegDate);
      cmd.addParam("", RSDBP_IN,  pEndDate);
      cmd.addParam("", RSDBP_IN,  pClient );
      cmd.addParam("", RSDBP_IN,  pIIS    );
      cmd.addParam("", RSDBP_IN,  pDocID  );
      cmd.addParam("", RSDBP_IN,  pStep   );
      cmd.addParam("", RSDBP_IN,  pFIID   );
      cmd.addParam("", RSDBP_IN,  pContract );
      cmd.addParam("", RSDBP_OUT, stat    );

      SQL_Execute(cmd, "1."+Step+" "+IndStr, true);
    end;

    UseProgress(Step);
  END;

  ОпределитьПараметрыРасчета(Oper);
  GetBegDate(Oper, false);

  LoadDataToTMP(pClient, pBegDate, pEndDate);

  if(Oper.rec.Contract > 0)
    pContract = Oper.rec.Contract;
  end;

  InitProgress( 21, "Выполняется расчет объектов НДР 1 уровня", "Расчет объектов НДР 1 уровня" );

  CalcLevel1(1, "Расчет объектов НДР по оплате основной суммы сделки и НКД");
  
  CalcLevel1(2, "Расчет объектов НДР по авансу/задатку");

  CalcLevel1(3, "Расчет объектов НДР по комиссиям");

  CalcLevel1(4, "Расчет объектов НДР по периодическим комиссиям");

  CalcLevel1(5, "Расчет объектов НДР по депозитарным комиссиям");

  CalcLevel1(6, "Расчет объектов НДР по покупкам при пересчете по рыночной цене");

  CalcLevel1(7, "Расчет объектов НДР по продажам при пересчете по рыночной цене");

  CalcLevel1(8, "Расчет объектов НДР по платежам по процентам в Репо");

  CalcLevel1(9, "Расчет объектов НДР по платежам по купону в Репо");

  CalcLevel1(10, "Расчет объектов НДР по платежам по ЧП в Репо");

  CalcLevel1(11, "Расчет объектов НДР по компенсационным платежам в Репо");

  CalcLevel1(12, "Расчет объектов НДР по основной сумме погашений");

  CalcLevel1(13, "Расчет объектов НДР по сумме НКД в погашениях");

  CalcLevel1(14, "Расчет объектов НДР по комиссиям погашений");

  CalcLevel1(15, "Расчет объектов НДР по зачислению");

  CalcLevel1(16, "Расчет объектов НДР по виртуальным сделкам");

  CalcLevel1(17, "Расчет объектов НДР по зачислениям в конвертациях");

  CalcLevel1(18, "Расчет объектов НДР по списаниям в конвертациях");

  CalcLevel1(19, "Расчет объектов НДР по операциям ГО и ИН");

  CalcLevel1(20, "Расчет объектов НДР по операциям ГО и ИН 2");

  CalcLevel1(21, "Расчет объектов НДР по ПИ");

  CalcLevel1(22, "Расчет объектов НДР по внебиржевым сделкам ПИ");

  RemProgress();

  return stat;

OnError(er)
  var err_text = "", delim = "";
  var j = 0;

  RemProgress();

  if(er and (er.err != NULL) and er.err.environment)
    while(j < er.err.environment.ErrorCount)
      err_text = err_text + delim + er.err.environment.error(j).descr;
      delim = "\n";
      j = j + 1;
    end;
    MsgBox(err_text);
  else
    MsgBox(er.Message);
  end;

  return 1;
END;

MACRO CreateMaterialTaxObjects1(Oper:TRecHandler/*NPTXOP*/, pStep)
  var stat = 0;

  PRIVATE MACRO CalcMaterialLevel1(Step:integer, IndStr:string)
    var cmd;
    
    if(stat == 0)
      cmd = RsdCommand( "{ CALL RSI_NPTXCALC.CreateMaterialTaxObjects1_"+Step+"(?, ?, ?, ?, ?, ?, ?, ?, ?) }" );

      cmd.addParam("", RSDBP_IN,  pBegDate);
      cmd.addParam("", RSDBP_IN,  pEndDate);
      cmd.addParam("", RSDBP_IN,  pClient );
      cmd.addParam("", RSDBP_IN,  pIIS    );
      cmd.addParam("", RSDBP_IN,  pDocID  );
      cmd.addParam("", RSDBP_IN,  pStep   );
      cmd.addParam("", RSDBP_IN,  pFIID   );
      cmd.addParam("", RSDBP_IN,  pContract );
      cmd.addParam("", RSDBP_OUT, stat    );

      SQL_Execute(cmd, "1."+Step+" "+IndStr, true);
    end;

    UseProgress(Step);
  END;

  ОпределитьПараметрыРасчета(Oper);
  GetBegDate(Oper, false);

  if(Oper.rec.Contract > 0)
    pContract = Oper.rec.Contract;
  end;

  LoadDataToTMP(pClient, pBegDate, pEndDate);

  InitProgress(3, "Выполняется расчет объектов НДР 1 уровня по матвыгоде", "Расчет объектов НДР 1 уровня по матвыгоде");

  CalcMaterialLevel1(1, "Расчет объектов НДР по материальной выгоде");

  CalcMaterialLevel1(2, "Расчет объектов НДР по материальной выгоде по зачислению");

  CalcMaterialLevel1(3, "Расчет объектов НДР матвыгоды по внебиржевым сделкам ПИ");

  RemProgress();

  return stat;

OnError(er)
  var err_text = "", delim = "";
  var j = 0;

  RemProgress();

  if(er and (er.err != NULL) and er.err.environment)
    while(j < er.err.environment.ErrorCount)
      err_text = err_text + delim + er.err.environment.error(j).descr;
      delim = "\n";
      j = j + 1;
    end;
    MsgBox(err_text);
  else
    MsgBox(er.Message);
  end;

  return 1;
END;

//////////////////////////////////////////////////////////////////
//НДР 2 
//////////////////////////////////////////////////////////////////

MACRO CreateTaxObjects2(Oper:TRecHandler/*NPTXOP*/, pStep)
  var stat = 0;


  PRIVATE MACRO CalcLevel2(Step:integer, IndStr:string)
    var cmd;
    
    if(stat == 0)
      cmd = RsdCommand( "{ CALL RSI_NPTXCALC.CreateTaxObjects2_"+Step+"(?, ?, ?, ?, ?, ?, ?, ?, ?) }" );

      cmd.addParam("", RSDBP_IN,  pBegDate);
      cmd.addParam("", RSDBP_IN,  pEndDate);
      cmd.addParam("", RSDBP_IN,  pClient );
      cmd.addParam("", RSDBP_IN,  pIIS    );
      cmd.addParam("", RSDBP_IN,  pDocID  );
      cmd.addParam("", RSDBP_IN,  pStep   );
      cmd.addParam("", RSDBP_IN,  pFIID   );
      cmd.addParam("", RSDBP_IN,  pContract );
      cmd.addParam("", RSDBP_OUT, stat    );

      SQL_Execute(cmd, "2."+Step+" "+IndStr, true);
    end;

    UseProgress(Step);
  END;


  ОпределитьПараметрыРасчета(Oper);
  GetBegDate(Oper, false);

  DL_ReCalcPrivAmountByLink(pBegDate,pEndDate,pClient,pIIS,pFIID);/*без отката (каждый раз пересчитываем)*/

  if(Oper.rec.Contract > 0)
    pContract = Oper.rec.Contract;
  end;

  InitProgress( 29, "Выполняется расчет объектов НДР 2 уровня", "Расчет объектов НДР 2 уровня" );

  CalcLevel2(0, "Расчет объектов НДР по данным из депозитария");
  
  CalcLevel2(1, "Расчет объектов НДР по процентам РЕПО");

  CalcLevel2(2, "Расчет объектов НДР по стоимости РЕПО");

  CalcLevel2(3, "Расчет объектов НДР по остаткам");

  CalcLevel2(4, "Расчет объектов НДР по связям");

  CalcLevel2(5, "Расчет объектов НДР по связям");

  CalcLevel2(6, "Расчет объектов НДР по связям");

  CalcLevel2(7, "Расчет объектов НДР по связям");

  CalcLevel2(8, "Расчет объектов НДР по связям");

  CalcLevel2(9, "Расчет объектов НДР по связям");

  CalcLevel2(10, "Расчет объектов НДР по связям");

  CalcLevel2(11, "Расчет объектов НДР по связям");

  CalcLevel2(12, "Расчет объектов НДР по связям");

  CalcLevel2(13, "Расчет объектов НДР по связям");

  CalcLevel2(14, "Расчет объектов НДР по связям");

  CalcLevel2(15, "Расчет объектов НДР по связям");

  CalcLevel2(16, "Расчет объектов НДР по связям");

  CalcLevel2(17, "Расчет объектов НДР по связям");

  CalcLevel2(18, "Расчет объектов НДР по связям");

  CalcLevel2(19, "Расчет объектов НДР по связям");

  CalcLevel2(20, "Расчет объектов НДР по остаткам");

  CalcLevel2(21, "Расчет объектов НДР по остаткам");

  CalcLevel2(22, "Расчет объектов НДР по остаткам");

  CalcLevel2(23, "Расчет объектов НДР по остаткам");

  CalcLevel2(24, "Расчет объектов НДР по остаткам");

  CalcLevel2(25, "Расчет объектов НДР по размещенным ц/б");

  CalcLevel2(26, "Расчет объектов НДР по размещенным ц/б");

  CalcLevel2(27, "Расчет объектов НДР по размещенным ц/б");

  CalcLevel2(28, "Расчет объектов НДР по размещенным ц/б");

  RemProgress();

  return stat;

OnError(er)
  var err_text = "", delim = "";
  var j = 0;

  RemProgress();

  if(er and (er.err != NULL) and er.err.environment)
    while(j < er.err.environment.ErrorCount)
      err_text = err_text + delim + er.err.environment.error(j).descr;
      delim = "\n";
      j = j + 1;
    end;
    MsgBox(err_text);
  else
    MsgBox(er.Message);
  end;

  return 1;
END;

PRIVATE MACRO CorrectTechnicalInObjTMP(DocID, StepID, Level)
  var cmd;
  
  cmd = RsdCommand( "{ CALL RSI_NPTXCALC.CorrectTechnicalInObjTMP(?,?,?) }" );

  cmd.addParam("", RSDBP_IN,  DocID);
  cmd.addParam("", RSDBP_IN,  StepID);
  cmd.addParam("", RSDBP_IN,  Level);

  SQL_Execute(cmd, "Корректировка технических объектов НДР", true);
OnError(er)
  return 1;
END;

//////////////////////////////////////////////////////////////////
//НДР 3 
//////////////////////////////////////////////////////////////////

MACRO CreateTaxObjects3( Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate )
  var stat = 0;
  
  PRIVATE MACRO CalcLevel3(Step:integer, IndStr:string)
    var cmd;
    
    if(stat == 0)
      cmd = RsdCommand( "{ CALL RSI_NPTXCALC.CreateTaxObjects3_"+Step+"(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) }" );

      cmd.addParam("", RSDBP_IN,  pBegDate  );
      cmd.addParam("", RSDBP_IN,  pEndDate  );
      cmd.addParam("", RSDBP_IN,  pClient   );
      cmd.addParam("", RSDBP_IN,  pIIS      );
      cmd.addParam("", RSDBP_IN,  pDocID    );
      cmd.addParam("", RSDBP_IN,  pStep     );
      cmd.addParam("", RSDBP_IN,  pFIID     );
      cmd.addParam("", RSDBP_IN,  pTechnical);
      cmd.addParam("", RSDBP_IN,  Oper.rec.Recalc);
      cmd.addParam("", RSDBP_IN,  pExistEarlyTechCalc);
      cmd.addParam("", RSDBP_IN,  pContract);
      cmd.addParam("", RSDBP_IN,  pTransfDate);
      cmd.addParam("", RSDBP_IN,  pTransfKind);
      cmd.addParam("", RSDBP_IN,  pDateNDR);
      cmd.addParam("", RSDBP_OUT, stat      );

      SQL_Execute(cmd, "3."+Step+" "+IndStr, true);
    end;

    UseProgress(Step);
  END;

  PRIVATE MACRO CalcAllLevel3()
    InitProgress( 8, "Выполняется расчет объектов НДР 3 уровня", "Расчет объектов НДР 3 уровня" );

    CalcLevel3(1, "Расчет объектов НДР по связям КП");

    CalcLevel3(2, "Расчет объектов НДР по связям КП 2");

    CalcLevel3(3, "Расчет объектов НДР по связям ЗКП");

    CalcLevel3(4, "Расчет объектов НДР по связям ЗКП 2");

    CalcLevel3(5, "Расчет объектов НДР по остаткам ц/б");

    CalcLevel3(6, "Расчет объектов НДР по сделкам РЕПО");

    CalcLevel3(7, "Расчет объектов НДР по сделкам РЕПО 2");

    CalcLevel3(8, "Расчет объектов НДР по связям КП");
    
    RemProgress();
  END;

  ОпределитьПараметрыРасчета(Oper);
  GetBegDate(Oper, true);
  if( (vBegDate!=null) AND (vEndDate!=null) )
    pBegDate = vBegDate;
    pEndDate = vEndDate;
  end;

  if(Oper.rec.Contract > 0)
    pContract = Oper.rec.Contract;
  end;

  if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
    var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
    stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);
    
    if(stat)
      MsgBox("Ошибка определения типа ИИС");
      return 1;
    end;
    
    pDateNDR = Oper.rec.OperDate;
    
    if( (TypeIIS == IISTYPEA) or 
        (TypeIIS == IISTYPEC)
      )
      pBegDate = iisDateBegin;
      pEndDate = iisDateEnd;
      CalcAllLevel3();
    elif((TypeIIS == IISTYPEB) or 
         (TypeIIS == IISTYPEG)
        )
      pBegDate = iisOpenDate;
      pEndDate = iisDateEnd;
      CalcAllLevel3();
    elif(TypeIIS == IISTYPED)
      pTransfDate = Dtransf;
      pBegDate = iisDateBegin;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      CalcAllLevel3();

      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      CalcAllLevel3();
    elif(TypeIIS == IISTYPEE)
      pTransfDate = Dtransf;
      pBegDate = iisOpenDate;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      CalcAllLevel3();
      
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      CalcAllLevel3();
    elif(TypeIIS == IISTYPEF)
      pTransfDate = Dtransf;
      pBegDate = iisOpenDate;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      CalcAllLevel3();
      
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      CalcAllLevel3();
    end;
  else
    CalcAllLevel3();
  end;

  if(not stat)
    stat = CorrectTechnicalInObjTMP(pDocID, pStep, 3);
  end;

  return stat;

OnError(er)
  var err_text = "", delim = "";
  var j = 0;

  RemProgress();

  if(er and (er.err != NULL) and er.err.environment)
    while(j < er.err.environment.ErrorCount)
      err_text = err_text + delim + er.err.environment.error(j).descr;
      delim = "\n";
      j = j + 1;
    end;
    MsgBox(err_text);
  else
    MsgBox(er.Message);
  end;

  return 1;
END;

//////////////////////////////////////////////////////////////////
//НДР 4 
//////////////////////////////////////////////////////////////////

MACRO GetNPTXObjSum(BegDate:date, EndDate:date, Client:integer, Kind:integer, IIS:integer, Contract:integer):money
  var query, cmd, DataSet;
  var S = $0;

  if(BegDate == NULL)
    BegDate = date(0,0,0);
  end;

  if(Contract == NULL)
    Contract = 0;
  end;

  query = "select RSI_NPTXCALC.GetNPTXObjSum(?, ?, ?, ?, ?, ?) as S from dual";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(BegDate);
  cmd.AddParam(EndDate);
  cmd.AddParam(Client);
  cmd.AddParam(Kind);
  cmd.AddParam(IIS);
  cmd.AddParam(IIF(Contract > 0, Contract, -1));

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    S = money(DataSet.S);
  end;

  return S;
END;

MACRO CreateTaxObjects4(Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate, vPeriodBegDate)
   var stat = 0;


   PRIVATE MACRO CalcLevel4(Step:integer, IndStr:string)
     var cmd;
     
     if(stat == 0)
       cmd = RsdCommand( "{ CALL RSI_NPTXCALC.CreateTaxObjects4_"+Step+"(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) }" );

       cmd.addParam("", RSDBP_IN,  pBegDate  );
       cmd.addParam("", RSDBP_IN,  pEndDate  );
       cmd.addParam("", RSDBP_IN,  pClient   );
       cmd.addParam("", RSDBP_IN,  pContract );
       cmd.addParam("", RSDBP_IN,  pIIS      );
       cmd.addParam("", RSDBP_IN,  pDocID    );
       cmd.addParam("", RSDBP_IN,  pStep     );
       cmd.addParam("", RSDBP_IN,  pFIID     );
       cmd.addParam("", RSDBP_IN,  pTechnical);
       cmd.addParam("", RSDBP_IN,  Oper.rec.Recalc);
       cmd.addParam("", RSDBP_IN,  pExistEarlyTechCalc);
       cmd.addParam("", RSDBP_IN,  pTransfDate);
       cmd.addParam("", RSDBP_IN,  pTransfKind);
       cmd.addParam("", RSDBP_IN,  pDateNDR);
       cmd.addParam("", RSDBP_OUT, stat      );

       SQL_Execute(cmd, "4."+Step+" "+IndStr, true);
     end;

     UseProgress(Step);
   END;

  PRIVATE MACRO Calc1to21Level4()
    CalcLevel4(1, "Суммарные расходы по облигациям, где погашение не облагается налогом");

    CalcLevel4(2, "Суммарные расходы по обычным облигациям");

    CalcLevel4(3, "Суммарные расходы по облигациям, где погашение облагается в обычном порядке, а проценты - льготные");

    CalcLevel4(4, "Суммарные расходы по акциям");

    CalcLevel4(5, "Суммарные расходы по акциям и обычным облигациям по коротким позициям");

    CalcLevel4(6, "Суммарные расходы по льготным облигациям по коротким позициям");

    CalcLevel4(7, "Суммарные расходы по ПИ");

    CalcLevel4(8, "Суммарные доходы по облигациям, где погашение не облагается налогом");

    CalcLevel4(9, "Суммарные доходы по обычным облигациям");

    CalcLevel4(10, "Суммарные доходы по облигациям, где погашение облагается в обычном порядке, а проценты - льготные");

    CalcLevel4(11, "Суммарные доходы по акциям");

    CalcLevel4(12, "Суммарные доходы по акциям и обычным облигациям по коротким позициям");

    CalcLevel4(13, "Суммарные доходы по льготным облигациям по коротким позициям");

    CalcLevel4(14, "Суммарные доходы по ПИ");

    CalcLevel4(15, "Доходы по частичному погашению ц/б, для которых сумма погашения не облагается налогом");

    CalcLevel4(16, "Доходы, не включаемые в НОБ");

    CalcLevel4(17, "Расходы, не включаемые в НОБ");

    CalcLevel4(18, "Доходы по полному погашению ц/б, для которых сумма погашения не облагается налогом");

    CalcLevel4(19, "Процентный (купонный) доход по ц/б");

    CalcLevel4(20, "Процентный (купонный) доход по ц/б");

    CalcLevel4(21, "Процентный (купонный) доход по ц/б");
  END;

   ОпределитьПараметрыРасчета(Oper);
   GetBegDate(Oper, true);

   if( (vBegDate!=null) AND (vEndDate!=null) )
     pBegDate = vBegDate;
     pEndDate = vEndDate;
   end;

  LoadDataToTMP(pClient, pBegDate, pEndDate);/*для определения общих комиссий <General>/<General_ИИС>*/
  InitProgress(24, "Выполняется расчет объектов НДР 4 уровня", "Расчет объектов НДР 4 уровня");

  if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
    var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
    stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);
    
    if(stat)
      MsgBox("Ошибка определения типа ИИС");
      return 1;
    end;

    pDateNDR = Oper.rec.OperDate;

    if(Oper.rec.Contract > 0)
      pContract = Oper.rec.Contract;
    end;

    if( (TypeIIS == IISTYPEA) or 
        (TypeIIS == IISTYPEC)
      )
      pBegDate = iisDateBegin;
      pEndDate = iisDateEnd;
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    elif((TypeIIS == IISTYPEB) or 
         (TypeIIS == IISTYPEG)
        )
      pBegDate = iisOpenDate;
      pEndDate = iisDateEnd;
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    elif(TypeIIS == IISTYPED)
      pTransfDate = Dtransf;
      pBegDate = iisDateBegin;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    elif(TypeIIS == IISTYPEE)
      pTransfDate = Dtransf;
      pBegDate = iisOpenDate;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    elif(TypeIIS == IISTYPEF)
      pTransfDate = Dtransf;
      pBegDate = iisOpenDate;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      Calc1to21Level4();
      CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
      CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));
    end;
  else
    if(Oper.rec.Contract > 0)
      pContract = Oper.rec.Contract;
    end;
    
    Calc1to21Level4();

    GetBegDate(Oper, false);
    if((vPeriodBegDate!=null) )
      pBegDate = vPeriodBegDate;
    end;
    CalcLevel4(22, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));

    GetBegDate(Oper, false);
    if((vPeriodBegDate!=null) )
      pBegDate = vPeriodBegDate;
    end;
    CalcLevel4(23, iif(pIIS,"Общие расходы по ИИС","Общие расходы"));

    if((pIIS == 0) and (pSubKindOperation == DL_TXHOLD_OPTYPE_ENDYEAR))
      GetBegDate(Oper, true);
      CalcLevel4(24, "Общие затраты прошлых лет");
    end;
  end;

   if(not stat)
     stat = CorrectTechnicalInObjTMP(pDocID, pStep, 4);
   end;

   RemProgress();

   return stat;

OnError(er)
  var err_text = "", delim = "";
  var j = 0;

  RemProgress();

  if(er and (er.err != NULL) and er.err.environment)
    while(j < er.err.environment.ErrorCount)
      err_text = err_text + delim + er.err.environment.error(j).descr;
      delim = "\n";
      j = j + 1;
    end;
    MsgBox(err_text);
  else
    MsgBox(er.Message);
  end;

  return 1;
END;

MACRO CreateMaterialTaxObjects4(Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate)
   var stat = 0;

   PRIVATE MACRO CalcMaterialLevel4(Step:integer, IndStr:string)
     var cmd;
     
     if(stat == 0)
       cmd = RsdCommand( "{ CALL RSI_NPTXCALC.CreateMaterialTaxObjects4_"+Step+"(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) }" );

       cmd.addParam("", RSDBP_IN,  pBegDate  );
       cmd.addParam("", RSDBP_IN,  pEndDate  );
       cmd.addParam("", RSDBP_IN,  pClient   );
       cmd.addParam("", RSDBP_IN,  pContract );
       cmd.addParam("", RSDBP_IN,  pIIS      );
       cmd.addParam("", RSDBP_IN,  pDocID    );
       cmd.addParam("", RSDBP_IN,  pStep     );
       cmd.addParam("", RSDBP_IN,  pFIID     );
       cmd.addParam("", RSDBP_IN,  pTechnical);
       cmd.addParam("", RSDBP_IN,  Oper.rec.Recalc);
       cmd.addParam("", RSDBP_IN,  pExistEarlyTechCalc);
       cmd.addParam("", RSDBP_IN,  pTransfDate);
       cmd.addParam("", RSDBP_IN,  pTransfKind);
       cmd.addParam("", RSDBP_IN,  pDateNDR);
       cmd.addParam("", RSDBP_OUT, stat      );

       SQL_Execute(cmd, "4."+Step+" "+IndStr, true);
     end;
   END;


  ОпределитьПараметрыРасчета(Oper);
  GetBegDate(Oper, true);
  if( (vBegDate!=null) AND (vEndDate!=null) )
    pBegDate = vBegDate;
    pEndDate = vEndDate;
  end;

  if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
    var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
    stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);
    
    if(stat)
      MsgBox("Ошибка определения типа ИИС");
      return 1;
    end;

    pDateNDR = Oper.rec.OperDate;

    if(Oper.rec.Contract > 0)
      pContract = Oper.rec.Contract;
    end;

    if( (TypeIIS == IISTYPEA) or 
        (TypeIIS == IISTYPEC)
      )
      pBegDate = iisDateBegin;
      pEndDate = iisDateEnd;
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    elif((TypeIIS == IISTYPEB) or 
         (TypeIIS == IISTYPEG)
        )
      pBegDate = iisOpenDate;
      pEndDate = iisDateEnd;
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    elif(TypeIIS == IISTYPED)
      pTransfDate = Dtransf;
      pBegDate = iisDateBegin;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    elif(TypeIIS == IISTYPEE)
      pTransfDate = Dtransf;
      pBegDate = iisOpenDate;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    elif(TypeIIS == IISTYPEF)
      pTransfDate = Dtransf;
      pBegDate = iisOpenDate;
      pEndDate = (Dtransf - 1);
      pTransfKind = 1; //До
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      pTransfKind = 2; //После
      CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
    end;
  else
    if(Oper.rec.Contract > 0)
      pContract = Oper.rec.Contract;
    end;

    CalcMaterialLevel4(1, "Материальная выгода по выпускам ц/б");
  end;

   return stat;

OnError(er)
  var err_text = "", delim = "";
  var j = 0;

  RemProgress();

  if(er and (er.err != NULL) and er.err.environment)
    while(j < er.err.environment.ErrorCount)
      err_text = err_text + delim + er.err.environment.error(j).descr;
      delim = "\n";
      j = j + 1;
    end;
    MsgBox(err_text);
  else
    MsgBox(er.Message);
  end;

  return 1;
END;

//////////////////////////////////////////////////////////////////
//НДР 5 
//////////////////////////////////////////////////////////////////

/**
  @brief Рассчет НДР 5-го уровня
  @param [in] Oper Объект TRecHandler операции (NPTXOP)
  @param [in] pStep Номер шага
  @param [in] vBegDate Дата начала периода
  @param [in] vEndDate Дата окончания периода
  @param [in] vTypeIIS Тип договора ИИС
  @param [in] vTransfDate Дата трансформации
  @param [in] vTransfKind Период расчета (До\После)
  @param [in] vContract Договор sfcontr по которому создаются НДР
  @param [in] vContracts Договора sfcontr для отбора НДР (строка вида "(1,2)")
*/
MACRO CreateTaxObjects5(Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate, vTypeIIS, vTransfDate, vTransfKind, vContract, vContracts, NotCreateMinusG:bool)
   var C2, C1, n, G_201 = 0, G_218 = 0, G_222 = 0,
       dir, S, S1, S2, R, FM = 0, ComRepo = 0, G = 0, TI = 0, F4 = 0, F5 = 0, Sm = 0, Sn = 0, 
       FRbs = 0, FRshortM = 0, FRshortN = 0, FRshortL = 0, VR = 0, O1 = 0, O2 = 0,
       RI = 0, RD = 0, 
       I_all = 0, D_all = 0, 
       _SI = 0, _SD = 0,
       Proc_Sec, Proc_Sec0,
       Div_Sec, Div_Sec0, 
       DivPay_Sec, DivPay_Sec0, _Proc_Sec_Change, 
       vKind, _I, _D, _D1, _U, _KS, Year, YearTransf = 0;
   var WhereCondTransfObj = " 1=1 ";
   var WhereCondTransfN = " ";
   stat = 0;
   
   ОпределитьПараметрыРасчета(Oper);
   GetBegDate(Oper, true);
   pDateNDR = ZeroDate;
   if( (vBegDate!=null) AND (vEndDate!=null) )
     pBegDate = vBegDate;
     pEndDate = vEndDate;
   end;

   if( (vTransfDate!=null) AND (vTransfKind!=null) )
     pTransfDate = vTransfDate;
     pTransfKind = vTransfKind;
     DateSplit(pTransfDate, null, null, YearTransf);
   end;

   if(vTypeIIS!=null)
     pContract = vContract;
     pDateNDR = Oper.rec.OperDate;
     WhereCondTransfObj = " obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 +
                          " and obj.t_Analitic6 in " + vContracts + " and obj.t_transfkind = " + pTransfKind + " ";
     WhereCondTransfN = " and N.t_AnaliticKind6 = " + TXOBJ_KIND6020 +
                        " and N.t_Analitic6 in " + vContracts + " and N.t_transfkind = " + pTransfKind + " ";
   end;

   if(NotCreateMinusG == NULL)
     NotCreateMinusG = false;
   end;

   //НДР по финрезу от других брокеров
   if((pIIS) and (Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS))

     QuerySelect =   " select k.t_Element, q.ObjSum, (case when k.t_Income = 'X' then "+TXOBJ_DIR_IN+" else "+TXOBJ_DIR_OUT+" end) as Dir, "
                   + "        NVL((select SUM(obj.t_Sum) "
                   + "               from dnptxobj_dbt obj "
                   + "              where obj.t_Client = ? "
                   + "                and obj.t_Kind = k.t_Element "
                   + "                and obj.t_OutSystCode = ? "
                   + "            ), 0) as FindObjSum ";

     QueryCond =   "  from (select 'PlusG_'||TO_CHAR(frob.t_IncomeCode)||(case when frob.t_IncomeCode = 3023 then '_ИИС' when frob.t_IncomeCode = 1011 then '_ИИС' else '' end) as ObjCode, SUM(frob.t_IncomeSum) as ObjSum "
                 + "          from dsfcontr_dbt sf, ddlcontr_dbt dlc, ddlcontrfrob_dbt frob "
                 + "         where sf.t_PartyID = ? "
                 + IIF(vContracts != NULL, " and sf.t_ID in " + vContracts + " ", " " ) 
                 + "               and dlc.t_SfContrID = sf.t_ID "
                 + "               and dlc.t_IIS = 'X' "
                 + "               and dlc.t_IISTransfer = 'X' "
                 + "               and frob.t_DlContrID = dlc.t_DlContrID "
                 + "               and frob.t_IncomeCode IN (1011, 3023, 1551, 1544, 1545, 1549, 1546, 1548, 1547, 1553) "
                 + IIF(pTransfKind == 1, " and frob.t_taxperiod < "  + string(YearTransf) + " ", " ")
                 + IIF(pTransfKind == 2, " and frob.t_taxperiod >= " + string(YearTransf) + " ", " ")
                 + "         group by frob.t_IncomeCode "
                 + "        union "
                 + "        select 'FullMinus_'||TO_CHAR(frob.t_DeductionCode) as ObjCode, SUM(frob.t_DeductionSum) as ObjSum "
                 + "          from dsfcontr_dbt sf, ddlcontr_dbt dlc, ddlcontrfrob_dbt frob "
                 + "         where sf.t_PartyID = ? "
                 + "               and dlc.t_SfContrID = sf.t_ID "
                 + "               and dlc.t_IIS = 'X' "
                 + "               and dlc.t_IISTransfer = 'X' "
                 + IIF(vContracts != NULL, " and sf.t_ID in " + vContracts + " ", " " ) 
                 + "               and frob.t_DlContrID = dlc.t_DlContrID "
                 + "               and frob.t_DeductionCode IN (225, 233, 239, 227, 226, 234, 240, 228, 229, 235, 230, 231) "
                 + IIF(pTransfKind == 1, " and frob.t_taxperiod < "  + string(YearTransf) + " ", " ")
                 + IIF(pTransfKind == 2, " and frob.t_taxperiod >= " + string(YearTransf) + " ", " ")
                 + "         group by frob.t_DeductionCode "
                 + "       ) q, dnptxkind_dbt k "
                 + " where instr(lower(k.t_Code), lower(q.ObjCode)) > 0 ";

     Query = DL_RSDCommand(QuerySelect + QueryCond);
     Query.addParam( pClient );
     Query.addParam( FrobOutSystCode );
     Query.addParam( pClient );
     Query.addParam( pClient );

     DataSet = Query.execute();
     while(DataSet.moveNext())
       S = DataSet.ObjSum - DataSet.FindObjSum + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, DataSet.Element, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind, FrobOutSystCode);
       if(S)
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             DataSet.Dir,
                             5,
                             UNSET_CHAR,
                             DataSet.Element,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Фин. рез., полученный от другого брокера",
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             UNSET_CHAR,
                             FrobOutSystCode,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );

         if(DataSet.Element == TXOBJ_PLUSG_1011_IIS)
           InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                               pClient,
                               DataSet.Dir,
                               5,
                               UNSET_CHAR,
                               TXOBJ_PLUSG_1011_1_IIS,
                               S,
                               NATCUR,
                               0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                               TXOBJ_KIND6020,                 
                               pContract,
                               "Фин. рез., полученный от другого брокера",
                               pDocID,
                               pStep,
                               0,
                               Oper.rec.Recalc,
                               UNSET_CHAR,
                               FrobOutSystCode
                             );
         end;
       end;
     end;
   end;

   //По НДР нижних уровней:
   //п.1 ----------------------------------------------------------------------------------------------

   if( IsPartyResident() == true ) //для резидента
      dir = TArray();
      dir(0) = TXOBJ_DIR_OUT;  //Расход
      dir(1) = TXOBJ_DIR_IN;   //Доход

      n = 0;
      while (n < dir.size)

         C2 = GetRubSumByClient(pClient, string(TXOBJ_EXP_SEC), pBegDate, pEndDate, dir(n), pIIS, null, WhereCondTransfObj);

         C1 = GetRubSumByClient(pClient, string(TXOBJ_EXP_GROUP), pBegDate, pEndDate, dir(n), pIIS, null, WhereCondTransfObj);
         S = C2 - C1;

         S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, TXOBJ_EXP_GROUP, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
         if ((stat == 0) and (S != 0))
            InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                                pClient,
                                dir(n),
                                5,
                                UNSET_CHAR,
                                TXOBJ_EXP_GROUP,
                                S,
                                NATCUR,
                                0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                                TXOBJ_KIND6020,                 
                                pContract,
                                "Доходы по погашению группы ц/б",
                                pDocID,
                                pStep,
                                0,
                                Oper.rec.Recalc,
                                NULL,
                                NULL,
                                NULL,
                                pTransfDate,
                                pTransfKind
                              );
         end;

         n = n + 1;
      end;

      if( pEndDate < date(1,1,2021) )
      n = 0;
      //while (n < dir.size)

         C2 = 0;
         QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

         QueryCond =   "  from dnptxobj_dbt N " +
                       " where N.t_Client = ? " +
                       " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                       "   and N.t_Direction = " + string(dir(1)) +
                       "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                       "   and N.t_Date >= ? " +
                       "   and N.t_Date <= ? " +
                       "   and ( " +
                       "          N.t_Date >= to_date('01.01.2021', 'dd.mm.yyyy')" +
                       "          OR N.t_Analitic5 IN (" + string(TXGROUP_40) + ", " +
                                                           string(TXGROUP_50) +
                                                     ") " +
                       "       ) " +
                       "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010);
                       
         Query = DL_RSDCommand(QuerySelect + QueryCond);
         Query.addParam( pClient );
         Query.addParam( pIIS );
         Query.addParam( pBegDate );
         Query.addParam( pEndDate );

         DataSet = Query.execute();

         if( (stat == 0) and DataSet.MoveNext() )
            C2 = DataSet.C2;
         end;

         C1 = GetRubSumByClient(pClient, string(TXOBJ_COUP0_GROUP), pBegDate, pEndDate, dir(1), pIIS);
         S = C2 - C1;

         S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, TXOBJ_COUP0_GROUP, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);
         if ((stat == 0) and (S != 0))
            InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                                pClient,
                                dir(1),
                                5,
                                UNSET_CHAR,
                                TXOBJ_COUP0_GROUP,
                                S,
                                NATCUR,
                                0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                                TXOBJ_KIND6020,                 
                                pContract,
                                "Купоны, полученные от эмитентов по группе ц/б",
                                pDocID,
                                pStep,
                                0,
                                Oper.rec.Recalc
                              );
         end;

         n = n + 1;
     // end;
     end;
   end;

   //Для справок НДР:
   //п.1-6 ----------------------------------------------------------------------------------------------

   //п.7-12 ----------------------------------------------------------------------------------------------

   DL_GetNPTXOBJSumByClientAndGroup(pClient, TXGROUP_30, string(TXOBJ_PROC_SEC), pBegDate, pEndDate, 
                                    TXOBJ_DIR_IN, @Proc_Sec, @Proc_Sec0, null, pIIS, WhereCondTransfObj);
   C2 = Proc_Sec0;

   DL_GetNPTXOBJSumByClientAndGroup(pClient, TXGROUP_30, string(TXOBJ_PROC_SEC), pBegDate, pEndDate, 
                                    TXOBJ_DIR_OUT, @Proc_Sec, @Proc_Sec0, null, pIIS, WhereCondTransfObj);
   C2 = C2 - Proc_Sec0;

   vKind = IIF(IsPartyResident(), IIF(pIIS, TXOBJ_PLUS9_1110_IIS, TXOBJ_PLUS9_1110), TXOBJ_PLUSG_1110);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          TXOBJ_KIND6020,                 
                          pContract,
                          IIF(IsPartyResident(), "Проценты по ипотечным облигациям для резидентов", "Проценты по ипотечным облигациям для нерезидентов") + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;

   //п.13-18 ----------------------------------------------------------------------------------------------

   var Query = "";

   // если NO, то формируются НДР 5го уровня по купонным выплатам - формируются НДР PlusG_3023/1011x
   // если YES, то формируются НДР 5го уровня по купонным выплатам по новой логике :
   // НЕ формируются НДР PlusG_3023/1011x, формируются PlusG_15хх с признаком Замены кода дохода = ДА
   var autoChangeCode = АвтоЗаменаКодовДоходовIntr(pEndDate);
   if (not autoChangeCode)

      Query = "select nvl(sum(" +
                  "                 case N.t_Direction " +
                  "                 when 1 " +
                  "                 then " +
                  "                    N.t_Sum0 " +
                  "                 else " +
                  "                    -N.t_Sum0 " +
                  "                 end " +
                  "              ), 0) as t_Sum0 " +
                  "from dnptxobj_dbt N, dfininstr_dbt fin, DAVOIRISS_DBT avr " +
                  "where N.t_Client = ? " +
                  "   and RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = ? " +
                  "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                  "   and N.t_Date >= ? " +
                  "   and N.t_Date <= ? " +
                  "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                  "   and N.t_AnaliticKind3 = " + string(TXOBJ_KIND3010) +
                  "   and ( " +
                  "          N.t_Analitic5 = " + string(TXGROUP_20) +
                  "          or ( " +
                  "                N.t_Date >= to_date('01.01.2021', 'dd.mm.yyyy') " +
                  "                and N.t_Analitic5 = " + string(TXGROUP_40) +
                  "             ) " +
                  "       ) " +
                  "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) +
                  "   and fin.T_FIID = N.t_Analitic3 " +
                  "   and avr.T_FIID = fin.T_FIID " +
                  /*вид ц/б != корпоративная облигация ИЛИ номинал != рубли ИЛИ дата начала размещения ранее 01.01.2017*/
                  "   and 1 = (case when N.t_Analitic4 <> " + string(NPTX_FI_CIRCULATE) + " then 1 " +
                  "                 when N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) + 
                  "                      and (   fin.T_FACEVALUEFI != " + string(NATCUR) +
                  "                           OR RSI_rsb_fiinstr.FI_AvrKindsEQ ("+string(FIKIND_AVOIRISS)+", "+string(32/*AVOIRKIND_BOND_CORPORATE*/)+", fin.T_AVOIRKIND) = 0 "+
                  "                           OR avr.t_BegPlacementDate < to_date('01.01.2017','DD.MM.YYYY') "+
                  "                          ) then 1 " +
                  "                 else 0 end) " + WhereCondTransfN;

      var Select = DL_RSDCommand(Query);
      Select.AddParam(pClient);
      Select.AddParam(pIIS);
      Select.AddParam(pBegDate);
      Select.AddParam(pEndDate);

      var DataSet = Select.Execute();

      Proc_Sec0 = 0;
      if(DataSet.MoveNext())
         Proc_Sec0 = DataSet.Sum0;
      end;

      C2 = Proc_Sec0;

      vKind = IIF(pIIS, TXOBJ_PLUSG_1011_IIS, TXOBJ_PLUSG_1011);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             IIF(IsPartyResident(), "Проценты по облигациям с обычным обложением для резидентов", "Проценты по облигациям с обычным обложением для нерезидентов") + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;

      //п.19-22 ----------------------------------------------------------------------------------------------

      S = 0;
      QuerySelect = "select NVL(sum(DECODE(N.t_Direction, "+TXOBJ_DIR_IN+",N.t_Sum0,-N.t_Sum0)), 0) C2 ";

      QueryCond =   "  from dnptxobj_dbt N, dparty_dbt pt, dfininstr_dbt fin, DAVOIRISS_DBT avr " +
                    " where N.t_Client = ? " +
                    "   and pt.t_PartyID = N.t_Client "
                    "   and N.t_Analitic3 = fin.T_FIID "
                    "   and fin.T_FIID = avr.T_FIID "
                    "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                    "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                    "   and N.t_Date >= ? " +
                    "   and N.t_Date <= ? " +
                    "   and ( " +
                    "          N.t_Analitic5 = " + TXGROUP_20 +
                    "          or (N.t_Analitic5 = " + TXGROUP_30 + " and pt.t_NotResident = CHR(88)) " +
                    "          or ( " +
                    "                N.t_Date >= to_date('01.01.2021', 'dd.mm.yyyy') " +
                    "                and N.t_Analitic5 = " + string(TXGROUP_40) +
                    "             )" +
                    "       ) "+
                    "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                    "   and N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) +
                    "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) +
                    "   and N.t_AnaliticKind3 = " + string(TXOBJ_KIND3010) +
                    /*вид ц/б != корпоративная облигация ИЛИ номинал != рубли ИЛИ дата начала размещения ранее 01.01.2017*/
                    "   and ( fin.T_FACEVALUEFI != " + string(NATCUR) +
                    "      OR RSI_rsb_fiinstr.FI_AvrKindsEQ ("+string(FIKIND_AVOIRISS)+", "+string(32/*AVOIRKIND_BOND_CORPORATE*/)+", fin.T_AVOIRKIND) = 0 "+
                    "      OR avr.t_BegPlacementDate < to_date('01.01.2017','DD.MM.YYYY') "+
                    "       )" + WhereCondTransfN;

      Query = DL_RSDCommand(QuerySelect + QueryCond);
      Query.addParam( pClient );
      Query.addParam( pIIS );
      Query.addParam( pBegDate );
      Query.addParam( pEndDate );
      
      DataSet = Query.execute();

      if( (stat == 0) and DataSet.MoveNext() )
         C2 = DataSet.C2;
      end;

      vKind = IIF(pIIS, TXOBJ_PLUSG_1011_1_IIS, TXOBJ_PLUSG_1011_1);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Проценты по обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;

      S = 0;
      QuerySelect = "select NVL(sum(DECODE(N.t_Direction, "+TXOBJ_DIR_IN+",N.t_Sum0,-N.t_Sum0)), 0) C2 ";

      QueryCond =   "  from dnptxobj_dbt N, dparty_dbt pt, dfininstr_dbt fin, DAVOIRISS_DBT avr " +
                    " where N.t_Client = ? " +
                    "   and pt.t_PartyID = N.t_Client "
                    "   and N.t_Analitic3 = fin.T_FIID "
                    "   and fin.T_FIID = avr.T_FIID "
                    "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                    "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                    "   and N.t_Date >= ? " +
                    "   and N.t_Date <= ? " +
                    "   and ( " +
                    "          N.t_Analitic5 = " + TXGROUP_20 +
                    "          or (N.t_Analitic5 = " + TXGROUP_30 + " and pt.t_NotResident = CHR(88)) " +
                    "          or ( " +
                    "                N.t_Date >= to_date('01.01.2021', 'dd.mm.yyyy') " +
                    "                and N.t_Analitic5 = " + string(TXGROUP_40) +
                    "             )" +
                    "       ) "+
                    "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                    "   and N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) +
                    "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) +
                    "   and N.t_AnaliticKind3 = " + string(TXOBJ_KIND3010) +
                    /*вид ц/б ? корпоративная облигация, номинал = рубли, дата начала размещения не ранее 01.01.2017*/
                    "   and fin.T_FACEVALUEFI = " + string(NATCUR) +
                    "   and RSI_rsb_fiinstr.FI_AvrKindsEQ ("+string(FIKIND_AVOIRISS)+", "+string(32/*AVOIRKIND_BOND_CORPORATE*/)+", fin.T_AVOIRKIND) = 1 "+
                    "   and avr.t_BegPlacementDate >= to_date('01.01.2017','DD.MM.YYYY') " + WhereCondTransfN;

      Query = DL_RSDCommand(QuerySelect + QueryCond);
      Query.addParam( pClient );
      Query.addParam( pIIS );
      Query.addParam( pBegDate );
      Query.addParam( pEndDate );
      
      DataSet = Query.execute();

      if( (stat == 0) and DataSet.MoveNext() )
         C2 = DataSet.C2;
      end;

      vKind = IIF(pIIS, TXOBJ_PLUSG_3023_IIS, TXOBJ_PLUSG_3023);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      S = C2 - C1;

      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Проценты по корпоративным облигациям в рублях, эмитированным после 01.01.2017" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;

      //п.23-26 ----------------------------------------------------------------------------------------------

      S = 0;
      QuerySelect = "select NVL(sum(DECODE(N.t_Direction, "+TXOBJ_DIR_IN+",N.t_Sum0,-N.t_Sum0)), 0) C2 ";

      QueryCond =   "  from dnptxobj_dbt N, dparty_dbt pt " +
                    " where N.t_Client = ? " +
                    "   and pt.t_PartyID = N.t_Client "
                    "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                    "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                    "   and N.t_Date >= ? " +
                    "   and N.t_Date <= ? " +
                    "   and ( " +
                    "          N.t_Analitic5 = " + TXGROUP_20 +
                    "          or (N.t_Analitic5 = " + TXGROUP_30 + " and pt.t_NotResident = CHR(88))" +
                    "          or ( " +
                    "                N.t_Date >= to_date('01.01.2021', 'dd.mm.yyyy') " +
                    "                and N.t_Analitic5 = " + string(TXGROUP_40) +
                    "             ) " +
                    "       ) " +
                    "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                    "   and N.t_Analitic4 = " + string(NPTX_FI_LOSTCIRCULATE) +
                    "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;

      Query = DL_RSDCommand(QuerySelect + QueryCond);
      Query.addParam( pClient );
      Query.addParam( pIIS );
      Query.addParam( pBegDate );
      Query.addParam( pEndDate );

      DataSet = Query.execute();

      if( (stat == 0) and DataSet.MoveNext() )
         C2 = DataSet.C2;
      end;

      vKind = IIF(pIIS, TXOBJ_PLUSG_1011_2_IIS, TXOBJ_PLUSG_1011_2);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Проценты по ц/б, потерявшим обращаемость" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;

      S = 0;
      QuerySelect = "select NVL(sum(DECODE(N.t_Direction, "+TXOBJ_DIR_IN+",N.t_Sum0,-N.t_Sum0)), 0) C2 ";

      QueryCond =   "  from dnptxobj_dbt N, dparty_dbt pt " +
                    " where N.t_Client = ? " +
                    "   and pt.t_PartyID = N.t_Client "
                    "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                    "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                    "   and N.t_Date >= ? " +
                    "   and N.t_Date <= ? " +
                    "   and ( " +
                    "          N.t_Analitic5 = " + TXGROUP_20 +
                    "          or (N.t_Analitic5 = " + TXGROUP_30 + " and pt.t_NotResident = CHR(88))" +
                    "       ) " +
                    "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                    "   and N.t_Analitic4 = " + string(NPTX_FI_NOCIRCULATE) +
                    "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;

      Query = DL_RSDCommand(QuerySelect + QueryCond);
      Query.addParam( pClient );
      Query.addParam( pIIS );
      Query.addParam( pBegDate );
      Query.addParam( pEndDate );

      DataSet = Query.execute();

      if( (stat == 0) and DataSet.MoveNext() )
         C2 = DataSet.C2;
      end;

      vKind = IIF(pIIS, TXOBJ_PLUSG_1011_3_IIS, TXOBJ_PLUSG_1011_3);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      S = C2 - C1;

      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Проценты по необращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind                        );
      end;

   end;

   //27-32 ----------------------------------------------------------------------------------------------

   vKind = IIF(pIIS, TXOBJ_PLUSG_1551, TXOBJ_PLUSG_1537);

   C2 = GetRubSumByClient(pClient, string(TXOBJ_PROCREPOTAX), pBegDate, pEndDate, TXOBJ_DIR_IN, pIIS, NULL, WhereCondTransfObj);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по процентам по РЕПО" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;

   //п.33-38 ----------------------------------------------------------------------------------------------

   S = 0;
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_PLUS_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_90) +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;

                 
   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
      C2 = DataSet.C2;
   end;

   vKind = IIF(pIIS, TXOBJ_PLUSG_1544, TXOBJ_PLUSG_1530);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind,
                          UNSET_CHAR
                        );
   end;

   if (autoChangeCode)
      S = 0;
      QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

      QueryCond =   "  from dnptxobj_dbt N " +
                    " where N.t_Client = ? " +
                    " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                    "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                    "   and N.t_Date >= ? " +
                    "   and N.t_Date <= ? " +
                    "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                    "   and N.t_Analitic5 <> " + string(TXGROUP_90) +
                    "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                    "   and N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) +
                    "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;

                    
      Query = DL_RSDCommand(QuerySelect + QueryCond);
      Query.addParam( pClient );
      Query.addParam( pIIS );
      Query.addParam( pBegDate );
      Query.addParam( pEndDate );

      DataSet = Query.execute();

      if( (stat == 0) and DataSet.MoveNext() )
         C2 = DataSet.C2;
      end;

      vKind = IIF(pIIS, TXOBJ_PLUSG_1544, TXOBJ_PLUSG_1530);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + "and" + WhereCondTransfObj + "and obj.t_ChangeCode = chr(88) and obj.t_FromOutSyst <> CHR(88)"));

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Доходы по обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind,
                             SET_CHAR
                           );
      end;

   end;


   //п.39-44 ----------------------------------------------------------------------------------------------

   S = 0;
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_PLUS_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_90) +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_NOCIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;


   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
      C2 = DataSet.C2;
   end;

   vKind = IIF(pIIS, TXOBJ_PLUSG_1545, TXOBJ_PLUSG_1531);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по необращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind,
                          UNSET_CHAR
                        );
   end;

   if (autoChangeCode)

      S = 0;
      QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

      QueryCond =   "  from dnptxobj_dbt N " +
                    " where N.t_Client = ? " +
                    " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                    "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                    "   and N.t_Date >= ? " +
                    "   and N.t_Date <= ? " +
                    "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                    "   and N.t_Analitic5 <> " + string(TXGROUP_90) +
                    "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                    "   and N.t_Analitic4 = " + string(NPTX_FI_NOCIRCULATE) +
                    "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;


      Query = DL_RSDCommand(QuerySelect + QueryCond);
      Query.addParam( pClient );
      Query.addParam( pIIS );
      Query.addParam( pBegDate );
      Query.addParam( pEndDate );

      DataSet = Query.execute();

      if( (stat == 0) and DataSet.MoveNext() )
         C2 = DataSet.C2;
      end;

      vKind = IIF(pIIS, TXOBJ_PLUSG_1545, TXOBJ_PLUSG_1531);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + "and" + WhereCondTransfObj + "and obj.t_ChangeCode = chr(88) and obj.t_FromOutSyst <> CHR(88)"));

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Доходы по необращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind,
                             SET_CHAR
                           );
      end;
   
   end;


   //п.45-50 ----------------------------------------------------------------------------------------------

   S = 0;
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_PLUS_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_90) +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_LOSTCIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;

   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
      C2 = DataSet.C2;
   end;

   vKind = IIF(pIIS, TXOBJ_PLUSG_1549, TXOBJ_PLUSG_1536);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));
                                                                                                       
   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по ц/б, потерявшим обращаемость" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind,
                          UNSET_CHAR
                        );
   end;

   if (autoChangeCode)

      S = 0;
      QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

      QueryCond =   "  from dnptxobj_dbt N " +
                    " where N.t_Client = ? " +
                    " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                    "   and N.t_Kind = " + string(TXOBJ_PROC_SEC) +
                    "   and N.t_Date >= ? " +
                    "   and N.t_Date <= ? " +
                    "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                    "   and N.t_Analitic5 <> " + string(TXGROUP_90) +
                    "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                    "   and N.t_Analitic4 = " + string(NPTX_FI_LOSTCIRCULATE) +
                    "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;

      Query = DL_RSDCommand(QuerySelect + QueryCond);
      Query.addParam( pClient );
      Query.addParam( pIIS );
      Query.addParam( pBegDate );
      Query.addParam( pEndDate );

      DataSet = Query.execute();

      if( (stat == 0) and DataSet.MoveNext() )
         C2 = DataSet.C2;
      end;

      vKind = IIF(pIIS, TXOBJ_PLUSG_1549, TXOBJ_PLUSG_1536);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + "and" + WhereCondTransfObj + "and obj.t_ChangeCode = chr(88) and obj.t_FromOutSyst <> CHR(88)"));
                                                                                                          
      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_IN,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Доходы по ц/б, потерявшим обращаемость" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind,
                             SET_CHAR
                           );
      end;

   end;

   //п.51-54 ----------------------------------------------------------------------------------------------

   S = 0;
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_PLUS_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic5 = " + string(TXGROUP_80) +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;
                 
   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
      C2 = DataSet.C2;
   end;

   vKind = IIF(pIIS, TXOBJ_PlusG_1546, TXOBJ_PLUSG_1532 );
   
   C1 = GetRubSumByClient(pClient, vKind, pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по обращающимся ПИ фондового рынка",
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;


   //п.55-58 ----------------------------------------------------------------------------------------------

   S = 0;
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_PLUS_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic5 = " + string(TXGROUP_90) +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;
                 
   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
      C2 = DataSet.C2;
   end;

   vKind = IIF(pIIS, TXOBJ_PlusG_1548, TXOBJ_PLUSG_1535 );
   
   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по обращающимся ПИ не фондового рынка",
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;

   //п.59-62 ----------------------------------------------------------------------------------------------

   S = 0;
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) C2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 " AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_PLUS_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic5 in(" + string(TXGROUP_80) + "," + string(TXGROUP_90) + ")" +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_NOCIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + 
                 "   and N.t_User != 'X'" + WhereCondTransfN;

   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
      C2 = DataSet.C2;
   end;

   vKind = IIF(pIIS, TXOBJ_PlusG_1547, TXOBJ_PLUSG_1533 );
   
   C1 = GetRubSumByClient(pClient, vKind, pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if( (stat == 0) and (S != 0) )
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по необращающимся ПИ",
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;
 
   //п.63-68 ----------------------------------------------------------------------------------------------

   C2 = GetRubSumByClient(pClient, string(TXOBJ_PLUS_SEC_SHORT), pBegDate, pEndDate, null, pIIS, null, WhereCondTransfObj);

   vKind = IIF(pIIS, TXOBJ_PLUSG_1553, TXOBJ_PLUSG_1539);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доходы по коротким позициям" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;

   //п.69-70 ----------------------------------------------------------------------------------------------
   if ((pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS));
     if(pIIS == 1)
       G = GetRubSumByClient(pClient, string(TXOBJ_GENERAL_IIS), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond5 + "and" + WhereCondTransfObj + " and obj.t_Analitickind6 <> " + string(TXOBJ_KIND6030) ));
     else
       DateSplit(pEndDate, NULL, NULL, Year);
       G = GetRubSumByClient(pClient, string(TXOBJ_PREVIOUSYEAR), NULL, date(1, 1, Year)-1, null, pIIS, NULL, NotUserWhereCond5 + " and obj.t_Analitickind6 <> " + string(TXOBJ_KIND6030)  ) +
           GetNPTXObjSum(pBegDate, pEndDate, pClient, TXOBJ_GENERAL, pIIS, pContract);
     end;
   else
      G = 0;
   end;

   if( pIIS == 1 )
      TI = GetRubSumByClient(pClient, string(TXOBJ_PLUS_SEC), pBegDate, pEndDate, null, pIIS, null, WhereCondTransfObj);
   else
      TI = GetRubSumByClient(pClient, string(TXOBJ_PLUS_SEC), pBegDate, pEndDate, null, pIIS) +
           GetRubSumByClient(pClient, string(TXOBJ_PLUS_SEC_SHORT), pBegDate, pEndDate, null, pIIS);
   end;

   Query = DL_RSDCommand();

   QuerySelect = "select NVL(sum(DECODE(N.t_Direction, "+TXOBJ_DIR_IN+", N.t_Sum0, -N.t_Sum0)), 0) TI "
               + "  from dnptxobj_dbt N, dparty_dbt pt "
               + " where N.t_Client = ? "
               + "   and pt.t_PartyID = N.t_Client "
               + "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "   and N.t_Kind = " + string(TXOBJ_PROC_SEC)
               + "   and N.t_Date >= ? "
               + "   and N.t_Date <= ? " + WhereCondTransfN;

   Query.addParam( pClient );
   Query.addParam( pIIS);
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.Execute(QuerySelect);
   if((stat == 0) and DataSet.moveNext())
     TI = TI + DataSet.TI;
   end;

   private macro StrMaxFactDate2()
      return
      " (NVL( (SELECT max(dlrq.t_FactDate) " +
      "  FROM ddlrq_dbt dlrq " + 
      "  WHERE dlrq.t_DocKind    = tick.t_BOfficeKind " +
      "      AND dlrq.t_DocID = tick.t_DealID " +
      "      AND dlrq.t_Type    IN (" + DLRQ_TYPE_DELIVERY + "," + DLRQ_TYPE_PAYMENT + ") " +
      "      AND dlrq.t_DealPart    = " + LEG_KIND_DL_TICK_BACK + 
      "      AND dlrq.t_State = " + DLRQ_STATE_EXEC +
      "      AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
      "      ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
      " ) ";
   end;

   private macro GetSumNdrFrobOut(KindStr)
     var StrSQL, Query, DataSet;
     var Sum = $0;

     if((pSubKindOperation != DL_TXBASECALC_OPTYPE_CLOSE_IIS) or (IsCalcNOBCloseISS() != true))
       return Sum;
     end;

     Query = DL_RSDCommand();

     StrSQL =    " select NVL (SUM (Sum1), 0) Sum2 from"
               + " (select NVL(sum(N.t_Sum0), 0) Sum1"
               + "   from dnptxobj_dbt N "
               + "  where N.t_Kind IN ( " + KindStr + " )"
               + "    and N.t_Client = ? "
               + "    and N.t_AnaliticKind6 = " + TXOBJ_KIND6020
               + "    and N.t_Analitic6 in " + vContracts 
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? "
               + "    and N.t_OutSystCode = '"+FrobOutSystCode+"' " + WhereCondTransfN
               + " UNION ALL "
               + " select NVL(sum(N.t_Sum), 0) Sum1"
               + "   from dnptxobj_tmp N "
               + "  where N.t_Kind IN ( " + KindStr + " )"
               + "    and N.t_Client = ? "
               + "    and N.t_AnaliticKind6 = " + TXOBJ_KIND6020
               + "    and N.t_Analitic6 in " + vContracts 
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? "
               + "    and N.t_OutSystCode = '"+FrobOutSystCode+"' " + WhereCondTransfN + " ) "; 

     Query.addParam( pClient );
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );
     Query.addParam( pClient );
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum = DataSet.Sum2;
     end;

     return Sum;
   end;


   //73
   FM = GetRubSumByClient(pClient, string(TXOBJ_PROCREPOTAX), pBegDate, pEndDate, TXOBJ_DIR_IN, pIIS, null, WhereCondTransfObj) + 
        GetSumNdrFrobOut(TXOBJ_PLUSG_1551) - (GetSumNdrFrobOut(TXOBJ_FULLMINUS_230) +
        GetRubSumByClient(pClient, string(TXOBJ_PROCREPOTAX), pBegDate, pEndDate, TXOBJ_DIR_OUT, pIIS, null, WhereCondTransfObj));

   QuerySelect = " select NVL(sum(N.t_Sum0), 0) S ";

   QueryCond =   "  from dnptxobj_dbt N, ddl_tick_dbt Tick " +
                 " where N.t_Client = ? " +
                 "   and N.t_Kind   = " + string(TXOBJ_COM) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_AnaliticKind1 = " + string(TXOBJ_KIND1010) +
                 "   and Tick.t_DealID = N.t_Analitic1" +
                 "   and Tick.t_BOfficeKind = " + string(DL_SECURITYDOC) +
                 "   and RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(Tick.t_DealType, Tick.t_BOfficeKind))) = 1" +
                 "   and RSI_NPTX.CheckCateg(" + string(OBJTYPE_SECDEAL) + ", 23, LPAD(Tick.t_DealID, 34, '0'), 2)<>1 " +
                 "                 and (" + StrMaxFactDate2() + " between ? and ?) " +
                 "   AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? " + WhereCondTransfN;

   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );
   Query.addParam( pIIS );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
     FM = FM - DataSet.S;
   end;

   //74
   Sm = 0;
   
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) Sm ";

   QueryCond =   "  from dnptxobj_dbt N, dparty_dbt pt " +
                 " where N.t_Client = ? " +
                 "   and pt.t_PartyID = N.t_Client " +
                 "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_COST) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_CIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;
                 
   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS);
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
     Sm = DataSet.Sm;
   end;

  
   //75
   Sn = 0;
   
   QuerySelect = "select NVL(sum(N.t_Sum0), 0) Sn ";

   QueryCond =   "  from dnptxobj_dbt N, dparty_dbt pt " +
                 " where N.t_Client = ? " +
                 "   and pt.t_PartyID = N.t_Client " +
                 "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "+
                 "   and N.t_Kind = " + string(TXOBJ_COST) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic4 = " + string(NPTX_FI_NOCIRCULATE) +
                 "   and N.t_AnaliticKind4 = " + string(TXOBJ_KIND4010) + WhereCondTransfN;
                 
   Query = DL_RSDCommand(QuerySelect + QueryCond);
   Query.addParam( pClient );
   Query.addParam( pIIS);
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();

   if( (stat == 0) and DataSet.MoveNext() )
     Sn = DataSet.Sn;
   end;

   //76-78
   O1 = 0;
   O2 = 0;
   if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
     if((Sm+Sn) != 0)
       O1 = MAX(0, -FM)*Sm/(Sm+Sn) + GetSumNdrFrobOut(TXOBJ_FULLMINUS_239);
       O2 = MAX(0, -FM)*Sn/(Sm+Sn) + GetSumNdrFrobOut(TXOBJ_FULLMINUS_240);
     end;
   else
     if((Sm+Sn) != 0)
       O1 = MAX(0, -FM)*Sm/(Sm+Sn);
       O2 = MAX(0, -FM)*Sn/(Sm+Sn);
     end;
   end; 
   //79
   private macro I(Str5, Str4)
     var StrSQL, Query, DataSet;
     var Sum1 = 0, Sum2 = 0;

     Query = DL_RSDCommand();

     StrSQL =   " select NVL(sum(N.t_Sum0), 0) Sum1"
               + "   from dnptxobj_dbt N "
               + "  where N.t_Kind IN (" + TXOBJ_PLUS_SEC + ", "+TXOBJ_PROC_SEC_SHORT+")"
               + "    and N.t_Direction = " + TXOBJ_DIR_IN
               + "    and N.t_Client = ? "
               + "    and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? " + WhereCondTransfN; 

     Query.addParam( pClient );
     Query.addParam( pIIS);
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     if((ValType(Str5) != V_UNDEF) and (Str5 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind5 = " + TXOBJ_KIND5010
                       + " and ( N.t_Analitic5 " + Str5 + " )";
     end;

     if((ValType(Str4) != V_UNDEF) and (Str4 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind4 = " + TXOBJ_KIND4010
                       + " and N.t_Analitic4 " + Str4;
     end;

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum1 = DataSet.Sum1;
     end;

     Query = DL_RSDCommand();

     StrSQL =   " select NVL(sum(DECODE(N.t_Direction, "+TXOBJ_DIR_IN+", N.t_Sum0, -N.t_Sum0)), 0) Sum2"
               + "   from dnptxobj_dbt N, dparty_dbt pt "
               + "  where N.t_Kind = " + TXOBJ_PROC_SEC
               + "    and N.t_Client = ? "
               + "    and pt.t_PartyID = N.t_Client " 
               + "    and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? " + WhereCondTransfN; 

     Query.addParam( pClient );
     Query.addParam( pIIS);
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     if((ValType(Str5) != V_UNDEF) and (Str5 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind5 = " + TXOBJ_KIND5010
                       + " and ( N.t_Analitic5 " + Str5 + " )";
     end;

     if((ValType(Str4) != V_UNDEF) and (Str4 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind4 = " + TXOBJ_KIND4010
                       + " and N.t_Analitic4 " + Str4;
     end;

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum2 = DataSet.Sum2;
     end;

     return Sum1 + Sum2;
   end;

   private macro Proc_Sec_Change(Str5, Str4)
     var StrSQL, Query, DataSet;
     var Sum1 = 0;

     Query = DL_RSDCommand();
 
     StrSQL =   " select NVL(sum(DECODE(N.t_Direction, "+TXOBJ_DIR_IN+", N.t_Sum0, -N.t_Sum0)), 0) Sum1"
               + "   from dnptxobj_dbt N, dparty_dbt pt "
               + "  where N.t_Kind = " + TXOBJ_PROCSEC_CHANGE
               + "    and N.t_Client = ? "
               + "    and pt.t_PartyID = N.t_Client " 
               + "    and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? " + WhereCondTransfN; 

     Query.addParam( pClient );
     Query.addParam( pIIS);
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     if((ValType(Str5) != V_UNDEF) and (Str5 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind5 = " + TXOBJ_KIND5010
                       + " and ( N.t_Analitic5 " + Str5 + " )";
     end;

     if((ValType(Str4) != V_UNDEF) and (Str4 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind4 = " + TXOBJ_KIND4010
                       + " and N.t_Analitic4 " + Str4;
     end;

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum1 = DataSet.Sum1;
     end;

     return Sum1;
   end;

   //80
   private macro D(Str5, Str4)
     var StrSQL, Query, DataSet;
     var Sum1 = 0;

     Query = DL_RSDCommand();

     StrSQL =   " select NVL(sum(N.t_Sum0), 0) Sum1"
               + "   from dnptxobj_dbt N "
               + "  where N.t_Kind IN ("+TXOBJ_MINUS_SEC+","+TXOBJ_OTHER_SEC+") "
               + "    and N.t_Direction = " + TXOBJ_DIR_OUT
               + "    and N.t_Client = ? "
               + "    and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? " + WhereCondTransfN; 

     Query.addParam( pClient );
     Query.addParam( pIIS);
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     if((ValType(Str5) != V_UNDEF) and (Str5 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind5 = " + TXOBJ_KIND5010
                       + " and ( N.t_Analitic5 " + Str5 + " )";
     end;

     if((ValType(Str4) != V_UNDEF) and (Str4 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind4 = " + TXOBJ_KIND4010
                       + " and N.t_Analitic4 " + Str4;
     end;

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum1 = DataSet.Sum1;
     end;

     return Sum1;
   end;

   private macro D1(Str5, Str4)
     var StrSQL, Query, DataSet;
     var Sum1 = 0;

     Query = DL_RSDCommand();

     StrSQL =   " select NVL(sum(N.t_Sum0), 0) Sum1"
               + "   from dnptxobj_dbt N "
               + "  where N.t_Kind IN ("+TXOBJ_PROC_SEC_SHORT+") "
               + "    and N.t_Direction = " + TXOBJ_DIR_OUT
               + "    and N.t_Client = ? "
               + "    and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? " + WhereCondTransfN; 

     Query.addParam( pClient );
     Query.addParam( pIIS);
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     if((ValType(Str5) != V_UNDEF) and (Str5 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind5 = " + TXOBJ_KIND5010
                       + " and ( N.t_Analitic5 " + Str5 + " )";
     end;

     if((ValType(Str4) != V_UNDEF) and (Str4 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind4 = " + TXOBJ_KIND4010
                       + " and N.t_Analitic4 " + Str4;
     end;

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum1 = DataSet.Sum1;
     end;

     return Sum1;
   end;

   //81
   private macro SI(Str5, Str4)
     var StrSQL, Query, DataSet;
     var Sum1 = 0;

     Query = DL_RSDCommand();

     StrSQL =   " select NVL(sum(N.t_Sum0), 0) Sum1"
               + "   from dnptxobj_dbt N "
               + "  where N.t_Kind = "+TXOBJ_PLUS_SEC_SHORT
               + "    and N.t_Client = ? "
               + "    and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? " + WhereCondTransfN; 

     Query.addParam( pClient );
     Query.addParam( pIIS);
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     if((ValType(Str5) != V_UNDEF) and (Str5 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind5 = " + TXOBJ_KIND5010
                       + " and ( N.t_Analitic5 " + Str5 + " )";
     end;

     if((ValType(Str4) != V_UNDEF) and (Str4 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind4 = " + TXOBJ_KIND4010
                       + " and N.t_Analitic4 " + Str4;
     end;

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum1 = DataSet.Sum1;
     end;

     return Sum1;
   end;

   //82
   private macro SD(Str5, Str4)
     var StrSQL, Query, DataSet;
     var Sum1 = 0;

     Query = DL_RSDCommand();

     StrSQL =   " select NVL(sum(N.t_Sum0), 0) Sum1"
               + "   from dnptxobj_dbt N "
               + "  where N.t_Kind in("+TXOBJ_MINUS_SEC_SHORT+")"
               + "    and N.t_Client = ? "
               + "    and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? "
               + "    and N.t_Date >= ? " 
               + "    and N.t_Date <= ? " + WhereCondTransfN; 

     Query.addParam( pClient );
     Query.addParam( pIIS);
     Query.addParam( pBegDate );
     Query.addParam( pEndDate );

     if((ValType(Str5) != V_UNDEF) and (Str5 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind5 = " + TXOBJ_KIND5010
                       + " and ( N.t_Analitic5 " + Str5 + " )";
     end;

     if((ValType(Str4) != V_UNDEF) and (Str4 != ""))
       StrSQL = StrSQL + " and N.t_AnaliticKind4 = " + TXOBJ_KIND4010
                       + " and N.t_Analitic4 " + Str4;
     end;

     DataSet = Query.Execute(StrSQL);
     if(DataSet.moveNext())
       Sum1 = DataSet.Sum1;
     end;

     return Sum1;
   end;

   private macro U()
     var v_U;

     if(TI != 0)
        v_U = _D + G*(_I + _SI)/TI;
     else
        v_U = 0;
     end;

     return v_U;
   end;

   private macro S_Not_80_90()
     var Sum1;

     if( (УчетУбытковВТечениеГода()) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)) 
       if((_SI < _SD) and ((_I + _Proc_Sec_Change) > _U)) 
         Sum1 = Min((_U + (_SD - _SI)), (_I + _Proc_Sec_Change));
       else
         Sum1 = Min((_I + _Proc_Sec_Change), _U);
       end;
     else
        Sum1 = Min(_I, _U);
     end;

     return Sum1;
   end;

   private macro G_225()
     var Sum1;
     
     if((pSubKindOperation != DL_TXBASECALC_OPTYPE_CLOSE_IIS) or (IsCalcNOBCloseISS() != true))
       return S_Not_80_90();
     end;

     if( (УчетУбытковВТечениеГода()) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS)) 
       if( ((_SI + GetSumNdrFrobOut(TXOBJ_PLUSG_1553)) < (_SD + GetSumNdrFrobOut(TXOBJ_FULLMINUS_231)) ) 
       and ((_I + _Proc_Sec_Change + GetSumNdrFrobOut(TXOBJ_PLUSG_1544)) > (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_225)))) 
         Sum1 = Min(((_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_225)) + ((_SD + GetSumNdrFrobOut(TXOBJ_FULLMINUS_231)) - (_SI + GetSumNdrFrobOut(TXOBJ_PLUSG_1553)))), (_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1544) + _Proc_Sec_Change));
       else
         Sum1 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1544) + _Proc_Sec_Change), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_225)));
       end;
     else
        Sum1 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1544)), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_225)));
     end;

     return Sum1;
   end;

   private macro G_226()
     var Sum1;
     
     if((pSubKindOperation != DL_TXBASECALC_OPTYPE_CLOSE_IIS) or (IsCalcNOBCloseISS() != true))
       return S_Not_80_90();
     end;

     if( (УчетУбытковВТечениеГода()) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS)) 
       if( (_SI < _SD) 
       and ((_I + _Proc_Sec_Change + GetSumNdrFrobOut(TXOBJ_PLUSG_1545)) > (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_226)))) 
         Sum1 = Min(((_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_226)) + (_SD - _SI )), (_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1545) + _Proc_Sec_Change));
       else
         Sum1 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1545) + _Proc_Sec_Change), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_226)));
       end;
     else
        Sum1 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1545)), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_226)));
     end;

     return Sum1;
   end;

   private macro G_227()
     var Sum1;
     
     if((pSubKindOperation != DL_TXBASECALC_OPTYPE_CLOSE_IIS) or (IsCalcNOBCloseISS() != true))
       return S_Not_80_90();
     end;

     if( (УчетУбытковВТечениеГода()) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS)) 
       if( (_SI < _SD) 
       and ((_I + _Proc_Sec_Change + GetSumNdrFrobOut(TXOBJ_PLUSG_1549)) > (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_227)))) 
         Sum1 = Min(((_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_227)) + (_SD - _SI )), (_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1549) + _Proc_Sec_Change));
       else
         Sum1 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1549) + _Proc_Sec_Change), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_227)));
       end;
     else
        Sum1 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1549)), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_227)));
     end;

     return Sum1;
   end;

   //84.  Расчёт для MinusG_201, MinusG_225, FullMinus_201, FullMinus_225:
   _SI = SI("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_CIRCULATE);
   _SD = SD("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_CIRCULATE);
   _I  = I ("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_CIRCULATE);
   _D  = D ("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_CIRCULATE);
   _D1 = D1("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_CIRCULATE);
   _Proc_Sec_Change = Proc_Sec_Change("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_CIRCULATE);

   _U  = U();

   if(NotCreateMinusG == false)
     vKind = IIF(pIIS, TXOBJ_MINUSG_225, TXOBJ_MINUSG_201);

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     G_201 = G_225();
     S = G_201 - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;

   vKind = IIF(pIIS, TXOBJ_FULLMINUS_225, TXOBJ_FULLMINUS_201);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   // FullMinus_201, FullMinus_225
   G_201 = S_Not_80_90();
   G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
   S = _U + _SD + Min(O1,(_I + _SI - Min(_I + _SI, _U + _SD))) + G_218 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_OUT,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Все расходы по обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;

   //85. Расчёт для MinusG_202, MinusG_226:
   _SI = SI("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
   _SD = SD("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
   _I  = I ("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
   _D  = D ("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
   _Proc_Sec_Change = Proc_Sec_Change("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);

   _U  = U();

   if(NotCreateMinusG == false)
     vKind = IIF(pIIS, TXOBJ_MINUSG_226, TXOBJ_MINUSG_202);

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     G_201 = G_226();
     S = G_201 - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по необращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;

   //86. Расчёт для MinusG_203, MinusG_227, FullMinus_203, FullMinus_227:
   _SI = SI("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_LOSTCIRCULATE);
   _SD = SD("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_LOSTCIRCULATE);
   _I  = I ("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_LOSTCIRCULATE);
   _D  = D ("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_LOSTCIRCULATE);
   _Proc_Sec_Change = Proc_Sec_Change("not in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_LOSTCIRCULATE);

   _U  = U();

   if(NotCreateMinusG == false)

     vKind = IIF(pIIS, TXOBJ_MINUSG_227, TXOBJ_MINUSG_203);

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     G_201 = G_227();
     S = G_201 - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по ц/б, потерявшим обращаемость" + IIF(pIIS, " (ИИС)", ""),
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;

   vKind = IIF(pIIS, TXOBJ_FULLMINUS_227, TXOBJ_FULLMINUS_203);

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = _U - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_OUT,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,
                          pContract,
                          "Все расходы по ц/б, потерявшим обращаемость" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;

   //87. Расчёт для MinusG_206, FullMinus_206:
   _SI = SI(" = "+TXGROUP_80, "= "+NPTX_FI_CIRCULATE);
   _I  = I(" = "+TXGROUP_80, "= "+NPTX_FI_CIRCULATE);
   _D  = D(" = "+TXGROUP_80, "= "+NPTX_FI_CIRCULATE);

   _U  = U();
   
   if(NotCreateMinusG == false)
     vKind = IIF(pIIS, TXOBJ_MINUSG_228, TXOBJ_MINUSG_206 );
     
     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
       S = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1546)), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_228))) - C1;
     else
       S = Min(_I, _U) - C1;
     end;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по обращающимся ПИ фондового рынка",
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;
   
   vKind = IIF(pIIS, TXOBJ_FULLMINUS_228, TXOBJ_FULLMINUS_206 );
   
   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = _U - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_OUT,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Все расходы по обращающимся ПИ фондового рынка",
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;


   //88.  Расчёт для MinusG_207, FullMinus_207:
   _SI = SI(" = "+TXGROUP_90, "= "+NPTX_FI_CIRCULATE);
   _I  = I(" = "+TXGROUP_90, "= "+NPTX_FI_CIRCULATE);
   _D  = D(" = "+TXGROUP_90, "= "+NPTX_FI_CIRCULATE);

   _U  = U();
        
   if(NotCreateMinusG == false)
     vKind = IIF(pIIS, TXOBJ_MINUSG_229, TXOBJ_MINUSG_207 );
     
     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
       S = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1548)), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_229))) - C1;
     else
       S = Min(_I, _U) - C1;
     end;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по обращающимся ПИ нефондового рынка",
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;

   vKind = IIF(pIIS, TXOBJ_FULLMINUS_229, TXOBJ_FULLMINUS_207 );
   
   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

   S = _U - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_OUT,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Все расходы по обращающимся ПИ нефондового рынка",
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;


   //89-96 ----------------------------------------------------------------------------------------------
   RI = GetRubSumByClient(pClient, string(TXOBJ_PROCREPOTAX), pBegDate, pEndDate, TXOBJ_DIR_IN, pIIS, null, WhereCondTransfObj);
   RD = GetRubSumByClient(pClient, string(TXOBJ_PROCREPOTAX), pBegDate, pEndDate, TXOBJ_DIR_OUT, pIIS, null, WhereCondTransfObj);

   /*плюс (рублевая сумма НДР вида <Com> по сделкам РЕПО, у которых максимальная из дат: фактической поставки по 2 части и фактической оплаты по 2 части входит в период расчета, и дата НДР после 31.12.2011)*/
   QueryCond =   "select NVL(sum(obj.t_Sum0),0) as S0 "
               + "  from dnptxobj_dbt obj, ddl_tick_dbt tick "                                                         
               + " where obj.t_Kind = ? "
               + "   and obj.t_AnaliticKind1 = ? "
               + "   and tick.t_DealID = obj.t_Analitic1 "
               + "   and obj.t_Date >= ? "
               + "   and obj.t_Date <= ? "
               + "   and obj.t_Direction = ? "
               + "   and obj.t_Client = ? "
               + "   and RSI_NPTO.CheckObjIIS ( ?, obj.t_Analitic6 ) = ? "
               + "   and rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "
               + "   and RSI_NPTX.CheckCateg(?, 23, LPAD(Tick.t_DealID, 34, '0'), 2)<>1 " //категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
               + "   and Tick.t_BOfficeKind = ? "
               + "   and (" + StrMaxFactDate2() + " between ? and ?) and " + WhereCondTransfObj;

   Query = DL_RSDCommand(QueryCond);
   Query.addParam( TXOBJ_COM );
   Query.addParam( TXOBJ_KIND1010 );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );
   Query.addParam( TXOBJ_DIR_OUT );
   Query.addParam( pClient );
   Query.addParam( TXOBJ_KIND6020 );
   Query.addParam( pIIS );
   Query.addParam( OBJTYPE_SECDEAL );
   Query.addParam( DL_SECURITYDOC );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   DataSet = Query.execute();
   
   if( DataSet.MoveNext() )
     RD = RD + Round(money(DataSet.S0));
   end;

   if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
     S = min(RI + GetSumNdrFrobOut(TXOBJ_PLUSG_1551), RD + GetSumNdrFrobOut(TXOBJ_FULLMINUS_230));
   else
     S = min(RI, RD);
   end;

   if(NotCreateMinusG == false)
     vKind = IIF(pIIS, TXOBJ_MINUSG_230, TXOBJ_MINUSG_211);

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     S = S - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по процентам РЕПО" + IIF(pIIS, " (ИИС)", ""),
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;

   //97.  Расчёт для MinusG_222, MinusG_239:

   if( (УчетУбытковВТечениеГода() or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)) and (NotCreateMinusG == false))
       vKind = IIF(pIIS, TXOBJ_MINUSG_239, TXOBJ_MINUSG_222);

      _I  = I (" not in ("+TXGROUP_80+","+TXGROUP_90+")", " in ("+NPTX_FI_CIRCULATE+")");
      _SI = SI(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " in ("+NPTX_FI_CIRCULATE+")");
      _SD = SD(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " in ("+NPTX_FI_CIRCULATE+")");
      _D  = D (" not in ("+TXGROUP_80+","+TXGROUP_90+")", " in ("+NPTX_FI_CIRCULATE+")");
      _D1 = D1(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " in ("+NPTX_FI_CIRCULATE+")");
      _Proc_Sec_Change = Proc_Sec_Change(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " in ("+NPTX_FI_CIRCULATE+")");

      _U  = U();

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
        G_218 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1544) + _Proc_Sec_Change) - G_225(), (_D1+ GetSumNdrFrobOut(TXOBJ_FULLMINUS_233)));
        S = min(O1, (_I+_Proc_Sec_Change + GetSumNdrFrobOut(TXOBJ_PLUSG_1544)) - (G_225() + G_218)) - C1;
      else
        G_201 = S_Not_80_90();
        G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
        G_222 = Min(O1, (_I+_Proc_Sec_Change) - (G_201 + G_218)); // O1 - NPTX_FI_CIRCULATE, NPTX_FI_LOSTCIRCULATE
        S = G_222 - C1;
      end;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Сумма превышения расходов над доходами по РЕПО в уменьшение НОБ по обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   //98.  Расчёт для  MinusG_223, MinusG_240:
  if( (УчетУбытковВТечениеГода() or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)) and (NotCreateMinusG == false))
       vKind = IIF(pIIS, TXOBJ_MINUSG_240, TXOBJ_MINUSG_223);
      _I  = I (" not in ("+TXGROUP_80+","+TXGROUP_90+")", " = "+NPTX_FI_NOCIRCULATE);
      _SI = SI(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " = "+NPTX_FI_NOCIRCULATE);
      _SD = SD(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " = "+NPTX_FI_NOCIRCULATE);
      _D  = D (" not in ("+TXGROUP_80+","+TXGROUP_90+")", " = "+NPTX_FI_NOCIRCULATE);
      _D1 = D1(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " = "+NPTX_FI_NOCIRCULATE);
      _Proc_Sec_Change = Proc_Sec_Change(" not in ("+TXGROUP_80+","+TXGROUP_90+")", " = "+NPTX_FI_NOCIRCULATE);

      _U  = U();

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
        G_201 = G_226() + G_227();
        G_218 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1545) + GetSumNdrFrobOut(TXOBJ_PLUSG_1549) + _Proc_Sec_Change) - G_201, (_D1 + GetSumNdrFrobOut(TXOBJ_FULLMINUS_234)));
        S = min(O2, (_I+_Proc_Sec_Change + GetSumNdrFrobOut(TXOBJ_PLUSG_1545)) - (G_226() + G_227() + G_218)) - C1;
      else
        G_201 = S_Not_80_90();
        G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
        G_222 = Min(O2, (_I+_Proc_Sec_Change) - (G_201 + G_218)); // O2 - NPTX_FI_NOCIRCULATE
        S = G_222 - C1;
      end;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Сумма превышения расходов над доходами по РЕПО в уменьшение НОБ по не обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   //99.  Расчёт для MinusG_213, MinusG_231:
   _I  = I("not in ("+TXGROUP_80+","+TXGROUP_90+")", null);
   _SI = SI("not in ("+TXGROUP_80+","+TXGROUP_90+")", null);
   _SD = SD("not in ("+TXGROUP_80+","+TXGROUP_90+")", null);
   _D  = D("not in ("+TXGROUP_80+","+TXGROUP_90+")", null);
   
   _U  = U();

   if(NotCreateMinusG == false)
     vKind = IIF(pIIS, TXOBJ_MINUSG_231, TXOBJ_MINUSG_213);

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
       if( (УчетУбытковВТечениеГода() or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR) or (pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS)) 
       and ((_SI + GetSumNdrFrobOut(TXOBJ_PLUSG_1553)) > (_SD + GetSumNdrFrobOut(TXOBJ_FULLMINUS_231)))
       and ((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1544+","+TXOBJ_PLUSG_1545+","+TXOBJ_PLUSG_1549)) < (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_225+","+TXOBJ_FULLMINUS_226+","+TXOBJ_FULLMINUS_227))) )

         S = Min((_SD + GetSumNdrFrobOut(TXOBJ_FULLMINUS_231)) + (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_225+","+TXOBJ_FULLMINUS_226+","+TXOBJ_FULLMINUS_227) - (_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1544+","+TXOBJ_PLUSG_1545+","+TXOBJ_PLUSG_1549))) + O1, _SI + GetSumNdrFrobOut(TXOBJ_PLUSG_1553)) - C1;
       else
         S = Min((_SI + GetSumNdrFrobOut(TXOBJ_PLUSG_1553)), (_SD + GetSumNdrFrobOut(TXOBJ_FULLMINUS_231))) - C1;
       end;
     else
       if( (УчетУбытковВТечениеГода() or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)) and (_SI > _SD) and (_I < _U) )
         S = Min(_SD + (_U - _I) + O1, _SI) - C1;
       else
         S = Min(_SI, _SD) - C1;
       end;
     end;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по коротким позициям по РЕПО" + IIF(pIIS, " (ИИС)", ""),
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;

   //100.   Расчёт для MinusG_214, MinusG_214_ИИС:
   if( (УчетУбытковВТечениеГода() or (pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)) and (NotCreateMinusG == false) )

      vKind = IIF(pIIS, TXOBJ_MINUSG_214_IIS, TXOBJ_MINUSG_214);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      S = 0 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             5,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Убытки по коротким позициям по РЕПО" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;                                                                  

   if(NotCreateMinusG == false)
     //101.   Расчёт для  MinusG_220:
     _I  = I("in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
     _SI = SI("in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
     _SD = SD("in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
     _D  = D("in ("+TXGROUP_80+","+TXGROUP_90+")", "= "+NPTX_FI_NOCIRCULATE);
     
     _U  = U();
   
     vKind =  IIF(pIIS, TXOBJ_MINUSG_235, TXOBJ_MINUSG_220 );

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
       S = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1547)), (_U + GetSumNdrFrobOut(TXOBJ_FULLMINUS_225))) - C1;
     else
       S = Min(_I, _U) - C1;
     end;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Расходы по необращающимся ПИ",
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;
   end;

   if(NotCreateMinusG == false)
     //102. Расчёт для MinusG_218, MinusG_233
       var str5 = " = " + TXGROUP_20 +
                     "          or ( " +
                     "                N.t_Date >= to_date('01.01.2021', 'dd.mm.yyyy') " +
                     "                and N.t_Analitic5  = " + string(TXGROUP_40) +
                     "             ) ";
       _SI = SI(str5, "= "+NPTX_FI_CIRCULATE);
       _SD = SD(str5, "= "+NPTX_FI_CIRCULATE);
       _I  = I (str5, "= "+NPTX_FI_CIRCULATE);
       _D  = D (str5, "= "+NPTX_FI_CIRCULATE);
       _D1 = D1(str5, "= "+NPTX_FI_CIRCULATE);
       _Proc_Sec_Change = Proc_Sec_Change(str5, "= "+NPTX_FI_CIRCULATE);

       _U  = U();

       vKind = IIF(pIIS, TXOBJ_MINUSG_233, TXOBJ_MINUSG_218);

       C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

       if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
         G_201 = S_Not_80_90();
         G_218 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1544) + _Proc_Sec_Change) - G_201, (_D1+ GetSumNdrFrobOut(TXOBJ_FULLMINUS_233)));
         S = G_218 - C1;
       else
         G_201 = S_Not_80_90();
         G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
         S = G_218 - C1;
       end;

       S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
       if ((stat == 0) and (S != 0))
          InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                              pClient,
                              TXOBJ_DIR_OUT,
                              5,
                              UNSET_CHAR,
                              vKind,
                              S,
                              NATCUR,
                              0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                              TXOBJ_KIND6020,                 
                              pContract,
                              "Процентный расход по коротким позициям по РЕПО (обращающиеся ц/б)" + IIF(pIIS, " (ИИС)", ""),
                              pDocID,
                              pStep,
                              0,
                              Oper.rec.Recalc,
                              NULL,
                              NULL,
                              NULL,
                              pTransfDate,
                              pTransfKind
                            );
       end;
     end;

     if(NotCreateMinusG == false)
     //103. Расчёт для MinusG_219, MinusG_234
       str5 = " = " + TXGROUP_20 +
                     "          or ( " +
                     "                N.t_Date >= to_date('01.01.2021', 'dd.mm.yyyy') " +
                     "                and N.t_Analitic5 = " + string(TXGROUP_40) +
                     "             ) ";

       _SI = SI(str5, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
       _SD = SD(str5, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
       _I  = I (str5, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
       _D  = D (str5, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
       _D1 = D1(str5, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
       _Proc_Sec_Change = Proc_Sec_Change(str5, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");

       _U  = U();

       vKind = IIF(pIIS, TXOBJ_MINUSG_234, TXOBJ_MINUSG_219);

       C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null,pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

       if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())
         G_201 = S_Not_80_90();
         G_218 = Min((_I + GetSumNdrFrobOut(TXOBJ_PLUSG_1545) + GetSumNdrFrobOut(TXOBJ_PLUSG_1549) + _Proc_Sec_Change) - G_201, (_D1+ GetSumNdrFrobOut(TXOBJ_FULLMINUS_234)));
         S = G_218 - C1;
       else
         G_201 = S_Not_80_90();
         G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
         S = G_218 - C1;
       end;

       S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
       if ((stat == 0) and (S != 0))
          InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                              pClient,
                              TXOBJ_DIR_OUT,
                              5,
                              UNSET_CHAR,
                              vKind,
                              S,
                              NATCUR,
                              0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                              TXOBJ_KIND6020,                 
                              pContract,
                              "Процентный расход по коротким позициям по РЕПО (не обращающиеся ц/б)" + IIF(pIIS, " (ИИС)", ""),
                              pDocID,
                              pStep,
                              0,
                              Oper.rec.Recalc,
                              NULL,
                              NULL,
                              NULL,
                              pTransfDate,
                              pTransfKind
                            );
       end;
    end;

   //104. Расчёт для Minus9_218, Minus9_233
   if(IsPartyResident() and (NotCreateMinusG == false))
     _SI = SI(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _SD = SD(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _I  = I (" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _D  = D (" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _D1 = D1(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _Proc_Sec_Change = Proc_Sec_Change(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);

     _U  = U();

     vKind = IIF(pIIS, TXOBJ_MINUS9_233, TXOBJ_MINUS9_218);

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     G_201 = S_Not_80_90();
     G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
     S = G_218 - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Процентный расход по коротким позициям по РЕПО (обращающиеся ипотечные облигации) для резидентов" + IIF(pIIS, " (ИИС)", ""),
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;

   end;

   //105. Расчёт для Minus9_219, Minus9_234:
   if(IsPartyResident() and (NotCreateMinusG == false))
     _SI = SI(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _SD = SD(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _I  = I (" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _D  = D (" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _D1 = D1(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _Proc_Sec_Change = Proc_Sec_Change(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");

     _U  = U();

     vKind = IIF(pIIS, TXOBJ_MINUS9_234, TXOBJ_MINUS9_219);

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     G_201 = S_Not_80_90();
     G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
     S = G_218 - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Процентный расход по коротким позициям по РЕПО (не обращающиеся ипотечные облигации) для резидентов" + IIF(pIIS, " (ИИС)", ""),
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;

   end;

   //106. Расчёт для MinusG_218_1:
   if( (not IsPartyResident()) and (pIIS == 0) and (NotCreateMinusG == false))
     _SI = SI(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _SD = SD(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _I  = I (" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _D  = D (" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _D1 = D1(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);
     _Proc_Sec_Change = Proc_Sec_Change(" = "+TXGROUP_30, "= "+NPTX_FI_CIRCULATE);

     _U  = U();

     vKind = TXOBJ_MINUSG_218_1;

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     G_201 = S_Not_80_90();
     G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
     S = G_218 - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Процентный расход  по коротким позициям по РЕПО (обращающиеся ипотечные облигации) для нерезидентов ",
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;

   end;


   //107. Расчёт для MinusG_219_1:
   if( (not IsPartyResident()) and (pIIS == 0) and (NotCreateMinusG == false))
     _SI = SI(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _SD = SD(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _I  = I (" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _D  = D (" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _D1 = D1(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");
     _Proc_Sec_Change = Proc_Sec_Change(" = "+TXGROUP_30, " in ("+NPTX_FI_NOCIRCULATE+","+NPTX_FI_LOSTCIRCULATE+")");

     _U  = U();

     vKind = TXOBJ_MINUSG_219_1;

     C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

     G_201 = S_Not_80_90();
     G_218 = Min((_I+_Proc_Sec_Change) - G_201, _D1);
     S = G_218 - C1;

     S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
     if ((stat == 0) and (S != 0))
        InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                            pClient,
                            TXOBJ_DIR_OUT,
                            5,
                            UNSET_CHAR,
                            vKind,
                            S,
                            NATCUR,
                            0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                            TXOBJ_KIND6020,                 
                            pContract,
                            "Процентный расход  по коротким позициям по РЕПО (не обращающиеся ипотечные облигации) для нерезидентов",
                            pDocID,
                            pStep,
                            0,
                            Oper.rec.Recalc,
                            NULL,
                            NULL,
                            NULL,
                            pTransfDate,
                            pTransfKind
                          );
     end;

   end;

   //108. Расчёт для FullMinus_618:
   if( pIIS == 0 )
      C1 = GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_618), pBegDate, pEndDate, null, pIIS, null, (NotUserWhereCond5 + "and" + WhereCondTransfObj));

      S = GetRubSumByClient(pClient, string(TXOBJ_FR_SEC_3Y), pBegDate, pEndDate, null, pIIS, null, WhereCondTransfObj);

      S = S - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, TXOBJ_FULLMINUS_618, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             5,
                             UNSET_CHAR,
                             TXOBJ_FULLMINUS_618,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Полный инвестиционный вычет по ц/б в собственности более 3-х лет",
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   return stat;
END;

MACRO CreateTaxObjectsIIS5(Oper:TRecHandler/*NPTXOP*/, pStep)
  stat = 0;
  var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
  var Contracts = "( ", wasContr = false, sfcontr = 0;
  
  stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);
    
  if(stat)
    MsgBox("Ошибка определения типа ИИС");
    return 1;
  end;

  var queryContr, cmdContr, DataSetContr;

  queryContr = "SELECT MP.T_SFCONTRID, CASE WHEN SF.T_NUMBER LIKE '%_ф' THEN 1 ELSE 0 END as mmvb, " +
               "       CASE WHEN SF.t_dateclose = TO_DATE ('01010001', 'ddmmyyyy') THEN TO_DATE ('31129999', 'ddmmyyyy') ELSE SF.t_dateclose END t_dateclose, " +
               "       SF.t_datebegin " +
               "  FROM DDLCONTRMP_DBT MP, DSFCONTR_DBT SF " +
               " WHERE MP.T_DLCONTRID = ? AND SF.T_ID = MP.T_SFCONTRID " +
               " UNION " +
               "SELECT DL.T_SFCONTRID, 0 as mmvb, TO_DATE ('01010001', 'ddmmyyyy') t_dateclose, TO_DATE ('31129999', 'ddmmyyyy') t_datebegin FROM DDLCONTR_DBT DL " + 
               " WHERE DL.T_DLCONTRID = ?"
               " ORDER BY t_dateclose DESC, t_datebegin ASC ";

  cmdContr = DL_RSDCommand(queryContr);
  cmdContr.AddParam(Oper.rec.Contract);
  cmdContr.AddParam(Oper.rec.Contract);

  DataSetContr = cmdContr.Execute();

  while(DataSetContr.moveNext())
    if(wasContr)
      Contracts = Contracts + ", " + DataSetContr.SFCONTRID;
    else
      Contracts = Contracts + DataSetContr.SFCONTRID;
      sfcontr = DataSetContr.SFCONTRID;
    end;
    if(DataSetContr.mmvb == 1)
      sfcontr = DataSetContr.SFCONTRID;
    end;
    wasContr = true;
  end;
  
  if(wasContr)
    Contracts = Contracts + " ) ";
    if( (TypeIIS == IISTYPEA) or 
        (TypeIIS == IISTYPEC)
      )
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, NULL, NULL, sfcontr, Contracts);
    elif((TypeIIS == IISTYPEB) or 
         (TypeIIS == IISTYPEG)
        )
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, NULL, NULL, sfcontr, Contracts);
    elif(TypeIIS == IISTYPED)
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 1, sfcontr, Contracts);
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 2, sfcontr, Contracts);
    elif(TypeIIS == IISTYPEE)
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 1, sfcontr, Contracts);
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 2, sfcontr, Contracts);
    elif(TypeIIS == IISTYPEF)
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 1, sfcontr, Contracts);
      stat = CreateTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 2, sfcontr, Contracts);
    end;
  end;

  return stat;
END;

MACRO CreateMaterialTaxObjects5(Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate, vTypeIIS, vTransfDate, vTransfKind, vContract, vContracts)
   var S, S1, S2, vKind;
   var WhereCondTransfObj = " 1=1 ";
   var WhereCondTransfN = " ";
   var TaxTeriodToLucre = 0, TaxPeriod = 0;
   stat = 0;

   ОпределитьПараметрыРасчета(Oper);
   GetBegDate(Oper, true);
   pDateNDR = ZeroDate;
   
   if( (vBegDate!=null) AND (vEndDate!=null) )
     pBegDate = vBegDate;
     pEndDate = vEndDate;
   end;

   if( (vTransfDate!=null) AND (vTransfKind!=null) )
     pTransfDate = vTransfDate;
     pTransfKind = vTransfKind;
   end;

   datesplit(pEndDate, null, null, TaxPeriod);

   TaxTeriodToLucre = CheckTaxTeriodToLucre(TaxPeriod);

   if(vTypeIIS!=null)
     pContract = vContract;
     pDateNDR = Oper.rec.OperDate;
     WhereCondTransfObj = " obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 +
                          " and obj.t_Analitic6 in " + vContracts + " and obj.t_transfkind = " + pTransfKind + " ";
     WhereCondTransfN = " and N.t_AnaliticKind6 = " + TXOBJ_KIND6020 +
                        " and N.t_Analitic6 in " + vContracts + " and N.t_transfkind = " + pTransfKind + " ";
   end;

   QuerySelect = "select NVL(sum(N.t_Sum0), 0) S2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 "   and N.t_Kind = " + string(TXOBJ_MATERIAL_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_80) +
                 "   and N.t_Analitic5 <> " + string(TXGROUP_90) +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) + WhereCondTransfN;
                 
   Query = DL_RSDCommand();
   Query.addParam( pClient );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   if(TaxTeriodToLucre == false)
     QueryCond = QueryCond + "   AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? ";
     Query.addParam( pIIS );
   end;

   DataSet = Query.execute(QuerySelect + QueryCond);

   if( (stat == 0) and DataSet.MoveNext() )
      S2 = DataSet.S2;
   end;

   vKind = IIF(pIIS, TXOBJ_PLUSG_2640_IIS, TXOBJ_PLUSG_2640);

   S1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, true, NotUserWhereCond5 + "and" + WhereCondTransfObj);

   S = S2 - S1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Материальная выгода по ц/б" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;


   QuerySelect = "select NVL(sum(N.t_Sum0), 0) S2 ";

   QueryCond =   "  from dnptxobj_dbt N " +
                 " where N.t_Client = ? " +
                 "   and N.t_Kind = " + string(TXOBJ_MATERIAL_SEC) +
                 "   and N.t_Date >= ? " +
                 "   and N.t_Date <= ? " +
                 "   and (N.t_Analitic5 = " + string(TXGROUP_80) +
                 "    or  N.t_Analitic5 = " + string(TXGROUP_90) + ") " +
                 "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) + WhereCondTransfN;
                 
   Query = DL_RSDCommand();
   Query.addParam( pClient );
   Query.addParam( pBegDate );
   Query.addParam( pEndDate );

   if(TaxTeriodToLucre == false)
     QueryCond = QueryCond + "   AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 )  = ? ";
     Query.addParam( pIIS );
   end;

   DataSet = Query.execute(QuerySelect + QueryCond);

   if( (stat == 0) and DataSet.MoveNext() )
      S2 = DataSet.S2;
   end;
   
   vKind = IIF(pIIS, TXOBJ_PLUSG_2641_IIS, TXOBJ_PLUSG_2641);
   
   S1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, true, NotUserWhereCond5 + "and" + WhereCondTransfObj);

   S = S2 - S1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                          pClient,
                          TXOBJ_DIR_IN,
                          5,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Материальная выгода по ПИ",
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc,
                          NULL,
                          NULL,
                          NULL,
                          pTransfDate,
                          pTransfKind
                        );
   end;

   if(not stat)
     stat = CorrectTechnicalInObjTMP(pDocID, pStep, 5);
   end;

   return stat;
END;

MACRO CreateMaterialTaxObjectsIIS5(Oper:TRecHandler/*NPTXOP*/, pStep)
  stat = 0;
  var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
  var Contracts = "( ", wasContr = false, sfcontr = 0;
  
  stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);

  if(stat)
    MsgBox("Ошибка определения типа ИИС");
    return 1;
  end;

  var queryContr, cmdContr, DataSetContr;

  queryContr = "SELECT MP.T_SFCONTRID, CASE WHEN SF.T_NUMBER LIKE '%_ф' THEN 1 ELSE 0 END as mmvb, " +
               "       CASE WHEN SF.t_dateclose = TO_DATE ('01010001', 'ddmmyyyy') THEN TO_DATE ('31129999', 'ddmmyyyy') ELSE SF.t_dateclose END t_dateclose, " +
               "       SF.t_datebegin " +
               "  FROM DDLCONTRMP_DBT MP, DSFCONTR_DBT SF " +
               " WHERE MP.T_DLCONTRID = ? AND SF.T_ID = MP.T_SFCONTRID " +
               " UNION " +
               "SELECT DL.T_SFCONTRID, 0 as mmvb, TO_DATE ('01010001', 'ddmmyyyy') t_dateclose, TO_DATE ('31129999', 'ddmmyyyy') t_datebegin FROM DDLCONTR_DBT DL " + 
               " WHERE DL.T_DLCONTRID = ?"
               " ORDER BY t_dateclose DESC, t_datebegin ASC ";

  cmdContr = DL_RSDCommand(queryContr);
  cmdContr.AddParam(Oper.rec.Contract);
  cmdContr.AddParam(Oper.rec.Contract);

  DataSetContr = cmdContr.Execute();

  while(DataSetContr.moveNext())
    if(wasContr)
      Contracts = Contracts + ", " + DataSetContr.SFCONTRID;
    else
      Contracts = Contracts + DataSetContr.SFCONTRID;
      sfcontr = DataSetContr.SFCONTRID;
    end;
    if(DataSetContr.mmvb == 1)
      sfcontr = DataSetContr.SFCONTRID;
    end;
    wasContr = true;
  end;
  
  if(wasContr)
    Contracts = Contracts + " ) ";
    if( (TypeIIS == IISTYPEA) or 
        (TypeIIS == IISTYPEC)
      )
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, NULL, NULL, sfcontr, Contracts);
    elif((TypeIIS == IISTYPEB) or 
         (TypeIIS == IISTYPEG)
        )
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, NULL, NULL, sfcontr, Contracts);
    elif(TypeIIS == IISTYPED)
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 1, sfcontr, Contracts);
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 2, sfcontr, Contracts);
    elif(TypeIIS == IISTYPEE)
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 1, sfcontr, Contracts);
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 2, sfcontr, Contracts);
    elif(TypeIIS == IISTYPEF)
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 1, sfcontr, Contracts);
      stat = CreateMaterialTaxObjects5(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 2, sfcontr, Contracts);
    end;
  end;

END;

//////////////////////////////////////////////////////////////////
//НДР 6  
//////////////////////////////////////////////////////////////////
/**
  @brief Рассчет НДР 6-го уровня
  @param [in] Oper Объект TRecHandler операции (NPTXOP)
  @param [in] pStep Номер шага
  @param [in] vBegDate Дата начала периода
  @param [in] vEndDate Дата окончания периода
  @param [in] vTypeIIS Тип договора ИИС
  @param [in] vTransfDate Дата трансформации
  @param [in] vTransfKind Период расчета (До\После)
  @param [in] vContract Договор sfcontr по которому создаются НДР
  @param [in] vContracts Договора sfcontr для отбора НДР (строка вида "(1,2)")
*/
MACRO CreateTaxObjects6(Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate, vTypeIIS, vTransfDate, vTransfKind, vContract, vContracts)
   var FRобрцб, FRпцб, FRфПИ, FRнПИ, FR_ПИ, C2, C1, S, vKind;
   var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
   var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
   var WhereCondTransfObj = " 1=1 ";
   
   stat = 0;

   ОпределитьПараметрыРасчета(Oper);
   GetBegDate(Oper, true);
   pDateNDR = ZeroDate;

   if( (vBegDate!=null) AND (vEndDate!=null) )
     pBegDate = vBegDate;
     pEndDate = vEndDate;
   end;

   if( (vTransfDate!=null) AND (vTransfKind!=null) )
     pTransfDate = vTransfDate;
     pTransfKind = vTransfKind;
   end;

   if(vTypeIIS!=null)
     pContract = vContract;
     pDateNDR = Oper.rec.OperDate;
     WhereCondTransfObj = " obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 +
                          " and obj.t_Analitic6 in " + vContracts + " and obj.t_transfkind = " + pTransfKind + " ";
   end;

   //п.1-4 ----------------------------------------------------------------------------------------------
   if( pIIS == 0 )
      FRобрцб = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1530   ), pBegDate, pEndDate, null, pIIS) +
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1539 ),   pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut) + 
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1011_1 ), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut) +
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_3023 ),   pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_201), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut);
     
      FRпцб   = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1536   ), pBegDate, pEndDate, null, pIIS) + 
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1011_2 ), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_203), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut);
     
      FRфПИ   = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1532   ), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_206), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut);
     
      FRнПИ   = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1535   ), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_207), pBegDate, pEndDate, null, pIIS, NULL, AddWhereNotOut);
   else
      FRобрцб = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1544   ),     pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) +
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1553 ),       pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) + 
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1011_1_IIS ), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) +
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_3023_IIS ),   pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_225),     pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj));
     
      FRпцб   = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1549   ),     pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) + 
                GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1011_2_IIS ), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_227),     pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj));
     
      FRфПИ   = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1546   ), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_228), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj));
     
      FRнПИ   = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1548   ), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj)) - 
                GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_229), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondTransfObj));
   end;

   FR_ПИ   = FRфПИ + FRнПИ;

   if( (FRобрцб < 0) and (FRфПИ + min(0, FRнПИ) > 0) and 
       ((pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR) or ((pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())) )

      vKind = IIF(pIIS, TXOBJ_MINUSG_250, TXOBJ_MINUSG_205);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondTransfObj));

      C2 = min(Abs(FRобрцб), FRфПИ + min(0, FRнПИ));
      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             6,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Убытки по обращающимся ц/б, уменьшающие НБ по обращающимся ПИ фондового рынка" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   if( (FRобрцб < 0) and (FRпцб > 0) and 
       ((pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)  or ((pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())) )
      vKind = IIF(pIIS, TXOBJ_MINUSG_236, TXOBJ_MINUSG_224);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondTransfObj));


      if( (FRобрцб < 0) and (FRфПИ + min(0, FRнПИ) > 0) and 
          ((pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR) or ((pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())) )
        C2 = min(Abs(FRобрцб)-Min(abs(FRобрцб), (FRфПИ + min(0, FRнПИ))), FRпцб);
      else
        C2 = min(abs(FRобрцб), FRпцб);
      end;

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             6,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Убытки по обращающимся ц/б, уменьшающие НБ по потерявшим обращаемость ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   if( (FRфПИ < 0) and (FRнПИ > 0) and 
       ((pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)  or ((pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())) )

      vKind = IIF(pIIS, TXOBJ_MINUSG_241, TXOBJ_MINUSG_210);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondTransfObj));

      C2 = min(Abs(FRфПИ), FRнПИ);
      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             6,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Убытки по обращающимся ПИ фондового рынка, уменьшающие НБ по обращающимся ПИ" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   if( (FRфПИ < 0) and (FR_ПИ < 0) and ((FRобрцб + min(0, FRпцб)) > 0) and 
       ((pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)  or ((pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())) )

      vKind = IIF(pIIS, TXOBJ_MINUSG_251, TXOBJ_MINUSG_208);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondTransfObj));

      C2 = min( min(Abs(FRфПИ), Abs(FR_ПИ)), 
                FRобрцб + min(0, FRпцб)
              );

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             6,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Убытки по обращающимся ПИ фондового рынка, уменьшающие НБ по обращающимся ц/б" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   if( (FRнПИ < 0) and (FRфПИ > 0) and 
       ((pSubKindOperation == DL_TXBASECALC_OPTYPE_ENDYEAR)  or ((pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS())) )

      vKind = IIF(pIIS, TXOBJ_MINUSG_252, TXOBJ_MINUSG_209);

      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondTransfObj));

      C2 = min(Abs(FRнПИ), FRфПИ);
      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc, pTransfKind);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( IIF(pDateNDR == ZeroDate, pEndDate, pDateNDR),
                             pClient,
                             TXOBJ_DIR_OUT,
                             6,
                             UNSET_CHAR,
                             vKind,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,                 
                             pContract,
                             "Убытки по обращающимся ПИ не-фондового рынка, уменьшающие НБ по обращающимся ПИ" + IIF(pIIS, " (ИИС)", ""),
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc,
                             NULL,
                             NULL,
                             NULL,
                             pTransfDate,
                             pTransfKind
                           );
      end;
   end;

   //12. Вычисление Limit_618

   if( pIIS == 0 )
      var Sumi, AllSumi, КЦБ;
      var query, cmd, DataSet;

      cmd = DL_RSDCOmmand();

      query =   " select NVL(SUM(obj.t_Sum0), 0) as AllSumi, NVL(SUM(obj.t_Sum0*obj.t_Holding_Period), 0) as Sumi"
              + "   from dnptxobj_dbt obj "
              + "  where obj.t_Client = " + cmd.AddParam(pClient)
              + "    and obj.t_Kind = " + TXOBJ_PLUSI
              + "    and obj.t_Date between "+cmd.AddParam(pBegDate)+" and "+cmd.AddParam(pEndDate)
              + "    and RSI_NPTO.CheckObjIIS ( " + TXOBJ_KIND6020 + ", obj.t_Analitic6 ) = 0 "
              + "    and " + AddWhereNotOut;

      DataSet = cmd.Execute(query);
      if(DataSet.moveNext())
        Sumi    = DataSet.Sumi;
        AllSumi = DataSet.AllSumi;
      end;

      if( AllSumi != 0 )
         КЦБ = Round( (Sumi / AllSumi), ТочностьКЦБ(), 1);
         C2 = 3000000 * КЦБ;
      else
         C2 = 0;
      end;

      C1   = GetRubSumByClient(pClient, string(TXOBJ_LIMIT_618), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond);

      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pClient, TXOBJ_LIMIT_618, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);

      S = round(money(S), 2);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( pEndDate,
                             pClient,
                             TXOBJ_DIR_OUT,
                             6,
                             UNSET_CHAR,
                             TXOBJ_LIMIT_618,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Предельное значение инвестиционного вычета по ц/б в собственности более 3-х лет",
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc
                           );
      end;
   end;

   if(not stat)
     stat = CorrectTechnicalInObjTMP(pDocID, pStep, 6);
   end;

   return stat;
END;

MACRO CreateTaxObjectsIIS6(Oper:TRecHandler/*NPTXOP*/, pStep)  
  stat = 0;
  var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
  var Contracts = "( ", wasContr = false, sfcontr = 0;
  
  stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);
    
  if(stat)
    MsgBox("Ошибка определения типа ИИС");
    return 1;
  end;

  var queryContr, cmdContr, DataSetContr;

  queryContr = "SELECT MP.T_SFCONTRID, CASE WHEN SF.T_NUMBER LIKE '%_ф' THEN 1 ELSE 0 END as mmvb, " +
               "       CASE WHEN SF.t_dateclose = TO_DATE ('01010001', 'ddmmyyyy') THEN TO_DATE ('31129999', 'ddmmyyyy') ELSE SF.t_dateclose END t_dateclose, " +
               "       SF.t_datebegin " +
               "  FROM DDLCONTRMP_DBT MP, DSFCONTR_DBT SF " +
               " WHERE MP.T_DLCONTRID = ? AND SF.T_ID = MP.T_SFCONTRID " +
               " UNION " +
               "SELECT DL.T_SFCONTRID, 0 as mmvb, TO_DATE ('01010001', 'ddmmyyyy') t_dateclose, TO_DATE ('31129999', 'ddmmyyyy') t_datebegin FROM DDLCONTR_DBT DL " + 
               " WHERE DL.T_DLCONTRID = ?"
               " ORDER BY t_dateclose DESC, t_datebegin ASC ";

  cmdContr = DL_RSDCommand(queryContr);
  cmdContr.AddParam(Oper.rec.Contract);
  cmdContr.AddParam(Oper.rec.Contract);

  DataSetContr = cmdContr.Execute();

  while(DataSetContr.moveNext())
    if(wasContr)
      Contracts = Contracts + ", " + DataSetContr.SFCONTRID;
    else
      Contracts = Contracts + DataSetContr.SFCONTRID;
      sfcontr = DataSetContr.SFCONTRID;
    end;
    if(DataSetContr.mmvb == 1)
      sfcontr = DataSetContr.SFCONTRID;
    end;
    wasContr = true;
  end;
  
  if(wasContr)
    Contracts = Contracts + " ) ";
    if( (TypeIIS == IISTYPEA) or 
        (TypeIIS == IISTYPEB) or
        (TypeIIS == IISTYPEC) or
        (TypeIIS == IISTYPEG)
      )
      stat = CreateTaxObjects6(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, NULL, NULL, sfcontr, Contracts);
    elif( (TypeIIS == IISTYPED) or 
          (TypeIIS == IISTYPEE) or 
          (TypeIIS == IISTYPEF)
        )
      stat = CreateTaxObjects6(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 1, sfcontr, Contracts);
      stat = CreateTaxObjects6(Oper, pStep, iisDateBegin, iisDateEnd, TypeIIS, Dtransf, 2, sfcontr, Contracts);
    end;
  end;

  return stat;
END;

MACRO GetPrevContr(open_date):TRecHandler
  var sfcontr = TRecHandler("SFCONTR.DBT");
  var begin_date, end_date;
  var query;
  var cmd;
  var data_set;

  query = "SELECT * FROM DSFCONTR_DBT t " +
          " WHERE t.t_PartyID = ? " + 
          "   AND t.t_DateClose < ? " +
          "   AND t.t_DateClose <> TO_DATE('01-01-0001','DD-MM-YYYY') " +
          "   AND RSI_NPTO.CheckContrIIS(t.t_ID) = 1 " +
          "ORDER BY t.t_DateClose DESC";
  cmd = DL_RSDCommand(query);
  cmd.addParam(pClient);
  cmd.addParam(open_date);
  data_set = cmd.Execute();
  
  if (data_set.MoveNext())
    data_set.GetRecord().CopyTo(sfcontr.rec);
  else 
    sfcontr = null;
  end;
  
  return sfcontr;
end;

//////////////////////////////////////////////////////////////////
//НДР 7 
//////////////////////////////////////////////////////////////////
/**
  @brief Рассчет НДР 7-го уровня
  @param [in] Oper Объект TRecHandler операции (NPTXOP)
  @param [in] pStep Номер шага
  @param [in] vBegDate Дата начала периода
  @param [in] vEndDate Дата окончания периода
  @param [in] vContract Договор sfcontr по которому создаются НДР
  @param [in] vContracts Договора sfcontr для отбора НДР (строка вида "(1,2)")
*/
MACRO CreateTaxObjects7( Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate, vContract, vContracts )
  var BG = 0, C2, C1, S = $0, Sum_Limit_618 = $0, Sum_FullMinus_618 = $0, MG_618 = $0, BG2_WithoutFullMinus_618 = $0, vKind, MinusG_618 = 0;
  var BG1 = $0, BG2 = $0, BG3 = $0, BG4 = $0, BG5 = $0, BG6 = $0, BG7 = $0, BG8 = $0, BG9 = $0;
  var S1 = $0, S2 = $0, S3 = $0, S4 = $0, S5 = $0, S6 = $0, S7 = $0, S8 = $0, S9 = 0;
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var i = 0;
   stat = 0;
  var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate, IsClientResident;
  var WhereCondContract = " 1=1 ";
  var WhereCondTransf = " ";
  var TaxTeriodToLucre, TaxPeriod, isTaxPeriod2981;


  private macro GetObjKindStr(TaxBaseKind:integer, IsIncome:bool):string
    var query, cmd, DataSet;
    var str = "";

    query =   " select t_Element "
            + "   from dnptxkind_dbt "
            + "  where t_Level < 7 "
            + "    and t_TaxBaseKind = ? ";

    if(IsIncome == true)
      query = query + " and t_Income = 'X' and t_Expenditure = CHR(0) ";
    else
      query = query + " and t_Income = CHR(0) and t_Expenditure = 'X' ";
    end;

    cmd = DL_RSDCommand(query);

    cmd.AddParam(TaxBaseKind);
    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      if(str == "")
        str = string(int(DataSet.Element));
      else
        str = str + ","+ string(int(DataSet.Element));
      end;
    end;

    if((TaxTeriodToLucre == false) and (IsIncome == true) and (TaxBaseKind == 2))
      if(str != "")
        str = str + ",";
      end;

      str = str + string(TXOBJ_PLUSG_2640) + "," + string(TXOBJ_PLUSG_2641);
    end;

    if((isTaxPeriod2981 == false) and (TaxBaseKind == 2))
      str = StrSubst(str, ("," + string(TXOBJ_PLUSG_2800)), " ");
      str = StrSubst(str, (string(TXOBJ_PLUSG_2800) + ","), " ");
    elif((isTaxPeriod2981 == false) and (TaxBaseKind == 9) and IsIncome)
      if(str != "")
        str = str + ",";
      end;
      str = str + string(TXOBJ_PLUSG_2800);
    end;
    
    if(str == "")
      str = "0";
    end;

    return str;
  end;

  private macro GetBG(ObjKind, CalcBG:@money)
    var BGi = $0;
    var query, cmd, DataSet;

    CalcBG = $0;

    query = "select t_TaxBaseKind from dnptxkind_dbt where t_Element = ?";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(ObjKind);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      BGi =  GetRubSumByClient(pClient, GetObjKindStr(int(DataSet.TaxBaseKind), true), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondContract))
           - GetRubSumByClient(pClient, GetObjKindStr(int(DataSet.TaxBaseKind), false), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondContract));

      CalcBG = BGi;
      
      BGi = MAX(BGi, 0);
    end;

    return BGi;
  end;

  private macro GetTransfBG(ObjKind, TransfKind)
    var BGi = $0;
    var query, cmd, DataSet;

    query = "select t_TaxBaseKind from dnptxkind_dbt where t_Element = ?";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(ObjKind);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      BGi =  GetRubSumByClient(pClient, GetObjKindStr(int(DataSet.TaxBaseKind), true), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondContract + " and obj.t_transfkind = " + TransfKind + " "))
           - GetRubSumByClient(pClient, GetObjKindStr(int(DataSet.TaxBaseKind), false), pBegDate, pEndDate, null, pIIS, NULL, (AddWhereNotOut + " and " + WhereCondContract + " and obj.t_transfkind = " + TransfKind + " "));

      BGi = MAX(BGi, 0);
    end;

    return BGi;
  end;

  private macro CreateTxObjBG(Si, ObjKind)
    Si = Si + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, ObjKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);
    if((Si != NULL) and (Si != 0))
      InsertTaxObjectTmp(pEndDate,
                         pClient,
                         TXOBJ_DIR_IN,
                         7,
                         UNSET_CHAR,
                         ObjKind,
                         Si,
                         NATCUR,
                         0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                         TXOBJ_KIND6020,                 
                         pContract,
                         "Налогооблагаемая база по общей ставке" + IIF(pIIS, " (ИИС)", ""),
                         pDocID,
                         pStep,
                         0,
                         Oper.rec.Recalc);
    end;
  end;

   ОпределитьПараметрыРасчета(Oper);
   GetBegDate(Oper, true);

   if( (vBegDate!=null) AND (vEndDate!=null) )
     pBegDate = vBegDate;
     pEndDate = vEndDate;
   end;

  if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
    stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);
    
    if(stat)
      MsgBox("Ошибка определения типа ИИС");
      return 1;
    end;

    pContract = vContract;
    
    IsClientResident = STB_IsResidentStatusRSI(pClient, pEndDate);

    pBegDate = iisDateBegin;
    pEndDate = iisDateEnd;

    WhereCondContract = " obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 +
                        " and obj.t_Analitic6 in " + vContracts + " ";
  end;

  datesplit(pEndDate, null, null, TaxPeriod);
  TaxTeriodToLucre = CheckTaxTeriodToLucre(TaxPeriod);
  isTaxPeriod2981 = (TaxPeriod >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981());

  if((pEndDate >= date(1,1,2021)) and (IsPartyResident()))
    vKind = TXOBJ_BASEGENERAL;
    if(pIIS != 0)
      vKind = TXOBJ_BASEGENERAL_IIS;
    end;

    if(pIIS != 0)
      if((TypeIIS == IISTYPED) or
         (TypeIIS == IISTYPEE) or
         (TypeIIS == IISTYPEF))
        BG5 = GetTransfBG(TXOBJ_BASEG5, 1)
      else
        BG5 = GetBG(TXOBJ_BASEG5);
      end;
      S5  = BG5 - GetRubSumByClient(pClient, string(TXOBJ_BASEG5), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondContract));
    else
      BG1 = GetBG(TXOBJ_BASEG1); 
      S1  = BG1 - GetRubSumByClient(pClient, string(TXOBJ_BASEG1), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond);

      MG_618 = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1530), pBegDate, pEndDate, null, pIIS,null," (obj.t_FromOutSyst = CHR(0) or obj.t_FromOutSyst IS NULL) and (obj.t_OutSystCode = CHR(1) or obj.t_OutSystCode IS NULL)")
             - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_201), pBegDate, pEndDate, null, pIIS)
             - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_208), pBegDate, pEndDate, null, pIIS)
             - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_214), pBegDate, pEndDate, null, pIIS)
             - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_218), pBegDate, pEndDate, null, pIIS)
             - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_222), pBegDate, pEndDate, null, pIIS);

      MG_618            = Max(MG_618, $0);
      Sum_Limit_618     = GetRubSumByClient(pClient, string(TXOBJ_LIMIT_618), pBegDate, pEndDate, null, pIIS);
      Sum_FullMinus_618 = GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_618), pBegDate, pEndDate, null, pIIS);

      var CalcBG2 = $0;

      BG2 = GetBG(TXOBJ_BASEG2, @CalcBG2);
      if(DL_InsertNPTXVAL(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_CALCBG2, date(0,0,0), time(0), CalcBG2, 0) != 0)
        return Error( "Ошибка при сохранении значения СНОБ" );
      end;

      BG2 = BG2 - Min(Min(Sum_Limit_618, MG_618), Sum_FullMinus_618);
      S2  = BG2 - GetRubSumByClient(pClient, string(TXOBJ_BASEG2), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond) - MinusG_618;

      BG3 = GetBG(TXOBJ_BASEG3);
      S3  = BG3 - GetRubSumByClient(pClient, string(TXOBJ_BASEG3), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond);
      
      BG4 = GetBG(TXOBJ_BASEG4);
      S4  = BG4 - GetRubSumByClient(pClient, string(TXOBJ_BASEG4), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond);
      
      BG6 = GetBG(TXOBJ_BASEG6);
      S6  = BG6 - GetRubSumByClient(pClient, string(TXOBJ_BASEG6), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond);
      
      BG7 = GetBG(TXOBJ_BASEG7);
      S7  = BG7 - GetRubSumByClient(pClient, string(TXOBJ_BASEG7), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond);
      
      BG8 = GetBG(TXOBJ_BASEG8); 
      S8  = BG8 - GetRubSumByClient(pClient, string(TXOBJ_BASEG8), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond);

      BG9 = GetBG(TXOBJ_BASEG9);
      S9  = BG9 - GetRubSumByClient(pClient, string(TXOBJ_BASEG9), pBegDate, pEndDate, null, pIIS, NULL, NotUserWhereCond); 
    end;

    BG = BG1 + BG2 + BG3 + BG4 + BG5 + BG6 + BG7 + BG8 + BG9;
    BG = max(BG, 0);

    if(BG > 0)
      C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondContract));
      S = BG - C1;
    end;
  else
   if( pIIS == 0 )

      vKind = TXOBJ_BASEGENERAL;

      BG = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1011), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_3023), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1110), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1530), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1531), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1536), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1532), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1533), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1535), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1537), pBegDate, pEndDate, null, pIIS)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1539), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_201), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_202), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_203), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_206), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_207), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_205), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_208), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_209), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_210), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_211), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_222), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_213), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_214), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_220), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_223), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_224), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_218), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_219), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_218_1), pBegDate, pEndDate, null, pIIS)
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_219_1), pBegDate, pEndDate, null, pIIS);

      BG = Max(0, BG);

      if( IsPartyResident() )
         Sum_Limit_618     = GetRubSumByClient(pClient, string(TXOBJ_LIMIT_618), pBegDate, pEndDate, null, pIIS);
         Sum_FullMinus_618 = GetRubSumByClient(pClient, string(TXOBJ_FULLMINUS_618), pBegDate, pEndDate, null, pIIS);

         C2 = BG - Min(Min(Sum_Limit_618, BG), Sum_FullMinus_618);
      else
         C2 = GetRubSumByClient(pClient, string(TXOBJ_PLUS35_3023), pBegDate, pEndDate, null, pIIS) + BG;
      end;

   else
      vKind = TXOBJ_BASEGENERAL_IIS;


      if( (TypeIIS == IISTYPED) or
          (TypeIIS == IISTYPEE) or
          (TypeIIS == IISTYPEF) )
        WhereCondTransf = " and obj.t_transfkind = 1 ";
      end;

      BG = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1011_IIS), pBegDate, pEndDate, null, pIIS, NULL, (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_3023_IIS), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1544), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1545), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1549), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1546), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1547), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1548), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1551), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_1553), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_225), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_226), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_227), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_228), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_229), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_250), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_251), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_252), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_241), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_230), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_239), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_231), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_214_IIS), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_235), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_240), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_236), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_233), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf))
         - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_234), pBegDate, pEndDate, null, pIIS, NULL,  (WhereCondContract + WhereCondTransf));

      BG = Max(0, BG);

      C2 = BG;
   end;

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null,
                          pIIS, NULL, (NotUserWhereCond + " and " + WhereCondContract));
   S = C2 - C1;
  end;

  var _dir = TXOBJ_DIR_IN; 
  var _msg = "Налогооблагаемая база по 214 ст. по общей ставке" 
             + IIF(pIIS, " (ИИС)", "");
  var param_619 = 0;
  var param_517 = 0;
  
  if (pSubKindOperation == DL_TXBASECALC_OPTYPE_CLOSE_IIS)

    var dlcontr = TRecHandler("DLCONTR.DBT");
    var sfcontr = TRecHandler("SFCONTR.DBT");
    var our_bank  = TRecHandler("party.dbt");
    var begin_date, end_date, last_date;
    var query;
    var cmd;
    var data_set;
    var MinPeriod;

    if(IsCalcNOBCloseISS() and (pContract > 0))
      if((IsClientResident == 1) and ( (TypeIIS == IISTYPEA) or
                                       (TypeIIS == IISTYPEB) or
                                       (TypeIIS == IISTYPED) or
                                       (TypeIIS == IISTYPEE) or
                                       (TypeIIS == IISTYPEF) 
                                      ))
        param_619=1;
      
        query = "SELECT DL.* FROM DDLCONTR_DBT DL, DDLCONTRMP_DBT MP " + 
                "WHERE DL.T_DLCONTRID = MP.T_DLCONTRID " + 
                "AND (MP.t_sfcontrid = ? OR DL.t_sfcontrid = ?) " +
                "AND ROWNUM = 1 ";
        cmd = DL_RSDCommand(query);
        cmd.addParam(pContract);
        cmd.addParam(pContract);
        data_set = cmd.Execute();

        if (data_set.MoveNext())
          data_set.GetRecord().CopyTo(dlcontr.rec);

          if (dlcontr.rec.IISDedFinRes != "X")
            param_619=0;
          else
            query = "SELECT min(T_MINPERIOD) as T_MINPERIOD FROM DNPTXIISSETTING_DBT " + 
                    " WHERE t_iistype = 1 ";
                    
            cmd = DL_RSDCommand(query);
            data_set = cmd.Execute();
            
            if (data_set.MoveNext())
              MinPeriod = int(data_set.MINPERIOD);
            else
              MinPeriod = 3;
            end;
            
            var iisDateBeginPlusMin, YearBegDate, MonBegDate, DayBegDate;
            
            datesplit (iisDateBegin, DayBegDate, MonBegDate, YearBegDate);
            
            iisDateBeginPlusMin = date(DayBegDate, MonBegDate, (YearBegDate + MinPeriod));
            
            if(iisDateBeginPlusMin > iisDateEnd)
              param_619=0;
            end;
          end;
        else
          param_619=0;
        end;
      end;
    else
      param_619=1; 

      query = "SELECT T_DateBegin, T_DateClose FROM DSFCONTR_DBT t " +
              " WHERE t.t_id = ?";
      cmd = DL_RSDCommand(query);
      cmd.addParam(pContract);
      data_set = cmd.Execute();
      data_set.MoveNext();

      begin_date = data_set.DateBegin;

      if (data_set.DateClose != ZeroDate)
        end_date = data_set.DateClose;
      else
        end_date = Oper.rec.OperDate;
      end;

      query = "SELECT DL.* FROM DDLCONTR_DBT DL, DDLCONTRMP_DBT MP " + 
                         "WHERE DL.T_DLCONTRID = MP.T_DLCONTRID " + 
                           "AND MP.t_sfcontrid = ?";
      cmd = DL_RSDCommand(query);
      cmd.addParam(pContract);
      data_set = cmd.Execute();

      if (data_set.MoveNext())
        data_set.GetRecord().CopyTo(dlcontr.rec);

        if (dlcontr.rec.IISDedFinRes != "X")
          param_619=0;
        else
          if (dlcontr.rec.IISTransfer == "X")
            ПолучитьСубъекта({OurBank}, our_bank);

            if ((our_bank.rec.ShortName == dlcontr.rec.IISLastBrokerName)
                or (our_bank.rec.Name == dlcontr.rec.IISLastBrokerName))
              sfcontr = GetPrevContr(begin_date);

              while (sfcontr != null)
                query = "SELECT DL.* FROM DDLCONTR_DBT DL, DDLCONTRMP_DBT MP " + 
                         "WHERE DL.T_DLCONTRID = MP.T_DLCONTRID " + 
                           "AND MP.t_sfcontrid = ?";
                cmd = DL_RSDCommand(query);
                cmd.addParam(sfcontr.rec.ID);
                data_set = cmd.Execute();

                if (data_set.MoveNext())
                  data_set.GetRecord().CopyTo(dlcontr.rec);
                  if ((dlcontr.rec.IISTransfer == 0)
                      or (date(begin_date) - date(sfcontr.rec.DateClose) > 30))
                    break;
                  end;
                end;
                begin_date = sfcontr.rec.DateBegin;
                sfcontr = GetPrevContr(begin_date);
              end;

            else
              begin_date = dlcontr.rec.IISFirstDate;
            end; 
          end;
        end;
      else
        query = "SELECT * FROM DSFCONTR_DBT t " +
                " WHERE t.t_id = ?";
        cmd = DL_RSDCommand(query);
        cmd.addParam(pContract);
        data_set = cmd.Execute();
        data_set.MoveNext();
        data_set.GetRecord().CopyTo(sfcontr.rec);
        var ПредоставлятьВычет = DL_GetMainObjAttr(sfcontr, 5, OBJTYPE_SFCONTR);
        if (ПредоставлятьВычет != 1)
          param_619=0;
        end;
      end;

      if (date(end_date) - date(begin_date) < 3 * 365)
        param_619=0;
      end;
    
    end;
  end;

  if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (pContract > 0) and
      (IsClientResident == 1) and ( (TypeIIS == IISTYPEG) or
                                    (TypeIIS == IISTYPEC) or
                                    (TypeIIS == IISTYPED) or
                                    (TypeIIS == IISTYPEE) or
                                    (TypeIIS == IISTYPEF) 
                                   ))
      param_517 = 1;
      MinPeriod = 0;
      
      query = "SELECT DL.* FROM DDLCONTR_DBT DL, DDLCONTRMP_DBT MP " + 
              " WHERE DL.T_DLCONTRID = MP.T_DLCONTRID " + 
              "   AND (MP.t_sfcontrid = ? OR DL.t_sfcontrid = ?) " +
              "   AND ROWNUM = 1 ";
      cmd = DL_RSDCommand(query);
      cmd.addParam(pContract);
      cmd.addParam(pContract);
      data_set = cmd.Execute();

      if (data_set.MoveNext())
        data_set.GetRecord().CopyTo(dlcontr.rec);

        if (dlcontr.rec.IISDedFinResIIS3 != "X")
          param_517 = 0;
        else
          var dateCheck = iisDateBegin, YearDtransf;
          
          if((TypeIIS == IISTYPED) or
             (TypeIIS == IISTYPEE) or
             (TypeIIS == IISTYPEF))
          
            YearsDepIISBefTransf();
            var Dtransf31 = (Dtransf-1);
            
            var YearDtransf31, MonDtransf31, DayDtransf31;
          
            datesplit (Dtransf31, DayDtransf31, MonDtransf31, YearDtransf31);
            
            var SetDate = date(DayDtransf31,MonDtransf31,(YearDtransf31 - YearsDepIISBefTransf()));
          
            dateCheck = IIF(iisDateBegin <= SetDate, SetDate, iisDateBegin);
          end;
          
          datesplit (dateCheck, DayBegDate, MonBegDate, YearBegDate);
          
          datesplit (Dtransf, NULL, NULL, YearDtransf);

          query = "SELECT min(T_MINPERIOD) as T_MINPERIOD FROM DNPTXIISSETTING_DBT " + 
                  " WHERE t_iistype = 2 and t_taxperiod = ? ";
                    
          cmd = DL_RSDCommand(query);
          cmd.addParam(IIF((TypeIIS == IISTYPED) or (TypeIIS == IISTYPEE) or (TypeIIS == IISTYPEF), YearDtransf, YearBegDate));
          data_set = cmd.Execute();
            
          if (data_set.MoveNext())
            MinPeriod = int(data_set.MINPERIOD);
          else
            MsgBox("Ошибка определения срока владения договором ИИС");
            return 1;
          end;

          iisDateBeginPlusMin = date(DayBegDate, MonBegDate, (YearBegDate + MinPeriod));
            
          if(iisDateBeginPlusMin > iisDateEnd)
            param_517 = 0;
          end;
        end;
      else
        param_517 = 0;
      end;
      
      if(param_517 == 1)
        var S_517 = 0;
        var YearEnd = 0;
        datesplit(pEndDate, NULL, NULL, YearEnd);

        var DateBeingYearCalc = date(1,1,YearEnd);
        var DateEndYearCalc   = date(31,12,YearEnd);

        if((TypeIIS == IISTYPED) or
           (TypeIIS == IISTYPEE) or
           (TypeIIS == IISTYPEF))
          BG5 = GetTransfBG(TXOBJ_BASEG5, 2);
        else
          BG5 = GetBG(TXOBJ_BASEG5);
        end;
        BG = max(BG5, 0);
        
        if(BG > 0)
          C1 = GetRubSumByClient(pClient, TXOBJ_FULLMINUS_517, pBegDate, pEndDate, null, pIIS, NULL, (NotUserWhereCond + " and " + WhereCondContract));
          S_517 = BG - C1;
        end;

        S_517 = S_517 + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pClient, TXOBJ_FULLMINUS_517, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);  
        if( (stat == 0) and (S_517 != 0) )
         InsertTaxObjectTmp( pEndDate,
                             pClient,
                             TXOBJ_DIR_OUT,
                             7,
                             UNSET_CHAR,
                             TXOBJ_FULLMINUS_517,
                             S_517,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Налоговый вычет на ДСГ в размере ФР на ИИС-3 (рассчитанный)",
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc
                           );
        end;
    
        var LimitS = CуммаВычетаИИС3();
        var AddLimitS = LimitS - GetRubSumByClient(pClient, string(TXOBJ_MINUSG_517), DateBeingYearCalc, DateEndYearCalc, null, pIIS, NULL, NotUserWhereCond);
        if( (stat == 0) and (AddLimitS != 0) )

          InsertTaxObjectTmp( pEndDate,
                              pClient,
                              TXOBJ_DIR_OUT,
                              6,
                              UNSET_CHAR,
                              TXOBJ_LIMIT_517,
                              AddLimitS,
                              NATCUR,
                              0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                              0,
                              -1,
                              "Предельный размер налогового вычета на ДСГ по ИИС-3 в налоговом периоде",
                              pDocID,
                              pStep,
                              0,
                              Oper.rec.Recalc
                            );
        end;
        
        S_517 = min( AddLimitS, S_517);
        if( (stat == 0) and (S_517 != 0) )

         InsertTaxObjectTmp( pEndDate,
                             pClient,
                             TXOBJ_DIR_OUT,
                             7,
                             UNSET_CHAR,
                             TXOBJ_MINUSG_517,
                             S_517,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Налоговый вычет на ДСГ в размере ФР на ИИС-3 (предоставленный)",
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc
                           );
        end;

        S_517 = max(BG-S_517, 0);
        if( (stat == 0) and (S_517 != 0) )
          CreateTxObjBG(S_517, TXOBJ_BASEG5);

          InsertTaxObjectTmp(pEndDate,
                             pClient,
                             _dir,
                             7,
                             UNSET_CHAR,
                             vKind,
                             S_517,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                             TXOBJ_KIND6020,                 
                             pContract,
                             _msg,
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc);

          
        end;
      end;
  end;

  if (param_619==1)
      vKind = TXOBJ_MINUSG_619;
      _dir  = TXOBJ_DIR_OUT;
      _msg  = "Инвестиционный вычет в размере ФР на ИИС";
  end;

  if( ((param_619 == 1) or (param_517 == 0)) or
      ((TypeIIS == IISTYPED) or
       (TypeIIS == IISTYPEE) or
       (TypeIIS == IISTYPEF))
     )
    S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);
    if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp(pEndDate,
                         pClient,
                         _dir,
                         7,
                         UNSET_CHAR,
                         vKind,
                         S,
                         NATCUR,
                         0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                         TXOBJ_KIND6020,                 
                         pContract,
                         _msg,
                         pDocID,
                         pStep,
                         0,
                         Oper.rec.Recalc);
    end;
  end;

  if((stat == 0) and ((param_619 == 0) and ((param_517 == 0) OR 
                      ((TypeIIS == IISTYPED) or
                       (TypeIIS == IISTYPEE) or
                       (TypeIIS == IISTYPEF)))
                     )
    )
    CreateTxObjBG(S1, TXOBJ_BASEG1);
    CreateTxObjBG(S2, TXOBJ_BASEG2);
    CreateTxObjBG(S3, TXOBJ_BASEG3);
    CreateTxObjBG(S4, TXOBJ_BASEG4);
    CreateTxObjBG(S5, TXOBJ_BASEG5);
    CreateTxObjBG(S6, TXOBJ_BASEG6);
    CreateTxObjBG(S7, TXOBJ_BASEG7);
    CreateTxObjBG(S8, TXOBJ_BASEG8);
    CreateTxObjBG(S9, TXOBJ_BASEG9);
  end;

  if( IsPartyResident() ) /*для резидента*/
     if( pIIS == 0 )
        vKind = TXOBJ_BASESPECIAL;
        C2 =   GetRubSumByClient(pClient, string(TXOBJ_PLUS9_1110), pBegDate, pEndDate,null, pIIS) 
             - GetRubSumByClient(pClient, string(TXOBJ_MINUS9_218), pBegDate, pEndDate,null, pIIS) 
             - GetRubSumByClient(pClient, string(TXOBJ_MINUS9_219), pBegDate, pEndDate,null, pIIS);
     else
        vKind = TXOBJ_BASESPECIAL_IIS;
        C2 =   GetRubSumByClient(pClient, string(TXOBJ_PLUS9_1110_IIS), pBegDate, pEndDate,null, pIIS, null, WhereCondContract) 
             - GetRubSumByClient(pClient, string(TXOBJ_MINUS9_233), pBegDate, pEndDate,null, pIIS, null, WhereCondContract) 
             - GetRubSumByClient(pClient, string(TXOBJ_MINUS9_234), pBegDate, pEndDate,null, pIIS, null, WhereCondContract);
     end;
  else
     C2 = 0.0;
    vKind = 0;
  end;

  if(vKind > 0)
    C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, WhereCondContract);
    S = C2 - C1;
  else
    S = 0;
  end;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_IN,
                          7,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Доход облагаемый по ставке 9 (15)% (кроме дивиденов)" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc
                        );
    end;

   if( pIIS == 0 )
      C2 = Min(Min(Sum_Limit_618, IIF(pEndDate>=date(1,1,2021), MG_618, BG) ), Sum_FullMinus_618);
      C1 = GetRubSumByClient(pClient, string(TXOBJ_MINUSG_618), pBegDate, pEndDate, null, pIIS);
      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);
      if( (stat == 0) and (S != 0) )
         InsertTaxObjectTmp( pEndDate,
                             pClient,
                             TXOBJ_DIR_OUT,
                             7,
                             UNSET_CHAR,
                             TXOBJ_MINUSG_618,
                             S,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             "Инвестиционный вычет по ц/б в собственности более 3-х лет",  //++
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc
                           );
      end;
   end;

   if((param_517 == 0) and
      ((TypeIIS == IISTYPED) or
       (TypeIIS == IISTYPEE) or
       (TypeIIS == IISTYPEF))
     )
      pBegDate = Dtransf;
      pEndDate = iisDateEnd;
      BG5 = GetTransfBG(TXOBJ_BASEG5, 2);

      BG = max(BG5, 0);  

      if( (stat == 0) and (BG != 0) )
        if(IsClientResident == 1)
          CreateTxObjBG(BG, TXOBJ_BASEG5);
        end;

        InsertTaxObjectTmp(pEndDate,
                             pClient,
                             _dir,
                             7,
                             UNSET_CHAR,
                             TXOBJ_BASEGENERAL_IIS,
                             BG,
                             NATCUR,
                             0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                             TXOBJ_KIND6020,
                             pContract,
                             _msg,
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc);
      end;
   end;

   vKind = TBOBJ_BASECOMP;
   C2 = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_4800), pBegDate, pEndDate, null, pIIS, " obj.t_OutSystCode != 'КОМПЕНС' ");
 
   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, null, WhereCondContract);
   S = C2 - C1;
 
   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);
   if ((stat == 0) and (S != 0))
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_IN,
                          7,
                          UNSET_CHAR,
                          TBOBJ_BASECOMP,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Налоговая база по компенсациям" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc
                        );
    end;

   if(not stat)
    stat = CorrectTechnicalInObjTMP(pDocID, pStep, 7);
   end;

   return stat;
END;

MACRO CreateTaxObjectsIIS7(Oper:TRecHandler/*NPTXOP*/, pStep)
  stat = 0;
  var Dtransf, iisDateEnd, iisDateBegin, TypeIIS, iisOpenDate;
  var Contracts = "( ", wasContr = false, sfcontr = 0;
  
  stat = ОпределитьТипИИС(Oper.rec.Contract, @TypeIIS, @iisDateBegin, @iisDateEnd, @Dtransf, @iisOpenDate, Oper.rec.OperDate);
    
  if(stat)
    MsgBox("Ошибка определения типа ИИС");
    return 1;
  end;

  var queryContr, cmdContr, DataSetContr;

  queryContr = "SELECT MP.T_SFCONTRID, CASE WHEN SF.T_NUMBER LIKE '%_ф' THEN 1 ELSE 0 END as mmvb, " +
               "       CASE WHEN SF.t_dateclose = TO_DATE ('01010001', 'ddmmyyyy') THEN TO_DATE ('31129999', 'ddmmyyyy') ELSE SF.t_dateclose END t_dateclose, " +
               "       SF.t_datebegin " +
               "  FROM DDLCONTRMP_DBT MP, DSFCONTR_DBT SF " +
               " WHERE MP.T_DLCONTRID = ? AND SF.T_ID = MP.T_SFCONTRID " +
               " UNION " +
               "SELECT DL.T_SFCONTRID, 0 as mmvb, TO_DATE ('01010001', 'ddmmyyyy') t_dateclose, TO_DATE ('31129999', 'ddmmyyyy') t_datebegin FROM DDLCONTR_DBT DL " + 
               " WHERE DL.T_DLCONTRID = ?"
               " ORDER BY t_dateclose DESC, t_datebegin ASC ";

  cmdContr = DL_RSDCommand(queryContr);
  cmdContr.AddParam(Oper.rec.Contract);
  cmdContr.AddParam(Oper.rec.Contract);

  DataSetContr = cmdContr.Execute();

  while(DataSetContr.moveNext())
    if(wasContr)
      Contracts = Contracts + ", " + DataSetContr.SFCONTRID;
    else
      Contracts = Contracts + DataSetContr.SFCONTRID;
      sfcontr = DataSetContr.SFCONTRID;
    end;
    if(DataSetContr.mmvb == 1)
      sfcontr = DataSetContr.SFCONTRID;
    end;
    wasContr = true;
  end;
  
  if(wasContr)
    Contracts = Contracts + " ) ";
    CreateTaxObjects7(Oper, pStep, null, null, sfcontr, Contracts);
  end;

  return stat;
END;

MACRO CreateMaterialTaxObjects7( Oper:TRecHandler/*NPTXOP*/, pStep, vBegDate, vEndDate, vContract)
   var C2, C1, S, vKind;
   stat = 0;
   var WhereCondContract = " 1=1 ";
   var TaxTeriodToLucre, TaxPeriod;

   ОпределитьПараметрыРасчета(Oper);
   GetBegDate(Oper, true);

   if( (vBegDate!=null) AND (vEndDate!=null) )
     pBegDate = vBegDate;
     pEndDate = vEndDate;
   end;

   datesplit(pEndDate, null, null, TaxPeriod);
   TaxTeriodToLucre = CheckTaxTeriodToLucre(TaxPeriod);

   if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
     pContract = vContract;

     WhereCondContract = " obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 +
                         " and obj.t_Analitic6 = " + pContract + " ";
   end;

   if( pIIS == 1 )
      vKind = TXOBJ_BASEMATERIAL_IIS;

      C2 = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_2640_IIS), pBegDate, pEndDate, null, pIIS, true, WhereCondContract)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_2641_IIS), pBegDate, pEndDate, null, pIIS, true, WhereCondContract);
   else
      vKind = TXOBJ_BASEMATERIAL;

      C2 = GetRubSumByClient(pClient, string(TXOBJ_PLUSG_2640), pBegDate, pEndDate, null, IIF(TaxTeriodToLucre == false, pIIS, NULL), true)
         + GetRubSumByClient(pClient, string(TXOBJ_PLUSG_2641), pBegDate, pEndDate, null, IIF(TaxTeriodToLucre == false, pIIS, NULL), true);
   end;

   C1 = GetRubSumByClient(pClient, string(vKind), pBegDate, pEndDate, null, pIIS, true, WhereCondContract);
   S = C2 - C1;

   S = S + GetSumNPTXOBJTech(Oper.rec.ID, pStep, pEndDate, pCLient, vKind, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, TXOBJ_KIND6020, pContract, Oper.rec.Recalc);
   if( (stat == 0) and (S != 0) )
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_IN,
                          7,
                          UNSET_CHAR,
                          vKind,
                          S,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                          TXOBJ_KIND6020,                 
                          pContract,
                          "Налогооблагаемая база по материальной выгоде" + IIF(pIIS, " (ИИС)", ""),
                          pDocID,
                          pStep,
                          0,
                          Oper.rec.Recalc
                        );
   end;

   return stat;
END;

//Проверить, что есть заяввление на возврат, сформированное в операции удержания с типом "Окончание года"
macro ExistsReqByEndYear(ClientID:integer, TaxPeriod:integer, NpTxOpID:@integer)
  var query, cmd, DataSet;

  NpTxOpID = 0;

  query =   "SELECT * "
          + "  FROM (SELECT nptxop.t_ID, oprdoc.t_AutoKey "
          + "          FROM dnptxop_dbt req, "
          + "               doprdocs_dbt oprdoc, "
          + "               doproper_dbt op, "
          + "               dnptxop_dbt nptxop "
          + "         WHERE     req.t_DocKind = " + DL_RETREQ
          + "               AND req.t_Status IN ("+DLNPTXRETREQ_CHECKED+", "+DLNPTXRETREQ_PARTEXECUTED+") "
          + "               AND req.t_Client = ? "
          + "               AND EXTRACT (YEAR FROM req.t_PrevDate) = ? "
          + "               AND oprdoc.t_DocKind = 4752 "             /*DL_INSERT_NPTXOP*/
          + "               AND oprdoc.t_DocumentID = LPAD (req.t_ID, 34, '0') "
          + "               AND op.t_ID_Operation = oprdoc.t_ID_Operation"
          + "               AND op.t_DocKind = " + DL_HOLDNDFL
          + "               AND nptxop.t_ID = TO_NUMBER (op.t_DocumentID) "
          + "        UNION ALL "
          + "        SELECT nptxop.t_ID, oprdoc.t_AutoKey "
          + "          FROM dnptxop_dbt req, "
          + "               doprdocs_dbt oprdoc,"
          + "               doproper_dbt op,"
          + "               dnptxop_dbt nptxop "
          + "         WHERE     nptxop.t_CLient = ? "
          + "               AND nptxop.t_DocKind = " + DL_HOLDNDFL
          + "               AND EXTRACT (YEAR FROM nptxop.t_PrevDate) = ? "
          + "               AND OP.T_DOCKIND = nptxop.t_DocKind "
          + "               AND op.t_DocumentID = LPAD (nptxop.t_ID, 34, '0') "
          + "               AND oprdoc.t_ID_Operation = op.t_ID_Operation "
          + "               AND oprdoc.t_DocKind = 4753 "            /*DL_NPTXRETREQ_CNG*/
          + "               AND req.t_ID = TO_NUMBER(UTL_RAW.cast_to_binary_integer(DBMS_LOB.SUBSTR (oprdoc.T_FMTBLOBDATA_XXXX, 4, 1), 2)) "
          + "               AND req.t_DocKind = " + DL_RETREQ
          + "               AND req.t_Status IN ("+DLNPTXRETREQ_CHECKED+", "+DLNPTXRETREQ_PARTEXECUTED+") "
          + "      ) q "
          + " ORDER BY q.t_AutoKey DESC ";

  cmd = DL_RSDCommand();

  cmd.AddParam(ClientID);
  cmd.AddParam(TaxPeriod);
  cmd.AddParam(ClientID);
  cmd.AddParam(TaxPeriod);

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    NpTxOpID = DataSet.ID;
    return true;
  end;

  return false;
end;

//////////////////////////////////////////////////////////////////
//НДР 8 
//////////////////////////////////////////////////////////////////
MACRO CreateHoldTaxObjects8( Oper/*NPTXOP*/, pStep, SumReestr, Taxe:@money, Taxe15:@money )
  var K = 1;
  var DEPOSystCode = "ДЕПО";
  var HoldEndYearNpTxOpID = 0;
  var HoldEndYearNpTxOp = TBFile("nptxop.dbt");
  var Year;
  
  Taxe = $0; 
  Taxe15 = $0;

  ОпределитьПараметрыРасчета(Oper, true);
  GetBegDate(Oper, true);

  datesplit(Oper.rec.PrevDate, 0, 0, Year);

  if((Oper.rec.DocKind == DL_HOLDNDFL) AND (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF))
    ExistsReqByEndYear(Oper.rec.Client, Year, @HoldEndYearNpTxOpID);
  end;

  var curAnaliticKind6 = TXOBJ_KIND6020;
  var curAnalitic6 = pContract;

  if((Oper.rec.DocKind == DL_HOLDNDFL) and (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF))
    //для возврата налога не заполняем аналитику 6
    curAnaliticKind6 = 0;
    curAnalitic6 = -1;
  end;

  if((Oper.rec.DocKind == DL_HOLDNDFL) AND (Oper.rec.PrevDate >= date(1,1,2023)) AND (((Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF) AND (HoldEndYearNpTxOpID > 0)) OR (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_ENDYEAR)))
    var DocKind = Oper.rec.DocKind;
    var DocID   = Oper.rec.ID;

    if(HoldEndYearNpTxOpID > 0)
      HoldEndYearNpTxOp.rec.ID = HoldEndYearNpTxOpID;
      HoldEndYearNpTxOp.GetEQ();

      if(HoldEndYearNpTxOp.rec.ID > 0)
        DocKind = HoldEndYearNpTxOp.rec.DocKind; 
        DocID   = HoldEndYearNpTxOp.rec.ID;
      end;
    end;

    var SOFR_taxe0201     = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0201);
    var SOFR_taxe0208     = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0208);
    var DEPO_taxe0201     = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0201);
    var DEPO_taxe0207     = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0207);
    var DEPO_taxe0208     = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0208);
    var SOFR_taxe0201_IIS = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0201_IIS);
    var SOFR_taxe0208_IIS = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_SOFR_TAXE0208_IIS); 
    var DEPO_taxe0201_IIS = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0201_IIS);
    var DEPO_taxe0207_IIS = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0207_IIS);
    var DEPO_taxe0208_IIS = STB_GetSavedNptxval(DocKind, DocID, NPTXVAL_KIND_DEPO_TAXE0208_IIS);

    if(Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF)
      K = -1;
    end;

    taxe   = K*(SOFR_taxe0201 + DEPO_taxe0201 + DEPO_taxe0207 + SOFR_taxe0201_IIS + DEPO_taxe0201_IIS + DEPO_taxe0207_IIS);
    taxe15 = K*(SOFR_taxe0208 + DEPO_taxe0208 + SOFR_taxe0208_IIS + DEPO_taxe0208_IIS);

    if(SOFR_taxe0201 != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL,
                          SOFR_taxe0201,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 201, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR
                        );
    end;

    if(SOFR_taxe0208 != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL_15_9,
                          SOFR_taxe0208,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 208, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Уплаченный налог по повышенной ставке",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR
                        );
    end;

    if(DEPO_taxe0201 != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL,
                          DEPO_taxe0201,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 201, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Диасофт. Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR,
                          UNSET_CHAR,           // Признак внешней системы
                          DEPOSystCode,         // Код внешней системы
                          ""                    // ID во внешней системе
                        );
    end;

    if(DEPO_taxe0207 != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL,
                          DEPO_taxe0207,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 207, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Диасофт. Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR,
                          UNSET_CHAR,           // Признак внешней системы
                          DEPOSystCode,         // Код внешней системы
                          ""                    // ID во внешней системе
                        );
    end;

    if(DEPO_taxe0208 != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL_15_9,
                          DEPO_taxe0208,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 208, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Диасофт. Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR,
                          UNSET_CHAR,           // Признак внешней системы
                          DEPOSystCode,         // Код внешней системы
                          ""                    // ID во внешней системе
                        );
    end;

    if(SOFR_taxe0201_IIS != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL_IIS,
                          SOFR_taxe0201_IIS,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 201, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR
                        );
    end;

    if(SOFR_taxe0208_IIS != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL_15_IIS,
                          SOFR_taxe0208_IIS,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 208, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Уплаченный налог по повышенной ставке",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR
                        );
    end;


    if(DEPO_taxe0201_IIS != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL_IIS,
                          DEPO_taxe0201_IIS,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 201, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Диасофт. Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR,
                          UNSET_CHAR,           // Признак внешней системы
                          DEPOSystCode,         // Код внешней системы
                          ""                    // ID во внешней системе
                        );
    end;

    if(DEPO_taxe0207_IIS != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL_IIS,
                          DEPO_taxe0207_IIS,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 207, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Диасофт. Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR,
                          UNSET_CHAR,           // Признак внешней системы
                          DEPOSystCode,         // Код внешней системы
                          ""                    // ID во внешней системе
                        );
    end;

    if(DEPO_taxe0208_IIS != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          TXOBJ_PAIDGENERAL_15_IIS,
                          DEPO_taxe0208_IIS,
                          NATCUR,
                          0, -1, TXOBJ_KIND2040, 208, 0, -1, 0, -1, 0, -1, 
                          0,                 
                          -1,
                          "Диасофт. Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR,
                          UNSET_CHAR,           // Признак внешней системы
                          DEPOSystCode,         // Код внешней системы
                          ""                    // ID во внешней системе
                        );
    end;

  else

    var cur15AnaliticKind2 = 0;
    var cur15Analitic2 = -1;

    Taxe   = STB_GetSavedNptxval(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_TAXE);
    if(Taxe < 0)
      Taxe = 0;
    end;

    Taxe15 = STB_GetSavedNptxval(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_TAXE_15);

    if((Oper.rec.DocKind == DL_HOLDNDFL) and (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_TAXREF)) //возврат налога
      K = -1;
    end;

    if((Oper.rec.DocKind == DL_HOLDNDFL) and (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY))
      cur15AnaliticKind2 = TXOBJ_KIND2040;
      cur15Analitic2 = 218;
    end;

    if(Taxe != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          IIF(pIIS==0, TXOBJ_PAIDGENERAL, TXOBJ_PAIDGENERAL_IIS),
                          K*Taxe,
                          NATCUR,
                          0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 
                          curAnaliticKind6,                 
                          curAnalitic6,
                          "Уплаченный налог",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR
                        );
    end;

    if(Taxe15 != 0)
      InsertTaxObjectTmp( pEndDate,
                          pClient,
                          TXOBJ_DIR_OUT,
                          8,
                          UNSET_CHAR,
                          IIF(pIIS==0, TXOBJ_PAIDGENERAL_15, TXOBJ_PAIDGENERAL_15_IIS),
                          K*Taxe15,
                          NATCUR,
                          0, -1, cur15AnaliticKind2, cur15Analitic2, 0, -1, 0, -1, 0, -1, 
                          curAnaliticKind6,                 
                          curAnalitic6,
                          "Уплаченный налог по повышенной ставке",
                          pDocID,
                          pStep,
                          SumReestr,
                          UNSET_CHAR
                        );

      if(pIIS==0)
        InsertTaxObjectTmp( pEndDate,
                            pClient,
                            TXOBJ_DIR_OUT,
                            8,
                            UNSET_CHAR,
                            TXOBJ_PAIDGENERAL_15_2,
                            K*Taxe15,
                            NATCUR,
                            0, -1, cur15AnaliticKind2, cur15Analitic2, 0, -1, 0, -1, 0, -1, 
                            curAnaliticKind6,                 
                            curAnalitic6,
                            "Уплаченный налог по повышенной ставке",
                            pDocID,
                            pStep,
                            SumReestr,
                            UNSET_CHAR
                          );
      end;
    end;

    if((Oper.rec.DocKind == DL_WRTMONEY) or ((Oper.rec.DocKind == DL_HOLDNDFL) and (Oper.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_PREHOLD))) //Доудержание
      if(Taxe != 0)
        InsertTaxObjectTmp(pEndDate,
                           pClient,
                           TXOBJ_DIR_OUT,
                           8,
                           UNSET_CHAR,
                           TXOBJ_DUETAX,
                           -Taxe,
                           NATCUR,
                           0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                           curAnaliticKind6,                 
                           curAnalitic6,
                           "Неуплаченный налог",
                           pDocID,
                           pStep,
                           0,
                           UNSET_CHAR);
      end;

      if(Taxe15 != 0)
        InsertTaxObjectTmp(pEndDate,
                           pClient,
                           TXOBJ_DIR_OUT,
                           8,
                           UNSET_CHAR,
                           TXOBJ_DUETAX,
                           -Taxe15,
                           NATCUR,
                           0, -1, 0, -1, 0, -1, 0, -1, 0, -1,
                           curAnaliticKind6,                 
                           curAnalitic6,
                           "Неуплаченный налог по повышенной ставке",
                           pDocID,
                           pStep,
                           0,
                           UNSET_CHAR);
      end;
    end;
  end;

  return 0;
END;

PRIVATE MACRO GetObjSumByKBK(Client, Kind, Year, KBK)
  var query, cmd, DataSet;
  var S = $0;

  query =   " select NVL(SUM(t_Sum0), 0) as AllSum "
          + "   from dnptxobj_dbt "
          + "  where t_Client = ? "
          + "    and t_Kind = ? "
          + "    and t_TaxPeriod = ? "
          + "    and t_AnaliticKind2 = " + TXOBJ_KIND2040
          + "    and t_Analitic2 = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(Client);
  cmd.AddParam(Kind);
  cmd.AddParam(Year);
  cmd.AddParam(int(substr(KBK,8,3)));

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    S = DataSet.AllSum;
  end;

  return S;
END;

MACRO CreateDueMaterial(ObjDocID, ClientID, ObjDate:date, TaxPeriod, ID_Step:integer, KBK:string, HoldMaterial:money, TaxObj:@TInsertTaxObject, InlineInsTaxObj:bool)
  var query, cmd, DataSet;
 
  if(HoldMaterial == NULL)
    HoldMaterial = 0;
  end;

  if(InlineInsTaxObj == NULL)
    InlineInsTaxObj = false;
  end;
    debugbreak;
  query = " select NVL(SUM(t_CalcPITax), 0) as SumLucreCalc "
        + "  from dnptxtotalbase_dbt   "
        + " where t_ClientID = ? "
        + "   and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
        + "   and t_Type in (1, 2, 3, 4) "
        + "   and t_TaxPeriod = ? "
        + "   and t_BccCalcPITax = ? "
        + "   and t_SpecialTag = 'МАТ' ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(TaxPeriod);
  cmd.AddParam(KBK);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    var Налог_ИСЧ_МАТВЫГ = DataSet.SumLucreCalc;                                
    var PaidMaterial     = GetObjSumByKBK(ClientID, TXOBJ_PAIDMATERIAL, TaxPeriod, KBK);
    var DueMaterial      = GetObjSumByKBK(ClientID, TXOBJ_DUEMATERIAL, TaxPeriod, KBK);

    var S = Налог_ИСЧ_МАТВЫГ - PaidMaterial - DueMaterial - HoldMaterial;

    if(S != 0)
      if(TaxObj != NULL)
        TaxObj.Add( 1                             
                   ,ObjDate            // Дата НДР
                   ,ClientID           // Клиент
                   ,TXOBJ_DIR_OUT      // Направление
                   ,8                  // Уровень
                   ,""                 // Признак "Пользовательский"
                   ,TXOBJ_DUEMATERIAL  // Вид НДР
                   ,S                  // Сумма дохода/расхода
                   ,NATCUR             // Валюта дохода/расхода
                   ,0                  // Вид аналитики 1
                   ,-1                 // Аналитика 1
                   ,TXOBJ_KIND2040     // Вид аналитики 2
                   ,int(substr(KBK,8,3)) // Аналитика 2
                   ,0                  // Вид аналитики 3
                   ,-1                 // Аналитика 3
                   ,0                  // Вид аналитики 4
                   ,-1                 // Аналитика 4
                   ,0                  // Вид аналитики 5
                   ,-1                 // Аналитика 5
                   ,0                  // Вид аналитики 6
                   ,-1                 // Аналитика 6
                   ,"Неуплаченный налог по мат. выгоде" // Комментарий
                   ,ObjDocID              // ID операции
                   ,ID_Step            // ID шага операции
                   ,1                  // Признак вызова не из операции расчета НОБ
                  );
      elif(InlineInsTaxObj)
        DL_NPTX_InsertTaxObject( ObjDate      // Дата НДР
                                ,ClientID     // Клиент
                                ,TXOBJ_DIR_OUT        // Направление
                                ,8                    // Уровень
                                ,""                   // Признак "Пользовательский"
                                ,TXOBJ_DUEMATERIAL    // Вид НДР
                                ,S                    // Сумма дохода/расхода
                                ,NATCUR               // Валюта дохода/расхода
                                ,0                    // Вид аналитики 1
                                ,-1                    // Аналитика 1
                                ,TXOBJ_KIND2040        // Вид аналитики 2
                                ,int(substr(KBK,8,3))            // Аналитика 2
                                ,0        // Вид аналитики 3
                                ,-1       // Аналитика 3
                                ,0        // Вид аналитики 4
                                ,-1       // Аналитика 4
                                ,0        // Вид аналитики 5
                                ,-1       // Аналитика 5
                                ,0        // Вид аналитики 6
                                ,-1       // Аналитика 6
                                ,"Неуплаченный налог по мат. выгоде"  // Комментарий
                                ,ObjDocID          // ID операции
                                ,ID_Step               // ID шага операции
                                ,1                  // Признак вызова не из операции расчета НОБ
                               );
      else
        InsertTaxObjectTmp( ObjDate,
                            ClientID,
                            TXOBJ_DIR_OUT,
                            8,
                            UNSET_CHAR,
                            TXOBJ_DUEMATERIAL,
                            S,
                            NATCUR,
                            0, -1, TXOBJ_KIND2040, int(substr(KBK,8,3)), 0, -1, 0, -1, 0, -1, 
                            0,                 
                            -1,
                            "Неуплаченный налог по мат. выгоде",
                            ObjDocID,
                            ID_Step,
                            0,
                            UNSET_CHAR,
                            UNSET_CHAR,   // Признак внешней системы
                            "",           // Код внешней системы
                            ""            // ID во внешней системе
                          );
      end;

    end;
  end;

  return 0;
END;

MACRO CreateAllDueMaterialObjects8(Oper, ID_Step)
  var query, cmd, DataSet;
  var err = 0;
  var IsClientResident = STB_IsResidentStatusRSI(Oper.rec.Client, Oper.rec.OperDate);
  var TaxPeriod = 0;

  if(Oper.rec.DocKind == DL_HOLDNDFL)
    datesplit(Oper.rec.PrevDate, NULL, NULL, TaxPeriod);
  else
    datesplit(Oper.rec.OperDate, NULL, NULL, TaxPeriod);
  end; 

  query =   " select llv.t_Name as KBK "
          + "   from dnptxsnoblimit_dbt l, dllvalues_dbt llv "
          + "  where l.t_TypeSNOB = 3 /*СНОБ2*/ "
          + "    and l.t_IsResident = " + IIF(IsClientResident, "'X'", "CHR(0)")
          + "    and llv.t_List = 3522 "
          + "    and llv.t_Code = TO_CHAR(l.t_CodeKBK) "
          + " order by l.t_CodeKBK ASC ";

  cmd = DL_RSDCommand(query);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())        
    CreateDueMaterial(Oper.rec.ID, Oper.rec.Client, Oper.rec.OperDate, TaxPeriod, ID_Step, DataSet.KBK);
  end;

  return err;
END;

private macro GetPg(NpTxKindsStr:string, AddWhereCond)
  var _Pg = $0;

  _Pg = GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_CALCNDFL, null, pIIS, AddWhereCond) + //созданные в операциях расчета НОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, 0 /*только пользовательские*/,null, pIIS, AddWhereCond) +
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, NULL, DL_HOLDNDFL, null, pIIS, AddWhereCond) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_WRTMONEY, null, pIIS, AddWhereCond) + //созданные в операциях списания/зачисления денежных средств
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_RETIREMENT_OWN, null, pIIS, AddWhereCond) + //созданные в операциях погашения ОЭБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_NPTXSTBOP, null, pIIS, AddWhereCond) + //созданные в операциях корректировки события СНОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_NPTXNETTOP, null, pIIS, AddWhereCond) + //созданные в операциях зачета СНОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_NPTXCRNSET, null, pIIS, AddWhereCond) + //созданные в операциях компенсации
        /*плюс операции в ПС <Векселя банка>*/
        GetRubSumByClientFromVeksel(pClient, string(NpTxKindsStr), pBeg, pEnd, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                               string(DL_VSBARTERORDER)  +", "+ //мена
                                                                               string(DL_VSINTERCHANGE) );      //зачет взаимных требований


  if(pIIS == 0)
    _Pg = _Pg + GetRubSumByClientFromDepo(pClient, string(NpTxKindsStr), pBeg, pEnd); //созданные в операции "Расчет и начисление дохода" в депозитарии
  end;

  return _Pg;
end;

private macro GetPp(NpTxKindsStr:string, AddWhereCond)
  var _Pp = $0;

  _Pp = GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_CALCNDFL, null, pIIS, AddWhereCond) + //созданные в операциях расчета НОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, 0 /*только пользовательские*/,null, pIIS, AddWhereCond) +
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, NULL, DL_HOLDNDFL, null, pIIS, AddWhereCond) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_WRTMONEY, null, pIIS, AddWhereCond) + //созданные в операциях списания/зачисления денежных средств
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_RETIREMENT_OWN, null, pIIS, AddWhereCond) + //созданные в операциях погашения ОЭБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_NPTXSTBOP, null, pIIS, AddWhereCond) + //созданные в операциях корректировки события СНОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_NPTXNETTOP, null, pIIS, AddWhereCond) + //созданные в операциях зачета СНОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_NPTXCRNSET, null, pIIS, AddWhereCond) + //созданные в операциях компенсации
        /*плюс операции в ПС <Векселя банка>*/
        GetRubSumByClientFromVeksel(pClient, string(NpTxKindsStr), pBeg, pEnd, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                               string(DL_VSBARTERORDER)  +", "+ //мена
                                                                               string(DL_VSINTERCHANGE) );      //зачет взаимных требований


  if(pIIS == 0)
    _Pp = _Pp + GetRubSumByClientFromDepo(pClient, string(NpTxKindsStr), pBeg, pEnd); //созданные в операции "Расчет и начисление дохода" в депозитарии
  end;

  return _Pp;
end;

private macro GetPs(NpTxKindsStr:string, AddWhereCond)
  var _Ps = $0;

  _Ps = GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_CALCNDFL, null, pIIS, AddWhereCond) + //созданные в операциях расчета НОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, 0 /*только пользовательские*/, null, pIIS, AddWhereCond) +
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, NULL, DL_HOLDNDFL, null, pIIS, AddWhereCond) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_RETIREMENT_OWN, null, pIIS, AddWhereCond) + //созданные в операциях погашения ОЭБ
        /*плюс операции в ПС <Векселя банка>*/
        GetRubSumByClientFromVeksel(pClient, string(NpTxKindsStr), pBeg, pEnd, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                               string(DL_VSBARTERORDER)  +", "+ //мена
                                                                               string(DL_VSINTERCHANGE) );      //зачет взаимных требований


  if(pIIS == 0)
    _Ps = _Ps + GetRubSumByClientFromDepo(pClient, string(NpTxKindsStr), pBeg, pEnd); //созданные в операции "Расчет и начисление дохода" в депозитарии
  end;

  return _Ps;
end;

private macro GetPm(NpTxKindsStr:string, AddWhereCond)
  var _Pm = $0;

  _Pm = GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_CALCNDFL, null, pIIS, AddWhereCond) + //созданные в операциях расчета НОБ
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, 0 /*только пользовательские*/,null, pIIS, AddWhereCond) +
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, NULL, DL_HOLDNDFL, null, pIIS, AddWhereCond) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
        GetRubSumByClientOperDocKind(pClient, string(NpTxKindsStr), pBeg, pEnd, DL_RETIREMENT_OWN, null, pIIS, AddWhereCond) + //созданные в операциях погашения ОЭБ
        /*плюс операции в ПС <Векселя банка>*/
        GetRubSumByClientFromVeksel(pClient, string(NpTxKindsStr), pBeg, pEnd, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                               string(DL_VSBARTERORDER)  +", "+ //мена
                                                                               string(DL_VSINTERCHANGE) );      //зачет взаимных требований


  if(pIIS == 0)
    _Pm = _Pm + GetRubSumByClientFromDepo(pClient, string(NpTxKindsStr), pBeg, pEnd); //созданные в операции "Расчет и начисление дохода" в депозитарии
  end;

  return _Pm;
end;


//Получить налоги при обработке заявления на вовзрат
MACRO CalcTaxDueReq( Oper/*NPTXOP*/, pStep, SumReestr, Taxe:@money, Taxe15:@money, retDs:@money, retDg:@money, retDp:@money, retDm:@money )
  var S, S15, Year, Bg=$0, Bm=$0, Bs=$0, Bp=$0, Dm=$0, Ds=$0, Dg=$0, Dp=$0, SN=$0, Pg=$0, Pm=$0, Ps=$0, Pp=$0;
  var Bg1 = $0, Bg2_2 = $0, Bg2_3 = $0, Bg9 = $0, Pg1 = $0, Pg2 = $0, Pg9 = $0, Pp1 = $0, Pp2 = $0, Pp9 = $0;
  var Dg1 = $0, Dg2 = $0, Dg9 = $0, Dp1 = $0, Dp2 = $0, Dp9 = $0;
  var ToutNat = $0;
  var query, cmd, DataSet;
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var AddWhereFromOut = " obj.t_FromOutSyst = 'X'";

  stat = 0;

  Taxe   = $0; //Уплаченный налог по базовой ставке по сформированным в этой ф-ции НДР
  Taxe15 = $0; //Уплаченный налог по повышенной ставке по сформированным в этой ф-ции НДР

  retDs = $0;
  retDg = $0;
  retDp = $0;
  retDm = $0;

  ОпределитьПараметрыРасчета(Oper);
  
  if((Oper.rec.DocKind != DL_RETREQ) or (pIIS != 0))
    return 0;
  end;

  GetBegDate(Oper, true);

  DateSplit(Oper.rec.PrevDate, null, null, Year);

  //НОБ считаем по дату последнего расчета окончания года из заявления
  var BegDateTB = date(1, 1, Year);
  var EndDateTB = date(31, 12, Year);

  query =   "select nvl(max(OpDate), "+GetSQlDate(date(0,0,0))+") as MaxOperDate"
          + "  from (select t_OperDate as OpDate"
          + "          from dnptxop_dbt "
          + "         where t_DocKind = "+DL_WRTMONEY
          + "           and t_Client = ? "
          + "           and t_OperDate >= ? "
          + "           and t_OperDate <= ? "
          + "           and t_OperDate <= ? "
          + "           and t_IIS = CHR(0) "
          + "           and t_Subkind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF
          + "        union "
          + "        select t_OperDate as OpDate"
          + "          from dnptxop_dbt "
          + "         where t_DocKind = "+DL_CALCNDFL
          + "           and t_Client = ? "
          + "           and t_OperDate >= ? "
          + "           and t_OperDate <= ? "
          + "           and t_OperDate <= ? "
          + "           and t_IIS = CHR(0) "
          + "           and t_Subkind_Operation = " + DL_TXBASECALC_OPTYPE_ENDYEAR
          + "        union "
          + "        select t_EndRecalcDate as OpDate "
          + "          from dnptxop_dbt "
          + "         where t_DocKind = "+DL_HOLDNDFL
          + "           and t_Client = ? "
          + "           and t_PrevDate = ? "
          + "           and t_OperDate <= ? "
          + "           and t_IIS = CHR(0) "
          + "           and t_SubKind_Operation IN ("+DL_TXHOLD_OPTYPE_ENDYEAR+", "+DL_TXHOLD_OPTYPE_OUTMONEY+")"
          + "       )";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(pClient);
  cmd.AddParam(BegDateTB);
  cmd.AddParam(EndDateTB);
  cmd.AddParam(Oper.rec.OperDate);

  cmd.AddParam(pClient);
  cmd.AddParam(BegDateTB);
  cmd.AddParam(EndDateTB);
  cmd.AddParam(Oper.rec.OperDate);

  cmd.AddParam(pClient);
  cmd.AddParam(EndDateTB);
  cmd.AddParam(Oper.rec.OperDate);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    EndDateTB = date(DataSet.MaxOperDate);
  end; 


  //Налог считаем до даты заявления или до конца года заявления (смотря, что раньше)
  pBeg = date(1, 1, Year);
  pEnd = IIF(Oper.rec.OperDate < date(31, 12, Year), Oper.rec.OperDate, date(31, 12, Year));

  var StartSTBDate = GetStartSTBDate();
  if((РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ()) and (StartSTBDate > date(0,0,0)) and (pEnd >= StartSTBDate))
    query =   " select NVL(SUM((CASE WHEN t_RateHoldPITax = "+int(NPTXGENTAXRATE_RESIDENT*100)+" THEN t_HoldPITax ELSE 0 END)), 0) as SumHoldPITax13, "
            + "        NVL(SUM((CASE WHEN t_RateCalcPITax = "+int(NPTXGENTAXRATE_RESIDENT*100)+" THEN t_CalcPITax ELSE 0 END)), 0) as SumCalcPITax13, "
            + "        NVL(SUM((CASE WHEN t_RateHoldPITax = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" THEN t_HoldPITax ELSE 0 END)), 0) as SumHoldPITax15, "
            + "        NVL(SUM((CASE WHEN t_RateCalcPITax = "+int(NPTXGENTAXRATE_RESIDENT_15*100)+" THEN t_CalcPITax ELSE 0 END)), 0) as SumCalcPITax15 "
            + "   from dnptxtotalbase_dbt "
            + "  where t_ClientID = ? "
            + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
            + "    and t_TaxPeriod = ? "
            + "    and ((t_IncDate BETWEEN ? AND ?) or (t_IncDate > ? and ? = TO_DATE('31.12.'||TO_CHAR(t_TaxPeriod),'DD.MM.YYYY')))";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(Oper.rec.Client);
    cmd.AddParam(Year);
    cmd.AddParam(pBeg);
    cmd.AddParam(pEnd);
    cmd.AddParam(pEnd);
    cmd.AddParam(pEnd);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Dg = DataSet.SumCalcPITax13 - DataSet.SumHoldPITax13;
      Dp = DataSet.SumCalcPITax15 - DataSet.SumHoldPITax15;
    end;

  else
  
    if((Year >= 2021) and (IsPartyResident()) and (pIIS == 0))
      Bg1 = GetRubSumByClient(pClient, string(TXOBJ_BASEG1), BegDateTB, EndDateTB, null, pIIS, null, AddWhereNotOut);
      Pg1 = GetPg(TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, AddWhereNotOut);
      Pp1 = GetPp(TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_1_0, AddWhereNotOut); 
      Dg1 = round(Rg() * Min(Bg1, NPTX_LIMINCOME_MAX15) / 100.0 - Pg1, 0);
      Dp1 = round(Rp() * Max(Bg1-NPTX_LIMINCOME_MAX15, $0) / 100.0 - Pp1, 0);

      Bg2_2 = GetRubSumByClient(pClient, TXOBJ_BASEG2, BegDateTB, EndDateTB, null, pIIS);
      Bg2_3 = GetRubSumByClient(pClient, TXOBJ_BASEG3, BegDateTB, EndDateTB, null, pIIS);
      Pg2 = GetPg(TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0+","+TXOBJ_PAIDMATERIAL);
      Pp2 = GetPp(TXOBJ_PAIDGENERAL_15_2)+GetPp(TXOBJ_PAIDGENERAL_15,AddWhereFromOut);
      Dg2 = round(Rg() * Min(Bg2_2, NPTX_LIMINCOME_MAX15) / 100.0 + Rg() * Min(Bg2_3, NPTX_LIMINCOME_MAX15) / 100.0 - Pg2, 0);
      Dp2 = round(Rp() * Max(Bg2_2-NPTX_LIMINCOME_MAX15, $0) / 100.0 + Rp() * Max(Bg2_3-NPTX_LIMINCOME_MAX15, $0) / 100.0 - Pp2, 0);

      Bg9 = GetRubSumByClient(pClient, string(TXOBJ_BASEG9), BegDateTB, EndDateTB, null, pIIS);
      Pg9 = GetPg(TXOBJ_PAIDBILL);
      Pp9 = GetPp(TXOBJ_PAIDGENERAL_15_9);
      Dg9 = round(Rg() * Min(Bg9, NPTX_LIMINCOME_MAX15) / 100.0 - Pg9, 0);
      Dp9 = round(Rp() * Max(Bg9-NPTX_LIMINCOME_MAX15, $0) / 100.0 - Pp9, 0);

      Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL), BegDateTB, EndDateTB, null, pIIS);
      Ps = GetPs(TXOBJ_PAIDSPECIAL+ ","+TXOBJ_PAIDSPECIAL_0);

      Dg = Dg1 + Dg2 + Dg9;
      Dp = Dp1 + Dp2 + Dp9;

      Ds = Rs() * Bs / 100.0 - Ps;
    elif((IsPartyResident() == false) and (pIIS == 0))
      
      Bg  =   GetRubSumByClient(pClient, string(TXOBJ_BASEGENERAL), BegDateTB, EndDateTB, null, pIIS, null, AddWhereNotOut)
            + GetRubSumByClient(pClient, string(TXOBJ_BASEG2), BegDateTB, EndDateTB, null, pIIS, null, AddWhereFromOut);

      Bm = GetRubSumByClient(pClient, string(TXOBJ_BASEMATERIAL), BegDateTB, EndDateTB, null, pIIS);
      Bs = GetRubSumByClient(pClient, string(TXOBJ_BASESPECIAL_DIV), BegDateTB, EndDateTB, null, pIIS, null, AddWhereNotOut);

      Pg = GetPg(TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0);
      Pm = GetPm(TXOBJ_PAIDMATERIAL);
      Ps = GetPs(TXOBJ_DIVPAY_SEC+","+TXOBJ_DIVPAY_SEC_0, AddWhereNotOut);
      
      Dg = Rg() * Bg / 100.0 - Pg;
      Dm = Rg() * Bm / 100.0 - Pm;
      Ds = Rs() * Bs / 100.0 - Ps;
    end;
  end;

  query =   " select NVL(SUM(t_TaxToPay-t_TaxSum), 0) as Sosn_prev, "
          + "        NVL(SUM(t_TaxDp-t_TaxSum2), 0) as Spov_prev "
          + "   from dnptxop_dbt "
          + "  where t_DocKind = "+DL_RETREQ
          + "    and t_Status IN ("+DLNPTXRETREQ_CHECKED+", "+DLNPTXRETREQ_PARTEXECUTED+") "
          + "    and t_OperDate <= ? "
          + "    and t_Client = ? "
          + "    and t_ID <> ?";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(Oper.rec.OperDate);
  cmd.AddParam(Oper.rec.Client);
  cmd.AddParam(Oper.rec.ID);

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    Dg = min(Dg + DataSet.Sosn_prev, 0);
    Dp = min(Dp + DataSet.Spov_prev, 0);
  end;

  Dg = round(Dg,0);
  Dm = round(Dm,0);         
  Ds = round(Ds,0);
  Dp = round(Dp,0);

  retDs = Ds;
  retDg = Dg;
  retDp = Dp;
  retDm = Dm;

  return stat;
END;

//////////////////////////////////////////////////////////////////
//НДР 9 
//////////////////////////////////////////////////////////////////

MACRO CreateMaterialTaxObjects9( Oper/*NPTXOP*/, pStep )
   var Year, Query, sql, rsd, Sgr, Stm, TaxPM, TaxPM0, TaxPMN, S, C2, C1, 
       ArrayOfKinds = TArray(), ArrayOfValues = TArray();
   stat = 0;

   if ( УчитыватьНалогНаМатВыгоду() != true)  /* Проверка настройки -Учитывать налог на мат. выгоду в затратах-*/
       return  stat;
   end;

   ОпределитьПараметрыРасчета(Oper);
   GetBegDate(Oper, true);

   DateSplit(Oper.rec.OperDate, null, null, Year);
   pBeg = IIF(pDocKind == DL_HOLDNDFL, Oper.rec.PrevDate, IIF(pIIS, GetFirstDateIIS(pClient, GetDlCOntrIDByNPTXOP(Oper)), date(1, 1, Year)));

   Sgr = GetRubSumByClient(pClient, string(IIF(pIIS, TXOBJ_PAIDMATERIAL_IIS, TXOBJ_PAIDMATERIAL)), pBeg, pEnd, null, pIIS);

   Query =   "select NM.* "
           + "  from dnptxobj_dbt NM, ddl_tick_dbt Deal, ddlrq_dbt RQ, "                                                         
           + "       (SELECT t_Kind_Operation, rsb_secur.get_OperationGroup(t_SysTypes) oGrp "
           + "          FROM doprkoper_dbt) Opr "
           + " where NM.t_Kind   = " + string(TXOBJ_MATERIAL)
           + "   and NM.t_Client = ? "
           +  " AND RSI_NPTO.CheckObjIIS (NM.t_AnaliticKind6, NM.t_Analitic6 )  = ? "
           + "   and NM.t_Date  >= ? "
           + "   and NM.t_Date  <= ? "
           + "   and NM.t_AnaliticKind1 in(" + string(TXOBJ_KIND1010) + "," + string(TXOBJ_KIND1070) + ")"
           + "   and NM.t_Analitic1 = Deal.t_DealID "
           + "   and Deal.t_DealID = RQ.t_DocID "
           + "   and Deal.t_dealdate <  TO_DATE('01.01.2018','DD.MM.YYYY') "
           + "   and Opr.t_Kind_Operation = Deal.t_DealType "
           + "   and RQ.t_SubKind    = " + string(DLRQ_SUBKIND_AVOIRISS)
           + "   and RQ.t_Type       = " + string(DLRQ_TYPE_DELIVERY)
           + "   and RQ.t_DealPart   = 1 "
           + "   and RQ.t_DocKind IN ( " + string(DL_SECURITYDOC) + ", " + string(DL_AVRWRT) + ") "
           + "   and ( (Rsb_Secur.IsBuy(Opr.oGrp) = 1 "
           + "          and ( (Rsb_Secur.IsRepo(Opr.oGrp) = 0 and Rsb_Secur.IsLoan(Opr.oGrp) = 0) or " 
           + "                (RSI_NPTX.CheckCateg(" + string(OBJTYPE_SECDEAL) + ", 23, LPAD(Deal.t_DealID, 34, '0'), 2)=1 ) " 
           + "              ) " 
           + "         ) or Rsb_Secur.IsAvrWrtIn(Opr.oGrp) = 1 " 
           + "       ) " 
           + " order by RQ.t_FactDate, Deal.t_DealDate, Deal.t_DealTime, LPAD(RTRIM(NVL(Deal.t_DealCodeTS, Deal.t_DealCode)), 30, ' ' ), NM.t_Date ";

   sql =  DL_RsdCommand(Query);
   sql.addParam( pClient );
   sql.addParam( pIIS);
   sql.addParam( pBeg );
   sql.addParam( pEnd );

   rsd = sql.execute();
   while((stat == 0) and rsd.moveNext() and (Sgr > 0))

      Stm = rsd.Sum0 * Rg();
      C2 = MIN (Stm, Sgr);

      ArrayOfKinds(0)  = 0;
      ArrayOfValues(0) = 0;

      ArrayOfKinds(1)  = rsd.AnaliticKind1;
      ArrayOfValues(1) = rsd.Analitic1;

      ArrayOfKinds(2)  = 0;
      ArrayOfValues(2) = 0;

      ArrayOfKinds(3)  = rsd.AnaliticKind3;
      ArrayOfValues(3) = rsd.Analitic3;

      ArrayOfKinds(4)  = rsd.AnaliticKind4;
      ArrayOfValues(4) = rsd.Analitic4;    

      ArrayOfKinds(5)  = rsd.AnaliticKind5;
      ArrayOfValues(5) = rsd.Analitic5;    

      ArrayOfKinds(6)  = 0;
      ArrayOfValues(6) = 0;

      DL_GetNPTXOBJSum(null, null, null, string(TXOBJ_TAXPM), pBegDate, pEndDate, 
                       null, @TaxPM, @TaxPM0, @TaxPMN, pClient, ArrayOfKinds, ArrayOfValues, null,null,null,null, pIIS );
      C1 = TaxPM0;
      S = C2 - C1;

      S = S + GetSumNPTXOBJTech(Oper.rec.ID,
                                pEndDate,
                                pCLient,
                                TXOBJ_TAXPM,
                                rsd.AnaliticKind1,
                                rsd.Analitic1,
                                rsd.AnaliticKind2,
                                rsd.Analitic2,
                                rsd.AnaliticKind3,
                                rsd.Analitic3,
                                rsd.AnaliticKind4,
                                rsd.Analitic4,
                                rsd.AnaliticKind5,
                                rsd.Analitic5,
                                rsd.AnaliticKind6,
                                rsd.Analitic6,
                                Oper.rec.Recalc);
      if ((stat == 0) and (S != 0))
         InsertTaxObjectTmp( pEndDate,
                             pClient,
                             TXOBJ_DIR_OUT,
                             9,
                             UNSET_CHAR,
                             TXOBJ_TAXPM,
                             S,
                             NATCUR,
                             rsd.AnaliticKind1,
                             rsd.Analitic1,
                             rsd.AnaliticKind2,
                             rsd.Analitic2,
                             rsd.AnaliticKind3,
                             rsd.Analitic3,
                             rsd.AnaliticKind4,
                             rsd.Analitic4,
                             rsd.AnaliticKind5,
                             rsd.Analitic5,
                             rsd.AnaliticKind6,
                             rsd.Analitic6,
                             "Налог, уплаченный на матвыгоду",
                             pDocID,
                             pStep,
                             0,
                             Oper.rec.Recalc
                           );
      end;

      Sgr = Sgr - C2;
   end;

   return stat;
END;

private macro _convertCurr(outVal:@money, inVal:money, ondate:date, fromCurr, toCurr ): bool
    var stat: bool = true;
    if (fromCurr != toCurr)
        stat = ConvSumDbl( outVal, inVal, onDate, fromCurr, toCurr, true, 7 /*ЦБ РФ*/ );
        SetParm(0, outVal); // передаем по ссылке
    end;
    return stat;
end;


CLASS TxObjData(_ObjSum, _ObjCurr, _ObjSymb)
  var ObjSum  = _ObjSum;
  var ObjCurr = _ObjCurr;
  var ObjSymb = _ObjSymb;
END;

MACRO GetTxObjFromParmStr(ParmStr, ObjKind, TxObjArr:@TArray)
  var pos;
  var Str = ParmStr;
  var findstr = "<"+ObjKind+">";
  var ObjSum = $0, ObjCurr = -1, ObjSymb = "";
  
  TxObjArr = TArray();
  TxObjArr.size = 0;

  pos = Index(Str, findstr);
  while(pos)
    Str = substr(Str, pos);
    Str = substr(Str, strlen("<"+ObjKind+">")+1);

    ObjSum = money(substr(Str, 1, Index(Str, ";")-1));
    Str = substr(Str, Index(Str, ";")+1); 

    ObjCurr = int(substr(Str, 1, Index(Str, ";")-1));
    Str = substr(Str, Index(Str, ";")+1);
    
    ObjSymb = string(substr(Str, 1, Index(Str, "<\\")-1));

    TxObjArr[TxObjArr.size] = TxObjData(ObjSum, ObjCurr, ObjSymb);

    pos = Index(Str, "<"+ObjKind+">" );
  end;
END;

MACRO CreateRecalcDivRetTaxObjects(tickRec, legRec, TaxGet13_rub_new, TaxGet15_rub_new, TaxPay13_rub_new, TaxPay15_rub_new, pDocID, ID_Step, ParmStr, securIsCirc, TaxGroup)
   var amountTxDiv_new = $0, amountTxDiv15_new = $0;
   var CatCred_new;

   const FactReceiverID = tickRec.rec.FactReceiverID;

   var BenefContrID = -1; 
   var KindContr    = 0;

   var DivDeal_rub = legRec.rec.Cost;
   if(_convertCurr(DivDeal_rub, DivDeal_rub, tickRec.rec.DealDate, tickRec.rec.CurGet, NATCUR) == false)
      return 1;
   end;

   if(_convertCurr(TaxGet13_rub_new, TaxGet13_rub_new, tickRec.rec.DealDate, tickRec.rec.CurGet, NATCUR) == false)
      return 1;
   end;

   if(_convertCurr(TaxGet15_rub_new, TaxGet15_rub_new, tickRec.rec.DealDate, tickRec.rec.CurGet, NATCUR) == false)
      return 1;
   end;

   if(_convertCurr(TaxPay13_rub_new, TaxPay13_rub_new, tickRec.rec.DealDate, legRec.rec.CFI, NATCUR) == false)
      return 1;
   end;

   if(_convertCurr(TaxPay15_rub_new, TaxPay15_rub_new, tickRec.rec.DealDate, legRec.rec.CFI, NATCUR) == false)
      return 1;
   end;

   SP_GetTaxAmountInRetDivid(tickRec.rec.ClientID, tickRec.rec.PartyID, tickRec.rec.FactReceiverID, DivDeal_rub, TaxPay13_rub_new, TaxGet13_rub_new,
                             TaxPay15_rub_new, TaxGet15_rub_new, @amountTxDiv_new, @CatCred_new, @amountTxDiv15_new);

   if(amountTxDiv_new != 0.0)
      //  DivPay_Sec
      InsertTaxObjectTmp( tickRec.rec.DealDate   // Дата НДР
                          ,FactReceiverID        // Фактический получатель дохода
                          ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                          ,TXOBJ_LEVEL4          // Уровень
                          ,UNSET_CHAR            // Признак "Пользовательский"
                          ,TXOBJ_DIVPAY_SEC      // Вид НДР
                          ,amountTxDiv_new       // Сумма из проводки "Удержание налога"     /*TaxGet_rub*/            // Сумма дохода/расхода
                          ,NATCUR                // Валюта дохода/расхода
                          ,TXOBJ_KIND1100        // Вид аналитики 1
                          ,tickRec.rec.DealID    // Аналитика 1
                          ,0                     // Вид аналитики 2
                          ,-1                    // Аналитика 2
                          ,TXOBJ_KIND3010        // Вид аналитики 3
                          ,tickRec.rec.PFI       // Аналитика 3
                          ,TXOBJ_KIND4010        // Вид аналитики 4
                          ,securIsCirc           // Аналитика 4
                          ,TXOBJ_KIND5010        // Вид аналитики 5
                          ,TaxGroup              // Аналитика 5
                          ,KindContr             // Вид аналитики 6
                          ,BenefContrID          // Аналитика 6
                          ,"Уплаченный налог на дивиденды"   // Комментарий
                          , pDocID               // ID операции
                          , ID_Step              // ID шага операции
                          , amountTxDiv_new      // Сумма реестра
                          ,0                     // Признак вызова не из операции расчета НОБ
                          ,SET_CHAR);            // Пересчет
   end;

   if(TaxGet13_rub_new != 0.0)
      InsertTaxObjectTmp( tickRec.rec.DealDate   // Дата НДР
                          ,FactReceiverID        // Фактический получатель дохода
                          ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                          ,TXOBJ_LEVEL4          // Уровень
                          ,UNSET_CHAR            // Признак "Пользовательский"
                          ,TXOBJ_DIVPAY_SEC_0    // Вид НДР
                          ,TaxGet13_rub_new - amountTxDiv_new // Сумма
                          ,NATCUR                // Валюта дохода/расхода
                          ,TXOBJ_KIND1100        // Вид аналитики 1
                          ,tickRec.rec.DealID    // Аналитика 1
                          ,0                     // Вид аналитики 2
                          ,-1                    // Аналитика 2
                          ,TXOBJ_KIND3010        // Вид аналитики 3
                          ,tickRec.rec.PFI       // Аналитика 3
                          ,TXOBJ_KIND4010        // Вид аналитики 4
                          ,securIsCirc           // Аналитика 4
                          ,TXOBJ_KIND5010        // Вид аналитики 5
                          ,TaxGroup              // Аналитика 5
                          ,KindContr             // Вид аналитики 6
                          ,BenefContrID          // Аналитика 6
                          ,"Уплаченный налог на дивиденды покупателем 1 ч. РЕПО"   // Комментарий
                          , pDocID               // ID операции
                          , ID_Step              // ID шага операции
                          , 0                    // Сумма реестра
                          ,0                     // Признак вызова не из операции расчета НОБ
                          ,SET_CHAR);            // Пересчет
   end;

   if(amountTxDiv15_new != 0)
      InsertTaxObjectTmp( tickRec.rec.DealDate               // Дата НДР
                          ,FactReceiverID                    // Клиент
                          ,TXOBJ_DIR_OUT                     // Направление
                          ,TXOBJ_LEVEL8                      // Уровень
                          ,UNSET_CHAR                        // Признак "Пользовательский"
                          ,TXOBJ_PAIDGENERAL_15_1            // Вид НДР
                          ,amountTxDiv15_new                 // Сумма дохода/расхода
                          ,NATCUR                            // Валюта дохода/расхода
                          ,TXOBJ_KIND1100                    // Вид аналитики 1
                          ,tickRec.rec.DealID                       // Аналитика 1
                          ,0                                 // Вид аналитики 2
                          ,-1                                // Аналитика 2
                          ,0                                 // Вид аналитики 3
                          ,-1                                // Аналитика 3
                          ,0                                 // Вид аналитики 4
                          ,-1                                // Аналитика 4
                          ,0                                 // Вид аналитики 5
                          ,-1                                // Аналитика 5
                          ,KindContr                         // Вид аналитики 6
                          ,BenefContrID                      // Аналитика 6
                          ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                          ,pDocID                            // ID операции
                          ,ID_Step                           // ID шага операции
                          ,amountTxDiv15_new                 // Сумма реестра
                          ,0
                          ,SET_CHAR);                        // Пересчет

   end;

   if(TaxGet15_rub_new - amountTxDiv15_new != 0)
      InsertTaxObjectTmp( tickRec.rec.DealDate              // Дата НДР
                         ,FactReceiverID                    // Клиент
                         ,TXOBJ_DIR_OUT                     // Направление
                         ,TXOBJ_LEVEL8                      // Уровень
                         ,UNSET_CHAR                        // Признак "Пользовательский"
                         ,TXOBJ_PAIDGENERAL_15_1_0          // Вид НДР
                         ,TaxGet15_rub_new - amountTxDiv15_new // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,TXOBJ_KIND1100                    // Вид аналитики 1
                         ,tickRec.rec.DealID                       // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,KindContr                         // Вид аналитики 6
                         ,BenefContrID                      // Аналитика 6
                         ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                         ,pDocID                            // ID операции
                         ,ID_Step                           // ID шага операции
                         ,TaxGet15_rub_new - amountTxDiv15_new // Сумма реестра
                         ,0
                         ,SET_CHAR);                        // Пересчет

      InsertTaxObjectTmp( tickRec.rec.DealDate     // Дата НДР
                         ,FactReceiverID           // Клиент
                         ,TXOBJ_DIR_OUT            // Направление
                         ,TXOBJ_LEVEL8             // Уровень
                         ,UNSET_CHAR               // Признак "Пользовательский"
                         ,TXOBJ_PAIDGENERAL_15     // Вид НДР
                         ,TaxGet15_rub_new - amountTxDiv15_new // Сумма дохода/расхода
                         ,NATCUR                   // Валюта дохода/расхода
                         ,TXOBJ_KIND1100           // Вид аналитики 1
                         ,tickRec.rec.DealID       // Аналитика 1
                         ,0                        // Вид аналитики 2
                         ,-1                       // Аналитика 2
                         ,0                        // Вид аналитики 3
                         ,-1                       // Аналитика 3
                         ,0                        // Вид аналитики 4
                         ,-1                       // Аналитика 4
                         ,0                        // Вид аналитики 5
                         ,-1                       // Аналитика 5
                         ,KindContr                // Вид аналитики 6
                         ,BenefContrID             // Аналитика 6
                         ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                         ,pDocID                   // ID операции
                         ,ID_Step                  // ID шага операции
                         ,0                        // Сумма реестра
                         ,0
                         ,SET_CHAR);               // Пересчет
   end;

   return 0;
END;

MACRO CreateRecalcDivTaxObjCarrySum(ID_Operation, ID_Step, ParmStr, ValueDate, PartyID, DivDeal_rub, FIID, AnaliticKind1, Analitic1, securIsCirc,
                                            TaxGroup, KindContr, BenefContrID, D1, D2)
   if(ParmStr == "")
      var bFactReceiverNeresid = IsNeresidentForNUTX(PartyID, ValueDate);

      if(  bFactReceiverNeresid == false) // Резидент  PlusG_1010 
         if(DivDeal_rub != $0)
            InsertTaxObjectTmp( ValueDate              // Дата НДР
                                ,PartyID        // Фактический получатель дохода
                                ,TXOBJ_DIR_IN          // Направление /*Доход*/
                                ,TXOBJ_LEVEL5          // Уровень
                                ,UNSET_CHAR            // Признак "Пользовательский"
                                ,TXOBJ_PLUSG_1010      // Вид НДР
                                ,DivDeal_rub           // Сумма дохода/расхода
                                ,NATCUR                // Валюта дохода/расхода
                                ,AnaliticKind1         // Вид аналитики 1
                                ,Analitic1             // Аналитика 1
                                ,0                     // Вид аналитики 2
                                ,-1                    // Аналитика 2
                                ,TXOBJ_KIND3010        // Вид аналитики 3
                                ,FIID                  // Аналитика 3
                                ,TXOBJ_KIND4010        // Вид аналитики 4
                                ,securIsCirc           // Аналитика 4
                                ,TXOBJ_KIND5010        // Вид аналитики 5
                                ,TaxGroup              // Аналитика 5
                                ,KindContr             // Вид аналитики 6
                                ,BenefContrID          // Аналитика 6
                                ,"ФЛ=нерезидент"       // Комментарий
                                , ID_Operation         // ID операции
                                , ID_Step              // ID шага операции
                                , 0                    // Сумма реестра
                                , 0                    // Признак вызова не из операции расчета НОБ
                                , SET_CHAR);           // Пересчет
         end;
      else
         InsertTaxObjectTmp( ValueDate              // Дата НДР
                             ,PartyID               // Фактический получатель дохода
                             ,TXOBJ_DIR_IN          // Направление /*Доход*/
                             ,TXOBJ_LEVEL5          // Уровень
                             ,UNSET_CHAR            // Признак "Пользовательский"
                             ,TXOBJ_PLUS15_1010     // Вид НДР
                             ,DivDeal_rub           // Сумма дохода/расхода
                             ,NATCUR                // Валюта дохода/расхода
                             ,AnaliticKind1         // Вид аналитики 1
                             ,Analitic1             // Аналитика 1
                             ,0                     // Вид аналитики 2
                             ,-1                    // Аналитика 2
                             ,TXOBJ_KIND3010        // Вид аналитики 3
                             ,FIID                  // Аналитика 3
                             ,TXOBJ_KIND4010        // Вид аналитики 4
                             ,securIsCirc           // Аналитика 4
                             ,TXOBJ_KIND5010        // Вид аналитики 5
                             ,TaxGroup              // Аналитика 5
                             ,KindContr             // Вид аналитики 6
                             ,BenefContrID          // Аналитика 6
                             ,"ФЛ=нерезидент"       // Комментарий
                             , ID_Operation         // ID операции
                             , ID_Step              // ID шага операции
                             , 0                    // Сумма реестра
                             ,0                     // Признак вызова не из операции расчета НОБ
                             ,SET_CHAR);            // Пересчет
      end;

      var amount = 0;
      if ( D2 != 0 )
          amount = DivDeal_rub * D1/D2;
      end;
      if(  bFactReceiverNeresid == false  ) // Резидент  MinusG_601  
         InsertTaxObjectTmp( ValueDate              // Дата НДР
                             ,PartyID               // Фактический получатель дохода
                             ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                             ,TXOBJ_LEVEL5          // Уровень
                             ,UNSET_CHAR            // Признак "Пользовательский"
                             ,TXOBJ_MINUSG_601      // Вид НДР
                             ,amount                // Сумма дохода/расхода
                             ,NATCUR                // Валюта дохода/расхода
                             ,AnaliticKind1         // Вид аналитики 1
                             ,Analitic1             // Аналитика 1
                             ,0                     // Вид аналитики 2
                             ,-1                    // Аналитика 2
                             ,TXOBJ_KIND3010        // Вид аналитики 3
                             ,FIID                  // Аналитика 3
                             ,TXOBJ_KIND4010        // Вид аналитики 4
                             ,securIsCirc           // Аналитика 4
                             ,TXOBJ_KIND5010        // Вид аналитики 5
                             ,TaxGroup              // Аналитика 5
                             ,KindContr             // Вид аналитики 6
                             ,BenefContrID          // Аналитика 6
                             ,"ФЛ=резидент"         // Комментарий
                             , ID_Operation         // ID операции
                             , ID_Step              // ID шага операции     
                             , 0                    // Сумма реестра
                             , 0                    // Признак вызова не из операции расчета НОБ
                             , SET_CHAR);           // Пересчет
      end;

      var comment = "";
      if ( bFactReceiverNeresid == false )
          amount = max(DivDeal_rub-amount/*MinusG_601*/, 0);  // вычислили выше MinusG_601
          comment = "ФЛ = резидент";
      else
          amount = DivDeal_rub;
          comment = "ФЛ=нерезидент";
      end;      

      InsertTaxObjectTmp( ValueDate              // Дата НДР
                          ,PartyID               // Фактический получатель дохода
                          ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                          ,TXOBJ_LEVEL7          // Уровень
                          ,UNSET_CHAR            // Признак "Пользовательский"
                          ,TXOBJ_BASESPECIAL_DIV // Вид НДР
                          ,amount                // Сумма дохода/расхода
                          ,NATCUR                // Валюта дохода/расхода
                          ,AnaliticKind1         // Вид аналитики 1
                          ,Analitic1             // Аналитика 1
                          ,0                     // Вид аналитики 2
                          ,-1                    // Аналитика 2
                          ,TXOBJ_KIND3010        // Вид аналитики 3
                          ,FIID                  // Аналитика 3
                          ,TXOBJ_KIND4010        // Вид аналитики 4
                          ,securIsCirc           // Аналитика 4
                          ,TXOBJ_KIND5010        // Вид аналитики 5
                          ,TaxGroup              // Аналитика 5
                          ,KindContr             // Вид аналитики 6
                          ,BenefContrID          // Аналитика 6
                          ,comment               // Комментарий
                          , ID_Operation         // ID операции
                          , ID_Step              // ID шага операции     
                          , 0                    // Сумма реестра
                          ,0                     // Признак вызова не из операции расчета НОБ
                          ,SET_CHAR);            // Пересчет
   end;
END;

MACRO CreateTransferRecalcTaxObjects(ParmStr, PartyID, ValueDate,          ID_Operation, ID_Step, AnaliticKind1, Analitic1, FIID, SecurIsCirc, TaxGroup, KindContr, BenefContrID)
   var PtIsRes = DL_GetPartyResident(PartyID);
   var TxObjArr = TArray();
   var sum = $0, Sum15 = $0, cur = -1;

   if((PtIsRes == NPTXPARTY_RESIDENT) and (ValueDate >= Date(1, 1, 2021)) and (ParmStr != ""))
      var i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_DIVPAY_SEC, @TxObjArr);
      while(i < TxObjArr.Size)
         if((AnaliticKind1 == TXOBJ_KIND1098) or (TxObjArr[i].ObjSymb == "R"))
            sum = TxObjArr[i].ObjSum;
            cur = TxObjArr[i].ObjCurr;
         else
            sum = $0;
         end;
         
         if(sum != $0)
            InsertTaxObjectTmp( ValueDate
                                ,PartyID
                                ,TXOBJ_DIR_OUT
                                ,4
                                ,""
                                ,TXOBJ_DIVPAY_SEC
                                ,sum
                                ,cur
                                ,AnaliticKind1
                                ,Analitic1
                                ,0
                                ,-1
                                ,TXOBJ_KIND3010
                                ,FIID
                                ,TXOBJ_KIND4010
                                ,SecurIsCirc
                                ,TXOBJ_KIND5010
                                ,TaxGroup              // Аналитика 5
                                ,KindContr             // Вид аналитики 6
                                ,BenefContrID          // Аналитика 6
                                ,"Уплаченный налог на дивиденды"   // Комментарий
                                ,ID_Operation          // ID операции
                                ,ID_Step               // ID шага операции
                                ,sum                   // Сумма реестра
                                ,0                     // Признак вызова не из операции расчета НОБ
                                ,SET_CHAR);            // Пересчет
         end;
         i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_PAIDGENERAL_15_1, @TxObjArr);
      while(i < TxObjArr.size)
 
        if((AnaliticKind1 == TXOBJ_KIND1098) or (TxObjArr[i].ObjSymb == "R"))
          sum = TxObjArr[i].ObjSum;
          cur = TxObjArr[i].ObjCurr;
        else
          sum = $0;
        end;
 
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate                         // Дата НДР
                              ,PartyID                           // Клиент
                              ,TXOBJ_DIR_OUT                     // Направление
                              ,TXOBJ_LEVEL8                      // Уровень
                              ,UNSET_CHAR                        // Признак "Пользовательский"
                              ,TXOBJ_PAIDGENERAL_15_1            // Вид НДР
                              ,sum                               // Сумма дохода/расхода
                              ,cur                               // Валюта дохода/расхода
                              ,AnaliticKind1                     // Вид аналитики 1
                              ,Analitic1                         // Аналитика 1
                              ,0                                 // Вид аналитики 2
                              ,-1                                // Аналитика 2
                              ,0                                 // Вид аналитики 3
                              ,-1                                // Аналитика 3
                              ,0                                 // Вид аналитики 4
                              ,-1                                // Аналитика 4
                              ,0                                 // Вид аналитики 5
                              ,-1                                // Аналитика 5
                              ,KindContr                         // Вид аналитики 6
                              ,BenefContrID                      // Аналитика 6
                              ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                              ,ID_Operation                      // ID операции
                              ,ID_Step                           // ID шага операции
                              ,sum                               // Сумма реестра
                              ,0
                              ,UNSET_CHAR                        // Пересчет
                             );
        end;
 
        Sum15 = Sum15 + sum;
 
        i = i + 1;
      end;

      if(Sum15 != 0)
         InsertTaxObjectTmp( ValueDate                 // Дата НДР
                            ,PartyID           // Клиент
                            ,TXOBJ_DIR_OUT            // Направление
                            ,TXOBJ_LEVEL8             // Уровень
                            ,UNSET_CHAR               // Признак "Пользовательский"
                            ,TXOBJ_PAIDGENERAL_15     // Вид НДР
                            ,Sum15                    // Сумма дохода/расхода
                            ,cur                      // Валюта дохода/расхода
                            ,AnaliticKind1            // Вид аналитики 1
                            ,Analitic1                // Аналитика 1
                            ,0                        // Вид аналитики 2
                            ,-1                       // Аналитика 2
                            ,0                        // Вид аналитики 3
                            ,-1                       // Аналитика 3
                            ,0                        // Вид аналитики 4
                            ,-1                       // Аналитика 4
                            ,0                        // Вид аналитики 5
                            ,-1                       // Аналитика 5
                            ,KindContr                // Вид аналитики 6
                            ,BenefContrID             // Аналитика 6
                            ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                            ,ID_Operation             // ID операции
                            ,ID_Step                  // ID шага операции
                            ,0                        // Сумма реестра
                            ,0
                            ,UNSET_CHAR               // Пересчет
                            );
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_PLUSG_1010, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate             // Дата НДР
                              ,PartyID               // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Доход*/
                              ,TXOBJ_LEVEL5          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_PLUSG_1010      // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,AnaliticKind1         // Вид аналитики 1
                              ,Analitic1             // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,TXOBJ_KIND3010        // Вид аналитики 3
                              ,FIID                  // Аналитика 3
                              ,TXOBJ_KIND4010        // Вид аналитики 4
                              ,SecurIsCirc           // Аналитика 4
                              ,TXOBJ_KIND5010        // Вид аналитики 5
                              ,TaxGroup              // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент"         // Комментарий
                              , ID_Operation         // ID операции
                              , ID_Step              // ID шага операции
                              , 0                    // Сумма реестра
                              , 0                    // Признак вызова не из операции расчета НОБ
                              , SET_CHAR);           // Пересчет

        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_MINUSG_601, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate             // Дата НДР
                              ,PartyID               // Фактический получатель дохода
                              ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                              ,TXOBJ_LEVEL5          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_MINUSG_601      // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,AnaliticKind1         // Вид аналитики 1
                              ,Analitic1             // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,TXOBJ_KIND3010        // Вид аналитики 3
                              ,FIID              // Аналитика 3
                              ,TXOBJ_KIND4010        // Вид аналитики 4
                              ,SecurIsCirc           // Аналитика 4
                              ,TXOBJ_KIND5010        // Вид аналитики 5
                              ,TaxGroup              // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент"         // Комментарий
                              ,ID_Operation          // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,0                     // Признак вызова не из операции расчета НОБ
                              ,SET_CHAR);            // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASESPECIAL_DIV, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate             // Дата НДР
                              ,PartyID               // Фактический получатель дохода
                              ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASESPECIAL_DIV // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,AnaliticKind1         // Вид аналитики 1
                              ,Analitic1             // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент"         // Комментарий
                              ,ID_Operation                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,0                     // Признак вызова не из операции расчета НОБ
                              ,SET_CHAR);            // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASESPECIAL_DIV_15, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate             // Дата НДР
                              ,PartyID               // Фактический получатель дохода
                              ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASESPECIAL_DIV_15 // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,AnaliticKind1         // Вид аналитики 1
                              ,Analitic1             // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент. Повышенная ставка"         // Комментарий
                              ,ID_Operation          // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,0                     // Признак вызова не из операции расчета НОБ
                              ,SET_CHAR);            // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASEG1, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate             // Дата НДР
                              ,PartyID               // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASEG1          // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,AnaliticKind1         // Вид аналитики 1
                              ,Analitic1             // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"Общая сумма дохода"  // Комментарий
                              ,ID_Operation          // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,0                     // Признак вызова не из операции расчета НОБ
                              ,SET_CHAR);            // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASEG1_13, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate             // Дата НДР
                              ,PartyID               // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASEG1_13       // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,AnaliticKind1         // Вид аналитики 1
                              ,Analitic1             // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"Сумма дохода по основной ставке"  // Комментарий
                              ,ID_Operation                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,0                     // Признак вызова не из операции расчета НОБ
                              ,SET_CHAR);            // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASEG1_15, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( ValueDate             // Дата НДР
                              ,PartyID               // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASEG1_15       // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,AnaliticKind1         // Вид аналитики 1
                              ,PartyID               // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"Сумма дохода по повышенной ставке"  // Комментарий
                              ,ID_Operation          // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,0                     // Признак вызова не из операции расчета НОБ
                              ,SET_CHAR);            // Пересчет
         end;

        i = i + 1;
      end;
   end;
END;

MACRO CreateDividendTaxObjects( ID_Operation, ID_Step: integer, tickRec, legRec, DivDeal  )

    var tick = tickRec.rec;
    var leg  = legRec.rec; 

    var TxObjArr = TArray(), i = 0, sum, cur;

    TaxObj = TInsertTaxObject();
 
    var  TaxGroup = 0; //GetTaxGroupNUTX(tick.PFI, tick.dealDate);
    var cmd  = DL_RSDCommand("select npto.GetPaperTaxGroupNPTX( ? ) TaxGroup from dual");
    cmd.addParam(tick.PFI);
    var rs = cmd.execute();
    if ( rs.MoveNext() )
        TaxGroup = rs.TaxGroup;
    end;

    const FactReceiverID = tick.FactReceiverID;
   
    //ОпределитьПараметрыРасчета(nptx);
    pDocID = ID_Operation;

    // Определение обращаемости бумаги
    var  securIsCirc = 2; // Не обращается
    cmd = DL_RSDCommand("select NPTO.IfMarket(?, ?) ifMarket from dual;");
    cmd.addParam(tick.PFI);
    cmd.addParam(tick.DealDate);
    rs = cmd.execute();
    if ( rs.MoveNext() and (rs.ifMarket == "X") )
        securIsCirc = 1; // в обращении
    end;
  
    // ----------------
    var BenefContrID = -1; 
    var KindContr    = 0;//TXOBJ_KIND6020;
    /*if ( not SP_GetSfContrID( tickRec, BenefContrID) and ( BenefContrID <= 0 ) ) 
        KindContr = 0;
        BenefContrID = -1;
    end;*/

    var nptxprm = TRecHandler("nptxprm.dbt");
    var ParmStr = "";

    nptxprm.Clear();

    cmd = DL_RSDCommand("select * from dnptxprm_dbt where t_DocKind = ? and t_DocID = ?");
    cmd.AddParam(tick.BOfficeKind);
    cmd.AddParam(tick.DealID);

    rs = cmd.Execute();
    if(rs.moveNext())
      rs.GetRecord().CopyTo(nptxprm.rec);
      ParmStr = nptxprm.rec.ParmStr;
    end;

    var amountTxDiv = 0, amountTxDiv15 = 0, CatCred = 0;
    var TaxGet13_rub = leg.ReceiptAmount;
    if( _convertCurr(TaxGet13_rub, TaxGet13_rub, tick.dealDate, tick.CurGet, NATCUR) == false )
        return 1;
    end;
    var TaxGet15_rub = leg.ReceiverIncrTax;
    if( _convertCurr(TaxGet15_rub, TaxGet15_rub, tick.dealDate, tick.CurGet, NATCUR) == false )
        return 1;
    end;
    var DivDeal_rub = leg.Cost;
    if( _convertCurr(DivDeal_rub, DivDeal_rub, tick.dealDate, leg.CFI, NATCUR) == false )
        return 1;
    end;
    var TaxPay13_rub = Leg.ReturnIncome;
    if( _convertCurr(TaxPay13_rub, TaxPay13_rub, tick.dealDate, leg.CFI, NATCUR) == false )
        return 1;
    end;
    var TaxPay15_rub = Leg.PayerIncrTax;
    if( _convertCurr(TaxPay15_rub, TaxPay15_rub, tick.dealDate, leg.CFI, NATCUR) == false )
        return 1;
    end;
    SP_GetTaxAmountInRetDivid(tick.ClientID, tick.PartyID, tick.FactReceiverID,
                              DivDeal_rub, TaxPay13_rub, TaxGet13_rub, TaxPay15_rub, TaxGet15_rub, 
                              @amountTxDiv, @CatCred, @amountTxDiv15);

    // Div_Sec
    InsertTaxObjectTmp(tick.dealDate        // Дата НДР
                        ,FactReceiverID        // Фактический получатель дохода
                        ,TXOBJ_DIR_IN          // Направление /*Доход*/
                        ,TXOBJ_LEVEL4          // Уровень
                        ,UNSET_CHAR            // Признак "Пользовательский"
                        ,TXOBJ_DIV_SEC         // Вид НДР
                        ,DivDeal               // Сумма дохода/расхода
                        ,tick.CurGet           // Валюта дохода/расхода
                        ,TXOBJ_KIND1100        // Вид аналитики 1
                        ,tick.DealID           // Аналитика 1
                        ,0                     // Вид аналитики 2
                        ,-1                    // Аналитика 2
                        ,TXOBJ_KIND3010        // Вид аналитики 3
                        ,tick.PFI              // Аналитика 3
                        ,TXOBJ_KIND4010        // Вид аналитики 4
                        ,securIsCirc           // Аналитика 4
                        ,TXOBJ_KIND5010        // Вид аналитики 5
                        ,TaxGroup              // Аналитика 5
                        ,KindContr             // Вид аналитики 6
                        ,BenefContrID          // Аналитика 6
                        ,"Дивиденды по выпуску ц/б"     // Комментарий
                        , pDocID               // ID операции
                        , ID_Step              // ID шага операции
                        , 0                    // Сумма реестра
                        ,1                     // Признак вызова не из операции расчета НОБ
                        ,UNSET_CHAR);          // Пересчет

    
    //  DivPay_Sec
    InsertTaxObjectTmp( tick.dealDate          // Дата НДР
                        ,FactReceiverID        // Фактический получатель дохода
                        ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                        ,TXOBJ_LEVEL4          // Уровень
                        ,UNSET_CHAR            // Признак "Пользовательский"
                        ,TXOBJ_DIVPAY_SEC      // Вид НДР
                        ,amountTxDiv           // Сумма из проводки "Удержание налога"     /*TaxGet_rub*/            // Сумма дохода/расхода
                        ,NATCUR                // Валюта дохода/расхода
                        ,TXOBJ_KIND1100        // Вид аналитики 1
                        ,tick.DealID           // Аналитика 1
                        ,0                     // Вид аналитики 2
                        ,-1                    // Аналитика 2
                        ,TXOBJ_KIND3010        // Вид аналитики 3
                        ,tick.PFI              // Аналитика 3
                        ,TXOBJ_KIND4010        // Вид аналитики 4
                        ,securIsCirc           // Аналитика 4
                        ,TXOBJ_KIND5010        // Вид аналитики 5
                        ,TaxGroup              // Аналитика 5
                        ,KindContr             // Вид аналитики 6
                        ,BenefContrID          // Аналитика 6
                        ,"Уплаченный налог на дивиденды"   // Комментарий
                        , pDocID               // ID операции
                        , ID_Step              // ID шага операции
                        , amountTxDiv          // Сумма реестра
                        ,1                     // Признак вызова не из операции расчета НОБ
                        ,UNSET_CHAR);          // Пересчет

     InsertTaxObjectTmp( tick.dealDate          // Дата НДР
                        ,FactReceiverID        // Фактический получатель дохода
                        ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                        ,TXOBJ_LEVEL4          // Уровень
                        ,UNSET_CHAR            // Признак "Пользовательский"
                        ,TXOBJ_DIVPAY_SEC_0    // Вид НДР
                        ,TaxGet13_rub - amountTxDiv // Сумма
                        ,NATCUR                // Валюта дохода/расхода
                        ,TXOBJ_KIND1100        // Вид аналитики 1
                        ,tick.DealID           // Аналитика 1
                        ,0                     // Вид аналитики 2
                        ,-1                    // Аналитика 2
                        ,TXOBJ_KIND3010        // Вид аналитики 3
                        ,tick.PFI              // Аналитика 3
                        ,TXOBJ_KIND4010        // Вид аналитики 4
                        ,securIsCirc           // Аналитика 4
                        ,TXOBJ_KIND5010        // Вид аналитики 5
                        ,TaxGroup              // Аналитика 5
                        ,KindContr             // Вид аналитики 6
                        ,BenefContrID          // Аналитика 6
                        ,"Уплаченный налог на дивиденды покупателем 1 ч. РЕПО"   // Комментарий
                        , pDocID               // ID операции
                        , ID_Step              // ID шага операции
                        , 0                    // Сумма реестра
                        ,1                     // Признак вызова не из операции расчета НОБ
                        ,UNSET_CHAR);          // Пересчет

    if(ParmStr != "")
      var Sum15 = $0;


      sum = amountTxDiv15;
      cur = NATCUR;
      if(sum != 0)
        InsertTaxObjectTmp( tick.dealDate                     // Дата НДР
                           ,FactReceiverID                    // Клиент
                           ,TXOBJ_DIR_OUT                     // Направление
                           ,TXOBJ_LEVEL8                      // Уровень
                           ,UNSET_CHAR                        // Признак "Пользовательский"
                           ,TXOBJ_PAIDGENERAL_15_1            // Вид НДР
                           ,sum                               // Сумма дохода/расхода
                           ,cur                               // Валюта дохода/расхода
                           ,TXOBJ_KIND1100                    // Вид аналитики 1
                           ,tick.DealID                       // Аналитика 1
                           ,0                                 // Вид аналитики 2
                           ,-1                                // Аналитика 2
                           ,0                                 // Вид аналитики 3
                           ,-1                                // Аналитика 3
                           ,0                                 // Вид аналитики 4
                           ,-1                                // Аналитика 4
                           ,0                                 // Вид аналитики 5
                           ,-1                                // Аналитика 5
                           ,KindContr                         // Вид аналитики 6
                           ,BenefContrID                      // Аналитика 6
                           ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                           ,pDocID                            // ID операции
                           ,ID_Step                           // ID шага операции
                           ,sum                               // Сумма реестра
                           ,1
                           ,UNSET_CHAR                        // Пересчет
                           );

        Sum15 = Sum15 + sum;
      end;

      sum = TaxGet15_rub - amountTxDiv15;
      cur = NATCUR;
      if(sum != 0)
        InsertTaxObjectTmp( tick.dealDate                     // Дата НДР
                           ,FactReceiverID                    // Клиент
                           ,TXOBJ_DIR_OUT                     // Направление
                           ,TXOBJ_LEVEL8                      // Уровень
                           ,UNSET_CHAR                        // Признак "Пользовательский"
                           ,TXOBJ_PAIDGENERAL_15_1_0          // Вид НДР
                           ,sum                               // Сумма дохода/расхода
                           ,cur                               // Валюта дохода/расхода
                           ,TXOBJ_KIND1100                    // Вид аналитики 1
                           ,tick.DealID                       // Аналитика 1
                           ,0                                 // Вид аналитики 2
                           ,-1                                // Аналитика 2
                           ,0                                 // Вид аналитики 3
                           ,-1                                // Аналитика 3
                           ,0                                 // Вид аналитики 4
                           ,-1                                // Аналитика 4
                           ,0                                 // Вид аналитики 5
                           ,-1                                // Аналитика 5
                           ,KindContr                         // Вид аналитики 6
                           ,BenefContrID                      // Аналитика 6
                           ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                           ,pDocID                            // ID операции
                           ,ID_Step                           // ID шага операции
                           ,sum                               // Сумма реестра
                           ,1
                           ,UNSET_CHAR                        // Пересчет
                           );
      end;

      if(not ((leg.ReceiptAmount != nptxprm.rec.TaxGet) or (leg.ReceiverIncrTax != nptxprm.rec.TaxGetIncr) or (Leg.ReturnIncome != nptxprm.rec.TaxPay) or (Leg.PayerIncrTax != nptxprm.rec.TaxPayIncr)))
        //Если не меняли налог вручную, то создаем объекты по переброске по базам, если они были
        
        i = 0;
        GetTxObjFromParmStr(ParmStr, TXOBJ_DIVPAY_SEC, @TxObjArr);
        while(i < TxObjArr.size)

          if(TxObjArr[i].ObjSymb == "R")
            sum = TxObjArr[i].ObjSum;
            cur = TxObjArr[i].ObjCurr;
          else
            sum = $0;
          end;
          
          if( sum != $0 )
             InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                                ,FactReceiverID        // Фактический получатель дохода
                                ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                                ,TXOBJ_LEVEL4          // Уровень
                                ,UNSET_CHAR            // Признак "Пользовательский"
                                ,TXOBJ_DIVPAY_SEC      // Вид НДР
                                ,sum                   // Сумма из проводки "Удержание налога"     
                                ,cur                   // Валюта дохода/расхода
                                ,TXOBJ_KIND1100        // Вид аналитики 1
                                ,tick.DealID           // Аналитика 1
                                ,0                     // Вид аналитики 2
                                ,-1                    // Аналитика 2
                                ,TXOBJ_KIND3010        // Вид аналитики 3
                                ,tick.PFI              // Аналитика 3
                                ,TXOBJ_KIND4010        // Вид аналитики 4
                                ,securIsCirc           // Аналитика 4
                                ,TXOBJ_KIND5010        // Вид аналитики 5
                                ,TaxGroup              // Аналитика 5
                                ,KindContr             // Вид аналитики 6
                                ,BenefContrID          // Аналитика 6
                                ,"Уплаченный налог на дивиденды"   // Комментарий
                                ,pDocID                // ID операции
                                ,ID_Step               // ID шага операции
                                ,sum                   // Сумма реестра
                                ,1                     // Признак вызова не из операции расчета НОБ
                                ,UNSET_CHAR);          // Пересчет
          end;

          i = i + 1;
        end;


        i = 0;
        GetTxObjFromParmStr(ParmStr, TXOBJ_PAIDGENERAL_15_1, @TxObjArr);
        while(i < TxObjArr.size)

          if(TxObjArr[i].ObjSymb == "R")
            sum = TxObjArr[i].ObjSum;
            cur = TxObjArr[i].ObjCurr;
          else
            sum = $0;
          end;

          if( sum != $0 )
             InsertTaxObjectTmp( tick.dealDate                     // Дата НДР
                                ,FactReceiverID                    // Клиент
                                ,TXOBJ_DIR_OUT                     // Направление
                                ,TXOBJ_LEVEL8                      // Уровень
                                ,UNSET_CHAR                        // Признак "Пользовательский"
                                ,TXOBJ_PAIDGENERAL_15_1            // Вид НДР
                                ,sum                               // Сумма дохода/расхода
                                ,cur                               // Валюта дохода/расхода
                                ,TXOBJ_KIND1100                    // Вид аналитики 1
                                ,tick.DealID                       // Аналитика 1
                                ,0                                 // Вид аналитики 2
                                ,-1                                // Аналитика 2
                                ,0                                 // Вид аналитики 3
                                ,-1                                // Аналитика 3
                                ,0                                 // Вид аналитики 4
                                ,-1                                // Аналитика 4
                                ,0                                 // Вид аналитики 5
                                ,-1                                // Аналитика 5
                                ,KindContr                         // Вид аналитики 6
                                ,BenefContrID                      // Аналитика 6
                                ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                                ,pDocID                            // ID операции
                                ,ID_Step                           // ID шага операции
                                ,sum                               // Сумма реестра
                                ,1
                                ,UNSET_CHAR                        // Пересчет
                                );
          end;

          Sum15 = Sum15 + sum;

          i = i + 1;
        end;

      end;
      

      if(Sum15 != 0)
        InsertTaxObjectTmp( tick.dealDate            // Дата НДР
                           ,FactReceiverID           // Клиент
                           ,TXOBJ_DIR_OUT            // Направление
                           ,TXOBJ_LEVEL8             // Уровень
                           ,UNSET_CHAR               // Признак "Пользовательский"
                           ,TXOBJ_PAIDGENERAL_15     // Вид НДР
                           ,Sum15                    // Сумма дохода/расхода
                           ,cur                      // Валюта дохода/расхода
                           ,TXOBJ_KIND1100           // Вид аналитики 1
                           ,tick.DealID              // Аналитика 1
                           ,0                        // Вид аналитики 2
                           ,-1                       // Аналитика 2
                           ,0                        // Вид аналитики 3
                           ,-1                       // Аналитика 3
                           ,0                        // Вид аналитики 4
                           ,-1                       // Аналитика 4
                           ,0                        // Вид аналитики 5
                           ,-1                       // Аналитика 5
                           ,KindContr                // Вид аналитики 6
                           ,BenefContrID             // Аналитика 6
                           ,"Налог по повышенной ставке с выплаты суммы дивидендов в РЕПО" // Комментарий
                           ,pDocID                   // ID операции
                           ,ID_Step                  // ID шага операции
                           ,0                        // Сумма реестра
                           ,1
                           ,UNSET_CHAR               // Пересчет
                           );
      end;


      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_PLUSG_1010, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                              ,FactReceiverID        // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Доход*/
                              ,TXOBJ_LEVEL5          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_PLUSG_1010      // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,TXOBJ_KIND1100        // Вид аналитики 1
                              ,tick.DealID           // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,TXOBJ_KIND3010        // Вид аналитики 3
                              ,tick.PFI              // Аналитика 3
                              ,TXOBJ_KIND4010        // Вид аналитики 4
                              ,securIsCirc           // Аналитика 4
                              ,TXOBJ_KIND5010        // Вид аналитики 5
                              ,TaxGroup              // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент"         // Комментарий
                              , pDocID               // ID операции
                              , ID_Step              // ID шага операции
                              , 0                    // Сумма реестра
                              , 1                    // Признак вызова не из операции расчета НОБ
                              ,UNSET_CHAR);          // Пересчет

        end;

        i = i + 1;
      end;


      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_MINUSG_601, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                              ,FactReceiverID        // Фактический получатель дохода
                              ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                              ,TXOBJ_LEVEL5          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_MINUSG_601      // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,TXOBJ_KIND1100        // Вид аналитики 1
                              ,tick.DealID           // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,TXOBJ_KIND3010        // Вид аналитики 3
                              ,tick.PFI              // Аналитика 3
                              ,TXOBJ_KIND4010        // Вид аналитики 4
                              ,securIsCirc           // Аналитика 4
                              ,TXOBJ_KIND5010        // Вид аналитики 5
                              ,TaxGroup              // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент"         // Комментарий
                              ,pDocID                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,1                     // Признак вызова не из операции расчета НОБ
                              ,UNSET_CHAR);          // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASESPECIAL_DIV, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                              ,FactReceiverID        // Фактический получатель дохода
                              ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASESPECIAL_DIV // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,TXOBJ_KIND1100        // Вид аналитики 1
                              ,tick.DealID           // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент"         // Комментарий
                              ,pDocID                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,1                     // Признак вызова не из операции расчета НОБ
                              ,UNSET_CHAR);          // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASESPECIAL_DIV_15, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                              ,FactReceiverID        // Фактический получатель дохода
                              ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASESPECIAL_DIV_15 // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,TXOBJ_KIND1100        // Вид аналитики 1
                              ,tick.DealID           // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"ФЛ=резидент. Повышенная ставка"         // Комментарий
                              ,pDocID                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,1                     // Признак вызова не из операции расчета НОБ
                              ,UNSET_CHAR);          // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASEG1, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                              ,FactReceiverID        // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASEG1          // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,TXOBJ_KIND1100        // Вид аналитики 1
                              ,tick.DealID           // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"Общая сумма дохода"  // Комментарий
                              ,pDocID                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,1                     // Признак вызова не из операции расчета НОБ
                              ,UNSET_CHAR);          // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASEG1_13, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                              ,FactReceiverID        // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASEG1_13       // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,TXOBJ_KIND1100        // Вид аналитики 1
                              ,tick.DealID           // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"Сумма дохода по основной ставке"  // Комментарий
                              ,pDocID                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,1                     // Признак вызова не из операции расчета НОБ
                              ,UNSET_CHAR);          // Пересчет
        end;

        i = i + 1;
      end;

      i = 0;
      GetTxObjFromParmStr(ParmStr, TXOBJ_BASEG1_15, @TxObjArr);
      while(i < TxObjArr.size)

        sum = TxObjArr[i].ObjSum;
        cur = TxObjArr[i].ObjCurr;
        
        if( sum != $0 )
           InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                              ,FactReceiverID        // Фактический получатель дохода
                              ,TXOBJ_DIR_IN          // Направление /*Расход*/
                              ,TXOBJ_LEVEL7          // Уровень
                              ,UNSET_CHAR            // Признак "Пользовательский"
                              ,TXOBJ_BASEG1_15       // Вид НДР
                              ,sum                   // Сумма дохода/расхода
                              ,cur                   // Валюта дохода/расхода
                              ,TXOBJ_KIND1100        // Вид аналитики 1
                              ,tick.DealID           // Аналитика 1
                              ,0                     // Вид аналитики 2
                              ,-1                    // Аналитика 2
                              ,0                     // Вид аналитики 3
                              ,-1                    // Аналитика 3
                              ,0                     // Вид аналитики 4
                              ,-1                    // Аналитика 4
                              ,0                     // Вид аналитики 5
                              ,-1                    // Аналитика 5
                              ,KindContr             // Вид аналитики 6
                              ,BenefContrID          // Аналитика 6
                              ,"Сумма дохода по повышенной ставке"  // Комментарий
                              ,pDocID                // ID операции
                              ,ID_Step               // ID шага операции     
                              ,0                     // Сумма реестра
                              ,1                     // Признак вызова не из операции расчета НОБ
                              ,UNSET_CHAR);          // Пересчет
         end;

        i = i + 1;
      end;


    else

    var bFactReceiverNeresid = IsNeresidentForNUTX(tick.FactReceiverID, tick.dealDate);

    if(  bFactReceiverNeresid == false) // Резидент  PlusG_1010 
        InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                            ,FactReceiverID        // Фактический получатель дохода
                            ,TXOBJ_DIR_IN          // Направление /*Доход*/
                            ,TXOBJ_LEVEL5          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,TXOBJ_PLUSG_1010      // Вид НДР
                            ,DivDeal_rub           // Сумма дохода/расхода
                            ,NATCUR                // Валюта дохода/расхода
                            ,TXOBJ_KIND1100        // Вид аналитики 1
                            ,tick.DealID           // Аналитика 1
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,TXOBJ_KIND3010        // Вид аналитики 3
                            ,tick.PFI              // Аналитика 3
                            ,TXOBJ_KIND4010        // Вид аналитики 4
                            ,securIsCirc           // Аналитика 4
                            ,TXOBJ_KIND5010        // Вид аналитики 5
                            ,TaxGroup              // Аналитика 5
                            ,KindContr             // Вид аналитики 6
                            ,BenefContrID          // Аналитика 6
                            ,"ФЛ=нерезидент"       // Комментарий
                            , pDocID               // ID операции
                            , ID_Step              // ID шага операции
                            , 0                    // Сумма реестра
                            , 1                    // Признак вызова не из операции расчета НОБ
                            ,UNSET_CHAR);          // Пересчет
    end;

    if(  bFactReceiverNeresid == true  ) // НеРезидент  Plus15_1010  
        InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                            ,FactReceiverID        // Фактический получатель дохода
                            ,TXOBJ_DIR_IN          // Направление /*Доход*/
                            ,TXOBJ_LEVEL5          // Уровень
                            ,UNSET_CHAR            // Признак "Пользовательский"
                            ,TXOBJ_PLUS15_1010     // Вид НДР
                            ,DivDeal_rub           // Сумма дохода/расхода
                            ,NATCUR                // Валюта дохода/расхода
                            ,TXOBJ_KIND1100        // Вид аналитики 1
                            ,tick.DealID           // Аналитика 1
                            ,0                     // Вид аналитики 2
                            ,-1                    // Аналитика 2
                            ,TXOBJ_KIND3010        // Вид аналитики 3
                            ,tick.PFI              // Аналитика 3
                            ,TXOBJ_KIND4010        // Вид аналитики 4
                            ,securIsCirc           // Аналитика 4
                            ,TXOBJ_KIND5010        // Вид аналитики 5
                            ,TaxGroup              // Аналитика 5
                            ,KindContr             // Вид аналитики 6
                            ,BenefContrID          // Аналитика 6
                            ,"ФЛ=нерезидент"       // Комментарий
                            , pDocID               // ID операции
                            , ID_Step              // ID шага операции
                            , 0                    // Сумма реестра
                            ,1                     // Признак вызова не из операции расчета НОБ
                            ,UNSET_CHAR);          // Пересчет
    end;

    var amount = 0;
    if ( leg.D2 != 0 )
        amount = DivDeal_rub * leg.D1/leg.D2;
    end;
    if(  bFactReceiverNeresid == false  ) // Резидент  MinusG_601  
         InsertTaxObjectTmp( tick.dealDate         // Дата НДР
                                ,FactReceiverID        // Фактический получатель дохода
                                ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                                ,TXOBJ_LEVEL5          // Уровень
                                ,UNSET_CHAR            // Признак "Пользовательский"
                                ,TXOBJ_MINUSG_601      // Вид НДР
                                ,amount                // Сумма дохода/расхода
                                ,NATCUR                // Валюта дохода/расхода
                                ,TXOBJ_KIND1100        // Вид аналитики 1
                                ,tick.DealID           // Аналитика 1
                                ,0                     // Вид аналитики 2
                                ,-1                    // Аналитика 2
                                ,TXOBJ_KIND3010        // Вид аналитики 3
                                ,tick.PFI              // Аналитика 3
                                ,TXOBJ_KIND4010        // Вид аналитики 4
                                ,securIsCirc           // Аналитика 4
                                ,TXOBJ_KIND5010        // Вид аналитики 5
                                ,TaxGroup              // Аналитика 5
                                ,KindContr             // Вид аналитики 6
                                ,BenefContrID          // Аналитика 6
                                ,"ФЛ=резидент"         // Комментарий
                                , pDocID               // ID операции
                                , ID_Step              // ID шага операции     
                                , 0                    // Сумма реестра
                                , 1                    // Признак вызова не из операции расчета НОБ
                                ,UNSET_CHAR);          // Пересчет
    end; 

    var comment = "";
    if ( bFactReceiverNeresid == false )
        amount = max(DivDeal_rub-amount/*MinusG_601*/, 0);  // вычислили выше MinusG_601
        comment = "ФЛ = резидент";
    else
        amount = DivDeal_rub;
        comment = "ФЛ=нерезидент";
    end;      

    InsertTaxObjectTmp( tick.dealDate        // Дата НДР
                        ,FactReceiverID        // Фактический получатель дохода
                        ,TXOBJ_DIR_OUT         // Направление /*Расход*/
                        ,TXOBJ_LEVEL7          // Уровень
                        ,UNSET_CHAR            // Признак "Пользовательский"
                        ,TXOBJ_BASESPECIAL_DIV // Вид НДР
                        ,amount                // Сумма дохода/расхода
                        ,NATCUR                // Валюта дохода/расхода
                        ,TXOBJ_KIND1100        // Вид аналитики 1
                        ,tick.DealID           // Аналитика 1
                        ,0                     // Вид аналитики 2
                        ,-1                    // Аналитика 2
                        ,TXOBJ_KIND3010        // Вид аналитики 3
                        ,tick.PFI              // Аналитика 3
                        ,TXOBJ_KIND4010        // Вид аналитики 4
                        ,securIsCirc           // Аналитика 4
                        ,TXOBJ_KIND5010        // Вид аналитики 5
                        ,TaxGroup              // Аналитика 5
                        ,KindContr             // Вид аналитики 6
                        ,BenefContrID          // Аналитика 6
                        ,comment               // Комментарий
                        , pDocID               // ID операции
                        , ID_Step              // ID шага операции     
                        , 0                    // Сумма реестра
                        ,1                     // Признак вызова не из операции расчета НОБ
                        ,UNSET_CHAR);          // Пересчет
    end;

    TaxObj.Save();
    
    return 0;
END;

/*Формирование НДРов для получателя - юрлица и для конечного получателя - физлица-нерезидента */
macro CreateTaxObjects_WhenPartyNeresAndBenefNatural(ID_Operation, ID_STEP, SubGrpID, partyID: Integer, CommDate: date): Integer
  /*
    Формируются объекты НДР только при настройке SECUR/"НДФЛ ДЛЯ БЕНЕФИЦИАРОВ ПРИ ВЫПЛАТАХ В РЕПО" = "YES"
    где получатель - ЮЛН, а бенефициар - физ.лицо
  */
  var GrpID = 0;
  var grp = TBFile("pmwrtgrp.dbt");
  var query, cmd, DataSet;

  query = "select distinct t_GrpID from dpmwrtsubgrp_dbt where t_SubGrpID = ?";
  cmd = DL_RSDCommand(query);
  cmd.AddParam(SubGrpID);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    GrpID = DataSet.GrpID;
  else
    return 4;
  end;

  grp.rec.ID = GrpID;
  if ( not grp.GetEQ() )
    return 4;
  end;

  var FactReceiverID: Integer = GetFactReceiverForNUTX(partyID);
  var benefPt                 = TRecHandler("party.dbt");
  var PartyPt                 = Trechandler("party.dbt"); 
 
  IF (PartyID == -1)
    PartyID = {ourbank};
  END;

  var err:Integer = ПолучитьСубъекта( PartyID, PartyPt );
  if ( 0 == err )
    if ( (1 != PartyPt.rec.LegalForm) or (not IsInstNeresForNUTX(PartyID, CommDate)) )
      return 0;
    end;
    err = ПолучитьСубъекта(int(FactReceiverID), benefPt);
    if ((0 != err) or (2 != benefPt.rec.LegalForm))
      return err;  // если получатель - не ЮЛН, а бенефициар - физ.лицо
    end;
  end;

  if (err) return err; end;

  var bResident: bool =  benefPt.rec.NotResident != SET_CHAR;// Конечный получатель - резидент/нерезидент

  var SfContr  = TRecHandler( "sfcontr.dbt" );
  if (not DL_FindSfContrByOrder( grp.rec.Contract, SfContr ) )
    msgbox("Не найден договор обслуживания: id" + grp.rec.Contract);
    return 1;
  end;
  var bSfContrIIS: bool = ПолучитьЗначениеКатегории(SfContr, 3/*Договор ИИС*/, OBJTYPE_SFCONTR,  CommDate) == 1;
  
  var NeedClientSummary = 0, Enable = false;
  GetRegistryValue( MAKE_CARRY_SUMMARY_CLNT, V_BOOL, Enable, err );
  if( err != 0 )
    msgbox("Ошибка при получении значения настройки " + MAKE_CARRY_SUMMARY_CLNT);
    return 1;
  elif(Enable)
    NeedClientSummary = 1;
  end;

  cmd = DL_RSDCommand(  " select rq.t_ID rqID, rq.t_Amount, rq.t_FIID, tk.t_PFI as PFI, rq.t_DocID, rq.t_TaxRateBuy, rq.t_TaxSumBuy, rq.t_TaxRateSell, rq.t_TaxSumSell, rq.t_FactReceiverID,  "
        + " npto.GetPaperTaxGroupNPTX( tk.t_PFI ) TaxGroup, "
        + " (case when npto.IfMarket(tk.t_PFI, ?)=chr(88) then 1 else 2 end) Circulate, "
        + " tk.t_ClientID, rq.t_FactDate as t_Date "
        + "   from dpmwrtsubdoc_dbt subdoc, ddlgrdeal_dbt grdeal, ddlrq_dbt rq, ddl_tick_dbt tk,  "
        + "        (select t_Kind_Operation, rsb_secur.get_OperationGroup(t_SysTypes) oGrp " 
        + "           from doprkoper_dbt where t_DocKind = "+DL_SECURITYDOC+") Opr "
        + "  where subdoc.t_SubGrpID = ? "
        + "    and grdeal.t_ID = subdoc.t_GrDealID "
        + "    and grdeal.t_TemplNum = " + DLGR_TEMPL_COUP
        + "    and grdeal.t_FIID IN (select grpfi.t_FIID from dpmwrtgrpfi_dbt grpfi where grpfi.t_GrpID = subgrp.t_GrpID) "
        + "    and tk.t_DealID = grdeal.t_DocID "
        + "    and rq.t_DocKind = tk.t_BOfficeKind "
        + "    and rq.t_DocID = tk.t_DealID "
        + "    and rq.t_Type = " + DLRQ_TYPE_PAYMREPOCOUP
        + "    and rq.t_FactDate = ? "
        + "    and Rsb_Secur.SC_GetRQByGrDeal(grdeal.T_ID) = rq.t_ID"
        + "    and Exists(select 1 "
        + "                 from ddlgracc_dbt gracc "
        + "                where gracc.t_GrDealID = grdeal.T_ID "
        + "                  and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING 
        + "                  and gracc.t_State = " + DLGRACC_STATE_PLAN
        + "              ) "
        + "   and Opr.t_Kind_Operation = tk.t_DealType "
        + "   and Rsb_Secur.IsSale(Opr.oGrp) = 1 " );
  cmd.addParam(commDate);
  cmd.AddParam(CommDate);
  cmd.AddParam(SubGrpID);
  DataSet = cmd.Execute();

  if ( NULL == TaxObj ) 
    TaxObj = TInsertTaxObject();
  end;
   
  while ( DataSet.moveNext() )
  
    var TaxSumSell = DataSet.TaxSumSell;  // PaidGeneral/PaidSpecial/Paid_35
    var TaxAmount  = DataSet.Amount;      // ProcSec_TS

    // Перевод суммы в рубли
    var procSec_rub    = TaxAmount;           
    var TaxSumSell_rub = TaxSumSell;
    if ( NATCUR != DataSet.FIID )
      SmartConvertSum(procSec_rub, procSec_rub, CommDate, DataSet.FIID, NATCUR, false);
      SmartConvertSum(TaxSumSell_rub, TaxSumSell_rub, CommDate, DataSet.FIID, NATCUR, false);
    end;
  
    var InsertObject = 1;
    var ContractID = -1; // Нужен еще контракт по фактическому получателю. Где его взять?

    var fin = TRecHandler("fininstr.dbt");
    err = ПолучитьФинИн(DataSet.PFI, fin);
    if ( 0 != err )
      MsgBox( err + ": Не найден фининструмент. FIID - " + DataSet.PFI );
      continue;
    end;
 
    var fiwarnts = TRecHandler("fiwarnts.dbt"); // Текущий купон
    if ( FI_CurrentWarnt(DataSet.PFI, date(0,0,0), false, false, fiwarnts) != 0)
      MsgBox("Не найден текущий купон по ЦБ(FIID - " +DataSet.PFI +")" );
      continue;
    end;

    var bCorporateObligation2018: bool = false; // Определение корпоративной облигации с 2018 в обращении
    if ( FI_IsBond(DataSet.PFI) and                                                         // Облигация
        FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BOND_CORPORATE, fin.rec.AvoirKind ) and //Корпоративная
        DL_NPTX_IsCorpBondAfter2018(DataSet.PFI, fiwarnts.rec.Number) == true )             // в обращении с 2018
              bCorporateObligation2018 = true;
    end;
    
    // ---------------------------------------------------
    // 2.   Вид выплаты = Купон, кроме Корп. облиг. с 2018
    // --------------------------------------------------
    if(not bCorporateObligation2018  )

      //var amount = DataSet.Amount * DataSet.TaxRateSell / 100.0;   
      // ProcSec_TS
      InsertTaxObjectTmp(
                  CommDate,                       // Дата НДР  
                  DataSet.FactReceiverID,                
                  TXOBJ_DIR_IN,                   // Направление /*Доход*/
                  TXOBJ_LEVEL2,                   // Уровень
                  UNSET_CHAR,                     // Признак "Пользовательский"
                  TXOBJ_PROCSEC_TS,               // Вид НДР
                  TaxAmount,                      // Сумма дохода/расхода
                  DataSet.FIID,                   // Валюта дохода/расхода  
                  TXOBJ_KIND1010,                 // Вид аналитики 1 - Сделка    
                  DataSet.DocID,                  // Аналитика 1       
                  0,                              // Вид аналитики 2      
                  -1,                             // Аналитика 2     
                  TXOBJ_KIND3010,                 // Вид аналитики 3 - Ц/б                 
                  DataSet.PFI,                    // Аналитика 3           
                  TXOBJ_KIND4010,                 // Вид аналитики 4 -  Категория ФИ                               
                  DataSet.Circulate,              // Аналитика 4      
                  TXOBJ_KIND5010,                 // Вид аналитики 5 - Налоговая группа    
                  DataSet.TaxGroup,               // Аналитика 5              
                  TXOBJ_KIND6020,                 // Вид аналитики 6 - ДО (Договор обслуживания)
                  ContractID,                     // Аналитика 6 
                  "",                             // Комментарий
                  ID_Operation,                   // ID операции
                  ID_STEP,                        // ID шага операции     
                  0,                              // Сумма реестра
                  1,                              // Признак вызова не из операции расчета НОБ
                  UNSET_CHAR);                   // Пересчет
 
      // TXOBJ_PAIDGENERAL
      /*if ( (not bResident) and (TXGROUP_30 != DataSet.TaxGroup) and (not bSfContrIIS) ) // Кроме случаев, когда НГ=30 и клиент = резидент. Кроме договоров ИИС
        InsertTaxObjectTmp( 
                      CommDate,                   // Дата НДР  
                      DataSet.FactReceiverID,                
                      TXOBJ_DIR_OUT,*/              // Направление /*Расход*/
                      /*TXOBJ_LEVEL8,               // Уровень
                      UNSET_CHAR,                 // Признак "Пользовательский"
                      TXOBJ_PAIDGENERAL,          // Вид НДР
                      TaxSumSell,                 // Сумма дохода/расхода
                      DataSet.FIID,               // Валюта дохода/расхода  
                      TXOBJ_KIND1010,             // Вид аналитики 1 - Сделка    
                      DataSet.DocID,              // Аналитика 1       
                      0,                          // Вид аналитики 2      
                      -1,                         // Аналитика 2     
                      TXOBJ_KIND3010,             // Вид аналитики 3 - Ц/б                 
                      DataSet.PFI,                // Аналитика 3           
                      TXOBJ_KIND4010,             // Вид аналитики 4 -  Категория ФИ                               
                      DataSet.Circulate,          // Аналитика 4      
                      TXOBJ_KIND5010,             // Вид аналитики 5 - Налоговая группа    
                      DataSet.TaxGroup,           // Аналитика 5              
                      TXOBJ_KIND6020,             // Вид аналитики 6 - ДО (Договор обслуживания)
                      ContractID,                 // Аналитика 6 
                      "",                         // Комментарий
                      ID_Operation,               // ID операции
                      ID_STEP,                    // ID шага операции         
                      1 ) ;                       // Признак вызова не из операции расчета НОБ
      end;*/

      // TXOBJ_PAIDSPECIAL
      /*if ( (TXGROUP_30 == DataSet.TaxGroup) and bResident and (not bSfContrIIS) ) // НГ=30 и клиент = ре-зидент. Кроме договоров ИИС
        InsertTaxObjectTmp( 
                    CommDate,                    // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_OUT,*/               // Направление /*Расход*/
                    /*TXOBJ_LEVEL8,                // Уровень
                    UNSET_CHAR,                  // Признак "Пользовательский"
                    TXOBJ_PAIDSPECIAL,           // Вид НДР
                    TaxSumSell,                  // Сумма дохода/расхода
                    DataSet.FIID,                // Валюта дохода/расхода
                    TXOBJ_KIND1010,              // Вид аналитики 1 - Сделка    
                    DataSet.DocID,               // Аналитика 1       
                    0,                           // Вид аналитики 2      
                    -1,                          // Аналитика 2     
                    TXOBJ_KIND3010,              // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,                 // Аналитика 3           
                    TXOBJ_KIND4010,              // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,           // Аналитика 4      
                    TXOBJ_KIND5010,              // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,            // Аналитика 5              
                    TXOBJ_KIND6020,              // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,                  // Аналитика 6 
                    "",                          // Комментарий
                    ID_Operation,                // ID операции
                    ID_STEP,                     // ID шага операции      
                    1 ) ;                        // Признак вызова не из операции расчета НОБ
      end;*/

      // TXOBJ_PAIDGENERAL_IIS
      /*if ( (TXGROUP_30 != DataSet.TaxGroup) and ( not bResident ) and  bSfContrIIS ) //Кроме случаев, когда НГ=30 и клиент = ре-зидент. Для договоров ИИС
        InsertTaxObjectTmp( 
                    CommDate,                    // Дата НДР 
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_OUT,*/               // Направление /*Расход*/
                    /*TXOBJ_LEVEL8,                // Уровень
                    UNSET_CHAR,                  // Признак "Пользовательский"
                    TXOBJ_PAIDGENERAL_IIS,       // Вид НДР
                    TaxSumSell,                  // Сумма дохода/расхода
                    DataSet.FIID,                // Валюта дохода/расхода  
                    TXOBJ_KIND1010,              // Вид аналитики 1 - Сделка    
                    DataSet.DocID,               // Аналитика 1       
                    0,                           // Вид аналитики 2      
                    -1,                          // Аналитика 2     
                    TXOBJ_KIND3010,              // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,                 // Аналитика 3           
                    TXOBJ_KIND4010,              // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,           // Аналитика 4      
                    TXOBJ_KIND5010,              // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,            // Аналитика 5              
                    TXOBJ_KIND6020,              // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,                  // Аналитика 6 
                    "",                          // Комментарий
                    ID_Operation,                // ID операции
                    ID_STEP,                     // ID шага операции             
                    1 ) ;                        // Признак вызова не из операции расчета НОБ
      end;*/

      // TXOBJ_PLUS9_1110
      if ( (TXGROUP_30 == DataSet.TaxGroup) and  bResident and (not bSfContrIIS) ) //НГ=30 и клиент = ре-зидент. Кроме ИИС
        InsertTaxObjectTmp( 
                    CommDate,                  // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,              // Направление /*Доход*/
                    TXOBJ_LEVEL5,              // Уровень
                    UNSET_CHAR,                // Признак "Пользовательский"
                    TXOBJ_PLUS9_1110,          // Вид НДР
                    procSec_rub,               // Сумма дохода/расхода
                    NATCUR,                    // Валюта дохода/расхода  
                    TXOBJ_KIND1010,            // Вид аналитики 1 - Сделка    
                    DataSet.DocID,             // Аналитика 1       
                    0,                         // Вид аналитики 2      
                    -1,                        // Аналитика 2     
                    TXOBJ_KIND3010,            // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,               // Аналитика 3           
                    TXOBJ_KIND4010,            // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,         // Аналитика 4      
                    TXOBJ_KIND5010,            // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,          // Аналитика 5              
                    TXOBJ_KIND6020,            // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,                // Аналитика 6 
                    "",                        // Комментарий
                    ID_Operation,              // ID операции
                    ID_STEP,                   // ID шага операции
                    0,                         // Сумма реестра
                    1,                         // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);               // Пересчет
      end;

      // TXOBJ_PLUS9_1110_IIS
      if ( (TXGROUP_30 == DataSet.TaxGroup) and  bResident and  bSfContrIIS ) //НГ=30 и клиент = ре-зидент. Для ИИС
        InsertTaxObjectTmp( 
                    CommDate,                  // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,             // Направление /*Доход*/
                    TXOBJ_LEVEL5,             // Уровень
                    UNSET_CHAR,               // Признак "Пользовательский"
                    TXOBJ_PLUS9_1110_IIS,     // Вид НДР
                    procSec_rub,              // Сумма дохода/расхода
                    NATCUR,                   // Валюта дохода/расхода  
                    TXOBJ_KIND1010,           // Вид аналитики 1 - Сделка    
                    DataSet.DocID,            // Аналитика 1       
                    0,                        // Вид аналитики 2      
                    -1,                       // Аналитика 2     
                    TXOBJ_KIND3010,           // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,              // Аналитика 3           
                    TXOBJ_KIND4010,           // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,        // Аналитика 4      
                    TXOBJ_KIND5010,           // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,         // Аналитика 5              
                    TXOBJ_KIND6020,           // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,               // Аналитика 6 
                    "",                       // Комментарий
                    ID_Operation,             // ID операции
                    ID_STEP,                  // ID шага операции     
                    0,                        // Сумма реестра
                    1,                        // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);              // Пересчет
      end;

      // TXOBJ_PLUSG_1110
      if ( (TXGROUP_30 == DataSet.TaxGroup) and (not bResident) ) //НГ=30 и клиент = нере-зидент
        InsertTaxObjectTmp(  
                    CommDate,                 // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,             // Направление /*Доход*/
                    TXOBJ_LEVEL5,             // Уровень
                    UNSET_CHAR,               // Признак "Пользовательский"
                    TXOBJ_PLUSG_1110,         // Вид НДР
                    procSec_rub,              // Сумма дохода/расхода
                    NATCUR,                   // Валюта дохода/расхода  
                    TXOBJ_KIND1010,           // Вид аналитики 1 - Сделка    
                    DataSet.DocID,            // Аналитика 1       
                    0,                        // Вид аналитики 2      
                    -1,                       // Аналитика 2     
                    TXOBJ_KIND3010,           // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,              // Аналитика 3           
                    TXOBJ_KIND4010,           // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,        // Аналитика 4      
                    TXOBJ_KIND5010,           // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,         // Аналитика 5              
                    TXOBJ_KIND6020,           // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,               // Аналитика 6 
                    "",                       // Комментарий
                    ID_Operation,             // ID операции
                    ID_STEP,                  // ID шага операции
                    0,                        // Сумма реестра
                    1,                        // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);              // Пересчет
      end;

      // TXOBJ_PLUSG_1011
      if ( (TXGROUP_20 == DataSet.TaxGroup) and (not bSfContrIIS) ) //НГ = 20. Кроме ИИС
        InsertTaxObjectTmp( 
                    CommDate,               // Дата НДР 
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL5,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_PLUSG_1110,       // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_PLUSG_1011_IIS
      if ( (TXGROUP_20 == DataSet.TaxGroup) and  bSfContrIIS ) //НГ = 20. Для ИИС
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL5,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_PLUSG_1011_IIS,   // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_COUP0_GROUP
      if ( TXGROUP_50 == DataSet.TaxGroup ) //НГ = 50
        InsertTaxObjectTmp( 
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL5,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_COUP0_GROUP,      // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ)
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_BASEGENERAL
      if ( (TXGROUP_30 != DataSet.TaxGroup) and bResident and (not bSfContrIIS) ) //НГ не равно =30 и кли-ент = резидент. Кроме ИИС
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL7,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_BASEGENERAL,      // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_BASESPECIAL
      if ( (TXGROUP_30 == DataSet.TaxGroup) and bResident and (not bSfContrIIS) ) //НГ=30 и клиент = ре-зидент. Кроме ИИС
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР 
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL7,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_BASESPECIAL,      // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_BASEGENERAL_IIS
      if ( (TXGROUP_30 != DataSet.TaxGroup) and bResident and bSfContrIIS ) //НГне равно 30 и клиент = резидент. Для ИИС
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL7,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_BASEGENERAL_IIS,  // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма Реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_BASESPECIAL
      if ( (TXGROUP_30 == DataSet.TaxGroup) and bResident and bSfContrIIS ) //НГ=30 и клиент = ре-зидент. Для ИИС
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL7,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_BASESPECIAL,      // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;
    // ---------------------------------
    // END       2. Вид выплаты = Купон, кроме Корп. облиг. с 2018
    //---------------------------------
    else // bCorporateObligation2018 == true
    // ---------------------------------------------------
    // 3.   Вид выплаты = Купон для  Корп. облиг. с 2018,
    // --------------------------------------------------   
 
      var FD = SPFirstDoc(LEG_KIND_DL_TICK, DataSet.DocID);
      var Quantity = FD.dl_leg.rec.Principal;

      procSec_rub = DL_NPTX_GetTaxBaseCorpBondAfter2018(DataSet.PFI, fiwarnts.rec.Number, Quantity); // Сумма рассчитанной НОБ
            //var DueTax =$0, DueTax0 = $0;
            //var DueTax = NUTX_GetClientDealDueTax(FD.tick.rec.DealID, FD.tick.rec.ClientID, DueTax, DueTax0);
    
      // TXOBJ_PROCSEC_TS_35
      if ( procSec_rub != $0 )
        InsertTaxObjectTmp( 
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL2,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_PROCSEC_TS_35,    // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Суума реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;
      // TXOBJ_BASE_35
      if ( (procSec_rub != $0) and bResident ) //клиент = ре-зидент.
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL7,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_BASE_35,          // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции 
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_COUP0_GROUP 
      if ( max(0, TaxAmount-procSec_rub) > 0 )
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL4,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_COUP0_GROUP,      // Вид НДР
                    TaxAmount-procSec_rub,  // Сумма дохода/расхода  !!!TODO
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции
                    0,                      // Сумма реестра  
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_PAID_35
      /*if (  bResident ) //клиент = ре-зидент.
        InsertTaxObjectTmp( 
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_OUT,*/          // Направление /*Расход*/
                    /*TXOBJ_LEVEL8,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_PAID_35,          // Вид НДР
                    TaxSumSell_rub,         // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции 
                    1 ) ;                   // Признак вызова не из операции расчета НОБ
      end;*/

      // TXOBJ_PAIDGENERAL
      /*if ( not bResident ) //Клиент = нерезидент.
        InsertTaxObjectTmp( 
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_OUT,*/          // Направление /*Расход*/
                    /*TXOBJ_LEVEL8,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_PAIDGENERAL,      // Вид НДР
                    TaxSumSell_rub,         // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции 
                    1 ) ;                   // Признак вызова не из операции расчета НОБ
      end;*/

      // TXOBJ_BASEGENERAL
      if ( (procSec_rub != $0) and (not bResident) ) //Клиент = нерезидент.
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL7,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_BASEGENERAL,      // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции 
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ
                    UNSET_CHAR);            // Пересчет
      end;

      // TXOBJ_PLUS35_3023
      if ( procSec_rub != $0 )
        InsertTaxObjectTmp(  
                    CommDate,               // Дата НДР  
                    DataSet.FactReceiverID,                
                    TXOBJ_DIR_IN,           // Направление /*Доход*/
                    TXOBJ_LEVEL5,           // Уровень
                    UNSET_CHAR,             // Признак "Пользовательский"
                    TXOBJ_PLUS35_3023,      // Вид НДР
                    procSec_rub,            // Сумма дохода/расхода
                    NATCUR,                 // Валюта дохода/расхода  
                    TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                    DataSet.DocID,          // Аналитика 1       
                    0,                      // Вид аналитики 2      
                    -1,                     // Аналитика 2     
                    TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                    DataSet.PFI,            // Аналитика 3           
                    TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                    DataSet.Circulate,      // Аналитика 4      
                    TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                    DataSet.TaxGroup,       // Аналитика 5              
                    TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                    ContractID,             // Аналитика 6 
                    "",                     // Комментарий
                    ID_Operation,           // ID операции
                    ID_STEP,                // ID шага операции 
                    0,                      // Сумма реестра
                    1,                      // Признак вызова не из операции расчета НОБ  
                    UNSET_CHAR);            // Пересчет
      end;   
    
    end; // if-else bCorporateObligation2018 

  end;  // while
    
  if ( not TaxObj.isEmpty() )
    TaxObj.Save();
    TaxObj.Clear();
  end;

  return err;
end;

MACRO CreateTaxObjects_NPTXCarry(TaxSum, ID_Operation, ID_STEP, GrpID, SubGrpID, partyID: Integer, CommDate: date, FIID:integer): Integer
   /*
   Формируются объекты НДР только при настройке SECUR/"НДФЛ ДЛЯ БЕНЕФИЦИАРОВ ПРИ ВЫПЛАТАХ В РЕПО" = "YES"
   где получатель - ЮЛН, а бенефициар - физ.лицо
   */
   var grp = TBFile("pmwrtgrp.dbt");
   grp.rec.ID = GrpID;
   if ( not grp.GetEQ() )
     return 4;
   end;

   var FactReceiverID: Integer = GetFactReceiverForNUTX(partyID);
   var benefPt                 = TRecHandler("party.dbt");
   var PartyPt                 = Trechandler("party.dbt"); 
  
   IF (PartyID == -1)
     PartyID = {ourbank};
   END;
  
   var err:Integer = ПолучитьСубъекта( PartyID, PartyPt );
   if ( 0 == err )
     if ( (1 != PartyPt.rec.LegalForm) or (not IsInstNeresForNUTX(PartyID, CommDate)) )
       return 0;
     end;
     err = ПолучитьСубъекта(int(FactReceiverID), benefPt);
     if ((0 != err) or (2 != benefPt.rec.LegalForm))
       return err;  // если получатель - не ЮЛН, а бенефициар - физ.лицо
     end;
   end;
  
   if (err) return err; end;
  
   var bResident: bool =  benefPt.rec.NotResident != SET_CHAR ; // Конечный получатель - резидент/нерезидент
  
   var SfContr  = TRecHandler( "sfcontr.dbt" );
   if (not DL_FindSfContrByOrder( grp.rec.Contract, SfContr ) )
     msgbox("Не найден договор обслуживания: id" + grp.rec.Contract);
     return 1;
   end;
   var bSfContrIIS: bool = ПолучитьЗначениеКатегории(SfContr, 3/*Договор ИИС*/, OBJTYPE_SFCONTR,  CommDate) == 1;
   
   var NeedClientSummary = 0, Enable = false;
   GetRegistryValue( MAKE_CARRY_SUMMARY_CLNT, V_BOOL, Enable, err );
   if( err != 0 )
     msgbox("Ошибка при получении значения настройки " + MAKE_CARRY_SUMMARY_CLNT);
     return 1;
   elif(Enable)
     NeedClientSummary = 1;
   end;
  
   var cmd = DL_RSDCommand(  " select rq.t_ID rqID, rq.t_Amount, rq.t_FIID, rq.t_DocID, rq.t_TaxRateBuy, rq.t_TaxSumBuy, rq.t_TaxRateSell, rq.t_TaxSumSell, rq.t_FactReceiverID,  "
         + " npto.GetPaperTaxGroupNPTX( tk.t_PFI ) TaxGroup, "
         + " (case when npto.IfMarket(tk.t_PFI, ?)=chr(88) then 1 else 2 end) Circulate, "
         + " tk.t_ClientID "
         + "   from dpmwrtsubdoc_dbt subdoc, ddlgrdeal_dbt grdeal, ddlrq_dbt rq, ddl_tick_dbt tk,  "
         + "        (select t_Kind_Operation, rsb_secur.get_OperationGroup(t_SysTypes) oGrp " 
         + "           from doprkoper_dbt where t_DocKind = "+DL_SECURITYDOC+") Opr "
         + "  where subdoc.t_SubGrpID = ? "
         + "    and grdeal.t_ID = subdoc.t_GrDealID "
         + "                  and grdeal.t_TemplNum = " + DLGR_TEMPL_COUP
         + "                  and grdeal.t_FIID = ? "
         + "    and tk.t_DealID = grdeal.t_DocID "
         + "    and rq.t_DocKind = tk.t_BOfficeKind "
         + "    and rq.t_DocID = tk.t_DealID "
         + "    and rq.t_Type = " + DLRQ_TYPE_PAYMREPOCOUP
         + "    and rq.t_FactDate = ? "
         + "    and Rsb_Secur.SC_GetRQByGrDeal(grdeal.T_ID) = rq.t_ID"
         + "    and Exists(select 1 "
         + "                 from ddlgracc_dbt gracc "
         + "                where gracc.t_GrDealID = grdeal.T_ID "
         + "                  and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING 
         + "                  and gracc.t_State = " + DLGRACC_STATE_PLAN
         + "              ) "
         + "   and Opr.t_Kind_Operation = tk.t_DealType "
         + "   and Rsb_Secur.IsSale(Opr.oGrp) = 1 " );
   cmd.addParam(commDate);
   cmd.AddParam(CommDate);
   cmd.AddParam(FIID);
   cmd.AddParam(SubGrpID);
   var DataSet = cmd.Execute();
  
   if ( NULL == TaxObj ) 
     TaxObj = TInsertTaxObject();
   end;

   while ( DataSet.moveNext() )
      var TaxSumSell = DataSet.TaxSumSell;  // PaidGeneral/PaidSpecial/Paid_35
      var TaxAmount  = DataSet.Amount;      // ProcSec_TS
  
      // Перевод суммы в рубли
      var procSec_rub    = TaxAmount;           
      var TaxSumSell_rub = TaxSumSell;
      if ( NATCUR != DataSet.FIID )
        SmartConvertSum(procSec_rub, procSec_rub, CommDate, DataSet.FIID, NATCUR, false);
        SmartConvertSum(TaxSumSell_rub, TaxSumSell_rub, CommDate, DataSet.FIID, NATCUR, false);
      end;
    
      var InsertObject = 1;
      var ContractID = -1; // Нужен еще контракт по фактическому получателю. Где его взять?
  
      var fin = TRecHandler("fininstr.dbt");
      err = ПолучитьФинИн(FIID, fin);
      if ( 0 != err )
        MsgBox( err + ": Не найден фининструмент. FIID - " + FIID );
        continue;
      end;
   
      var fiwarnts = TRecHandler("fiwarnts.dbt"); // Текущий купон
      if ( FI_CurrentWarnt(FIID, date(0,0,0), false, false, fiwarnts) != 0)
        MsgBox("Не найден текущий купон по ЦБ(FIID - " +FIID +")" );
        continue;
      end;
  
      var bCorporateObligation2018: bool = false; // Определение корпоративной облигации с 2018 в обращении
      if ( FI_IsBond(FIID) and                                                         // Облигация
          FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BOND_CORPORATE, fin.rec.AvoirKind ) and //Корпоративная
          DL_NPTX_IsCorpBondAfter2018(FIID, fiwarnts.rec.Number) == true )             // в обращении с 2018
                bCorporateObligation2018 = true;
      end;

      var sum = $0;
      if(not bCorporateObligation2018  )
         // TXOBJ_PAIDGENERAL
         if ( (bResident) and (TXGROUP_30 != DataSet.TaxGroup) and (not bSfContrIIS) ) // Кроме случаев, когда НГ=30 и клиент = резидент. Кроме договоров ИИС
           InsertTaxObjectTmp( //268203
                         CommDate,                   // Дата НДР  
                         DataSet.FactReceiverID,                
                         TXOBJ_DIR_OUT,              // Направление /*Расход*/
                         TXOBJ_LEVEL8,               // Уровень
                         UNSET_CHAR,                 // Признак "Пользовательский"
                         TXOBJ_PAIDGENERAL,          // Вид НДР
                         TaxSum,                 // Сумма дохода/расхода
                         DataSet.FIID,               // Валюта дохода/расхода  
                         TXOBJ_KIND1010,             // Вид аналитики 1 - Сделка    
                         DataSet.DocID,              // Аналитика 1       
                         0,                          // Вид аналитики 2      
                         -1,                         // Аналитика 2     
                         TXOBJ_KIND3010,             // Вид аналитики 3 - Ц/б                 
                         FIID,                       // Аналитика 3           
                         TXOBJ_KIND4010,             // Вид аналитики 4 -  Категория ФИ                               
                         DataSet.Circulate,          // Аналитика 4      
                         TXOBJ_KIND5010,             // Вид аналитики 5 - Налоговая группа    
                         DataSet.TaxGroup,           // Аналитика 5              
                         TXOBJ_KIND6020,             // Вид аналитики 6 - ДО (Договор обслуживания)
                         ContractID,                 // Аналитика 6 
                         "",                         // Комментарий
                         ID_Operation,               // ID операции
                         ID_STEP,                    // ID шага операции         
                         TaxSum,                     // Сумма реестра
                         1,                          // Признак вызова не из операции расчета НОБ
                         UNSET_CHAR);                // Пересчет

           sum = max(TaxSumSell_rub - GetNPTXObjSum(NULL, CommDate, PartyID, TXOBJ_PAIDGENERAL, 0), 0);
           InsertTaxObjectTmp( 
                         CommDate,                   // Дата НДР  
                         DataSet.FactReceiverID,                
                         TXOBJ_DIR_OUT,              // Направление /*Расход*/
                         TXOBJ_LEVEL8,               // Уровень
                         UNSET_CHAR,                 // Признак "Пользовательский"
                         TXOBJ_PAIDGENERAL_0,        // Вид НДР
                         sum,                        // Сумма дохода/расхода
                         DataSet.FIID,               // Валюта дохода/расхода  
                         TXOBJ_KIND1010,             // Вид аналитики 1 - Сделка    
                         DataSet.DocID,              // Аналитика 1       
                         0,                          // Вид аналитики 2      
                         -1,                         // Аналитика 2     
                         TXOBJ_KIND3010,             // Вид аналитики 3 - Ц/б                 
                         FIID,                       // Аналитика 3           
                         TXOBJ_KIND4010,             // Вид аналитики 4 -  Категория ФИ                               
                         DataSet.Circulate,          // Аналитика 4      
                         TXOBJ_KIND5010,             // Вид аналитики 5 - Налоговая группа    
                         DataSet.TaxGroup,           // Аналитика 5              
                         TXOBJ_KIND6020,             // Вид аналитики 6 - ДО (Договор обслуживания)
                         ContractID,                 // Аналитика 6 
                         "",                         // Комментарий
                         ID_Operation,               // ID операции
                         ID_STEP,                    // ID шага операции         
                         0,                          // Сумма реестра
                         1,                          // Признак вызова не из операции расчета НОБ
                         UNSET_CHAR);                // Пересчет
         end;
   
         // TXOBJ_PAIDSPECIAL
         if ( (TXGROUP_30 == DataSet.TaxGroup) and bResident and (not bSfContrIIS) ) // НГ=30 и клиент = ре-зидент. Кроме договоров ИИС
           InsertTaxObjectTmp( //268203
                       CommDate,                    // Дата НДР  
                       DataSet.FactReceiverID,                
                       TXOBJ_DIR_OUT,               // Направление /*Расход*/
                       TXOBJ_LEVEL8,                // Уровень
                       UNSET_CHAR,                  // Признак "Пользовательский"
                       TXOBJ_PAIDSPECIAL,           // Вид НДР
                       TaxSum,                  // Сумма дохода/расхода
                       DataSet.FIID,                // Валюта дохода/расхода
                       TXOBJ_KIND1010,              // Вид аналитики 1 - Сделка    
                       DataSet.DocID,               // Аналитика 1       
                       0,                           // Вид аналитики 2      
                       -1,                          // Аналитика 2     
                       TXOBJ_KIND3010,              // Вид аналитики 3 - Ц/б                 
                       FIID,                        // Аналитика 3           
                       TXOBJ_KIND4010,              // Вид аналитики 4 -  Категория ФИ                               
                       DataSet.Circulate,           // Аналитика 4      
                       TXOBJ_KIND5010,              // Вид аналитики 5 - Налоговая группа    
                       DataSet.TaxGroup,            // Аналитика 5              
                       TXOBJ_KIND6020,              // Вид аналитики 6 - ДО (Договор обслуживания)
                       ContractID,                  // Аналитика 6 
                       "",                          // Комментарий
                       ID_Operation,                // ID операции
                       ID_STEP,                     // ID шага операции      
                       TaxSum,                  // Сумма реестра
                       1,                           // Признак вызова не из операции расчета НОБ
                       UNSET_CHAR);                 // Пересчет

           sum = max(TaxSumSell_rub - GetNPTXObjSum(NULL, CommDate, PartyID, TXOBJ_PAIDSPECIAL, 0), 0);
           InsertTaxObjectTmp( 
                       CommDate,                    // Дата НДР  
                       DataSet.FactReceiverID,                
                       TXOBJ_DIR_OUT,               // Направление /*Расход*/
                       TXOBJ_LEVEL8,                // Уровень
                       UNSET_CHAR,                  // Признак "Пользовательский"
                       TXOBJ_PAIDSPECIAL_0,         // Вид НДР
                       sum,                         // Сумма дохода/расхода
                       DataSet.FIID,                // Валюта дохода/расхода
                       TXOBJ_KIND1010,              // Вид аналитики 1 - Сделка    
                       DataSet.DocID,               // Аналитика 1       
                       0,                           // Вид аналитики 2      
                       -1,                          // Аналитика 2     
                       TXOBJ_KIND3010,              // Вид аналитики 3 - Ц/б                 
                       FIID,                        // Аналитика 3           
                       TXOBJ_KIND4010,              // Вид аналитики 4 -  Категория ФИ                               
                       DataSet.Circulate,           // Аналитика 4      
                       TXOBJ_KIND5010,              // Вид аналитики 5 - Налоговая группа    
                       DataSet.TaxGroup,            // Аналитика 5              
                       TXOBJ_KIND6020,              // Вид аналитики 6 - ДО (Договор обслуживания)
                       ContractID,                  // Аналитика 6 
                       "",                          // Комментарий
                       ID_Operation,                // ID операции
                       ID_STEP,                     // ID шага операции      
                       0,                           // Сумма реестра
                       1,                           // Признак вызова не из операции расчета НОБ
                       UNSET_CHAR);                 // Пересчет
         end;
   
         // TXOBJ_PAIDGENERAL_IIS
         if ( (TXGROUP_30 != DataSet.TaxGroup) and ( not bResident ) and  bSfContrIIS ) //Кроме случаев, когда НГ=30 и клиент = ре-зидент. Для договоров ИИС
           InsertTaxObjectTmp( //268203
                       CommDate,                    // Дата НДР 
                       DataSet.FactReceiverID,                
                       TXOBJ_DIR_OUT,               // Направление /*Расход*/
                       TXOBJ_LEVEL8,                // Уровень
                       UNSET_CHAR,                  // Признак "Пользовательский"
                       TXOBJ_PAIDGENERAL_IIS,       // Вид НДР
                       TaxSumSell,                  // Сумма дохода/расхода
                       DataSet.FIID,                // Валюта дохода/расхода  
                       TXOBJ_KIND1010,              // Вид аналитики 1 - Сделка    
                       DataSet.DocID,               // Аналитика 1       
                       0,                           // Вид аналитики 2      
                       -1,                          // Аналитика 2     
                       TXOBJ_KIND3010,              // Вид аналитики 3 - Ц/б                 
                       FIID,                        // Аналитика 3           
                       TXOBJ_KIND4010,              // Вид аналитики 4 -  Категория ФИ                               
                       DataSet.Circulate,           // Аналитика 4      
                       TXOBJ_KIND5010,              // Вид аналитики 5 - Налоговая группа    
                       DataSet.TaxGroup,            // Аналитика 5              
                       TXOBJ_KIND6020,              // Вид аналитики 6 - ДО (Договор обслуживания)
                       ContractID,                  // Аналитика 6 
                       "",                          // Комментарий
                       ID_Operation,                // ID операции
                       ID_STEP,                     // ID шага операции             
                       TaxSumSell,                  // Сумма реестра
                       1,                           // Признак вызова не из операции расчета НОБ
                       UNSET_CHAR);                 // Пересчет
         end;
      else
         // TXOBJ_PAID_35
         if (  bResident ) //клиент = ре-зидент.
           InsertTaxObjectTmp( //268203
                       CommDate,               // Дата НДР  
                       DataSet.FactReceiverID,                
                       TXOBJ_DIR_OUT,          // Направление /*Расход*/
                       TXOBJ_LEVEL8,           // Уровень
                       UNSET_CHAR,             // Признак "Пользовательский"
                       TXOBJ_PAID_35,          // Вид НДР
                       TaxSum,                 // Сумма дохода/расхода
                       NATCUR,                 // Валюта дохода/расхода  
                       TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                       DataSet.DocID,          // Аналитика 1       
                       0,                      // Вид аналитики 2      
                       -1,                     // Аналитика 2     
                       TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                       FIID,                   // Аналитика 3           
                       TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                       DataSet.Circulate,      // Аналитика 4      
                       TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                       DataSet.TaxGroup,       // Аналитика 5              
                       TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                       ContractID,             // Аналитика 6 
                       "",                     // Комментарий
                       ID_Operation,           // ID операции
                       ID_STEP,                // ID шага операции 
                       TaxSum,                 // Сумма реестра
                       1,                      // Признак вызова не из операции расчета НОБ
                       UNSET_CHAR);            // Пересчет

           sum = max(TaxSumSell_rub - GetNPTXObjSum(NULL, CommDate, PartyID, TXOBJ_PAID_35, 0), 0);
           InsertTaxObjectTmp( 
                       CommDate,               // Дата НДР  
                       DataSet.FactReceiverID,                
                       TXOBJ_DIR_OUT,          // Направление /*Расход*/
                       TXOBJ_LEVEL8,           // Уровень
                       UNSET_CHAR,             // Признак "Пользовательский"
                       TXOBJ_PAID35_0,         // Вид НДР
                       sum,                    // Сумма дохода/расхода
                       NATCUR,                 // Валюта дохода/расхода  
                       TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                       DataSet.DocID,          // Аналитика 1       
                       0,                      // Вид аналитики 2      
                       -1,                     // Аналитика 2     
                       TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                       FIID,                   // Аналитика 3           
                       TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                       DataSet.Circulate,      // Аналитика 4      
                       TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                       DataSet.TaxGroup,       // Аналитика 5              
                       TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                       ContractID,             // Аналитика 6 
                       "",                     // Комментарий
                       ID_Operation,           // ID операции
                       ID_STEP,                // ID шага операции
                       0,                      // Сумма реестра
                       1,                      // Признак вызова не из операции расчета НОБ
                       UNSET_CHAR);            // Пересчет
         end;
   
         // TXOBJ_PAIDGENERAL
         if ( not bResident ) //Клиент = нерезидент.
           InsertTaxObjectTmp( //268203
                       CommDate,               // Дата НДР  
                       DataSet.FactReceiverID,                
                       TXOBJ_DIR_OUT,          // Направление /*Расход*/
                       TXOBJ_LEVEL8,           // Уровень
                       UNSET_CHAR,             // Признак "Пользовательский"
                       TXOBJ_PAIDGENERAL,      // Вид НДР
                       TaxSum,                 // Сумма дохода/расхода
                       NATCUR,                 // Валюта дохода/расхода  
                       TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                       DataSet.DocID,          // Аналитика 1       
                       0,                      // Вид аналитики 2      
                       -1,                     // Аналитика 2     
                       TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                       FIID,                   // Аналитика 3           
                       TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                       DataSet.Circulate,      // Аналитика 4      
                       TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                       DataSet.TaxGroup,       // Аналитика 5              
                       TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                       ContractID,             // Аналитика 6 
                       "",                     // Комментарий
                       ID_Operation,           // ID операции
                       ID_STEP,                // ID шага операции 
                       TaxSum,                 // Сумма реестра
                       1,                      // Признак вызова не из операции расчета НОБ
                       UNSET_CHAR);            // Пересчет

           sum = max(TaxSumSell_rub - GetNPTXObjSum(NULL, CommDate, PartyID, TXOBJ_PAIDGENERAL, 0), 0);
           InsertTaxObjectTmp( 
                       CommDate,               // Дата НДР  
                       DataSet.FactReceiverID,                
                       TXOBJ_DIR_OUT,          // Направление /*Расход*/
                       TXOBJ_LEVEL8,           // Уровень
                       UNSET_CHAR,             // Признак "Пользовательский"
                       TXOBJ_PAIDGENERAL_0,    // Вид НДР
                       TaxSum,                 // Сумма дохода/расхода
                       NATCUR,                 // Валюта дохода/расхода  
                       TXOBJ_KIND1010,         // Вид аналитики 1 - Сделка    
                       DataSet.DocID,          // Аналитика 1       
                       0,                      // Вид аналитики 2      
                       -1,                     // Аналитика 2     
                       TXOBJ_KIND3010,         // Вид аналитики 3 - Ц/б                 
                       FIID,                   // Аналитика 3           
                       TXOBJ_KIND4010,         // Вид аналитики 4 -  Категория ФИ                               
                       DataSet.Circulate,      // Аналитика 4      
                       TXOBJ_KIND5010,         // Вид аналитики 5 - Налоговая группа    
                       DataSet.TaxGroup,       // Аналитика 5              
                       TXOBJ_KIND6020,         // Вид аналитики 6 - ДО (Договор обслуживания)
                       ContractID,             // Аналитика 6 
                       "",                     // Комментарий
                       ID_Operation,           // ID операции
                       ID_STEP,                // ID шага операции 
                       0,                      // Сумма реестра
                       1,                      // Признак вызова не из операции расчета НОБ
                       UNSET_CHAR);            // Пересчет
         end;
      end;
   end;

   if(not TaxObj.IsEmpty())
      TaxObj.Save();
      TaxObj.Clear();
   end;

   DL_NPTX_StartInsertTaxObject(ID_Operation, ID_Step);
   
   return err;
END;

//получить сумму вывода ц/б
MACRO GetOutAvoirissSum(ClientID, IIS, BeginDate, EndDate, v_TO:@variant)
  var Query, rsd, DataSet, Query1, rsd1, DataSet1;
  var SumBrub, SumBrub0, ComB, IsBack;
  file dl_tick(dl_tick);
  var SZ = $0, v_Sum = $0;

  v_TO = $0;
  
  Query = "select L.t_Amount LAmount, LegB.t_Principal Qbuy, BDL.t_DealID, BDL.t_BOfficeKind, " +
          "       Rsb_Secur.IsSale(Opr.oGrp) IsSale, SDL.t_DealDate WrtDealDate " +
          "  from ddl_tick_dbt SDL, dnptxlot_dbt LS, dnptxlnk_dbt L, dnptxlot_dbt LB, ddl_tick_dbt BDL, ddl_leg_dbt LegB, dsfcontr_dbt sfcontr, ddl_leg_dbt LegS, " +
          "       (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup(t_SysTypes) oGrp " +
          "          FROM doprkoper_dbt) Opr " +
          " where SDL.t_BOfficeKind = " + string(DL_AVRWRT) +
          "   and SDL.t_ClientID = ? " +
          "   and LS.t_contract = sfcontr.t_ID  " +
          "   and ( npto.CheckContrIIS(sfcontr.t_ID) = ? ) " +
          "   and SDL.t_DealDate >= ? " +
          "   and SDL.t_DealDate <= ? " +
          "   and LS.t_DocKind = SDL.t_BOfficeKind" +
          "   and LS.t_DocID = SDL.t_DealID" +
          "   and L.t_SaleID = LS.t_ID " +
          "   and L.t_Type IN ( " + string(NPTXLNK_DELIVER) + ", " + string(NPTXLNK_OPPOS) + " ) " +
          "   and LB.t_ID = L.t_BuyID" +
          "   and BDL.t_DealID = LB.t_DocID " +
          "   and BDL.t_BOfficeKind = LB.t_DocKind " +
          "   and LegB.t_DealID = BDL.t_DealID " +
          "   and LegB.t_LegID = 0 " +
          "   and LegB.t_LegKind = 0 " +
          "   and LegS.t_DealID = SDL.t_DealID" +
          "   and LegS.t_LegID = 0" +
          "   and LegS.t_LegKind = 0" +
          "   and Opr.t_Kind_Operation = BDL.t_DealType " +
          "   and Opr.t_DocKind = BDL.t_BOfficeKind " +
          "   and (Exists " +
                      " ( SELECT 1 FROM dobjatcor_dbt objatcor " +
                      "    WHERE objatcor.t_ObjectType = "+ OBJTYPE_SECDEAL + " AND " + 
                      "          objatcor.t_GroupID    = 30 AND " + /*"Является выплатой дохода в натуральной форме"*/
                      "          objatcor.t_Object     = LPAD( SDL.t_DealID, 34, '0' ) AND "+
                      "          objatcor.t_AttrID     = 1" + /*Да*/
                      " ) " +
          "       or" +
          "       (select t_NotResident from dparty_dbt where t_PartyID = LegS.t_DepositID) = 'X'" +
          "       )"; 

  rsd = RSDCommand(Query);
  rsd.addParam( "", RSDBP_IN, ClientID );
  rsd.addParam( "", RSDBP_IN, IIS );
  rsd.addParam( "", RSDBP_IN, BeginDate );
  rsd.addParam( "", RSDBP_IN, EndDate );
  rsd.execute();

  DataSet = TRsbDataSet(rsd);
  while( DataSet.MoveNext() )
    if (DataSet.IsSale == 1)
       IsBack = true;
    else
       IsBack = false;
    end;

    Query1 = "select rq.t_Amount, rq.t_FIID, rq.t_FactDate " +
             "  from ddlrq_dbt rq, ddl_leg_dbt Leg " +
             " where rq.t_DocKind    = " + string(DataSet.BOfficeKind) +
             "   and rq.t_DocID = " + string(DataSet.DealID) +
             "   and Leg.t_DealID = rq.t_DocID " +
             "   and Leg.t_LegID = 0 " +
             "   and Leg.t_LegKind = " + IIF(IsBack, string(2), string(0)) +
             "   and rq.t_DealPart = " + IIF(IsBack, string(2), string(1)) +
             "   and rq.t_Type IN ( " + string(DLRQ_TYPE_PAYMENT) + "," + string(DLRQ_TYPE_AVANCE) + "," + string(DLRQ_TYPE_DEPOSIT) + " ) " +
             "   and rq.t_State = " + DLRQ_STATE_EXEC;
    rsd1 = RSDCommand(Query1);
    rsd1.execute();

    DataSet1 = TRsbDataSet(rsd1);
    SumBrub = 0;
    while( DataSet1.MoveNext() )
       SmartConvertSum(SumBrub0, DataSet1.Amount, date(DataSet1.FactDate), DataSet1.FIID, NATCUR, false);
       SumBrub = SumBrub + SumBrub0;
    end;

    ComB = 0;

    ClearRecord( dl_tick );
    dl_tick.DealID = DataSet.DealID;
    if( GetEQ( dl_tick ) )

       VAR sum_agent = $0, nds_agent = $0;                                                              
       
       SP_GetSumCom( sum_agent, nds_agent, null, null,
                     dl_tick.BofficeKind, dl_tick.DealID, null, null, null, 0, 1,   
                     1, 0, 1, 1, null, NATCUR, true, IIF(IsBack,false,true), IIF(IsBack,true,false)
                   );

       ComB = sum_agent;
    end;

    v_Sum = DataSet.LAmount * (SumBrub + ComB) / DataSet.Qbuy;

    SZ = SZ + v_Sum;

    if( SQL_ConvTypeDate(DataSet.WrtDealDate) == EndDate )
       v_TO = v_TO + v_Sum;
    end;

  end;

  return SZ;
END;

//получить сумму вывода д/с
MACRO GetOutCurrencySum(ClientID, IIS, BegDate, EndDate, IsNotFlagTax, ConvDate):Money
  var OutSum = $0;
  var query = "", cmd = null, set = null;
  var Sum = $0;

  query = " SELECT "
            + " nptxop.t_OutSum "
           + " ,nptxop.t_Currency "
        + " FROM "
            + " dnptxop_dbt nptxop "
        + " WHERE "
            + " nptxop.t_DocKind = " + DL_WRTMONEY + " "
        + " AND nptxop.t_Client = ? "
        + " AND npto.CheckContrIIS(nptxop.t_Contract) = ? " 
        + " AND nptxop.t_OperDate BETWEEN ? AND ? "
        + " AND nptxop.t_CalcNDFL = " + GetSQLChar(SET_CHAR) + " " 
        + " AND nptxop.t_Subkind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
        + " AND nptxop.t_Status > " + DL_TXOP_Prep + " ";

  if(IsNotFlagTax)
    query = query + " AND nptxop.t_FlagTax <> 'X' ";
  end;

  cmd = RSDCommand(query);
  cmd.NullConversion = true;
  cmd.addParam("", RSDBP_IN, ClientID);
  cmd.addParam("", RSDBP_IN, IIS);
  cmd.addParam("", RSDBP_IN, BegDate);
  cmd.addParam("", RSDBP_IN, EndDate);
  cmd.execute();

  set = RsdRecordset(cmd);
  while(set.MoveNext())
    if(set.Value("t_Currency") != NATCUR)
      Sum = $0;
      if(SmartConvertSum(Sum, set.Value("t_OutSum"), ConvDate, set.Value("t_Currency"), NATCUR, true))
        OutSum = OutSum + Sum;
      end;
    else
      OutSum = OutSum + set.Value("t_OutSum");
    end;
  end;

  return OutSum;
END;

class NPTXLink(_BeginDate, _EndDate, _Mode)
  private var m_BeginDate = ZeroDate;
  private var m_EndDate = ZeroDate;
  private var m_Mode = 1;

  macro Create()
    var query = "", cmd = null, set = null;
    var query2 = "", cmd2 = null, set2 = null;
    var query3 = "", cmd3 = null;
    var TO = $0.0, SO = $0.0, SZ = $0.0;
    var Bg = $0.0, Bm = $0.0, Bs = $0.0, Bo = $0.0, Bd = $0.0;
    var Dg = $0.0, Dm = $0.0, Ds = $0.0, Po = $0.0;
    var yyyy = 0, taxToPay = $0.0, endDate = ZeroDate;
    var sum = $0, allSum = $0, lnkSum = $0;

    SQL_Truncate("dnptx6_tmp");

    query = " SELECT "
              + " nptxop.t_DocKind AS t_DocKind "
             + " ,nptxop.t_ID AS t_DocID "
             + " ,nptxobj.t_Client AS t_ClientID "
             + " ,nptxop.t_OperDate AS t_Date "
             + " ,SUM(nptxobj.t_Sum) AS t_Sum "
             + " ,nptxop.t_CloseContr AS t_CloseContr "
             + " ,nptxop.t_Contract as t_Contract "
             + " ,nptxop.t_Tax AS t_Tax "
             + " ,nptxop.t_SubKind_Operation AS t_SubKind_Operation "
             + " ,CASE "
                  + " WHEN nptxop.t_DocKind = " + DL_WRTMONEY + " "
                  + " THEN "
                      + " CASE "
                          + " WHEN npto.CheckContrIIS(nptxop.t_Contract) = 1 "
                          + " THEN "
                              + " " + GetSQLChar(SET_CHAR) + " "
                          + " ELSE "
                              + " " + GetSQLChar(UNSET_CHAR) + " "
                      + " END "
                  + " ELSE "
                      + " nptxop.t_IIS "
              + " END AS t_IIS "
             + " ,nptxop.t_PrevDate AS t_PrevDate "
             + " ,nptxop.t_TOut AS t_TOut  "
             + " ,nptxop.t_OutSum AS t_OutSum "
          + " FROM "
              + " dnptxobj_dbt nptxobj "
             + " ,dnptxobdc_dbt nptxobdc "
             + " ,dnptxop_dbt nptxop "
          + " WHERE "
              + " nptxobj.t_Kind = " + TXOBJ_DUETAX + " "
          + " AND nptxobj.t_Sum > 0 "
          + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
          + " AND nptxobdc.t_DocID = nptxop.t_ID "
          + " AND (1 = " + IIF(m_Mode == 1, 1, 0) + " "
           + " AND (nptxop.t_DocKind = " + DL_WRTMONEY + " "
            + " AND nptxop.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
            + " AND nptxop.t_FlagTax = " + GetSQLChar(SET_CHAR) + " "
             + " OR nptxop.t_DocKind = " + DL_HOLDNDFL + ") "
            + " OR 1 = " + IIF(m_Mode != 1, 1, 0) + " "
           + " AND nptxop.t_DocKind = " + DL_HOLDNDFL + " "
           + " AND nptxop.t_SubKind_Operation IN (" + DL_TXHOLD_OPTYPE_OUTAVOIR
                                             + ", " + DL_TXHOLD_OPTYPE_LUCRE + ")) "
          + " AND nptxop.t_OperDate BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_EndDate) + " "
          + " GROUP BY "
              + " nptxop.t_DocKind "
             + " ,nptxop.t_ID "
             + " ,nptxobj.t_Client "
             + " ,nptxop.t_OperDate "
             + " ,nptxop.t_CloseContr "
             + " ,nptxop.t_Tax "
             + " ,nptxop.t_SubKind_Operation "
             + " ,CASE "
                  + " WHEN nptxop.t_DocKind = " + DL_WRTMONEY + " "
                  + " THEN "
                      + " CASE "
                          + " WHEN npto.CheckContrIIS(nptxop.t_Contract) = 1 "
                          + " THEN "
                              + " " + GetSQLChar(SET_CHAR) + " "
                          + " ELSE "
                              + " " + GetSQLChar(UNSET_CHAR) + " "
                      + " END "
                  + " ELSE "
                      + " nptxop.t_IIS "
              + " END "
             + " ,nptxop.t_PrevDate "
             + " ,nptxop.t_TOut "
             + " ,nptxop.t_OutSum ";

    cmd = RsdCommand(query);
    cmd.NullConversion = true;
    cmd.Execute();

    set = RsdRecordset(cmd);
    while(set.MoveNext())
      sum = $0.0;

      if(set.Value("t_DocKind") == DL_WRTMONEY)
        DateSplit(Date(set.Value("t_Date")), null, null, yyyy);

        if(set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_OUTMONEY)
          TO = set.Value("t_OutSum");
        end;

        CalcPaidSum(set.Value("t_ClientID"), set.Value("t_Contract"), set.Value("t_DocKind"), set.Value("t_SubKind_Operation"), Date(1, 1, yyyy), Date(set.Value("t_Date")), SO, SZ, TO, @Bg, @Bm, @Bs, @Dm, @Ds, @Dg, set.Value("t_IIS"), @Po, @Bd);

        if(set.Value("t_CloseContr") != SET_CHAR)
          sum = Ds + Dg;
        else
          sum = Dm + Ds + Dg;
        end;
      else
        DateSplit(Date(set.Value("t_PrevDate")), null, null, yyyy);

        endDate = Date(31, 12, yyyy);

        if(Date(set.Value("t_Date")) < endDate)
          endDate = Date(set.Value("t_Date"));
        end;

        if((set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_OUTMONEY)
        or (set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_CLOSE))
          if(set.Value("t_TOut") != $0.0)
            TO = set.Value("t_TOut");
          else
            TO = GetOutCurrencySum(set.Value("t_ClientID"), IIF(set.Value("t_IIS") == SET_CHAR, 1, 0), Date(set.Value("t_Date")), Date(set.Value("t_Date")), true, Date(set.Value("t_Date")));
          end;
        end;

        if((set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_OUTMONEY)
        or (set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_OUTAVOIR))
          SO = GetOutCurrencySum(set.Value("t_ClientID"), IIF(set.Value("t_IIS") == SET_CHAR, 1, 0), Date(set.Value("t_PrevDate")), endDate, false, Date(set.Value("t_Date")));

          if(set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_OUTAVOIR)
            SZ = GetOutAvoirissSum(set.Value("t_ClientID"), IIF(set.Value("t_IIS") == SET_CHAR, 1, 0), Date(set.Value("t_PrevDate")), endDate, @TO);
          else
            SZ = GetOutAvoirissSum(set.Value("t_ClientID"), IIF(set.Value("t_IIS") == SET_CHAR, 1, 0), Date(set.Value("t_PrevDate")), endDate);
          end;
        end;

        CalcPaidSum(set.Value("t_ClientID"), set.Value("t_Contract"), set.Value("t_DocKind"), set.Value("t_SubKind_Operation"), m_BeginDate, endDate, SO, SZ, TO, @Bg, @Bm, @Bs, @Dm, @Ds, @Dg, UNSET_CHAR, @Po, @Bd);

        taxToPay = $0.0;

        if((set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_OUTMONEY)
        or (set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_OUTAVOIR))
          taxToPay = Po;
        elif(set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_PREHOLD)
          if(set.Value("t_IIS") != SET_CHAR)
            DL_GetNPTXOBJSum(null, null, null, "" + TXOBJ_DUETAX, set.Value("t_PrevDate"), endDate, null, null, @taxToPay, 0, set.Value("t_ClientID"), null, null, null, null, null, null, null, 0, null);
          else
            query2 = " SELECT "
                       + " nptxop.t_CloseContr AS t_CloseContr "
                      + " ,nptxop.t_IIS AS t_IIS "
                   + " FROM "
                       + " dnptxop_dbt nptxop "
                   + " WHERE "
                       + " nptxop.t_DocKind = " + DL_WRTMONEY + " "
                   + " AND nptxop.t_Status = " + DL_TXOP_Close + " "
                   + " AND nptxop.t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_OUTMONEY + " "
                   + " AND nptxop.t_Client = ? "
                   + " AND npto.CheckContrIIS(nptxop.t_Contract) = 1 "
                   + " AND nptxop.t_OperDate <= ? "
                   + " ORDER BY "
                       + " nptxop.t_OperDate DESC ";

            cmd2 = RsdCommand(query2);
            cmd2.NullConversion = true;
            cmd2.AddParam("", RSDBP_IN, set.Value("t_ClientID"));
            cmd2.AddParam("", RSDBP_IN, endDate);
            cmd2.Execute();

            set2 = RsdRecordset(cmd2);

            if(not set2.MoveNext()
            or (set2.Value("t_CloseContr") == SET_CHAR)
           and (set2.Value("t_IIS") == SET_CHAR))
              taxToPay = GetRubSumByClientFromDepo(set.Value("t_ClientID"), "" + TXOBJ_DUETAX, Date(1, 1, yyyy), endDate);
            elif((set2.Value("t_CloseContr") == SET_CHAR)
             and (set2.Value("t_IIS") != SET_CHAR))
              DL_GetNPTXOBJSum(null, null, null, "" + TXOBJ_DUETAX, Date(GetFirstDateIIS(set.Value("t_ClientID"))), endDate, null, null, @taxToPay, 0, set.Value("t_ClientID"), null, null, null, null, null, null, null, 0, null);
            end;
          end;
        else
          taxToPay = Dm + Ds + Dg;
        end;

        if(set.Value("t_SubKind_Operation") == DL_TXHOLD_OPTYPE_PREHOLD)
          sum = taxToPay;
        else
          sum = Dm + Ds + Dg;
        end;
      end;

      if((sum > 0) and (sum > set.Value("t_Tax")))
        query2 = " INSERT INTO "
                   + " dnptx6_tmp(t_Type "
                             + " ,t_DocKind "
                             + " ,t_DocID "
                             + " ,t_ClientID "
                             + " ,t_Date "
                             + " ,t_Sum) "
               + " VALUES "
                   + " (1 "
                   + " ,? "
                   + " ,? "
                   + " ,? "
                   + " ,? "
                   + " ,?) ";

        cmd2 = RsdCommand(query2);
        cmd2.NullConversion = true;
        cmd2.AddParam("", RSDBP_IN, set.Value("t_DocKind"));
        cmd2.AddParam("", RSDBP_IN, set.Value("t_DocID"));
        cmd2.AddParam("", RSDBP_IN, set.Value("t_ClientID"));
        cmd2.AddParam("", RSDBP_IN, set.Value("t_Date"));
        cmd2.AddParam("", RSDBP_IN, set.Value("t_Sum"));
        cmd2.Execute();
      end;
    end;

    query = " INSERT INTO "
              + " dnptx6_tmp(t_Type "
                        + " ,t_DocKind "
                        + " ,t_DocID "
                        + " ,t_ClientID "
                        + " ,t_Date "
                        + " ,t_Sum) "
              + " SELECT "
                  + " 2 AS t_Type "
                 + " ,nptxop.t_DocKind AS t_DocKind "
                 + " ,nptxop.t_ID AS t_DocID "
                 + " ,nptxobj.t_Client AS t_ClientID "
                 + " ,nptxop.t_OperDate AS t_Date "
                 + " ,SUM(nptxobj.t_Sum) AS t_Sum "
              + " FROM "
                  + " dnptxobj_dbt nptxobj "
                 + " ,dnptxobdc_dbt nptxobdc "
                 + " ,dnptxop_dbt nptxop "
              + " WHERE "
                  + " nptxobj.t_Kind = " + TXOBJ_DUETAX + " "
              + " AND nptxobj.t_Sum < 0 "
              + " AND nptxobj.t_ObjID = nptxobdc.t_ObjID "
              + " AND nptxobdc.t_DocID = nptxop.t_ID "
              + " AND (nptxop.t_DocKind = " + DL_WRTMONEY + " "
               + " AND nptxop.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF + " "
               + " AND nptxop.t_FlagTax = " + GetSQLChar(SET_CHAR) + " "
                + " OR nptxop.t_DocKind = " + DL_HOLDNDFL + ") "
              + " AND nptxop.t_OperDate BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_EndDate) + " "
              + " AND NOT EXISTS (SELECT "
                                  + " t_DocID "
                              + " FROM "
                                  + " dnptx6_tmp "
                              + " WHERE "
                                  + " t_DocID = nptxop.t_ID) "
              + " AND nptxop.t_Tax > 0 "
              + " GROUP BY "
                  + " nptxop.t_DocKind "
                 + " ,nptxop.t_ID "
                 + " ,nptxobj.t_Client "
                 + " ,nptxop.t_OperDate ";

    cmd = RsdCommand(query);
    cmd.Execute();

    SQL_Truncate("dnptx6lnk_tmp");

    query = " SELECT "
              + " t_DocKind "
             + " ,t_DocID "
             + " ,t_ClientID "
             + " ,t_Date "
             + " ,t_Sum "
          + " FROM "
              + " dnptx6_tmp "
          + " WHERE "
              + " t_Type = 1 "
          + " ORDER BY "
              + " t_Date ASC ";

    cmd = RsdCommand(query);
    cmd.NullConversion = true;
    cmd.Execute();

    set = RsdRecordset(cmd);
    while(set.MoveNext())
      sum = set.Value("t_Sum");
      allSum = sum;

      while(sum > 0)
        query2 = " SELECT "
                   + " t_DocKind "
                  + " ,t_DocID "
                  + " ,t_ClientID "
                  + " ,t_Date "
                  + " ,t_Sum "
               + " FROM "
                   + " dnptx6_tmp "
               + " WHERE "
                   + " t_Type = 2 "
               + " AND t_ClientID = ? "
               + " AND t_Sum < 0 "
               + " ORDER BY "
                   + " t_Date ASC ";

        cmd2 = RsdCommand(query2);
        cmd2.NullConversion = true;
        cmd2.AddParam("", RSDBP_IN, set.Value("t_ClientID"));
        cmd2.Execute();

        set2 = RsdRecordset(cmd2);
        if(set2.MoveNext())
          lnkSum = Min(sum, Abs(set2.Value("t_Sum")));

          query3 = " INSERT INTO "
                     + " dnptx6lnk_tmp(t_DocKind1 "
                                  + " ,t_DocID1 "
                                  + " ,t_ClientID1 "
                                  + " ,t_DocKind2 "
                                  + " ,t_DocID2 "
                                  + " ,t_ClientID2 "
                                  + " ,t_Date "
                                  + " ,t_Sum "
                                  + " ,t_AllSum) "
                     + " VALUES "
                         + " (? "
                         + " ,? "
                         + " ,? "
                         + " ,? "
                         + " ,? "
                         + " ,? "
                         + " ,? "
                         + " ,? "
                         + " ,?) ";

          cmd3 = RsdCommand(query3);
          cmd3.NullConversion = true;
          cmd3.AddParam("", RSDBP_IN, set.Value("t_DocKind"));
          cmd3.AddParam("", RSDBP_IN, set.Value("t_DocID"));
          cmd3.AddParam("", RSDBP_IN, set.Value("t_ClientID"));
          cmd3.AddParam("", RSDBP_IN, set2.Value("t_DocKind"));
          cmd3.AddParam("", RSDBP_IN, set2.Value("t_DocID"));
          cmd3.AddParam("", RSDBP_IN, set2.Value("t_ClientID"));
          cmd3.AddParam("", RSDBP_IN, set.Value("t_Date"));
          cmd3.AddParam("", RSDBP_IN, lnkSum);
          cmd3.AddParam("", RSDBP_IN, allSum);
          cmd3.Execute();

          sum = sum - lnkSum;

          query3 = " UPDATE "
                     + " dnptx6_tmp "
                 + " SET "
                     + " (t_Sum) = "
                         + " (SELECT "
                              + " ? "
                          + " FROM "
                              + " DUAL) "
                 + " WHERE "
                     + " t_Type = 1 "
                 + " AND t_DocKind = ? "
                 + " AND t_DocID = ? "
                 + " AND t_ClientID = ? ";

          cmd3 = RsdCommand(query3);
          cmd3.NullConversion = true;
          cmd3.AddParam("", RSDBP_IN, sum);
          cmd3.AddParam("", RSDBP_IN, set.Value("t_DocKind"));
          cmd3.AddParam("", RSDBP_IN, set.Value("t_DocID"));
          cmd3.AddParam("", RSDBP_IN, set.Value("t_ClientID"));
          cmd3.Execute();

          query3 = " UPDATE "
                     + " dnptx6_tmp "
                 + " SET "
                     + " (t_Sum) = "
                         + " (SELECT "
                              + " ? "
                          + " FROM "
                              + " DUAL) "
                 + " WHERE "
                     + " t_Type = 2 "
                 + " AND t_DocKind = ? "
                 + " AND t_DocID = ? "
                 + " AND t_ClientID = ? ";

          cmd3 = RsdCommand(query3);
          cmd3.NullConversion = true;
          cmd3.AddParam("", RSDBP_IN, set2.Value("t_Sum") + lnkSum);
          cmd3.AddParam("", RSDBP_IN, set2.Value("t_DocKind"));
          cmd3.AddParam("", RSDBP_IN, set2.Value("t_DocID"));
          cmd3.AddParam("", RSDBP_IN, set2.Value("t_ClientID"));
          cmd3.Execute();
        else
          break;
        end;
      end;
    end;
  end;

  if(_BeginDate != null)
    m_BeginDate = _BeginDate;
  end;

  if(_EndDate != null)
    m_EndDate = _EndDate;
  end;

  if(_Mode != null)
    m_Mode = _Mode;
  end;
end;

MACRO RecalcDividendTaxObjects(Oper:TRecHandler, ID_Operation, ID_Step)
   var TaxAmountRec = 0.0, TaxAmountRec15 = 0.0, ParmStr = "";
   var TaxAmountPay = 0.0, TaxAmountPay15 = 0.0;
   var Num = 0;
   var TickRec = TRecHandler("dl_tick.dbt");
   var LegRec = TRecHandler("dl_leg.dbt");
   var AnaliticKind1;
   var BenefContrID = -1, KindContr = 0;
   var stat = 0;

   TaxObj = TInsertTaxObject();

   var DivQuery = "select q.t_BruttoAmount, " +
                  "       q.t_CorpopCurrency, " +
                  "       q.t_HolderID, " +
                  "       q.t_FIID, " +
                  "       q.t_HolderAccID, " +
                  "       q.t_DocumentID, " +
                  "       q.t_ValueDate, " +
                  "       q.t_D1, " +
                  "       q.t_D2, " +
                  "       q.t_TaxCurr, " +
                  "       q.t_PayerID " +
                  "from (" +
                  "        select dppmacc.t_BruttoAmount, " +
                  "               dpcorpop.t_Currency as t_CorpopCurrency, " +
                  "               dppmacc.t_HolderID, " +
                  "               dpreglin.t_FIIDFrom as t_FIID, " +
                  "               dppmacc.t_HolderAccID, " +
                  "               dppmacc.t_DocumentID as t_DocumentID, " +
                  "               dpcorpop.t_ValueDate, " +
                  "               RSI_RSB_FIInstr.ConvSum(RSB_DEPO.GetNoteTextMoney( 997/*OBJTYPE_DIVIDENDS*/, LPAD(fiwarnts.t_ID, 34, '0'), 1, dpcorpop.t_ValueDate ), fiwarnts.t_IncomeFI, dpcorpop.t_Currency, dpcorpop.t_ValueDate) as t_D1, " +
                  "               RSI_RSB_FIInstr.ConvSum(RSB_DEPO.GetNoteTextMoney( 997/*OBJTYPE_DIVIDENDS*/, LPAD(fiwarnts.t_ID, 34, '0'), 2, dpcorpop.t_ValueDate ), fiwarnts.t_IncomeFI, dpcorpop.t_Currency, dpcorpop.t_ValueDate) as t_D2, " +
                  "               dpcorpop.t_Currency as t_TaxCurr, " +
                  "               0 as t_PayerID " +
                  "        from ddpcorpop_dbt dpcorpop," +
                  "             ddppmacc_dbt dppmacc," +
                  "             ddpregstr_dbt dpregstr," +
                  "             ddpreglin_dbt dpreglin," +
                  "             dparty_dbt party, " +
                  "             dparty_dbt issuer, " +
                  "             dfininstr_dbt fin, " +
                  "             dfiwarnts_dbt fiwarnts " +
                  "        where dpcorpop.t_ValueDate between " + GetSQLDate(Oper.rec.BegRecalcDate) + " and " + GetSQLDate(Oper.rec.EndRecalcDate)  +
                  "          and dpcorpop.t_PaymentType = " + string(DP_CRPPAYMENTTYPE_DIVIDENDS) +
                  "          and dpcorpop.t_State = 3 " +
                  "          and dppmacc.t_HolderID = " + string(Oper.rec.Client) +
                  "          and party.t_PartyID = dppmacc.t_HolderID " +
                  "          and party.t_LegalForm = 2 " +
                  "          and RSI_NPTX.ResidenceStatus(party.t_PartyID, dpcorpop.t_ValueDate) = 1 " +
                  "          and dppmacc.t_DocumentID = dpcorpop.t_DocumentID " +
                  "          and dpregstr.t_DocumentID = dpcorpop.t_DocumentID " +
                  "          and dpreglin.t_RegisterID = dpregstr.t_RegisterID " +
                  "          and dpreglin.t_HolderAccID = dppmacc.t_HolderAccID " +
                  "          and dpreglin.t_Type = 60 " +
                  "          and dpreglin.t_FIIDFrom = " + IIF(Oper.rec.FIID > 0, string(Oper.rec.FIID), "dpreglin.t_FIIDFrom") +
                  "          and fin.t_FIID = dpreglin.t_FIIDFrom " +
                  "          and issuer.t_PartyID = fin.t_Issuer " +
                  "          and ( " +
                  "                 issuer.t_NotResident <> chr(88) " +
                  "                 or RSI_NPTO.GetPaperTaxGroupNPTX( dpreglin.t_FIIDFrom,   -1 ) = '40' " +
                  "              ) " +
                  "          and fiwarnts.t_FIID = fin.t_FIID " +
                  "          and fiwarnts.t_Number = dpcorpop.t_WarrantNum " +
                  "        union all " +
                  "        select dl_leg.t_Cost as t_BruttoAmount, " +
                  "               dl_tick.t_CurDeal as t_CorpopCurrency, " +
                  "               dl_tick.t_FactReceiverID as t_HolderID, " +
                  "               dl_leg.t_PFI as t_FIID, " +
                  "               0 as t_HolderAccID, " +
                  "               dl_tick.t_DealID as t_DocumentID, " +
                  "               dl_tick.t_DealDate as t_ValueDate, " +
                  "               dl_leg.t_D1, " +
                  "               dl_leg.t_D2, " +
                  "               dl_tick.t_CurGet as t_TaxCurr, " +
                  "               dl_tick.t_ClientID as t_PayerID " +
                  "        from ddl_tick_dbt dl_tick, " +
                  "             ddl_leg_dbt dl_leg, " +
                  "             dparty_dbt party " +
                  "        where dl_tick.t_DealDate between " + GetSQLDate(Oper.rec.BegRecalcDate) + " and " + GetSQLDate(Oper.rec.EndRecalcDate) +
                  "          and dl_tick.t_BOfficeKind = " + string(DL_RETURN_DIVIDEND) +
                  "          and dl_tick.t_DealType = 2108 " +
                  "          and dl_tick.t_DealStatus = 20 " +
                  "          and dl_tick.t_FactReceiverID = " + string(Oper.rec.Client) +
                  "          and dl_leg.t_DealID = dl_tick.t_DealID " +
                  "          and dl_leg.t_LegID = 0 " +
                  "          and dl_leg.t_LegKind = 0 " +
                  "          and dl_leg.t_PFI = " + IIF(Oper.rec.FIID > 0, string(Oper.rec.FIID), "dl_leg.t_PFI") +
                  "          and party.t_PartyID = dl_tick.t_FactReceiverID " +
                  "          and party.t_LegalForm = 2 " +
                  "          and RSI_NPTX.ResidenceStatus(party.t_PartyID, dl_tick.t_DealDate) = 1 " +
                  "     ) q " +
                  "order by q.t_ValueDate";

   var DivCmd = DL_RSDCommand(DivQuery);

   var Count = DivCmd.GetCount();
   InitProgress(DivCmd.GetCount(), "Пересчет НОБ по дивидендам", "Пересчет НОБ по дивидендам");
   var DivDS = DivCmd.Execute();
   while(DivDS.MoveNext())
      var TaxAmountRecCmd = RSDCommand("BEGIN RSB_DEPO.CalcDivTaxAmount2021(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); END;");
      TaxAmountRecCmd.AddParam("p_BruttoAmount", RSDBP_IN);
      TaxAmountRecCmd.Value("p_BruttoAmount") = DivDS.BruttoAmount;
      TaxAmountRecCmd.AddParam("p_CorpopCurrency", RSDBP_IN);
      TaxAmountRecCmd.Value("p_CorpopCurrency") = DivDS.CorpopCurrency;
      TaxAmountRecCmd.AddParam("p_HolderID", RSDBP_IN);
      TaxAmountRecCmd.Value("p_HolderID") = DivDS.HolderID;
      TaxAmountRecCmd.AddParam("p_FIID", RSDBP_IN);
      TaxAmountRecCmd.Value("p_FIID") = DivDS.FIID;
      TaxAmountRecCmd.AddParam("p_HolderAccID", RSDBP_IN);
      TaxAmountRecCmd.Value("p_HolderAccID") = DivDS.HolderAccID;
      TaxAmountRecCmd.AddParam("p_DocumentID", RSDBP_IN);
      TaxAmountRecCmd.Value("p_DocumentID") = DivDS.DocumentID;
      TaxAmountRecCmd.AddParam("p_ValueDate", RSDBP_IN);
      TaxAmountRecCmd.Value("p_ValueDate") = Date(DivDS.ValueDate);
      TaxAmountRecCmd.AddParam("p_D1", RSDBP_IN);
      TaxAmountRecCmd.Value("p_D1") = DivDS.D1;
      TaxAmountRecCmd.AddParam("p_D2", RSDBP_IN);
      TaxAmountRecCmd.Value("p_D2") = DivDS.D2;
      TaxAmountRecCmd.AddParam("p_TaxCurr", RSDBP_IN, DivDS.TaxCurr);
      TaxAmountRecCmd.AddParam("p_TaxAmount", RSDBP_OUT, V_MONEY);
      TaxAmountRecCmd.AddParam("p_TaxAmount_15", RSDBP_OUT, V_MONEY);
      TaxAmountRecCmd.AddParam("p_ParmStr", RSDBP_OUT, V_STRING, 512);

      TaxAmountRecCmd.execute();
      TaxAmountRec = Money(TaxAmountRecCmd.Value("p_TaxAmount"));
      TaxAmountRec15 = Money(TaxAmountRecCmd.Value("p_TaxAmount_15"));
      ParmStr = string(TaxAmountRecCmd.Value("p_ParmStr"));

      var  TaxGroup = 0; //GetTaxGroupNUTX(tick.PFI, tick.dealDate);
      var cmd  = DL_RSDCommand("select npto.GetPaperTaxGroupNPTX( ? ) TaxGroup from dual");
      cmd.addParam(DivDS.FIID);
      var rs = cmd.execute();
      if ( rs.MoveNext() )
          TaxGroup = rs.TaxGroup;
      end;

      // Определение обращаемости бумаги
      var  securIsCirc = 2; // Не обращается
      cmd = DL_RSDCommand("select NPTO.IfMarket(?, ?) ifMarket from dual;");
      cmd.addParam(DivDS.FIID);
      cmd.addParam(DivDS.ValueDate);
      rs = cmd.execute();
      if ( rs.MoveNext() and (rs.ifMarket == "X") )
          securIsCirc = 1; // в обращении
      end;

      if(DivDS.HolderAccID == 0)
         var TaxAmountPayCmd = RSDCommand("BEGIN RSB_SECUR.CalcPayerTaxDivRet(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); END;");
         TaxAmountPayCmd.AddParam("p_PartyID", RSDBP_IN);
         TaxAmountPayCmd.Value("p_PartyID") = DivDS.PayerID;
         TaxAmountPayCmd.AddParam("p_FIID", RSDBP_IN);
         TaxAmountPayCmd.Value("p_FIID") = DivDS.FIID;
         TaxAmountPayCmd.AddParam("p_ValueDate", RSDBP_IN);
         TaxAmountPayCmd.Value("p_ValueDate") = Date(DivDS.ValueDate);
         TaxAmountPayCmd.AddParam("p_BruttoAmount", RSDBP_IN);
         TaxAmountPayCmd.Value("p_BruttoAmount") = DivDS.BruttoAmount;
         TaxAmountPayCmd.AddParam("p_CorpopCurrency", RSDBP_IN);
         TaxAmountPayCmd.Value("p_CorpopCurrency") = DivDS.CorpopCurrency;
         TaxAmountPayCmd.AddParam("p_RatePay", RSDBP_IN);
         TaxAmountPayCmd.Value("p_RatePay") = 0;
         TaxAmountPayCmd.AddParam("p_D1", RSDBP_IN);
         TaxAmountPayCmd.Value("p_D1") = DivDS.D1;
         TaxAmountPayCmd.AddParam("p_D2", RSDBP_IN);
         TaxAmountPayCmd.Value("p_D2") = DivDS.D2;
         TaxAmountPayCmd.AddParam("p_TaxCurr", RSDBP_IN);
         TaxAmountPayCmd.Value("p_TaxCurr") = DivDS.TaxCurr;
         TaxAmountPayCmd.AddParam("p_Tax", RSDBP_OUT, V_MONEY);
         TaxAmountPayCmd.AddParam("p_IncrTax", RSDBP_OUT, V_MONEY);

         TaxAmountPayCmd.execute();
         TaxAmountPay = Money(TaxAmountPayCmd.Value("p_Tax"));
         TaxAmountPay15 = Money(TaxAmountPayCmd.Value("p_IncrTax"));

         if((TaxAmountPay != 0) or (TaxAmountPay15 != 0) or (TaxAmountRec != 0) or (TaxAmountRec15 != 0))
            /*var PrmQuery = "select t_ID, " +
                           "       t_ParmStr, " +
                           "       t_TaxPay, " +
                           "       t_TaxPayIncr, " +
                           "       t_TaxGet, " +
                           "       t_TaxGetIncr " +
                           "from dnptxprm_dbt " +
                           "where t_DocKind = " + string(DL_RETURN_DIVIDEND) +
                           "  and t_DocID = " + string(DivDS.DocumentID);
   
            var PrmCmd = DL_RSDCommand(PrmQuery);
            var PrmDS = PrmCmd.Execute();
            if(PrmDS.MoveNext())
               if((PrmDS.ParmStr != ParmStr) or (PrmDS.TaxPay != TaxAmountPay) or (PrmDS.TaxPayIncr != TaxAmountPay15) or (PrmDS.TaxGet != TaxAmountRec) or (PrmDS.TaxGetIncr != TaxAmountRec15))
                  var UpdateNPTXPrmQuery = "update dnptxprm_dbt set " +
                                           "   t_ParmStr = " + ParmStr + ", " +
                                           "   t_TaxPay = " + string(TaxAmountPay) + ", " +
                                           "   t_TaxPayIncr = " + string(TaxAmountPay) + ", " +
                                           "   t_TaxGet = " + string(TaxAmountRec) + ", " +
                                           "   t_TaxGetIncr = " + string(TaxAmountRec15) +
                                           " where t_ID = " + string(PrmDS.ID);
   
                  var UpdateNPTXPrmCmd = RSDCommand(UpdateNptxPrmQuery);
                  UpdateNptxPrmCmd.execute();
               end;
            else
               var InsertNPTXPrmQuery = "insert into dnptxprm_dbt values(" +
                                                                           string(DL_RETURN_DIVIDEND) + ", " +
                                                                           string(DivDS.DocumentID) + ", " +
                                                                           "'" + ParmStr + "', " +
                                                                           string(TaxAmountPay) + ", " +
                                                                           string(TaxAmountPay15) + ", " +
                                                                           string(TaxAmountRec) + ", " +
                                                                           string(TaxAmountRec15) +
                                                                       ")";

               var InsertNPTXPrmCmd = RSDCommand(InsertNPTXPrmQuery);
               InsertNPTXPrmCmd.execute();
            end;*/

            var TickQuery = "select * " +
                            "from ddl_tick_dbt " +
                            "where t_DealID = " + string(Int(DivDS.DocumentID));
   
            var TickCmd = DL_RSDCommand(TickQuery);
            var TickDS = TickCmd.Execute();
            if(TickDS.MoveNext())
               TickDS.GetRecord().CopyTo(TickRec.rec);
   
               var LegQuery = "select * " +
                              "from ddl_leg_dbt " +
                              "where t_DealID = " + string(TickRec.rec.DealID) +
                              "  and t_LegID = 0 " +
                              "  and t_LegKind = 0 ";
   
               var LegCmd = DL_RSDCommand(LegQuery);
               var LegDS = LegCmd.Execute();
               if(LegDS.MoveNext())
                  LegDS.GetRecord().CopyTo(LegRec.rec);
                  CreateRecalcDivRetTaxObjects(TickRec, LegRec, TaxAmountRec, TaxAmountRec15, TaxAmountPay, TaxAmountPay15, ID_Operation, ID_Step, securIsCirc, TaxGroup);
               end;
            end;
         end;

         AnaliticKind1 = TXOBJ_KIND1100;
      else
         AnaliticKind1 = TXOBJ_KIND1098;
         KindContr = TXOBJ_KIND6020;

         var BenefContrIDQuery = "select sfcontr.t_ID " +
                                 "from dsfcontr_dbt sfcontr, ddepoacnt_dbt depoacnt " +
                                 "where depoacnt.t_AutoKey = " + string(DivDS.HolderAccID) +
                                 "  and sfcontr.t_ObjectType = " + string(SF_DEPOACC) +
                                 "  and sfcontr.t_ServKind = " + string(PTSK_DEPOS) +
                                 "  and sfcontr.t_Object = depoacnt.t_Code " +
                                 "  and sfcontr.t_PartyID = depoacnt.t_Owner";

         var BenefContrIDCmd = DL_RSDCommand(BenefContrIDQuery);
         var BenefContrIDDS = BenefContrIDCmd.Execute();
         if(BenefContrIDDS.MoveNext())
            BenefContrID = BenefContrIDDS.ID;
         end;
      end;

      CreateRecalcDivTaxObjCarrySum(ID_Operation, ID_Step, ParmStr, DivDS.ValueDate, DivDS.HolderID, DivDS.BruttoAmount, DivDS.FIID, AnaliticKind1, DivDS.DocumentID, securIsCirc,
                                            TaxGroup, KindContr, BenefContrID, DivDS.D1, DivDS.D2, securIsCirc, TaxGroup);

      if((Num == Count - 1) or (DivDS.HolderAccID > 0))
         CreateTransferRecalcTaxObjects(ParmStr, DivDS.HolderID, DivDS.ValueDate, ID_Operation, ID_Step, AnaliticKind1, DivDS.DocumentID, DivDS.FIID, securIsCirc, TaxGroup, KindContr, BenefContrID);
      end;

      UseProgress(Num = Num + 1);
   end;

   TaxObj.Save();
   RemProgress();

   return 0;
END;

macro GetP(ClientID, IIS:integer, NpTxKindsStr:string, BegDate, EndDate, AddWhereCond)
  var _P = $0;

  _P = GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_CALCNDFL, null, IIS, AddWhereCond) + //созданные в операциях расчета НОБ
       GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, 0 /*только пользовательские*/,null, IIS, AddWhereCond) +
       GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_HOLDNDFL, null, IIS, AddWhereCond) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
       GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_WRTMONEY, null, IIS, AddWhereCond) + //созданные в операциях списания/зачисления денежных средств
       GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_RETIREMENT_OWN, null, IIS, AddWhereCond) + //созданные в операциях погашения ОЭБ
       GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_NPTXSTBOP, null, IIS, AddWhereCond) + //созданные в операциях корректировки события СНОБ
       GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_NPTXNETTOP, null, IIS, AddWhereCond) + //созданные в операциях зачета СНОБ
       GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_NPTXCRNSET, null, IIS, AddWhereCond) + //созданные в операциях компенсации
       /*плюс операции в ПС <Векселя банка>*/
       GetRubSumByClientFromVeksel(ClientID, string(NpTxKindsStr), BegDate, EndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                              string(DL_VSBARTERORDER)  +", "+ //мена
                                                                              string(DL_VSINTERCHANGE) );      //зачет взаимных требований


  if(pIIS == 0)
    _P = _P + GetRubSumByClientFromDepo(ClientID, string(NpTxKindsStr), BegDate, EndDate); //созданные в операции "Расчет и начисление дохода" в депозитарии
  end;

  return _P;
end;

MACRO CalcSTBTaxeByNOBOper(nptxop, IIS:bool, BegDate, EndDate, TaxBaseKind, СНОБ, НОБ_опер, НОБ_30:@money, НОБ_13:@money, НОБ_15:@money, taxe:@money, taxe15:@money, OnlyByOper:bool, calcTaxe:@money, calcTaxe15:@money)
  var Oper = TRecHandler("nptxop.dbt");
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var ClientResident = false;
  var vIIS = IIF(IIS==true, 1, 0);
  var Year = 0;

  if(OnlyByOper == NULL)
    OnlyByOper = false;
  end;

  Copy(Oper, nptxop);
  
  datesplit(EndDate, NULL, NULL, Year);

  if( DL_GetPartyResident(Oper.rec.Client) == NPTXPARTY_RESIDENT )
    ClientResident = true;
  end;
  
  if(ClientResident == false)
    НОБ_30 = НОБ_опер;
  else
    if(НОБ_опер > 0)
      НОБ_13 = MAX(0, MIN((СНОБ + НОБ_опер), NPTX_LIMINCOME_MAX15) - СНОБ);
      НОБ_15 = НОБ_опер - НОБ_13;
    elif(НОБ_опер < 0)
      var Сумма_НОБ = STB_GetSumTaxBaseCurrPay(Oper.rec.Client, TaxBaseKind, IIF(IIS, NULL, Year), int(NPTXGENTAXRATE_RESIDENT_15*100));
      НОБ_15 = -MIN(ABS(НОБ_опер), Сумма_НОБ);
      НОБ_13 = НОБ_опер - НОБ_15;
    end;
  end;

  if(IIS)
    if(ClientResident == false)
      taxe   = NPTXGENTAXRATE_NOTRESIDENT * (IIF(OnlyByOper, $0, STB_GetSumTaxBaseCurrPay(Oper.rec.Client, NPTXTOTALBASE_TAXBASEKIND_IIS, NULL, int(NPTXGENTAXRATE_NOTRESIDENT*100))) + НОБ_30) 
               - IIF(OnlyByOper, $0, GetP(Oper.rec.Client, vIIS, TXOBJ_PAIDGENERAL_IIS, BegDate, EndDate, AddWhereNotOut));
      taxe15 = NPTXGENTAXRATE_RESIDENT_15 * (IIF(OnlyByOper, $0, STB_GetSumTaxBaseCurrPay(Oper.rec.Client, NPTXTOTALBASE_TAXBASEKIND_IIS, NULL, int(NPTXGENTAXRATE_RESIDENT_15*100))) + НОБ_15) 
               - IIF(OnlyByOper, $0, GetP(Oper.rec.Client, vIIS, TXOBJ_PAIDGENERAL_15_IIS, BegDate, EndDate, AddWhereNotOut));
    else
      taxe   = NPTXGENTAXRATE_RESIDENT * (IIF(OnlyByOper, $0, STB_GetSumTaxBaseCurrPay(Oper.rec.Client, NPTXTOTALBASE_TAXBASEKIND_IIS, NULL, int(NPTXGENTAXRATE_RESIDENT*100))) + НОБ_13) 
               - IIF(OnlyByOper, $0, GetP(Oper.rec.Client, vIIS, TXOBJ_PAIDGENERAL_IIS, BegDate, EndDate, AddWhereNotOut));
      taxe15 = NPTXGENTAXRATE_RESIDENT_15 * (IIF(OnlyByOper, $0, STB_GetSumTaxBaseCurrPay(Oper.rec.Client, NPTXTOTALBASE_TAXBASEKIND_IIS, NULL, int(NPTXGENTAXRATE_RESIDENT_15*100))) + НОБ_15) 
               - IIF(OnlyByOper, $0, GetP(Oper.rec.Client, vIIS, TXOBJ_PAIDGENERAL_15_IIS, BegDate, EndDate, AddWhereNotOut));
    end;
  else
    var FindTaxBaseKind;
    var FindPaidKind;   
    var FindPaidKind_15;

    if(РАБОТА_В_РЕЖИМЕ_СНОБ() == true)
      FindTaxBaseKind = string(NPTXTOTALBASE_TAXBASEKIND_BROK);
      FindPaidKind    = TXOBJ_PAIDGENERAL;
      FindPaidKind_15 = TXOBJ_PAIDGENERAL_15_2;
    else
      FindTaxBaseKind = TaxBaseKind;
      if(FindTaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        FindPaidKind    = TXOBJ_PAIDBILL+","+TXOBJ_PAIDCOMP;
        FindPaidKind_15 = TXOBJ_PAIDGENERAL_15_9+","+TXOBJ_PAIDCOMP_15;
      else
        FindPaidKind    = TXOBJ_PAIDGENERAL;     
        FindPaidKind_15 = TXOBJ_PAIDGENERAL_15_2;
      end;
    end;

    if(ClientResident == false)
      taxe   = NPTXGENTAXRATE_NOTRESIDENT * (  IIF(OnlyByOper, $0, STB_GetSumTaxBaseCurrPay(Oper.rec.Client, FindTaxBaseKind, Year, int(NPTXGENTAXRATE_NOTRESIDENT*100))) 
                                             + НОБ_опер) - IIF(OnlyByOper, $0, GetP(Oper.rec.Client, vIIS, FindPaidKind, BegDate, EndDate, AddWhereNotOut));
    else
      taxe   = NPTXGENTAXRATE_RESIDENT * (  IIF(OnlyByOper, $0, STB_GetSumTaxBaseCurrPay(Oper.rec.Client, FindTaxBaseKind, Year, int(NPTXGENTAXRATE_RESIDENT*100))) 
                                          + НОБ_13) - IIF(OnlyByOper, $0, GetP(Oper.rec.Client, vIIS, FindPaidKind, BegDate, EndDate, AddWhereNotOut));
      taxe15 = NPTXGENTAXRATE_RESIDENT_15 * (  IIF(OnlyByOper, $0, STB_GetSumTaxBaseCurrPay(Oper.rec.Client, FindTaxBaseKind, Year, int(NPTXGENTAXRATE_RESIDENT_15*100))) 
                                             + НОБ_15) - IIF(OnlyByOper, $0, GetP(Oper.rec.Client, vIIS, FindPaidKind_15, BegDate, EndDate, AddWhereNotOut));
    end;
  end;

  calcTaxe = taxe;
  calcTaxe15 = taxe15;

  taxe   = round(taxe, 0);
  taxe15 = round(taxe15, 0);
END;

MACRO GetSpecialTagByOper(nptxop, TaxBaseKind, DocKind)
  var Oper = TRecHandler("nptxop.dbt");
  var SpecTag = "";
  
  Copy(Oper, nptxop);

  if(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
    if((DocKind == DL_VEKSELDRAWORDER) or (DocKind == DL_VSBARTERORDER) or (DocKind == DL_VSINTERCHANGE))
      SpecTag = "ВЕКС";
    elif((Oper.rec.DocKind == DL_HOLDNDFL) and (Oper.rec.SubKind_Operation == DL_TXHOLD_OPTYPE_LUCRE))
       SpecTag = "МАТ";
    elif((Oper.rec.DocKind == DL_HOLDNDFL) and (Oper.rec.SubKind_Operation == DL_TXHOLD_OPTYPE_OUTMONEY))
      SpecTag = "БРОК";
    elif(Oper.rec.DocKind == DL_WRTMONEY)
      SpecTag = "БРОК";
    elif((Oper.rec.DocKind == DL_CALCNDFL) and (Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_LUCRE))
      SpecTag = "МАТ";
    elif((Oper.rec.DocKind == DL_CALCNDFL) and ((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_NORMAL) or (Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_ENDYEAR)))
      SpecTag = "БРОК";
    end;
  end;

  return SpecTag;
END;

//Рассчитать НОБ по операции. Например, для проверки необходимости запроса СНОБ
MACRO CalcNOBoper(nptxop, НОБ_опер:@money, СУММ_выч_Диас, TaxBaseKind, SpecialTag:@string, BeforeDate)
  var Oper = TRecHandler("nptxop.dbt");
  var Year = 0;
  var НОБ_тек = $0;
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var AddWhereTotalBase = " 1 = 1 ";
  var TaxTeriodToLucre;

  НОБ_опер = $0;

  if(СУММ_выч_Диас == NULL)
    СУММ_выч_Диас = $0;
  end;

  Copy(Oper, nptxop);

  ОпределитьПараметрыРасчета(Oper);
  GetBegDate(Oper, true);

  if(TaxBaseKind == NULL)
    TaxBaseKind = IIF(pIIS, NPTXTOTALBASE_TAXBASEKIND_IIS, NPTXTOTALBASE_TAXBASEKIND_BROK);
  end;

  SpecialTag = GetSpecialTagByOper(Oper, TaxBaseKind);

  DateSplit(IIF(Oper.rec.DocKind != DL_HOLDNDFL, Oper.rec.OperDate, Oper.rec.PrevDate), null, null, Year);
  pBeg = IIF(Oper.rec.DocKind == DL_HOLDNDFL, Oper.rec.PrevDate, IIF(pIIS, GetFirstDateIIS(Oper.rec.Client, GetDlCOntrIDByNPTXOP(Oper)), date(1, 1, Year)));

  TaxTeriodToLucre = CheckTaxTeriodToLucre(Year);

  if((Oper.rec.DocKind == DL_CALCNDFL) and (Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_LUCRE) and (TaxTeriodToLucre == true))
    AddWhereNotOut = AddWhereNotOut + " and (obj.t_Technical IS NULL or obj.t_Technical = CHR(0)) ";
  end;

  if(pIIS)
    if(Year >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981())
      AddWhereNotOut = AddWhereNotOut + " and t_analitic6 = " + TXOBJ_KIND6020 + " and t_Analitic6 = " + GetDlCOntrIDByNPTXOP(Oper) + " ";
    end;
    if(IsPartyResident())
      НОБ_тек = GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEG5), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
    else
      НОБ_тек = GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEGENERAL_IIS), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
    end;
  elif(IsPartyResident())
    if(СУММ_выч_Диас > 0)
      НОБ_тек = STB_GetSavedNptxval(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_CALCBG2);
    else

      НОБ_тек = GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEG2), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
    end;

    НОБ_тек =   НОБ_тек + GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEG3), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
    if(TaxTeriodToLucre)
         НОБ_тек = НОБ_тек + GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEMATERIAL), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
    end;
  else
    НОБ_тек =  GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEGENERAL), pBeg, pEnd, null, pIIS, null, AddWhereNotOut)
             + GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEMATERIAL), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
  end;

  if((TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS) and (Year >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981()))
    AddWhereTotalBase = " t_DlContrID = " +  GetDlCOntrIDByNPTXOP(Oper) + " ";
  end;

  НОБ_опер = НОБ_тек - STB_GetSumTaxBaseCurrPay(Oper.rec.Client, TaxBaseKind, IIF(pIIS, NULL, Year), NULL, NULL, BeforeDate, NULL, AddWhereTotalBase);
END;


//Рассчитать суммы налога по операции nptxop (расчет НОБ, списание д/с)
MACRO CalcTaxSTB(nptxop, НОБ_опер:@money, НОБ_30:@money, НОБ_13:@money, НОБ_15:@money, taxe:@money, taxe15:@money, TOut:money, AmountSNOB, calcTaxe:@money, calcTaxe15:@money, СУММ_выч_Диас:money)
  var Oper = TRecHandler("nptxop.dbt");
  var Year = 0;
  var СНОБ = $0, STBDate = date(0,0,0), STBTime = time(0);
  var НОБ_тек = $0;
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var TaxBaseKind;
  var NeedCalcTaxe = true;

  if((taxe == NULL) and (taxe15 == NULL))
    NeedCalcTaxe = false;
  end;

  if(СУММ_выч_Диас == NULL)
    СУММ_выч_Диас = $0;
  end;

  НОБ_опер = $0; 
  НОБ_30   = $0; 
  НОБ_13   = $0; 
  НОБ_15   = $0;
  taxe     = $0; 
  taxe15   = $0;

  Copy(Oper, nptxop);

  ОпределитьПараметрыРасчета(Oper);
  GetBegDate(Oper, true);

  DateSplit(IIF(Oper.rec.DocKind != DL_HOLDNDFL, Oper.rec.OperDate, Oper.rec.PrevDate), null, null, Year);
  pBeg = IIF(Oper.rec.DocKind == DL_HOLDNDFL, Oper.rec.PrevDate, IIF(pIIS, GetFirstDateIIS(Oper.rec.Client, GetDlCOntrIDByNPTXOP(Oper)), date(1, 1, Year)));

  TaxBaseKind = IIF(pIIS, NPTXTOTALBASE_TAXBASEKIND_IIS, NPTXTOTALBASE_TAXBASEKIND_BROK);

  CalcNOBoper(nptxop, @НОБ_опер, СУММ_выч_Диас);

  if(NeedCalcTaxe == true)

    if(AmountSNOB != NULL)
      СНОБ = AmountSNOB;
    else
      GetLastOpSTBVal(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_STB, @СНОБ, @STBDate, @STBTime);
    end;

    CalcSTBTaxeByNOBOper(Oper, pIIS, pBeg, pEnd, TaxBaseKind, СНОБ, НОБ_опер, @НОБ_30, @НОБ_13, @НОБ_15, @taxe, @taxe15, false, @calcTaxe, @calcTaxe15);

    if((TOut != NULL) and (TOut != 0))
      if(Oper.rec.CloseContr == SET_CHAR)
        if(TOut < (taxe + taxe15))
          if(taxe15 > 0)
            taxe15 = min(taxe15, max(0, TOut-taxe));
          end;
          if(taxe > 0)
            taxe = min(taxe, TOut-taxe15);
          end;
        end;
      end;
    end;

    taxe   = MAX(taxe, $0);  
    taxe15 = MAX(taxe15, $0);
  end;

END;

private macro ExistDepoNptxObj(Oper, ObjKind:integer)
  var query, cmd, DataSet;
  var BegDate, EndDate, Year;

  return true;

  datesplit(Oper.rec.OperDate, null, null, Year);

  BegDate = date(1,1,Year);
  EndDate = date(31,12,Year);

  query =   " select 1 "
          + "   from dnptxobj_dbt "
          + "  where t_Client = ? "
          + "    and t_Date between ? and ? "
          + "    and t_Kind = ? "    
          + "    and t_FromOutSyst = 'X' "
          + "    and t_OutSystCode in ('DEPO','ДЕПО') "
          + "    and t_ChangeCode = 'X'";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(Oper.rec.Client);
  cmd.AddParam(BegDate);
  cmd.AddParam(EndDate);
  cmd.AddParam(ObjKind);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    return true;
  end;

  return false;
end;

private macro GetSumDeduction(ClientID, Year, ObjKind:integer)
  var query, cmd, DataSet;
  var BegDate, EndDate;
  var SumDeduction = $0;

  BegDate = date(1,1,Year);
  EndDate = date(31,12,Year);

  query =   " select NVL(SUM(t_Sum0),0) as SumDeduction "
          + "   from dnptxobj_dbt "
          + "  where t_Client = ? "
          + "    and t_Date between ? and ? "
          + "    and t_Kind = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(BegDate);
  cmd.AddParam(EndDate);
  cmd.AddParam(ObjKind);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    SumDeduction = money(DataSet.SumDeduction);
  end;

  return SumDeduction;
end;

private macro GetSumSOFRObj(ClientID, Year, ObjKind:integer)
  var query, cmd, DataSet;
  var BegDate, EndDate;
  var SumSOFRObj = $0;

  BegDate = date(1,1,Year);
  EndDate = date(31,12,Year);

  query =   " select NVL(SUM(t_Sum0),0) as SumSOFRObj "
          + "   from dnptxobj_dbt "
          + "  where t_Client = ? "
          + "    and t_Date between ? and ? "
          + "    and t_Kind = ? "
          + "    and (t_FromOutSyst = CHR(0) or t_FromOutSyst IS NULL) "
          + "    and (t_OutSystCode = CHR(1) or t_OutSystCode IS NULL) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(BegDate);
  cmd.AddParam(EndDate);
  cmd.AddParam(ObjKind);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    SumSOFRObj = money(DataSet.SumSOFRObj);
  end;

  return SumSOFRObj;
end;

private macro GetSumCoup(ClientID, Year, ObjKind:integer)
  var query, cmd, DataSet;
  var BegDate, EndDate;
  var SumCoup = $0;

  BegDate = date(1,1,Year);
  EndDate = date(31,12,Year);

  query =   " select NVL(SUM(t_Sum0),0) as SumSOFRObj "
          + "   from dnptxobj_dbt "
          + "  where t_Client = ? "
          + "    and t_Date between ? and ? "
          + "    and t_Kind = ? "
          + "    and (t_FromOutSyst = CHR(0) or t_FromOutSyst IS NULL) "
          + "    and t_OutSystCode in ('DEPO','ДЕПО') "
          + "    and t_ChangeCode = 'X'";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(BegDate);
  cmd.AddParam(EndDate);
  cmd.AddParam(ObjKind);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    SumCoup = money(DataSet.SumSOFRObj);
  end;

  return SumCoup;
end; 

macro Рассчитать_НОБ_обр_ЦБ(ClientID, Year)
  var НОБ_обр_ЦБ, SUM_1530, Coup_1530_SOFR, SUM_Deduction_201;

  SUM_Deduction_201 =  GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_201) 
                     + GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_618) 
                     + GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_222)
                     + GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_218)
                     + GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_208);

  SUM_1530 = GetSumSOFRObj(ClientID, Year, TXOBJ_PLUSG_1530);

  Coup_1530_SOFR = GetSumCoup(ClientID, Year, TXOBJ_PLUSG_1530);

  НОБ_обр_ЦБ = (SUM_1530 + Coup_1530_SOFR) - SUM_Deduction_201;

  return НОБ_обр_ЦБ;
end;

macro Рассчитать_НОБ_необр_ЦБ(ClientID, Year)
  var НОБ_необр_ЦБ, SUM_1531, Coup_1531_SOFR, SUM_Deduction_202;

  SUM_Deduction_202 =  GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_202) 
                     + GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_223) 
                     + GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_219);

  SUM_1531 = GetSumSOFRObj(ClientID, Year, TXOBJ_PLUSG_1531);

  Coup_1531_SOFR = GetSumCoup(ClientID, Year, TXOBJ_PLUSG_1531);

  НОБ_необр_ЦБ = (SUM_1531 + Coup_1531_SOFR) - SUM_Deduction_202;

  return НОБ_необр_ЦБ;
end;

macro Рассчитать_НОБ_потеря_ЦБ(ClientID, Year)
  var НОБ_потеря_ЦБ, SUM_1536, Coup_1536_SOFR, SUM_Deduction_203;

  SUM_Deduction_203 =  GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_203) 
                     + GetSumDeduction(ClientID, Year, TXOBJ_MINUSG_224); 

  SUM_1536 = GetSumSOFRObj(ClientID, Year, TXOBJ_PLUSG_1536);

  Coup_1536_SOFR = GetSumCoup(ClientID, Year, TXOBJ_PLUSG_1536);

  НОБ_потеря_ЦБ = (SUM_1536 + Coup_1536_SOFR) - SUM_Deduction_203;

  return НОБ_потеря_ЦБ;
end;

private macro Set207KBKInNptxObj(ObjID:integer, DocID:integer, ID_Step:integer)
  var query, ins;

  query =   " INSERT INTO DNPTXOBJ_TMP(T_ID, "
          + "                          T_DATE, "         
          + "                          T_CLIENT, "       
          + "                          T_DIRECTION , "   
          + "                          T_LEVEL, "        
          + "                          T_KIND, "         
          + "                          T_SUM, "          
          + "                          T_CUR, "          
          + "                          T_ANALITICKIND1, "
          + "                          T_ANALITIC1, "    
          + "                          T_ANALITICKIND2, "
          + "                          T_ANALITIC2, "    
          + "                          T_ANALITICKIND3, "
          + "                          T_ANALITIC3, "    
          + "                          T_ANALITICKIND4, "
          + "                          T_ANALITIC4, "    
          + "                          T_ANALITICKIND5, "
          + "                          T_ANALITIC5, "    
          + "                          T_ANALITICKIND6, "
          + "                          T_ANALITIC6, "    
          + "                          T_COMMENT, "
          + "                          T_DOCID, "
          + "                          T_STEP, "   
          + "                          T_FROMOUTSYST, "  
          + "                          T_OUTSYSTCODE, "  
          + "                          T_OUTOBJID, "     
          + "                          T_SOURCEOBJID, "  
          + "                          T_TECHNICAL, "    
          + "                          T_TAXPERIOD, "
          + "                          T_REALOBJID, "
          + "                          T_ACTION "
          + "                         ) "
          + " SELECT 0, "    
          + "        T_DATE, "         
          + "        T_CLIENT, "       
          + "        T_DIRECTION , "   
          + "        T_LEVEL, "        
          + "        T_KIND, "         
          + "        T_SUM, "          
          + "        T_CUR, "          
          + "        T_ANALITICKIND1, "
          + "        T_ANALITIC1, "    
          + "        "+TXOBJ_KIND2040+"," //T_ANALITICKIND2, 
          + "        207, "           //T_ANALITIC2,     
          + "        T_ANALITICKIND3, "
          + "        T_ANALITIC3, "    
          + "        T_ANALITICKIND4, "
          + "        T_ANALITIC4, "    
          + "        T_ANALITICKIND5, "
          + "        T_ANALITIC5, "    
          + "        T_ANALITICKIND6, "
          + "        T_ANALITIC6, "    
          + "        T_COMMENT, "
          + "        ?, "
          + "        ?, "     
          + "        T_FROMOUTSYST, "  
          + "        T_OUTSYSTCODE, "  
          + "        T_OUTOBJID, "     
          + "        T_SOURCEOBJID, "  
          + "        T_TECHNICAL, "    
          + "        T_TAXPERIOD, "
          + "        T_OBJID, "
          + "        1 " //T_ACTION = NPTXBC_ACTION_UPDATE   
          + "  FROM dnptxobj_dbt "
          + " WHERE t_ObjID = ? ";

  ins = DL_RSDCommand(query);

  ins.AddParam(DocID);
  ins.AddParam(ID_Step);
  ins.AddParam(ObjID);

  ins.ExecuteCMD();
                                    
end;

private class TSumData(_ID:integer, _ДатаПолучДох:date, _ВремяПолучДох:time, _СУММ_выч_зап:money, _Ставка:integer, _КБК:string)
  var ID = _ID;
  var ДатаПолучДох = _ДатаПолучДох;
  var ВремяПолучДох = _ВремяПолучДох;
  var СУММ_выч_зап = _СУММ_выч_зап;
  var Ставка = _Ставка;
  var КБК = _КБК;
end;

macro УчестьКупонныеВыплатыДЕПО(_nptxop, AllTaxesArr:@TArray, AllSumArr:@TArray, EndYearOpDate:date, ID_Operation:integer, ID_Step:integer, RecAmountSNOB:money, RecSNOBDate:date, RecSNOBTime:time, СУММ_выч_Диас:@money)
  var Oper = TRecHandler("nptxop.dbt");
  var query, cmd, DataSet;
  var Year = 0;
  var err = 0;
  var НОБ_вып = $0;
  var SumDataArr = TArray();
  var TaxObj = TInsertTaxObject();

  Copy(Oper, _nptxop);

  datesplit(Oper.rec.OperDate, null, null, Year);

  AllTaxesArr.size = 0;
  AllSumArr.size = 0;  

  СУММ_выч_Диас = $0;
  
  if(УчетКупДепоПриРасчНОБ() == false)
    return 0;
  end;

  //Проверить, выполнялся ли уже учет купонов.
  //Это актуально при пересчете, если запись по учету купона отправилась в Хранилище, а другие нет
  //Тогда шаг повторяется, но уже учет купонов делать не нужно
  //Статус записи не проверяем, так как вместе с ней могли быь созданы и НДР, т.е. пересчет точно не нужен, чтобы не задублировались НДР, даже если соыбтие СНОБ не удалось отправить.
  query =   " select SUM(t_TaxBaseCurrPay) as SumTaxBaseCurrPay, SUM(t_CalcPITax) as SumCalcPITax, t_RateCalcPITax"
          + "   from dnptxtotalbase_dbt "
          + "  where t_ID_Operation = ? "
          + "    and t_Description Like '%Диасофт%' "
          + "    and t_Description Like '%(ID = %' "
          + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + " group by t_RateCalcPITax"
          + " order by t_RateCalcPITax ASC";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(ID_Operation);
  
  if(cmd.GetCount() > 0)
    DataSet = cmd.Execute();

    while(DataSet.moveNext())
      СУММ_выч_Диас = СУММ_выч_Диас + money(-1*DataSet.SumTaxBaseCurrPay);
    end;

    return 0;
  end;

  if(ExistDepoNptxObj(Oper, TXOBJ_PLUSG_1530) == true)
    //5.1.1.        Находим сумму для купонных выплат в Депозитарии, по которым созданы вычеты:
    var НОБ_обр_ЦБ;

    НОБ_обр_ЦБ = Рассчитать_НОБ_обр_ЦБ(Oper.rec.Client, Year);
    
    if(НОБ_обр_ЦБ < 0)
      //5.1.1.2.    если НОБ_обр_ЦБ < 0 (в СОФР создались вычеты для купонных выплат в Депозитарии, формирующих НОБ_обр_ЦБ),

      var СУММ_выч_обр = abs(НОБ_обр_ЦБ);
      var СУММ_выч_обр_зап = $0, СУММ_выч_обр_207 = $0;

      query =   " select * "
              + "   from dnptxcodechange_dbt "
              + "  where t_ClientID = ? "
              + "    and t_ChangeCode = 'X' "
              + "    and t_Sum_For_Change > 0 "
              + "    and t_TaxPeriod = ? "
              + "    and (t_AccountNumber LIKE '408%' or (t_AccountNumber LIKE '306%' and t_IsGetTax = 'X'))"
              + "    and t_Code_After = 1530 "
              + "  order by t_PaymentDate DESC ";

      cmd = DL_RSDCOmmand(query);

      cmd.AddParam(Oper.rec.Client);
      cmd.AddParam(Year);

      DataSet = cmd.Execute();

      while(DataSet.moveNext())
        НОБ_вып = money(DataSet.Sum_For_Change);

        if(СУММ_выч_обр >= НОБ_вып)
          СУММ_выч_обр_зап = НОБ_вып;
        else
          СУММ_выч_обр_зап = СУММ_выч_обр;
        end;

        СУММ_выч_обр = СУММ_выч_обр - СУММ_выч_обр_зап;

        SumDataArr[SumDataArr.size] = TSumData(DataSet.ID, date(DataSet.IncDate), time(DataSet.IncTime), СУММ_выч_обр_зап, DataSet.TaxRate, DataSet.KBK_After);

        if(DataSet.KBK_AFTER == NPTXKBK_PROC)
          СУММ_выч_обр_207 = СУММ_выч_обр_207 + СУММ_выч_обр_зап;
        end;

        if(СУММ_выч_обр == 0)
          break;
        end;
      end;
      
      
      if(СУММ_выч_обр_207 != 0)

        query =   " select obj.* "
                + "   from dnptxobdc_dbt dc, dnptxobj_dbt obj "
                + "  where dc.t_DocID = ? "
                + "    and obj.t_ObjID = dc.t_ObjID "
                + "    and (obj.t_Date = ? "  //Проверка даты нужна в основном при вызове из операции с признаком "Пересчет", чтобы отобрать не все НДР MinusG, а относящиеся именно к событию Окончание года
                + "         or obj.t_Date IN (select /*+ index(obj1 dnptxobj_dbt_idxa)*/ obj1.t_Date "
                                          + "   from dnptxobj_dbt obj1"
                                          + "  where obj1.t_Client = obj.t_Client "
                                          + "    and obj1.t_Date between ? and ? "
                                          + "    and obj1.t_Kind = " + TXOBJ_PLUSG_1530    
                                          + "    and obj1.t_FromOutSyst = 'X' "
                                          + "    and obj1.t_OutSystCode in ('DEPO','ДЕПО') "
                                          + "    and obj1.t_ChangeCode = 'X'"
                + "                          )"
                + "        ) "
                + "    and obj.t_Kind IN ( "+TXOBJ_MINUSG_201+","+TXOBJ_MINUSG_222+","+TXOBJ_MINUSG_218+","+TXOBJ_MINUSG_208+") "
                + " order by obj.t_Date DESC, "
                + "          ( case when obj.t_Kind = " + TXOBJ_MINUSG_201 + " then 1 "
                + "                 when obj.t_Kind = " + TXOBJ_MINUSG_222 + " then 2 "
                + "                 when obj.t_Kind = " + TXOBJ_MINUSG_218 + " then 3 "
                + "                 when obj.t_Kind = " + TXOBJ_MINUSG_208 + " then 4 "
                + "                 else 0 end "
                + "          ) ASC, dc.t_ObjID ASC ";
                
        cmd = DL_RSDCommand(query);
        
        cmd.AddParam(Oper.rec.ID);
        cmd.AddParam(EndYearOpDate);
        cmd.AddParam(date(1,1,Year));
        cmd.AddParam(date(31,12,Year));

        DataSet = cmd.Execute();
        while((DataSet.moveNext()) and (СУММ_выч_обр_207 > 0))
          var S = DataSet.Sum0 - СУММ_выч_обр_207;

          if(S < 0)
            Set207KBKInNptxObj(DataSet.ObjID, Oper.rec.ID, ID_Step);

            СУММ_выч_обр_207 = СУММ_выч_обр_207 - DataSet.Sum0;
          elif(S > 0)
            TaxObj.Add( 1                             
                       ,DataSet.Date               // Дата НДР
                       ,DataSet.Client             // Клиент
                       ,DataSet.Direction          // Направление
                       ,DataSet.Level              // Уровень
                       ,DataSet.User               // Признак "Пользовательский"
                       ,DataSet.Kind               // Вид НДР
                       ,СУММ_выч_обр_207           // Сумма дохода/расхода
                       ,NATCUR                     // Валюта дохода/расхода
                       ,DataSet.AnaliticKind1      // Вид аналитики 1
                       ,DataSet.Analitic1          // Аналитика 1
                       ,TXOBJ_KIND2040             // Вид аналитики 2
                       ,207                        // Аналитика 2
                       ,DataSet.AnaliticKind3      // Вид аналитики 3
                       ,DataSet.Analitic3          // Аналитика 3
                       ,DataSet.AnaliticKind4      // Вид аналитики 4
                       ,DataSet.Analitic4          // Аналитика 4
                       ,DataSet.AnaliticKind5      // Вид аналитики 5
                       ,DataSet.Analitic5          // Аналитика 5
                       ,DataSet.AnaliticKind6      // Вид аналитики 6
                       ,DataSet.Analitic6          // Аналитика 6
                       ,"Объект 1, созданный при учете купонного дохода от Диасофта. Создан на основе ObjID = " + DataSet.ObjID // Комментарий
                       ,Oper.rec.ID        // ID операции
                       ,ID_Step            // ID шага операции
                       ,0                  // Признак вызова не из операции расчета НОБ
                      );

            TaxObj.Add( 1                             
                       ,DataSet.Date               // Дата НДР
                       ,DataSet.Client             // Клиент
                       ,DataSet.Direction          // Направление
                       ,DataSet.Level              // Уровень
                       ,DataSet.User               // Признак "Пользовательский"
                       ,DataSet.Kind               // Вид НДР
                       ,(-1*СУММ_выч_обр_207)      // Сумма дохода/расхода
                       ,NATCUR                     // Валюта дохода/расхода
                       ,DataSet.AnaliticKind1      // Вид аналитики 1
                       ,DataSet.Analitic1          // Аналитика 1
                       ,DataSet.AnaliticKind2      // Вид аналитики 2
                       ,DataSet.Analitic2          // Аналитика 2
                       ,DataSet.AnaliticKind3      // Вид аналитики 3
                       ,DataSet.Analitic3          // Аналитика 3
                       ,DataSet.AnaliticKind4      // Вид аналитики 4
                       ,DataSet.Analitic4          // Аналитика 4
                       ,DataSet.AnaliticKind5      // Вид аналитики 5
                       ,DataSet.Analitic5          // Аналитика 5
                       ,DataSet.AnaliticKind6      // Вид аналитики 6
                       ,DataSet.Analitic6          // Аналитика 6
                       ,"Объект 2, созданный при учете купонного дохода от Диасофта. Создан на основе ObjID = " + DataSet.ObjID // Комментарий
                       ,Oper.rec.ID        // ID операции
                       ,ID_Step            // ID шага операции
                       ,0                  // Признак вызова не из операции расчета НОБ
                      );

            СУММ_выч_обр_207 = $0;
          elif(S == 0)
            Set207KBKInNptxObj(DataSet.ObjID, Oper.rec.ID, ID_Step);

            СУММ_выч_обр_207 = $0;
          end;
        end;
      end;
    end;
  end;


  if((not err) and (ExistDepoNptxObj(Oper, TXOBJ_PLUSG_1531) == true))
    var НОБ_необр_ЦБ;

    НОБ_необр_ЦБ = Рассчитать_НОБ_необр_ЦБ(Oper.rec.Client, Year);

    if(НОБ_необр_ЦБ < 0)
      //5.1.2.3.    если НОБ_необр_ЦБ < 0 (для купонных выплат в Депозитарии, формирующих НОБ_необр_ЦБ, вычеты в СОФР создались),
      var СУММ_выч_необр = abs(НОБ_необр_ЦБ);
      var СУММ_выч_необр_зап = $0;

      query =   " select * "
              + "   from dnptxcodechange_dbt "
              + "  where t_ClientID = ? "
              + "    and t_ChangeCode = 'X' "
              + "    and t_Sum_For_Change > 0 "
              + "    and t_TaxPeriod = ? "
              + "    and (t_AccountNumber LIKE '408%' or (t_AccountNumber LIKE '306%' and t_IsGetTax = 'X'))"
              + "    and t_Code_After = 1531 "
              + "  order by t_PaymentDate DESC ";

      cmd = DL_RSDCOmmand(query);

      cmd.AddParam(Oper.rec.Client);
      cmd.AddParam(Year);

      DataSet = cmd.Execute();

      while(DataSet.moveNext())
        НОБ_вып = money(DataSet.Sum_For_Change);

        if(СУММ_выч_необр >= НОБ_вып)
          СУММ_выч_необр_зап = НОБ_вып;
        else
          СУММ_выч_необр_зап = СУММ_выч_необр;
        end;

        СУММ_выч_необр = СУММ_выч_необр - СУММ_выч_необр_зап;

        SumDataArr[SumDataArr.size] = TSumData(DataSet.ID, date(DataSet.IncDate), time(DataSet.IncTime), СУММ_выч_необр_зап, DataSet.TaxRate, DataSet.KBK_After);

        if(СУММ_выч_необр == 0)
          break;
        end;
      end;

    end;
  end;

  if((not err) and (ExistDepoNptxObj(Oper, TXOBJ_PLUSG_1536) == true))
    var НОБ_потеря_ЦБ;

    НОБ_потеря_ЦБ = Рассчитать_НОБ_потеря_ЦБ(Oper.rec.Client, Year);

    if(НОБ_потеря_ЦБ < 0)
      //5.1.3.3.    если НОБ_потеря_ЦБ < 0 (для купонных выплат в Депозитарии, формирующих НОБ_потеря_ЦБ, вычеты в СОФР создались),
      var СУММ_выч_потеря = abs(НОБ_потеря_ЦБ);
      var СУММ_выч_потеря_зап = $0;

      query =   " select * "
              + "   from dnptxcodechange_dbt "
              + "  where t_ClientID = ? "
              + "    and t_ChangeCode = 'X' "
              + "    and t_Sum_For_Change > 0 "
              + "    and t_TaxPeriod = ? "
              + "    and (t_AccountNumber LIKE '408%' or (t_AccountNumber LIKE '306%' and t_IsGetTax = 'X'))"
              + "    and t_Code_After = 1536 "
              + "  order by t_PaymentDate DESC ";

      cmd = DL_RSDCOmmand(query);

      cmd.AddParam(Oper.rec.Client);
      cmd.AddParam(Year);

      DataSet = cmd.Execute();

      while(DataSet.moveNext())
        НОБ_вып = money(DataSet.Sum_For_Change);

        if(СУММ_выч_потеря >= НОБ_вып)
          СУММ_выч_потеря_зап = НОБ_вып;
        else
          СУММ_выч_потеря_зап = СУММ_выч_потеря;
        end;

        СУММ_выч_потеря = СУММ_выч_потеря - СУММ_выч_потеря_зап;

        SumDataArr[SumDataArr.size] = TSumData(DataSet.ID, date(DataSet.IncDate), time(DataSet.IncTime), СУММ_выч_потеря_зап, DataSet.TaxRate, DataSet.KBK_After);

        if(СУММ_выч_необр == 0)
          break;
        end;
      end;

    end;

  end;


  if(SumDataArr.size > 0)
    //6.        Формируем набор данных (далее набор Д) для записи в Хранилище СНОБ по вычетам, примененным к доходам по купонным выплатам в Депозитарии
    var i = 0;
    
    while((not err) and (i < SumDataArr.size))
      var STB = TRecHandler("nptxtotalbase.dbt");

      if(SumDataArr[i].СУММ_выч_зап > 0)
        var taxe = $0;

        if(ValType(AllSumArr[SumDataArr[i].Ставка]) == V_UNDEF)
          AllSumArr[SumDataArr[i].Ставка] = $0;
        end;

        if(ValType(AllTaxesArr[SumDataArr[i].Ставка]) == V_UNDEF)
          AllTaxesArr[SumDataArr[i].Ставка] = $0;
        end;
          
        AllSumArr[SumDataArr[i].Ставка] = AllSumArr[SumDataArr[i].Ставка] + SumDataArr[i].СУММ_выч_зап;

        taxe = round(-1*AllSumArr[SumDataArr[i].Ставка]*SumDataArr[i].Ставка/100.0 - AllTaxesArr[SumDataArr[i].Ставка], 0);

        AllTaxesArr[SumDataArr[i].Ставка] = AllTaxesArr[SumDataArr[i].Ставка] + taxe;

        СУММ_выч_Диас = СУММ_выч_Диас + SumDataArr[i].СУММ_выч_зап;

        InitSTB(STB, 
                Oper.rec.DocKind, 
                Oper.rec.ID, 
                Oper.rec.Client, 
                IIF(Oper.rec.IIS == SET_CHAR, true, false), 
                Year, 
                -SumDataArr[i].СУММ_выч_зап, 
                SumDataArr[i].Ставка, 
                $0, 
                taxe, 
                SumDataArr[i].КБК, 
                SumDataArr[i].ДатаПолучДох, 
                SumDataArr[i].ВремяПолучДох, 
                RecAmountSNOB, 
                RecAmountSNOB, 
                RecSNOBDate, 
                RecSNOBTime, 
                Oper.rec.DocKind, 
                Oper.rec.ID, 
                NPTXTOTALBASE_TAXBASEKIND_BROK, 
                "Диасофт. Замена кодов. Вычет, примененный к доходу по купонной выплате в депозитарии. (ID = "+SumDataArr[i].ID+")", 
                1/*Выплата дохода*/);

        err = CheckAndSaveSTB(STB);

        i = i + 1;
      end;
    end;
  end;

  if(not err)
    TaxObj.Save();
  end;

  return err;
end;

private macro GetSystDateTime(SystDate:@date, SystTime:@time)
  var cmd = DL_RSDCommand("select sysdate dt from dual");
  var DataSet = cmd.execute();

  DataSet.moveNext();

  DtTmSplit(DataSet.dt, SystDate, SystTime);
end;

private macro GetPrevCanclTBID(ClientID, ID_Operation, ID_Step)
  var query, cmd, DataSet;
  var TBID = 0;

  query =   " select t_TBID "
          + "   from dnptxtotalbase_dbt "
          + "  where t_ClientID = ? "
          + "    and t_ID_Operation = ? "
          + "    and t_ID_Step = ? "
          + "    and t_ConfirmState = " + NPTXTOTALBASE_CONFIRMSTATE_NOTCONFIRMED  //Не подтверждена
          + "    and t_StorState    = " + NPTXTOTALBASE_STORSTATE_CANCELED        //Отмененная
          + " order by t_TBID DESC ";    

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(ID_Operation);
  cmd.AddParam(ID_Step);

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    TBID = DataSet.TBID;
  end;

  return TBID;
end;

//Выполнить отмену прежних записей в операции расчета НОБ с признаком "Пересчет"
//Используется в операции расчета НОБ и в начальном решении (для этого и вынесена в отдельную ф-цию)
MACRO ExecCancelSTBinCalcNDFLop(_nptxop, ID_Operation, ID_Step, ErrStr:@string)
  var err = 0;
  var query, cmd, DataSet;
  var STB = TRecHandler("nptxtotalbase.dbt");
  var Oper = TRecHandler("nptxop.dbt");
  var FindTaxBaseKind = "";
  var STBArr = TArray();
  var NeedLoopStep = false;

  Copy(Oper, _nptxop);

  FindTaxBaseKind = IIF(Oper.rec.IIS == SET_CHAR, NPTXTOTALBASE_TAXBASEKIND_IIS, NPTXTOTALBASE_TAXBASEKIND_BROK);
  
  query =   " select 1 "
          + "   from dnptxval_dbt "
          + "  where t_ID_Operation = ? "
          + "    and t_Kind = " + NPTXVAL_KIND_DOCRECALCSTATUS
          + "    and ROWNUM = 1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ID_Operation);

  if(cmd.GetCount() == 0)
    //Выполняем отмену прежних записей за весь период
    query =   " select * "
            + "   from dnptxtotalbase_dbt "
            + "  where t_ClientID = ? "
            + "    and t_Type = 1 /*Выплата дохода*/ "
            + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
            + "    and t_TaxBaseKind IN (" + FindTaxBaseKind + ") "
            + "    and t_IncDate between ? and ? ";

    cmd = DL_RSDCommand();

    cmd.AddParam(Oper.rec.Client);
    cmd.AddParam(Oper.rec.BegRecalcDate);
    cmd.AddParam(Oper.rec.EndRecalcDate);
   
    if(Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_LUCRE)
      query = query + " and t_SpecialTag = 'МАТ' ";
    else 
      query = query + " and t_SpecialTag <> 'МАТ' ";
    end;

    DataSet = cmd.Execute(query);
    while(DataSet.moveNext())
      DataSet.GetRecord().CopyTo(STB.rec);

      STB.rec.ConfirmState = NPTXTOTALBASE_CONFIRMSTATE_NOTCONFIRMED; //Не подтверждена
      STB.rec.StorState    = NPTXTOTALBASE_STORSTATE_CANCELED;        //Отмененная
      STB.rec.IdentErrStr  = "";
      STB.rec.NeedRecalc   = "";
      err = CheckAndSaveSTB(STB);
      if(err)
        err = 1;
        ErrStr = "Ошибка при обновлении записи";
      else
        DL_NPTX_TbAddMsg(STB.rec.TBID, "Событие СНОБ отменено и не будет отправлено в Хранилище.");

        AddSTBToArr(STBArr, STB);
      end;
    end;
    
    if((not err) and (STBArr.size > 0))
      err = STB_ExecuteSendSTBArrToStorOnStep(STBArr, Oper.rec.DocKind, Oper.rec.ID, ID_Operation, ID_Step, @NeedLoopStep, @ErrStr, true);
    end;
  end;

  return err;
END;

private macro GetSNOBActualToRecalc(RecalcID:integer, CheckIncDate:date, CheckIncTime:time)
  var query, cmd, DataSet;
  var СНОБакт = $0, СНОБотм = $0, НОБотм = $0, НОБакт = $0;
  var i = 0;

  //Вычисляем СНОБ_отм
  //Отбираем отменнную запись по данной выплате на шаге "Отмена прежних записей о событиях СНОБ"
  query =   " select stb.t_ApplSTaxBaseInclude, stb.t_TaxBaseCurrPay "
          + "   from dnptxop_dbt recalcop, doproper_dbt op, dnptxtotalbase_dbt stb, doprstep_dbt st "
          + "  where recalcop.t_ID = ? "
          + "    and op.t_DocKind = recalcop.t_DocKind "
          + "    and op.t_DocumentID = LPAD(recalcop.t_ID, 34, '0') "
          + "    and stb.t_ID_Operation = op.t_ID_Operation "
          + "    and stb.t_StorState = " + NPTXTOTALBASE_STORSTATE_CANCELED
          + "    and (stb.t_IncDate < ? or (stb.t_IncDate = ? and stb.t_IncTime <= ?)) "
          + "    and st.t_ID_Operation = op.t_ID_Operation "
          + "    and st.t_ID_Step = stb.t_ID_Step "
          + "    and st.t_Number_Step = 104 " //Шаг "Отмена прежних записей о событиях СНОБ"
          + "  order by stb.t_TBID DESC";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(RecalcID);
  cmd.AddParam(CheckIncDate);
  cmd.AddParam(CheckIncDate);
  cmd.AddParam(CheckIncTime);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    if(i == 0)
      СНОБотм = DataSet.ApplSTaxBaseInclude;
    end;

    if(СНОБотм > 0)
      НОБотм = НОБотм + DataSet.TaxBaseCurrPay;
    end;

    i = i + 1;
  end;

  query =   " select NVL(SUM(stb.t_TaxBaseCurrPay), 0) as SumNOBact "
          + "   from dnptxop_dbt recalcop, doproper_dbt op, dnptxtotalbase_dbt stb "
          + "  where recalcop.t_ID = ? "
          + "    and op.t_DocKind = recalcop.t_DocKind "
          + "    and op.t_DocumentID = LPAD(recalcop.t_ID, 34, '0') "
          + "    and stb.t_ID_Operation = op.t_ID_Operation "
          + "    and stb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE;

  cmd = DL_RSDCommand(query);

  cmd.AddParam(RecalcID);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    НОБакт = DataSet.SumNOBact;
  end;

  СНОБакт = СНОБотм - НОБотм + НОБакт;

  return СНОБакт;
end;

//Выполнить пересчет в операции расчета НОБ с признаком "Пересчет"
//Используется в операции расчета НОБ и в начальном решении (для этого и вынесена в отдельную ф-цию)
//Если запустили в операции, то за один раз обрабатываем одну запись
//В начальном решении обрабатываем сразу все
MACRO ExecRecalcSTBinCalcNDFLop(_nptxop, ID_Operation, ID_Step, ErrStr:@string)
  var Year = 0;
  var err = 0;
  var НОБ_опер = $0, НОБ_30 = $0, НОБ_13 = $0, НОБ_15 = $0;
  var taxe = $0, taxe15 = $0;
  var TxArr = TArray();
  var query, cmd, DataSet;
  var STB = TRecHandler("nptxtotalbase.dbt");
  var Oper = TRecHandler("nptxop.dbt");
  var AmountSNOB = $0, ValDate, ValTime;
  var FindTaxBaseKind = "";
  var pIIS, НОБ_тек;
  var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
  var pBeg, pEnd;
  var ExistsDocToExec = 0;
  var prevSendID_Step = 0;
  var Technical = -1;
  var StartProgressScaleDate = GetStartProgressScaleDate();
  var i = 0;
  var TaxPeriod = 0, TaxTeriodToLucre;

  Copy(Oper, _nptxop);

  datesplit(Oper.rec.OperDate, null, null, TaxPeriod);

  TaxTeriodToLucre = CheckTaxTeriodToLucre(TaxPeriod);

  Technical = IsTechnical(Oper.rec.DocKind, Oper.rec.ID);

  if((РАБОТА_В_РЕЖИМЕ_СНОБ() == true) and (ПРОГРЕССИВНАЯ_ШКАЛА_ДЛЯ_НДФЛ() == true) and (StartProgressScaleDate > date(0,0,0)) and (Oper.rec.OperDate >= StartProgressScaleDate))
    FindTaxBaseKind = string(NPTXTOTALBASE_TAXBASEKIND_BROK) + ", " + string(NPTXTOTALBASE_TAXBASEKIND_IIS);
  else
    FindTaxBaseKind = IIF(Oper.rec.IIS == SET_CHAR, NPTXTOTALBASE_TAXBASEKIND_IIS, NPTXTOTALBASE_TAXBASEKIND_BROK);
  end;
  
  //2.1.    Определяем набор дат получения дохода для клиента за пересчитываемый период
  //2.2.  Для каждой даты получения дохода определяется связанная операция расчета НОБ.

  if(ID_Operation > 0)
    query =   " select 1 "
            + "   from dnptxval_dbt "
            + "  where t_ID_Operation = ? "
            + "    and t_Kind = " + NPTXVAL_KIND_DOCRECALCSTATUS
            + "    and ROWNUM = 1 ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(ID_Operation);

    ExistsDocToExec = cmd.GetCount();
  end;

  cmd = DL_RSDCommand();

  query =   " select q.*, " + IIF(ExistsDocToExec, "v.t_Val", "1") + " as RecalcStatus, " + IIF(ExistsDocToExec, "v.t_ID_Step", "0") + " as prevID_Step "
          + "   from (select nptxop.t_ID, nptxop.t_DocKind, nptxop.t_OperDate, nptxop.t_Time, nptxop.t_Client, (case when nptxop.t_SubKInd_Operation = "+DL_TXBASECALC_OPTYPE_ENDYEAR+" then 1 else 0 end) as OrigOpIsEndYear, "
          + "                (select st.t_Syst_Time "
          + "                   from doprstep_dbt st "
          + "                  where st.t_ID_Operation = op.t_ID_Operation "
          + "                    and st.t_ID_Step = (select MIN(st1.t_ID_Step) "
          + "                                          from doprstep_dbt st1 "
          + "                                         where st1.t_ID_Operation = st.t_ID_Operation "
          + "                                       ) "
          + "                ) as StepTime "
          + "           from dnptxop_dbt nptxop, doproper_dbt op "
          + "          where nptxop.t_DocKind = " + DL_CALCNDFL
          + "            and nptxop.t_Client = ? "
          + "            and nptxop.t_OperDate between ? and ? "
          + "            and nptxop.t_SubKind_Operation IN ("+DL_TXBASECALC_OPTYPE_ENDYEAR + ", " +DL_TXBASECALC_OPTYPE_CLOSE_IIS + ") "
          + IIF(TaxTeriodToLucre, " and " + Oper.rec.SubKind_Operation + " <> "+ DL_TXBASECALC_OPTYPE_LUCRE, "")
          + "            and nptxop.t_IIS = " + IIF(Oper.rec.IIS == SET_CHAR, "'X'", "CHR(0)")
          + "            and nptxop.t_Contract = ? "
          + "            and nptxop.t_Status = " + DL_TXOP_Close
          + "            and nptxop.t_Recalc <> 'X' "
          + "            and op.t_DocKind = nptxop.t_DocKind "
          + "            and op.t_DocumentID = LPAD(nptxop.t_ID, 34, '0') "
          + "            and op.t_Parent_ID_Operation = 0 "
          + "         union "
          + "         select nptxwrt.t_ID, nptxwrt.t_DocKind, nptxwrt.t_OperDate, nptxwrt.t_Time, nptxop.t_Client, 0 as OrigOpIsEndYear, "
          + "                (select st.t_Syst_Time "
          + "                   from doprstep_dbt st "
          + "                  where st.t_ID_Operation = opwrt.t_ID_Operation "
          + "                    and st.t_ID_Step = (select MIN(st1.t_ID_Step) "
          + "                                          from doprstep_dbt st1 "
          + "                                         where st1.t_ID_Operation = st.t_ID_Operation "
          + "                                       ) "
          + "                ) as StepTime "
          + "           from dnptxop_dbt nptxop, doproper_dbt op, dnptxop_dbt nptxwrt, doproper_dbt opwrt "
          + "          where nptxop.t_DocKind = " + DL_CALCNDFL
          + "            and nptxop.t_Client = ? "
          + "            and nptxop.t_OperDate between ? and ? "
          + "            and nptxop.t_SubKind_Operation IN (" + DL_TXBASECALC_OPTYPE_NORMAL + ", " +DL_TXBASECALC_OPTYPE_CLOSE_IIS + ") "
          + IIF(TaxTeriodToLucre, " and " + Oper.rec.SubKind_Operation + " <> "+ DL_TXBASECALC_OPTYPE_LUCRE, "")
          + "            and nptxop.t_IIS = " + IIF(Oper.rec.IIS == SET_CHAR, "'X'", "CHR(0)")
          + "            and nptxop.t_Contract = ? "
          + "            and nptxop.t_Status = " + DL_TXOP_Close
          + "            and op.t_DocKind = nptxop.t_DocKind "
          + "            and op.t_DocumentID = LPAD(nptxop.t_ID, 34, '0') "
          + "            and op.t_Parent_ID_Operation > 0 "
          + "            and opwrt.t_ID_Operation = op.t_Parent_ID_Operation "
          + "            and opwrt.t_DocKind = " + DL_WRTMONEY
          + "            and nptxwrt.t_ID = TO_NUMBER(opwrt.t_DocumentID) "
          + "            and (   trim(NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote("+OBJTYPE_WRTMONEY+", LPAD(nptxwrt.t_ID, 34, '0'), 103/*Отметка об отказе в исполнении*/, nptxwrt.t_OperDate)), CHR(1))) = CHR(1) "
          + "                 or ascii(trim(NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote("+OBJTYPE_WRTMONEY+", LPAD(nptxwrt.t_ID, 34, '0'), 103/*Отметка об отказе в исполнении*/, nptxwrt.t_OperDate)), CHR(1)))) = 0"
          + "                )"
          + "         union "
          + "         select nptxwrt.t_ID, nptxwrt.t_DocKind, nptxwrt.t_OperDate, nptxwrt.t_Time, nptxwrt.t_Client, 0 as OrigOpIsEndYear, "
          + "                (select st.t_Syst_Time "
          + "                   from doprstep_dbt st "
          + "                  where st.t_ID_Operation = opwrt.t_ID_Operation "
          + "                    and st.t_ID_Step = (select MIN(st1.t_ID_Step) "
          + "                                          from doprstep_dbt st1 "
          + "                                         where st1.t_ID_Operation = st.t_ID_Operation "
          + "                                       ) "
          + "                ) as StepTime "
          + "           from dnptxop_dbt nptxwrt, doproper_dbt opwrt "
          + "          where nptxwrt.t_DocKind = " + DL_WRTMONEY
          + "            and nptxwrt.t_Client = ? "
          + "            and nptxwrt.t_OperDate between ? and ? "
          + "            and rsi_npto.CheckContrIIS(nptxwrt.t_Contract) = " + IIF(Oper.rec.IIS == SET_CHAR, "1", "0")
          + "            and (? <= 0 or nptxwrt.t_Contract IN (select mp.t_SfContrID from ddlcontrmp_dbt mp where mp.t_DlContrID = ?))"
          + "            and nptxwrt.t_FlagTax = 'X' "
          + "            and nptxwrt.t_Status = " + DL_TXOP_Close
          + "            and (   trim(NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote("+OBJTYPE_WRTMONEY+", LPAD(nptxwrt.t_ID, 34, '0'), 103/*Отметка об отказе в исполнении*/, nptxwrt.t_OperDate)), CHR(1))) = CHR(1) "
          + "                 or ascii(trim(NVL(rsb_struct.getString(rsi_rsb_kernel.GetNote("+OBJTYPE_WRTMONEY+", LPAD(nptxwrt.t_ID, 34, '0'), 103/*Отметка об отказе в исполнении*/, nptxwrt.t_OperDate)), CHR(1)))) = 0"
          + "                )"
          + "            and opwrt.t_DocKind = nptxwrt.t_DocKind "
          + "            and opwrt.t_DocumentID = LPAD(nptxwrt.t_ID, 34, '0') "
          + "            and Not Exists(select 1 "
          + "                             from doproper_dbt op "
          + "                            where op.t_Parent_ID_Operation = opwrt.t_ID_Operation "
          + "                              and op.t_DocKind = " + DL_CALCNDFL
          + "                          ) "
          + IIF(TaxTeriodToLucre, " and " + Oper.rec.SubKind_Operation + " <> "+ DL_TXBASECALC_OPTYPE_LUCRE, "")
          + IIF(TaxTeriodToLucre, "         union "
          + "         select nptxop.t_ID, nptxop.t_DocKind, nptxop.t_OperDate, nptxop.t_Time, nptxop.t_Client, 0 as OrigOpIsEndYear, "
          + "                (select st.t_Syst_Time "
          + "                   from doprstep_dbt st "
          + "                  where st.t_ID_Operation = op.t_ID_Operation "
          + "                    and st.t_ID_Step = (select MIN(st1.t_ID_Step) "
          + "                                          from doprstep_dbt st1 "
          + "                                         where st1.t_ID_Operation = st.t_ID_Operation "
          + "                                       ) "
          + "                ) as StepTime "
          + "           from dnptxop_dbt nptxop, doproper_dbt op "
          + "          where nptxop.t_DocKind = " + DL_CALCNDFL
          + "            and nptxop.t_Client = ? "
          + "            and nptxop.t_OperDate between ? and ? "
          + "            and nptxop.t_SubKind_Operation = " + DL_TXBASECALC_OPTYPE_LUCRE
          + "            and " + Oper.rec.SubKind_Operation + " = "+ DL_TXBASECALC_OPTYPE_LUCRE
          + "            and nptxop.t_Status = " + DL_TXOP_Close
          + "            and op.t_DocKind = nptxop.t_DocKind "
          + "            and op.t_DocumentID = LPAD(nptxop.t_ID, 34, '0') "
          + "            and op.t_Parent_ID_Operation = 0 ", "")
          + "        ) q " + IIF(ExistsDocToExec, ", dnptxval_dbt v ", "")
          + "  where q.t_ID <> ? ";

  cmd.AddParam(Oper.rec.Client);
  cmd.AddParam(Oper.rec.BegRecalcDate);
  cmd.AddParam(Oper.rec.EndRecalcDate);
  cmd.AddParam(Oper.rec.Contract);
  cmd.AddParam(Oper.rec.Client);
  cmd.AddParam(Oper.rec.BegRecalcDate);
  cmd.AddParam(Oper.rec.EndRecalcDate);
  cmd.AddParam(Oper.rec.Contract);
  cmd.AddParam(Oper.rec.Client);
  cmd.AddParam(Oper.rec.BegRecalcDate);
  cmd.AddParam(Oper.rec.EndRecalcDate);
  cmd.AddParam(Oper.rec.Contract);
  cmd.AddParam(Oper.rec.Contract);
  if(TaxTeriodToLucre)
    cmd.AddParam(Oper.rec.Client);
    cmd.AddParam(Oper.rec.BegRecalcDate);
    cmd.AddParam(Oper.rec.EndRecalcDate);
  end;
  cmd.AddParam(Oper.rec.ID);

  if(ExistsDocToExec)
    query = query +  " and v.t_ID_Operation = ? "
                   + " and v.t_Kind = " + NPTXVAL_KIND_DOCRECALCSTATUS
                   + " and v.t_DocKind = q.t_DocKind "
                   + " and v.t_DocID = q.t_ID "
                   + " and v.t_ID = (select MAX(v1.t_ID) "
                   + "                 from dnptxval_dbt v1 "
                   + "                where v1.t_DocKind = v.t_DocKind "
                   + "                  and v1.t_DocID = v.t_DocID "
                   + "                  and v1.t_Kind = v.t_Kind "
                   + "                  and v1.t_ID_Operation = v.t_ID_Operation "
                   + "              ) "
                   + " and v.t_Val IN (1,3) ";

    cmd.AddParam(ID_Operation);
  end;

  if((Oper.rec.DocKind == DL_CALCNDFL) and (Oper.rec.Recalc == SET_CHAR) and (IsTechnical(Oper.rec.DocKind, Oper.rec.ID) == 0) and ((Oper.rec.SubKind_Operation != DL_TXBASECALC_OPTYPE_LUCRE) or (TaxTeriodToLucre == false)))
     query = query + " and not exists( " +
                     "                  select 1 " +
                     "                  from dnptxobj_dbt obj " +
                     "                  where obj.t_Date = q.t_OperDate " +
                     "                    and obj.t_Client = q.t_Client " +
                     "                    and obj.t_Technical = CHR(88) " +
                     "               ) ";
  end;

  query = query + "  order by q.t_OperDate ASC, q.StepTime ASC, q.t_ID ASC ";

  DataSet = cmd.Execute(query);

  if((ID_Operation > 0) and (not ExistsDocToExec))
    //При первом запуске запоминаем все операции к обработке
    while(DataSet.moveNext())
      if(DL_InsertNPTXVAL(DataSet.DocKind, DataSet.ID, NPTXVAL_KIND_DOCRECALCSTATUS, date(0,0,0), time(0), 1/*Начальный пересчет*/, 0) != 0)
        ErrStr = "Ошибка при сохранении значения СНОБ";
        return 1;
      end;
    end;

    DataSet = cmd.Execute(query);
  end;
  
  while((not err) and (DataSet.moveNext())) 
    var currIncDate = date(DataSet.OperDate);
    var currIncTime = time(DataSet.StepTime);
    var OrigDocKind = DataSet.DocKind;
    var OrigDocID   = DataSet.ID;
    var AllTaxesArr = TArray(), AllSumArr = TArray();
    var СУММ_выч_Диас = $0;

    TxArr.size = 0;

    НОБ_тек  = $0;
    НОБ_опер = $0;
    НОБ_30   = $0;
    НОБ_13   = $0;
    НОБ_15   = $0;
    taxe     = $0;
    taxe15   = $0;

    DateSplit(currIncDate, null, null, Year);

    //3.    В каждую определенную в п 2.1. дату, начиная с самой ранней, выполняем формирование набора записей для отправки в Хранилище СНОБ
    if(DataSet.RecalcStatus == 1)
      //Если шаг выполняется первый раз, то рассчитываем СНОБ по данным СОФР по общим правилам
      AmountSNOB = GetSNOBActualToRecalc(Oper.rec.ID, currIncDate, currIncTime);

      ValDate = date(0,0,0);
      ValTime = time(0);
    else
      //Если шаг выполняется повторно (была ошибка "30"), то ищем полученную от Хранилища актуальную СНОБ 

      //Найдем отмененную на предыдущем шаге запись СНОБ по этой выплате, чтобы взять с неё актуальную СНОБ, полученную с ошибочным ответом Хранилища
      var prevTBID = GetPrevCanclTBID(Oper.rec.Client, ID_Operation, DataSet.prevID_Step);

      if(prevTBID <= 0)
        if(ID_Operation > 0) 
          if(DL_InsertNPTXVAL(DataSet.DocKind, DataSet.ID, NPTXVAL_KIND_DOCRECALCSTATUS, date(0,0,0), time(0), 2/*Пересчет выполнен*/, 0) != 0)
            ErrStr = "Ошибка при сохранении значения СНОБ";
            return 1;
          end;
        end;
        continue; //Если запись не нашли, то, возможно, её и не было по той операции. Просто игнорируем этот факт
      else
        GetLastOpSTBVal(DL_NPTXSTBOP, prevTBID, NPTXVAL_KIND_STB, @AmountSNOB, @ValDate, @ValTime);
      end;
    end;  

    if(not err)
      if((DataSet.OrigOpIsEndYear == 1) and (Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_ENDYEAR))
        err = УчестьКупонныеВыплатыДЕПО(Oper, @AllTaxesArr, @AllSumArr, date(Oper.rec.OperDate), ID_Operation, ID_Step, AmountSNOB, ValDate, ValTime, @СУММ_выч_Диас);
      end;
    end;

    if(not err)
      //3.2.    Считаем НОБ на дату получения дохода 
      pIIS = IIF((Oper.rec.IIS == SET_CHAR), 1, 0);

      pBeg = IIF(pIIS, GetFirstDateIIS(Oper.rec.Client, GetDlCOntrIDByNPTXOP(Oper)), date(1, 1, Year));
      pEnd = currIncDate;
      
      if(pIIS)
        taxe   = GetRubSumByClientOper(Oper.rec.Client, string(TXOBJ_PAIDGENERAL_IIS), pEnd, pEnd, OrigDocKind, OrigDocID, null, pIIS, AddWhereNotOut);
        taxe15 = GetRubSumByClientOper(Oper.rec.Client, string(TXOBJ_PAIDGENERAL_15_IIS), pEnd, pEnd, OrigDocKind, OrigDocID, null, pIIS, AddWhereNotOut);
      else
        if(DL_GetPartyResident(Oper.rec.Client) == NPTXPARTY_RESIDENT)
          taxe   = GetRubSumByClientOper(Oper.rec.Client, string(TXOBJ_PAIDGENERAL), pEnd, pEnd, OrigDocKind, OrigDocID, null, pIIS, AddWhereNotOut);   
          taxe15 = GetRubSumByClientOper(Oper.rec.Client, string(TXOBJ_PAIDGENERAL_15_2), pEnd, pEnd, OrigDocKind, OrigDocID, null, pIIS, AddWhereNotOut);
        else
          taxe   = GetRubSumByClientOper(Oper.rec.Client, string(TXOBJ_PAIDGENERAL), pEnd, pEnd, OrigDocKind, OrigDocID, null, pIIS, AddWhereNotOut);
          taxe15 = $0;
        end;
      end;

      if((ПРОГРЕССИВНАЯ_ШКАЛА_ДЛЯ_НДФЛ() == true) and (StartProgressScaleDate > date(0,0,0)) and (Oper.rec.OperDate >= StartProgressScaleDate))
        var OrigNptxop = TBFile("nptxop.dbt");
        var q, sel, ds;

        OrigNptxop.rec.ID = OrigDocID;
        OrigNptxop.GetEQ();
        
        CalcNOBoper(OrigNptxop, @НОБ_опер, СУММ_выч_Диас, NULL, NULL, Oper.rec.OperDate+1);
        
        if(НОБ_опер > 0)
          CalcTaxByRanges(Oper.rec.Client,
                          Year,
                          STB_GetTaxBaseKindByDocKind(OrigDocKind, IIF(Oper.rec.IIS == SET_CHAR, true, false)),
                          НОБ_опер,
                          AmountSNOB,
                          OrigNptxop.rec.OperDate
                         );

          q = " select * from dnptxtaxbaseranges_tmp order by t_range asc ";
          sel = DL_RSDCommand(q);
          ds = sel.Execute();
          while(ds.moveNext())
            var TaxHold = IIF(int(ds.TaxRate) == int(NPTXGENTAXRATE_RESIDENT_15*100), taxe15, taxe);

            TxArr[TxArr.size] = STB_TaxRateParm(int(ds.TaxRate),
                                                money(ds.BaseSum) + IIF(ValType(AllSumArr[int(ds.TaxRate)]) != V_UNDEF, AllSumArr[int(ds.TaxRate)], $0), 
                                                TaxHold,
                                                ds.KBK, 
                                                ds.TaxBaseType, 
                                                IIF(Oper.rec.IIS == SET_CHAR, true, false), 
                                                NULL, 
                                                0, 
                                                money(ds.TaxCalc)
                                                );

            if(int(ds.TaxRate) == int(NPTXGENTAXRATE_RESIDENT_15*100))
              taxe15 = $0;
            else
              taxe = $0;
            end;
          end;

          i = 0;
          НОБ_опер = $0;
          while(i < TxArr.size)
            НОБ_опер = НОБ_опер + TxArr[i].НОБ;

            i = i + 1;
          end;
        end;

        if(taxe != $0)
          TxArr[TxArr.size] = STB_TaxRateParm(IIF(DL_GetPartyResident(Oper.rec.Client) == NPTXPARTY_RESIDENT, int(NPTXGENTAXRATE_RESIDENT*100), int(NPTXGENTAXRATE_NOTRESIDENT*100)),
                                              $0, 
                                              taxe
                                              );
        end;

        if(taxe15 != $0)
          TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                              $0, 
                                              taxe15
                                              );
        end;

        //Чтобы отрицательная НОБ отменилась
        if((НОБ_опер < 0) and (TxArr.size > 0))
          TxArr[0].НОБ = НОБ_опер;
        end;
        
      else

        if(pIIS)
          if(DL_GetPartyResident(Oper.rec.Client) == NPTXPARTY_RESIDENT)
            НОБ_тек =   GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEG5), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
          else
            НОБ_тек =   GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEGENERAL_IIS), pBeg, pEnd, null, pIIS, null, AddWhereNotOut)
                      + GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEMATERIAL_IIS), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
          end;
        elif(DL_GetPartyResident(Oper.rec.Client) == NPTXPARTY_RESIDENT)
          if(СУММ_выч_Диас > 0)
            НОБ_тек = STB_GetSavedNptxval(Oper.rec.DocKind, Oper.rec.ID, NPTXVAL_KIND_CALCBG2);
          else

            НОБ_тек = GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEG2), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
          end;

          НОБ_тек =   НОБ_тек + GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEG3), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
        else
          НОБ_тек =   GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEGENERAL), pBeg, pEnd, null, pIIS, null, AddWhereNotOut)
                    + GetRubSumByClient(Oper.rec.Client, string(TXOBJ_BASEMATERIAL), pBeg, pEnd, null, pIIS, null, AddWhereNotOut);
        end;

        НОБ_опер = НОБ_тек - STB_GetSumTaxBaseCurrPay(Oper.rec.Client, FindTaxBaseKind, IIF(pIIS, NULL, Year), NULL, NULL, currIncDate, currIncTime+time(0,0,1)); 

        if(DL_GetPartyResident(Oper.rec.Client) == NPTXPARTY_RESIDENT)
          if(НОБ_опер > 0)
            НОБ_13 = MAX(0, MIN((AmountSNOB + НОБ_опер), NPTX_LIMINCOME_MAX15) - AmountSNOB);
            НОБ_15 = НОБ_опер - НОБ_13;
          elif(НОБ_опер < 0)
            var Сумма_НОБ = STB_GetSumTaxBaseCurrPay(Oper.rec.Client, FindTaxBaseKind, IIF(pIIS, NULL, Year), int(NPTXGENTAXRATE_RESIDENT_15*100), NULL, currIncDate, currIncTime+time(0,0,1));
            НОБ_15 = -MIN(ABS(НОБ_опер), Сумма_НОБ);
            НОБ_13 = НОБ_опер - НОБ_15;
          end;
        else
          НОБ_30 = НОБ_опер;
        end;
        
        if(DL_GetPartyResident(Oper.rec.Client) == NPTXPARTY_RESIDENT)
          TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT*100),
                                              НОБ_13 + IIF(ValType(AllSumArr[int(NPTXGENTAXRATE_RESIDENT*100)]) != V_UNDEF, AllSumArr[int(NPTXGENTAXRATE_RESIDENT*100)], $0), 
                                              taxe
                                             );

          TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_RESIDENT_15*100),
                                              НОБ_15 + IIF(ValType(AllSumArr[int(NPTXGENTAXRATE_RESIDENT_15*100)]) != V_UNDEF, AllSumArr[int(NPTXGENTAXRATE_RESIDENT_15*100)], $0), 
                                              taxe15
                                             );
        else
          TxArr[TxArr.size] = STB_TaxRateParm(int(NPTXGENTAXRATE_NOTRESIDENT*100),
                                              НОБ_30 + IIF(ValType(AllSumArr[int(NPTXGENTAXRATE_NOTRESIDENT*100)]) != V_UNDEF, AllSumArr[int(NPTXGENTAXRATE_NOTRESIDENT*100)], $0), 
                                              taxe
                                             );
        end;
      
        i = 0;
        НОБ_опер = $0;
        while(i < TxArr.size)
          НОБ_опер = НОБ_опер + TxArr[i].НОБ;

          i = i + 1;
        end;

      end;

      err = STB_ExecuteCreateSTBOnStep(TxArr,
                                       НОБ_опер,
                                       Oper.rec.DocKind, 
                                       Oper.rec.ID, 
                                       Oper.rec.Client, 
                                       Oper.rec.OperDate, 
                                       IIF(Oper.rec.IIS == SET_CHAR, true, false), 
                                       Year, 
                                       ID_Operation, 
                                       ID_Step, 
                                       @ErrStr,
                                       currIncDate,
                                       currIncTime,
                                       AmountSNOB,
                                       IIF(ID_Operation == 0, $0, AmountSNOB-СУММ_выч_Диас),
                                       ValDate,
                                       ValTime,
                                       OrigDocKind,
                                       OrigDocID
                                       );

      
      if(ID_Operation > 0) 
        if(DL_InsertNPTXVAL(DataSet.DocKind, DataSet.ID, NPTXVAL_KIND_DOCRECALCSTATUS, date(0,0,0), time(0), 2/*Пересчет выполнен*/, 0) != 0)
          ErrStr = "Ошибка при сохранении значения СНОБ";
          return 1;
        end;
        //Непосредственно в самой операции обрабатываем только одну запись за один раз
        break;
      end;
    end;
  end;

  return err;
END;

//Проверка, не была ли создана операция расчета НОБ в другой операции
MACRO IsChildOp(DocKind:INTEGER, DocID:INTEGER)
  var query, cmd, DataSet;

  query =   " select 1 "
          + "   from doproper_dbt op "
          + "  where op.t_DocKind = ? "
          + "    and op.t_DocumentID = LPAD(?, 34, '0') "
          + "    and op.t_Parent_ID_Operation > 0 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);

  if(cmd.GetCount() > 0)
    return true;
  end;

  return false;
END;


MACRO GetSumCorrBalInOp(DocKind:integer, DocID:integer, ClientID:integer, KBK:string, IIS:bool, ExcludeOpTaxBaseKind:bool)
  var OpTaxBaseKind;
  var query, cmd, DataSet;
  var Sum = $0;

  if(IIS == NULL)
    IIS = false;
  end;

  OpTaxBaseKind = STB_GetTaxBaseKindByDocKind(DocKind, IIS);

  cmd = DL_RSDCommand();

  query =   " select NVL(SUM(t_HoldPITax), 0) as SumCorrBal "
          + "   from dnptxtotalbase_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_ClientID = ? "
          + "    and t_BCCHoldPITax = ?"
          + "    and t_TaxBaseCurrPay = 0 "
          + "    and t_CalcPITax = 0 "
          + "    and t_HoldPITax <> 0 "
          + "    and t_OrigTBID = 0 "
          + "    and t_Type IN (2,3) "
          + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and instr(UPPER(t_Description), UPPER('Диасофт')) = 0";

  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ClientID);
  cmd.AddParam(KBK);

  if(ExcludeOpTaxBaseKind == true)
    query = query + "    and t_TaxBaseKind <> ? ";
    cmd.AddParam(OpTaxBaseKind);
  end;

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    Sum = money(DataSet.SumCorrBal);
  end;
  
  return Sum;
END;

MACRO GetSumCorrBalInOpPRGS(DocKind:integer, DocID:integer, ClientID:integer, IIS:bool, ExcludeOpTaxBaseKind:bool, SumCorrBalArr:@TArray, OperDate)
  var OpTaxBaseKind;
  var query, cmd, DataSet;
  var Sum = $0;

  SumCorrBalArr.size = 0;

  if(IIS == NULL)
    IIS = false;
  end;

  OpTaxBaseKind = STB_GetTaxBaseKindByDocKind(DocKind, IIS, OperDate);

  cmd = DL_RSDCommand();

  query =   " select NVL(SUM(t_HoldPITax), 0) as SumCorrBal, t_BCCHoldPITax, t_RateHoldPITax "
          + "   from dnptxtotalbase_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? "
          + "    and t_ClientID = ? "
          + "    and t_HoldPITax <> 0 "
          + "    and t_OrigTBID = 0 "
          + "    and t_Type IN (1,2,3) "
          + "    and t_Symbol = 'C' "
          + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and instr(UPPER(t_Description), UPPER('Диасофт')) = 0"
          + " group by t_BCCHoldPITax, t_RateHoldPITax"
          + " order by t_RateHoldPITax ASC";

  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ClientID);

  if(ExcludeOpTaxBaseKind == true)
    query = query + "    and t_TaxBaseKind <> ? ";
    cmd.AddParam(OpTaxBaseKind);
  end;

  DataSet = cmd.Execute(query);
  while(DataSet.moveNext())
    var sz = SumCorrBalArr.size;

    SumCorrBalArr[sz] = STB_TaxRateParm(int(DataSet.RateHoldPITax),
                                        $0, 
                                        money(DataSet.SumCorrBal),
                                        DataSet.BCCHoldPITax
                                       );
  end;
  
  return Sum;
END;

macro GetCatTransfByRate(TaxRate:integer)
  var query, cmd, DataSet;
  var CatCode = "";

  query =   " select t_Name "
          + "   from dllvalues_dbt "
          + "  where t_List = 4158 "
          + "    and t_Flag = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(TaxRate);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    CatCode = DataSet.Name;
  end;    

  return CatCode;
end;

macro GetCatRetByRate(TaxRate:integer)
  var query, cmd, DataSet;
  var CatCode = "";

  query =   " select t_Name "
          + "   from dllvalues_dbt "
          + "  where t_List = 4159 "
          + "    and t_Flag = ? ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(TaxRate);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    CatCode = DataSet.Name;
  end;    

  return CatCode;
end;

MACRO ВыполнитьПроводкуЗачетаНДФЛ(FD, OpCode, ClientID, dat, WrtMainTo15, Wrt15ToMain, DtAccountNum:@string, CtAccountNum:@string, ErrStr:@string)
  var accMain = TRecHandler("account.dbt");
  var acc15   = TRecHandler("account.dbt");
  var CtAcc = TRecHandler("account.dbt");
  var DtAcc = TRecHandler("account.dbt");
  var RestAcc = $0;
  var CatCode = "";
  var SCorr = $0;
  var IsClientResident = STB_IsResidentStatus(STB_GetClientTaxPayerStatus(ClientID));
  var ClientShortName = ПолучитьКороткоеИмяСубъекта(ClientID);
  var needAccTrn = true;
  var err = 0;

  ErrStr = "";

  CatCode = "НДФЛ к перечислению, FLR";
  if(IsClientResident == false)
    CatCode = "НДФЛ к перечислению, FLN";
  end;
  if( not FD.OpenAccount(CatCode, null, false, null, accMain, dat, NATCUR) )
     return Error( "Ошибка при определении счета по категории <"+CatCode+">." );
  end;

  CatCode = "НДФЛ к перечислению 15%";
  if( not FD.OpenAccount(CatCode, null, false, null, acc15, dat, NATCUR) )
     return Error( "Ошибка при определении счета по категории <"+CatCode+">." );
  end;

  if(accMain.rec.Account == acc15.rec.Account)
    return 0;
  end;

  //Вообще одновременно WrtMainTo15 и Wrt15ToMain не должны быть отличный от 0. Иначе в этом нет никакого смысла. Тогда это ошибка в предыдущих расчетах
  if(Wrt15ToMain != 0) //Уменьшение НДФЛ по 15%
    SCorr = abs(Wrt15ToMain);

    copy(CtAcc, accMain);

    RestAcc = DL_GetRestAccount(acc15.rec, dat);
    if(SCorr > RestAcc)
      DtAcc = "НДФЛ к возврату_15%";
    else
      copy(DtAcc, acc15);
    end;
  elif(WrtMainTo15 != 0) //Увеличение НДФЛ по 15%
    SCorr = abs(WrtMainTo15);
    
    copy(CtAcc, acc15);
  
    RestAcc = DL_GetRestAccount(accMain.rec, dat);
    if(SCorr > RestAcc)
      DtAcc = "НДФЛ к возврату";
    else
      copy(DtAcc, accMain);
    end;
  end;

  if( not ПроводкаПоКатегориямУчета( FD,
                                     DtAcc, CtAcc,
                                     dat,                           /* Дата */
                                     1,                             /* Глава */
                                     NATCUR,                        /* Валюта суммы проводки */
                                     SCorr,                         /* Сумма проводки*/
                                     NULL,                          /* Документ */
                                     INPCARRY,                      /* Result_Carry */
                                     " 1",                          /* Kind_Oper */
                                     OpCode,                        /* Numb_Document */
                                     "Урегулирование НДФЛ между КБК, "+ClientShortName,             /* Ground */
                                     NULL, NULL, NULL, NULL, NULL, NULL,
                                     NULL, NULL, NULL, NULL, NULL, NULL,
                                     @DtAccountNum, @CtAccountNum
                                   )
    )
     ErrStr = "Ошибка при выполнении проводки";
     return 1;
  end;


  return err;
END;

CLASS NPTXNettAccTrnData(_DtAccountNum:string, _CtAccountNum:string, _Sum:money)
  var DtAccountNum = _DtAccountNum; 
  var CtAccountNum = _CtAccountNum; 
  var Sum          = _Sum;
END;

MACRO ВыполнитьПроводкиЗачетаНДФЛ(FD, OpCode, ClientID, dat, TaxRateX, TaxRateY, SCorr, NettAccTrnArr:@TArray, ErrStr:@string)
  var accX  = TRecHandler("account.dbt");
  var accY  = TRecHandler("account.dbt");
  var accRetY  = TRecHandler("account.dbt");
  var RESTrate_Y = $0;
  var CatCode = "";
  var IsClientResident = STB_IsResidentStatus(STB_GetClientTaxPayerStatus(ClientID));
  var ClientShortName = ПолучитьКороткоеИмяСубъекта(ClientID);
  var needAccTrn = true;
  var err = 0;
  var CatCodeX = GetCatTransfByRate(TaxRateX);
  var CatCodeY = GetCatTransfByRate(TaxRateY);
  var DtAccountNum = "", CtAccountNum = "";
  var CatRetY = "";
  var Sum = 0;

  NettAccTrnArr.size = 0;
  ErrStr = "";

  if(CatCodeX == "")
    ErrStr = "Не найдена категория НДФЛ к перечислению для ставки " + TaxRateX + "%";
    return 1;
  end;

  if(CatCodeY == "")
    ErrStr = "Не найдена категория НДФЛ к перечислению для ставки " + TaxRateY + "%";
    return 1;
  end;

  if( not FD.OpenAccount(CatCodeX, null, false, null, accX, dat, NATCUR) )
    ErrStr = "Ошибка при определении счета по категории <"+CatCodeX+">.";
    return 1;
  end;

  if( not FD.OpenAccount(CatCodeY, null, false, null, accY, dat, NATCUR) )
    ErrStr = "Ошибка при определении счета по категории <"+CatCodeY+">.";
    return 1;
  end;

  if(accX.rec.Account == accY.rec.Account)
    return 0;
  end;

  RESTrate_Y = DL_GetRestAccount(accY.rec, dat);

  if(SCorr <= RESTrate_Y)
    Sum = SCorr;
    
    if( not ПроводкаПоКатегориямУчета( FD,
                                       accY, accX,
                                       dat,                           /* Дата */
                                       1,                             /* Глава */
                                       NATCUR,                        /* Валюта суммы проводки */
                                       Sum,                           /* Сумма проводки*/
                                       NULL,                          /* Документ */
                                       INPCARRY,                      /* Result_Carry */
                                       " 1",                          /* Kind_Oper */
                                       OpCode,                        /* Numb_Document */
                                       "Урегулирование НДФЛ между КБК <"+ClientShortName+">",             /* Ground */
                                       NULL, NULL, NULL, NULL, NULL, NULL,
                                       NULL, NULL, NULL, NULL, NULL, NULL,
                                       @DtAccountNum, @CtAccountNum
                                     )
      )
       ErrStr = "Ошибка при выполнении проводки";
       return 1;
    end;

    NettAccTrnArr[NettAccTrnArr.size] = NPTXNettAccTrnData(DtAccountNum, CtAccountNum, Sum);
  else
    Sum = RESTrate_Y;
    if( not ПроводкаПоКатегориямУчета( FD,
                                       accY, accX,
                                       dat,                           /* Дата */
                                       1,                             /* Глава */
                                       NATCUR,                        /* Валюта суммы проводки */
                                       Sum,                           /* Сумма проводки*/
                                       NULL,                          /* Документ */
                                       INPCARRY,                      /* Result_Carry */
                                       " 1",                          /* Kind_Oper */
                                       OpCode,                        /* Numb_Document */
                                       "Урегулирование НДФЛ между КБК <"+ClientShortName+">",             /* Ground */
                                       NULL, NULL, NULL, NULL, NULL, NULL,
                                       NULL, NULL, NULL, NULL, NULL, NULL,
                                       @DtAccountNum, @CtAccountNum
                                     )
      )
       ErrStr = "Ошибка при выполнении проводки";
       return 1;
    end;

    NettAccTrnArr[NettAccTrnArr.size] = NPTXNettAccTrnData(DtAccountNum, CtAccountNum, Sum);

    CatRetY = GetCatRetByRate(TaxRateY);

    if(CatRetY == "")
      ErrStr = "Не найдена категория НДФЛ к возврату для ставки " + TaxRateY + "%";
      return 1;
    end;

    if( not FD.OpenAccount(CatRetY, null, false, null, accRetY, dat, NATCUR) )
      ErrStr = "Ошибка при определении счета по категории <"+CatRetY+">.";
      return 1;
    end;

    Sum = SCorr-RESTrate_Y;

    if( not ПроводкаПоКатегориямУчета( FD,
                                       accRetY, accY,
                                       dat,                           /* Дата */
                                       1,                             /* Глава */
                                       NATCUR,                        /* Валюта суммы проводки */
                                       Sum,                           /* Сумма проводки*/
                                       NULL,                          /* Документ */
                                       INPCARRY,                      /* Result_Carry */
                                       " 1",                          /* Kind_Oper */
                                       OpCode,                        /* Numb_Document */
                                       "Урегулирование остатков на счетах 60301", /* Ground */
                                       NULL, NULL, NULL, NULL, NULL, NULL,
                                       NULL, NULL, NULL, NULL, NULL, NULL,
                                       @DtAccountNum, @CtAccountNum
                                     )
      )
       ErrStr = "Ошибка при выполнении проводки";
       return 1;
    end;

    NettAccTrnArr[NettAccTrnArr.size] = NPTXNettAccTrnData(DtAccountNum, CtAccountNum, Sum);
  end;

  return err;
END;


//Формировать объекты НДР по корректировке баланса на шаге операции
MACRO СоздатьНДРКоррБал(DocKind, DocID, ClientID, ID_Operation, ID_Step)
  var query, cmd, DataSet;
  var TaxObj = TInsertTaxObject();
  var ObjKind, ObjKind2;
  var Sum = $0;
  var err = 0;
  var AnaliticKind6 = 0, Analitic6 = -1;
  var nptxop = TBFile("nptxop.dbt");
  var ObjDocID = DocID;
  var isVeks = false;

  if(ВЫПОЛНЯТЬ_КОРРЕКТИРОВКУ_НДФЛ() == false)
    return 0;
  end;
  
  if((DocKind == DL_VEKSELDRAWORDER) or        
     (DocKind == DL_VSBARTERORDER) or
     (DocKind == DL_VSINTERCHANGE)
    )
    ObjDocID = ID_Operation;
    IsVeks = true;
  end;

  nptxop.Clear();

  nptxop.rec.ID = DocID;
  nptxop.GetEQ();

  query =   " select stb.* "
          + "   from dnptxtotalbase_dbt stb "
          + "  where stb.t_ClientID = ? "
          + "    and stb.t_DocKind = ? "
          + "    and stb.t_DocID = ? "
          + "    and stb.t_ID_Operation = ? "
          + "    and stb.t_TaxBaseCurrPay = 0 "
          + "    and stb.t_CalcPITax = 0 "
          + "    and stb.t_HoldPITax <> 0 "
          + "    and stb.t_OrigTBID = 0 "
          + "    and stb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and stb.t_Type IN (2,3) "
          + "  order by stb.t_TBID ASC ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ID_Operation);

  DataSet = cmd.Execute();

  while((not err) and (DataSet.moveNext()))
    ObjKind  = 0;
    ObjKind2 = 0;
    if(DataSet.BCCHoldPITax == NPTXKBK_MAIN) //КБК по основной ставке
      if(DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        ObjKind = TXOBJ_PAIDBILL;
      elif(DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
        ObjKind = TXOBJ_PAIDGENERAL;
      elif(DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
        ObjKind = TXOBJ_PAIDGENERAL_IIS;
      end;
    elif((DataSet.BCCHoldPITax == NPTXKBK_15) or (DataSet.BCCHoldPITax == NPTXKBK_INCR_218)) //КБК по повышенной ставке
      if(DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        ObjKind = TXOBJ_PAIDGENERAL_15;
        ObjKind2 = TXOBJ_PAIDGENERAL_15_9;
      elif(DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
        ObjKind = TXOBJ_PAIDGENERAL_15;
        ObjKind2 = TXOBJ_PAIDGENERAL_15_2;
      elif(DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
        ObjKind = TXOBJ_PAIDGENERAL_15_IIS;
      end;
    end;

    AnaliticKind6 = 0; 
    Analitic6 = -1;

    //if(DataSet.TaxBaseKind != NPTXTOTALBASE_TAXBASEKIND_ONB)
    //  AnaliticKind6 = TXOBJ_KIND6020;
    //  Analitic6 = GetPtContrIDForNDR(ClientID, date(DataSet.IncDate), IIF(DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS, 1, 0));
    //end;

    Sum = DataSet.HoldPITax;

    if(ObjKind)
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,ObjKind            // Вид НДР
                 ,Sum                // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,0                  // Вид аналитики 2
                 ,-1                 // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,DataSet.Description // Комментарий
                 ,ObjDocID              // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                );
    end;

    if(ObjKind2)
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,ObjKind2           // Вид НДР
                 ,Sum                // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,0                  // Вид аналитики 2
                 ,-1                 // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,DataSet.Description // Комментарий
                 ,ObjDocID           // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                );
    end;

    if((nptxop.rec.DocKind == DL_WRTMONEY) or ((nptxop.rec.DocKind == DL_HOLDNDFL) and (nptxop.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_PREHOLD))) //Доудержание
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,TXOBJ_DUETAX       // Вид НДР
                 ,-Sum               // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,0                  // Вид аналитики 2
                 ,-1                 // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,"Неуплаченный налог" // Комментарий
                 ,ObjDocID           // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                ); 
    end;
  end;

  if(not err)
    TaxObj.Save();
    err = DL_NPTX_StartInsertTaxObject(ObjDocID, ID_Step);
  end;

  return err;
END;

MACRO GetPaidNptxObjKindByTaxRate(KBK:string, TaxBaseKind:integer, TaxRate:integer, ObjKind:@integer, ObjKind2:@integer, SpecialTag, TaxPeriod)
  var query, cmd, DataSet;
  var ObjKindCode = "PaidGeneral_" + string(int(TaxRate));

  ObjKind  = 0;
  ObjKind2 = 0;

  if((TaxPeriod != NULL) and (TaxPeriod >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981()))
    if(TaxRate == int(100*NPTXGENTAXRATE_RESIDENT))
      if(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        ObjKind = TXOBJ_PAIDCOMP;
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
        if(SpecialTag == "МАТ")
          ObjKind  = TXOBJ_PAIDMATERIAL;
        elif(SpecialTag == "ВЕКС")
          ObjKind = TXOBJ_PAIDBILL;
        elif(SpecialTag == "БРОК")
          ObjKind = TXOBJ_PAIDGENERAL;
        else
          ObjKind = TXOBJ_PAIDGENERAL;
        end;
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
        ObjKind = TXOBJ_PAIDGENERAL_IIS;
      end;
    elif(TaxRate == int(100*NPTXGENTAXRATE_RESIDENT_15))
      if(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        ObjKind = TXOBJ_PAIDCOMP_15;
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
        if(SpecialTag == "МАТ")
          ObjKind  = TXOBJ_PAIDMATERIAL;
        elif(SpecialTag == "ВЕКС")
          ObjKind = TXOBJ_PAIDBILL;
        elif(SpecialTag == "БРОК")
          ObjKind = TXOBJ_PAIDGENERAL_15_2;
        else
          ObjKind = TXOBJ_PAIDGENERAL_15_2;
        end;
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
        ObjKind = TXOBJ_PAIDGENERAL_IIS;
      end;
    elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
      ObjKindCode = ObjKindCode + "_9";
      
      query = "select t_Element from dnptxkind_dbt where LOWER(t_Code) = LOWER(?)";
      cmd = DL_RSDCommand(query);

      cmd.AddParam(ObjKindCode);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        ObjKind = int(DataSet.Element);
      end;
    end;
  else
    if(KBK == NPTXKBK_MAIN) //КБК по основной ставке
      if(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        ObjKind = TXOBJ_PAIDBILL;
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
        ObjKind = TXOBJ_PAIDGENERAL;
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
        ObjKind = TXOBJ_PAIDGENERAL_IIS;
      end;
    else //КБК по повышенной ставке

      if(int(TaxRate) == int(100*NPTXGENTAXRATE_RESIDENT_15))
        query = "select t_Element from dnptxkind_dbt where LOWER(t_Code) = LOWER(?)";
        cmd = DL_RSDCommand(query);

        cmd.AddParam(ObjKindCode);

        DataSet = cmd.Execute();
        if(DataSet.moveNext())
          ObjKind2 = int(DataSet.Element);
        end;
      end;
    
      if(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        ObjKindCode = ObjKindCode + "_9";
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
        ObjKindCode = ObjKindCode + "_2";
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
        ObjKindCode = ObjKindCode + "_ИИС";
      end;

      query = "select t_Element from dnptxkind_dbt where LOWER(t_Code) = LOWER(?)";
      cmd = DL_RSDCommand(query);

      cmd.AddParam(ObjKindCode);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        ObjKind = int(DataSet.Element);
      end;
    end;
  
  end;
END;

//Формировать объекты НДР по корректировке баланса на шаге операции (по прогрессивной шкале)
MACRO СоздатьНДРКоррБал_ПРГС(DocKind, DocID, ClientID, ID_Operation, ID_Step)
  var query, cmd, DataSet;
  var TaxObj = TInsertTaxObject();
  var ObjKind, ObjKind2;
  var Sum = $0;
  var err = 0;
  var AnaliticKind6 = 0, Analitic6 = -1;
  var nptxop = TBFile("nptxop.dbt");
  var ObjDocID = DocID;
  var isVeks = false;

  if(ВЫПОЛНЯТЬ_КОРРЕКТИРОВКУ_НДФЛ() == false)
    return 0;
  end;
  
  if((DocKind == DL_VEKSELDRAWORDER) or        
     (DocKind == DL_VSBARTERORDER) or
     (DocKind == DL_VSINTERCHANGE)
    )
    ObjDocID = ID_Operation;
    IsVeks = true;
  end;

  nptxop.Clear();

  nptxop.rec.ID = DocID;
  nptxop.GetEQ();

  query =   " select stb.* "
          + "   from dnptxtotalbase_dbt stb "
          + "  where stb.t_ClientID = ? "
          + "    and stb.t_DocKind = ? "
          + "    and stb.t_DocID = ? "
          + "    and stb.t_ID_Operation = ? "
          + "    and stb.t_HoldPITax <> 0 "
          + "    and stb.t_OrigTBID = 0 "
          + "    and stb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and stb.t_Type IN (1,2,3) "
          + "    and stb.t_Symbol = 'C' "
          + "  order by stb.t_TBID ASC ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ID_Operation);

  DataSet = cmd.Execute();

  while((not err) and (DataSet.moveNext()))
    ObjKind  = 0;
    ObjKind2 = 0;

    GetPaidNptxObjKindByTaxRate(DataSet.BCCHoldPITax, DataSet.TaxBaseKind, DataSet.RateHoldPITax, @ObjKind, @ObjKind2, DataSet.SpecialTag, DataSet.TaxPeriod);

    AnaliticKind6 = 0; 
    Analitic6 = -1;

    Sum = DataSet.HoldPITax;

    if(ObjKind)
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,ObjKind            // Вид НДР
                 ,Sum                // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,TXOBJ_KIND2040     // Вид аналитики 2
                 ,int(substr(DataSet.BCCHoldPITax,8,3)) // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,DataSet.Description // Комментарий
                 ,ObjDocID              // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                );
    end;

    if(ObjKind2)
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,ObjKind2           // Вид НДР
                 ,Sum                // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,TXOBJ_KIND2040     // Вид аналитики 2
                 ,int(substr(DataSet.BCCHoldPITax,8,3)) // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,DataSet.Description // Комментарий
                 ,ObjDocID           // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                );
    end;

    if((DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK) and (DataSet.SpecialTag == "МАТ") and (DataSet.TaxPeriod >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981()))
      CreateDueMaterial(DocID, ClientID, date(DataSet.IncDate), DataSet.TaxPeriod, ID_Step, DataSet.BCCHoldPITax, Sum, @TaxObj);
    end;

    if((nptxop.rec.DocKind == DL_WRTMONEY) or ((nptxop.rec.DocKind == DL_HOLDNDFL) and (nptxop.rec.Subkind_Operation == DL_TXHOLD_OPTYPE_PREHOLD))) //Доудержание
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,TXOBJ_DUETAX       // Вид НДР
                 ,-Sum               // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,0                  // Вид аналитики 2
                 ,-1                 // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,"Неуплаченный налог" // Комментарий
                 ,ObjDocID           // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                ); 
    end;
  end;

  if(not err)
    TaxObj.Save();
    err = DL_NPTX_StartInsertTaxObject(ObjDocID, ID_Step);
  end;

  return err;
END;

MACRO УчестьКоррБалНДФЛ(FD, nptxop, ClientID, Taxe:@money, Taxe15:@money, AddTaxe:@money, AddTaxe15:@money, ErrStr:@string)
  var InitTaxe = Taxe;
  var InitTaxe15 = Taxe15;
  var CorrTaxBalMain = GetSumCorrBalInOp(nptxop.rec.DocKind, nptxop.rec.ID, ClientID, NPTXKBK_MAIN, IIF(nptxop.rec.IIS==SET_CHAR, true, false), false);
  var CorrTaxBal15   = GetSumCorrBalInOp(nptxop.rec.DocKind, nptxop.rec.ID, ClientID, NPTXKBK_15, IIF(nptxop.rec.IIS==SET_CHAR, true, false), false);
  var DecrTaxMain = $0, DecrTax15 = $0;
  var WrtMainTo15 = $0, Wrt15ToMain = $0;
  var err = 0;

  AddTaxe   = $0; 
  AddTaxe15 = $0;

  if(ВЫПОЛНЯТЬ_КОРРЕКТИРОВКУ_НДФЛ() == false)
    return 0;
  end;

  if((CorrTaxBalMain == 0) and (CorrTaxBal15 == 0))
    return 0;
  end;

  if(CorrTaxBalMain < 0)
    WrtMainTo15 = CorrTaxBalMain;
  end;

  if(CorrTaxBal15 < 0)
    Wrt15ToMain = CorrTaxBal15;
  end;

  if((CorrTaxBalMain >= 0) and (CorrTaxBal15 >= 0))
    //Значит только положительные
    //В этом случае просто возвращаем корректировки в качестве налога к доудержанию. Проводки и платежи формируются далее в каждом случае самостоятельно
    AddTaxe   = CorrTaxBalMain;
    AddTaxe15 = CorrTaxBal15;
  end; 
    
  if((WrtMainTo15 != 0) or (Wrt15ToMain != 0))
    err = ВыполнитьПроводкуЗачетаНДФЛ(FD, nptxop.rec.Code, ClientID, nptxop.rec.OperDate, WrtMainTo15, Wrt15ToMain, NULL, NULL, @ErrStr);
  end;

  return err;
END;



MACRO УчестьКоррБалНДФЛ_ПРГС(FD, nptxop, ClientID, AddTaxeArr:@TArray, ErrStr:@string)
  var SumCorrBalArr = TArray();
  var SumPlusCorrBalArr = TArray();
  var NettAccTrnArr = TArray();
  var AllCorrPlus = true;
  var err = 0;
  var i = 0;

  AddTaxeArr.size = $0; 

  if(ВЫПОЛНЯТЬ_КОРРЕКТИРОВКУ_НДФЛ() == false)
    return 0;
  end;

  GetSumCorrBalInOpPRGS(nptxop.rec.DocKind, nptxop.rec.ID, ClientID, IIF(nptxop.rec.IIS==SET_CHAR, true, false), false, @SumCorrBalArr);

  while(i < SumCorrBalArr.size)
    if(SumCorrBalArr[i].Налог > 0)
      AddTaxeArr[AddTaxeArr.size] = STB_TaxRateParm(SumCorrBalArr[i].Ставка,
                                                    $0, 
                                                    SumCorrBalArr[i].Налог,
                                                    SumCorrBalArr[i].КБК
                                                   );
    end;

    i = i + 1;
  end;

  if(SumCorrBalArr.size != AddTaxeArr.size) //Если помимо положительных корректировок есть отрицательные
    i = 0;
    while((i < SumCorrBalArr.size) and (not err))
      if(SumCorrBalArr[i].Налог < 0)
        var SCorr = $0;
        var j = 0;

        while((j < AddTaxeArr.size) and (not err))

          if(AddTaxeArr[j].Налог > 0)
            SCorr = min(abs(SumCorrBalArr[i].Налог), AddTaxeArr[j].Налог);

            err = ВыполнитьПроводкиЗачетаНДФЛ(FD, nptxop.rec.Code, ClientID, nptxop.rec.OperDate, AddTaxeArr[j].Ставка, SumCorrBalArr[i].Ставка, SCorr, @NettAccTrnArr, @ErrStr);

            AddTaxeArr[j].Налог = AddTaxeArr[j].Налог - SCorr;
          end;

          j = j + 1;
        end;

      end;

      i = i + 1;
    end;

    AddTaxeArr.size = 0;
  end;
 
  return err;
END;

//Формировать объекты НДР по удержанию НДФЛ на шаге операции (по прогрессивной шкале)
MACRO СоздатьНДРУдержания_ПРГС(DocKind, DocID, ClientID, ID_Operation, ID_Step, Taxe:@Money, Taxe15:@Money, AddTaxDp:@Money, AddHoldArr:@TArray)
  var query, cmd, DataSet;
  var TaxObj = TInsertTaxObject();
  var ObjKind, ObjKind2;
  var Sum = $0;
  var err = 0;
  var AnaliticKind6 = 0, Analitic6 = -1;
  var ObjDocID = DocID;
  var OutSystCode = "";

  Taxe   = $0;
  Taxe15 = $0;
  AddTaxDp = $0;
  AddHoldArr.size = 0;

  query =   " select stb.* "
          + "   from dnptxtotalbase_dbt stb "
          + "  where stb.t_clientid = ? "
          + "    and stb.t_dockind = ? "
          + "    and stb.t_docid = ? "
          + "    and stb.t_id_operation = ? "
          + "    and stb.t_taxbasecurrpay = 0 "
          + "    and stb.t_calcpitax = 0 "
          + "    and stb.t_holdpitax <> 0 "
          + "    and stb.t_origtbid = 0 "
          + "    and stb.t_storstate = " + NPTXTOTALBASE_STORSTATE_ACTIVE
          + "    and stb.t_symbol = 'H' "
          + "  order by stb.t_rateholdpitax asc ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(DocKind);
  cmd.AddParam(DocID);
  cmd.AddParam(ID_Operation);

  DataSet = cmd.Execute();

  while((not err) and (DataSet.moveNext()))
    ObjKind  = 0;
    ObjKind2 = 0;

    GetPaidNptxObjKindByTaxRate(DataSet.BCCHoldPITax, DataSet.TaxBaseKind, DataSet.RateHoldPITax, @ObjKind, @ObjKind2, DataSet.SpecialTag, DataSet.TaxPeriod);

    AnaliticKind6 = 0; 
    Analitic6 = -1;

    Sum = money(DataSet.HoldPITax);

    OutSystCode = IIF(DataSet.SysCome == 2, "ДЕПО", "");

    if(ObjKind)
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,ObjKind            // Вид НДР
                 ,Sum                // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,TXOBJ_KIND2040     // Вид аналитики 2
                 ,int(substr(DataSet.BCCHoldPITax,8,3)) // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,DataSet.Description // Комментарий
                 ,ObjDocID              // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                 ,NULL               // Technical
                 ,UNSET_CHAR         //FromOutSyst
                 ,OutSystCode        //OutSystCode
                );
    end;

    if(ObjKind2)
      TaxObj.Add( 1                             
                 ,date(DataSet.IncDate) // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                  // Уровень
                 ,""                 // Признак "Пользовательский"
                 ,ObjKind2           // Вид НДР
                 ,Sum                // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                  // Вид аналитики 1
                 ,-1                 // Аналитика 1
                 ,TXOBJ_KIND2040     // Вид аналитики 2
                 ,int(substr(DataSet.BCCHoldPITax,8,3)) // Аналитика 2
                 ,0                  // Вид аналитики 3
                 ,-1                 // Аналитика 3
                 ,0                  // Вид аналитики 4
                 ,-1                 // Аналитика 4
                 ,0                  // Вид аналитики 5
                 ,-1                 // Аналитика 5
                 ,AnaliticKind6      // Вид аналитики 6
                 ,Analitic6          // Аналитика 6
                 ,DataSet.Description // Комментарий
                 ,ObjDocID           // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                  // Признак вызова не из операции расчета НОБ
                 ,NULL               // Technical
                 ,UNSET_CHAR         //FromOutSyst
                 ,OutSystCode        //OutSystCode
                );
    end;

    if((DataSet.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK) and (DataSet.SpecialTag == "МАТ"))
      CreateDueMaterial(DocID, ClientID, date(DataSet.IncDate), DataSet.TaxPeriod, ID_Step, DataSet.BCCHoldPITax, Sum, @TaxObj);
    end;

    if(int(DataSet.RateHoldPITax) == int(NPTXGENTAXRATE_RESIDENT_15*100))
      Taxe15 = Taxe15 + money(DataSet.HoldPITax);
    elif( (int(DataSet.RateHoldPITax) == int(100*NPTXGENTAXRATE_RESIDENT)) or (int(DataSet.RateHoldPITax) == int(NPTXGENTAXRATE_NOTRESIDENT*100)) )
      Taxe = Taxe  + money(DataSet.HoldPITax);
    else
      AddHoldArr[AddHoldArr.size] = STB_TaxRateParm(int(DataSet.RateHoldPITax),
                                                    $0, 
                                                    money(DataSet.HoldPITax),
                                                    DataSet.BCCHoldPITax
                                                   );
    end;
  end;

  if(not err)
    TaxObj.Save();
    err = DL_NPTX_StartInsertTaxObject(ObjDocID, ID_Step);
  end;

  return err;
END;

CLASS CTaxCaclTotalPrm (_TaxHoldBrokDEPO,
                        _TaxHoldBrokSOFR,
                        _TaxHoldBrok,
                        _TaxHoldMaterial,
                        _TaxHoldBILL,
                        _TaxHoldONB,
                        _CodeKBK,
                        _Rate)
  var TaxHoldBrokDEPO = _TaxHoldBrokDEPO;
  var TaxHoldBrokSOFR = _TaxHoldBrokSOFR;
  var TaxHoldBrok     = _TaxHoldBrok;
  var TaxHoldMaterial = _TaxHoldMaterial;
  var TaxHoldBILL     = _TaxHoldBILL;
  var TaxHoldONB      = _TaxHoldONB;
  var CodeKBK         = _CodeKBK;
  var Rate            = _Rate;
END;

/**
  @brief Рассчет параметров для Функции расчета налога TaxeCalcFunction
  @param [in] ClientID Идентификатор клиента
  @param [in] TaxPeriod Налоговый период
  @param [in] TaxBaseKind Вид НОБ
  @param [in] SubKindOperation Вид расчета
*/
MACRO TaxeCalcFunctionPrm(ClientID:integer,
                          TaxPeriod:integer,
                          TaxBaseKind:integer,
                          SubKindOperation:integer)
  var cmd;
  
  cmd = RSDCommand("CALL RSI_NPTX.TaxeCalcFunctionPrm(?,?,?,?)");

  cmd.addParam( "", RSDBP_IN, ClientID );
  cmd.addParam( "", RSDBP_IN, TaxPeriod );
  cmd.addParam( "", RSDBP_IN, TaxBaseKind );
  cmd.addParam( "", RSDBP_IN, SubKindOperation );

  cmd.execute();
END;

/**
  @brief Проверка необходимости действий при удержании
  @param [in] CalcParams Массив параметров CTaxCaclTotalPrm
  @return 1 - Необходим зачет, 2 - Необходим возврат, 3 - Необходимо удержание 
*/
MACRO ПроверитьНеобходимостьЗачетаПереплаты(CalcParams:@TArray)
  var i = 0;
  var hasPlusBal = false;
  var hasMinusBal = false;

  while(CalcParams.size > i)
    if( (CalcParams[i].TaxHoldBrokDEPO > 0) or 
        (CalcParams[i].TaxHoldBrokSOFR > 0) or 
        (CalcParams[i].TaxHoldMaterial > 0) or 
        (CalcParams[i].TaxHoldBILL > 0) or 
        (CalcParams[i].TaxHoldONB > 0)
      )
      hasPlusBal = true;
    end;
    
    if( (CalcParams[i].TaxHoldBrokDEPO < 0) or 
          (CalcParams[i].TaxHoldBrokSOFR < 0) or 
          (CalcParams[i].TaxHoldMaterial < 0) or 
          (CalcParams[i].TaxHoldBILL < 0) or 
          (CalcParams[i].TaxHoldONB < 0)
        )
      hasMinusBal = true;
    end;
      i = i + 1;
  end;
    
  if(hasPlusBal and hasMinusBal)
    return 1;
  elif(hasMinusBal)
    return 2;
  else
    return 3;
  end;
END;

class TBCCBalanceData(_BCCPITax, _TaxRate, _TaxBaseKind, _Balance, _IsDepo, _SpecTag, _Prior)
  var BCCPITax      = _BCCPITax;
  var TaxRate       = _TaxRate;  
  var TaxBaseKind   = _TaxBaseKind;
  var Balance       = _Balance;
  var IsDepo        = _IsDepo;
  var SpecTag       = _SpecTag;
  var Prior         = _Prior;
end;

class TBCCBalanceAllData(_BCCPITax, _TaxRate, _TaxBaseKind, _IsDepo, _BCCPITax2, _TaxRate2, _TaxBaseKind2, _IsDepo2, _Balance, _SpecTag, _SpecTag2, _Prior, _Prior2)
  var PlusBal  = TBCCBalanceData(_BCCPITax, _TaxRate, _TaxBaseKind, _Balance, _IsDepo, _SpecTag, _Prior);
  var MinusBal = TBCCBalanceData(_BCCPITax2, _TaxRate2, _TaxBaseKind2, -1*_Balance, _IsDepo2, _SpecTag2, _Prior2);
end;

class TDeltaBalanceCollect()
  var m_DeltaBalanceArr = TArray();

  macro findSum(_BCCPITax, _TaxBaseKind, _IsDepo, _SpecTag)
    var i = 0;
    var sum = $0.0;

    while(i < m_DeltaBalanceArr.size)
      if((m_DeltaBalanceArr[i].PlusBal.BCCPITax == _BCCPITax) and (m_DeltaBalanceArr[i].PlusBal.TaxBaseKind == _TaxBaseKind) and (m_DeltaBalanceArr[i].PlusBal.IsDepo == _IsDepo) and (m_DeltaBalanceArr[i].PlusBal.SpecTag == _SpecTag))
        sum = sum + m_DeltaBalanceArr[i].PlusBal.Balance;
      end;
      if((m_DeltaBalanceArr[i].MinusBal.BCCPITax == _BCCPITax) and (m_DeltaBalanceArr[i].MinusBal.TaxBaseKind == _TaxBaseKind) and (m_DeltaBalanceArr[i].MinusBal.IsDepo == _IsDepo) and (m_DeltaBalanceArr[i].MinusBal.SpecTag == _SpecTag))
        sum = sum + m_DeltaBalanceArr[i].MinusBal.Balance;
      end;
      i = i + 1;
    end;

    return sum; 
  end;

  macro AddAll(_BCCPITax, _TaxRate, _TaxBaseKind, _IsDepo, _BCCPITax2, _TaxRate2, _TaxBaseKind2, _IsDepo2, _Balance, _SpecTag, _SpecTag2, _Prior, _Prior2)
    m_DeltaBalanceArr[m_DeltaBalanceArr.size] = TBCCBalanceAllData(_BCCPITax, _TaxRate, _TaxBaseKind, _IsDepo, _BCCPITax2, _TaxRate2, _TaxBaseKind2, _IsDepo2, _Balance, _SpecTag, _SpecTag2, _Prior, _Prior2);
  end;
end;

/**
  @brief Выполнить зачет переплаты
  @param [in] CalcParams Массив параметров CTaxCaclTotalPrm
  @param [in] ID_Step Номер шага
  @param [in] ID_Operation Идентификатор операции
  @param [in] Oper Объект NPTXOP операции 
*/
PRIVATE MACRO ВыполнитьЗачетПереплаты(CalcParams, ID_Operation, ID_Step, Oper)
  var BalancePlusArr  = TArray();
  var BalanceMinusArr = TArray();
  var SumBalancePlus = $0;
  var SumBalanceMinus = $0;
  var SumOffset = $0;
  var DeltaBalance = NULL;
  var TxArr = TArray();
  var i = 0;
  var err = 0;
  var ObjKind = 0, ObjKind2 = 0;
  var OutSystCode = "";
  var OutSystCode2 = "";
  var Rate = 0;
  var Sum = 0;
  var TaxPeriod = 0;
  var ErrStr = "";
  var DeltaS = 0;
  var FD = DLFirstDocNPTXOP(Oper);
  var IsClientResident = STB_IsResidentStatus(STB_GetClientTaxPayerStatus(Oper.rec.Client));
  var TaxObj = TInsertTaxObject();
  var PriorNDFLobj = CPriorNDFL();
  
  datesplit(Oper.rec.PrevDate, null, null, TaxPeriod);
  
  macro SortByPrior(left:Variant, right:Variant, data:Variant)
    return IIF(left.Prior > right.Prior, 1, (IIF(left.Prior < right.Prior, -1, 0)));
  end;
  
  macro AddValueToBalArr(BCCPITax, TaxRate, TaxBaseKind, IsDepo, Balance, SpecTag)
    if(Balance > 0)
      BalancePlusArr[BalancePlusArr.size] = TBCCBalanceData(BCCPITax, TaxRate, TaxBaseKind, Balance, IsDepo, SpecTag, PriorNDFLobj.getPriorForObj(TaxRate, TaxBaseKind, SpecTag, IIF(IsDepo, 2, 1), BCCPITax));
      SumBalancePlus = SumBalancePlus + Balance;
    elif(Balance < 0)
      BalanceMinusArr[BalanceMinusArr.size] = TBCCBalanceData(BCCPITax, TaxRate, TaxBaseKind, Balance, IsDepo, SpecTag, PriorNDFLobj.getPriorForObj(TaxRate, TaxBaseKind, SpecTag, IIF(IsDepo, 2, 1), BCCPITax));
      SumBalanceMinus = SumBalanceMinus + abs(Balance);
    end;
  end;

  private macro ClearZeroBalance(BalanceArr:@TArray)
    var arr = TArray();
    var i = 0;

    while(i < BalanceArr.size)
      if(BalanceArr[i].Balance != 0)
        arr[arr.size] = BalanceArr[i];
      end;

      i = i + 1;
    end;

    BalanceArr = TArray(arr);
  end;

  private macro CreateTaxObjForBal(TaxObj:@TInsertTaxObject, Bal:@TBCCBalanceData, dat:date, ClientID:integer, NpTxOpID:integer, ID_Step:integer, OutSystCode, ObjKind:@integer, ObjKind2:@integer)
    var query, cmd, DataSet;
    var ObjKindCode = "";
    var TaxPeriod = 0;
    
    datesplit(dat, null, null, TaxPeriod);
 
    ObjKind  = 0; 
    ObjKind2 = 0;

    GetPaidNptxObjKindByTaxRate(Bal.BCCPITax, Bal.TaxBaseKind, Bal.TaxRate, @ObjKind, @ObjKind2, Bal.SpecTag, TaxPeriod);

    if(ObjKind)
      TaxObj.Add( 1                             
                 ,dat                  // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                    // Уровень
                 ,""                   // Признак "Пользовательский"
                 ,ObjKind            // Вид НДР
                 ,Bal.Balance        // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                    // Вид аналитики 1
                 ,-1                   // Аналитика 1
                 ,TXOBJ_KIND2040     // Вид аналитики 2
                 ,int(substr(Bal.BCCPITax,8,3))       // Аналитика 2
                 ,0                    // Вид аналитики 3
                 ,-1                   // Аналитика 3
                 ,0                    // Вид аналитики 4
                 ,-1                   // Аналитика 4
                 ,0                    // Вид аналитики 5
                 ,-1                   // Аналитика 5
                 ,0                    // Вид аналитики 6
                 ,-1                   // Аналитика 6
                 ,"Объект, созданный при зачете удержанного НДФЛ в операции удержания при окончании года" // Комментарий
                 ,NpTxOpID           // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                    // Признак вызова не из операции расчета НОБ
                 ,UNSET_CHAR         // Технический
                 ,UNSET_CHAR         // Признак внешней системы
                 ,OutSystCode        // Код внешней системы
                 ,""                   // ID во внешней системе
              );
    end;

    if(ObjKind2)
      TaxObj.Add( 1                               
                 ,dat                  // Дата НДР
                 ,ClientID           // Клиент
                 ,TXOBJ_DIR_OUT      // Направление
                 ,8                    // Уровень
                 ,""                   // Признак "Пользовательский"
                 ,ObjKind2           // Вид НДР
                 ,Bal.Balance        // Сумма дохода/расхода
                 ,NATCUR             // Валюта дохода/расхода
                 ,0                    // Вид аналитики 1
                 ,-1                   // Аналитика 1
                 ,TXOBJ_KIND2040     // Вид аналитики 2
                 ,int(substr(Bal.BCCPITax,8,3))       // Аналитика 2
                 ,0                    // Вид аналитики 3
                 ,-1                   // Аналитика 3
                 ,0                    // Вид аналитики 4
                 ,-1                   // Аналитика 4
                 ,0                    // Вид аналитики 5
                 ,-1                   // Аналитика 5
                 ,0                    // Вид аналитики 6
                 ,-1                   // Аналитика 6
                 ,"Объект, созданный при зачете удержанного НДФЛ в операции удержания при окончании года" // Комментарий
                 ,NpTxOpID           // ID операции
                 ,ID_Step            // ID шага операции
                 ,1                    // Признак вызова не из операции расчета НОБ
                 ,UNSET_CHAR         // Технический
                 ,UNSET_CHAR         // Признак внешней системы
                 ,OutSystCode        // Код внешней системы
                 ,""                   // ID во внешней системе
              );
    end;
    
    if((Bal.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK) and (Bal.SpecTag == "МАТ") and (TaxPeriod >= НП_ВВОДА_ДОРАБОТОК_BOSS_2981()))
      CreateDueMaterial(NpTxOpID, ClientID, dat, TaxPeriod, ID_Step, Bal.BCCPITax, Bal.Balance, @TaxObj);
    end;
  END;

  macro CorrValueByDeltaBal(BCCPITax, TaxBaseKind, IsDepo, Val:@money, SpecTag)
    var sumVal = 0;
    if(DeltaBalance.m_DeltaBalanceArr.size > 0)
      sumVal = DeltaBalance.findSum(BCCPITax, TaxBaseKind, IsDepo, SpecTag);
      Val = Val - sumVal;
    end;
  end;

  i = 0;

  while(i < CalcParams.size)
    AddValueToBalArr(CalcParams[i].CodeKBK, CalcParams[i].Rate, NPTXTOTALBASE_TAXBASEKIND_BROK,  true,  CalcParams[i].TaxHoldBrokDEPO, "БРОК");
    AddValueToBalArr(CalcParams[i].CodeKBK, CalcParams[i].Rate, NPTXTOTALBASE_TAXBASEKIND_BROK,  false, CalcParams[i].TaxHoldBrokSOFR, "БРОК");
    AddValueToBalArr(CalcParams[i].CodeKBK, CalcParams[i].Rate, NPTXTOTALBASE_TAXBASEKIND_BROK,  false, CalcParams[i].TaxHoldMaterial, "МАТ");
    AddValueToBalArr(CalcParams[i].CodeKBK, CalcParams[i].Rate, NPTXTOTALBASE_TAXBASEKIND_BROK,  false, CalcParams[i].TaxHoldBILL,     "ВЕКС");
    AddValueToBalArr(CalcParams[i].CodeKBK, CalcParams[i].Rate, NPTXTOTALBASE_TAXBASEKIND_ONB,   false, CalcParams[i].TaxHoldONB,      "");
     
    i = i + 1;
  end;

  ClearZeroBalance(@BalancePlusArr);
  ClearZeroBalance(@BalanceMinusArr);

  BalancePlusArr.sort(@SortByPrior);
  BalanceMinusArr.sort(@SortByPrior);

  SumOffset = min(SumBalancePlus, SumBalanceMinus);

  DeltaBalance = TDeltaBalanceCollect();

  while(SumOffset != 0)
    if((BalancePlusArr.size == 0) or (BalanceMinusArr.size == 0))
      break;
    end;

    //Работаем всегда только с первыми элементами массивов, так как далее мы уменьшаем в них баланс, а затем элементы с нулевым балансом вычищаем
    DeltaS = min(abs(BalancePlusArr[0].Balance), abs(BalanceMinusArr[0].Balance));

    BalancePlusArr[0].Balance = BalancePlusArr[0].Balance - DeltaS;
    BalanceMinusArr[0].Balance = BalanceMinusArr[0].Balance + DeltaS;
    DeltaBalance.addAll(BalancePlusArr[0].BCCPITax, BalancePlusArr[0].TaxRate, BalancePlusArr[0].TaxBaseKind, BalancePlusArr[0].IsDepo, 
                        BalanceMinusArr[0].BCCPITax, BalanceMinusArr[0].TaxRate, BalanceMinusArr[0].TaxBaseKind, BalanceMinusArr[0].IsDepo, DeltaS, 
                        BalancePlusArr[0].SpecTag, BalanceMinusArr[0].SpecTag, BalancePlusArr[0].Prior, BalanceMinusArr[0].Prior);

    SumOffset = SumOffset - DeltaS;

    ClearZeroBalance(@BalancePlusArr);
    ClearZeroBalance(@BalanceMinusArr);
  end;

  if(DeltaBalance.m_DeltaBalanceArr.size > 0)
    var SCorr = $0;

    i = 0;
    while((not err) and (i < DeltaBalance.m_DeltaBalanceArr.size))
      var CatCode1 = GetCatTransfByRate(DeltaBalance.m_DeltaBalanceArr[i].PlusBal.TaxRate);
      var CatCode2 = GetCatTransfByRate(DeltaBalance.m_DeltaBalanceArr[i].MinusBal.TaxRate);
      var NettAccTrnArr = TArray();
      var AccTrnInd = TArray();

      if(CatCode1 != CatCode2)
        if(DeltaBalance.m_DeltaBalanceArr[i].PlusBal.Balance != 0)
          SCorr = DeltaBalance.m_DeltaBalanceArr[i].PlusBal.Balance;

          if(0 != ВыполнитьПроводкиЗачетаНДФЛ(FD, 
                                              Oper.rec.Code, 
                                              Oper.rec.Client, 
                                              Oper.rec.OperDate,
                                              DeltaBalance.m_DeltaBalanceArr[i].PlusBal.TaxRate,
                                              DeltaBalance.m_DeltaBalanceArr[i].MinusBal.TaxRate, 
                                              SCorr, 
                                              @NettAccTrnArr, 
                                              @ErrStr
                                             ))
            return Error(ErrStr);
          end;
        end;
      end;

      //Формируем объект НДР
      ObjKind  = 0;
      ObjKind2 = 0;

      OutSystCode = "";
      OutSystCode2 = "";

      if(DeltaBalance.m_DeltaBalanceArr[i].PlusBal.IsDepo)
        OutSystCode = "ДЕПО";
      end;

      if(DeltaBalance.m_DeltaBalanceArr[i].MinusBal.IsDepo)
        OutSystCode2 = "ДЕПО";
      end;

      CreateTaxObjForBal(@TaxObj, DeltaBalance.m_DeltaBalanceArr[i].PlusBal, Oper.rec.OperDate, Oper.rec.Client, Oper.rec.ID, ID_Step, OutSystCode, @ObjKind, @ObjKind2);
      CreateTaxObjForBal(@TaxObj, DeltaBalance.m_DeltaBalanceArr[i].MinusBal, Oper.rec.OperDate, Oper.rec.Client, Oper.rec.ID, ID_Step, OutSystCode2, @ObjKind, @ObjKind2);

      //Для событий СНОБ
      TxArr.size = 0;
      TxArr[TxArr.size] = STB_TaxRateParm(DeltaBalance.m_DeltaBalanceArr[i].PlusBal.TaxRate, $0, DeltaBalance.m_DeltaBalanceArr[i].PlusBal.Balance, DeltaBalance.m_DeltaBalanceArr[i].PlusBal.BCCPITax, NULL, NULL, NULL, NULL, NULL, NULL, NULL, DeltaBalance.m_DeltaBalanceArr[i].PlusBal.SpecTag);

      err = STB_ExecuteCreateSTBOnStep(TxArr,
                                       $0, 
                                       Oper.rec.DocKind, 
                                       Oper.rec.ID, 
                                       Oper.rec.Client, 
                                       Oper.rec.OperDate, 
                                       IIF(DeltaBalance.m_DeltaBalanceArr[i].PlusBal.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS, true, false), 
                                       TaxPeriod, 
                                       ID_Operation, 
                                       ID_Step, 
                                       @ErrStr,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       NULL,
                                       DeltaBalance.m_DeltaBalanceArr[i].PlusBal.TaxBaseKind,
                                       IIF(DeltaBalance.m_DeltaBalanceArr[i].PlusBal.IsDepo, "Диасофт. ", "")+"Урегулирование НДФЛ между КБК",
                                       3 /*Зачет переплаты*/);


      if(ErrStr)
        err = Error(ErrStr);
      end;

      if(not err)
        TxArr.size = 0;
        TxArr[TxArr.size] = STB_TaxRateParm(DeltaBalance.m_DeltaBalanceArr[i].MinusBal.TaxRate, $0, DeltaBalance.m_DeltaBalanceArr[i].MinusBal.Balance, DeltaBalance.m_DeltaBalanceArr[i].MinusBal.BCCPITax, NULL, NULL, NULL, NULL, NULL, NULL, NULL, DeltaBalance.m_DeltaBalanceArr[i].MinusBal.SpecTag);

        err = STB_ExecuteCreateSTBOnStep(TxArr,
                                         $0, 
                                         Oper.rec.DocKind, 
                                         Oper.rec.ID, 
                                         Oper.rec.Client, 
                                         Oper.rec.OperDate, 
                                         IIF(DeltaBalance.m_DeltaBalanceArr[i].MinusBal.TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS, true, false), 
                                         TaxPeriod, 
                                         ID_Operation, 
                                         ID_Step, 
                                         @ErrStr,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         NULL,
                                         DeltaBalance.m_DeltaBalanceArr[i].MinusBal.TaxBaseKind,
                                         IIF(DeltaBalance.m_DeltaBalanceArr[i].MinusBal.IsDepo, "Диасофт. ", "")+"Урегулирование НДФЛ между КБК",
                                         3 /*Зачет переплаты*/);

        if(ErrStr)
          err = Error(ErrStr);
        end;
      end;

      if(not err)
        TaxObj.Save();

        err = DL_NPTX_StartInsertTaxObject(Oper.rec.ID, ID_Step);
      end;

      i = i + 1;
    end;
  end;

  i = 0;
  while(i < CalcParams.size)
    CorrValueByDeltaBal(CalcParams[i].CodeKBK, NPTXTOTALBASE_TAXBASEKIND_BROK,  true,  @CalcParams[i].TaxHoldBrokDEPO, "БРОК"    );
    CorrValueByDeltaBal(CalcParams[i].CodeKBK, NPTXTOTALBASE_TAXBASEKIND_BROK,  false, @CalcParams[i].TaxHoldBrokSOFR, "БРОК");
    CorrValueByDeltaBal(CalcParams[i].CodeKBK, NPTXTOTALBASE_TAXBASEKIND_BROK,  false, @CalcParams[i].TaxHoldMaterial, "МАТ"); 
    CorrValueByDeltaBal(CalcParams[i].CodeKBK, NPTXTOTALBASE_TAXBASEKIND_BROK,  false, @CalcParams[i].TaxHoldBILL,     "ВЕКС"); 
    CorrValueByDeltaBal(CalcParams[i].CodeKBK, NPTXTOTALBASE_TAXBASEKIND_ONB,   false, @CalcParams[i].TaxHoldONB,      ""); 
    
    i = i + 1;
  end;

  return err;
END;

/**
  @brief Универсальная функция расчета налога
  @param [in] ClientID Идентификатор клиента
  @param [in] TaxPeriod Налоговый период
  @param [in] TaxBaseKind Вид НОБ
  @param [in] ID_Step Номер шага
  @param [in] ID_Operation Идентификатор операции
  @param [in] Oper Объект NPTXOP операции 
  @param [in] TaxHoldArr Массив параметров CTaxCaclTotalPrm
*/
MACRO TaxeCalcFunction(_ClientID, _TaxPeriod, _TaxBaseKind, _ID_Step, _ID_Operation, _Oper, _TaxHoldArr:@TArray)
  var query, cmd, DataSet;
  var check = 0;
  var TaxHoldArr  = _TaxHoldArr;// массивы передаются по ссылке
  var ClientID    = _ClientID;
  var TaxPeriod   = _TaxPeriod;
  var TaxBaseKind = _TaxBaseKind;
  var ID_Step     = _ID_Step;
  var ID_Operation = _ID_Operation;
  var Oper = TRecHandler("nptxop.dbt");
  
  Copy(Oper, _Oper);
  
  private macro loadCaclTotal()
    TaxHoldArr.size = 0;
  
    TaxeCalcFunctionPrm(ClientID,
                        TaxPeriod,
                        TaxBaseKind,
                        Oper.rec.SubKind_Operation);
  
    query = " select * from dtaxcalctotal_tmp order by t_Rate ASC, t_CodeKBK ASC";
    cmd = DL_RSDCommand(query);
    DataSet = cmd.Execute();
  
    while(DataSet.moveNext())
      TaxHoldArr[TaxHoldArr.size] = CTaxCaclTotalPrm (DataSet.TaxHoldBrokDEPO,
                                                      DataSet.TaxHoldBrokSOFR,
                                                      DataSet.TaxHoldBrok,
                                                      DataSet.TaxHoldMaterial,
                                                      DataSet.TaxHoldBILL,
                                                      DataSet.TaxHoldONB,
                                                      DataSet.CodeKBK,
                                                      DataSet.Rate);
    end;
  end;

  loadCaclTotal();
    
  check = ПроверитьНеобходимостьЗачетаПереплаты(TaxHoldArr);
  
  if(check == 1)
    ВыполнитьЗачетПереплаты(TaxHoldArr, ID_Operation, ID_Step, Oper);
  end;
END;

