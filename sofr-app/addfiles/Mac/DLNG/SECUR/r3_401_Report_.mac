/*******************************************************************************
 DESCRIPTION  :   Отчет "Расшифровка 401 Сделки ПФИ, кроме сделок с ценными бумагами"
 PROGRAMMED BY:   Сагиян С.Г.
 CREATION DATE:    19.02.2019
*******************************************************************************/
IMPORT "spCache.mac", "r3_401_form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "cb_sql.mac", "sprepfun.mac", "oralib", "MoCommon.mac","ws_txreportform.mac";;
//import "sccomiss.mac", "spRepFun.mac"

PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR   OD1_Form;
PRIVATE VAR   OD1_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб

PRIVATE VAR   NFinRez;
PRIVATE VAR   NNDFL;

PRIVATE VAR ReportHeader = " \n"; 
                                                                                                                                                                                                                                                                                                                             
PRIVATE VAR TableHeader = " \n"; 

                                                                                                                                    
PRIVATE CLASS (DL_CReportTemplate) SP_OD1_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  PRIVATE VAR F0_6, F0_9, F0_11; /*суммы строки "Итого"*/
  PRIVATE VAR m_TotalAmountPoint = 0;
  PRIVATE VAR v_account = "";
  var RS, RS1, RSACC;
  VAR RepDate, BeginDate, EndDate;
  var v_tr_fi, v_ob_fi, v_tr_acc, v_ob_acc, v_tr_amount, v_ob_amount;
  var v_rate_dol, v_date_dol;
  var v_plus_pfi, v_minus_pfi, v_oborot_plus, v_oborot_minus;

  VAR v_Acc;
  VAR l_ratedate, l_rateval;
  
  VAR         ProgressValue = CTxProgressValue();

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
/* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END;
  
  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintLine( P1,P2,P3,P4,P5,P6,P7,P8,P9,P10,P11,P12,P13,P14,P15,P16,P17,P18,P19,P20,P21,P22 )

     this.PrintTableLine( 

          /*1 */     "DealNom",      	P1  , null, 
          /*2 */     "DealKind",       	P2  , null, 
          /*3 */     "DealType",      	P3  , null, 
          /*4 */     "FiKind",      	P4  , null, 
          /*5 */     "Contractor",      P5  , null, 
          /*6 */     "ContrCou",    	P6  , null, 
          /*7 */     "ContrType",      	P7  , null, 
          /*8 */     "OpenDate",     	P8  , null, 
          /*9 */     "CloseDate",       P9  , null,
          /*10*/     "TrAcc",          	P10 , null,
          /*11*/     "TrVal",      	P11 , null,
          /*12*/     "TrAmount",     	P12 , null,
          /*13*/     "ObAcc",        	P13 , null,
          /*14*/     "ObVal",        	P14 , null,
          /*15*/     "ObAmount",        P15 , null,
          /*16*/     "PromSum1",        P16 , null,
          /*17*/     "PromSum2",        P17 , null,
          /*18*/     "BreakDate",     	P18 , null,
          /*19*/     "PromSum3",        P19 , null,
          /*20*/     "Rate1",     	P20 , null,
          /*21*/     "Rate2",     	P21 , null,
          /*22*/     "Rate3",     	P22 , null
       );      

  END;




  PRIVATE MACRO BeginReport()

     VAR AvrKindShowValue = "";

     this.SetActiveSheet( "Лист1" );
     
     VAR cmd1, rs1, cmdacc, rsacc;


     cmd1 = RSDCommand("select to_char(d,'dd.mm.yyyy') begindate, to_char(d + interval '1' month - interval '1' day, 'dd.mm.yyyy') enddate from  (select  to_date( '01.'|| to_char( ? , 'mm.yyyy'), 'dd.mm.yyyy') d from dual)");
     cmd1.AddParam( "", RSDBP_IN, OD1_Form.GetFieldValue( PNFLD_OD1_DATE ) );	  
     RS1 = TRsbDataSet( cmd1 );
     RS1.MoveNext;
     BeginDate = RS1.BeginDate;
     EndDate = RS1.EndDate;


                               

     this.PrintFormatString( ReportHeader,
                     "H0_1"  , BeginDate + " - " + EndDate 
                   );


     this.RegisterTable( "MainTable", "",

          /*1 */     "DealNom",      	
          /*2 */     "DealKind",       	
          /*3 */     "DealType",      	
          /*4 */     "FiKind",      	
          /*5 */     "Contractor",      
          /*6 */     "ContrCou",    	
          /*7 */     "ContrType",      	
          /*8 */     "OpenDate",     	
          /*9 */     "CloseDate",       
          /*10*/     "TrAcc",          	
          /*11*/     "TrVal",      	
          /*12*/     "TrAmount",     	
          /*13*/     "ObAcc",        	
          /*14*/     "ObVal",        	
          /*15*/     "ObAmount",        
          /*16*/     "PromSum1",        
          /*17*/     "PromSum2",        
          /*18*/     "BreakDate",     	
          /*19*/     "PromSum3",        
          /*20*/     "Rate1",     	
          /*21*/     "Rate2",     	
          /*22*/     "Rate3"

       );      

  END;

  MACRO ПечататьПромежуточныеИтоги()
/*
     SetSubtotal(12, 11 + MAXROWSHEET,
                 "K8",    
                 "S8"
                 );
*/
  END;

  PRIVATE MACRO EndReport()
     this.EndTable();
     ПечататьПромежуточныеИтоги();
//     this.AddStandardFooter( "" );
  END;



  PRIVATE MACRO DealNom
     return rs.dealcode;
  END;

  PRIVATE MACRO DealKind
	return "ПФИ";
  END;

  PRIVATE MACRO DealType
	return rs.dealtype;
  END;

  PRIVATE MACRO FiKind
	return rs.dealkind;
  END;

  PRIVATE MACRO Contractor
	return rs.Contractor;
  END;

  PRIVATE MACRO ContrCou
	return rs.ContrCou;
  END;

  PRIVATE MACRO ContrType
     VAR cmd1, rs1;
     cmd1 = RSDCommand("select 1 from dpartyown_dbt where t_partyid=? and t_partykind=2");
     cmd1.AddParam( "", RSDBP_IN, rs.ContrPartyID );	  
     RS1 = TRsbDataSet( cmd1 );
     IF (RS1.MoveNext)
		return "Банк";
     else
		return "ЮЛ";
     end;
  END;

  PRIVATE MACRO FindAcc(v_dealid, fi1, fi2)
     VAR cmd1 ;
     cmd1 = RSDCommand("select     acc1.t_account TrAcc,    acc2.t_account ObAcc,   acc1val.t_fi_code TrVal,   acc2val.t_fi_code ObVal "+
			"from    dmcaccdoc_dbt acc1,     dmcaccdoc_dbt acc2,      dfininstr_dbt acc1val,      dfininstr_dbt acc2val "+
			"where acc1.t_docid=?  and acc2.t_docid=acc1.t_docid   and acc1.t_dockind=199      and acc2.t_dockind=199    and ACC1.T_CATNUM=1224     and ACC2.T_CATNUM=1225      and ACC1.T_CURRENCY=acc1val.t_fiid         and ACC2.T_CURRENCY=acc2val.t_fiid " +
			"and acc1.t_disablingdate=to_date('01.01.0001','dd.mm.yyyy') and acc2.t_disablingdate=to_date('01.01.0001','dd.mm.yyyy') and acc1.t_currency=? and acc2.t_currency=? ");

     cmd1.AddParam( "", RSDBP_IN, v_dealid );	  
     cmd1.AddParam( "", RSDBP_IN, fi1 );
     cmd1.AddParam( "", RSDBP_IN, fi2 );
     RSACC = TRsbDataSet( cmd1 );
     RSACC.MoveNext;
  END;


  PRIVATE MACRO OpenDate
	return rs.OpenDate;
  END;

  PRIVATE MACRO CloseDate
        var Clop;
	if (rs.ExecDate2 != "01.01.0001")
		Clop = max(rs.PayDate2, rs.SuplDate2);
		if (Clop != "01.01.0001") 
			return Clop;
		else 
			return rs.ExecDate2;
		end;
	else 
		Clop = max(rs.PayDate1, rs.SuplDate1);
		if (Clop != "01.01.0001") 
			return Clop;
		else 
			return rs.ExecDate1;
		end;
	end;
  END;

  PRIVATE MACRO BreakDate
	return "";
  END;

  PRIVATE MACRO TrAcc
	return rsacc.TrAcc;
  END;

  PRIVATE MACRO TrVal
	return rsacc.TrVal;
  END;

  PRIVATE MACRO TrAmount
	return v_tr_amount;
  END;

  PRIVATE MACRO ObAcc
	return rsacc.ObAcc;
  END;

  PRIVATE MACRO ObVal
	return rsacc.ObVal;
  END;

  PRIVATE MACRO ObAmount
	return v_ob_amount;
  END;

  PRIVATE MACRO PromSum1
	return 0;
  END;

  PRIVATE MACRO PromSum2
	return 0;
  END;

  PRIVATE MACRO PromSum3
	return 0;
  END;

  PRIVATE MACRO Rate2
     VAR query1, cmd1, rs1, cmd2, rs2, dclop, rest;
/*
     cmd1 = RSDCommand("SELECT t_sum_payer RetVal FROM DACCTRN_DBT WHERE t_account_payer like '61210%'  and substr(t_account_receiver,1,5) in ('52601') and T_GROUND like ? and t_date_carry between ? and ?");
     cmd1.AddParam( "", RSDBP_IN, "% "+rs.DealCode+"%" );	  
     cmd1.AddParam( "", RSDBP_IN, BeginDate );	  
     cmd1.AddParam( "", RSDBP_IN, EndDate );	  
     
     RS1 = TRsbDataSet( cmd1 );
     IF (RS1.MoveNext)
		return rs1.RetVal;
     else
	     	cmd1 = RSDCommand("SELECT t_sum_payer RetVal FROM DACCTRN_DBT WHERE substr(t_account_payer,1,5) in ('70613','70614')  and substr(t_account_receiver,1,5) in ('52601') and T_GROUND like ? and t_date_carry between ? and ?");
	     	cmd1.AddParam( "", RSDBP_IN, "% "+rs.DealCode+"%" );	  
	     	cmd1.AddParam( "", RSDBP_IN, BeginDate );	  
	     	cmd1.AddParam( "", RSDBP_IN, EndDate );	  
		RS1 = TRsbDataSet( cmd1 );
		IF (RS1.MoveNext)
			return rs1.RetVal;
	        else
			return 0;
	        end;
     end;



     cmd1 = RSDCommand("SELECT t_sum_payer RetVal FROM DACCTRN_DBT WHERE t_account_payer like '61210%'  and substr(t_account_receiver,1,5) in ('52601') and T_GROUND like ? and t_date_carry between ? and ?");
     cmd1.AddParam( "", RSDBP_IN, "% "+rs.DealCode+"%" );	  
     cmd1.AddParam( "", RSDBP_IN, BeginDate );	  
     cmd1.AddParam( "", RSDBP_IN, EndDate );	  



      dclop = min(EndDate, CloseDate); 


      query1 =   " select rsb_account.restac(a.t_Account, t_Code_Currency, ?, a.t_Chapter, null) as t_rest "
              + "  from daccount_dbt a, dmcaccdoc_dbt b where a.t_account=b.t_Account and b.t_catnum=1217 "
              + "  and b.t_docid = ? and b.t_dockind=199 ";

      cmd1 = RSDCommand(query1);         

      cmd1.AddParam("", RSDBP_IN,dclop);
      cmd1.AddParam("", RSDBP_IN,rs.id);

      rs1 = TRsbDataSet( cmd1 );
      if(rs1.moveNext())
        Rest = rs1.Rest;
      else return 0;
      end; 

      return Rest;

*/

	return v_oborot_plus;


  END;


  PRIVATE MACRO Rate3
     VAR cmd1, rs1, cmd2, rs2, query1, dclop, rest;
/*
     cmd1 = RSDCommand("SELECT t_sum_payer RetVal FROM DACCTRN_DBT WHERE substr(t_account_payer,1,5) in ('52602','52601') and substr(t_account_receiver,1,5) in ('61210','47408') and T_GROUND like ? and t_date_carry between ? and ?");
     cmd1.AddParam( "", RSDBP_IN, "% "+rs.DealCode+"%" );	  
     cmd1.AddParam( "", RSDBP_IN, BeginDate );	  
     cmd1.AddParam( "", RSDBP_IN, EndDate );	  
     
     RS1 = TRsbDataSet( cmd1 );
     IF (RS1.MoveNext)
		return rs1.RetVal;
     else
	     	cmd1 = RSDCommand("SELECT t_sum_payer RetVal FROM DACCTRN_DBT WHERE substr(t_account_payer,1,5) in ('70613','70614')  and substr(t_account_receiver,1,5) in ('52602','52601') and T_GROUND like ? and t_date_carry between ? and ?");
	     	cmd1.AddParam( "", RSDBP_IN, "% "+rs.DealCode+"%" );	  
	     	cmd1.AddParam( "", RSDBP_IN, BeginDate );	  
	     	cmd1.AddParam( "", RSDBP_IN, EndDate );	  
		RS1 = TRsbDataSet( cmd1 );
		IF (RS1.MoveNext)
			return rs1.RetVal;
	        else
			return 0;
	        end;
     end;



      dclop = min(EndDate, CloseDate); 


      query1 =   " select rsb_account.restac(a.t_Account, t_Code_Currency, ?, a.t_Chapter, null) as t_rest"
              + "  from daccount_dbt a, dmcaccdoc_dbt b where a.t_account=b.t_Account and b.t_catnum=1218 "
              + "  and b.t_docid = ? and b.t_dockind=199 ";

      cmd1 = RSDCommand(query1);         

      cmd1.AddParam("", RSDBP_IN, dclop);
      cmd1.AddParam("", RSDBP_IN, rs.id);

      rs1 = TRsbDataSet( cmd1 );
      if(rs1.moveNext())
        Rest = rs1.Rest;
      else return 0;
      end; 

      return Rest;

*/
	return v_oborot_minus;

  END;






  PRIVATE MACRO GetRate(fi, rtype, ddate)
     VAR cmd1, rs1, cmd2, rs2;
     cmd1 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratehist_dbt rh where rh.t_rateid in " +
                       " (select t_rateid from dratedef_Dbt where t_otherfi=? and t_type=?) " + 
                       " and  rh.t_sincedate = (select max(l.t_sincedate) from dratehist_dbt l where l.t_rateid = rh.t_rateid and l.t_sincedate <= ?) ");

     cmd1.AddParam( "", RSDBP_IN, fi );	  
     cmd1.AddParam( "", RSDBP_IN, rtype );	  
     cmd1.AddParam( "", RSDBP_IN, ddate );	  

     RS1 = TRsbDataSet( cmd1 );
     IF (RS1.MoveNext)
		return rs1.RetVal;
     else
	     cmd2 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratedef_dbt rh where t_otherfi = ? and t_type = ? and rh.t_sincedate <= ? ");

	     cmd2.AddParam( "", RSDBP_IN, fi );	  
	     cmd2.AddParam( "", RSDBP_IN, rtype );	  
	     cmd2.AddParam( "", RSDBP_IN, ddate );	  
	     RS2 = TRsbDataSet( cmd2 );
	     IF (RS2.MoveNext)
		return rs2.RetVal;        
	     end;
	     return 0;
     end;

  END;


  PRIVATE MACRO Rate1
	var loc;
	if (date(CloseDate) > date(EndDate))
		loc = EndDate;
	else 
		loc = CloseDate;
	end;

        if (v_date_dol == loc)
		return v_rate_dol;
	else

	    v_rate_dol = GetRate(7, 7, loc);
            v_date_dol = loc;
	    return v_rate_dol;

	end;
  END;


  PRIVATE MACRO OPT
	if (rs.t_type == 5 )  // покупка/продажа
			v_tr_fi = rs.fi2_pricefi;
			v_tr_amount = rs.fi2_cost;	
			v_ob_fi = rs.fi2_fi;
			v_ob_amount = rs.fi2_amount;
	elif (rs.t_type == 6 )  // продажа/покупка
			v_tr_fi = rs.fi2_fi;
			v_tr_amount = rs.fi2_amount;
			v_ob_fi = rs.fi2_pricefi;
			v_ob_amount = rs.fi2_cost;	
	elif (rs.t_type == 1 )  // покупка
			if (rs.dealkind == "Опцион") 
				if   (rs.optiontype == 2)    // Call
					v_tr_fi = rs.fi1_fi;
					v_tr_amount = rs.fi1_amount;	
					v_ob_fi = rs.fi1_pricefi;
					v_ob_amount = rs.fi1_cost;
				elif (rs.optiontype == 1)  // Put
					v_tr_fi = rs.fi1_pricefi;
					v_tr_amount = rs.fi1_cost;	
					v_ob_fi = rs.fi1_fi;
					v_ob_amount = rs.fi1_amount;
				end;
			else
				v_tr_fi = rs.fi1_fi;
				v_tr_amount = rs.fi1_amount;
				v_ob_fi = rs.fi1_pricefi;
				v_ob_amount = rs.fi1_cost;	
			end;
	elif (rs.t_type == 2 )  // продажа
			if (rs.dealkind == "Опцион") 
				if   (rs.optiontype == 1)    // Put
					v_tr_fi = rs.fi1_fi;
					v_tr_amount = rs.fi1_amount;	
					v_ob_fi = rs.fi1_pricefi;
					v_ob_amount = rs.fi1_cost;
				elif (rs.optiontype == 2)    // Call
					v_tr_fi = rs.fi1_pricefi;
					v_tr_amount = rs.fi1_cost;	
					v_ob_fi = rs.fi1_fi;
					v_ob_amount = rs.fi1_amount;
				end;
			else
				v_tr_fi = rs.fi1_pricefi;
				v_tr_amount = rs.fi1_cost;	
				v_ob_fi = rs.fi1_fi;
				v_ob_amount = rs.fi1_amount;
			end;
	elif (rs.t_type == 7 )  // на ставку
			v_tr_fi = rs.fi2_fi;
			v_tr_amount = rs.fi2_amount;	
			v_ob_fi = rs.fi1_fi;
			v_ob_amount = rs.fi1_amount;
	elif (rs.t_type == 8 )  // на ставку
			v_tr_fi = rs.fi2_fi;
			v_tr_amount = rs.fi2_amount;	
			v_ob_fi = rs.fi1_fi;
			v_ob_amount = rs.fi1_amount;
	elif (rs.t_type == 9 )  // покупка/продажа
			v_tr_fi = rs.fi2_pricefi;
			v_tr_amount = rs.fi2_cost;	
			v_ob_fi = rs.fi2_fi;
			v_ob_amount = rs.fi2_amount;
	end;

  END;


  // Получение счетов категорий +ПФИ(1217) и -ПФИ(1218)
  macro GetAccPFI
	var query3, cmd3, rs3;

      //  обороты по проводкам..
 
      v_oborot_plus = 0;
      v_oborot_minus = 0;

      query3 = 
	"SELECT T.T_ACCOUNT_PAYER, T.T_ACCOUNT_RECEIVER, substr(T.T_ACCOUNT_PAYER,1 ,5) PAYER_BAL2, substr(T.T_ACCOUNT_RECEIVER,1 ,5) RECEIVER_BAL2,  substr(T.T_ACCOUNT_PAYER,1 ,3) PAYER_BAL1, substr(T.T_ACCOUNT_RECEIVER,1 ,3) RECEIVER_BAL1, t.t_fiid_receiver, t.t_sum_natcur summ, t_ground  FROM dacctrn_dbt t " +
	"WHERE ( (t.t_AccTrnID IN  (SELECT docs.t_AccTrnID FROM doprdocs_dbt docs, doproper_dbt opr WHERE     opr.t_DocKind = 199 AND opr.t_DocumentID = LPAD (?, 34, chr(48)) AND docs.t_ID_Operation = opr.t_ID_Operation AND docs.t_DocKind = 1) " +
	"OR t.t_AccTrnID IN (SELECT grdoc.t_DocID FROM ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc WHERE     grdeal.t_DocKind = 199 AND grdeal.t_DocID = ? AND grdoc.t_GrDealID = grdeal.t_ID AND grdoc.t_DocKind = 1))) " +
	"and ( substr(t_account_payer, 1, 3) = '526' or substr(t_account_receiver, 1, 3) = '526') and t_ground not like '%преми_ %' and t_date_carry <= ? " ;

      cmd3 = RSDCommand(query3);         

      cmd3.AddParam("", RSDBP_IN, rs.id);
      cmd3.AddParam("", RSDBP_IN, rs.id);
      cmd3.AddParam("", RSDBP_IN, EndDate);

      rs3 = TRsbDataSet( cmd3 );

      while (rs3.moveNext())
		if     ( (rs3.payer_bal1 == "526") AND (rs3.receiver_bal1 == "526") )
		       // нейтрализуем проводку урегулирования парных

		elif   ( (rs3.payer_bal2 == "52602") AND (rs3.receiver_bal1 != "706") )   // Списание отрицательной переоценки
			v_oborot_plus = 0;
			v_oborot_minus = abs(rs3.summ);
			return;

		elif   ( (rs3.receiver_bal2 == "52601") AND (rs3.payer_bal1 != "706") )   // Списание положительной переоценки
			v_oborot_plus = abs(rs3.summ);
			v_oborot_minus = 0;
			return;
	
		elif   ( rs3.payer_bal2  == "52601" ) 
				v_oborot_plus = v_oborot_plus + abs(rs3.summ);
		elif   ( rs3.receiver_bal2 == "52602" ) 
				v_oborot_minus = v_oborot_minus + abs(rs3.summ);
		elif   ( rs3.payer_bal2	 == "52602" ) 
				v_oborot_minus = v_oborot_minus - abs(rs3.summ);
		elif   ( rs3.receiver_bal2 == "52601" ) 
				v_oborot_plus = v_oborot_plus - abs(rs3.summ);
		end;

      end; 

	//-- урегулирование парных
      if  (v_oborot_minus > v_oborot_plus)
		v_oborot_minus = v_oborot_minus - v_oborot_plus;
		v_oborot_plus = 0;
      else
		v_oborot_plus = v_oborot_plus - v_oborot_minus;
		v_oborot_minus = 0;
      end;
  end;


               
  PRIVATE MACRO Create()

     VAR DataQuery, DataQuery1, DQ1, DQ2, TR1, TR2;
     VAR cmd, cmd1;
     VAR SUMM_SUM;
     var s0=0,s1=0,s2=0,s3=0,s4=0,s5=0,s6=0;
     var DataQueryTransfer;
       

DataQuery = 
		"SELECT  /*+FIRST_ROWS*/    t.t_code DealCode,   DVKindNA.t_szNameAlg as DealKind,  decode(t.t_dockind,199,'Внебиржевая','Биржевая') DealType, Contractor.t_ShortName Contractor,	" +
		"t.t_Contractor ContrPartyID,  decode(Contractor.t_legalform,1,'ЮЛ',2,'ФЛ') ContrForm,  to_char(t.t_date,'dd.mm.yyyy') OpenDate,  to_char(nFI.t_ExecDate,'dd.mm.yyyy') ExecDate1,  nvl(to_char(nFI_2.t_ExecDate,'dd.mm.yyyy'), '01.01.0001') ExecDate2, nvl(to_char(nFI_2.t_PayDate,'dd.mm.yyyy'), '01.01.0001') PayDate2, nvl(to_char(nFI_2.t_SuplDate,'dd.mm.yyyy'), '01.01.0001') SuplDate2, t.*,	" +
		"nvl(to_char(nFI.t_PayDate,'dd.mm.yyyy'), '01.01.0001') PayDate1, nvl(to_char(nFI.t_SuplDate,'dd.mm.yyyy'), '01.01.0001') SuplDate1, " +
		"Client.t_ShortName Client,  MarketKindNA.t_szNameAlg as Market,  PeriodClsNA.t_szNameAlg as Period,  nFI.t_FIID,  nFI.t_StdFIID,  nFI.t_Amount,  nFI.t_Price,	" +
		"nFI.t_Point, nFI.t_fiid fi1_fi, nFI.t_pricefiid fi1_pricefi, nvl(nFI.t_cost,0) fi1_cost, nvl(nFI.t_amount,0) fi1_amount, nvl(nFI_2.t_fiid,-1) fi2_fi, nvl(nFI_2.t_cost,0) fi2_cost, nvl(nFI_2.t_amount,0) fi2_amount, nvl(nFI_2.t_pricefiid,-1) fi2_pricefi, nFI.t_OpenDate,    GenAgr.t_Code ," +
		" ( select t_codelat3 from dcountry_dbt cou where t_parentcountryid=0 start with cou.t_codelat3=contractor.t_nrcountry connect by cou.t_countryid=prior cou.t_parentcountryid ) ContrCou " +
		
		"FROM ddvndeal_dbt t,  dparty_dbt Client,  dparty_dbt Contractor,   dnamealg_dbt DVKindNA,  ddl_genagr_dbt GenAgr,  dnamealg_dbt MarketKindNA,  ddvnfi_dbt nFI,  ddvnfi_dbt nFI_2,	" +
		"         dnamealg_dbt PeriodClsNA,   dfininstr_dbt fiin ,  doproper_dbt oper	" +

		"WHERE    " +
		"oper.t_dockind = t.t_dockind and oper.t_documentid = lpad (t.t_id, 34, '0') and " +
		"   (    Client.t_PartyID(+) = t.t_Client	" +
		"AND Contractor.t_PartyID(+) = t.t_Contractor	" +
		"AND DVKindNA.t_iTypeAlg(+) = 7010	" +
		"AND DVKindNA.t_iNumberAlg(+) = t.t_DVKind	" +
		"AND fiin.t_fiid = nFI.t_fiid " +
		"AND MarketKindNA.t_iTypeAlg(+) = 7039	" +
		"              AND MarketKindNA.t_iNumberAlg(+) = t.t_MarketKind   " +
		"              AND PeriodClsNA.t_iTypeAlg(+) = 7038	" +
		"              AND PeriodClsNA.t_iNumberAlg(+)= t.t_PeriodCls	" +
		"              AND nFI.t_DealID(+) = t.t_ID	" +
		"              AND nFI.t_Type(+) = 0	" +
		"              AND nFI_2.t_DealID(+) = t.t_ID	" +
		"              AND nFI_2.t_Type(+) = 2	" +
		"              AND GenAgr.t_GenAgrID(+) = t.t_GenAgrID)	" +
//		"              AND t.t_MarketKind <> 1	" +
//		"              and t.t_state > 0	" +
		"              and Contractor.t_notresident=chr(88)	" +
//		"	       and t.t_ispfi = chr(88) " +


         	"         and t_client = -1    " +   
         	"         and exists (select 1 from ddvnfi_dbt where t_dealid = t.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind in (1, 6)))  " +
         	"         and t.t_dvkind in (1/*форвард*/, 2/*опцион*/, 3/*валютный своп*/, 4/*процентный своп*/, 5/*покупка/продаэа Т+3*/, 6/*СВОП*/)  " +
//         	"         and (oper.t_end_date >=  " + GetSQLDate( BeginDate ) + " and oper.t_end_date <= " + GetSQLDate( EndDate ) + ")  " +
         	"         and (t_sector = 'X' or exists (select 1 from doprstep_dbt where t_kind_action = 110 and t_id_operation = oper.t_id_operation and t_isexecute = 'X' and t_fact_date <= " + GetSQLDate( EndDate ) + "))  " +
         	"         and case when t_dvkind in (3,6) then (select greatest (t_execdate, t_supldate) from ddvnfi_dbt where t_dealid = t.t_id and t_type = 2) else (select t_execdate from ddvnfi_dbt where t_dealid=t.t_id and t_type=0 and t_opendate = chr (0)) end >= " + GetSQLDate( EndDate ) + " " +
		"ORDER BY t.t_id";




DataQueryTransfer = 
		"SELECT  /*+FIRST_ROWS*/    t.t_code DealCode,   DVKindNA.t_szNameAlg as DealKind,  decode(t.t_dockind,199,'Внебиржевая','Биржевая') DealType, Contractor.t_ShortName Contractor,	" +
		"t.t_Contractor ContrPartyID,  decode(Contractor.t_legalform,1,'ЮЛ',2,'ФЛ') ContrForm,  to_char(t.t_date,'dd.mm.yyyy') OpenDate,  to_char(nFI.t_ExecDate,'dd.mm.yyyy') ExecDate1,  nvl(to_char(nFI_2.t_ExecDate,'dd.mm.yyyy'), '01.01.0001') ExecDate2, nvl(to_char(nFI_2.t_PayDate,'dd.mm.yyyy'), '01.01.0001') PayDate2, nvl(to_char(nFI_2.t_SuplDate,'dd.mm.yyyy'), '01.01.0001') SuplDate2, t.*,	" +
		"nvl(to_char(nFI.t_PayDate,'dd.mm.yyyy'), '01.01.0001') PayDate1, nvl(to_char(nFI.t_SuplDate,'dd.mm.yyyy'), '01.01.0001') SuplDate1, " +
		"Client.t_ShortName Client,  MarketKindNA.t_szNameAlg as Market,  PeriodClsNA.t_szNameAlg as Period,  nFI.t_FIID,  nFI.t_StdFIID,  nFI.t_Amount,  nFI.t_Price,	" +
		"nFI.t_Point, nFI.t_fiid fi1_fi, nFI.t_pricefiid fi1_pricefi, nvl(nFI.t_cost,0) fi1_cost, nvl(nFI.t_amount,0) fi1_amount, nvl(nFI_2.t_fiid,-1) fi2_fi, nvl(nFI_2.t_cost,0) fi2_cost, nvl(nFI_2.t_amount,0) fi2_amount, nvl(nFI_2.t_pricefiid,-1) fi2_pricefi, nFI.t_OpenDate,    GenAgr.t_Code ," +
		" ( select t_codelat3 from dcountry_dbt cou where t_parentcountryid=0 start with cou.t_codelat3=contractor.t_nrcountry connect by cou.t_countryid=prior cou.t_parentcountryid ) ContrCou " +
		
		"FROM ddvndeal_dbt t,  dparty_dbt Client,  dparty_dbt Contractor,   dnamealg_dbt DVKindNA,  ddl_genagr_dbt GenAgr,  dnamealg_dbt MarketKindNA,  ddvnfi_dbt nFI,  ddvnfi_dbt nFI_2,	" +
		"         dnamealg_dbt PeriodClsNA,   dfininstr_dbt fiin ,  doproper_dbt oper	" +

		"WHERE    " +
		"oper.t_dockind = t.t_dockind and oper.t_documentid = lpad (t.t_id, 34, '0') and " +
		"   (    Client.t_PartyID(+) = t.t_Client	" +
		"AND Contractor.t_PartyID(+) = t.t_Contractor	" +
		"AND DVKindNA.t_iTypeAlg(+) = 7010	" +
		"AND DVKindNA.t_iNumberAlg(+) = t.t_DVKind	" +
		"AND fiin.t_fiid = nFI.t_fiid " +
		"AND MarketKindNA.t_iTypeAlg(+) = 7039	" +
		"              AND MarketKindNA.t_iNumberAlg(+) = t.t_MarketKind   " +
		"              AND PeriodClsNA.t_iTypeAlg(+) = 7038	" +
		"              AND PeriodClsNA.t_iNumberAlg(+)= t.t_PeriodCls	" +
		"              AND nFI.t_DealID(+) = t.t_ID	" +
		"              AND nFI.t_Type(+) = 0	" +
		"              AND nFI_2.t_DealID(+) = t.t_ID	" +
		"              AND nFI_2.t_Type(+) = 2	" +
		"              AND GenAgr.t_GenAgrID(+) = t.t_GenAgrID)	" +
//		"              AND t.t_MarketKind <> 1	" +
//		"              and t.t_state > 0	" +
//		"	       and t.t_ispfi = chr(88) " +


         	"         and t_client = -1    " +   
         	"         and exists (select 1 from ddvnfi_dbt where t_dealid = t.t_id and exists (select 1 from dfininstr_dbt where t_fiid=ddvnfi_dbt.t_fiid and t_fi_kind in (1, 6)))  " +
         	"         and t.t_dvkind in (1/*форвард*/, 2/*опцион*/, 3/*валютный своп*/, 4/*процентный своп*/, 5/*покупка/продаэа Т+3*/, 6/*СВОП*/)  " +
         	"         and t_date < " + GetSQLDate( EndDate ) + 
         	"         and (oper.t_end_date = to_date ('01010001','ddmmyyyy') or oper.t_end_date >= " + GetSQLDate( EndDate ) + ")  " +
         	"         and (t_sector = 'X' or exists (select 1 from doprstep_dbt where t_kind_action = 110 and t_id_operation = oper.t_id_operation and t_isexecute = 'X' and t_fact_date <= " + GetSQLDate( EndDate ) + "))  " +
         	"         and case when t_dvkind in (3,6) then (select greatest (t_execdate, t_supldate) from ddvnfi_dbt where t_dealid = t.t_id and t_type = 2) else (select t_execdate from ddvnfi_dbt where t_dealid=t.t_id and t_type=0 and t_opendate = chr (0)) end >= " + GetSQLDate( EndDate ) + " " +
		"ORDER BY t.t_id";







     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Maximum = ProgressValue.Maximum + SQL_GetNRecs( DataQueryTransfer );
     ProgressValue.Current = 0;
     
     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);
     
     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"\"Сделки ПФИ, кроме сделок с ценными бумагами\"" , HTML_StSheetName);
     end;
     cmd = RSDCommand( DataQuery );
     RS = TRsbDataSet( cmd );

     while( RS.MoveNext() )
            if ((date(CloseDate) >= date(BeginDate)) and (date(CloseDate) <= date(EndDate)))

		  OPT;
		  GetAccPFI;

		  FindAcc( RS.ID, v_tr_fi, v_ob_fi );

                  s0 = s0 + trAmount;
                  s1 = s1 + ObAmount;
		  s2 = s2 + PromSum1;
		  s3 = s3 + PromSum2;
		  s4 = s4 + PromSum3;
		  s5 = s5 + rate2;
		  s6 = s6 + rate3;

	          m_IsDataExist = true;
	          PrintLine( 
	          /*1 */     DealNom,      	
	          /*2 */     DealKind,       	
        	  /*3 */     DealType,      	
	          /*4 */     FiKind,      	
	          /*5 */     Contractor,      
	          /*6 */     ContrCou,    	
	          /*7 */     ContrType,      	
	          /*8 */     OpenDate,     	
	          /*9 */     CloseDate,       
	          /*10*/     TrAcc,          	
	          /*11*/     TrVal,      	
	          /*12*/     TrAmount,     	
	          /*13*/     ObAcc,        	
	          /*14*/     ObVal,        	
	          /*15*/     ObAmount,        
	          /*16*/     PromSum1,        
	          /*17*/     PromSum2,        
	          /*18*/     BreakDate,     	
	          /*19*/     PromSum3,
	          /*20*/     Rate1,     	
	          /*21*/     Rate2,     	
	          /*22*/     Rate3
		  );		
	      end;
        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;

     PrintLine( "","","","","","","","","","","","","","","","","","","","","","");
     PrintLine( "","","","","","","","","","","","","","","","","","","","","","");

     cmd = RSDCommand( DataQueryTransfer );
     RS = TRsbDataSet( cmd );
     while( RS.MoveNext() )
		  OPT;
		  FindAcc( RS.ID, v_tr_fi, v_ob_fi );
		  GetAccPFI;

                  s0 = s0 + trAmount;
                  s1 = s1 + ObAmount;
		  s2 = s2 + PromSum1;
		  s3 = s3 + PromSum2;
		  s4 = s4 + PromSum3;
		  s5 = s5 + rate2;
		  s6 = s6 + rate3;

	          m_IsDataExist = true;
	          PrintLine( 
	          /*1 */     DealNom,      	
	          /*2 */     DealKind,       	
        	  /*3 */     DealType,      	
	          /*4 */     FiKind,      	
	          /*5 */     Contractor,      
	          /*6 */     ContrCou,    	
	          /*7 */     ContrType,      	
	          /*8 */     OpenDate,     	
	          /*9 */     CloseDate,       
	          /*10*/     TrAcc,          	
	          /*11*/     TrVal,      	
	          /*12*/     TrAmount,     	
	          /*13*/     ObAcc,        	
	          /*14*/     ObVal,        	
	          /*15*/     ObAmount,        
	          /*16*/     PromSum1,        
	          /*17*/     PromSum2,        
	          /*18*/     BreakDate,     	
	          /*19*/     PromSum3,
	          /*20*/     Rate1,     	
	          /*21*/     Rate2,     	
	          /*22*/     Rate3
		  );		

        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;

     PrintLine( "","","","","","","","","","","",s0,"","",s1,s2,s3,"",s4,"",s5,s6);


     ProgressIndicator.Stop();

  END;
  
  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  OD1_Form = DL_OD1_Panel();

  stat = OD1_Form.Run();

  if( stat )
      OD1_Report = SP_OD1_Report( null, "Report_401_3.xls", null, IsWebService, ReportHashCode );
      OD1_Report.Run();

      Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  end;

  return FullReportFileNames;
END;
