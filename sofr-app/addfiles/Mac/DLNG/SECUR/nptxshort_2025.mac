/*
$Name:        nptxshort_2025.mac
$Module:      Ценные бумаги
$Description: Отчет "Краткая справка по расчету НДФЛ (2025)" 
*/
IMPORT "nptxshort_2025_form.mac", "nptxshort_2025_data.mac";

PRIVATE CONST POI_MODE = true;

PRIVATE CONST ItogsLineName = "Всего:";

private macro GetSystDateTime(SystDate:@date, SystTime:@time)
  var cmd = DL_RSDCommand("select sysdate dt from dual");
  var DataSet = cmd.execute();

  DataSet.moveNext();

  DtTmSplit(DataSet.dt, SystDate, SystTime);
end;

PRIVATE MACRO GetRepPath()
  var RegistryPath = "РСХБ\\ДИРЕКТОРИИ\\OUT\\КРАТКАЯ_СПРАВКА";
  var Path = "";
  var stat = 0;
 
  GetRegistryValue(RegistryPath, V_STRING, Path, stat);
  if((stat) or (Path == "")) 
    msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
  else
    if(substr(Path, strlen(Path), 1) != "\\")
      Path = Path + "\\";
    end;
  end;

  return Path;
END;

//Печать
PRIVATE CLASS (TX_RegistrReport) NPTXShort2025_Report(RepData, GUID)
  var m_BeginDate, m_ReportType, m_ByDepo, m_AvrKind, m_AvrFIID, m_NeedRealizList, m_NeedShortPosList, m_NeedRepoList, m_NeedLucreList, m_NeedPFIList, m_NeedBillList, m_NeedProtocolList, m_ByIIS, m_DlContrID;
  var m_Include_Tech;
  var m_ContractIDsStr = "", m_ContractNumber = "";
  var m_By_IIS = false, m_By_NotIIS = false;
  var m_TaxPeriod = 0;
  var m_GUID = GUID;
  var m_RepData = RepData;

  VAR m_CurrInvestorSheetName, m_CurrInvestor, m_CurrInvestorName, m_InvestorFIO;
  
  PRIVATE MACRO LoadRepParam()
    var query, cmd, DataSet;

    query =   " select rp.*, "
            + "        trim( pt.t_Name ) as InvestorName, "
            + "        trim(persn.t_Name1) "
            + "         || case when(persn.t_Name2 = CHR(1))then '' else SUBSTR (persn.t_Name2, 1, 1) end"
            + "         || case when(persn.t_Name3 = CHR(1))then '' else SUBSTR (persn.t_Name3, 1, 1) end as InvestorFIO "
            + "   from dnptxshort_repparm_dbt rp, dpersn_dbt persn, dparty_dbt pt "
            + "  where rp.t_GUID = ? "
            + "    and pt.t_PartyID = rp.t_ClientID "
            + "    and persn.t_PersonID = pt.t_PartyID ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_GUID);
    DataSet = cmd.Execute();
    if(DataSet.moveNext())

      m_EndDate = date(DataSet.EndDate);
      datesplit(m_EndDate, NULL, NULL, m_TaxPeriod);
      m_BeginDate = date(1, 1, m_EndDate);
                         
      m_ReportType       = DataSet.RepType;
      m_ByDepo           = DataSet.ByDepo;
      m_AvrKind          = int(DataSet.AvrKind);
      m_AvrFIID          = int(DataSet.AvrFIID);
      m_NeedRealizList   = DataSet.NeedRealizList;
      m_NeedShortPosList = DataSet.NeedShortPosList;
      m_NeedRepoList     = DataSet.NeedRepoList;
      m_NeedLucreList    = DataSet.NeedLucreList;
      m_NeedPFIList      = DataSet.NeedPFIList;
      m_Include_Tech     = DataSet.Include_Tech;
      m_NeedBillList     = DataSet.NeedBillList;    
      m_NeedProtocolList = DataSet.NeedProtocolList;
      m_ByIIS            = IIF(DataSet.ByIIS == SET_CHAR, 1, 0);
      m_CurrInvestor     = int(DataSet.ClientID);
      m_DlContrID        = int(DataSet.DlContrID);

      m_CurrInvestorName = DataSet.InvestorName;
      m_InvestorFIO      = DataSet.InvestorFIO;
      
      return true;
    end;

    return false;
  END;


  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport()
    SetIsShowAppl(false); //Всегда не показываем отчет на экран

    CreateTotalBook();    
    DL_CallInsertStat(PrintMode()); 
  END;
  
  PRIVATE MACRO EndReport()
     SaveTotalBook();
     setRecreateSheets(true);
  END;

  PRIVATE MACRO CorrectSheetName(SheetName:string)
    return substr(SheetName, 1, 31);
  END;

  macro AsDouble(Str)
    Str = trim(Str);
    if(Str != "")
      return double(Str);
    end;

    return Str;
  end;

  macro AsDate(Str):variant
    Str = trim(Str);
    if(Str != "")
      return date(Str);
    end;

    return Str;
  end;

  MACRO GetTotalCalcField(FieldName)
    var query, cmd, DataSet;

    query = "select * from dnptxshort_totalcalc_dbt where t_GUID = ? and t_FieldName = LOWER(?)";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_GUID);
    cmd.AddParam(FieldName);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      if(DataSet.FieldType == V_DATE)
        return date(DataSet.FieldValue);
      elif(DataSet.FieldType == V_MONEY)
        return money(DataSet.FieldValue);
      elif(DataSet.FieldType == V_DOUBLE)
        return double(DataSet.FieldValue);
      elif(DataSet.FieldType == V_INTEGER)
        return int(DataSet.FieldValue);
      else
        return string(DataSet.FieldValue);
      end;
    end;

    return "";
  END;

  //РЕПО
  PRIVATE MACRO CreateRepoRep()
    var WasPrinted = false;
    var cnt = 0, i = 0;
    var query, cmd, DataSet;
   
    var SheetName = "РЕПО";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_repo_dbt "
            + "  where t_GUID = ? ";

    cmd.AddParam(m_GUID);

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      query = "select q.* from ("+query+") q order by q.t_GUID ASC, q.t_Itog ASC, q.t_Sort ASC";

      DataSet = cmd.Execute(query);

      InitProgress( cnt, CurrSheetName, CurrSheetName );

      while(DataSet.moveNext())
        if(WasPrinted == false)
          UseNewSheetInTotalBook();
          SetActiveSheet( SheetName );

          PrintFormatString( NULL,
                             "N3_Dbeg",   GetTotalCalcField("Dbeg"),   //за период с
                             "N3_Dend",   GetTotalCalcField("Dend"),   //по         
                             "N3_Client", GetTotalCalcField("Client")  // Клиент    
                            );
          CopyAllSheetInTotalBook(SheetName, false, "N3_ReportHeader", 0, CurrSheetName);

          CopyAllSheetInTotalBook(SheetName, false, "N3_TableHeader", 0, CurrSheetName);
          RegisterTable( "N3_MainTable", NULL,
               /*1  */   "N3_SecCode",   
               /*2  */   "N3_SecName",
               /*3  */   "N3_ContractS",
               /*4  */   "N3_CodeR",     
               /*5  */   "N3_DZ",        
               /*6  */   "N3_Qnty",      
               /*7  */   "N3_Dir1",      
               /*8  */   "N3_DD1",       
               /*9  */   "N3_DP1",       
               /*10  */   "N3_Tot1vp",    
               /*11 */   "N3_Rate",      
               /*12 */   "N3_Dir2",      
               /*13 */   "N3_DD2",       
               /*14 */   "N3_DP2",       
               /*15 */   "N3_Deal2vp",   
               /*16 */   "N3_Tot2vp",    
               /*17 */   "N3_DohRub",    
               /*18 */   "N3_RashRub",   
               /*19 */   "N3_TaxPashRub",
               /*20 */   "N3_GenRub",
               /*21 */   "N3_Com",       
               /*22 */   "N3_CoupCalcVn",
               /*23 */   "N3_AmortCalcVn"
               );

        end;

        WasPrinted = true;

        if(DataSet.Itog == UNSET_CHAR)
          PrintTableLine("N3_SecCode",       DataSet.SecCode,                   null,               //1
                         "N3_SecName",       DataSet.SecName,                   null,               //2
                         "N3_ContractS",     DataSet.ContractS,                 null,               //3
                         "N3_CodeR",         DataSet.CodeR,                     null,               //4
                         "N3_DZ",            AsDate(DataSet.DZ),                null,               //5
                         "N3_Qnty",          AsDouble(DataSet.Qnty),            SetPrecisionByFractPart(AsDouble(DataSet.Qnty), DataSet.SumPrecision, 0),  //6
                         "N3_Dir1",          DataSet.Dir1,                      null,               //7
                         "N3_DD1",           AsDate(DataSet.DD1),               null,               //8
                         "N3_DP1",           AsDate(DataSet.DP1),               null,               //9
                         "N3_Tot1vp",        AsDouble(DataSet.Tot1vp),          null,               //10
                         "N3_Rate",          DataSet.Rate,                      null,               //11
                         "N3_Dir2",          DataSet.Dir2,                      null,               //12
                         "N3_DD2",           AsDate(DataSet.DD2),               null,               //13
                         "N3_DP2",           AsDate(DataSet.DP2),               null,               //14
                         "N3_Deal2vp",       AsDouble(DataSet.Deal2vp),         null,               //15
                         "N3_Tot2vp",        AsDouble(DataSet.Tot2vp),          null,               //16
                         "N3_DohRub",        AsDouble(DataSet.DohRub),          null,               //17
                         "N3_RashRub",       AsDouble(DataSet.RashRub),         null,               //18
                         "N3_TaxPashRub",    AsDouble(DataSet.TaxPashRub),      null,               //19
                         "N3_GenRub",        AsDouble(DataSet.GenRub),          null,               //20
                         "N3_Com",           AsDouble(DataSet.Com),             null,               //21
                         "N3_CoupCalcVn",    AsDouble(DataSet.CoupCalcVn),      null,               //22
                         "N3_AmortCalcVn",   AsDouble(DataSet.AmortCalcVn),     null                //23
                       );
        else
          PrintTableLine( "N3_SecCode",     ItogsLineName,                 null, 
                /*5  */   "N3_Qnty",        AsDouble(DataSet.Qnty),        SetPrecisionByFractPart(AsDouble(DataSet.Qnty), DataSet.SumPrecision, 0),           
                /*9  */   "N3_Tot1vp",      AsDouble(DataSet.Tot1vp),      null,
                /*16 */   "N3_DohRub",      AsDouble(DataSet.DohRub),      null,
                /*17 */   "N3_RashRub",     AsDouble(DataSet.RashRub),     null,
                /*18 */   "N3_TaxPashRub",  AsDouble(DataSet.TaxPashRub),  null,
                /*19 */   "N3_Com",         AsDouble(DataSet.Com),         null,
                /*20 */   "N3_CoupCalcVn",  AsDouble(DataSet.CoupCalcVn),  null,
                /*21 */   "N3_AmortCalcVn", AsDouble(DataSet.AmortCalcVn), null
                         );
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      if(WasPrinted)
        EndTable();
        CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
      end;
    end;

    return WasPrinted;
  END; 
          

  //Короткие позиции
  PRIVATE MACRO CreateShortPosRep()
    var query, DataSet, cmd;
    var SheetName = "Короткие позиции";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);
    var cnt = 0, i = 0;
    var Sum_Qnty= $0;
    var Sum_AllSrub = $0;
    var Sum_DifS = $0;
    var Sum_ComBankS = $0;
    var Sum_ComExcS =  $0;
    var Sum_ComS =  $0;
    var Sum_AllBrub = $0;
    var Sum_MaterialB = $0;
    var Sum_TaxMaterialB = $0;
    var Sum_DifB  = $0;
    var Sum_ComBankB =  $0;
    var Sum_ComExcB = $0;
    var Sum_ComB = $0;
    var Sum_TaxFRlink =0.0;
    var WasPrinted = false;


    this.SetCurrentLineFont( 8, false, false );

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_shortpos_dbt "
            + "  where t_GUID = ? ";

    cmd.AddParam(m_GUID);

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      query = "select q.* from ("+query+") q order by q.t_GUID ASC, q.t_Itog ASC, q.t_Sort ASC";

      DataSet = cmd.Execute(query);

      InitProgress( cnt, CurrSheetName, CurrSheetName );
      while(DataSet.moveNext())
          
        if(WasPrinted == false)
          UseNewSheetInTotalBook();
          SetActiveSheet( SheetName );

          PrintFormatString( NULL,
                             "N4_Dbeg",   GetTotalCalcField("Dbeg"),   //за период с
                             "N4_Dend",   GetTotalCalcField("Dend"),   //по
                             "N4_Client", GetTotalCalcField("Client")  // Клиент
                            );
          CopyAllSheetInTotalBook(SheetName, false, "N4_ReportHeader", 0, CurrSheetName);

          CopyAllSheetInTotalBook(SheetName, false, "N4_TableHeader", 0, CurrSheetName);
          RegisterTable( "N4_MainTable", NULL,
               /*1  */   "N4_SecCode",     
               /*2  */   "N4_SecName",     
               /*3  */   "N4_Qnty",
               /*4  */   "N4_ContractS",        
               /*5  */   "N4_CodeS",       
               /*6  */   "N4_DZS",         
               /*7  */   "N4_DPS",         
               /*8  */   "N4_PrSrub",      
               /*9  */   "N4_AllSrub",     
               /*10 */   "N4_DifS",        
               /*11 */   "N4_ComBankS",    
               /*12 */   "N4_ComExcS",     
               /*13 */   "N4_ComS",
               /*14 */   "N4_ContractB",
               /*15 */   "N4_CodeB",       
               /*16 */   "N4_DZB",         
               /*17 */   "N4_DPB",         
               /*18 */   "N4_PrBrub",      
               /*19 */   "N4_AllBrub",     
               /*20 */   "N4_MaterialB",   
               /*21 */   "N4_TaxMaterialB",
               /*22 */   "N4_DifB",        
               /*23 */   "N4_ComBankB",    
               /*24 */   "N4_ComExcB",     
               /*25 */   "N4_ComB",        
               /*26 */   "N4_TaxFRlink",   
               /*27 */   "N4_SecType",     
               /*28 */   "N4_TaxTags",     
               /*29 */   "N4_AA"      
               );
        end;

        WasPrinted = true;

        if(DataSet.Itog == UNSET_CHAR)
          PrintTableLine( "N4_SecCode",          DataSet.SecCode,                null,      /*1  */
                          "N4_SecName",          DataSet.SecName,                null,      /*2  */
                          "N4_Qnty",             AsDouble(DataSet.Qnty),         null,      /*3  */
                          "N4_ContractS",        DataSet.ContractS,              null,      /*4  */
                          "N4_CodeS",            DataSet.CodeS,                  null,      /*5  */
                          "N4_DZS",              AsDate(DataSet.DZS),            null,      /*6  */
                          "N4_DPS",              AsDate(DataSet.DPS),            null,      /*7  */
                          "N4_PrSrub",           AsDouble(DataSet.PrSrub),       DataSet.SPoint,      /*8  */
                          "N4_AllSrub",          AsDouble(DataSet.AllSrub),      null,      /*9  */
                          "N4_DifS",             AsDouble(DataSet.DifS),         null,      /*10  */
                          "N4_ComBankS",         AsDouble(DataSet.ComBankS),     null,      /*11 */
                          "N4_ComExcS",          AsDouble(DataSet.ComExcS),      null,      /*12 */
                          "N4_ComS",             AsDouble(DataSet.ComS),         null,      /*13 */
                          "N4_ContractB",        DataSet.ContractB,              null,      /*14 */
                          "N4_CodeB",            DataSet.CodeB,                  null,      /*15 */
                          "N4_DZB",              AsDate(DataSet.DZB),            null,      /*16 */
                          "N4_DPB",              AsDate(DataSet.DPB),            null,      /*17 */
                          "N4_PrBrub",           DataSet.PrBrub,                 null,      /*18 */
                          "N4_AllBrub",          AsDouble(DataSet.AllBrub),      null,      /*19 */
                          "N4_MaterialB",        AsDouble(DataSet.MaterialB),    null,      /*20 */
                          "N4_TaxMaterialB",     AsDouble(DataSet.TaxMaterialB), null,      /*21 */
                          "N4_DifB",             AsDouble(DataSet.DifB),         null,      /*22 */
                          "N4_ComBankB",         AsDouble(DataSet.ComBankB),     null,      /*23 */
                          "N4_ComExcB",          AsDouble(DataSet.ComExcB),      null,      /*24 */
                          "N4_ComB",             AsDouble(DataSet.ComB),         null,      /*25 */
                          "N4_TaxFRlink",        AsDouble(DataSet.TaxFRlink),    null,      /*26 */
                          "N4_SecType",          DataSet.SecType,                null,      /*27 */
                          "N4_TaxTags",          DataSet.TaxTags,                null,      /*28 */
                          "N4_AA",               DataSet.AA,                     null       /*29 */
                         );
        else
          SetCurrentLineFont( 10, true, false );
          PrintTableLine( "N4_SecCode",      ItogsLineName,                  null,           
                /*3  */   "N4_Qnty",         AsDouble(DataSet.Qnty),         null,
                /*8  */   "N4_AllSrub",      AsDouble(DataSet.AllSrub),      null,
                /*9  */   "N4_DifS",         AsDouble(DataSet.DifS),         null,
                /*10 */   "N4_ComBankS",     AsDouble(DataSet.ComBankS),     null,
                /*11 */   "N4_ComExcS",      AsDouble(DataSet.ComExcS),      null,
                /*12 */   "N4_ComS",         AsDouble(DataSet.ComS),         null,
                /*17 */   "N4_AllBrub",      AsDouble(DataSet.AllBrub),      null,
                /*18 */   "N4_MaterialB",    AsDouble(DataSet.MaterialB),    null,
                /*19 */   "N4_TaxMaterialB", AsDouble(DataSet.TaxMaterialB), null,
                /*20 */   "N4_DifB",         AsDouble(DataSet.DifB),         null,
                /*21 */   "N4_ComBankB",     AsDouble(DataSet.ComBankB),     null,
                /*22 */   "N4_ComExcB",      AsDouble(DataSet.ComExcB),      null,
                /*23 */   "N4_ComB",         AsDouble(DataSet.ComB),         null,
                /*24 */   "N4_TaxFRlink",    AsDouble(DataSet.TaxFRlink),    null
                         );
        end;

        UseProgress(i = i + 1);

      end;

      RemProgress();

      if(WasPrinted)
        EndTable();
        CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
      end;
    end;

    return WasPrinted;
  END;

  //Реализация
  PRIVATE MACRO CreateRealizRep()
    var query, DataSet, cmd, ins, del, upd;
    var SheetName = "Реализация";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);
    var cnt = 0, i = 0;
    var WasPrinted = false;

    this.SetCurrentLineFont( 8, false, false );
    
    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_realiz_dbt "
            + "  where t_GUID = ? ";

    cmd.AddParam(m_GUID);

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      query = "select q.* from ("+query+") q order by q.t_GUID ASC, q.t_Itog ASC, q.t_Sort ASC";

      DataSet = cmd.Execute(query);

      InitProgress( cnt, CurrSheetName, CurrSheetName );
      while(DataSet.moveNext())

        if(WasPrinted == false)
          UseNewSheetInTotalBook();
          SetActiveSheet( SheetName );

          PrintFormatString( NULL,
                             "N2_Dbeg",   GetTotalCalcField("Dbeg"),    //за период с
                             "N2_Dend",   GetTotalCalcField("Dend"),    //по
                             "N2_Client", GetTotalCalcField("Client")   // Клиент
                            );
          CopyAllSheetInTotalBook(SheetName, false, "N2_ReportHeader", 0, CurrSheetName);

          CopyAllSheetInTotalBook(SheetName, false, "N2_TableHeader", 0, CurrSheetName);

          SetActiveSheet( SheetName );

          RegisterTable( "N2_MainTable", NULL,
               /*1  */   "N2_SecCode",     
               /*2  */   "N2_SecName",     
               /*3  */   "N2_Qnty",
               /*4  */   "N2_ContractS",
               /*5  */   "N2_CodeS",       
               /*6  */   "N2_DZS",         
               /*7  */   "N2_DPS",         
               /*8  */   "N2_PrSrub",      
               /*9  */   "N2_AllSrub",     
               /*10 */   "N2_DifS",        
               /*11 */   "N2_ComBankS",    
               /*12 */   "N2_ComExcS",     
               /*13 */   "N2_ComS",
               /*14 */   "N2_ContractB",      
               /*15 */   "N2_CodeB",       
               /*16 */   "N2_DZB",         
               /*17 */   "N2_DPB",         
               /*18 */   "N2_PrBrub",      
               /*19 */   "N2_AllBrub",     
               /*20 */   "N2_MaterialB",   
               /*21 */   "N2_TaxMaterialB",
               /*22 */   "N2_DifB",        
               /*23 */   "N2_ComBankB",    
               /*24 */   "N2_ComExcB",     
               /*25 */   "N2_ComB",        
               /*26 */   "N2_TaxFRlink",   
               /*27 */   "N2_SecType",     
               /*28 */   "N2_TaxTags",     
               /*29 */   "N2_AA"      
               );
        end;

        WasPrinted = true;

        if(DataSet.Itog == UNSET_CHAR)
          PrintTableLine( "N2_SecCode",          DataSet.SecCode,                null,      /*1  */
                          "N2_SecName",          DataSet.SecName,                null,      /*2  */
                          "N2_Qnty",             AsDouble(DataSet.Qnty),         null,      /*3  */
                          "N2_ContractS",        DataSet.ContractS,              null,      /*4  */
                          "N2_CodeS",            DataSet.CodeS,                  null,      /*5  */
                          "N2_DZS",              AsDate(DataSet.DZS),            null,      /*6  */
                          "N2_DPS",              AsDate(DataSet.DPS),            null,      /*7  */
                          "N2_PrSrub",           AsDouble(DataSet.PrSrub),       DataSet.SPoint,      /*8  */
                          "N2_AllSrub",          AsDouble(DataSet.AllSrub),      null,      /*9  */
                          "N2_DifS",             AsDouble(DataSet.DifS),         null,      /*10  */
                          "N2_ComBankS",         AsDouble(DataSet.ComBankS),     null,      /*11 */
                          "N2_ComExcS",          AsDouble(DataSet.ComExcS),      null,      /*12 */
                          "N2_ComS",             AsDouble(DataSet.ComS),         null,      /*13 */
                          "N2_ContractB",        DataSet.ContractB,              null,      /*14 */
                          "N2_CodeB",            DataSet.CodeB,                  null,      /*15 */
                          "N2_DZB",              AsDate(DataSet.DZB),            null,      /*16 */
                          "N2_DPB",              AsDate(DataSet.DPB),            null,      /*17 */
                          "N2_PrBrub",           DataSet.PrBrub,                 null,      /*18 */
                          "N2_AllBrub",          AsDouble(DataSet.AllBrub),      null,      /*19 */
                          "N2_MaterialB",        AsDouble(DataSet.MaterialB),    null,      /*20 */
                          "N2_TaxMaterialB",     AsDouble(DataSet.TaxMaterialB), null,      /*21 */
                          "N2_DifB",             AsDouble(DataSet.DifB),         null,      /*22 */
                          "N2_ComBankB",         AsDouble(DataSet.ComBankB),     null,      /*23 */
                          "N2_ComExcB",          AsDouble(DataSet.ComExcB),      null,      /*24 */
                          "N2_ComB",             AsDouble(DataSet.ComB),         null,      /*25 */
                          "N2_TaxFRlink",        AsDouble(DataSet.TaxFRlink),    null,      /*26 */
                          "N2_SecType",          DataSet.SecType,                null,      /*27 */
                          "N2_TaxTags",          DataSet.TaxTags,                null,      /*28 */
                          "N2_AA",               DataSet.AA,                     null       /*29 */
                         );
        else
          SetCurrentLineFont( 10, true, false );
          PrintTableLine( "N2_SecCode",      ItogsLineName,                  null,           
                /*3  */   "N2_Qnty",         AsDouble(DataSet.Qnty),         null,
                /*8  */   "N2_AllSrub",      AsDouble(DataSet.AllSrub),      null,
                /*9  */   "N2_DifS",         AsDouble(DataSet.DifS),         null,
                /*10 */   "N2_ComBankS",     AsDouble(DataSet.ComBankS),     null,
                /*11 */   "N2_ComExcS",      AsDouble(DataSet.ComExcS),      null,
                /*12 */   "N2_ComS",         AsDouble(DataSet.ComS),         null,
                /*17 */   "N2_AllBrub",      AsDouble(DataSet.AllBrub),      null,
                /*18 */   "N2_MaterialB",    AsDouble(DataSet.MaterialB),    null,
                /*19 */   "N2_TaxMaterialB", AsDouble(DataSet.TaxMaterialB), null,
                /*20 */   "N2_DifB",         AsDouble(DataSet.DifB),         null,
                /*21 */   "N2_ComBankB",     AsDouble(DataSet.ComBankB),     null,
                /*22 */   "N2_ComExcB",      AsDouble(DataSet.ComExcB),      null,
                /*23 */   "N2_ComB",         AsDouble(DataSet.ComB),         null,
                /*24 */   "N2_TaxFRlink",    AsDouble(DataSet.TaxFRlink),    null
                         );
        end;

        UseProgress(i = i + 1);

      end;

      RemProgress();

      if(WasPrinted)
        EndTable();
        CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
      end;
      
    end;

    return WasPrinted;
  END;

  MACRO CerateInvestDedRep()
    var query, DataSet, cmd;
    var SheetName = "Инвестиционный вычет";
    var CurrSheetName = CorrectSheetName(m_CurrInvestorSheetName + "_" + SheetName);
    var cnt = 0, i = 0;
    var WasPrinted = false;

    this.SetCurrentLineFont( 8, false, false );

    
    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_invest_dbt "
            + "  where t_GUID = ? ";

    cmd.AddParam(m_GUID);

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      query = "select q.* from ("+query+") q order by q.t_GUID ASC, q.t_Itog ASC, q.t_Sort ASC";

      DataSet = cmd.Execute(query);

      InitProgress( cnt, CurrSheetName, CurrSheetName );
      while(DataSet.moveNext())
          
        if(WasPrinted == false)
          UseNewSheetInTotalBook();
          SetActiveSheet( SheetName );

          PrintFormatString( NULL,
                             "N5_Dbeg",       GetTotalCalcField("Dbeg"),
                             "N5_Dend",       GetTotalCalcField("Dend"),
                             "N5_Client",     GetTotalCalcField("Client"),
                             "N5_SumFR",      GetTotalCalcField("SumFR"),
                             "N5_MinusG_618", GetTotalCalcField("SumMinusG_618"),
                             "N5_Index_618",  GetTotalCalcField("Index_618"),
                             "N5_Limit_618",  GetTotalCalcField("Limit_618")
                            );
          CopyAllSheetInTotalBook(SheetName, false, "N5_ReportHeader", 0, CurrSheetName);

          CopyAllSheetInTotalBook(SheetName, false, "N5_TableHeader", 0, CurrSheetName);
          RegisterTable( "N5_MainTable", NULL,
               /*1  */   "N5_SecCode",     
               /*2  */   "N5_SecName",     
               /*3  */   "N5_Qnty",
               /*4  */   "N5_ContractS",   
               /*5  */   "N5_CodeS",       
               /*6  */   "N5_DZS",         
               /*7  */   "N5_DPS",         
               /*8  */   "N5_PrSrub",      
               /*9  */   "N5_AllSrub",     
               /*10 */   "N5_ComS",
               /*11 */   "N5_ContractB",    
               /*12 */   "N5_CodeB",       
               /*13 */   "N5_DZB",         
               /*14 */   "N5_DPB",         
               /*15 */   "N5_PrBrub",      
               /*16 */   "N5_AllBrub",     
               /*17 */   "N5_ComB",        
               /*18 */   "N5_Plusi",
               /*19 */   "N5_FR_Sec_3Y",
               /*20 */   "N5_TaxTagsYears"
               );
        end;

        WasPrinted = true;

        if(DataSet.Itog == UNSET_CHAR)
          PrintTableLine( "N5_SecCode",      DataSet.SecCode,                null,
                          "N5_SecName",      DataSet.SecName,                null,
                          "N5_Qnty",         AsDouble(DataSet.Qnty),         null,
                          "N5_ContractS",    DataSet.ContractS,              null,
                          "N5_CodeS",        DataSet.CodeS,                  null,
                          "N5_DZS",          AsDate(DataSet.DZS),            null,
                          "N5_DPS",          AsDate(DataSet.DPS),            null,
                          "N5_PrSrub",       AsDouble(DataSet.PrSrub),       null,
                          "N5_AllSrub",      AsDouble(DataSet.AllSrub),      null,
                          "N5_ComS",         AsDouble(DataSet.ComS),         null,
                          "N5_ContractB",    DataSet.ContractB,              null,
                          "N5_CodeB",        DataSet.CodeB,                  null,
                          "N5_DZB",          AsDate(DataSet.DZB),            null,
                          "N5_DPB",          AsDate(DataSet.DPB),            null,
                          "N5_PrBrub",       AsDouble(DataSet.PrBrub),       null,
                          "N5_AllBrub",      AsDouble(DataSet.AllBrub),      null,
                          "N5_ComB",         AsDouble(DataSet.ComB),         null,
                          "N5_Plusi",        AsDouble(DataSet.Plusi),        null,
                          "N5_FR_Sec_3Y",    AsDouble(DataSet.FR_Sec_3Y),    null,
                          "N5_TaxTagsYears", AsDouble(DataSet.TaxTagsYears), null
                        );
        else
          SetCurrentLineFont( 10, true, false );
          PrintTableLine( "N5_SecCode",      ItogsLineName,    null,           
                /*1  */   "N5_Qnty",         AsDouble(DataSet.Qnty),               null,
                /*2  */   "N5_AllSrub",      AsDouble(DataSet.AllSrub),            null,
                /*3  */   "N5_ComS",         AsDouble(DataSet.ComS),               null,
                /*4  */   "N5_AllBrub",      AsDouble(DataSet.AllBrub),            null,
                /*5  */   "N5_ComB",         AsDouble(DataSet.ComB),               null,
                /*6  */   "N5_FR_Sec_3Y",    GetTotalCalcField("SumFR"),           null
                        );
        end;

        UseProgress(i = i + 1);

      end;

      RemProgress();
      
      if(WasPrinted)
        EndTable();
        CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, CurrSheetName);
      end;
    end;

    return WasPrinted;
  END;

  //Общая информация
  PRIVATE MACRO CreateTotalCalc()
    var SheetName = "Справка по расчету НДФЛ";
    var CurrSheetName = m_CurrInvestorSheetName;

    this.SetCurrentLineFont( 8, false, false );
    
    SetActiveSheet( SheetName );  
    PrintFormatString( NULL,
                       "N1_Dbeg",            date(GetTotalCalcField("Dbeg")),     // за период с
                       "N1_Dend",            date(GetTotalCalcField("Dend")),        // по
                       "N1_Dsys",            date(GetTotalCalcField("Dsys")),           // Дата формирования отчета
                       "N1_Client",          GetTotalCalcField("Client"),           // Клиент
                       "N1_ClientStatus",    GetTotalCalcField("ClientStatus"),   // Статус клиента
                       "N1_ReportType",      GetTotalCalcField("ReportType"),   // Тип отчета
                       "N1_DlastNOB",        date(GetTotalCalcField("DlastNOB")):f,     // Дата последнего расчета НОБ 
                       "N1_PreliminaryCalc", GetTotalCalcField("PreliminaryCalc") // текст "Прогнозное значение" или пусто
                      );
    CopyAllSheetInTotalBook(SheetName, false, "N1_ReportHeader", 0, CurrSheetName);


    PrintFormatString( NULL,
                       "N1_SNOBType",    GetTotalCalcField("SNOBType"),
                       "N1_SNOBAmount",  GetTotalCalcField("SNOBAmount")            // СНОБ
                      );
    CopyAllSheetInTotalBook(SheetName, false, "N1_SNOB_Line", 0, CurrSheetName);
    

    PrintFormatString( NULL,
                       "N1_SNOBType1",    GetTotalCalcField("SNOBType1"), 
                       "N1_SNOBAmount1",  GetTotalCalcField("SNOBAmount1")            // СНОБ1
                      );
    CopyAllSheetInTotalBook(SheetName, false, "N1_SNOB1_Line", 0, CurrSheetName);

    PrintFormatString( NULL,
                       "N1_SNOBType2",    GetTotalCalcField("SNOBType2"),
                       "N1_SNOBAmount2",  GetTotalCalcField("SNOBAmount2")            // СНОБ2
                      );
    CopyAllSheetInTotalBook(SheetName, false, "N1_SNOB2_Line", 0, CurrSheetName);

    PrintFormatString( NULL,
                      /*                    БО ЦБ и ПИ                           \/                        ДЕПО                                    \/                         ОНБ                               \/       Сумма                      */
                      "N1_TaxFR_Total",     GetTotalCalcField("TaxFR_Total"), 
                      "N1_TaxFR_market",    GetTotalCalcField("TaxFR_market"),          
                      "N1_TaxFR_OTC",       GetTotalCalcField("TaxFR_OTC"),             
                      "N1_TaxFR_Lost",      GetTotalCalcField("TaxFR_Lost"),            
                      "N1_ComDepo",         GetTotalCalcField("ComDepo"),               
                      "N1_CoupRub",         GetTotalCalcField("CoupRub"),        "N1_DepoCoupRub",          GetTotalCalcField("DepoCoupRub"),            
                      "N1_TaxFR_Open",      GetTotalCalcField("TaxFR_Open"),  
                      "N1_RepoFactRub",     GetTotalCalcField("RepoFactRub"), 
                      "N1_RepoTaxRub",      GetTotalCalcField("RepoTaxRub"),  
                      "N1_RepoTaxRach",     GetTotalCalcField("RepoTaxRach"), 
                      "N1_DerivTaxRub",     GetTotalCalcField("DerivTaxRub"), 
                      "N1_BaseMaterial",    GetTotalCalcField("BaseMaterial"),
                                                                                                                                                     "N1_BaseBill",            GetTotalCalcField("BaseBill"),         
                                                                                                                                                     "N1_OtherIncome",         GetTotalCalcField("OtherIncome"),      
                      "N1_TaxBase_618",     GetTotalCalcField("TaxBase_618"),    "N1_DepoTaxBase_618",      GetTotalCalcField("DepoTaxBase_618"),                                                 
                      "N1_MinusG_618",      GetTotalCalcField("MinusG_618"),     "N1_DepoMinusG_618",       GetTotalCalcField("DepoMinusG_618"),                                                  
                      "N1_MinusG_619",      GetTotalCalcField("MinusG_619"),                                                                                                                      
                      "N1_MinusG_517",      GetTotalCalcField("MinusG_517"),                                                                                                                      
                                                                                                                                                                                                  
                      "N1_TaxBaseAll",      GetTotalCalcField("TaxBaseAll"),     "N1_DepoTaxBaseAll",       GetTotalCalcField("DepoTaxBaseAll"),     "N1_OnbTaxBaseAll",       GetTotalCalcField("OnbTaxBaseAll"),    
                      "N1_TaxBase_13",      GetTotalCalcField("TaxBase_13"),     "N1_DepoTaxBase_13",       GetTotalCalcField("DepoTaxBase_13"),     "N1_OnbTaxBase_13",       GetTotalCalcField("OnbTaxBase_13"),    
                      "N1_TaxBase_15",      GetTotalCalcField("TaxBase_15"),     "N1_DepoTaxBase_15",       GetTotalCalcField("DepoTaxBase_15"),     "N1_OnbTaxBase_15",       GetTotalCalcField("OnbTaxBase_15"),    
                                                                                                                                                     "N1_OnbTaxBase_18",       GetTotalCalcField("OnbTaxBase_18"),    
                                                                                                                                                     "N1_OnbTaxBase_20",       GetTotalCalcField("OnbTaxBase_20"),    
                                                                                                                                                     "N1_OnbTaxBase_22",       GetTotalCalcField("OnbTaxBase_22"),    
                                                                                                                                                                                                  
                      "N1_TaxDueYear",      GetTotalCalcField("TaxDueYear"),     "N1_DepoTaxDueYear",       GetTotalCalcField("DepoTaxDueYear"),     "N1_OnbTaxDueYear",       GetTotalCalcField("OnbTaxDueYear"),    
                      "N1_TaxDueYear_13",   GetTotalCalcField("TaxDueYear_13"),  "N1_DepoTaxDueYear_13",    GetTotalCalcField("DepoTaxDueYear_13"),  "N1_OnbTaxDueYear_13",    GetTotalCalcField("OnbTaxDueYear_13"), 
                      "N1_TaxDueYear_15",   GetTotalCalcField("TaxDueYear_15"),  "N1_DepoTaxDueYear_15",    GetTotalCalcField("DepoTaxDueYear_15"),  "N1_OnbTaxDueYear_15",    GetTotalCalcField("OnbTaxDueYear_15"), 
                                                                                                                                                     "N1_OnbTaxDueYear_18",    GetTotalCalcField("OnbTaxDueYear_18"), 
                                                                                                                                                     "N1_OnbTaxDueYear_20",    GetTotalCalcField("OnbTaxDueYear_20"), 
                                                                                                                                                     "N1_OnbTaxDueYear_22",    GetTotalCalcField("OnbTaxDueYear_22"), 
                                                                                                                                                                                                  
                                                                                                                                                                                                  
                      "N1_TaxPaid_all",     GetTotalCalcField("TaxPaid_all"),    "N1_DepoTaxPaid_all",      GetTotalCalcField("DepoTaxPaid_all"),    "N1_OnbTaxPaid_all",      GetTotalCalcField("OnbTaxPaid_all"),   
                      "N1_TaxPaid",         GetTotalCalcField("TaxPaid"),        "N1_DepoTaxPaid",          GetTotalCalcField("DepoTaxPaid"),        "N1_OnbTaxPaid",          GetTotalCalcField("OnbTaxPaid"),       
                      "N1_TaxPaid_15",      GetTotalCalcField("TaxPaid_15"),     "N1_DepoTaxPaid_15",       GetTotalCalcField("DepoTaxPaid_15"),     "N1_OnbTaxPaid_15",       GetTotalCalcField("OnbTaxPaid_15"),    
                                                                                                                                                     "N1_OnbTaxPaid_18",       GetTotalCalcField("OnbTaxPaid_18"),    
                                                                                                                                                     "N1_OnbTaxPaid_20",       GetTotalCalcField("OnbTaxPaid_20"),    
                                                                                                                                                     "N1_OnbTaxPaid_22",       GetTotalCalcField("OnbTaxPaid_22"),    
                                                                                                                                                                                                  
                                                                                                                                                                                                  
                      "N1_TaxDueNow1_all",  GetTotalCalcField("TaxDueNow1_all"), "N1_DepoTaxDueNow1_all",   GetTotalCalcField("DepoTaxDueNow1_all"), "N1_OnbTaxDueNow1_all",   GetTotalCalcField("OnbTaxDueNow1_all"),
                      "N1_TaxDueNow1",      GetTotalCalcField("TaxDueNow1"),     "N1_DepoTaxDueNow1",       GetTotalCalcField("DepoTaxDueNow1"),     "N1_OnbTaxDueNow1",       GetTotalCalcField("OnbTaxDueNow1"),                                                           
                      "N1_TaxDueNow1_15",   GetTotalCalcField("TaxDueNow1_15"),  "N1_DepoTaxDueNow1_15",    GetTotalCalcField("DepoTaxDueNow1_15"),  "N1_OnbTaxDueNow1_15",    GetTotalCalcField("OnbTaxDueNow1_15"), 
                                                                                                                                                     "N1_OnbTaxDueNow1_18",    GetTotalCalcField("OnbTaxDueNow1_18"), 
                                                                                                                                                     "N1_OnbTaxDueNow1_20",    GetTotalCalcField("OnbTaxDueNow1_20"), 
                                                                                                                                                     "N1_OnbTaxDueNow1_22",    GetTotalCalcField("OnbTaxDueNow1_22") 
                     );
    CopyAllSheetInTotalBook( SheetName, false, "N1_ReportBody", 0, CurrSheetName);

    CopyAllSheetInTotalBook( SheetName, false, "N1_Footer", 0, CurrSheetName);
  END;

  

  PRIVATE MACRO CreateReportNPTXLucre()
    var SheetName = "МатВыгода";
    var CurrSheetName = m_CurrInvestorSheetName + "_" + SheetName;
    var query, cmd = NULL, DataSet;
    var count = 0;
    var WasPrinted = false;

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_lucre_dbt "
            + "  where t_GUID = ? "
            + " order by t_GUID ASC, t_Itog ASC, t_Sort ASC";

    cmd.AddParam(m_GUID);

    count = cmd.GetCount(query);

    var i = 0;

    if(count > 0)

       InitProgress(count, "Печать данных по материальной выгоде для клиента " + m_RepData.ClientName());

       DataSet = cmd.Execute(query);

       while(DataSet.MoveNext())

          if(WasPrinted == false)
            this.SetCurrentLineFont( 8, false, false );

            UseNewSheetInTotalBook();
            SetActiveSheet(SheetName);
        
            PrintFormatString(NULL,
                              "N6_Dbeg",   GetTotalCalcField("Dbeg"), 
                              "N6_Dend",   GetTotalCalcField("Dend"), 
                              "N6_Client", GetTotalCalcField("Client")
                             );
        
            CopyAllSheetInTotalBook(SheetName, false, "N6_ReportHeader", 0, CurrSheetName);
        
            RegisterTable("N6_MainTable", NULL,
                          "N6_SecCode",
                          "N6_SecName",
                          "N6_VN",
                          "N6_ContractB",
                          "N6_CodeB",
                          "N6_DZB",
                          "N6_DDB",
                          "N6_DPB",
                          "N6_Qnty",
                          "N6_PrBvp",
                          "N6_ValB",
                          "N6_VpB",
                          "N6_CrBD",
                          "N6_KZB",
                          "N6_MainBvp",
                          "N6_MainBrub",
                          "N6_bMrktB",
                          "N6_PriceMrktB",
                          "N6_MrktB",
                          "N6_DMrktB",
                          "N6_ComB",
                          "N6_NomB",
                          "N6_ComB",
                          "N6_SecType",
                          "N6_TaxRate");
          end;

          WasPrinted = true;

          if(DataSet.Itog == UNSET_CHAR)
            PrintTableLine("N6_SecCode",    DataSet.SecCode,              NULL,
                           "N6_SecName",    DataSet.SecName,              NULL,
                           "N6_VN",         DataSet.VN,                   NULL,
                           "N6_ContractB",  DataSet.ContractB,            NULL,
                           "N6_CodeB",      DataSet.CodeB,                NULL,
                           "N6_DZB",        AsDate(DataSet.DZB),          NULL,
                           "N6_DDB",        AsDate(DataSet.DDB),          NULL,
                           "N6_DPB",        AsDate(DataSet.DPB),          NULL,
                           "N6_Qnty",       AsDouble(DataSet.Qnty),       SetPrecisionByFractPart(AsDouble(DataSet.Qnty), DataSet.SumPrecision, 0),
                           "N6_PrBvp",      AsDouble(DataSet.PrBvp),      NULL,
                           "N6_ValB",       DataSet.ValB,                 NULL,
                           "N6_VpB",        DataSet.VpB,                  NULL,
                           "N6_CrBD",       AsDouble(DataSet.CrBD),       NULL,
                           "N6_KZB",        AsDouble(DataSet.KZB),        NULL,
                           "N6_MainBvp",    AsDouble(DataSet.MainBvp),    NULL,
                           "N6_MainBrub",   AsDouble(DataSet.MainBrub),   NULL,
                           "N6_bMrktB",     DataSet.bMrktB,               NULL,
                           "N6_PriceMrktB", AsDouble(DataSet.PriceMrktB), NULL,
                           "N6_MrktB",      DataSet.MrktB,                NULL,
                           "N6_DMrktB",     AsDate(DataSet.DMrktB),       NULL,
                           "N6_ComB",       AsDouble(DataSet.ComB),       NULL,
                           "N6_NomB",       AsDouble(DataSet.NomB),       NULL,
                           "N6_ContB",      DataSet.ContB,                NULL,
                           "N6_SecType",    DataSet.SecType,              NULL,
                           "N6_TaxRate",    DataSet.TaxRate,              NULL
                          );
          else
            SetCurrentLineFont( 10, true, false );

            PrintTableLine("N6_SecCode",    "",           NULL,
                           "N6_SecName",    "",           NULL,
                           "N6_VN",         "",           NULL,
                           "N6_ContractB",  "",           NULL,
                           "N6_CodeB",      "",           NULL,
                           "N6_DZB",        "",           NULL,
                           "N6_DDB",        "",           NULL,
                           "N6_DPB",        "",           NULL,
                           "N6_Qnty",       AsDouble(DataSet.Qnty),      NULL,
                           "N6_PrBvp",      "",           NULL,
                           "N6_ValB",       "",           NULL,
                           "N6_VpB",        "",           NULL,
                           "N6_CrBD",       "",           NULL,
                           "N6_KZB",        "",           NULL,
                           "N6_MainBvp",    AsDouble(DataSet.MainBvp),   NULL,
                           "N6_MainBrub",   AsDouble(DataSet.MainBrub),  NULL,
                           "N6_bMrktB",     "",           NULL,
                           "N6_PriceMrktB", "",           NULL,
                           "N6_MrktB",      "",           NULL,
                           "N6_DMrktB",     "",           NULL,
                           "N6_ComB",       AsDouble(DataSet.ComB),      NULL,
                           "N6_NomB",       "",           NULL,
                           "N6_ContB",      "",           NULL,
                           "N6_SecType",    "",           NULL,
                           "N6_TaxRate",    "",           NULL); 

            ExternalSetCellPoint("N6_Qnty", SetPrecisionByFractPart(AsDouble(DataSet.Qnty), DataSet.SumPrecision, 0));
          end;

          UseProgress(i = i + 1);
       end;

       RemProgress();

       if(WasPrinted)
         EndTable();
         CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, CurrSheetName);
       end;
    end;

    return WasPrinted;
  END;

  // Биржевые производные инструменты
  MACRO CreateReportPFIExchange()
    var i = 0;
    var SheetName = "ПИ_бирж.";
    var CurrSheetName = m_CurrInvestorSheetName + "_" + SheetName;
    var WasPrinted = false;
    var query, cmd, DataSet;
    var count = 0;

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_pfiexchange_dbt "
            + "  where t_GUID = ? "
            + " order by t_GUID ASC, t_Itog ASC, t_Sort ASC";

    cmd.AddParam(m_GUID);

    count = cmd.GetCount(query);

    if(count > 0)
      SetActiveSheet( SheetName );

      InitProgress(count, CurrSheetName, CurrSheetName);

      DataSet = cmd.Execute(query);
    
      while(DataSet.moveNext())
        
        if(WasPrinted == false)
          UseNewSheetInTotalBook();
          SetActiveSheet( SheetName );  
          PrintFormatString( NULL,
                             "N7_Dbeg",    GetTotalCalcField("Dbeg"),     // за период с
                             "N7_Dend",    GetTotalCalcField("Dend"),     // по
                             "N7_Client1", GetTotalCalcField("Client")    // Клиент
                            );

          CopyAllSheetInTotalBook(SheetName, false, "N7_ReportHeader", 0, CurrSheetName);

          RegisterTable( "N7_MainTable", NULL,
                         "N7_Client",
                         "N7_ClientStatus",
                         "N7_SecCode",
                         "N7_FICode",
                         "N7_FIName",
                         "N7_FIType",
                         "N7_BaseType",
                         "N7_BaseCode",
                         "N7_BaseName",
                         "N7_TradePlace",
                         "N7_ContractS",
                         "N7_Dpos",
                         "N7_Qbuy",
                         "N7_Qsell",
                         "N7_Qlong",
                         "N7_Material",
                         "N7_VarPos",
                         "N7_VarNeg",
                         "N7_PremPos",
                         "N7_PremNeg",
                         "N7_Com",
                         "N7_FR",
                         "N7_bMarket",
                         "N7_TaxRate"
                       );
        end;

        WasPrinted = true;

        PrintTableLine( "N7_Client",       DataSet.Client,              null,
                        "N7_ClientStatus", DataSet.ClientStatus,        null,
                        "N7_SecCode",      DataSet.SecCode,             null,
                        "N7_FICode",       DataSet.FICode,              null,
                        "N7_FIName",       DataSet.FIName,              null,
                        "N7_FIType",       DataSet.FIType,              null,
                        "N7_BaseType",     DataSet.BaseType,            null,
                        "N7_BaseCode",     DataSet.BaseCode,            null,
                        "N7_BaseName",     DataSet.BaseName,            null,
                        "N7_TradePlace",   DataSet.TradePlace,          null,
                        "N7_ContractS",    DataSet.ContractS,           null,
                        "N7_Dpos",         AsDate(DataSet.Dpos),        null,
                        "N7_Qbuy",         AsDouble(DataSet.Qbuy),      null,
                        "N7_Qsell",        AsDouble(DataSet.Qsell),     null,
                        "N7_Qlong",        AsDouble(DataSet.Qlong),     null,
                        "N7_Material",     AsDouble(DataSet.Material),  null,
                        "N7_VarPos",       AsDouble(DataSet.VarPos),    null,
                        "N7_VarNeg",       AsDouble(DataSet.VarNeg),    null,
                        "N7_PremPos",      AsDouble(DataSet.PremPos),   null,
                        "N7_PremNeg",      AsDouble(DataSet.PremNeg),   null,
                        "N7_Com",          AsDouble(DataSet.Com),       null,
                        "N7_FR",           AsDouble(DataSet.FR),        null,
                        "N7_bMarket",      DataSet.bMarket,             null,
                        "N7_TaxRate",      AsDouble(DataSet.TaxRate),   null
                      );

        UseProgress(i = i + 1);
      end;

      RemProgress();

      if(WasPrinted)
        EndTable();

        CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 2, CurrSheetName);

        SetSubTotalEx(0, 8, "N7_F12",
                            "N7_F13",
                            "N7_F15",
                            "N7_F16",
                            "N7_F17",
                            "N7_F18",
                            "N7_F19",
                            "N7_F20",
                            "N7_F21"
                     );

        CopyAllSheetInTotalBook(SheetName, false, "N7_Totals", "A6", CurrSheetName);
      end;
    end;

    return WasPrinted;
  END;

  // Внебиржевые производные инструменты
  MACRO CreateReportPFIOutExchange()
    var i = 0, needprint = false, isPrintHead = false, isRegTable = false;
    var SheetName = "ПИ_внебирж.";
    var CurrSheetName = m_CurrInvestorSheetName + "_" + SheetName;
    var WasPrinted = false;
    var query, cmd, DataSet;
    var count = 0;

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_pfioutexchange_dbt "
            + "  where t_GUID = ? "
            + " order by t_GUID ASC, t_Itog ASC, t_Sort ASC";

    cmd.AddParam(m_GUID);

    count = cmd.GetCount(query);

    if(count > 0)
      SetActiveSheet( SheetName );  

      InitProgress(count, CurrSheetName, CurrSheetName);

      DataSet = cmd.Execute(query);
    
      while(DataSet.moveNext())
          
        if(WasPrinted == false)
          PrintFormatString( NULL,
                             "N8_Dbeg",    GetTotalCalcField("Dbeg"),     // за период с
                             "N8_Dend",    GetTotalCalcField("Dend"),        // по
                             "N8_Client1", GetTotalCalcField("Client")    // Клиент
                           );

          CopyAllSheetInTotalBook(SheetName, false, "N8_ReportHeader", 0, CurrSheetName);
          
          RegisterTable( "N8_MainTable", NULL,
                         "N8_Client",
                         "N8_ClientStatus",
                         "N8_ContractS",
                         "N8_DealDate",
                         "N8_ContractN",
                         "N8_ContractType",
                         "N8_Direction",
                         "N8_Contract",
                         "N8_BaseType",
                         "N8_FIType",
                         "N8_ExpirationDate",
                         "N8_Q",
                         "N8_Contragent",
                         "N8_ExpirationPriceCur",
                         "N8_PriceCurrency",
                         "N8_MarketPrice",
                         "N8_Material",
                         "N8_VarPos",
                         "N8_VarNeg",
                         "N8_PremPos",
                         "N8_PremNeg",
                         "N8_Com",
                         "N8_FR"
                       );

        end;

        WasPrinted = true;

        PrintTableLine( "N8_Client",             DataSet.Client,                       null,
                        "N8_ClientStatus",       DataSet.ClientStatus,                 null,
                        "N8_ContractS",          DataSet.ContractS,                    null,
                        "N8_DealDate",           AsDate(DataSet.DealDate),             null,
                        "N8_ContractN",          DataSet.ContractN,                    null,
                        "N8_ContractType",       DataSet.ContractType,                 null,
                        "N8_Direction",          DataSet.Direction,                    null,
                        "N8_Contract",           DataSet.Contract,                     null,
                        "N8_BaseType",           DataSet.BaseType,                     null,
                        "N8_FIType",             DataSet.FIType,                       null,
                        "N8_ExpirationDate",     AsDate(DataSet.ExpirationDate),       null,
                        "N8_Q",                  AsDouble(DataSet.Q),                  null,
                        "N8_Contragent",         DataSet.Contragent,                   null,
                        "N8_ExpirationPriceCur", AsDouble(DataSet.ExpirationPriceCur), null,
                        "N8_PriceCurrency",      DataSet.PriceCurrency,                null,
                        "N8_MarketPrice",        AsDouble(DataSet.MarketPrice),        null,
                        "N8_Material",           AsDouble(DataSet.Material),           null,
                        "N8_VarPos",             AsDouble(DataSet.VarPos),             null,
                        "N8_VarNeg",             AsDouble(DataSet.VarNeg),             null,
                        "N8_PremPos",            AsDouble(DataSet.PremPos),            null,
                        "N8_PremNeg",            AsDouble(DataSet.PremNeg),            null,
                        "N8_Com",                AsDouble(DataSet.Com),                null,
                        "N8_FR",                 AsDouble(DataSet.FR),                 null
                      );

        UseProgress(i = i + 1);
      end;

      RemProgress();

      if(WasPrinted)
        EndTable();

        CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 2, CurrSheetName);

        SetSubTotalEx(0, 9, "N8_F16",
                            "N8_F17",
                            "N8_F18",
                            "N8_F19",
                            "N8_F20",
                            "N8_F21",
                            "N8_F22"
                     );

        CopyAllSheetInTotalBook(SheetName, false, "N8_Totals", "A7", CurrSheetName);
      end;
    end;

    return WasPrinted;
  END;

  PRIVATE MACRO CreateReportBill()
    var SheetName = "Векселя";
    var CurrSheetName = m_CurrInvestorSheetName + "_" + SheetName;
    var query, cmd = NULL;
    var count = 0;
    var M = $0;
    var WasPrinted = false;
    var i = 0;

    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_bill_dbt "
            + "  where t_GUID = ? "
            + " order by t_GUID ASC, t_Itog ASC, t_Sort ASC";

    cmd.AddParam(m_GUID);

    count = cmd.GetCount(query);

    if(count > 0)
       InitProgress(count, "Печать данных по векселям для клиента " + m_RepData.ClientName());

       var DataSet = cmd.Execute(query);

       while(DataSet.MoveNext())

          if(WasPrinted == false)
            this.SetCurrentLineFont( 8, false, false );

            UseNewSheetInTotalBook();
            SetActiveSheet(SheetName);
        
            PrintFormatString(NULL,
                              "N9_Dbeg",   GetTotalCalcField("Dbeg"), 
                              "N9_Dend",   GetTotalCalcField("Dend"), 
                              "N9_Client", GetTotalCalcField("Client")
                             );
        
            CopyAllSheetInTotalBook(SheetName, false, "N9_ReportHeader", 0, CurrSheetName);
        
            RegisterTable("N9_MainTable", NULL,
                          "N9_DocNumber", 
                          "N9_DOper", 
                          "N9_NBill", 
                          "N9_Cost",  
                          "N9_Repayment",     
                          "N9_Interest",      
                          "N9_Discount",      
                          "N9_SumNOB"
                         );
          end;

          WasPrinted = true;

          if(DataSet.Itog == UNSET_CHAR)
            PrintTableLine("N9_DocNumber", DataSet.DocNumber,           NULL,
                           "N9_DOper",     AsDate(DataSet.DOper),       NULL,
                           "N9_NBill",     DataSet.NBill,               NULL,
                           "N9_Cost",      AsDouble(DataSet.Cost),      NULL,
                           "N9_Repayment", AsDouble(DataSet.Repayment), NULL,
                           "N9_Interest",  AsDouble(DataSet.Interest),  NULL,
                           "N9_Discount",  AsDouble(DataSet.Discount),  NULL,
                           "N9_SumNOB",    AsDouble(DataSet.SumNOB),    NULL
                          );
          else
            SetCurrentLineFont( 10, true, false );

            PrintTableLine("N9_DocNumber", ItogsLineName,               NULL,
                           "N9_DOper",     NULL,                        NULL,
                           "N9_NBill",     NULL,                        NULL,
                           "N9_Cost",      AsDouble(DataSet.Cost),      NULL,
                           "N9_Repayment", AsDouble(DataSet.Repayment), NULL,
                           "N9_Interest",  AsDouble(DataSet.Interest),  NULL,
                           "N9_Discount",  AsDouble(DataSet.Discount),  NULL,
                           "N9_SumNOB",    AsDouble(DataSet.SumNOB),    NULL
                          );
          end;

          UseProgress(i = i + 1);
       end;
       
       RemProgress();

       if(WasPrinted)
         EndTable();

         CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, CurrSheetName);
       end;
    end;

    return WasPrinted;
  END;

  PRIVATE MACRO CreateProtocol()
    var SheetName = "Протокол";
    var CurrSheetName = m_CurrInvestorSheetName + "_" + SheetName;
    var query, cmd = NULL;
    var count = 0;
    var WasPrinted = false;
    var i = 0;
    
    cmd = DL_RSDCommand();

    query =   " select * "
            + "   from dnptxshort_protocol_dbt "
            + "  where t_GUID = ? "
            + " order by t_GUID ASC, t_Itog ASC, t_Sort ASC";

    cmd.AddParam(m_GUID);

    count = cmd.GetCount(query);

    if(count > 0)

       InitProgress(count, "Печать протокола для клинета " + m_RepData.ClientName());

       var DataSet = cmd.Execute(query);

       while(DataSet.MoveNext())

          if(WasPrinted == false)
            this.SetCurrentLineFont( 8, false, false );

            UseNewSheetInTotalBook();
            SetActiveSheet(SheetName);
        
            PrintFormatString(NULL,
                              "N10_Dbeg",   GetTotalCalcField("Dbeg"), 
                              "N10_Dend",   GetTotalCalcField("Dend"), 
                              "N10_Client", GetTotalCalcField("Client")
                             );
        
            CopyAllSheetInTotalBook(SheetName, false, "N10_ReportHeader", 0, CurrSheetName);
        
            RegisterTable("N10_MainTable", NULL,
                          "N10_IncomeNDR",   
                          "N10_IncomeCode",    
                          "N10_IncomeName",    
                          "N10_IncomeSum",     
                          "N10_ExpenseNDR",    
                          "N10_ExpenseCode",   
                          "N10_ExpenseName",   
                          "N10_ExpenseSum"
                         );
          end;

          WasPrinted = true;


          PrintTableLine("N10_IncomeNDR",   DataSet.IncomeNDR,            NULL,
                         "N10_IncomeCode",  DataSet.IncomeCode,           NULL,
                         "N10_IncomeName",  DataSet.IncomeName,           NULL,
                         "N10_IncomeSum",   AsDouble(DataSet.IncomeSum),  NULL,
                         "N10_ExpenseNDR",  DataSet.ExpenseNDR,           NULL,
                         "N10_ExpenseCode", DataSet.ExpenseCode,          NULL,
                         "N10_ExpenseName", DataSet.ExpenseName,          NULL,
                         "N10_ExpenseSum",  AsDouble(DataSet.ExpenseSum), NULL
                        );
          
          UseProgress(i = i + 1);
       end;
       
       RemProgress();

       if(WasPrinted)
         EndTable();

         CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, CurrSheetName);
       end;
    end;

    return WasPrinted;
  END;

  //Старт
  PRIVATE MACRO Create()
    var query, DataSet, cmd;
    var stat = 0;
    var Year = 0;
    var cnt = 0, i = 0;

    if(LoadRepParam() == false)
      return 1;
    end;

    query = "select * from dnptxshort_totalcalc_dbt where t_GUID = ?";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_GUID);
    
    cnt = cmd.GetCount(query);
    if(cnt > 0)
      InitProgress(1, "Краткая справка по расчету НДФЛ", "Краткая справка по расчету НДФЛ" );

      DataSet = cmd.Execute(query);
      stat = DataSet.moveNext();
      if(stat)

        m_CurrInvestorSheetName = IIF(m_ByIIS, "ИИС", "")+m_InvestorFIO;

        stat = DataSet.moveNext();

        //Общий расчет
        CreateTotalCalc();

        if(SET_CHAR == m_NeedRealizList)
          CreateRealizRep();
        end;

        if(SET_CHAR == m_NeedShortPosList)
          CreateShortPosRep();
        end;
        
        if(SET_CHAR == m_NeedRepoList)
          CreateRepoRep();
        end;

        if((m_ReportType == DL_TXHOLD_OPTYPE_ENDYEAR) or (m_ReportType == DL_TXHOLD_OPTYPE_CLOSE) or (m_ReportType == DL_TXHOLD_OPTYPE_OUTMONEY))
          CerateInvestDedRep();
        end;

        if(SET_CHAR == m_NeedLucreList)
          CreateReportNPTXLucre();
        end;

        if(SET_CHAR == m_NeedPFIList)
          CreateReportPFIExchange();
          CreateReportPFIOutExchange();
        end;

        if(SET_CHAR == m_NeedBillList)
          CreateReportBill();
        end;

        if(SET_CHAR == m_NeedProtocolList)
          CreateProtocol();
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();
    else
      SetActiveSheet( "Справка по расчету НДФЛ" );  
      PrintFormatString( NULL,"N1_NoRepData","Нет данных, удовлетворяющих параметрам отчета");
      CopyAllSheetInTotalBook( "Справка по расчету НДФЛ", false, "N1_NoRepData", 0 );
    end;

  END;


  MACRO Run()
    Run();
    
    for (var fileName, GetFullReportFileNames())
      return fileName;
    end;

    return "";
  END;

  initTX_RegistrReport( NULL, "Report_NptxShort_2025.xlsx", NULL, NULL, NULL, POI_MODE, false );
END;


PRIVATE MACRO RunRep(EndDate,
                     RepType,
                     ByDepo,
                     AvrKind,
                     AvrFIID,
                     NeedRealizList,
                     NeedShortPosList,
                     NeedRepoList,
                     NeedLucreList,
                     NeedPFIList,
                     NeedBillList,    
                     NeedProtocolList,
                     Include_Tech,
                     ByIIS,
                     ClientID,
                     DlContrID,
                     ShowRep
                    )
  
  var SystDate, SystTime;
  GetSystDateTime(@SystDate, @SystTime);

  var GUID = DL_GetGUID();
  var query, ins, del;

  query = "INSERT INTO DNPTXSHORT_REPPARM_DBT (T_GUID, "
                                           + " T_ENDDATE, "
                                           + " T_REPTYPE, "
                                           + " T_BYDEPO,  "
                                           + " T_AVRKIND, "
                                           + " T_AVRFIID, "
                                           + " T_NEEDREALIZLIST, "
                                           + " T_NEEDSHORTPOSLIST, "
                                           + " T_NEEDREPOLIST, "
                                           + " T_NEEDLUCRELIST, "
                                           + " T_NEEDPFILIST, "
                                           + " T_NEEDBILLLIST, "   
                                           + " T_NEEDPROTOCOLLIST, "
                                           + " T_INCLUDE_TECH, "
                                           + " T_BYIIS, "
                                           + " T_CLIENTID, "
                                           + " T_DLCONTRID "
                                           + " ) "
                              + " VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) ";

  ins = DL_RSDCommand(query);
  ins.AddParam(GUID);
  ins.AddParam(EndDate);
  ins.AddParam(RepType);
  ins.AddParam(ByDepo);
  ins.AddParam(AvrKind);
  ins.AddParam(AvrFIID);
  ins.AddParam(NeedRealizList);
  ins.AddParam(NeedShortPosList);
  ins.AddParam(NeedRepoList);
  ins.AddParam(NeedLucreList);
  ins.AddParam(NeedPFIList);
  ins.AddParam(NeedBillList);
  ins.AddParam(NeedProtocolList);
  ins.AddParam(Include_Tech);
  ins.AddParam(IIF(ByIIS, SET_CHAR, UNSET_CHAR));
  ins.AddParam(ClientID);
  ins.AddParam(DlContrID);

  ins.ExecuteCMD();

  var RepData = NPTXShort2025_Data(GUID);

  RepData.Create();

  var RepObj = NPTXShort2025_Report(RepData, GUID);
  var FullFileNameXLSX = RepObj.Run();
  var ClientFIO = RepData.ClientFIO();
  var ContrNumber = StrSubst(RepData.ContrNumber(), "/","_");

  RepObj = NULL;
  
  var Directory = GetRepPath();
  if(not isStandAlone())
    FullFileNameXLSX = "$"+FullFileNameXLSX;
  end;
  
  if(FullFileNameXLSX != "")
    var day, mon, year;
    var hour, mn, sec;
    var FileName, FileExt;
    var ToFileName, ToFileExt;
    var FromDir = SplitFile(FullFileNameXLSX, FileName, FileExt);
    var ToDir = Directory;

    DateSplit(SystDate, day, mon, year);
    TimeSplit(SystTime, hour, mn, sec);

    var NewFileNameXLSX = "";
    
    if(ByIIS)
      NewFileNameXLSX = ContrNumber+"_"+ClientFIO+"_"+string(hour:o:2)+string(mn:o:2)+string(sec:o:2)+"_"+string(day:o:2)+string(mon:o:2)+string(year)+".xlsx";
    else
      NewFileNameXLSX = ClientFIO+"_"+string(hour:o:2)+string(mn:o:2)+string(sec:o:2)+"_"+string(day:o:2)+string(mon:o:2)+string(year)+".xlsx";
    end;
    
    if(not RenameFile(FullFileNameXLSX, FromDir+NewFileNameXLSX))
      msgbox("Ошибка при переименовании файла отчета");
    else
      if((ToDir != "") and (ToDir != FromDir))
        if(SC_CopyFile(FromDir, ToDir, NewFileNameXLSX, NewFileNameXLSX) != 0)
          msgbox("Ошибка при сохранении файла отчета");
        end;
      end;

      if((ShowRep) and (GetDialogFlag() != 0) and (SP_IsShedulerRunning() == false))
        SC_ShowFile(ToDir, NewFileNameXLSX);
      end;
    end;
  end;

  RepData.ClearData();

  query = "DELETE FROM DNPTXSHORT_REPPARM_DBT WHERE T_GUID = ?";
  del = DL_RSDCommand(query);
  del.AddParam(GUID);

  del.ExecuteCMD();
  
end;

PRIVATE MACRO ExistsNptxopCode(DocKind, Code)
  var query, cmd;

  query = "select 1 from dnptxop_dbt where t_DocKind = ? and t_Code = ?";
  cmd = DL_RSDCommand(query);
  cmd.AddParam(DocKind);
  cmd.AddParam(Code);

  if(cmd.GetCount() > 0)
    return true;
  end;

  return false;
END;

PRIVATE MACRO CheckAndLoadDiasData(ClientID:integer, TaxPeriod:integer)
  var query, cmd, DataSet;
  var MaxLoadDate = date(0,0,0), MaxLoadTime = time(0);
  var MaxTimeStampRegDate = date(0,0,0), MaxTimeStampRegTime = time(0);

  cmd = DL_RSDCommand(query);

  query =   " select q.*, "
          + "        (select MAX(tbe1.t_LoadTime) "
          + "           from dnptxtbext_dbt tbe1 "
          + "          where tbe1.t_ClientID = q.t_ClientID "
          + "            and tbe1.t_TaxPeriod = q.t_TaxPeriod " 
          + "            and tbe1.t_LoadDate = q.MaxLoadDate "
          + "        ) as MaxLoadTime " 
          + "   from (select MAX(tbe.t_LoadDate) as MaxLoadDate, tbe.t_ClientID, tbe.t_TaxPeriod "
          + "           from dnptxtbext_dbt tbe "
          + "          where tbe.t_ClientID = " + cmd.AddParam(ClientID)
          + "            and tbe.t_TaxPeriod = " + cmd.AddParam(TaxPeriod)
          + "          group by tbe.t_ClientID, tbe.t_TaxPeriod "
          + "        ) q";

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    MaxLoadDate = date(DataSet.MaxLoadDate);
    MaxLoadTime = time(DataSet.MaxLoadTime);
  end;

  cmd = DL_RSDCommand(query);

  query =   " select q.*, "
          + "        (select MAX(tbb1.t_TimeStampRegTime) "
          + "           from dnptxtbbuf_dbt tbb1, dnptxtotalbase_dbt stb1 "
          + "          where tbb1.t_ClientID = q.t_ClientID "
          + "            and stb1.t_TBID = tbb1.t_EventID "
          + "            and stb1.t_TaxPeriod = q.t_TaxPeriod " 
          + "            and tbb1.t_TimeStampRegDate = q.MaxTimeStampRegDate "
          + "        ) as MaxTimeStampRegTime " 
          + "   from (select MAX(tbb.t_TimeStampRegDate) as MaxTimeStampRegDate, tbb.t_ClientID, stb.t_TaxPeriod "
          + "           from dnptxtbbuf_dbt tbb, dnptxtotalbase_dbt stb "
          + "          where tbb.t_ClientID = " + cmd.AddParam(ClientID)
          + "            and stb.t_TBID = tbb.t_EventID "
          + "            and stb.t_TaxPeriod = " + cmd.AddParam(TaxPeriod)
          + "          group by tbb.t_ClientID, stb.t_TaxPeriod "
          + "        ) q";

  DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    MaxTimeStampRegDate = date(DataSet.MaxTimeStampRegDate);
    MaxTimeStampRegTime = time(DataSet.MaxTimeStampRegTime);
  end; 

  if((MaxLoadDate < MaxTimeStampRegDate) or ((MaxLoadDate == MaxTimeStampRegDate) and (MaxLoadTime < MaxTimeStampRegTime)))
    var OperCode = "", RefID = 0;
    var SystDate, SystTime;

    GetSystDateTime(@SystDate, @SystTime);
    
    GenerateNumberByReference( 193/*OBJTYPE_GETSNOBPROC*/, 1, @RefID, @OperCode );

    if(OperCode != "")
       var i = 0;
       while(ExistsNptxopCode(DL_GETSNOBPROC, OperCode))
         if(i == 100) //На всякий случай, чтобы не зависла операция
           msgbox("Ошибка при генерации номера операции удержания НДФЛ");
           return;
         end;

         GenerateNumberByReference( 193/*OBJTYPE_GETSNOBPROC*/, 1, @RefID, @OperCode );
         i = i + 1;
       end;
    end;

    var queryInsert = " DECLARE "
                    + " BEGIN "
                    + " INSERT INTO dnptxop_dbt (T_ID, "
                    + "                          T_DOCKIND, "
                    + "                          T_KIND_OPERATION, "
                    + "                          T_SUBKIND_OPERATION, "
                    + "                          T_CODE,"
                    + "                          T_OPERDATE, "
                    + "                          T_CLIENT, "
                    + "                          T_CONTRACT, "
                    + "                          T_PREVDATE, "
                    + "                          T_PLACEKIND, "
                    + "                          T_PLACE, "
                    + "                          T_TAXBASE, "
                    + "                          T_OUTSUM,"
                    + "                          T_OUTCOST,"
                    + "                          T_TOUT,"
                    + "                          T_TOTALTAXSUM,"
                    + "                          T_PREVTAXSUM,"
                    + "                          T_TAXSUM,"
                    + "                          T_TAX, "
                    + "                          T_METHOD,"
                    + "                          T_ACCOUNT, "
                    + "                          T_CURRENCY, "
                    + "                          T_STATUS, "
                    + "                          T_OPER, "
                    + "                          T_DEPARTMENT, "
                    + "                          T_IIS) "
                    + " VALUES (0, "                                //T_ID                    
                    + "         ?, "                                //T_DOCKIND               
                    + "         0, "                                //T_KIND_OPERATION        
                    + "         0, "                                //T_SUBKIND_OPERATION     
                    + "         ?, "                                //T_CODE                  
                    + "         ?, "                                //T_OPERDATE             
                    + "         ?, "                                //T_CLIENT               
                    + "         0, "                                //T_CONTRACT             
                    + "         ?, "                                //T_PREVDATE             
                    + "         0, "                                //T_PLACEKIND             
                    + "         0, "                                //T_PLACE                 
                    + "         0, "                                //T_TAXBASE               
                    + "         0, "                                //T_OUTSUM                
                    + "         0, "                                //T_OUTCOST               
                    + "         0, "                                //T_TOUT                  
                    + "         0, "                                //T_TOTALTAXSUM           
                    + "         0, "                                //T_PREVTAXSUM            
                    + "         0, "                                //T_TAXSUM                
                    + "         0, "                                //T_TAX                  
                    + "         10, "                               //T_METHOD                
                    + "         CHR(1), "                           //T_ACCOUNT              
                    + "         0, "                                //T_CURRENCY             
                    + "         0, "                                //T_STATUS               
                    + "         ?, "                                //T_OPER                 
                    + "         ?, "                                //T_DEPARTMENT            
                    + "         CHR(0)) "                           //T_IIS                 
                    + "         RETURNING T_ID INTO ?; "
                    + " END;"; 

    var cmdInsert = RSDCommand(queryInsert);
    cmdInsert.AddParam("", RSDBP_IN, DL_GETSNOBPROC); //t_DocKind
    cmdInsert.AddParam("", RSDBP_IN, OperCode);       //t_Code
    cmdInsert.AddParam("", RSDBP_IN, SystDate);       //t_OperDate
    cmdInsert.AddParam("", RSDBP_IN, ClientID);       //t_Client
    cmdInsert.AddParam("", RSDBP_IN, date(1,1,TaxPeriod));     //t_PrevDate
    cmdInsert.AddParam("", RSDBP_IN, {Oper});         //t_Oper
    cmdInsert.AddParam("", RSDBP_IN, {OperDprt});     //t_Department
    cmdInsert.AddParam("retId", RSDBP_OUT, v_integer);
  
    SQL_Execute(cmdInsert);

    var ID = SQL_ConvTypeInteger(cmdInsert.value("retId"));

    if(ID > 0)
      var ErrStr = "";
      DL_GetSNOBProcExec(ID, ErrStr);

      if(ErrStr != "")
        msgbox(ErrStr);
      end;
    end;
  end;

END;

PRIVATE MACRO RunNpTXShort2025_Report()
  var Form          = NPTXShort2025_Panel();

  while(Form.Run())

    var EndDate       = Form.GetFieldValue(PNFLD_NPTXSHORT_DATE);
    var ReportType    = Form.GetFieldValue(PNFLD_NPTXSHORT_TYPE);
    var ByDepo        = Form.GetFieldValue(PNFLD_NPTXSHORT_BYDEPO);
    var AvrKind       = Form.GetFieldValue(PNFLD_NPTXSHORT_AVRKIND);
    var AvrFIID       = Form.GetFieldValue(PNFLD_NPTXSHORT_AVRCODE);

    var InvestorArr   = Form.GetFieldValue(PNFLD_NPTXSHORT_INVESTORCODE);
    var IISDlContrArr = Form.GetFieldValue(PNFLD_NPTXSHORT_IIS_NUMBER);

    var NeedRealizList   = Form.GetFieldValue(PNFLD_NPTXSHORT_REALIZ);
    var NeedShortPosList = Form.GetFieldValue(PNFLD_NPTXSHORT_SHORTPOS);
    var NeedRepoList     = Form.GetFieldValue(PNFLD_NPTXSHORT_REPO);
    var NeedLucreList    = Form.GetFieldValue(PNFLD_NPTXSHORT_LUCRE);
    var NeedPFIList      = Form.GetFieldValue(PNFLD_NPTXSHORT_PFI);
    var NeedBillList     = Form.GetFieldValue(PNFLD_NPTXSHORT_BILL);    
    var NeedProtocolList = Form.GetFieldValue(PNFLD_NPTXSHORT_PROTOCOL);

    var By_IIS       = IIF(Form.GetFieldValue(PNFLD_NPTXSHORT_BY_IIS) == SET_CHAR, true, false); 
    var By_NotIIS    = IIF(Form.GetFieldValue(PNFLD_NPTXSHORT_BY_NOT_IIS) == SET_CHAR, true, false);

    var Include_Tech = Form.GetFieldValue(PNFLD_NPTXSHORT_INCLUDE_TECH);

    var BegDate, Year;

    var i = 0;

    datesplit(EndDate, null, null, Year);
    BegDate = date(1,1,Year);

    if(By_NotIIS == true)
      if((InvestorArr != NULL) and (InvestorArr.size > 0))
        var ShowRep = IIF(InvestorArr.size >= 10, 0, 1);
        
        i = 0;
        InitProgress(InvestorArr.size, "Формирование справок для выбранных клиентов", "Формирование справок для выбранных клиентов");
        while(i < InvestorArr.size)

          if(ByDepo)
            CheckAndLoadDiasData(InvestorArr[i], Year);
          end;

          RunRep(EndDate,
                 ReportType,
                 ByDepo,
                 AvrKind,
                 AvrFIID,
                 NeedRealizList,
                 NeedShortPosList,
                 NeedRepoList,
                 NeedLucreList,
                 NeedPFIList,
                 NeedBillList,    
                 NeedProtocolList,
                 Include_Tech,
                 false,
                 InvestorArr[i],
                 0,
                 ShowRep
                );

          UseProgress(i = i + 1);
        end;
        RemProgress();

        if(ShowRep == 0)
          msgbox("Отчеты по выбранным клиентам сформированы. Их можно их найти в папке " + GetRepPath());
        end;
      end;
    end;

    if(By_IIS == true)
      if((IISDlContrArr == NULL) or (IISDlContrArr.size == 0) or (IISDlContrArr[0] <= 0))
        var query, cmd, DataSet;

        IISDlContrArr = TArray();

        cmd = DL_RSDCommand();

        query =   " select dlc.t_DlContrID "
                + "   from ddlcontr_dbt dlc, dsfcontr_dbt sf "
                + "  where sf.t_PartyID = " + cmd.AddParam(InvestorArr[0])
                + "    and sf.t_DateBegin <= " + cmd.AddParam(EndDate)
                + "    and (sf.t_DateClose = " + cmd.AddParam(date(0,0,0))+ " or sf.t_DateClose >= " + cmd.AddParam(BegDate)+ ") "
                + "    and dlc.t_SfContrID = sf.t_ID "
                + "    and dlc.t_IIS = 'X' ";

        DataSet = cmd.Execute(query);
        while(DataSet.moveNext())
          IISDlContrArr[IISDlContrArr.size] = DataSet.DlContrID;
        end; 

        if(IISDlContrArr.size == 0)
          msgbox("Не найдено подходящих договоров ИИС указанного клиента");
        end;
      end;

      if((IISDlContrArr != NULL) and (IISDlContrArr.size > 0))
        
        if(ByDepo)
          CheckAndLoadDiasData(InvestorArr[0], Year);
        end;

        i = 0;
        InitProgress(IISDlContrArr.size, "Формирование справок по договорам ИИС", "Формирование справок по договорам ИИС");
        while(i < IISDlContrArr.size)

          RunRep(EndDate,
                 ReportType,
                 ByDepo,
                 AvrKind,
                 AvrFIID,
                 NeedRealizList,
                 NeedShortPosList,
                 NeedRepoList,
                 NeedLucreList,
                 NeedPFIList,
                 NeedBillList,    
                 NeedProtocolList,
                 Include_Tech,
                 true,
                 InvestorArr[0],
                 IISDlContrArr[i],
                 1
                );

          UseProgress(i = i + 1);
        end;
        RemProgress();
      end;
    end;

  end;

END;

RunNpTXShort2025_Report();
exit(1);
