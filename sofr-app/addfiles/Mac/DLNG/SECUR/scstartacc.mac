/*                           
$Name:             scstartacc.mac
$Module:           ñ•≠≠Î• °„¨†£®
$Description:      ß†Ø„·™, ¢ÎØÆ´≠•≠®• ™Æ≠¢•©•‡† Åì
*/

import BankInter, XmlRpcInter, "scservop.mac", "scntgacccarry.mac", "sp_calc.mac","sp_carbacc.mac", "sp_carcmacc.mac", "sp_carouacc.mac", "scchdateacc.mac", "sp_car2acc.mac", "scchdealacc.mac", "sp_carsacc.mac", "sp_carsmacc.mac", "sp_carsf.mac","sc_closeacc.mac", "settl.mac", "ws_file.mac", "sp_ownacc.mac", "dlutils.mac";
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//áÄèìëä äéçÇÖâÖêÄ

const SC_ACCCONVLOTS  = 14; //Ç®§ ™Æ≠¢•©•‡† îÆ‡¨®‡Æ¢†≠®• ´Æ‚Æ¢ °„Â£†´‚•‡·™Æ£Æ „Á•‚† Åé ñÅ
const SC_ACCCONVCARRY = 15; //Ç®§ ™Æ≠¢•©•‡† ÇÎØÆ´≠•≠®• Ø‡Æ¢Æ§Æ™ °„Â£†´‚•‡·™Æ£Æ „Á•‚† Åé ñÅ

private const SC_REPORTKIND_COMMIS       = 0; //ØÆ ™Æ¨®··®Ô¨
private const SC_REPORTKIND_ACC_TICK     = 1; //ØÆ Ø‡Æ°´•¨≠Æ¨„ ·Á•‚„ ØÆ ·§•´™•
private const SC_REPORTKIND_NULLFIWARNTS = 3; //ØÆ ≠„´•¢Î¨ ™„ØÆ≠†¨/óè
private const SC_REPORTKIND_REPOWTHREPCOUP = 4; //ØÆ ≠•ØÆ£†Ë•≠≠Î¨ ™„ØÆ≠†¨/óè

//Ç®§Î ØÆ§£‡„ØØ
const SUBGRP_TYPE_KVIT  = 1; //ä¢®‚Æ¢™†
const SUBGRP_TYPE_CARRY = 2; //è‡Æ¢Æ§™®

const OBJTYPE_KIND_ANALITIC = 3519;

private var å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà = 100; //å®≠®¨†´Ï≠Æ• ™Æ´-¢Æ ·§•´Æ™ ™´®•≠‚† (™‡Æ¨• ç†Ë•£ÆÅ†≠™†), Á‚Æ°Î £‡„ØØÎ ‰Æ‡¨®‡Æ¢†´®·Ï ¢ ‚Æ¨ Á®·´• · ‡†ß°®¢™Æ© ØÆ îà
private var ê†ß°®¢†‚ÏÇ≠„‚‡®î®ëÆ°·‚¢       = false; //é·„È•·‚¢´Ô‚Ï ´® ‡†ß°®¢™„ ØÆ ·Æ°·‚¢•≠≠Î¨ ¢≠„‚‡® Æ§≠Æ© îà
private var äÆ´®Áë‚‡Æ™É‡†‰®™†ÇèÆ§£‡„ØØ•   = 100; //äÆ´®Á•·‚¢Æ ·‚‡Æ™ £‡†‰®™† ¢ ØÆ§£‡„ØØ• Ø‡Æ¢Æ§Æ™, •·´® ØÆ £‡„ØØ• ·‚‡Æ™ £‡†‰®™† °Æ´ÏË• Ì‚Æ£Æ ™Æ´-¢†
private var ä†‚•£Æ‡®®Ñ´ÔÅ•ß´®¨®‚† = GetIntArrFromRegPath("SECUR\\ëéÅì\\äì_ÅÖáãàåàí");

å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà = GetRegValueOrDefValue("SECUR\\ëéÅì\\åàç_ëÑÖãéä_Ñãü_êÄáÅàÇ_îà_äãàÖç",V_INTEGER,å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà);
ê†ß°®¢†‚ÏÇ≠„‚‡®î®ëÆ°·‚¢       = GetRegValueOrDefValue("SECUR\\ëéÅì\\êÄáÅàÇÄíú_Ççìíêà_îà_ëéÅëí",V_BOOL,ê†ß°®¢†‚ÏÇ≠„‚‡®î®ëÆ°·‚¢);
äÆ´®Áë‚‡Æ™É‡†‰®™†ÇèÆ§£‡„ØØ•   = GetRegValueOrDefValue("SECUR\\ëéÅì\\ëíêéä_ÉêÄîàäÄ_Ç_èÄóäÖ",V_INTEGER,äÆ´®Áë‚‡Æ™É‡†‰®™†ÇèÆ§£‡„ØØ•);

//·‚‡Æ™† · ¢®§†¨® ·‚‡Æ™ £‡†‰®™†, ™Æ‚Æ‡Î• ≠• ≠†§Æ ¢™´ÓÁ†‚Ï ¢ Æ°‡†°Æ‚™„ Ø‡Æ¢Æ§Æ™ Åì
private var DeliveryTemplsStr = DLGR_TEMPL_DELIVERY + ", " +
                                DLGR_TEMPL_DELIVERY2 + ", " +
                                DLGR_TEMPL_COMPDELIVERY + ", " +
                                DLGR_TEMPL_DELIVERYOWN + ", " +
                                DLGR_TEMPL_EXECOWN + ", " +
                                DLGR_TEMPL_DELIVERYCONTR + ", " +    
                                DLGR_TEMPL_DELIVERYCONTR2 + ", " +   
                                DLGR_TEMPL_COMPDELIVERYCONTR;

private var ExcludeTemplStr = DLGR_TEMPL_TRANSFER + ", " +
                              DLGR_TEMPL_DEPODRAFT + ", " +      
                              DLGR_TEMPL_DEPODRAFT2 + ", " +     
                              DLGR_TEMPL_DEPODRAFTCONTR + ", " + 
                              DLGR_TEMPL_DEPODRAFTCONTR2;


                              
private var RepErrArr = TArray(); //¨†··®¢ ÆË®°Æ™
private var ProblemAccRepDataArr = TArray(); //¨†··®¢ ÆË®°Æ™ ß†™‡Î‚®Ô ·Á•‚Æ¢ (Æ‚§•´Ï≠Æ Æ‚ ÆË®°Æ™ ÆØ•‡†Ê®®)

//·‚‡Æ™† · ¢®§†¨® ·‚‡Æ™ £‡†‰®™†, Æ‚≠Æ·ÔÈ®¨·Ô ™ ™´®•≠‚„-™Æ≠‚‡†£•≠‚„
private var CCTemplsStr = DLGR_TEMPL_DELIVERYCONTR + ", " +    
                          DLGR_TEMPL_DELIVERYCONTR2 + ", " +   
                          DLGR_TEMPL_COMPDELIVERYCONTR + ", " +
                          DLGR_TEMPL_PAYCOMCONTR;      

//™´†·· · §†≠≠Î¨® §´Ô ·‚‡Æ™® Ø‡Æ‚Æ™Æ´† ØÆ Ø•‡®Æ§®Á•·™®¨ ™Æ¨®··®Ô¨
class CSC_AccComisRepParm(_SfContrID:integer,
                          _ComisCode:string,
                          _DebAccount:string,
                          _CredAccount:string,
                          _Amount:money,
                          _Currency:integer
)
  var Kind        =  0;           //¢®§ Æ‚Á•‚†
  var SfContrID   = _SfContrID;   //ÑÆ£Æ¢Æ‡ Æ°·´„¶®¢†≠®Ô
  var ComisCode   = _ComisCode;   //ç†®¨•≠Æ¢†≠®• ™Æ¨®·®®
  var DebAccount  = _DebAccount;  //ëÁ•‚ Ñ‚
  var CredAccount = _CredAccount; //ëÁ•‚ ä‚
  var Amount      = _Amount;      //ë„¨¨†
  var Currency    = _Currency;    //Ç†´Ó‚† ·„¨¨Î
end;

CLASS (DL_LOG_FROM_XML) ACCCOMIS_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var CarryData:CSC_AccComisRepParm;

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "SFCONTRID", V_INTEGER, CarryData.SfContrID) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "COMISCODE", V_STRING, CarryData.ComisCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEBACCOUNT", V_STRING, CarryData.DebAccount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CREDACCOUNT", V_STRING, CarryData.CredAccount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "AMOUNT", V_MONEY, CarryData.Amount) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "CURRENCY", V_INTEGER, CarryData.Currency) == false)
        end;
       
        return CarryData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;


/*´Æ£ ÆË®°Æ™*/
PRIVATE CLASS (DL_LOG_FROM_XML) SC_ERROR_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var ErrorData:CSC_AccountingRepErr;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "DEALCODE", V_STRING, ErrorData.DealCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ERRCODE", V_STRING, ErrorData.ErrCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ERRSTR", V_STRING, ErrorData.ErrStr) == false)
        end;
        
        return ErrorData;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

/*´Æ£ ÆË®°Æ™ ëé*/
CLASS (DL_LOG_DATA_XML) SC_ACCOUNTING_ERROR_LOG_DATA_XML(pDocKind:integer, pDocumentID:integer, pDataParms:TArray, pType:integer, pVersion:integer)

  PRIVATE MACRO ëÆß§†‚Ïìß•´éË®°Æ™(i)
     var ìß•´éË®°Æ™ = null;

     if( m_Version == 1 )
        ìß•´éË®°Æ™ = CreateElement("Property",
                                   "DealCode",  m_DataParms[i].DealCode, 
                                   "ErrCode",   m_DataParms[i].ErrCode, 
                                   "ErrStr",    m_DataParms[i].ErrStr
                                  );
     else
        ìß•´éË®°Æ™ = CreateElement("Property");
     end;
     
     return ìß•´éË®°Æ™;
  END;


  initDL_LOG_DATA_XML(pDocKind, pDocumentID, pDataParms, pType, pVersion);

END;

//™´†·· · §†≠≠Î¨® §´Ô ·‚‡Æ™® Ø‡Æ‚Æ™Æ´† ØÆ ‡•ØÆ · ≠•ØÆ£†Ë•≠≠Î¨® ™„ØÆ≠†¨®/óè
class REPOWithNotRepaymentCoup(_Kind:integer,
                       _FI_Code:string,
                       _FI_Name:string,
                       _RepoCode:string,
                       _Coup_Number:string,
                       _Coup_DrawingDate:date
)
  var Kind       = _Kind; //¢®§ Æ‚Á•‚†
  var FI_Code    = _FI_Code;    //äÆ§ Ê/°
  var FI_Name    = _FI_Name;    //ç†ß¢†≠®• Ê/°
  var RepoCode          = _RepoCode;    
  var Coup_Number       = _Coup_Number;    
  var Coup_DrawingDate  = _Coup_DrawingDate;   
end;

/*´Æ£ ¢ÎØ„·™Æ¢ ØÆ ‡•ØÆ · ≠•ØÆ£†Ë•≠≠Î¨® ™„ØÆ≠†¨®/óè*/
CLASS (DL_LOG_FROM_XML) REPOWithNotRepaymentCoup_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()

     var REPO_WithNotRepCoup:REPOWithNotRepaymentCoup;

     if( m_ReportVersion == 1 )

        if(DL_ReadTagAttribut(m_child_ReportNumber, "FI_CODE", V_STRING, REPO_WithNotRepCoup.FI_Code) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "FI_NAME", V_STRING, REPO_WithNotRepCoup.FI_Name) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "REPOCODE", V_STRING, REPO_WithNotRepCoup.RepoCode) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "COUP_NUMBER", V_STRING, REPO_WithNotRepCoup.Coup_Number) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "COUP_DRAWINGDATE", V_DATE, REPO_WithNotRepCoup.Coup_DrawingDate) == false)
        end;

        return REPO_WithNotRepCoup;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);
END;

PRIVATE MACRO GetLogDataXML( DocKind:integer, DocumentID:integer, Type:integer, OnlyLastReport:bool, ReportKind:integer )
   var xml_obj = null;

   if( Type == LOG_TYPE_DATA )
      if( ReportKind == SC_REPORTKIND_COMMIS )
      xml_obj = ACCCOMIS_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif( (ReportKind == SC_REPORTKIND_ACC_TICK) )
         xml_obj = PROBLEMACC_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif( (ReportKind == SC_REPORTKIND_NULLFIWARNTS) )
        xml_obj = NULLFIWARNTS_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      elif( (ReportKind == SC_REPORTKIND_REPOWTHREPCOUP) )
        xml_obj = REPOWithNotRepaymentCoup_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
      end;
   elif(Type == LOG_TYPE_ERROR )
      xml_obj = SC_ERROR_LOG_FROM_XML(DocKind, DocumentID, Type, OnlyLastReport);
   end;

   return xml_obj;
END;

macro SaveAccountingErrForReport_XML( RepErrArr, DocumentID:integer, DocKind:integer )

  var RepXML = "";

  if( RepErrArr.Size > 0 )
     RepXML = SC_ACCOUNTING_ERROR_LOG_DATA_XML(DocKind,DocumentID,RepErrArr,LOG_TYPE_ERROR).GetDataXML();
  end;

  if( RepXML != "" )
     var Header = DL_LOG_HEADER_XML(DocKind).GetHeaderXML();

     DL_InsertHeaderLog(DocumentID, DocKind, {Oper}, Header);
     DL_InsertLogXMLData( DocumentID, DocKind, LOG_TYPE_ERROR, {Oper}, RepXML);
  end;

end;


private var N1RepHeaderStr = "                                        ####################################################################\n"+
                             "\n"+
                             "################################################################################";


private var N1TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥    äÆ§ Ê/°    ≥    ¸ ·§•´™®   ≥    ¸ ·§•´™®   ≥           äÆ´-¢Æ Ê/°           ≥    ë„¨¨† ·§•´™® ·    ≥  Ç†´Ó‚†  ≥è•‡•ÆÊ•≠™†≥ç†Á®·´•≠≠Î© Ø‡ÆÊ•≠‚-≥\n"+
                            "≥               ≥    Ø‡Æ§†¶®    ≥    ØÆ™„Ø™®    ≥                                ≥    ß†‚‡†‚†¨® ¢ Çç    ≥ ≠Æ¨®≠†´† ≥   (‡„°.) ≥≠Î©/§®·™Æ≠‚≠Î© §ÆÂÆ§≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";



private var N2RepHeaderStr = "                              #################################################";
private var N2InvestorStr  = "#";


private var N2TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥    äÆ§ Ê/°    ≥         äÆ´-¢Æ Ê/° ¢           ≥    ¸ ·§•´™®   ≥    ¸ ·§•´™®   ≥         äÆ´-¢Æ Ê/° ¢           ≥\n"+
                            "≥               ≥        ·§•´™• Ø‡Æ§†¶®          ≥    Ø‡Æ§†¶®    ≥  Ø‡®Æ°‡•‚•≠®Ô ≥        ·§•´™• ØÆ™„Ø™®          ≥\n"+                            
                            "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";


private var N3RepHeaderStr = "                                                          #################################################";
private var N3InvestorStr  = "#";

private var N3TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥ ¸ ·§•´™® ≥        ëÆ§•‡¶†≠®• Ø‡Æ¢Æ§™®         ≥      ëÁ•‚ Ñ‚       ≥     ë„¨¨† Ñ‚     ≥     Ç†´Ó‚† Ñ‚    ≥      ëÁ•‚ ä‚       ≥     ë„¨¨† ä‚     ≥     Ç†´Ó‚† ä‚    ≥ë„¨¨† Ì™¢®¢†´•≠‚† ≥\n"+
                            "≥          ≥                                    ≥                    ≥                  ≥                  ≥                    ≥                  ≥                  ≥  ¢ ≠†Ê. ¢†´Ó‚•   ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N3FooterCarryStr  =
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
" ≥##############################################################≥\n"+
" ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ";

private var N4OprStateMsg = "########################################################";                            
private var N4TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥äÆ§ ·§•´™®≥¸ ÆË®°™®  ≥ëÆÆ°È•≠®•                                                     ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";


private var N5BlockHeader = "########################################################";
private var N5StateMsg = "########################################################";
private var N5TableHeader1 = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                             "≥            ë§•´™†           ≥          ëÁ•‚         ≥        è‡®¨•Á†≠®•           ≥\n"+
                             "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N5TableHeader2 = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                             "≥            ÇÎØ„·™           ≥          ëÁ•‚         ≥        è‡®¨•Á†≠®•           ≥\n"+
                             "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";


private var N6RepHeaderStr = "                       #########################################################\n"+
                             "                       #########################################################";

private var N6TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒø\n"+
                            "≥        ç†®¨•≠Æ¢†≠®•         ≥        ëÁ•‚ Ñ‚        ≥        ëÁ•‚ ä‚        ≥       ë„¨¨†      ≥ Ç†´Ó‚† ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ¥";


private var N7RepHeaderStr = "                                            #########################################################\n"+
                             "                                            #########################################################";
private var N7EmptyRepStr  = "########################################################";

private var N7TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥ çÆ¨•‡ Ø‡Æ¢Æ§™® ≥    ëÁ•‚ Ø´†‚•´ÏÈ®™†     ≥  ë„¨¨†  §•°•‚†     ≥  Ç†´Ó‚† §•°•‚† ≥    ëÁ•‚ ØÆ´„Á†‚•´Ô      ≥   ë„¨¨† ™‡•§®‚†    ≥ Ç†´Ó‚† ™‡•§®‚† ≥ ë„¨¨† ¢ ≠†Ê. ¢†´Ó‚•≥   Ñ†‚†   ≥ ë‚†‚„·        ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N8RepHeaderStr1 = "                       #########################################################\n";
private var N8RepHeaderStr2 = " #########################################################";

private var N8TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥ ¸ ·§•´™®       ≥      äÆ§ Ê/°      ≥     äÆ´-¢Æ Ê/°    ≥   Ñ†‚† ØÆ·‚†¢™®   ≥      Ç®§      ≥     í®Ø     ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N9RepHeaderStr1 = "                       #########################################################\n";
private var N9RepHeaderStr2 = " #########################################################";

private var N9TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                            "≥   Ñ†‚† ·Æß§†≠®Ô  ≥      ä´®•≠‚      ≥     äÆ≠‚‡†£•≠‚    ≥   ì‡Æ¢•≠Ï   ≥      Ç®§      ≥    ë„¨¨†    ≥     Ç†´Ó‚†    ≥    Ç®§ †≠†´®‚®™®1    ≥    Ä≠†´®‚®™†1    ≥    Ç®§ †≠†´®‚®™®2    ≥    Ä≠†´®‚®™†2    ≥    Ç®§ †≠†´®‚®™®3    ≥    Ä≠†´®‚®™†3    ≥    Ç®§ †≠†´®‚®™®4    ≥    Ä≠†´®‚®™†4    ≥    Ç®§ †≠†´®‚®™®5    ≥    Ä≠†´®‚®™†5    ≥    Ç®§ †≠†´®‚®™®6    ≥    Ä≠†´®‚®™†6    ≥\n"+
                            "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N8RepHeaderStr = "                                        ##############################################################################\n"+
                             "\n";


private var N8TableHeader_OWN = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                                "≥    äÆ§ Ê/°    ≥    ¸ ·§•´™®   ≥    ¸ ·§•´™®   ≥           äÆ´-¢Æ Ê/°           ≥   çÆ¨®≠†´Ï≠†Ô   ≥  Ç†´Ó‚†  ≥  ë‚Æ®¨Æ·‚Ï Ê/°  ≥  ç†Á†´Ï≠Î©  ≥é·‚†‚Æ™ ≠†Á†´Ï≠Æ£Æ≥ëØ®·†≠≠Î© ¢ ·§•´™•≥\n"+
                                "≥               ≥    ØÆ™„Ø™®    ≥    Ø‡Æ§†¶®    ≥                                ≥  ·‚Æ®¨Æ·‚Ï Ê/°  ≥ ≠Æ¨®≠†´† ≥                 ≥   §®·™Æ≠‚   ≥     §®·™Æ≠‚†     ≥      §®·™Æ≠‚     ≥\n"+
                                "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";


private var N9RepHeaderStr = "                                                          #################################################";

private var N9TableHeader_OWN = "⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                                "≥ ¸ ·§•´™® ≥        ëÆ§•‡¶†≠®• Ø‡Æ¢Æ§™®         ≥      ëÁ•‚ Ñ‚       ≥     ë„¨¨† Ñ‚     ≥     Ç†´Ó‚† Ñ‚    ≥      ëÁ•‚ ä‚       ≥     ë„¨¨† ä‚     ≥     Ç†´Ó‚† ä‚    ≥ë„¨¨† Ì™¢®¢†´•≠‚† ≥\n"+
                                "≥          ≥                                    ≥                    ≥                  ≥                  ≥                    ≥                  ≥                  ≥  ¢ ≠†Ê. ¢†´Ó‚•   ≥\n"+
                                "√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N12RepHeaderStr = "                       #########################################################";

private var N12TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                             "≥       äÆ§ Ê/°      ≥        ç†®¨•≠Æ¢†≠®• Ê/°         ≥Ö·‚Ï ≠„´•¢Î• ™„ØÆ≠Î?≥Ö·‚Ï ≠„´•¢Î• óè?≥\n"+
                             "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var N13RepHeaderStr = "                       #########################################################################################";

private var N13TableHeader = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                             "≥      äÆ§ ·§•´™® êÖèé      ≥       äÆ§ Ê/°       ≥        ç†®¨•≠Æ¢†≠®• Ê/°         ≥        çÆ¨•‡ ™„ØÆ≠†/óè        ≥ Ñ†‚† ØÆ£†Ë•≠®Ô ™„ØÆ≠†/óè ≥\n"+
                             "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";


PRIVATE CLASS (DL_CReportTemplate) SC_Accounting_Report(dl_comm, Mode, GrpID, IsWebService:BOOL)
  PRIVATE VAR m_PrintMode, m_ByGrpID;
  PRIVATE VAR m_comm = TRecHandler("dl_comm");
  PRIVATE VAR m_cnt_lot = 0, m_cnt_client_lot = 0, m_cnt_carry = 0, m_cnt_comiss = 0, m_cnt_closeacc = 0, m_cnt_nullfiwarnts = 0, m_cnt_repowthrepcoup = 0; 
  PRIVATE VAR m_PrintedStdHead = false;

  PRIVATE MACRO PrintMode():INTEGER
     return m_PrintMode;
  END;
  
  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO ä¢®‚Æ¢™†ëÆ°·‚¢•≠≠ÎÂñÅ()
    var query_lot, cmd_lot, DataSet;
    var SheetName = "ä¢®‚ëÆ°·‚¢";
    var stat = 0;
    var PrevSaleID = 0;
    var is_back, Group;

    //èÆ ·Æ°·‚¢•≠≠Î¨ ´Æ‚†¨
    query_lot =   " select lnk.t_SaleID, lnk.t_Amount, lnk.t_CostBuy, lnk.t_NKDBuyAmount, lnk.t_InterestIncomeBuy, lnk.t_DiscountIncomeBuy, "
                + "        salelot.t_FIID, salelot.t_DealCode SaleDealCode, salelot.t_Cost SaleCost, salelot.t_NKDAmount SaleNKDAmount, salelot.t_DealID SaleDealID, "
                + "        buylot.t_DealCode BuyDealCode, "
                + "        fin.t_FI_Code, fin.t_Name, fin.t_SumPrecision, fin.t_FaceValueFI "
                + "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt salelot, dpmwrtsum_dbt buylot, dfininstr_dbt fin "
                + "  where lnk.t_ID_Operation = ? "
                + "    and lnk.t_ID_Step = -1 "
                + "    and salelot.t_SumID = lnk.t_SaleID "
                + "    and buylot.t_SumID = lnk.t_BuyID "
                + "    and fin.t_FIID = salelot.t_FIID "
                + "    order by salelot.t_FIID, lnk.t_LnkID ";  // + "  order by salelot.t_FIID, lnk.t_SaleID ";

    cmd_lot = DL_RSDCommand(query_lot);
    
    cmd_lot.AddParam(m_comm.rec.DocumentID);

    m_cnt_lot = cmd_lot.GetCount();

    if(m_cnt_lot > 0)

      VAR i = 0;
      InitProgress( m_cnt_lot, "è•Á†‚Ï Æ‚Á•‚† ØÆ ™¢®‚Æ¢™• ·Æ°·‚¢•≠≠ÎÂ Ê/°", "è•Á†‚Ï Æ‚Á•‚† ØÆ ™¢®‚Æ¢™• ·Æ°·‚¢•≠≠ÎÂ Ê/°" );

      SetActiveSheet( SheetName );
      
      UseNewSheetInTotalBook();

      if((m_PrintMode == DL_OUTREPORT_STD) and (m_PrintedStdHead == false))
        PrintFormatString("                                                         èêéíéäéã äÇàíéÇäà\n");
        PrintFormatString("                                                 Ñ†‚† ÆØ•‡†Ê®®: " + string(m_comm.rec.CommDate:f)+ " ™Æ§: " + m_comm.rec.CommCode);
        m_PrintedStdHead = true;
      end;

      PrintFormatString(N1RepHeaderStr,
                        "N1_RepHead", "ëØ®·†≠®• ´Æ‚Æ¢ Ê•≠≠ÎÂ °„¨†£, Ø‡®≠†§´•¶†È®Â °†≠™„, ¢ ·§•´™†Â Ø‡Æ§†¶®",
                        "N1_InvestorStr", "à≠¢•·‚Æ‡ " + èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†({OurBank}));
      CopyAllSheetInTotalBook( SheetName, false, "N1_RepHeader", 0, SheetName );  
      
      CopyAllSheetInTotalBook( SheetName, false, "N1_TableHeader", 0, SheetName ); 
      RegisterTable( "N1_MainTable", N1TableHeader,
                     "N1_FI_Code",    
                     "N1_SaleDealCode",  
                     "N1_BuyDealCode",   
                     "N1_Qnty",  
                     "N1_Cost",  
                     "N1_Overvalue", 
                     "N1_Income"
                   );

      DataSet = cmd_lot.Execute();
      while(DataSet.moveNext())

        UseProgress(i = i + 1);

        if(PrevSaleID != DataSet.SaleID)
          var dl_leg   = TRecHandler( "dl_leg" ),
              Tick     = TBFile("dl_tick"),
              LotSale  = TRecHandler("pmwrtsum"),
              LegKind, Principal, TotalCost;

          Tick.Clear();
          Tick.rec.DealID = DataSet.SaleDealID;
          Tick.GetEQ();

          /*ÆØ‡•§•´Ô•¨ Á†·‚Ï ™ ™Æ‚Æ‡Æ© Æ‚≠Æ·®‚·Ô ´Æ‚ Ø‡Æ§†¶®*/   
          Group = SP_GetOperationGroup( Tick.rec );
          if( IsBUY(Group) )
             is_back = true;   
             LegKind = LEG_KIND_DL_TICK_BACK;
          else
             is_back = false;   
             LegKind  = LEG_KIND_DL_TICK;
          end;

          dl_leg = GetDlLegByDealID( DataSet.SaleDealID, LegKind );

          Principal = TotalCost = 0.0;
          if( IsBasket(Group) )
             var cmd2 = DL_RSDCommand();
             var query2= " SELECT SUM(CASE WHEN T_KIND = ? THEN NVL(T_PRINCIPAL,0) ELSE NVL(-T_PRINCIPAL,0) END) T_PRINCIPAL " +
                         "   FROM DDL_TICK_ENS_DBT " +
                         "  WHERE T_DEALID = ? " +
                         "    AND T_DATE  <= ? " +
                         "    AND T_FIID   = ? ";
             cmd2.AddParam(TICKENS_KIND_IN);
             cmd2.AddParam(Tick.rec.DealID);
             cmd2.AddParam(m_comm.rec.CommDate);
             cmd2.AddParam(DataSet.FIID);

             var DataSet2 = cmd2.Execute(query2);
             if( DataSet2.moveNext() )
                Principal = SQL_ConvTypeSum(DataSet2.Principal);
             end;

             var cmd3 = DL_RSDCommand();
             var query3= " SELECT SUM(CASE WHEN T_KIND = ? THEN NVL(T_TOTALCOST,0) ELSE NVL(-T_TOTALCOST,0) END) T_TOTALCOST " +
                         "   FROM DDL_TICK_ENS_DBT " +
                         "  WHERE T_DEALID = ? " +
                         "    AND T_DATE  <= ? " +
                         "    AND T_FIID   = ? ";
             cmd3.AddParam(TICKENS_KIND_IN);
             cmd3.AddParam(Tick.rec.DealID);
             cmd3.AddParam(m_comm.rec.CommDate);
             cmd3.AddParam(DataSet.FIID);

             var DataSet3 = cmd3.Execute(query3);
             if( DataSet3.moveNext() )
                TotalCost = SQL_ConvTypeSum(DataSet3.TotalCost);

                if( DataSet.FaceValueFI != NATCUR )
                   SmartConvertSum(TotalCost, TotalCost, m_comm.rec.CommDate, NATCUR, DataSet.FaceValueFI, true);
                end;
             end;
          else
             Principal = dl_leg.Principal;
             TotalCost = dl_leg.TotalCost;
          end;

          if( èÆ´„Á®‚ÏãÆ‚èÆë§•´™•(Tick.rec, PM_WRITEOFF_SUM_SALE, LotSale, false, null, is_back) )
            PrintTableLine( "N1_FI_Code:c",       DataSet.FI_Code,                     null,
                            "N1_SaleDealCode:c",  DataSet.SaleDealCode,                null,
                            "N1_BuyDealCode:c",   "",                                  null,
                            "N1_Qnty:r",          Principal,                           SetPrecisionByFractPart(Principal, DataSet.SumPrecision(), 0),
                            "N1_Cost:r",          TotalCost,                           null,
                            "N1_FVFI:c",          GetFinInstrCcy(DataSet.FaceValueFI), null,
                            "N1_Overvalue:r",     "",                                  null,
                            "N1_Income:r",        "",                                  null
                          );
           end;
        end;

        PrintTableLine( "N1_FI_Code:c",       "",                                                    null,
                        "N1_SaleDealCode:c",  "",                                                    null,
                        "N1_BuyDealCode:c",   DataSet.BuyDealCode,                                   null,
                        "N1_Qnty:r",          DataSet.Amount,                                        SetPrecisionByFractPart(DataSet.Amount, DataSet.SumPrecision(), 0),
                        "N1_Cost:r",          DataSet.CostBuy + DataSet.NKDBuyAmount,                null,
                        "N1_FVFI:c",          GetFinInstrCcy(DataSet.FaceValueFI),                   null,
                        "N1_Overvalue:r",     "",                                                    null,
                        "N1_Income:r",        DataSet.InterestIncomeBuy + DataSet.DiscountIncomeBuy, null
                      );

        PrevSaleID = DataSet.SaleID;
      end;

      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );

      if(m_PrintMode == DL_OUTREPORT_EXCEL)
        AddStandardFooter( "N1_" );
        CopyAllSheetInTotalBook( SheetName, false, "N1_Footer", 2, SheetName );
      end;

      remprogress();
    end;

  END;

  PRIVATE MACRO ä¢®‚Æ¢™†ä´®•≠‚·™®ÂñÅ()
    var query_client_lot, cmd_client_lot, DataSet;
    var PrevContract = 0, PrevFIID = -1;
    var SheetName = "ä¢®‚ä´≠‚";
    var stat = 0;

    query_client_lot =    " with d as (select tk.t_DealID, tk.t_DealCode, tk.t_DealType, tk.t_BOfficeKind, rq.t_DealPart, rq.t_Amount, rq.t_Kind, "
                      + "                   grp.t_Party, grp.t_Contract, grpfi.t_FIID, "
                      + "                   RSB_SECUR.IsSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsSale, "
                      + "                   RSB_SECUR.IsBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsBuy, "
                      + "                   RSB_SECUR.IsREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsRepo, "
                      + "                   RSB_SECUR.IsRet_Issue(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsRet_Issue, "
                      + "                   RSB_SECUR.IsRet_Partly(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsRet_Partly, "
                      + "                   RSB_SECUR.IsRet_Coupon(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsRet_Coupon, "
                      + "                   RSB_SECUR.IsAvrWrtIn(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsAvrWrtIn, "
                      + "                   RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) IsAvrWrtOut "
                      + "              from dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi, ddlgrdoc_dbt grdoc, ddlrq_dbt rq, ddl_tick_dbt tk "
                      + "             where grp.t_DocKind = ? "
                      + "               and grp.t_DocID = ? "
                      + "               and grp.t_Party <> -1 "
                      + "               and grpfi.t_GrpID = grp.t_ID "
                      + "               and grdoc.t_ServDocKind = grp.t_DocKind "
                      + "               and grdoc.t_ServDocID = grp.t_DocID "
                      + "               and grdoc.t_GrpID = grp.t_ID "
                      + "               and grdoc.t_DocKind = " + DLDOC_PAYMENT
                      + "               and rq.t_ID = RSI_DLRQ.RSI_GetRQByGrDeal( grdoc.t_GrDealID ) "
                      + "               and tk.t_DealID = rq.t_DocID "
                      + "               and tk.t_BOfficeKind = rq.t_DocKind "
                      + "           ) "
                      + " select q.*, pt.t_ShortName as PartyShortName, contr.t_Number as ContractNumber, fin.t_FI_Code, fin.t_Name "
                      + "   from ("
                      //Ø‡Æ§†¶®
                      + "         ( select distinct 1 as Num, 0 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsSALE = 1 "
                      + "              and d.IsREPO = 0"
                      + "              and d.t_DealPart = 1 "
                      + "         ) UNION ALL "
                      //·Ø®·†≠®Ô
                      + "         ( select distinct 2 as Num, 0 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsAvrWrtOut = 1 "
                      + "              and d.t_DealPart = 1 "
                      + "         ) UNION ALL "
                      //ØÆ£†Ë•≠®Ô
                      + "         ( select distinct 3 as Num, 0 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsRet_Issue = 1 "
                      + "              OR  d.IsRet_Partly = 1 "
                      + "              OR  d.IsRet_Coupon = 1"
                      + "         ) UNION ALL "
                      //1-• Á†·‚® Ø‡Ô¨Æ£Æ ‡•ØÆ
                      + "         ( select distinct 4 as Num, 1 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsSALE = 1 "
                      + "              and d.IsREPO = 1 "
                      + "              and d.t_DealPart = 1 "
                      + "         ) UNION ALL "
                      //2-• Á†·‚® Æ°‡†‚≠Æ£Æ ‡•ØÆ
                      + "         ( select distinct 5 as Num, 1 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsBUY = 1 "
                      + "              and d.IsREPO = 1 "
                      + "              and d.t_DealPart = 2 "
                      + "         ) UNION ALL "
                      //ØÆ™„Ø™®
                      + "         ( select distinct 6 as Num, 0 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsBUY = 1 "
                      + "              and d.IsREPO = 0 "
                      + "              and d.t_DealPart = 1 "
                      + "         ) UNION ALL "
                      //ß†Á®·´•≠®Ô
                      + "         ( select distinct 7 as Num, 0 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsAvrWrtIn = 1 "
                      + "              and d.t_DealPart = 1 "
                      + "         ) UNION ALL "
                      //2-• Á†·‚® Ø‡Ô¨Æ£Æ ‡•ØÆ
                      + "         ( select distinct 8 as Num, 1 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsSALE = 1 "
                      + "              and d.IsREPO = 1 "
                      + "              and d.t_DealPart = 2 "
                      + "         ) UNION ALL "
                      //1-• Á†·‚® Æ°‡†‚≠Æ£Æ ‡•ØÆ
                      + "         ( select distinct 9 as Num, 1 as IsRepo, d.t_DealID, d.t_BOfficeKind, d.t_DealCode, d.t_Party, d.t_Contract, d.t_FIID, d.t_Amount, d.t_Kind, d.t_DealPart "
                      + "             from d "
                      + "            where d.IsBUY = 1 "
                      + "              and d.IsREPO = 1 "
                      + "              and d.t_DealPart = 1 "
                      + "         ) "
                      + "        ) q, dparty_dbt pt, dsfcontr_dbt contr, dfininstr_dbt fin "
                      + "  where pt.t_PartyID = q.t_Party "
                      + "    and contr.t_ID = q.t_Contract "
                      + "    and fin.t_FIID = q.t_FIID "
                      + " order by q.t_Party ASC, q.t_Contract ASC, q.t_FIID ASC, q.Num ASC, q.t_DealCode ASC ";

    cmd_client_lot = DL_RSDCommand(query_client_lot);

    cmd_client_lot.AddParam(m_comm.rec.DocKind);
    cmd_client_lot.AddParam(m_comm.rec.DocumentID);

    m_cnt_client_lot = cmd_client_lot.GetCount();

    if(m_cnt_client_lot > 0)
            
      VAR i = 0;
      InitProgress( m_cnt_client_lot, "è•Á†‚Ï Æ‚Á•‚† ØÆ ™¢®‚Æ¢™• ™´®•≠‚·™®Â Ê/°", "è•Á†‚Ï Æ‚Á•‚† ØÆ ™¢®‚Æ¢™• ™´®•≠‚·™®Â Ê/°" );
            
      SetActiveSheet( SheetName );

      UseNewSheetInTotalBook();

      if((m_PrintMode == DL_OUTREPORT_STD) and (m_PrintedStdHead == false))
        PrintFormatString("                                                         èêéíéäéã äÇàíéÇäà\n");
        PrintFormatString("                                                 Ñ†‚† ÆØ•‡†Ê®®: " + string(m_comm.rec.CommDate:f)+ " ™Æ§: " + m_comm.rec.CommCode);
        m_PrintedStdHead = true;
      end;

      PrintFormatString(N2RepHeaderStr,
                        "N2_RepHead", "ëØ®·†≠®• ™´®•≠‚·™®Â Ê•≠≠ÎÂ °„¨†£"
                       );
      CopyAllSheetInTotalBook( SheetName, false, "N2_RepHeader", 0, SheetName ); 
      

      DataSet = cmd_client_lot.Execute();
      stat = DataSet.moveNext();
      while(stat)
        UseProgress(i = i + 1);

        if(PrevContract != DataSet.Contract)
          PrevFIID = -1;

          PrintFormatString(N2InvestorStr,
                            "N2_InvestorStr", "à≠¢•·‚Æ‡ " + DataSet.PartyShortName + "    §Æ£Æ¢Æ‡ ¸ " + DataSet.ContractNumber
                           );
          CopyAllSheetInTotalBook( SheetName, false, "N2_InvestorStr", 1, SheetName ); 

          CopyAllSheetInTotalBook( SheetName, false, "N2_TableHeader", 0, SheetName );
          RegisterTable( "N2_MainTable",   N2TableHeader,
                         "N2_FI_Code",
                         "N2_SaleQnty",   
                         "N2_SaleDealCode",  
                         "N2_BuyDealCode",
                         "N2_BuyQnty"   
                       );
        end;

        PrintTableLine( "N2_FI_Code",       IIF(PrevFIID != DataSet.FIID, DataSet.FI_Code, ""),                                                                    null,
                        "N2_SaleQnty",      IIF(DataSet.Kind == DLRQ_KIND_REQUEST, "", DataSet.Amount),                                                            null,
                        "N2_SaleDealCode",  IIF(DataSet.Kind == DLRQ_KIND_REQUEST, "", DataSet.DealCode + IIF(DataSet.IsRepo == 1, "("+DataSet.DealPart+")", "")), null,
                        "N2_BuyDealCode",   IIF(DataSet.Kind == DLRQ_KIND_REQUEST, DataSet.DealCode + IIF(DataSet.IsRepo == 1, "("+DataSet.DealPart+")", ""), ""), null,
                        "N2_BuyQnty",       IIF(DataSet.Kind == DLRQ_KIND_REQUEST, DataSet.Amount,   ""),                                                          null
                      );

        PrevContract = DataSet.Contract;
        PrevFIID = DataSet.FIID;

        stat = DataSet.moveNext();
        if((not stat) or (PrevContract != DataSet.Contract))
          EndTable();
          CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );
        end
      end;

      if(m_PrintMode == DL_OUTREPORT_EXCEL)
        AddStandardFooter( "N2_" );
        CopyAllSheetInTotalBook( SheetName, false, "N2_Footer", 2, SheetName );
      end;

      remprogress();
    end;

  END;

  PRIVATE MACRO è‡Æ¢Æ§™®()
    var query_carry, cmd_carry, DataSet;
    var SheetName = "è‡Æ¢Æ§™®";
    var stat = 0;
    var PrevPartyID = 0;
    var PrevContract = 0;
    var dateCarryShift = true;

    query_carry =   " select q.t_Party,  q.t_Contract, q.t_Number AS ContractNumber, "
                + "        q.t_Numb_Document, q.t_Ground, q.t_Account_Payer, q.t_Sum_Payer, q.t_FIID_Payer, "
                + "        q.t_Account_Receiver, q.t_Sum_Receiver, q.t_FIID_Receiver, q.t_Sum_Natcur, q.t_Date_Carry "
                + "   from ("
                + "         select grp.t_Party, grp.t_Contract, contr.t_Number, "
                + "                carry.t_Numb_Document, carry.t_Ground, carry.t_Account_Payer, carry.t_Sum_Payer, carry.t_FIID_Payer, "
                + "                carry.t_Account_Receiver, carry.t_Sum_Receiver, carry.t_FIID_Receiver, carry.t_Sum_Natcur, carry.t_AccTrnID, carry.t_Date_Carry "
                + "           from dpmwrtgrp_dbt grp, ddlgrdoc_dbt grdoc, dacctrn_dbt carry, dsfcontr_dbt contr "
                + "          where grp.t_DocKind = ? "
                + "            and grp.t_DocID = ? "
                + "            and grp.t_IsSecOwn = CHR(0) "
                + "            and grdoc.t_ServDocKind = grp.t_DocKind "
                + "            and grdoc.t_ServDocID = grp.t_DocID "
                + "            and grdoc.t_GrpID = grp.t_ID "
                + "            and grdoc.t_DocKind = " + DLDOC_CARRY
                + "            and grdoc.t_SourceType = " + DLGR_SOURCETYPE_NORMAL
                + "            and carry.t_AccTrnID = grdoc.t_DocID "
                + "            and contr.t_ID(+) = grp.t_Contract "
                + "         UNION ALL "
                + "         select -1 as t_Party, 0 as t_Contract, '' as ContractNumber,  "
                + "                carry.t_Numb_Document, carry.t_Ground, carry.t_Account_Payer, carry.t_Sum_Payer, carry.t_FIID_Payer, "
                + "                carry.t_Account_Receiver, carry.t_Sum_Receiver, carry.t_FIID_Receiver, carry.t_Sum_Natcur, carry.t_AccTrnID, carry.t_Date_Carry "
                + "           from ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal, dacctrn_dbt carry "
                + "          where grdoc.t_ServDocKind = ? "
                + "            and grdoc.t_ServDocID = ? "
                + "            and grdoc.t_GrpID = 0 "
                + "            and grdoc.t_DocKind = " + DLDOC_CARRY
                + "            and carry.t_AccTrnID = grdoc.t_DocID "
                + "            and grdeal.t_ID = grdoc.t_GrDealID "
                + "            and grdeal.t_DocKind = " + DL_NTGSEC
                + "         UNION ALL "
                + "         select -1 as t_Party, 0 as t_Contract, '' as ContractNumber,  "
                + "                carry.t_Numb_Document, carry.t_Ground, carry.t_Account_Payer, carry.t_Sum_Payer, carry.t_FIID_Payer, "
                + "                carry.t_Account_Receiver, carry.t_Sum_Receiver, carry.t_FIID_Receiver, carry.t_Sum_Natcur, carry.t_AccTrnID, carry.t_Date_Carry "
                + "           from ddlgrdoc_dbt grdoc, dacctrn_dbt carry "
                + "          where grdoc.t_ServDocKind = ? "
                + "            and grdoc.t_ServDocID = ? "
                + "            and grdoc.t_GrpID = 0 "
                + "            and grdoc.t_DocKind = " + DLDOC_CARRY
                + "            and carry.t_AccTrnID = grdoc.t_DocID "
                + "            and grdoc.t_SourceType = " + DLGR_SOURCETYPE_CALCEXCHANGE
                + "        ) q "
                + "  order by q.t_Party, q.t_Contract asc, q.t_Numb_Document asc, q.t_AccTrnID asc ";

    cmd_carry = DL_RSDCommand(query_carry);
    
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);

    m_cnt_carry = cmd_carry.GetCount();

    if(m_cnt_carry > 0)
      SetActiveSheet( SheetName );

      UseNewSheetInTotalBook();

      if((m_PrintMode == DL_OUTREPORT_STD) and (m_PrintedStdHead == false))
        PrintFormatString("                                                         èêéíéäéã äÇàíéÇäà\n");
        PrintFormatString("                                                 Ñ†‚† ÆØ•‡†Ê®®: " + string(m_comm.rec.CommDate:f)+ " ™Æ§: " + m_comm.rec.CommCode);
        m_PrintedStdHead = true;
      end;

      PrintFormatString(N3RepHeaderStr,
                        "N3_RepHead", "îÆ‡¨®‡Æ¢†≠®• Ø‡Æ¢Æ§Æ™"
                       );
      CopyAllSheetInTotalBook( SheetName, false, "N3_RepHeader", 0, SheetName );

      VAR i = 0;
      InitProgress( m_cnt_carry, "è•Á†‚Ï Ø‡Æ¢Æ§Æ™ ÆØ•‡†Ê®®", "è•Á†‚Ï Ø‡Æ¢Æ§Æ™ ÆØ•‡†Ê®®" );

      DataSet = cmd_carry.Execute();
      stat = DataSet.moveNext();
      while(stat)
        UseProgress(i = i + 1);
        
        if( (PrevPartyID != DataSet.Party) or (PrevContract != DataSet.Contract) )

          PrintFormatString(N3InvestorStr,
                            "N3_InvestorStr", IIF(DataSet.Party == -1, 
                                                  "à≠¢•·‚Æ‡ " + èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†({OurBank}),
                                                  "à≠¢•·‚Æ‡ " + èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†(int(DataSet.Party))  + "    §Æ£Æ¢Æ‡ ¸ " + DataSet.ContractNumber )
                           );
          CopyAllSheetInTotalBook( SheetName, false, "N3_InvestorStr", 1, SheetName ); 

          CopyAllSheetInTotalBook( SheetName, false, "N3_TableHeader", 0, SheetName );
          RegisterTable( "N3_MainTable",   N3TableHeader,
                         "N3_DealCode",   
                         "N3_Ground",    
                         "N3_DtAccount", 
                         "N3_DtSum", 
                         "N3_DtFI",  
                         "N3_CtAccount", 
                         "N3_CtSum", 
                         "N3_CtFI",  
                         "N3_NatSum"   
                       );
        end;

        PrintTableLine( "N3_DealCode:c",   DataSet.Numb_Document,                                  null,
                        "N3_Ground:l",     DataSet.Ground,                                         null,
                        "N3_DtAccount:c",  DataSet.Account_Payer,                                  null,
                        "N3_DtSum:r",      DataSet.Sum_Payer,                                      null,
                        "N3_DtFI:c",       GetFICode(DataSet.FIID_Payer, null, FICK_ISOSTRING),    null,
                        "N3_CtAccount:c",  DataSet.Account_Receiver,                               null,
                        "N3_CtSum:r",      DataSet.Sum_Receiver,                                   null,
                        "N3_CtFI:c",       GetFICode(DataSet.FIID_Receiver, null, FICK_ISOSTRING), null,
                        "N3_NatSum:r",     DataSet.Sum_Natcur,                                     null
                      );


        PrevPartyID = DataSet.Party;
        PrevContract = DataSet.Contract;
        dateCarryShift = dateCarryShift and (DataSet.Date_Carry != m_comm.rec.CommDate);
        stat = DataSet.moveNext();
        
        if((not stat) or (PrevPartyID != DataSet.Party) or (PrevContract != DataSet.Contract) )
          EndTable();
          CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );
        end;
      end;

      if (dateCarryShift)
        PrintFormatString(N3FooterCarryStr,"N3_CarryStr", "Ñ†‚Î Ø‡Æ¢Æ§Æ™ ·¨•È•≠Î Æ‚≠Æ·®‚•´Ï≠Æ §†‚Î ÆØ•‡†Ê®®");
      end;

      if(m_PrintMode == DL_OUTREPORT_EXCEL)
        AddStandardFooter( "N3_" );
        CopyAllSheetInTotalBook( SheetName, false, "N3_Footer", 2, SheetName );
      end;

      remprogress();
    end;

  END;

private macro RemoveSymbFromMsg(symb:string, msg:string):string
   var retVal:string = "";
   //var sourceStr:string = msg;
   var startPos:integer = 1;

   while( startPos > 0 ) 
     startPos = StrBrk ( msg, "|" ); 
     var tmpStr:string = Trim ( SubStr(msg,1,startPos-1) );
     if ( StrLen( tmpStr ) )
       retVal = RetVal + tmpStr + " ";
     end;
     msg = SubStr( msg, startPos+1 );
   end;
   retVal = Trim(RetVal + msg);
   return retVal;
end; 

  PRIVATE MACRO ëÆÆ°È•≠®Ô()
    var ReportLineData_XML:variant;
    var IsExistsErr = false;
    var ErrData:CSC_AccountingRepErr;
    var reccomm = TRecHandler("dl_comm");
    VAR errtext, errcode;
    var stat = 0;
    var cntobj = 0, cmd;
    var SheetName = "ëÆÆ°È•≠®Ô";

    SetActiveSheet( SheetName );

    UseNewSheetInTotalBook();
    
    cmd = DL_RSDCommand("select 1 from ddlgrdoc_dbt where t_ServDocKind = ? and t_ServDocID = ?");
    cmd.AddParam(m_comm.rec.DocKind);
    cmd.AddParam(m_comm.rec.DocumentID);
    cntobj = cmd.GetCount();

    ReportLineData_XML = GetLogDataXML(m_comm.rec.DocKind, m_comm.rec.DocumentID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    
    stat = ReportLineData_XML.Next();

    if((stat) or ((m_cnt_lot == 0) and (m_cnt_client_lot == 0) and (m_cnt_carry == 0) and (m_cnt_comiss == 0) and (m_cnt_closeacc == 0) and (cntobj == 0) and (m_cnt_nullfiwarnts == 0) and (m_cnt_repowthrepcoup == 0)))
      if(m_PrintMode == DL_OUTREPORT_EXCEL)
        m_ObjTemplateXLS.SetSheetColor( XlColorIndex_RED );
      end;

      CopyAllSheetInTotalBook( SheetName, false, "N4_TableHeader", 0, SheetName );
      RegisterTable( "N4_MainTable",  N4TableHeader,
                     "N4_DealCode",   
                     "N4_ErrCode",    
                     "N4_Message"
                   );

      if(not stat)
        PrintTableLine( "N4_DealCode",  "",                      null,
                        "N4_ErrCode",   "",                      null,
                        "N4_Message",   "ç•‚ ØÆ§ÂÆ§ÔÈ®Â ·§•´Æ™", null
                      );

      else
        while(stat)
          ErrData = ReportLineData_XML.GetReportLineData();
          var RetValErrMsg:string = "";
          RetValErrMsg  = RemoveSymbFromMsg("|",ErrData.ErrStr);         
          PrintTableLine( "N4_DealCode",  ErrData.DealCode, null,
                          "N4_ErrCode",   ErrData.ErrCode,  null,
                          "N4_Message:w", RetValErrMsg,   null
                        );

          stat = ReportLineData_XML.Next();
        end;
      end;

      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );

    else
      PrintFormatString(N4OprStateMsg,
                        "N4_OprStateMsg", "éØ•‡†Ê®Ô ß†¢•‡Ë•≠† „·Ø•Ë≠Æ");
      CopyAllSheetInTotalBook( SheetName, false, "N4_OprStateMsg", 0, SheetName );
    end; 

  END;

  PRIVATE MACRO á†™‡Î‚®•ëÁ•‚Æ¢()
    var IsFirstUse = true;
    var DataSet;

    var ReportLineData_XML:variant;
    var ProblemAccData:CSC_ProblemAccount;
    var SheetName = "á†™‡Î‚®•ëÁ•‚Æ¢";

    SetActiveSheet( SheetName );

    UseNewSheetInTotalBook();

    m_cnt_closeacc = 0;

    ReportLineData_XML = GetLogDataXML(m_comm.rec.DocKind, m_comm.rec.DocumentID, LOG_TYPE_DATA, false, SC_REPORTKIND_ACC_TICK);
    ReportLineData_XML.SetReportNumber(SC_REPORTKIND_ACC_TICK);

    PrintFormatString(N5BlockHeader,
                     "N5_BlockHeader", "á†™‡Î‚®• ´®Ê•¢ÎÂ ·Á•‚Æ¢ ØÆ ·§•´™†¨");
    CopyAllSheetInTotalBook( SheetName, false, "N5_BlockHeader", 0, SheetName );
    
    /*·≠†Á†´† Ø•Á†‚†•¨ ®≠‰Æ‡¨†Ê®Ó ØÆ Ø‡Æ°´•¨≠Î¨ ·Á•‚†¨, ™Æ‚Æ‡Î• °Î´† ØÆØÎ‚™† ß†™‡Î‚Ï*/
    var stat = ReportLineData_XML.Next;
    while( stat )
       if(IsFirstUse)

          CopyAllSheetInTotalBook( SheetName, false, "N5_TableHeader1", 0, SheetName );
          RegisterTable( "N5_MainTable1",  N5TableHeader1,
                         "N5_DealCode",   
                         "N5_DealAccount",    
                         "N5_DealNote"
                       );

          IsFirstUse = false;
       end;

       ProblemAccData = ReportLineData_XML.GetReportLineData();

       PrintTableLine( "N5_DealCode:c",    ProblemAccData.Code,    null,
                       "N5_DealAccount:r", ProblemAccData.Account, null,
                       "N5_DealNote:w",    ProblemAccData.Note,    null
                     );

       stat = ReportLineData_XML.Next;
    end;

    /*§†´•• Ø•Á†‚†•¨ ®≠‰Æ‡¨†Ê®Ó ØÆ ß†™‡Î‚Î¨ ·Á•‚†¨*/
    var cmd = DL_RSDCommand("select acc.t_Account, tick.t_DealCode "+
                            "  from dmcaccdoc_dbt acc, ddlgrdoc_dbt grdoc, ddl_tick_dbt tick "+
                            " where grdoc.t_ServDocKind = ? "+
                            "   and grdoc.t_ServDocID = ? "+
                            "   and grdoc.t_DocKind = ? "+
                            "   and grdoc.t_DocID = acc.t_ID "+
                            "   and (grdoc.t_SourceType = ? OR grdoc.t_SourceType = ?)"+
                            "   and tick.t_DealID = rsb_secur.GetDealID(acc.t_DocKind, acc.t_DocID) "
                            " group by tick.t_DealCode, acc.t_Account "+
                            " order by tick.t_DealCode, acc.t_Account "
                           );
    
    cmd.AddParam(m_comm.rec.DocKind);
    cmd.AddParam(m_comm.rec.DocumentID);
    cmd.AddParam(60/*DLDOC_MCACCDOC*/);
    cmd.AddParam(DLGR_SOURCETYPE_ACC_CLOSE_TICK);
    cmd.AddParam(DLGR_SOURCETYPE_ACC_ONLYCLOSE_TICK);

    DataSet = cmd.Execute();

    while( DataSet.moveNext() )

       if(IsFirstUse)

          CopyAllSheetInTotalBook( SheetName, false, "N5_TableHeader1", 0, SheetName );
          RegisterTable( "N5_MainTable1",  N5TableHeader1,
                         "N5_DealCode",   
                         "N5_DealAccount",    
                         "N5_DealNote"
                       );

          IsFirstUse = false;
       end;

       PrintTableLine( "N5_DealCode:c",    DataSet.DealCode, null,
                       "N5_DealAccount:r", DataSet.Account,  null,
                       "N5_DealNote:w",    "",               null
                     );

       m_cnt_closeacc = m_cnt_closeacc + 1;

    end;
                                           
    if( IsFirstUse == false )
       EndTable();
       CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );
    else
       PrintFormatString(N5StateMsg,
                        "N5_StateMsg", "ç•‚ Æ°‡†°Æ‚†≠≠ÎÂ ·Á•‚Æ¢");
       CopyAllSheetInTotalBook( SheetName, false, "N5_StateMsg", 0, SheetName );
    end;

    PrintFormatString(N5BlockHeader,
                     "N5_BlockHeader", "á†™‡Î‚®• ´®Ê•¢ÎÂ ·Á•‚Æ¢ ØÆ ¢ÎØ„·™†¨");
    CopyAllSheetInTotalBook( SheetName, false, "N5_BlockHeader", 0, SheetName );

    var cnt_closeaccFI = ReportProtocolCloseAcc_FI(this, m_comm, SheetName);
    if (cnt_closeaccFI != 0)
       EndTable();
       CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );
       m_cnt_closeacc = m_cnt_closeacc + cnt_closeaccFI;
    else
       PrintFormatString(N5StateMsg,
                        "N5_StateMsg", "ç•‚ Æ°‡†°Æ‚†≠≠ÎÂ ·Á•‚Æ¢");
       CopyAllSheetInTotalBook( SheetName, false, "N5_StateMsg", 0, SheetName );
    end;

  END;

  PRIVATE MACRO è•‡®Æ§®Á•·™®•äÆ¨®··®®()
    var ReportLineData_XML:variant;
    var ComisData:CSC_AccComisRepParm;
    var Executer = DepoExecuter( {oper} );
    var sfcontr = TBFile("sfcontr");
    var printed = false;
    var HeadPrinted = false;
    var PrevSfContrID = 0;
    var stat = 0;
    var SheetName = "è•‡®Æ§äÆ¨®·®®";
    
    m_cnt_comiss = 0;

    ReportLineData_XML = GetLogDataXML(m_comm.rec.DocKind, m_comm.rec.DocumentID, LOG_TYPE_DATA, false, SC_REPORTKIND_COMMIS);
    if(ReportLineData_XML)
      

      ReportLineData_XML.SetReportNumber(SC_REPORTKIND_COMMIS);
      stat = ReportLineData_XML.Next();
      while( stat )

         ComisData = ReportLineData_XML.GetReportLineData();


         if(HeadPrinted == false)
           SetActiveSheet( SheetName );
           UseNewSheetInTotalBook();

           PrintFormatString(N6RepHeaderStr,
                             "N6_RepHead", "èêéíéäéã éèãÄíõ èÖêàéÑàóÖëäàï äéåàëëàâ",
                             "N6_RepData", "Ñ†‚† ÆØ•‡†Ê®®: " + string(m_comm.rec.CommDate:f)+ " ™Æ§: " + m_comm.rec.CommCode);
           CopyAllSheetInTotalBook( SheetName, false, "N6_RepHeader", 0, SheetName );  
           
           CopyAllSheetInTotalBook( SheetName, false, "N6_TableHeader", 1, SheetName ); 
           RegisterTable( "N6_MainTable", N6TableHeader,
                          "N6_ComisCode",    
                          "N6_DtAccount",  
                          "N6_CtAccount",   
                          "N6_Sum",  
                          "N6_SumFI"  
                        );

           HeadPrinted = true;
         end;


         if(PrevSfContrID != ComisData.SfContrID)
            sfcontr.Clear();
            sfcontr.rec.ID = ComisData.SfContrID;
            sfcontr.GetEQ();

            if(m_PrintMode == DL_OUTREPORT_EXCEL)
              Merge( "N6_ComisCode", "N6_SumFI" );
            end;

            PrintTableLine("N6_ComisCode:l", "à≠¢•·‚Æ‡ " +èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†(sfcontr.rec.PartyID)+ "    §Æ£Æ¢Æ‡ ¸ "+sfcontr.rec.Number, null);

         end;

         PrintTableLine( "N6_ComisCode:c", ComisData.ComisCode,   null,
                         "N6_DtAccount:c", ComisData.DebAccount,  null,
                         "N6_CtAccount:c", ComisData.CredAccount, null,
                         "N6_Sum:r",       ComisData.Amount,      null,
                         "N6_SumFI:c",     èÆ´„Á®‚ÏäÆ§î®≠à≠( ComisData.Currency, null, FICK_ISOSTRING ), null
                       );


         PrevSfContrID = ComisData.SfContrID;

         stat = ReportLineData_XML.Next();

         m_cnt_comiss = m_cnt_comiss + 1;
         
      end;

      if(HeadPrinted)
        EndTable();
        CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );

        AddStandardFooter( "N6_" );
        CopyAllSheetInTotalBook( SheetName, false, "N6_Footer", 0, SheetName );
      end;
    end;
  END;

  PRIVATE MACRO ç†´Æ£Æ¢Î•ãÆ‚Î()
    var NumLine = 0;
    var Investor = "", InvestorID, OldInvestorID = 0, ContrID, ContrNum = "", OldContrID = 0;
    var LotsDS;

    var query_lots =    " select distinct party.t_ShortName as t_Party,  q.t_Contract, q.t_Number AS ContractNumber, party.t_PartyID as t_InvestorID, q.t_Contract as t_ContrID "
                      + "   from ("
                      + "         select grp.t_Party, grp.t_Contract, contr.t_Number "
                      + "           from dpmwrtgrp_dbt grp, ddlgrdoc_dbt grdoc, dsfcontr_dbt contr "
                      + "          where grp.t_DocKind = ? "
                      + "            and grp.t_DocID = ? "
                      + "            and grdoc.t_ServDocKind = grp.t_DocKind "
                      + "            and grdoc.t_ServDocID = grp.t_DocID "
                      + "            and grdoc.t_GrpID = grp.t_ID "
                      + "            and grdoc.t_SourceType = " + DLGR_SOURCETYPE_NORMAL
                      + "            and contr.t_ID(+) = grp.t_Contract "
                      + "         UNION ALL "
                      + "         select -1 as t_Party, 0 as t_Contract, '' as ContractNumber  "
                      + "           from ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal "
                      + "          where grdoc.t_ServDocKind = ? "
                      + "            and grdoc.t_ServDocID = ? "
                      + "            and grdoc.t_GrpID = 0 "
                      + "            and grdeal.t_ID = grdoc.t_GrDealID "
                      + "            and grdeal.t_DocKind = " + DL_NTGSEC
                      + "         UNION ALL "
                      + "         select -1 as t_Party, 0 as t_Contract, '' as ContractNumber  "
                      + "           from ddlgrdoc_dbt grdoc"
                      + "          where grdoc.t_ServDocKind = ? "
                      + "            and grdoc.t_ServDocID = ? "
                      + "            and grdoc.t_GrpID = 0 "
                      + "            and grdoc.t_SourceType = " + DLGR_SOURCETYPE_CALCEXCHANGE
                      + "        ) q, dparty_dbt party "
                      + "       where party.t_PartyID = q.t_Party";

    var cmd_lots = DL_RSDCommand(query_lots);
    cmd_lots.AddParam(m_comm.rec.DocKind);
    cmd_lots.AddParam(m_comm.rec.DocumentID);
    cmd_lots.AddParam(m_comm.rec.DocKind);
    cmd_lots.AddParam(m_comm.rec.DocumentID);
    cmd_lots.AddParam(m_comm.rec.DocKind);
    cmd_lots.AddParam(m_comm.rec.DocumentID);
    var LotsCount = cmd_lots.GetCount();

    var DataSet = cmd_lots.execute();

    if((m_PrintMode != DL_OUTREPORT_EXCEL) and (LotsCount > 0 )) /*bpv Ø‡Æ¢•‡™† ≠† ≠†´®Á®• ≠†´Æ£Æ¢ÎÂ ´Æ‚Æ¢, Á‚Æ°Î ≠• Ø•Á†‚†‚Ï ß†£Æ´Æ¢Æ™*/
      PrintFormatString(N8RepHeaderStr1,
                            "N8_RepHead", "ç†´Æ£Æ¢Î• ´Æ‚Î §´Ô Ó‡®§®Á•·™®Â ´®Ê-≠•‡•ß®§•≠‚Æ¢");
    end;
    
    MACRO PrintLine(DealCode, SecurCode, Amount, DelivDate,     Kind, Type)
      if((InvestorID != OldInvestorID) or (ContrID != OldContrID))
        SetActiveSheet("ç†´Æ£Æ¢Î•ãÆ‚Î");

        if((m_PrintMode == DL_OUTREPORT_EXCEL) and (LotsCount > 0))
          PrintFormatString(N8RepHeaderStr1,
                            "N8_RepHead", "ç†´Æ£Æ¢Î• ´Æ‚Î §´Ô Ó‡®§®Á•·™®Â ´®Ê-≠•‡•ß®§•≠‚Æ¢");
        end;
        PrintFormatString(N8RepHeaderStr2, "N8_InvestorStr", "à≠¢•·‚Æ‡ " + Investor + " §Æ£Æ¢Æ‡ ¸ " + ContrNum);

        CopyAllSheetInTotalBook("ç†´Æ£Æ¢Î•ãÆ‚Î", false, "N8_RepHeader", 0, "ç†´Æ£Æ¢Î•ãÆ‚Î");

        CopyAllSheetInTotalBook("ç†´Æ£Æ¢Î•ãÆ‚Î", false, "N8_TableHeader", 0, "ç†´Æ£Æ¢Î•ãÆ‚Î");
        RegisterTable( "N8_MainTable", N8TableHeader,
                       "N8_DealCode",
                       "N8_Secur",
                       "N8_Amount",
                       "N8_DelivDate",
                       "N8_Kind",
                       "N8_Type"
                     );
        OldInvestorID = InvestorID;
        OldContrID = ContrID;
      end;

      PrintTableLine( "N8_DealCode", DealCode, null,
                      "N8_Secur", SecurCode, null,
                      "N8_Amount", Amount, null,
                      "N8_DelivDate", DelivDate, null,
                      "N8_Kind", Kind, null,
                      "N8_Type", Type, null
                    );

      NumLine = Numline + 1;
    end;

    while(DataSet.MoveNext())
      NumLine = 0;
      Investor = DataSet.Party;
      ContrNum = DataSet.ContractNumber;
      InvestorID = DataSet.InvestorID;
      ContrID = DataSet.ContrID;

      LotsDS = NULL;
      var LotsCom = DL_RSDCommand( "select Deal.t_DealCode as t_DealCode," +
                                   "   lot.t_Kind as t_Kind," +
                                   "   lot.t_Type as t_Type," +
                                   "   lot.t_Amount as t_Amount," +
                                   "   fi.t_FI_Code as t_FI_Code," +
                                   "   CAST(dlrq.t_FactDate as Date) as t_DelivDate" +
                                   " from ddl_tick_dbt Deal, dnutxlot_dbt lot, ddlgrdeal_dbt grdeal, dpmwrtgrp_dbt grp, dfininstr_dbt fi, ddlrq_dbt dlrq" +
                                   " where grp.t_DocKind = ?" +
                                   "   and grp.t_DocID = ?" +
                                   "   and grp.t_Party = ?" +
                                   "   and exists(" +
                                   "                select 1" +
                                   "                from ddlgrdoc_dbt grdoc" +
                                   "                where grdoc.t_ServDocKind = ?" +
                                   "   and grdoc.t_ServDocID = ?" +
                                   "   and grdoc.t_GrpID = grp.t_ID" +
                                   "   and grdoc.t_DocKind = " + DLDOC_PAYMENT +
                                   "                  and grdoc.t_GrDealID = grdeal.t_ID" +
                                   "             )" +
                                   "   and lot.t_DocKind = grdeal.t_DocKind" +
                                   "   and lot.t_DocID = grdeal.t_DocID" +
                                   "   and Deal.t_DealID = lot.t_DocID" +
                                   "   and Deal.t_BOfficeKind = lot.t_DocKind" +
                                   "   and fi.t_FIID = lot.t_FIID" +
                                   "   and dlrq.t_DocKind = Deal.t_BOfficeKind" +
                                   "   and dlrq.t_DocID = Deal.t_DealID" +
                                   "   and dlrq.t_Type = " + DLRQ_TYPE_DELIVERY );
    
      LotsCom.AddParam(m_comm.rec.DocKind);
      LotsCom.AddParam(m_comm.rec.DocumentID);
      LotsCom.AddParam(InvestorID);
      LotsCom.AddParam(m_comm.rec.DocKind);
      LotsCom.AddParam(m_comm.rec.DocumentID);
    
      LotsDS = LotsCom.execute();
  
      while(LotsDS.MoveNext())
        var Kind, Type;
  
        if(LotsDS.Kind == NUTXLOTS_BUY)
          Kind = "èÆ™„Ø™†";
        elif(LotsDS.Kind == NUTXLOTS_SALE)
          Kind = "è‡Æ§†¶†";
        elif(LotsDS.Kind == NUTXLOTS_REPO)
          Kind = "êÖèé Ø‡Ô¨Æ•";
        elif(LotsDS.Kind == NUTXLOTS_BACKREPO)
          Kind = "êÖèé Æ°‡†‚≠Æ•";
        elif(LotsDS.Kind == NUTXLOTS_LOANPUT)
          Kind = "á†©¨-‡†ß¨•È•≠®•";
        elif(LotsDS.Kind == NUTXLOTS_LOANGET)
          Kind = "á†©¨-Ø‡®¢´•Á•≠®•";
        end;
  
        if(LotsDS.Type == NUTXDEAL_REAL)
          Type = "ê•†´Ï≠†Ô ·§•´™†";
        elif(LotsDS.Type == NUTXDEAL_MARKET)
          Type = "Ç®‡‚„†´Ï≠†Ô ·§•´™† ‡Î≠ÆÁ≠Æ£Æ ‚®Ø†";
        elif(LotsDS.Type == NUTXDEAL_CALC)
          Type = "Ç®‡‚„†´Ï≠†Ô ‡†·Á•‚≠†Ô ·§•´™†";
        elif(LotsDS.Type == NUTXDEAL_COMP)
          Type=  "èÆ·‚™Æ¨Ø•≠·†Ê®Æ≠≠Î© ´Æ‚";
        end;
        
        PrintLine(LotsDS.DealCode, LotsDS.FI_Code, LotsDS.Amount, Date(LotsDS.DelivDate), Kind, Type);
      end;

      if(NumLine > 0)
        EndTable();
        CopyAllSheetInTotalBook("ç†´Æ£Æ¢Î•ãÆ‚Î", false, GetTableRange(), 0, "ç†´Æ£Æ¢Î•ãÆ‚Î");
      end;
    end;
    
    if((m_PrintMode == DL_OUTREPORT_EXCEL) and (NumLine > 0))
        AddStandardFooter("N8_");
        CopyAllSheetInTotalBook("ç†´Æ£Æ¢Î•ãÆ‚Î", false, "N8_Footer", 0, "ç†´Æ£Æ¢Î•ãÆ‚Î");
    end;
  END;

  PRIVATE MACRO é°Í•™‚ÎçÑê_ûãç()
    var NumLine = 0;
    var Investor = "", InvestorID, OldInvestorID = 0, ContrNum = "", ContrID, OldContrID = 0;
    var LotsDS;
    var ReceiverID = 0, Party = 0, DocID = 0, FIID = 0, Contract = 0, GrpID = 0;

    var query_lots =    " select distinct party.t_ShortName as t_Party,  q.t_Contract, q.t_ContractNumber AS ContractNumber, party.t_PartyID as t_InvestorID, q.t_Contract as t_ContrID "
                      + "   from ("
                      + "         select grp.t_Party, grp.t_Contract, contr.t_Number as t_ContractNumber "
                      + "           from dpmwrtgrp_dbt grp, ddlgrdoc_dbt grdoc, dsfcontr_dbt contr "
                      + "          where grp.t_DocKind = ? "
                      + "            and grp.t_DocID = ? "
                      + "            and grdoc.t_ServDocKind = grp.t_DocKind "
                      + "            and grdoc.t_ServDocID = grp.t_DocID "
                      + "            and grdoc.t_GrpID = grp.t_ID "
                      + "            and grdoc.t_SourceType = " + DLGR_SOURCETYPE_NORMAL
                      + "            and contr.t_ID(+) = grp.t_Contract "
                      + "         UNION ALL "
                      + "         select -1 as t_Party, 0 as t_Contract, '' as t_ContractNumber "
                      + "           from ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal "
                      + "          where grdoc.t_ServDocKind = ? "
                      + "            and grdoc.t_ServDocID = ? "
                      + "            and grdoc.t_GrpID = 0 "
                      + "            and grdeal.t_ID = grdoc.t_GrDealID "
                      + "            and grdeal.t_DocKind = " + DL_NTGSEC
                      + "         UNION ALL "
                      + "         select -1 as t_Party, 0 as t_Contract, '' as t_ContractNumber "
                      + "           from ddlgrdoc_dbt grdoc"
                      + "          where grdoc.t_ServDocKind = ? "
                      + "            and grdoc.t_ServDocID = ? "
                      + "            and grdoc.t_GrpID = 0 "
                      + "            and grdoc.t_SourceType = " + DLGR_SOURCETYPE_CALCEXCHANGE
                      + "        ) q, dparty_dbt party "
                      + "       where party.t_PartyID = q.t_Party";

    var cmd_lots = DL_RSDCommand(query_lots);
    
    cmd_lots.AddParam(m_comm.rec.DocKind);
    cmd_lots.AddParam(m_comm.rec.DocumentID);
    cmd_lots.AddParam(m_comm.rec.DocKind);
    cmd_lots.AddParam(m_comm.rec.DocumentID);
    cmd_lots.AddParam(m_comm.rec.DocKind);
    cmd_lots.AddParam(m_comm.rec.DocumentID);
    cmd_lots.AddParam(m_comm.rec.DocKind);
    cmd_lots.AddParam(m_comm.rec.DocumentID);

    var DataSet = cmd_lots.execute();
    
    MACRO Printline(Date, Client, Party, Level, Kind, Sum, Cur, AnaliticKind1, Analitic1, AnaliticKind2, Analitic2, AnaliticKind3, Analitic3, AnaliticKind4, Analitic4, AnaliticKind5, Analitic5, AnaliticKind6, Analitic6)
      if((InvestorID != OldInvestorID) or (ContrID != OldContrID))
        SetActiveSheet("é°Í•™‚ÎçÑê_ûãç");

        if(m_PrintMode == DL_OUTREPORT_EXCEL)
          PrintFormatString(N9RepHeaderStr1, "N9_RepHead", "é°Í•™‚Î çÑê §´Ô Ó‡®§®Á•·™®Â ´®Ê-≠•‡•ß®§•≠‚Æ¢");
        end;
        PrintFormatString(N9RepHeaderStr2, "N9_InvestorStr", "à≠¢•·‚Æ‡ " + Investor + " §Æ£Æ¢Æ‡ ¸ " + ContrNum);
        CopyAllSheetInTotalBook("é°Í•™‚ÎçÑê_ûãç", false, "N9_RepHeader", 0, "é°Í•™‚ÎçÑê_ûãç");

        CopyAllSheetInTotalBook("é°Í•™‚ÎçÑê_ûãç", false, "N9_TableHeader", 0, "é°Í•™‚ÎçÑê_ûãç");

        RegisterTable( "N9_MainTable", N9TableHeader,
                       "N9_Date",
                       "N9_Client",
                       "N9_Party",
                       "N9_Level",
                       "N9_Kind",
                       "N9_Sum",
                       "N9_Cur",
                       "N9_AnaliticKind1",
                       "N9_Analitic1",
                       "N9_AnaliticKind2",
                       "N9_Analitic2",
                       "N9_AnaliticKind3",
                       "N9_Analitic3",
                       "N9_AnaliticKind4",
                       "N9_Analitic4",
                       "N9_AnaliticKind5",
                       "N9_Analitic5",
                       "N9_AnaliticKind6",
                       "N9_Analitic6"
                      );
        OldInvestorID = InvestorID;
        OldContrID = ContrID;
      end;

      PrintTableLine( "N9_Date", Date, null,
                      "N9_Client", Client, null,
                      "N9_Party", Party, null,
                      "N9_Level", Level, null,
                      "N9_Kind", Kind, null,
                      "N9_Sum", Sum, null,
                      "N9_Cur", Cur, null,
                      "N9_AnaliticKind1", AnaliticKind1, null,
                      "N9_Analitic1",     Analitic1,     null,
                      "N9_AnaliticKind2", AnaliticKind2, null,
                      "N9_Analitic2",     Analitic2,     null,
                      "N9_AnaliticKind3", AnaliticKind3, null,
                      "N9_Analitic3",     Analitic3,     null,
                      "N9_AnaliticKind4", AnaliticKind4, null,
                      "N9_Analitic4",     Analitic4,     null,
                      "N9_AnaliticKind5", AnaliticKind5, null,
                      "N9_Analitic5",     Analitic5,     null,
                      "N9_AnaliticKind6", AnaliticKind6, null,
                      "N9_Analitic6",     Analitic6,     null );

      NumLine = NumLine + 1;
    end;

    while(DataSet.MoveNext())
      NumLine = 0;
      Investor = DataSet.Party;
      ContrNum = DataSet.ContractNumber;
      InvestorID = DataSet.InvestorID;
      ContrID = DataSet.ContrID;
  

      var GrpQuery = "select grp.*, grpfi.t_FIID " +
                     "  from dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi " +
                     "where grp.t_DocKind = ?" +
                     "   and grp.t_DocID = ?" +
                     "   and grp.t_Party = ?" +
                     "   and grpfi.t_GrpID = grp.t_ID";
  
      var GrpSelect = DL_RSDCommand(GrpQuery);
      GrpSelect.AddParam(m_comm.rec.DocKind);
      GrpSelect.AddParam(m_comm.rec.DocumentID);
      GrpSelect.AddParam(InvestorID);
      var GrpDS = GrpSelect.execute();
      while(GrpDS.MoveNext())
        ReceiverID = GetFactReceiverForNUTX(GrpDS.Party);
        Party = GrpDS.Party;
        DocID = GrpDS.DocID;
        FIID = GrpDS.FIID;
        Contract = GrpDS.Contract;
        GrpID = GrpDS.ID;
  
        var NUTXOBJQuery =  "select CAST(obj.t_Date as Date) as t_Date, client.t_ShortName as t_Client, party.t_ShortName as t_Party, obj.t_Level, ObjKind.t_Code as t_Kind, obj.t_Sum, cur.t_CCY as t_Cur," +
                            "  val1.t_Name as t_AnaliticKind1, tick.t_DealCode as t_Analitic1," +
                            "  val2.t_Name as t_AnaliticKind2, CASE WHEN obj.t_Analitic2 = -1 THEN '' ELSE TO_CHAR(obj.t_Analitic2) END as t_Analitic2," +
                            "  val3.t_Name as t_AnaliticKind3, sec.t_FI_Code as t_Analitic3," +
                            "  val4.t_Name as t_AnaliticKind4, CASE WHEN obj.t_Analitic4 = -1 THEN '' ELSE TO_CHAR(obj.t_Analitic4) END as t_Analitic4," +
                            "  val5.t_Name as t_AnaliticKind5, CASE WHEN obj.t_Analitic5 = -1 THEN '' ELSE TO_CHAR(obj.t_Analitic5) END as t_Analitic5," +
                            "  val6.t_Name as t_AnaliticKind6, sfcontr.t_Number as t_Analitic6 " +
                            "from dnutxobj_dbt obj," +
                            "  ddlgrdeal_dbt grdeal," +
                            "  dllvalues_dbt val1," +
                            "  dllvalues_dbt val2," +
                            "  dllvalues_dbt val3," +
                            "  dllvalues_dbt val4," +
                            "  dllvalues_dbt val5," +
                            "  dllvalues_dbt val6," +
                            "  dparty_dbt client," +
                            "  dparty_dbt party," +
                            "  dfininstr_dbt cur," +
                            "  dnutxkind_dbt ObjKind," +
                            "  ddl_tick_dbt tick," +
                            "  dfininstr_dbt sec," +
                            "  dsfcontr_dbt sfcontr " +
                            "where exists ( select 1" +
                            "             from ddlgrdoc_dbt grdoc" +
                            "               where grdoc.t_GrpID = ?" +
                            "               and grdoc.t_DocKind = " + DLDOC_CARRY +
                            "               and grdoc.t_ServDocKind = ?" +
                            "               and grdoc.t_ServDocID = ?" +
                            "               and grdoc.t_GrDealID = grdeal.t_ID" +
                            "            )" +
                            "  and obj.t_Date = ?" +
                            "  and obj.t_User <> '" + SET_CHAR + "'" +
                            "  and obj.t_AnaliticKind1 = " + TXOBJ_KIND1010 +
                            "  and obj.t_Analitic1 = grdeal.t_DocID" +
                            "  and val1.t_List(+) = " + OBJTYPE_KIND_ANALITIC +
                            "  and val1.t_Element(+) = obj.t_AnaliticKind1" +
                            "  and val2.t_List(+) = " + OBJTYPE_KIND_ANALITIC +
                            "  and val2.t_Element(+) = obj.t_AnaliticKind2" +
                            "  and val3.t_List(+) = " + OBJTYPE_KIND_ANALITIC +
                            "  and val3.t_Element(+) = obj.t_AnaliticKind3" +
                            "  and val4.t_List(+) = " + OBJTYPE_KIND_ANALITIC +
                            "  and val4.t_Element(+) = obj.t_AnaliticKind4" +
                            "  and val5.t_List(+) = " + OBJTYPE_KIND_ANALITIC +
                            "  and val5.t_Element(+) = obj.t_AnaliticKind5" +
                            "  and val6.t_List(+) = " + OBJTYPE_KIND_ANALITIC +
                            "  and val6.t_Element(+) = obj.t_AnaliticKind6" +
                            "  and client.t_PartyID = obj.t_Client" +
                            "  and party.t_PartyID = obj.t_Party" +
                            "  and cur.t_FIID = obj.t_Cur" +
                            "  and ObjKind.t_Element = obj.t_Kind" +
                            "  and tick.t_DealID(+) = obj.t_Analitic1" +
                            "  and sec.t_FIID(+) = obj.t_Analitic3" +
                            "  and sfcontr.t_ID(+) = obj.t_Analitic6";
  
        var NUTXOBJSelect = DL_RSDCommand(NUTXOBJQuery);
        NUTXOBJSelect.AddParam(GrpID);
        NUTXOBJSelect.AddParam(m_comm.rec.DocKind);
        NUTXOBJSelect.AddParam(m_comm.rec.DocumentID);
        NUTXOBJSelect.AddParam(m_comm.rec.CommDate);

        if((m_PrintMode != DL_OUTREPORT_EXCEL) and (NUTXOBJSelect.GetCount() > 0))
           PrintFormatString(N9RepHeaderStr1, "N9_RepHead", "é°Í•™‚Î çÑê §´Ô Ó‡®§®Á•·™®Â ´®Ê-≠•‡•ß®§•≠‚Æ¢");
        end;
        
        var NUTXOBJDS = NUTXOBJSelect.Execute();
  
        while(NUTXOBJDS.MoveNext())
          Printline( Date(NUTXOBJDS.Date), NUTXOBJDS.Client, NUTXOBJDS.Party, NUTXOBJDS.Level, NUTXOBJDS.Kind, NUTXOBJDS.Sum, NUTXOBJDS.Cur,
                     NUTXOBJDS.AnaliticKind1, NUTXOBJDS.Analitic1,
                     NUTXOBJDS.AnaliticKind2, NUTXOBJDS.Analitic2,
                     NUTXOBJDS.AnaliticKind3, NUTXOBJDS.Analitic3,
                     NUTXOBJDS.AnaliticKind4, NUTXOBJDS.Analitic4,
                     NUTXOBJDS.AnaliticKind5, NUTXOBJDS.Analitic5,
                     NUTXOBJDS.AnaliticKind6, NUTXOBJDS.Analitic6 );
        end;
      end;

      if(NumLine > 0)
        EndTable();
        CopyAllSheetInTotalBook("é°Í•™‚ÎçÑê_ûãç", false, GetTableRange(), 0, "é°Í•™‚ÎçÑê_ûãç");
      end;
    end;

    if((m_PrintMode == DL_OUTREPORT_EXCEL)and (NumLine > 0))
      AddStandardFooter("N9_");
      CopyAllSheetInTotalBook("é°Í•™‚ÎçÑê_ûãç", false, "N9_Footer", 0, "é°Í•™‚ÎçÑê_ûãç");
    end;
  END;

  PRIVATE MACRO ë¢Æ§≠Î•è‡Æ¢Æ§™®(_ByGrpID)
    file dl_tick( dl_tick ) ;
    var  errcode, errtext, TmpFName = GetWorkFileName("docoffrp");
    var  NumRec = 0, ContinueDoc, Summa = $0, FIID, NumLine = 0;
    var  ByGrpID = 0;
    var  SheetName = "ë¢Æ§≠Î•è‡Æ¢Æ§™®";

    if( (_ByGrpID != null) and (_ByGrpID > 0) )
       ByGrpID = _ByGrpID;
    end;

    MACRO PrintLine( Numb_Document, Account_Payer, Sum_Payer, FIID_Payer_Code, Account_Receiver, Sum_Receiver, FIID_Receiver_Code, Sum_NatCur, Date_Carry, DocStatus )

       if( NumLine == 0 )
         SetActiveSheet( SheetName );
         UseNewSheetInTotalBook();

         PrintFormatString(N7RepHeaderStr,
                           "N7_RepHead", "ëÇéÑçõÖ èêéÇéÑäà èé ëÑÖãäÄå çÄ ÅàêÜÖ",
                           "N7_RepData", "Ñ†‚† ÆØ•‡†Ê®® " + string(m_comm.rec.CommDate) + "  " + "äÆ§: " + m_comm.rec.CommCode);
         CopyAllSheetInTotalBook( SheetName, false, "N7_RepHeader", 0, SheetName );  
         
         CopyAllSheetInTotalBook( SheetName, false, "N7_TableHeader", 1, SheetName ); 
         RegisterTable( "N7_MainTable", N7TableHeader,
                        "N7_Number",    
                        "N7_DtAccount", 
                        "N7_DtSum", 
                        "N7_DtFI",  
                        "N7_CtAccount", 
                        "N7_CtSum", 
                        "N7_CtFI",  
                        "N7_NatSum",    
                        "N7_Date",  
                        "N7_State"
                      );
       end;


       PrintTableLine( "N7_Number:c",    Numb_Document,      null,
                       "N7_DtAccount:c", Account_Payer,      null,
                       "N7_DtSum:r",     Sum_Payer,          null,
                       "N7_DtFI:r",      FIID_Payer_Code,    null,
                       "N7_CtAccount:c", Account_Receiver,   null,
                       "N7_CtSum:r",     Sum_Receiver,       null,
                       "N7_CtFI:r",      FIID_Receiver_Code, null,
                       "N7_NatSum:r",    Sum_NatCur,         null,
                       "N7_Date:c",      Date_Carry,         null,
                       "N7_State:l",     DocStatus,          null
                     );

       NumLine = NumLine + 1;
    END;

    /*ÇÂÆ§®‚ ´® Æ‚´Æ¶•≠≠†Ô Ø‡Æ¢Æ§™† ØÆ ·§•´™• (spdocoff) ¢ ·¢Æ§≠„Ó Ø‡Æ¢Æ§™„*/
    macro IsIncludDocOffSubQuery( Code_CurrencyPayer:integer, Code_CurrencyReceiver:integer, Chapter:integer, Account_Payer:string, Account_Receiver:string )
       private record rAccount( account );
       
       private macro ChAcc(account) /*äÆ‡‡•™‚®‡Æ¢™† ·‚‡Æ™® ·Á•‚† §´Ô ß†Ø‡Æ·†*/
          var account_ret = "";
          if (account == "")
             account_ret = "chr(0)"; 
          else
             account_ret = " '" + string(account) + "' "; 
          end;
          return account_ret;
       end;

       var SubQuery = "", SubQuery1 = "", SubQuery2 = "", SubQuery3 = "", SubQuery4 = "", DtPairAcc = "", CtPairAcc = "";

       /*Ø†‡≠Î• ·Á•‚† §Æ™„¨•≠‚Æ¢ Ø‡Æ¢Æ§™®*/       
       if( GetAccount( Chapter, Code_CurrencyPayer, Account_Payer, rAccount, true ) )
           DtPairAcc = rAccount.PairAccount;
       end;

       if( GetAccount( Chapter, Code_CurrencyReceiver, Account_Receiver, rAccount, true ) )
           CtPairAcc = rAccount.PairAccount;
       end;

       SubQuery1 = 
              " (   DOCOFF.t_Account_Payer = " + ChAcc(Account_Payer) +
              " and DOCOFF.t_Account_Receiver = " + ChAcc(Account_Receiver) + " ) ";

       SubQuery2 = 
              /*¢Æß¨Æ¶≠Æ °Î´® ®§•≠‚®Á≠Î• Ø‡Æ¢Æ§™® ØÆ Ø†‡≠Î¨ ·Á•‚†¨*/
              " (  ( DOCOFF.t_Account_Payer = " + ChAcc(DtPairAcc) +
              "  and DOCOFF.t_Account_Receiver = " + ChAcc(Account_Receiver) + " )" +
              " or ( DOCOFF.t_Account_Payer = " + ChAcc(Account_Payer) +
              "  and DOCOFF.t_Account_Receiver = " + ChAcc(CtPairAcc) + " )" +
              " or ( DOCOFF.t_Account_Payer = " + ChAcc(DtPairAcc) +
              "  and DOCOFF.t_Account_Receiver = " + ChAcc(CtPairAcc) + " ) ) ";

       SubQuery4 = " ( " + SubQuery1 + " or (not " + SubQuery1 + " and " + SubQuery2 + " ) ) ";

       /*¢Æß¨Æ¶≠Æ °Î´® Ø‡Æ‚®¢ÆØÆ´Æ¶≠Î• Ø‡Æ¢Æ§™® ØÆ Ø†‡≠Î¨ ·Á•‚†¨*/
       if( (DtPairAcc != "") AND (CtPairAcc != "") ) /*é°† ·Á•‚† Ø†‡≠Î•*/
          SubQuery3 =  
              " and DOCOFF.t_Account_Payer = " + ChAcc(CtPairAcc) +
              " and DOCOFF.t_Account_Receiver = " + ChAcc(DtPairAcc);
       elif( DtPairAcc != "" ) /*ëÁ•‚ §•°•‚† Ø†‡≠Î©*/
          SubQuery3 =  
              " and DOCOFF.t_Account_Payer = " + ChAcc(Account_Receiver) +
              " and DOCOFF.t_Account_Receiver = " + ChAcc(DtPairAcc);
       elif( CtPairAcc != "" ) /*ëÁ•‚ ™‡•§®‚† Ø†‡≠Î©*/
          SubQuery3 =  
              " and DOCOFF.t_Account_Payer = " + ChAcc(CtPairAcc) +
              " and DOCOFF.t_Account_Receiver = " + ChAcc(Account_Payer);
       end;                                              

       SubQuery = " and ( " + SubQuery4 + 
             IIF (SubQuery3 == "", "", " or (not " + SubQuery4 + SubQuery3 + " ) ") + " ) ";

       return SubQuery;
    end;

    /*ØÆ´„Á®‚Ï ·‚†‚„· Ø‡Æ¢Æ§™® ·¢Æ§≠Æ© ®ß spdocoff*/
    private macro GetTxtSpDocState(State)
       if( State == SPDOCOFF_STATE_PREPARED )
          return "é‚´Æ¶•≠";
       elif(State == SPDOCOFF_STATE_EXECUTED)
          return "ÇÎØÆ´≠•≠";
       elif(State == SPDOCOFF_STATE_CANCELED)
          return "Ä≠≠„´®‡Æ¢†≠";
       end;
       return "";
    end;

    MACRO PrintDealsByCarryGround(AccTrnData,GroundKind)
       var
          CarryByDeal;

        var cmd = DL_RSDCommand( " select DOCOFF.*, FIP.T_CCY AS FIID_Payer_Code, FIR.T_CCY AS FIID_Receiver_Code "
                                    + "   from DSPDOCOFF_DBT DOCOFF, DFININSTR_DBT FIP, DFININSTR_DBT FIR "
                                    + "  WHERE DOCOFF.t_GrpID      = ? "
                                    + "    and DOCOFF.t_State      = ? " 
                                    + "    and DOCOFF.t_Date_Carry = ? " 
                                    + "    and DOCOFF.t_Chapter    = ? " 
                                    + "    and (DOCOFF.t_Sum_Payer = 0 " 
                                    + "     or DOCOFF.t_Currency_Payer = ? ) " 
                                    + "    and (DOCOFF.t_Sum_Receiver = 0 " 
                                    + "    or DOCOFF.t_Currency_Receiver = ?) " 
                                    +IsIncludDocOffSubQuery( AccTrnData.FIID_Payer, AccTrnData.FIID_Receiver, AccTrnData.Chapter, AccTrnData.Account_Payer, AccTrnData.Account_Receiver ) 
                                    + "    AND FIP.T_FIID = DOCOFF.T_Currency_Payer "
                                    + "    AND FIR.T_FIID = DOCOFF.T_Currency_Receiver "
                                    + "    and DOCOFF.t_GroundKind = ? "
                                    + " order by DOCOFF.t_DealID"
                               );
    
    
       cmd.AddParam(AccTrnData.GRPID);
       cmd.AddParam(SPDOCOFF_STATE_EXECUTED);
       cmd.AddParam(m_comm.rec.CommDate);
       cmd.AddParam(AccTrnData.Chapter);
       cmd.AddParam(AccTrnData.FIID_Payer);
       cmd.AddParam(AccTrnData.FIID_Receiver);
       cmd.AddParam(GroundKind);
       
       CarryByDeal = cmd.Execute();
       
       while( CarryByDeal.MoveNext() )
          dl_tick.DealId = CarryByDeal.DealID;
          if( GetEQ( dl_tick ) )                                                                                                                                                                                                                          
              var Sum_Receiver = CarryByDeal.Sum_Receiver;
              if( (Sum_Receiver == 0) and (CarryByDeal.Currency_Payer == CarryByDeal.Currency_Receiver) )
                 Sum_Receiver = CarryByDeal.Sum_Payer;
              end;
              PrintLine( dl_tick.DealCodeTS, CarryByDeal.Account_Payer, CarryByDeal.Sum_Payer, CarryByDeal.FIID_Payer_Code, CarryByDeal.Account_Receiver, Sum_Receiver, CarryByDeal.FIID_Receiver_Code, "", SQL_ConvTypeDate(CarryByDeal.Date_Carry), GetTxtSpDocState(int(CarryByDeal.State)));
          end;
       end;

    END;

    /*ç†©‚® ¢·• ·§•´™®, Ø‡Æ¢Æ§™® ™Æ‚Æ‡ÎÂ ·Æ·‚†¢®´® ·¢Æ§≠„Ó Ø‡Æ¢Æ§™„*/
    MACRO PrintDealsByCarry(AccTrnData)
       var
          CarryByGround;

       var cmd = DL_RSDCommand("select sum(DOCOFF.t_Sum_Payer) Sum_Payer, sum(DOCOFF.t_Sum_Receiver) Sum_Receiver, DOCOFF.t_GroundKind from DSPDOCOFF_DBT DOCOFF "+
                               " WHERE DOCOFF.t_GrpID      = ? "+
                               "   and DOCOFF.t_State      = ? " +
                               "   and DOCOFF.t_Date_Carry = ? " +
                               "   and DOCOFF.t_Chapter    = ? " +
                               "   and (DOCOFF.t_Sum_Payer = 0 " +
                               "   or DOCOFF.t_Currency_Payer = ? ) " +
                               "   and (DOCOFF.t_Sum_Receiver = 0 " +
                               "   or DOCOFF.t_Currency_Receiver = ?) " +
                              IsIncludDocOffSubQuery( AccTrnData.FIID_Payer, AccTrnData.FIID_Receiver, AccTrnData.Chapter, AccTrnData.Account_Payer, AccTrnData.Account_Receiver ) +
                               " group by DOCOFF.t_GroundKind"
                              );
    
       cmd.AddParam(AccTrnData.GRPID);
       cmd.AddParam(SPDOCOFF_STATE_EXECUTED);
       cmd.AddParam(m_comm.rec.CommDate);
       cmd.AddParam(AccTrnData.Chapter);
       cmd.AddParam(AccTrnData.FIID_Payer);
       cmd.AddParam(AccTrnData.FIID_Receiver);
    
       CarryByGround = cmd.Execute();
    
       while( CarryByGround.MoveNext() )
          if( (CarryByGround.Sum_Payer != $0) or (CarryByGround.Sum_Receiver != $0) )
    
             if( ((AccTrnData.FIID_Receiver == AccTrnData.FIID_Payer) and (AccTrnData.Sum_Payer == CarryByGround.Sum_Payer)) or
                 ( (CarryByGround.Sum_Payer == AccTrnData.Sum_Payer) and (CarryByGround.Sum_Receiver == AccTrnData.Sum_Receiver) )
               )
                 PrintDealsByCarryGround(AccTrnData,CarryByGround.GroundKind);
             end;
    
          end;
       end;
    
    END;

    /*ë¢Æ§≠Î• Ø‡Æ¢Æ§™®*/

    var cmd = DL_RSDCommand(  " select ACCTRN.*, DLGRDOC.t_GrpID, FIP.T_CCY AS FIID_Payer_Code, FIR.T_CCY AS FIID_Receiver_Code, "
                            + "        (select st.t_statename from dacctrn_state_dbt st where st.t_state = ACCTRN.t_State) as StateName"
                            + "   from DDLGRDOC_DBT DLGRDOC, DACCTRN_DBT ACCTRN, DFININSTR_DBT FIP, DFININSTR_DBT FIR "
                            + "  WHERE DLGRDOC.T_SERVDOCKIND = ? "
                            + "    AND DLGRDOC.T_SERVDOCID = ? "
                            + "    AND DLGRDOC.T_DocKind = ? "
                            + "    AND DLGRDOC.T_GRDEALID = 0 " 
                            + "    AND ACCTRN.T_ACCTRNID = DLGRDOC.T_DocID "
                            + "    AND FIP.T_FIID = ACCTRN.T_FIID_Payer "
                            + "    AND FIR.T_FIID = ACCTRN.T_FIID_Receiver "
                            + IIF(ByGrpID > 0, "   AND DLGRDOC.T_GrpID = "+ByGrpID, "" )/*ØÆ £Æ‡„ØØ•, •·´® ß†§†≠† (§´Ô ¢ÎØ„·™Æ¢)*/
                           );

    cmd.AddParam(m_comm.rec.DocKind);
    cmd.AddParam(m_comm.rec.DocumentID);
    cmd.AddParam(DLDOC_CARRY);

    NumRec = cmd.GetCount();

    if( NumRec > 0 )
       VAR i = 0;
       InitProgress( NumRec, "è•Á†‚Ï Æ‚Á•‚† ØÆ ·¢Æ§≠Î¨ Ø‡Æ¢Æ§™†¨", "è•Á†‚Ï Æ‚Á•‚† ØÆ ·¢Æ§≠Î¨ Ø‡Æ¢Æ§™†¨" );

       var DataSet = cmd.Execute();
      
       NumRec = 0;
       while( DataSet.MoveNext() )
          UseProgress(i = i + 1);

          PrintLine( "ë¢Æ§≠†Ô Ø‡Æ¢Æ§™†", DataSet.Account_Payer, DataSet.Sum_Payer, DataSet.FIID_Payer_Code, DataSet.Account_Receiver, DataSet.Sum_Receiver, DataSet.FIID_Receiver_Code, DataSet.Sum_NatCur, SQL_ConvTypeDate(DataSet.Date_Carry),DataSet.StateName );
          PrintDealsByCarry(DataSet);
       end;
       remprogress();
    end;

    if( NumLine > 0 )
      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );

      AddStandardFooter( "N7_" );
      CopyAllSheetInTotalBook( SheetName, false, "N7_Footer", 0, SheetName );
    elif(m_ByGrpID > 0 )
      SetActiveSheet( SheetName );
      UseNewSheetInTotalBook();

      PrintFormatString(N7EmptyRepStr,
                        "N7_EmptyRepStr", "ç•‚ ¢ÎØÆ´≠•≠≠ÎÂ ·¢Æ§≠ÎÂ Ø‡Æ¢Æ§Æ™ ØÆ ÆØ•‡†Ê®®.");
      CopyAllSheetInTotalBook( SheetName, false, "N7_EmptyRepStr", 0, SheetName );
    end;

  END;

  PRIVATE MACRO ä¢®‚Æ¢™†ëÆ°·‚¢•≠≠ÎÂñÅ_ëùÅ()
    var query_lot, cmd_lot, DataSet;
    var SheetName = "ä¢®‚ëÆ°·‚¢ëùÅ";
    var stat = 0;
    var PrevBuyID = 0;
    var is_back, Group;
    
    query_lot =   " select lnk.t_BuyID, lnk.t_Amount, lnk.t_CostBuy, lnk.t_NKDBuyAmount, lnk.t_InterestIncomeBuy, lnk.t_DiscountIncomeBuy, "
                + "        salelot.t_FIID, salelot.t_DealCode SaleDealCode, salelot.t_BegDiscount BegDiscount, salelot.t_Cost SaleCost, salelot.t_NKDAmount SaleNKDAmount, buylot.t_DealID BuyDealID, "
                + "        buylot.t_DealCode BuyDealCode, "
                + "        fin.t_FI_Code, fin.t_Name, fin.t_SumPrecision, fin.t_FaceValue, fin.t_FaceValueFI "
                + "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt salelot, dpmwrtsum_dbt buylot, dfininstr_dbt fin "
                + "  where lnk.t_ID_Operation = ? "
                + "    and lnk.t_ID_Step = -1 "
                + "    and salelot.t_SumID = lnk.t_SaleID "
                + "    and buylot.t_SumID = lnk.t_BuyID "
                + "    and fin.t_FIID = salelot.t_FIID "
                + "    and 1 <> 1" //??? ØÆ™† ≠• ØÆ≠Ô‚≠Æ, ™†™ °„§„‚ Æ‚´®Á†‚Ï·Ô ´Æ‚Î ëùÅ Æ‚ Æ·‚†´Ï≠ÎÂ
                + "  order by buylot.t_FIID, lnk.t_BuyID ";

    cmd_lot = DL_RSDCommand(query_lot);
    
    cmd_lot.AddParam(m_comm.rec.DocumentID);

    m_cnt_lot = cmd_lot.GetCount();

    if(m_cnt_lot > 0)

      VAR i = 0;
      InitProgress( m_cnt_lot, "è•Á†‚Ï Æ‚Á•‚† ØÆ ™¢®‚Æ¢™• ·Æ°·‚¢•≠≠ÎÂ Ê/°", "è•Á†‚Ï Æ‚Á•‚† ØÆ ™¢®‚Æ¢™• ·Æ°·‚¢•≠≠ÎÂ Ê/°" );

      SetActiveSheet( SheetName );
      
      UseNewSheetInTotalBook();

      if((m_PrintMode == DL_OUTREPORT_STD) and (m_PrintedStdHead == false))
        PrintFormatString("                                                         èêéíéäéã äÇàíéÇäà\n");
        PrintFormatString("                                                 Ñ†‚† ÆØ•‡†Ê®®: " + string(m_comm.rec.CommDate:f)+ " ™Æ§: " + m_comm.rec.CommCode);
        m_PrintedStdHead = true;
      end;

      PrintFormatString(N8RepHeaderStr,
                        "N8_RepHead", "ëØ®·†≠®• ‡†ß¨•È•≠≠ÎÂ ´Æ‚Æ¢ Ê•≠≠ÎÂ °„¨†£, ¢ÎØ„È•≠≠ÎÂ °†≠™Æ¨, ¢ ·§•´™†Â ØÆ™„Ø™®"
                       );
      CopyAllSheetInTotalBook( SheetName, false, "N8_RepHeader", 0, SheetName );  
      
      CopyAllSheetInTotalBook( SheetName, false, "N8_TableHeader", 0, SheetName ); 
      RegisterTable( "N8_MainTable", N8TableHeader_OWN,
                     "N8_FI_Code",    
                     "N8_BuyDealCode",   
                     "N8_SaleDealCode",
                     "N8_Qnty",  
                     "N8_FaceValue",
                     "N8_FaceValueFI",
                     "N8_Cost",  
                     "N8_StartDisc", 
                     "N8_RestStartDisc",
                     "N8_WrtDisc"
                   );

      DataSet = cmd_lot.Execute();
      while(DataSet.moveNext())

        UseProgress(i = i + 1);

        if(PrevBuyID != DataSet.BuyID)
          var dl_leg   = TRecHandler( "dl_leg" ),
              Tick     = TBFile("dl_tick"),
              LotBuy   = TRecHandler("pmwrtsum"),
              LegKind, Principal, TotalCost;

          Tick.Clear();
          Tick.rec.DealID = DataSet.BuyDealID;
          Tick.GetEQ();

          dl_leg = GetDlLegByDealID( DataSet.BuyDealID, LEG_KIND_DL_TICK );

          Principal = dl_leg.Principal;
          TotalCost = dl_leg.TotalCost;

          if( èÆ´„Á®‚ÏãÆ‚èÆë§•´™•(Tick.rec, PM_WRITEOFF_SUM_BUY, LotBuy, false, null, false) )
            PrintTableLine( "N8_FI_Code:c",       DataSet.FI_Code,                     null,
                            "N8_BuyDealCode:c",   DataSet.BuyDealCode,                 null,
                            "N8_SaleDealCode:c",  "",                                  null,
                            "N8_Qnty:r",          Principal,                           SetPrecisionByFractPart(Principal, DataSet.SumPrecision(), 0),
                            "N8_FaceValue:r",     DataSet.FaceValue*Principal,         null,
                            "N8_FaceValueFI:c",   GetFinInstrCcy(DataSet.FaceValueFI), null,
                            "N8_Cost:r",          "",                                  null,
                            "N8_StartDisc:r",     "",                                  null,
                            "N8_RestStartDisc:r", "",                                  null,
                            "N8_WrtDisc:r",       ""/*???*/,                           null
                          );
           end;
        end;

        PrintTableLine( "N8_FI_Code:c",       "",                                                    null,
                        "N8_BuyDealCode:c",   "",                                                    null,
                        "N8_SaleDealCode:c",  DataSet.SaleDealCode,                                  null,
                        "N8_Qnty:r",          DataSet.Amount,                                        SetPrecisionByFractPart(DataSet.Amount, DataSet.SumPrecision(), 0),
                        "N8_FaceValue:r",     DataSet.FaceValue*DataSet.Amount,                      null,
                        "N8_FaceValueFI:c",   GetFinInstrCcy(DataSet.FaceValueFI), null,
                        "N8_Cost:r",          DataSet.SaleCost + DataSet.SaleNKDAmount,              null,
                        "N8_StartDisc:r",     DataSet.BegDiscount,                                   null,
                        "N8_RestStartDisc:r", ""/*???*/,                                             null,
                        "N8_WrtDisc:r",       "",                                                    null
                      );

        PrevBuyID = DataSet.BuyID;
      end;

      EndTable();
      CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );

      if(m_PrintMode == DL_OUTREPORT_EXCEL)
        AddStandardFooter( "N8_" );
        CopyAllSheetInTotalBook( SheetName, false, "N8_Footer", 2, SheetName );
      end;

      remprogress();
    end;

  END;

  PRIVATE MACRO è‡Æ¢Æ§™®_ëùÅ()
    var query_carry, cmd_carry, DataSet;
    var SheetName = "è‡Æ¢Æ§™®ëùÅ";
    var stat = 0;
    var PrevPartyID = 0;
    var PrevContract = 0;

    query_carry =   " select q.t_Party,  q.t_Contract, q.t_Number AS ContractNumber, "
                + "        q.t_Numb_Document, q.t_Ground, q.t_Account_Payer, q.t_Sum_Payer, q.t_FIID_Payer, "
                + "        q.t_Account_Receiver, q.t_Sum_Receiver, q.t_FIID_Receiver, q.t_Sum_Natcur "
                + "   from ("
                + "         select grp.t_Party, grp.t_Contract, contr.t_Number, "
                + "                carry.t_Numb_Document, carry.t_Ground, carry.t_Account_Payer, carry.t_Sum_Payer, carry.t_FIID_Payer, "
                + "                carry.t_Account_Receiver, carry.t_Sum_Receiver, carry.t_FIID_Receiver, carry.t_Sum_Natcur, carry.t_AccTrnID "
                + "           from dpmwrtgrp_dbt grp, ddlgrdoc_dbt grdoc, dacctrn_dbt carry, dsfcontr_dbt contr "
                + "          where grp.t_DocKind = ? "
                + "            and grp.t_DocID = ? "
                + "            and grp.t_IsSecOwn = 'X' "
                + "            and grdoc.t_ServDocKind = grp.t_DocKind "
                + "            and grdoc.t_ServDocID = grp.t_DocID "
                + "            and grdoc.t_GrpID = grp.t_ID "
                + "            and grdoc.t_DocKind = " + DLDOC_CARRY
                + "            and grdoc.t_SourceType = " + DLGR_SOURCETYPE_NORMAL
                + "            and carry.t_AccTrnID = grdoc.t_DocID "
                + "            and contr.t_ID(+) = grp.t_Contract "
                + "        ) q "
                + "  order by q.t_Party, q.t_Contract asc, q.t_Numb_Document asc, q.t_AccTrnID asc ";

    cmd_carry = DL_RSDCommand(query_carry);
    
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);
    cmd_carry.AddParam(m_comm.rec.DocKind);
    cmd_carry.AddParam(m_comm.rec.DocumentID);

    m_cnt_carry = cmd_carry.GetCount();

    if(m_cnt_carry > 0)
      SetActiveSheet( SheetName );

      UseNewSheetInTotalBook();

      if((m_PrintMode == DL_OUTREPORT_STD) and (m_PrintedStdHead == false))
        PrintFormatString("                                                         èêéíéäéã äÇàíéÇäà\n");
        PrintFormatString("                                                 Ñ†‚† ÆØ•‡†Ê®®: " + string(m_comm.rec.CommDate:f)+ " ™Æ§: " + m_comm.rec.CommCode);
        m_PrintedStdHead = true;
      end;

      PrintFormatString(N9RepHeaderStr,
                        "N9_RepHead", "îÆ‡¨®‡Æ¢†≠®• Ø‡Æ¢Æ§Æ™ ØÆ ·§•´™†¨ · Çé"
                       );
      CopyAllSheetInTotalBook( SheetName, false, "N9_RepHeader", 0, SheetName );

      VAR i = 0;
      InitProgress( m_cnt_carry, "è•Á†‚Ï Ø‡Æ¢Æ§Æ™ ØÆ ·§•´™†¨ · Çé", "è•Á†‚Ï Ø‡Æ¢Æ§Æ™ ØÆ ·§•´™†¨ · Çé" );

      DataSet = cmd_carry.Execute();
      stat = DataSet.moveNext();
      while(stat)
        UseProgress(i = i + 1);
        
        if( (PrevPartyID != DataSet.Party) or (PrevContract != DataSet.Contract) )

           CopyAllSheetInTotalBook( SheetName, false, "N9_TableHeader", 0, SheetName );
          RegisterTable( "N9_MainTable",   N9TableHeader_OWN,
                         "N9_DealCode",   
                         "N9_Ground",    
                         "N9_DtAccount", 
                         "N9_DtSum", 
                         "N9_DtFI",  
                         "N9_CtAccount", 
                         "N9_CtSum", 
                         "N9_CtFI",  
                         "N9_NatSum"   
                       );
        end;

        PrintTableLine( "N9_DealCode:c",   DataSet.Numb_Document,                                  null,
                        "N9_Ground:l",     DataSet.Ground,                                         null,
                        "N9_DtAccount:c",  DataSet.Account_Payer,                                  null,
                        "N9_DtSum:r",      DataSet.Sum_Payer,                                      null,
                        "N9_DtFI:c",       GetFICode(DataSet.FIID_Payer, null, FICK_ISOSTRING),    null,
                        "N9_CtAccount:c",  DataSet.Account_Receiver,                               null,
                        "N9_CtSum:r",      DataSet.Sum_Receiver,                                   null,
                        "N9_CtFI:c",       GetFICode(DataSet.FIID_Receiver, null, FICK_ISOSTRING), null,
                        "N9_NatSum:r",     DataSet.Sum_Natcur,                                     null
                      );


        PrevPartyID = DataSet.Party;
        PrevContract = DataSet.Contract;
        stat = DataSet.moveNext();
        
        if((not stat) or (PrevPartyID != DataSet.Party) or (PrevContract != DataSet.Contract) )
          EndTable();
          CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );
        end;
      end;

      if(m_PrintMode == DL_OUTREPORT_EXCEL)
        AddStandardFooter( "N9_" );
        CopyAllSheetInTotalBook( SheetName, false, "N9_Footer", 2, SheetName );
      end;

      remprogress();
    end;

  END;

  PRIVATE MACRO ñÅ·ç„´•¢Î¨®ä„ØÆ≠†¨®óè()
    var ReportLineData_XML:variant;
    var NullFiwarntsData:CSC_NullFiwarnts;
    var stat = 0;
    var HeadPrinted = false;
    var SheetName = "ç„´•¢Î• ™„ØÆ≠Î ® óè";

    SetActiveSheet( SheetName );

    UseNewSheetInTotalBook();
     
    ReportLineData_XML = GetLogDataXML(m_comm.rec.DocKind, m_comm.rec.DocumentID, LOG_TYPE_DATA, false, SC_REPORTKIND_NULLFIWARNTS);
    ReportLineData_XML.SetReportNumber(SC_REPORTKIND_NULLFIWARNTS);
    
    if(ReportLineData_XML)
      stat = ReportLineData_XML.Next();
      while( stat )

         NullFiwarntsData = ReportLineData_XML.GetReportLineData();

         if(HeadPrinted == false)
           SetActiveSheet( SheetName );
           UseNewSheetInTotalBook();

           PrintFormatString(N12RepHeaderStr,
                             "N12_RepHead", "ëØ®·Æ™ ¢ÎØ„·™Æ¢ · ≠„´•¢Î¨® ™„ØÆ≠†¨®/óè");
           CopyAllSheetInTotalBook( SheetName, false, "N12_RepHeader", 0, SheetName );  
           
           CopyAllSheetInTotalBook( SheetName, false, "N12_TableHeader", 1, SheetName ); 
           RegisterTable( "N12_MainTable", N12TableHeader,
                          "N12_N0",    
                          "N12_N1",  
                          "N12_N2",   
                          "N12_N3"
                        );

           HeadPrinted = true;
         end;

         PrintTableLine( "N12_N0:c", NullFiwarntsData.FI_Code,  null,
                         "N12_N1:c", NullFiwarntsData.FI_Name,  null,
                         "N12_N2:c", IIF(NullFiwarntsData.isNullCoup == 1, "Ñ†", ""), null,
                         "N12_N3:c", IIF(NullFiwarntsData.isNullPart == 1, "Ñ†", ""), null
                       );


         stat = ReportLineData_XML.Next();

         m_cnt_nullfiwarnts = m_cnt_nullfiwarnts + 1;
         
      end;

      if(HeadPrinted)
        EndTable();
        CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );

        if(m_PrintMode == DL_OUTREPORT_EXCEL)
          AddStandardFooter( "N12_" );
          CopyAllSheetInTotalBook( SheetName, false, "N12_Footer", 0, SheetName );
        end;
      end;
    end; 

  END;

  PRIVATE MACRO ê•ØÆÅ•ßèÆ£†Ë•≠®©ä„ØÆ≠†óè()
    var ReportLineData_XML:variant;
    var REPO_WithNotRepCoup:REPOWithNotRepaymentCoup;
    var stat = 0;
    var HeadPrinted = false;
    var SheetName = "ç•ØÆ£†Ë•≠≠Î• ™„ØÆ≠Î ® óè";

    SetActiveSheet( SheetName );

    UseNewSheetInTotalBook();
     
    ReportLineData_XML = GetLogDataXML(m_comm.rec.DocKind, m_comm.rec.DocumentID, LOG_TYPE_DATA, false, SC_REPORTKIND_REPOWTHREPCOUP);
    ReportLineData_XML.SetReportNumber(SC_REPORTKIND_REPOWTHREPCOUP);
    
    if(ReportLineData_XML)
      stat = ReportLineData_XML.Next();
      while( stat )

         REPO_WithNotRepCoup = ReportLineData_XML.GetReportLineData();

         if(HeadPrinted == false)
           SetActiveSheet( SheetName );
           UseNewSheetInTotalBook();

           PrintFormatString(N13RepHeaderStr,
                             "N13_RepHead", "Ç≠®¨†≠®•! Ñ´Ô ·´•§„ÓÈ®Â ·§•´Æ™ ‡•ØÆ Æ‚·„‚·‚¢„Ó‚ ÆØ•‡†Ê®® ØÆ£†Ë•≠®Ô ™„ØÆ≠†/óè ¢≠„‚‡® ‡•ØÆ:");
           CopyAllSheetInTotalBook( SheetName, false, "N13_RepHeader", 0, SheetName );  
           
           CopyAllSheetInTotalBook( SheetName, false, "N13_TableHeader", 1, SheetName ); 
           RegisterTable( "N13_MainTable", N13TableHeader,
                          "N13_N0",    
                          "N13_N1",  
                          "N13_N2",   
                          "N13_N3",   
                          "N13_N4"
                        );

           HeadPrinted = true;
         end;

         PrintTableLine( "N13_N0:c", REPO_WithNotRepCoup.RepoCode, null,
                         "N13_N1:c", REPO_WithNotRepCoup.FI_Code,  null,
                         "N13_N2:c", REPO_WithNotRepCoup.FI_Name,  null,
                         "N13_N3:c", REPO_WithNotRepCoup.Coup_Number, null,
                         "N13_N4:c", REPO_WithNotRepCoup.Coup_DrawingDate, null
                       );


         stat = ReportLineData_XML.Next();

         m_cnt_repowthrepcoup = m_cnt_repowthrepcoup + 1;
         
      end;

      if(HeadPrinted)
        EndTable();
        CopyAllSheetInTotalBook( SheetName, false, GetTableRange(), 0, SheetName );

        if(m_PrintMode == DL_OUTREPORT_EXCEL)
          AddStandardFooter( "N13_" );
          CopyAllSheetInTotalBook( SheetName, false, "N13_Footer", 0, SheetName );
        end;
      end;
    end; 

  END;

  PRIVATE MACRO Create()
    if(m_ByGrpID == 0)
      ñÅ·ç„´•¢Î¨®ä„ØÆ≠†¨®óè();
      ê•ØÆÅ•ßèÆ£†Ë•≠®©ä„ØÆ≠†óè();
      ä¢®‚Æ¢™†ëÆ°·‚¢•≠≠ÎÂñÅ();
      ä¢®‚Æ¢™†ä´®•≠‚·™®ÂñÅ();
      ä¢®‚Æ¢™†ëÆ°·‚¢•≠≠ÎÂñÅ_ëùÅ();
      //è‡Æ¢Æ§™®();
      //è‡Æ¢Æ§™®_ëùÅ();
      ç†´Æ£Æ¢Î•ãÆ‚Î();
      é°Í•™‚ÎçÑê_ûãç();
      if(m_PrintMode == DL_OUTREPORT_STD)
        AddStandardFooter();
      end;
    end;
    ë¢Æ§≠Î•è‡Æ¢Æ§™®();
    if(m_ByGrpID == 0)
      è•‡®Æ§®Á•·™®•äÆ¨®··®®();
      á†™‡Î‚®•ëÁ•‚Æ¢();
      ëÆÆ°È•≠®Ô();
    end;

    OnError(er)
      var err_text = GetFullErrorMessage(er);
      MsgBox(err_text);
  END;

  m_PrintMode = Mode;
  m_comm = dl_comm;
  m_ByGrpID = 0;
  
  if(ValType(GrpID) != V_UNDEF)
    m_ByGrpID = GrpID;
  end;

  initDL_CReportTemplate( NULL, "Report_Accounting.xls", NULL, IsWebService );

END;

MACRO PrintSPDOCOFFbyGrpID(comm, Mode, GrpID)
  var ReportLineData_XML:variant;
  var IsExistsErr = false;
  var ErrData:CSC_AccountingRepErr;
  record DlComm("dl_comm");
  var reccomm = TRecHandler("dl_comm");
  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*‰†©´ ¢Î¢Æ§† §´Ô Æ‚Á•‚†*/
  var stat = 0;
  var printkvit = false, printcomis = false, cntobj = 0, cmd, printaccclose = false;

  SetBuff(DlComm, comm);

  copy(reccomm, dlcomm);

  var V_Report = SC_Accounting_Report(reccomm, Mode/*DL_OUTREPORT_EXCEL*/, GrpID);
  V_Report.Run();
  V_Report = NULL;
  return true;

END;

MACRO PrintSPDOCOFFbyGrpIDToSTD(comm, GrpID)
  return PrintSPDOCOFFbyGrpID(comm, DL_OUTREPORT_STD, GrpID);
END;

MACRO PrintSPDOCOFFbyGrpIDToExcel(comm, GrpID)
  return PrintSPDOCOFFbyGrpID(comm, DL_OUTREPORT_EXCEL, GrpID);
END;

/*Ø•Á†‚Ï Æ‚Á•‚† ØÆ §†≠≠Î¨ xml*/
MACRO PrintAccountingByXML(comm, Mode)
  var ReportLineData_XML:variant;
  var IsExistsErr = false;
  var ErrData:CSC_AccountingRepErr;
  record DlComm("dl_comm");
  var reccomm = TRecHandler("dl_comm");
  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*‰†©´ ¢Î¢Æ§† §´Ô Æ‚Á•‚†*/
  var stat = 0;
  var printkvit = false, printcomis = false, cntobj = 0, cmd, printaccclose = false;
  
  SetBuff(DlComm, comm);

  copy(reccomm, dlcomm);

  SC_Accounting_Report(reccomm, Mode).Run();
  
  return true;
END;

/*Ø•Á†‚Ï Æ‚Á•‚† ØÆ §†≠≠Î¨ xml web*/
MACRO WebPrintAccountingByXML(comm, Mode)
  var rep, FC;

  rep = SC_Accounting_Report(comm, Mode, NULL, true);
  rep.Run();

  if(Mode == DL_OUTREPORT_STD)
     FC = CreateFileContainer(ConvertTxt2Html(rep.GetFullReportFileNames[0]));
  elif(Mode == DL_OUTREPORT_EXCEL)
     FC = CreateFileContainer(rep.GetFullReportFileNames[0]);
  end;

  return FC;
END;


PRIVATE CLASS (DL_CReportTemplate) SC_AccountingMsg_Report(dl_comm)
  PRIVATE VAR m_comm = TRecHandler("dl_comm");

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  private macro RemoveSymbFromMsg(symb:string, msg:string):string
     var retVal:string = "";
     //var sourceStr:string = msg;
     var startPos:integer = 1;

     while( startPos > 0 ) 
       startPos = StrBrk ( msg, "|" ); 
       var tmpStr:string = Trim ( SubStr(msg,1,startPos-1) );
       if ( StrLen( tmpStr ) )
         retVal = RetVal + tmpStr + " ";
       end;
       msg = SubStr( msg, startPos+1 );
     end;
     retVal = Trim(RetVal + msg);
     return retVal;
  end;

  PRIVATE MACRO Create()

    var ReportLineData_XML:variant;
    var IsExistsErr = false;
    var ErrData:CSC_AccountingRepErr;
    var reccomm = TRecHandler("dl_comm");
    VAR errtext, errcode;
    var stat = 0;
    var cntobj = 0, cmd;
    var SheetName = "ëÆÆ°È•≠®Ô";
    var i = 0;
    

    SetActiveSheet(SheetName);

    RegisterTable( "N1_MainTable", "", "N1_DealCode", "N1_ErrCode", "N1_Message");

    PrintFormatString(NULL,
                      "N1_OprDate", string(m_comm.rec.CommDate:f),
                      "N1_OprCode", m_comm.rec.CommCode);

    cmd = DL_RSDCommand("select 1 from ddlgrdoc_dbt where t_ServDocKind = ? and t_ServDocID = ? and rownum = 1");
    cmd.AddParam(m_comm.rec.DocKind);
    cmd.AddParam(m_comm.rec.DocumentID);
    cntobj = cmd.GetCount();

    ReportLineData_XML = GetLogDataXML(m_comm.rec.DocKind, m_comm.rec.DocumentID, LOG_TYPE_ERROR, false);
    ReportLineData_XML.SetReportNumber(0);
    
    stat = ReportLineData_XML.Next();

    if(stat or (cntobj == 0))
      PrintFormatString("", "N1_OprStateMsg", "");
      
      if(not stat)
        PrintTableLine( "N1_DealCode",  "",                      null,
                        "N1_ErrCode",   "",                      null,
                        "N1_Message",   "ç•‚ ØÆ§ÂÆ§ÔÈ®Â ·§•´Æ™", null
                      );

      else
        InitProgress(-1, "è•Á†‚Ï ·ÆÆ°È•≠®©", "è•Á†‚Ï ·ÆÆ°È•≠®©");
        while(stat)
          ErrData = ReportLineData_XML.GetReportLineData();
          var RetValErrMsg:string = "";
          RetValErrMsg  = RemoveSymbFromMsg("|",ErrData.ErrStr);         
          PrintTableLine( "N1_DealCode",  ErrData.DealCode, null,
                          "N1_ErrCode",   ErrData.ErrCode,  null,
                          "N1_Message:w", RetValErrMsg,     null
                        );

          stat = ReportLineData_XML.Next();

          UseProgress(i = i + 1);
        end;
        RemProgress();
      end;

      EndTable();

    else
      PrintFormatString("", "N1_OprStateMsg", "éØ•‡†Ê®Ô ß†¢•‡Ë•≠† „·Ø•Ë≠Æ");
    end;

  END;

  m_comm = dl_comm;

  initDL_CReportTemplate( NULL, "Report_AccountingMsg.xls", NULL, false );
END;

MACRO PrintAccountingByXMLToSTD(comm)
  return PrintAccountingByXML(comm, DL_OUTREPORT_STD);
END;

MACRO PrintAccountingByXMLToExcel(comm)
  return PrintAccountingByXML(comm, DL_OUTREPORT_EXCEL);
END;

MACRO PrintAccountingMsg(comm)
    record DlComm("dl_comm");
  var reccomm = TRecHandler("dl_comm");

  SetBuff(DlComm, comm);

  copy(reccomm, dlcomm);

  var Rep = SC_AccountingMsg_Report(reccomm);
      Rep.Run(1);
           
  return true; 
END;


//////////////////////////////////////////////////////////////////////////////////////////////////////////
//ÇõèéãçÖçàÖ Åì
//////////////////////////////////////////////////////////////////////////////////////////////////////////

private var AccLogPackID = 0;
private var AccLogExecID = 0;
private macro AddScAccLogInfo(dl_comm, StrInfo:string)
  var query, cmd, DataSet;

  if(AccLogPackID == 0)
    query = " select NVL(MAX(t_ExecID), 0) as MaxExecID from dscacclog_dbt where t_ServDocKind = ? and t_ServDocID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.addParam(dl_comm.rec.DocKind);
    cmd.addParam(dl_comm.rec.DocumentID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      AccLogExecID = int(DataSet.MaxExecID) + 1;
    end;
  end;

  query = "INSERT INTO DSCACCLOG_DBT (T_SERVDOCKIND, T_SERVDOCID, T_EXECID, T_PACKID, T_STATE, T_STRINFO) VALUES(?,?,?,?,?,?)";

  cmd = DL_RSDCommand(query);

  cmd.addParam(dl_comm.rec.DocKind);
  cmd.addParam(dl_comm.rec.DocumentID);
  cmd.addParam(AccLogExecID);
  cmd.addParam(AccLogPackID = AccLogPackID + 1);
  cmd.addParam(0);
  cmd.addParam(StrInfo);

  cmd.ExecuteCMD();
end;


//™´†·· · §†≠≠Î¨® §´Ô ™Æ≠¢•©•‡†
class AccCnvDataDLCOMM(_DocumentID,_isRunFromCnv,_msesPrcId,_primeMode)
  var DocumentID = _DocumentID;
  var isRunFromCnv = _isRunFromCnv;
  var MsesPrcId = _msesPrcId;
  var PrimeMode = _primeMode;
end;

macro èÆ´„Á®‚Ïó†·‚Ïë§•´™®èÆÇ®§„ò†°´Æ≠†(TemplNum)
  var query, cmd, DataSet;
 var DealPart = 1;
    
  query = "select rsi_dlgr.RSI_GetDealPartByGrTemplNum(?) as DealPart from dual";
  
  cmd = DL_RSDCommand(query);

  cmd.AddParam(TemplNum);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    DealPart = int(DataSet.DealPart);
 end;

 return DealPart;
end;


private macro Ö·‚Ïç•ØÆ£†Ë•≠≠Î•ä„ØÆ≠Îóè(FIID:integer, DrawingDate:date, IsPartial)
  var query, cmd, DataSet;

  query =   " select 1 "
          + "   from dfiwarnts_dbt "
          + "  where t_FIID = ? "
          + "    and t_SPIsClosed = CHR(0) "
          + "    and t_DrawingDate < ? ";

  if(IsPartial == "X")
    query = query + " and t_IsPartial = 'X' ";
  else
    query = query + " and t_IsPartial = CHR(0) ";
  end;
  
  cmd = DL_RSDCommand(query);
  cmd.AddParam(FIID);
  cmd.AddParam(DrawingDate);

  if(cmd.GetCount() > 0)
    return true;
  end;

  return false;
end;

private macro èÆ´„Á®‚ÏäÆ´®Á•·‚¢ÆÇêÖèé(FIID:integer, DrawingDate:date)
  var query, cmd, DataSet;

  query =   " select NVL(SUM(h.t_Amount), 0) as Amount "
          + "   from v_rqhistex h, ddlrq_dbt rq1, ddlrq_dbt rq2 "
          + "  where h.t_FIID = ? "
          + "    and h.t_DealPart = 2 "
          + "    and h.t_SubKind = " + DLRQ_SUBKIND_AVOIRISS
          + "    and h.t_Type = " + DLRQ_TYPE_DELIVERY
          + "    and h.t_Instance = (select MAX(h1.t_Instance) "
          + "                          from v_rqhistex h1 "
          + "                         where h1.t_ID = h.t_ID "
          + "                           and h1.t_ChangeDate <= ? "
          + "                       )"
          + "    and rq1.t_FIID = ? "
          + "    and rq1.t_DocKind = h.t_DocKind "
          + "    and rq1.t_DocID = h.t_DocID "
          + "    and rq1.t_DealPart = 1 "
          + "    and rq1.t_SubKind = h.t_SubKind "
          + "    and rq1.t_Type = h.t_Type "
          + "    and rq1.t_FactDate <= ? "
          + "    and rq2.t_FIID = ? "
          + "    and rq2.t_DocKind = h.t_DocKind "
          + "    and rq2.t_DocID = h.t_DocID "
          + "    and rq2.t_DealPart = 2 "
          + "    and rq2.t_SubKind = h.t_SubKind "
          + "    and rq2.t_Type = h.t_Type "
          + "    and rq2.t_PlanDate > ? ";


  cmd = DL_RSDCommand(query);
  cmd.AddParam(FIID);
  cmd.AddParam(DrawingDate-1);
  cmd.AddParam(FIID);
  cmd.AddParam(DrawingDate-1);
  cmd.AddParam(FIID);
  cmd.AddParam(DrawingDate);

  DataSet = cmd.execute();

  if(DataSet.MoveNext())
     return ToMoney(DataSet.Amount);
  end;
   
  return $0;
end;

private macro á†™‡Î‚Ïä„ØÆ≠óè_OLD( IsPartial, FIID, Number, WarntID:integer, dl_comm )

  RslDefCon.BeginTrans();

  var stat = FI_SetIsClosedOnCoupon( FIID, string(Number), IIF(IsPartial==SET_CHAR,true,false) );
  var mes_stat, mes;

  if( stat !=0 )
     mes_stat = GetErrMsg();
     if (strlen(mes_stat) == 0)
        InitError();
        MemoryError(stat);
        mes_stat = GetErrMsg();
     end;

     if( IsPartial==SET_CHAR )
        mes = "éË®°™† ß†™‡Î‚®Ô †≠™•‚Î óè · ≠Æ¨•‡Æ¨ \""+string(Number)+"\" ¢ÎØ„·™† Ê/° · ID = "+string(FIID)+". ";
     else
        mes = "éË®°™† ß†™‡Î‚®Ô †≠™•‚Î ™„ØÆ≠† · ≠Æ¨•‡Æ¨ \""+string(Number)+"\" ¢ÎØ„·™† Ê/° · ID = "+string(FIID)+". ";
     end;
     RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", stat, mes+mes_stat);

     RslDefCon.RollbackTrans();
  else
     var cmd = RSDCommand( " INSERT INTO DDLGRDOC_DBT ( t_ID,          " +
                           "                            t_GrDealID,    " +
                           "                            t_DocKind,     " +
                           "                            t_DocID,       " +
                           "                            t_ServDocKind, " +
                           "                            t_ServDocID,   " +
                           "                            t_GrpID,       " +
                           "                            t_SourceType ) " +
                           " VALUES(0, 0, ?, ?, ?, ?, 0, ?)" );

     cmd.addParam( "", RSDBP_IN, DLDOC_COUPON );
     cmd.addParam( "", RSDBP_IN, WarntID );
     cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocKind );
     cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocumentID );
     cmd.addParam( "", RSDBP_IN, DLGR_SOURCETYPE_CLOSEFIWARNTS );
     cmd.execute();

     RslDefCon.CommitTrans();
  end;

  OnError(er)
    var err_text = GetFullErrorMessage(er);
    if(isEqClass("TRsdError", er.err))
      MsgBox(err_text);
      RunError(err_text);
    else
      if(RslDefCon.IsInTrans)
        RslDefCon.RollbackTrans();
      end;
    end;
end;

Private var IsPartial_;
Private var FIID_;
Private var Number_;
Private var WarntID_:integer;
//Private dl_comm_;
PRIVATE FILE dl_comm_ ("dl_comm.dbt") write; 
PRIVATE FILE fiwarnts ("fiwarnts.dbt") write;


private var ScAccLogArr = TArray();

private macro á†™‡Î‚Ïä„ØÆ≠óè_( )

  var mes_stat, mes;

  ScAccLogArr[ScAccLogArr.size] = "ç†Á†´Æ ‰-Ê®® á†™‡Î‚Ïä„ØÆ≠óè_. WarntID_ = " + WarntID_;

  var stat = FI_SetIsClosedOnCouponWait( FIID_, string(Number_), IIF(IsPartial_==SET_CHAR,true,false) );
  ScAccLogArr[ScAccLogArr.size] = "ÇÎØÆ´≠•≠† FI_SetIsClosedOnCouponWait. stat = " + stat;
  if( stat !=0 )
    ScAccLogArr[ScAccLogArr.size] = "è‡•‡Î¢†≠®• ‚‡†≠ß†™Ê®®";
    AbortTrn();
  else
     var cmd = RSDCommand( " INSERT INTO DDLGRDOC_DBT ( t_ID,          " +
                           "                            t_GrDealID,    " +
                           "                            t_DocKind,     " +
                           "                            t_DocID,       " +
                           "                            t_ServDocKind, " +
                           "                            t_ServDocID,   " +
                           "                            t_GrpID,       " +
                           "                            t_SourceType ) " +
                           " VALUES(0, 0, ?, ?, ?, ?, 0, ?)" );

     cmd.addParam( "", RSDBP_IN, DLDOC_COUPON );
     cmd.addParam( "", RSDBP_IN, WarntID_ );
     cmd.addParam( "", RSDBP_IN, dl_comm_.DocKind );
     cmd.addParam( "", RSDBP_IN, dl_comm_.DocumentID );
     cmd.addParam( "", RSDBP_IN, DLGR_SOURCETYPE_CLOSEFIWARNTS );
     cmd.execute();

     ScAccLogArr[ScAccLogArr.size] = "ÇÎØÆ´≠•≠† ¢·‚†¢™† ¢ DDLGRDOC_DBT";

  end;

  ScAccLogArr[ScAccLogArr.size] = "äÆ≠•Ê ‰-Ê®® á†™‡Î‚Ïä„ØÆ≠óè_";
  OnError(er)
    var err_text = GetFullErrorMessage(er);
    ScAccLogArr[ScAccLogArr.size] = "OnError ‰-Ê®® á†™‡Î‚Ïä„ØÆ≠óè_ (ØÆ´≠Æ• ·ÆÆ°È•≠®•):"+err_text;
    if(isEqClass("TRsdError", er.err))
      MsgBox(err_text);
      RunError(err_text);
      AbortTrn();
    end;
end;

private macro á†™‡Î‚Ïä„ØÆ≠óè( IsPartial, FIID, Number, WarntID:integer, dl_comm )

  AddScAccLogInfo(dl_comm, "ç†Á†´Æ ‰-Ê®® á†™‡Î‚Ïä„ØÆ≠óè");
  ScAccLogArr.size = 0;

  var mes_stat, mes;
  IsPartial_ = IsPartial;
  FIID_ = FIID; 
  Number_ = Number;
  WarntID_ = WarntID;
  ClearRecord( dl_comm_ );
  KeyNum( dl_comm_, 0 );
  dl_comm_.DocumentID = dl_comm.rec.DocumentID;
  GetEQ( dl_comm_ );
  AddScAccLogInfo(dl_comm, "á†Ø„·™ ‚‡†≠ß†™Ê®® á†™‡Î‚Ïä„ØÆ≠óè_");
  LoopInTrn(true);
  if (ProcessTrn(0, "á†™‡Î‚Ïä„ØÆ≠óè_",dl_comm_, fiwarnts) == false )   
     var stat = 28108;
     mes_stat = GetErrMsg();
     if (strlen(mes_stat) == 0)
        InitError();
        MemoryError(stat);
        mes_stat = GetErrMsg();
     end;

     ScAccLogArr[ScAccLogArr.size] = "í‡†≠ß†™Ê®Ô ß†¢•‡Ë®´†·Ï ÆË®°™Æ©: " + mes_stat;

     if( IsPartial_==SET_CHAR )
        mes = "éË®°™† ß†™‡Î‚®Ô †≠™•‚Î óè · ≠Æ¨•‡Æ¨ \""+string(Number_)+"\" ¢ÎØ„·™† Ê/° · ID = "+string(FIID_)+". ";
     else
        mes = "éË®°™† ß†™‡Î‚®Ô †≠™•‚Î ™„ØÆ≠† · ≠Æ¨•‡Æ¨ \""+string(Number_)+"\" ¢ÎØ„·™† Ê/° · ID = "+string(FIID_)+". ";
     end;
     RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", stat, mes+mes_stat);

  end;


  if(ScAccLogArr.size > 0)
    var i = 0;

    while(i < ScAccLogArr.size)
      AddScAccLogInfo(dl_comm, ScAccLogArr[i]);
      i = i + 1;
    end;
  end;

  AddScAccLogInfo(dl_comm, "äÆ≠•Ê ‰-Ê®® á†™‡Î‚Ïä„ØÆ≠óè");
end;

private macro á†™‡Î‚ÏñÅ( FIID, dl_comm, DrawingDate )

  var transactionStarted = false;

  RslDefCon.BeginTrans();
  transactionStarted = true;

  var stat = SP_CloseFININSTR(FIID, DrawingDate);
  var mes_stat;

  if( stat !=0 )
     mes_stat = GetErrMsg();
     if (strlen(mes_stat) == 0)
        InitError();
        MemoryError(stat);
        mes_stat = GetErrMsg();
     end;
     RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", stat, "éË®°™† ß†™‡Î‚®Ô †≠™•‚Î ¢ÎØ„·™† Ê/° · ID = "+string(FIID)+". "+mes_stat);

     RslDefCon.RollbackTrans();
  else
     var cmd = RSDCommand( " INSERT INTO DDLGRDOC_DBT ( t_ID,          " +
                           "                            t_GrDealID,    " +
                           "                            t_DocKind,     " +
                           "                            t_DocID,       " +
                           "                            t_ServDocKind, " +
                           "                            t_ServDocID,   " +
                           "                            t_GrpID,       " +
                           "                            t_SourceType ) " +
                           " VALUES(0, 0, ?, ?, ?, ?, 0, ?)" );

     cmd.addParam( "", RSDBP_IN, DLDOC_ISSUE );
     cmd.addParam( "", RSDBP_IN, FIID );
     cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocKind );
     cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocumentID );
     cmd.addParam( "", RSDBP_IN, DLGR_SOURCETYPE_CLOSEFIWARNTS );
     cmd.execute();

     transactionStarted = false;
     RslDefCon.CommitTrans();
  end;

  OnError(er)
    var err_text = GetFullErrorMessage(er);
    if(isEqClass("TRsdError", er.err))
      MsgBox(err_text);
      RunError(err_text);
    else
      if(RslDefCon.IsInTrans)
        RslDefCon.RollbackTrans();
      end;
    end;
end;

private macro è‡Æ¢•‡®‚Ïé‚´Æ¶•≠≠Î•ë¢Æ§≠Î•è‡Æ¢Æ§™®(dl_comm:TBFile) : integer
  var cmd, dataSet;
  var cnt = 0, i = 0;
  var strErr = "ë„È•·‚¢„Ó‚ ≠•®·ØÆ´≠•≠≠Î• Æ‚´Æ¶•≠≠Î• ·¢Æ§≠Î• Ø‡Æ¢Æ§™®.", strCommCode = "";

  cmd = DL_RSDCommand("select dl.t_CommCode" +
                      "  from DSPDOCOFF_DBT DocOff, ddl_comm_dbt dl" + 
                      " where DocOff.t_State = ?" +
                      "   and DocOff.t_Date_Carry < ?" +
                      "   and dl.t_DocumentID = DocOff.t_ServOperID");
  cmd.addParam(SPDOCOFF_STATE_PREPARED);
  cmd.addParam(dl_comm.rec.CommDate);

  cnt = cmd.GetCount();

  if(cnt > 0)
    dataSet = cmd.Execute();
    while (dataSet.MoveNext() and (i < 5))
      strCommCode = strCommCode + " " + dataSet.CommCode + ",";
      i = i + 1;
    end;
    if (strCommCode != "")
      if (cnt == 1)
        strErr = strErr + "|ç•Æ°ÂÆ§®¨Æ Æ‚™†‚®‚Ï ·•‡¢®·≠„Ó ÆØ•‡†Ê®Ó Åì · ™Æ§Æ¨" + substr(strCommCode, 1, strlen(strCommCode)-1); // Æ°‡•¶•¨ ß†ØÔ‚„Ó
      else
        strErr = strErr + "|ç•Æ°ÂÆ§®¨Æ Æ‚™†‚®‚Ï ·•‡¢®·≠Î• ÆØ•‡†Ê®® Åì · ™Æ§†¨®" + substr(strCommCode, 1, strlen(strCommCode)-1); // Æ°‡•¶•¨ ß†ØÔ‚„Ó
        if (cnt > 5)
          strErr = strErr + ", ... ¢·•£Æ " + cnt + " Ë‚„™";
        end;
      end;
    end;

    msgbox(strErr);
  end;

  return cnt;
end;

macro à¨Ôç•Æ°‡†°Æ‚†≠≠Æ©ë‚‡Æ™®É‡†‰®™†(TemplNum:variant)
  var query, cmd, DataSet;
  cmd = DL_RSDCommand();
  query =   " select tk.t_Name lineName"
          + " from ddlgrtempl_dbt tk "
          + " where tk.t_num = ?";
  cmd.AddParam(TemplNum);
  DataSet = cmd.Execute(query);
  DataSet.moveNext();
  return DataSet.lineName;
end;

private macro è‡Æ¢•‡®‚Ïè•‡•≠„¨•‡†Ê®Óë§•´Æ™( dl_comm:variant ):integer

  var RetVal:integer = 0;

  if( ç„¶≠†è•‡•≠„¨•‡†Ê®Ôë§•´Æ™á†Ñ†‚„(dl_comm.rec.CommDate) )
     if( MsgBoxEx("í‡•°„•‚·Ô ¢ÎØÆ´≠®‚Ï Ø•‡•≠„¨•‡†Ê®Ó ·§•´Æ™ ¢ §†‚• " + string(dl_comm.rec.CommDate:f) + ". è‡Æ§Æ´¶®‚Ï ¢ÎØÆ´≠•≠®• °•ß Ø•‡•≠„¨•‡†Ê®®?", MB_YES+MB_NO, IND_NO) != IND_YES )
        RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", 1, "í‡•°„•‚·Ô ¢ÎØÆ´≠®‚Ï Ø•‡•≠„¨•‡†Ê®Ó ·§•´Æ™ ¢ §†‚• " + string(dl_comm.rec.CommDate:f));
        RetVal = 1;
     end;
  end;

  return RetVal;
end;

private macro è‡Æ‚Æ™Æ´®‡Æ¢†‚Ïç„´•¢Î•ä„ØÆ≠Îóè( dl_comm:variant ):integer
  var query, cmd, DataSet;
  var RetVal:integer = 0;
  var NullFiwarntsArr = TArray();

  query =   " with q as (select DISTINCT grpfi.t_FIID "
          + "              from dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi "
          + "             where grp.t_DocKind = ? "
          + "               and grp.t_DocID = ? "
          + "               and grpfi.t_GrpID = grp.t_ID "
          + "           )"
          + " select fin.t_FI_Code, fin.t_Name, "
          + "        (select count(1) "
          + "           from dfiwarnts_dbt fiw "
          + "          where fiw.t_FIID = fin.t_FIID "
          + "            and fiw.t_IsPartial = CHR(0) "
          + "            and fiw.t_IncomeRate = 0 "
          + "            and fiw.t_IncomeVolume = 0 "
          + "            and fiw.t_FirstDate <= ? "
          + "            and rownum = 1"
          + "        ) as CntNullCoup, "
          + "        (select count(1) "
          + "           from dfiwarnts_dbt fiw "
          + "          where fiw.t_FIID = fin.t_FIID "
          + "            and fiw.t_IsPartial = 'X' "
          + "            and fiw.t_IncomeRate = 0 "
          + "            and fiw.t_IncomeVolume = 0 "
          + "            and fiw.t_FirstDate <= ? "
          + "            and rownum = 1"
          + "        ) as CntNullPart "
          + "   from q, dfininstr_dbt fin "
          + "  where fin.t_FIID = q.t_FIID "
          + "    and RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_FI_Kind, fin.t_AvoirKind ) = " + AVOIRISSKIND_BOND;

  cmd = DL_RSDCommand(query);

  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.CommDate);
  
  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    if((DataSet.CntNullCoup > 0) or (DataSet.CntNullPart > 0))
      NullFiwarntsArr[NullFiwarntsArr.size] = CSC_NullFiwarnts(SC_REPORTKIND_NULLFIWARNTS, DataSet.FI_Code, DataSet.Name, DataSet.CntNullCoup, DataSet.CntNullPart);
    end;
  end;
  
  DL_SaveDataForReport_XML(dl_comm.rec.DocumentID, dl_comm.rec.DocKind, NullFiwarntsArr, LOG_TYPE_DATA);

  return RetVal;
end;

private macro è‡Æ‚Æ™Æ´®‡Æ¢†‚Ïé‚·„‚·‚¢®•ä„ØÆ≠†óèÇê•ØÆ( dl_comm:variant ):integer
  var query, cmd, DataSet;
  var RetVal:integer = 0;
  var REPO_WithNotRepCoup = TArray();

  query =   " WITH "
            + "    q "
            + "    AS "
            + "        (SELECT DISTINCT grpfi.t_FIID, "
            + "                         grpfin.t_FI_Code, "
            + "                         grpfin.t_Name, "
            + "                         grpfiw.T_NUMBER, "
            + "                         grpfiw.T_DRAWINGDATE, "
            + "                         grpfiw.t_IsPartial "
            + "           FROM dpmwrtgrp_dbt    grp, "
            + "                dpmwrtgrpfi_dbt  grpfi, "
            + "                dfininstr_dbt    grpfin, "
            + "                dfiwarnts_dbt    grpfiw "
            + "          WHERE     grp.t_DocKind = ? "
            + "                AND grp.t_DocID = ? "
            + "                AND grpfi.t_GrpID = grp.t_ID "
            + "                AND grpfin.t_FIID = grpfi.t_FIID "
            + "                AND RSB_FIInstr.FI_AvrKindsGetRoot (grpfin.t_FI_Kind, "
            + "                                                    grpfin.t_AvoirKind) = " + AVOIRISSKIND_BOND 
            + "                AND grpfiw.t_FIID = grpfin.t_FIID "
            + "                AND grpfiw.t_SPIsClosed = CHR (0) "
            + "                AND grpfiw.T_DRAWINGDATE <= ? "
            + "         UNION "
            + "         SELECT oblig.t_FIID, "
            + "                oblig.t_FI_Code, "
            + "                oblig.t_Name, "
            + "                oblig_fiw.T_NUMBER, "
            + "                oblig_fiw.T_DRAWINGDATE, "
            + "                oblig_fiw.t_IsPartial "
            + "           FROM dfininstr_dbt oblig, dfiwarnts_dbt oblig_fiw "
            + "          WHERE     RSB_FIInstr.FI_AvrKindsGetRoot (oblig.t_FI_Kind, "
            + "                                                    oblig.t_AvoirKind) = " + AVOIRISSKIND_BOND
            + IIF((dl_comm.rec.FIID > -1), " AND oblig.t_FIID = ? ", "") 
            + "                AND oblig_fiw.t_FIID = oblig.t_FIID "
            + "                AND oblig_fiw.t_SPIsClosed = CHR (0) "
            + "                AND oblig_fiw.T_DRAWINGDATE <= ?) "
            + "SELECT q.t_FI_Code, "
            + "       q.t_Name, "
            + "       tk.T_DEALCODE, "
            + "       q.T_NUMBER, "
            + "       q.T_DRAWINGDATE "
            + "  FROM q, ddl_tick_dbt tk "
            + " WHERE     EXISTS "
            + "               (SELECT leg1.* "
            + "                  FROM ddl_leg_dbt leg1 "
            + "                 WHERE     leg1.t_pfi = q.t_FIID "
            + "                       AND leg1.t_dealid = tk.t_dealid "
            + "                       AND leg1.t_legid = 0 "
            + "                       AND leg1.t_legkind = " + LEG_KIND_DL_TICK
            + "                       AND leg1.t_expiry < q.T_DRAWINGDATE) "
            + "       AND EXISTS "
            + "               (SELECT leg2.* "
            + "                  FROM ddl_leg_dbt leg2 "
            + "                 WHERE     leg2.t_pfi = q.t_FIID "
            + "                       AND leg2.t_dealid = tk.t_dealid "
            + "                       AND leg2.t_legid = 0 "
            + "                       AND leg2.t_legkind = " + LEG_KIND_DL_TICK_BACK
            + "                       AND leg2.t_expiry >= q.T_DRAWINGDATE) "
            + "       AND RSB_SECUR.IsREPO ( "
            + "               rsb_secur.get_OperationGroup ( "
            + "                   rsb_secur.get_OperSysTypes (tk.t_DealType, "
            + "                                               tk.t_BofficeKind))) = 1 "
            + "       AND tk.T_DEALSTATUS = 10 "
            + "       AND NOT EXISTS "
            + "               (SELECT grdeal.* "
            + "                  FROM ddlgrdeal_dbt grdeal "
            + "                 WHERE     grdeal.t_DocKind = tk.t_BOfficeKind "
            + "                       AND grdeal.t_DocID = tk.t_DealID "
            + "                       AND (       grdeal.t_TemplNum = " + DLGR_TEMPL_COUP
            + "                               AND q.t_IsPartial = CHR (0) "
            + "                            OR     grdeal.t_TemplNum = "  +DLGR_TEMPL_PARTREP
            + "                               AND q.t_IsPartial = CHR (88))) "
            + "       AND tk.t_clientid = -1 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);
  cmd.AddParam(dl_comm.rec.CommDate);
  if(dl_comm.rec.FIID > -1)
    cmd.AddParam(dl_comm.rec.FIID);
  end;
  cmd.AddParam(dl_comm.rec.CommDate);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    REPO_WithNotRepCoup[REPO_WithNotRepCoup.size] = REPOWithNotRepaymentCoup(SC_REPORTKIND_REPOWTHREPCOUP, DataSet.FI_Code, DataSet.Name, DataSet.DealCode, DataSet.Number, DataSet.DrawingDate);
  end;
  
  DL_SaveDataForReport_XML(dl_comm.rec.DocumentID, dl_comm.rec.DocKind, REPO_WithNotRepCoup, LOG_TYPE_DATA);

  return RetVal;
end;

private macro è‡Æ¢•‡®‚Ïé°‡†°Æ‚™„Åìß†í•™„È„ÓÑ†‚„(dl_comm:variant)
  var query, cmd, DataSet;
  var cnt = 0;
 
  cmd = DL_RSDCommand();
  
  query =   " select DealNumber, Type, TemplNum "
          + "   from( ";

  if(dl_comm.rec.FlagSecur == SET_CHAR)
    query = query  
            + "        (select tk.t_DealCode DealNumber, 1 as Type, grdeal.t_TemplNum TemplNum "
            + "           from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, dfininstr_dbt fin, ddlgracc_dbt gracc_bo "
            + "          where grdeal.t_PlanDate = ? "
            + "            and grdeal.t_TemplNum NOT IN ("+CCTemplsStr+")"
            + "            and gracc.t_GrDealID = grdeal.t_ID "
            + "            and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
            + "            and gracc.t_State = " + DLGRACC_STATE_PLAN
            + "            and tk.t_DealID = grdeal.t_DocID "
            + "            and tk.t_BOfficeKind = grdeal.t_DocKind "
            + "            and tk.t_BOfficeKind IN ("+DL_SECURITYDOC+","+DL_RETIREMENT+","+DL_AVRWRT+") "
            + "            and tk.t_Department = ? "
            + "            and gracc_bo.t_GrDealID = grdeal.t_ID "
            + "            and gracc_bo.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
            + "            and gracc_bo.t_State IN (" + DLGRACC_STATE_NOTNEED + ", "+DLGRACC_STATE_FACTEXEC+") "        
            + "            and fin.t_FIID = grdeal.t_FIID ";

    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);

    if(dl_comm.rec.ClientID > -1)
      if( (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank}) )
        query = query + " and tk.t_ClientID = ? ";
        cmd.AddParam(-1);
      else
        query = query + " and tk.t_ClientID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
        cmd.AddParam(dl_comm.rec.ClientID);
        query = query + " and tk.t_ClientID <> ? ";
        cmd.AddParam(-1);
      end;
    else
      query = query + " and tk.t_ClientID <> ? ";
      cmd.AddParam(-1);
    end;

    if(dl_comm.rec.ContractID > 0)
      query = query + " and tk.t_ClientContrID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.ContractID);
    end;

    if(dl_comm.rec.AvoirKind > 0)
      query = query + " AND 1 "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", ?, fin.t_AvoirKind) ";
      cmd.AddParam(dl_comm.rec.AvoirKind); 
    end;

    if(dl_comm.rec.FIID > -1)
      query = query + " AND fin.t_FIID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.FIID);
    end;

    if(dl_comm.rec.Currency > -1)
      query = query + " AND fin.t_FaceValueFI "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.Currency);
    end;

    if(dl_comm.rec.OperSubKind > 0)
      query = query + " and tk.t_DealType = ? ";
      cmd.AddParam(dl_comm.rec.OperSubKind);
    end;

    if((dl_comm.rec.ContractKind > 0) and (dl_comm.rec.OperSubKind <= 0))
      if(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_EXCHANGE)
        query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 1 ";
      elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OUTEXCHANGE)
        query = query + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 1 ";
      elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OTHER)
        query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 "
                      + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 ";
      end;
    end;


    query = query 
            + "          group by tk.t_DealCode, grdeal.t_TemplNum "
            + "        ) UNION ALL "
            + "        (select tk.t_DealCode DealNumber, 1 as Type, grdeal.t_TemplNum TemplNum "
            + "           from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, dfininstr_dbt fin, ddlgracc_dbt gracc_bo "
            + "          where grdeal.t_PlanDate = ? "
            + "            and grdeal.t_TemplNum IN ("+CCTemplsStr+")"
            + "            and gracc.t_GrDealID = grdeal.t_ID "
            + "            and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
            + "            and gracc.t_State = " + DLGRACC_STATE_PLAN
            + "            and tk.t_DealID = grdeal.t_DocID "
            + "            and tk.t_BOfficeKind = grdeal.t_DocKind "
            + "            and tk.t_BOfficeKind = "+DL_SECURITYDOC
            + "            and tk.t_IsPartyClient = 'X' "
            + "            and tk.t_Department = ? "
            + "            and gracc_bo.t_GrDealID = grdeal.t_ID "
            + "            and gracc_bo.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
            + "            and gracc_bo.t_State IN (" + DLGRACC_STATE_NOTNEED + ", "+DLGRACC_STATE_FACTEXEC+") "                                                                                                                                
            + "            and fin.t_FIID = grdeal.t_FIID ";

    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);

    if(dl_comm.rec.ClientID > -1)
      if( (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank}) )
        query = query + " and tk.t_PartyID = ? ";
        cmd.AddParam(-1);
      else
        query = query + " and tk.t_PartyID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
        cmd.AddParam(dl_comm.rec.ClientID);
        query = query + " and tk.t_PartyID <> ? ";
        cmd.AddParam(-1);
      end;
    else
      query = query + " and tk.t_PartyID <> ? ";
      cmd.AddParam(-1);
    end;

    if(dl_comm.rec.ContractID > 0)
      query = query + " and tk.t_PartyContrID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.ContractID);
    end;

    if(dl_comm.rec.AvoirKind > 0)
      query = query + " AND 1 "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", ?, fin.t_AvoirKind) ";
      cmd.AddParam(dl_comm.rec.AvoirKind); 
    end;

    if(dl_comm.rec.FIID > -1)
      query = query + " AND fin.t_FIID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.FIID);
    end;

    if(dl_comm.rec.Currency > -1)
      query = query + " AND fin.t_FaceValueFI "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.Currency);
    end;

    if(dl_comm.rec.OperSubKind > 0)
      query = query + " and tk.t_DealType = ? ";
      cmd.AddParam(dl_comm.rec.OperSubKind);
    end;

    if((dl_comm.rec.ContractKind > 0) and (dl_comm.rec.OperSubKind <= 0))
      if(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_EXCHANGE)
        query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 1 ";
      elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OUTEXCHANGE)
        query = query + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 1 ";
      elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OTHER)
        query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 "
                      + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 ";
      end;
    end;

    query = query + "          group by tk.t_DealCode, grdeal.t_TemplNum "
                  + "        ) ";


    if(dl_comm.rec.Flag2 == SET_CHAR) //≠•‚‚®≠£

       query = query + " UNION ALL "
                     + " (select ntg.t_DealNumber DealNumber, 2 as Type, grdeal.t_TemplNum TemplNum "
                     + "    from ddl_nett_dbt ntg, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, ddlgracc_dbt gracc_bo"
                     + "   where grdeal.t_PlanDate = ? "
                     + "     and ntg.t_DocKind = grdeal.t_DocKind "
                     + "     and ntg.t_NettingID = grdeal.t_DocID "
                     + "     and ntg.t_Department = ? "
                     + "     and gracc.t_GrDealID = grdeal.t_ID "
                     + "     and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                     + "     and gracc.t_State = " + DLGRACC_STATE_PLAN
                     + "            and gracc_bo.t_GrDealID = grdeal.t_ID "
                     + "            and gracc_bo.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
                     + "            and gracc_bo.t_State IN (" + DLGRACC_STATE_NOTNEED + ", "+DLGRACC_STATE_FACTEXEC+") ";        
           
       cmd.AddParam(dl_comm.rec.CommDate);
       cmd.AddParam(dl_comm.rec.Division);

       if( dl_comm.rec.ClientID > -1 )
          if( (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank}) )
             query = query + " and ntg.t_ClientId = ? ";
             cmd.AddParam(-1);
          else
             query = query + " and ntg.t_ClientId "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
           cmd.AddParam(dl_comm.rec.ClientID);
             query = query + " and ntg.t_ClientId <> ? ";
             cmd.AddParam(-1);
       end;
       else
          query = query + " and ntg.t_ClientId <> ? ";
          cmd.AddParam(-1);
       end;

       if(dl_comm.rec.ContractID > 0)
         query = query + " and ntg.t_ClientContrID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
         cmd.AddParam(dl_comm.rec.ContractID);
       end;

       query = query + "   group by ntg.t_DealNumber, grdeal.t_TemplNum "
                     + " ) ";

    end;

    if(dl_comm.rec.Flag3 == SET_CHAR) //™´®•≠‚·™®• ™Æ¨®··®®
      query = query + " UNION ALL "
                    + " (select contr.t_Number DealNumber, 3 as Type, grdeal.t_TemplNum TemplNum"
                    + "    from dsfcontr_dbt contr, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
                    + "   where grdeal.t_PlanDate = ? "
                    + "     and grdeal.t_DocKind = " + OBJTYPE_SFCONTR
                    + "     and contr.t_ID = grdeal.t_DocID "
                    + "     and contr.t_Department = ? "
                    + "     and grdeal.t_TemplNum = " + DLGR_TEMPL_PAYCOM
                    + "     and gracc.t_GrDealID = grdeal.t_ID "
                    + "     and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                    + "     and gracc.t_State = " + DLGRACC_STATE_PLAN;

      cmd.AddParam(dl_comm.rec.CommDate);
      cmd.AddParam(dl_comm.rec.Division);

      if(dl_comm.rec.ClientID > -1)
        query = query + " and contr.t_PartyID "+IIF(((dl_comm.rec.Flag1 == SET_CHAR) and (dl_comm.rec.Flag5 != SET_CHAR)), "<>", "=")+" ? ";
        cmd.AddParam(dl_comm.rec.ClientID);
      else
        query = query + " and contr.t_PartyID <> ? ";
        cmd.AddParam({OurBank}); 
      end;

      if(dl_comm.rec.ContractID > 0)
        query = query + " and contr.t_ID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
        cmd.AddParam(dl_comm.rec.ContractID);
      end;

      query = query + "   group by contr.t_Number, grdeal.t_TemplNum "
                    + " ) ";
    end;

  end;

  if(dl_comm.rec.FlagSecurOwn == SET_CHAR)
    if(dl_comm.rec.FlagSecur == SET_CHAR)        
      query = query + "      UNION ALL ";
    end;

    query = query + "(select tk.t_DealCode DealNumber, 1 as Type, grdeal.t_TemplNum TemplNum "
                  + "   from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, dfininstr_dbt fin, ddlgracc_dbt gracc_bo "
                  + "  where grdeal.t_PlanDate = ? "
                  + "    and grdeal.t_TemplNum NOT IN ("+CCTemplsStr+")"
                  + "    and gracc.t_GrDealID = grdeal.t_ID "
                  + "    and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                  + "    and gracc.t_State = " + DLGRACC_STATE_PLAN
                  + "    and tk.t_DealID = grdeal.t_DocID "
                  + "    and tk.t_BOfficeKind = grdeal.t_DocKind "
                  + "    and tk.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+","+DL_RETIREMENT_OWN+") "
                  + "    and tk.t_Department = ? "
                  + "    and gracc_bo.t_GrDealID = grdeal.t_ID "
                  + "    and gracc_bo.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
                  + "    and gracc_bo.t_State IN (" + DLGRACC_STATE_NOTNEED + ", "+DLGRACC_STATE_FACTEXEC+") "        
                  + "    and fin.t_FIID = grdeal.t_FIID ";

    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);

    if(dl_comm.rec.ClientID > -1)
      if( (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank}) )
        query = query + " and tk.t_ClientID = ? ";
        cmd.AddParam(-1);
      else
        query = query + " and tk.t_ClientID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
        cmd.AddParam(dl_comm.rec.ClientID);
        query = query + " and tk.t_ClientID <> ? ";
        cmd.AddParam(-1);
      end;
    else
      query = query + " and tk.t_ClientID <> ? ";
      cmd.AddParam(-1);
    end;

    if(dl_comm.rec.ContractID > 0)
      query = query + " and tk.t_ClientContrID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.ContractID);
    end;

    if(dl_comm.rec.AvoirKind > 0)
      query = query + " AND 1 "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", ?, fin.t_AvoirKind) ";
      cmd.AddParam(dl_comm.rec.AvoirKind); 
    end;

    if(dl_comm.rec.FIID > -1)
      query = query + " AND fin.t_FIID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.FIID);
    end;

    if(dl_comm.rec.Currency > -1)
      query = query + " AND fin.t_FaceValueFI "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.Currency);
    end;

    if(dl_comm.rec.OperSubKind > 0)
      query = query + " and tk.t_DealType = ? ";
      cmd.AddParam(dl_comm.rec.OperSubKind);
    end;

    if((dl_comm.rec.ContractKind > 0) and (dl_comm.rec.OperSubKind <= 0))
      if(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_EXCHANGE)
        query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 1 ";
      elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OUTEXCHANGE)
        query = query + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 1 ";
      elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OTHER)
        query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 "
                      + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tk.t_DealType, tk.t_BofficeKind))) = 0 ";
      end;
    end;

    query = query + "   group by tk.t_DealCode, grdeal.t_TemplNum "
                  + " ) ";

  end;

  query = query + "       ) "
          + " group by DealNumber, Type, TemplNum "
          + " order by DealNumber, Type, TemplNum";
  

  DataSet = cmd.Execute(query);
  var errStr = "";
  while(DataSet.moveNext())
    errStr = "";
    if(DataSet.Type == 1)
      errStr = "èÆ ·§•´™• "+DataSet.DealNumber+" Æ·‚†´®·Ï ≠•Æ°‡†°Æ‚†≠≠Î• ·‚‡Æ™®" + " (" + à¨Ôç•Æ°‡†°Æ‚†≠≠Æ©ë‚‡Æ™®É‡†‰®™†(DataSet.TemplNum)  + ") " + "£‡†‰®™† ß† §†‚„ " + string(date(dl_comm.rec.CommDate):f);
    elif(DataSet.Type == 2)
      errStr = "èÆ ÆØ•‡†Ê®® ≠•‚‚®≠£† "+DataSet.DealNumber+" Æ·‚†´®·Ï ≠•Æ°‡†°Æ‚†≠≠Î• ·‚‡Æ™®" + " (" + à¨Ôç•Æ°‡†°Æ‚†≠≠Æ©ë‚‡Æ™®É‡†‰®™†(DataSet.TemplNum)  + ") " + "£‡†‰®™† ß† §†‚„ " + string(date(dl_comm.rec.CommDate):f);
    elif(DataSet.Type == 3)
      errStr = "èÆ §Æ£Æ¢Æ‡„ Æ°·´„¶®¢†≠®Ô "+DataSet.DealNumber+" Æ·‚†´®·Ï ≠•Æ°‡†°Æ‚†≠≠Î• ·‚‡Æ™®" + " (" + à¨Ôç•Æ°‡†°Æ‚†≠≠Æ©ë‚‡Æ™®É‡†‰®™†(DataSet.TemplNum)  + ") " + "£‡†‰®™† ß† §†‚„ " + string(date(dl_comm.rec.CommDate):f);
    end;
    if(errStr != "")
      RepErrArr[RepErrArr.size] = CSC_AccountingRepErr(DataSet.DealNumber, 1, errStr);
    end;
  end;

  return 0;
end;

private macro è‡Æ¢•‡®‚Ïä‡†·≠Æ•ë†´Ï§Æ(dl_comm, accList)
  for (var curAc, accList)
    var query, cmd, DataSet;
    var cnt = 0;
    
    cmd = DL_RSDCommand();
    
    query = 
      " SELECT rsi_rsb_account.restac (ac.T_ACCOUNT, "
     +"                                ac.T_CODE_CURRENCY, "
     +"                                ?, "
     +"                                ac.t_CHAPTER, "
     +"                                NULL) "
     +"           AS t_rest, "
     +"        ac.* "
     +"   FROM DACCOUNT_DBT ac "
     +"  WHERE ac.T_ACCOUNTID = ? ";

    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(curAc);

    DataSet = cmd.Execute(query);
    var errStr = "";
    if(DataSet.moveNext())
      errStr = "";
      if (((DataSet.Kind_Account == "Ä") and (DataSet.Rest > $0)) or
          ((DataSet.Kind_Account == "è") and (DataSet.Rest < $0)))
        errStr = "Ç≠®¨†≠®•! èÆ ·ÁÒ‚„ "+DataSet.Account+" Æ°≠†‡„¶•≠Æ ™‡†·≠Æ• ·†´Ï§Æ";
      end;
      if(errStr != "")
        RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", 1, errStr);
      end;
    end;
  end;
end;

private macro ë‰Æ‡¨®‡Æ¢†‚Ïè‡Æ¢Æ§™®Ñ´Ôç•‚‚®≠£†(NettingID, TemplNum, CarryDate)
  var err = 0;

  if(TemplNum == DLGR_TEMPL_PAYMENT)
    err = è‡Æ¢Æ§™®èÆéØ´†‚•ç•‚‚®≠£†ÅéñÅ(NettingID);
  elif( TemplNum == DLGR_TEMPL_OVERDUEPAY )
    err = è‡Æ¢Æ§™®èÆè‡Æ·‡ÆÁ™®ç•‚‚®≠£†ÅéñÅ(NettingID);
  end;

  return err;
end;

macro ThisAccounting_msgbox(StrErr)
  RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", 1, StrSubSt(StrErr,"|"," ") );
end;

private macro Åì_é°‡†°Æ‚†‚Ïç•‚‚®≠£(dl_comm)
  var query, cmd, DataSet;
  var CntNgtGr = 0, i = 0, err = 0;
                                                 
  query =   " select ntg.t_NettingID, ntg.t_DealNumber, grdeal.t_TemplNum, grdeal.t_PlanDate, gracc.t_GrDealID, templ.t_Name as TemplName "
          + "   from ddl_nett_dbt ntg, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, ddlgrtempl_dbt templ "
          + "  where grdeal.t_PlanDate = ? "
          + "    and grdeal.t_DocKind = ntg.t_DocKind "
          + "    and grdeal.t_DocID = ntg.t_NettingID "
          + "    and ntg.t_Department = ? "
          + "    and gracc.t_GrDealID = grdeal.t_ID "
          + "    and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
          + "    and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "    and not Exists( select 1 "
          + "                      from ddlgracc_dbt gracc2 "
          + "                     where gracc2.t_GrDealID = grdeal.t_ID "
          + "                       and gracc.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
          + "                       and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "                  ) "
          + "    and templ.t_Num = grdeal.t_TemplNum";

  if( dl_comm.rec.ClientID > -1 )
     if( (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank}) )
        query = query + " and ntg.t_ClientId = ? ";
     else
        query = query + " and ntg.t_ClientId "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
        query = query + " and ntg.t_ClientId <> ? ";
     end;
  else
     query = query + " and ntg.t_ClientId <> ? ";
  end;

  if(dl_comm.rec.ContractID > 0)
    query = query + " and ntg.t_ClientContrID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
  end;   

  query = query + "  order by ntg.t_DealNumber ";


  cmd = DL_RSDCommand(query);

  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.Division);

  if( (dl_comm.rec.ClientID < 0) or (dl_comm.rec.ClientID == {OurBank}) )
      cmd.AddParam(-1);
    else
      cmd.AddParam(dl_comm.rec.ClientID);
     cmd.AddParam(-1);
    end;

  if(dl_comm.rec.ContractID > 0)
    cmd.AddParam(dl_comm.rec.ContractID);
  end;   

  CntNgtGr = cmd.GetCount();

  if(CntNgtGr > 0)

    InitProgress( CntNgtGr, "îÆ‡¨®‡Æ¢†≠®• Ø‡Æ¢Æ§Æ™ ØÆ ÆØ•‡†Ê®Ô¨ ç•‚‚®≠£†", "îÆ‡¨®‡Æ¢†≠®• Ø‡Æ¢Æ§Æ™ ØÆ ÆØ•‡†Ê®Ô¨ ç•‚‚®≠£†" );

    è‡Æ¢Æ§™®Åì = SecurAccountingCarry(dl_comm.rec.DocKind, dl_comm.rec.DocumentID);

    DataSet = cmd.Execute();

    while((not err) and (DataSet.moveNext()))

      è‡Æ¢Æ§™®Åì.SetGrDealData(DataSet.GrDealID, 0, -1, DLGR_SOURCETYPE_NETTING);
      err = ë‰Æ‡¨®‡Æ¢†‚Ïè‡Æ¢Æ§™®Ñ´Ôç•‚‚®≠£†(DataSet.NettingID, DataSet.TemplNum, date(DataSet.PlanDate));

      if(err)
        var bankMsg:RSBankMsg = AL_GetErrorInfo();
        var errMes:string = "éË®°™† Ø‡® Æ°‡†°Æ‚™• ·‚‡Æ™® £‡†‰®™† \""+DataSet.TemplName+"\" ØÆ ·§•´™• ≠•‚‚®≠£†";
        var errCode:integer = 1;

        if (bankMsg.Stat != 0)
          errCode = bankMsg.Stat;
          errMes  = errMes + ". "+ bankMsg.Message;
        end;
        
        RepErrArr[RepErrArr.size] = CSC_AccountingRepErr(DataSet.DealNumber, errCode, errMes);
      end;

      UseProgress(i = i + 1);
    end;

    RemProgress();

    if(not err)

      RslDefCon.BeginTrans();

      err = è‡Æ¢Æ§™®Åì.Execute(RepErrArr);

      if(not err) 
        var sql, exec;

        //àß¨•≠Ô•¨ ·‚†‚„· ¢®§† „Á•‚† Åì
        sql =  "DECLARE "
             + "BEGIN "
             + "  FOR one_grdoc IN (SELECT DISTINCT GRDOC.T_GRDEALID "
             + "                      FROM DDLGRDOC_DBT GRDOC, DDLGRDEAL_DBT GRDEAL "
             + "                     WHERE GRDOC.T_DOCKIND = 0 "
             + "                       AND GRDOC.T_DOCID = 0 "
             + "                       AND GRDOC.T_SERVDOCKIND = ? "
             + "                       AND GRDOC.T_SERVDOCID = ? "
             + "                       AND GRDOC.T_GRPID = 0 "
             + "                       AND GRDEAL.T_ID = GRDOC.T_GRDEALID "
             + "                       AND GRDEAL.T_DOCKIND = " + DL_NTGSEC 
             + "                   ) LOOP "
             + "    RSI_DLGR.RSI_UpdateGrDealAccByID( one_grdoc.t_GRDEALID, "+DLGR_ACCKIND_ACCOUNTING+", "+DLGRACC_STATE_FACTEXEC+", NULL, 0); "
             + "  END LOOP; "
             + "  RSI_DLGR.RSI_ExecCommitDLGR; "
             + "END; ";
         
        exec = RSDCommand(sql);

        exec.addParam( "", RSDBP_IN, dl_comm.rec.DocKind );
        exec.addParam( "", RSDBP_IN, dl_comm.rec.DocumentID );
        exec.execute();
      end;

      if(err)
        RslDefCon.RollbackTrans(); //é‚™†‚®‚Ï ‚‡†≠ß†™Ê®Ó
      else
        RslDefCon.CommitTrans(); //á†¢•‡Ë®‚Ï ‚‡†≠ß†™Ê®Ó
      end;
    end;

  end;
  OnError(er)
    var err_text = GetFullErrorMessage(er);
    if(isEqClass("TRsdError", er.err))
      MsgBox(err_text);
      RunError(err_text);
    end;
end;

private macro Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚Îä„ØÆ≠Æ¢(dl_comm)
  var query, cmd, DataSet;
  var ä_ØÆ·‚, ä_¢_≠†´®Á®®, ä_ØÆ£†Ë, ä_Æ°‡†°Æ‚, S, vDate = Date(0,0,0);
  var ä_·Æ°_‡†ß¨•È, ä_·Æ°_Æ°‡†°Æ‚;
  var queryNullCoup, cmdNullCoup, DSNullCoup;

  AccLogPackID = 0;
  AddScAccLogInfo(dl_comm, "ç†Á†´Æ ‡†°Æ‚Î ‰-Ê®® Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚Îä„ØÆ≠Æ¢");

  query =   " with q as (select distinct fin.t_FIID "
          + "              from dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi, dfininstr_dbt fin "
          + "             where grp.t_DocKind    = ? "
          + "               and grp.t_DocID      = ? "
          + "               and grp.t_Department = ? "
          + "               and grpfi.t_GrpID    = grp.t_ID "
          + "               and fin.t_FIID       = grpfi.t_FIID "
          + "               and RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, "+AVOIRISSKIND_BOND+", fin.t_AvoirKind) = 1 "
          + "           ) "
          + " select distinct f.*, RSI_RSB_FIInstr.FI_GetNominalDrawingDate(q.T_FIID, (select t_Termless from davoiriss_dbt where t_FIID = q.T_FIID)) FiidDrawingDate, "
          + "        ("
          + "           case when not exists( "
          + "                                  select 1 "
          + "                                  from dfiwarnts_dbt fiwarnts"
          + "                                  where fiwarnts.t_FIID = q.t_FIID"
          + "                                    and fiwarnts.t_IsPartial <> 'X'"
          + "                                    and fiwarnts.t_DrawingDate > ?"
          + "                                    and ("
          + "                                           fiwarnts.t_IncomeRate <> 0"
          + "                                           or fiwarnts.t_IncomeVolume <> 0"
          + "                                        )"
          + "                               ) "
          + "                     and exists("
          + "                                  select 1 "
          + "                                  from dfiwarnts_dbt fiwarnts "
          + "                                  where fiwarnts.t_FIID = q.t_FIID "
          + "                                    and fiwarnts.t_IsPartial <> 'X'"
          + "                                    and fiwarnts.t_DrawingDate > ?"
          + "                                    and fiwarnts.t_IncomeRate = 0"
          + "                                    and fiwarnts.t_IncomeVolume = 0"
          + "                               )"
          + "                    and Exists(select 1 "
          + "                                 from ddlgrdoc_dbt grd, ddlgrdeal_dbt grdeal, ddl_tick_dbt tk "
          + "                                where grd.t_ServDocKind = ? "
          + "                                  and grd.t_ServDocID   = ? "
          + "                                  and grd.t_DocKind     = 0 "
          + "                                  and grdeal.t_ID = grd.t_GrDealID "
          + "                                  and grdeal.t_DocKind IN (" + DL_RETIREMENT+ ","+DL_RETIREMENT_OWN+") "
          + "                                  and tk.t_DealID = grdeal.t_DocID "
          + "                                  and tk.t_PFI          = q.t_FIID "
          + "                                  and RSB_SECUR.IsRet_Issue( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tk.t_DealType, tk.t_BofficeKind ) ) ) > 0 "
          + "                              ) "
          + "                then 1"
          + "                else 0"
          + "           end"
          + "        ) as t_IsPreDrawing "
          + "   from q, dfiwarnts_dbt f "
          + "  where f.t_FIID        = q.t_FIID "
          + "    and f.t_IsPartial = CHR(0) "
          + "    and f.t_SPIsClosed = CHR(0) "
          + "    and f.t_DrawingDate <= ? "
          + "    and not Exists (select 1 "
          + "                      from ddl_tick_dbt tk, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal "
          + "                     where tk.t_BOfficeKind IN (" + DL_RETIREMENT+ ","+DL_RETIREMENT_OWN+") "
          + "                       and tk.t_PFI           = q.t_FIID "
          + "                       and tk.t_Number_Coupon = f.t_Number "
          + "                       and grdeal.t_DocKind = tk.t_BOfficeKind "
          + "                       and grdeal.t_DocID = tk.t_DealID "
          + "                       AND grdeal.t_templnum != 15 " /*à·™´ÓÁ®‚Ï ÆØ´†‚„( ‚†™ ™†™ ß†™‡Î‚Ï ≠„¶≠Æ ·‡†ß„ Ø‡® ·Ø®·†≠®® · ´Æ‚Æ¢)*/
          + "                       and gracc.t_GrDealID = grdeal.t_ID "
          + "                       and gracc.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
          + "                       and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "                   ) "
          + IIF(((dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank})), "",
            "    and not Exists (select 1 "
          + "                      from ddl_tick_dbt tk, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal "
          + "                     where tk.t_BOfficeKind IN (" + DL_RETIREMENT+ ","+DL_RETIREMENT_OWN+") "
          + "                       and tk.t_PFI           = q.t_FIID "
          + "                       and tk.t_Number_Coupon = f.t_Number "
          + "                       and tk.t_ClientID = " + UnknownParty
          + "                       and grdeal.t_DocKind = tk.t_BOfficeKind "
          + "                       and grdeal.t_DocID = tk.t_DealID "
          + "                       AND grdeal.t_templnum IN ("+DLGR_TEMPL_DELIVERY+","+DLGR_TEMPL_RECDELIVERY+") " 
          + "                       and gracc.t_GrDealID = grdeal.t_ID "
          + "                       and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
          + "                       and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "                   ) "
            )
          + IIF(((dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank})), "",
            "    and not Exists (select 1 "
          + "                      from ddl_tick_dbt tk, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal "
          + "                     where tk.t_BOfficeKind  = " + DL_SECURITYDOC
          + "                       and tk.t_PFI           = q.t_FIID "
          + "                       and tk.t_DealStatus  != " + DL_CLOSED
          + "                       and tk.t_ClientID = " + UnknownParty
          + "                       and grdeal.t_DocKind = tk.t_BOfficeKind "
          + "                       and grdeal.t_DocID = tk.t_DealID "
          + "                       and grdeal.t_PlanDate >= f.t_DrawingDate "
          + "                       AND grdeal.t_templnum IN ("+DLGR_TEMPL_DELIVERY2 + "," + DLGR_TEMPL_RECDELIVERY2 + ") " 
          + "                       and gracc.t_GrDealID = grdeal.t_ID "
          + "                       and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
          + "                       and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "                   ) "
            ) 
          + IIF((dl_comm.rec.ClientID == {OurBank}),
            "    and (( Exists (select 1 " 
          + "                   from ddl_tick_dbt tk, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal " 
          + "                  where tk.t_BOfficeKind IN (" + DL_RETIREMENT+ ","+ DL_RETIREMENT_OWN + ") " 
          + "                    and tk.t_PFI = q.t_FIID " 
          + "                    and tk.t_Number_Coupon = f.t_Number " 
          + "                    and grdeal.t_DocKind = tk.t_BOfficeKind " 
          + "                    and grdeal.t_DocID = tk.t_DealID " 
          + "                    AND grdeal.t_templnum = 17 " 
          + "                    and gracc.t_GrDealID = grdeal.t_ID " 
          + "                    and gracc.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE 
          + "                    and gracc.t_State = " + DLGRACC_STATE_FACTEXEC + " ) "
          + "            and (0 != RSB_PMWRTOFF.WRTGetPortfolioAmount(?, q.t_FIID, -1, -1, 1 /*KINDPORT_TRADE*/, -1, ?, 1, 0, 0, 0) "
          + "            or 0 != RSB_PMWRTOFF.WRTGetPortfolioAmount(?, q.t_FIID, -1, -1, 2 /*RSB_PMWRTOFF.KINDPORT_SALE*/, -1, ?, 1, 0, 0, 0) "
          + "            or 0 != RSB_PMWRTOFF.WRTGetPortfolioAmount(?, q.t_FIID, -1, -1, 5 /*RSB_PMWRTOFF.KINDPORT_RETIRE*/, -1, ?, 1, 0, 0, 0))"
          + "         ) or  (0 = RSB_PMWRTOFF.WRTGetPortfolioAmount(?, q.t_FIID, -1, -1, 1 /*KINDPORT_TRADE*/, -1, ?, 1, 0, 0, 0) "
          + "            and 0 = RSB_PMWRTOFF.WRTGetPortfolioAmount(?, q.t_FIID, -1, -1, 2 /*RSB_PMWRTOFF.KINDPORT_SALE*/, -1, ?, 1, 0, 0, 0) "
          + "            and 0 = RSB_PMWRTOFF.WRTGetPortfolioAmount(?, q.t_FIID, -1, -1, 5 /*RSB_PMWRTOFF.KINDPORT_RETIRE*/, -1, ?, 1, 0, 0, 0)))", ""
             ) 
          + "    and not Exists(select 1"
          + "                     from dpmwrtgrp_dbt grp1, dpmwrtgrpfi_dbt grpfi1 "
          + "                    where grp1.t_DocKind   = ? " 
          + "                      and grp1.t_DocID     = ? "
          + "                      and grp1.t_ErrStatus <> 0 "
          + "                      and grpfi1.t_GrpID = grp1.t_ID "
          + "                      and grpfi1.t_FIID    = q.t_FIID "
          + "                  )"
          + " order by f.t_DrawingDate";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);
  cmd.AddParam(dl_comm.rec.Division);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);
  cmd.AddParam(dl_comm.rec.CommDate);
  
 if(dl_comm.rec.ClientID == {OurBank})
    cmd.AddParam(dl_comm.rec.Division);
    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);
    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);
    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);
    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);
    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);
    cmd.AddParam(dl_comm.rec.CommDate);
  end;

  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);

  DataSet = cmd.Execute();

  while(DataSet.moveNext())
    AddScAccLogInfo(dl_comm, "é°‡†°†‚Î¢†•‚·Ô ™„ØÆ≠ " + DataSet.Number + " ØÆ °„¨†£• " + èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID));
    
    if(Ö·‚Ïç•ØÆ£†Ë•≠≠Î•ä„ØÆ≠Îóè(DataSet.FIID, date(DataSet.DrawingDate), DataSet.IsPartial))
      AddScAccLogInfo(dl_comm, "ë„È•·‚¢„•‚ ≠•ØÆ£†Ë•≠≠Î© ™„ØÆ≠ ß† °Æ´•• ‡†≠≠ÓÓ §†‚„. é°‡†°Æ‚™† Ê/° Ø‡•‡¢†≠†");
      
      MsgBox( "ë„È•·‚¢„•‚ ≠•ØÆ£†Ë•≠≠Î© ™„ØÆ≠ ØÆ °„¨†£• "+èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID)+" ß† °Æ´•• ‡†≠≠ÓÓ §†‚„" );
      continue;
    end;

    if( date(DataSet.ListDate) == date(DataSet.FiidDrawingDate) )
       vDate = date(DataSet.ListDate) - 1;/*Ç §†‚„ ØÆ£†Ë•≠®Ô °„¨†£®, °•‡Ò¨ ™Æ´®Á•·‚¢Æ ≠† Ø‡•§Î§„È„Ó §†‚„*/
    else
       vDate = date(DataSet.ListDate);
    end;

    if( vDate == date(0,0,0) )
      AddScAccLogInfo(dl_comm, "ç• ß†§†≠† §†‚† ·Æ·‚†¢´•≠®Ô Ø•‡•Á≠Ô §´Ô ™„ØÆ≠†. é°‡†°Æ‚™† Ê/° Ø‡•‡¢†≠†");

      MsgBox("ç• ß†§†≠† §†‚† ·Æ·‚†¢´•≠®Ô Ø•‡•Á≠Ô §´Ô ™„ØÆ≠† " + DataSet.Number + " °„¨†£® " + èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID));
      continue;
    end;

    ä_¢_≠†´®Á®® = WRTGetPortfolioAmount(-1, DataSet.FIID, 0, -1, -1, -1, vDate, true, false, false);/*èÆ·‚†¢´•≠≠Î•, ¢ ‚.Á. ™´®•≠‚·™®• ® èÇé.*/
    ä_Æ°‡†°Æ‚ = WRTGetAmountFromRetire(-1, DataSet.FIID, 0, -1, DataSet.Number, "", -1, 0, true);/*¢·• ·Æ°·‚¢•≠≠Î• °„¨†£® ® ™´®•≠‚·™®•*/

    ä_·Æ°_‡†ß¨•È = WRTGetAmountOwn(-1, DataSet.FIID, vDate, true, false);
    ä_·Æ°_Æ°‡†°Æ‚ = WRTGetAmountFromRetireOwn(-1, DataSet.FIID, DataSet.Number, -1, true);

    S = ä_¢_≠†´®Á®® + ä_·Æ°_‡†ß¨•È - ä_Æ°‡†°Æ‚ - ä_·Æ°_Æ°‡†°Æ‚;

    if(S < 0)
      AddScAccLogInfo(dl_comm, "S < 0");
//      MsgBox( "éË®°™† Ø‡® ‡†·Á•‚• ™Æ´®Á•·‚¢† ØÆ£†Ë•≠≠ÎÂ °„¨†£ "+èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID)+" ≠† §†‚„ ØÆ£†Ë•≠®Ô ™„ØÆ≠†" );
        á†™‡Î‚Ïä„ØÆ≠óè(DataSet.IsPartial, DataSet.FIID, DataSet.Number, SQL_ConvTypeInteger(DataSet.ID), dl_comm);
    elif(S == 0)
      AddScAccLogInfo(dl_comm, "S == 0");
      á†™‡Î‚Ïä„ØÆ≠óè(DataSet.IsPartial, DataSet.FIID, DataSet.Number, SQL_ConvTypeInteger(DataSet.ID), dl_comm);

      if(DataSet.IsPreDrawing == 1)
         queryNullCoup =   "select fiwarnts.* "
                         + "from dfiwarnts_dbt fiwarnts "
                         + "where fiwarnts.t_FIID = ? "
                         + "  and fiwarnts.t_IsPartial <> 'X'"
                         + "  and fiwarnts.t_IncomeRate  = 0"
                         + "  and fiwarnts.t_IncomeVolume = 0"
                         + "  and fiwarnts.t_DrawingDate > ?";

         cmdNullCoup = DL_RSDCommand(queryNullCoup);
         cmdNullCoup.AddParam(DataSet.FIID);
         cmdNullCoup.AddParam(dl_comm.rec.CommDate);

         DSNullCoup = cmdNullCoup.Execute();
         while(DSNullCoup.MoveNext())
            á†™‡Î‚Ïä„ØÆ≠óè(DSNullCoup.IsPartial, DSNullCoup.FIID, DSNullCoup.Number, SQL_ConvTypeInteger(DSNullCoup.ID), dl_comm);
         end;
      end;
    else
      AddScAccLogInfo(dl_comm, "S > 0");
      á†™‡Î‚Ïä„ØÆ≠óè(DataSet.IsPartial, DataSet.FIID, DataSet.Number, SQL_ConvTypeInteger(DataSet.ID), dl_comm);
    end;

  end;

  AddScAccLogInfo(dl_comm, "äÆ≠•Ê ‡†°Æ‚Î ‰-Ê®® Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚Îä„ØÆ≠Æ¢");
end;

private macro Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚Îóè(dl_comm)
  var query, cmd, DataSet;
  var ä_ØÆ·‚, ä_¢_≠†´®Á®®, ä_¢_≠†´®Á®®_èÇé, ä_¢_≠†´®Á®®_ä´, ä_ØÆ£†Ë, ä_Æ°‡†°Æ‚, S, vDate = Date(0,0,0);

  query =   " select distinct f.*, fin.t_DrawingDate FiidDrawingDate "
          + "   from dfiwarnts_dbt f, dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi, dfininstr_dbt fin "
          + "  where grp.t_DocKind = ? "
          + "    and grp.t_DocID = ? "
          + "    and grp.t_Department = ? "
          + "    and grpfi.t_GrpID = grp.t_ID "
          + "    and f.t_FIID = grpfi.t_FIID "
          + "    and f.t_IsPartial = 'X' "
          + "    and f.t_SPIsClosed = CHR(0) "
          + "    and f.t_DrawingDate <= ? "
          + "    and not Exists (select 1 "
          + "                      from ddl_tick_dbt tk, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal "
          + "                     where tk.t_BOfficeKind = " + DL_RETIREMENT
          + "                       and tk.t_PFI = f.t_FIID "
          + "                       and tk.t_Number_Partly = f.t_Number "
          + "                       and grdeal.t_DocKind = tk.t_BOfficeKind "
          + "                       and grdeal.t_DocID = tk.t_DealID "
          + "                       and gracc.t_GrDealID = grdeal.t_ID "
          + "                       and gracc.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
          + "                       and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "                   ) "
          + "    and fin.t_FIID = f.t_FIID "
          + "    and not Exists(select 1"
          + "                     from dpmwrtgrp_dbt grp1, dpmwrtgrpfi_dbt grpfi1 "
          + "                    where grp1.t_DocKind = grp.t_DocKind " 
          + "                      and grp1.t_DocID = grp.t_DocID "
          + "                      and grp1.t_ErrStatus <> 0 "
          + "                      and grpfi1.t_GrpID = grp1.t_ID "
          + "                      and grpfi1.t_FIID = fin.t_FIID "
          + "                  )"
          + " order by f.t_DrawingDate";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);
  cmd.AddParam(dl_comm.rec.Division);
  cmd.AddParam(dl_comm.rec.CommDate);

  DataSet = cmd.Execute();

  while(DataSet.moveNext())
    if(Ö·‚Ïç•ØÆ£†Ë•≠≠Î•ä„ØÆ≠Îóè(DataSet.FIID, date(DataSet.DrawingDate), DataSet.IsPartial))
      MsgBox(  "ë„È•·‚¢„•‚ ≠•ØÆ£†Ë•≠≠Æ• Á†·‚®Á≠Æ• ØÆ£†Ë•≠®• ØÆ °„¨†£• "+èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID)+" ß† °Æ´•• ‡†≠≠ÓÓ §†‚„");
      continue;
    end;

    if( date(DataSet.ListDate) == date(DataSet.FiidDrawingDate) )
       vDate = date(DataSet.ListDate) - 1;/*Ç §†‚„ ØÆ£†Ë•≠®Ô °„¨†£®, °•‡Ò¨ ™Æ´®Á•·‚¢Æ ≠† Ø‡•§Î§„È„Ó §†‚„*/
    else
       vDate = date(DataSet.ListDate);
    end;

    if( vDate == date(0,0,0) )
      MsgBox("ç• ß†§†≠† §†‚† ·Æ·‚†¢´•≠®Ô Ø•‡•Á≠Ô §´Ô óè " + DataSet.Number + " °„¨†£® " + èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID));
      continue;
    end;

    ä_¢_≠†´®Á®® =     WRTGetPortfolioAmount(-1, DataSet.FIID, 0, -1, -1, -1, vDate, true, false, false); // èÆ·‚†¢´•≠≠Î•, ¢ ‚.Á. ™´®•≠‚·™®• ® èÇé.
    ä_¢_≠†´®Á®®_èÇé = WRTGetPortfolioAmount(-1, DataSet.FIID, 0, -1,  6, -1, vDate, true, false, false); // èÇé
    ä_¢_≠†´®Á®®_ä´ =  WRTGetPortfolioAmount(-1, DataSet.FIID, 0, -1,  0, -1, vDate, true, false, false); // ä´®•≠‚·™®•
    ä_Æ°‡†°Æ‚ = WRTGetAmountFromRetire(-1, DataSet.FIID, 0, -1, "", DataSet.Number, -1);/*¢·• ·Æ°·‚¢•≠≠Î• °„¨†£® ® ™´®•≠‚·™®•*/

    if (((ä_¢_≠†´®Á®® - ä_¢_≠†´®Á®®_èÇé - ä_¢_≠†´®Á®®_ä´) > 0) and (ä_Æ°‡†°Æ‚ == 0))
      MsgBox("ç• ≠†©§•≠† ·•‡¢®·≠†Ô ÆØ•‡†Ê®Ô ØÆ ¢ÎØ„·™„ " + èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID) + " §´Ô Á†·‚®Á≠Æ£Æ ØÆ£†Ë•≠®Ô ≠Æ¨•‡ " + DataSet.Number + " ß† §†‚„ " + DataSet.DrawingDate);
      continue;
    end;

    S = ä_¢_≠†´®Á®® - ä_Æ°‡†°Æ‚;

    if(S < 0)
      MsgBox( "éË®°™† Ø‡® ‡†·Á•‚• ™Æ´®Á•·‚¢† ØÆ£†Ë•≠≠ÎÂ °„¨†£ "+èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID)+" ≠† §†‚„ óè");
      á†™‡Î‚Ïä„ØÆ≠óè(DataSet.IsPartial, DataSet.FIID, DataSet.Number, SQL_ConvTypeInteger(DataSet.ID), dl_comm);
    elif(S == 0)
      á†™‡Î‚Ïä„ØÆ≠óè(DataSet.IsPartial, DataSet.FIID, DataSet.Number, SQL_ConvTypeInteger(DataSet.ID), dl_comm);
    else
      á†™‡Î‚Ïä„ØÆ≠óè(DataSet.IsPartial, DataSet.FIID, DataSet.Number, SQL_ConvTypeInteger(DataSet.ID), dl_comm);
    end;

  end;
end;

private macro Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚ÎñÅ(dl_comm)
  var query, cmd, DataSet;
  var ä_¢_≠†´®Á®®, ä_Æ°‡†°Æ‚, S;
  var ä_·Æ°_‡†ß¨•È, ä_·Æ°_Æ°‡†°Æ‚;

  query =   " with f as (select distinct grpfi.t_FIID "
          + "              from dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi "
          + "             where grp.t_DocKind = ? "
          + "               and grp.t_DocID = ? "
          + "               and grp.t_Department = ? "
          + "               and grpfi.t_GrpID = grp.t_ID "
          + "               and Exists(select 1 "
          + "                            from ddlgrdoc_dbt grd, ddlgrdeal_dbt grdeal, ddl_tick_dbt tk "
          + "                           where grd.t_ServDocKind = grp.t_DocKind "
          + "                             and grd.t_ServDocID = grp.t_DocID "
          + "                             and grd.t_GrpID = grp.t_ID "
          + "                             and grdeal.t_ID = grd.t_GrDealID "
          + "                             and grdeal.t_DocKind IN (" + DL_RETIREMENT+ ","+DL_RETIREMENT_OWN+") "
          + "                             and tk.t_DealID = grdeal.t_DocID "
          + "                             and tk.t_PFI = grpfi.t_FIID "
          + "                             and RSB_SECUR.IsRet_Issue( RSB_SECUR.get_OperationGroup( RSB_SECUR.get_OperSysTypes( tk.t_DealType, tk.t_BofficeKind ) ) ) > 0 "
          + "                         ) "
          + "               and not Exists (select 1 "
          + "                                 from ddl_tick_dbt tk, ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal, doprkoper_dbt opr "
          + "                                where tk.t_BOfficeKind IN (" + DL_RETIREMENT+ ","+DL_RETIREMENT_OWN+") "
          + "                                  and tk.t_PFI = grpfi.t_FIID "
          + "                                  and opr.t_Kind_Operation = tk.t_DealType "
          + "                                  and opr.t_DocKind = tk.t_BOfficeKind "
          + "                                  and RSB_SECUR.IsRet_Issue(RSB_SECUR.get_OperationGroup(opr.t_SysTypes)) = 1 "
          + "                                  and grdeal.t_DocKind = tk.t_BOfficeKind "
          + "                                  and grdeal.t_DocID = tk.t_DealID "
          + "                                  and gracc.t_GrDealID = grdeal.t_ID "
          + "                                  and gracc.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
          + "                                  and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "                              ) "
          + "               and not Exists(select 1"
          + "                                from dpmwrtgrp_dbt grp1, dpmwrtgrpfi_dbt grpfi1 "
          + "                               where grp1.t_DocKind = grp.t_DocKind "
          + "                                 and grp1.t_DocID = grp.t_DocID "
          + "                                 and grp1.t_ErrStatus <> 0 "
          + "                                 and grpfi1.t_GrpID = grp1.t_ID "
          + "                                 and grpfi1.t_FIID = grpfi.t_FIID "
          + "                             )"
          + "           ) "
          + " select fin.t_FIID, fin.t_FI_Code, "
          + "        ( "
          + "           case when not exists( "
          + "                                  select 1 "
          + "                                  from dfiwarnts_dbt fiwarnts "
          + "                                  where fiwarnts.t_FIID = fin.t_FIID "
          + "                                    and fiwarnts.t_IsPartial <> 'X' "
          + "                                    and fiwarnts.t_DrawingDate > ? "
          + "                                    and ( "
          + "                                           fiwarnts.t_IncomeRate <> 0 "
          + "                                           or fiwarnts.t_IncomeVolume <> 0 "
          + "                                        ) "
          + "                               ) "
          + "                     and exists( "
          + "                                  select 1 "
          + "                                  from dfiwarnts_dbt fiwarnts "
          + "                                  where fiwarnts.t_FIID = fin.t_FIID "
          + "                                    and fiwarnts.t_IsPartial <> 'X' "
          + "                                    and fiwarnts.t_DrawingDate > ? "
          + "                                    and fiwarnts.t_IncomeRate = 0 "
          + "                                    and fiwarnts.t_IncomeVolume = 0"
          + "                               )"
          + "                then ( "
          + "                        select NVL(MAX(fiwarnts.t_DrawingDate), to_date('01.01.0001', 'dd.mm.yyyy')) "
          + "                        from dfiwarnts_dbt fiwarnts "
          + "                        where fiwarnts.t_FIID = fin.t_FIID "
          + "                          and fiwarnts.t_IsPartial <> 'X' "
          + "                          and ( "
          + "                                 fiwarnts.t_IncomeRate <> 0 "
          + "                                 or fiwarnts.t_IncomeVolume <> 0 "
          + "                              ) "
          + "                     ) "
          + "                when avr.t_Termless = CHR(0) and fin.t_ParentFI <= 0 and fin.t_DrawingDate > "+GetSQLDate(date(0,0,0))+" then least(fin.t_DrawingDate, ?) "
          + "                else RSI_RSB_FIInstr.FI_GetNominalDrawingDate(fin.T_FIID, avr.t_Termless) "
          + "           end"
          + "        ) DrawingDate, "
          + "        ( "
          + "           case when not exists( "
          + "                                  select 1 "
          + "                                  from dfiwarnts_dbt fiwarnts "
          + "                                  where fiwarnts.t_FIID = fin.t_FIID "
          + "                                    and fiwarnts.t_IsPartial <> 'X' "
          + "                                    and fiwarnts.t_DrawingDate > ? "
          + "                                    and ( "
          + "                                           fiwarnts.t_IncomeRate <> 0 "
          + "                                           or fiwarnts.t_IncomeVolume <> 0 "
          + "                                        ) "
          + "                               ) "
          + "                     and exists( "
          + "                                  select 1 "
          + "                                  from dfiwarnts_dbt fiwarnts "
          + "                                  where fiwarnts.t_FIID = fin.t_FIID "
          + "                                    and fiwarnts.t_IsPartial <> 'X' "
          + "                                    and fiwarnts.t_DrawingDate > ? "
          + "                                    and fiwarnts.t_IncomeRate = 0 "
          + "                                    and fiwarnts.t_IncomeVolume = 0"
          + "                               )"
          + "                then 1"
          + "                else 0 "
          + "           end"
          + "        ) IsPerDrawing"
          + "   from f, dfininstr_dbt fin, davoiriss_dbt avr "
          + "  where fin.t_FIID = f.t_FIID "
          + "    and avr.t_FIID = fin.t_FIID "
          + "    and avr.t_SPIsClosed = CHR(0) "
          + "    and RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, "+AVOIRISSKIND_BOND+", fin.t_AvoirKind) = 1 "
/*äÑ*/    + "    and fin.t_DrawingDate != " + GetSQLDate(date(0,0,0))
          + "    and 1 = (CASE WHEN avr.t_Termless = 'X' "
          + "                  THEN CASE WHEN (SELECT NVL(MAX(t_DrawingDate), TO_DATE('01.01.0001', 'DD.MM.YYYY')) "
          + "                                    FROM DFIWARNTS_DBT "
          + "                                   WHERE t_FIID = fin.t_FIID "
          + "                                     AND t_IsPartial = CHR(0) "
          + "                                 ) = RSI_RSB_FIInstr.FI_GetNominalDrawingDate(fin.T_FIID, avr.t_Termless) "
          + "                            THEN 1 ELSE 0 END  "
          + "                  ELSE 1 END  "
          + "            ) "
          + " order by RSI_RSB_FIInstr.FI_GetNominalDrawingDate(fin.T_FIID, avr.t_Termless)";

  cmd = DL_RSDCommand(query);
  
  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);
  cmd.AddParam(dl_comm.rec.Division);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.CommDate);

  DataSet = cmd.Execute();

  var procCloseScr = SC_CCloseAccountSecurity(dl_comm);

  while(DataSet.moveNext())

    ä_¢_≠†´®Á®® = WRTGetPortfolioAmount(-1, DataSet.FIID, 0, -1, -1, -1, min(dl_comm.rec.CommDate, date(DataSet.DrawingDate))-1, true, false, false);
    ä_Æ°‡†°Æ‚ = WRTGetAmountFromRetire(-1, DataSet.FIID, 0, -1, "", "", -1, 0, true); 

    ä_·Æ°_‡†ß¨•È = WRTGetAmountOwn(-1, DataSet.FIID, date(DataSet.DrawingDate)-1, true, false);
    ä_·Æ°_Æ°‡†°Æ‚ = WRTGetAmountFromRetireOwn(-1, DataSet.FIID, "", -1, true);

    S = ä_¢_≠†´®Á®® + ä_·Æ°_‡†ß¨•È - ä_Æ°‡†°Æ‚ - ä_·Æ°_Æ°‡†°Æ‚;

    if(S < 0)
      MsgBox( "éË®°™† Ø‡® ‡†·Á•‚• ™Æ´®Á•·‚¢† ØÆ£†Ë•≠≠ÎÂ °„¨†£ "+èÆ´„Á®‚ÏäÆ§î®≠à≠(DataSet.FIID)+" ≠† §†‚„ ØÆ£†Ë•≠®Ô");
    elif(S == 0)
      //á†™‡Î‚ÏñÅ(DataSet.FIID, dl_comm, IIF(DataSet.IsPerDrawing == 1, date(DataSet.DrawingDate), date(0, 0, 0)));
      procCloseScr.processAccount(DataSet.FIID, DataSet.FI_Code);
    end;
  end; 
end;

private macro Åì_è‡Æ¢Æ§™®èÆÇ´†§•´ÏÊ†¨(dl_comm)
  var query, cmd, DataSet;
  var sz = 0, err = 0, äÆ¨ = NULL, FDContr;
  var prevGrDealID = 0;
  var ComisRepDataArr = TArray();
  var dlgrdocCache = RsbSQLInsert("dlgrdoc.dbt");
  var rContr = TBFile("sfcontr");
  var AccountDt = TrecHandler( "account.dbt"), 
      AccountCt = TrecHandler( "account.dbt"),
      rSfSiDt   = TrecHandler( "sfsi.dbt"),
      rSfSiCt   = TrecHandler( "sfsi.dbt"),
      AccountNDS= TrecHandler( "account.dbt");

  è‡Æ¢Æ§™®Åì = SecurAccountingCarry(dl_comm.rec.DocKind, dl_comm.rec.DocumentID);

  cmd = DL_RSDCommand();

  query =   " select comis.t_ComNumber, contr.t_ID ContrID, comis.t_NDS, comis.t_Sum, gracc.t_GrDealID, sfdef.t_ID SfDefID "
          + "   from ddlcomis_dbt comis, dsfcontr_dbt contr, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, dsfdef_dbt sfdef, dsfcomiss_dbt sfcom "
          + "  where grdeal.t_PlanDate = ? "
          + "    and grdeal.t_DocKind = " + OBJTYPE_SFCONTR
          + "    and contr.t_ID = grdeal.t_DocID "
          + "    and contr.t_Department = ? "
          + "    and grdeal.t_TemplNum = " + DLGR_TEMPL_PAYCOM
          + "    and gracc.t_GrDealID = grdeal.t_ID "
          + "    and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
          + "    and gracc.t_State = " + DLGRACC_STATE_PLAN
          + "    and comis.t_Contract = contr.t_ID "
          + "    and comis.t_DocKind = grdeal.t_DocKind "
          + "    and comis.t_DocID = grdeal.t_DocID "
          + "    and sfdef.t_SfContrID = contr.t_ID "
          + "    and sfdef.t_FeeType = comis.t_FeeType "
          + "    and sfdef.t_CommNumber = comis.t_ComNumber "
          + "    and sfdef.t_DateFee = comis.t_PlanPayDate "
          + "    and grdeal.t_PlanDate = comis.t_PlanPayDate"
          + "    and sfcom.t_FeeType = comis.t_FeeType " 
          + "    and sfcom.t_Number = comis.t_ComNumber "
          + "    and sfcom.T_SERVICEKIND = ? ";

  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.Division);
  cmd.AddParam(PTSK_STOCKDL);

  if(dl_comm.rec.ClientID > -1)
    query = query + " and contr.t_PartyID "+IIF(((dl_comm.rec.Flag1 == SET_CHAR) and (dl_comm.rec.Flag5 != SET_CHAR)), "<>", "=")+" ? ";
    cmd.AddParam(dl_comm.rec.ClientID);
  else
    query = query + " and contr.t_PartyID <> ? ";
    cmd.AddParam({OurBank});   
  end;

  if(dl_comm.rec.ContractID > 0)
    query = query + " and contr.t_ID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
    cmd.AddParam(dl_comm.rec.ContractID);
  end;

  query = query + " order by gracc.t_GrDealID asc";

  DataSet = cmd.Execute(query);

  AccountDt.Clear();
  AccountCt.Clear();
  AccountNDS.Clear();

  while((not err) and (DataSet.moveNext()))
    
    if(prevGrDealID != DataSet.GrDealID) //Ö·´® ≠† ·‚‡Æ™• ≠•·™Æ´Ï™Æ ™Æ¨®··®©, Á‚Æ°Î ≠•·™Æ´Ï™Æ ‡†ß ≠• §Æ°†¢´Ô‚Ï §Æ™„¨•≠‚ Æ°‡†°Æ‚™® ·‚‡Æ™®
      è‡Æ¢Æ§™®Åì.SetGrDealData(DataSet.GrDealID, 0, -1, DLGR_SOURCETYPE_PAYCOM);
      prevGrDealID = DataSet.GrDealID;
    end;
    
    rContr.Clear();
    rContr.rec.ID = DataSet.ContrID;
    if(rContr.GetEQ())

      FDContr = SPFirstDocContract( DL_STOCKCONTR, rContr );
      äÆ¨ = CPeriodCommission( rContr, DataSet.ComNumber, DataSet.SfDefID );

      if( è‡Æ¢•‡®‚Ïä†‚•£Æ‡®ÓäÆ¨®··®®( äÆ¨.rComiss, "TDF", OBJGROUP_SFCOM_CALCBYBO ) == false )
        msgbox( "Ñ´Ô ™Æ¨®··®® " +äÆ¨.rComiss.rec.Number+" ¢ ™†‚•£Æ‡®® \"ê†·Á•‚ ™Æ¨®··®© ¢ Åé ñÅ\" §Æ´¶≠Æ °Î‚Ï „·‚†≠Æ¢´•≠Æ ß≠†Á•≠®• \"è‡® ß†¢•‡Ë•≠®® ‚Æ‡£Æ¢Æ£Æ §≠Ô\".");
        continue;
      end;

      if( (not äÆ¨.èÆ´„Á®‚ÏëÁ•‚è´†‚•´ÏÈ®™†(  rContr.rec.Number, rSfSiDt, true ) ) OR
         (not äÆ¨.èÆ´„Á®‚ÏëÁ•‚èÆ´„Á†‚•´Ô( rContr.rec.Number, rSfSiCt, false, AccountNDS ) )
       )
        err = 1;
      end;

      if(not err)
        /*·Á•‚ ™´®•≠‚† ¢·•£§† §Æ´¶•≠ °Î‚Ï ß†§†≠ (true ¢ èÆ´„Á®‚ÏëÁ•‚†éØ´†‚Î)*/
        if( AccountDt.rec.Account != rSfSiDt.rec.Account )
           if( GetAccount( 1, rSfSiDt.rec.FIID, rSfSiDt.rec.Account, AccountDt, true ) == false )
              MsgBox( "ç• ≠†©§•≠ ·Á•‚ ™´®•≠‚† <"+rSfSiDt.rec.Account+">, ß†§†≠≠Î© ¢ èà §´Ô §Æ£Æ¢Æ‡† <" +rContr.rec.Number+">");
              err = 1;
           end;
        end;

        if(not err)
          if( rSfSiCt.rec.Account == "" )
             if( not FDContr.OpenAccount( "+äÇ, Ê/°", null, null, FIROLE_COMISS_CLIENT, AccountCt, ScOprServDoc.CommDate) )
                err = 1;
             end;
          elif( AccountCt.rec.Account != rSfSiCt.rec.Account )
             if( GetAccount( 1, NATCUR, rSfSiCt.rec.Account, AccountCt, true ) == false )
                MsgBox( "ç• ≠†©§•≠ ·Á•‚ ØÆ´„Á†‚•´Ô ™Æ¨®··®® <"+rSfSiCt.rec.Account+">, ß†§†≠≠Î© ¢ èà §´Ô ™Æ¨®·®® <" +äÆ¨.rComiss.rec.Number+">");
                err = 1;
             end;
          end;
        end;

        if(not err)
          if(not Åì_è‡Æ¢Æ§™†èÆä†‚•£Æ‡®Ô¨ìÁ•‚†( 
                 FDContr, 
                 AccountDt, AccountCt,
                 dl_comm.rec.CommDate,           /* Ñ†‚† */
                 1,                             /* É´†¢† */
                 äÆ¨.Ç†´Ó‚†éØ´†‚Î(),            /* Ç†´Ó‚† ·„¨¨Î Ø‡Æ¢Æ§™® */
                 DataSet.Sum,                   /* ë„¨¨† Ø‡Æ¢Æ§™®*/
                 INPCARRY,                      /* Result_Carry */
                 " 1",                          /* Kind_Oper */
                 rContr.rec.Number,             /* Numb_Document */
                 "éØ´†‚† ™Æ¨®··®® ØÆ §Æ£Æ¢Æ‡„ " + rContr.rec.Number + " ™´®•≠‚† · °†≠™Æ¨", /* Ground */
                 null, FIROLE_COMISS_CLIENT, FIROLE_COMISS_CLIENT
            ) 
          )
            err = 1;
          else  
            //§Æ°†¢®‚Ï ß†Ø®·Ï ¢ ´Æ£ Æ ¢ÎØÆ´≠•≠≠Æ© Ø‡Æ¢Æ§™•
            ComisRepDataArr[ComisRepDataArr.size] = CSC_AccComisRepParm(rContr.rec.ID,
                                                                        äÆ¨.rComiss.rec.Code,
                                                                        AccountDt.rec.Account,      
                                                                        AccountCt.rec.Account,   
                                                                        DataSet.Sum,         
                                                                        äÆ¨.Ç†´Ó‚†éØ´†‚Î());

          end;

        end;

        if( (not err) and (DataSet.NDS != 0) )
          if( AccountNDS.rec.Account == "" )
             if( not FDContr.OpenAccount( "-çÑë", null, null, FIROLE_COMISS_CLIENT, AccountNDS, ScOprServDoc.CommDate) )
                err = 1;
             end;
          elif( GetAccount( 1, NATCUR, AccountNDS.rec.Account, AccountNDS, true ) == false )
             MsgBox( "ç• ≠†©§•≠ ·Á•‚ ØÆ´„Á†‚•´Ô çÑë <"+AccountNDS.rec.Account+">, ß†§†≠≠Î© §´Ô ™Æ¨®·®® <" +äÆ¨.rComiss.rec.Number+">");
             err = 1;
          end;

          if(not err)
            if(not Åì_è‡Æ¢Æ§™†èÆä†‚•£Æ‡®Ô¨ìÁ•‚†( 
                   FDContr, 
                   AccountDt, AccountNDS,   
                   dl_comm.rec.CommDate,     /* Ñ†‚† */
                   1,                       /* É´†¢† */
                   NATCUR,                  /* Ç†´Ó‚† ·„¨¨Î Ø‡Æ¢Æ§™® */
                   DataSet.NDS,             /* ë„¨¨† Ø‡Æ¢Æ§™®*/
                   INPCARRY,                /* Result_Carry */
                   " 1",                    /* Kind_Oper */
                   rContr.rec.Number,       /* Numb_Document */
                   "éØ´†‚† çÑë · ™Æ¨®··®® ØÆ §Æ£Æ¢Æ‡„ " + rContr.rec.Number + " ™´®•≠‚† · °†≠™Æ¨", /* Ground */
                   null, FIROLE_COMISS_CLIENT, FIROLE_COMISS_CLIENT
              ) 
            )
              err = 1;
            else  
              //§Æ°†¢®‚Ï ß†Ø®·Ï ¢ ´Æ£ Æ ¢ÎØÆ´≠•≠≠Æ© Ø‡Æ¢Æ§™•
              ComisRepDataArr[ComisRepDataArr.size] = CSC_AccComisRepParm(rContr.rec.ID,
                                                                          "çÑë",
                                                                          AccountDt.rec.Account,      
                                                                          AccountNDS.rec.Account,   
                                                                          DataSet.NDS,         
                                                                          NATCUR);

            end;
          end;
        end;
      end;
    end;
  end;

  if(not err)
    RslDefCon.BeginTrans();

    err = è‡Æ¢Æ§™®Åì.Execute(RepErrArr);

    if(not err) 
      var sql, exec;

      //àß¨•≠Ô•¨ ·‚†‚„· ¢®§† „Á•‚† Åì
      sql =  "DECLARE "
           + "BEGIN "
           + "  FOR one_grdoc IN (SELECT DISTINCT GRDOC.T_GRDEALID "
           + "                      FROM DDLGRDOC_DBT GRDOC, DDLGRDEAL_DBT GRDEAL "
           + "                     WHERE GRDOC.T_DOCKIND = 0 "
           + "                       AND GRDOC.T_DOCID = 0 "
           + "                       AND GRDOC.T_SERVDOCKIND = ? "
           + "                       AND GRDOC.T_SERVDOCID = ? "
           + "                       AND GRDOC.T_GRPID = 0 "
           + "                       AND GRDEAL.T_ID = GRDOC.T_GRDEALID "
           + "                       AND GRDEAL.T_DOCKIND = " + OBJTYPE_SFCONTR 
           + "                   ) LOOP "
           + "    RSI_DLGR.RSI_UpdateGrDealAccByID( one_grdoc.t_GRDEALID, "+DLGR_ACCKIND_ACCOUNTING+", "+DLGRACC_STATE_FACTEXEC+", NULL, 0); "
           + "  END LOOP; "
           + "  RSI_DLGR.RSI_ExecCommitDLGR; "
           + "END; ";
       
      exec = RSDCommand(sql);

      exec.addParam( "", RSDBP_IN, dl_comm.rec.DocKind );
      exec.addParam( "", RSDBP_IN, dl_comm.rec.DocumentID );
      exec.execute();
    end;

    if(err)
      RslDefCon.RollbackTrans(); //é‚™†‚®‚Ï ‚‡†≠ß†™Ê®Ó
    else
      RslDefCon.CommitTrans(); //á†¢•‡Ë®‚Ï ‚‡†≠ß†™Ê®Ó
    end;
  end;

  DL_SaveDataForReport_XML(dl_comm.rec.DocumentID, dl_comm.rec.DocKind, ComisRepDataArr, LOG_TYPE_DATA);

  return err;
end; 

private macro á†™‡Î‚ÏëÁ•‚†ê†·Á•‚Æ¢( FD, FIID, StrInfo, dl_comm )
  var    SumAdd = $0, SumSub = $0, Sum1 = $0, Sum2 = $0, SumRed = $0, IsClientOper = false; 
  var    dat = FD.comm.rec.CommDate;
  var FiRole = null, BOfficeKind, ù‚ÆÑì = (FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_TRUST); 
  var FlagSecur = dl_comm.rec.FlagSecur, FlagSecurOwn = dl_comm.rec.FlagSecurOwn;
  var WhereCond = "";

  var ground = "";

  GetSettlFiRoleByOperSubKind(FD.comm.rec.OperSubKind,@FiRole);
  var AccCat = "ä´®‡®≠£Æ¢Î© ·Á•‚";

  if( (FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_CLIENT) or ù‚ÆÑì )/*‡•†´Ï≠Æ §´Ô Ñì Ì‚Æ‚ Ø‡®ß≠†™ ≠• ®·ØÆ´Ïß„•¨, ≠Æ ØÆ ·¨Î·´„ ·§•´™® Ñì ¢·•£§† ™´®•≠‚·™®•*/
     IsClientOper = true;
  else
     IsClientOper = false;
  end;

  if((IsClientOper == false) AND (DL_Ö§®≠Î©è„´é°•·Ø•Á•≠®ÔëÆ°·‚¢) AND ( (FIID != natcur) OR ( (FIID == natcur) AND (FD.comm.rec.ContractKind == DV_MARKETKIND_ALL) ) ) ) // Golovkin §´Ô ê†·Á•‚Æ¢ · °®‡¶•© •§®≠Æ£Æ Ø„´†
     AccCat = "+é°•·Ø•Á•≠®•";
     FiRole = FIROLE_BANKROLL;//ß†≠„´Ô•¨
  end;

  if((IsClientOper == true) AND (DL_Ö§®≠Î©è„´é°•·Ø•Á•≠®Ôä´®•≠‚) AND (FIID != natcur) AND (GetRealFIKind(FIID) != FIKIND_METAL) AND (FD.comm.rec.flag1 == "X"))
     AccCat = "+é°•·Ø•Á•≠®•";
  end;

  if( IsClientOper )
    if(dl_comm.rec.ClientID > -1)
      if( (dl_comm.rec.Flag5 != SET_CHAR) and (dl_comm.rec.ClientID != {OurBank}) )
        WhereCond = " and deal.t_ClientID " + IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=") + string(dl_comm.rec.ClientID);
        WhereCond = " and deal.t_ClientID <> -1 ";
      end;
    end;
    if(dl_comm.rec.ContractID > 0)
      WhereCond = WhereCond + " and deal.t_ClientContrID " + IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=") + string(dl_comm.rec.ContractID);
    end;
  end;

  /*è‡Æ¢•‡Ô‚Ï Á‚Æ ·§•´™† - Ñì - ØÆ „·´Æ¢®Ó dl_tick.t_BOfficeKind == DL_TRUSTDOC*/

  /*Ø‡Æ§†¶® ≠† éêñÅ*/ 
  if(FlagSecur == SET_CHAR)
    CalculatorByDeals( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTDOC,DL_SECURITYDOC), DL_CLOSED, dat, 
                       DEAL_TYPE_SALE, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_PAYMENT, 1, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  if((ù‚ÆÑì == false) and (FlagSecurOwn == SET_CHAR))
    CalculatorByDeals( SumAdd, DEALCALC_CALC, DL_SECUROWN, DL_CLOSED, dat, 
                       DEAL_TYPE_SALE, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_PAYMENT, 1, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  /*ØÆ£†Ë•≠®Ô ≠† éêñÅ*/ 
  if(FlagSecur == SET_CHAR)
    CalculatorByDeals( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTRETIREMENT,DL_RETIREMENT), DL_CLOSED, dat, 
                       DEAL_TYPE_SALE, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_PAYMENT, 1, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );

    CalculatorByDeals( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTRETIREMENT,DL_RETIREMENT), DL_CLOSED, dat, 
                       DEAL_TYPE_RET_PARTLY, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_PAYMENT, 1, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  /*ØÆ´„Á•≠≠Æ• çäÑ */ 
  if(FlagSecur == SET_CHAR)
    CalculatorNKDByDeals( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTDOC,DL_SECURITYDOC), DL_CLOSED, dat, 
                          DEAL_TYPE_SALE, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  if((ù‚ÆÑì == false) and (FlagSecurOwn == SET_CHAR))
    CalculatorNKDByDeals( SumAdd, DEALCALC_CALC, DL_SECUROWN, DL_CLOSED, dat, 
                          DEAL_TYPE_SALE, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  if(FlagSecur == SET_CHAR)
    CalculatorNKDByDeals( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTRETIREMENT,DL_RETIREMENT), DL_CLOSED, dat, 
                          DEAL_TYPE_SALE, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
    CalculatorNKDByDeals( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTRETIREMENT,DL_RETIREMENT), DL_CLOSED, dat, 
                          DEAL_TYPE_RET_COUPON, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
    CalculatorNKDByDeals( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTRETIREMENT,DL_RETIREMENT), DL_CLOSED, dat, 
                          DEAL_TYPE_RET_PARTLY, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  /*™Æ¨Ø•≠·†Ê®Æ≠≠Î• íé ØÆ êÖèé*/
  if(FlagSecur == SET_CHAR)
    CalculatorByRq( SumAdd, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTDOC,DL_SECURITYDOC), DL_CLOSED, dat, 
                    DEAL_TYPE_BUY, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_COMPPAYM, 2, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  /*ë„¨¨Î ·Ø®·†≠®Ô ß† ‚•™„È®© §•≠Ï*/
  /*ØÆ™„Ø™® ≠† éêñÅ*/ 
  if(FlagSecur == SET_CHAR)
    CalculatorByDeals( SumSub, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTDOC,DL_SECURITYDOC), DL_CLOSED, dat, 
                       DEAL_TYPE_BUY, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_PAYMENT, 1, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  if((ù‚ÆÑì == false) and (FlagSecurOwn == SET_CHAR))
    CalculatorByDeals( SumSub, DEALCALC_CALC, DL_SECUROWN, DL_CLOSED, dat, 
                       DEAL_TYPE_BUY, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_PAYMENT, 1, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  /*™Æ¨®··®® ØÆ ·§•´™†¨ (·„¨¨Î Ø‡ÆË´® ØÆ ™‡•§®‚„ ·Á•‚† "-Å®‡¶†") */ 
  if(FlagSecur == SET_CHAR)
    CalcComissByDeals( SumSub, FD.comm.rec, FIID, IsClientOper, WhereCond );
    CalcComissByDealsKlirSPB( SumSub, FD.comm.rec, FIID, IsClientOper, WhereCond );
  end;

  /*„Ø´†Á•≠≠Æ• çäÑ */ 
  if(FlagSecur == SET_CHAR)
    CalculatorNKDByDeals( SumSub, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTDOC,DL_SECURITYDOC), DL_CLOSED, dat, 
                          DEAL_TYPE_BUY, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  if((ù‚ÆÑì == false) and (FlagSecurOwn == SET_CHAR))
    CalculatorNKDByDeals( SumSub, DEALCALC_CALC, DL_SECUROWN, DL_CLOSED, dat, 
                          DEAL_TYPE_BUY, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;

  /*™Æ¨Ø•≠·†Ê®Æ≠≠Î• íé ØÆ êÖèé*/
  if(FlagSecur == SET_CHAR)
    CalculatorByRq( SumSub, DEALCALC_CALC, IIF(ù‚ÆÑì,DL_TRUSTDOC,DL_SECURITYDOC), DL_CLOSED, dat, 
                    DEAL_TYPE_SALE, FD.comm.rec.PartyID, FD.comm.rec.MarketSchemeID, DLRQ_TYPE_COMPPAYM, 2, -1, IsClientOper, FIID, null, ù‚ÆÑì, WhereCond );
  end;
 /*
  if( SumAdd != $0 )
     if( not Åì_è‡Æ¢Æ§™†èÆä†‚•£Æ‡®Ô¨ìÁ•‚†( FD, 
              AccCat, "+Å®‡¶†",
              dat, 
              1,
              FIID, 
              Abs(SumAdd), 
              INPCARRY, " 1", FD.comm.rec.CommCode, 
              "è•‡•≠Æ· ·„¨¨Î ß†Á®·´•≠®© ØÆ ®‚Æ£†¨ ‚Æ‡£Æ¢ ≠† " + StrInfo + " ·Æ ·Á•‚† \"Å®‡¶†\" ≠† \"ä´®‡®≠£Æ¢Î© ·Á•‚\"",
              null, FiRole, null, 
              FIID, FIID
       ))
        return 1;
     end;   
  end; 

  if( SumSub != $0 ) 
     if( not Åì_è‡Æ¢Æ§™†èÆä†‚•£Æ‡®Ô¨ìÁ•‚†( FD, 
              "-Å®‡¶†", AccCat,
              dat, 
              1,
              FIID, 
              Abs(SumSub), 
              INPCARRY, " 1", FD.comm.rec.CommCode, 
              "è•‡•≠Æ· ·„¨¨Î ·Ø®·†≠®© ØÆ ®‚Æ£†¨ ‚Æ‡£Æ¢ ≠† " + StrInfo + " ·Æ ·Á•‚† \"Å®‡¶†\" ≠† \"ä´®‡®≠£Æ¢Î© ·Á•‚\"",
              null, null, FiRole,
              FIID, FIID
       ))
        return 1;
     end;   
  end;
*/ 
 
  If(not IsClientOper)
     ground = "Å®‡¶†, ‰Æ≠§Æ¢Î© ‡Î≠Æ™. ë•£¨•≠‚ " + StrInfo + ". ë†´Ï§Æ ‡†·Á•‚Æ¢.";
  else
     ground = "Å®‡¶†, ‰Æ≠§Æ¢Î© ‡Î≠Æ™. ë•£¨•≠‚ " + StrInfo + ", ™´®•≠‚·™†Ô ØÆß®Ê®Ô. ë†´Ï§Æ ‡†·Á•‚Æ¢.";
  end;


  if( Abs(SumAdd)>Abs(SumSub) )
     if( not Åì_è‡Æ¢Æ§™†èÆä†‚•£Æ‡®Ô¨ìÁ•‚†( FD, 
              AccCat/*"ä´®‡®≠£Æ¢Î© ·Á•‚"*/, "+Å®‡¶†", // Golovkin upg 48
              dat, 
              1,
              FIID, 
              /*Abs(SumAdd)*/Abs(SumAdd)-Abs(SumSub), 
              INPCARRY, " 1", FD.comm.rec.CommCode, 
              ground/*"è•‡•≠Æ· ·„¨¨Î ß†Á®·´•≠®© ØÆ ®‚Æ£†¨ ‚Æ‡£Æ¢ ≠† " + StrInfo + " ·Æ ·Á•‚† \"Å®‡¶†\" ≠† \"ä´®‡®≠£Æ¢Î© ·Á•‚\""*/,
              null, FiRole, FiRole, 
              FIID, FIID
       ))
        return 1;
     end;   
  end;

  if( Abs(SumSub)>Abs(SumAdd) )
     if( not Åì_è‡Æ¢Æ§™†èÆä†‚•£Æ‡®Ô¨ìÁ•‚†( FD, 
              "+Å®‡¶†", AccCat/*"ä´®‡®≠£Æ¢Î© ·Á•‚"*/, // Golovkin upg 48
              dat, 
              1,
              FIID, 
              Abs(SumSub)-Abs(SumAdd), 
              INPCARRY, " 1", FD.comm.rec.CommCode, 
              ground/*"ååÇÅ ‰Æ≠§Æ¢Î© ‡Î≠Æ™. ë•£¨•≠‚ " + StrInfo + ", ™´®•≠‚·™†Ô ØÆß®Ê®Ô. ë†´Ï§Æ ‡†·Á•‚Æ¢."*/,
              null, FiRole, FiRole,
              FIID, FIID
       ))
        return 1;
     end;   
  end;
 
  return 0;
end;

private macro Åì_è‡Æ¢Æ§™®ê†·Á•‚Æ¢ç†Å®‡¶•(dl_comm)
  var query, cmd, DataSet;
  var StrInfo;
  var err = 0, i = 0;
  var FD = null;
  
  è‡Æ¢Æ§™®Åì = SecurAccountingCarry(dl_comm.rec.DocKind, dl_comm.rec.DocumentID);

  cmd = DL_RSDCommand();

  //§´Ô ™†¶§Æ© ¢†´Ó‚Î ®ß ®·ØÆ´≠•≠≠ÎÂ ÆØ•‡†Ê®© ‡†·Á•‚Æ¢ ‰Æ‡¨®‡„•¨ Ø‡Æ¢Æ§™®
  query =   " select comm.t_DocKind, comm.t_DocumentID, comm.t_PartyID, comm.t_traderid, comm.t_PartyOfficeID, total.t_CodeFI FIID "
          + "   from ddl_comm_dbt comm, ddl_totaloffi_dbt total "
          + "  where comm.t_DocKind = " + DL_SETTLEMENTFCURM
          + "    and comm.t_CommDate = ? "
          + "    and comm.t_Division = ? "
          + "    and comm.t_CommStatus <> " + DL_PREPARING
          + "    and total.T_DocID = comm.t_DocumentID "
          + "    and total.t_DocKind = comm.t_DocKind  "
          + "    and total.t_Parent = 0";

  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.Division);

/*  if(dl_comm.rec.ClientID > -1)
    if( (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank}) )
      query = query + " and comm.t_OperSubKind = ? ";
      cmd.AddParam(ALG_SP_MONEY_SOURCE_OWN);
    else
      query = query + " and comm.t_OperSubKind = ? ";
      cmd.AddParam(ALG_SP_MONEY_SOURCE_CLIENT);
    end;
  else
    query = query + " and comm.t_OperSubKind = ? ";
    cmd.AddParam(ALG_SP_MONEY_SOURCE_CLIENT);
  end;
*/
  DataSet = cmd.Execute(query);

  while((not err) and (DataSet.moveNext()))
    //FD = SPFirstDocDLCOMM( DataSet.DocKind, DataSet.DocumentID );
    FD = SPFirstDocDLCOMMitog( DataSet.DocKind, DataSet.DocumentID, DataSet.FIID ); // Golovkin 25.08.2020

    è‡Æ¢Æ§™®Åì.SetGrDealData(0, 0, -1, DLGR_SOURCETYPE_CALCEXCHANGE);

    StrInfo = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†( DataSet.PartyID, PTCK_CONTR ) 
            + " ·•™‚Æ‡ " + èÆ´„Á®‚Ïç†®¨•≠Æ¢†≠®•ë•™‚Æ‡†( DataSet.traderid/*DataSet.PartyID*/, DataSet.PartyOfficeID );

    err = á†™‡Î‚ÏëÁ•‚†ê†·Á•‚Æ¢( FD, DataSet.FIID, StrInfo, dl_comm );

    if(err)
      MsgBox( "éË®°™† Ø‡® ‰Æ‡¨®‡Æ¢†≠®® Ø‡Æ¢Æ§Æ™ ‡†·Á•‚Æ¢ · °®‡¶•©");
    end;
  end;

  if(not err)
    RslDefCon.BeginTrans();

    err = è‡Æ¢Æ§™®Åì.Execute(RepErrArr);

    if(err)
      RslDefCon.RollbackTrans(); //é‚™†‚®‚Ï ‚‡†≠ß†™Ê®Ó
    else
      RslDefCon.CommitTrans(); //á†¢•‡Ë®‚Ï ‚‡†≠ß†™Ê®Ó
    end;
  end;
  return 0;
end;

macro Åì_ÇÎØÆ´≠®‚Ïè‡Æ¢Æ§™®èÆë‚‡Æ™•É‡†‰®™†( FD, GrDealID, TemplNum, CarryDate:date, _IsControlOrg ):integer
  var err = 0;
  var RealizSumm = TArray();

  if((TemplNum == DLGR_TEMPL_PAYAVANCE) OR (TemplNum == DLGR_TEMPL_PAYAVANCE2)) /*éØ´†‚† †¢†≠·†/ß†§†‚™†*/
    err = Åì_é°‡†°Æ‚†‚ÏíéÄ¢†≠·†á†§†‚™†( FD, CarryDate, FD.ExistAvance );
  elif(TemplNum == DLGR_TEMPL_PAYMENT) /*éØ´†‚†*/
    if(IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group))
      err = Åì_è‡Æ¢Æ§™®éØ´†‚Îä„ØÆ≠†óè(FD, CarryDate);
    elif(IsRET_ISSUE(FD.Group))
      err = Åì_è‡Æ¢Æ§™®éØ´†‚Îè‡®èÆ£†Ë•≠®®ñÅ(FD, CarryDate);
    elif(IsREPO(FD.Group))
      err = Åì_è‡Æ¢Æ§™®èÆéØ´†‚•êÖèéó1(FD, CarryDate);
    elif(IsBUY(FD.Group))
      err = Åì_è‡Æ¢Æ§™®èÆéØ´†‚•è‡®èÆ™„Ø™•(FD, CarryDate);
    else
      err = Åì_è‡Æ¢Æ§™®èÆéØ´†‚•è‡®è‡Æ§†¶•(FD, CarryDate);
    end;
  elif(TemplNum == DLGR_TEMPL_PAYMENT2) /*éØ´†‚† ØÆ 2-© Á†·‚® êÖèé*/
    if(IsOUTEXCHANGE(FD.Group))
      err = Åì_è‡Æ¢Æ§™®èÆéØ´†‚•Ç≠•°®‡¶êÖèéó2(FD, CarryDate, GrDealID);
    else
      err = Åì_è‡Æ¢Æ§™®èÆéØ´†‚•Å®‡¶êÖèéó2(FD, CarryDate, GrDealID);
    end;
  elif(TemplNum == DLGR_TEMPL_PAYPC) /*éØ´†‚† %% ß†©¨*/
    err = Åì_è‡Æ¢Æ§™®èÆéØ´†‚•è‡ÆÊá†©¨†(FD, CarryDate);
  elif(TemplNum == DLGR_TEMPL_RECDELIVERY) /*ìÁ•‚ ØÆ·‚†¢™®*/
    if(IsRET_COUPON(FD.Group))
      if( ( not IsClientDeal(FD.tick.rec) ) OR IsBROKER(FD.Group) OR FD.ë§•´™†éêñÅ() )
        if( FD.tick.rec.Number_Coupon != "" )
           if( not Åì_è‡Æ¢Æ§™®èÆ£†Ë•≠®Ôä„ØÆ≠†(FD, CarryDate) )
              err = 1;
           end;
        end;
      end;
    elif( IsRET_PARTLY(FD.Group) )
      if( ( not IsClientDeal(FD.tick.rec) ) OR IsBROKER(FD.Group) OR FD.ë§•´™†éêñÅ() )
        if( not Åì_è‡Æ¢Æ§™®ó†·‚®Á≠Æ£ÆèÆ£†Ë•≠®Ô(FD, CarryDate) )
          err = 1;
        end;
        if(not err)
          if( (FD.tick.rec.Number_Coupon != "") AND (not IsClientDeal(FD.tick.rec) ) )
             if( not Åì_è‡Æ¢Æ§™®èÆ£†Ë•≠®Ôä„ØÆ≠†(FD, CarryDate) )
                err = 1;
             end;
          end;
        end;
      end;
    elif(IsRET_ISSUE(FD.Group))
      err = Åì_ìÁ•‚èÆ·‚†¢™®è‡®èÆ£†Ë•≠®®ñÅ(FD, CarryDate);
      if(not err)
        if( (FD.tick.rec.Number_Coupon != "") AND (not IsClientDeal(FD.tick.rec) ) )
           if( not Åì_è‡Æ¢Æ§™®èÆ£†Ë•≠®Ôä„ØÆ≠†(FD, CarryDate, RealizSumm) )
              err = 1;
           end;
        end;
        if(not err)
          if( not Åì_ëØ®·†≠®•ë•°•·‚Æ®¨Æ·‚®è‡®èÆ£†Ë•≠®®(FD, CarryDate, RealizSumm) )
             err = 1;
          end;
        end;
      end;
    elif(IsTwoPart(FD.Group))
      err = Åì_è‡Æ¢Æ§™®èÆìÁ•‚„èÆ·‚†¢™®êÖèéó1(FD, CarryDate, GrDealID);
    elif(IsAVRWRTIN(FD.Group) or IsAVRWRTOUT(FD.Group))
      err = Åì_è‡Æ¢Æ§™®ìÁ•‚†èÆ·‚†¢™®áóëè(FD, CarryDate, null, GrDealID);
    else
      err = Åì_è‡Æ¢Æ§™®ìÁ•‚†èÆ·‚†¢™®(FD, CarryDate, null, GrDealID);
    end;
  elif((TemplNum == DLGR_TEMPL_RECDELIVERY2) /*and (not IsLoan(FD.Group))*/) /*ìÁ•‚ ØÆ·‚†¢™® ØÆ 2-© Á†·‚® êÖèé*/
    err = Åì_è‡Æ¢Æ§™®èÆìÁ•‚„èÆ·‚†¢™®êÖèéó2(FD, CarryDate, GrDealID);
  elif(TemplNum == DLGR_TEMPL_PREVCOSTACC) /*ìÁ•‚ Ø‡•§¢†‡®‚•´Ï≠ÎÂ ß†‚‡†‚*/
    if( IsBUY(FD.Group) ) /*Ç ·§•´™†Â Ø‡Æ§†¶® ØÆ ·‚‡Æ™• £‡†‰®™† ≠®Á•£Æ ≠• §•´†•¨*/
      if( not Åì_ìÁ•‚è‡•§¢†‡®‚•´Ï≠ÎÂá†‚‡†‚( FD, CarryDate, FD.tick.rec.PREOUTLAY, FD.tick.rec.PREOUTLAYFIID ) )
        err = 1;
      end;
    end;

/*USER*/
  elif(TemplNum == 100) /*ç†Á®·´•≠®• ™Æ¨®··®©*/
    err = Åì_è‡Æ¢Æ§™®î®™·†Ê®®äÆ¨®··®©(FD, CarryDate);

  elif(TemplNum == 102) /*ç†Á®·´•≠®• ™Æ¨®··®© ØÆ ä´®‡®≠£„ ëèÅ ≠• ¢ §†‚„ ß†™´ÓÁ•≠®Ô*/

    err = Åì_è‡Æ¢Æ§™®î®™·†Ê®®äÆ¨®··®©ä´®‡®≠£ëèÅ(FD, CarryDate);

  elif(TemplNum == DLGR_TEMPL_PAYCOM) /*éØ´†‚† ™Æ¨®··®©*/
    err = Åì_é°‡†°Æ‚†‚ÏíéØÆäÆ¨®··®Ô¨( FD, CarryDate, NULL, FD.tick.rec.ClientID, false );
    if((not err) and ((CarryDate == FD.tick.rec.DealDate) or (CarryDate == FD.tick.rec.CommDate))) //Ö·´® ·‚‡Æ™† £‡†‰®™† ¢ §†‚„ ·§•´™®, ‚Æ Æ°‡†°†‚Î¢†•¨ ‚†™¶• ™Æ¨®··®®, Æ‚≠Æ·ÔÈ®•·Ô ≠† ‡†·ÂÆ§Î °†≠™† 
      err = Åì_é°‡†°Æ‚†‚ÏíéØÆäÆ¨®··®Ô¨(FD, CarryDate, NULL, {OurBank}, true);
    end;
  elif(TemplNum == DLGR_TEMPL_PAYCOMCONTR) /*éØ´†‚† ™Æ¨®··®© ™´®•≠‚†-™Æ≠‚‡†£•≠‚†*/
    err = Åì_é°‡†°Æ‚†‚ÏíéØÆäÆ¨®··®Ô¨( FD, CarryDate, NULL, FD.tick.rec.PartyID, false );
  elif(TemplNum == DLGR_TEMPL_OFFBALANCE) /*èÆ·‚†≠Æ¢™† ≠† ¢≠•°†´†≠·*/
    err = Åì_èÆ·‚†¢®‚Ïç†Ç≠•°†´†≠·( FD, CarryDate, null, null, null, GrDealID );
  elif(TemplNum == DLGR_TEMPL_BALANCE) /*èÆ·‚†≠Æ¢™† ≠† °†´†≠·*/
    if(Åì_ë≠®¨†‚ÏëÇ≠•°†´†≠·†(FD, CarryDate))
      err = Åì_ë≠Ô‚ÏëÇ≠•°†´†≠·†( FD, CarryDate );
    end;
    if(not err)
      err = Åì_è‡Æ¢Æ§™®èÆ·‚†≠Æ¢™®ç†Å†´†≠·(FD, CarryDate);
    end;
  elif(TemplNum == DLGR_TEMPL_RECCOMPDELIVERY) /*äÆ¨Ø•≠·†Ê®Æ≠≠†Ô ØÆ·‚†¢™†*/
    err = Åì_è‡Æ¢Æ§™®ìÁ•‚†äÆ¨Ø•≠·†Ê®Æ≠≠Æ©èÆ·‚†¢™®(FD, CarryDate, GrDealID);
  elif(TemplNum == DLGR_TEMPL_COMPPAYMENT) /*äÆ¨Ø•≠·†Ê®Æ≠≠Î© Ø´†‚•¶*/
    err = Åì_è‡Æ¢Æ§™®ìÁ•‚†äÆ¨Ø•≠·†Ê®Æ≠≠Æ£Æè´†‚•¶†(FD, CarryDate, GrDealID);
  elif(TemplNum == DLGR_TEMPL_DELAYEDPAY) /*é‚´Æ¶®‚Ï ®·ØÆ´≠•≠®• ÆØ´†‚Î*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_LONGPAY, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_DELAYEDDELIVERY) /*é‚´Æ¶®‚Ï ®·ØÆ´≠•≠®• ØÆ·‚†¢™®*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_LONGSET, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_OVERDUEAVANCE) /*ÇÎ≠Æ· ≠† Ø‡Æ·‡ÆÁ™„ †¢†≠·†*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_OVERDUE_AVANCE, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_OVERDUEPAY) /*ÇÎ≠Æ· ≠† Ø‡Æ·‡ÆÁ™„ ÆØ´†‚Î*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_OVERDUE_PAY, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_OVERDUEDELIVERY) /*ÇÎ≠Æ· ≠† Ø‡Æ·‡ÆÁ™„ ØÆ·‚†¢™®*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_OVERDUE_SET, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_OVERDUEPAY2) /*ÇÎ≠Æ· ≠† Ø‡Æ·‡ÆÁ™„ ÆØ´†‚Î 2Á*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_OVERDUE_PAY, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_OVERDUEDELIVERY2) /*ÇÎ≠Æ· ≠† Ø‡Æ·‡ÆÁ™„ ØÆ·‚†¢™® 2Á*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_OVERDUE_SET, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_OVERDUEAVANCE2) /*ÇÎ≠Æ· ≠† Ø‡Æ·‡ÆÁ™„ †¢†≠·† 2Á*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_OVERDUE_AVANCE, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_PROLONGDELIVERY2) /*è‡Æ´Æ≠£†Ê®Ô ØÆ·‚†¢™® ØÆ 2Á*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_LONGSET, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_PROLONGPAY2) /*è‡Æ´Æ≠£†Ê®Ô ÆØ´†‚Î ØÆ 2Á*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôë‡Æ™Æ¢à·ØÆ´≠•≠®Ô_Ñ´Ôë§•´™®( FD, DEALCALC_ACTION_LONGPAY, CarryDate, CarryDate, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_REJECT) /*é‚™†ß Æ‚ ·§•´™®*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôì·´Æ¢®©( FD, CarryDate, SPTKCHNG_REJECT, GrDealID );
  elif(TemplNum == DLGR_TEMPL_REJECT2) /*é‚™†ß Æ‚ 2Á ·§•´™®*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôì·´Æ¢®©( FD, CarryDate, SPTKCHNG_REJECT2, GrDealID );
  elif(TemplNum == DLGR_TEMPL_CHANGE) /*à≠¨•≠•≠®• „·´Æ¢®©*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôì·´Æ¢®©( FD, CarryDate, SPTKCHNG_CHANGE, GrDealID );
  elif(TemplNum == DLGR_TEMPL_COUP) /*ìÁ•‚ ™„ØÆ≠†*/
    if(IsBUY(FD.Group))
      err = Åì_è‡Æ¢Æ§™®èÆìÁ•‚„ä„ØÆ≠†Çé°‡†‚≠Æ¨ê•ØÆ(FD, CarryDate, GrDealID);
    else
      err = Åì_è‡Æ¢Æ§™®èÆìÁ•‚„ä„ØÆ≠†Çè‡Ô¨Æ¨ê•ØÆ(FD, CarryDate, GrDealID);
    end;
  elif(TemplNum == DLGR_TEMPL_PARTREP) /*ìÁ•‚ óè*/
    if(IsBUY(FD.Group))
      err = Åì_è‡Æ¢Æ§™®èÆìÁ•‚„óèÇé°‡†‚≠Æ¨ê•ØÆ(FD, CarryDate, GrDealID);
    else
      err = Åì_è‡Æ¢Æ§™®èÆìÁ•‚„óèÇè‡Ô¨Æ¨ê•ØÆ(FD, CarryDate, GrDealID);
    end;
  elif(TemplNum == DLGR_TEMPL_RECDELFORTAX) /*èÆ·‚†¢™† §´Ô ≠†´Æ£Æ¢*/
    if(not _IsControlOrg)
    err = Åì_è‡Æ¢Æ§™®èÆìÁÒ‚„èÆ·‚†¢™®Ñ´Ôç†´Æ£Æ¢(FD, CarryDate, GrDealID);
    end;
  elif(TemplNum == DLGR_TEMPL_RECOGNITION_PFI)/*è‡®ß≠†≠®• èîà*/
    err = Åì_è‡®ß≠†≠®•èîà( FD, CarryDate, GrDealID );
  end;

  return err;
end;

macro Åì_ëùÅ_ÇÎØÆ´≠®‚Ïè‡Æ¢Æ§™®èÆë‚‡Æ™•É‡†‰®™†( FD, GrDealID, TemplNum, CarryDate:date ):integer
  var err = 0;
  
  if(TemplNum == DLGR_TEMPL_BALANCE) /*èÆ·‚†≠Æ¢™† ≠† °†´†≠·*/
    if(Åì_ë≠®¨†‚ÏëÇ≠•°†´†≠·†(FD, CarryDate))
      err = Åì_ë≠Ô‚ÏëÇ≠•°†´†≠·†éùÅ( FD, CarryDate, GrDealID );
    end;
    if(not err)
      err = Åì_èÆ·‚†¢®‚Ïç†Å†´†≠·éùÅ( FD, CarryDate, GrDealID );
    end;
  elif(TemplNum == DLGR_TEMPL_PAYMENT) /*éØ´†‚†*/
    if(IsSALE(FD.Group))
      err = Åì_è‡Æ¢Æ§™®éØ´†‚Îê†ß¨•È•≠®ÔéùÅ(FD, CarryDate, GrDealID);
    else
      err = Åì_è‡Æ¢Æ§™®éØ´†‚ÎÇÎ™„Ø†éùÅ(FD, CarryDate, GrDealID);
    end;
  elif(TemplNum == DLGR_TEMPL_RECDELIVERY) /*ìÁ•‚ ØÆ·‚†¢™®*/
    if (FD.tick.rec.BOfficeKind == DL_SECUROWN)
      if(IsSALE(FD.Group))
        err = Åì_è‡Æ¢Æ§™®ìÁ•‚†èÆ·‚†¢™®ê†ß¨•È•≠®ÔéùÅ(FD, CarryDate, GrDealID);
      else
        err = Åì_è‡Æ¢Æ§™®ìÁ•‚†èÆ·‚†¢™®ÇÎ™„Ø†éùÅ(FD, CarryDate, GrDealID);
      end;
    elif(FD.tick.rec.BOfficeKind == DL_RETIREMENT_OWN)
      if(IsRET_ADDINCOME(FD.Group))
          err = Åì_è‡Æ¢Æ§™®ìÁ•‚†èÆ£†Ë•≠®ÔÑÆØÑÆÂÆ§†éùÅ(FD, CarryDate, GrDealID);
      else
      if(IsRET_COUPON(FD.Group))
        err = Åì_è‡Æ¢Æ§™®ìÁ•‚†èÆ£†Ë•≠®Ôä„ØÆ≠†éùÅ(FD, CarryDate, GrDealID);
      else
        err = Åì_è‡Æ¢Æ§™®ìÁ•‚†èÆ£†Ë•≠®ÔéùÅ(FD, CarryDate, GrDealID);
      end;
    end;
    end;
  elif(TemplNum == DLGR_TEMPL_OFFBALANCE) /*èÆ·‚†≠Æ¢™† ≠† ¢≠•°†´†≠·*/
    err = Åì_èÆ·‚†¢®‚Ïç†Ç≠•°†´†≠·éùÅ( FD, CarryDate, 0, GrDealID );
  elif(TemplNum == DLGR_TEMPL_OUTOFFBALANCEOWN) /*ë≠Ô‚®• · ¢≠•°†´†≠·† éùÅ*/
    err = Åì_ë≠Ô‚ÏëÇ≠•°†´†≠·†éùÅ( FD, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_PAYCOM) /*éØ´†‚† ™Æ¨®··®©*/
    if (FD.tick.rec.BOfficeKind == DL_SECUROWN)
      if(IsEXCHANGE(FD.Group))
      if(IsSALE(FD.Group))
        err = Åì_éØ´†‚†äÆ¨®··®©è‡®ê†ß¨•È•≠®®éùÅ( FD, CarryDate, GrDealID );
      else
        err = Åì_éØ´†‚†äÆ¨®··®©è‡®ÇÎ™„Ø•éùÅ( FD, CarryDate, GrDealID );
      end;
      else
        if(IsSALE(FD.Group))
          err = Åì_éØ´†‚†äÆ¨®··®©è‡®Ç≠•°®‡¶ê†ß¨•È•≠®®éùÅ( FD, CarryDate, GrDealID );
        end;
      end;
      end;
  elif(TemplNum == DLGR_TEMPL_PAYCOMOWN) /*éØ´†‚† ™Æ¨®··®©*/
    if(FD.tick.rec.BOfficeKind == DL_RETIREMENT_OWN)
      err = Åì_éØ´†‚†äÆ¨®··®©è‡®èÆ£†Ë•≠®®éùÅ( FD, CarryDate, GrDealID );
    end;
  elif(TemplNum == DLGR_TEMPL_MOVEACC) /*è•‡•≠Æ· ≠† ·Á•‚† "™ ®·ØÆ´≠•≠®Ó"*/
    if((FD.tick.rec.BOfficeKind == DL_RETIREMENT_OWN) and
       IsRET_ADDINCOME(FD.Group))
        err = Åì_è•‡•≠Æ·ç†ëÁ•‚†äà·ØÆ´≠•≠®ÓÑÆØÑÆÂÆ§éùÅ(FD, CarryDate, GrDealID);
    else
      if(IsRET_COUPON(FD.Group))
        err = Åì_è•‡•≠Æ·ç†ëÁ•‚†äà·ØÆ´≠•≠®Óä„ØÆ≠éùÅ( FD, CarryDate, GrDealID );
      elif(IsRET_ISSUE(FD.Group))
        err = Åì_è•‡•≠Æ·ç†ëÁ•‚†äà·ØÆ´≠•≠®ÓèÆ£†Ë•≠®•éùÅ( FD, CarryDate, GrDealID );
      end;
    end;
  elif(TemplNum == DLGR_TEMPL_CHANGE) /*à≠¨•≠•≠®• „·´Æ¢®©*/
    err = Åì_è‡Æ¢Æ§™®àß¨•≠•≠®Ôì·´Æ¢®©éùÅ( FD, CarryDate, GrDealID );
  elif(TemplNum == DLGR_TEMPL_RECPFIOWN) //è‡®ß≠†≠®• èîà Çé
    err = Åì_è‡Æ¢Æ§™®è‡®ß≠†≠®ÔèîàéùÅ( FD, CarryDate, GrDealID );
  end;

  return err;
end;



private macro Åì_ë¢Æ§≠Î•è‡Æ¢Æ§™®èÆä´®•≠‚†¨(dl_comm)
  var err = 0;
  var query, cmd, DataSet;
  var i = 0;
  var dlgrdocCache = RsbSQLInsert("dlgrdoc.dbt");
  var PrevDealID = 0, PrevDealPart = 0, DealPart = 0, GrpID = 0;
  var FD = NULL;
  var Enable = false, stat = 0;

  var TemplsStr = DLGR_TEMPL_TRANSFER + ", " +
                  DLGR_TEMPL_PAYCOMCONTR + ", " +
                  DLGR_TEMPL_DELIVERYCONTR + ", " +    
                  DLGR_TEMPL_DELIVERYCONTR2 + ", " +   
                  DLGR_TEMPL_COMPDELIVERYCONTR;      

  
  GetRegistryValue( MAKE_CARRY_SUMMARY_CLNT, V_BOOL, Enable, stat );
  if( stat != 0 )
     msgbox("éË®°™† Ø‡® ØÆ´„Á•≠®® ß≠†Á•≠®Ô ≠†·‚‡Æ©™® " + MAKE_CARRY_SUMMARY_CLNT);
     return 1;
  elif(Enable == false)
     return 0;
  end;

  è‡Æ¢Æ§™®Åì = SecurAccountingCarry(dl_comm.rec.DocKind, dl_comm.rec.DocumentID);
  
  RslDefCon.BeginTrans();
  
  query =  " select q.*  "
         + "   from "
         + "     (select grdeal.t_ID GrDealID, grdeal.t_PlanDate PlanDate, grdeal.t_TemplNum TemplNum, "
         + "             tk.t_DealID DealID, tk.t_DealCode DealCode, "
         + "             grdeal.t_PlanTime PlanTime, templ.t_Sort Sort, templ.t_Name TemplName, "
         + "             rsi_dlgr.RSI_GetDealPartByGrTemplNum(grdeal.t_TemplNum) as DealPart "
         + "        from ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, ddl_tick_dbt tk, ddl_leg_dbt leg, ddlgracc_dbt bou, ddlgrtempl_dbt templ, doprkoper_dbt koper "
         + "       where grdeal.t_PlanDate = ? /*1*/"
         + "         and grdeal.t_TemplNum NOT IN ("+TemplsStr+") "
         + "         and gracc.t_GrDealID = grdeal.t_ID "
         + "         and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
         + "         and gracc.t_State = " + DLGRACC_STATE_PLAN
         + "         and templ.t_Num = grdeal.t_TemplNum "
         + "         and tk.t_BOfficeKind = grdeal.t_DocKind "
         + "         and tk.t_DealID = grdeal.t_DocID "
         + "         and tk.t_BOfficeKind IN ("+DL_SECURITYDOC+","+DL_RETIREMENT+","+DL_AVRWRT+") "
         + "         and tk.t_ClientID <> -1 "
         + "         and tk.t_Department = ?/*2*/ "
         + "         and Exists (select 1 "
         + "                       from dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi "
         + "                      where grp.t_DocKind = ? /*3*/ "
         + "                        and grp.t_DocID = ? /*4*/ "
         + "                        and grp.t_ErrStatus = 0 "
         + "                        and grpfi.t_GrpID = grp.t_ID "
         + "                        and grpfi.t_FIID = grdeal.t_FIID "
         + "                        and grp.t_Department = tk.t_Department "
         + "                        and grp.t_Party = tk.t_ClientID "
         + "                        and grp.t_Contract = tk.t_ClientContrID"
         + "                        and grp.t_IsSecOwn = CHR(0)) "
         + "         and LEG.T_DEALID = tk.T_DEALID "
         + "         and LEG.T_LEGKIND = " + LEG_KIND_DL_TICK
         + "         and LEG.T_LEGID = 0 "
         + "         and LEG.T_OPERSTATE > " + DL_LEG_PREPARING
         + "         and BOU.T_GRDEALID = grdeal.t_ID "
         + "         and BOU.T_ACCNUM = " + DLGR_ACCKIND_BACKOFFICE
         + "         and BOU.T_STATE != " + DLGRACC_STATE_PLAN
         + "         and koper.t_Kind_Operation = tk.t_DealType "
         + "         and (1 = RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(koper.t_SysTypes)) or ((tk.t_BOfficeKind = " + DL_RETIREMENT + ") and (tk.t_Flag1 = chr(88)))) "
         + "      ) q "
         + "  order by q.PlanDate ASC, q.PlanTime ASC, q.DealCode ASC, q.Sort ASC ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.Division);
  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);

  cmd.AddParam(dl_comm.rec.CommDate);
  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())

    DealPart = int(DataSet.DealPart);

    if((PrevDealID != DataSet.DealID) OR (PrevDealPart != DealPart))
      FD = SPFirstDoc( IIF(DealPart == 2, LEG_KIND_DL_TICK_BACK, LEG_KIND_DL_TICK), DataSet.DealID );
    end;

    è‡Æ¢Æ§™®Åì.SetGrDealData(DataSet.GrDealID, 0, -1, DLGR_SOURCETYPE_CARRYSUMMARY);//ê•†´Ï≠Æ §Æ´¶≠Î ·‰Æ‡¨®‡Æ¢†‚Ï·Ô ‚Æ´Ï™Æ spdocoff ® ≠®™†™®Â Ø‡Æ¢Æ§Æ™
    è‡Æ¢Æ§™®Åì.SetGrDealID(DataSet.GrDealID);
    
    err = Åì_ÇÎØÆ´≠®‚Ïè‡Æ¢Æ§™®èÆë‚‡Æ™•É‡†‰®™†(FD, DataSet.GrDealID, DataSet.TemplNum, date(DataSet.PlanDate));
     
    if(err)
      var bankMsg:RSBankMsg = AL_GetErrorInfo();
      var errMes:string = "éË®°™† Ø‡® Æ°‡†°Æ‚™• ·‚‡Æ™® £‡†‰®™† \""+DataSet.TemplName+"\"";
      var errCode:integer = 1;

      if (bankMsg.Stat != 0)
        errCode = bankMsg.Stat;
        errMes  = errMes + ". "+ bankMsg.Message;
      end;
      
      RepErrArr[RepErrArr.size] = CSC_AccountingRepErr(DataSet.DealCode, errCode, errMes);
    end;

    PrevDealID   = DataSet.DealID;
    PrevDealPart = DealPart;

  end;

  if(not err)
    //·ÆÂ‡†≠®‚Ï spdocoff, Á‚Æ°Î ØÆ ≠®¨ ·‰Æ‡¨®‡Æ¢†‚Ï ·¢Æ§≠Î• Ø‡Æ¢Æ§™®
    err = è‡Æ¢Æ§™®Åì.SaveDocOff();
  end;
         
  è‡Æ¢Æ§™®Åì.SetGrDealData(0, 0, -1, DLGR_SOURCETYPE_CARRYSUMMARY);
  if( (not err) and (Åì_ÇÎØÆ´≠®‚Ïë¢Æ§≠Î•è‡Æ¢Æ§™®(dl_comm.rec.DocKind, dl_comm.rec.DocumentID, 0, true )) )
     err = 1;
  end;   
  
  /*¢·‚†¢´ÔÓ‚·Ô ·¢Ôß™® ·Æ ¢·•¨® Ø‡Æ¢Æ§™†¨®*/
  if(not err)
     err = è‡Æ¢Æ§™®Åì.Execute(RepErrArr);
  end;
  
  /*èÆ ß†¢•‡Ë•≠®® Æ°‡†°Æ‚™®, •·´® ≠• °Î´Æ ÆË®°Æ™, §´Ô ¢·•Â DSPDOCOFF_DBT £§• T_GRPID == DPMWRTGRP_DBT.T_ID ® ·‚†‚„· == "Æ‚´Æ¶•≠" - „·‚†≠Æ¢®‚Ï ·‚†‚„· = "à·ØÆ´≠•≠".*/
       
  if(not err)
     Åì_èÆ·‚†¢®‚Ïà·Øç†é‚´Æ¶ë¢Æ§≠è‡(dl_comm.rec.DocumentID, 0, true);
  end; 
  
  if(err)
    RslDefCon.RollbackTrans(); //é‚™†‚®‚Ï ‚‡†≠ß†™Ê®Ó
  else
    RslDefCon.CommitTrans(); //á†¢•‡Ë®‚Ï ‚‡†≠ß†™Ê®Ó
  end;

  return err;
end; 

PRIVATE MACRO BeginAction( NumAction:@INTEGER, StatusLine:STRING )
  Message( StatusLine );
  UseProgress( NumAction = NumAction + 1 );
END;

MACRO ErrorFromCnvpack( cnv )
  var Cmd, Query, DataSet, err = 0;
  Query = " select t_Error, t_ErrMsg " +
          " from dcnvpack_dbt " +
          " where t_ExecID =  "  + string(cnv.ExecID) + 
          " group by t_Error, t_ErrMsg" ;
 
  Cmd = DL_RSDCommand( Query );      
  
  DataSet = Cmd.Execute();

  while( DataSet.MoveNext() )
    if( DataSet.Error != 0 )      
      err = err + 1;

      if((DataSet.ErrMsg != "") OR (DataSet.Error != 1))
        RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", DataSet.Error, IIF( DataSet.ErrMsg, DataSet.ErrMsg, "" ) );
      end;
    end; 
  end;
  return err;
END;

macro GetStringFIID( ArrErrorFIID:TArray, NErrorFIID )
  var str:string;
  var counter = 0;
   var ArrSize = ArrErrorFIID.Size();
  if( NErrorFIID == 1 )
    str = " ¢ÎØ„·™† ";
  else str = " ¢ÎØ„·™Æ¢ ";
  end;   
  while( counter < ArrSize )
    str = str + èÆ´„Á®‚ÏäÆ§î®≠à≠(ArrErrorFIID[counter]) +  IIF( ( ArrSize == counter + 1), " ", ", " );
    counter = counter + 1; 
    end;
   if( NErrorFIID > 5 ) 
    str = str + " ¢·•£Æ " + string( NErrorFIID );
  end;
  return str;  
end;

macro è‡Æ¢•‡®‚Ïç•Æ°ÂÆ§®¨Æ·‚Ïé‚™†‚†(FIID:integer, Department:integer, Party:integer, Contract:integer, IsSecOwn:string, CommDate:DATE, DocumentID:INTEGER)
  var query, cmd;
  var cnt = 0;

  query =   " select 1 "
          + "   from dpmwrtgrp_dbt grp, dpmwrtgrpfi_dbt grpfi, ddl_comm_dbt comm "
          + "  where comm.t_DocKind = " + DL_SëACCOUNTING
          + "    and comm.t_CommDate = ? "
          + "    and comm.t_DocumentID <> ? " 
          + "    and grp.t_DocKind = comm.t_DocKind "
          + "    and grp.t_DocID = comm.t_DocumentID "
          + "    and grpfi.t_GrpID = grp.t_ID "
          + "    and grpfi.t_FIID = ? "
          + "    and grp.t_Department = ? "
          + "    and grp.t_Party = ? "
          + "    and grp.t_Contract = ? "
          + "    and grp.t_IsSecOwn = ? ";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(CommDate);
  cmd.AddParam(DocumentID);
  cmd.AddParam(FIID);
  cmd.AddParam(Department);
  cmd.AddParam(Party);
  cmd.AddParam(Contract);
  cmd.AddParam(IsSecOwn);

  cnt = cmd.GetCount();
  return cnt;
end;

macro á†≠•·‚®Ç‡•¨ÔÇë‚‡Æ™®É‡†‰®™Æ¢(dl_comm:variant)

  var sql, exec, DataSet, Msgtxt = "", DealCodes = "", AddWhere = "", Eq = "", AddTable = "";

  macro é°≠Æ¢®‚ÏÇ‡•¨ÔèÆèÆ·‚†¢™†¨èÆó†·‚®(DealPart:integer)
     //á†≠•·‚® ¢‡•¨Ô ¢ ·‚‡Æ™® £‡†‰®™Æ¢
     sql =  "DECLARE "

          + "  TYPE time_t IS TABLE OF DDL_LEG_DBT.T_SUPPLYTIME%TYPE; "
          + "  TYPE grdealid_t IS TABLE OF DDLGRDEAL_DBT.T_ID%TYPE; "

          + "  v_time       time_t; "
          + "  v_GrDealID   grdealid_t; "
          + "BEGIN "
          + "  SELECT /*+ ordered index(GrDeal DDLGRDEAL_DBT_IDX5) index(TICK DDL_TICK_DBT_IDX0) index(LEG DDL_LEG_DBT_IDX2) */ GrDeal.t_ID, Leg.T_SUPPLYTIME "
          + "    BULK COLLECT INTO v_GrDealID, v_time "
          + "    FROM DDLGRDEAL_DBT GrDeal, DDL_TICK_dbt Tick, DDL_LEG_dbt Leg,  DDLGRTEMPL_DBT Templ " +AddTable
          + "   WHERE GrDeal.t_DocKind = Tick.T_BOFFICEKIND "
          + "     AND GrDeal.t_DocID = Tick.T_DEALID "
          + "     AND GrDeal.T_PLANDATE = ? "
          + "     AND Leg.T_DEALID = Tick.T_DEALID "
          + "     AND Leg.T_LEGKIND = ? "
          + "     AND (   Exists(Select 1 from DDLGRACC_DBT GrAcc"
          + "                     Where GrAcc.T_GRDEALID = GrDeal.t_ID "
          + "                       AND GrAcc.T_ACCNUM = " + DLGR_ACCKIND_ACCOUNTING 
          + "                       AND (GrAcc.T_STATE = "+DLGRACC_STATE_NOTNEED+" or GrAcc.T_STATE = "+DLGRACC_STATE_PLAN+")) "
          + "          OR NOT Exists(Select 1 from DDLGRACC_DBT GrAcc"
          + "                         Where GrAcc.T_GRDEALID = GrDeal.t_ID "
          + "                           AND GrAcc.T_ACCNUM = " + DLGR_ACCKIND_ACCOUNTING 
          + "                       ) "
          + "         )"
          + "     AND Templ.T_NUM = GrDeal.T_TEMPLNUM "
          + "     AND Templ.t_DateKind = ? "
          + AddWhere + ";"

          + "  IF v_GrDealID.COUNT > 0 THEN "
          + "    FORALL i IN v_GrDealID.first .. v_GrDealID.last "
          + "      UPDATE DDLGRDEAL_DBT GrDeal "
          + "         SET GrDeal.T_PLANTIME = v_Time(i) "
          + "       WHERE GrDeal.t_ID = v_GrDealID(i); "
          + "  END IF; "
          + "END; ";
      
     exec = RSDCommand(sql);
    
     exec.addParam( "", RSDBP_IN, dl_comm.rec.CommDate );
     exec.addParam( "", RSDBP_IN, iif(DealPart==1,LEG_KIND_DL_TICK,LEG_KIND_DL_TICK_BACK) );
     exec.addParam( "", RSDBP_IN, iif(DealPart==1,DLGR_DATEKIND_DELIVERY,DLGR_DATEKIND_DELIVERY2) );
    
     exec.execute();
  end;

  if( dl_comm.rec.Flag1 != SET_CHAR )
     Eq = " = ";
  else
     Eq = " != ";
  end;

  AddWhere = "";
  AddTable = "";

  if( (dl_comm.rec.FlagSecur == SET_CHAR) and (dl_comm.rec.FlagSecurOwn == SET_CHAR) )
     AddWhere = AddWhere + " and (Tick.t_BOfficeKind IN ("+DL_SECURITYDOC+","+DL_RETIREMENT+","+DL_AVRWRT+") or "
                         + "      Tick.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+","+DL_RETIREMENT_OWN+") "
                         + "     )";
  elif( dl_comm.rec.FlagSecur == SET_CHAR )
     AddWhere = AddWhere + " and Tick.t_BOfficeKind IN ("+DL_SECURITYDOC+","+DL_RETIREMENT+","+DL_AVRWRT+") ";
  elif( dl_comm.rec.FlagSecurOwn == SET_CHAR )
     AddWhere = AddWhere + " and Tick.t_BOfficeKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+","+DL_RETIREMENT_OWN+") ";
  end;

  if(dl_comm.rec.ClientID > -1)
    if( (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank}) )
      AddWhere = AddWhere + " and Tick.t_ClientID = -1 ";                                  
    else
      AddWhere = AddWhere + " and Tick.t_ClientID "+Eq+string(dl_comm.rec.ClientID);                                  
    end;
  else
    AddWhere = AddWhere + " and Tick.t_ClientID != -1 ";     
  end;
                                                                                              
  if( dl_comm.rec.ContractID > 0 )                                                            
     AddWhere = AddWhere + " and Tick.t_ClientContrID "+Eq+string(dl_comm.rec.ContractID);                             
  end;                                                                                        
                                                                                              
  if( dl_comm.rec.FIID > -1 )                                                                  
     AddTable = ", DFININSTR_DBT fin ";
     AddWhere = AddWhere 
               + " AND fin.t_FIID = GrDeal.t_FIID "
               + " AND GrDeal.t_FIID "+Eq+string(dl_comm.rec.FIID);                                    
  elif( dl_comm.rec.AvoirKind > 0 )                                                           
     AddTable = ", DFININSTR_DBT fin ";
     AddWhere = AddWhere
               + " AND fin.t_FIID = GrDeal.t_FIID "
               + " AND RSB_FIInstr.FI_AvrKindsEQ( "+string(FIKIND_AVOIRISS)+", "+dl_comm.rec.AvoirKind+", fin.t_AvoirKind) "+Eq+" 1 ";
  end;                                                                                        
                                                                                              
  if( dl_comm.rec.Currency > -1 )
     if( AddTable == "" )                                                         
        AddTable = ", DFININSTR_DBT fin ";
        AddWhere = AddWhere
                  + " AND fin.t_FIID = GrDeal.t_FIID ";
     end;
     AddWhere = AddWhere
               + " AND fin.t_FaceValueFI "+Eq+string(dl_comm.rec.Currency);                                
  end;                                                                                        

  if(dl_comm.rec.OperSubKind > 0)
    AddWhere = AddWhere + " and Tick.t_DealType = "+string(dl_comm.rec.OperSubKind);
  elif( dl_comm.rec.ContractKind > 0 )
    if(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_EXCHANGE)
      AddWhere = AddWhere + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 1 ";
    elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OUTEXCHANGE)
      AddWhere = AddWhere + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 1 ";
    elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OTHER)
      AddWhere = AddWhere + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 0 "
                    + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 0 ";
    end;
  end;

  //á†≠•·‚® ¢‡•¨Ô ¢ ·‚‡Æ™® £‡†‰®™Æ¢
  sql =  "DECLARE "
       + "  TYPE time_t IS TABLE OF DDL_TICK_DBT.T_DEALTIME%TYPE; "
       + "  TYPE grdealid_t IS TABLE OF DDLGRDEAL_DBT.T_ID%TYPE; "

       + "  v_time       time_t; "
       + "  v_GrDealID   grdealid_t; "
       + "BEGIN "
       + "  SELECT /*+ ordered index(GrDeal DDLGRDEAL_DBT_IDX5) index(GrAcc DLGRACC_DBT_IDX1) index(TICK DDL_TICK_DBT_IDX0)) */ GrDeal.t_ID, Tick.T_DEALTIME "
       + "    BULK COLLECT INTO v_GrDealID, v_time "
       + "    FROM DDLGRDEAL_DBT GrDeal,DDLGRACC_DBT GrAcc, DDL_TICK_dbt Tick, DDLGRTEMPL_DBT Templ " +AddTable
       + "   WHERE GrDeal.t_DocKind = Tick.T_BOFFICEKIND "
       + "     AND GrDeal.t_DocID = Tick.T_DEALID "
       + "     AND GrDeal.T_PLANDATE = ? "
       + "     AND GrAcc.T_GRDEALID = GrDeal.t_ID "
       + "     AND GrAcc.T_ACCNUM =  ? " 
       + "     AND (GrAcc.T_STATE = ? or GrAcc.T_STATE = ?) "
       + "     AND Templ.T_NUM = GrDeal.T_TEMPLNUM "
       + "     AND Templ.t_DateKind not in (?,?,?) "
       + AddWhere+ " ;"

       + "  IF v_GrDealID.COUNT > 0 THEN "
       + "    FORALL i IN v_GrDealID.first .. v_GrDealID.last "
       + "      UPDATE DDLGRDEAL_DBT GrDeal "
       + "         SET GrDeal.T_PLANTIME = v_Time(i) "
       + "       WHERE GrDeal.t_ID = v_GrDealID(i); "
       + "  END IF; "

       + "END; ";
   
  exec = RSDCommand(sql);

  exec.addParam( "", RSDBP_IN, dl_comm.rec.CommDate );
  exec.addParam( "", RSDBP_IN, DLGR_ACCKIND_ACCOUNTING );
  exec.addParam( "", RSDBP_IN, DLGRACC_STATE_NOTNEED );
  exec.addParam( "", RSDBP_IN, DLGRACC_STATE_PLAN );
  exec.addParam( "", RSDBP_IN, DLGR_DATEKIND_CALC );
  exec.addParam( "", RSDBP_IN, DLGR_DATEKIND_DELIVERY );
  exec.addParam( "", RSDBP_IN, DLGR_DATEKIND_DELIVERY2 );

  exec.execute();

  é°≠Æ¢®‚ÏÇ‡•¨ÔèÆèÆ·‚†¢™†¨èÆó†·‚®(1);
  é°≠Æ¢®‚ÏÇ‡•¨ÔèÆèÆ·‚†¢™†¨èÆó†·‚®(2);

  sql =   " SELECT distinct Tick.t_DealCode "
        + "   FROM DDL_TICK_dbt Tick, DDL_LEG_dbt Leg, DDLGRDEAL_DBT GrDeal, DDLGRACC_DBT GrAcc " +AddTable
        + "  WHERE GrDeal.t_DocKind = Tick.T_BOFFICEKIND "
        + "    AND GrDeal.t_DocID = Tick.T_DEALID "
        + "    AND Leg.T_DEALID = Tick.T_DEALID "
        + "    AND Leg.T_LEGKIND = ? "
        + "    AND GrAcc.T_GRDEALID = GrDeal.t_ID "
        + "    AND GrAcc.T_ACCNUM =  ? " 
        + "    AND (GrAcc.T_STATE = ? or GrAcc.T_STATE = ?) "
        + "    AND GrDeal.T_PLANDATE = ? "
        + "    AND GrDeal.T_TEMPLNUM in(?,?,?,?,?) "
        + "    AND (GrDeal.T_PLANDATE < (case when RSB_SECUR.IsLoan(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 1 "
        + "                                   then Leg.t_Maturity "
        + "                                   else (case when Leg.t_MaturityIsPrincipal = 'X' then Leg.t_Maturity else Leg.t_Expiry end) "
        + "                              end) or "
        + "         (GrDeal.T_PLANDATE = (case when RSB_SECUR.IsLoan(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 1 "
        + "                                   then Leg.t_Maturity "
        + "                                   else (case when Leg.t_MaturityIsPrincipal = 'X' then Leg.t_Maturity else Leg.t_Expiry end) "
        + "                              end) and GrDeal.T_PLANTIME <= Leg.T_SUPPLYTIME) "
        + "        ) "
        + AddWhere;
   
  exec = RSDCommand(sql);

  exec.addParam( "", RSDBP_IN, LEG_KIND_DL_TICK );
  exec.addParam( "", RSDBP_IN, DLGR_ACCKIND_ACCOUNTING );
  exec.addParam( "", RSDBP_IN, DLGRACC_STATE_NOTNEED );
  exec.addParam( "", RSDBP_IN, DLGRACC_STATE_PLAN );
  exec.addParam( "", RSDBP_IN, dl_comm.rec.CommDate );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COUP );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_PARTREP );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COMPDELIVERY );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COMPDELIVERYCONTR );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COMPPAYMENT );

  exec.execute();

  DataSet = TRsbDataSet(exec);
  if( DataSet.MoveNext() )
     DealCodes = DataSet.DealCode;
     while(DataSet.MoveNext())
        DealCodes = DealCodes + ", "+string(DataSet.DealCode);
     end;
     Msgtxt = "èÆ ·§•´™†¨ "+DealCodes+" §†‚†/¢‡•¨Ô „Á•‚≠ÎÂ §•©·‚¢®© ¨•≠ÏË• §†‚Î/¢‡•¨•≠® ®·ØÆ´≠•≠®Ô Ø•‡¢ÎÂ Á†·‚•© ·§•´Æ™.";
     msgbox(Msgtxt);
     if( GetTrue( false, Msgtxt + " é·‚†≠Æ¢®‚Ï ¢ÎØÆ´≠•≠®• ÆØ•‡†Ê®®?" ) != false)
       return 1;
     end;   
  end;

  sql =   " SELECT distinct Tick.t_DealCode "
        + "   FROM DDL_TICK_dbt Tick, DDL_LEG_dbt Leg, DDLGRDEAL_DBT GrDeal, DDLGRACC_DBT GrAcc " +AddTable
        + "  WHERE GrDeal.t_DocKind = Tick.T_BOFFICEKIND "
        + "    AND GrDeal.t_DocID = Tick.T_DEALID "
        + "    AND Leg.T_DEALID = Tick.T_DEALID "
        + "    AND Leg.T_LEGKIND = ? "
        + "    AND GrAcc.T_GRDEALID = GrDeal.t_ID "
        + "    AND GrAcc.T_ACCNUM =  ? " 
        + "    AND (GrAcc.T_STATE = ? or GrAcc.T_STATE = ?) "
        + "    AND GrDeal.T_PLANDATE = ? "
        + "    AND GrDeal.T_TEMPLNUM in(?,?,?,?,?) "
        + "    AND (GrDeal.T_PLANDATE > (case when RSB_SECUR.IsLoan(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 1 "
        + "                                   then Leg.t_Expiry "
        + "                                   else (case when Leg.t_MaturityIsPrincipal = 'X' then Leg.t_Maturity else Leg.t_Expiry end) "
        + "                              end) or "
        + "         (GrDeal.T_PLANDATE = (case when RSB_SECUR.IsLoan(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(Tick.t_DealType, Tick.t_BofficeKind))) = 1 "
        + "                                   then Leg.t_Expiry "
        + "                                   else (case when Leg.t_MaturityIsPrincipal = 'X' then Leg.t_Maturity else Leg.t_Expiry end) "
        + "                              end) and GrDeal.T_PLANTIME >= Leg.T_SUPPLYTIME) "
        + "        ) "
        + AddWhere;
   
  exec = RSDCommand(sql);

  exec.addParam( "", RSDBP_IN, LEG_KIND_DL_TICK_BACK );
  exec.addParam( "", RSDBP_IN, DLGR_ACCKIND_ACCOUNTING );
  exec.addParam( "", RSDBP_IN, DLGRACC_STATE_NOTNEED );
  exec.addParam( "", RSDBP_IN, DLGRACC_STATE_PLAN );
  exec.addParam( "", RSDBP_IN, dl_comm.rec.CommDate );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COUP );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_PARTREP );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COMPDELIVERY );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COMPDELIVERYCONTR );
  exec.addParam( "", RSDBP_IN, DLGR_TEMPL_COMPPAYMENT );

  exec.execute();

  DataSet = TRsbDataSet(exec);
  if( DataSet.MoveNext() )
     DealCodes = DataSet.DealCode;
     while(DataSet.MoveNext())
        DealCodes = DealCodes + ", "+string(DataSet.DealCode);
     end;
     Msgtxt = "èÆ ·§•´™†¨ "+DealCodes+" §†‚†/¢‡•¨Ô „Á•‚≠ÎÂ §•©·‚¢®© °Æ´ÏË• §†‚Î/¢‡•¨•≠® ®·ØÆ´≠•≠®Ô ¢‚Æ‡ÎÂ Á†·‚•© ·§•´Æ™.";        
     msgbox(Msgtxt);
     if( GetTrue( false, Msgtxt + " é·‚†≠Æ¢®‚Ï ¢ÎØÆ´≠•≠®• ÆØ•‡†Ê®®?" ) != false)
       return 1;
     end;   
  end;

  return 0;

  OnError(er)
    var err_text = GetFullErrorMessage(er);
    if(isEqClass("TRsdError", er.err))
      MsgBox(err_text);
      RunError(err_text);
    else
      MsgBox("éË®°™† Æ°≠Æ¢´•≠®Ô ¢‡•¨•≠® ¢ ·‚‡Æ™†Â £‡†‰®™Æ¢: "+err_text);
    end;
    return 1;
end;

private macro ë‰Æ‡¨®‡Æ¢†‚ÏÉ‡„ØØÎé°‡†°Æ‚™®(dl_comm)
  var cnt = 0;
  var query, cmd, DataSet;
  var ArrErrorFIID = TArray();
  var counter = 0;
  var NErrorFIID = 0;

  var isOurBank = (dl_comm.rec.Flag5 == SET_CHAR) or (dl_comm.rec.ClientID == {OurBank});

  InitProgress(7, "èÆ§£Æ‚Æ¢™† £‡„ØØ Æ°‡†°Æ‚™®", "èÆ§£Æ‚Æ¢™† £‡„ØØ Æ°‡†°Æ‚™®");

  SQL_Execute(" DELETE FROM DPMWRTGRP_TMP ", null, false );

  cmd = DL_RSDCommand();

  query =   "DECLARE "
          + "  TYPE grptmp_t IS TABLE OF DPMWRTGRP_TMP%ROWTYPE INDEX BY BINARY_INTEGER; "
          + "  v_grptmp grptmp_t; "
          + "BEGIN "

          + " select ?, ?, q.FIID, q.Department, q.ClientID, q.ClientContrID, q.IsSecOwn, q.DealID, q.GrDealID, "
          + "        (case when q.TemplNum IN ("+DeliveryTemplsStr+") then 1 else 2 end) as Type"
          + "  BULK COLLECT INTO v_grptmp "
          + "   from (";

  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);

  if(dl_comm.rec.FlagSecur == SET_CHAR)        
    query = query + "        (select /*+ leading(grdeal) INDEX(grdeal DDLGRDEAL_DBT_IDX3)*/ grdeal.t_FIID FIID, "
                  + "                grdeal.t_ID as GrDealID, "
                  + "                grdeal.t_TemplNum as TemplNum, "
                  + "                tk.t_Department Department, "
                  + "                tk.t_ClientID ClientID, "
                  + "                tk.t_ClientContrID ClientContrID, "
                  + "                CHR(0) as IsSecOwn, "
                  + "                tk.t_DealType as Kind_Operation, " 
                  + "                tk.t_BOfficeKind as BOfficeKind, "
                  + "                tk.t_DealID as DealID "
                  + "           from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal "
                  + "          where grdeal.t_DocKind IN ("+DL_SECURITYDOC+","+DL_RETIREMENT+","+DL_AVRWRT+") "
                  + "            and grdeal.t_PlanDate = ? "
                  + "            and grdeal.t_TemplNum NOT IN ("+CCTemplsStr+")"
                  + "            and grdeal.t_TemplNum NOT IN ("+ExcludeTemplStr+")"
                  + "            and Not Exists(select /*+INDEX(gracc ddlgracc_dbt_idx1)*/ 1 "
                  + "                             from ddlgracc_dbt gracc "
                  + "                            where gracc.t_GrDealID = grdeal.t_ID "
                  + "                              and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                  + "                              and gracc.t_State = " + DLGRACC_STATE_FACTEXEC //ÑÆ°†¢´Ô•¨ ¢·•, ™‡Æ¨• Æ°‡†°Æ‚†≠≠ÎÂ, ¢ ‚.Á. ® ≠• ‚‡•°„ÓÈ®•·Ô, Á‚Æ°Î ØÆØ†´® ·‚‡Æ™® ìÁ•‚èÆ·‚†¢™®
                  + "                          ) "
                  + "            and tk.t_DealID = grdeal.t_DocID "
                  + "            and tk.t_Department = ? ";
     cmd.AddParam(dl_comm.rec.CommDate);
     cmd.AddParam(dl_comm.rec.Division);
     
     if(dl_comm.rec.OperSubKind > 0)
       query = query + " and tk.t_DealType = ? ";
       cmd.AddParam(dl_comm.rec.OperSubKind);
     end;

     query = query + "        ) UNION ALL "
                   + "        (select /*+ leading(grdeal) INDEX(grdeal DDLGRDEAL_DBT_IDX3)*/ grdeal.t_FIID FIID, "
                   + "                grdeal.t_ID as GrDealID, "
                   + "                grdeal.t_TemplNum as TemplNum, "
                   + "                tk.t_Department Department, "
                   + "                tk.t_PartyID ClientID, "
                   + "                tk.t_PartyContrID ClientContrID, "
                   + "                CHR(0) as IsSecOwn, "
                   + "                tk.t_DealType as Kind_Operation, " 
                   + "                tk.t_BOfficeKind as BOfficeKind, "
                   + "                tk.t_DealID as DealID "
                   + "           from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal "
                   + "          where grdeal.t_DocKind = "+DL_SECURITYDOC
                   + "            and grdeal.t_PlanDate = ? "
                   + "            and grdeal.t_TemplNum IN ("+CCTemplsStr+")"
                   + "            and grdeal.t_TemplNum NOT IN ("+ExcludeTemplStr+")"
                   + "            and Not Exists(select /*+INDEX(gracc ddlgracc_dbt_idx1)*/ 1 "
                   + "                             from ddlgracc_dbt gracc "
                   + "                            where gracc.t_GrDealID = grdeal.t_ID "
                   + "                              and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                   + "                              and gracc.t_State = " + DLGRACC_STATE_FACTEXEC //ÑÆ°†¢´Ô•¨ ¢·•, ™‡Æ¨• Æ°‡†°Æ‚†≠≠ÎÂ, ¢ ‚.Á. ® ≠• ‚‡•°„ÓÈ®•·Ô, Á‚Æ°Î ØÆØ†´® ·‚‡Æ™® ìÁ•‚èÆ·‚†¢™®
                   + "                          ) "
                   + "            and tk.t_DealID = grdeal.t_DocID "
                   + "            and tk.t_IsPartyClient = 'X' "
                   + "            and tk.t_Department = ? ";
    
    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);

    if(dl_comm.rec.OperSubKind > 0)
      query = query + " and tk.t_DealType = ? ";
      cmd.AddParam(dl_comm.rec.OperSubKind);
    end;

    query = query + "        ) ";

  end;       

  if(dl_comm.rec.FlagSecurOwn == SET_CHAR)
    if(dl_comm.rec.FlagSecur == SET_CHAR)        
      query = query + "      UNION ALL ";
    end;

    query = query + "        (select /*+ leading(grdeal) INDEX(grdeal DDLGRDEAL_DBT_IDX3)*/ grdeal.t_FIID FIID, "
                  + "                grdeal.t_ID as GrDealID, "
                  + "                grdeal.t_TemplNum as TemplNum, "
                  + "                tk.t_Department Department, "
                  + "                tk.t_ClientID ClientID, "
                  + "                tk.t_ClientContrID ClientContrID, "
                  + "                CHR(88) as IsSecOwn, "
                  + "                tk.t_DealType as Kind_Operation, " 
                  + "                tk.t_BOfficeKind as BOfficeKind, "
                  + "                tk.t_DealID as DealID "
                  + "           from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal "
                  + "          where grdeal.t_DocKind IN ("+DL_SECUROWN+","+DL_AVRWRTOWN+","+DL_RETIREMENT_OWN+") "
                  + "            and grdeal.t_PlanDate = ? "
                  + "            and grdeal.t_TemplNum NOT IN ("+CCTemplsStr+")"
                  + "            and grdeal.t_TemplNum NOT IN ("+ExcludeTemplStr+")"
                  + "            and Not Exists(select /*+INDEX(gracc ddlgracc_dbt_idx1)*/ 1 "
                  + "                             from ddlgracc_dbt gracc "
                  + "                            where gracc.t_GrDealID = grdeal.t_ID "
                  + "                              and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
                  + "                              and gracc.t_State = " + DLGRACC_STATE_FACTEXEC //ÑÆ°†¢´Ô•¨ ¢·•, ™‡Æ¨• Æ°‡†°Æ‚†≠≠ÎÂ, ¢ ‚.Á. ® ≠• ‚‡•°„ÓÈ®•·Ô, Á‚Æ°Î ØÆØ†´® ·‚‡Æ™® ìÁ•‚èÆ·‚†¢™®
                  + "                          ) "
                  + "            and tk.t_DealID = grdeal.t_DocID "
                  + "            and tk.t_Department = ? ";
    
    cmd.AddParam(dl_comm.rec.CommDate);
    cmd.AddParam(dl_comm.rec.Division);

    if(dl_comm.rec.OperSubKind > 0)
      query = query + " and tk.t_DealType = ? ";
      cmd.AddParam(dl_comm.rec.OperSubKind);
    end;

    query = query + "        ) ";
  end;

  query = query + "        ) q, dfininstr_dbt fin "
                + "  where fin.t_FIID = q.FIID ";

  
  if(dl_comm.rec.ClientID > -1)
    if( isOurBank )
      query = query + " and q.ClientID = ? ";
      cmd.AddParam(-1);
    else
      query = query + " and q.ClientID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
      cmd.AddParam(dl_comm.rec.ClientID);
    end;
  else
    query = query + " and q.ClientID <> ? ";
    cmd.AddParam(-1);
  end;

  if(dl_comm.rec.ContractID > 0)
    query = query + " and q.ClientContrID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
    cmd.AddParam(dl_comm.rec.ContractID);
  end;

  if(dl_comm.rec.AvoirKind > 0)
    query = query + " AND 1 "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", ?, fin.t_AvoirKind) ";
    cmd.AddParam(dl_comm.rec.AvoirKind); 
  end;

  if(dl_comm.rec.FIID > -1)
    query = query + " AND fin.t_FIID "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
    cmd.AddParam(dl_comm.rec.FIID);
  end;

  if(dl_comm.rec.Currency > -1)
    query = query + " AND fin.t_FaceValueFI "+IIF(dl_comm.rec.Flag1 == SET_CHAR, "<>", "=")+" ? ";
    cmd.AddParam(dl_comm.rec.Currency);
  end;

  if((dl_comm.rec.ContractKind > 0) and (dl_comm.rec.OperSubKind <= 0))
    if(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_EXCHANGE)
      query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(q.Kind_Operation, q.BofficeKind))) = 1 ";
    elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OUTEXCHANGE)
      query = query + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(q.Kind_Operation, q.BofficeKind))) = 1 ";
    elif(dl_comm.rec.ContractKind == SC_ACCOPERTYPE_OTHER)
      query = query + " AND RSB_SECUR.ISEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(q.Kind_Operation, q.BofficeKind))) = 0 "
                    + " AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(q.Kind_Operation, q.BofficeKind))) = 0 ";
    end;
  end;

  query = query + ";";
  
  query = query + " IF v_grptmp.COUNT > 0 THEN "
                + "   FORALL indx IN v_grptmp.FIRST .. v_grptmp.LAST "
                + "    INSERT INTO dpmwrtgrp_tmp "
                + "    VALUES v_grptmp (indx); "
                + " END IF; ";

  query = query + "END; ";
 
  cmd.ExecuteCMD(query);

  UseProgress(1);
  
  query =   " select distinct t_DocKind, t_DocID, t_FIID, t_Department, t_Party, t_Contract, t_IsSecOwn "
          + "   from dpmwrtgrp_tmp where t_Party = -1 ";

  cmd = DL_RSDCommand();

  DataSet = cmd.Execute(query);

  while( DataSet.moveNext() )
    if( è‡Æ¢•‡®‚Ïç•Æ°ÂÆ§®¨Æ·‚Ïé‚™†‚†(DataSet.FIID, DataSet.Department, DataSet.Party, DataSet.Contract, DataSet.IsSecOwn, dl_comm.rec.CommDate, dl_comm.rec.DocumentID) > 0 )
      NErrorFIID = NErrorFIID + 1;  
      if( NErrorFIID <= 5 )
        ArrErrorFIID.Size = counter;                  
        ArrErrorFIID[counter] = DataSet.FIID; 
        counter = counter + 1;                     
      end;                          
    end;          
  end;

  if( NErrorFIID > 0 )
    if( GetTrue( false, "Ñ´Ô" + GetStringFIID( ArrErrorFIID, NErrorFIID )+" ¢ §†‚„ "+string(dl_comm.rec.CommDate:f)+" „¶• •·‚Ï ®·ØÆ´≠•≠≠†Ô ÆØ•‡†Ê®Ô ‰Æ‡¨®‡Æ¢†≠®Ô Åì. è‡Æ§Æ´¶®‚Ï Æ°‡†°Æ‚™„?" ) == false)
      return 0;
    end;   
  end;

  UseProgress(2); 
      
  if( á†≠•·‚®Ç‡•¨ÔÇë‚‡Æ™®É‡†‰®™Æ¢(dl_comm) )
     return 1;
  end;

  UseProgress(3);

  RslDefCon.BeginTrans();

  //Ç Æ§≠Æ© £‡„ØØ• Æ§≠† îà, •·´® Ì‚Æ £‡„ØØ† ç†Ë•£ÆÅ†≠™†, ≠Æ §´Ô °†≠™† ·§•´Æ™ >= å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîàëÆ°·‚¢ ®´® ™´®•≠‚·™†Ô, ≠Æ §´Ô ™´®•≠‚† ·§•´Æ™ >= å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà
  //Ç†¶§Æ© ØÆ§£‡„ØØ• Ø‡Æ¢Æ§Æ™ ™Æ´®Á·‚¢Æ ·‚‡Æ™ £‡†‰®™† ¢ ß†¢®·®¨Æ·‚® Æ‚ ß≠†Á•≠®Ô äÆ´®Áë‚‡Æ™É‡†‰®™†ÇèÆ§£‡„ØØ•
  query =   "DECLARE "
          + "  v_GrpID    NUMBER; "
          + "  v_SubGrpID NUMBER; "
          + "  v_Cnt      NUMBER; "
          + "  v_Rest     NUMBER; "
          + "  v_AddCount NUMBER := 0;"
          + "  v_PrevDealid DPMWRTGRP_TMP.T_DEALID%TYPE := 0;"
          + "  v_bufStep  NUMBER := 0;"
          + "  v_Step     NUMBER := "+äÆ´®Áë‚‡Æ™É‡†‰®™†ÇèÆ§£‡„ØØ•+"; "

          + "  TYPE subdoc_t IS TABLE OF DPMWRTSUBDOC_DBT%ROWTYPE INDEX BY BINARY_INTEGER; "
          + "  v_subdoc subdoc_t; "

          + "  TYPE grprec_t IS TABLE OF DPMWRTGRP_TMP%ROWTYPE; "
          + "  v_grprec grprec_t; "
          + "  v_grprecBuf grprec_t := grprec_t(); "
          + "  v_grprecToIns grprec_t :=  grprec_t(); "

          + "  v_Cursor SYS_REFCURSOR; "

          + "BEGIN ";

  if (isOurBank and (not ê†ß°®¢†‚ÏÇ≠„‚‡®î®ëÆ°·‚¢))
        query = query
          + "  v_Step := 999999999; ";
  elif ((not isOurBank) and (å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà == 0))
        query = query
          + "  v_Step := 999999999; ";
  end;
        query = query
          + "  SELECT greatest(NVL(MAX (t_grdealcount), 100),v_Step) into v_Step  "
          + " FROM (  SELECT tmp.T_DEALID, COUNT (T_GRDEALID) AS t_grdealcount "
          + "           FROM DPMWRTGRP_TMP tmp "
          + "          WHERE tmp.T_TYPE = "+SUBGRP_TYPE_CARRY+" "
          + "       GROUP BY TMP.T_DOCKIND, "
          + "                TMP.T_DOCID, "
          + "                TMP.T_DEPARTMENT, "
          + "                TMP.T_PARTY, "
          + "                TMP.T_CONTRACT, "
          + "                TMP.T_ISSECOWN, "
          + "                TMP.T_FIID, "
          + "                tmp.T_DEALID) q1; ";
          
        query = query
          + "  FOR one_tmp IN (SELECT DISTINCT TMP.T_DOCKIND, TMP.T_DOCID, TMP.T_DEPARTMENT, TMP.T_PARTY, TMP.T_CONTRACT, TMP.T_ISSECOWN, TMP.T_FIID "
          + "                    FROM DPMWRTGRP_TMP TMP "
          + "                   WHERE TMP.T_DOCKIND = ? " 
          + "                     AND TMP.T_DOCID = ? ";
  if( isOurBank )
    query = query + " AND TMP.T_PARTY = -1 ";
  else
    if (å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà > 0)
      query = query
            + "                      AND TMP.T_PARTY > 0 "
            + "                      AND EXISTS (SELECT 1 "
            + "                                                                          FROM DPMWRTGRP_TMP TMP1 "
            + "                                                                         WHERE TMP1.T_DOCKIND    = TMP.T_DOCKIND "
            + "                                                                           AND TMP1.T_DOCID      = TMP.T_DOCID "
            + "                                                                           AND TMP1.T_DEPARTMENT = TMP.T_DEPARTMENT "
            + "                                                                           AND TMP1.T_PARTY      = TMP.T_PARTY "
            + "                                                                           AND TMP1.T_CONTRACT   = TMP.T_CONTRACT "
            + "                                                                           AND TMP1.T_ISSECOWN   = TMP.T_ISSECOWN "
            + "                                   GROUP BY TMP1.T_DOCKIND, TMP1.T_DOCID, TMP1.T_DEPARTMENT, TMP1.T_PARTY, TMP1.T_CONTRACT, TMP1.T_ISSECOWN, TMP1.T_TYPE, TMP1.T_FIID "
            + "                                   HAVING COUNT(DISTINCT TMP1.T_DEALID) >= " + å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà
            + "                                                                       )"
            + "                          ";
    else
      // Ö·´® å®≠äÆ´®Áë§•´Æ™Ñ´Ôê†ß°®¢™®èÆîà ‡†¢≠† 0, ‚Æ ‡†ß°®•≠®• ≠† Ø†Á™® ¢≠„‚‡® îà ≠• ¢ÎØÆ´≠Ô‚Ï 
      query = query + " AND TMP.T_PARTY > 0 ";
    end;
  end; 

  query = query
          + "                     AND NOT EXISTS(SELECT 1 "
          + "                                      FROM DPMWRTGRP_DBT GRP, DPMWRTGRPFI_DBT GRPFI "
          + "                                     WHERE GRP.T_DOCKIND    = TMP.T_DOCKIND "
          + "                                       AND GRP.T_DOCID      = TMP.T_DOCID "
          + "                                       AND GRP.T_DEPARTMENT = TMP.T_DEPARTMENT "
          + "                                       AND GRP.T_PARTY      = TMP.T_PARTY "
          + "                                       AND GRP.T_CONTRACT   = TMP.T_CONTRACT "
          + "                                       AND GRP.T_ISSECOWN   = TMP.T_ISSECOWN "
          + "                                       AND GRPFI.T_GRPID    = GRP.T_ID "
          + "                                       AND GRPFI.T_FIID     = TMP.T_FIID "
          + "                                   ) "
          + "                 ) "
          + "  LOOP "
          //§´Ô ëùÅ ‡†ß¨•‡ Ø†Á™® §•´†•¨ °Æ´ÏË®¨, Á‚Æ°Î §´Ô ëùÅ ‡†ß°®¢Æ™ ≠• Æ·„È•·‚¢´Ô´Æ·Ï
          + "    IF one_tmp.T_ISSECOWN = chr(88) THEN"
          + "      v_bufStep := v_Step;"
          + "      v_Step := 99999999;"
          + "    END IF;"
          + "    INSERT INTO DPMWRTGRP_DBT(T_ID,T_DOCKIND,T_DOCID,T_DEPARTMENT,T_PARTY,T_CONTRACT,T_ISSECOWN,T_ERRSTATUS) "
          + "                       VALUES(0, one_tmp.T_DOCKIND, one_tmp.T_DOCID, one_tmp.T_DEPARTMENT, one_tmp.T_PARTY, one_tmp.T_CONTRACT, one_tmp.T_ISSECOWN, 0) "
          + "                RETURNING t_ID INTO v_GrpID; "
          + "    INSERT INTO DPMWRTGRPFI_DBT(T_ID,T_GRPID,T_FIID) VALUES(0, v_GrpID, one_tmp.T_FIID); "

          + "    SELECT COUNT (1) "
          + "      INTO v_Cnt "
          + "      FROM DPMWRTGRP_TMP tmp, ddl_tick_dbt tk "
          + "     WHERE     tmp.T_DOCKIND = one_tmp.T_DOCKIND "
          + "           AND tmp.T_DOCID = one_tmp.T_DOCID "
          + "           AND tmp.T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "           AND tmp.T_PARTY = one_tmp.T_PARTY "
          + "           AND tmp.T_CONTRACT = one_tmp.T_CONTRACT "
          + "           AND tmp.T_ISSECOWN = one_tmp.T_ISSECOWN "
          + "           AND tmp.T_FIID = one_tmp.T_FIID "
          + "           AND tmp.T_TYPE = "+SUBGRP_TYPE_CARRY+" "
          + "           AND tmp.T_PARTY = -1 "
          + "           AND TK.T_DEALID = TMP.T_DEALID "
          + "           AND tk.T_DEALTYPE IN "
          + "                  (SELECT T_KIND_OPERATION "
          + "                     FROM DOPRKOPER_DBT "
          + "                    WHERE     INSTR (T_SYSTYPES, 'B') > 0 "
          + "                          AND INSTR (T_SYSTYPES, 't') > 0 "
          + "                          AND (T_NOTINUSE IS NULL OR T_NOTINUSE = CHR (0)) "
          + "                          AND T_KIND_OPERATION > 0 "
          + "                          AND T_DOCKIND = 101); "

          //§Æ°†¢´Ô•¨ ¢·• ·Æ°·‚¢•≠≠Î• Æ°‡†‚≠Î• êÖèé ·§•´™® ¢ "Ø•‡¢®Á≠„Ó" £‡„ØØ„ Æ°‡†°Æ‚™®
          + "    IF v_Cnt > 0 "
          + "    THEN "
          + "       INSERT INTO dpmwrtsubgrp_dbt (T_SUBGRPID, T_GRPID, T_TYPE) "
          + "            VALUES (0, v_GrpID, "+SUBGRP_TYPE_CARRY+") "
          + "         RETURNING t_SubGrpID "
          + "              INTO v_SubGrpID; "

          + "       INSERT INTO DPMWRTPRIMESUBGRP_DBT (T_SUBGRPID, T_GRPID) "
          + "            VALUES (v_SubGrpID, v_GrpID); "

          + "       SELECT v_SubGrpID, t_GrDealID "
          + "         BULK COLLECT INTO v_subdoc "
          + "         FROM DPMWRTGRP_TMP tmp, ddl_tick_dbt tk "
          + "        WHERE     tmp.T_DOCKIND = one_tmp.T_DOCKIND "
          + "              AND tmp.T_DOCID = one_tmp.T_DOCID "
          + "              AND tmp.T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "              AND tmp.T_PARTY = one_tmp.T_PARTY "
          + "              AND tmp.T_CONTRACT = one_tmp.T_CONTRACT "
          + "              AND tmp.T_ISSECOWN = one_tmp.T_ISSECOWN "
          + "              AND tmp.T_FIID = one_tmp.T_FIID "
          + "              AND tmp.T_TYPE = "+SUBGRP_TYPE_CARRY+" "
          + "              AND tmp.T_PARTY = -1 "
          + "              AND TK.T_DEALID = TMP.T_DEALID "
          + "              AND tk.T_DEALTYPE IN "
          + "                     (SELECT T_KIND_OPERATION "
          + "                        FROM DOPRKOPER_DBT "
          + "                       WHERE INSTR (T_SYSTYPES, 'B') > 0 "
          + "                             AND INSTR (T_SYSTYPES, 't') > 0 "
          + "                             AND (T_NOTINUSE IS NULL "
          + "                                  OR T_NOTINUSE = CHR (0)) "
          + "                             AND T_KIND_OPERATION > 0 "
          + "                             AND T_DOCKIND = 101); "

          + "       IF v_subdoc.COUNT > 0 "
          + "       THEN "
          + "          FORALL indx IN v_subdoc.FIRST .. v_subdoc.LAST "
          + "             INSERT INTO dpmwrtsubdoc_dbt "
          + "                  VALUES v_subdoc (indx); "
          + "       END IF; "

          + "       DELETE FROM DPMWRTGRP_TMP TMP "
          + "             WHERE     TMP.T_DOCKIND = one_tmp.T_DOCKIND "
          + "                   AND TMP.T_DOCID = one_tmp.T_DOCID "
          + "                   AND TMP.T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "                   AND TMP.T_PARTY = one_tmp.T_PARTY "
          + "                   AND TMP.T_CONTRACT = one_tmp.T_CONTRACT "
          + "                   AND TMP.T_ISSECOWN = one_tmp.T_ISSECOWN "
          + "                   AND TMP.T_FIID = one_tmp.T_FIID "
          + "                   AND TMP.T_TYPE = "+SUBGRP_TYPE_CARRY+" "
          + "                   AND TMP.T_GRDEALID IN (SELECT S.T_GRDEALID "
          + "                                            FROM DPMWRTSUBDOC_DBT S "
          + "                                           WHERE S.T_SUBGRPID = v_SubGrpID); "
          + "    END IF; "

          + "    SELECT COUNT(1) INTO v_Cnt "
          + "      FROM DPMWRTGRP_TMP "
          + "     WHERE T_DOCKIND    = one_tmp.T_DOCKIND "
          + "       AND T_DOCID      = one_tmp.T_DOCID "
          + "       AND T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "       AND T_PARTY      = one_tmp.T_PARTY "
          + "       AND T_CONTRACT   = one_tmp.T_CONTRACT "
          + "       AND T_ISSECOWN   = one_tmp.T_ISSECOWN "
          + "       AND T_FIID       = one_tmp.T_FIID "
          + "       AND T_TYPE       = "+SUBGRP_TYPE_CARRY+"; "

          + "    IF v_Cnt > 0 THEN "
          + "      v_Rest := v_Cnt; "
          + "      WHILE v_Rest > 0 LOOP "
          + "        INSERT INTO dpmwrtsubgrp_dbt(T_SUBGRPID,T_GRPID,T_TYPE) VALUES(0,v_GrpID,"+SUBGRP_TYPE_CARRY+") RETURNING t_SubGrpID INTO v_SubGrpID;"
          + "        v_grprecToIns.DELETE; "
          + "        v_AddCount := 0; "
          + "        v_PrevDealid := NULL; "
          + "        v_grprecBuf.DELETE; "

          + "                    OPEN v_Cursor FOR '  SELECT * "
          + "            FROM DPMWRTGRP_TMP "
          + "           WHERE     T_DOCKIND = :p_dockind "
          + "                 AND T_DOCID = :p_docid "
          + "                 AND T_DEPARTMENT = :p_department "
          + "                 AND T_PARTY = :p_party "
          + "                 AND T_CONTRACT = :p_contract "
          + "                 AND T_ISSECOWN = :p_issecown "
          + "                 AND T_FIID = :p_fiid "
          + "                 AND T_TYPE = 2 "
          + "        ORDER BY T_DEALID' "
          + "                       USING one_tmp.T_DOCKIND, "
          + "                             one_tmp.T_DOCID, "
          + "                             one_tmp.T_DEPARTMENT, "
          + "                             one_tmp.T_PARTY, "
          + "                             one_tmp.T_CONTRACT, "
          + "                             one_tmp.T_ISSECOWN, "
          + "                             one_tmp.T_FIID; "

          //·¨Î·´ ·´•§„ÓÈ•£Æ †´£Æ‡®‚¨†, Á‚Æ°Î ·‚‡Æ™® £‡†‰®™† Æ‚ Æ§≠Æ© ·§•´™®, ≠• ØÆØ†´® ¢ ‡†ß≠Î• Ø†Á™®
          //ØÆÌ‚Æ¨„ §†, ‚„‚ ¨Æ£„‚ ØÆ´„Á®‚·Ô ≠• ÆÁ•≠Ï ‡Æ¢≠Î• Ø†Á™®
          + "        LOOP "
          + "           FETCH v_Cursor "
          + "           BULK COLLECT INTO v_grprec "
          + "           LIMIT ( (v_Step * 2) + 50); "

          + "           IF v_grprec.COUNT > 0 "
          + "           THEN "
          + "              FOR indx IN 1 .. v_grprec.COUNT "
          + "              LOOP "
          + "                  IF v_PrevDealid IS NULL or v_grprec(indx).T_DEALID <> v_PrevDealid THEN "
          + "                      IF v_grprecBuf.COUNT > 0 THEN "
          + "                          IF (v_grprecBuf.COUNT + v_AddCount) > v_Step THEN "
          + "                              v_grprecBuf.DELETE; "
          + "                              CLOSE v_Cursor; "
          + "                              EXIT WHEN 1=1; "
          + "                          END IF;"
          + "                          v_AddCount := v_AddCount + v_grprecBuf.COUNT; "
          + "                          v_grprecToIns := v_grprecToIns MULTISET UNION v_grprecBuf; "
          + "                          v_grprecBuf.DELETE; "
          + "                      END IF; "
          + "                      v_PrevDealid := v_grprec(indx).T_DEALID; "
          + "                  END IF; "
          + "                  v_grprecBuf.EXTEND; "
          + "                  v_grprecBuf(v_grprecBuf.COUNT) := v_grprec(indx); "
          + "              END LOOP; "
          + "           END IF; "

          + "           EXIT WHEN NOT v_Cursor%ISOPEN OR v_Cursor%NOTFOUND; "
          + "        END LOOP; "
          + "        IF v_Cursor%ISOPEN THEN "
          + "            CLOSE v_Cursor; "
          + "        END IF; "

          + "       IF (v_grprecBuf.COUNT > 0) and ((v_grprecBuf.COUNT + v_grprecToIns.COUNT) <= v_Step) THEN "
          + "           v_grprecToIns := v_grprecToIns MULTISET UNION v_grprecBuf; "
          + "           v_grprecBuf.DELETE; "
          + "       END IF; ";

   query = query
          + "        IF v_grprecToIns.COUNT > 0 "
          + "        THEN "
          + "           FORALL indx IN v_grprecToIns.FIRST .. v_grprecToIns.LAST "
          + "              INSERT INTO dpmwrtsubdoc_dbt (T_SUBGRPID, T_GRDEALID) "
          + "                   VALUES (v_SubGrpID, v_grprecToIns (indx).T_GRDEALID); "
          + "        END IF; "
          //à·ØÆ´ÏßÆ¢†≠≠Î• ß†Ø®·® ·‡†ß„ „§†´Ô•¨ ®ß ¢‡•¨•≠≠Æ© ‚†°´®ÊÎ, Á‚Æ°Î ≠• ¨•Ë†´®
          + "        DELETE FROM DPMWRTGRP_TMP TMP "
          + "         WHERE TMP.T_DOCKIND    = one_tmp.T_DOCKIND "
          + "           AND TMP.T_DOCID      = one_tmp.T_DOCID "
          + "           AND TMP.T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "           AND TMP.T_PARTY      = one_tmp.T_PARTY "
          + "           AND TMP.T_CONTRACT   = one_tmp.T_CONTRACT "
          + "           AND TMP.T_ISSECOWN   = one_tmp.T_ISSECOWN "
          + "           AND TMP.T_FIID       = one_tmp.T_FIID "
          + "           AND TMP.T_TYPE       = "+SUBGRP_TYPE_CARRY
          + "           AND TMP.T_GRDEALID IN (SELECT S.T_GRDEALID FROM DPMWRTSUBDOC_DBT S WHERE S.T_SUBGRPID = v_SubGrpID); ";
          
          query = query + "        v_Rest := v_Rest - v_grprecToIns.COUNT ;";

  query = query        
          + "      END LOOP; "

          + "    END IF; "

          + "    SELECT COUNT(1) INTO v_Cnt "
          + "      FROM DPMWRTGRP_TMP "
          + "     WHERE T_DOCKIND    = one_tmp.T_DOCKIND "
          + "       AND T_DOCID      = one_tmp.T_DOCID "
          + "       AND T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "       AND T_PARTY      = one_tmp.T_PARTY "
          + "       AND T_CONTRACT   = one_tmp.T_CONTRACT "
          + "       AND T_ISSECOWN   = one_tmp.T_ISSECOWN "
          + "       AND T_FIID       = one_tmp.T_FIID "
          + "       AND T_TYPE       = "+SUBGRP_TYPE_KVIT+"; "

          + "    IF v_Cnt > 0 THEN "
          //Ç £‡„ØØ„ §Æ°†¢®‚Ï ØÆ§£‡„ØØ„ ™¢®‚Æ¢™® ≠† ¢·• ·ÆÆ‚¢•‚·‚¢„ÓÈ®• ·‚‡Æ™® £‡†‰®™†
          + "        INSERT INTO dpmwrtsubgrp_dbt(T_SUBGRPID,T_GRPID,T_TYPE) VALUES(0,v_GrpID,"+SUBGRP_TYPE_KVIT+") RETURNING t_SubGrpID INTO v_SubGrpID;"

          + "        SELECT v_SubGrpID, t_GrDealID "
          + "          BULK COLLECT INTO v_subdoc "
          + "          FROM DPMWRTGRP_TMP "
          + "         WHERE T_DOCKIND    = one_tmp.T_DOCKIND "
          + "           AND T_DOCID      = one_tmp.T_DOCID "
          + "           AND T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "           AND T_PARTY      = one_tmp.T_PARTY "
          + "           AND T_CONTRACT   = one_tmp.T_CONTRACT "
          + "           AND T_ISSECOWN   = one_tmp.T_ISSECOWN "
          + "           AND T_FIID       = one_tmp.T_FIID "
          + "           AND T_TYPE       = "+SUBGRP_TYPE_KVIT+"; "

          + "        IF v_subdoc.COUNT > 0 THEN "
          + "          FORALL indx IN v_subdoc.FIRST .. v_subdoc.LAST "
          + "           INSERT INTO dpmwrtsubdoc_dbt "
          + "           VALUES v_subdoc (indx); "
          + "        END IF; "

          //à·ØÆ´ÏßÆ¢†≠≠Î• ß†Ø®·® ·‡†ß„ „§†´Ô•¨ ®ß ¢‡•¨•≠≠Æ© ‚†°´®ÊÎ, Á‚Æ°Î ≠• ¨•Ë†´®
          + "        DELETE FROM DPMWRTGRP_TMP TMP "
          + "         WHERE TMP.T_DOCKIND    = one_tmp.T_DOCKIND "
          + "           AND TMP.T_DOCID      = one_tmp.T_DOCID "
          + "           AND TMP.T_DEPARTMENT = one_tmp.T_DEPARTMENT "
          + "           AND TMP.T_PARTY      = one_tmp.T_PARTY "
          + "           AND TMP.T_CONTRACT   = one_tmp.T_CONTRACT "
          + "           AND TMP.T_ISSECOWN   = one_tmp.T_ISSECOWN "
          + "           AND TMP.T_FIID       = one_tmp.T_FIID "
          + "           AND TMP.T_TYPE       = " + SUBGRP_TYPE_KVIT
          + "           AND TMP.T_GRDEALID IN (SELECT S.T_GRDEALID FROM DPMWRTSUBDOC_DBT S WHERE S.T_SUBGRPID = v_SubGrpID); "

          + "    END IF; "

          + "  IF one_tmp.T_ISSECOWN = chr(88) THEN "
          + "    v_Step := v_bufStep;"
          + "  END IF;"

          + "  END LOOP; "
          + "END; ";  

  cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocKind );
  cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocumentID );
  cmd.execute();

  UseProgress(4);

  
  //Ñ´Ô ¢·•Â Æ·‚†¢Ë®Â·Ô ß†Ø®·•© ‰Æ‡¨®‡„•¨ £‡„ØØÎ °•ß ‡†ß°®¢™® ØÆ Ê/°
  query =   "DECLARE "
          + "  v_GrpID NUMBER; "
          + "BEGIN "
          + "  FOR one_rec IN (SELECT DISTINCT TMP.T_DOCKIND, TMP.T_DOCID, TMP.T_DEPARTMENT, TMP.T_PARTY, TMP.T_CONTRACT, TMP.T_ISSECOWN "
          + "                   FROM DPMWRTGRP_TMP TMP "
          + "                  WHERE NOT EXISTS(SELECT 1 "
          + "                                     FROM DPMWRTGRP_DBT GRP, DPMWRTGRPFI_DBT F "
          + "                                    WHERE GRP.T_DOCKIND    = TMP.T_DOCKIND "
          + "                                      AND GRP.T_DOCID      = TMP.T_DOCID "
          + "                                      AND GRP.T_DEPARTMENT = TMP.T_DEPARTMENT "
          + "                                      AND GRP.T_PARTY      = TMP.T_PARTY "
          + "                                      AND GRP.T_CONTRACT   = TMP.T_CONTRACT "
          + "                                      AND GRP.T_ISSECOWN   = TMP.T_ISSECOWN "
          + "                                      AND F.T_GRPID        = GRP.T_ID "
          + "                                      AND F.T_FIID         = TMP.T_FIID "
          + "                                  ) "
          + "                 ) "
          + "  LOOP "
          + "    INSERT INTO DPMWRTGRP_DBT(T_ID,T_DOCKIND,T_DOCID,T_DEPARTMENT,T_PARTY,T_CONTRACT,T_ISSECOWN,T_ERRSTATUS) "
          + "                   VALUES(0, one_rec.T_DOCKIND, one_rec.T_DOCID, one_rec.T_DEPARTMENT, one_rec.T_PARTY, one_rec.T_CONTRACT, one_rec.T_ISSECOWN, 0) RETURNING t_ID INTO v_GrpID; "

          + "    INSERT INTO DPMWRTGRPFI_DBT (T_ID, T_GRPID, T_FIID) "
          + "    SELECT DISTINCT 0, v_GrpID, TMP.T_FIID "
          + "      FROM DPMWRTGRP_TMP TMP "
          + "     WHERE TMP.T_DOCKIND    = one_rec.t_DocKind "
          + "       AND TMP.T_DOCID      = one_rec.t_DocID "
          + "       AND TMP.T_DEPARTMENT = one_Rec.t_Department "
          + "       AND TMP.T_PARTY      = one_rec.t_Party "
          + "       AND TMP.T_CONTRACT   = one_Rec.t_Contract "
          + "       AND TMP.T_ISSECOWN   = one_rec.t_IsSecOwn "
          + "       AND NOT EXISTS(SELECT 1 "
          + "                        FROM DPMWRTGRP_DBT GRP, DPMWRTGRPFI_DBT F "
          + "                       WHERE GRP.T_DOCKIND    = TMP.T_DOCKIND "
          + "                         AND GRP.T_DOCID      = TMP.T_DOCID "
          + "                         AND GRP.T_DEPARTMENT = TMP.T_DEPARTMENT "
          + "                         AND GRP.T_PARTY      = TMP.T_PARTY "
          + "                         AND GRP.T_CONTRACT   = TMP.T_CONTRACT "
          + "                         AND GRP.T_ISSECOWN   = TMP.T_ISSECOWN "
          + "                         AND F.T_GRPID        = GRP.T_ID "
          + "                         AND F.T_FIID         = TMP.T_FIID "
          + "                     ); "

          + "  END LOOP; "
          + "END;";
  
  SQL_Execute(query, "îÆ‡¨®‡Æ¢†≠®• £‡„ØØ Æ°‡†°Æ‚™® °•ß ‡†ß°®¢™® ØÆ Ê/°", false );

  UseProgress(5);

  private macro CreateSubDocNotFI(Type)

    query =   "DECLARE "
            + "  v_SubGrpID NUMBER; "
            + "  TYPE subdoc_t IS TABLE OF DPMWRTSUBDOC_DBT%ROWTYPE INDEX BY BINARY_INTEGER; "
            + "  v_subdoc subdoc_t; "
            + "  v_Type NUMBER := 0; "
            + "BEGIN "

            + "  v_Type := ?; "

            + "  FOR one_grp IN (SELECT GRP.* "
            + "                    FROM DPMWRTGRP_DBT GRP "
            + "                   WHERE GRP.T_DOCKIND = ? "
            + "                     AND GRP.T_DOCID = ? "
            + "                     AND NOT EXISTS(SELECT 1 FROM DPMWRTSUBGRP_DBT S WHERE S.T_GRPID = GRP.T_ID AND T_TYPE = v_Type)"
            + "                 ) "
            + "  LOOP "
            + "    INSERT INTO dpmwrtsubgrp_dbt(T_SUBGRPID,T_GRPID,T_TYPE) VALUES(0,one_grp.t_ID,v_Type) RETURNING t_SubGrpID INTO v_SubGrpID; "

            + "    SELECT v_SubGrpID, t_GrDealID "
            + "      BULK COLLECT INTO v_subdoc "
            + "      FROM DPMWRTGRP_TMP "
            + "     WHERE T_DOCKIND    = one_grp.T_DOCKIND "
            + "       AND T_DOCID      = one_grp.T_DOCID "
            + "       AND T_DEPARTMENT = one_grp.T_DEPARTMENT "
            + "       AND T_PARTY      = one_grp.T_PARTY "
            + "       AND T_CONTRACT   = one_grp.T_CONTRACT "
            + "       AND T_ISSECOWN   = one_grp.T_ISSECOWN "
            + "       AND T_FIID IN (SELECT F.T_FIID FROM DPMWRTGRPFI_DBT F WHERE F.T_GRPID = one_grp.t_ID) "
            + "       AND T_TYPE       = v_Type; "

            + "    IF v_subdoc.COUNT > 0 THEN "
            + "      FORALL indx IN v_subdoc.FIRST .. v_subdoc.LAST "
            + "       INSERT INTO dpmwrtsubdoc_dbt "
            + "       VALUES v_subdoc (indx); "
            + "    END IF; "

            + "    DELETE FROM DPMWRTGRP_TMP TMP "
            + "     WHERE TMP.T_DOCKIND    = one_grp.T_DOCKIND "   
            + "       AND TMP.T_DOCID      = one_grp.T_DOCID "     
            + "       AND TMP.T_DEPARTMENT = one_grp.T_DEPARTMENT "
            + "       AND TMP.T_PARTY      = one_grp.T_PARTY "     
            + "       AND TMP.T_CONTRACT   = one_grp.T_CONTRACT "  
            + "       AND TMP.T_ISSECOWN   = one_grp.T_ISSECOWN "  
            + "       AND TMP.T_TYPE       = v_Type "
            + "       AND TMP.T_GRDEALID IN (SELECT S.T_GRDEALID FROM DPMWRTSUBDOC_DBT S WHERE S.T_SUBGRPID = v_SubGrpID); "

            + "  END LOOP; "
            + "END; ";

    cmd = RSDCommand(query);

    cmd.addParam( "", RSDBP_IN, Type );
    cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocKind );
    cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocumentID );
    cmd.execute();
  end;

  //Ñ´Ô ¢·•Â £‡„ØØ °•ß ‡†ß°®¢™® ØÆ Ê/° ·Æß§†•¨ ØÆ§£‡„ØØÎ §´Ô ™¢‚Æ¢™® ® Ø‡Æ¢Æ§Æ™ ≠† ¢•·Ï Æ°Í•¨
  CreateSubDocNotFI(SUBGRP_TYPE_KVIT);
  CreateSubDocNotFI(SUBGRP_TYPE_CARRY);

  UseProgress(6);

  //§´Ô ¢·•Â £‡„ØØ ·°‡Æ·®¨ ·‚†‚„· ÆË®°™® (¨Æ£´® °Î‚Ï ÆË®°™® ØÆ ‡†≠•• ·„È•·‚¢Æ¢†¢Ë®¨ £‡„ØØ†¨)
  query =   " UPDATE DPMWRTGRP_DBT GRP "
          + "    SET GRP.T_ERRSTATUS = 0 "
          + "  WHERE GRP.T_DOCKIND = ? " 
          + "    AND GRP.T_DOCID = ? "
          + "    AND EXISTS(SELECT 1 "
          + "                 FROM DPMWRTGRP_TMP TMP "
          + "                WHERE TMP.T_DOCKIND    = GRP.T_DOCKIND   "
          + "                  AND TMP.T_DOCID      = GRP.T_DOCID     "
          + "                  AND TMP.T_DEPARTMENT = GRP.T_DEPARTMENT"
          + "                  AND TMP.T_PARTY      = GRP.T_PARTY     "
          + "                  AND TMP.T_CONTRACT   = GRP.T_CONTRACT  "
          + "                  AND TMP.T_ISSECOWN   = GRP.T_ISSECOWN  "
          + "              )";

  cmd = RSDCommand(query);

  cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocKind );
  cmd.addParam( "", RSDBP_IN, dl_comm.rec.DocumentID );
  cmd.execute();

  UseProgress(7);

  RslDefCon.CommitTrans();

  query =   " select 1 "
          + "   from dpmwrtgrp_dbt "
          + "  where t_DocKind = ? "
          + "    and t_DocID = ? ";

  cmd = DL_RSDCommand(query);

  cmd.addParam(dl_comm.rec.DocKind );
  cmd.addParam(dl_comm.rec.DocumentID );

  cnt = cmd.GetCount();

  RemProgress();

  return cnt;

  OnError(er)
    var err_text = GetFullErrorMessage(er);
    if(RslDefCon.IsInTrans)
      RslDefCon.RollbackTrans();
    end;
    MsgBox(err_text);
    RunError(err_text);
end;

PRIVATE MACRO Åì_è‡Æ¢•‡™†ä´®•≠‚·™®ÂëÁ•‚Æ¢(dl_comm)
  var MinusClientAccRepDataArr = TArray();
  var query, cmd, DataSet;

 query = " with grd as( select /*+ materialize ordered index(grd DDLGRDOC_DBT_IDX1) */ "
          + "           acctrn.t_Account_Payer ,acctrn.t_Account_Receiver, acctrn.t_FIID_Payer ,acctrn.t_FIID_Receiver, acctrn.t_Chapter, acctrn.t_Date_Carry "
          + "         from ddlgrdoc_dbt grd, dacctrn_dbt  acctrn "
          + "           where grd.t_ServDocKind = ? "
          + "             and grd.t_ServDocID = ? "
          + "             and grd.t_DocKind = " + DLDOC_CARRY
          + "             and acctrn.t_AccTrnID = grd.t_DocID "
          + "             and (acctrn.t_Account_Payer like '306%' or acctrn.t_Account_Receiver like '306%')),"
          + " acc as (select t_Account,t_Currency,t_Chapter,t_Date_Carry, "
          + "         rsb_account.restac(t_Account,t_Currency,t_Date_Carry,t_Chapter,null) as Rest "
          + "        from  (select t_Account_Payer as t_Account, t_FIID_Payer as t_Currency, t_Chapter, t_Date_Carry "
          + "               from grd "
          + "               where t_Account_Payer LIKE '306%' "
          + "               UNION "
          + "               select t_Account_Receiver as t_Account, t_FIID_Receiver as t_Currency, t_Chapter, t_Date_Carry "
          + "               from grd "
          + "               where t_Account_Receiver LIKE '306%' )), "
          + " mc as (select distinct acc.t_Account,  acc.t_Date_Carry, acc.Rest, mcacc.t_ClientContrID "
          + "           from acc, dmcaccdoc_dbt mcacc "
          + "          where mcacc.t_Account = acc.t_Account "
          + "            and mcacc.t_Currency = acc.t_Currency "
          + "            and mcacc.t_Chapter = acc.t_Chapter "
          + "            and mcacc.t_ClientContrID > 0  and acc.Rest < 0 "
          + "        ) "
          + " select mc.t_Account, pt.t_ShortName, "
          + "        mc.t_Date_Carry, mc.Rest, "
          + "        (case when sf.t_ServKind = 0 then sf.t_Number "
          + "              else (select s.t_Number "
          + "                      from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt s "
          + "                     where mp.t_SfContrID = sf.t_ID "
          + "                       and dlc.t_DlContrID = mp.t_DlContrID "
          + "                       and s.t_ID = dlc.t_SfContrID " 
          + "                   )"
          + "              end) as DlContrNum"
          + "  from mc, dsfcontr_dbt sf, dparty_dbt pt "
          + "  where sf.t_ID = mc.t_ClientContrID "
          + "    and pt.t_PartyID = sf.t_PartyID ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(dl_comm.rec.DocKind);
  cmd.AddParam(dl_comm.rec.DocumentID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    msgbox("Ñ´Ô ™´®•≠‚† "+DataSet.ShortName+" (≠Æ¨•‡ ÑÅé "+DataSet.DlContrNum+") ≠† ·Á•‚• "+DataSet.Account+" Æ‚‡®Ê†‚•´Ï≠Î© Æ·‚†‚Æ™ "+string(money(DataSet.Rest)));
  end;

END;

PRIVATE MACRO Åì_ì·‚†≠Æ¢®‚ÏÅ•ß´®¨®‚ç†ëÁ•‚†ëê†ß°®¢™Æ©ç†è†Á™®(dl_comm)
  var accList = TArray();
  if (ä†‚•£Æ‡®®Ñ´ÔÅ•ß´®¨®‚†.size() > 0)
    var query, cmd, DataSet;
    query = 
      " SELECT DISTINCT ac.T_ACCOUNTID, ac.T_ACCOUNT, ac.T_CHAPTER, ac.T_CODE_CURRENCY "
     +"   FROM DMCACCDOC_DBT mcdoc, DACCOUNT_DBT ac "
     +"  WHERE T_CATID IN (SELECT t_id "
     +"                      FROM DMCCATEG_DBT "
     +"                     WHERE t_number IN ("+join(ä†‚•£Æ‡®®Ñ´ÔÅ•ß´®¨®‚†, ",")+")) "
     +"        AND T_FIID IN "
     +"               (SELECT fi.T_FIID "
     +"                  FROM DPMWRTGRPFI_DBT fi "
     +"                 WHERE t_grpid IN "
     +"                          (SELECT t_id "
     +"                             FROM DPMWRTGRP_DBT "
     +"                            WHERE t_docid = ? AND t_dockind = ? AND T_PARTY = -1) "
     +"                       AND (SELECT COUNT (*) "
     +"                              FROM DPMWRTSUBGRP_DBT sub "
     +"                             WHERE sub.t_grpid = fi.t_grpid AND SUB.T_TYPE = "+SUBGRP_TYPE_CARRY+") > "
     +"                              1) "
     +"        AND ac.T_ACCOUNT = mcdoc.T_ACCOUNT "
     +"        AND ac.T_CODE_CURRENCY = mcdoc.T_CURRENCY "
     +"        AND ac.T_CHAPTER = mcdoc.T_CHAPTER "
     +"        AND ac.t_open_date <= ? "
     +"        AND (ac.t_close_date >= ? "
     +"             OR ac.t_close_date = TO_DATE ('01.01.0001', 'DD.MM.YYYY')) "
     +"        AND INSTR (ac.t_type_account, 'î') = 0 ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(dl_comm.rec.DocumentID);
    cmd.AddParam(dl_comm.rec.DocKind);
    cmd.AddParam(dl_comm.rec.commdate);
    cmd.AddParam(dl_comm.rec.commdate);

    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      execSql("update daccount_dbt set t_type_account = REPLACE(REPLACE((t_type_account || :newtype),CHR(0)),CHR(1)) where t_accountid = :accid", 
        makeArray(
          SQLParam("newtype", "î"),
          SQLParam("accid", DataSet.AccountID)
        ),
        true
      );
      accList[accList.size] = DataSet.AccountID;
    end;
  end;

  return accList;
END;

PRIVATE MACRO Åì_ë≠Ô‚ÏÅ•ß´®¨®‚ç†ëÁ•‚†ëê†ß°®¢™Æ©ç†è†Á™®(accList)
  for (var curAcc, accList)
    execSql("update daccount_dbt set t_type_account = NVL(REPLACE(t_type_account, :deltype),chr(1)) where t_accountid = :accid", 
      makeArray(
        SQLParam("deltype", "î"),
        SQLParam("accid", curAcc)
      ),
      true
    );
  end;
END;

private macro é°‡†°Æ‚†‚Ïå•¶·•··®Æ≠≠Î•Ñ†≠≠Î•(p_msesData)
  var dl_valueCache = RsbSQLInsert("dl_value.dbt");
  var dl_value = NULL;

  var m_ArrRegistrValue = p_msesData.GetObjListByClassName("TRegistrValue");

  var i = 0;
  var err = 0;

  //ß†≠•·‚® §†≠≠Î• ¢ ‡•£®·‚‡ Ø•‡•ÆÊ•≠™®
  if(m_ArrRegistrValue.size > 0)
    i = 0;
    while(i < m_ArrRegistrValue.size)

      dl_value = TRecHandler("dl_value.dbt");
      dl_value.Clear();

      dl_value.rec.DocKind      = m_ArrRegistrValue[i].m_DocKind;
      dl_value.rec.DocID        = m_ArrRegistrValue[i].m_DocID;  
      dl_value.rec.Kind         = m_ArrRegistrValue[i].m_Kind;
      dl_value.rec.Date         = m_ArrRegistrValue[i].m_Date;
      dl_value.rec.Sum          = m_ArrRegistrValue[i].m_Sum;
      dl_value.rec.SumFIID      = m_ArrRegistrValue[i].m_SumFIID;
      dl_value.rec.ID_Operation = m_ArrRegistrValue[i].m_ServDocID;
      dl_value.rec.ID_Step      = -1;
      dl_value.rec.GrpID        = m_ArrRegistrValue[i].m_GrpID;

      dl_valueCache.AddRecord(dl_value);

      i = i + 1;
    end;

  end;

  var m_ArrComissValue = p_msesData.GetObjListByClassName("TRegistrValueComiss");

  //ß†≠•·‚® §†≠≠Î• ¢ ‡•£®·‚‡ ØÆ ™Æ¨®··®Ô¨
  if(m_ArrComissValue.size > 0)
    i = 0;
    while(i < m_ArrComissValue.size)

      dl_value = TRecHandler("dl_value.dbt");
      dl_value.Clear();

      dl_value.rec.DocKind      = m_ArrComissValue[i].m_DocKind;
      dl_value.rec.DocID        = m_ArrComissValue[i].m_DocID;
      dl_value.rec.Kind         = m_ArrComissValue[i].m_Kind;
      dl_value.rec.Date         = m_ArrComissValue[i].m_Date;
      dl_value.rec.Sum          = m_ArrComissValue[i].m_Sum;
      dl_value.rec.SumFIID      = m_ArrComissValue[i].m_SumFIID;
      dl_value.rec.ID_Operation = m_ArrComissValue[i].m_ServDocID;
      dl_value.rec.ID_Step      = -1;
      dl_value.rec.GrpID        = m_ArrComissValue[i].m_GrpID;

      dl_valueCache.AddRecord(dl_value);

      i = i + 1;
    end;
  end;

  if(not dl_valueCache.insert())
    err = 1;
    msgbox("éË®°™† Ø‡® ·ÆÂ‡†≠•≠®® ·„¨¨");
  end;

  VAR cmd, ExecStr = "";
  i = 0;
  var m_ArrDLSUM = p_msesData.GetObjListByClassName("TDLSUM");

  while( i < m_ArrDLSUM.size )                                        
     ExecStr = ExecStr + " RSI_DLGR.SetDLSUM(" + m_ArrDLSUM[i].DocKind +","
                                               + m_ArrDLSUM[i].DocID +","
                                               + m_ArrDLSUM[i].Kind +","             
                                               + m_ArrDLSUM[i].Currency +","        
                                               + GetSQLDate( m_ArrDLSUM[i].CommDate ) +","
                                               + string( m_ArrDLSUM[i].Sum ) +","
                                               + string( m_ArrDLSUM[i].NDS ) +","
                                               + m_ArrDLSUM[i].GrpID +","
                                               + m_ArrDLSUM[i].FIID +
                                           ");";
     i = i + 1;
  end;

  if( ExecStr != "" )
     cmd = RSDCommand( "DECLARE BEGIN "+ ExecStr + " END; " );
     cmd.execute();
  end; 

  return err;
end;

PRIVATE macro __StartAccounting( dl_comm:TBFile, IsWebService  )
  var OperID = 11; //éØ•‡†Ê®Ô §´Ô ™Æ≠¢•©‡† - è†™•‚≠†Ô ÆØ•‡†Ê®Ô ‰Æ‡¨®‡Æ¢†≠®Ô °„Â£†´‚•‡·™Æ£Æ „Á•‚† ØÆ ·§•´™†¨ ¨Æ§„´Ô "ñ•≠≠Î• °„¨†£®"
  var ConvID = 0;
  var NumAction = 0;
  var err = 0;
  var stat = 0;
  var cmd;
  var UseConveyer = false;
  var UnlimAccArr = TArray();
  var msesCreator = MSesDataCreator();
  UseConveyer = UserSecurUseConveyer();

  BeginAction( @NumAction, "è‡Æ¢•‡™† ≠•®·ØÆ´≠•≠≠ÎÂ ·¢Æ§≠ÎÂ Ø‡Æ¢Æ§Æ™" );
  if (è‡Æ¢•‡®‚Ïé‚´Æ¶•≠≠Î•ë¢Æ§≠Î•è‡Æ¢Æ§™®(dl_comm) != 0)
    return 0;
  end;

  BeginAction( @NumAction, "è‡Æ¢•‡™† Ø•‡•≠„¨•‡†Ê®® ·§•´Æ™" );
  if( è‡Æ¢•‡®‚Ïè•‡•≠„¨•‡†Ê®Óë§•´Æ™(dl_comm) != 0 )
     return 0;
  end;

  BeginAction( @NumAction, "îÆ‡¨®‡Æ¢†≠®• £‡„ØØ Æ°‡†°Æ‚™®" );
  ë‰Æ‡¨®‡Æ¢†‚ÏÉ‡„ØØÎé°‡†°Æ‚™®(dl_comm);

  UnlimAccArr = Åì_ì·‚†≠Æ¢®‚ÏÅ•ß´®¨®‚ç†ëÁ•‚†ëê†ß°®¢™Æ©ç†è†Á™®(dl_comm);

  BeginAction( @NumAction, "é°‡†°Æ‚™† ´Æ‚Æ¢ ® ‰Æ‡¨®‡Æ¢†≠®• ™´®•≠‚·™®Â Ø‡Æ¢Æ§Æ™" );
//  ConvID = 14; //Ç†‡®†≠‚ ß†Ø„·™† ™Æ≠¢•©•‡† °„Â£†´‚•‡·™Æ£Æ „Á•‚† Åé ñÅ (‰Æ‡¨®‡Æ¢†≠®• ´Æ‚Æ¢)
//  UseConveyer = SecurUseConveyer(ConvID, OperID);
  if(UseConveyer)
//    var cnv1 = RsbConveyerExec(ConvID);
    var cnv1 = RsbConveyerExec( 14 ); //Ç†‡®†≠‚ ß†Ø„·™† ™Æ≠¢•©•‡† °„Â£†´‚•‡·™Æ£Æ „Á•‚† Åé ñÅ (‰Æ‡¨®‡Æ¢†≠®• ´Æ‚Æ¢)
    var rslObj1 = AccCnvDataDLCOMM(dl_comm.rec.DocumentID, true, msesCreator.GetProcessId(), false);
    cnv1.AddParamsForConveyer(SC_ACCCONVLOTS, rslObj1, 0);
    cnv1.AddParamsForOperation(SC_ACCCONVLOTS, OperID, rslObj1, "", 0);
    cnv1.showPanelMonitoring( 1 );
    if( (IsWebService != null) and (IsWebService == true) )
       cnv1.showPanelMonitoring(0);
    else
       cnv1.showPanelMonitoring(1);
    end;
    cnv1.Run();
    err = ErrorFromCnvpack( cnv1 );
  else
    err = ExecMacroFile("sc_accounting.mac", "ExecuteAccounting", 0, 0, SC_ACCCONVLOTS, 0, 0, AccCnvDataDLCOMM(dl_comm.rec.DocumentID, false, msesCreator.GetProcessId(), false));
  end;

  if (err == 0)
    err = ExecMacroFile("sc_accounting.mac", "ExecuteAccounting", 0, 0, SC_ACCCONVCARRY, 0, 0, AccCnvDataDLCOMM(dl_comm.rec.DocumentID, false, msesCreator.GetProcessId(), true));
  end;
  
  if( err == 0 )

    BeginAction( @NumAction, "îÆ‡¨®‡Æ¢†≠®• Ø‡Æ¢Æ§Æ™" );
    ConvID = 15; //Ç†‡®†≠‚ ß†Ø„·™† ™Æ≠¢•©•‡† °„Â£†´‚•‡·™Æ£Æ „Á•‚† Åé ñÅ (‰Æ‡¨®‡Æ¢†≠®• Ø‡Æ¢Æ§Æ™)
    UseConveyer = SecurUseConveyer(ConvID, OperID);
    if(UseConveyer)
    cmd = DL_RSDCommand("select 1 from dpmwrtgrp_dbt where t_DocKind = ? and t_DocID = ? and t_Party = -1 and rownum = 1");
    
    cmd.AddParam(dl_comm.rec.DocKind);
    cmd.AddParam(dl_comm.rec.DocumentID);
    
    if(cmd.GetCount() > 0)
      var cnv2 = RsbConveyerExec(ConvID);
      var rslObj2 = AccCnvDataDLCOMM(dl_comm.rec.DocumentID, true, msesCreator.GetProcessId(), false);
      cnv2.AddParamsForConveyer(SC_ACCCONVCARRY, rslObj2, 0);
      cnv2.AddParamsForOperation(SC_ACCCONVCARRY, OperID, rslObj2, "", 0);
      if( (IsWebService != null) and (IsWebService == true) )
        cnv2.showPanelMonitoring(0);
      else
        cnv2.showPanelMonitoring( 1 );
      end;
      cnv2.Run();
      err = ErrorFromCnvpack( cnv2 );

    end;
  else
    err = ExecMacroFile("sc_accounting.mac", "ExecuteAccounting", 0, 0, SC_ACCCONVCARRY, 0, 0, AccCnvDataDLCOMM(dl_comm.rec.DocumentID, false, msesCreator.GetProcessId(), false));
  end;

  if (err == 0)
    if (msesCreator.CheckHasData())
      //•·´® ®¨•Ó‚·Ô ¨•¶·•··®Æ≠≠Î• §†≠≠Î•, ≠†§Æ ®Â Æ°‡†°Æ‚†‚Ï
      err = é°‡†°Æ‚†‚Ïå•¶·•··®Æ≠≠Î•Ñ†≠≠Î•(msesCreator.CreateMSesClass());
    end;
  end;

    if( err == 0 )  

         BeginAction( @NumAction, "è‡Æ¢Æ§™® ØÆ ¢´†§•´ÏÊ†¨" );
         if(dl_comm.rec.Flag3 == SET_CHAR)
           Åì_è‡Æ¢Æ§™®èÆÇ´†§•´ÏÊ†¨(dl_comm);
         end;

         BeginAction( @NumAction, "è‡Æ¢Æ§™® ≠•‚‚®≠£†" );
         if(dl_comm.rec.Flag2 == SET_CHAR)
           Åì_é°‡†°Æ‚†‚Ïç•‚‚®≠£(dl_comm);
         end;

         BeginAction( @NumAction, "ë¢Æ§≠Î• Ø‡Æ¢Æ§™® ØÆ ™´®•≠‚†¨" );
         Åì_ë¢Æ§≠Î•è‡Æ¢Æ§™®èÆä´®•≠‚†¨(dl_comm);

      BeginAction( @NumAction, "è‡Æ¢Æ§™® ‡†·Á•‚Æ¢ ≠† °®‡¶•" );
      if(dl_comm.rec.Flag4 == SET_CHAR)
        var DataSet = DL_RSDCommand(
               " SELECT * " + 
               " FROM DDL_COMM_DBT" +
               " WHERE t_dockind = " + String(DL_SCACCOUNTING) + 
               " AND T_FLAG4 = chr(88)" +
               " AND T_COMMDATE = ? " + 
               " AND T_COMMSTATUS = 2" +
               " AND T_DOCUMENTID <> ? "
               );

        DataSet.AddParam(dl_comm.rec.commdate);
        DataSet.AddParam(dl_comm.rec.documentid);

        if(DataSet.GetCount() != 0)  
          if(GetTrue(false, "á† §†‚„ "+ dl_comm.rec.commdate +" „¶• •·‚Ï ß†™‡Î‚Î• ÆØ•‡†Ê®® · „·‚†≠Æ¢´•≠≠Æ© Æ‚¨•‚™Æ© \"ê†·Á•‚Î ≠† °®‡¶•\"!"
                           +"\n"+"ë‰Æ‡¨®‡Æ¢†‚Ï ØÆ¢‚Æ‡≠Æ Ø‡Æ¢Æ§™® ØÆ ·/Æ \"ê†·Á•‚Î · °®‡¶•©\"?"))
            Åì_è‡Æ¢Æ§™®ê†·Á•‚Æ¢ç†Å®‡¶•(dl_comm);
          end;
        else
          Åì_è‡Æ¢Æ§™®ê†·Á•‚Æ¢ç†Å®‡¶•(dl_comm);
        end;
      end;
  
      BeginAction( @NumAction, "è‡Æ¢•‡™† ≠„´•¢ÎÂ ™„ØÆ≠Æ¢/óè" );
      è‡Æ‚Æ™Æ´®‡Æ¢†‚Ïç„´•¢Î•ä„ØÆ≠Îóè(dl_comm);
  
      if((dl_comm.rec.FlagSecur == SET_CHAR) and (dl_comm.rec.ClientID == {OurBank}))
        è‡Æ‚Æ™Æ´®‡Æ¢†‚Ïé‚·„‚·‚¢®•ä„ØÆ≠†óèÇê•ØÆ(dl_comm);
      end;
  
      BeginAction( @NumAction, "é°‡†°Æ‚™† ™„ØÆ≠Æ¢" );
      Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚Îä„ØÆ≠Æ¢(dl_comm);
  
      BeginAction( @NumAction, "é°‡†°Æ‚™† óè" );
      Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚Îóè(dl_comm);

      BeginAction( @NumAction, "é°‡†°Æ‚™† †≠™•‚ Ê/°" );
      Åì_é°‡†°Æ‚†‚ÏÄ≠™•‚ÎñÅ(dl_comm);   

      /*á†™‡Î‚®• ·Á•‚Æ¢*/
      BeginAction( @NumAction, "á†™‡Î‚®• ØÆ·§•´ÆÁ≠ÎÂ ·Á•‚Æ¢" );
      SC_CCloseAccountAccounting(dl_comm).processDeal();

      BeginAction( @NumAction, "è‡Æ¢•‡™† ÆØ•‡†Ê®®" );
      è‡Æ¢•‡®‚Ïä‡†·≠Æ•ë†´Ï§Æ(dl_comm, UnlimAccArr);
      è‡Æ¢•‡®‚Ïé°‡†°Æ‚™„Åìß†í•™„È„ÓÑ†‚„(dl_comm);


      BeginAction( @NumAction, "è‡Æ¢•‡™† ™´®•≠‚·™®Â ·Á•‚Æ¢" );
      Åì_è‡Æ¢•‡™†ä´®•≠‚·™®ÂëÁ•‚Æ¢(dl_comm);

      BeginAction( @NumAction, "èÆ§£Æ‚Æ¢™† Ø‡Æ‚Æ™Æ´† ¢ÎØÆ´≠•≠®Ô ÆØ•‡†Ê®®" );
    else
      stat = 1;
    end;
  else
    stat = 1;
  end;

  Åì_ë≠Ô‚ÏÅ•ß´®¨®‚ç†ëÁ•‚†ëê†ß°®¢™Æ©ç†è†Á™®(UnlimAccArr);
  return stat;

  OnError(er)
    Åì_ë≠Ô‚ÏÅ•ß´®¨®‚ç†ëÁ•‚†ëê†ß°®¢™Æ©ç†è†Á™®(UnlimAccArr);
    var err_text = GetFullErrorMessage(er);
    if(isEqClass("TRsdError", er.err))
      MsgBox(err_text);
      RunError(err_text);
    else
      if(RslDefCon.IsInTrans)
        RslDefCon.RollbackTrans();
      end;
      MsgBox(err_text);
      return 1;
    end;
end;

macro StartAccounting(DocumentID, IsWebService)

  macro getDocumentName(id)
    var query = "select * from doprkdoc_dbt where t_dockind = " + id;
    var cmd = RSDCommand(query);
    var rs = RSDRecordSet(cmd);
    if (rs.movenext)
      return rs.value("t_name");
    else
      return "";
    end; 
  end;

  var stat = 0,
      dl_comm = TBFile("dl_comm.dbt");

  dl_comm.rec.DocumentID = DocumentID;
  if(not dl_comm.GetEQ())
    msgbox("éË®°™† ØÆ®·™† ÆØ•‡†Ê®®");
    return 1;
  end;

  //file docfcomm("dl_comm.dbt");
  //var dl_comm_old_rec = TRecHandler ("dl_comm");
  //var dl_comm_new_rec = TRecHandler ("dl_comm");
  //copy(dl_comm_old_rec,dl_comm);  

  //WriteFiscLog(OLstrproc, "ë‚†‡‚ ·•‡¢®·≠Æ© ÆØ•‡†Ê®® Å„Â£†´‚•‡·™®© „Á•‚. à¨Ô ‰†©´† - dl_comm_dbt. ID ÆØ•‡†Ê®® "+dl_comm.rec.documentid+
  //    ". í®Ø ÆØ•‡†Ê®® ("+dl_comm.rec.dockind+") "+getDocumentName(dl_comm.rec.dockind)+
  //    ". äÆ§ ÆØ•‡†Ê®® "+dl_comm.rec.commcode); 
  //WriteFiscLog(OLinsert,docfcomm,dl_comm_old_rec);

  InitProgress( 15, "ÇÎØÆ´≠•≠®• ÆØ•‡†Ê®® ...", "Å„Â£†´‚•‡·™®© „Á•‚" );

  ReplaceMacro( "msgbox", "ThisAccounting_msgbox" );

  RepErrArr.size = 0; //¨†··®¢ ÆË®°Æ™

  stat = __StartAccounting( dl_comm, IsWebService );

  SaveAccountingErrForReport_XML( RepErrArr, dl_comm.rec.DocumentID, dl_comm.rec.DocKind );

  ReplaceMacro( "msgbox", NULL );
  RemProgress();

  //WriteFiscLog(OLfinproc, "á†¢•‡Ë•≠®• ·•‡¢®·≠Æ© ÆØ•‡†Ê®® Å„Â£†´‚•‡·™®© „Á•‚. à¨Ô ‰†©´† - dl_comm_dbt. ID ÆØ•‡†Ê®® "+dl_comm.rec.documentid+
  //    ". í®Ø ÆØ•‡†Ê®® ("+dl_comm.rec.dockind+") "+getDocumentName(dl_comm.rec.dockind)+
  //    ". äÆ§ ÆØ•‡†Ê®® "+dl_comm.rec.commcode); 
  //copy(dl_comm_new_rec,dl_comm);  
  //WriteFiscLog(OLupdate,docfcomm,dl_comm_new_rec,dl_comm_old_rec);
  //WriteFiscLog(OLinsert,docfcomm,dl_comm_new_rec);

  return stat;
END;


macro PrintRollBackReport(comm)
  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*‰†©´ ¢Î¢Æ§† §´Ô Æ‚Á•‚†*/
  record DlComm("dl_comm");

  SetBuff(DlComm, comm);
  
  ReportFileName = GetTxtFileName( "accounting_" + DlComm.CommCode );
  if( not Open( ReportOutFile, ReportFileName ) )
     errcode = status(errtext);
     RunError( "éË®°™† Ø‡® ·Æß§†≠®® ‰†©´†|"+ReportFileName+"|(" + errcode + ") " + errtext );
  end;
  SetOutput( ReportFileName );

  var sql =  " select t_warning from DSCREPLOG_TMP group by t_warning order by t_warning ";
     
  var cmd = DL_RSDCommand(sql);

  var DataSet = cmd.execute();
  var i = 1, IsFirstUse = true;;

  while( DataSet.MoveNext() )
     if(IsFirstUse == true )
        println(" è‡Æ‚Æ™Æ´ Æ‚™†‚† ÆØ•‡†Ê®®");
        println("⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø");
        IsFirstUse = false;
     else
        println("√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥");
     end;

     [≥##########≥##############################################################≥]
     (i:r, DataSet.Warning:w);
     i = i + 1;

  end;

  if( IsFirstUse == false )
     println("¿ƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ");
  end;

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );

  return true;
end;
