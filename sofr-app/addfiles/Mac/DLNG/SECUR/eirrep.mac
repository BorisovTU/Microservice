/*
$Name:        eirrep.mac
$Module:      –¥­­ë¥ ¡ã¬ £¨
$Description: âç¥â ¯® ‘
*/

IMPORT FIInter,"DLReport_h.mac", "dlmisc.mac";
IMPORT "eirrep_form.mac";
import RsbDataSet;

var ToExcel;

private var ErrorString = "###############################################################################################################################";

private var Header = "                                              âçñâ ¯® ‘ ¯® ##################################";

var Footer = "‘®áâ ¢«¥­®: ##########\n\n";

private var TableHeader = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                          "³     „ â       ³ Š®«¨ç¥áâ¢® ³  ®àâä¥«ì  ³ ‘â®¨¬®áâì æ/¡ ³ Š„ «®â  ³ ‡ â à âë ³ â­¥á¥­. ­  ³  ç¨á«. ³  ç¨á«. ³  ç¨á«. ³ ¥à¥®æ¥­ª  ³  « ­á®¢ ï ³  ‘  ³ ’¥ªãé ï ª®àà. ¯à®æ. ¤® ³     €‘     ³     ‘‘     ³  ç «ì­ ï  ³ â­¥á¥­. ­  ¯àâ¡/ã¡ ³ ¥§¥à¢, àã¡. ³ ¥§¥à¢ ¯® ­ ç¨á«. ³ æ¥­®ç­ë© à¥§¥à¢, ³ Š®àà¥ªâ¨à®¢ª  ¤® ³ ‚¨¤ à áç¥â  ³   ‘â âãá   ³\n"+
                          "³               ³            ³            ³               ³          ³          ³    à áå®¤   ³ ¯à¥¬¨ï  ³   „    ³   „„    ³            ³ áâ®¨¬®áâì  ³       ³           ‘          ³            ³            ³              ³                   ³              ³        „„        ³        àã¡.       ³     ®æ¥­. à¥§.   ³      €‘     ³            ³\n"+
                          "³               ³            ³            ³               ³          ³          ³    § âà âë  ³         ³         ³         ³            ³            ³       ³                        ³            ³            ³              ³                     ³              ³                   ³                   ³                  ³             ³            ³\n"+
                          "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄ´"; 

PRIVATE VAR  m_Form = DL_EIRREP_Form();

class ReportData
  var Date = ZeroDate;
  var Amount = 0;
  var Portf;
  var Cost;
  var NKDamount;
  var Outlay;
  var WrtOutlay;
  var Bonus;
  var InterestIncome;
  var DiscountIncome;
  var OverAmount;
  var BalanceCost;
  var EffectInterestRate;
  var CorrIntToEIR;
  var AmortCost;
  var CorrValue;
  var BegDefDiff;
  var AccountedDefDiff;
  var ReservAmount;
  var IncomeReserv;
  var EstReserve;
  var CorrEstReserve;
  var NAtype;
  var NAstate;

end;
  
class (DL_CReportTemplate) Dl_EIRREP_Report
  macro PrintFooter(RepDate:date)
    PrintFormatString(NULL, "N1_F1", RepDate); 
    AddStandardFooter("N1_", true, false); 
    CopyAllSheetInTotalBook(NULL, false, "N1_Footer", 1);  
  end;
  private macro GetQuery(pSumID:integer):string
    var query = " SELECT v1.*, " +
                " Fin.t_Name, " +
                " NA1.t_szNameAlg NAstate, " +
                " NA2.t_szNameAlg NAtype, " +
                " Port.t_Code " +
                " FROM v_scwrthistex v1, " +
                " dfininstr_dbt Fin, " +
                " dnamealg_dbt NA1, " +
                " dnamealg_dbt NA2, " +
                " dllvalues_dbt Port, " +
                "      (  SELECT t_changedate, t_sumID " +
                "           FROM v_scwrthistex " +
                "       GROUP BY t_changedate, t_sumID) v2 " +
                " WHERE     v1.t_changedate = v2.t_changedate " +
                "       AND v1.t_sumID = v2.t_sumID " +
                "       AND v2.t_sumID = " + pSumID +
                "       AND v1.t_instance = " +
                "              (SELECT MAX (V11.t_instance) " +
                "                 FROM v_scwrthistex V11 " +
                "               WHERE     V11.t_sumid = V1.t_sumid  " +
                "                     AND V11.t_changedate <= v1.t_changedate) "+
                "       AND Fin.t_FIID=v1.t_FIID AND Fin.t_FI_KIND=2 " +
                "       AND NA1.t_iTypeAlg(+)=3118 AND NA1.t_iNumberAlg(+)=v1.t_State " + 
                "       AND NA2.t_iTypeAlg(+)=3116 AND NA2.t_iNumberAlg(+)=v1.t_AmortCalcKind " +
                "       AND Port.t_List(+)=1100 AND Port.t_Element(+)=v1.t_Portfolio " +
                " ORDER BY v1.t_changedate ";
    return query;
  end;

  private macro GetSumID(fiid:integer):integer
    var sumid = 0;
    var query = " SELECT q.t_sumID, t_date " +
                " FROM ( " +
                "         SELECT t_sumID, t_date " +
                "           FROM dpmwrtsum_dbt "  +
                "          WHERE t_FIID = ? " +
                "            and t_buy_sale = 0 " +
                "            and t_portfolio in (1, 2, 5) " +
                "            and t_state in (1, 3) " +
                "            and t_Amount > 0 " +
                "       ORDER BY t_date, t_sumID " +
                "      ) q " +
                " WHERE ROWNUM = 1 ";

    var cmd = RSDCommand(query);
    cmd.addParam("", RSDBP_IN, fiid);

    var DataSet = TRsbDataSet(cmd);
    if(DataSet.moveNext()) 
      sumid = DataSet.sumID;
    end;
    return sumid;
  end;

  private macro GetBuyID(fiid:integer):integer
    var buyid = 0;
    var query = " SELECT t_BUYID " +
                " FROM dpmwrtlnk_dbt " +
                "    WHERE t_lnkid = (SELECT MAX (lnk.t_lnkid) " +
                "                     FROM dpmwrtlnk_dbt lnk   " +
                "                        WHERE t_BuyID IN (SELECT t_sumID " +
                "                                          FROM dpmwrtsum_dbt " +
                "                                             WHERE t_FIID = " + fiid + "))";
    var DataSet = TRsbDataSet(query);
    while(DataSet.moveNext()) 
      buyid = DataSet.buyID;
    end; 
    return buyid;
  end;

  private macro PrintMode():INTEGER
     if(ToExcel)
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  end;

  private macro BeginReport()
    CreateTotalBook();
  end;

  private macro PrintLine(DataSet)
    PrintTableLine( "N1_A1",  date(DataSet.ChangeDate),   null,
                    "N1_A2",  DataSet.Amount,             null,
                    "N1_A3",  DataSet.Code,               null, //Portfolio
                    "N1_A4",  DataSet.Cost,               null,
                    "N1_A5",  DataSet.NKDAmount,          null,
                    "N1_A6",  DataSet.Outlay,             null,
                    "N1_A7",  DataSet.WrtOutlay,          null,
                    "N1_A8",  DataSet.Bonus,              null,
                    "N1_A9",  DataSet.InterestIncome,     null,
                    "N1_A10", DataSet.DiscountIncome,     null,
                    "N1_A11", DataSet.OverAmount,         null,
                    "N1_A12", DataSet.BalanceCost,        null,
                    "N1_A13", DataSet.EffectInterestRate, null,
                    "N1_A14", DataSet.CorrIntToEIR,       null,
                    "N1_A15", DataSet.AmortCost,          null,
                    "N1_A16", DataSet.CorrValue,          null,
                    "N1_A17", DataSet.BegDefDiff,         null,
                    "N1_A18", DataSet.AccountedDefDiff,   null,
                    "N1_A19", DataSet.ReservAmount,       null,
                    "N1_A20", DataSet.IncomeReserv,       null,
                    "N1_A21", DataSet.EstReserve,         null,
                    "N1_A22", DataSet.CorrEstReserve,     null,
                    "N1_A23", DataSet.NAtype,             null,
                    "N1_A24", DataSet.NAstate,            null);
  end;

  private macro EndReport()
    SaveTotalBook();
  end;

  macro PrintHead( name:string )
    SetActiveSheet( "âç¥â" );
    PrintFormatString( Header,
                      "N1_A0", name);
    CopyAllSheetInTotalBook( NULL, false, "N1_Header", 0 ); 
  end;

  macro PrintError( error:string )
    SetActiveSheet( "âç¥â" );
    PrintFormatString( ErrorString,
                      "N1_E1", error);
    CopyAllSheetInTotalBook( NULL, false, "N1_E1", 0 ); 
  end;

  macro PrintProtocol()
    var DataSet;

    PrintHead(FiName);
    CopyAllSheetInTotalBook("âç¥â", false, "N1_TableHead", 0, "âç¥â");
    var Rdata = ReportData();

    RegisterTable( "N1_MainTable", TableHeader,
                   "N1_A1",
                   "N1_A2",
                   "N1_A3",
                   "N1_A4",
                   "N1_A5",
                   "N1_A6",
                   "N1_A7",
                   "N1_A8",
                   "N1_A9",
                   "N1_A10",
                   "N1_A11",
                   "N1_A12",
                   "N1_A13",
                   "N1_A14",
                   "N1_A15",
                   "N1_A16",
                   "N1_A17",
                   "N1_A18",
                   "N1_A19",
                   "N1_A20",
                   "N1_A21",
                   "N1_A22",
                   "N1_A23",
                   "N1_A24" );
    var pSumID = 0;
    var Count = 0;
    var Num = 0;

    if(not(pSumID = GetSumID(FIID)))
       pSumID = GetBuyID(FIID);
    end;

    if(pSumID)  
      DataSet = TRsbDataSet("select count(*) as count from (" + GetQuery(pSumID) + ")");
      if(DataSet.moveNext())
        Count = DataSet.count;
        Num = 0;
        InitProgress(Count, "¥ç âì ®âç¥â ", "¥ç âì ®âç¥â ");
      end;
      
      DataSet = TRsbDataSet(GetQuery(pSumID));
      while( DataSet.moveNext() )
        PrintLine(DataSet);
        UseProgress(Num = Num + 1); 
      end;
      RemProgress();
    else
      Count = 0;
    end;
    if(ToExcel) 
      EndTable();
    end;
    if( not Count )
      PrintError("„«ï § ¤ ­­®© æ¥­­®© ¡ã¬ £¨ ­¥ ­ ©¤¥­ «®â");
    else
      CopyAllSheetInTotalBook("âç¥â", false, GetTableRange(), 0, "âç¥â");
      PrintFooter({curdate});
    end;
  end;

  macro Create()
    SetActiveSheet("âç¥â");
    PrintProtocol(); 
  end;

  macro PrintErrorMessage(msg:string)
    MsgBox( msg );
  end;

  initDL_CReportTemplate( null, "Report_EIR.xlsx", true, false, NULL, true);
END;


macro MakeReports()
  var stat = 0;

  
  stat = m_Form.Run();
  // à®¢¥àï¥¬ ¬®¦¥¬ «¨ ¬ë ¤¥« âì ®âç¥â ¯® ¯à¥¤®áâ ¢«¥­­ë¬ ¤ ­­ë¬
  if (not stat)
   return 1;
  end;
  ToExcel = m_Form.GetFieldValue(PNFLD_EIRREP_EXCEL);
  var Report = Dl_EIRREP_Report();
  Report.Run();

  return 0;
end;


while( not MakeReports() ) 
end;
exit(1);
