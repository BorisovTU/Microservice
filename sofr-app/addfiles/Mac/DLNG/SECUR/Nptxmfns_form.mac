/*
$Name:        nptxmfns_form.mac
$Module:      Ценные бумаги
$Description: Форма ввода данных для отчета "Сообщение в ФНС по счетам ИИС"
*/

import "DLRepForm_h.mac", "globals.mac", BankInter;
/*ak*/
import cb_sql;
import captureoutput;
/*~ak*/


PRIVATE CONST SelCodeKind = 1;
PRIVATE CONST ZERO_DATE = date(0, 0, 0);

/*Номера полей в форме отчета*/
CONST PNFLD_TXMFNS_ENDDATE      = 0,
      PNFLD_TXMFNS_INVESTORCODE = 1,
      PNFLD_TXMFNS_INVESTORNAME = 2,
      PNFLD_TXMFNS_CONTR_NUM    = 3,
/*ak*/
      PNFLD_TXMFNS_MES_NUM   = 4,
      PNFLD_TXMFNS_MES_KIND   = 5,
      PNFLD_TXMFNS_CORRECT_NUM  = 6,
      PNFLD_TXMFNS_FIOPERSON    = 7,
      PNFLD_TXMFNS_PRINTMETHOD  = 8;

/*~ak*
      PNFLD_TXMFNS_MES_NUM      = 6,
      PNFLD_TXMFNS_MES_KIND     = 7,
      PNFLD_TXMFNS_CORRECT_NUM  = 8,
      PNFLD_TXMFNS_PRINTMETHOD  = 9;
*/
CONST H_PNFLD_CLIENT_SDIIS_CODE = 100;
CONST H_PNFLD_CLIENT_SDIIS_NAME = 110;
CONST H_PNFLD_CLIENT_SDIIS_CONTR_NUM = 120;
CONST H_PNFLD_CLIENT_SDIIS_MES_NUM = 130;
CONST H_PNFLD_CORRECT_NUM               = 132;
CONST H_PNFLD_TXMFNS_FIOPERSON          = 135;
CONST H_PNFLD_CLIENT_SDIIS_MES_KIND = 140;
/*ak*/
CONST H_PNFLD_SIGN_SDIIS_CODE = 150;
CONST H_PNFLD_SIGN_SDIIS_NAME = 160;
/*~ak*/

CONST NPTXMFNS_REPORTKIND = 16837;
CONST MES_KIND_IISOPEN      = 1; // Открытие ИИС
CONST MES_KIND_IISOPENMOVE  = 2; // Открытие ИИС с переводом активов
CONST MES_KIND_IISCLOSE     = 3; // Закрытие ИИС
CONST MES_KIND_IISCLOSEMOVE = 4; // Закрытие ИИС с переводом активов
CONST MES_KIND_IISCORRECT   = 5; // Корректировка ИИС

var PartyID     =   -1;
var SfContrID   =   1;
/*ak*/
var Num = null;
/*~ak*/

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(FldRealValue != NULL)
    if( Cmd == DLG_INIT )
      FldShowValue = FldRealValue;
    end; 
    FldShowValue = FldRealValue;
  else
    FldShowValue = "";  
  end;
  
  return CM_DEFAULT;
END;

/*ak*/
macro GetGuid()
  var cmd, rs;
  //gtv: при наличии в строке chr(1) дальнейшая обработка падает
  //Golovkin 18.07.2019 ID : 490935 (IM2912674) ЕКК из договора
  StartCaptureOutput();
  [ 
    select  substr(guid,1,8)||'-'||substr(guid,9,4)||'-'||substr(guid,13,4)||'-'||substr(guid,17,4)||'-'||'D'
          ||substr(case WHEN contrcode.t_code IS NOT NULL or contrcode.t_code != chr(1) THEN contrcode.t_code
                        when t_mpcode is null or t_mpcode = chr(1) then '0' 
                        else t_mpcode end,1,9)
          ||'F'||substr(guid,21,9-length(substr(nvl(t_mpcode,'0'),1,9))) t_guid  
    from (select sys_guid() guid from dual)
    left join ddlcontr_dbt dlcontr on dlcontr.t_sfcontrid = ?
    left join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_sfcontrid = ? or dlcontrmp.t_dlcontrid = dlcontr.t_dlcontrid
    LEFT JOIN ddlobjcode_dbt contrcode  ON contrcode.t_objecttype = 207 and contrcode.t_Codekind = 1 /*and contrcode.t_state = 0*/ and  contrcode.t_objectid = dlcontr.t_dlcontrid
  ];
  cmd = RsdCommand(EndCaptureOutput());
  cmd.AddParam("sfcontrid1", RSDBP_IN, SfContrID);
  cmd.AddParam("sfcontrid2", RSDBP_IN, SfContrID);
  rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
  rs.movenext();
  return rs.value("t_guid");
end;

MACRO DL_FldProc_Signer_Code( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    var Party = TRecHandler("party.dbt");
    var partcode = TBFile( "partcode.dbt",  "R", 0 );
    var whereCond:string = "";

    if(Cmd == DLG_INIT)
        if(FldRealValue == NULL)
            FldRealValue = -1;
        end;

        if(FldRealValue > 0)
            partcode.Clear();
            partcode.rec.PartyID = FldRealValue;
            partcode.rec.CodeKind = SelCodeKind;
            if(partcode.GetEQ())
                FldShowValue = partcode.rec.Code;
            end;

            if( not ПолучитьСубъекта(FldRealValue, Party) )
                pThis.SetLinkedValue( H_PNFLD_SIGN_SDIIS_CODE, Party.rec.ShortName);
            end;
        end;
    elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
        FldRealValue = -1;
        FldShowValue = "";
        pThis.SetLinkedValue( H_PNFLD_SIGN_SDIIS_NAME, "" );
    elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
        whereCond = " t.t_LegalForm = 2 AND " +
                    " t.T_PARTYID IN ( select officer.t_personid "
                                     +"from dofficer_dbt officer "
                                     +"join dlegalproxy_dbt legalproxy on "
                                     + "    legalproxy.t_partyid = officer.t_partyid and "
                                     + "    legalproxy.t_proxyid = officer.t_personid and "
                                     + "    legalproxy.t_begindate <= " + GetSQLDate(pthis.GetFieldValue(PNFLD_TXMFNS_ENDDATE)) + " and "
                                     + "    legalproxy.t_enddate >= " + GetSQLDate(pthis.GetFieldValue(PNFLD_TXMFNS_ENDDATE)) + " "
                                     + "where officer.t_partyid = " + {OurBank} + " and "
                                     + "      (officer.t_isfirstperson = chr(88) or officer.t_issecondperson = chr(88)))";

        if( ListPText( Party, Party.rec.PartyID, whereCond) == true )
            FldRealValue = Party.rec.PartyID;
            partcode.Clear();
            partcode.rec.PartyID  = Party.rec.PartyID;
            partcode.rec.CodeKind = SelCodeKind;
            if (partcode.GetEQ())
                FldShowValue = partcode.rec.Code;
            end;
            pThis.SetLinkedValue( H_PNFLD_SIGN_SDIIS_NAME, Party.rec.ShortName);
        end;
    end;
    
    return CM_DEFAULT;
END;
/*~ak*/

MACRO DL_FldProc_Client_SDIIS_Code( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    var Party = TRecHandler("party.dbt");
    var partcode = TBFile( "partcode.dbt",  "R", 0 );
    var whereCond:string = "";

    if(Cmd == DLG_INIT)
        if(FldRealValue == NULL)
            FldRealValue = -1;
        end;

        if(FldRealValue > 0)
            partcode.Clear();
            partcode.rec.PartyID = FldRealValue;
            partcode.rec.CodeKind = SelCodeKind;
            if(partcode.GetEQ())
                FldShowValue = partcode.rec.Code;
                PartyID = partcode.rec.PartyID;
            end;

            if( not ПолучитьСубъекта(FldRealValue, Party) )
                pThis.SetLinkedValue( H_PNFLD_CLIENT_SDIIS_NAME, Party.rec.ShortName);
            end;
        end;
    elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
        FldRealValue = -1;
        FldShowValue = "";
/*ak
        pThis.SetLinkedValue( H_PNFLD_CLIENT_SDIIS_NAME, STR_ALLVALUE );
~ak*/
    elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
        whereCond = " t.t_LegalForm = 2 AND " +
                 " t.T_PARTYID IN ( SELECT c2.T_PARTYID " +
                                 "    FROM dclient_dbt c2 " +
                                 "   WHERE t.T_PARTYID = c2.T_PARTYID " + 
                                 "     AND c2.t_servicekind = " + string(PTSK_STOCKDL) + ")" +
/*ak
                                 "     AND EXISTS(SELECT 1 from dsfcontr_dbt sfcontr" +
                                 "                WHERE sfcontr.t_PartyID = t.t_PartyID" +
                                 "                AND sfcontr.t_ServKind = 1" +
                                 "                AND rsi_npto.CheckContrIIS(sfcontr.t_ID) = 1)";*/

                                 "     and exists(select 1 " +
                                 "                from dsfcontr_dbt sfcontr " +
                                 "                join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_sfcontrid = sfcontr.t_id " +
                                 "                join ddlcontr_dbt dlcontr on dlcontr.t_dlcontrid = dlcontrmp.t_dlcontrid and " +
                                 "                                             dlcontr.t_iis = chr(88) " +
                                 "                where sfcontr.t_partyid = t.T_PARTYID and " +
                                 "                      sfcontr.t_servkind = " + string(PTSK_STOCKDL) + ")";
/*~ak*/

        if( ListPText( Party, Party.rec.PartyID, whereCond) == true )
            FldRealValue = Party.rec.PartyID;
            partcode.Clear();
            partcode.rec.PartyID  = Party.rec.PartyID;
            partcode.rec.CodeKind = SelCodeKind;
            if (partcode.GetEQ())
                FldShowValue = partcode.rec.Code;
/*ak
                var Query = "select sfcontr.t_ID as ID" +
                        " from dsfcontr_dbt sfcontr" +
                        " where sfcontr.t_ServKind = 1" +
                        "   and rsi_npto.CheckContrIIS(sfcontr.t_ID) = 1" +
                        "   and sfcontr.t_PartyID = " + Party.rec.PartyID +
                        "   and sfcontr.t_DateConc = (select MAX(sfcontr2.t_DateConc)" +
                                                      " from dsfcontr_dbt sfcontr2" +
                                                      " where sfcontr2.t_ServKind = 1" +
                                                        " and rsi_npto.CheckContrIIS(sfcontr2.t_ID) = 1" +
                                                        " and sfcontr2.t_PartyID = " + string(Party.rec.PartyID) + ")";

                var Sql = RSDCommand(Query);
                Sql.AddParam("", RSDBP_IN, SfContrID);
                Sql.AddParam("", RSDBP_IN, OBJTYPE_SFCONTR);*/

                var Query = " select sfcontr.t_id id " +
                            " from dsfcontr_dbt sfcontr " +
                            " join ddlcontr_dbt dlcontr on dlcontr.t_sfcontrid = sfcontr.t_id and " +
                            "                              dlcontr.t_iis = chr(88) " +
                            " where sfcontr.t_partyid = " + Party.rec.PartyID + " " +
                            " order by t_dateconc desc";
/*~ak*/
                var Sql = RSDCommand(Query);
                Sql.execute();
                var SqlData = TRsbDataSet(Sql);

                if(SqlData.MoveNext())
                    pThis.SetLinkedValue( H_PNFLD_CLIENT_SDIIS_CONTR_NUM, SqlData.ID);
                end;
            end;
            pThis.SetLinkedValue( H_PNFLD_CLIENT_SDIIS_NAME, Party.rec.ShortName);
        end;
    end;
    
    PartyID = FldRealValue;
    return CM_DEFAULT;
END;

MACRO DL_FldProc_ContrIIS_NUM( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    var SfContr = TRecHandler("sfcontr.dbt");
    
    if( Cmd == DLG_INIT )
        if(FldRealValue == NULL)
            FldRealValue = -1;
        end;

        if(FldRealValue > 0)
            var Query = "select sfcontr.t_Number as Num" +
                        " from dsfcontr_dbt sfcontr" +
                        " where sfcontr.t_ID = " + string(FldRealValue) +
			" order by sfcontr.t_dateconc";

             var Sql = RSDCommand(Query);
             Sql.execute();
             var SqlData = TRsbDataSet(Sql);
 
             if(SqlData.MoveNext())
                FldShowValue = SqlData.Num;
             end;
            SfContrID = FldRealValue;
            pThis.SetLinkedValue( H_PNFLD_CLIENT_SDIIS_MES_NUM, GetGuid() );
        elif(FldRealValue == 0)
            FldShowValue = "";
            pThis.SetLinkedValue( H_PNFLD_CLIENT_SDIIS_MES_NUM, "" );
        end;
    elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
        if( pThis.GetFieldValue(PNFLD_TXMFNS_INVESTORCODE) == -1 )
            msgbox("Необходимо выбрать инвестора");
            return CM_IGNORE;
        end;

        if( ListContrIIS(SfContr, PartyID) )
            FldRealValue = SfContr.rec.ID;
            FldShowValue = SfContr.rec.Number;
            SfContrID = SfContr.rec.ID;
        end;
        pThis.SetLinkedValue( H_PNFLD_CLIENT_SDIIS_MES_NUM, GetGuid() );
    end;    

    return CM_DEFAULT;
END;
     
MACRO DL_FldProc_MesNum( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  var party = TRecHandler("party.dbt");
  var whereCond = "";
  var count = 0;

  if(Cmd == DLG_INIT)
     var Query = "select count(1) as t_Count" +
                 " from ddl_report_stat_dbt" +
                 " where t_ReportKind = " + string(NPTXMFNS_REPORTKIND);
     var Select = DL_RSDCommand(Query);
     var DataSet = Select.Execute();
     if(DataSet.MoveNext())
        count = DataSet.Count;
     end;

     FldShowValue = FldRealValue = Int(count + 1);
  end;

    return CM_DEFAULT;
END;

MACRO DL_FldProc_Mes_Kind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    MACRO Name( Id:INTEGER )
     if( Id == MES_KIND_IISOPEN )
        return "открытие ИИС";
     elif( Id == MES_KIND_IISCLOSE )
        return "закрытие ИИС";
     elif( Id == MES_KIND_IISCLOSEMOVE )
        return "закрытие ИИС с переводом активов";   
     elif( Id == MES_KIND_IISCORRECT )
        return "корректировка ИИС";
     elif( Id == MES_KIND_IISOPENMOVE )
        return "открытие ИИС с переводом активов";
     end;                                           
     return "";
    END;

    var itemName:string;
    var item:integer;
    if( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
        DL_ListString( null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                    Name(MES_KIND_IISOPEN), MES_KIND_IISOPEN,
                    Name(MES_KIND_IISOPENMOVE), MES_KIND_IISOPENMOVE,
                    Name(MES_KIND_IISCLOSE), MES_KIND_IISCLOSE,
                    Name(MES_KIND_IISCLOSEMOVE), MES_KIND_IISCLOSEMOVE,
                    Name(MES_KIND_IISCORRECT), MES_KIND_IISCORRECT
                  );
       if(FldRealValue == MES_KIND_IISCORRECT)
          EnableFields( pThis.Data(), PNFLD_TXMFNS_CORRECT_NUM );
       else
          DisableFields( pThis.Data(), PNFLD_TXMFNS_CORRECT_NUM );
          pThis.SetLinkedValue( H_PNFLD_CORRECT_NUM, 0 );
       end;
    elif(Cmd == DLG_INIT)
	FldRealValue = 1;
	FldShowValue = Name(FldRealValue);	
        //FldRealValue = -1;
    end;

    return CM_DEFAULT
END;

// Номер корректировки
private MACRO FldProc_Correct_Num( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR Day, Month, OldYear;

  if( Cmd == DLG_INIT ) /*Инициализация по умолчанию*/
     FldShowValue = FldRealValue;
     DisableFields( pThis.Data(), PNFLD_TXMFNS_CORRECT_NUM );
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
     if( (FldRealValue < 0) OR (FldRealValue > 999) ) /*максимально исключить опечатки*/
        MsgBox( "Неверное значение в поле \"Номер корректировки\".");
        return CM_IGNORE;
     end;
  end;
  return CM_DEFAULT;
END;

// Наименование сотрудника нашего банка, у которого установлен признак "Право подписи отчетов" и в поле "Перечень отчетов" = "Сообщение в ФНС по счетам ИИС"
MACRO DL_FldProc_FIOPerson( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  var party = TRecHandler("party.dbt");
  var whereCond = "";

  if(Cmd == DLG_INIT)
     if(FldRealValue == NULL)
        FldRealValue = -1;
     end;

     if(FldRealValue <= 0)
        FldShowValue = "";
        pThis.SetLinkedValue( H_PNFLD_TXMFNS_FIOPERSON, STR_ALLVALUE);
     else
        if(not ПолучитьСубъекта(FldRealValue, party))
           FldShowValue = party.rec.Name;
           pThis.SetLinkedValue(H_PNFLD_TXMFNS_FIOPERSON, party.rec.Name);
        end;
     end;
  elif((Cmd == DLG_KEY) and (Key == KEY_SPACE))
     FldRealValue = -1;
     FldShowValue = "";
     pThis.SetLinkedValue(H_PNFLD_TXMFNS_FIOPERSON, STR_ALLVALUE);
  elif((Cmd == DLG_KEY) and (Key == KEY_F3))
     whereCond = " exists(" +
                 "          select 1 from dofficer_dbt officer" +
                 "          where officer.t_PartyID = " + string({OurBank}) +
                 "            and officer.t_PersonID = t.t_PartyID" +
                 "       )";

     if(ListPText(party, party.rec.PartyID, whereCond))
        FldRealValue = party.rec.PartyID;
        FldShowValue = party.rec.Name;
        pThis.SetLinkedValue(H_PNFLD_TXMFNS_FIOPERSON, party.rec.Name);
     end;
  end;

  return CM_DEFAULT; 
END;

MACRO FldProc_NpTxPrintMethod( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  MACRO Name( Id:INTEGER )
     if( Id == DL_OUTREPORT_EXCEL )
        return "Excel";
     elif( Id == DL_OUTREPORT_XML )
        return "XML";
     end;                                           
     return "";
  END;

  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
/*ak*/
        FldRealValue = DL_OUTREPORT_EXCEL;
        FldRealValue = DL_OUTREPORT_XML;
/*~ak*/
     end;
     FldShowValue = Name(FldRealValue);
/*ak
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
     DL_ListString( null, pThis.CurrentFldX(), pThis.CurrentFldY(), @FldShowValue, @FldRealValue,
                    Name(DL_OUTREPORT_EXCEL),DL_OUTREPORT_EXCEL,
                    Name(DL_OUTREPORT_XML),  DL_OUTREPORT_XML
                  );
~ak*/
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) NPTX_MES_FNS_Panel()

    VAR IsMessageBoxNO = false;
    
    PRIVATE MACRO Init()
	/*дата*/
        AddFieldProc( 0, PNFLD_TXMFNS_ENDDATE,      DL_PNFLD_ENDDATE,              @DL_FldProc_EndDate, {curdate} );
	/*Инвестор_код*/
        AddFieldProc( 0, PNFLD_TXMFNS_INVESTORCODE, H_PNFLD_CLIENT_SDIIS_CODE,     @DL_FldProc_Client_SDIIS_Code );
	/*Инвестор_имя*/
        AddFieldProc( 0, PNFLD_TXMFNS_INVESTORNAME, H_PNFLD_CLIENT_SDIIS_NAME,     @Default );
	/*Номер договора*/
        AddFieldProc( 0, PNFLD_TXMFNS_CONTR_NUM,    H_PNFLD_CLIENT_SDIIS_CONTR_NUM,@DL_FldProc_ContrIIS_NUM );
/*ak
	/*Пописант_код*/
        AddFieldProc( 0, PNFLD_TXMFNS_SIGNERCODE,   H_PNFLD_SIGN_SDIIS_CODE,       @DL_FldProc_Signer_Code );
	/*Подписант_имя*/
        AddFieldProc( 0, PNFLD_TXMFNS_SIGNERNAME,   H_PNFLD_SIGN_SDIIS_NAME,       @Default );
~ak*/
	/*Номер сообщения*/
        AddFieldProc( 0, PNFLD_TXMFNS_MES_NUM,      H_PNFLD_CLIENT_SDIIS_MES_NUM,  @DL_FldProc_MesNum );
	/*Вид сообщения*/
        AddFieldProc( 0, PNFLD_TXMFNS_MES_KIND,     H_PNFLD_CLIENT_SDIIS_MES_KIND, @DL_FldProc_Mes_Kind, NULL, 17, 9 );
	/*Номер корректировки*/
        AddFieldProc( 0, PNFLD_TXMFNS_CORRECT_NUM,  H_PNFLD_CORRECT_NUM,           @FldProc_Correct_Num, 0 );
        /*Подписант*/
        AddFieldProc( 0, PNFLD_TXMFNS_FIOPERSON,    H_PNFLD_TXMFNS_FIOPERSON,      @DL_FldProc_FIOPerson, NULL, 17, 9 );
	/*способ формирования отчета*/
        AddFieldProc( 0, PNFLD_TXMFNS_PRINTMETHOD,  DL_PNFLD_PRINTMETHOD,          @FldProc_NpTxPrintMethod, NULL, 30, 10);
    END;

    PRIVATE MACRO Check():BOOL    

        if( this.GetFieldValue(PNFLD_TXMFNS_ENDDATE) == ZERO_DATE )
            msgbox("Необходимо ввести отчетную дату");
            return false;
        end;

        if( this.GetFieldValue(PNFLD_TXMFNS_INVESTORCODE) == -1 )
            msgbox("Необходимо выбрать инвестора");
            return false;
        end;

/*ak
        if( this.GetFieldValue(PNFLD_TXMFNS_SIGNERCODE) == -1 )
            msgbox("Необходимо выбрать подписанта");
            return false;
        end;
~ak*/

        if( this.GetFieldValue(PNFLD_TXMFNS_CONTR_NUM) == -1 )
            msgbox("Необходимо ввести номер договора");
            return false;
        end;

        if( this.GetFieldValue(PNFLD_TXMFNS_MES_NUM) == "" )
            msgbox("Необходимо ввести номер сообщения");
            return false;
        end;

        if( this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == -1 )
            msgbox("Необходимо выбрать вид сообщения");
            return false;
        end;

        if( (this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISCORRECT) and (this.GetFieldValue(PNFLD_TXMFNS_CORRECT_NUM) == 0) )
            msgbox("Укажите последовательный номер корректировки от 1 до 998.\nЗначение 999 используется для аннулирования ранее отправленного Сообщения");
            return false;
        end;

        var SfContr = TBFile("sfcontr.dbt", "R", 0);
        SfContr.rec.ID = SfContrID;
        SfContr.GetEQ();
        var d = SfContr.rec.DateClose;

/*ak 
        var Query = "select acc.t_CLOSE_DATE CloseDate, acc.T_ACCOUNT account"+
                    " from DACCOUNT_DBT acc, DSFCONTR_DBT sfcontr, DSFSSI_DBT sfssi, DSETTACC_DBT settacc"+
                    " where sfcontr.T_ID = ?"+
                    "   AND sfssi.T_OBJECTTYPE = ?"+
                    "   AND sfssi.T_OBJECTID = lpad(to_char(SFCONTR.T_ID),10,'0')"+
                    "   AND settacc.T_SETTACCID = sfssi.T_SETACCID"+
                    "   AND acc.T_ACCOUNT = settacc.T_ACCOUNT"+
                    "   AND acc.T_CODE_CURRENCY = sfssi.T_FIID";

        var Sql = RSDCommand(Query);
        Sql.AddParam("", RSDBP_IN, SfContrID);
        Sql.AddParam("", RSDBP_IN, OBJTYPE_SFCONTR);*/

        var Query = "select acc.t_CLOSE_DATE CloseDate, acc.T_ACCOUNT account "
                  + "from ddlcontr_dbt dlcontr "
                  + "join ddlcontrmp_dbt dlcontrmp on dlcontrmp.t_dlcontrid = dlcontr.t_dlcontrid "
                  + "join dsfcontr_dbt sfcontr on sfcontr.t_id = dlcontrmp.t_sfcontrid and "
                  + "                  sfcontr.t_servkind = 1 and "
                  + "                  sfcontr.t_servkindsub = 8 "
                  + "join DSFSSI_DBT sfssi on sfssi.T_OBJECTTYPE = ? AND "
                  + "                         sfssi.T_OBJECTID = lpad(to_char(SFCONTR.T_ID),10,'0') "
                  + "join DSETTACC_DBT settacc on settacc.T_SETTACCID = sfssi.T_SETACCID "
                  + "join DACCOUNT_DBT acc on acc.T_ACCOUNT = settacc.T_ACCOUNT AND "
                  + "                  acc.T_CODE_CURRENCY = sfssi.T_FIID "
                  + "where dlcontr.t_sfcontrid = ?";
        var Sql = RSDCommand(Query);
        Sql.AddParam("", RSDBP_IN, OBJTYPE_SFCONTR);
        Sql.AddParam("", RSDBP_IN, SfContrID);
/*~ak*/

        Sql.execute();
        var SqlData = TRsbDataSet(Sql);
        var dacc:date = ZERO_DATE;
        var account:string = "";
        var sfcnum:string = "";
        var issfcacc = true;

        var QuerySfCNum = "select T_NUMBER num from DSFCONTR_DBT where T_ID = ?";
        var SqlSfCNum = RsdCommand(QuerySfCNum);
        SqlSfCNum.AddParam("", RSDBP_IN, SfContrID);
        SqlSfCNum.execute();
        var SqlSfCNumData = TRsbDataSet(SqlSfCNum);
        SqlSfCNumData.MoveNext();
        SfCNum = SqlSfCNumData.num;
        
        if( SqlData.MoveNext() )
            dacc = SqlData.CloseDate;
            account = SqlData.account;
        else
            issfcacc = false;
        end;
        
        if( this.GetFieldValue(PNFLD_TXMFNS_PRINTMETHOD) == -1 )
            msgbox("Необходимо выбрать способ формирования отчета");
            return false;
        else
            if( (this.GetFieldValue(PNFLD_TXMFNS_PRINTMETHOD) == DL_OUTREPORT_EXCEL) and
                   (((this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISCLOSE) or (this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISCLOSEMOVE))) and
                   ((d == ZERO_DATE) or (dacc == ZERO_DATE))
               )
                var MsgRes = MsgBoxEx("Счет " + account + " и/или договор обслуживания " + sfcnum + " не закрыт / не закрыты. Сформировать сообщение?", MB_YES + MB_NO + MB_CANCEL, IND_YES, "Сообщение", "");
                if(MsgRes == IND_NO)
                    IsMessageBoxNO = true;
                    exit(1);
                elif(MsgRes == IND_YES)
                    IsMessageBoxNO = false;
                    return true;
                else
                    return false;
                end;
            else
                if( (this.GetFieldValue(PNFLD_TXMFNS_PRINTMETHOD) == DL_OUTREPORT_EXCEL) and
                        (issfcacc == false) and
                        ((this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISOPEN) or (this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISOPENMOVE))
                  )
                  MsgRes = MsgBoxEx("Для договора " + SfCNum + " не указан счет ИИС. Сформировать сообщение?", MB_YES + MB_NO + MB_CANCEL, IND_YES, "Сообщение", "");
                  if(MsgRes == IND_NO)
                    IsMessageBoxNO = true;
                    exit(1);
                  elif(MsgRes == IND_YES)
                    IsMessageBoxNO = false;
                    return true;
                  else
                    return false;
                  end;
                else
                    if( (this.GetFieldValue(PNFLD_TXMFNS_PRINTMETHOD) == DL_OUTREPORT_XML) and
                           (((this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISCLOSE) or (this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISCLOSEMOVE))) and
                           ((d == ZERO_DATE) or (dacc == ZERO_DATE))
                       )
                       msgbox("Счет " + account + " и/или договор обслуживания " + SfCNum + " не закрыт / не закрыты. Формирование сообщения невозможно.");
                       return false;
                    elif( (this.GetFieldValue(PNFLD_TXMFNS_PRINTMETHOD) == DL_OUTREPORT_XML) and
                            (issfcacc == false) and
                           (((this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISOPEN) or (this.GetFieldValue(PNFLD_TXMFNS_MES_KIND) == MES_KIND_IISOPENMOVE))) and
                           ((d == ZERO_DATE) or (dacc == ZERO_DATE))
                        )
                        msgbox("Для договора " + SfCNum + " не указан счет ИИС. Формирование сообщения невозможно.");
                        return false;
                    end;
                end;
            end;    
        end;

        return true;
    END;

/*ak    */
    initDL_CPanel( "sp_rep.lbr", "NPTXMFNS" );
    //initDL_CPanel( "sp_repu.lbr", "NPTXMFNS" );
/*~ak*/
end;
