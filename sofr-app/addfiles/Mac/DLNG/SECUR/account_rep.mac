import rsd;
import or_rep_h, globals, oralib, likepy, or_tpl_h;
import fiinter;
import "sp_categ.mac";
import RsbFormsInter;

//Переменные для варианта WindowsReports, поддерживающего POIReports
var csvFile, fName, csvTable, printEngine;

var flag = 0;

macro GetBO(account)
  var query = "select t_dockind from dmcaccdoc_dbt where t_account = '" + account + "' and t_dockind <> 0 " + 
              "union " +
              "select distinct t_DOCKIND from dpmpaym_dbt " +
              "where (t_payeraccount = '" + account + "' or t_receiveraccount = '" + account + "') and t_dockind <> 322";
  var data = RsdRecordSet(query);
  if ( data.MoveNext() )
    if ( (data.value(0) == 101) or (data.value(0) == 107) or (data.value(0) == 5) or (data.value(0) == 4607) or (data.value(0) == 3001))
      return "БОЦБ";
    elif ( (data.value(0) == 102) or (data.value(0) == 103) )
      return "МБК";
    elif ( (data.value(0) == 4813) or (data.value(0) == 199) or (data.value(0) == 140) or (data.value(0) == 194) )
      return "ФИССиКО";
    elif (data.value(0) == 109)
      return "Векселя";
    else
      return "?";
    end;
  elif ( (SubStr(account, 1, 5) == "40701") or (SubStr(account, 1, 5) == "40817") or (SubStr(account, 1, 5) == "60312") )
     return "БОЦБ";
  else
     return "";
  end;
end;

Private macro GetRep()

   if (GetTRUE (TRUE,"Выводить в отчет остатки по счетам 306* ?"))
     flag = 1;
   end;

    csvTable = printEngine.RegisterTable("templateTable", "templateTableHeader", true);
    csvFile = C_CSVFile();
    if (printEngine.UsePoi())
      csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
    end;
    fName = csvFile.CreateFullFileName("account_rep_mac_csv.txt");
    csvFile.FileOpen(fName, true);

    printEngine.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, "Отчет по счетам");

   var cmd;
   if(flag == 0) //Если счета 306* не включаем в выборку
       cmd = string("SELECT distinct  ac.t_account, "+
       "  ac.t_nameaccount, "+
       "  ac.t_oper, "+
       "  RSI_RSB_ACCOUNT.RESTALL (ac.t_account,  ac.t_chapter, ac.t_code_currency, TO_DATE ('"+{curdate}+"', 'dd.mm.yyyy')) AS Rest, "+
       "  ac.t_kind_account " + 
       "       FROM daccount_dbt ac "+     
       "       WHERE     (ac.t_type_account = 'Ф' OR ac.t_type_account = 'О') "+
       "          AND t_open_close <> 'З' "+
       "          and AC.T_CHAPTER=1 "+
       "          and substr(ac.t_account, 1, 3) <> '306' "+
       "          and substr(ac.t_account, 1, 5) <> '40701' "+
       "          and substr(ac.t_account, 1, 5) <> '40817' "+
       "     order by AC.T_ACCOUNT   "  ); 
  else  //Если счета 306* включаем в выборку
       cmd = string("SELECT distinct  ac.t_account, "+
       "  ac.t_nameaccount, "+
       "  ac.t_oper, "+
       "       RSI_RSB_ACCOUNT.RESTALL (ac.t_account,  ac.t_chapter, ac.t_code_currency, TO_DATE ('"+{curdate}+"', 'dd.mm.yyyy')) AS Rest, "+
       " ac.t_kind_account " + 
       "       FROM daccount_dbt ac "+     
       "       WHERE     (ac.t_type_account = 'Ф' OR ac.t_type_account = 'О') "+
       "          AND t_open_close <> 'З' "+
       "          and substr(ac.t_account, 1, 5) <> '40701' "+
       "          and substr(ac.t_account, 1, 5) <> '40817' "+
       "          and AC.T_CHAPTER=1 "+
       "     order by AC.T_ACCOUNT   "  ); 
   end;

   var rs = RsdRecordset(cmd);
   while (rs.movenext)
      if ( ((rs.value(4) == "А") and (rs.value(3) > 0)) or ((rs.value(4) == "П") and (rs.value(3) < 0)) )
        csvFile.AddCell(rs.value(0));
        csvFile.AddCell("");
        csvFile.AddCell(rs.value(1));
        csvFile.AddCell(rs.value(2));
        csvFile.AddCell(rs.value(3));
        csvFile.AddCell(GetBO(rs.value(0)));   /*SVE 496559*/
        csvFile.AddRow();
      end;
   end;

    csvFile.FileClose();
    csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
    csvTable.EndTable();

    printEngine.CopyAllSheetInTotalBook(null,         //Имя закладки,по умолчанию имя закладки из шаблона
                                      false, // true - на новый лист, false - на существующий(если имя листа отличается, всегда на новый лист)
                                      csvTable.GetTableRange(),     //Что копировать м.б. диапозон вида "A1:T60" или имя именованного диапозона
                                        0,
                                      "Отчет по счетам") ;


End;

/*
  Инциализируем класс Отчёта
*/
macro initRep()
    printEngine=CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);

    if(printEngine.UsePoi())
      printEngine.SetXLSXFormat();
    end;

    printEngine.CreateTotalBook();

    InitProgress(-1, "", "");

    printEngine.OpenTemplate("account_rep_mac.xlsx", true);
    printEngine.SheetChange(1);
   
end;

/*
  Показать окно отчёта
*/
macro showRep()
    printEngine.Close();
    printEngine.SaveTotalBook("report_OD24");
end;

   if (GetTRUE (TRUE,"Выпустить отчет по счетам с безлимитом"))
      initRep();
      GetRep();
      showRep();

      exit(1);
   else
     return 0;
   end;



