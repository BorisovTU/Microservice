/*
$Name:        BrokerPrognos_Report.mac
$Module:      Ценные бумаги
$Description: Отчет брокера о проведенных операциях. 
              Формирование отчета.
*/

import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "dldlngfun.mac", "spRepFun.mac";
import "BrokerPrognos_Form.mac";


private class TAmountMove
  var inAmount:numeric = $0.0,
      outAmount:numeric = $0.0;
end;
/* ************************ */
/* класс данных Движение ЦБ */
/* ************************ */
private class TFIMove(_FIID:integer, _nameFI:string, _inAmount:numeric)
  var FIID:integer     = _FIID, 
      nameFI:string    = _nameFI,
      inAmount:numeric = _inAmount,
      fiMoveT0:TAmountMove      = TAmountMove(),
      fiMoveT1      = TAmountMove(),
      fiMoveT2      = TAmountMove(),
      fiMoveTPlus   = TAmountMove();
  
  macro AddAmount(countDays:integer, in:numeric, out:numeric)
    if (countDays == 0)
      fiMoveT0.inAmount  = fiMoveT0.inAmount + in;
      fiMoveT0.outAmount = fiMoveT0.outAmount + out;
    elif (countDays == 1)
      fiMoveT1.inAmount  = fiMoveT1.inAmount + in;
      fiMoveT1.outAmount = fiMoveT1.outAmount + out;
    elif (countDays == 2)
      fiMoveT2.inAmount  = fiMoveT2.inAmount + in;
      fiMoveT2.outAmount = fiMoveT2.outAmount + out;
    elif (countDays > 2)
      fiMoveTPlus.inAmount  = fiMoveTPlus.inAmount + in;
      fiMoveTPlus.outAmount = fiMoveTPlus.outAmount + out;
    end;
  end;
end;
/* ************************************** */
/* класс данных Движение денежных средств */
/* ************************************** */
private class CMoneyMove()
  var amountMoveT0    = TAmountMove(),
      amountMoveT1    = TAmountMove(),
      amountMoveT2    = TAmountMove(),
      amountMoveTPlus = TAmountMove();

  macro AddAmount(countDays:integer, in:numeric, out:numeric)
    if (countDays == 0)
      amountMoveT0.inAmount  = amountMoveT0.inAmount + in;
      amountMoveT0.outAmount = amountMoveT0.outAmount + out;
    elif (countDays == 1)
      amountMoveT1.inAmount  = amountMoveT1.inAmount + in;
      amountMoveT1.outAmount = amountMoveT1.outAmount + out;
    elif (countDays == 2)
      amountMoveT2.inAmount  = amountMoveT2.inAmount + in;
      amountMoveT2.outAmount = amountMoveT2.outAmount + out;
    elif (countDays > 2)
      amountMoveTPlus.inAmount  = amountMoveTPlus.inAmount + in;
      amountMoveTPlus.outAmount = amountMoveTPlus.outAmount + out;
    end;
  end;
end;

/* *********************************************** */
/* */
/* *********************************************** */
private class (DL_CReportTemplate) CBrokerPrognos_Report(paramReport)
  private var m_paramReport = paramReport;
  private var m_sumPrec = 2, m_sumPrecFI = 6;
  private var HeaderBranch = "                                                                     Отчет брокера о проведенных биржевых операциях                                                                     \n" +
                             "########################################################### ##################################            ########## г.                                                                 \n" +
                             "\n";
  private var HeaderClient = "\n"+                            
                             "###########################################################  ##################################  Договор №: ###################### от ########## г.      счет №  #######################\n" +     
                             "\n";
  private var TableA_Name   = "        Денежные средства - входящий остаток       \n";
  private var TableA_Header = "┌─────────────────────────────┬───────────────────┐\n"
                              "│                             │       Итого       │\n"
                              "├─────────────────────────────┼───────────────────┤";

  private var TableB_Name    = "                   Ценные бумаги - входящий остаток               \n";
  private var TableL_Name    = "                   Ценные бумаги - исходящий остаток              \n";
  private var TableBL_Header = "┌─────────────────────────────────────────────┬──────────────────┐\n"
                               "│           Наименование, тип ЦБ              │      Остаток     │\n"
                               "├─────────────────────────────────────────────┼──────────────────┤";

  private var TableC_Name     = "                                                                                    Сделки на ММВБ - исполнение ранее заключенных сделок                                                                                   \n";
  private var TableD_Name     = "                                                                                    Сделки на ММВБ - заключенные и завершенные сделки (ТО)                                                                                   \n";
  private var TableE_Name     = "                                                                                    Сделки на ММВБ - заключенные и незавершенные сделки (Т+)                                                                               \n";
  private var TableСDE_Header = "┌─────────────────────────┬──────────┬──────────┬────────────────────────────┬───────────────────────────────┬────────────────┬────────────────┬────────────────┬────────────────┬────────────────┬────────────┬──────────┐\n" +
                                "│      Номер сделки       │   Дата   │   Время  │         Вид сделки         │     Наименование, тип ЦБ      │ Кол-во ЦБ, шт. │      Цена      │     Сумма      │      НКД       │    Комиссия    │Дата перере-│   Дата   │\n" +
                                "│                         │заключения│          │                            │                               │                │                │                │                │                │гистрации ЦБ│  оплаты  │\n" +
                                "├─────────────────────────┼──────────┼──────────┼────────────────────────────┼───────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────┼──────────┤";

  private var TableF_Name   = "                                                                                                  Движение ценных бумаг                                                                                                                     \n";
  private var TableF_Header = "┌─────────────────────────────────┬──────────────────────────────────────────────────┬──────────────────────────────────────────────────┬──────────────────────────────────────────────────┬──────────────────────────────────────────────────┐\n" +
                              "│                                 │                         ТО                       │                        Т+1                       │                       Т+2                        │                         T+                       │\n" +
                              "│       Наименование, тип ЦБ      ├────────────────┬────────────────┬────────────────┼────────────────┬────────────────┬────────────────┼────────────────┬────────────────┬────────────────┼────────────────┬────────────────┬────────────────┤\n" +
                              "│                                 │   Зачисление   │     Списание   │   Исх. остаток │    Зачисление  │     Списание   │   Исх. остаток │    Зачисление  │    Списание    │  Исх. остаток  │    Зачисление  │     Списание   │   Исх. Остаток │\n" +
                              "├─────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤";

  private var TableG = "                                                                             Движение денежных средств                                                                        \n" +
                       "┌────────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┐\n" +
                       "│                                    │               ТО                │               Т+1               │               Т+2               │                T+               │\n" +
                       "│       Наименование, тип ЦБ         ├────────────────┬────────────────┼────────────────┬────────────────┼────────────────┬────────────────┼────────────────┬────────────────┤\n" +
                       "│                                    │   Зачисление   │     Списание   │    Зачисление  │     Списание   │    Зачисление  │    Списание    │    Зачисление  │     Списание   │\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Зачисления/списания по сделкам с ЦБ │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Зачисление/вывод средств            │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Комиссия брокера                    │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Комиссия биржи                      │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Комиссия депозитария                │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│НДФЛ                                │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Иные списания                       │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Выплаты эмитентов                   │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Возврат НДФЛ                        │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤\n" +
                       "│Иные зачисления                     │################│################│################│################│################│################│################│################│\n" +
                       "├────────────────────────────────────┼────────────────┴────────────────┼────────────────┴────────────────┼────────────────┴────────────────┼────────────────┴────────────────┤\n" +
                       "│Прогноз остатка денежных средств    │#################################│#################################│#################################│#################################│\n" +
                       "└────────────────────────────────────┴─────────────────────────────────┴─────────────────────────────────┴─────────────────────────────────┴─────────────────────────────────┘\n";


  private var TableK_Name   = "           Денежные средства - исходящий остаток               \n";
  private var TableK_Header = "┌───────────────────┬───────────────────┬─────────────────────┐\n" + 
                              "│       ММВБ        │ Внебиржевой рынок │        Итого        │\n" + 
                              "├───────────────────┼───────────────────┼─────────────────────┤";

  private var m_SheetName:string = "ReportList",     // имя текущей закладки
              m_SheetNameTmpl:string = "ReportList"; // имя закладки в шаблоне

  private var m_FIMove = TArray(); // движение ЦБ (таблица F)
  // константы строк таблицы Движение денежных средств (G)
  private const DEALFI_OPERAT     = 0, // по сделкам с ЦБ
                INOUT_OPERAT      = 1, // зачисление/вывод средств
                COMMISBROK_OPERAT = 2, // комиссия брокера
                COMMISMARK_OPERAT = 3, // комиссия бирже
                COMMISDEPO_OPERAT = 4, // комиссия депозитария
                NDFL_OPERAT       = 5, // НДФЛ
                OTHEROUT_OPERAT   = 6, // Иные списания
                PAYISSUER_OPERAT  = 7, // выплаты эмитентов
                RETURNNDFL_OPERAT = 8, // возврат НДФЛ
                OTHERIN_OPERAT    = 9; // иные зачисления
  private var m_moneyMove = TArray(); // массив строк для таблицы Движение денежных средств (G)
  private var A1:numeric = $0.0; // значение ячейки A1

  private var m_isExistData = false; // есть данные для выпуска отчета?
  private var m_isExistClientData = false; // есть данные для выпуска по клиенту и договору

  private var prevDprt = -1, prevClntID = -1; // предыдущие значения ИД, для отображения нового листа

  private macro GetFIMove(fiid:integer, nameFI:string)
    for (var obj, m_FIMove)
      if (obj.FIID == fiid)
        return obj;
      end;
    end;

    m_FIMove[m_FIMove.size] = TFIMove(fiid, nameFI, $0.0);
    return m_FIMove[m_FIMove.size-1];
  end;

  private macro ClearMoneyMoveArr()
    m_moneyMove.size = 0;
    m_moneyMove[DEALFI_OPERAT]     = CMoneyMove();
    m_moneyMove[INOUT_OPERAT]      = CMoneyMove();
    m_moneyMove[COMMISBROK_OPERAT] = CMoneyMove();
    m_moneyMove[COMMISMARK_OPERAT] = CMoneyMove();
    m_moneyMove[COMMISDEPO_OPERAT] = CMoneyMove();
    m_moneyMove[NDFL_OPERAT]       = CMoneyMove();
    m_moneyMove[OTHEROUT_OPERAT]   = CMoneyMove();
    m_moneyMove[PAYISSUER_OPERAT]  = CMoneyMove();
    m_moneyMove[RETURNNDFL_OPERAT] = CMoneyMove();
    m_moneyMove[OTHERIN_OPERAT]    = CMoneyMove();
  end;

  private macro EndTable()
    EndTable();
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, GetTableRange(), 0, m_SheetName);
  end;                      
  
  private macro PrintMode():integer
    if(m_paramReport.IsExcel)
      return DL_OUTREPORT_EXCEL;
    else
      return DL_OUTREPORT_STD;
    end;
  end;

  private macro BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
    if (m_ObjTemplateXLS != null)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    SetUseApp(m_paramReport.IsApp); // для экселя не работает
  end;
// закомментировал для POI, если будет обработка не через POI - раскомментировать
/*
  private macro SaveTotalBook()
    if (m_UseTemplate)
      m_ObjTemplateXLS.Close();
      m_ObjTemplateXLS.SaveTotalBook( "itogs", m_isExistData );
    end;
  end;
*/

  private macro EndReport()
    if (m_UseTemplate)
      ReplaceAndCalculate( GetDL_FORMULA(), "=" );
    end;
    SaveTotalBook();
  end;

  private macro DigitIsApp(Digit, IsNotPrintNull:bool, SumPrecision:Integer)
    var sumPrec = m_sumPrec;

    if((Digit == $0.0) and IsNotPrintNull)
      return "";
    end;

    if(not m_paramReport.IsExcel)
      if (SumPrecision != null)
        sumPrec = SumPrecision;
      end;
      if(m_paramReport.IsApp)
        return ЧислоCЗаданнойТочностью(Digit, sumPrec, "a:r");
      else
        return ЧислоCЗаданнойТочностью(Digit, sumPrec, "r");
      end;
    end;

    return Digit;
  end;
  /* Аналог DigitIsApp, но для ЦБ*/
  private macro DigitIsAppFI(Digit, IsNotPrintNull:bool, SumPrecision:Integer)
    /*По согласованию с аналитиком (Панкина Дарья): "выводить только целую часть, но в самой ячейке в строке формул полностью показывать".*/
    if (PrintMode() == DL_OUTREPORT_EXCEL )
       return DigitIsApp(Digit, IsNotPrintNull, SumPrecision);
//       return ВыводЧерезФормулу(Digit);
// переделал для POI, если будет обработка не через POI - вернуть обратно
    end;

    var sumPrec = m_sumPrecFI;
    if (SumPrecision != null)
      sumPrec = SumPrecision;
    else
      if (Int(Digit) == Digit)
        sumPrec = 0;
      end;
    end;

    return DigitIsApp(Digit, IsNotPrintNull, sumPrec);
  end;
  /* Условие выборки сделок биржевых или внебиржевых в WHERE по сделке */
  private macro GetWhereAndDealMarket()
    var where = "";
    if (m_paramReport.IsMarket and m_paramReport.IsOutMarket)
      where = "";
    elif (m_paramReport.IsMarket)
      where = " AND (tick.t_Flag1 = chr(88) AND rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0) ";
    elif (m_paramReport.IsOutMarket)
      where = " AND (tick.t_Flag1 = chr(0) OR rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1)";
    end;
    return where;
  end;

  // -------------------------------
  // Заголовок по Банку
  // -------------------------------
  macro PrintHeaderBank(branch:integer, bankName:string, cityBank:string, clientCode:string)
    SetActiveSheet(m_SheetNameTmpl);

    UseNewSheetInTotalBook();

    PrintFormatString(HeaderBranch,
                      "H0.1", bankName,
                      "H0.2", cityBank,
                      "H0.3", m_paramReport.ReportDate
                     );
    if (branch != -1)
      m_SheetName = branch + " " + clientCode;
    else
      m_SheetName = String(m_paramReport.ReportDate);
    end;
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "HeaderBranch", 0, m_SheetName);
  end;
  // -------------------------------
  // Заголовок по клиенту
  // -------------------------------
  macro PrintHeaderClient(clientName:string, clientCode:string, contractNumber:string, contractDate:date, account:String)
    SetActiveSheet(m_SheetNameTmpl);

    PrintFormatString(HeaderClient,
                      "H1.1", clientName,
                      "H1.2", clientCode,
                      "H1.3", contractNumber,
                      "H1.4", contractDate,
                      "H1.5", account
                     );
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "HeaderClient", 0, m_SheetName);
  end;

  // -------------------------------------
  // Денежные средства - Входящий остаток
  // -------------------------------------
  macro PrintTableA(rest:numeric)
    Message("Формирование таблицы \"Денежные средства - Входящий остаток\"");
    SetActiveSheet(m_SheetNameTmpl);

    PrintFormatString(TableA_Name);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableA_Name", 0, m_SheetName);
    
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableA_Header", 0, m_SheetName );
    RegisterTable( "TableA_Rec", TableA_Header, 
                   "A_0", "A_1" );
    A1 = rest;

    PrintTableLine( "A_0",   "ММВБ",           null,
                    "A_1:r", DigitIsApp(rest), m_sumPrec
                  );
    EndTable();
    Message("");
  end;
  // -------------------------------------
  // Ценные бумаги - входящий остаток
  // -------------------------------------
  macro PrintTableB(cmd)
    Message("Формирование таблицы \"Ценные бумаги - входящий остаток\"");
    
    var cnt = cmd.GetCount();
    var i = 0;
    var dataSet = cmd.Execute();
    SetActiveSheet(m_SheetNameTmpl);
    
    PrintFormatString(TableB_Name);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableB_Name", 0, m_SheetName);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableB_Header", 0, m_SheetName );
    RegisterTable( "TableB_Rec", TableBL_Header, 
                   "B_1", "B_2" );

    InitProgress(cnt, "Просмотр сделок", "Просмотр сделок");
    while (dataSet.MoveNext())
      if (dataSet.Rest != $0.0)
        // В экселе в таблице объединенная ячейка, поэтому разобъем
        if (DL_OUTREPORT_STD == PrintMode())
          PrintTableLine( "B_1",   dataSet.FIName,             null,
                          "B_2:r", DigitIsAppFI(dataSet.Rest), null
                        );
        else
          PrintTableLine( "B_1", dataSet.FIName, null,
                          "",    "",             null, // пустая ячейка, из-за объединения
                          "B_2", DigitIsAppFI(dataSet.Rest),   null
                        );
        end;
        m_FIMove[m_FIMove.size] = TFIMove(dataSet.Code_Currency, dataSet.FIName, dataSet.Rest);
      end;

      UseProgress(i = i  +1);
    end;
    RemProgress();

    EndTable();

    Message("");
  end;

  private macro GetPrefixMMVB(kind:integer):string
    var prefix = "";

    if (0 == kind)
      prefix = "C";
    elif (1 == kind)
      prefix = "D";
    elif (2 == kind)
      prefix = "E";
    end;
    return prefix;
  end;
  private macro GetTableNameMMVB(kind:integer):string
    var name = "";

    if (0 == kind)
      name = TableC_Name;
    elif (1 == kind)
      name = TableD_Name;
    elif (2 == kind)
      name = TableE_Name;
    end;
    return name;
  end;
  // -------------------------------------
  // Сделки на ММВБ. Регистрация таблиц
  //  (общая для 3-х таблиц)
  // -------------------------------------
  macro CreateTablesMMVB(kind:integer)
    var prefix = GetPrefixMMVB(kind);
    SetActiveSheet(m_SheetNameTmpl);

    PrintFormatString(GetTableNameMMVB(kind));
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "Table"+prefix+"_Name", 0, m_SheetName);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "Table"+prefix+"_Header", 0, m_SheetName );
    RegisterTable( "Table"+prefix+"_Rec", TableСDE_Header, 
                   prefix+"_1", prefix+"_2", prefix+"_3", prefix+"_4", prefix+"_5", prefix+"_6", prefix+"_7",
                   prefix+"_8", prefix+"_9", prefix+"_10", prefix+"_11", prefix+"_12" );
  end;
  // -------------------------------------
  // Сделки на ММВБ. Вывод строки таблицы
  //  (общая для 3-х таблиц)
  // -------------------------------------
  macro PrintLineTablesMMVB(kind:integer, dealCode:string, dealDate:date, dealTime:time, kindDeal:string, nameFI:string,
                            amountFI:numeric, price:variant, cost:numeric, nkd:numeric, comm:numeric, registrDate:date, paymDate:date)
    var prefix = GetPrefixMMVB(kind);

    PrintTableLine( prefix+"_1",    dealCode,               null,
                    prefix+"_2",    dealDate,               null,
                    prefix+"_3",    dealTime,               null,
                    prefix+"_4",    kindDeal,               null,
                    prefix+"_5",    nameFI,                 null,
                    prefix+"_6:r",  DigitIsAppFI(amountFI), null,
                    prefix+"_7:r",  DigitIsApp(price),      m_sumPrec,
                    prefix+"_8:r",  DigitIsApp(cost),       m_sumPrec,
                    prefix+"_9:r",  DigitIsApp(nkd),        m_sumPrec,
                    prefix+"_10:r", DigitIsApp(comm),       m_sumPrec,
                    prefix+"_11",   registrDate,            null,
                    prefix+"_12",   paymDate,               null
                  );
  end;                            
  // -------------------------------------
  // Сделки на ММВБ. Завершение таблиц
  // -------------------------------------
  macro EndTablesMMVB(kind:integer)
    EndTable();
  end;
  // -------------------------------------
  // Движение ЦБ
  // -------------------------------------
  macro PrintTableF()
    Message("Формирование таблицы \"Движение ЦБ\"");
    SetActiveSheet(m_SheetNameTmpl);
    
    PrintFormatString(TableF_Name);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableF_Name", 0, m_SheetName);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableF_Header", 0, m_SheetName );
    RegisterTable( "TableF_Rec", TableF_Header, 
                   "F_1", "F_2", "F_3", "F_4", "F_5", "F_6", "F_7", "F_8", "F_9", "F_10", "F_11", "F_12", "F_13");
    
    for(var obj, m_FIMove)
      var f4:numeric  = obj.inAmount + obj.fiMoveT0.inAmount - obj.fiMoveT0.outAmount,
          f7:numeric  = f4 + obj.fiMoveT1.inAmount - obj.fiMoveT1.outAmount,
          f10:numeric = f7 + obj.fiMoveT2.inAmount - obj.fiMoveT2.outAmount,
          f13:numeric = f10 + obj.fiMoveTPlus.inAmount - obj.fiMoveTPlus.outAmount;

      PrintTableLine( "F_1",    obj.nameFI,                              null,
                      "F_2:r",  DigitIsAppFI(obj.fiMoveT0.inAmount),     null,
                      "F_3:r",  DigitIsAppFI(obj.fiMoveT0.outAmount),    null,
                      "F_4:r",  DigitIsAppFI(f4),                        null,
                      "F_5:r",  DigitIsAppFI(obj.fiMoveT1.inAmount),     null,
                      "F_6:r",  DigitIsAppFI(obj.fiMoveT1.outAmount),    null,
                      "F_7:r",  DigitIsAppFI(f7),                        null,
                      "F_8:r",  DigitIsAppFI(obj.fiMoveT2.inAmount),     null,
                      "F_9:r",  DigitIsAppFI(obj.fiMoveT2.outAmount),    null,
                      "F_10:r", DigitIsAppFI(f10),                       null,
                      "F_11:r", DigitIsAppFI(obj.fiMoveTPlus.inAmount),  null,
                      "F_12:r", DigitIsAppFI(obj.fiMoveTPlus.outAmount), null,
                      "F_13:r", DigitIsAppFI(f13),                       null
                    );
    end;
    EndTable();
    m_FIMove.size = 0;

    Message("");
  end;
  // -------------------------------------
  // Денежные средства - Исходящий остаток
  // -------------------------------------
  macro PrintTableK(restMMVB:numeric, restOutMarket:numeric)
    Message("Формирование таблицы \"Денежные средства - Исходящий остаток\"");
    SetActiveSheet(m_SheetNameTmpl);

    PrintFormatString(TableK_Name);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableK_Name", 0, m_SheetName);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableK_Header", 0, m_SheetName );
    RegisterTable( "TableK_Rec", TableK_Header, 
                   "K_1", "K_2", "K_3");

    // В экселе в таблице объединенная ячейка, поэтому разобъем
    if (DL_OUTREPORT_STD == PrintMode())
      PrintTableLine( "K_1:r", DigitIsApp(restMMVB),               null,
                      "K_2:r", DigitIsApp(restOutMarket),          null,
                      "K_3:r", DigitIsApp(restMMVB+restOutMarket), null
                    );
    else
      PrintTableLine( "K_1", restMMVB,               m_sumPrec,
                      "",    "",                     null, // пустая ячейка, из-за объединения
                      "K_2", restOutMarket,          m_sumPrec,
                      "",    "",                     null, // пустая ячейка, из-за объединения
                      "K_3", restMMVB+restOutMarket, m_sumPrec
                    );
    end;
    EndTable();

    Message("");
  end;
  // -------------------------------------
  // Ценные бумаги - исходящий остаток   
  // -------------------------------------
  macro PrintTableL(cmd)
    Message("Формирование таблицы \"Ценные бумаги - исходящий остаток\"");
    var dataSet = cmd.Execute();

    SetActiveSheet(m_SheetNameTmpl);

    PrintFormatString(TableL_Name);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableL_Name", 0, m_SheetName);
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableL_Header", 0, m_SheetName );
    RegisterTable( "TableL_Rec", TableBL_Header, 
                   "L_1", "L_2" );

    while (dataSet.MoveNext())
      if (dataSet.Rest != $0.0)
        // В экселе в таблице объединенная ячейка, поэтому разобъем
        if (DL_OUTREPORT_STD == PrintMode())
          PrintTableLine( "L_1",   dataSet.FIName,             null,
                          "L_2:r", DigitIsAppFI(dataSet.Rest), null
                        );
        else
          PrintTableLine( "L_1", dataSet.FIName, null,
                          "",    "",             null, // пустая ячейка, из-за объединения
                          "",    "",             null, // пустая ячейка, из-за объединения
                          "L_2", DigitIsAppFI(dataSet.Rest),   null
                        );
        end;
      end;
    end;
    EndTable();

    Message("");
  end;

  /* остаток ЦБ */
  private macro ExecuteDepo(dateRep:date, dprtID:integer, clientID:integer, PrintMethod:MethodRef, pIsExistsData:bool)
    Message();
    var cmd;
    var cnt = 0, IsExistsData = false;

    if( pIsExistsData != null )
       IsExistsData = pIsExistsData;
    end;

    var query =   "SELECT acc.t_Code_Currency, fin.t_Name || ', ' || avrkind.t_Name as t_FIName, "
                + "       Sum(abs(rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, null))) as t_Rest"
                + "  FROM ddepoacnt_dbt dacnt, daccount_dbt acc, dfininstr_dbt fin, davrkinds_dbt avrkind"
                + " WHERE dacnt.t_owner = ? "/*2*/
                + "   AND dacnt.t_department = ?" /*3*/
                + "   AND rsb_depo.depokindtype(dacnt.t_autoKey) = 1 " // счет владельца
                + "   AND acc.t_DepoAcc = dacnt.t_AutoKey "
                + "   AND INSTR(acc.t_Type_Account, 'I') = 0 " // по закрытом хранению, отбираются эмиссионные ЦБ
                + "   AND fin.t_FIID = acc.t_Code_Currency"
                + "   AND avrkind.t_AvoirKind = fin.t_AvoirKind"
                + "   AND avrkind.t_FI_KIND = fin.t_Fi_Kind"
                + " GROUP BY acc.t_Code_Currency, fin.t_Name, avrkind.t_Name";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(dateRep);
    cmd.AddParam(clientID);
    cmd.AddParam(dprtID);

    if( IsExistsData )
       cnt = cmd.GetCount(query);
       if( cnt > 0 )
          m_isExistClientData = true;
       end;
       return;
    end;

    CallR2M(PrintMethod, cmd); 

    Message("");

    OnError(e)
      msgbox(cmd.GetErrorString(e));
  end;

  // ----------------------------
  // Получение Цены
  // ----------------------------
  private macro getPrice(dataSet, tick, leg)
    var price = "";
  
    /* Для всех сделок, кроме РЕПО выводится цена одной ц/б в валюте цены
       сделки, для 2 части сделки РЕПО выводится текст "ставка" + ставка
       РЕПО + "%"  */
    if ((dataSet.IsREPO) AND (dataSet.DealPart == 2)) /*Репо 2 часть*/
      price = "ставка " + ЧислоCЗаданнойТочностью(DoubleToMoney(leg.rec.IncomeRate), 4) + " %";
    elif( (tick.rec.BOfficeKind == DL_RETIREMENT) or (tick.rec.BOfficeKind == DL_CONVAVR) )/*по словам аналитика цену для погашений можно не заполнять*/
      price = "";
    else
      price = ЧислоCЗаданнойТочностью(DoubleToMoney(GetPriceByDlTickDlLeg(tick.rec, leg.rec, true, null)), 4);
    end;

    return price; 
  end;

  private macro getCommis(dataSet, tick, leg)
    var commis = $0.0;
    var sum_agent = $0, sum_bank = $0, nds_agent = $0, nds_bank = $0;                                                              

    SP_GetSumCom( commis, null, null, null, tick.rec.BofficeKind, tick.rec.DealID, null, null, null, 1, 1, 1, 1, 1, 1, null, NATCUR, true);
    commis = commis + ПолучитьСуммуРаспределенныхКомиссийПоСделке( tick.rec, null, null, null, null, null, null, NATCUR, date(dataSet.DelivDate));                              
    return commis;
  end;

  private macro SetAmount(dataSet, amount:numeric, inAmount:@numeric, outAmount:@numeric)
    if (dataSet.t_IsREPO)
      if (dataSet.DealPart == 2)
        if(dataSet.t_IsBuy)    
          outAmount = amount;
        else
          inAmount = amount;
        end;
      else
        if(dataSet.t_IsBuy)
          inAmount = amount;
        else
          outAmount = amount;
        end;
      end;  
    elif ((dataSet.t_IsBUY) or (dataSet.IsAvrWrtIn))
      inAmount = amount;
    elif ((dataSet.t_IsSale) or (dataSet.IsAvrWrtOut))
      outAmount = amount;
    end;
  end;

  /* Сделки ММВБ */
  /* kind - вид отчета: 0 - исполнение ранее заключенных сделок
                        1 - заключенные и завершенные сделки (Т0)
                        2 - заключенные и незавершенные сделки (Т+)*/
  macro ExecuteMMVB(kind:integer, dprtID:integer, cntrID:integer, clientID:integer, pIsExistsData:bool)
    Message("Формирование таблиц \"Сделки ММВБ ...\"");
    var cmd, dataSet, RegDate = Date(0,0,0);
    var tick = TRecHandler("dl_tick");
    var leg = TRecHandler("dl_leg");

    var cnt = 0, IsExistsData = false, i = 0;

    if( pIsExistsData != null )
       IsExistsData = pIsExistsData;
    end;

    /*Аналитик: Под датой исполнения понимается ранняя из дат оплаты или поставки*/ 
    var sql_PayDate = 
                   " NVL( (SELECT min(DECODE(pm.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), pm.t_PlanDate, pm.t_FactDate)) " +
                   "         FROM DDLRQ_DBT pm " + 
                   "         WHERE pm.t_DocKind  = tick.t_BOfficeKind " +
                   "           AND pm.t_DocID    = tick.t_DealID " +
                   "           AND pm.t_Type     = ? " +
                   "           AND pm.t_DealPart = DECODE(leg.t_LegKind, 0, 1, 2) " + 
                   "       ),to_date('01.01.0001', 'DD.MM.YYYY')) ";

    var sql_DelivDate = 
                   "  NVL( (SELECT min(DECODE(pm.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), pm.t_PlanDate, pm.t_FactDate)) " +
                   "         FROM DDLRQ_DBT pm " + 
                   "         WHERE pm.t_DocKind  = tick.t_BOfficeKind " +
                   "           AND pm.t_DocID    = tick.t_DealID " +
                   "           AND pm.t_Type     = case when rsb_secur.IsRET_COUPON(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 or " +
                   "                                         rsb_secur.IsRET_PARTLY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
                   "                                    then ? else ? end " +
                   "           AND pm.t_DealPart = DECODE(leg.t_LegKind, 0, 1, 2) " + 
                   "       ),to_date('01.01.0001', 'DD.MM.YYYY')) ";

    /*Аналитик: Под датой исполнения понимается ранняя из дат оплаты или поставки*/ 
    var ExecDate = " case when " + sql_PayDate + " < " + sql_DelivDate + " then " + sql_PayDate + " else " + sql_DelivDate+" end ";

    cmd = DL_RSDCommand();


    var query =   " with tick_flt as (select /*+ inline */ * "
                + "  from ddl_tick_dbt tick "
                + " where tick.t_BOfficeKind in (?,?) "
                + "   and tick.t_Flag1 = chr(88) "
                + "   and rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0 "
                + "   and tick.t_Department = ? )";
    if( IsExistsData )
      query = query + " SELECT 1 as rec ";
    else
      query = query +  " SELECT count(*) over() rec_cnt, tick.t_DealID, tick.t_DealCode, tick.t_DealDate, tick.t_DealTime, tick.T_PartyID, fin.t_Name||', '||avrkind.t_Name as t_NameFI,"
                + "       DECODE(leg.t_LegKind, 0, 1, 2) as DealPart, leg.t_Principal, leg.t_Cost, leg.t_NKD, leg.t_TotalCost, "
                + sql_PayDate + " as PayDate, "+ sql_DelivDate + " as DelivDate, "
                + "       rsb_secur.IsRET_COUPON(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) as IsRET_COUPON, "
                + "       rsb_secur.IsRET_PARTLY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) as IsRET_PARTLY, "
                + "       rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) as IsRepo, "
                + "       rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)) as OpGroup "

    end;
      query = query + "  FROM (select /*+ index(tick.tick DDL_TICK_DBT_USR0)*/ * from tick_flt tick "
                + "          where tick.t_ClientContrID = ? and tick.T_ClientID = ? "
                + "        union all "
                + "        select /*+ index(tick.tick DDL_TICK_DBT_IDX_U2)*/ * from tick_flt tick "
                + "          where tick.T_PartyID = ? ) tick, ddl_leg_dbt leg, dfininstr_dbt fin, davrkinds_dbt avrkind"
                + " WHERE leg.t_DealID = tick.t_DealID"
                + "   AND leg.t_LegKind IN (0,2)"
                + "   AND fin.t_FIID = tick.t_PFI"
                + "   AND avrkind.t_AvoirKind = fin.t_AvoirKind"
                + "   AND avrkind.t_FI_KIND = fin.t_Fi_Kind";

    cmd.AddParam(DL_SECURITYDOC);
    cmd.AddParam(DL_RETIREMENT);
    cmd.AddParam(dprtID);

    if( not IsExistsData )
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_DELIVERY);
    end;

    cmd.AddParam(cntrID);
    cmd.AddParam(clientID);
    cmd.AddParam(clientID);



  /*  var query =   "SELECT tick.t_DealID, tick.t_DealCode, tick.t_DealDate, tick.t_DealTime, tick.T_PartyID, fin.t_Name||', '||avrkind.t_Name as t_NameFI,"
                + "       DECODE(leg.t_LegKind, 0, 1, 2) as DealPart, leg.t_Principal, leg.t_Cost, leg.t_NKD, leg.t_TotalCost, "
                + sql_PayDate + " as PayDate, "+ sql_DelivDate + " as DelivDate, "
                + "       rsb_secur.IsRET_COUPON(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) as IsRET_COUPON, "
                + "       rsb_secur.IsRET_PARTLY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) as IsRET_PARTLY, "
                + "       rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) as IsRepo, "
                + "       rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)) as OpGroup "
                + "  FROM ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fin, davrkinds_dbt avrkind"
                + " WHERE tick.t_BOfficeKind in (?,?)" // DL_SECURITYDOC, DL_RETIREMENT
                + "   AND tick.t_Flag1 = chr(88)" // Биржа ММВБ
                + "   AND rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0 "
                + "   AND tick.t_Department = ?"
                + "   AND ((tick.t_ClientContrID = ? AND tick.T_ClientID = ?) OR tick.T_PartyID = ?)"
                + "   AND leg.t_DealID = tick.t_DealID"
                + "   AND leg.t_LegKind IN (0,2)"
                + "   AND fin.t_FIID = tick.t_PFI"
                + "   AND avrkind.t_AvoirKind = fin.t_AvoirKind"
                + "   AND avrkind.t_FI_KIND = fin.t_Fi_Kind";

    cmd.AddParam(DLRQ_TYPE_PAYMENT);
    cmd.AddParam(DLRQ_TYPE_PAYMENT);
    cmd.AddParam(DLRQ_TYPE_DELIVERY);

    cmd.AddParam(DL_SECURITYDOC);
    cmd.AddParam(DL_RETIREMENT);

    cmd.AddParam(dprtID);
    cmd.AddParam(cntrID);
    cmd.AddParam(clientID);
    cmd.AddParam(clientID); */

    if (0 == kind)
      // Дата исполнения равна отчетной дате
      query = query + " AND tick.t_DealDate < ?"
                    + " AND ? = "+ExecDate;
      cmd.AddParam(m_paramReport.ReportDate);
      cmd.AddParam(m_paramReport.ReportDate);

      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_DELIVERY);

      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_DELIVERY);
    elif (1 == kind)
      // Дата исполнения равна отчетной дате
      query = query + " AND tick.t_DealDate = ?"
                    + " AND tick.t_DealDate = "+ExecDate;
      cmd.AddParam(m_paramReport.ReportDate);

      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_DELIVERY);

      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_DELIVERY);
    elif (2 == kind)
      query = query + " AND tick.t_DealDate <= ? "
                    + " AND ? < "+ExecDate;
      cmd.AddParam(m_paramReport.ReportDate);
      cmd.AddParam(m_paramReport.ReportDate);

      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_DELIVERY);

      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_PAYMENT);
      cmd.AddParam(DLRQ_TYPE_DELIVERY);
    end;

    if( not IsExistsData )
       query = query + " ORDER BY tick.t_DealDate, tick.t_DealTime";
    end;

     
   // cnt = cmd.GetCount(query);
     cnt = -1 ;

    dataSet = cmd.Execute(query);

    if( IsExistsData )
       if( dataSet.MoveNext() )
          m_isExistClientData = true;
       end;
       return;
    end;
      
      while (dataSet.MoveNext())
        if(cnt == -1)
          cnt = int(dataSet.rec_cnt);
          CreateTablesMMVB(kind);
          InitProgress(cnt, "Просмотр сделок", "Просмотр сделок");
        end;
        if( dataSet.IsRET_COUPON OR dataSet.IsRET_PARTLY )
           RegDate = date(dataSet.PayDate);
        else
           RegDate = date(dataSet.DelivDate);
        end;

        var kindOperat = "";
        if (clientID == dataSet.PartyID)
          kindOperat = ПолучитьВидСделкиКонтрагентаД(int(dataSet.OpGroup), IIF(dataSet.DealPart == 2, true, false), true, true );
        else
          kindOperat = ПолучитьВидОперации(int(dataSet.OpGroup), IIF(dataSet.DealPart == 2, true, false), true, true, false, false, true);
        end;

        GetDealByID( dataSet.DealID, NULL, NULL, tick );
        GetDlLegByDealID( dataSet.DealID, IIF(dataSet.DealPart == 1, LEG_KIND_DL_TICK, LEG_KIND_DL_TICK_BACK), NULL, NULL, leg);

        PrintLineTablesMMVB(kind, dataSet.DealCode, dataSet.DealDate, Time(dataSet.DealTime),
                            kindOperat,
                            dataSet.NameFI,
                            dataSet.Principal, double(getPrice(dataSet, tick, leg)), dataSet.TotalCost, dataSet.NKD, getCommis(dataSet, tick, leg), RegDate, date(dataSet.PayDate));

        UseProgress(i = i + 1);
      end;
    if(cnt > 0 )
      RemProgress();
      EndTablesMMVB(kind);
    end;

    Message();

    OnError(e)
      msgbox(cmd.GetErrorString(e));
  end;

  /* сбор данных по ДС и ЦБ */
  macro ExecuteMMVB_Move(RqType:integer, dprtID:integer, cntrID:integer, clientID:integer, pIsExistsData:bool)
    Message("Формирование таблиц \"Движение ценных бумаг/Движение денежных средств ...\"");
    var cmd, dataSet;
    var FD = null;

    var cnt = 0, IsExistsData = false;

    if( pIsExistsData != null )
       IsExistsData = pIsExistsData;
    end;

    macro СборДляДвижЦБ(isContrAgentD:bool)
      // сбор данных для табл. движение ЦБ
      // isContrAgentD для клиента-контрагента Д (поменять местами)
      var objFIMove:TFIMove;
      var inAmountFI = $0.0, outAmountFI = $0.0;

      objFIMove = GetFIMove(dataSet.PFI, dataSet.NameFI);
      SetAmount(dataSet, dataSet.Principal, @inAmountFI, @outAmountFI);
      if (isContrAgentD)
        // для контаргента Д суммы "меняются местами"
        objFIMove.AddAmount(Date(dataSet.PaymDate)-m_paramReport.ReportDate, outAmountFI, inAmountFI);
      else
        objFIMove.AddAmount(Date(dataSet.PaymDate)-m_paramReport.ReportDate, inAmountFI, outAmountFI);
      end;
    end;

    macro СборДляДвижДС(isContrAgentD:bool)
      // сбор данных для табл. движение денежных средств
      var inAmountMoney = $0.0, outAmountMoney = $0.0;
      // здесь наоборот суммы
      if( dataSet.BOfficeKind == DL_RETIREMENT )
         inAmountMoney = dataSet.TotalCost;
      else
         SetAmount(dataSet, dataSet.TotalCost, @outAmountMoney, @inAmountMoney);
      end;
      if (isContrAgentD)
        // для контаргента Д суммы "меняются местами"
        m_moneyMove[DEALFI_OPERAT].AddAmount(Date(dataSet.PaymDate)-m_paramReport.ReportDate, outAmountMoney, inAmountMoney);
      else
        m_moneyMove[DEALFI_OPERAT].AddAmount(Date(dataSet.PaymDate)-m_paramReport.ReportDate, inAmountMoney, outAmountMoney);
      end;
    end;

    cmd = DL_RSDCommand();


  var query =" with tick_flt as (select /*+ inline */ * "
               + "  from ddl_tick_dbt tick "
               + " where tick.t_BOfficeKind in (?,?,?)" // DL_SECURITYDOC, DL_AVRWRT, DL_RETIREMENT
               + "   AND case when tick.t_BOfficeKind = ? then chr(88) else tick.t_Flag1 end = chr(88)" // Биржа ММВБ только для сделок\погашений (а должны попасть еще и списания\зачисления, биржа для них не задается)
               + "   AND rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0 " 
               + "   AND tick.t_Department = ?"
               + "   AND tick.t_DealDate <= ?  /*BPV отбираем будущие платежи, но не сделки*/ )"
               + " SELECT count(*) over () rec_cnt, tick.t_DealID, tick.t_BOfficeKind, tick.t_DealCode, tick.t_PFI, tick.t_DealDate, tick.t_DealTime, tick.T_PartyID, fin.t_Name||', '||avrkind.t_Name as t_NameFI,"
                + "       DECODE(leg.t_LegKind, 0, 1, 2) as DealPart, leg.t_Principal, leg.t_Cost, leg.t_NKD, leg.t_TotalCost,"
                + "       DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate, rq.t_FactDate) as t_PaymDate, "
                + "       RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsBuy, "
                + "       RSB_SECUR.ISSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsSale, "
                + "       RSB_SECUR.ISREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsRepo, "
                + "       RSB_SECUR.IsAvrWrtIn(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsAvrWrtIn, "
                + "       RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsAvrWrtOut "
               + "  FROM (select /*+ index(tick.tick DDL_TICK_DBT_USR0)*/ * from tick_flt tick "
               + "          where tick.t_ClientContrID = ? and tick.T_ClientID = ? "
               + "        union all "
               + "        select /*+ index(tick.tick DDL_TICK_DBT_IDX_U2)*/ * from tick_flt tick "
               + "          where tick.T_PartyID = ?  ) tick, ddl_leg_dbt leg, dfininstr_dbt fin, davrkinds_dbt avrkind, ddlrq_dbt rq "
                + " WHERE leg.t_DealID = tick.t_DealID"
                + "   AND leg.t_LegKind IN (0,2)"
                + "   AND fin.t_FIID = tick.t_PFI"
                + "   AND avrkind.t_AvoirKind = fin.t_AvoirKind"
                + "   AND avrkind.t_FI_KIND = fin.t_Fi_Kind"
                + "   AND rq.t_DocID = tick.t_DealID"
                + "   AND rq.t_DocKind = tick.t_BOfficeKind"
                + "   AND ? = rq.t_Type " 
                + "   AND rq.t_DealPart = DECODE(leg.t_LegKind, 0, 1, 2)"
                + "   AND ? <= DECODE (rq.t_FactDate,TO_DATE ('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate, rq.t_FactDate)";

    cmd.AddParam(DL_SECURITYDOC);
    cmd.AddParam(DL_AVRWRT);
    cmd.AddParam(DL_RETIREMENT);

    cmd.AddParam(DL_AVRWRT);

    cmd.AddParam(dprtID);
    cmd.AddParam(m_paramReport.ReportDate);

    cmd.AddParam(cntrID);
    cmd.AddParam(clientID);
    cmd.AddParam(clientID);
    cmd.AddParam(RqType);

    cmd.AddParam(m_paramReport.ReportDate);


/*    var query =   "SELECT tick.t_DealID, tick.t_BOfficeKind, tick.t_DealCode, tick.t_PFI, tick.t_DealDate, tick.t_DealTime, tick.T_PartyID, fin.t_Name||', '||avrkind.t_Name as t_NameFI,"
                + "       DECODE(leg.t_LegKind, 0, 1, 2) as DealPart, leg.t_Principal, leg.t_Cost, leg.t_NKD, leg.t_TotalCost,"
                + "       DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate, rq.t_FactDate) as t_PaymDate, "
                + "       RSB_SECUR.ISBUY(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsBuy, "
                + "       RSB_SECUR.ISSALE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsSale, "
                + "       RSB_SECUR.ISREPO(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsRepo, "
                + "       RSB_SECUR.IsAvrWrtIn(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsAvrWrtIn, "
                + "       RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TICK.t_DealType, TICK.t_BofficeKind))) T_IsAvrWrtOut "
                + "  FROM ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fin, davrkinds_dbt avrkind, ddlrq_dbt rq "
                + " WHERE tick.t_BOfficeKind in (?,?,?)" // DL_SECURITYDOC, DL_AVRWRT, DL_RETIREMENT
                + "   AND case when tick.t_BOfficeKind = ? then chr(88) else tick.t_Flag1 end = chr(88)" // Биржа ММВБ только для сделок\погашений (а должны попасть еще и списания\зачисления, биржа для них не задается)
                + "   AND rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0 " 
                + "   AND tick.t_Department = ?"
                + "   AND ((tick.t_ClientContrID = ? AND tick.T_ClientID = ?) OR tick.T_PartyID = ?)"
                + "   AND leg.t_DealID = tick.t_DealID"
                + "   AND leg.t_LegKind IN (0,2)"
                + "   AND fin.t_FIID = tick.t_PFI"
                + "   AND avrkind.t_AvoirKind = fin.t_AvoirKind"
                + "   AND avrkind.t_FI_KIND = fin.t_Fi_Kind"
                + "   AND rq.t_DocID = tick.t_DealID"
                + "   AND rq.t_DocKind = tick.t_BOfficeKind"
                + "   AND ? = rq.t_Type " 
                + "   AND rq.t_DealPart = DECODE(leg.t_LegKind, 0, 1, 2)"
                + "   AND ? <= DECODE (rq.t_FactDate,TO_DATE ('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate, rq.t_FactDate)"
                + "   AND tick.t_DealDate <= ? ";/*BPV отбираем будущие платежи, но не сделки*/

    cmd.AddParam(DL_SECURITYDOC);
    cmd.AddParam(DL_AVRWRT);
    cmd.AddParam(DL_RETIREMENT);

    cmd.AddParam(DL_AVRWRT);

    cmd.AddParam(dprtID);
    cmd.AddParam(cntrID);
    cmd.AddParam(clientID);
    cmd.AddParam(clientID);
    cmd.AddParam(RqType);

    cmd.AddParam(m_paramReport.ReportDate);
    cmd.AddParam(m_paramReport.ReportDate);
*/
  
  query = query + " ORDER BY tick.t_DealDate, tick.t_DealTime";

  //  cnt = cmd.GetCount(query);
    dataSet = cmd.Execute(query);
    cnt = -1;
    var i = 0;
   while (dataSet.MoveNext())
      if(cnt < 0)
        cnt = int(dataSet.rec_cnt);
        InitProgress(cnt, "Сбор данных по ДС и ЦБ", "Сбор данных по ДС и ЦБ");
      end;
      if( (RqType == DLRQ_TYPE_PAYMENT) or (dataSet.BOfficeKind == DL_AVRWRT) )/*у списаний\зачислений оплаты нет*/
         if( IsExistsData )
             m_isExistClientData = true;
             break;
         end;
         СборДляДвижДС(dataSet.PartyID==clientID);
      end;
      if( (RqType == DLRQ_TYPE_DELIVERY) and (dataSet.BOfficeKind != DL_RETIREMENT) )/*по погашениям только по ДС собираем*/
         if( IsExistsData )
            m_isExistClientData = true;
            break;
         end;
         СборДляДвижЦБ(dataSet.PartyID==clientID);
      end;
      UseProgress(i = i + 1);
    end;
   if(cnt > 0)
      RemProgress();
   end;

    Message();

    OnError(e)
      msgbox(cmd.GetErrorString(e));
  end;

  /* Сбор данных для строки G2 */
  private macro ExecuteG2(cntrID:integer, clientID:integer, place:integer, pIsExistsData:bool)
    var cmd, dataSet;
    var query = "";

    var cnt = 0, IsExistsData = false;
    if( pIsExistsData != null )
       IsExistsData = pIsExistsData;
    end;

    cmd = DL_RSDCommand();

    if( place <= 0 )
       query = " WITH place  "
               + "    AS (SELECT party.t_partyID, (case when code.t_ObjectID <> -1  then code.t_ObjectID else party.t_partyID end)t_ObjectID "
               + "          FROM dparty_dbt party "
               + "            INNER JOIN ddp_dep_dbt dep  ON party.t_partyID = dep.t_PartyID "
               + "            INNER JOIN dbankdprt_dbt bankdprt ON dep.t_PartyID = bankdprt.t_PartyID "
               + "            INNER JOIN  dobjcode_dbt code "
               + "              ON  code.t_Code = bankdprt.t_BIC_RCC "
               + "                AND code.t_CodeKind = 3 " //PTCK_BIC
               + "                AND code.t_Objecttype = 3 "
               + "                AND code.t_bankdate <= ? ) ";
       cmd.addParam(m_paramReport.ReportDate);
    end;

    // Определение G2
    // сюда должны попадать и отложенные операции в том числе (а по ним еще ни счета ни проводок)
    query = query + "SELECT Sum(dlac.T_SUM) as t_Sum, dlac.t_opertype, (dlac.t_valuedate-"+GetSQLDate(m_paramReport.ReportDate)+") as t_CountDays"
                  + "  FROM ddl_acc_dbt dlac ";

    if( place <= 0 )
       query = query + ", place ";
    end;

    query = query + " WHERE dlac.t_Client = ?" /*1*/
                  + "   AND dlac.t_ClientContr = ? " /*2*/
                  + "   AND dlac.t_valuedate >= ? " /*3*/
                  + "   AND dlac.t_boffice = 5"
                  + "   AND dlac.t_opertype in ( 6, 7 ) " // Возврат клиенту денежных средств, Прием от клиента денежных средств
                  + "   AND dlac.T_FIID = " + NATCUR;

    cmd.addParam(clientID);                 /*1*/
    cmd.addParam(cntrID);                   /*2*/
    cmd.addParam(m_paramReport.ReportDate); /*3*/

    if( place <= 0 )
       query = query + "   AND case when dlac.t_opertype = 6 then dlac.t_NewPlace else dlac.t_OldPlace end in(place.t_partyID,place.t_ObjectID) ";
    else
       query = query + "   AND case when dlac.t_opertype = 6 then dlac.t_NewPlace else dlac.t_OldPlace end = ? ";
       cmd.addParam(place);
    end;
                  
    query = query + "  GROUP BY dlac.t_opertype, (dlac.t_valuedate)";

    if( IsExistsData )
       cnt = cmd.GetCount(query);
       if( cnt > 0 )
          m_isExistClientData = true;
       end;
       return;
    end;

    dataSet = cmd.Execute(query);
    while (dataSet.MoveNext())
      var inAmountMoney = $0.0, outAmountMoney = $0.0;
      if (dataSet.OperType == 7) // возврат
        outAmountMoney = dataSet.Sum;
      else
        inAmountMoney = dataSet.Sum;
      end;
      m_moneyMove[INOUT_OPERAT].AddAmount(dataSet.CountDays, inAmountMoney, outAmountMoney);
    end;

    OnError(e)
      msgbox(cmd.GetErrorString(e));
  end;
  /* Сбор данных для строки G3 */
  macro ExecuteG3(cntrID:integer, clientID:integer, pIsExistsData:bool)
    var cmd, dataSet;

    var cnt = 0, IsExistsData = false;
    if( pIsExistsData != null )
       IsExistsData = pIsExistsData;
    end;

    // Определение G2

   var query =" with tick_flt as (select /*+ inline */ * "
               + "  from ddl_tick_dbt tick "
               + " where tick.t_BOfficeKind in (101,127) "
               + GetWhereAndDealMarket()
               + "   AND tick.t_DealDate <= ?  /*BPV отбираем будущие платежи, но не сделки*/ )";
    if( IsExistsData )
      query = query + "SELECT 1 as rec ";
    else
      query = query + "SELECT Sum(DECODE(tick.t_MarketID, rq.t_Party, rq.t_Amount, 0.0)) as t_MarketCom,"
               + "       Sum(DECODE(tick.t_BrokerID, rq.t_Party, rq.t_Amount, 0.0)) as t_BrokerCom,"
               + "       (DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate,rq.t_FactDate)-"+GetSQLDate(m_paramReport.ReportDate)+") as t_CountDays,"
               + "       rq.t_Party " ;
    end;
    query = query + "  FROM (select /*+ index(tick.tick DDL_TICK_DBT_USR0)*/ * from tick_flt tick "
               + "          where tick.t_ClientContrID = ? and tick.T_ClientID = ? "
               + "        union all "
               + "        select /*+ index(tick.tick DDL_TICK_DBT_IDX_U2)*/ * from tick_flt tick "
               + "          where tick.T_PartyID = ?  ) tick, ddlrq_dbt rq "
               + " WHERE (rq.t_FactDate >= ? or (rq.t_FactDate=to_date('01.01.0001', 'DD.MM.YYYY') and rq.t_PlanDate >= ? ))"
               + "   AND rq.t_DocKind = tick.t_BOfficeKind"
               + "   AND rq.t_DocID =  tick.t_DealID"
               + "   AND rq.t_Type = 6 " // DLRQ_TYPE_COMISS комиссия
               + "   AND (tick.t_MarketID = rq.t_Party or tick.t_BrokerID = rq.t_Party)" ;
    if( not IsExistsData )
      query = query + " GROUP BY rq.t_Party, DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'),  rq.t_PlanDate,rq.t_FactDate)";
    end;
    cmd = DL_RSDCommand(query);

    cmd.addParam(m_paramReport.ReportDate);
    cmd.addParam(cntrID);
    cmd.addParam(clientID);
    cmd.addParam(clientID);
    cmd.addParam(m_paramReport.ReportDate);
    cmd.addParam(m_paramReport.ReportDate); 

    /*var query =  "SELECT Sum(DECODE(tick.t_MarketID, rq.t_Party, rq.t_Amount, 0.0)) as t_MarketCom,"
               + "       Sum(DECODE(tick.t_BrokerID, rq.t_Party, rq.t_Amount, 0.0)) as t_BrokerCom,"
               + "       (DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'), rq.t_PlanDate,rq.t_FactDate)-"+GetSQLDate(m_paramReport.ReportDate)+") as t_CountDays,"
               + "       rq.t_Party "
               + "  FROM ddl_tick_dbt tick, ddlrq_dbt rq "
               + " WHERE  tick.t_BOfficeKind in (101,127)" // DL_SECURITYDOC, DL_AVRWRT
               + GetWhereAndDealMarket()
               + "   AND ((tick.t_ClientContrID = ? AND tick.T_ClientID = ?) OR tick.T_PartyID = ?)"
               + "   AND (rq.t_FactDate >= ? or (rq.t_FactDate=to_date('01.01.0001', 'DD.MM.YYYY') and rq.t_PlanDate >= ? ))"
               + "   AND tick.t_DealDate <= ? "   //BPV отбираем будущие платежи, но не сделки
               + "   AND rq.t_DocKind = tick.t_BOfficeKind"
               + "   AND rq.t_DocID =  tick.t_DealID"
               + "   AND rq.t_Type = 6 " // DLRQ_TYPE_COMISS комиссия
               + "   AND (tick.t_MarketID = rq.t_Party or tick.t_BrokerID = rq.t_Party)"
               + " GROUP BY rq.t_Party, DECODE(rq.t_FactDate, to_date('01.01.0001', 'DD.MM.YYYY'),  rq.t_PlanDate,rq.t_FactDate)"; 
    cmd = DL_RSDCommand(query);

    cmd.addParam(cntrID);
    cmd.addParam(clientID);
    cmd.addParam(clientID);
    cmd.addParam(m_paramReport.ReportDate);
    cmd.addParam(m_paramReport.ReportDate);
    cmd.addParam(m_paramReport.ReportDate); */

    dataSet = cmd.Execute();

    if( IsExistsData )
     //  cnt = cmd.GetCount(query);
       if(dataSet.MoveNext())
          m_isExistClientData = true;
       end;
       return;
    end;

    while (dataSet.MoveNext())

      if (dataSet.t_MarketCom != 0)
        m_moneyMove[COMMISMARK_OPERAT].AddAmount(dataSet.CountDays, $0.0, dataSet.t_MarketCom);
      end;
      if (dataSet.t_BrokerCom != 0)
        m_moneyMove[COMMISBROK_OPERAT].AddAmount(dataSet.CountDays, $0.0, dataSet.t_BrokerCom);
      end;
    end;

    OnError(e)
      msgbox(cmd.GetErrorString(e));
  end;

  // --------------------------------
  // Движение денежных средств
  // --------------------------------
  macro ExecuteMoneyMoving(cntrID:integer, clientID:integer, place:integer)
    Message("Формирование таблицы \"Движение денежных средств\"");
    ExecuteG2(cntrID, clientID, place);
    ExecuteG3(cntrID, clientID);

    SetActiveSheet(m_SheetNameTmpl);

    var G11 = A1 + m_moneyMove[DEALFI_OPERAT].amountMoveT0.inAmount + m_moneyMove[INOUT_OPERAT].amountMoveT0.inAmount -
              m_moneyMove[DEALFI_OPERAT].amountMoveT0.outAmount - m_moneyMove[INOUT_OPERAT].amountMoveT0.outAmount -
              m_moneyMove[COMMISBROK_OPERAT].amountMoveT0.outAmount - m_moneyMove[COMMISMARK_OPERAT].amountMoveT0.outAmount;
    var G12 = G11 + m_moneyMove[DEALFI_OPERAT].amountMoveT1.inAmount + m_moneyMove[INOUT_OPERAT].amountMoveT1.inAmount -
              m_moneyMove[DEALFI_OPERAT].amountMoveT1.outAmount - m_moneyMove[INOUT_OPERAT].amountMoveT1.outAmount -
              m_moneyMove[COMMISBROK_OPERAT].amountMoveT1.outAmount - m_moneyMove[COMMISMARK_OPERAT].amountMoveT1.outAmount;
    var G13 = G12 + m_moneyMove[DEALFI_OPERAT].amountMoveT2.inAmount + m_moneyMove[INOUT_OPERAT].amountMoveT2.inAmount -
              m_moneyMove[DEALFI_OPERAT].amountMoveT2.outAmount - m_moneyMove[INOUT_OPERAT].amountMoveT2.outAmount -
              m_moneyMove[COMMISBROK_OPERAT].amountMoveT2.outAmount - m_moneyMove[COMMISMARK_OPERAT].amountMoveT2.outAmount;
    var G14 = G13 + m_moneyMove[DEALFI_OPERAT].amountMoveTPlus.inAmount + m_moneyMove[INOUT_OPERAT].amountMoveTPlus.inAmount -
              m_moneyMove[DEALFI_OPERAT].amountMoveTPlus.outAmount - m_moneyMove[INOUT_OPERAT].amountMoveTPlus.outAmount -
              m_moneyMove[COMMISBROK_OPERAT].amountMoveTPlus.outAmount - m_moneyMove[COMMISMARK_OPERAT].amountMoveTPlus.outAmount;

    PrintFormatString(TableG,
                        "G1_1:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveT0.inAmount),        "G1_2:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveT0.outAmount),     
                        "G1_3:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveT1.inAmount),        "G1_4:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveT1.outAmount),
                        "G1_5:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveT2.inAmount),        "G1_6:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveT2.outAmount),         
                        "G1_7:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveTPlus.inAmount),     "G1_8:r",  DigitIsApp(m_moneyMove[DEALFI_OPERAT].amountMoveTPlus.outAmount),

                        "G2_1:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveT0.inAmount),         "G2_2:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveT0.outAmount),           
                        "G2_3:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveT1.inAmount),         "G2_4:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveT1.outAmount),
                        "G2_5:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveT2.inAmount),         "G2_6:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveT2.outAmount),          
                        "G2_7:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveTPlus.inAmount),      "G2_8:r",  DigitIsApp(m_moneyMove[INOUT_OPERAT].amountMoveTPlus.outAmount),

                        "G3_1:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveT0.inAmount),    "G3_2:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveT0.outAmount), 
                        "G3_3:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveT1.inAmount),    "G3_4:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveT1.outAmount),
                        "G3_5:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveT2.inAmount),    "G3_6:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveT2.outAmount),  
                        "G3_7:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveTPlus.inAmount), "G3_8:r",  DigitIsApp(m_moneyMove[COMMISBROK_OPERAT].amountMoveTPlus.outAmount),

                        "G4_1:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveT0.inAmount),    "G4_2:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveT0.outAmount), 
                        "G4_3:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveT1.inAmount),    "G4_4:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveT1.outAmount),
                        "G4_5:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveT2.inAmount),    "G4_6:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveT2.outAmount), 
                        "G4_7:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveTPlus.inAmount), "G4_8:r",  DigitIsApp(m_moneyMove[COMMISMARK_OPERAT].amountMoveTPlus.outAmount),

                        "G5_1:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveT0.inAmount),    "G5_2:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveT0.outAmount),
                        "G5_3:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveT1.inAmount),    "G5_4:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveT1.outAmount),
                        "G5_5:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveT2.inAmount),    "G5_6:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveT2.outAmount),
                        "G5_7:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveTPlus.inAmount), "G5_8:r",  DigitIsApp(m_moneyMove[COMMISDEPO_OPERAT].amountMoveTPlus.outAmount),

                        "G6_1:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveT0.inAmount),          "G6_2:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveT0.outAmount),        
                        "G6_3:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveT1.inAmount),          "G6_4:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveT1.outAmount),
                        "G6_5:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveT2.inAmount),          "G6_6:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveT2.outAmount),    
                        "G6_7:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveTPlus.inAmount),       "G6_8:r",  DigitIsApp(m_moneyMove[NDFL_OPERAT].amountMoveTPlus.outAmount),

                        "G7_1:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveT0.inAmount),      "G7_2:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveT0.outAmount), 
                        "G7_3:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveT1.inAmount),      "G7_4:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveT1.outAmount),
                        "G7_5:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveT2.inAmount),      "G7_6:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveT2.outAmount),
                        "G7_7:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveTPlus.inAmount),   "G7_8:r",  DigitIsApp(m_moneyMove[OTHEROUT_OPERAT].amountMoveTPlus.outAmount),

                        "G8_1:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveT0.inAmount),     "G8_2:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveT0.outAmount),
                        "G8_3:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveT1.inAmount),     "G8_4:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveT1.outAmount),
                        "G8_5:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveT2.inAmount),     "G8_6:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveT2.outAmount),
                        "G8_7:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveTPlus.inAmount),  "G8_8:r",  DigitIsApp(m_moneyMove[PAYISSUER_OPERAT].amountMoveTPlus.outAmount),

                        "G9_1:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveT0.inAmount),    "G9_2:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveT0.outAmount),
                        "G9_3:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveT1.inAmount),    "G9_4:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveT1.outAmount),
                        "G9_5:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveT2.inAmount),    "G9_6:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveT2.outAmount),
                        "G9_7:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveTPlus.inAmount), "G9_8:r",  DigitIsApp(m_moneyMove[RETURNNDFL_OPERAT].amountMoveTPlus.outAmount),

                        "G10_1:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveT0.inAmount),       "G10_2:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveT0.outAmount),  
                        "G10_3:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveT1.inAmount),       "G10_4:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveT1.outAmount),
                        "G10_5:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveT2.inAmount),       "G10_6:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveT2.outAmount),   
                        "G10_7:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveTPlus.inAmount),    "G10_8:r", DigitIsApp(m_moneyMove[OTHERIN_OPERAT].amountMoveTPlus.outAmount),

                      "G_11:r",  DigitIsApp(G11), "G_12:r", DigitIsApp(G12), "G_13:r", DigitIsApp(G13), "G_14:r", DigitIsApp(G14)
                     );
    CopyAllSheetInTotalBook(m_SheetNameTmpl, false, "TableG", 0, m_SheetName);

    Message();
  end;

  private macro FormReportByClient(ClientData:variant,Account:string,InAmount:money,OutAmount:money,Place:integer)

    var query:string = "";
    var cmd, dataSet;
    var isNewSheet = false;

    m_isExistData = true;

    ClearMoneyMoveArr();

    isNewSheet = ((prevDprt != ClientData.DepartmentID) or (prevClntID != ClientData.ClientID));
    if (isNewSheet)
      PrintHeaderBank(ClientData.DepartmentID, ClientData.DprtName, ClientData.DprtCity, ClientData.ClientCode);
    end;
    
    PrintHeaderClient(ClientData.ClientName, ClientData.ClientCode, ClientData.CntrNumber, ClientData.CntrDate, Account);
    PrintTableA(InAmount);

    ExecuteDepo(m_paramReport.ReportDate-1, ClientData.DepartmentID, ClientData.ClientID, R2M(this, "PrintTableB"));
    ExecuteMMVB_Move(DLRQ_TYPE_PAYMENT, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID);
    ExecuteMMVB_Move(DLRQ_TYPE_DELIVERY, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID);
    ExecuteMMVB(0, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID);
    ExecuteMMVB(1, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID);
    ExecuteMMVB(2, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID);
    PrintTableF();
    ExecuteMoneyMoving(ClientData.CntrID, ClientData.ClientID, Place);
    PrintTableK(OutAmount, $0.0);
    ExecuteDepo(m_paramReport.ReportDate, ClientData.DepartmentID, ClientData.ClientID, R2M(this, "PrintTableL"));

    prevDprt = ClientData.DepartmentID;
    prevClntID = ClientData.ClientID;

  end;

  private macro ExecuteReportByClient(ClientData:variant)
    var query:string = "";
    var cmd, dataSet;

    m_isExistClientData = false;

    // входящие\исходящие остатки
    query = " WITH place  "
            + "    AS (SELECT party.t_partyID, (case when code.t_ObjectID <> -1  then code.t_ObjectID else party.t_partyID end)t_ObjectID "
            + "          FROM dparty_dbt party "
            + "            INNER JOIN ddp_dep_dbt dep  ON party.t_partyID = dep.t_PartyID "
            + "            INNER JOIN dbankdprt_dbt bankdprt ON dep.t_PartyID = bankdprt.t_PartyID "
            + "            INNER JOIN  dobjcode_dbt code "
            + "              ON  code.t_Code = bankdprt.t_BIC_RCC "
            + "                AND code.t_CodeKind = 3 " //PTCK_BIC
            + "                AND code.t_Objecttype = 3 "
            + "                AND code.t_bankdate <= ? ) "
            + " SELECT accdoc.t_Account, "
            + "       abs(rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null)) as t_inamount," // входящий
            + "       abs(rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null)) as t_outamount," // исходящий
            + "       accdoc.t_Place"
            + "  FROM dmccateg_dbt cat, dmcaccdoc_dbt accdoc, place"
            + " WHERE cat.t_code = 'ДС Клиента, ВУ'"
            + "   and cat.t_LEVELTYPE = 1"  
            + "   AND accdoc.t_catID = cat.t_ID"
            + "   AND accdoc.t_currency = 0" // только рубли
            + "   AND (abs(rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null)) != 0"
            + "     or abs(rsb_account.restac(accdoc.t_Account, accdoc.t_Currency, ?, accdoc.t_Chapter, null)) != 0"
            + "     or rsb_account.kreditac(accdoc.t_Account,accdoc.t_Chapter,accdoc.t_Currency,?,?, null) != 0"// Были движения?
            + "     or rsb_account.debetac(accdoc.t_Account,accdoc.t_Chapter,accdoc.t_Currency,?,?, null) != 0) "
            + "   AND ACCDOC.T_DocID = ? "
            + "   AND accdoc.t_DocKind = 122 " // DL_STOCKCONTR
            + "   AND (accdoc.t_Place = place.t_PartyID or accdoc.t_Place = place.t_ObjectID)" // МХ
            + "   AND accdoc.t_DepartmentID = ?";

    cmd = DL_RSDCommand();
    cmd.AddParam(m_paramReport.ReportDate);
    cmd.AddParam(m_paramReport.ReportDate-1);
    cmd.AddParam(m_paramReport.ReportDate);
    cmd.AddParam(m_paramReport.ReportDate-1);
    cmd.AddParam(m_paramReport.ReportDate);
    cmd.AddParam(m_paramReport.ReportDate-1);
    cmd.AddParam(m_paramReport.ReportDate);
    cmd.AddParam(m_paramReport.ReportDate-1);
    cmd.AddParam(m_paramReport.ReportDate);
    cmd.AddParam(ClientData.CntrID);
    cmd.AddParam(ClientData.DepartmentID);
    
    //println(query);

    var cnt = 0;
    cnt = cmd.GetCount(query);

    if (cnt > 0)

       dataSet = cmd.Execute(query);
      
       while (dataSet.MoveNext())
      
         FormReportByClient(ClientData, dataSet.Account, dataSet.inamount, dataSet.outamount, dataSet.Place);
      
       end;

    else/*если счет не нашли*/

       ExecuteDepo(m_paramReport.ReportDate-1, ClientData.DepartmentID, ClientData.ClientID, null, true);

       if( not m_isExistClientData )
          ExecuteMMVB_Move(DLRQ_TYPE_PAYMENT, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID, true );
       end;

       if( not m_isExistClientData )
          ExecuteMMVB_Move(DLRQ_TYPE_DELIVERY, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID, true );
       end;

       if( not m_isExistClientData )
          ExecuteMMVB(0, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID, true);
       end;

       if( not m_isExistClientData )
          ExecuteMMVB(1, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID, true);
       end;

       if( not m_isExistClientData )
          ExecuteMMVB(2, ClientData.DepartmentID, ClientData.CntrID, ClientData.ClientID, true);
       end;

       if( not m_isExistClientData )
          ExecuteDepo(m_paramReport.ReportDate, ClientData.DepartmentID, ClientData.ClientID, null, true);
       end;

       if( not m_isExistClientData )
          ExecuteG2(ClientData.cntrID, ClientData.clientID, 0, true);
       end;

       if( not m_isExistClientData )
          ExecuteG3(ClientData.cntrID, ClientData.clientID, true);
       end;

       if( m_isExistClientData )
          FormReportByClient(ClientData, "", $0, $0, 0);
       end;

    end;
    
    OnError(e)
      msgbox(cmd.GetErrorString(e));
  end;

  /* выполнение отчета*/
  private macro ExecuteReport()
    var query:string = "";
    var cmd, dataSet;

    prevDprt = -1;
    prevClntID = -1; // предыдущие значения ИД, для отображения нового листа

    query = " SELECT sfcontr.t_ID as t_CntrID, sfcontr.t_Number as t_CntrNumber, sfcontr.t_DateBegin as t_CntrDate, sfcontr.t_PartyID as t_ClientID, "
            + "       partyDprt.t_shortname as t_DprtName, dep.t_code DepartmentID, "
            + "       NVL((SELECT t_district FROM dadress_dbt WHERE t_PartyID = partyDprt.t_partyid and t_type = 1), chr(1)) as t_DprtCity, "
            + "       partyClnt.t_ShortName as t_ClientName, RSI_RSBPARTY.GetPartyCode(sfcontr.t_PartyID, 1) as t_ClientCode "
            + "  FROM dsfcontr_dbt sfcontr, ddp_dep_dbt dep, dparty_dbt partyDprt, dparty_dbt partyClnt "
            + " WHERE sfcontr.T_SERVKIND = 1" // фондовый дилинг 
            + "   AND sfcontr.T_DATEBEGIN <= ?"
            + "   AND ( sfcontr.T_DATECLOSE >= ? or sfcontr.T_DATECLOSE = TO_DATE('01.01.0001','DD.MM.YYYY') ) "
            + "   AND partyDprt.t_partyid = dep.t_partyid"
            + "   AND partyClnt.t_PartyID = sfcontr.t_PartyID"
            + "   AND dep.t_code = sfcontr.t_Department ";

    cmd = DL_RSDCommand();
    cmd.AddParam(m_paramReport.ReportDate);
    cmd.AddParam(m_paramReport.ReportDate);
    
    // подразделение
    if (m_paramReport.Department != -1)
      query = query + "  AND dep.t_code = ?";
      cmd.AddParam(m_paramReport.Department);
    end;
    // клиент
    if (m_paramReport.ClientID != -1)
      query = query + "  AND sfcontr.t_PartyID = ?";
      cmd.AddParam(m_paramReport.ClientID);
    end;
    // договор
    if (m_paramReport.CntrID != -1)
      query = query + "  AND sfcontr.t_ID = ?";
      cmd.AddParam(m_paramReport.CntrID);
    end;

    query = query + " order by dep.t_code, t_ClientID ";

//    println(query);

    var cnt = 0, i = 0;
    cnt = cmd.GetCount(query);

    if (cnt > 0)
      InitProgress( cnt, "Отчет \"Отчет брокера о проведенных операциях\"", "Формирование отчета" );

      dataSet = cmd.Execute(query);

      while (dataSet.MoveNext())

        ExecuteReportByClient(dataSet);
        i = i + 1;
        UseProgress(i);
      end;

      RemProgress;
    end;
    
    OnError(e)
      msgbox(cmd.GetErrorString(e));
  end;

  private macro Create()
    ExecuteReport();
  end;

  /* есть данные в выборке? */
  macro CReport_DataExist()
     return m_isExistData;
  end;

  initDL_CReportTemplate(NULL, "Report_BrokerPrognos.xls", null, null, null, true);
end;

/* ******************************************* */
/* ******************************************* */
/* Процедура запуска отчета                    */
/* ******************************************* */
/* ******************************************* */
macro ReportRun()
  var param = СBrokerMarket_Panel();
  while (param.Run())
    var report = CBrokerPrognos_Report(param);
    report.Run();
    if (not report.CReport_DataExist())
      msgbox("Нет данных для выпуска отчета");
    end;
  end;
end; 

ReportRun();
exit(1);