/*
$Name:         conv310.mac
$Module:       Ценные бумаги
$Description:  Операция конвертации ц/б.
*/
import "secinter.mac","sp_class.mac";

macro ExecuteStep( doc, FDoc)
  record deal(dl_tick);
  var    FD_in, FD_out, dat;

  SetBuff( deal, FDoc ); 

  FD_in  = SPFirstDoc( deal, true ); /*зачисление*/
  GetOprDate( FD_in.GetKindDate(DATE_CONVAVR_END), dat );
  if( dat > {curdate} )
     MsgBox ("Преждевременное выполнение шага запрещено.");
     return 1;
  end;

  FD_out = SPFirstDoc( deal ); /*списание*/

  if( ТОЗакрыто( FD_out.GetRQ(DLRQ_TYPE_DELIVERY) ) != true )
     msgbox( "ТО по списанию ц/б не закрыто.|Возможно выполнены не все проводки по учету ц/б в части списания");
     return 1;
  end;

  if( ТОЗакрыто( FD_in.GetRQ(DLRQ_TYPE_DELIVERY) ) != true )
     msgbox( "ТО по зачислению ц/б не закрыто.|Возможно выполнены не все проводки по учету ц/б в части зачисления");
     return 1;
  end;

  return 0;
end;
