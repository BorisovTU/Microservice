/*
$Name:        TaxAccSecur_Report.mac
$Module:      АРНУ
$Description: Налоговый учет эмиссионных ценных бумаг. Отчеты - НУНП, НУСВОД, НУМСФО. 
              Формирование отчета.
*/
IMPORT "TaxAccSecur_Form.mac", TaxAccSecur_FIReportsReader;

// Количество параллельно выполняемых задач для отчета НУСВОД:
//  рекомендуется указывать не больше, чем: cpu_count * parallel_threads_per_cpu
//  0 - последовательное выполнение (для отладки)
PRIVATE VAR ParallelLevel = 8;

PRIVATE VAR WebMenuItem; // Информация о запуске отчета из веб

PRIVATE CONST SHEET_NUNP   = "Приложение 2 (НП)",
              SHEET_SVOD   = "Приложение 3 (Свод)",
              SHEET_MSFO   = "Приложение 4 (Отчет МСФО)",

              LIGHTGREYCOLOR  = RGB(217,217,217),
              GREYCOLOR       = RGB(166,166,166),
              LIGHTBROWNCOLOR = RGB(217,233,253),

              POILIGHTGREYCOLOR = RGB(200,200,200),
              POIGREYCOLOR      = RGB(170,170,170),

              O1_1         = 1, // ССПУ_ЦБ
              O1_2         = 2, // СССД_ЦБ
              O1_3         = 3, // АС_ЦБ, ПДО или ПКУ

              НомерСтрокиИтогов       = 5,
              НомерСтрокиИтогов_Свод  = 5,

              C_NUNP_DDB              = "G",  //Н2    //7
              C_NUNP_QntyB            = "H",  //Н3    //8
              C_NUNP_QntyS            = "I",  //Н4    //9
              C_NUNP_QntyOst          = "J",  //Н5    //10
              C_NUNP_QntyB_OR         = "K",  //Н6    //11
              C_NUNP_QntyS_PR         = "L",  //Н7    //12
              C_NUNP_NomVN_DDB        = "N",  //Н9    //14
              C_NUNP_NomVN_DH         = "O",  //Н10   //15
              C_NUNP_PrBnom           = "P",  //Н11   //16
              C_NUNP_PrBVN            = "Q",  //Н12   //17
              C_NUNP_NkdBVN_DDB       = "S",  //Н14   //19
              C_NUNP_LastCoupDate     = "T",  //Н15   //20
              C_NUNP_SumBVN_DH        = "U",  //Н16   //21
              C_NUNP_NkdBVN_DH        = "V",  //Н17   //22
              C_NUNP_CrVNrub_DDB      = "W",  //Н18   //23
              C_NUNP_CrVNrub_DH       = "X",  //Н19   //24
              C_NUNP_SumBrub_DDB      = "Y",  //Н20   //25
              C_NUNP_NkdBrub_DDB      = "Z",  //Н21   //26
              C_NUNP_SumBrub_DH       = "AA", //Н22   //27
              C_NUNP_NkdBrub_DH       = "AB", //Н23   //28
              C_NUNP_NkdRepVN         = "AC", //Н24   //29
              C_NUNP_NkdRepRub3       = "AD", //Н25   //30
              C_NUNP_NkdRepChgNumRub  = "AE", //Н26   //31
              C_NUNP_BalSumVN_DH      = "AF", //Б1    //32
              C_NUNP_BalNkdBVN_DH     = "AG", //Б2    //33
              C_NUNP_B3               = "AH", //Б3    //34
              C_NUNP_B4               = "AI", //Б4    //35
              C_NUNP_B5               = "AJ", //Б5    //36
              C_NUNP_BalSumRub_DH     = "AK", //Б6    //37
              C_NUNP_BalNkdBrub_DH    = "AL", //Б7    //38
              C_NUNP_B8               = "AM", //Б8    //39
              C_NUNP_B9               = "AN", //Б9    //40
              C_NUNP_B10              = "AO", //Б10   //41
              C_NUNP_B11              = "AP", //Б11   //42
              C_NUNP_B12              = "AQ", //Б12   //43
              C_NUNP_B13              = "AR", //Б13   //44
              C_NUNP_B14              = "AS", //Б14   //45
              C_NUNP_B15              = "AT", //Б15   //46
              C_NUNP_B16              = "AU", //Б16   //47
              C_NUNP_B17              = "AV", //Б17   //48
              C_NUNP_B17_1            = "AW", //Б17.1 //49
              C_NUNP_B18              = "AX", //Б18   //50
              C_NUNP_B18_1            = "AY", //Б18.1 //51
              C_NUNP_B19              = "AZ", //Б19   //52
              C_NUNP_B19_1            = "BA", //Б19.1 //53
              C_NUNP_B20              = "BB", //Б20   //54
              C_NUNP_VR1              = "BC", //ВР1   //55
              C_NUNP_VR2              = "BD", //ВР2   //56
              C_NUNP_ComBRub          = "BE"; //ВР3   //57


/*вкладка Приложение 4 (Отчет МСФО)*/
PRIVATE CLASS CNU_MSFO( Report:OBJECT )
  PRIVATE VAR m_Report = Report;

  MACRO F(Str:string ):string
    return m_Report.F(Str);
  END;

  PRIVATE MACRO BeginReport()

    m_Report.SetActiveSheet( SHEET_MSFO );

    m_Report.PrintFormatString( "",
                                "N3_H1",   GetPartyFullNameByID({OurBank}, false, false),
                                "N3_H0_1", string(m_Report.GetEndDate():f)
                              );
  END;

  PRIVATE MACRO Print_NU_MSFO()
    var v_FSumIF = m_Report.FormulaSUMIF(),
        v_SHEET_SVOD = "'"+SHEET_SVOD+"'";

    if( m_Report.GetIsDataExist_SVOD() )
      // Раздел 1.1 - Доходы под 20%
      // Графа 3 "Факт"
      // по коду 77751101:
      m_Report.SetCell( "C10", F(v_SHEET_SVOD+"!AC7") );

      // Графа 6 "Наращенные (б)"
      // по коду 77751102:
      m_Report.SetCell( "F11", F(v_FSumIF+"("+v_SHEET_SVOD+"!BG7;\">0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BI7;\">0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BK7;\">0\")") );
      // по коду 77751103:
      m_Report.SetCell( "F12", F(v_FSumIF+"("+v_SHEET_SVOD+"!BE7;\">0\")") );
      // по коду 77751105:
      m_Report.SetCell( "F14", F(v_SHEET_SVOD+"!BQ7-"+v_SHEET_SVOD+"!BO7") );

      // Графа 8 "Будущие"
      // по коду 77751102:
      m_Report.SetCell( "H11", F(v_FSumIF+"("+v_SHEET_SVOD+"!BF7;\">0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BH7;\">0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BJ7;\">0\")") );
      // по коду 77751103:
      m_Report.SetCell( "H12", F(v_FSumIF+"("+v_SHEET_SVOD+"!BD7;\">0\")") );
      // по коду 77751105:
      m_Report.SetCell( "H14", F(v_SHEET_SVOD+"!BP7-"+v_SHEET_SVOD+"!BN7") );

      // Раздел 1.2 - Доходы под 15%
      // Графа 3 "Факт"
      // по коду 77751202:
      m_Report.SetCell( "C24", F(v_SHEET_SVOD+"!AC6") );

      // Графа 6 "Наращенные (б)"
      // по коду 77751202:
      m_Report.SetCell( "F26", F(v_SHEET_SVOD+"!BQ6-"+v_SHEET_SVOD+"!BO6") );

      // Графа 8 "Будущие"
      // по коду 77751204:
      m_Report.SetCell( "H26", F(v_SHEET_SVOD+"!BP6-"+v_SHEET_SVOD+"!BN6") );

      // Раздел 2.1 - Расходы под 20%
      // Графа 3 "Факт"
      // по коду 77752101:
      m_Report.SetCell( "C40", F(v_SHEET_SVOD+"!AD7") );

      // Графа 5 "Предыдущие"
      // по коду 77752108:
      m_Report.SetCell( "E47", F(v_SHEET_SVOD+"!BV7") );

      // Графа 6 "Наращенные (б)"
      // по коду 77752102:
      m_Report.SetCell( "F41", F(v_FSumIF+"("+v_SHEET_SVOD+"!BG7;\"<0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BI7;\"<0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BK7;\"<0\")") );
      // по коду 77752103:
      m_Report.SetCell( "F42", F(v_FSumIF+"("+v_SHEET_SVOD+"!BE7;\"<0\")") );
      // по коду 77752107:
      m_Report.SetCell( "F46", F(v_SHEET_SVOD+"!BS7") );

      // Графа 7 "Наращенные"
      // по коду 77752108:
      m_Report.SetCell( "G47", F(v_SHEET_SVOD+"!BW7") );

      // Графа 8 "Будущие"
      // по коду 77752102:
      m_Report.SetCell( "H41", F(v_FSumIF+"("+v_SHEET_SVOD+"!BF7;\"<0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BH7;\"<0\")+"+v_FSumIF+"("+v_SHEET_SVOD+"!BJ7;\"<0\")") );
      // по коду 77752103:
      m_Report.SetCell( "H42", F(v_FSumIF+"("+v_SHEET_SVOD+"!BD7;\"<0\")") );
      // по коду 77752107:
      m_Report.SetCell( "H46", F(v_SHEET_SVOD+"!BR7") );

      // Налоговая база - по РНУ
      // Графа 3
      // по коду 77750002:
      m_Report.SetCell( "C58", F(v_SHEET_SVOD+"!X5+"+v_SHEET_SVOD+"!AB5") );
    end;

  END;

  PRIVATE MACRO EndReport()
    m_Report.EndReport_NU_MSFO();
  END;

  MACRO CreateReport()
    BeginReport();
    Print_NU_MSFO();
    EndReport();
  END;
END;


/*вкладка Приложение 3 (Свод)*/
PRIVATE CLASS CNU_SVOD( Report:OBJECT )
  PRIVATE VAR m_Report = Report,
              m_RS, m_IsExistsData = false, m_CurrentStrNumber = 0,
              v_StrNumFI_NUNP:integer = -1, ExistsFI_NUNP:bool = false, v_SHEET_NUNP:string = "";

  PRIVATE MACRO BeginReport()

     m_Report.SetActiveSheet( SHEET_SVOD );

     m_Report.PrintFormatString( "",
                                 "N2_H0_1", string(m_Report.GetEndDate():f)
                               );

     m_Report.RegisterTable( "N2_MainTable", "",
                  /* O1  */  "N2_SecName",
                  /* O2  */  "N2_ISIN",
                  /* O3  */  "N2_NumReg",
                  /* O4  */  "N2_Code",
                  /* O5  */  "N2_VN",
                  /* Н1  */  "N2_SumSrub",
                  /* Н2  */  "N2_SumBrub",
                  /* Н3  */  "N2_Comiss",
                  /* Н4  */  "N2_Fin_Res",
                  /* Н5  */  "N2_NkdSRub",
                  /* Н6  */  "N2_NkdBRub",
                  /* Н7  */  "N2_NkdRepRub",
                  /* Н8  */  "N2_NkdRub",
                  /* Н9  */  "N2_NkdPrevRub",
                  /* Н10 */  "N2_ProcAllRub",
                  /* Н11 */  "N2_SumSrub_Tx",
                  /* Н12 */  "N2_RashAll_Tx",
                  /* Н13 */  "N2_DohRepRub",
                  /* Н14 */  "N2_RashRepRub",
                  /* Н15 */  "N2_DohNkd_Tx",
                  /* Н16 */  "N2_RashNkd_Tx",
                  /* Н17 */  "N2_Taxe_All",
                  /* Н18 */  "N2_StRate",
                  /* Н19 */  "N2_Taxe_StRate15",
                  /* Н20 */  "N2_Taxe_StRate20",
                  /* Н21 */  "N2_DohRez",
                  /* Н22 */  "N2_RashRez",
                  /* Н23 */  "N2_TxStR20_Rez",
                  /* БС1 */  "N2_Doh_All",
                  /* БС2 */  "N2_Rash_All",
                  /* БС3 */  "N2_Taxe_RashDiff",
                  /* БС4 */  "N2_FinRes_Diff",
                  /* БС5 */  "N2_Taxe_Diff",
                  /* БС6 */  "N2_BS6",
                  /* Б1  */  "N2_BalDoh_Rest",
                  /* Б2  */  "N2_BalRash_Rest",
                  /* Б3  */  "N2_BalDoh_Coup",
                  /* Б4  */  "N2_BalDoh_Disk",
                  /* Б5  */  "N2_B5",
                  /* Б6  */  "N2_DohPrcRep",
                  /* Б7  */  "N2_RashPrcRep",
                  /* Б8  */  "N2_Doh_Deriv",
                  /* Б9  */  "N2_Rash_Deriv",
                  /* Б10 */  "N2_PlusCurrPereoc",
                  /* Б11 */  "N2_MinusCurrPereoc",
                  /* Б12 */  "N2_DohPerMarkt",
                  /* Б13 */  "N2_RashPerMarkt",
                  /* Б14 */  "N2_B14",
                  /* Б15 */  "N2_B15",
                  /* Б16 */  "N2_B16",
                  /* Б17 */  "N2_B17",
                  /* Б18 */  "N2_Diff",
                  /* Б19 */  "N2_PlusPereoc_Diff",
                  /* Б20 */  "N2_MinusPereoc_Diff",
                  /* Б21 */  "N2_B21",
                  /* К1  */  "N2_K1",
                  /* К2  */  "N2_K2",
                  /* К3  */  "N2_K3",
                  /* К4  */  "N2_K4",
                  /* К5  */  "N2_K5",
                  /* К6  */  "N2_K6",
                  /* К7  */  "N2_K7",
                  /* К8  */  "N2_K8",
                  /* К9  */  "N2_K9",
                  /* К10 */  "N2_K10",
                  /* К11 */  "N2_K11",
                  /* К12 */  "N2_K12",
                  /* К13 */  "N2_K13",
                  /* К14 */  "N2_K14",
                  /* К15 */  "N2_K15",
                  /* К16 */  "N2_K16",
                  /* К17 */  "N2_K17",
                  /* К18 */  "N2_K18",
                  /* К19 */  "N2_RashRez_Prev",
                  /* К20 */  "N2_RashRez_DH",
                  /* П1  */  "N2_PrtfCateg",
                  /* С1  */  "N2_AccDoh_Rest",
                  /* С2  */  "N2_AccRash_Rest",
                  /* С3  */  "N2_AccDoh_Coup",
                  /* С4  */  "N2_AccDoh_Disk",
                  /* С5  */  "N2_S5",
                  /* С6  */  "N2_AccDoh_Pereoc",
                  /* С7  */  "N2_AccRash_Pereoc",
                  /* С8  */  "N2_S8",
                  /* С9  */  "N2_S9",
                  /* С10 */  "N2_Acc_Rest",
                  /* С11 */  "N2_AccCoupS",
                  /* С12 */  "N2_Acc_Disk",
                  /* С13 */  "N2_S13",
                  /* С14 */  "N2_AccCoupB",
                  /* С15 */  "N2_AccRepRest",
                  /* С16 */  "N2_AccRepCoupS",
                  /* С17 */  "N2_AccRepDisk",
                  /* С18 */  "N2_S18",
                  /* С19 */  "N2_AccRepCoupB",
                  /* С20 */  "N2_S20",
                  /* С21 */  "N2_S21",
                  /* С22 */  "N2_S22",
                  /* С23 */  "N2_S23",
                  /* С24 */  "N2_PlusPereoc_Account",
                  /* С25 */  "N2_MinusPereoc_Account",
                  /* O6  */  "N2_SecCode",
                  /* O7  */  "N2_DGO"
                           );
  END;

  PRIVATE MACRO GetSumSrub():STRING
    return ("F"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetSumBrub():STRING
    return ("G"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetComiss():STRING
    return ("H"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetNkdSRub():STRING
    return ("J"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetNkdBRub():STRING
    return ("K"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetNkdRepRub():STRING
    return ("L"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetNkdRub():STRING
    return ("M"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetNkdPrevRub():STRING
    return ("N"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDohRepRub():STRING // Н13
    return ("R"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRashRepRub():STRING // Н14
    return ("S"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetSumSrub_Tx():STRING
    return ("P"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRashAll_Tx():STRING
    return ("Q"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDohNkd_Tx():STRING
    return ("T"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRashNkd_Tx():STRING
    return ("U"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetTaxe_All():STRING
    return ("V"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetStRate():STRING // Н18
    return ("W"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetTaxe_StRate15():STRING // Н19
    return ("X"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetTaxe_StRate20():STRING // Н20
    return ("Y"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDohRez():STRING // Н21
    return ("Z"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRashRez():STRING // Н22
    return ("AA"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetBalDoh_Rest():STRING // Б1
    return ("AI"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetBalDoh_Coup():STRING // Б3
    return ("AK"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetBalDoh_Disk():STRING // Б4
    return ("AL"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDohPrcRep():STRING // Б6
    return ("AN"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDoh_Deriv():STRING // Б8
    return ("AP"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetPlusCurrPereoc():STRING // Б10
    return ("AR"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetMinusCurrPereoc():STRING // Б11
    return ("AS"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDohPerMarkt():STRING // Б12
    return ("AT"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetB14():STRING // Б14
    return ("AV"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetB16():STRING // Б16
    return ("AX"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDiff():STRING // Б18
    return ("AZ"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetBalRash_Rest():STRING // Б2
    return ("AJ"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetB5():STRING // Б5
    return ("AM"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRashPrcRep():STRING // Б7
    return ("AO"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRash_Deriv():STRING // Б9
    return ("AQ"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRashPerMarkt():STRING // Б13
    return ("AU"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetB15():STRING // Б15
    return ("AW"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetB17():STRING // Б17
    return ("AY"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK1():STRING // К1
    return ("BD"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK2():STRING // К2
    return ("BE"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK3():STRING // К3
    return ("BF"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK4():STRING // К4
    return ("BG"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK5():STRING // К5
    return ("BH"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK6():STRING // К6
    return ("BI"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK7():STRING // К7
    return ("BJ"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK8():STRING // К8
    return ("BK"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK9():STRING // К9
    return ("BL"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK10():STRING // К10
    return ("BM"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK11():STRING // К11
    return ("BN"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK12():STRING // К12
    return ("BO"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK13():STRING // К13
    return ("BP"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK14():STRING // К14
    return ("BQ"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK15():STRING // К15
    return ("BR"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK16():STRING // К16
    return ("BS"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK17():STRING // К17
    return ("BT"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK18():STRING // К18
    return ("BU"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK19():STRING // К19
    return ("BV"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetK20():STRING // К20
    return ("BW"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetPlusPereoc_Diff():STRING // Б19
    return ("BA"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetMinusPereoc_Diff():STRING // Б20
    return ("BB"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetB21():STRING // Б21
    return ("BC"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetDoh_All():STRING // Б1
    return ("AC"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetRash_All():STRING // БС2
    return ("AD"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetTaxe_RashDiff():STRING // Б3
    return ("AE"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetTxStR20_Rez():STRING // Н23
    return ("AB"+m_CurrentStrNumber);
  END;
  PRIVATE MACRO GetFinRes_Diff():STRING // БС4
    return ("AF"+m_CurrentStrNumber);
  END;

  MACRO F(Str:string ):string
    return m_Report.F(Str);
  END;

  MACRO GetEndROWNum()
     return (MAXROWSHEET + НомерСтрокиИтогов + 2);
  END;            
 
  PRIVATE MACRO PrintTableStr()
     v_SHEET_NUNP = "'"+SHEET_NUNP+"'";

     if(m_Report.GetIsDataExist_NUNP())
       v_StrNumFI_NUNP = m_Report.GetStrFI_NUNP(m_Rs.FIID);
     else
      v_StrNumFI_NUNP = -1;
     end;

     if(v_StrNumFI_NUNP != -1)
       ExistsFI_NUNP = true;
     else
       ExistsFI_NUNP = false;
     end;

     m_Report.PrintTableLine(
                   /* О1  */  "N2_SecName",               m_RS.SecName,                                                                                          null,
                   /* О2  */  "N2_ISIN",                  m_RS.ISIN,                                                                                             null,
                   /* О3  */  "N2_NumReg",                m_RS.NumReg,                                                                                           null,
                   /* О4  */  "N2_Code",                  m_RS.Code,                                                                                             null,
                   /* О5  */  "N2_VN",                    m_RS.VN,                                                                                               null,
                   /* Н1  */  "N2_SumSrub",               m_RS.SumSrub,                                                                                          null,
                   /* Н2  */  "N2_SumBrub",               m_RS.SumBrub,                                                                                          null,
                   /* Н3  */  "N2_Comiss",                m_RS.Comiss,                                                                                           null,
                   /* Н4  */  "N2_Fin_Res",               F(GetSumSrub+"-"+GetSumBrub+"-"+GetComiss),                                                            null,/*! Формула*/
                   /* Н5  */  "N2_NkdSRub",               m_RS.NkdSRub,                                                                                          null,
                   /* Н6  */  "N2_NkdBRub",               m_RS.NkdBRub,                                                                                          null,
                   /* Н7  */  "N2_NkdRepRub",             m_RS.NkdRepRub,                                                                                        null,
                   /* Н8  */  "N2_NkdRub",                m_RS.NkdRub,                                                                                           null,
                   /* Н9  */  "N2_NkdPrevRub",            m_RS.NkdPrevRub,                                                                                       null,
                   /* Н10 */  "N2_ProcAllRub",            F(GetNkdSRub+"-"+GetNkdBRub+"+"+GetNkdRepRub+"+"+GetNkdRub+"-"+GetNkdPrevRub),                         null,/*! Формула*/
                   /* Н11 */  "N2_SumSrub_Tx",            F(GetSumSrub+"+"+GetNkdSRub),                                                                          null,/*! Формула*/
                   /* Н12 */  "N2_RashAll_Tx",            F(GetSumBrub+"+"+GetComiss+"+"+GetNkdBRub),                                                            null,/*! Формула*/
                   /* Н13 */  "N2_DohRepRub",             m_RS.DohRepRub,                                                                                        null,
                   /* Н14 */  "N2_RashRepRub",            m_RS.RashRepRub,                                                                                       null,
                   /* Н15 */  "N2_DohNkd_Tx",             F(GetNkdSRub+"-"+GetNkdBRub+"+"+GetNkdRepRub+"+"+GetNkdRub+"-"+GetNkdPrevRub+"+"+GetDohRepRub),        null,/*! Формула*/
                   /* Н16 */  "N2_RashNkd_Tx",            F(GetNkdSRub+"-"+GetNkdBRub+"+"+GetRashRepRub),                                                                       null,/*! Формула*/
                   /* Н17 */  "N2_Taxe_All",              F(GetSumSrub_Tx+"-"+GetRashAll_Tx+"+"+GetDohNkd_Tx+"-"+GetRashNkd_Tx),                                 null,/*! Формула*/
                   /* Н18 */  "N2_StRate",                m_RS.StRate,                                                                                           null,
                   /* Н19 */  "N2_Taxe_StRate15",         F(m_Report.FormulaIF()+"("+GetStRate+"=15%;("+GetNkdRepRub+"+"+GetNkdRub+"-"+GetNkdPrevRub+"); 0)"),   null,/*! Формула*/
                   /* Н20 */  "N2_Taxe_StRate20",         F(GetTaxe_All+"-"+GetTaxe_StRate15),                                                                   null,/*! Формула*/
                   /* Н21 */  "N2_DohRez",                F(m_Report.FormulaIF()+"("+GetK20+">"+GetK19+";("+GetK20+"-"+GetK19+"); 0)"),                          null,/*! Формула*/
                   /* Н22 */  "N2_RashRez",               F(m_Report.FormulaIF()+"("+GetK19+">"+GetK20+";("+GetK19+"-"+GetK20+"); 0)"),                          null,/*! Формула*/
                   /* Н23 */  "N2_TxStR20_Rez",           F(GetTaxe_StRate20+"+"+GetDohRez+"-"+GetRashRez),                                                      null,/*! Формула*/
                   /* БС1 */  "N2_Doh_All",               F(GetBalDoh_Rest+"+"+GetBalDoh_Coup+"+"+GetBalDoh_Disk+"+"+GetDohPrcRep+"+"+GetDoh_Deriv+"+"+
                                                            GetPlusCurrPereoc+"+"+GetDohPerMarkt+"+"+GetB14+"+"+GetB16+"+"+GetDiff),                             null,/*! Формула*/
                   /* БС2 */  "N2_Rash_All",              F(GetBalRash_Rest+"+"+GetB5+"+"+GetRashPrcRep+"+"+GetRash_Deriv+"+"+GetMinusCurrPereoc+"+"+
                                                            GetRashPerMarkt+"+"+GetB15+"+"+GetB17+"+"+GetB21),                                                              null,/*! Формула*/
                   /* БС3 */  "N2_Taxe_RashDiff",         F("-"+GetK1+"+"+GetK2+"-"+GetK3+"+"+GetK4+"-"+GetK5+"+"+GetK6+"-"+GetK7+"+"+GetK8+"-"+GetK9+"+"+
                                                            GetK10+"-"+GetK15+"+"+GetK16+"-"+GetK17+"+"+GetK18+"+"+
                                                            GetK19+"+"+GetK20+"+"+GetPlusPereoc_Diff+"+"+GetMinusPereoc_Diff),                                   null,/*! Формула*//*GAA:511246, new:+Б19, old:-Б19*/
                   /* БС4 */  "N2_FinRes_Diff",           F(GetDoh_All+"-"+GetRash_All+"+"+GetTaxe_RashDiff),                                                    null,/*! Формула*/
                   /* БС5 */  "N2_Taxe_Diff",             F(GetTaxe_StRate15+"+"+GetTxStR20_Rez+"-"+GetFinRes_Diff),                                             null,/*! Формула*/
                   /* БС6 */  "N2_BS6",                   F(GetDohRepRub+"-"+GetRashRepRub+"-"+GetDohPrcRep+"+"+GetRashPrcRep+"-"+GetK17+"+"+GetK18),            null,/*! Формула*/
                   /* Б1  */  "N2_BalDoh_Rest",           m_RS.BalDoh_Rest,                                                                                      null,
                   /* Б2  */  "N2_BalRash_Rest",          m_RS.BalRash_Rest,                                                                                     null,
                   /* Б3  */  "N2_BalDoh_Coup",           m_RS.BalDoh_Coup,                                                                                      null,
                   /* Б4  */  "N2_BalDoh_Disk",           m_RS.BalDoh_Disk,                                                                                      null,
                   /* Б5  */  "N2_B5",                    m_RS.B5_SVOD,                                                                                          null,
                   /* Б6  */  "N2_DohPrcRep",             m_RS.DohPrcRep,                                                                                        null,
                   /* Б7  */  "N2_RashPrcRep",            m_RS.RashPrcRep,                                                                                       null,
                   /* Б8  */  "N2_Doh_Deriv",             m_RS.Doh_Deriv,                                                                                        null,
                   /* Б9  */  "N2_Rash_Deriv",            m_RS.Rash_Deriv,                                                                                       null,
                   /* Б10 */  "N2_PlusCurrPereoc",        m_RS.PlusCurrPereoc,                                                                                   null,
                   /* Б11 */  "N2_MinusCurrPereoc",       m_RS.MinusCurrPereoc,                                                                                  null,
                   /* Б12 */  "N2_DohPerMarkt",           m_RS.DohPerMarkt,                                                                                      null,
                   /* Б13 */  "N2_RashPerMarkt",          m_RS.RashPerMarkt,                                                                                     null,
                   /* Б14 */  "N2_B14",                   m_RS.B14_SVOD,                                                                                         null,
                   /* Б15 */  "N2_B15",                   m_RS.B15_SVOD,                                                                                         null,
                   /* Б16 */  "N2_B16",                   m_RS.B16_SVOD,                                                                                         null,
                   /* Б17 */  "N2_B17",                   m_RS.B17_SVOD,                                                                                         null,
                   /* Б18 */  "N2_Diff",                  $0,                                                                                                    null,
                   /* Б19 */  "N2_PlusPereoc_Diff",       m_RS.PLUS_PEREOC_DIFF,                                                                                 null,
                   /* Б20 */  "N2_MinusPereoc_Diff",      m_RS.MINUS_PEREOC_DIFF,                                                                                null,
                   /* Б21 */  "N2_B21",                   m_RS.B21_SVOD,                                                                                         null,
                   /* К1  */  "N2_K1",                    F(IIF(ExistsFI_NUNP, v_SHEET_NUNP+"!"+C_NUNP_VR2+v_StrNumFI_NUNP, 0)),                                 null,/*! Формула*/
                   /* К2  */  "N2_K2",                    m_RS.VR2,                                                                                              null,
                   /* К3  */  "N2_K3",                    F(IIF(ExistsFI_NUNP, v_SHEET_NUNP+"!"+C_NUNP_VR1+v_StrNumFI_NUNP, 0)),                                 null,/*! Формула*/
                   /* К4  */  "N2_K4",                    m_RS.VR1,                                                                                              null,
                   /* К5  */  "N2_K5",                    F(IIF(ExistsFI_NUNP, v_SHEET_NUNP+"!"+C_NUNP_B11+v_StrNumFI_NUNP+"-"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B12+v_StrNumFI_NUNP+"+"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B13+v_StrNumFI_NUNP+"-"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B14+v_StrNumFI_NUNP, 0)),                                                    null,/*! Формула*/
                   /* К6  */  "N2_K6",                    m_RS.K6,                                                                                               null,
                   /* К7  */  "N2_K7",                    F(IIF(ExistsFI_NUNP, v_SHEET_NUNP+"!"+C_NUNP_B15+v_StrNumFI_NUNP+"-"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B16+v_StrNumFI_NUNP, 0)),                                                    null,/*! Формула*/
                   /* К8  */  "N2_K8",                    m_RS.K8,                                                                                               null,
                   /* К9  */  "N2_K9",                    F(IIF(ExistsFI_NUNP, "-"+v_SHEET_NUNP+"!"+C_NUNP_B17+v_StrNumFI_NUNP+"-"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B17_1+v_StrNumFI_NUNP+"+"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B18+v_StrNumFI_NUNP+"-"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B18_1+v_StrNumFI_NUNP+"-"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B19+v_StrNumFI_NUNP+"+"+
                                                            v_SHEET_NUNP+"!"+C_NUNP_B19_1+v_StrNumFI_NUNP, 0)),                                                    null,/*! Формула*/
                   /* К10 */  "N2_K10",                   m_RS.K10,                                                                                              null,
                   /* К11 */  "N2_K11",                   F(IIF(ExistsFI_NUNP, "-"+v_SHEET_NUNP+"!"+C_NUNP_B10+v_StrNumFI_NUNP, 0)),                             null,/*! Формула*/
                   /* К12 */  "N2_K12",                   m_RS.K12,                                                                                              null,
                   /* К13 */  "N2_K13",                   F(IIF(ExistsFI_NUNP, v_SHEET_NUNP+"!"+C_NUNP_B9+v_StrNumFI_NUNP, 0)),                                  null,/*! Формула*/
                   /* К14 */  "N2_K14",                   m_RS.K14,                                                                                              null,
                   /* К15 */  "N2_K15",                   F(IIF(ExistsFI_NUNP, "-"+v_SHEET_NUNP+"!"+C_NUNP_ComBRub+v_StrNumFI_NUNP, 0)),                         null,/*! Формула*/
                   /* К16 */  "N2_K16",                   m_RS.K16,                                                                                              null,
                   /* К17 */  "N2_K17",                   0,                                                                                                     null,
                   /* К18 */  "N2_K18",                   0,                                                                                                     null,
                   /* К19 */  "N2_RashRez_Prev",          m_RS.RashRez_Prev,                                                                                     null,
                   /* К20 */  "N2_RashRez_DH",            m_RS.RashRez_DH,                                                                                       null,
                   /* П1  */  "N2_PrtfCateg",             m_Rs.PRTFCATEG,                                                                                        null,
                   /* С1  */  "N2_AccDoh_Rest",           m_RS.AccDoh_Rest,                                                                                      null,
                   /* С2  */  "N2_AccRash_Rest",          m_RS.AccRash_Rest,                                                                                     null,
                   /* С3  */  "N2_AccDoh_Coup",           m_RS.AccDoh_Coup,                                                                                      null,
                   /* С4  */  "N2_AccDoh_Disk",           m_RS.AccDoh_Disk,                                                                                      null,
                   /* С5  */  "N2_S5",                    m_RS.S5_SVOD,                                                                                          null,
                   /* С6  */  "N2_AccDoh_Pereoc",         m_RS.AccDoh_Pereoc,                                                                                    null,
                   /* С7  */  "N2_AccRash_Pereoc",        m_RS.AccRash_Pereoc,                                                                                   null,
                   /* С8  */  "N2_S8",                    m_RS.S8_SVOD,                                                                                          null,
                   /* С9  */  "N2_S9",                    m_RS.S9_SVOD,                                                                                          null,
                   /* С10 */  "N2_Acc_Rest",              m_RS.Acc_Rest,                                                                                         null,
                   /* С11 */  "N2_AccCoupS",              m_RS.ACC_COUPS,                                                                                        null,
                   /* С12 */  "N2_Acc_Disk",              m_RS.ACC_DISK,                                                                                         null,
                   /* С13 */  "N2_S13",                   m_RS.S13_SVOD,                                                                                         null,
                   /* С14 */  "N2_AccCoupB",              m_RS.ACC_COUPB,                                                                                        null,
                   /* С15 */  "N2_AccRepRest",            m_RS.ACC_REPREST,                                                                                      null,
                   /* С16 */  "N2_AccRepCoupS",           m_RS.ACC_REPCOUPS,                                                                                     null,
                   /* С17 */  "N2_AccRepDisk",            m_RS.ACC_REPDISK,                                                                                      null,
                   /* С18 */  "N2_S18",                   m_RS.S18_SVOD,                                                                                         null,
                   /* С19 */  "N2_AccRepCoupB",           m_RS.ACC_REPCOUPB,                                                                                     null,
                   /* С20 */  "N2_S20",                   m_RS.S20_SVOD,                                                                                         null,
                   /* С21 */  "N2_S21",                   m_RS.S21_SVOD,                                                                                         null,
                   /* С22 */  "N2_S22",                   m_RS.S22_SVOD,                                                                                         null,
                   /* С23 */  "N2_S23",                   m_RS.S23_SVOD,                                                                                         null,
                   /* С24 */  "N2_PlusPereoc_Account",    m_RS.PLUS_PEREOC_ACCOUNT,                                                                              null,
                   /* С25 */  "N2_MinusPereoc_Account",   m_RS.MINUS_PEREOC_ACCOUNT,                                                                             null,
                   /* О6  */  "N2_SecCode",               m_RS.FI_Code,                                                                                          null,
                   /* О7  */  "N2_DGO",                   m_RS.DGO,                                                                                              null
                            );
     m_CurrentStrNumber = m_CurrentStrNumber + 1;
  end;

  PRIVATE MACRO EndReport()
    m_Report.EndReport_NU_SVOD();
  END;

  PRIVATE MACRO LoadDataInDBT()
    var cmd, header = "Отбор данных для отчета "+SHEET_SVOD;
    m_Report.GetProgressIndicator().Start(1, header, header);

    cmd = RSDCommand("CALL RSB_NUREP.CreateNU_SVOD_Data(?,?,?,?,?)");

    cmd.addParam( "", RSDBP_IN, m_Report.GetBegDate() );
    cmd.addParam( "", RSDBP_IN, m_Report.GetEndDate() );
    cmd.addParam( "", RSDBP_IN, m_Report.SessionID() );
    cmd.addParam( "", RSDBP_IN, ParallelLevel );
    if( m_Report.GetIsWebService() )
      cmd.addParam( "", RSDBP_IN, m_Report.GetProgressIndicator().GetReqID() );
    else
      cmd.addParam( "", RSDBP_IN, "" );
    end;
    cmd.execute();

    if( not m_Report.GetIsWebService() )
      m_Report.GetProgressIndicator().Update(1,1,header);
    end;
    m_Report.GetProgressIndicator().Stop();
  END;

  // печать данных отчета НУСвод
  PRIVATE MACRO Print_NU_SVOD()
    var header = "", NRecs = 0, Current = 0, cmd;
 
    cmd = DL_RSDCommand( " SELECT t.t_FIID, "
                        +"        t.t_FaceValueFI, "
                        +"        t.t_FaceValue, "  
                        +"        t.t_VN, "
                        +"        t.t_SecName, "
                        +"        t.t_RootAvrKind, "
                        +"        t.t_NumReg, "     
                        +"        t.t_ISIN, "       
                        +"        t.t_Code, "
                        +"        t.t_FI_Code, "
                        +"        t.t_IssName, "         
                        +"        t.t_StRate, "
                        +"        t.t_PLUS_PEREOC_ACCOUNT, " 
                        +"        t.t_MINUS_PEREOC_ACCOUNT, "
                        +"        t.t_ACC_REST,"
                        +"        t.t_ACC_COUPS,"   
                        +"        t.t_ACC_DISK,"    
                        +"        t.t_ACC_COUPB,"
                        +"        t.t_ACC_REPREST,"
                        +"        t.t_ACC_REPCOUPS,"
                        +"        t.t_ACC_REPDISK,"
                        +"        t.t_ACC_REPCOUPB,"
                        +"        t.t_PLUS_PEREOC_DIFF,"
                        +"        t.t_MINUS_PEREOC_DIFF,"
                        +"        t.t_BalDoh_Rest,"
                        +"        t.t_AccDoh_Rest,"
                        +"        t.t_BalRash_Rest,"
                        +"        t.t_AccRash_Rest,"
                        +"        t.t_BalDoh_Coup,"
                        +"        t.t_AccDoh_Coup,"
                        +"        t.t_BalDoh_Disk,"
                        +"        t.t_AccDoh_Disk,"
                        +"        t.t_B5_SVOD,"
                        +"        t.t_S5_SVOD,"
                        +"        t.t_DohPrcRep,"
                        +"        t.t_RashPrcRep,"
                        +"        t.t_Doh_Deriv,"
                        +"        t.t_Rash_Deriv,"
                        +"        t.t_PlusCurrPereoc,"
                        +"        t.t_MinusCurrPereoc,"
                        +"        t.t_DohPerMarkt,"
                        +"        t.t_AccDoh_Pereoc,"
                        +"        t.t_RashPerMarkt,"
                        +"        t.t_AccRash_Pereoc,"
                        +"        t.t_B14_SVOD,"
                        +"        t.t_S8_SVOD,"
                        +"        t.t_B15_SVOD,"
                        +"        t.t_S9_SVOD,"
                        +"        t.t_B16_SVOD,"
                        +"        t.t_B17_SVOD,"
                        +"        t.t_B21_SVOD,"
                        +"        t.t_S13_SVOD,"
                        +"        t.t_S18_SVOD,"
                        +"        t.t_S20_SVOD,"
                        +"        t.t_S21_SVOD,"
                        +"        t.t_S22_SVOD,"
                        +"        t.t_S23_SVOD,"
                        +"        t.t_PRTFCATEG,"
                        +"        t.t_DGO,"
                        +"        NVL(sc.t_SumSrub,0) t_SumSrub,"        
                        +"        NVL(sc.t_SumBrub,0) t_SumBrub,"        
                        +"        NVL(sc.t_Comiss,0) t_Comiss,"       
                        +"        NVL(sc.t_NkdSRub,0) t_NkdSRub,"         
                        +"        NVL(sc.t_NkdBRub,0) t_NkdBRub,"         
                        +"        NVL(sc.t_NkdRepRub,0) t_NkdRepRub,"       
                        +"        NVL(sc.t_NkdRub,0) t_NkdRub,"          
                        +"        NVL(sc.t_NkdPrevRub,0) t_NkdPrevRub,"      
                        +"        NVL(sc.t_DohRepRub,0) t_DohRepRub,"       
                        +"        NVL(sc.t_RashRepRub,0) t_RashRepRub,"
                        +"        NVL(sc.t_RashRez_Prev,0) t_RashRez_Prev,"
                        +"        NVL(sc.t_RashRez_DH,0) t_RashRez_DH,"
                        +"        NVL(sc.t_VR1,0) t_VR1, "
                        +"        NVL(sc.t_VR2,0) t_VR2, "
                        +"        NVL(sc.t_K6,0) t_K6, "
                        +"        NVL(sc.t_K8,0) t_K8, "
                        +"        NVL(sc.t_K10,0) t_K10, "
                        +"        NVL(sc.t_K12,0) t_K12, "
                        +"        NVL(sc.t_K14,0) t_K14, "
                        +"        NVL(sc.t_K16,0) t_K16 "
                        +"   FROM DNUSVODREP_DBT t left join DSCTXTOTAL_DBT sc on sc.t_FI_CODE = t.t_FI_CODE "
                        +"  WHERE t.t_SessionID = ? "
                        +"  ORDER BY t.T_SECNAME ");

    cmd.AddParam(m_Report.SessionID());
    NRecs = cmd.GetCount();

    if( NRecs > 0 )
      m_Report.SetCurrentStrNumber();
      m_CurrentStrNumber = m_Report.GetCurrentStrNumber();
      m_IsExistsData = true;
      m_Report.SetIsDataExist_SVOD(true);
      header = "Печать строк отчета "+SHEET_SVOD;
      m_Report.GetProgressIndicator().Start(NRecs, header, header);

      m_RS = cmd.execute();
      while(m_RS.MoveNext())
        // печать данных
        PrintTableStr();

        Current = Current + 1;
        m_Report.GetProgressIndicator().Update(Current,NRecs);
      end;
      m_Report.GetProgressIndicator().Stop();
    end;

  END;

  MACRO PrintItogs()
     m_Report.SetCurrentStrNumber();

     var v_CurrStrNum = iif(m_IsExistsData,string(m_Report.GetCurrentStrNumber()-1),11),
         v_FSum = m_Report.FormulaSUM(),
         v_НомерСтрокиНОБ15 = НомерСтрокиИтогов_Свод + 1,
         v_F:string = "=";

     /*Итого*/
     /*Н1  */ m_Report.SetCell( "F"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(F11:F"+v_CurrStrNum+")") );
     /*Н2  */ m_Report.SetCell( "G"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(G11:G"+v_CurrStrNum+")") );
     /*Н3  */ m_Report.SetCell( "H"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(H11:H"+v_CurrStrNum+")") );
     /*Н4  */ m_Report.SetCell( "I"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(I11:I"+v_CurrStrNum+")") );
     /*Н5  */ m_Report.SetCell( "J"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(J11:J"+v_CurrStrNum+")") );
     /*Н6  */ m_Report.SetCell( "K"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(K11:K"+v_CurrStrNum+")") );
     /*Н7  */ m_Report.SetCell( "L"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(L11:L"+v_CurrStrNum+")") );
     /*Н8  */ m_Report.SetCell( "M"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(M11:M"+v_CurrStrNum+")") );
     /*Н9  */ m_Report.SetCell( "N"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(N11:N"+v_CurrStrNum+")") );
     /*Н10 */ m_Report.SetCell( "O"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(O11:O"+v_CurrStrNum+")") );
     /*Н11 */ m_Report.SetCell( "P"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(P11:P"+v_CurrStrNum+")") );
     /*Н12 */ m_Report.SetCell( "Q"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(Q11:Q"+v_CurrStrNum+")") );
     /*Н13 */ m_Report.SetCell( "R"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(R11:R"+v_CurrStrNum+")") );
     /*Н14 */ m_Report.SetCell( "S"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(S11:S"+v_CurrStrNum+")") );
     /*Н15 */ m_Report.SetCell( "T"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(T11:T"+v_CurrStrNum+")") );
     /*Н16 */ m_Report.SetCell( "U"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(U11:U"+v_CurrStrNum+")") );
     /*Н17 */ m_Report.SetCell( "V"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(V11:V"+v_CurrStrNum+")") );
     /*Н19 */ m_Report.SetCell( "X"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(X11:X"+v_CurrStrNum+")") );
     /*Н20 */ m_Report.SetCell( "Y"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(Y11:Y"+v_CurrStrNum+")") );
     /*Н21 */ m_Report.SetCell( "Z"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(Z11:Z"+v_CurrStrNum+")") );
     /*Н22 */ m_Report.SetCell( "AA"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AA11:AA"+v_CurrStrNum+")") );
     /*Н22 */ m_Report.SetCell( "AB"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AB11:AB"+v_CurrStrNum+")") );
     /*БС1 */ m_Report.SetCell( "AC"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AC11:AC"+v_CurrStrNum+")") );
     /*БС2 */ m_Report.SetCell( "AD"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AD11:AD"+v_CurrStrNum+")") );
     /*БС3 */ m_Report.SetCell( "AE"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AE11:AE"+v_CurrStrNum+")") );
     /*БС4 */ m_Report.SetCell( "AF"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AF11:AF"+v_CurrStrNum+")") );
     /*БС5 */ m_Report.SetCell( "AG"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AG11:AG"+v_CurrStrNum+")") );
     /*БС6 */ m_Report.SetCell( "AH"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AH11:AH"+v_CurrStrNum+")") );
     /*Б1  */ m_Report.SetCell( "AI"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AI11:AI"+v_CurrStrNum+")") );
     /*Б2  */ m_Report.SetCell( "AJ"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AJ11:AJ"+v_CurrStrNum+")") );
     /*Б3  */ m_Report.SetCell( "AK"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AK11:AK"+v_CurrStrNum+")") );
     /*Б4  */ m_Report.SetCell( "AL"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AL11:AL"+v_CurrStrNum+")") );
     /*Б5  */ m_Report.SetCell( "AM"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AM11:AM"+v_CurrStrNum+")") );
     /*Б6  */ m_Report.SetCell( "AN"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AN11:AN"+v_CurrStrNum+")") );
     /*Б7  */ m_Report.SetCell( "AO"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AO11:AO"+v_CurrStrNum+")") );
     /*Б8  */ m_Report.SetCell( "AP"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AP11:AP"+v_CurrStrNum+")") );
     /*Б9  */ m_Report.SetCell( "AQ"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AQ11:AQ"+v_CurrStrNum+")") );
     /*Б10 */ m_Report.SetCell( "AR"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AR11:AR"+v_CurrStrNum+")") );
     /*Б11 */ m_Report.SetCell( "AS"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AS11:AS"+v_CurrStrNum+")") );
     /*Б12 */ m_Report.SetCell( "AT"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AT11:AT"+v_CurrStrNum+")") );
     /*Б13 */ m_Report.SetCell( "AU"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AU11:AU"+v_CurrStrNum+")") );
     /*Б14 */ m_Report.SetCell( "AV"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AV11:AV"+v_CurrStrNum+")") );
     /*Б15 */ m_Report.SetCell( "AW"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AW11:AW"+v_CurrStrNum+")") );
     /*Б16 */ m_Report.SetCell( "AX"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AX11:AX"+v_CurrStrNum+")") );
     /*Б17 */ m_Report.SetCell( "AY"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AY11:AY"+v_CurrStrNum+")") );
     /*Б18 */ m_Report.SetCell( "AZ"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(AZ11:AZ"+v_CurrStrNum+")") );
     /*Б19 */ m_Report.SetCell( "BA"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BA11:BA"+v_CurrStrNum+")") );
     /*Б20 */ m_Report.SetCell( "BB"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BB11:BB"+v_CurrStrNum+")") );
     /*Б21 */ m_Report.SetCell( "BC"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BC11:BC"+v_CurrStrNum+")") );
     /*К1  */ m_Report.SetCell( "BD"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BD11:BD"+v_CurrStrNum+")") );
     /*К2  */ m_Report.SetCell( "BE"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BE11:BE"+v_CurrStrNum+")") );
     /*К3  */ m_Report.SetCell( "BF"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BF11:BF"+v_CurrStrNum+")") );
     /*К4  */ m_Report.SetCell( "BG"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BG11:BG"+v_CurrStrNum+")") );
     /*К5  */ m_Report.SetCell( "BH"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BH11:BH"+v_CurrStrNum+")") );
     /*К6  */ m_Report.SetCell( "BI"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BI11:BI"+v_CurrStrNum+")") );
     /*К7  */ m_Report.SetCell( "BJ"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BJ11:BJ"+v_CurrStrNum+")") );
     /*К8  */ m_Report.SetCell( "BK"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BK11:BK"+v_CurrStrNum+")") );
     /*К9  */ m_Report.SetCell( "BL"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BL11:BL"+v_CurrStrNum+")") );
     /*К10 */ m_Report.SetCell( "BM"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BM11:BM"+v_CurrStrNum+")") );
     /*К11 */ m_Report.SetCell( "BN"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BN11:BN"+v_CurrStrNum+")") );
     /*К12 */ m_Report.SetCell( "BO"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BO11:BO"+v_CurrStrNum+")") );
     /*К13 */ m_Report.SetCell( "BP"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BP11:BP"+v_CurrStrNum+")") );
     /*К14 */ m_Report.SetCell( "BQ"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BQ11:BQ"+v_CurrStrNum+")") );
     /*К15 */ m_Report.SetCell( "BR"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BR11:BR"+v_CurrStrNum+")") );
     /*К16 */ m_Report.SetCell( "BS"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BS11:BS"+v_CurrStrNum+")") );
     /*К17 */ m_Report.SetCell( "BT"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BT11:BT"+v_CurrStrNum+")") );
     /*К18 */ m_Report.SetCell( "BU"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BU11:BU"+v_CurrStrNum+")") );
     /*К19 */ m_Report.SetCell( "BV"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BV11:BV"+v_CurrStrNum+")") );
     /*К20 */ m_Report.SetCell( "BW"+НомерСтрокиИтогов_Свод, v_F+(v_FSum+"(BW11:BW"+v_CurrStrNum+")") );

     /*НОБ по ставке 15%*/
     v_FSum = m_Report.FormulaSUMIF();
     /*Н5  */ m_Report.SetCell( "J"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";J11:J"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";J11:J"+v_CurrStrNum+")") );
     /*Н6  */ m_Report.SetCell( "K"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";K11:K"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";K11:K"+v_CurrStrNum+")") );
     /*Н7  */ m_Report.SetCell( "L"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";L11:L"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";L11:L"+v_CurrStrNum+")") );
     /*Н8  */ m_Report.SetCell( "M"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";M11:M"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";M11:M"+v_CurrStrNum+")") );
     /*Н9  */ m_Report.SetCell( "N"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";N11:N"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";N11:N"+v_CurrStrNum+")") );
     /*Н10 */ m_Report.SetCell( "O"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";O11:O"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";O11:O"+v_CurrStrNum+")") );
     /*Н19 */ m_Report.SetCell( "X"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";X11:X"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";X11:X"+v_CurrStrNum+")") );
     /*Б3  */ m_Report.SetCell( "AK"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";AK11:AK"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";AK11:AK"+v_CurrStrNum+")") );
     /*Б4  */ m_Report.SetCell( "AL"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";AL11:AL"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";AL11:AL"+v_CurrStrNum+")") );
     /*Б5  */ m_Report.SetCell( "AM"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";AM11:AM"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";AM11:AM"+v_CurrStrNum+")") );
     /*К13 */ m_Report.SetCell( "BP"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";BP11:BP"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";BP11:BP"+v_CurrStrNum+")") );
     /*К14 */ m_Report.SetCell( "BQ"+v_НомерСтрокиНОБ15, v_F+(v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%\";BQ11:BQ"+v_CurrStrNum+")+"+v_FSum+"(W11:W"+v_CurrStrNum+";\"=15%/20%\";BQ11:BQ"+v_CurrStrNum+")") );
  END;

  PRIVATE MACRO ClearDBT()
    sql_execute("DELETE FROM DNUSVODREP_DBT WHERE t_SessionID = " + string(m_Report.SessionID()));
  END;

  MACRO CreateReport()
    LoadDataInDBT();
    BeginReport();
    Print_NU_SVOD();
    EndReport();
    PrintItogs();
    ClearDBT();
  onError(e)
    ClearDBT();
    RunError;
  END;

END;

// Запоминает диапазон суммирования по портфелю внутри выпуска
PRIVATE CLASS CPortfRowsSum()
  // 1:ССПУ_ЦБ
  var StrNumBeg_Portf1:integer = 0;
  var StrNumEnd_Portf1:integer = 0;
  // 2:СССД_ЦБ
  var StrNumBeg_Portf2:integer = 0;
  var StrNumEnd_Portf2:integer = 0;
  // 3:АС_ЦБ, ПДО или ПКУ
  var StrNumBeg_Portf3:integer = 0;
  var StrNumEnd_Portf3:integer = 0;

  macro SetStrNumBeg(pStrNumBeg:@integer, pNum:integer)
    if( pStrNumBeg == 0 )
      pStrNumBeg = pNum;
    end;
  end;

  macro SetRangeSum(pO1:integer, pStrNum:integer)
    if( pO1 == O1_1 )
      SetStrNumBeg(@StrNumBeg_Portf1, pStrNum);
      StrNumEnd_Portf1 = pStrNum;
    elif( pO1 == O1_2 )
      SetStrNumBeg(@StrNumBeg_Portf2, pStrNum);
      StrNumEnd_Portf2 = pStrNum;
    elif( pO1 == O1_3 )
      SetStrNumBeg(@StrNumBeg_Portf3, pStrNum);
      StrNumEnd_Portf3 = pStrNum;
    end;
  end;

  macro GetRangeSum(pO1:integer, pStrNumBeg:@integer, pStrNumEnd:@integer)
    if( pO1 == O1_1 )
      pStrNumBeg = StrNumBeg_Portf1;
      pStrNumEnd = StrNumEnd_Portf1;
    elif( pO1 == O1_2 )
      pStrNumBeg = StrNumBeg_Portf2;
      pStrNumEnd = StrNumEnd_Portf2;
    elif( pO1 == O1_3 )
      pStrNumBeg = StrNumBeg_Portf3;
      pStrNumEnd = StrNumEnd_Portf3;
    end;
  end;
END;

// Запоминает диапазон суммирования по портфелям для выпуска
PRIVATE CLASS CIssuePortfRowsSum()
  var StrNumBeg = 0;
  var StrNumEnd = 0;

  macro SetStrNumBeg(pStrNumBeg:@integer, pNum:integer)
    if( pStrNumBeg == 0 )
      pStrNumBeg = pNum;
    end;
  end;

  macro SetRangeSum(pStrNum:integer)
    SetStrNumBeg(@StrNumBeg, pStrNum);
    StrNumEnd = pStrNum;
  end;

  macro GetRangeSum(pStrNumBeg:@integer, pStrNumEnd:@integer)
    pStrNumBeg = StrNumBeg;
    pStrNumEnd = StrNumEnd;
  end;
END;

PRIVATE CLASS CFIStr(pFIID:integer, pStrNumItog:integer)
  var FIID = -1;
  var StrNumItog = 0; // Номер строки итогов по выпуску

  macro Init(pFIID:integer, pStrNumItog:integer)
    FIID = pFIID;
    StrNumItog = pStrNumItog;
  end;

  Init(pFIID, pStrNumItog);
END;

PRIVATE CLASS CFIStrArr(pFIID:integer, pStrNumItog:integer)
  var arr = TArray();

  macro AddFI(pFIID:integer, pStrNumItog:integer)
    arr[arr.size] = CFIStr(pFIID, pStrNumItog);
  end;

  macro GetStrFI(fiid:integer)
    for (var rec, arr)
      if (rec.FIID == fiid)
        return rec.StrNumItog;
      end;
    end;

    return -1;
  end;
END;

PRIVATE CLASS (DL_CReportTemplate) CTaxAccSecur_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI: BOOL )
  private var m_IsDataExist = false, // для Web, если нет данных, то ничего не показываем
              m_IsDataExist_NUNP = false, m_IsDataExist_SVOD = false,
              m_НомерСтрокиИтогов_СВОД = 7,
              m_RepParams, m_ReportKind, m_CurrStrNum = 0, m_RS,
              m_PortfRowsSum = CPortfRowsSum(),
              m_IssuePortfRowsSum = CIssuePortfRowsSum(),
              m_FIStr = CFIStrArr(),
              m_SessionID = GetSessionID();

 // не показывать пустые отчет в Web
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true; //в EW показываем листы всегда
    end;
  END; 

  MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  MACRO IsPoi()
    return m_RepParams.UsePoi;
  END;

  MACRO GetDL_FORMULA():string
    if (IsPoi())
      return "=";
    end;
    return "f=";
  END;

  MACRO SetCell(name:string, val:variant)
    m_ObjTemplateXLS.SetValue_NameCell(name, val);
  END;

  PRIVATE MACRO SetAutoFilter_NUNP()
    if( ExistsSheet( SHEET_NUNP ) )
      m_ObjTemplateXLS.SetAutoFilter("A7:BF7", SHEET_NUNP);
    end;
  END;

  PRIVATE MACRO SetAutoFilter_NU_SVOD()
    if( ExistsSheet( SHEET_SVOD ) )
      m_ObjTemplateXLS.SetAutoFilter("A10:CW10", SHEET_SVOD);
    end;
  END;

  PRIVATE MACRO SetRowColor(rowNumber: Integer, cellCount: Integer, color: Integer)
    var book = m_ObjTemplateXLS.GetWorkbook();
    for (var i: Integer, 0, cellCount - 1)
      book.setBackgroundColor(color, rowNumber, i);
    end;
  END;

  MACRO SessionID():integer
    return m_SessionID;
  END;

  MACRO GetStrNumItog_SVOD():integer
    return m_НомерСтрокиИтогов_СВОД;
  END;

  MACRO SetStrNumItog_SVOD(pStrNumItog_SVOD:integer):integer
    m_НомерСтрокиИтогов_СВОД = pStrNumItog_SVOD;
  END;

  MACRO GetStrFI_NUNP(FIID:integer):integer
    return m_FIStr.GetStrFI(FIID);
  END;

  MACRO SetRepParams(RepParams)
    m_RepParams = RepParams;
  END;

  MACRO GetBegDate()
    return m_RepParams.BegDate;
  END;

  MACRO GetEndDate()
    return m_RepParams.EndDate;
  END;

  MACRO GetYear()
    return m_RepParams.Year;
  END;

  MACRO GetProgressIndicator()
    return m_ProgressIndicator;
  END;

  MACRO GetIsWebService()
    return m_IsWebService;
  END;

  MACRO GetIsDataExist_SVOD()
    return m_IsDataExist_SVOD;
  END;

  MACRO GetIsDataExist_NUNP()
    return m_IsDataExist_NUNP;
  END;

  MACRO SetIsDataExist(pIsDataExist:bool)
    m_IsDataExist = pIsDataExist;
  END;

  MACRO SetIsDataExist_SVOD(pIsDataExist:bool)
    SetIsDataExist(pIsDataExist);
    m_IsDataExist_SVOD = pIsDataExist;
  END;

  MACRO SetIsDataExist_NUNP(pIsDataExist:bool)
    SetIsDataExist(pIsDataExist);
    m_IsDataExist_NUNP = pIsDataExist;
  END;

  PRIVATE MACRO AddStandardFooter_TaxAccSecur( CellPrefix:STRING, _IsCurDate:BOOL, _IsPrintOperNum:bool )
    var ДолжностьРуководителяПодразделения = "Руководитель подразделения",
        РуководительПодразделения = ""; 

    MACRO ПолучитьПостИИмяРукПодразделения()
      var RS = TRsbDataSet("SELECT party.t_Name, officer.t_Post " +
                           "  FROM dofficer_dbt officer, dparty_dbt party " +
                           " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                           "       officer.t_OfficeID = " + string(SelfDivision) + " AND " +
                           "       officer.t_IsFirstOfficePerson = 'X' AND "
                           "       party.t_PartyID = officer.t_PersonID "
                          );
      if( RS.MoveNext() )
        ДолжностьРуководителяПодразделения = RS.Post;
        РуководительПодразделения = RS.Name;
      end;
    END;

    MACRO ДолжностьОперациониста()
      var RS = TRsbDataSet("SELECT officer.t_Post " +
                           "  FROM dofficer_dbt officer, dperson_dbt person " +
                           " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                           "       person.t_oper = " + string({oper}) + " AND " +
                           "       officer.t_PersonID = person.t_PartyID "
                          );
       if( RS.MoveNext() )
         return string(RS.Post);
      end;
      return "Ответственный сотрудник";
    END;

    var IsCurDate = False, m_Date, PostBoss, IsPrintOperNum = false;
    if( _IsCurDate != NULL )
      IsCurDate = _IsCurDate;
    end;
    if( _IsPrintOperNum != NULL )
      IsPrintOperNum = _IsPrintOperNum;
    end;

    if( m_UseTemplate )
      if( CellPrefix == null )
         CellPrefix = "";
      end;

      ПолучитьПостИИмяРукПодразделения();

      SetCell( CellPrefix+"ДолжностьРуководителяПодразделения",  ДолжностьРуководителяПодразделения + " _____________ "  );
      SetCell( CellPrefix+"РуководительПодразделения", РуководительПодразделения );
      SetCell( CellPrefix+"ДолжностьОперациониста", ДолжностьОперациониста() + " _____________ " );
      if(IsPrintOperNum)
        SetCell( CellPrefix+"Операционист", {Name_Oper} );
      end;
    else 
      m_ObjWinRep.AddStandardFooter( IsCurDate );
    end;
  END;

  PRIVATE MACRO PrintHeader_NUNP()
    PrintFormatString( "",
                       "N1_H0_1", string(m_RepParams.EndDate:f)
                     );
  END;

  PRIVATE MACRO НомерТекущейСтроки()
    if (IsPoi())
      return (getCurrentRow() + m_ReportTable.bRowTable - 2);
    end;
    return (getCurrentRow() + m_ReportTable.bRowTable);
  END;

  MACRO SetCurrentStrNumber()
    m_CurrStrNum = НомерТекущейСтроки();
  END;

  MACRO GetCurrentStrNumber()
    return m_CurrStrNum;
  END;

  PRIVATE MACRO NUNP_IsBond():BOOL
    return m_RS.RootAvrKind == AVOIRISSKIND_BOND;
  END;

  PRIVATE MACRO NUNP_FIID():INTEGER
    return m_RS.FIID;
  END;

  PRIVATE MACRO NUNP_FaceValueFI():INTEGER
    return m_RS.FaceValueFI;
  END;

  PRIVATE MACRO NUNP_FaceValue():MONEY
    return m_RS.FaceValue;
  END;

  PRIVATE MACRO NUNP_DEALID():INTEGER
    return m_RS.DEALID;
  END;

  PRIVATE MACRO NUNP_IsItogPortf():BOOL
    return m_RS.IsItogPortf == SET_CHAR;
  END;

  PRIVATE MACRO NUNP_ISITOG():BOOL
    return m_RS.ISITOG == SET_CHAR;
  END;

  // Номер портфеля
  PRIVATE MACRO NUNP_O1():INTEGER
    return m_RS.O1;
  END;

  // Краткое наименование выпуска ценных бумаг
  PRIVATE MACRO NUNP_SecName():STRING
    return m_RS.SecName;
  END;

  // ISIN
  PRIVATE MACRO NUNP_ISIN():STRING
    return m_RS.ISIN;
  END;

  // Номер государственной регистрации выпуска
  PRIVATE MACRO NUNP_NumReg():STRING
    return m_RS.NumReg;
  END;

  // Код вида ценной бумаги
  PRIVATE MACRO NUNP_Code():STRING
    return m_RS.Code;
  END;

  // Код ценной бумаги
  PRIVATE MACRO NUNP_SecCode():STRING
    return m_RS.FI_Code;
  END;

  // Дата заключения сделки
  PRIVATE MACRO NUNP_DR():DATE
    return m_RS.DR;
  END;

  // Дата ППС
  MACRO NUNP_DDB():DATE
    return m_RS.DDB;
  END;

  // Количество ценных бумаг (всего по сделке покупки), шт.
  PRIVATE MACRO NUNP_QntyB():DOUBLE
    /*bug WinRep: точность денег всегда 2? приходится через double ...*/
    return double(m_RS.QntyB);
  END;

  // Количество ценных бумаг (всего продано по сделкам обычной купли-продажи), шт.
  PRIVATE MACRO NUNP_QntyS():DOUBLE
    return double(m_RS.QntyS);
  END;

  // Код валюты номинала
  PRIVATE MACRO NUNP_VN():STRING
    return m_RS.VN;
  END;

  // Номинальная стоимость ценной бумаги на дату ППС, в валюте номинала
  PRIVATE MACRO NUNP_NomVN_DDB():DOUBLE
    return round(double(m_RS.NomVN_DDB), 2);
  END;

  // Номинальная стоимость ценной бумаги на отчетную дату, в валюте номинала
  PRIVATE MACRO NUNP_NomVN_DH():DOUBLE
    return round(double(m_RS.NomVN_DH), 2);
  END;

  // Цена приобретения одной облигации (без НКД), в %
  PRIVATE MACRO NUNP_PrBnom():DOUBLE
    return round(double(m_RS.PrBnom), 3);
  END;

  // Цена приобретения одной ценной бумаги (кроме облигации), в валюте номинала
  PRIVATE MACRO NUNP_PrBVN():DOUBLE
    return double(m_RS.PrBVN);
  END;

  // НКД уплаченный при приобретении облигаций на дату ППС, в валюте номинала
  PRIVATE MACRO NUNP_NkdBVN_DDB():DOUBLE
    return double(m_RS.NkdBVN_DDB);
  END;

  // Дата выплаты последнего купона в отчетном (налоговом) периоде
  PRIVATE MACRO NUNP_LastCoupDate():DATE
    return m_RS.LastCoupDate;
  END;

  // Курс валюты номинала, установленный ЦБ РФ на дату ППС, в рублях
  PRIVATE MACRO NUNP_CrVNrub_DDB():DOUBLE
    return double(m_RS.CrVNrub_DDB);
  END;

  // Курс валюты номинала, установленный ЦБ РФ на отчетную дату, в рублях
  PRIVATE MACRO NUNP_CrVNrub_DH():DOUBLE
    return double(m_RS.CrVNrub_DH);
  END;

  // Сумма комиссий по сделке <CodeB>
  PRIVATE MACRO NUNP_ComBRubSum():DOUBLE
    return double(m_RS.t_ComBRubSum);
  END;

  // Значение примечания "Прочие комиссии" по сделке
  PRIVATE MACRO NUNP_ComRub():DOUBLE
    return double(m_RS.t_ComRub);
  END;

  // Наименование контрагента
  PRIVATE MACRO NUNP_ContB_Name():STRING
    return m_RS.ContB_Name;
  END;

  // ДР "ВЗЛ" контрагента
  PRIVATE MACRO NUNP_ContB_VZL():STRING
    return m_RS.ContB_VZL;
  END;

  // Номер сделки (при приобретении ценных бумаг)
  PRIVATE MACRO NUNP_CodeB():STRING
    return m_RS.CodeB;
  END;

  // Количество ценных бумаг (всего приобретено по первой части обратного РЕПО), штук
  PRIVATE MACRO NUNP_QntyB_OR():DOUBLE
    return double(m_RS.QntyB_OR);
  END;

  // Количество ценных бумаг (всего продано по первой части прямого РЕПО), штук
  PRIVATE MACRO NUNP_QntyS_PR():DOUBLE
    return double(m_RS.QntyS_PR);
  END;

  // Балансовый остаток по счету по учету вложений (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_BalSumVN_DH():DOUBLE
    return double(m_RS.BalSumVN_DH);
  END;

  // НКД начисленный (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_NKDREPVN():DOUBLE
    return double(m_RS.NKDREPVN);
  END;

  // НКД начисленный (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_NKDREPRUB():DOUBLE
    return double(m_RS.NKDREPRUB3);
  END;

  // Процентные доходы от изменения номинальной стоимости (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_NKDREPCHGNUMRUB():DOUBLE
    return double(m_RS.NKDREPCHGNUMRUB);
  END;

  // Балансовый остаток по счету по учету НКД уплаченного (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_BalNkdBVN_DH():DOUBLE
    return double(m_RS.BalNkdBVN_DH);
  END;

  // Балансовый остаток по счету по учету вложений на отчетную дату, в рублях
  PRIVATE MACRO NUNP_BalSumRub_DH():DOUBLE
    return double(m_RS.BalSumRub_DH);
  END;

  // Балансовый остаток по счету по учету НКД уплаченного (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_BalNkdBrub_DH():DOUBLE
    return double(m_RS.BalNkdBrub_DH);
  END;

  // Балансовый остаток по счету по учету НКД начисленного (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_B3():DOUBLE
    return double(m_RS.B3);
  END;

  // Балансовый остаток по счету по учету дисконта начисленного (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_B4():DOUBLE
    return double(m_RS.B4);
  END;

  // Балансовый остаток по счету по учету премии начисленной (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_B5():DOUBLE
    return double(m_RS.B5);
  END;

  // Балансовый остаток по счету по учету НКД начисленного (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_B8():DOUBLE
    return double(m_RS.B8);
  END;

  // Балансовый остаток по счету по учету дисконта начисленного (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_B9():DOUBLE
    return double(m_RS.B9);
  END;

  // Балансовый остаток по счету по учету премии начисленной (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_B10():DOUBLE
    return double(m_RS.B10);
  END;

  // Балансовый остаток по счету по учету превышения СС над стоимостью приобретения (на отчетную дату), в рублях (50671, 50771)
  PRIVATE MACRO NUNP_B11():DOUBLE
    return double(m_RS.B11);
  END;

  // Балансовый остаток по счету по учету превышения стоимости приобретения над СС (на отчетную дату), в рублях (50670, 50770)
  PRIVATE MACRO NUNP_B12():DOUBLE
    return double(m_RS.B12);
  END;

  // Балансовый остаток по счету по учету положительной переоценки (на отчетную дату), в рублях (50121, 50221, 50621, 50721)
  PRIVATE MACRO NUNP_B13():DOUBLE
    return double(m_RS.B13);
  END;

  // Балансовый остаток по счету по учету отрицательной переоценки (на отчетную дату), в рублях (50120, 50220, 50620, 50720)
  PRIVATE MACRO NUNP_B14():DOUBLE
    return double(m_RS.B14);
  END;

  // Балансовый остаток по счету по учету положительной корректировки стоимости (на отчетную дату), в рублях (50140, 50264, 50428)
  PRIVATE MACRO NUNP_B15():DOUBLE
    return double(m_RS.B15);
  END;

  // Балансовый остаток по счету по учету отрицательной корректировки стоимости (на отчетную дату), в рублях (50141, 50265, 50429)
  PRIVATE MACRO NUNP_B16():DOUBLE
    return double(m_RS.B16);
  END;

  // Балансовый остаток по счету по учету резерва РВП (на отчетную дату), в рублях (50427, 50507, 50908, 50419, 50719, 60105)
  PRIVATE MACRO NUNP_B17():DOUBLE
    return double(m_RS.B17);
  END;

  // Балансовый остаток по счету по учету резерва РВП (на отчетную дату), в рублях (10630)
  PRIVATE MACRO NUNP_B17_1():DOUBLE
    return double(m_RS.B17_1);
  END;

  // Балансовый остаток по счету по учету корректировки (увеличение) резерва РВП (на отчетную дату), в рублях (50430, 50508, 50738)
  PRIVATE MACRO NUNP_B18():DOUBLE
    return double(m_RS.B18);
  END;

  // Балансовый остаток по счету по учету корректировки (увеличение) резерва РВП (на отчетную дату), в рублях (10634)
  PRIVATE MACRO NUNP_B18_1():DOUBLE
    return double(m_RS.B18_1);
  END;

  // Балансовый остаток по счету по учету корректировки (уменьшение) резерва РВП (на отчетную дату), в рублях (50431, 50509, 50739)
  PRIVATE MACRO NUNP_B19():DOUBLE
    return double(m_RS.B19);
  END;

  // Балансовый остаток по счету по учету корректировки (уменьшение) резерва РВП (на отчетную дату), в рублях (10635)
  PRIVATE MACRO NUNP_B19_1():DOUBLE
    return double(m_RS.B19_1);
  END;


  PRIVATE MACRO printNUNP_QntyB()
    return ВыводЧерезФормулу(NUNP_QntyB());
  END;

  PRIVATE MACRO printNUNP_QntyS()
    return ВыводЧерезФормулу(NUNP_QntyS());
  END;

  PRIVATE MACRO printNUNP_NomVN_DDB()
    return NUNP_NomVN_DDB();
  END;

  PRIVATE MACRO printNUNP_NomVN_DH()
    return NUNP_NomVN_DH();
  END;

  PRIVATE MACRO printNUNP_PrBnom()
      return NUNP_PrBnom();
  END;

  PRIVATE MACRO printNUNP_PrBVN()
      return ВыводЧерезФормулу(NUNP_PrBVN());
  END;

  PRIVATE MACRO printNUNP_NkdBVN_DDB()
      return ВыводЧерезФормулу(NUNP_NkdBVN_DDB());
  END;

  PRIVATE MACRO printNUNP_LastCoupDate()
      return NUNP_LastCoupDate();
  END;

  PRIVATE MACRO printNUNP_CrVNrub_DDB()
    return ВыводЧерезФормулу(NUNP_CrVNrub_DDB());
  END;

  PRIVATE MACRO printNUNP_CrVNrub_DH()
    return ВыводЧерезФормулу(NUNP_CrVNrub_DH());
  END;

  PRIVATE MACRO printNUNP_QntyB_OR()
    return ВыводЧерезФормулу(NUNP_QntyB_OR());
  END;

  PRIVATE MACRO printNUNP_QntyS_PR()
    return ВыводЧерезФормулу(NUNP_QntyS_PR());
  END;

  PRIVATE MACRO printNUNP_BalSumVN_DH()
    return ВыводЧерезФормулу(NUNP_BalSumVN_DH());
  END;

  PRIVATE MACRO printNUNP_BalNkdBVN_DH()
    return ВыводЧерезФормулу(NUNP_BalNkdBVN_DH());
  END;

  PRIVATE MACRO printNUNP_BalSumRub_DH()
    return ВыводЧерезФормулу(NUNP_BalSumRub_DH());
  END;

  PRIVATE MACRO printNUNP_BalNkdBrub_DH()
    return ВыводЧерезФормулу(NUNP_BalNkdBrub_DH());
  END;


  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_QntyB():STRING
    return (C_NUNP_QntyB+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_QntyS():STRING
    return (C_NUNP_QntyS+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_NomVN_DDB():STRING
    return (C_NUNP_NomVN_DDB+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_PrBnom():STRING
    return (C_NUNP_PrBnom+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  MACRO GetNUNP_QntyOst():STRING
    return (C_NUNP_QntyOst+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_PrBVN():STRING
    return (C_NUNP_PrBVN+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_NomVN_DH():STRING
    return (C_NUNP_NomVN_DH+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_LastCoupDate():STRING
    return (C_NUNP_LastCoupDate+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_DDB():STRING
    return (C_NUNP_DDB+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_NkdBVN_DDB():STRING
    return (C_NUNP_NkdBVN_DDB+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_SumBVN_DH():STRING
    return (C_NUNP_SumBVN_DH+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  MACRO GetNUNP_CrVNrub_DDB():STRING
    return (C_NUNP_CrVNrub_DDB+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_NkdBVN_DH():STRING
    return (C_NUNP_NkdBVN_DH+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_CrVNrub_DH():STRING
    return (C_NUNP_CrVNrub_DH+string(m_CurrStrNum));
  END;
  /*получить адрес ячейки*/
  PRIVATE MACRO GetNUNP_BalSumVN_DH():STRING
    return (C_NUNP_BalSumVN_DH+string(m_CurrStrNum));
  END;
  PRIVATE MACRO GetNUNP_BalSumRub_DH():STRING
    return (C_NUNP_BalSumRub_DH+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_BalNkdBrub_DH():STRING
    return (C_NUNP_BalNkdBrub_DH+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B8():STRING
    return (C_NUNP_B8+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B9():STRING
    return (C_NUNP_B9+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B10():STRING
    return (C_NUNP_B10+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B13():STRING
    return (C_NUNP_B13+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B14():STRING
    return (C_NUNP_B14+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B15():STRING
    return (C_NUNP_B15+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B16():STRING
    return (C_NUNP_B16+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B17():STRING
    return (C_NUNP_B17+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B18():STRING
    return (C_NUNP_B18+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B18_1():STRING
    return (C_NUNP_B18_1+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B19():STRING
    return (C_NUNP_B19+m_CurrStrNum);
  END;
  PRIVATE MACRO GetNUNP_B19_1():STRING
    return (C_NUNP_B19_1+m_CurrStrNum);
  END;


  // Количество ценных бумаг, стоимость которых не списана на расходы в налоговом учете
  PRIVATE MACRO NUNP_QntyOst_F()
    return F(GetNUNP_QntyB()+"-"+GetNUNP_QntyS());
  END;

  // Стоимость приобретения ценных бумаг (без НКД) на дату ППС, в валюте номинала
  PRIVATE MACRO NUNP_SumBVN_DDB_F()
    if( NUNP_IsBond() )
      return F(GetNUNP_QntyB()+"*"+GetNUNP_NomVN_DDB()+"*"+GetNUNP_PrBnom()+"/100");
    else
      return F(GetNUNP_QntyB()+"*"+GetNUNP_PrBVN());
    end;
  END;

  // Стоимость приобретения ценных бумаг (без НКД) (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_SumBVN_DH_F()
    if( NUNP_IsBond() )
      return F(GetNUNP_QntyOst()+"*"+ GetNUNP_NomVN_DH()+"*"+GetNUNP_PrBnom()+"/100");
    else
      return F(GetNUNP_QntyOst()+"*"+GetNUNP_PrBVN());
    end;
  END;

  // НКД уплаченный при приобретении облигаций (на отчетную дату), в валюте номинала
  PRIVATE MACRO NUNP_NkdBVN_DH_F()
    if( NUNP_IsBond() )
      return SetIFFormulaShort( GetNUNP_LastCoupDate()+"<"+GetNUNP_DDB(), GetNUNP_NkdBVN_DDB()+"/"+GetNUNP_QntyB()+"*"+GetNUNP_QntyOst(), "0", "" );
    else
      return "0";
    end;
  END;

  // Стоимость приобретения ценных бумаг (без НКД) (на дату ППС), в рублях
  PRIVATE MACRO NUNP_SumBrub_DDB_F()
    return F( GetNUNP_SumBVN_DH()+"*"+GetNUNP_CrVNrub_DDB() );
  END;

  // НКД уплаченный при приобретении облигаций (на дату ППС), в рублях
  PRIVATE MACRO NUNP_NkdBrub_DDB_F()
    return F( GetNUNP_NkdBVN_DH()+"*"+GetNUNP_CrVNrub_DDB() );
  END;

  // Стоимость приобретения ценных бумаг (без НКД) (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_SumBrub_DH_F()
    return F( GetNUNP_SumBVN_DH()+"*"+GetNUNP_CrVNrub_DH() );
  END;

  // НКД уплаченный при приобретении облигаций (на отчетную дату), в рублях
  PRIVATE MACRO NUNP_NkdBrub_DH_F()
    return F( GetNUNP_NkdBVN_DH()+"*"+GetNUNP_CrVNrub_DH() );
  END;

  // Уплаченные комиссии и прочие расходы "будущие"
  PRIVATE MACRO NUNP_ComBRub_F()
    return F( NUNP_ComBRubSum()+"*"+GetNUNP_QntyOst()+"/"+GetNUNP_QntyB()+"+"+NUNP_ComRub() );
  END;


  // ИТОГО Балансовая стоимость ценных бумаг (на отчетную дату), в рублях
  // (Б6 + Б7 + Б8 + Б9 + Б10 + Б13 + Б15 + Б18 + Б18.1) - (Б14 + Б16 + Б17 + Б19+ Б19.1)
  PRIVATE MACRO NUNP_B20_F()
    return F( "("+GetNUNP_BalSumRub_DH()+"+"+GetNUNP_BalNkdBrub_DH()+"+"+GetNUNP_B8()+"+"+GetNUNP_B9()+"+"+GetNUNP_B10()+"+"+GetNUNP_B13()+"+"+GetNUNP_B15()+"+"+GetNUNP_B18()+"+"+GetNUNP_B18_1()+")"+
              "-("+GetNUNP_B14()+"+"+GetNUNP_B16()+"+"+GetNUNP_B17()+"+"+GetNUNP_B19()+"+"+GetNUNP_B19_1()+")" );
  END;

  // Доходы(+) / Расходы(-) в виде разницы стоимостей списания "будущие"
  // Графа Б6 + Графа Б7 + Графа Б9 + Графа Б10 - (Графа Н16 + Графа Н17) * Графа Н19
  PRIVATE MACRO NUNP_VR1_F()
    return F( GetNUNP_BalSumRub_DH()+"+"+GetNUNP_B9()+"+"+GetNUNP_B10()+
              "-"+GetNUNP_SumBVN_DH()+"*"+GetNUNP_CrVNrub_DH() );
  END;

  // Доходы(+) / Расходы(-) в виде валютной переоценки "будущие"
  // (Графа Н16 + Графа Н17) * (Графа Н19 - Графа Н18)
  PRIVATE MACRO NUNP_VR2_F()
    return F( "("+GetNUNP_SumBVN_DH()+"+"+GetNUNP_NkdBVN_DH()+")*("+GetNUNP_CrVNrub_DH()+"-"+GetNUNP_CrVNrub_DDB()+")" );
  END;


  PRIVATE MACRO PrintTableStr_NUNP()
    SetCurrentStrNumber();

    PrintTableLine(
          /*O1   */  "N1_O1",                 NUNP_O1(),                  null,
          /*O2   */  "N1_SecName",            NUNP_SecName(),             null,
          /*O3   */  "N1_ISIN",               NUNP_ISIN(),                null,
          /*O4   */  "N1_NumReg",             NUNP_NumReg(),              null,
          /*O5   */  "N1_Code",               NUNP_Code(),                null,
          /*Н1   */  "N1_DR",                 NUNP_DR(),                  null,
          /*Н2   */  "N1_DDB",                NUNP_DDB(),                 null,
          /*Н3   */  "N1_QntyB",              printNUNP_QntyB(),          null,
          /*Н4   */  "N1_QntyS",              printNUNP_QntyS(),          null,
          /*Н5   */  "N1_QntyOst",            NUNP_QntyOst_F(),           null,
          /*Н6   */  "N1_QntyB_OR",           "x",                        null,
          /*Н7   */  "N1_QntyS_PR",           "x",                        null,
          /*Н8   */  "N1_VN",                 NUNP_VN(),                  null,
          /*Н9   */  "N1_NomVN_DDB",          printNUNP_NomVN_DDB(),      null,
          /*Н10  */  "N1_NomVN_DH",           printNUNP_NomVN_DH(),       null,
          /*Н11  */  "N1_PrBnom",             printNUNP_PrBnom(),         null,
          /*Н12  */  "N1_PrBVN",              printNUNP_PrBVN(),          null,
          /*Н13  */  "N1_SumBVN_DDB",         NUNP_SumBVN_DDB_F(),        null,
          /*Н14  */  "N1_NkdBVN_DDB",         printNUNP_NkdBVN_DDB(),     null,
          /*Н15  */  "N1_LastCoupDate",       printNUNP_LastCoupDate(),   null,
          /*Н16  */  "N1_SumBVN_DH",          NUNP_SumBVN_DH_F(),         null,
          /*Н17  */  "N1_NkdBVN_DH",          NUNP_NkdBVN_DH_F(),         null,
          /*Н18  */  "N1_CrVNrub_DDB",        printNUNP_CrVNrub_DDB(),    null,
          /*Н19  */  "N1_CrVNrub_DH",         printNUNP_CrVNrub_DH(),     null,
          /*Н20  */  "N1_SumBrub_DDB",        NUNP_SumBrub_DDB_F(),       null,
          /*Н21  */  "N1_NkdBrub_DDB",        NUNP_NkdBrub_DDB_F(),       null,
          /*Н22  */  "N1_SumBrub_DH",         NUNP_SumBrub_DH_F(),        null,
          /*Н23  */  "N1_NkdBrub_DH",         NUNP_NkdBrub_DH_F(),        null,
          /*Н24  */  "N1_NkdRepVN",           "",                         null,
          /*Н25  */  "N1_NkdRepRub3",         "",                         null,
          /*Н26  */  "N1_NkdRepChgNumRub",    "",                         null,
          /*Б1   */  "N1_BalSumVN_DH",        "",                         null,
          /*Б2   */  "N1_BalNkdBVN_DH",       "",                         null,
          /*Б3   */  "N1_B3",                 "",                         null,
          /*Б4   */  "N1_B4",                 "",                         null,
          /*Б5   */  "N1_B5",                 "",                         null,
          /*Б6   */  "N1_BalSumRub_DH",       "",                         null,
          /*Б7   */  "N1_BalNkdBrub_DH",      "",                         null,
          /*Б8   */  "N1_B8",                 "",                         null,
          /*Б9   */  "N1_B9",                 "",                         null,
          /*Б10  */  "N1_B10",                "",                         null,
          /*Б11  */  "N1_B11",                "",                         null,
          /*Б12  */  "N1_B12",                "",                         null,
          /*Б13  */  "N1_B13",                "",                         null,
          /*Б14  */  "N1_B14",                "",                         null,
          /*Б15  */  "N1_B15",                "",                         null,
          /*Б16  */  "N1_B16",                "",                         null,
          /*Б17  */  "N1_B17",                "",                         null,
          /*Б17.1*/  "N1_B17_1",              "",                         null,
          /*Б18  */  "N1_B18",                "",                         null,
          /*Б18.1*/  "N1_B18_1",              "",                         null,
          /*Б19  */  "N1_B19",                "",                         null,
          /*Б19.1*/  "N1_B19_1",              "",                         null,
          /*Б20  */  "N1_B20",                "",                         null,
          /*ВР1  */  "N1_VR1",                "",                         null,
          /*ВР2  */  "N1_VR2",                NUNP_VR2_F(),               null,
          /*ВР3  */  "N1_ComBRub",            NUNP_ComBRub_F(),           null,
          /*П1   */  "N1_ContB_Name",         NUNP_ContB_Name(),          null,
          /*П2   */  "N1_ContB_VZL",          NUNP_ContB_VZL(),           null,
          /*П3   */  "N1_CodeB",              NUNP_CodeB(),               null,
          /*O6   */  "N1_SecCode",            NUNP_SecCode(),             null
                  );

    //SetCellFont( C_NUNP_QntyB_OR+m_CurrStrNum, 10, false, false, null, null, LIGHTBROWNCOLOR );
    //SetCellFont( C_NUNP_QntyS_PR+m_CurrStrNum, 10, false, false, null, null, LIGHTBROWNCOLOR );

    m_PortfRowsSum.SetRangeSum(int(NUNP_O1()), m_CurrStrNum);
  END;

  // Печать промежуточных итогов
  PRIVATE MACRO PrintSubTotal_NUNP()
    SetCurrentStrNumber();

    var v_StrNumBeg, v_StrNumEnd;

    m_IssuePortfRowsSum.GetRangeSum(@v_StrNumBeg, @v_StrNumEnd);

    if( m_RepParams.Print_NUSVOD )
      m_FIStr.AddFI(NUNP_FIID(), m_CurrStrNum); // номера итоговых строк по выпуску для отчета Свод
    end;

    if (not IsPoi())
      SetCurrentLineFont( 10, false, false, null, null, GREYCOLOR );
    end;

    PrintTableLine(
    /*O1   */  "N1_O1",                 "Итого по выпуску",         null,
    /*O2   */  "N1_SecName",            NUNP_SecName(),             null,
    /*O3   */  "N1_ISIN",               NUNP_ISIN(),                null,
    /*O4   */  "N1_NumReg",             NUNP_NumReg(),              null,
    /*O5   */  "N1_Code",               NUNP_Code(),                null,
    /*H1   */  "N1_DR",                 "x",                        null,
    /*H2   */  "N1_DDB",                "x",                        null,
    /*H3   */  "N1_QntyB",              F(FormulaSUM()+"("+C_NUNP_QntyB+v_StrNumBeg+":"+C_NUNP_QntyB+v_StrNumEnd+")"),  null,
    /*H4   */  "N1_QntyS",              F(FormulaSUM()+"("+C_NUNP_QntyS+v_StrNumBeg+":"+C_NUNP_QntyS+v_StrNumEnd+")"),  null,
    /*H5   */  "N1_QntyOst",            F(FormulaSUM()+"("+C_NUNP_QntyOst+v_StrNumBeg+":"+C_NUNP_QntyOst+v_StrNumEnd+")"),  null,
    /*H6   */  "N1_QntyB_OR",           printNUNP_QntyB_OR(),       null,
    /*H7   */  "N1_QntyS_PR",           printNUNP_QntyS_PR(),       null,
    /*H8   */  "N1_VN",                 "x",                        null,
    /*H9   */  "N1_NomVN_DDB",          "x",                        null,
    /*H10  */  "N1_NomVN_DH",           "x",                        null,
    /*H11  */  "N1_PrBnom",             "x",                        null,
    /*H12  */  "N1_PrBVN",              "x",                        null,
    /*H13  */  "N1_SumBVN_DDB",         "x",                        null,
    /*H14  */  "N1_NkdBVN_DDB",         "x",                        null,
    /*H15  */  "N1_LastCoupDate",       "x",                        null,
    /*H16   */  "N1_SumBVN_DH",         F(FormulaSUM()+"("+C_NUNP_SumBVN_DH+v_StrNumBeg+":"+C_NUNP_SumBVN_DH+v_StrNumEnd+")"),  null,
    /*H17   */  "N1_NkdBVN_DH",         F(FormulaSUM()+"("+C_NUNP_NkdBVN_DH+v_StrNumBeg+":"+C_NUNP_NkdBVN_DH+v_StrNumEnd+")"),  null,
    /*H18  */  "N1_CrVNrub_DDB",        "x",                        null,
    /*H19  */  "N1_CrVNrub_DH",         printNUNP_CrVNrub_DH(),     null,
    /*H20   */  "N1_SumBrub_DDB",       F(FormulaSUM()+"("+C_NUNP_SumBrub_DDB+v_StrNumBeg+":"+C_NUNP_SumBrub_DDB+v_StrNumEnd+")"),  null,
    /*H21   */  "N1_NkdBrub_DDB",       F(FormulaSUM()+"("+C_NUNP_NkdBrub_DDB+v_StrNumBeg+":"+C_NUNP_NkdBrub_DDB+v_StrNumEnd+")"),  null,
    /*H22   */  "N1_SumBrub_DH",        F(FormulaSUM()+"("+C_NUNP_SumBrub_DH+v_StrNumBeg+":"+C_NUNP_SumBrub_DH+v_StrNumEnd+")"),  null,
    /*H23   */  "N1_NkdBrub_DH",        F(FormulaSUM()+"("+C_NUNP_NkdBrub_DH+v_StrNumBeg+":"+C_NUNP_NkdBrub_DH+v_StrNumEnd+")"),  null,
    /*Н24  */  "N1_NkdRepVN",           NUNP_NKDREPVN(),            null,
    /*Н25  */  "N1_NkdRepRub3",         NUNP_NKDREPRUB(),           null,
    /*Н26  */  "N1_NkdRepChgNumRub",    NUNP_NKDREPCHGNUMRUB(),     null,
    /*Б1    */  "N1_BalSumVN_DH",       F(FormulaSUM()+"("+C_NUNP_BalSumVN_DH+v_StrNumBeg+":"+C_NUNP_BalSumVN_DH+v_StrNumEnd+")"),  null,
    /*Б2    */  "N1_BalNkdBVN_DH",      F(FormulaSUM()+"("+C_NUNP_BalNkdBVN_DH+v_StrNumBeg+":"+C_NUNP_BalNkdBVN_DH+v_StrNumEnd+")"),  null,
    /*Б3    */  "N1_B3",                F(FormulaSUM()+"("+C_NUNP_B3+v_StrNumBeg+":"+C_NUNP_B3+v_StrNumEnd+")"),  null,
    /*Б4    */  "N1_B4",                F(FormulaSUM()+"("+C_NUNP_B4+v_StrNumBeg+":"+C_NUNP_B4+v_StrNumEnd+")"),  null,
    /*Б5    */  "N1_B5",                F(FormulaSUM()+"("+C_NUNP_B5+v_StrNumBeg+":"+C_NUNP_B5+v_StrNumEnd+")"),  null,
    /*Б6    */  "N1_BalSumRub_DH",      F(FormulaSUM()+"("+C_NUNP_BalSumRub_DH+v_StrNumBeg+":"+C_NUNP_BalSumRub_DH+v_StrNumEnd+")"),  null,
    /*Б7    */  "N1_BalNkdBrub_DH",     F(FormulaSUM()+"("+C_NUNP_BalNkdBrub_DH+v_StrNumBeg+":"+C_NUNP_BalNkdBrub_DH+v_StrNumEnd+")"),  null,
    /*Б8    */  "N1_B8",                F(FormulaSUM()+"("+C_NUNP_B8+v_StrNumBeg+":"+C_NUNP_B8+v_StrNumEnd+")"),  null,
    /*Б9    */  "N1_B9",                F(FormulaSUM()+"("+C_NUNP_B9+v_StrNumBeg+":"+C_NUNP_B9+v_StrNumEnd+")"),  null,
    /*Б10   */  "N1_B10",               F(FormulaSUM()+"("+C_NUNP_B10+v_StrNumBeg+":"+C_NUNP_B10+v_StrNumEnd+")"),  null,
    /*Б11   */  "N1_B11",               F(FormulaSUM()+"("+C_NUNP_B11+v_StrNumBeg+":"+C_NUNP_B11+v_StrNumEnd+")"),  null,
    /*Б12   */  "N1_B12",               F(FormulaSUM()+"("+C_NUNP_B12+v_StrNumBeg+":"+C_NUNP_B12+v_StrNumEnd+")"),  null,
    /*Б13   */  "N1_B13",               F(FormulaSUM()+"("+C_NUNP_B13+v_StrNumBeg+":"+C_NUNP_B13+v_StrNumEnd+")"),  null,
    /*Б14   */  "N1_B14",               F(FormulaSUM()+"("+C_NUNP_B14+v_StrNumBeg+":"+C_NUNP_B14+v_StrNumEnd+")"),  null,
    /*Б15   */  "N1_B15",               F(FormulaSUM()+"("+C_NUNP_B15+v_StrNumBeg+":"+C_NUNP_B15+v_StrNumEnd+")"),  null,
    /*Б16   */  "N1_B16",               F(FormulaSUM()+"("+C_NUNP_B16+v_StrNumBeg+":"+C_NUNP_B16+v_StrNumEnd+")"),  null,
    /*Б17   */  "N1_B17",               F(FormulaSUM()+"("+C_NUNP_B17+v_StrNumBeg+":"+C_NUNP_B17+v_StrNumEnd+")"),  null,
    /*Б17.1 */  "N1_B17_1",             F(FormulaSUM()+"("+C_NUNP_B17_1+v_StrNumBeg+":"+C_NUNP_B17_1+v_StrNumEnd+")"),  null,
    /*Б18   */  "N1_B18",               F(FormulaSUM()+"("+C_NUNP_B18+v_StrNumBeg+":"+C_NUNP_B18+v_StrNumEnd+")"),  null,
    /*Б18.1 */  "N1_B18_1",             F(FormulaSUM()+"("+C_NUNP_B18_1+v_StrNumBeg+":"+C_NUNP_B18_1+v_StrNumEnd+")"),  null,
    /*Б19   */  "N1_B19",               F(FormulaSUM()+"("+C_NUNP_B19+v_StrNumBeg+":"+C_NUNP_B19+v_StrNumEnd+")"),  null,
    /*Б19.1 */  "N1_B19_1",             F(FormulaSUM()+"("+C_NUNP_B19_1+v_StrNumBeg+":"+C_NUNP_B19_1+v_StrNumEnd+")"),  null,
    /*Б20   */  "N1_B20",               F(FormulaSUM()+"("+C_NUNP_B20+v_StrNumBeg+":"+C_NUNP_B20+v_StrNumEnd+")"),  null,
    /*ВР1   */  "N1_VR1",               F(FormulaSUM()+"("+C_NUNP_VR1+v_StrNumBeg+":"+C_NUNP_VR1+v_StrNumEnd+")"),  null,
    /*ВР2   */  "N1_VR2",               F(FormulaSUM()+"("+C_NUNP_VR2+v_StrNumBeg+":"+C_NUNP_VR2+v_StrNumEnd+")"),  null,
    /*ВР3   */  "N1_ComBRub",           F(FormulaSUM()+"("+C_NUNP_ComBRub+v_StrNumBeg+":"+C_NUNP_ComBRub+v_StrNumEnd+")"),  null,
    /*П1   */  "N1_ContB_Name",         "x",                        null,
    /*П2   */  "N1_ContB_VZL",          "x",                        null,
    /*П3   */  "N1_CodeB",              "x",                        null,
    /*O6   */  "N1_SecCode",            NUNP_SecCode(),             null
                  );

    if (not IsPoi())
      SetCurrentLineFont( 10, false, false, null, null, DefaultBkGrColor );
    else
      SetRowColor(GetCurrentStrNumber() + 1, 58, POIGREYCOLOR);
    end;

    m_PortfRowsSum = CPortfRowsSum();
    m_IssuePortfRowsSum = CIssuePortfRowsSum();
  END;

  // Печать промежуточных итогов по портфелям внутри выпусков
  PRIVATE MACRO PrintSubTotalPortf_NUNP()
    SetCurrentStrNumber();

    var NumSubTotalPortfStr = НомерТекущейСтроки(),
        v_StrNumBeg, v_StrNumEnd;

    m_PortfRowsSum.GetRangeSum(int(NUNP_O1()), @v_StrNumBeg, @v_StrNumEnd);
    m_IssuePortfRowsSum.SetRangeSum(m_CurrStrNum);

    if (not IsPoi())
      SetCurrentLineFont( 10, false, false, null, null, LIGHTGREYCOLOR );
    end;

    PrintTableLine(
    /*O1   */  "N1_O1",                 "Итого по "+NUNP_O1(),      null,
    /*O2   */  "N1_SecName",            NUNP_SecName(),             null,
    /*O3   */  "N1_ISIN",               NUNP_ISIN(),                null,
    /*O4   */  "N1_NumReg",             NUNP_NumReg(),              null,
    /*O5   */  "N1_Code",               NUNP_Code(),                null,
    /*H1   */  "N1_DR",                 "x",                        null,
    /*H2   */  "N1_DDB",                "x",                        null,
    /*H3   */  "N1_QntyB",              F(FormulaSUM()+"("+C_NUNP_QntyB+v_StrNumBeg+":"+C_NUNP_QntyB+v_StrNumEnd+")"),  null,
    /*H4   */  "N1_QntyS",              F(FormulaSUM()+"("+C_NUNP_QntyS+v_StrNumBeg+":"+C_NUNP_QntyS+v_StrNumEnd+")"),  null,
    /*H5   */  "N1_QntyOst",            F(FormulaSUM()+"("+C_NUNP_QntyOst+v_StrNumBeg+":"+C_NUNP_QntyOst+v_StrNumEnd+")"),  null,
    /*Н6   */  "N1_QntyB_OR",           "x",                        null,
    /*Н7   */  "N1_QntyS_PR",           "x",                        null,
    /*H8   */  "N1_VN",                 "x",                        null,
    /*H9   */  "N1_NomVN_DDB",          "x",                        null,
    /*H10  */  "N1_NomVN_DH",           "x",                        null,
    /*H11  */  "N1_PrBnom",             "x",                        null,
    /*H12  */  "N1_PrBVN",              "x",                        null,
    /*H13  */  "N1_SumBVN_DDB",         "x",                        null,
    /*H14  */  "N1_NkdBVN_DDB",         "x",                        null,
    /*H15  */  "N1_LastCoupDate",       "x",                        null,
    /*H16  */  "N1_SumBVN_DH",          F(FormulaSUM()+"("+C_NUNP_SumBVN_DH+v_StrNumBeg+":"+C_NUNP_SumBVN_DH+v_StrNumEnd+")"),  null,
    /*H17  */  "N1_NkdBVN_DH",          F(FormulaSUM()+"("+C_NUNP_NkdBVN_DH+v_StrNumBeg+":"+C_NUNP_NkdBVN_DH+v_StrNumEnd+")"),  null,
    /*H18  */  "N1_CrVNrub_DDB",        "x",                        null,
    /*H19  */  "N1_CrVNrub_DH",         printNUNP_CrVNrub_DH(),     null,
    /*H20  */  "N1_SumBrub_DDB",        F(FormulaSUM()+"("+C_NUNP_SumBrub_DDB+v_StrNumBeg+":"+C_NUNP_SumBrub_DDB+v_StrNumEnd+")"),  null,
    /*H21  */  "N1_NkdBrub_DDB",        F(FormulaSUM()+"("+C_NUNP_NkdBrub_DDB+v_StrNumBeg+":"+C_NUNP_NkdBrub_DDB+v_StrNumEnd+")"),  null,
    /*H22  */  "N1_SumBrub_DH",         F(FormulaSUM()+"("+C_NUNP_SumBrub_DH+v_StrNumBeg+":"+C_NUNP_SumBrub_DH+v_StrNumEnd+")"),  null,
    /*H23  */  "N1_NkdBrub_DH",         F(FormulaSUM()+"("+C_NUNP_NkdBrub_DH+v_StrNumBeg+":"+C_NUNP_NkdBrub_DH+v_StrNumEnd+")"),  null,
    /*Н24  */  "N1_NkdRepVN",           "",                         null,
    /*Н25  */  "N1_NkdRepRub3",         "",                         null,
    /*Н26  */  "N1_NkdRepChgNumRub",    "",                         null,
    /*Б1   */  "N1_BalSumVN_DH",        printNUNP_BalSumVN_DH(),    null,
    /*Б2   */  "N1_BalNkdBVN_DH",       printNUNP_BalNkdBVN_DH(),   null,
    /*Б3   */  "N1_B3",                 NUNP_B3(),                  null,
    /*Б4   */  "N1_B4",                 NUNP_B4(),                  null,
    /*Б5   */  "N1_B5",                 NUNP_B5(),                  null,
    /*Б6   */  "N1_BalSumRub_DH",       printNUNP_BalSumRub_DH(),   null,
    /*Б7   */  "N1_BalNkdBrub_DH",      printNUNP_BalNkdBrub_DH(),  null,
    /*Б8   */  "N1_B8",                 NUNP_B8(),                  null,
    /*Б9   */  "N1_B9",                 NUNP_B9(),                  null,
    /*Б10  */  "N1_B10",                NUNP_B10(),                 null,
    /*Б11  */  "N1_B11",                NUNP_B11(),                 null,
    /*Б12  */  "N1_B12",                NUNP_B12(),                 null,
    /*Б13  */  "N1_B13",                NUNP_B13(),                 null,
    /*Б14  */  "N1_B14",                NUNP_B14(),                 null,
    /*Б15  */  "N1_B15",                NUNP_B15(),                 null,
    /*Б16  */  "N1_B16",                NUNP_B16(),                 null,
    /*Б17  */  "N1_B17",                NUNP_B17(),                 null,
    /*Б17.1*/  "N1_B17_1",              NUNP_B17_1(),               null,
    /*Б18  */  "N1_B18",                NUNP_B18(),                 null,
    /*Б18.1*/  "N1_B18_1",              NUNP_B18_1(),               null,
    /*Б19  */  "N1_B19",                NUNP_B19(),                 null,
    /*Б19.1*/  "N1_B19_1",              NUNP_B19_1(),               null,
    /*Б20  */  "N1_B20",                NUNP_B20_F(),               null,
    /*ВР1  */  "N1_VR1",                NUNP_VR1_F(),               null,
    /*ВР2  */  "N1_VR2",                F(FormulaSUM()+"("+C_NUNP_VR2+v_StrNumBeg+":"+C_NUNP_VR2+v_StrNumEnd+")"),  null,
    /*ВР3  */  "N1_ComBRub",            F(FormulaSUM()+"("+C_NUNP_ComBRub+v_StrNumBeg+":"+C_NUNP_ComBRub+v_StrNumEnd+")"),  null,
    /*П1   */  "N1_ContB_Name",         "x",                        null,
    /*П2   */  "N1_ContB_VZL",          "x",                        null,
    /*П3   */  "N1_CodeB",              "x",                        null,
    /*O6   */  "N1_SecCode",            NUNP_SecCode(),             null
                  );

    if (not IsPoi())
      SetCurrentLineFont( 10, false, false, null, null, DefaultBkGrColor );
    else
      SetRowColor(GetCurrentStrNumber() + 1, 58, POILIGHTGREYCOLOR);
    end;
  END;

  // Печать итогов
  PRIVATE MACRO PrintTotal_NUNP()
    var cmd = RSDCommand("SELECT NVL(SUM(t_QntyB), 0) t_QntyB, " +
                               " NVL(SUM(t_QntyS), 0) t_QntyS, " +
                               " NVL(SUM(t_QntyOst), 0) t_QntyOst, " +
                               " NVL(SUM(t_QntyB_OR), 0) t_QntyB_OR, " +
                               " NVL(SUM(t_QntyS_PR), 0) t_QntyS_PR, " +
                               " NVL(SUM(t_SumBrub_DDB), 0) t_SumBrub_DDB, " +
                               " NVL(SUM(t_NkdBrub_DDB), 0) t_NkdBrub_DDB, " +
                               " NVL(SUM(t_SumBrub_DH), 0) t_SumBrub_DH, " +
                               " NVL(SUM(t_NkdBrub_DH), 0) t_NkdBrub_DH, " +
                               " NVL(SUM(t_BalSumRub_DH), 0) t_BalSumRub_DH, " +
                               " NVL(SUM(t_BalNkdBrub_DH), 0) t_BalNkdBrub_DH, " +
                               " NVL(SUM(T_NKDREPRUB3), 0) T_NKDREPRUB3,"
                               " NVL(SUM(T_NKDREPCHGNUMRUB), 0) T_NKDREPCHGNUMRUB,"
                               " NVL(SUM(T_NKDREPVN), 0) T_NKDREPVN,"
                               " NVL(SUM(t_B8), 0) t_B8, " +
                               " NVL(SUM(t_B9), 0) t_B9, " +
                               " NVL(SUM(t_B10), 0) t_B10, " +
                               " NVL(SUM(t_B11), 0) t_B11, " +
                               " NVL(SUM(t_B12), 0) t_B12, " +
                               " NVL(SUM(t_B13), 0) t_B13, " +
                               " NVL(SUM(t_B14), 0) t_B14, " +
                               " NVL(SUM(t_B15), 0) t_B15, " +
                               " NVL(SUM(t_B16), 0) t_B16, " +
                               " NVL(SUM(t_B17), 0) t_B17, " +
                               " NVL(SUM(t_B17_1), 0) t_B17_1, " +
                               " NVL(SUM(t_B18), 0) t_B18, " +
                               " NVL(SUM(t_B18_1), 0) t_B18_1, " +
                               " NVL(SUM(t_B19), 0) t_B19, " +
                               " NVL(SUM(t_B19_1), 0) t_B19_1, " +
                               " NVL(SUM(t_B20), 0) t_B20, " +
                               " NVL(SUM(t_VR1), 0) t_VR1, " +
                               " NVL(SUM(t_VR2), 0) t_VR2, " +
                               " NVL(SUM(t_ComBRub), 0) t_ComBRub " +
                          " FROM DNUNPREP_TMP " +
                         " WHERE t_IsItog = CHR(88) ");

    var ds = TRsbDataSet(cmd);
    if(ds.MoveNext())
      SetCell(C_NUNP_QntyB + НомерСтрокиИтогов, ds.QntyB);
      SetCell(C_NUNP_QntyS + НомерСтрокиИтогов, ds.QntyS);
      SetCell(C_NUNP_QntyOst + НомерСтрокиИтогов, ds.QntyOst);
      SetCell(C_NUNP_QntyB_OR + НомерСтрокиИтогов, ds.QntyB_OR);
      SetCell(C_NUNP_QntyS_PR + НомерСтрокиИтогов, ds.QntyS_PR);
      SetCell(C_NUNP_SumBrub_DDB + НомерСтрокиИтогов, ds.SumBrub_DDB);
      SetCell(C_NUNP_NkdBrub_DDB + НомерСтрокиИтогов, ds.NkdBrub_DDB);
      SetCell(C_NUNP_SumBrub_DH + НомерСтрокиИтогов, ds.SumBrub_DH);
      SetCell(C_NUNP_NkdRepVN + НомерСтрокиИтогов, ds.NKDREPVN);
      SetCell(C_NUNP_NkdRepRub3 + НомерСтрокиИтогов, ds.NKDREPRUB3);
      SetCell(C_NUNP_NkdRepChgNumRub + НомерСтрокиИтогов, ds.NKDREPCHGNUMRUB);
      SetCell(C_NUNP_NkdBrub_DH + НомерСтрокиИтогов, ds.NkdBrub_DH);
      SetCell(C_NUNP_BalSumRub_DH + НомерСтрокиИтогов, ds.BalSumRub_DH);
      SetCell(C_NUNP_BalNkdBrub_DH + НомерСтрокиИтогов, ds.BalNkdBrub_DH);
      SetCell(C_NUNP_B8 + НомерСтрокиИтогов, ds.B8);
      SetCell(C_NUNP_B9 + НомерСтрокиИтогов, ds.B9);
      SetCell(C_NUNP_B10 + НомерСтрокиИтогов, ds.B10);
      SetCell(C_NUNP_B11 + НомерСтрокиИтогов, ds.B11);
      SetCell(C_NUNP_B12 + НомерСтрокиИтогов, ds.B12);
      SetCell(C_NUNP_B13 + НомерСтрокиИтогов, ds.B13);
      SetCell(C_NUNP_B14 + НомерСтрокиИтогов, ds.B14);
      SetCell(C_NUNP_B15 + НомерСтрокиИтогов, ds.B15);
      SetCell(C_NUNP_B16 + НомерСтрокиИтогов, ds.B16);
      SetCell(C_NUNP_B17 + НомерСтрокиИтогов, ds.B17);
      SetCell(C_NUNP_B17_1 + НомерСтрокиИтогов, ds.B17_1);
      SetCell(C_NUNP_B18 + НомерСтрокиИтогов, ds.B18);
      SetCell(C_NUNP_B18_1 + НомерСтрокиИтогов, ds.B18_1);
      SetCell(C_NUNP_B19 + НомерСтрокиИтогов, ds.B19);
      SetCell(C_NUNP_B19_1 + НомерСтрокиИтогов, ds.B19_1);
      SetCell(C_NUNP_B20 + НомерСтрокиИтогов, ds.B20);
      SetCell(C_NUNP_VR1 + НомерСтрокиИтогов, ds.VR1);
      SetCell(C_NUNP_VR2 + НомерСтрокиИтогов, ds.VR2);
      SetCell(C_NUNP_ComBRub + НомерСтрокиИтогов, ds.ComBRub);
    end;

  END;

  // печать данных отчета НУНП
  PRIVATE MACRO Print_NUNP()
    var header = "", NRecs = 0, Current = 0, cmd;

    cmd = DL_RSDCommand(" SELECT * FROM DNUNPREP_TMP ORDER BY T_SECNAME, T_FIID, T_ISITOG, T_ISITOGPORTF, T_O1, T_DDB, T_DR ");
    NRecs = cmd.GetCount();

    if( NRecs > 0 )
      SetIsDataExist_NUNP(true);
      header = "Печать строк отчета НУНП";
      m_ProgressIndicator.Start(NRecs, header, header);

      m_RS = cmd.execute();
      while( m_RS.MoveNext() )
        if( NUNP_ISITOG() )
          // печать промежуточных итогов по выпускам
          PrintSubTotal_NUNP();
        elif( NUNP_IsItogPortf() )
          // печать итогов по портфелям внутри выпусков
          PrintSubTotalPortf_NUNP();
        else
          // печать данных
          PrintTableStr_NUNP();
        end;
        Current = Current + 1;
        m_ProgressIndicator.Update(Current,NRecs);
      end;
      // печать итогов
      PrintTotal_NUNP();
      m_ProgressIndicator.Stop();
    end;
  END;

  PRIVATE MACRO LoadDataInTMP_NUNP()
    var cmd, header = "Отбор данных для отчета НУНП";
    m_ProgressIndicator.Start(1, header, header);

    cmd = RSDCommand("CALL RSB_NUREP.CreateNUNPData(?,?,?,?)");

    cmd.addParam( "", RSDBP_IN, m_RepParams.BegDate );
    cmd.addParam( "", RSDBP_IN, m_RepParams.EndDate );
    cmd.addParam( "", RSDBP_IN, SessionID() );
    if( m_IsWebService )
      cmd.addParam( "", RSDBP_IN, m_ProgressIndicator.GetReqID() );
    else
      cmd.addParam( "", RSDBP_IN, "" );
    end;
    cmd.execute();

    m_ProgressIndicator.Update(1,1,header);
    m_ProgressIndicator.Stop();
  END;


  PRIVATE MACRO BeginReport_NUNP()
    SetActiveSheet( SHEET_NUNP );

    PrintHeader_NUNP();

    RegisterTable( "N1_MainTable",        "",
                   "N1_O1",               "N1_SecName",        "N1_ISIN",            "N1_NumReg",         "N1_Code",           "N1_DR",
                   "N1_DDB",              "N1_QntyB",          "N1_QntyS",           "N1_QntyOst",        "N1_QntyB_OR",       "N1_QntyS_PR",
                   "N1_VN",               "N1_NomVN_DDB",      "N1_NomVN_DH",        "N1_PrBnom",         "N1_PrBVN",          "N1_SumBVN_DDB",
                   "N1_NkdBVN_DDB",       "N1_LastCoupDate",   "N1_SumBVN_DH",       "N1_NkdBVN_DH",      "N1_CrVNrub_DDB",    "N1_CrVNrub_DH",
                   "N1_SumBrub_DDB",      "N1_NkdBrub_DDB",    "N1_SumBrub_DH",      "N1_NkdBrub_DH",     "N1_BalSumVN_DH",    "N1_BalNkdBVN_DH",
                   "N1_B3",               "N1_B4",             "N1_B5",              "N1_BalSumRub_DH",   "N1_BalNkdBrub_DH",  "N1_B8",
                   "N1_B9",               "N1_B10",            "N1_B11",             "N1_B12",            "N1_B13",            "N1_B14",
                   "N1_B15",              "N1_B16",            "N1_B17",             "N1_B17_1",          "N1_B18",            "N1_B18_1",
                   "N1_B19",              "N1_B19_1",          "N1_B20",             "N1_VR1",            "N1_VR2",            "N1_VR3",
                   "N1_ContB_Name",       "N1_ContB_VZL",      "N1_CodeB",           "N1_SecCode"
                 );

  END;

  PRIVATE MACRO EndReport_NUNP()
    EndTable();
    SetAutoFilter_NUNP();
    AddStandardFooter_TaxAccSecur( "N1_", null, true );
  END;

  MACRO EndReport_NU_SVOD()
    EndTable();
    SetAutoFilter_NU_SVOD();
    AddStandardFooter_TaxAccSecur( "N2_", null, true );

    if(m_RepParams.AutoRegistersSVOD)
       var PathFiles:string = SP_TXGetFullPath(SP_GetTotalTaxRegDir());
       var PathNameProtocol = MergeFile(PathFiles, m_RepParams.NameProtocolAuto, "txt");
       if(ExistFile(PathNameProtocol))
          var doc = TStreamDoc(PathNameProtocol, "r"), msg_str;
          while(doc.readLine(@msg_str))
             msgbox(msg_str);
          end;
          doc= NULL;
       end;
    end;

    if(TX_ErrorMesage.size>0)
       var i = 0;
       while( i < TX_ErrorMesage.size)
          msgbox(TX_ErrorMesage[i]);
          i = i + 1;
       end;
    end;
  END;

  MACRO EndReport_NU_MSFO()
    AddStandardFooter_TaxAccSecur( "N3_", null, true );
  END;

  // Налоговый портфель эмиссионных ценных бумаг
  PRIVATE MACRO CreateReport_NUNP()
    SQL_Execute("DELETE FROM DNUNPREP_TMP", "", false );
    // отбор данных
    LoadDataInTMP_NUNP();
    // печать заголовка и регистрация таблицы
    BeginReport_NUNP();
    // печать данных
    Print_NUNP();
    // завершение
    EndReport_NUNP();
  END;

  // Свод данных налогового учета за отчетный период
  PRIVATE MACRO CreateReport_NU_SVOD(ObjReport:OBJECT)
    ObjReport.CreateReport();
  END;

  // Порядок отражения доходов и расходов по ц/б в отчетности в соответствии с требованиями МСФО
  PRIVATE MACRO CreateReport_NU_MSFO(ObjReport:OBJECT)
    ObjReport.CreateReport();
  END;

  PRIVATE MACRO CreateReportByKind()
    if( m_RepParams.Print_NUNP )
       CreateReport_NUNP();
    end;
    if( m_RepParams.Print_NUSVOD )
       CreateReport_NU_SVOD(CNU_SVOD(this));
    end;
    if( m_RepParams.Print_NUMSFO )
       CreateReport_NU_MSFO(CNU_MSFO(this));
    end;

    ReplaceAndCalculate("f=", "=");
  END;

  PRIVATE MACRO WriteProtocol()
    var ProtocolSelect = DL_RSDCommand("SELECT t_Message FROM DNUREPERR_DBT WHERE t_SessionID = ?");
    ProtocolSelect.AddParam(SessionID());
    if(ProtocolSelect.GetCount() > 0)
      var ProtocolDS = ProtocolSelect.execute();
      while(ProtocolDS.MoveNext())
        DL_MsgBoxFromReport(ProtocolDS.Message);
      end;
      sql_execute("DELETE FROM DNUREPERR_DBT WHERE t_SessionID = " + string(SessionID()));
    end;
  END;

  PRIVATE MACRO Create()
    CreateReportByKind();
    WriteProtocol();
  END;

  PRIVATE MACRO EndReport()
    if (IsPoi())
      ReplaceFormulaAndCalculate();
    end;
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, true );
  SetRowFlushCount(2000);
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  var TaxAccSecur_Form, TaxAccSecur_Report;

  WebMenuItem = menuItem;

  if( not IsWebService )
    TaxAccSecur_Form = CTaxAccSecur_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      TaxAccSecur_Form = WS_CTaxAccSecur_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = TaxAccSecur_Form.Run();
    end;

    if( stat )
      var prm = TaxAccSecur_Form.GetParams();
      prm.UsePoi = true;
      if( prm.Print_NUSVOD )

         if( (not IsWebService) and SP_ExistsPrevCalcData() )
           if( MsgBoxEx("Для НУСвод использовать данные по регистрам НУ предыдущего расчета?", MB_YES + MB_NO, IND_YES) == IND_YES ) 
              prm.UsePrevCalcData = true;
           end;
         end;
         SP_TaxParseXlsFiles(IsWebService, prm);
      end;

      TaxAccSecur_Report = CTaxAccSecur_Report(null, "Report_TaxAccSecur.xlsx", not prm.UsePoi, IsWebService, ReportHashCode, prm.UsePoi);
      TaxAccSecur_Report.SetRepParams(prm);
      TaxAccSecur_Report.SetIsShowAppl(not prm.UsePoi); //DEF-42228
      TaxAccSecur_Report.Run();
      
      if (prm.UsePoi)
        MsgBoxEx("Файл отчета сформирован");
      end;

      if( IsWebService )
        Dl_CallInsertStat( TaxAccSecur_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = TaxAccSecur_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( TaxAccSecur_Report.PrintMode() );
      end;
    end;
    TaxAccSecur_Report=null;
  end;

  return FullReportFileNames;
END;