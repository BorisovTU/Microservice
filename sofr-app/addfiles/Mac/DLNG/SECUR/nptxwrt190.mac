/**
  @file: 		mac\user\dlng\secur\nptxwrt190.mac
  @brief: 		Шаг 1: Отказ от исполнения, блок 203714
  # menu 
  - БО ЦБ\Сервисные операции\Операция списания и зачисления денежных средств
  # changelog
  |date       |author         |tasks                                       |note                                                        
  |-----------|---------------|--------------------------------------------|-------------------------------------------------------------
  |2025.10.10 |Васильев Н.А.  |AVT_BOSS-104                                | 
*/


import "dlquery.mac", oralib, "mmlib.mac";
import "cblogger2.mac";
import InsCarryDoc;

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;


MACRO ExecuteStep(kind_oper, DocKind, FDoc, ID_Operation, ID_Step)
  var cmd = RSDCommand("declare " +
                            "docId integer; " +
                            "refillID integer; " +
                            "paymentid integer; " +
                            "oper integer := :oper; " +
                       "BEGIN " +
                            "SELECT to_number(TRIM(t_documentid)) INTO docID FROM doproper_dbt p  JOIN dnptxop_dbt n  " +
                                              "ON n.t_id = TO_NUMBER(TRIM(p.t_documentid)) " + 
                                              "WHERE p.t_id_operation = :id_operation   AND p.t_dockind = :dockind; " +  

                            "SELECT t_refillid, t_paymentid INTO refillID, paymentid FROM UNPTXOP_PAYMENT_LINK_DBT  WHERE t_nptxopid = docID; " +

                            "UPDATE urefill_dbt SET t_status = 2, t_status_name = 'Закрыта' WHERE t_id = refillID; " +
                                
                            "INSERT INTO urefill_step_dbt " +
                                          "(t_stepid, t_refillid, t_date_operation, t_systemdate, t_action, t_comment, t_oper) " +
                                    "SELECT 0, t_id, t_date_operation, sysdate, 50, 'Отказ от исполнения', oper " +
                                          "FROM urefill_dbt " +
                                          "WHERE t_id = refillID; " +
                                          
                            // "UPDATE UNPTXOP_PAYMENT_LINK_DBT " +
                            //   "SET t_responseid = nvl(t_responseid, 0) " +
                            //   "WHERE t_nptxopid = docId AND t_paymentid = paymentid; " +
                                        
                            "INSERT INTO UNPTXOP_PAYMENT_LINK_STEP_DBT " +
                                        "(t_stepid, t_refillid, t_systemdate, t_action, t_comment, t_oper) " +
                                        "VALUES (0, refillID, sysdate, 50, 'Отказ от исполнения',  oper); " +
                                        
                          // "INSERT INTO dfuncobj_dbt " +
                          //             "(t_funcid, t_objectid, t_param, t_objecttype) " +
                          //       "VALUES (11503, docId, null, 4600); " +
                        "END; ");                     
  cmd.AddParam("oper", RSDBP_IN, {oper});
  cmd.addParam("id_operation", RSDBP_IN, ID_Operation);
  cmd.addParam("dockind", RSDBP_IN, FDoc);
  cmd.Execute();
  if( not InsertOprStatus(484131, 4)) //Установить ИРК = Закрытие
      return Error( "Ошибка при установке статуса вида \"Установить ИРК \" операции" );
  end;
  return 0;

OnError(err)
  NewLogger(c_logger.IT_LOG_TYPE, "ExecuteStep 203714").Error("ID_Operation = " + String(ID_Operation) + ", FDoc = " + String(FDoc) + ", ошибка: " + GetFullErrMsg(err));
  return 1;
  
end;
