/* Операция внебиржевой покупки с обратной продажей
   шаг "Инициализация второй части сделки"*/

import InsCarryDoc, "sp_car.mac", "sp_class.mac", "sp_carrl.mac", "sp_catac.mac", "scservop.mac";


macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);
  var     FD, dat;

  SetBuff( deal, FDoc );
  FD   = SPFirstDoc( deal, true );

  GetOprDate( DATE_DEALBEGIN_2, dat );
  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( not IsClientDeal(deal) )

     if( not АктуализироватьСрочныеСчета( FD, dat ) )
        return 1;
     end; 

     /*Если будет перерегистрация во второй части (установлен признак оплаты рег. сбора)*/
     if( FD.dl_leg.rec.PayRegTax == SET_CHAR )
        if( (not FD.OpenAccount( "+НДС", null, null, null, null, dat ) ) )
           return 1;             
        end;             
     end;  

     /*есть задаток, откроем +Расчеты в валюте оплаты (контрактива)*/ 
     if( FD.ExistDeposit == true ) 
        if( IsBUY(FD.Group) )
           if( not FD.OpenAccount( "-Расчеты", null, null, null, null, dat ) )
              return 1;
           end;
        else
           if( not FD.OpenAccount( "+Расчеты", null, null, null, null, dat ) )
              return 1;
           end;
        end;
     end; 

  else  /*Клиентская сделка */

     if( deal.ClientContrID != 0 ) 
        if( not FD.OpenAccount( "-НДС", null, null, null, null, dat )  )
           return 1;             
        end; 
     end; 
  end;

  return 0;
end;