/**
  @file nptxsnobver005.mac
  @brief Шаг инициализации операции технической сверки СНОБ

  #menu
  - БО ЦБ\Налоговый учет\НДФЛ\СНОБ\Операции технической сверки СНОБ

  #tag
  - functional_block: СНОБ
  - code_type: GUI
  - code_type: Operation
  - Сверка
  - Техническая сверка

  #link
  [BIQ-7294. Анализ. Техническая сверка] (https://sdlc.go.rshbank.ru/confluence/pages/viewpage.action?pageId=223940937)

  #changeLog
  |date      |author       |tasks    |note                                                             |
  |----------|-------------|---------|-----------------------------------------------------------------|
  |04.12.2023|Хромеев Д. С.|BOSS-1489|BOSS-48.9 СОФР. Реализация Технической сверки данных. Разработка.|
*/

import "nptxsnobverfun.mac";

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

MACRO ExecuteStep(doc, FDoc, DocKind, ID_Operation, ID_Step)
   var err = 0;
   var nptxsnobver = TRecHandler("nptxsnobver.dbt");

   SetBuff(nptxsnobver, FDoc);

   if (HasSnobverWithMessageByDate(nptxsnobver.rec.operdate))
     return Error("Уже существует сверка за " + nptxsnobver.rec.operdate + ". Выполнение невозможно.");
   end;

   var query = "                            SELECT 1 " +
               "                            FROM DNPTXTOTALBASE_DBT tb   " +
               "                       LEFT JOIN " +
               "                          DNPTXTBBUF_DBT bf " +
               "                       ON bf.t_bfid = RSI_NPTO.GetActualBFIDForTB (tb.t_tbid) " +
               "                          WHERE (tb.T_INCDATE between ? and ? AND T_CONFIRMSTATE = 1) " +
               "                             OR (NVL(bf.T_TIMESTAMPCANCLDATE,TO_DATE('01.01.0001','DD.MM.YYYY')) between ? and ?) " +
               "                             OR (tb.T_RECSTAXBASEDATE between ? and ? AND T_CONFIRMSTATE = 1) ";

   var cmd = DL_RSDCommand(query);
   cmd.AddParam(nptxsnobver.rec.BeginDate);
   cmd.AddParam(nptxsnobver.rec.EndDate);
   cmd.AddParam(nptxsnobver.rec.BeginDate);
   cmd.AddParam(nptxsnobver.rec.EndDate);
   cmd.AddParam(nptxsnobver.rec.BeginDate);
   cmd.AddParam(nptxsnobver.rec.EndDate);

   var ds = cmd.Execute();

   if (UpdateSnobverStatus(nptxsnobver, 1) != 0)
      err = Error( "Ошибка при обновлении статуса" );
   end;

   if(ds.MoveNext())
      if( not InsertOprStatus(46501, 2)); //Установка статуса Документооборот = Отбор записей
         err = Error( "Ошибка при установке статуса вида \"Документооборот\" операции" );
      end;
   else
      Error("Нет записей к сверке");
      if( not InsertOprStatus(46501, 4)); //Установка статуса Документооборот = Закрытие
         err = Error( "Ошибка при установке статуса вида \"Документооборот\" операции" );
      end;
   end;

   return err;
END;