//SecurOTCReport.mac
import "or_rep_h.mac", oralib, likepy, "it_utils.mac", "commonutil.mac";

private macro TotalInfo(dbegin:date, dend:date)
  var isDataExists:bool = false;
  var headerStr = 
  "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄ¿\n"+
  "³ ‘¤¥«®ª ¨§ ä ©«  ³ ‡ £àã¦¥­® ¢ ¡ãä¥à ¡¥§ ®è¨¡®ª ³ Žâ«®¦¥­­ë¥ ³ Žâªàëâë¥ ³ ‡ ªàëâë¥ ³ Š®«-¢® ­¥áª¢¨â®¢ ­­ëå á¤¥«®ª ³ Žè¨¡ª¨ ³\n"+
  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄ´";

  var Rep = CMakeReport(headerStr);

  CaptureOutput();
  [
  select count(1) as cnt_all,
         count(case when b.deal_id is null and b.error is null then 1 end) as cnt_loaded_to_buf,
         count(b.error) as cnt_error,
         count(case when t.t_dealstatus =  0 then 1 end) cnt_ready_deals,
         count(case when t.t_dealstatus = 10 then 1 end) cnt_open_deals,
         count(case when t.t_dealstatus = 20 then 1 end) cnt_closed_deals,
         nvl(count(t.t_dealid), 0) - sum((select sign(count(1))
                                            from dspgrdoc_dbt l
                                            join dspground_dbt g on g.t_spgroundid = l.t_spgroundid
                                           where l.t_sourcedockind = t.t_bofficekind
                                             and l.t_sourcedocid = t.t_dealid
                                             and g.t_kind = 251)) as cnt_not_matched_deals
    from otc_deals_buffer b
    left join ddl_tick_dbt t on t.t_dealid = b.deal_id
    where b.create_date >= :dbegin
      and trunc(b.create_date) <= :dend
  ];

  var row = ExecSQLselectPrmDyn(StopCaptureOutput(), dbegin, dend);

  if (row.MoveNext())
    Rep.AddPrintCell(int(row.value("cnt_all")));
    Rep.AddPrintCell(int(row.value("cnt_loaded_to_buf")));
    Rep.AddPrintCell(int(row.value("cnt_ready_deals")));
    Rep.AddPrintCell(int(row.value("cnt_open_deals")));
    Rep.AddPrintCell(int(row.value("cnt_closed_deals")));
    Rep.AddPrintCell(int(row.value("cnt_not_matched_deals")));
    Rep.AddPrintCell(int(row.value("cnt_error")));
    Rep.AddStr();
    isDataExists = true;
  end;

  if (isDataExists)
    Println("Ž¡é¨© ¨â®£:");
    Rep.PrintRep();
    Println();
    Println();
    Println();
  end;
end;

private macro ErrorInfo(dbegin:date, dend:date)
  macro PrintTableTop()
    [„¥â «¨§ æ¨ï ¯® ®è¨¡ª ¬:];
    [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
    [³                   Žè¨¡ª                   ³    Š®¤ á¤¥«ª¨    ³               ”ˆŽ               ³        „®£®¢®à        ³      ISIN      ³     –¥­      ³  Š®«¨ç¥áâ¢®  ³     ‘ã¬¬      ³    ¯à ¢«¥­¨¥   ³];
    [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
  end;                                                                                              
                                                                                                    
  macro PrintTableCenter(error, dealCode, name, contract, isin, price, qty, sum)
    [³###########################################³##################³#################################³#######################³################³##############³##############³###############³#################³]
    (error, dealCode, name, contract, isin, price, qty, sum);
  end;                                                                                              
                                                                                                    
  macro PrintTableBottom()                                                                       
    [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
  end;

  var isHeaderPrinted:bool = false;
  var count:integer = 0;

  InitProgress(-1, "”®à¬¨à®¢ ­¨¥ ®âçñâ  á ®è¨¡ª ¬¨", "”®à¬¨à®¢ ­¨¥ ®âçñâ  á ®è¨¡ª ¬¨");

  CaptureOutput();
  [
  select b.error,
         nvl(t.t_dealcodets, '-') dealcode,
         p.t_name client_name,
         s.t_number contr_number,
         av.t_isin,
         b.price,
         b.amount,
         b.price * b.amount summ,
         b.direction
    from otc_deals_buffer b
    join dparty_dbt p on p.t_partyid = b.client_id
    join dsfcontr_dbt s on s.t_id = b.contract_id
    join davoiriss_dbt av on av.t_fiid = b.instrument_id
    left join ddl_tick_dbt t on t.t_dealid = b.deal_id
   where b.error is not null
     and b.create_date >= :dbegin
     and trunc(b.create_date) <= :dend
  ];
  var rows = ExecSQLselectPrmDyn(StopCaptureOutput(), dbegin, dend);

  while (rows.MoveNext())
    if (not isHeaderPrinted)
      isHeaderPrinted = true;
      PrintTableTop();
    end;
    PrintTableCenter(rows.value("error"),
                     rows.value("dealcode"),
                     rows.value("client_name"),
                     rows.value("contr_number"),
                     rows.value("t_isin"),
                     rows.value("price"),
                     rows.value("amount"),
                     rows.value("summ"),
                     rows.value("direction"));
    UseProgress(count = count + 1);
  end;
  RemProgress();
  
  if (isHeaderPrinted)
    PrintTableBottom();
    Println();
    Println();
    Println();
  end;
end;

macro StepsInfo(dbegin:date, dend:date)
  macro PrintTableTop(allSteps:integer, executed:integer, ready:integer)
    [’¥å­¨ç¥áª ï ¨­ä®à¬ æ¨ï ® â¥ªãé¥¬ á®áâ®ï­¨¨ è £®¢ ¢ á¤¥«ª å];
    [‚á¥£® è £®¢:          ###########################################](allSteps);
    [‚ë¯®«­¥­®:            ###########################################](executed);
    [ƒ®â®¢ëå ª ¢ë¯®«­¥­¨î: ###########################################](ready);
    [ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
    [³    ®¬¥à è £     ³    Š®«¨ç¥áâ¢®    ³ ƒ®â®¢ë ª ¢ë¯-î   ³    ‚ë¯®«­¥­®     ³];
    [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
  end;                                                                                              
                                                                                                    
  macro PrintTableCenter(stepNumber:integer, cntAll:integer, ready:integer, executed:integer)
    [³##################³##################³##################³##################³]
    (stepNumber, cntAll, ready, executed);
  end;                                                                                              
                                                                                                    
  macro PrintTableBottom()                                                                       
    [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
  end;

  var isTopPrinted:bool = false;
  var count:integer = 0;

  InitProgress(-1, "”®à¬¨à®¢ ­¨¥ ¤¥â «¨§ æ¨¨ ¯® è £ ¬", "”®à¬¨à®¢ ­¨¥ ¤¥â «¨§ æ¨¨ ¯® è £ ¬");

  CaptureOutput();
  [
  with deals as (
      select /*+ leading(b, t) materialize */
             t.t_dealid,
             t.t_dealtype,
             t.t_bofficekind
        from ddl_tick_dbt t
        join otc_deals_buffer b on b.deal_id = t.t_dealid
                               and b.create_date >= :dbegin
                               and trunc(b.create_date) <= :dend
       where t.t_bofficekind = 101
         and secur_deals_utils.is_substitution_deal(p_dealid => t.t_dealid) = 1
       )
     select s.t_number_step,
            count(1) cnt_by_step,
            count(case when s.t_isexecute = 'R' then 1 end) cnt_ready,
            count(case when s.t_isexecute = 'X' then 1 end) cnt_executed,
            sum(count(1)) over() all_steps,
            sum(count(case when s.t_isexecute = 'X' then 1 end)) over () all_executed_steps,
            sum(count(case when s.t_isexecute = 'R' then 1 end)) over () all_ready_steps
       from deals d
       join doproper_dbt op on op.t_kind_operation = d.t_Dealtype and
                               op.t_dockind = d.t_bofficekind and
                               op.t_documentid = lpad(d.t_dealid, 34, '0')
       join doprstep_dbt s on s.t_id_operation = op.t_id_operation
     group by s.t_number_step
     order by s.t_number_step;
  ];
  var rows = ExecSQLselectPrmDyn(StopCaptureOutput(), dbegin, dend);

  while (rows.MoveNext())
    if(not isTopPrinted)
      PrintTableTop(rows.value("all_steps"), rows.value("all_executed_steps"), rows.value("all_ready_steps"));
      isTopPrinted = true;
    end;

    PrintTableCenter(rows.value("t_number_step"),
                     rows.value("cnt_by_step"),
                     rows.value("cnt_ready"),
                     rows.value("cnt_executed"));
    UseProgress(count = count + 1);
  end;

  RemProgress();

  if (isTopPrinted)
    PrintTableBottom();
    Println();
    Println();
    Println();
  end;
end;

private var periodPanel = GetPeriodPanel("‚ë¡¥à¨â¥ ¯¥à¨®¤", date - 30, date);
if (periodPanel.run)
  TotalInfo(periodPanel.BDate, periodPanel.EDate);
  ErrorInfo(periodPanel.BDate, periodPanel.EDate);
  StepsInfo(periodPanel.BDate, periodPanel.EDate);
end;