/*******************************************************************************
 DESCRIPTION  :   Отчет "Информация о выплаченных иностранным организациям доходах и удержанных налогах" (НУ)
 PROGRAMMED BY:   Сагиян С.Г.
 CREATION DATE:    12.02.2019
*******************************************************************************/
IMPORT  "spCache.mac", "nr18_form.mac", "nr18_file.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "cb_sql.mac", "sprepfun.mac", "oralib", "MoCommon.mac","ws_txreportform.mac";;
//import "sccomiss.mac", "spRepFun.mac"

PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR   NR18_Form;
PRIVATE VAR   NR18_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб
PRIVATE VAR   impMask       = "*.DBF";
PRIVATE VAR   fname;
CONST NOTEKIND_TAXPROC = 59;  // Налоговая ставка по процентам.
VAR CurrentRow = 11;

VAR RowArr = TArray();
VAR RowArr2 = TArray();
VAR   encode        = "lcansi";//"lcoem";
VAR CounterPart;
VAR Sour1, Sour2, Sour3;

PRIVATE VAR ReportHeader = " \n"; 
                                                                                                                                                                                                                                                                                                                             
PRIVATE VAR TableHeader = " \n"; 

                                                                                                                                   
PRIVATE CLASS (DL_CReportTemplate) DL_NR18_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  var RS;
  VAR BeginDate, EndDate;
  var cmdtemp, rstemp;

  VAR PrevFI, PrevS;
  VAR         ProgressValue = CTxProgressValue();

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
/* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END;


	



  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintLine( SOURCENUM, P1,P2,P3,P4,P5,P6,P7,P8,P9,P10,P11,P12,P13,P14,P15,P16,P17,P18,P19,P20,P21,P22,P23,P24,P25,P26,P27,P28,P29)
     CurrentRow = CurrentRow + 1;
     var fict1, fict2, fict3;
     if (SOURCENUM == 2)
		    //  fict1 = "=ЕСЛИ(Q" + CurrentRow + "=99,99;\"\";N" + CurrentRow + "*Q" + CurrentRow + "/100)";
        if (P17 == 99.99)
            fict1 = P14 * P17 / 100;
        end;
     		//  fict3 = "=ЕСЛИ(И(ЕЧИСЛО(V" + CurrentRow + ") ; ЕЧИСЛО(T" + CurrentRow + "));T" + CurrentRow + "*V" + CurrentRow + ";\"\")";
        if (P22 and P20)
          fict3 = P22 * P20;
        end;
     else
     		// fict1 = "=ЕСЛИ(Q" + CurrentRow + "=99,99;\"\";ОТБР(N" + CurrentRow + "*Q" + CurrentRow + "/100))";
        if (P17 == 99.99)
            fict1 = round(p14 * P17 / 100);
        end;
		    // fict3 = "=ЕСЛИ(И(ЕЧИСЛО(V" + CurrentRow + ") ; ЕЧИСЛО(T" + CurrentRow + "));ОТБР(T" + CurrentRow + "*V" + CurrentRow + ");\"\")";
        if (P22 and P20)
          fict3 = round(p22 * P20);
        end;
     end;

     if (P15 != 643)  
     	// fict2 = "=ЕСЛИ(И(ЕЧИСЛО(T" + CurrentRow + ") ; O" + CurrentRow + "<>643);" + int(P22*100) + "/10000;\"\")";
      if (P20 and (P15 != 643))
        fict2 = P22 * 100 / 10000;
      end;
     else 
	    fict2 = "";
     end;
     



     this.PrintTableLine( 

          /*1 */     "N1_Q0",      	P1  , null, 
          /*2 */     "N1_Q5",      	P2  , null, 
          /*3 */     "N1_Q10",      	P3  , null, 
          /*4 */     "N1_Q20",         	P4  , null, 
          /*5 */     "N1_Q30",      	P5  , null, 
          /*6 */     "N1_Q40",       	P6  , null, 
          /*7 */     "N1_Q50",     	P7  , null, 
          /*8 */     "N1_Q60",        	P8  , null, 
          /*9 */     "N1_Q70",      	P9  , null, 
          /*10*/     "N1_Q80",       	P10 , null, 
          /*11*/     "N1_D10",      	P11 , null, 
          /*12*/     "N1_D20",  	P12 , null, 
          /*13*/     "N1_D30",     	P13 , null, 
          /*14*/     "N1_D40",  	P14 , null, 
          /*15*/     "N1_D50",      	P15 , null, 
          /*16*/     "N1_D60",        	P16 , null, 
          /*17*/     "N1_D70",         	P17 , null, 
          /*18*/     "N1_D80",      	P18 , null, 
          /*19*/     "N1_D90",     	P19 , null, 
          /*20*/     "N1_D100",     	fict1 , null, 
          /*21*/     "N1_D110",      	P21 , null, 
          /*22*/     "N1_D120",     	fict2 , null, 
          /*23*/     "N1_D130",       	P23 , null, 
          /*24*/     "N1_D140",    	fict3 , null, 
          /*25*/     "N1_D150",       	P25 , null, 
          /*26*/     "N1_D160", 	P26 , null, 
          /*27*/     "N1_D170",    	P27 , null, 
          /*28*/     "N1_D180",  	P28 , null, 
          /*29*/     "N1_D190",    	P29 , null
       );      

  END;


  PRIVATE MACRO PrintEmptyLine()
     CurrentRow = CurrentRow + 1;
     this.PrintTableLine( 

          /*1 */     "N1_Q0",      	"x"  , null, 
          /*2 */     "N1_Q5",      	"x"  , null, 
          /*3 */     "N1_Q10",      	"x"  , null, 
          /*4 */     "N1_Q20",         	"x"  , null, 
          /*5 */     "N1_Q30",      	"x"  , null, 
          /*6 */     "N1_Q40",       	"x"  , null, 
          /*7 */     "N1_Q50",     	"x"  , null, 
          /*8 */     "N1_Q60",        	"x"  , null, 
          /*9 */     "N1_Q70",      	"x"  , null, 
          /*10*/     "N1_Q80",       	"x" , null, 
          /*11*/     "N1_D10",      	"x" , null, 
          /*12*/     "N1_D20",  	"x" , null, 
          /*13*/     "N1_D30",     	"x" , null, 
          /*14*/     "N1_D40",  	"x" , null, 
          /*15*/     "N1_D50",      	"x" , null, 
          /*16*/     "N1_D60",        	"x" , null, 
          /*17*/     "N1_D70",         	"x" , null, 
          /*18*/     "N1_D80",      	"x" , null, 
          /*19*/     "N1_D90",     	"x" , null, 
          /*20*/     "N1_D100",     	"x" , null, 
          /*21*/     "N1_D110",      	"x" , null, 
          /*22*/     "N1_D120",     	"x" , null, 
          /*23*/     "N1_D130",       	"x" , null, 
          /*24*/     "N1_D140",    	"x" , null, 
          /*25*/     "N1_D150",         "x" , null, 
          /*26*/     "N1_D160", 	"x" , null, 
          /*27*/     "N1_D170",    	"x" , null, 
          /*28*/     "N1_D180",  	"x" , null, 
          /*29*/     "N1_D190",    	"x" , null
       );      

  END;




  PRIVATE MACRO BeginReport()

     VAR AvrKindShowValue = "";

     this.SetActiveSheet( "Подраздел 3.3. ЮЛ" );

     this.RegisterTable( "N3_MAINTABLE", "",
	"N3_D0","N3_D05","N3_D010","N3_D020","N3_D030","N3_D040","N3_D050","N3_D060","N3_D070","N3_D080","N3_D090","N3_D100","N3_D110","N3_D120","N3_D130","N3_D140"

       );      


     this.PrintTableLine( 

          /*1 */     "N3_D0",      	"x"  , null, 
          /*2 */     "N3_D05",      	"x"  , null, 
          /*11*/     "N3_D010",      	"x" , null, 
          /*12*/     "N3_D020",  	"x" , null, 
          /*13*/     "N3_D030",     	"x" , null, 
          /*14*/     "N3_D040",  	"x" , null, 
          /*15*/     "N3_D050",      	"x" , null, 
          /*16*/     "N3_D060",        	"x" , null, 
          /*17*/     "N3_D070",         "x" , null, 
          /*18*/     "N3_D080",      	"x" , null, 
          /*19*/     "N3_D090",     	"x" , null, 
          /*20*/     "N3_D100",     	"x" , null, 
          /*21*/     "N3_D110",      	"x" , null, 
          /*22*/     "N3_D120",     	"x" , null, 
          /*23*/     "N3_D130",       	"x" , null, 
          /*24*/     "N3_D140",    	"x" , null 
       );      

     this.EndTable();



     this.SetActiveSheet( "Подразделы 3.1-3.2" );


                               

     this.PrintFormatString( ReportHeader,
                     "H0_0"  , NR18_Form.GetFieldValue( PNFLD_NR18_BEGINDATE ) + " - " + NR18_Form.GetFieldValue( PNFLD_NR18_ENDDATE )
                   );

     this.RegisterTable( "N1_MainTable", "",
          /*1 */     "N1_Q0",      	
          /*2 */     "N1_Q5",      	
          /*3 */     "N1_Q10",      	
          /*4 */     "N1_Q20",         	
          /*5 */     "N1_Q30",      	
          /*6 */     "N1_Q40",       	
          /*7 */     "N1_Q50",     	
          /*8 */     "N1_Q60",        	
          /*9 */     "N1_Q70",      	
          /*10*/     "N1_Q80",       	
          /*11*/     "N1_D10",      	
          /*12*/     "N1_D20",  	
          /*13*/     "N1_D30",     	
          /*14*/     "N1_D40",  	
          /*15*/     "N1_D50",      	
          /*16*/     "N1_D60",        	
          /*17*/     "N1_D70",         	
          /*18*/     "N1_D80",      	
          /*19*/     "N1_D90",     	
          /*20*/     "N1_D100",     	
          /*21*/     "N1_D110",      	
          /*22*/     "N1_D120",     	
          /*23*/     "N1_D130",       	
          /*24*/     "N1_D140",    	
          /*25*/     "N1_D150",       	
          /*26*/     "N1_D160", 	
          /*27*/     "N1_D170",    	
          /*28*/     "N1_D180",  	
          /*29*/     "N1_D190"    	
       );      

  END;


  MACRO BeginReport2

     this.SetActiveSheet( "Подраздел 3.3. ФЛ" );

     this.RegisterTable( "N2_MAINTABLE", "",
          /*1 */     "N2_D0",      	
          /*2 */     "N2_D5",      	
          /*11*/     "N2_D010",      	
          /*12*/     "N2_D020",  	
          /*13*/     "N2_D030",     	
          /*14*/     "N2_D040",  	
          /*15*/     "N2_D050",      	
          /*16*/     "N2_D060",        	
          /*17*/     "N2_D070",         	
          /*25*/     "N2_D150",       	
          /*26*/     "N2_D160", 	
          /*27*/     "N2_D170",    	
          /*28*/     "N2_D180",  	
          /*29*/     "N2_D190",
          /*29*/     "N2_D200",
          /*29*/     "N2_D210",          
	  /*29*/     "N2_D220",
	  /*29*/     "N2_D230",
	  /*29*/     "N2_D240",
	  /*29*/     "N2_D250",
	  /*29*/     "N2_D260",
	  /*29*/     "N2_D270",
	  /*29*/     "N2_D271",
	  /*29*/     "N2_D272",
	  /*29*/     "N2_D273",
	  /*29*/     "N2_D274",
	  /*29*/     "N2_D275",
	  /*29*/     "N2_D276",
	  /*29*/     "N2_D277",
	  /*29*/     "N2_D278",
	  /*29*/     "N2_D279",
	  /*29*/     "N2_D280",
	  /*29*/     "N2_D290",
	  /*29*/     "N2_D300"
       );      


  END;

  MACRO PrintLine2( P1,P2,P3,P4,P5,P6,P7,P8,P9,P17,P18,P19,P20,P21,P22,P23,P24,P25,P26,P27,P28,P29,P30,P31,P32,P33,P34,P35,P36,P37,P38,P39,P40,P41)

        this.PrintTableLine( 
          /*11*/     "N2_D0",      	P1 , null, 
          /*11*/     "N2_D05",      	P2 , null, 
          /*11*/     "N2_D10",      	P3 , null, 
          /*12*/     "N2_D20",  	P4 , null, 
          /*13*/     "N2_D30",     	P5 , null, 
          /*14*/     "N2_D40",  	P6 , null, 
          /*15*/     "N2_D50",      	P7 , null, 
          /*16*/     "N2_D60",        	P8 , null, 
          /*17*/     "N2_D70",         	P9 , null, 
          /*25*/     "N2_D150",       	P17 , null, 
          /*26*/     "N2_D160", 	P18 , null, 
          /*27*/     "N2_D170",    	P19 , null, 
          /*28*/     "N2_D180",  	P20 , null, 
          /*29*/     "N2_D190",    	P21 , null,
          /*29*/     "N2_D200",    	P22 , null,
          /*29*/     "N2_D210",    	P23 , null,
          /*29*/     "N2_D220",    	P24 , null,
          /*29*/     "N2_D230",    	P25 , null,
          /*29*/     "N2_D240",    	P26 , null,
          /*29*/     "N2_D250",    	P27 , null,
          /*29*/     "N2_D260",    	P28 , null,
          /*29*/     "N2_D270",    	P29 , null,
          /*29*/     "N2_D271",    	P30 , null,
          /*29*/     "N2_D272",    	P31 , null,
          /*29*/     "N2_D273",    	P32 , null,
          /*29*/     "N2_D274",    	P33 , null,
          /*29*/     "N2_D275",    	P34 , null,
          /*29*/     "N2_D276",    	P35 , null,
          /*29*/     "N2_D277",    	P36 , null,
          /*29*/     "N2_D278",    	P37 , null,
          /*29*/     "N2_D279",    	P38 , null,
          /*29*/     "N2_D280",    	P39 , null,
          /*29*/     "N2_D290",    	P40 , null,
          /*29*/     "N2_D300",    	P41 , null
       );      
  END;





  MACRO ПечататьПромежуточныеИтоги()
  END;

  PRIVATE MACRO EndReport()
     ReplaceFormulaAndCalculate();
     this.EndTable();
     ПечататьПромежуточныеИтоги();
//     this.AddStandardFooter( "" );
  END;




  MACRO GetTaxSUM(dealid)
    var cmd, rs, query;
    query = 
        "SELECT T.T_ACCOUNT_PAYER, T.T_ACCOUNT_RECEIVER, t.t_fiid_receiver, t.t_sum_payer summ1, t_sum_receiver summ2, t_fiid_payer fiid1, t_fiid_receiver fiid2, t_ground, t.t_date_carry datecarry  FROM dacctrn_dbt t " +
        "WHERE ( (t.t_AccTrnID IN  (SELECT docs.t_AccTrnID FROM doprdocs_dbt docs, doproper_dbt opr WHERE     opr.t_DocKind = 102 AND opr.t_DocumentID = LPAD (?, 34, chr(48)) AND docs.t_ID_Operation = opr.t_ID_Operation AND docs.t_DocKind = 1)  " +
        "OR t.t_AccTrnID IN (SELECT grdoc.t_DocID FROM ddlgrdeal_dbt grdeal, ddlgrdoc_dbt grdoc WHERE     grdeal.t_DocKind = 102 AND grdeal.t_DocID = ? AND grdoc.t_GrDealID = grdeal.t_ID AND grdoc.t_DocKind = 1))) " +
        "and ( substr(t_account_payer, 1, 3) = '474' and substr(t_account_receiver, 1, 3) = '603') and t.t_date_carry between  " + GetSQLDate( BeginDate ) + " and " + GetSQLDate( EndDate );

    cmd = RSDCommand( Query );
    cmd.AddParam( "", RSDBP_IN, dealid );      
    cmd.AddParam( "", RSDBP_IN, dealid );      
    rs = TRsbDataSet( cmd );
    if ( rs.movenext )    
            return rs.summ1;
    else 
	    return 0;
    end;
  END;

                
  PRIVATE MACRO Create()

     VAR DataQuery;
     VAR DealBuy;
     VAR AddWhere:string = "";

     VAR AvrFIID:integer, AvrKind:integer;       
     VAR QntySold:money = $0, SumBvpr:money = $0;
     VAR NKD:money = $0;
     VAR BuyDealTime:time, BuyPrice:double = 0.0;
     VAR NatCurSum;
     VAR TempTax;
     VAR IsBlock;

     VAR Counter=1;
     VAR RegNO=0;
     VAR PrevParty=-1;
     VAR Flag_load;
     VAR ProcTax;
     VAR LDealType;
            
     NR18_Form.GetFieldValue( PNFLD_NR18_BEGINDATE, @BeginDate );
     NR18_Form.GetFieldValue( PNFLD_NR18_ENDDATE, @EndDate );
     NR18_Form.GetFieldValue( PNFLD_NR18_LOAD, @Flag_load );
     NR18_Form.GetFieldValue( PNFLD_NR18_SOUR1, @Sour1 );
     NR18_Form.GetFieldValue( PNFLD_NR18_SOUR2, @Sour2 );
     NR18_Form.GetFieldValue( PNFLD_NR18_SOUR3, @Sour3 );

     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);


if (Sour1 == "X")
//KEA изменено NKDDate на дату фактической оплаты, и отбор по этой дате. 526251
     DataQuery = "select EM.T_NOTRESIDENT, tick.t_partyid partyid, (case when length(adr1.t_adress)>10 then adr1.t_adress else adr2.t_adress end) contradress,  cou.t_codenum3 Contrcoucode, fi.t_name FiName, fi.t_facevaluefi, fi.t_issuer FiIssuerID, contr.t_name ContrName, " + 
                 "nvl((select 1 from dpartyown_dbt  contrb where contrb.t_partykind=2 and CONTR.T_PARTYID=contrb.t_partyid),0) ContrIsBank, leg.t_nkd NKDSum, faceval.t_iso_number NKDfi, faceval.t_fiid NKDfiid, " +
                 " /* (case when leg.t_maturityisprincipal=chr(88) then leg.t_expiry else t_maturity*/  LRQ.T_FACTDATE/*  end)*/ NKDDate " + //MAA: 509204 - Убираем преобразование даты в строку
                 "from ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fi, dparty_dbt em, dparty_dbt contr, dcountry_dbt cou, dadress_dbt adr1, dadress_dbt  adr2, dfininstr_dbt pfi, dfininstr_dbt faceval, ddlrq_dbt lrq " + 
                 "where tick.t_dealtype in (12183, 2183) " + 
                 "and tick.t_clientid = -1 " + //Chesnokov D.S. 503507 убираем клентские
                 "and tick.t_pfi = pfi.t_fiid " + 
                 "and tick.t_pfi=fi.t_fiid " +
                 "and pfi.t_facevaluefi = faceval.t_fiid " + 
                 "and fi.t_issuer = em.t_partyid " +
                 "and tick.t_partyid = contr.t_partyid " +
                 "and tick.t_dealid = leg.t_dealid and leg.t_legkind=0 " +
                 "and LRQ.T_DOCID = TICK.T_DEALID and LRQ.T_KIND = 1 " +
                 "and contr.t_nrcountry=cou.t_codelat3 " +
                 "and EM.T_NOTRESIDENT <> chr(88) " +
                 "and CONTR.T_NOTRESIDENT = chr(88) " +
                 "and CONTR.T_PARTYID = adr1.t_partyid(+) and adr1.t_type(+)=1 " +
                 "and CONTR.T_PARTYID = adr2.t_partyid(+) and adr2.t_type(+)=2 " +
                 " and lrq.t_dockind = 101 "+ /*IS: 534009*/
                 "and /*tick.t_dealdate*/ LRQ.T_FACTDATE between " + GetSQLDate( BeginDate ) + " and " + GetSQLDate( EndDate ) + " order by tick.t_partyid, NKDDate" ;

     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Current = 0;
     
     
     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"\"Информация о выплаченных ин. организациям доходах и удержанных налогах\"" , HTML_StSheetName);
     end;
     PrevFi = 0;
     PrevS = 0;
     RS = TRsbDataSet( DataQuery );
     while( RS.MoveNext() )
	 Counter = RowArr.Size;
	 if (PrevParty != RS.partyid) 
		RegNO = RegNO + 1;
		PrevParty = RS.partyid;
	 end;

	 RowArr( Counter ) = TRow();
	 RowArr( Counter ).Source = 1;
         RowArr( Counter ).Q0 = RegNO;      	
         RowArr( Counter ).Q5 = Counter+1;      	
         if (RS.ContrIsBank == 1)  RowArr( Counter ).Q10 = 1;
	 else  RowArr( Counter ).Q10 = 4;
	 end;
         RowArr( Counter ).Q20 = RS.ContrName;         	
         RowArr( Counter ).Q30 = RS.Contrcoucode;
         RowArr( Counter ).Q40 = RS.contradress;
         RowArr( Counter ).Q50 = ПолучитьКодСубъекта(RS.partyid, 6);
         RowArr( Counter ).Q60 = "";
         RowArr( Counter ).Q70 = "";
         RowArr( Counter ).Q80 = "";
         RowArr( Counter ).D10 = 1;
         RowArr( Counter ).D20 = 10;
         RowArr( Counter ).D30 = "";
         RowArr( Counter ).D40 = RS.NKDSum;
         RowArr( Counter ).D50 = RS.NKDFi;      	
         RowArr( Counter ).D60 = Date(RS.NKDDate);

	 ProcTax = readNoteForObject( OBJTYPE_PARTY, L_Z( rs.PARTYID, 10 ), NOTEKIND_TAXPROC);  
	 if (ProcTax == "") ProcTax = 0;
	 end;

	 if ((ProcTax == 0) OR (ProcTax == "")) 
	         RowArr( Counter ).D70 = "99,99";
	 else
	         RowArr( Counter ).D70 = ProcTax;
	 end;

         RowArr( Counter ).D80 = "";
         RowArr( Counter ).D90 = "";

         RowArr( Counter ).D110 = "";

	 NatCurSum = 0;
	 if (/*( ProcTax == 0 ) or*/ (RS.NKDfiid == 0))
		RowArr( Counter ).D120 = "";
	 else 
		SmartConvertSum(NatCurSum, money(100), RS.NKDDate, RS.NKDfiid, NATCUR, true);	
		RowArr( Counter ).D120 = NatCurSum;
	 end;

         RowArr( Counter ).D130 = "";
	 if (NatCurSum > 0)
         	RowArr( Counter ).D140 = "X"; //RS.NKDSum * ProcTax / 100 * NatCurSum;
	 else 
		RowArr( Counter ).D140 = "";
	 end;

         RowArr( Counter ).D150 = "01";       	
         RowArr( Counter ).D160 = ""; 	
         RowArr( Counter ).D170 = "";
         RowArr( Counter ).D180 = "";
         RowArr( Counter ).D190 = "";
         ProgressValue.Current = ProgressValue.Current + 1;
         ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;
     CounterPart = RowArr.Size;

     // ----- ЗАгрузка второй части из файлов НРД ----- sgs -----
     if (Flag_load == "X")
     	GetFromExcel(RowArr, RowArr2);                                                  
     end;
     //----------------------------------------------------------

end;

//-----------------------------------------------------------------------------------------------
//     загрузка из 2 источника 
//-----------------------------------------------------------------------------------------------

LDealType = "";

if (Sour2 == "X") LDealType = "12300, 32300, ";  //SVE 497588 из отчета убраны овердрафты 12301
end;
if (Sour3 == "X") LDealType = LDealType + "12310, ";
end;

if (LDealType != "")

	LDealType = LDealType + "0";

        DataQuery =  	   " select distinct (case when tick.t_dealtype=12310 then 3 else 2 end) source,  tick.t_dealid,  tick.t_partyid partyid, (case when length(adr1.t_adress)>10 then adr1.t_adress else adr2.t_adress end) contradress,  ";
        DataQuery =  DataQuery +   "(case when contr.t_nrcountry=chr(1) then '643' else (select cou.t_codenum3 from dcountry_dbt cou where contr.t_nrcountry=cou.t_codelat3) end) Contrcoucode,  ";
        DataQuery =  DataQuery +   "contr.t_name ContrName,  ";
        DataQuery =  DataQuery +   "nvl((select 1 from dpartyown_dbt  contrb where contrb.t_partykind=2 and CONTR.T_PARTYID=contrb.t_partyid),0) ContrIsBank,  ";
        DataQuery =  DataQuery +   "(select nvl(sum(t_amount),0) from dpmpaym_dbt where t_dockind=102 and t_documentid=tick.t_dealid and t_purpose=11 and t_valuedate between " + GetSQLDate( BeginDate ) + " AND " + GetSQLDate( EndDate ) + " ) NKDSum, ";
//        DataQuery =  DataQuery +   " leg.t_cost  NKDSum, ";
        DataQuery =  DataQuery +   "(select min(t_iso_number) from dpmpaym_dbt pm, dfininstr_dbt fi where t_dockind=102 and t_documentid=tick.t_dealid and t_purpose=11 and pm.t_payfiid=fi.t_fiid) NKDFi, ";
        DataQuery =  DataQuery +   "(select min(pm.t_payfiid) from dpmpaym_dbt pm where t_dockind=102 and t_documentid=tick.t_dealid and t_purpose=11 ) NKDFiid, ";
        DataQuery =  DataQuery +   "(select min(t_valuedate) from dpmpaym_dbt where t_dockind=102 and t_documentid=tick.t_dealid and t_purpose=11 and t_valuedate between " + GetSQLDate( BeginDate ) + " AND " + GetSQLDate( EndDate ) + ") NKDDate  "; //MAA: 509204 - Убираем преобразование даты в строку
        DataQuery =  DataQuery +   "from ddl_tick_Dbt tick, ddl_leg_dbt leg, dfininstr_dbt pfi, dparty_dbt contr, dadress_dbt adr1, dadress_dbt  adr2  ";
        DataQuery =  DataQuery +   "where tick.t_bofficekind=102 and tick.t_dealtype in (" + LDealType + ") and tick.t_clientid=-1 ";
        DataQuery =  DataQuery +   "and tick.t_dealstatus in (10,20) ";
        DataQuery =  DataQuery +   "and tick.t_pfi = pfi.t_fiid  ";
        DataQuery =  DataQuery +   "and tick.t_partyid = contr.t_partyid  ";
        DataQuery =  DataQuery +   "and tick.t_dealid = leg.t_dealid and leg.t_legkind=0  ";
        DataQuery =  DataQuery +   "and CONTR.T_NOTRESIDENT = chr(88)  ";
        DataQuery =  DataQuery +   "and CONTR.T_PARTYID = adr1.t_partyid(+) and adr1.t_type(+)=1  ";
        DataQuery =  DataQuery +   "and CONTR.T_PARTYID = adr2.t_partyid(+) and adr2.t_type(+)=2  ";
        DataQuery =  DataQuery +   "and leg.t_start < " + GetSQLDate( EndDate ) + " and ((leg.t_closed > " + GetSQLDate( BeginDate ) + ") or (leg.t_closed = TO_DATE ('01.01.0001', 'DD.MM.YYYY')))";
        //DataQuery =  DataQuery +   "order by tick.t_partyid, NKDDate ";

	DataQuery =  DataQuery +   " UNION ";

        DataQuery =  DataQuery +   " select distinct  2 source, 0 t_dealid,  contr.t_partyid partyid, (case when length(adr1.t_adress)>10 then adr1.t_adress else adr2.t_adress end) contradress,  ";
        DataQuery =  DataQuery +   "(case when contr.t_nrcountry=chr(1) then '643' else (select cou.t_codenum3 from dcountry_dbt cou where contr.t_nrcountry=cou.t_codelat3) end) Contrcoucode,  ";
        DataQuery =  DataQuery +   "contr.t_name ContrName,  ";
        DataQuery =  DataQuery +   "nvl((select 1 from dpartyown_dbt  contrb where contrb.t_partykind=2 and CONTR.T_PARTYID=contrb.t_partyid),0) ContrIsBank,  ";
        DataQuery =  DataQuery +   "abs(prc.t_exppaid) NKDSum, ";
        DataQuery =  DataQuery +   "(select t_iso_number from dfininstr_dbt fii where pm.t_sumpaycur=fii.t_fiid) NKDFi, ";
        DataQuery =  DataQuery +   "pm.t_sumpaycur NKDFiid, ";
        DataQuery =  DataQuery +   "pm.t_date NKDDate "; //MAA: 509204 - Убираем преобразование даты в строку
        DataQuery =  DataQuery +   "from ddvcsa_dbt csa, dparty_dbt contr, dadress_dbt adr1, dadress_dbt  adr2, ddvcsapmprc_Dbt prc, ddvcsapm_dbt pm ";
        DataQuery =  DataQuery +   "where 1=1 ";
        DataQuery =  DataQuery +   "and csa.t_partyid = contr.t_partyid  ";
        DataQuery =  DataQuery +   "and CONTR.T_NOTRESIDENT = chr(88)  ";
        DataQuery =  DataQuery +   "and CONTR.T_PARTYID = adr1.t_partyid(+) and adr1.t_type(+)=1  ";
        DataQuery =  DataQuery +   "and CONTR.T_PARTYID = adr2.t_partyid(+) and adr2.t_type(+)=2  ";
        DataQuery =  DataQuery +   "and prc.t_exppaid <> 0   ";
        DataQuery =  DataQuery +   "and CSA.T_CSAID = pm.T_CSAID and pm.t_pmid=prc.t_pmid and pm.t_date between " + GetSQLDate( BeginDate ) + " AND " + GetSQLDate( EndDate );

        DataQuery =  DataQuery +   "order by partyid, NKDDate";



     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Current = 0;
     
     ProgressIndicator = CreateProgressIndicator(m_IsWebService);
     
     if( m_IsWebService and (WebMenuItem != null) )
       header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"\"Информация о выплаченных ин. организациям доходах и удержанных налогах\"" , HTML_StSheetName);
     end;
     PrevFi = 0;
     PrevS = 0;
     RS = TRsbDataSet( DataQuery );
     while( RS.MoveNext() )
       if (valtype(RS.NKDDate) > 0)
//       if (RS.nkdsum > 0)
	 Counter = RowArr.Size;
	 if (PrevParty != RS.partyid) 
		RegNO = RegNO + 1;
		PrevParty = RS.partyid;
	 end;

	 RowArr( Counter ) = TRow();
         RowArr( Counter ).Source = 2;     
         RowArr( Counter ).Q0 = RegNO;      	
         RowArr( Counter ).Q5 = Counter+1;      	
         if (RS.ContrIsBank == 1)  RowArr( Counter ).Q10 = 1;
	 else  RowArr( Counter ).Q10 = 4;
	 end;
         RowArr( Counter ).Q20 = RS.ContrName;         	
         RowArr( Counter ).Q30 = RS.Contrcoucode;
         RowArr( Counter ).Q40 = RS.contradress;
         RowArr( Counter ).Q50 = ПолучитьКодСубъекта(RS.partyid, 6);
         RowArr( Counter ).Q60 = "";
         RowArr( Counter ).Q70 = "";
         RowArr( Counter ).Q80 = "";
         RowArr( Counter ).D10 = 1;
         RowArr( Counter ).D20 = 11;

         if (RS.ContrIsBank == 1)  
		if ((RS.dealid > 0) or (RS.source != 2))
			RowArr( Counter ).D30 = "11119";
		else
			RowArr( Counter ).D30 = "11216";   // dealid == 0 - признак сделки CSA
		end
	 else  
		RowArr( Counter ).D30 = "11116";
	 end;

	 ProcTax = readNoteForObject( OBJTYPE_PARTY, L_Z( rs.PARTYID, 10 ), NOTEKIND_TAXPROC);  
	 if (ProcTax == "") ProcTax = 0;
	 end;


//	 TempTax = GetTaxSUM(rs.dealid);
//         RowArr( Counter ).D40 = RS.NKDSum * 100 / (100-ProcTax);
//def-65196
         RowArr( Counter ).D40 = RS.NKDSum;
         RowArr( Counter ).D50 = RS.NKDFi;      	
         RowArr( Counter ).D60 = Date(RS.NKDDate);


	 if ((ProcTax == 0) OR (ProcTax == "")) 
	         RowArr( Counter ).D70 = "99,99";
	 else
	         RowArr( Counter ).D70 = ProcTax;
	 end;

         RowArr( Counter ).D80 = "";
         RowArr( Counter ).D90 = "";

         RowArr( Counter ).D110 = "";
	 NatCurSum = 0;
	 if ( /*( ProcTax == 0 ) or*/ (RS.NKDfiid == 0))
		RowArr( Counter ).D120 = "";
	 else 
		SmartConvertSum(NatCurSum, money(100), RS.NKDDate, RS.NKDfiid, NATCUR, true);	
		RowArr( Counter ).D120 = NatCurSum;
	 end;

         RowArr( Counter ).D130 = "";
	 if (NatCurSum > 0)
         	RowArr( Counter ).D140 = "X"; //RS.NKDSum * ProcTax / 100 * NatCurSum;
	 else 
		RowArr( Counter ).D140 = "";
	 end;

	 RowArr( Counter ).D140 = "formula=N12*Q12/100";

         RowArr( Counter ).D150 = "01";       	
         RowArr( Counter ).D160 = ""; 	
         RowArr( Counter ).D170 = "";
         RowArr( Counter ).D180 = "";
         RowArr( Counter ).D190 = "";
         ProgressValue.Current = ProgressValue.Current + 1;
         ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
      end;
     end;

end;
//-----------------------------------------------------------------------------------------------
//     загрузка из 2 источника завершена
//-----------------------------------------------------------------------------------------------


     Counter = 0;
     while (Counter < RowArr.Size)

	 PrintLine ( 
		 RowArr( Counter ).Source,
	         RowArr( Counter ).Q0,      	
	         RowArr( Counter ).Q5,      	
	         RowArr( Counter ).Q10,      	
	         RowArr( Counter ).Q20,         	
	         RowArr( Counter ).Q30,      	
	         RowArr( Counter ).Q40,       	
	         RowArr( Counter ).Q50,     	
	         RowArr( Counter ).Q60,        	
	         RowArr( Counter ).Q70,      	
	         RowArr( Counter ).Q80,       	
	         RowArr( Counter ).D10,      	
	         RowArr( Counter ).D20,  	
	         RowArr( Counter ).D30,     	
	         RowArr( Counter ).D40,  	
	         RowArr( Counter ).D50,      	
	         RowArr( Counter ).D60,        	
	         RowArr( Counter ).D70,         	
	         RowArr( Counter ).D80,      	
	         RowArr( Counter ).D90,     	
	         RowArr( Counter ).D100,     	
	         RowArr( Counter ).D110,      	
	         RowArr( Counter ).D120,     	
	         RowArr( Counter ).D130,       	
	         RowArr( Counter ).D140,    	
	         RowArr( Counter ).D150,       	
	         RowArr( Counter ).D160, 	
	         RowArr( Counter ).D170,    	
	         RowArr( Counter ).D180,  	
	         RowArr( Counter ).D190
	 );


	 Counter = Counter + 1;
         m_IsDataExist = true;


	 if ((Counter == CounterPart) AND (Flag_load == "X") )
		 PrintEmptyLine;
	 end;


     end;
     ProgressIndicator.Stop();


     this.EndTable();

     this.BeginReport2();
     Counter = 0;
     while (Counter < RowArr2.Size)

	 PrintLine2 (
	         RowArr2( Counter ).N2_D0,      	
	         RowArr2( Counter ).N2_D05,  	
	         RowArr2( Counter ).N2_D010,     	
	         RowArr2( Counter ).N2_D020,  	
	         RowArr2( Counter ).N2_D030,      	
	         RowArr2( Counter ).N2_D040,        	
	         RowArr2( Counter ).N2_D050,         	
	         RowArr2( Counter ).N2_D060,      	
	         RowArr2( Counter ).N2_D070,     	
	         RowArr2( Counter ).N2_D150,     	
	         RowArr2( Counter ).N2_D160,      	
	         RowArr2( Counter ).N2_D170,     	
	         RowArr2( Counter ).N2_D180,       	
	         RowArr2( Counter ).N2_D190,    	
	         RowArr2( Counter ).N2_D200,       	
	         RowArr2( Counter ).N2_D210, 	
	         RowArr2( Counter ).N2_D220,    	
	         RowArr2( Counter ).N2_D230,  	
	         RowArr2( Counter ).N2_D240,
	         RowArr2( Counter ).N2_D250,
	         RowArr2( Counter ).N2_D260,
	         RowArr2( Counter ).N2_D270,
		 "", "", "", "", "", "", "", "", "", 
	         RowArr2( Counter ).N2_D280,
	         RowArr2( Counter ).N2_D290,
	         RowArr2( Counter ).N2_D300
	 );
		 Counter = Counter + 1;
     END;

  END;
  
  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;
  CurrentRow = 0;

  NR18_Form = DL_NR18_Panel();

  stat = NR18_Form.Run();

  if( stat )
      NR18_Report = DL_NR18_Report( null, "Report_NR_18.xls", null, IsWebService, ReportHashCode );
      NR18_Report.Run();

      Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  end;

  return FullReportFileNames;
END;
