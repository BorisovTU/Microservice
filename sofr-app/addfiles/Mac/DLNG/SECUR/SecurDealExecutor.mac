// SecurDealExecutor.mac

import "cblogger2.mac", oralib, SPInter;

class SecurDealExecutor
    private var logger:c_logger = LoggerFactory().NewItLog("SecurDealExecutor").GetLogger();

    private macro GetDealErrorMessage():string
        var sql = ExecSQLselect("select t_errormessage from doprdistaff_tmp where t_errorstatus not in (0)");

        var errorMessage:string = "";
        while(sql.MoveNext())
            errorMessage = errorMessage + sql.value("t_errormessage") + "\n";
        end;

        return errorMessage;

    Onerror()
        return "";
    end;

    macro RunDeal(dealId:integer, startDate:date):bool
        var isVerbose = false;
        var ErrCount = SP_ExecDeal(dealId, isVerbose, startDate);

        if (ErrCount > 0)
            logger.ErrorClob("error. dealid = " + dealId, GetDealErrorMessage());
            return false;
        end;

        return true;
    OnError(err)
        logger.ErrorClob("error. dealid = " + dealId, GetFullErrMsg(err));
        return false;
    end;
end;