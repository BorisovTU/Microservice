/*
$Name:        npreptax.mac
$Module:      Ценные бумаги
$Description: Отчет "Рассчитанные и удержанные налоги"
*/
import DPInter, "npreptax_form.mac","sprepfun.mac";
import cblogger;

PRIVATE CONST CL_STATE_RES    = "резидент",
              CL_STATE_NOTRES = "нерезидент";
PRIVATE const NPTXPARTTAXRATE_RESIDENT    = 0.09; //для резидентов
PRIVATE const NPTXPARTTAXRATE_NOTRESIDENT = 0.15; //для нерезидентов
PRIVATE const Max15 = 5000000;

PRIVATE VAR TableHeader = 
"┌─────────────────────────────────────────────────────────────┬─────────────────┬──────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬────────────────────────────────────────────────────────┐\n"+
"│                     Данные об инвесторе                     │Ставка           │                    Операция расчета НДФЛ                         │                 Доходы (нарастающим итогом с начала года)                 │Налог по данной операции расчета НДФЛ│   Налог нарастающим итогом за год   │      В том числе налог на материальную выгоду          │\n"+
"│                                                             │налогообложения  │                                                                  │                                                                           │                                     │                                     │                                                        │\n"+
"├──────────────────────────────┬──────────────────────────────┼────────┬────────┼──────────┬─────┬──────────────────────────────┬──────────────────┼──────────────────┬──────────────────┬──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┬──────────────────┤\n"+
"│          Инвестор            │            Статус            │общая   │по от-  │ Дата     │Нало-│        Тип расчета           │    Сумма вывода  │   не облагаемые  │ облагаемые по    │ материальная     │ облагаемые по    │    подлежащий    │     реально      │   рассчитанный   │    удержанный    │   рассчитанный   │    удержанный    │ подлежащий уплате│\n"+
"│                              │                              │        │дельным │ расчета  │говый│                              │                  │                  │ общей ставке     │ выгода           │ ставке 9 (15)%   │    удержанию     │     удержанный   │                  │                  │                  │                  │                  │\n"+
"│                              │                              │        │доходам │          │пери-│                              │                  │                  │ по 214 статье    │                  │                  │                  │                  │                  │                  │                  │                  │                  │\n"+
"│                              │                              │        │        │          │од   │                              │                  │                  │                  │                  │                  │                  │                  │                  │                  │                  │                  │                  │\n"+
"├──────────────────────────────┼──────────────────────────────┼────────┼────────┼──────────┼─────┼──────────────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤\n"+
"│              1               │              2               │   3    │   4    │    5     │  6  │              7               │         8        │         9        │        10        │        11        │        12        │        13        │        14        │        15        │        16        │        17        │        18        │        19        │\n"+
"├──────────────────────────────┼──────────────────────────────┼────────┼────────┼──────────┼─────┼──────────────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤";
                                                                                                                                                                                                             
PRIVATE VAR RepHeader   = 
"Отчет о доходах, удержанных и уплаченных налогах\n"+            
"за период с ##########      по   ##########\n"+
"Инвестор: ############################## \n\n";

PRIVATE CLASS (DL_CReportTemplate) Sp_npreptax_Report
  var m_BegDate, m_EndDate, m_ClientID, m_Nrec = 0, m_Year;
  var m_PrevClientID, m_Data, m_ClientStatus;
  var m_Dg, m_Ds, m_Dm, m_Dp;
  var m_TaxPaidGeneral, m_TaxPaidGeneralIIS, m_DivPaySec, m_PaidGeneral_15_1, m_TaxPaidSpecial, m_TaxPaidSpecialIIS;
  var m_TaxPaidMaterial, m_TaxCalculatedPaidTotal, m_TaxPaidTotal, m_TaxPaidTotal15, m_BaseSpecialDiv, m_BaseSpecialDiv15;
  var m_BaseGeneral, m_BaseBill, m_BaseG2, m_BaseG3, m_BaseG9, m_BaseG5;

  /*Отбираются операции расчета НОБ по НДФЛ и операции удержания НДФЛ по отобранным инвесторам за период с <D1> по <D2> из формы запуска, 
    причем операции удержания НДФЛ отбираются только те, где TaxYear операции = <T2> из формы запуска.*/

                // Операции расчета НОБ
  var m_query = "select q.Client, " +
                "       q.DocKind, " +
                "       q.SubKind_Operation, " +
                "       q.IIS, " +
                "       q.ShortName, " +
                "       q.t_LegalForm, " +
                "       q.OperID, " +
                "       q.OperDate, " +
                "       q.OutSum, " +
                "       q.OutCost, " +
                "       q.TaxCalculated, " +
                "       q.TaxPaid, " +
                "       q.Type " +
                " from ( " +
                //Операции расчета НОБ
                "         select nptxop.T_Client             Client,            "+
                "                nptxop.T_DocKind            DocKind,           "+
                "                nptxop.T_SubKind_Operation  SubKind_Operation, "+
                "                nptxop.T_IIS                IIS,               "+
                "                (party.t_ShortName || (case when nptxop.t_IIS = CHR(88) then ' ИИС' else '' end)) ShortName, "+
                "                party.T_LEGALFORM,          "+
                "                nptxop.t_ID OperID,         "+
                "                nptxop.t_OperDate OPERDATE, "+    
                "                0 OutSum, " + //"       nptxop.T_OutSum  OutSum,  "+
                "                0 OutCost, " + //"       nptxop.T_OutCost OutCost, "+
                "                0 TaxCalculated, "+
                "                0 TaxPaid, " +
                "                1 Type " +
                "         from dnptxop_dbt nptxop, " +
                "              dparty_dbt party "+
                "         where nptxop.T_CLIENT = case when ? != -1 then ? else nptxop.T_CLIENT end "+ //1, 2
                "           and nptxop.T_DOCKIND = " +string(DL_CALCNDFL) +
                "           and nptxop.t_SubKind_Operation in ( " + string(DL_TXBASECALC_OPTYPE_ENDYEAR) + ", " +
                                                                    string(DL_TXBASECALC_OPTYPE_NORMAL) + ", " +
                                                                    string(DL_TXBASECALC_OPTYPE_DIVIDEND) +
                                                             ") " +
                "           and nptxop.t_OperDate between ? and ? " + //3, 4
                "           and nptxop.t_Status > 0 " +
                "           and not exists( " +
                "                            select 1 " +
                "                            from ddppmobj_dbt dppmobj " +
                "                            where dppmobj.t_ObjKind = " + string(DL_CALCNDFL) +
                "                              and dppmobj.t_ObjID = nptxop.t_ID " +
                "                         ) " +
                "           and party.t_PartyID = nptxop.t_Client " +
                "         union all " +
                //Операции списания ц/б
                "         select dl_tick.t_ClientID Client, " +
                "                dl_tick.t_BOfficekind DocKind, " +
                "                dl_tick.t_DealType SubKind_Operation, " +
                "                ( " +
                "                   case " +
                "                      when RSI_NPTO.CheckContrIIS(dl_tick.t_ClientContrID) = 1 " +
                "                      then chr(88) " +
                "                      else chr(0) " +
                "                   end " +
                "                ) IIS, " +
                "                (party.t_ShortName || (case when rsi_npto.CheckContrIIS(dl_tick.t_ClientContrID) = 1 then ' ИИС' else '' end)) ShortName, " +
                "                party.T_LEGALFORM, " +
                "                dl_tick.t_DealID OperID, " +
                "                dl_tick.t_DealDate OperDate, " +
                "                0 OutSum, " +
                "                0 OutCost, " + 
                "                0 TaxCalculated, " +
                "                0 TaxPaid, " +
                "                2 Type " +
                "         from ddl_tick_dbt dl_tick, " +
                "              dparty_dbt party, " +
                "              dobjatcor_dbt objatcor " +
                "         where dl_tick.t_BOfficeKind = " + string(DL_AVRWRT) +
                "           and dl_tick.t_ClientID = case when ? <> -1 then ? else dl_tick.t_ClientID end " + //5, 6
                "           and RSB_SECUR.IsAvrWrtOut(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(dl_tick.t_DealType, dl_tick.t_BOfficeKind))) = 1 " +
                "           and dl_tick.t_DealDate between ? and ? " + //7, 8
                "           and objatcor.t_ObjectType = " + string(OBJTYPE_SECDEAL) +
                "           and objatcor.t_Object = LPAD(dl_tick.t_DealID, 34, '0') " +
                "           and objatcor.t_GroupID = 30 " +
                "           and objatcor.t_AttrID = 1 " +
                "           and party.t_PartyID = dl_tick.t_ClientID " +
                "         union all " +
                //Операции списания д/с
                "         select nptxop.t_Client Client, " +
                "                nptxop.t_DocKind DocKind, " +
                "                nptxop.t_SubKind_Operation SubKind_Operation, " +
                "                nptxop.t_IIS IIS, " +
                "                (party.t_ShortName || (case when nptxop.t_IIS = chr(88) then ' ИИС' else '' end)) ShortName, " +
                "                party.t_LegalForm, " +
                "                nptxop.t_ID OperID, " +
                "                nptxop.t_OperDate OperDate, " +
                "                nptxop.t_OutSum OutSum, " +
                "                nptxop.t_OutCost OutCost, " +
                "                nptxop.t_TaxSum TaxCalculated, " +
                "                0 TaxPaid, " + //Считается отдельно в функции TaxPaid
                "                3 Type " +
                "         from dnptxop_dbt nptxop, " +
                "              dparty_dbt party " +
                "         where nptxop.t_Client = case when ? <> -1 then ? else nptxop.t_Client end " + //9, 10
                "           and nptxop.t_DocKind = " + string(DL_WRTMONEY) +
                "           and nptxop.t_SubKind_Operation = " + string(DL_NPTXOP_WRTKIND_WRTOFF) +
                "           and nptxop.t_Status > 0 " +
                "           and nptxop.t_FlagTax = chr(88) " +
                "           and nptxop.t_OperDate between ? and ? " + //11, 12
                "           and party.t_PartyID = nptxop.t_Client " +
                "         union all " +
                //Операции удержания НДФЛ
                "         select nptxop.t_Client Client, " +
                "                nptxop.t_DocKind DocKind, " +
                "                nptxop.t_SubKind_Operation SubKind_Operation, " +
                "                nptxop.t_IIS IIS, " +
                "                (party.t_ShortName || (case when nptxop.t_IIS = chr(88) then ' ИИС' else '' end)) ShortName, " +
                "                party.t_LegalForm, " +
                "                nptxop.t_ID OperID, " +
                "                nptxop.t_OperDate OperDate, " +
                "                nptxop.t_OutSum OutSum, " +
                "                nptxop.t_OutCost OutCost, " +
                "                nptxop.t_TaxSum TaxCalculated, " +
                "                nptxop.t_Tax TaxPaid, " +
                "                4 Type " +
                "         from dnptxop_dbt nptxop, " +
                "              dparty_dbt party " +
                "         where nptxop.t_Client = case when ? <> -1 then ? else nptxop.t_Client end " + //13, 14
                "           and nptxop.t_DocKind = " + string(DL_HOLDNDFL) +
                "           and nptxop.t_Status > 0 " +
                "           and ( " +
                "                  nptxop.t_OperDate between ? and ? " + //15, 16
                "                  or extract(year from nptxop.t_PrevDate) = ? " + //17
                "               ) " +
                "           and not exists( " +
                "                            select 1 " +
                "                            from ddppmobj_dbt dppmobj " +
                "                            where dppmobj.t_ObjKind = " + string(DL_HOLDNDFL) +
                "                              and dppmobj.t_ObjID = nptxop.t_ID " +
                "                         ) " +
                "           and party.t_PartyID = nptxop.t_Client " +
                "         union all " +
                // НДР, созданные в операциях расчёта выплат по ц/б в депозитарии
                "         select q1.Client, " +
                "                q1.DocKind, " +
                "                q1.SubKind_Operation, " +
                "                q1.IIS, " +
                "                q1.ShortName, " +
                "                q1.LegalForm, " +
                "                q1.OperID, " +
                "                q1.OperDate, " +
                "                0 OutSum, " +
                "                0 OutCost, " +
                "                nvl(sum(q1.TaxCalculated), 0) TaxCalculated, " +
                "                nvl(sum(q1.TaxCalculated), 0) TaxPaid, " +
                "                5 Type " +
                "         from ( " +
                "                 select party.t_PartyID Client, " +
                "                        dpcorpop.t_DocKind DocKind, " +
                "                        dpcorpop.t_PaymentType SubKind_Operation, " +
                "                        chr(0) IIS, " +
                "                        party.t_ShortName ShortName, " +
                "                        party.t_LegalForm LegalForm, " +
                "                        dpcorpop.t_DocumentID OperID, " +
                "                        nptxobj.t_Date OperDate, " +
                "                        ( " +
                "                           case " +
                "                              when ( " +
                "                                      ( " +
                "                                         nptxobj.t_Kind in ( " + string(TXOBJ_DIVPAY_SEC) + ", " +
                                                                                  string(TXOBJ_PAIDGENERAL_15_1) +
                                                                           ") " +
                "                                         and dpcorpop.t_PaymentType = " + string(DP_CRPPAYMENTTYPE_DIVIDENDS) +
                "                                      ) " +
                "                                      or ( " +
                "                                            nptxobj.t_Kind in ( " + string(TXOBJ_PAIDGENERAL) + ", " +
                                                                                     string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                                     string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                                     string(TXOBJ_PAIDSPECIAL_IIS) +
                                                                              ") " +
                "                                            and dpcorpop.t_PaymentType = " + string(DP_CRPPAYMENTTYPE_COUPON) +
                "                                         ) " +
                "                                   ) " +
                "                              then nptxobj.t_Sum0 " +
                "                              else 0 " +
                "                           end " +
                "                        ) TaxCalculated " +
                "                 from ddppmacc_dbt dppmacc, " +
                "                      ddpcorpop_dbt dpcorpop, " +
                "                      dparty_dbt party, " +
                "                      dnptxobj_dbt nptxobj, " +
                "                      ddppmobj_dbt dppmobj " +
                "                 where nptxobj.t_Client = case when ? <> -1 then ? else nptxobj.t_Client end " + //18, 19
                "                   and nptxobj.t_Kind in ( " + string(TXOBJ_DIVPAY_SEC) + ", " +
                                                                string(TXOBJ_DIVPAY_SEC_0) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_1_0) + ", " +
                                                                string(TXOBJ_PAIDGENERAL) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_0) + ", " +
                                                                string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                string(TXOBJ_PAIDBILL) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                string(TXOBJ_PAIDSPECIAL_0) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_IIS) + ", " +
                                                                string(TXOBJ_PAIDSPECIAL_IIS) +
                                                         ") " +
                "                   and nptxobj.t_Date between ? and ? " + //20, 21
                "                   and dppmobj.t_ObjID = nptxobj.t_ObjID " +
                "                   and dppmobj.t_ObjKind = " + string(OBJTYPE_NPTXOBJ) +
                "                   and dppmacc.t_ID = dppmobj.t_PmAccID " +
                "                   and dpcorpop.t_DocumentID = dppmacc.t_DocumentID " +
                "                   and party.t_PartyID = nptxobj.t_Client " +
                "              ) q1 " +
                "         group by q1.LegalForm, q1.Client, q1.ShortName, q1.IIS, q1.DocKind, q1.SubKind_Operation, q1.OperDate, q1.OperID " +
                // НДР, созданные в операциях расчета НОБ и удержания НДФЛ, выполненных безынтерфейсно в операциях расчета выплат по ц/б в депозитарии
                "         union all " +
                "         select q2.Client, " +
                "                q2.DocKind, " +
                "                q2.SubKind_Operation, " +
                "                q2.IIS, " +
                "                q2.ShortName, " +
                "                q2.LegalForm, " +
                "                q2.OperID, " +
                "                q2.OperDate, " +
                "                0 OutSum, " +
                "                0 OutCost, " +
                "                nvl(sum(q2.TaxCalculated), 0) TaxCalculated, " +
                "                nvl(sum(q2.TaxPaid), 0) TaxPaid, " +
                "                6 Type " +
                "         from ( " +
                "                 select party.t_PartyID Client, " +
                "                        dpcorpop.t_DocKind DocKind, " +
                "                        dpcorpop.t_PaymentType SubKind_Operation, " +
                "                        nptxop.t_IIS IIS, " +
                "                        (party.t_ShortName || (case when nptxop.t_IIS = chr(88) then ' ИИС' else '' end)) ShortName, " +
                "                        party.t_LegalForm LegalForm, " +
                "                        dpcorpop.t_DocumentID OperID, " +
                "                        nptxobj.t_Date OperDate, " +
                "                        ( " +
                "                           case " +
                "                              when nptxobj.t_Kind in ( " + string(TXOBJ_PAIDGENERAL) + ", " +
                                                                            string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                            string(TXOBJ_PAIDBILL) + ", " +
                                                                            string(TXOBJ_PAIDGENERAL) + ", " +
                                                                            string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                            string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                            string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                            string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                            string(TXOBJ_PAIDGENERAL_15_IIS) + ", " +
                                                                            string(TXOBJ_PAIDSPECIAL_IIS) +
                                                                     ") " +
                "                              then nptxobj.t_Sum0 " +
                "                              else 0 " +
                "                           end " +
                "                        ) TaxCalculated, " +
                "                        nptxobj.t_Sum0 TaxPaid " +
                "                 from dparty_dbt party, " +
                "                      ddpcorpop_dbt dpcorpop, " +
                "                      ddppmacc_dbt dppmacc, " +
                "                      dnptxop_dbt nptxop, " +
                "                      dnptxobj_dbt nptxobj, " +
                "                      dnptxobdc_dbt nptxobdc, " +
                "                      ddppmobj_dbt dppmobj " +
                "                 where nptxobj.t_Client = case when ? <> -1 then ? else nptxobj.t_Client end " + //22, 23
                "                   and nptxobj.t_Kind in ( " + string(TXOBJ_DIVPAY_SEC) + ", " +
                                                                string(TXOBJ_DIVPAY_SEC_0) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_1_0) + ", " +
                                                                string(TXOBJ_PAIDGENERAL) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_0) + ", " +
                                                                string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                string(TXOBJ_PAIDBILL) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                string(TXOBJ_PAIDSPECIAL_0) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_IIS) + ", " +
                                                                string(TXOBJ_PAIDSPECIAL_IIS) +
                                                         ") " +
                "                   and nptxobj.t_Date between ? and ? " + //24, 25
                "                   and nptxobdc.t_ObjID = nptxobj.t_ObjID " +
                "                   and nptxop.t_ID = nptxobdc.t_DocID " +
                "                   and nptxop.t_DocKind in ( " + string(DL_CALCNDFL) + ", " +
                                                                  string(DL_HOLDNDFL) +
                                                           ") " +
                "                   and nptxop.t_Status > 0 " +
                "                   and dppmobj.t_ObjID = nptxop.t_ID " +
                "                   and dppmobj.t_ObjKind in ( " + string(DL_CALCNDFL) + ", " +
                                                                   string(DL_HOLDNDFL) +
                                                            ") " +
                "                   and dppmacc.t_ID = dppmobj.t_PmAccID " +
                "                   and dpcorpop.t_DocumentID = dppmacc.t_DocumentID " +
                "                   and party.t_PartyID = dppmacc.t_HolderID " +
                "              ) q2 " +
                "         group by q2.LegalForm, q2.Client, q2.ShortName, q2.IIS, q2.DocKind, q2.SubKind_Operation, q2.OperDate, q2.OperID " +
                //Операции погашения ОЭБ
                "         union all " +
                "         select q3.Client, " +
                "                q3.DocKind, " +
                "                q3.SubKind_Operation, " +
                "                q3.IIS, " +
                "                case " +
                "                   when q3.IIS = chr(0) " +
                "                   then q3.ShortName " +
                "                   else q3.ShortName || ' ИИС' " +
                "                end ShortName, " +
                "                q3.LegalForm, " +
                "                q3.OperID, " +
                "                q3.OperDate, " +
                "                0 OutSum, " +
                "                0 OutCost, " +
                "                nvl(sum(q3.TaxCalculated), 0) TaxCalculated, " +
                "                nvl(sum(q3.TaxCalculated), 0) TaxPaid, " +
                "                7 Type " +
                "         from ( " +
                "                 select tx.t_FactReceiverID Client, " +
                "                        dl_tick.t_BOfficeKind DocKind, " +
                "                        dl_tick.t_DealType SubKind_Operation, " +
                "                        ( " +
                "                           case " +
                "                              when exists( " +
                "                                            select 1 " +
                "                                            from dsfcontr_dbt sfcontr " +
                "                                            where sfcontr.t_ServKind = " + string(PTSK_STOCKDL) +
                "                                              and sfcontr.t_PartyID = sh.t_OwnerID " +
                "                                              and sfcontr.t_DateBegin <= dl_tick.t_DealDate " +
                "                                              and ( " +
                "                                                     sfcontr.t_DateClose > dl_tick.t_DealDate " +
                "                                                     or sfcontr.t_DateClose = to_date('01.01.0001', 'dd.mm.yyyy') " +
                "                                                  ) " +
                "                                              and rsi_npto.CheckContrIIS(sfcontr.t_ID) = 0 " +
                "                                         ) " +
                "                              then chr(0) " +
                "                              else chr(88) " +
                "                           end " +
                "                        ) IIS, " +
                "                        party.t_ShortName ShortName, " +
                "                        party.t_LegalForm LegalForm, " +
                "                        dl_tick.t_DealID OperID, " +
                "                        nptxobj.t_Date OperDate, " +
                "                        nptxobj.t_Sum0 TaxCalculated " +
                "                 from ddl_tick_dbt dl_tick, " +
                "                      dparty_dbt party, " +
                "                      dscownlist_dbt ls, " +
                "                      dscownhist_dbt sh, " +
                "                      dnptxobj_dbt nptxobj, " +
                "                      dnptxobdc_dbt obdc, " +
                "                      doproper_dbt oproper, " +
                "                      dscowntax_dbt tx " +
                "                 where nptxobj.t_Client = case when ? <> -1 then ? else nptxobj.t_Client end " + //26, 27
                "                   and nptxobj.t_Date between ? and ? " + //28, 29
                "                   and ( " +
                "                          ( " +
                "                             exists( " +
                "                                      select 1 " +
                "                                      from dsfcontr_dbt sfcontr " +
                "                                      where sfcontr.t_ServKind = " + string(PTSK_STOCKDL) +
                "                                        and sfcontr.t_PartyID = sh.t_OwnerID " +
                "                                        and sfcontr.t_DateBegin <= dl_tick.t_DealDate " +
                "                                        and ( " +
                "                                               sfcontr.t_DateClose > dl_tick.t_DealDate " +
                "                                               or sfcontr.t_DateClose = to_date('01.01.0001', 'dd.mm.yyyy') " +
                "                                            ) " +
                "                                        and rsi_npto.CheckContrIIS(sfcontr.t_ID) = 0 " +
                "                                   ) " +
                "                             and nptxobj.t_Kind in ( " + string(TXOBJ_PAIDGENERAL) + ", " +
                                                                          string(TXOBJ_PAIDGENERAL_15_2) +
                                                                   ") " +
                "                          ) " +
                "                          or nptxobj.t_Kind in ( " + string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                      string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                               ") " +
                "                       ) " +
                "                   and nptxobj.t_Client = tx.t_FactReceiverID " +
                "                   and obdc.t_ObjID = nptxobj.t_ObjID " +
                "                   and oproper.t_ID_Operation = obdc.t_DocID " +
                "                   and oproper.t_DocKind = " + string(DL_RETIREMENT_OWN) +
                "                   and dl_tick.t_DealID = to_number(oproper.t_DocumentID) " +
                "                   and ls.t_FIID = dl_tick.t_PFI " +
                "                   and ls.t_Number_Coupon = dl_tick.t_Number_Coupon " +
                "                   and sh.t_ListID = ls.t_ListID " +
                "                   and tx.t_SHID = sh.t_ID " +
                "                   and ( " +
                "                          tx.t_TaxSum > 0 " +
                "                          or tx.t_TaxSum15 > 0 " +
                "                       ) " +
                "                   and party.t_PartyID = nptxobj.t_Client " +
                "              ) q3 " +
                "         group by q3.LegalForm, q3.Client, q3.ShortName, q3.IIS, q3.DocKind, q3.SubKind_Operation, q3.OperDate, q3.OperID " +
                "         union all " +
                //Операции возврата дивидендов
                "         select q4.Client, " +
                "                q4.DocKind, " +
                "                q4.SubKind_Operation, " +
                "                q4.IIS, " +
                "                ( " +
                "                   case " +
                "                      when q4.IIS = chr(0) " +
                "                      then q4.ShortName " +
                "                      else q4.ShortName || ' ИИС' " +
                "                   end " +
                "                ) ShortName, " +
                "                q4.LegalForm, " +
                "                q4.OperID, " +
                "                q4.OperDate, " +
                "                0 OutSum, " +
                "                0 OutCost, " +
                "                nvl(sum(q4.TaxCalculated), 0) TaxCalculated, " +
                "                nvl(sum(q4.TaxCalculated), 0) TaxPaid, " +
                "                8 Type " +
                "         from ( " +
                "                 select nptxobj.t_Client Client, " +
                "                        dl_tick.t_BOfficeKind DocKind, " +
                "                        dl_tick.t_DealType SubKind_Operation, " +
                "                        ( " +
                "                           case " +
                "                              when rsi_npto.CheckContrIIS(dl_tick.t_ClientContrID) = 0 " +
                "                              then chr(0) " +
                "                              else chr(88) " +
                "                           end " +
                "                        ) IIS, " +
                "                        party.t_ShortName ShortName, " +
                "                        party.t_LegalForm LegalForm, " +
                "                        dl_tick.t_DealID OperID, " +
                "                        nptxobj.t_Date OperDate, " +
                "                        nptxobj.t_Sum0 TaxCalculated " +
                "                 from ddl_tick_dbt dl_tick, " +
                "                      dparty_dbt party, " +
                "                      dnptxobj_dbt nptxobj, " +
                "                      dnptxobdc_dbt obdc, " +
                "                      doproper_dbt oproper " +
                "                 where nptxobj.t_Kind in ( " + string(TXOBJ_DIVPAY_SEC) + ", " +
                                                                string(TXOBJ_PAIDGENERAL_15_1) +
                                                         ") " +
                "                   and nptxobj.t_Client = case when ? <> -1 then ? else nptxobj.t_Client end " + //30, 31
                "                   and nptxobj.t_Date between ? and ? " + //32, 33
                "                   and obdc.t_ObjID = nptxobj.t_ObjID " +
                "                   and oproper.t_ID_Operation = obdc.t_DocID " +
                "                   and LPAD(dl_tick.t_DealID, 34) = oproper.t_DocumentID " +
                "                   and dl_tick.t_BOfficeKind = " + string(DL_RETURN_DIVIDEND) +
                "                   AND party.t_PartyID = nptxobj.t_Client " +
                "              ) q4 " +
                "         group by q4.LegalForm, q4.Client, q4.ShortName, q4.IIS, q4.DocKind, q4.SubKind_Operation, q4.OperDate, q4.OperID " +
                /*Добавляя операции с векселями*/
                "         UNION ALL "+
                

                "         select q5.Client, " +
                "                q5.DocKind, " +
                "                q5.SubKind_Operation, " +
                "                q5.IIS, " +
                "                q5.ShortName, " +
                "                q5.LegalForm, " +
                "                q5.OperID, " +
                "                q5.OperDate, " +
                "                0 OutSum, " +
                "                0 OutCost, " +
                "                nvl(sum(q5.TaxCalculated), 0) TaxCalculated, " +
                "                0 TaxPaid, " +
                "                9 Type " +
                "         from ( " +
                "                 select distinct nptxobj.t_Client Client, "+
                "                        oper.t_DocKind DocKind, "+
                "                        -1 SubKind_Operation, "+
                "                        DECODE( RSI_NPTO.CheckObjIIS(nptxobj.t_AnaliticKind6, nptxobj.t_Analitic6), 1, 'X', 0) IIS, "+
                "                        (party.t_ShortName ||( case when DECODE( RSI_NPTO.CheckObjIIS(nptxobj.t_AnaliticKind6, nptxobj.t_Analitic6), 1, 'X', 0) = CHR(88) then ' ИИС' else '' end)) ShortName, "+ 
                "                        party.t_LegalForm LegalForm, "+
                "                        oper.t_ID_Operation  OperID, "+
                "                        nptxobj.t_Date OPERDATE, "+
                "                        nptxobj.t_Sum0 TaxCalculated " +
                "                 from dnptxobj_dbt nptxobj, " +
                "                      dnptxobdc_dbt lnk, " +
                "                      doproper_dbt oper, " +
                "                      dparty_dbt party "+
                "                 where nptxobj.t_kind = " + TXOBJ_PAIDBILL +
                "                   and nptxobj.t_AnaliticKind1 in ( 1130, 1115, 1120, 1125 ) "+
                "                   and nptxobj.t_ObjID = lnk.t_ObjID      "+
                "                   and oper.t_ID_Operation = lnk.t_DocID  "+
                "                   and nptxobj.t_client = party.t_PartyID "+
                "                   and nptxobj.t_Date between ? and ? "+ //34, 35
                "                   and nptxobj.t_client = case when ? != -1 then ? else nptxobj.t_client end "+ //36, 37
                "                   and party.t_PartyID = nptxobj.t_Client " +
                "              ) q5 " +
                "         group by q5.LegalForm, q5.Client, q5.ShortName, q5.IIS, q5.DocKind, q5.SubKind_Operation, q5.OperDate, q5.OperID " +
                "      ) q " +
                " order by q.ShortName, q.OperDate, q.Type ";

  PRIVATE MACRO BeginReport()
    m_BegDate  = m_Form.GetFieldValue( PNFLD_NPREPTAX_BEGDATE );
    m_EndDate  = m_Form.GetFieldValue( PNFLD_NPREPTAX_ENDDATE );
    m_ClientID = m_Form.GetFieldValue( PNFLD_NPREPTAX_INVERSTORCODE );
    m_Year     = m_Form.GetFieldValue( PNFLD_NPREPTAX_YEAR );
  END;

  MACRO PrintMode():INTEGER
    return m_Form.GetFieldValue( PNFLD_NPREPTAX_PRINTMETHOD );
  END;

  PRIVATE MACRO GetTotalSumFormula(Col)
     var Formula = "";
     if(m_Nrec)
        Formula = "=SUM("+Col+"10:"+Col+trim(string(10+m_Nrec))+")";
     end;
     return Formula;	
  END;

  PRIVATE MACRO GetSubTotalFormula(Col)
     var Formula = "";
     if(m_Nrec)
        Formula = "=SUBTOTAL(9;'НалогиДоходы'!$"+Col+"10:$"+Col+trim(string(9+m_Nrec))+")";
     end;
     return Formula;	
  END;

  PRIVATE MACRO PrintRepHeader()
     PrintFormatString( RepHeader, "H0_1", m_BegDate,
                                   "H0_2", m_EndDate,
                                   "Year", m_Year,
                                   "H0_3", this.InvestorName(),
                                   "H_SumOut", GetTotalSumFormula("G"),
                                   "H_TaxSpecial0", GetSubTotalFormula("H"), 
                                   "H_Div", GetSubTotalFormula("M"),
                                   "H_Div15", GetSubTotalFormula("N")
                      );
     CopyAllSheetInTotalBook( null, false, "N1_TableHeader" );
  END;

  PRIVATE MACRO RegistrTable()
     RegisterTable( "MainTable", TableHeader,
                    "Client",
                    "ClientStatus",       
                    "RateGeneral",       
                    "RateSpecial",         
                    "OperDate",
                    "Type",
                    "SumOut",
                    "TaxSpecial0",
                    "TaxGeneral",
                    "TaxMaterial",
                    "TaxSpecial",
                    "TaxGeneral15",
                    "Div",
                    "_Div15",
                    "TaxCalculated",
                    "TaxPaid",
                    "TaxTotal",
                    "TaxTotal15",
                    "TaxPaidTotal",
                    "TaxPaidTotal15",
                    "TaxToPay"
                  );

/*     SetCellAutoSumma( "Всего", 
                       "SumOut", "TaxCalculated", "TaxPaid" );

     PrintTableLine( "Client", "Всего", null, "P8", "<P8>", null );
     PrintTableLine( "Client", "В том числе", null );*/
  END;

  MACRO ПечататьПромежуточныеИтоги()
     
/*     SetSubtotal(10, 7 + MAXROWSHEET,
                  "H4",             
                  "M4",           
                  "N4"
                );*/
  END;

  PRIVATE MACRO PrintLineNpOp()

    PrintTableLine(  "Client",           this.Client(),           null,
                     "ClientStatus",     this.ClientStatus(),     null,      
                     "RateGeneral",      this.RateGeneral(),      null,   
                     "RateSpecial",      this.RateSpecial(),      null,
                     "OperDate",         string(this.OperDate():f), null,
                     "Type",             this.Type(),             null,
                     "SumOut",           this.SumOut(),           null,
                     "TaxSpecial0",      this.TaxSpecial0(),      null,
                     "TaxGeneral",       this.TaxGeneral(),       null,
                     "TaxMaterial",      this.TaxMaterial(),      null,
                     "TaxSpecial",       this.TaxSpecial(),       null,
                     "TaxGeneral15",     this.TaxGeneral15(),     null,
                     "Div",              this.Div(),              null,
                     "_Div15",            this.Div15(),            null,
                     "TaxCalculated",    this.TaxCalculated(),    null,
                     "TaxPaid",          this.TaxPaid(),          null,
                     "TaxTotal",         this.TaxTotal(),         null,
                     "TaxTotal15",       this.TaxTotal15(),       null,
                     "TaxPaidTotal",     this.TaxPaidTotal(),     null,
                     "TaxPaidTotal15",   this.TaxPaidTotal15(),   null,
                     "TaxToPay",         this.TaxToPay(),         null
                  );

  END;

  PRIVATE MACRO PrintLineNoOp()

    PrintTableLine(  "Client",           "",       null,
                     "ClientStatus",     "",       null,      
                     "RateGeneral",      "",       null,   
                     "RateSpecial",      "",       null,
                     "OperDate",         ZeroDate, null,
                     "Type",             "",       null,
                     "SumOut",           $0,       null,
                     "TaxSpecial0",      $0,       null,
                     "TaxGeneral",       $0,       null,
                     "TaxMaterial",      $0,       null,
                     "TaxSpecial",       $0,       null,
                     "TaxGeneral15",     $0,       null,
                     "Div",              $0,       null,
                     "_Div15",            $0,       null,
                     "TaxCalculated",    $0,       null,
                     "TaxPaid",          $0,       null,
                     "TaxTotal",         $0,       null,
                     "TaxTotal15",       $0,       null,
                     "TaxPaidTotal",     $0,       null,
                     "TaxPaidTotal15",   $0,       null,
                     "TaxToPay",         $0,       null
                  );

  END;

  PRIVATE MACRO EndReport()
  END;

  MACRO Clear()
     m_Dg = null;
     m_Ds = null;
     m_Dm = null;
     m_Dp = null;
     m_TaxPaidGeneral = null;
     m_TaxPaidGeneralIIS = null;
     m_DivPaySec = null;
     m_PaidGeneral_15_1 = null;
     m_TaxPaidSpecial = null;
     m_TaxPaidSpecialIIS = null;
     m_TaxPaidMaterial = null;
     m_TaxCalculatedPaidTotal = null;
     m_TaxPaidTotal = null;
     m_TaxPaidTotal15 = null;
     m_BaseSpecialDiv = null;
     m_BaseSpecialDiv15 = null;
     m_BaseG2 = null;
     m_BaseG3 = null;
     m_BaseG9 = null;
     m_BaseG5 = null;
  END;

  PRIVATE MACRO SavePart()
    LogIt("SavePart()"); 
    EndTable();
    LogIt("GetTableRange()="+GetTableRange()); 
    CopyAllSheetInTotalBook( null, false, GetTableRange() );      
    RegistrTable();
  END;

  PRIVATE MACRO ExecuteReport()
    var Num = 0;
    var Query, Sql;

    Sql = RSDCommand(m_Query);

    Sql.addParam("", RSDBP_IN, m_ClientID); //1
    Sql.addParam("", RSDBP_IN, m_ClientID); //2
    Sql.addParam("", RSDBP_IN, m_BegDate); //3
    Sql.addParam("", RSDBP_IN, m_EndDate); //4
    Sql.addParam("", RSDBP_IN, m_ClientID); //5
    Sql.addParam("", RSDBP_IN, m_ClientID); //6
    Sql.addParam("", RSDBP_IN, m_BegDate); //7
    Sql.addParam("", RSDBP_IN, m_EndDate); //8
    Sql.addParam("", RSDBP_IN, m_ClientID); //9
    Sql.addParam("", RSDBP_IN, m_ClientID); //10
    Sql.addParam("", RSDBP_IN, m_BegDate); //11
    Sql.addParam("", RSDBP_IN, m_EndDate); //12
    Sql.addParam("", RSDBP_IN, m_ClientID); //13
    Sql.addParam("", RSDBP_IN, m_ClientID); //14
    Sql.addParam("", RSDBP_IN, m_BegDate); //15
    Sql.addParam("", RSDBP_IN, m_EndDate); //16
    Sql.addParam("", RSDBP_IN, m_Year); //17
    Sql.addParam("", RSDBP_IN, m_ClientID); //18
    Sql.addParam("", RSDBP_IN, m_ClientID); //19
    Sql.addParam("", RSDBP_IN, m_BegDate); //20
    Sql.addParam("", RSDBP_IN, m_EndDate); //21
    Sql.addParam("", RSDBP_IN, m_ClientID); //22
    Sql.addParam("", RSDBP_IN, m_ClientID); //23
    Sql.addParam("", RSDBP_IN, m_BegDate); //24
    Sql.addParam("", RSDBP_IN, m_EndDate); //25
    Sql.addParam("", RSDBP_IN, m_ClientID); //26
    Sql.addParam("", RSDBP_IN, m_ClientID); //27
    Sql.addParam("", RSDBP_IN, m_BegDate); //28
    Sql.addParam("", RSDBP_IN, m_EndDate); //29
    Sql.addParam("", RSDBP_IN, m_ClientID); //30
    Sql.addParam("", RSDBP_IN, m_ClientID); //31
    Sql.addParam("", RSDBP_IN, m_BegDate); //32
    Sql.addParam("", RSDBP_IN, m_EndDate); //33
    Sql.addParam("", RSDBP_IN, m_BegDate); //34
    Sql.addParam("", RSDBP_IN, m_EndDate); //35
    Sql.addParam("", RSDBP_IN, m_ClientID); //36
    Sql.addParam("", RSDBP_IN, m_ClientID); //37

    LogIt(Sql.cmdText);
    Sql.execute();
    
    m_Data = TRsbDataSet(Sql);

    InitProgress( m_Nrec, "Рассчитанные и удержанные налоги ", "Просмотр операций расчета НДФЛ" );

    if( m_Nrec )
       Dl_CallInsertStat(PrintMode());
       PrintRepHeader();
       RegistrTable();
    end;

    LogIt("Начало обработки данных, m_Nrec="+string(m_Nrec));

    while( m_Data.MoveNext() )

       Clear();

       if( m_PrevClientID != m_Data.Client )
          m_PrevClientID == m_Data.Client;
          m_ClientStatus = null;
       end;

       PrintLineNpOp();
       UseProgress( Num = Num + 1 );

       if(mod(Num, 1000) == 0) 
          LogIt("Обработано "+string(Num)+" записей (из "+string(m_Nrec)+")");
          SavePart();
       end;

    end;
    LogIt("Завершение обработки данных, m_Nrec="+string(m_Nrec));
    RemProgress();

    SavePart();

    LogIt("AddStandardFooter()");
    AddStandardFooter();
    CopyAllSheetInTotalBook( null, false, "N1_Footer" );

  END;

  PRIVATE MACRO GetDataForRep()
    var NRec, NRecData;

    m_Nrec = 0;

    NRec = RSDCommand("select count(1) nRecs from(" + m_Query + ")");;

    NRec.addParam("", RSDBP_IN, m_ClientID); //1
    NRec.addParam("", RSDBP_IN, m_ClientID); //2
    NRec.addParam("", RSDBP_IN, m_BegDate); //3
    NRec.addParam("", RSDBP_IN, m_EndDate); //4
    NRec.addParam("", RSDBP_IN, m_ClientID); //5
    NRec.addParam("", RSDBP_IN, m_ClientID); //6
    NRec.addParam("", RSDBP_IN, m_BegDate); //7
    NRec.addParam("", RSDBP_IN, m_EndDate); //8
    NRec.addParam("", RSDBP_IN, m_ClientID); //9
    NRec.addParam("", RSDBP_IN, m_ClientID); //10
    NRec.addParam("", RSDBP_IN, m_BegDate); //11
    NRec.addParam("", RSDBP_IN, m_EndDate); //12
    NRec.addParam("", RSDBP_IN, m_ClientID); //13
    NRec.addParam("", RSDBP_IN, m_ClientID); //14
    NRec.addParam("", RSDBP_IN, m_BegDate); //15
    NRec.addParam("", RSDBP_IN, m_EndDate); //16
    NRec.addParam("", RSDBP_IN, m_Year); //17
    NRec.addParam("", RSDBP_IN, m_ClientID); //18
    NRec.addParam("", RSDBP_IN, m_ClientID); //19
    NRec.addParam("", RSDBP_IN, m_BegDate); //20
    NRec.addParam("", RSDBP_IN, m_EndDate); //21
    NRec.addParam("", RSDBP_IN, m_ClientID); //22
    NRec.addParam("", RSDBP_IN, m_ClientID); //23
    NRec.addParam("", RSDBP_IN, m_BegDate); //24
    NRec.addParam("", RSDBP_IN, m_EndDate); //25
    NRec.addParam("", RSDBP_IN, m_ClientID); //26
    NRec.addParam("", RSDBP_IN, m_ClientID); //27
    NRec.addParam("", RSDBP_IN, m_BegDate); //28
    NRec.addParam("", RSDBP_IN, m_EndDate); //29
    NRec.addParam("", RSDBP_IN, m_ClientID); //30
    NRec.addParam("", RSDBP_IN, m_ClientID); //31
    NRec.addParam("", RSDBP_IN, m_BegDate); //32
    NRec.addParam("", RSDBP_IN, m_EndDate); //33
    NRec.addParam("", RSDBP_IN, m_BegDate); //34
    NRec.addParam("", RSDBP_IN, m_EndDate); //35
    NRec.addParam("", RSDBP_IN, m_ClientID); //36
    NRec.addParam("", RSDBP_IN, m_ClientID); //37
    
    LogIt("Get m_Nrec");
    NRec.execute();

    NRecData = TRsbDataSet(NRec);

    if( NRecData.MoveNext() )
       m_Nrec = int(NRecData.nRecs);
    end;

    LogIt("m_Nrec="+string(m_Nrec));

    return m_Nrec;
  END;

  PRIVATE MACRO Create()
     CreateTotalBook();
     SetActiveSheet( "НалогиДоходы" );
     if( GetDataForRep() )
        ExecuteReport();
     else
     /*если данных вообще нет*/
        PrintRepHeader(0);
        RegistrTable();
        PrintLineNoOp();
        EndTable();
        ПечататьПромежуточныеИтоги();
        AddStandardFooter();
     end;
     LogIt("SaveTotalBook()");
     SaveTotalBook();
  END;

  MACRO KindIIS():integer
     return IIF(m_Data.IIS == "X", 1, 0);
  END;

  MACRO InvestorName():string
     if( m_ClientID == -1 )
        return STR_ALLVALUE;
     end;

     var v_ClientRec = TRecHandler( "party.dbt" );
     if( not ПолучитьСубъекта(m_ClientID,v_ClientRec) )
        return v_ClientRec.rec.ShortName;
     end;
     return "";
  END;

  MACRO Client():string
     return m_Data.ShortName;
  END;

  MACRO OperDate():date
     return SQL_ConvTypeDate(m_Data.OperDate);
  END;

  MACRO ClientStatus():string
     var NumInList = "";

     if( m_ClientStatus == null )
        m_ClientStatus = "";
        var v_ClientRec = TRecHandler("party.dbt");
        if( not ПолучитьСубъекта(m_Data.Client,v_ClientRec) AND 
            GetMainObjAttr( null, OBJTYPE_PARTY, UniID(v_ClientRec, OBJTYPE_PARTY), 42/*Является плательщиком НДФЛ*/, null, null, NumInList, OperDate()))
          if( NumInList == "1" )
             m_ClientStatus = CL_STATE_RES;
          else
             m_ClientStatus = CL_STATE_NOTRES;
          end;
        end;
       
        if( (m_ClientStatus == "") and (v_ClientRec.rec.PartyID > 0) )
          if(v_ClientRec.rec.NotResident == SET_CHAR)
             m_ClientStatus = CL_STATE_NOTRES; //для нерезидента
          else
             m_ClientStatus = CL_STATE_RES; //для резидента
          end;
        end;
     end;

     return m_ClientStatus;
  END;

  MACRO RateGeneral():money
     if( this.ClientStatus() == CL_STATE_RES )
        return NPTXGENTAXRATE_RESIDENT;
     elif( this.ClientStatus() == CL_STATE_NOTRES )
        var _stat = 1;
        var _TaxRate;
        if (m_EndDate != NULL)
          _stat = ПолучитьЗначениеПримечанияНаДату(m_ClientID, PARTY_NOTE_KIND_NPTX_RATE_NOTRES, m_EndDate, @_TaxRate);
        end;
        if (_stat != 0)
          _TaxRate = NPTXGENTAXRATE_NOTRESIDENT; //для нерезидента
        elif ( _TaxRate != NULL )          
          _TaxRate = _TaxRate / 100; //примечание вернёт целое число процентов, а нужен коэффициент
        end;
     
        return _TaxRate;
     end;
     return 0;
  END;

  MACRO RateSpecial():money
     if( this.ClientStatus() == CL_STATE_RES )
        return NPTXPARTTAXRATE_RESIDENT;
     elif( this.ClientStatus() == CL_STATE_NOTRES )
        var _stat = 1;
        var _TaxRate;
        if (m_EndDate != NULL)
          _stat = ПолучитьЗначениеПримечанияНаДату(m_ClientID, 57, OperDate(), @_TaxRate);
        end;
        if (_stat != 0)
          _TaxRate = NPTXPARTTAXRATE_NOTRESIDENT; //для нерезидента     
        elif ( _TaxRate != NULL )          
          _TaxRate = _TaxRate / 100; //примечание вернёт целое число процентов, а нужен коэффициент          
        end;     
        return _TaxRate;     
     end;
     return 0;
  END;

  MACRO Rp()
     if(ClientStatus() == CL_STATE_RES)
        return 0.15;
     end;

     return 0;
  END;

  MACRO Year():integer
     return m_Year;
  END;

  MACRO Dbeg():date
    return IIF(m_Data.IIS == "X", GetFirstDateIIS(m_Data.Client),Date(1,1,m_Year));
  END;

  MACRO Dend():date
     return min(this.OperDate(),DATE(31,12,m_Year));
  END;

  MACRO Type():string
     if( m_Data.DocKind == DL_CALCNDFL )
        return "расчет " + DL_GetNameAlg(7337,m_Data.SUBKIND_OPERATION);
     elif( m_Data.DocKind == DL_HOLDNDFL )
        return "удержание " + DL_GetNameAlg(7332,m_Data.SUBKIND_OPERATION);
     elif( (m_Data.DocKind == DL_VEKSELDRAWORDER)    or//погашение сюда же входит выкуп
           (m_Data.DocKind == DL_VSBARTERORDER)      or//мена
           (m_Data.DocKind == DL_VSINTERCHANGE)        //зачет взаимных требований           
         )
         return "Доход по векселям";
     elif(m_Data.DocKind == DL_WRTMONEY)
         return "Вывод д/с";
     elif(m_Data.DocKind == DL_AVRWRT)
         return "Вывод ц/б";
     elif(m_Data.DocKind == DL_RETIREMENT_OWN)
         return "Доход по ОЭБ";
     elif(m_Data.DocKind == DL_RETURN_DIVIDEND)
         return "Дивиденды в РЕПО";
     elif(m_Data.DocKind == 870)
         return DL_GetNameAlg(3258,m_Data.SUBKIND_OPERATION) + " в депозитарии";
     end;

     return "";
  END;
  /*Сумма вывода*/
  MACRO SumOut():money
     if( m_Data.DocKind == DL_HOLDNDFL )
        if( m_Data.SUBKIND_OPERATION == DL_TXHOLD_OPTYPE_OUTMONEY )
           return m_Data.OutSum;
        elif( m_Data.SUBKIND_OPERATION == DL_TXHOLD_OPTYPE_OUTAVOIR )
           return m_Data.OutCost;
        end;
     elif(m_Data.DocKind == DL_WRTMONEY)
        return m_Data.Outsum;
     elif( (m_Data.DocKind == DL_VEKSELDRAWORDER)    or//погашение сюда же входит выкуп
           (m_Data.DocKind == DL_VSBARTERORDER)      or//мена
           (m_Data.DocKind == DL_VSINTERCHANGE)        //зачет взаимных требований        
         )
        return $0;
     end;
     return $0;
  END;

  /*Доходы..не облагаемые*/
  MACRO TaxSpecial0():money
     var v_TaxSpecial0 = $0;
     var objstr = string(TXOBJ_COUP0_GROUP)+", "+string(TXOBJ_EXP_GROUP);

     DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                     objstr,
                                     this.Dbeg(),
                                     this.OperDate(),
                                     null,
                                     m_Data.OperID,
                                     null,
                                     @v_TaxSpecial0,
                                     null,
                                     KindIIS()
                                    );

     return v_TaxSpecial0;
  END;

  MACRO BaseGeneral()
     if(m_BaseGeneral == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASEGENERAL),
                                        this.Dbeg(),
                                        this.OperDate(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_BaseGeneral,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseGeneral;
  END;

  MACRO BaseBill()
     if(m_BaseBill == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASEBILL),
                                        this.Dbeg(),
                                        this.OperDate(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_BaseBill,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseBill;
  END;

  MACRO BaseG2()
     if(m_BaseG2 == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASEG2),
                                        this.Dbeg(),
                                        this.OperDate(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_BaseG2,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseG2;
  END;

  MACRO BaseG3()
     if(m_BaseG3 == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASEG3),
                                        this.Dbeg(),
                                        this.OperDate(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_BaseG3,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseG3;
  END;

  MACRO BaseG9()
     if(m_BaseG9 == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASEG9),
                                        this.Dbeg(),
                                        this.OperDate(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_BaseG9,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseG9;
  END;

  MACRO BaseG5()
     if(m_BaseG5 == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASEG5),
                                        this.Dbeg(),
                                        this.OperDate(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_BaseG5,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseG5;
  END;

  /*Доходы (нарастающим итогом с начала года) -  материальная выгода*/
  MACRO TaxMaterial():money
     var v_TaxMaterial = $0;

     DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                     string(IIF(KindIIS() == 1, TXOBJ_BASEMATERIAL_IIS, TXOBJ_BASEMATERIAL)),
                                     this.Dbeg(),
                                     this.Dend(),
                                     null,
                                     m_Data.OperID,
                                     null,
                                     @v_TaxMaterial
                                    );

     return v_TaxMaterial;
  END;

  /*Доходы..облагаемые по общей ставке*/
  MACRO TaxGeneral():money
     var v_TaxGeneral = $0;

     if(ClientStatus() == CL_STATE_NOTRES)
        v_TaxGeneral = BaseGeneral() + BaseBill();
     else
        if(KindIIS() == 0)
           v_TaxGeneral = min(BaseG2() - TaxMaterial(), Max15) + min(BaseG3(), Max15) + min(BaseG9(), Max15);
        else
           v_TaxGeneral = min(BaseG5() - TaxMaterial(), Max15);
        end;
     end;

     return v_TaxGeneral;
  END;

  MACRO TaxGeneral15():money
     var v_TaxGeneral15 = $0;

     if(ClientStatus() == CL_STATE_NOTRES)
        v_TaxGeneral15 = BaseGeneral() + BaseBill();
     else
        if(KindIIS() == 0)
           v_TaxGeneral15 = max(BaseG2() - TaxMaterial() - Max15, 0) + max(BaseG3() - Max15, 0) + max(BaseG9() - Max15, 0);
        else
           v_TaxGeneral15 = max(BaseG5() - TaxMaterial() - Max15, 0);
        end;
     end;

     return v_TaxGeneral15;
  END;

  MACRO BaseSpecial():money
     var v_BaseSpecial = $0;
     DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                     string(TXOBJ_BASESPECIAL),
                                     this.Dbeg(),
                                     this.Dend(),
                                     null,
                                     null,/*и пользовательские тоже*/
                                     null,
                                     @v_BaseSpecial
                                    );
     return v_BaseSpecial;
  END;

  MACRO BaseSpecialIIS():money
     var v_BaseSpecialIIS = $0;
     DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                     string(TXOBJ_BASESPECIAL_IIS),
                                     this.Dbeg(),
                                     this.Dend(),
                                     null,
                                     null,/*и пользовательские тоже*/
                                     null,
                                     @v_BaseSpecialIIS
                                    );
     return v_BaseSpecialIIS;
  END;

  MACRO BaseSpecialDiv():money
     if(m_BaseSpecialDiv == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASESPECIAL_DIV),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        null,/*и пользовательские тоже*/
                                        null,
                                        @m_BaseSpecialDiv,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseSpecialDiv;
  END;

  MACRO Div()
     return BaseSpecialDiv();
  END;

  MACRO BaseSpecialDiv15():money
     if(m_BaseSpecialDiv15 == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_BASESPECIAL_DIV_15),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        null,/*и пользовательские тоже*/
                                        null,
                                        @m_BaseSpecialDiv15,
                                        null,
                                        KindIIS()
                                       );
     end;

     return m_BaseSpecialDiv15;
  END;

  MACRO Div15()
     return BaseSpecialDiv15();
  END;

  MACRO DivPaySec():money
     if(m_DivPaySec == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_DIVPAY_SEC),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        null,/*null, тк на данный момент не привязывается ни к опции НОБ ни к Опции расчета НДФЛ (привязывается к депозитарной операции)*/
                                        null,
                                        @m_DivPaySec,
                                        null,
                                        KindIIS()
                                       );
     end;
     return m_DivPaySec;
  END;

  MACRO PaidGeneral_15_1():money
     if(m_PaidGeneral_15_1 == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_PAIDGENERAL_15_1),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        null,/*null, тк на данный момент не привязывается ни к опции НОБ ни к Опции расчета НДФЛ (привязывается к депозитарной операции)*/
                                        null,
                                        @m_PaidGeneral_15_1,
                                        null,
                                        KindIIS()
                                       );
     end;
     return m_PaidGeneral_15_1;
  END;

  /*Доходы..облагаемые по ставке 9 (15)%*/
  MACRO TaxSpecial():money
     var RetVal:money = $0;

     if( KindIIS() == 1 )
        RetVal = BaseSpecialIIS();
     else
        RetVal = BaseSpecial();
        //if( ClientStatus() == CL_STATE_NOTRES )
        //   RetVal = RetVal + BaseSpecialDiv();
        //end;
     end;

     return RetVal;
  END;

  MACRO GetTaxCalculatedPaidTotal()
     if(m_TaxCalculatedPaidTotal == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_PAIDSPECIAL) + ", " + string(TXOBJ_PAIDSPECIAL_0),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_TaxCalculatedPaidTotal
                                       );
     end;

     return m_TaxCalculatedPaidTotal;
  END;

  MACRO GetTaxCalculatedRetOwn()
     return m_Data.TaxCalculated;
  END;

  MACRO GetTaxCalculatedDiv()
     return m_Data.TaxCalculated;
  END;

  MACRO GetTaxCalculatedDepo()
     return m_Data.TaxCalculated;
  END;

  /*Налог по данной операции расчета НДФЛ, подлежащий удержанию*/
  MACRO TaxCalculated():money
     var Bs, Ps;
     if( m_Data.DocKind == DL_CALCNDFL )
        return this.TaxTotal() + this.TaxTotal15();
     elif(m_Data.DocKind == DL_WRTMONEY)
        if((m_Dg == null) or (m_Ds == null) or (m_Dm == null) or (m_Dp == null))
           Bs = TaxSpecial();
           Ps = GetTaxCalculatedPaidTotal();
           GetTAXCalculatedDue(m_Data.Client, ClientStatus(), Dbeg(), m_Data.OperDate, m_Year, KindIIS(), RateGeneral(), RateSpecial(), Rp(), Bs, @m_Dg, @m_Ds, @m_Dm, @m_Dp, NULL, NULL, NULL, NULL, true);
        end;
        if(m_Dg + m_Ds + m_Dm + m_Dp > SumOut())
           return SumOut() * RateGeneral();
        else
           return m_Dg + m_Ds + m_Dm + m_Dp;
        end;
     elif(m_Data.DocKind == DL_AVRWRT)
        return 0;
     elif(m_Data.DocKind == DL_RETIREMENT_OWN)
        return GetTaxCalculatedRetOwn();
     elif(m_Data.DocKind == DL_RETURN_DIVIDEND)
        return GetTaxCalculatedDiv();
     elif(m_Data.DocKind == 870) //Расчет выплат в депозитарии (в т. ч. и сумма НДР, созданных в операциях расчета НОБ и удержания НДФЛ, выполненных
        return GetTaxCalculatedDepo(); //безынтерфейсно в операциях расчетов выплат в депозитарии)
     elif( m_Data.DocKind == DL_HOLDNDFL )
        return m_Data.TaxCalculated;
     elif( (m_Data.DocKind == DL_VEKSELDRAWORDER)    or//погашение сюда же входит выкуп
           (m_Data.DocKind == DL_VSBARTERORDER)      or//мена
           (m_Data.DocKind == DL_VSINTERCHANGE)        //зачет взаимных требований   
         )
        return m_Data.TaxCalculated;
     end;
     return $0;
  END;

  MACRO TaxPaidSpecial():money
     if(m_TaxPaidSpecial == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_PAIDSPECIAL),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_TaxPaidSpecial
                                       );
     end;

     return m_TaxPaidSpecial;
  END;

  MACRO PaidGeneral_0():money
     var v_PaidGeneral_0 = $0;

     DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                     string(TXOBJ_PAIDGENERAL_0),
                                     this.Dbeg(),
                                     this.Dend(),
                                     null,
                                     m_Data.OperID,
                                     null,
                                     @v_PaidGeneral_0
                                    );

     return v_PaidGeneral_0;
  END;

  MACRO PaidSpecial_0():money
     var v_PaidSpecial_0 = $0;

     DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                     string(TXOBJ_PAIDSPECIAL_0),
                                     this.Dbeg(),
                                     this.Dend(),
                                     null,
                                     m_Data.OperID,
                                     null,
                                     @v_PaidSpecial_0
                                    );

     return v_PaidSpecial_0;
  END;

  MACRO TaxPaidSpecialIIS():money
     if(m_TaxPaidSpecialIIS == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_PAIDSPECIAL_IIS),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_TaxPaidSpecialIIS
                                       );
     end;

     return m_TaxPaidSpecialIIS;
  END;

  MACRO TaxPaidGeneral():money
     if(m_TaxPaidGeneral == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_PAIDGENERAL),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_TaxPaidGeneral
                                       );
     end;

     return m_TaxPaidGeneral;
  END;

  MACRO TaxPaidGeneralIIS():money
     if(m_TaxPaidGeneralIIS == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_PAIDGENERAL_IIS),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_TaxPaidGeneralIIS
                                       );
     end;

     return m_TaxPaidGeneralIIS;
  END;

  MACRO TaxPaidMaterial():money
     if(m_TaxPaidMaterial == null)
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_PAIDMATERIAL),
                                        this.Dbeg(),
                                        this.Dend(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @m_TaxPaidMaterial
                                       );
     end;

     return m_TaxPaidMaterial;
  END;

  MACRO TaxPaidMaterialIIS():money
     var v_TaxPaidMaterialIIS = $0;

     DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                     string(TXOBJ_PAIDMATERIAL_IIS),
                                     this.Dbeg(),
                                     this.Dend(),
                                     null,
                                     m_Data.OperID,
                                     null,
                                     @v_TaxPaidMaterialIIS
                                    );

     return v_TaxPaidMaterialIIS;
  END;

  /*Налог по данной операции расчета НДФЛ, реально удержанный*/
  MACRO TaxPaid():money
     var v_TaxPaid = $0;

     if((m_Data.DocKind == DL_CALCNDFL) or (m_Data.DocKind == DL_HOLDNDFL) or (m_Data.DocKind == DL_RETIREMENT_OWN) or (m_Data.DocKind == DL_RETURN_DIVIDEND) or (m_Data.DocKind == DL_AVRWRT) or (m_Data.DocKind == 870))
        v_TaxPaid = m_Data.TaxPaid;
     else
        DL_GetNPTXOBJSumByClientAndOper(m_Data.Client,
                                        string(TXOBJ_DIVPAY_SEC) + ", " +
                                        string(TXOBJ_DIVPAY_SEC_0) + ", " +
                                        string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                        string(TXOBJ_PAIDGENERAL_15_1_0) + ", " +
                                        string(TXOBJ_PAIDGENERAL) + ", " +
                                        string(TXOBJ_PAIDGENERAL_0) + ", " +
                                        string(TXOBJ_PAIDMATERIAL) + ", " +
                                        string(TXOBJ_PAIDBILL) + ", " +
                                        string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                        string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                        string(TXOBJ_PAIDSPECIAL) + ", " +
                                        string(TXOBJ_PAIDSPECIAL_0) + ", " +
                                        string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                        string(TXOBJ_PAIDGENERAL_15_IIS) + ", " +
                                        string(TXOBJ_PAIDSPECIAL_IIS),
                                        Dbeg(),
                                        Dend(),
                                        null,
                                        m_Data.OperID,
                                        null,
                                        @v_TaxPaid
                                       );
     end;

     return v_TaxPaid;
  END;

  /*Налог, нарастающим итогом за год, рассчитанный*/
  MACRO TaxTotal():money
      var Bs, Ps;

      if((m_Dg == null) or (m_Ds == null) or (m_Dm == null) or (m_Dp == null))
         Bs = TaxSpecial();
         Ps = GetTaxCalculatedPaidTotal();
         GetTAXCalculatedDue(m_Data.Client, ClientStatus(), Dbeg(), m_Data.OperDate, m_Year, KindIIS(), RateGeneral(), RateSpecial(), Rp(), Bs, @m_Dg, @m_Ds, @m_Dm, @m_Dp, NULL, NULL, NULL, NULL, true);
      end;

      return m_Dg + m_Ds + m_Dm;
  END;

  MACRO TaxTotal15()
     var Bs, Ps;

     if(m_Dp == null)
        Bs = TaxSpecial();
        Ps = GetTaxCalculatedPaidTotal();
        GetTAXCalculatedDue(m_Data.Client, ClientStatus(), Dbeg(), m_Data.OperDate, m_Year, KindIIS(), RateGeneral(), RateSpecial(), Rp(), Bs, @m_Dg, @m_Ds, @m_Dm, @m_Dp, NULL, NULL, NULL, NULL, true);
     end;

     return m_Dp;
  END;

  MACRO TPaid( objstr:string ):money
     var retVal:money = 0;
     /*созданные в операциях расчета НОБ*/
     retVal = retVal + GetRubSumByClientOperDocKind(m_Data.Client, objstr, Dbeg(), OperDate(), DL_CALCNDFL, null, KindIIS());
     retVal = retVal + GetRubSumByClientOperDocKind(m_Data.Client, objstr, Dbeg(), OperDate(), 0, null, KindIIS() )         ;/*только пользовательские*/
     retVal = retVal + GetRubSumByClientOperDocKind(m_Data.Client, objstr, Dbeg(), OperDate(), DL_HOLDNDFL, IIF(m_Data.IIS=="X", null, Dbeg()), KindIIS()); /*созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции*/
     retVal = retVal + GetRubSumByClientOperDocKind(m_Data.Client, objstr, Dbeg(), OperDate(), DL_WRTMONEY, null, KindIIS()); /*списание д/с*/
     /*плюс операции в ПС <Векселя банка>*/
     retVal = retVal + GetRubSumByClientFromVeksel(m_Data.Client, objstr, Dbeg(), OperDate(), string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                              string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                              string(DL_VSINTERCHANGE) )  ;    //зачет взаимных требований         
     if(KindIIS() == 0)
        retVal = retVal + GetRubSumByClientFromDepo(m_Data.Client, string(objstr), DBeg(), DEnd()); //созданные в депозитарии
     end;

     return retVal;
  END;


  /*Налог нарастающим итогом за год, удержанный*/
  /*
  НДР с кодом PaidSpecial ,  PaidGeneral и  DivPay_Sec  за период с Dbeg по <OperDate> включительно: 
  1) пользовательские и созданные в операции расчета НОБ
  плюс
  2) не для ИИС - созданные в операции удержания НДФЛ, , где TaxYear операции = <Year>
  3) для ИИС - созданные в операции удержания НДФЛ */
  MACRO TaxPaidTotal():money
     if(m_TaxPaidTotal == null)
        if( KindIIS() == 1 )
           m_TaxPaidTotal = TPaid(string(TXOBJ_PAIDSPECIAL_IIS)+", "+string(TXOBJ_PAIDGENERAL_IIS));
        else
           m_TaxPaidTotal = TPaid(string(TXOBJ_DIVPAY_SEC)+", "+string(TXOBJ_PAIDGENERAL)+", "+string(TXOBJ_PAIDMATERIAL)+", "+string(TXOBJ_PAIDBILL)+", "+string(TXOBJ_PAIDSPECIAL) );
        end;
     end;

     return m_TaxPaidTotal;
  END;

  MACRO TaxPaidTotal15():money
     if(m_TaxPaidTotal15 == null)
        if((m_Data.OperDate >= Date(1, 1, 2021)) and (ClientStatus() == CL_STATE_RES))
           if(KindIIS() == 0)
              m_TaxPaidTotal15 = Round(TPaid(string(TXOBJ_PAIDGENERAL_15_1) + ", " + string(TXOBJ_PAIDGENERAL_15_2) + ", " + string(TXOBJ_PAIDGENERAL_15_9)), 0);
           else
              m_TaxPaidTotal15 = Round(TPaid(string(TXOBJ_PAIDGENERAL_15_IIS)), 0);
           end;
        else
           m_TaxPaidTotal15 = $0;
        end;
     end;

     return m_TaxPaidTotal15;
  END;

  MACRO TaxToPay()
     return TaxTotal() + TaxTotal15() - TaxPaidTotal() - TaxPaidTotal15();
  END;

  /*В том числе налог на матери-альную выгоду - рассчитанный*/
  MACRO TaxMaterialCalc():money
     return this.TaxMaterial()*this.RateGeneral();
  END;

  /*В том числе налог на материальную выгоду*/
  MACRO TaxMaterialPaid():money
     if( KindIIS() == 1 )
        return TPaid(string(TXOBJ_PAIDMATERIAL_IIS));
     else
        return TPaid(string(TXOBJ_PAIDMATERIAL));
     end;
  END;

  /*В том числе налог на материальную выгоду - подлежащий уплате*/
  MACRO TaxMaterialToPay():money
     return this.TaxMaterialCalc() - this.TaxMaterialPaid();
  END;

  /* DEF-45062 При сохранении отчета были ошибки. Изменил шаблон на xlsx и вывод через POI.
     Производится частичное сохранение данных после обработки 1000 записей.
     Также изменил метод для формирования строк ВСЕГО и В ТОМ ЧИСЛЕ 
     (теперь SetCellAutoSumma() не используется).
     Если нужен лог, то раскомментируйте следующий оператор (InitCbLog)
     Велигжанин А.В.
  */
/*  InitCbLog(1);*/
  initDL_CReportTemplate( Sp_NPREPTAX_Panel(), "Report_npreptax.xlsx", true, false, null, true, true ); 
END;

Sp_npreptax_Report().Run();
exit(1);