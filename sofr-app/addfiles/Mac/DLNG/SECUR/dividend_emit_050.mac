/*
$Name:         dividend_emit_050.mac
$Module:       Ценные бумаги
$Description:  Операция получения дивидендов по РЕПО (от Контрагента)
*/
/*  Шаг Вынос на просрочку (50): формирование проводок  */

import InsCarryDoc, "sp_class.mac", "sp_car2.mac", "spservsql.mac", "SPQICheckOper.mac";
 
macro ExecuteStep( Doc, FDoc,  /*доп.параметры*/ 
                                DocKind, ID_Operation, ID_Step )   

    record deal(DL_TICK);
    SetBuff( deal, FDoc ); 
    
    var FD = SPFirstDoc( deal );
    var tick = FD.tick.rec;
    var leg = FD.dl_leg.rec;
    
    // Проверяется, была ли сумма всех Qstep, указанных на шагах, меньше Qdepo
     var cmd = DL_RSDCommand( "select Nvl(Sum(dl.t_Nds),0) QSteps from ddlsum_dbt dl"
                            + " where dl.t_DocKind = ?"
                            + " and dl.t_DocID = ?"
                            + " and dl.t_Kind = ?" 
                            + " and dl.t_Date >= ?");  
    cmd.AddParam( tick.BOfficeKind );
    cmd.AddParam( tick.DealID );
    cmd.AddParam( DLSUM_KIND_BANK_PERIOD );
    cmd.AddParam( tick.DealDate );
    var DataSet = cmd.Execute(); 
    
    var QSteps = 0;

    if ( DataSet.moveNext() )
         QSteps = DataSet.QSteps;
    end;

     if ( QSteps < leg.Principal /*Qdepo*/ )
        MsgBox( "Сумма всех сумм от эмитента (Qsteps), указанных на шагах, должна быть >= 'Количество ценных бумаг на счетах депо'(Qdepo)" );
        return 1;
    end;

    // --------------------------------------------------------------------------

    var AccountDt = TrecHandler( "account.dbt");
    var AccountCt = TrecHandler( "account.dbt");
    
    // ПРОВОДКА - П	/*D max	Перенос на просрочку*/
    
    // ЗДЕСЬ ОСОБЕННАЯ КУ - ПРОСРОЧЕННАЯ!!!!!                                     // ДАТА?????????   ВАЛЮТА                  
    if ( not FD.OpenAccount("Начисленные дивиденды", null, false, FIROLE_DEALS_OVERDUE, AccountDt, leg.DmaxPay, leg.CFI /*CurDiv*/) )
        //MsgBox( "Ошибка при определении счета по категории по 'Оплаченные налоги'" );
        return 1;
    end;
    // ЗДЕСЬ ОСОБЕННАЯ КУ - НЕПРОСРОЧЕННАЯ!!!!!   
    if ( not FD.OpenAccount("Начисленные дивиденды", null, false, null, AccountCt, leg.DmaxPay, leg.CFI) )
        //MsgBox( "Ошибка при определении счета по категории по 'Начисленные дивиденды'" );
        return 1;
    end;

    var sum =  leg.Price /*DivOne*/ * ( leg.Principal /*Qdepo*/ - QSteps );

    if( not ПроводкаПоКатегориямУчета( 
            FD, 
            AccountDt, AccountCt, 
            leg.DmaxPay,                 /* Дата ???????????????????????????? */
            1,                             /* Глава */
            leg.CFI,             //NATCUR,  /* Валюта суммы проводки */
            sum,                           /* Сумма проводки*/    
            Doc,                           /* Документ */
            INPCARRY,                      /* Result_Carry */
            " 1",                          /* Kind_Oper */
            deal.DealCode,                 /* Numb_Document */
            "Учет налога",                 /* Ground */
            null,null,null,
            AccountDt.rec.code_currency, AccountCt.rec.code_currency  // валюты счетов: Дт - Кт 
        ) 
    )
        MsgBox( "Ошибка при выполнении проводки 'Учет налога'!" );
        return 1;
    end;

    if( not InsertOprStatus( 1511, 3) )
        msgbox( "Ошибка при установке статуса <Документооборот> операции" );
        return 1;
    end;

    return 0;
end;