 /*
 $Name: wrtavr_utils.mac
 $Module: Ядро Dealing
 $Description: Утилитные функции для списаний/зачислений ЦБ

  # tag
  - code_type: API 
  
  # changelog
  |date       |author         |tasks                                                   |note                                                        
  |-----------|---------------|--------------------------------------------------------|-------------------------------------------------------------
  |2024.05.28 |Дылгеров Ц.В.  |DEF-65552                                               | Создание
  |2024.11.07 |Зыков М.В.     |DEF-73019                                               | Ложная сработка мониторинга по БИК-13034

*/

import "oralib.mac","dlmisc.mac";

/**
  @brief - Отправка сообщения об ошибке по данной операции списание/зачисления ЦБ в рамках реализации BIQ-13034
  @param[in] DealIDQuery - по списку сделок 
  @param[in] head - заголовок письма 
  @param[in] text - описание ошибки при выполнении операции списания/зачисления ЦБ 
*/
macro wrtavr_utils_mac_sendErrorEvent(DealIDQuery,head,text)
  execSQL(" declare v_isBIQ13034 integer ; begin " +
          " select count(*) into v_isBIQ13034 from PKO_WriteOff t where rownum < 2 and t.dealid in ("+DealIDQuery+") ;" +
          " if v_isBIQ13034 > 0 then   it_diasoft.SendErrorEvent(p_ErrorCode => it_q_manager.C_N_ERROR_OTHERS_MSGCODE, p_Head => :1, p_Text => :2); end if ; " +
          " end; ", 
          makeArray(SQLParam("head", head), SQLParam("text", text)), true);
end;

//wrtavr_utils_mac_sendErrorEvent("head","text");
