/*******************************************************************************
 DESCRIPTION  :   Отчет ""
 PROGRAMMED BY:   Сагиян С.Г.
 CREATION DATE:    18.07.2019
*******************************************************************************/
IMPORT  "spCache.mac", "od1_2_form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "cb_sql.mac", "sprepfun.mac", "oralib", "MoCommon.mac","ws_txreportform.mac", "res_carry";

PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR   OD1_Form;
PRIVATE VAR   OD1_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб

PRIVATE VAR   NFinRez;
PRIVATE VAR   NNDFL;

PRIVATE VAR ReportHeader = " \n"; 
                                                                                                                                                                                                                                                                                                                             
PRIVATE VAR TableHeader = " \n"; 

record rsvprm(rsvprm);
record accbase(account);

                                                                                                                                   
PRIVATE CLASS (DL_CReportTemplate) SP_OD1_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  PRIVATE VAR F0_6, F0_9, F0_11; /*суммы строки "Итого"*/
  PRIVATE VAR m_TotalAmountPoint = 0;
  PRIVATE VAR v_account = "", v_amount;
  var RS;
  VAR RepDate;
  var cmdtemp, rstemp;

  PRIVATE VAR v_BuyCost, v_BuyNKD, v_BuyTotalCost, v_SaleCost, v_SaleNKD, v_SaleTotalCost, v_ComS, v_ComB, v_FinRez;
  PRIVATE VAR v_s_BuyCost, v_s_BuyNKD, v_s_BuyTotalCost, v_s_SaleCost, v_s_SaleNKD, v_s_SaleTotalCost, v_s_ComS, v_s_ComB, v_s_FinRez;
  VAR PrevFI, PrevS;
  VAR         ProgressValue = CTxProgressValue();

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
/* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END;

	



  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintLine( P1,P2,P3,P4,P5,P6,P7,P8,P9,P10,P11,P12,P13,P14,P15,P16,P17,P18,P19,P20,P21,P22,P23,P24,P25,P26,P27,P28,P29,P30,P31,P32,P33,P34,P35,P36,P37,P38,P39,P40,P41,P42,P43,P44,P45,P46,P47,P48,P49,P50,P51)

     this.PrintTableLine( 

          /*1 */     "FICode",      P1  , null, 
          /*2 */     "Filial",      P2  , null, 
          /*3 */     "AccBal",      P3  , null, 
          /*4 */     "Acc",         P4  , null, 
          /*5 */     "FIName",      P5  , null, 
          /*6 */     "Seria",       P6  , null, 
          /*7 */     "Emitent",     P7  , null,  
          /*8 */     "Amount",      P8 , null, 
          /*9 */     "NomFI",       P9 , null,
          /*10*/     "NominalRUR",  P10 , null, 
          /*11*/     "Nominal",     P11 , null, 
          /*12*/     "BalCostRUR",  P12 , null, 
          /*13*/     "SumRUR",      P13 , null, 
          /*14*/     "UNKD",        P14 , null, 
          /*15*/     "Discont",     P15 , null, 
          /*16*/     "BalCost",     P16 , null,
          /*17*/     "Bcost",       P17 , null, 
          /*18*/     "LastCost",    P18 , null, 
          /*19*/     "DrawingDate", P19 , null, 
          /*20*/     "CoupProc",    P20 , null, 
          /*21*/     "Pereots",     P21 , null,  
          /*22*/     "CoupPeriod",  P22 , null, 
          /*23*/     "NearDate",    P23 , null, 
          /*24*/     "DayS",        P24 , null, 
          /*25*/     "PKD",         P25 , null, 
          /*26*/     "Premia",      P26 , null, 
          /*27*/     "Cost1",       P27 , null, 
          /*28*/     "Cost2",       P28 , null, 
          /*29*/     "Reserv",      P29 , null,  
          /*30*/     "TT1",	    P30 , null,
          /*31*/     "TT2",	    P31 , null,
          /*32*/     "TT4",	    P32 , null,  
          /*33*/     "Country1",    P33 , null, 
          /*34*/     "Country2",    P34 , null, 
          /*35*/     "Country3",    P35 , null, 
          /*36*/     "Portf",       P36 , null, 
          /*37*/     "AgName",      P37 , null, 
          /*38*/     "FIRate",      P38 , null, 
          /*39*/     "DohodEff",    P39 , null, 
          /*40*/     "ISIN",        P40  , null, 
          /*41*/     "GosReg",      P41  , null,
          /*42*/     "RatePlace",   P42 , null, 
          /*43*/     "ActPlace",    P43 , null, 
          /*44*/     "Ierarh",      P44 , null, 
          /*45*/     "BusModel",    P45 , null, 
          /*46*/     "SPPI",        P46 , null,
          /*47*/     "PartPerc",    P47 , null,
          /*48*/     "AttachDate",  P48 , null,
          /*49*/     "RepDateDividends",  P49 , null,
          /*50*/     "ReceiveDividends",  P50 , null,
          /*51*/     "FirstPayDateDividends",  P51 , null
       );      

  END;

  macro AccRest(acc, pfiid, pdate)
      var sql = " select rsb_account.RestA(t_account, ?, 1, 1) rest from dmcaccdoc_dbt where t_account like ? and t_iscommon=chr(88) and t_fiid=? ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, pdate);
      cmd.addParam("", RSDBP_IN, acc);
      cmd.addParam("", RSDBP_IN, pfiid);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return abs(getData.Value(0)); 
      else 
       return 0;
      end;
  end;

  macro PortfolioAccRest(pfiid, pdate)
      var sql = " select sum(rsb_account.RestA(t_account, ?, 1, 1)) rest from dmcaccdoc_dbt where t_catid in (31, 495) and t_iscommon=chr(88) and t_fiid=? ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, pdate);
      cmd.addParam("", RSDBP_IN, pfiid);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return abs(getData.Value(0)); 
      else 
       return 0;
      end;
  end;

    macro getESTRESERVE(fininstr, Data)
  
     var RetVal = $0.0;  
     var sql = 
         "SELECT  DISTINCT(t_account), RSB_ACCOUNT.RESTALL(t_account, t_chapter,t_currency, ? ) " +
         "  FROM dmcaccdoc_dbt ";
      if (RS.PORTFOLIO == 2)
         sql = sql +
         " WHERE t_catnum IN (1457, 1458) AND t_templnum = 5 and t_iscommon = CHR (88) AND t_fiid = ? " ;
      elif (RS.PORTFOLIO == 5)
         sql = sql +
         " WHERE t_catnum IN (1457, 1458) AND t_templnum in (1,3) and t_iscommon = CHR (88) AND t_fiid = ? " ; /*PDV 512006  */
      else
       //  sql = sql +
       //  " WHERE t_catnum IN (1457, 1458) and and t_templnum = 3 t_iscommon = CHR (88) AND t_fiid = ? " ;
        return 0;
      end;                                                                            
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, RS.FIID);
//	cmd.addParam("", RSDBP_IN, RS.FIID);
     // cmd.addParam("", RSDBP_IN, RS.ACCOUNT);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      return RetVal; 
       
  /*     
     var sql = " SELECT  SUM (NVL (ESTRESERVE, 0)) ESTRESERVE" +
               "         FROM DPORTFOLIO_TMP t " +
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +
               "              T_FIID, " +
               "              T_PARTYID, " +
               "              T_AVKINDSHNAME, " +
               "              T_ACCOUNT, " +
               "              T_BALANCE ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, RS.PORTFOLIO);
      cmd.addParam("", RSDBP_IN, RS.FIID);
      cmd.addParam("", RSDBP_IN, RS.ACCOUNT);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData.Value(0);  
      else 
       return 0;
      end;
          */
      // onError
      //  return 0;

    End;



    macro getCORRINTTOEIR (fininstr, Data)
/*    var RetVal = $0.0;  
     var sql = 
         "SELECT  t_account, RSB_ACCOUNT.RESTALL(t_account, t_chapter,t_currency, ? ) rest  " +
         "  FROM dmcaccdoc_dbt " +
         " WHERE t_catnum IN (1418, 1417) AND t_iscommon = CHR (88) AND t_fiid = ? " ;
      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.addParam("", RSDBP_IN, RS.FIID);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      while(getData.MoveNext)
        RetVal = RetVal + getData.Value(1);  
      end;
      return RetVal;*/


     var sql = " SELECT  SUM (NVL (CORRINTTOEIR, 0)) CORRINTTOEIR " +
               "         FROM DPORTFOLIO_TMP t " +
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +
               "              T_FIID, " +
               "              T_PARTYID, " +
               "              T_AVKINDSHNAME, " +
               "              T_ACCOUNT, " +
               "              T_BALANCE ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, RS.PORTFOLIO);
      cmd.addParam("", RSDBP_IN, RS.FIID);
      cmd.addParam("", RSDBP_IN, RS.ACCOUNT);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
       return getData.Value(0);  
      else 
       return 0;
      end;
           
    End;







  PRIVATE MACRO GetRate(fi, rtype, ddate)
     VAR cmd1, rs1, cmd2, rs2;
     cmd1 = RSDCommand("select t_rate/power(10,t_point) RetVal, t_sincedate RetDate from dratedef_dbt rh where t_otherfi = ? and t_type = ? and rh.t_sincedate <= ? ");

     cmd1.AddParam( "", RSDBP_IN, fi );	  
     cmd1.AddParam( "", RSDBP_IN, rtype );	  
     cmd1.AddParam( "", RSDBP_IN, ddate );	  

     RS1 = TRsbDataSet( cmd1 );
     IF ((RS1.MoveNext) and ( RS1.RetDate <= ddate))
		return rs1.RetVal;
     else
	     cmd2 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratehist_dbt rh where rh.t_rateid in " +
                       " (select t_rateid from dratedef_Dbt where t_otherfi=? and t_type=?) " + 
                       " and  rh.t_sincedate = (select max(l.t_sincedate) from dratehist_dbt l where l.t_rateid = rh.t_rateid and l.t_sincedate <= ?) ");

	     cmd2.AddParam( "", RSDBP_IN, fi );	  
	     cmd2.AddParam( "", RSDBP_IN, rtype );	  
	     cmd2.AddParam( "", RSDBP_IN, ddate );	  
	     RS2 = TRsbDataSet( cmd2 );
	     IF (RS2.MoveNext)
		return rs2.RetVal;        
	     end;
	     return 0;
     end;

  END;


  PRIVATE MACRO GetRateAccur(fi, rtype, ddate)
     VAR cmd1, rs1, cmd2, rs2;
     cmd1 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratehist_dbt rh where rh.t_rateid in " +
                       " (select t_rateid from dratedef_Dbt where t_otherfi=? and t_type=?) " + 
                       " and  rh.t_sincedate =  ? ");

     cmd1.AddParam( "", RSDBP_IN, fi );	  
     cmd1.AddParam( "", RSDBP_IN, rtype );	  
     cmd1.AddParam( "", RSDBP_IN, ddate );	  

     RS1 = TRsbDataSet( cmd1 );
     IF (RS1.MoveNext)
		return rs1.RetVal;
     else
	     cmd2 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratedef_dbt rh where t_otherfi = ? and t_type = ? and rh.t_sincedate = ? ");

	     cmd2.AddParam( "", RSDBP_IN, fi );	  
	     cmd2.AddParam( "", RSDBP_IN, rtype );	  
	     cmd2.AddParam( "", RSDBP_IN, ddate );	  
	     RS2 = TRsbDataSet( cmd2 );
	     IF (RS2.MoveNext)
		return rs2.RetVal;        
	     end;
	     return 0;
     end;

  END;



  PRIVATE MACRO BeginReport()

     VAR AvrKindShowValue = "";

     this.SetActiveSheet( "Лист1" );


                               

     this.PrintFormatString( ReportHeader,
                     "H0_1"  , OD1_Form.GetFieldValue( PNFLD_OD1_DATE )
                   );

     this.PrintFormatString( ReportHeader,
                     "HO_USD"  , GetRate( 7, 7, OD1_Form.GetFieldValue( PNFLD_OD1_DATE ))
                   );
     this.PrintFormatString( ReportHeader,
                     "H0_EUR"  , GetRate( 8, 7, OD1_Form.GetFieldValue( PNFLD_OD1_DATE ))
                   );


     this.RegisterTable( "MainTable", "",

          /*1 */     "FICode", 
          /*2 */     "Filial",
          /*3 */     "AccBal", 
          /*4 */     "Acc",   
          /*5 */     "FIName",
          /*6 */     "Seria", 
          /*7 */     "Emitent",  
          /*8 */     "Amount", 
          /*9 */     "NomFI",
          /*10*/     "NominalRUR", 
          /*11*/     "Nominal", 
          /*12*/     "BalCostRUR",  
          /*13*/     "SumRUR", 
          /*14*/     "UNKD",    
          /*15*/     "Discont",
          /*16*/     "BalCost",  
          /*17*/     "Bcost",  
          /*18*/     "LastCost",  
          /*19*/     "DrawingDate", 
          /*20*/     "CoupProc",    
          /*21*/     "Pereots",     
          /*22*/     "CoupPeriod",  
          /*23*/     "NearDate",    
          /*24*/     "DayS",        
          /*25*/     "PKD",         
          /*26*/     "Premia",      
          /*27*/     "Cost1",       
          /*28*/     "Cost2",       
          /*29*/     "Reserv",      
          /*30*/     "TT1",	   
          /*31*/     "TT2",	    
          /*32*/     "TT4",	    
          /*33*/     "Country1",   
          /*34*/     "Country2",   
          /*35*/     "Country3",   
          /*36*/     "Portf",      
          /*37*/     "AgName",    
          /*38*/     "FIRate",     
          /*39*/     "DohodEff",  
          /*40*/     "ISIN",      
          /*41*/     "GosReg",     
          /*42*/     "RatePlace",  
          /*43*/     "ActPlace",   
          /*44*/     "Ierarh",     
          /*45*/     "BusModel",  
          /*46*/     "SPPI",       
          /*47*/     "PartPerc",   
          /*48*/     "AttachDate", 
          /*49*/     "RepDateDividends", 
          /*50*/     "ReceiveDividends", 
          /*51*/     "FirstPayDateDividends"
       );      

  END;

  MACRO ПечататьПромежуточныеИтоги()
/*
     SetSubtotal(12, 11 + MAXROWSHEET,
                 "K8",    
                 "S8"
                 );
*/
  END;

  PRIVATE MACRO EndReport()
     this.EndTable();
     ПечататьПромежуточныеИтоги();
//     this.AddStandardFooter( "" );
  END;

    /*
      Получить Открытое количество ЦБ
    */

    macro getAvarAmount

     if (v_amount > 0) return v_amount;
     end;     
  
     var sql = " SELECT  SUM (NVL (T_AVRAMOUNT, 0)) T_AVRAMOUNT " +
               "         FROM DPORTFOLIO_TMP t " +
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +
               "              T_FIID, " +
               "              T_PARTYID, " +
               "              T_AVKINDSHNAME, " +
               "              T_ACCOUNT, " +
               "              T_BALANCE ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, rs.PORTFOLIO);
      cmd.addParam("", RSDBP_IN, rs.FIID);
      cmd.addParam("", RSDBP_IN, rs.ACCOUNT_NUMBER_2);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
		v_amount = getData.Value(0);
       		return v_amount;  
      else 
       return 0;
      end;

      // onError
      //  return 0;

    End;





  PRIVATE MACRO FICode   
	return rs.avrcode;  
  END;
  
  PRIVATE MACRO Filial   
	return "0000";
	return rs.depname;  
  END;  

  PRIVATE MACRO AccBal   
	return rs.ACCOUNT_NUMBER_1;  
  END;  

  PRIVATE MACRO Acc   
	return rs.ACCOUNT_NUMBER_2;  
  END;  

  PRIVATE MACRO FIName   
	return rs.avrname;  
  END;  

  PRIVATE MACRO Seria   
	return rs.series + IIF(rs.issue != "", "/" + rs.issue, ""); 
  END;  

  PRIVATE MACRO Emitent   
	return rs.issuer; // + " (" + rs.issuerid + ")";  
  END;  

  PRIVATE MACRO ISIN   
	return rs.isin;  
  END;  

  PRIVATE MACRO GosReg   
	return rs.lsin;  
  END;  

  PRIVATE MACRO NomFI   
	return rs.currency;  
  END;  

  PRIVATE MACRO Amount   

	return getAvarAmount;
	return rs.amount;  
  END;  

  PRIVATE MACRO NominalRUR   
	var RetVal;
	if (rs.facevaluefi != NATCUR)
	        SmartConvertSumDbl(RetVal, rs.NominalVal*amount, repdate, rs.facevaluefi, NATCUR, false);
	else 
		RetVal = rs.NominalVal*amount;
	end;
	return RetVal;  
  END;  

  PRIVATE MACRO Nominal   
	if (rs.facevaluefi != NATCUR)
		return rs.NominalVal*amount;
	end;
	return 0;  
  END;  

  PRIVATE MACRO BalCostRUR
	var RetVal;

return rs.BalCost;

	if (rs.facevaluefi != NATCUR)
	        //SmartConvertSumDbl(RetVal, rs.BalCost, repdate, rs.facevaluefi, NATCUR, false);
		RetVal = rs.BalCost;
	else 
		return 0;
	end;
  END;  

  PRIVATE MACRO SumRUR   

	return rs.dealcostsum;

/*	var RetVal;
	if (rs.facevaluefi != NATCUR)
	        SmartConvertSumDbl(RetVal, rs.Summ, repdate, rs.currency, NATCUR, false);
	else 
		RetVal = rs.Summ;
	end;
	return RetVal; 
*/
  END;  

  PRIVATE MACRO UNKD   
	return rs.unkd_with_coupon; 	
  END;  

  PRIVATE MACRO PKD   
	return rs.COUPON_AMOUNT; 
  END;  

  PRIVATE MACRO Premia   
	return rs.premium_amount; 
  END;  

  PRIVATE MACRO Discont   
	return rs.discount_amount; 
  END;  

  PRIVATE MACRO Pereots   
	return rs.overvalue; 
  END;  

  PRIVATE MACRO Reserv
 //if (rs.fiid == 15346)/*PDV 512006  */
   /*if (rs.facevaluefi != NATCUR)
        return   rs.reserve_amount/GetRate( 7, 7, repdate);
      else MAA: 512799 */
	return rs.reserve_amount;
    //end; 
  END;    
 
  PRIVATE MACRO BalCost 
	var RetVal;
	if (rs.facevaluefi != NATCUR)  
	        SmartConvertSumDbl(RetVal, rs.BalCost, repdate, NATCUR, rs.facevaluefi, false);
		return RetVal;  
	else 
		return 0;
	end;
  END;  

  PRIVATE MACRO Bcost   
	return "";  
  END; 

  PRIVATE MACRO LastCost   
        var cl;
       if ((rs.T_FIID == 2354) OR (rs.T_FIID == 1508) OR (rs.T_FIID == 1556) OR (rs.T_FIID == 2432) OR (rs.T_FIID == 854) OR (rs.T_FIID == 1573)  OR (rs.T_FIID == 1464))  /*AVN: 522381 */ 
                 cl = GetRate(rs.fiid, 4, repdate);  // Средневзвешенная
         else                                                                                   
	       if (rs.T_FIID == 1953)
			 cl = 0; //дефолтная бумага
                else
			if ((rs.avoirkind == 28) OR (rs.avoirkind == 39) OR (rs.avoirkind == 41) OR (rs.avoirkind == 43))  
	       	        cl = GetRate(rs.fiid, 23, repdate);    // Блумберг
	       		if (cl == 0)                                                                               
	       		        cl = GetRate(rs.fiid, 4, repdate);  // Средневзвешенная
	       		end;                                                                                       
	       		if (cl == 0)                                                                               
	       		        cl = GetRate(rs.fiid, 1001, repdate);  // Мотивированное суждение 
	       		end;                                                                                       
	       	else                                                                                               
	       	        cl = GetRate(rs.fiid, 1001, repdate);     // Мотивированное суждение 
	       		if (cl == 0)                                                                               
	       		        cl = GetRate(rs.fiid, 4, repdate);  // Средневзвешенная
			end;
	       		 if (cl == 0)                                                              
			        cl = GetRate(rs.fiid, 23, repdate);  // Блумберг
	       		end;                                                                                       
	             end;
		end;                                                                                               
      end;
	return cl;      

  END;  

  PRIVATE MACRO Dohod   
	return "";  
  END;  

  PRIVATE MACRO DrawingDate   
	return rs.t_DrawingDate;  
  END;  


 PRIVATE MACRO dmain
	if (rs.d1 != 0) return RS.d1;
	elif (rs.d2 != 0) return RS.d2;
	else return 0;
	end;
  END;


  PRIVATE MACRO CoupProc   
	var rate = rs.coupincomerate;
	var vol = rs.coupincomevolume;
	if (rate == 0) 
              if ( dmain == 0 ) 
			return 0;
	       end;
		rate = round(vol / rs.NominalVal * 100 * 365 / dmain, 2);
	end; 

	return rate;   
  END;  

  PRIVATE MACRO CoupPeriod_try
        var RetVal;
	var d = dmain;
	var h, j;
	var counter = 0;  // если сразу не найдем период, надо поимкать предыдущий купон и посмотреть на его период.

	while (counter < 2)
		if   ((d > 27) and (d < 33) ) RetVal = "ежемесячный";
		elif ((d > 70) and (d < 95) ) RetVal = "ежеквартальный";
		elif ((d > 170) and (d < 190) ) RetVal = "полугодовой";
		elif ((d > 359) and (d < 365) ) RetVal = "годовой";
		else 
	
			h = RSDCommand("select (w1.t_drawingdate - w1.t_firstdate + 1) days from  dfiwarnts_dbt w1 where  t_ispartial = CHR (0) and  w1.t_fiid=" + rs.fiid + " and w1.t_drawingdate = " +
	                 " (SELECT MAX (t.t_drawingdate) FROM dfiwarnts_dbt t WHERE t.t_fiid = w1.t_fiid AND t_ispartial = CHR (0) AND t.t_drawingdate < " + GetSQLDate( RepDate ) + ")");
	     		j = TRSBDataSet(h);
	     		if (j.movenext)
				d = j.days;
			end;
			counter = counter - 1;
		end;
		counter = counter + 2;
	end;


	return RetVal;  
  END;  

  PRIVATE MACRO CoupPeriod
	return CoupPeriod_try;
  END;  


  PRIVATE MACRO NearDate   
	return rs.coupdrawingdate;  
  END;  

  PRIVATE MACRO DayS   
	return rs.days;  
  END;  

  PRIVATE MACRO Cost3   
	return "";  
  END;  

  PRIVATE MACRO Country1   
	if (rs.flag_mez > 0) 
		return "";  
	end;

	if (rs.issuer_country == "Российская Федерация")
		return "Россия";  
	end;
	return "";
  END;  

  PRIVATE MACRO Country2   
	if (rs.flag_mez > 0) 
		return "";  
	end;

	if (rs.issuer_country != "Российская Федерация")
		return rs.issuer_country;  
	end;
	return "";
  END;  

  PRIVATE MACRO Country3   
	if (rs.flag_mez > 0) 
		return "Международная организация";
	else 
		return "";  
	end;
  END;  

  PRIVATE MACRO ReservMSFO   
	return "";  
  END;  

  PRIVATE MACRO FPRSBU1   
	return "";  
  END;  

  PRIVATE MACRO FPRSBU2   
	return "";  
  END;  

  PRIVATE MACRO PereotsChange   
	return "";  
  END;  

  PRIVATE MACRO NaDoh   
	return "";  
  END;  

  PRIVATE MACRO NaRash   
	return "";  
  END;  

  PRIVATE MACRO FPRSBU3   
	return "";  
  END;  

  PRIVATE MACRO Comment   
	return "";  
  END;  

  PRIVATE MACRO Cost4   
	return "";  
  END;  









                
  PRIVATE MACRO Create()

     VAR dl_leg      = TRecHandler( "dl_leg.dbt" );

     VAR DataQuery;
     VAR Select;
     VAR DealBuy;
     VAR AddWhere:string = "";

     VAR AvrFIID:integer, AvrKind:integer;       
     VAR QntySold:money = $0, SumBvpr:money = $0;
     VAR NKD:money = $0;
     VAR BuyDealTime:time, BuyPrice:double = 0.0;
     VAR StrNumbDeal1, StrNumbDeal2;
     VAR IsBlock;
     VAR ReserveSum, ReserveAccount;
            
     OD1_Form.GetFieldValue( PNFLD_OD1_DATE, @RepDate );

     NFinRez = 0;
     NNDFL = 0;

     // Проверка наличия данных
     cmdtemp = RSDCommand("select * from tRSHB_Portfolio_PKL_2CHD where report_dt = ?");
     cmdtemp.AddParam("", RSDBP_IN, RepDate);
     rstemp = TRSBDataSet(cmdtemp);
     if (not rstemp.movenext)
	 cmdtemp = RSDCommand("begin rsFillPortfolio (?); end;");
         cmdtemp.addParam( "", RSDBP_IN, repDate );
         cmdtemp.Execute();
     end;




     DataQuery = "select e.portfolio, avr.t_series, avr.t_issue, codes.t_code avrcode, substr(e.account_number_2,10,4)  depname, e.account_number_2  account, nvl(round(war.t_incomerate,t_incomepoint), 0) coupincomerate, nvl(war.t_incomevolume, 0) coupincomevolume, " +
		 " e.*, fi.t_fiid, fi.t_facevaluefi, fi.t_avoirkind avoirkind, e.balance_price BalCost, (select count(*) from dpartyown_dbt where t_partykind=52 and t_partyid=fi.t_issuer ) flag_mez, fi.t_issuer issuerid, " +
		 "rsi_rsb_fiinstr.ConvSum((select sum(y.amount) from DPORTFOLIO_TMP y where y.t_account=e.account_number_2  and y.t_fiid=fi.t_fiid and y.t_portfid=e.portfolio and y.report_dt = e.report_dt), fi.t_facevaluefi ,0," + GetSQLDate( RepDate ) + ") dealcostsum, " +
		 " nvl((war.t_drawingdate - war.t_firstdate + 1), 0) as d1, " +
        	 " nvl((select w1.t_drawingdate - w1.t_firstdate + 1 from  dfiwarnts_dbt w1 where  t_ispartial = CHR (0) and  fi.t_fiid = w1.t_fiid  and w1.t_drawingdate = " +
                 " (SELECT MIN (t.t_drawingdate) FROM dfiwarnts_dbt t WHERE t.t_fiid = fi.t_fiid AND t_ispartial = CHR (0)  AND t.t_drawingdate > " + GetSQLDate( RepDate ) + ")), 0) as d2, " +

		 "nvl(to_char(war.t_drawingdate,'dd.mm.yyyy'),'') coupdrawingdate, to_char(e.repay_dt,'dd.mm.yyyy') t_drawingdate, fi.t_fi_code, e.fi_group kname, /*e.security_name*/ fi.t_name avrname, e.issuer issuer, e.isin isin, e.reg_number lsin, e.currency facevaluefi, rsb_fiinstr.FI_GetNominalOnDate(fi.t_fiid, " + GetSQLDate( RepDate ) + ", 0) NominalVal, (war.t_drawingdate - " + GetSQLDate( RepDate ) + ") days " +
		 "from tRSHB_Portfolio_PKL_2CHD e, dfiwarnts_dbt war, dobjcode_dbt codes, dfininstr_Dbt fi, davrkinds_dbt kinds, davoiriss_dbt avr " +
		 "where e.report_dt = " + GetSQLDate( RepDate ) + " and fi.t_fiid = war.t_fiid(+) and war.t_ispartial(+)=chr(0) and   war.t_drawingdate(+) >= " + GetSQLDate( RepDate ) + " and war.t_firstdate(+) <= " + GetSQLDate( RepDate ) +  
		 " and codes.t_objectid(+)=fi.t_fiid and codes.t_codekind(+)=103 and t_objecttype(+)=9 and fi.t_fiid = avr.t_fiid " +
		 "and e.isin=avr.t_isin   and avr.t_isin <> chr(1) and kinds.t_fi_kind=2 and fi.t_avoirkind=kinds.t_avoirkind and kinds.t_root=17 and e.account_number_2 like '50%'" +
//" and fi.t_fiid=1937 " +
		 " union " +

     		 "select e.portfolio, avr.t_series, avr.t_issue, codes.t_code avrcode, substr(e.account_number_2,10,4)  depname, e.account_number_2  account, nvl(round(war.t_incomerate,t_incomepoint), 0) coupincomerate, nvl(war.t_incomevolume, 0) coupincomevolume, " +
		 " e.*, fi.t_fiid, fi.t_facevaluefi, fi.t_avoirkind avoirkind, e.balance_price BalCost, (select count(*) from dpartyown_dbt where  t_partykind=52 and t_partyid=fi.t_issuer  ) flag_mez, fi.t_issuer issuerid, " +
		 "rsi_rsb_fiinstr.ConvSum((select sum(y.amount) from DPORTFOLIO_TMP y where y.t_account=e.account_number_2 and y.t_fiid=fi.t_fiid  and y.t_portfid=e.portfolio  and y.report_dt = e.report_dt), fi.t_facevaluefi ,0," + GetSQLDate( RepDate ) + ") dealcostsum, " +

		 " nvl((war.t_drawingdate - war.t_firstdate + 1), 0) as d1, " +
        	 " nvl((select w1.t_drawingdate - w1.t_firstdate + 1 from  dfiwarnts_dbt w1 where  t_ispartial = CHR (0) and  fi.t_fiid = w1.t_fiid  and w1.t_drawingdate = " +
                 " (SELECT MIN (t.t_drawingdate) FROM dfiwarnts_dbt t WHERE t.t_fiid = fi.t_fiid AND t_ispartial = CHR (0)  AND t.t_drawingdate > " + GetSQLDate( RepDate ) + ")), 0) as d2, " +

		 "nvl(to_char(war.t_drawingdate,'dd.mm.yyyy'),'') coupdrawingdate, to_char(e.repay_dt,'dd.mm.yyyy') t_drawingdate, fi.t_fi_code, e.fi_group kname, /*e.security_name*/ fi.t_name avrname, e.issuer issuer, e.isin isin, e.reg_number lsin, e.currency facevaluefi, rsb_fiinstr.FI_GetNominalOnDate(fi.t_fiid, " + GetSQLDate( RepDate ) + ", 0) NominalVal, (war.t_drawingdate - " + GetSQLDate( RepDate ) + ") days " +
		 "from tRSHB_Portfolio_PKL_2CHD e, dfiwarnts_dbt war, dobjcode_dbt codes, dfininstr_Dbt fi, davrkinds_dbt kinds, davoiriss_dbt avr " +
		 "where e.report_dt = " + GetSQLDate( RepDate ) + " and fi.t_fiid = war.t_fiid(+) and war.t_ispartial(+)=chr(0) and   war.t_drawingdate(+) >= " + GetSQLDate( RepDate ) + " and war.t_firstdate(+) <= " + GetSQLDate( RepDate ) +  
		 "and codes.t_objectid(+)=fi.t_fiid and codes.t_codekind(+)=103 and t_objecttype(+)=9 and fi.t_fiid = avr.t_fiid(+) " +
		 "and fi.t_name = e.security_name and kinds.t_fi_kind=2 and fi.t_avoirkind=kinds.t_avoirkind and kinds.t_root=17 and e.account_number_2 like '50%'" +
//" and fi.t_fiid=1937 " +
		 " order by account ";







     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Current = 0;

     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"\"Остаток ценных бумаг в портфеле\"" , HTML_StSheetName);
     end;
     PrevFi = 0;
     PrevS = 0;
     v_s_BuyCost = 0; v_s_BuyNKD = 0; v_s_BuyTotalCost = 0; v_s_SaleCost = 0; v_s_SaleNKD = 0; v_s_SaleTotalCost = 0; v_s_ComS = 0; v_s_ComB = 0; v_s_FinRez = 0;

     RS = TRsbDataSet( DataQuery );
     while( RS.MoveNext() )
    

	  v_account = "";
	  v_amount = 0;

          m_IsDataExist = true;
          PrintLine( 
          /*1 */     FICode,
          /*2 */     Filial,
          /*3 */     AccBal,
          /*4 */     Acc,
          /*5 */     FIName,
          /*6 */     Seria,
          /*7 */     Emitent,
          /*8*/     Amount,
          /*9*/     NomFI,
          /*10*/     NominalRUR,
          /*11*/     Nominal,
          /*12*/     BalCostRUR,
          /*13*/     SumRUR,
          /*14*/     UNKD,
          /*15*/     Discont,
          /*16*/     BalCost, 
          /*17*/     Bcost,
          /*18*/     LastCost,
          /*19*/     DrawingDate,
          /*20*/     CoupProc,
          /*21*/     Pereots,
          /*22*/     CoupPeriod,
          /*23*/     NearDate,
          /*24*/     DayS,
          /*25*/     PKD,
          /*26*/     Premia,
          /*27*/     "",
          /*28*/     "",
          /*29*/     Reserv,
          /*30*/     getCORRINTTOEIR(RS.fiid, RepDate),  
          /*31*/     getESTRESERVE(RS.fiid, RepDate), 
          /*32*/     AccRest("50905%", RS.fiid, RepDate), 
          /*33*/     Country1,
          /*34*/     Country2,
          /*35*/     Country3,
          /*36*/     "",
          /*37*/     "",
          /*38*/     "",
          /*39*/     "",
          /*40*/     ISIN,
          /*41*/     GosReg,
          /*42*/     "",
          /*43*/     "",
          /*44*/     "",
          /*45*/     "",
          /*46*/     "",
          /*47*/     "",
          /*48*/     "",
          /*49*/     "",
          /*50*/     "",
          /*51*/     ""
    );

        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;
     ProgressIndicator.Stop();
    
    StartCaptureOutput();
    [
      select count(1) over() t_cnt,
             t_department,
             t_fiid,
             t_fi_code,
             t_departmentnum,
             case when t_balaccount is null and t_fiid = 181 and dt between to_date('24.12.2018','dd.mm.yyyy') and to_date('16.04.2019','dd.mm.yyyy') then '60102' else t_balaccount end t_balaccount,
             case when t_account is null and t_fiid = 181 and dt between to_date('24.12.2018','dd.mm.yyyy') and to_date('16.04.2019','dd.mm.yyyy') then '60102810900000000020' else t_account end t_account,
             t_issuer,
             t_amount,
             t_facefi_code,
             t_facevalueRUR,
             t_facevalue,
             t_balancecostRUR,
             t_balancecost,
             t_price,
             t_priceoverdate,
             t_overamount,
             t_reservamount,
             t_maturity,
             t_rateSS, 
             t_countryRUS,
             t_countryOESR,
             t_country,
             t_isin,
             t_lsin,
             t_accountid,
             nvl((select war.t_drawingdate - war.t_firstdate + 1 from dfiwarnts_dbt war where dat.t_fiid = war.t_fiid and war.t_ispartial =chr(0) and   war.t_drawingdate >= dt and war.t_firstdate <= dt ), 0) d1,
             nvl((select w1.t_drawingdate - w1.t_firstdate + 1 from  dfiwarnts_dbt w1 where  t_ispartial = CHR (0) and  dat.t_fiid = w1.t_fiid  and w1.t_drawingdate =  
                                          (SELECT MIN (t.t_drawingdate) FROM dfiwarnts_dbt t WHERE t.t_fiid = dat.t_fiid AND t_ispartial = CHR (0)  AND t.t_drawingdate >  dt))  , 0) d2,
             t_name,
             t_series,
             t_issue
      from (select dt,
                   fi.t_department t_department,
                   fi.t_fiid t_fiid,
                   (select nvl(max(t_code),chr(1)) 
                    from dobjcode_dbt objcode
                    where objcode.t_objecttype = 9/*Финансовый инструмент*/ and
                          objcode.t_objectid = fi.t_fiid and
                          objcode.t_codekind = 103/*Код в БИСквит*/ and
                          objcode.t_bankdate < dt and
                          (objcode.t_bankclosedate >= dt or objcode.t_bankclosedate = to_date('01.01.0001','dd.mm.yyyy'))) t_fi_code,
                   dp_dep.t_name t_departmentnum,
                   case when t_datatype = 0
                        then (select listagg(substr(mcaccdoc.t_account,1,5), ' ') within group(order by mcaccdoc.t_account) 
                              from dmcaccdoc_dbt mcaccdoc
                              where mcaccdoc.t_iscommon = chr(88) and
                                    mcaccdoc.t_owner = -1 and
                                    mcaccdoc.t_chapter = 1 and
                                    mcaccdoc.t_fiid = fi.t_fiid and
                                    mcaccdoc.t_branch = fi.t_department and
                                    (regexp_like(mcaccdoc.t_account, '^50[6|7]0') or 
                                     regexp_like(mcaccdoc.t_account, '^60[1|2]0')) and
                                    (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= dt) and
                                    rsb_account.restall(mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt-1) != 0)
                        else (select listagg(substr(mcaccdoc.t_account,1,5), ' ') within group(order by mcaccdoc.t_account)
                              from dmcaccdoc_dbt mcaccdoc
                              where mcaccdoc.t_iscommon = chr(0) and
                                    mcaccdoc.t_owner = -1 and
                                    mcaccdoc.t_chapter = 1 and
                                    mcaccdoc.t_fiid = -1 and
                                    mcaccdoc.t_branch = fi.t_department and
                                    mcaccdoc.t_dockind = 176 and /*Нога сделки РЕПО*/
                                    mcaccdoc.t_docid in (select t_id from ddl_leg_dbt l where l.t_pfi = fi.t_fiid and l.t_legid = 0 and l.t_legkind = 0) and
                                    regexp_like(mcaccdoc.t_account, '^50618') and
                                    (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= dt) and
                                    rsb_account.restall(mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt-1) != 0) end t_balaccount,
                   case when t_datatype = 0
                        then (select listagg(mcaccdoc.t_account, ' ') within group(order by mcaccdoc.t_account) 
                              from dmcaccdoc_dbt mcaccdoc
                              where mcaccdoc.t_iscommon = chr(88) and
                                    mcaccdoc.t_owner = -1 and
                                    mcaccdoc.t_chapter = 1 and
                                    mcaccdoc.t_fiid = fi.t_fiid and
                                    mcaccdoc.t_branch = fi.t_department and
                                    (regexp_like(mcaccdoc.t_account, '^50[6|7]0') or 
                                     regexp_like(mcaccdoc.t_account, '^60[1|2]0')) and
                                    (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= dt) and
                                    rsb_account.restall(mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt-1) != 0)
                        else (select listagg(mcaccdoc.t_account, ' ') within group(order by mcaccdoc.t_account) 
                              from dmcaccdoc_dbt mcaccdoc
                              where mcaccdoc.t_iscommon = chr(0) and
                                    mcaccdoc.t_owner = -1 and
                                    mcaccdoc.t_chapter = 1 and
                                    mcaccdoc.t_fiid = -1 and
                                    mcaccdoc.t_branch = fi.t_department and
                                    mcaccdoc.t_dockind = 176 and /*Нога сделки РЕПО*/
                                    mcaccdoc.t_docid in (select t_id from ddl_leg_dbt l where l.t_pfi = fi.t_fiid and l.t_legid = 0 and l.t_legkind = 0) and
                                    regexp_like(mcaccdoc.t_account, '^50618') and
                                    (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate >= dt) and
                                    rsb_account.restall(mcaccdoc.t_account, mcaccdoc.t_chapter, mcaccdoc.t_currency, dt-1) != 0) end t_account,
                   nvl(issuer.t_name,chr(1)) t_issuer,
                   fi.t_amount,
                   face.t_fi_code t_facefi_code,
                   case when fininstr.t_facevaluefi = 0 then fininstr.t_facevalue*fi.t_amount
                        else rsi_rsb_fiinstr.convsum(fininstr.t_facevalue*fi.t_amount,fininstr.t_facevaluefi,0,dt-1)
                   end t_facevalueRUR,
                   case when fininstr.t_facevaluefi = 0 then null
                        else fininstr.t_facevalue*fi.t_amount
                   end t_facevalue,
                   case when fi.t_currency = 0 then fi.t_balancecost
                        else rsi_rsb_fiinstr.convsum(fi.t_balancecost,fi.t_currency,0,dt-1)
                   end t_balancecostRUR,
                   case when fi.t_currency = 0 then null
                        else fi.t_balancecost
                   end t_balancecost,
                   fi.t_price t_price,
                   case when fi.t_overdate != to_date('01.01.0001','dd.mm.yyyy') then rsb_brkrep_u.GetRate(1, fi.t_fiid, fininstr.t_facevaluefi, 1, dt-1)
                        else null
                   end t_priceoverdate,
                   fi.t_overamount t_overamount,
                   fi.t_reservamount t_reservamount,
                   fi.t_maturity t_maturity,
                   rsb_brkrep_u.getrate(1, fi.t_fiid, fininstr.t_facevaluefi, 12/*Справедливая стоимость*/, dt-1) t_rateSS, 
                   case when issuer.t_notresident != chr(88) then 'Россия' 
                        else chr(1) 
                   end t_countryRUS,
                   case when issuer.t_notresident = chr(88) and issuercountry.t_codelat3 in ('AUS','BEL','GBR','HUN','DEU','GRC','DNK','IRL','ISR','ISL','ESP','ITA','CAN','LVA','LTU','LUX','MEX','NLD','NZL','NOR','POL','PRT','SVK','SVN','USA','TUR','FIN','FRA','CZE','CHL','CHE','SWE','EST','KOR','JPN') then nvl(issuercountry.t_name,chr(1)) 
                        else chr(1) 
                   end t_countryOESR,
                   case when issuer.t_notresident = chr(88) and issuercountry.t_codelat3 not in ('AUS','BEL','GBR','HUN','DEU','GRC','DNK','IRL','ISR','ISL','ESP','ITA','CAN','LVA','LTU','LUX','MEX','NLD','NZL','NOR','POL','PRT','SVK','SVN','USA','TUR','FIN','FRA','CZE','CHL','CHE','SWE','EST','KOR','JPN') then nvl(issuercountry.t_name,chr(1)) 
                        else chr(1) 
                   end t_country,
                   nvl(avoiriss.t_isin,chr(1)) t_isin,
                   nvl(avoiriss.t_lsin,chr(1)) t_lsin,
                   0 t_accountid,
                   fininstr.t_name,
                   avoiriss.t_series,
                   avoiriss.t_issue
            from (select dt,
                         t_department,
                         t_fiid,
                         t_currency,
                         sum(t_amount) t_amount,
                         sum(t_balancecost) t_balancecost,
                         sum(t_overamount) t_overamount,
                         sum(t_reservamount) t_reservamount,
                         max(t_overdate) t_overdate,
                         max(t_price) t_price,
                         max(t_maturity) t_maturity,
                         t_datatype
                    from (select dt,
                                 scwrthistex.t_department,
                                 scwrthistex.t_fiid,
                                 scwrthistex.t_currency,
                                 scwrthistex.t_amount,
                                 /*scwrthistex.t_balancecost - scwrthistex.t_overamount t_balancecost,*/
                                 /*scwrthistex.t_balancecost t_balancecost,*/
                                 scwrthistex.t_cost t_balancecost,
                                 scwrthistex.t_overamount,
                                 scwrthistex.t_reservamount,
                                 scwrthistex.t_overdate,
                                 listagg(rtrim(to_char(dl_leg.t_price,'fm999G999G990D99999999'),'.,'), ' ' on overflow truncate ' и т.д. ') within group (order by scwrthistex.t_dealid) over(partition by scwrthistex.t_department, scwrthistex.t_fiid) t_price,
                                 listagg(to_char(dl_leg.t_maturity,'dd.mm.yyyy'), ' ' on overflow truncate ' и т.д. ') within group (order by scwrthistex.t_dealid) over(partition by scwrthistex.t_department, scwrthistex.t_fiid) t_maturity,
                                 0 t_datatype
                          from (select dt, 
                                       scwrthistex.t_dealid,
                                       scwrthistex.t_partnum,
                                       scwrthistex.t_department,
                                       scwrthistex.t_fiid,
                                       scwrthistex.t_portfolio,
                                       scwrthistex.t_currency,
                                       scwrthistex.t_amount,
                                       scwrthistex.t_balancecost,
                                       scwrthistex.t_cost,
                                       scwrthistex.t_overamount,
                                       scwrthistex.t_reservamount,
                                       scwrthistex.t_overdate,
                                       scwrthistex.t_state,
                                       scwrthistex.t_changedate,
                                       max(scwrthistex.t_changedate) over(partition by scwrthistex.t_department, scwrthistex.t_fiid, scwrthistex.t_sumid) t_maxchangedate,
                                       scwrthistex.t_instance,  
                                       max(scwrthistex.t_instance) over(partition by scwrthistex.t_department, scwrthistex.t_fiid, scwrthistex.t_sumid, scwrthistex.t_changedate) t_maxinstance
                                from v_scwrthistex scwrthistex
                                join (select ? dt from dual) on 1=1
                                join dfininstr_dbt fininstr on fininstr.t_fi_kind = 2/*FIKIND_AVOIRISS*/ and 
                                                               fininstr.t_fiid = scwrthistex.t_fiid  
                                join davrkinds_dbt avrkinds on avrkinds.t_fi_kind = fininstr.t_fi_kind and 
                                                               avrkinds.t_avoirkind = fininstr.t_avoirkind and
                                                               rsb_fiinstr.fi_avrkindsgetroot(fininstr.t_fi_kind, fininstr.t_avoirkind) in (20/*AVOIRKIND_SHARE*/, 16/*AVOIRKIND_INVESTMENT_SHARE*/)
                                where scwrthistex.t_party = -1 and
                                      scwrthistex.t_changedate < dt) scwrthistex
                          left join ddl_leg_dbt dl_leg on dl_leg.t_dealid = scwrthistex.t_dealid and 
                                                          dl_leg.t_legkind = 0 and 
                                                          dl_leg.t_legid = scwrthistex.t_partnum
                          where scwrthistex.t_changedate = scwrthistex.t_maxchangedate and
                                scwrthistex.t_instance = scwrthistex.t_maxinstance and                        
                                scwrthistex.t_state in (1,3) and
                                scwrthistex.t_portfolio between 1 and 5 and
                                scwrthistex.t_amount > 0
                          union all /*Simanov. По заявке от Казаковой: если на дату отчета на балансе есть остаток по счетам прямого РЕПО (50618, мб и другие счета), то его выводить в отдельную строку*/
                          select dt,
                                 scwrthistex.t_department,
                                 scwrthistex.t_fiid,
                                 scwrthistex.t_currency,
                                 scwrthistex.t_amount,
                                 scwrthistex.t_cost t_balancecost,
                                 scwrthistex.t_overamount,
                                 scwrthistex.t_reservamount,
                                 scwrthistex.t_overdate,
                                 listagg(rtrim(to_char(dl_leg.t_price,'fm999G999G990D99999999'),'.,'), ' ' on overflow truncate ' и т.д. ') within group (order by scwrthistex.t_dealid) over(partition by scwrthistex.t_department, scwrthistex.t_fiid) t_price,
                                 listagg(to_char(dl_leg.t_maturity,'dd.mm.yyyy'), ' ' on overflow truncate ' и т.д. ') within group (order by scwrthistex.t_dealid) over(partition by scwrthistex.t_department, scwrthistex.t_fiid) t_maturity,
                                 1 t_datatype
                          from (select dt,
                                       scwrthistex.t_dealid,
                                       scwrthistex.t_partnum,
                                       scwrthistex.t_department,
                                       scwrthistex.t_fiid,
                                       scwrthistex.t_portfolio,
                                       scwrthistex.t_currency,
                                       scwrthistex.t_amount,
                                       scwrthistex.t_balancecost,
                                       scwrthistex.t_cost,
                                       scwrthistex.t_overamount,
                                       scwrthistex.t_reservamount,
                                       scwrthistex.t_overdate,
                                       scwrthistex.t_state,
                                       scwrthistex.t_changedate,
                                       max(scwrthistex.t_changedate) over(partition by scwrthistex.t_department, scwrthistex.t_fiid, scwrthistex.t_sumid) t_maxchangedate,
                                       scwrthistex.t_instance,  
                                       max(scwrthistex.t_instance) over(partition by scwrthistex.t_department, scwrthistex.t_fiid, scwrthistex.t_sumid, scwrthistex.t_changedate) t_maxinstance,
                                       scwrthistex.t_action
                                from v_scwrthistex scwrthistex
                                join (select ? dt from dual) on 1=1
                                join dfininstr_dbt fininstr on fininstr.t_fi_kind = 2/*FIKIND_AVOIRISS*/ and 
                                                               fininstr.t_fiid = scwrthistex.t_fiid  
                                join davrkinds_dbt avrkinds on avrkinds.t_fi_kind = fininstr.t_fi_kind and 
                                                               avrkinds.t_avoirkind = fininstr.t_avoirkind and
                                                               rsb_fiinstr.fi_avrkindsgetroot(fininstr.t_fi_kind, fininstr.t_avoirkind) in (20/*AVOIRKIND_SHARE*/, 16/*AVOIRKIND_INVESTMENT_SHARE*/)
                                join ddl_tick_dbt tick on tick.t_dealid = scwrthistex.t_dealid and
                                                          rsb_secur.DealIsRepo(tick.t_dealid) = 1 and
                                                          RSB_SECUR.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 0 and /*прямое РЕПО*/
                                                          (tick.t_closedate > dt or tick.t_closedate = to_date('01.01.0001', 'dd.mm.yyyy'))
                                where scwrthistex.t_party = -1 and
                                      scwrthistex.t_changedate <= dt) scwrthistex
                          left join ddl_leg_dbt dl_leg on dl_leg.t_dealid = scwrthistex.t_dealid and 
                                                          dl_leg.t_legkind = 0 and 
                                                          dl_leg.t_legid = scwrthistex.t_partnum
                          where scwrthistex.t_changedate = scwrthistex.t_maxchangedate and
                                scwrthistex.t_action = 0 and /*тут не уверен*/                              
                                scwrthistex.t_state in (1,3) and
                                scwrthistex.t_amount > 0) 
                          group by dt, t_department, t_fiid, t_currency, t_datatype) fi
            join dfininstr_dbt fininstr on fininstr.t_fi_kind = 2/*FIKIND_AVOIRISS*/ and 
                                           fininstr.t_fiid = fi.t_fiid  
            left join ddp_dep_dbt dp_dep on dp_dep.t_code = fi.t_department
            left join dparty_dbt issuer on issuer.t_partyid = fininstr.t_issuer
            left join dcountry_dbt issuercountry on issuer.t_notresident = chr(88) and 
                                                    issuercountry.t_codelat3 = issuer.t_nrcountry 
            left join dfininstr_dbt face on face.t_fiid = fininstr.t_facevaluefi
            left join davoiriss_dbt avoiriss on avoiriss.t_fiid = fi.t_fiid
            union all
            select dt,
                   account.t_department t_department,
                   -1 t_fiid,
                   chr(1) t_fi_code,
                   dp_dep.t_name t_departmentnum,
                   substr(account.t_account,1,5) t_balaccount,
                   account.t_account t_account,
                   account.t_nameaccount t_issuer,
                   (select nvl(max(rsb_struct.getDouble(t_text)),0) 
                    from dnotetext_dbt notetext 
                    where notetext.t_objecttype = 4/*счет*/ and 
                          notetext.t_documentid = '010000000'||account.t_account and 
                          notetext.t_notekind = 124/*Количество бумаг*/ and 
                          notetext.t_date <= dt-1 and 
                          notetext.t_validtodate >= dt-1) t_amount, 
                   (select nvl(max(rsb_struct.getString(t_text)),fininstr.t_fi_code)
                    from dnotetext_dbt notetext 
                    where notetext.t_objecttype = 4/*счет*/ and 
                          notetext.t_documentid = '010000000'||account.t_account and 
                          notetext.t_notekind = 125/*Валюта номинирования акции*/ and 
                          notetext.t_date <= dt-1 and 
                          notetext.t_validtodate >= dt-1) t_facefi_code,
                   case when fininstr.t_fiid = 0 then account.t_rest
                        else rsi_rsb_fiinstr.convsum(account.t_rest,fininstr.t_fiid,0,dt-1)
                   end t_facevalueRUR,
                   case when fininstr.t_fiid = 0 then null
                        else account.t_rest
                   end t_facevalue,
                   case when fininstr.t_fiid = 0 then account.t_rest
                        else rsi_rsb_fiinstr.convsum(account.t_rest,fininstr.t_fiid,0,dt-1)
                   end t_balancecostRUR,
                   case when fininstr.t_fiid = 0 then null
                        else account.t_rest
                   end t_balancecost,
                   null t_price,
                   null t_priceoverdate,
                   null t_overamount,
                   null t_reservamount,
                   --(select max(to_char(rsb_struct.getDate(t_text),'dd.mm.yyyy'))
                   (select max(rsb_struct.getString(t_text))
                    from dnotetext_dbt notetext 
                    where notetext.t_objecttype = 4/*счет*/ and 
                          notetext.t_documentid = '010000000'||account.t_account and 
                          notetext.t_notekind = 122/*Дата вложения*/ and 
                          notetext.t_date <= dt-1 and notetext.t_validtodate >= dt-1) t_maturity,
                   null t_rateSS, 
                   case when nvl(issuercountry.t_codelat3,chr(1)) = 'RUS' then 'Россия'
                        else chr(1)
                   end t_countryRUS,
                   case when issuercountry.t_codelat3 is not null and 
                             issuercountry.t_codelat3 != 'RUS' and 
                             issuercountry.t_codelat3 in ('AUS','BEL','GBR','HUN','DEU','GRC','DNK','IRL','ISR','ISL','ESP','ITA','CAN','LVA','LTU','LUX','MEX','NLD','NZL','NOR','POL','PRT','SVK','SVN','USA','TUR','FIN','FRA','CZE','CHL','CHE','SWE','EST','KOR','JPN') then nvl(issuercountry.t_name,chr(1)) 
                        else chr(1) 
                   end t_countryOESR,
                   case when issuercountry.t_codelat3 is not null and 
                             issuercountry.t_codelat3 != 'RUS' and 
                             issuercountry.t_codelat3 not in ('AUS','BEL','GBR','HUN','DEU','GRC','DNK','IRL','ISR','ISL','ESP','ITA','CAN','LVA','LTU','LUX','MEX','NLD','NZL','NOR','POL','PRT','SVK','SVN','USA','TUR','FIN','FRA','CZE','CHL','CHE','SWE','EST','KOR','JPN') then nvl(issuercountry.t_name,chr(1)) 
                        else chr(1) 
                   end t_country,
                   chr(1) t_isin,
                   chr(1) t_lsin,
                   account.t_accountid t_accountid,
                   fininstr.t_name,
                   chr(1) t_series,
                   chr(1) t_issue
            from (select dt, 
                         account.t_department, 
                         substr(account.t_account,1,5) t_balance, 
                         account.t_account, 
                         account.t_code_currency, 
                         -rsb_account.restall(account.t_account, account.t_chapter, account.t_code_currency, dt, account.t_code_currency) t_rest,
                         account.t_accountid t_accountid,
                         account.t_nameaccount t_nameaccount
                  from daccount_dbt account
                  join (select ? dt from dual) on 1=1
                  where regexp_like(account.t_account, '^6020[1|2|3|4]') and
                        account.t_chapter = 1 and
                        account.t_open_date < dt and
                        (account.t_open_close != chr(88) or account.t_final_date >= dt)) account
            join dfininstr_dbt fininstr on fininstr.t_fiid = account.t_code_currency
            left join ddp_dep_dbt dp_dep on dp_dep.t_code = account.t_department
            left join dcountry_dbt issuercountry on issuercountry.t_codelat3 = (select max(upper(substr(trim(rsb_struct.getString(t_text)),1,3)))
                                                                                from dnotetext_dbt notetext 
                                                                                where notetext.t_objecttype = 4/*счет*/ and 
                                                                                      notetext.t_documentid = '010000000'||account.t_account and 
                                                                                      notetext.t_notekind = 123/*Страна резиденства эмитента*/ and 
                                                                                      notetext.t_date <= dt-1 and 
                                                                                      notetext.t_validtodate >= dt-1) 
           
            where t_rest != 0) dat
           
      where not t_account is null /*Для каких-то сделок прямого РЕПО нет счетов 50618. Не знаю, как эти сделки вычленить, поэтому так.*/ 
      
      order by t_departmentnum, case when length(nvl(t_account,chr(1))) >= 20 then substr(t_account,1,8)||substr(t_account,10,11) else t_account end 
    ];

    DataQuery = EndCaptureOutput();

    Select = DL_RSDCommand(DataQuery);
    Select.AddParam(RepDate);
    Select.AddParam(RepDate);
    Select.AddParam(RepDate);

    RS = Select.execute();

    ProgressValue.Maximum = RS.value("t_cnt");
    ProgressValue.Current = 0;

    ProgressIndicator = CreateProgressIndicator(m_IsWebService);

    if( m_IsWebService and (WebMenuItem != null) )
      header = "Формирование отчета " + WebMenuItem.szNameItem;
      ProgressIndicator.Start(ProgressValue.Maximum, header, header);
    else
      ProgressIndicator.Start(ProgressValue.Maximum,"\"Отбор долевых ценных бумаг\"" , HTML_StSheetName);
    end;

    while( RS.MoveNext() )
      /*Определяем сумму резерва*/
      if(RS.value("t_accountid") == 0)
        ReserveSum = RS.value("t_reservamount");
      else
        ReserveSum = $0;
        ClearRecord(accbase);
        ClearRecord(rsvprm);
        accbase.account = RS.value("t_account");
        accbase.accountid = RS.value("t_accountid");
        if((CB_GetRsvParmForAccount(RepDate-1, accbase.account, 1, rsvprm)) and (rsvprm.ParamID != 0))
          ReserveAccount = FindReserveAccount(AccountPrimdoc(accbase, 0, rsvprm), RepDate-1);
          if(strlen(ReserveAccount) > 0)
            ReserveSum = RestA(ReserveAccount, RepDate-1);
          end;
        end;
      end;

      m_IsDataExist = true;
      PrintLine( 
          /*1 */     RS.value("t_fi_code"),
          /*2 */     RS.value("t_departmentnum"),
          /*3 */     RS.value("t_balaccount"),
          /*4 */     RS.value("t_account"),
          /*5 */     RS.value("t_name"), 
          /*6 */     RS.value("t_series") + IIF(RS.value("t_issue") != "", "/" + RS.value("t_issue"), ""),
          /*7 */     RS.value("t_issuer"),
          /*8*/     RS.value("t_amount"),
          /*9*/     RS.value("t_facefi_code"),
          /*10*/     RS.value("t_facevalueRUR"),
          /*11*/     RS.value("t_facevalue"),
          /*12*/     RS.value("t_balancecostRUR"),
          /*13*/     PortfolioAccRest(RS.fiid, RepDate),
          /*14*/     "",
          /*15*/     "",
          /*16*/     RS.value("t_balancecost"), 
          /*17*/     StrSubst( RS.value("t_price"), " ", "\n " ),
          /*18*/     RS.value("t_priceoverdate"),
          /*19*/     "",
          /*20*/     "",
          /*21*/     RS.value("t_overamount"),
          /*22*/     CoupPeriod,
          /*23*/     "",
          /*24*/     "",
          /*25*/     "",
          /*26*/     "",
          /*27*/     "",
          /*28*/     "",
          /*29*/     ReserveSum,
          /*30*/     "",  
          /*31*/     "", 
          /*32*/     AccRest("50905%", RS.fiid, RepDate), 
          /*33*/     RS.value("t_countryRUS"),
          /*34*/     RS.value("t_countryOESR"),
          /*35*/     RS.value("t_country"),
          /*36*/     "",
          /*37*/     "",
          /*38*/     "",
          /*39*/     "",
          /*40*/     RS.value("t_isin"),
          /*41*/     RS.value("t_lsin"),
          /*42*/     "",
          /*43*/     "",
          /*44*/     "",
          /*45*/     "",
          /*46*/     "",
          /*47*/     "",
          /*48*/     RS.value("t_maturity"),
          /*49*/     "",
          /*50*/     "",
          /*51*/     ""
      );

      ProgressValue.Current = ProgressValue.Current + 1;
      ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
    end;
    ProgressIndicator.Stop();

  END;
  
  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  OD1_Form = DL_OD1_Panel();

  stat = OD1_Form.Run();

  if( stat )
      OD1_Report = SP_OD1_Report( null, "Report_OD_1.xls", null, IsWebService, ReportHashCode );
      OD1_Report.Run();

      Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  end;

  return FullReportFileNames;
END;
