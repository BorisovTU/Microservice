/*
$Name:        sccnfrmrjct.mac
$Module:      Ценные бумаги
$Description: Шаг потверждения отказа от сделки
*/

import "sp_class.mac", "insdpdr.mac";

private macro ExecuteStep( Doc, FDoc, DocKind, ID_Op, ID_Step )
    record deal( dl_tick );
    var err = 0;
    var custodylinkkind = DL_KINDLINKCUSTODY_UNDEF;

    SetBuff( deal, FDoc );

    GetRegistryValue( "SECUR\\ВИД СВЯЗИ С ДЕПОЗИТАРИЕМ", V_INTEGER, custodylinkkind, err );
    if( err != 0 )
        MsgBox( "Не найдена настройка с именем: SECUR\\ВИД СВЯЗИ С ДЕПОЗИТАРИЕМ" );
        err = 1;
    end;

    if( err == 0 )
        if( ( ( custodylinkkind == DL_KINDLINKCUSTODY_DOUBWITHCTRL )
           or ( custodylinkkind == DL_KINDLINKCUSTODY_DOUBWITHSYNCANDCTRL ) )
        and not IsExistRepDepoDraft( deal.DealID ) )
            MsgBox( "В списке документов по сделке " + deal.DealCode + " отсутствует документ вида|"
                  + "\"Отчет об исполнении информационной операции " + GetInfOprRejectXld( deal.DealID ) + "\"" );
            err = 1;
        end;
    end;

    return err;
end;
