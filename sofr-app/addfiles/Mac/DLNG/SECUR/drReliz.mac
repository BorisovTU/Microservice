/*****************************************************************************/ 
/*                                                           R-Style Softlab */ 
/*                                                                           */ 
/*               Остатки по счетам доходов и расходов от реализации          */
/*                         в разрезе выпусков бумаг                          */
/*                                                                           */ 
/*  Create : Punyaev D.V.                                                    */ 
/*  Date   : 05.08.2019                                                      */ 
/*****************************************************************************/ 

import RsbFormsInter, Global, or_rep_h,"cb_sql.mac";

/*const v_specval = 26;

private macro iif(a,b,c)
      if(a)
         return b;
      else
         return c;
      end;
   end;        */




CLASS OfferRep(Begdate, Enddate)

/*var Report;
var vDAte   = pDAte;  */

var Report;                    
var rn = 1;                    
var _BegDate = begdate;        
var _EndDate = enddate;        
var sheet = 1,n_sheet = 2;     
var count = 0;                 



var EXCEL_MONEY = "\"# ##0,00\"";



var col1_len = 22,  col2_len = 15, col3_len = 45;
var col4_len = 15,  col5_len = 12,  col6_len = 16;
//var col7_len = 9,   col8_len = 7, col9_len = 7;
var color  = 12632256;  
var ColorD = 16316664;
var ColorL = 15395562;

var head_format = "ex_FS(b):ex_B(tblr):ex_BC(" + color + ")";
var format      = "ex_FS():ex_B(tblr):ex_BC(" + color + ")";

private macro ДобавитьСтроку()
  Report.AddStr();rn = rn + 1;
end;

private macro ДобавитьПустуюСтроку()
   Report.AddEmptyStr();rn = rn + 1;
end; 

private macro ПечатьШапки ()        

    ДобавитьПустуюСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":E"+(rn)+"\").merge;");
   
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":E"+(rn)+"\").merge;");
    Report.AddPrintCell("Доходы/Расходы от реализации.", col1_len, null, "r:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+rn+").WrapText = false;");
    Report.SetExecute("iBook.Sheets("+sheet+").Range(\"A"+(rn)+":E"+(rn)+"\").merge;");
    Report.AddPrintCell("За период: " + string(_Begdate) +  " - "+ string(_EndDate):f, col1_len, null, "l:ex_FS(b):ex_B()");
    ДобавитьСтроку();

    ДобавитьПустуюСтроку();

  //  rn = rn - 1;    

/*1*/   Report.AddPrintCell ("Счет",         col1_len,  null, "c:" + head_format);
/*2*/   Report.AddPrintCell ("Остаток на счете",  col2_len,  null,"c:" + head_format);
/*2*/   Report.AddPrintCell ("Наименование ценной бумаги",   col3_len,  null,"c:" + head_format);
/*4*/   Report.AddPrintCell ("ISIN",        col4_len,  null, "c:"+ head_format);
/*5*/   Report.AddPrintCell ("Сумма",       col5_len,  null, "c:" + head_format);
/*6*/   Report.AddPrintCell ("Номер госрегистрации",        col6_len,  null,"c:" + head_format); 





    ДобавитьСтроку;  color = colorD; head_format = "c:ex_FZ(8):ex_FS():ex_B(tblr):ex_BC(" + color + ")"; color = colorL;
/*1*/   Report.AddPrintCell ("1", col1_len,  null, head_format);
/*2*/   Report.AddPrintCell ("2", col2_len,  null, head_format);
/*3*/   Report.AddPrintCell ("3", col3_len,  null, head_format);
/*4*/   Report.AddPrintCell ("4", col4_len,  null, head_format);
/*5*/   Report.AddPrintCell ("5", col5_len,  null, head_format);
/*6*/   Report.AddPrintCell ("6", col6_len,  null, head_format);     
 











    Report.SetExecute("iBook.Sheets("+sheet+").Rows("+(rn-1)+").AutoFilter;");
    ДобавитьСтроку;
end;

private macro ПечатьБлокаДанных(_rs);
    if(valtype(_rs) != v_undef)
    format = "ex_FS():ex_B(tblr)";
    var test;
      while(_rs.movenext)
        Report.AddPrintCell(_rs.value("acc"), col1_len, null, "l:"+format); // 1. 
        Report.AddPrintCell(_rs.value("rest"), col2_len, null, "l:"+format); // 2.  
        Report.AddPrintCell(_rs.value("nam1"), col3_len, null, "l:"+format); // 3.  
	 Report.AddPrintCell(_rs.value("isi"), col4_len, null, "l:"+format); // 4.       
      	Report.AddPrintCell(_rs.value("sump"), col5_len, null, "l:"+format); // 5. 
	 Report.AddPrintCell(_rs.value("lsi"), col6_len, null, "l:"+format); // 6.
                
      
        ДобавитьСтроку;
                     
      end;
    end;
end;

macro run()
var SQL, cmd, rs;

  Report = CMakeReport("┌┬┬┬┬┬┬┬┬┬┬┬┐");
  Report.SetDefaultFontName("Times New Roman");
  Report.SetDefaultFontSize(10);
  //Report.SetFlagShowGrid(true);

  ПечатьШапки();

begaction(100,"Сбор данных...");
ExecMacroFile ("nu_assist.mac","UpdateTempTable");    
endaction;


                                                                                                           
SQL = "select  t_account_payer acc,                                                                        "+
"abs(max(rest1)) rest ,                                                                                    "+
"(select t_name from dfininstr_Dbt where t_fiid = pfi) nam1 ,                                              "+
"ISIN isi ,                                                                                                "+
"sum(summ1) sump,                                                                                          "+
"   LSIN lsi                                                                                               "+
"from tsgs r                                                                                               "+
"where  t_account_payer like '706%'                                                                        "+
"        and r.trndate between :beg and :end                                                       "+
"        and t_dealid in (select t_dealid from ddl_tick_dbt where t_clientid=-1)                           "+
"        and t_account_payer in (select t_account from dmcaccdoc_dbt where t_catnum in (15,37))            "+
"group by  pfi, isin, lsin, t_account_payer                                                                "+
"union                                                                                                     "+
"select  t_account_receiver acc , /*Счет*/                                                                 "+
"abs(max(rest2)) rest , /*Остаток*/                                                                        "+
"(select t_name from dfininstr_Dbt where t_fiid = pfi) nam1 ,/*Наименование ц/б*/                          "+
"  ISIN isi , /*ISIN*/                                                                                     "+
"sum(summ2)sump,/*сумма*/                                                                                  "+
" LSIN lsi /*номер госрегистрации*/                                                                        "+
"from tsgs r                                                                                               "+
"where  t_account_receiver like '706%'                                                                     "+
"        and r.trndate between :beg and :end                                                       "+
"        and t_dealid in (select t_dealid from ddl_tick_dbt where t_clientid=-1)                           "+
"        and t_account_receiver in (select t_account from dmcaccdoc_dbt where t_catnum in (15,37))         "+
"group by  pfi, isin, lsin, t_account_receiver                                                             "+
"order by 1 , 4                                                                                            ";     


   
    cmd = RSDCommand(SQL);

                           
    cmd.AddParam("end", RSDBP_IN, _BegDate);
    cmd.AddParam("beg", RSDBP_IN, _EndDate);
    begaction(100,"Сбор данных...");
    rs = RSDRecordset(cmd, rsdval_client,rsdval_static);
      ПечатьБлокаДанных(rs);
      endaction;

      Report.PrintWinRep("Доходы/Расходы от реализации.");
      Report.SetWinRepOutput();
      Report.ShowWinRep();

 





end;  

END;


/*CLASS (TRsbPanel) Pan
    initTRsbPanel();

    const Delta = 50;

    const K_Enter = 13;
    const K_F3    = 317;
    const K_F2    = 316;

    const BeginCalcDate_ID = 1;

    var curstr = 1;
    Caption = "Доходы/Расходы от реализации.";
    Status = "~ESC~Выход ~F2~Выполнить";
    setSize(37,5);
    setPosition(30,10);
    var BeginCalcDate, dx;
    var RuDataFlag = 0;
    var InPortfolioFlag = 1;

    curstr = curstr+1;
    BeginCalcDate = TRsbEditField(V_DATE);
    BeginCalcDate.setPosition(16,curstr);
    BeginCalcDate.setSize(8,1);
    BeginCalcDate.name = "begincalcdate";
    BeginCalcDate.value = {curdate};
    addControl(BeginCalcDate);

    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr,"Дата отчета:");
    addLabel (m_LabelCD);

    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));
    
    macro onKeyPressed(ev)
        if (ev.KeyCode == K_F3)
           if (ev.id == BeginCalcDate_ID)
            BeginCalcDate.value = GetDateByCalendar({CurDate});
            this.redraw; 
           end;
        elif (ev.KeyCode == K_Enter)
            //this.update;
           // EndCalcDate.value = BeginCalcDate.value + Delta;
            this.redraw; 
        elif(ev.keyCode == K_F2)
                
         var myRep = OfferRep(BeginCalcDate.value);
         myRep.run;
        end;
    end; 
END;

var myPanel:TRsbPanel = Pan;
myPanel.run;
exit(1);  */

CLASS (TRsbPanel) Pan                                                                                
    initTRsbPanel();                                                                                 
                                                                                                     
                                                                                                     
    const K_Enter = 13;                                                                              
    const K_F3    = 317;                                                                             
    const K_F2    = 316;                                                                             
                                                                                                     
    const BeginCalcDate_ID = 1;                                                                      
    const EndCalcDate_ID = 2;                                                                        
    var curstr = 1;                                                                                  
    Caption = "Доходы/Расходы от реализации.";
    Status = "~ESC~Выход ~F2~Выполнить";                                                             
    setSize(37,5);                                                                                   
    setPosition(30,10);                                                                              
    var BeginCalcDate, EndCalcDate, dx;                                                              
    var RuDataFlag = 0;                                                                              
    var InPortfolioFlag = 1;                                                                         
                                                                                                     
    curstr = curstr+1;                                                                               
    BeginCalcDate = TRsbEditField(V_DATE);                                                           
    BeginCalcDate.setPosition(16,curstr);                                                            
    BeginCalcDate.setSize(8,1);                                                                      
    BeginCalcDate.name = "begincalcdate";                                                            
    BeginCalcDate.value = {curdate};                                                                 
    addControl(BeginCalcDate);                                                                       
                                                                                                     
    EndCalcDate = TRsbEditField(V_DATE);                                                             
    EndCalcDate.setPosition(27,curstr);                                                              
    EndCalcDate.setSize(8,1);                                                                        
    EndCalcDate.name = "endincalcdate";                                                              
    EndCalcDate.value = {curdate};                                                                   
    addControl(EndCalcDate);                                                                         
                                                                                                     
    var m_LabelCD:TrsbLabel = TRsbLabel(2,curstr," За период:");                                     
    addLabel (m_LabelCD);                                                                            
                                                                                                     
    var m_LabelT:TrsbLabel = TRsbLabel(25,curstr,"~");                                               
    addLabel (m_LabelT);                                                                             
                                                                                                     
    addEventHandler(RSB_EV_KEY_PRESSED, R2M(this, "onKeyPressed"));                                  
                                                                                                     
                                                                                                     
    macro onKeyPressed(ev)                                                                           
        if (ev.KeyCode == K_F3)                                                                      
           if ((ev.id == BeginCalcDate_ID) or (ev.id == EndCalcDate_ID ))                            
            BeginCalcDate.value = GetDateByCalendar({CurDate});                                      
//            EndCalcDate.value   = BeginCalcDate.value + Delta;                                     
            this.redraw;                                                                             
           end;                                                                                      
        elif (ev.KeyCode == K_Enter)                                                                 
            //this.update;                                                                           
//            EndCalcDate.value = BeginCalcDate.value + Delta;                                       
            this.redraw;                                                                             
        elif(ev.keyCode == K_F2)                                                                     
  //       EndCalcDate.value   = BeginCalcDate.value + Delta;                                        
                                                                                                     
         var myRep = OfferRep(BeginCalcDate.value, EndCalcDate.value);                               
         myRep.run;                                                                                  
        end;                                                                                         
    end;                                                                                             
END;                                                                                                 
                                                                                                     
var myPanel:TRsbPanel = Pan;                                                                         
myPanel.run;                                                                                         
exit(1);                                                                                             