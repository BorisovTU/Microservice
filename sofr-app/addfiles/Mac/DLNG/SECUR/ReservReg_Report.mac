/*
$Name:            ReservReg_Report.mac
$Module:          АРНУ
$Description:     Отчет "Регистры по резервам" (НУ) 07.11.06
*/

IMPORT "spCache.mac", "ReservReg_Form.mac", "DLReport_h.mac", "spserv.mac", "spRepFun.mac", "oralib.mac", "ws_txreportform.mac", "RegistrReport.mac", "dldlngfun.mac";

/*Здесь можно через "," в апострофах указать код (FININSTR.FI_Code) ценных бумаг, которые будут исключаться из отчета.
  Например:
    ИсключаемыеИзОтчетаЦБ = "'1','2','3'"
*/
PRIVATE CONST ИсключаемыеИзОтчетаЦБ = "";

PRIVATE VAR   ReservReg_Form;
PRIVATE VAR   ReservReg_Report;
PRIVATE VAR   WebFormData;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб

PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

PRIVATE VAR NumStr_N1  = 0;
PRIVATE VAR NumStr_N1S = 0;
PRIVATE VAR NumStr_N2  = 0;
PRIVATE VAR NumStr_N2S = 0;

PRIVATE VAR xbeg, xend, xRezRubPrevious;
PRIVATE VAR F2_RezDif, F2_Rash, F2_Doh, F1_Rash, F1_Doh;
PRIVATE VAR RezRubValue, RezRubOldValue, RezDifValue, RashValue, DohValue;

PRIVATE CONST Строка_Итого                = 0,
              Строка_ИтогоПоВсемЦБ        = 1,
              Строка_ЗаголовокБумаги      = 2,
              Строка_ДатаСозданияРезерва  = 3,
              Строка_ИтогоЗаДатуРезерва   = 4,
              Строка_ИтогоЗаГод           = 5,
              Строка_СтрокаДанных         = 6,
              Строка_НетДанных            = 7;              

PRIVATE CONST AVOIR_TAXGROUP_INDEXNOM = 15; // группа налогового учёта "ц/б с индексированным номиналом"

PRIVATE CONST NOTEKIND_SECDEAL_DATEACCOUNTING = 24;
PRIVATE CONST NOTEKIND_SECDEAL_CONTROLCOMMENT = 26;
PRIVATE CONST NOTEKIND_SECDEAL_REJECTMPRICE   = 27;

PRIVATE CONST OBJATTR_SECDEAL_MORECONTROL       = 32;
PRIVATE CONST OBJATTR_SECDEAL_FISSKIND          = 33;
PRIVATE CONST OBJATTR_SECDEAL_METHODDETECTPRICE = 34;

PRIVATE CONST SHEET_0801  = "0801";
PRIVATE CONST SHEET_0801s = "0801_Свод";
PRIVATE CONST SHEET_0802  = "0802";
PRIVATE CONST SHEET_0802s = "0802_Свод";
PRIVATE CONST OFZIN_StartFV: MONEY = 1000.0; //номинальная стоимость облигации с индексируемым номиналом в дату начала размещения

PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ = 27;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb = 14;
PRIVATE CONST НОМЕР_СТРОКИ_ИТОГОВ_rshb = 7;

private const NoDataTxt = "ДАННЫХ НЕТ";

PRIVATE CONST REDCOLOR  = RGB(0,0,255); // BGR
PRIVATE CONST GREYCOLOR = RGB(217,217,217);

private const Cell_Begin   = "$B$16";
private const Cell_End     = "$B$17";
private const Cell_H0_13   = "$B$18";
private const Cond_NotYear = "<>\"За год\"";

private var C_Flag            ="";
private var C_SecCode         ="";
private var C_SecName         ="";
private var C_Drez            ="";
private var C_CodeB           ="";
private var C_VN              ="";
private var C_VprB            ="";
private var C_DZB             ="";
private var C_DDB             ="";
private var C_Qnty            ="";
private var C_SumBvp          ="";
private var C_SumBrub         ="";
private var C_ComB            ="";
private var C_SumBrez         ="";
private var C_RezRub          ="";
private var C_RezDif          ="";
private var C_Rash            ="";
private var C_Doh             ="";
private var C_RezMrkt         ="";
private var C_MrktRez         ="";
private var C_DMrktRez        ="";
private var C_ValMrkt         ="";
private var C_ContB           ="";
private var C_CostMrkt        ="";
private var C_Control         ="";
private var C_PrBvp           ="";
private var C_MaxMrkt         ="";
private var C_Val_MarketB     ="";
private var C_MrktB           ="";
private var C_DMrktB          ="";
private var C_QuoteValueB     ="";
private var C_DifB            ="";
private var C_RC              ="";
private var C_RC_Comment      ="";
private var C_RFISS           ="";
private var C_K_Control       ="";
private var C_Control_Comment ="";
private var C_CrBZ            ="";
private var C_Cr_Val_MrkBZ    ="";
private var C_CrBZH0          =""; 
private var C_CrBD            ="";
private var C_DR              ="";
private var C_Dqual           ="";
private var C_TypeB           ="";
private var C_SecType         ="";
private var C_ContB_Dep       ="";
private var C_ISIN            ="";

private var C_SumBvn    ="";
private var C_AmortVN   ="";
private var C_AmortRub  ="";
private var C_PrBnom    ="";
private var C_NomB      ="";
private var C_NomRez    ="";
private var C_CrVN_DZB  ="";
private var C_CrRez     ="";

private var C2_SecType    ="";   
private var C2_SecCode    ="";   
private var C2_SecName    ="";   
private var C2_RezRub31   ="";   
private var C2_RezRubS    ="";
private var C2_RashS      ="";
private var C2_DohS       ="";
private var C2_RezDifS    ="";
private var C2_RezControlS="";
private var C2_QntyS      ="";
private var C2_SumBvpS    ="";
private var C2_SumBrubS   ="";
private var C2_ISIN       ="";

PRIVATE VAR T_Dep:T_Dep_Collector;
PRIVATE VAR Protocol = TArray();

PRIVATE MACRO Операционист()
  var RS = TRsbDataSet("SELECT person.t_Name " +
                       "  FROM dperson_dbt person " +
                       " WHERE person.t_oper = " + string({oper})
                      );

  if( RS.MoveNext() )
     return RS.Name;
  end;
  return "";
END;

PRIVATE MACRO MINDATE (date1, date2)
  if (date1 <= date2)
    return date1;
  else
    return date2;
  end;
END;

PRIVATE CLASS ProtocolData(_SecCode, _SecName, _CodeB, _DZB, _Drez)
  VAR SecCode =  _SecCode,
      SecName =  _SecName,
      CodeB   =  _CodeB,
      DZB     =  _DZB,
      Drez    =  _Drez;
END;

private macro Oper_rshb():string
  var fio = GetPersnFIOByID(GetOperRecByID({oper}).PartyID);
  if(fio == "")
     return GetOperRecByID({oper}).Name;
  else
     return ConvetFIO_Report(fio);
  end;  
end;

PRIVATE CLASS CReservReg_801( Report:OBJECT )
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;
  var m_NoHeaderFlag:bool = true;

  /*отбираются акции*/
  MACRO Where():STRING
     return   " AND (   RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_SHARE+", FinInstr.t_AvoirKind) > 0 "
            + "      OR RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_DEPOSITORY_RECEIPT+", FinInstr.t_AvoirKind) > 0 )";
  END;

  MACRO REP0801 ()
     m_Report.SetActiveSheet( SHEET_0801 );

     m_Report.PrintHeader_rshb("N1_");

     m_Report.RegisterTable( "N1_MainTable", "N1_MainTableName",
                             "N1_Flag", 
                             "N1_SecCode",
                             "N1_SecName",
                             "N1_Drez",
                             "N1_CodeB",
                             "N1_VN",
                             "N1_VprB",
                             "N1_DZB",
                             "N1_DDB",
                             "N1_Qnty",
                             "N1_SumBvp",
                             "N1_SumBrub",
                             "N1_ComB",
                             "N1_SumBrez",
                             "N1_RezRub",
                             "N1_RezDif",
                             "N1_Rash",
                             "N1_Doh",
                             "N1_RezMrkt",
                             "N1_MrktRez",
                             "N1_DMrktRez",
                             "N1_ValMrkt",
                             "N1_ContB",
                             "N1_CostMrkt",
                             "N1_Control",
                             "N1_PrBvp",
                             "N1_MaxMrkt",
                             "N1_Val_MarketB",
                             "N1_MrktB",
                             "N1_DMrktB",
                             "N1_QuoteValueB",
                             "N1_DifB",
                             "N1_RC",
                             "N1_RC_Comment",
                             "N1_RFISS",
                             "N1_K_Control",
                             "N1_Control_Comment",
                             "N1_CrBZ",
                             "N1_Cr_Val_MrkBZ",
                             "N1_CrBZH0",
                             "N1_CrBD",
                             "N1_DR",
                             "N1_Dqual",
                             "N1_TypeB",
                             "N1_SecType",
                             "N1_ContB_Dep",
                             "N1_ISIN"
                           );
      m_NoDataFlag = true;
  END;

  MACRO REP0801S()
     m_Report.SetActiveSheet( SHEET_0801s );

     m_Report.PrintHeaderS1();

     m_Report.RegisterTable( "N1S_MainTable", "N1S_MainTableName",
                             "N1S_SecType",
                             "N1S_SecCode",
                             "N1S_SecName",
                             "N1S_RezRub31",
                             "N1S_RezRubS",
                             "N1S_RashS",
                             "N1S_DohS",
                             "N1S_RezDifS",
                             "N1S_RezControlS",
                             "N1S_QntyS",
                             "N1S_SumBvpS",
                             "N1S_SumBrubS",
                             "N1S_ISIN");

    m_Report.SetCellAutoSummaPoint( "",
                                 "N1S_RezRub31",2,
                                 "N1S_RezRubS",2,
                                 "N1S_RashS",2,
                                 "N1S_DohS", 2,
                                 "N1S_RezDifS", 2,
                                 "N1S_RezControlS", 2,
                                 "N1S_QntyS", 0,
                                 "N1S_SumBvpS", 2,
                                 "N1S_SumBrubS", 2
                                  );

  END;

  MACRO BeginReport()

    REP0801();

  END;

  MACRO ПечататьПромежуточныеИтоги()

     m_Report.SetSubtotal(31, 1048576,
                        "I23",
                        "J23",
                        "K23",
                        "L23",
                        "M23",
                        "P23",
                        "Q23",
                        "W23",
                        "X23",
                        "AE23"
                        );
  END;

  MACRO ПечататьПромежуточныеИтогиСвод()

     m_Report.SetSubtotal(28, 1048576,
                        "D23",
                        "E23",
                        "F23",
                        "G23",
                        "H23",
                        "I23",
                        "J23",
                        "K23",
                        "L23"
                        );
  END;

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )
     var CurStrNumb = string(/*27*/1 + NumStr_N1);

     if( LineType == Строка_СтрокаДанных )

        m_Report.PrintTableLine_2Point( "N1_SecCode", m_Report.SecCode(),    null, null,
                                 "N1_SecName",        m_Report.SecName(),           null, null,
                                 "N1_Drez",           m_Report.Drez(),              null, null,
                                 "N1_CodeB",          m_Report.CodeB(),             null, null,
                                 "N1_VN",             m_Report.VN(),                null, null,
                                 "N1_VprB",           m_Report.VprB(),              null, null,
                                 "N1_DZB",            m_Report.DZB(),               null, null,
                                 "N1_DDB",            m_Report.DDB(),               null, null,
                                 "N1_Qnty",           m_Report.Qnty(),              null, null,
                                 "N1_SumBvp",         m_Report.SumBvp(),            null, null,
                                 "N1_SumBrub",        m_Report.SumBrub(),           null, null,
                                 "N1_ComB",           m_Report.ComB(),              null, null,
                                 "N1_SumBrez",        m_Report.SetTwoSignFormula(C_SumBrub+CurStrNumb,C_DifB+CurStrNumb,"+"+C_ComB+CurStrNumb,"-", "+"), null, null,                                
                                 "N1_RezRub",         m_Report.SetIFFormula("("+C_SumBrez+CurStrNumb+"-"+C_CostMrkt+CurStrNumb+")",0,"("+C_SumBrez+CurStrNumb+"-"+C_CostMrkt+CurStrNumb+")","<=0"), null, null,
                                 "N1_RezDif",         "",                           null, null,
                                 "N1_Rash",           "",                           null, null,
                                 "N1_Doh",            "",                           null, null,
                                 "N1_RezMrkt",        double(m_Report.m_RezMrkt),      9, null,
                                 "N1_MrktRez",        m_Report.m_MrktRez,           null, null,
                                 "N1_DMrktRez",       m_Report.m_DMrktRez,          null, null,
                                 "N1_ValMrkt",        m_Report.PrintValMrkt(),      null, null,
                                 "N1_ContB",          m_Report.ContB(),             null, null,                                
                                 "N1_CostMrkt",       m_Report.SetOneSignFormula(C_RezMrkt+CurStrNumb+"*"+C_Qnty+CurStrNumb+"*"+C_CrBZH0+CurStrNumb,"",""),          null, null,                                 
                                 "N1_Control",        m_Report.SetIFFormula("("+C_CostMrkt+CurStrNumb+"-"+C_SumBrez+CurStrNumb+")",0,"("+C_CostMrkt+CurStrNumb+"-"+C_SumBrez+CurStrNumb+"+"+C_RezRub+CurStrNumb+")",">=0"), null, null,
                                 "N1_PrBvp",          m_Report.PrBvp(),             null, null,
                                 "N1_MaxMrkt",        m_Report.MaxMrkt(),           null, null,
                                 "N1_Val_MarketB",    m_Report.Val_MarketB(),       null, null,
                                 "N1_MrktB",          m_Report.MrktB(),             null, null,
                                 "N1_DMrktB",         m_Report.DMrktB(),            null, null,
                                 "N1_QuoteValueB",    m_Report.QuoteValueB(),          9, null,
                                 "N1_DifB",           m_Report.DifB(),              null, null,
                                 "N1_RC",             m_Report.RC(),                null, null,
                                 "N1_RC_Comment",     m_Report.RC_CommentB(),       null, null,
                                 "N1_RFISS",          m_Report.RFISS(),             null, null,
                                 "N1_K_Control",      m_Report.K_Control(),         null, null,
                                 "N1_Control_Comment",m_Report.Control_Comment(),   null, null,
                                 "N1_CrBZ",           m_Report.printCrBZ(),         null, null,
                                 "N1_Cr_Val_MrkBZ",   m_Report.printCr_Val_MrkBZ(), null, null,
                                 "N1_CrBZH0",         m_Report.printCrBZH0(),       null, null,
                                 "N1_CrBD",           m_Report.printCrBD(),         null, null,
                                 "N1_DR",             m_Report.DR(),                null, null,
                                 "N1_Dqual",          m_Report.Dqual(),             null, null,
                                 "N1_TypeB",          m_Report.TypeB(),             null, null,
                                 "N1_SecType",        m_Report.SecType(),           null, null,
                                 "N1_ContB_Dep",      m_Report.DepB(),              null, null,
                                 "N1_ISIN",           m_Report.ISIN(),              null, null
          );
          NumStr_N1 = NumStr_N1 + 1;
          RezRubValue = Round(RezRubValue + m_Report.RezRubValue(), 2);
          m_NoDataFlag = false;

     elif( LineType == Строка_ДатаСозданияРезерва )
        m_Report.SetCurrentLineFont( 8, false, true );

        m_Report.PrintTableLine( "N1_SecCode",  "Дата",             null,
                                 "N1_SecName",  "создания резерва", null,
                                 "N1_Drez",     m_Report.Drez(),    null
                               );
        NumStr_N1 = NumStr_N1 + 1;
        xbeg = NumStr_N1 + 1;

        RezRubOldValue = RezRubValue;
        RezRubValue = 0;
        RashValue   = 0;
        DohValue    = 0;

        m_Report.SetCurrentLineFont( 8, false, false );

     elif( LineType == Строка_ИтогоЗаДатуРезерва )
        xend = NumStr_N1;

        if(StrLen(F1_Rash) > 1)
           F1_Rash = F1_Rash + "+";
        end;
        if(StrLen(F1_Doh) > 1)
           F1_Doh = F1_Doh + "+";
        end;

        if(m_Report.H2_1() == m_Report.H0_13())
          F2_RezDif = 0.0;
          F2_Rash   = 0.0;
          F2_Doh    = 0.0;

          RezDifValue    = 0;
          RezRubOldValue = 0;
        else
          F2_RezDif = "="+C_RezRub+CurStrNumb+"-"+C_RezRub+string(xRezRubPrevious);
          F2_Rash   = m_Report.SetIFFormula( C_RezDif+CurStrNumb, "0", C_RezDif+CurStrNumb, "<=0" );
          F2_Doh    = m_Report.SetIFFormula( C_RezDif+CurStrNumb, "0", "-"+C_RezDif+CurStrNumb, ">=0" );
          F1_Rash   = F1_Rash + C_Rash+CurStrNumb;
          F1_Doh    = F1_Doh  + C_Doh+CurStrNumb;

          RezDifValue = Round(RezRubValue - RezRubOldValue, 2);
          RezRubOldValue = RezRubValue;

        end;

        if(RezDifValue < 0)
           RashValue = 0;
           DohValue  = abs(RezDifValue);
        elif(RezDifValue == 0)
           RashValue = 0;
           DohValue  = 0;
        else
           RashValue = RezDifValue;
           DohValue  = 0;
        end;

        xRezRubPrevious = NumStr_N1+1;

        m_Report.SetCurrentLineFont( 8, true, true );
        m_Report.PrintTableLine( "N1_SecCode",  "Итого по",            null,
                                 "N1_SecName",  m_Report.H1_1(),       null,
                                 "N1_Drez",     m_Report.H2_1(),       null,
                                 "N1_CodeB",    "",                    null,
                                 "N1_VN",       "",                    null,
                                 "N1_VprB",     "",                    null,
                                 "N1_DZB",      "",                    null,
                                 "N1_DDB",      "",                    null,
                                 "N1_Qnty",     "",                    null,
                                 "N1_SumBvp",   "",                    null,
                                 "N1_SumBrub",  "",                    null,
                                 "N1_ComB",     "",                    null,
                                 "N1_SumBrez",  "",                    null,                                 
                                 "N1_RezRub",   IIF(xend < xbeg, m_Report.SetSUMFormula(C_RezRub+string(xend), C_RezRub+string(xend)), m_Report.SetSUMFormula(C_RezRub+string(xbeg), C_RezRub+string(xend))), null,
                                 "N1_RezDif",   F2_RezDif,             null,
                                 "N1_Rash",     F2_Rash,               null,
                                 "N1_Doh",      F2_Doh,                null
                               );

        NumStr_N1 = NumStr_N1 + 1;

        xbeg = 0;
        xend = 0;

     elif( LineType == Строка_ЗаголовокБумаги )
        m_Report.SetCurrentLineFont( 10, false, false );
        m_Report.PrintTableLine( "N1_SecCode",  "ЦБ",             null,
                                 "N1_SecName",  m_Report.H1_1(),  null
                               );
        NumStr_N1 = NumStr_N1 + 1;
        xbeg = 0;
        xend = 0;
        xRezRubPrevious = 0;

        F1_Rash = "=";
        F1_Doh  = "=";

        RezRubValue  = 0;
        m_NoHeaderFlag = false;

     elif( LineType == Строка_ИтогоЗаГод )
        m_Report.SetCurrentLineFont( 10, true, false );
        m_Report.SetCellFont("N1_Flag",10, true, false, null, REDCOLOR, GREYCOLOR );   

        m_Report.PrintTableLine( "N1_Flag",    "N",                null,
                                 "N1_SecCode", "Итого по",         null,
                                 "N1_SecName", m_Report.H1_1(),    null,
                                 "N1_Drez",    "за год",           null,
                                 "N1_CodeB",   "",                 null,
                                 "N1_VN",      "",                 null,
                                 "N1_VprB",    "",                 null,
                                 "N1_DZB",     "",                 null,
                                 "N1_DDB",     "",                 null,
                                 "N1_Qnty",    "",                 null,
                                 "N1_SumBvp",  "",                 null,
                                 "N1_SumBrub", "",                 null,
                                 "N1_ComB",    "",                 null,
                                 "N1_SumBrez", "",                 null,
                                 "N1_RezRub",  "",                 null,
                                 "N1_RezDif",  "",                 null,
                                 "N1_Rash",    F1_Rash,            null,
                                 "N1_Doh",     F1_Doh,             null

                               );
        NumStr_N1 = NumStr_N1 + 1;

        F1_Rash = "";
        F1_Doh = "";

     elif( LineType == Строка_Итого )
        m_Report.SetCurrentLineFont( 9, true, false );
        m_Report.PrintTableLine( "N1_SecCode",  "Всего",   null
                               );
        NumStr_N1 = NumStr_N1 + 1;

        m_Report.SetCurrentLineFont( 10, false, false );
        m_Report.PrintTableLine( "N1_SecCode",  "в т.ч.", null );
        NumStr_N1 = NumStr_N1 + 1;

     elif( LineType == Строка_ИтогоПоВсемЦБ )
        m_Report.SetCurrentLineFont( 10, true, false );

     elif( LineType == Строка_НетДанных )
        m_Report.PrintTableLine( "N1_SecCode",  NoDataTxt,   null );

     end;

  END;

  MACRO ПечататьСтрокуТаблицыСвод( LineType:INTEGER )

     var CurStrNumb = string(/*27*/1 + NumStr_N1S);

     if( LineType == Строка_СтрокаДанных )
        m_Report.SetCurrentLineFont( 8, false, false );

        m_Report.PrintTableLine( "N1S_SecType",          m_Report.SecType(),            null,
                                 "N1S_SecCode",          m_Report.SecCode(),            null,
                                 "N1S_SecName",          m_Report.Secname(),            null,
                                 "N1S_RezRub31",         m_Report.FSum_SecCode_Drez(SHEET_0801, C_RezRub, "="+C2_SecCode+CurStrNumb, "="+Cell_H0_13 ), null,
                                 "N1S_RezRubS",          m_Report.FSum_SecCode_Drez(SHEET_0801, C_RezRub, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N1S_RashS",            m_Report.FSum_SecName_2Drez(SHEET_0801, C_Rash, "="+C2_SecCode+CurStrNumb, ">"+Cell_Begin, Cond_NotYear ),     null,
                                 "N1S_DohS",             m_Report.FSum_SecName_2Drez(SHEET_0801, C_Doh, "="+C2_SecCode+CurStrNumb, ">"+Cell_Begin, Cond_NotYear ),     null,
                                 "N1S_RezDifS",          m_Report.SetOneSignFormula(
                                                                    C2_RezRub31+CurStrNumb, // "D"+CurStrNumb,
                                                                    C2_RezRubS+CurStrNumb,  // "E"+CurStrNumb,
                                                                    "-" ),              null,
                                 "N1S_RezControlS",      m_Report.SetThreeSignFormula(
                                                                    C2_RezRub31+CurStrNumb, // "D"+CurStrNumb,
                                                                    C2_RezRubS+CurStrNumb,  // "E"+CurStrNumb,
                                                                    C2_RashS+CurStrNumb,    // "F"+CurStrNumb,
                                                                    C2_DohS+CurStrNumb,     // "G"+CurStrNumb,
                                                                    "-",
                                                                    "+",
                                                                    "-"),               null,
                                 "N1S_QntyS",            m_Report.FSum_SecCode_Drez(SHEET_0801, C_Qnty, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N1S_SumBvpS",          m_Report.FSum_SecCode_Drez(SHEET_0801, C_SumBvp, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N1S_SumBrubS",         m_Report.FSum_SecCode_Drez(SHEET_0801, C_SumBrub, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N1S_ISIN",             m_Report.ISIN(),               null
                                 );
        NumStr_N1S = NumStr_N1S + 1;

     elif( LineType == Строка_Итого )
        m_Report.SetCurrentLineFont( 9, true, false );
        m_Report.PrintTableLine( "N1S_SecType",  "Всего", null);
        NumStr_N1S = NumStr_N1S + 1;

        m_Report.SetCurrentLineFont( 9, false, false );
        m_Report.PrintTableLine( "N1S_SecType",  "в т.ч.", null );
        NumStr_N1S = NumStr_N1S + 1;

     elif( LineType == Строка_ИтогоПоВсемЦБ )
        m_Report.SetCurrentLineFont( 10, true, false );
     end;
  END;

  MACRO EndReport();
     if(m_NoDataFlag)
        ПечататьСтрокуТаблицы(Строка_НетДанных);
     end;
     m_Report.EndTable();
     if(m_NoDataFlag)
        if(m_NoHeaderFlag)
           m_Report.PrintHeader_supl_801( "N1_", NumStr_N1, m_NoDataFlag );
        else
           //лишние строки удаляем если была найдена хоть одна бумага
           //m_Report.DeleteRows(SHEET_0801, "14:"+string(13+NumStr_N1));
           m_Report.PrintHeader_supl_801( "N1_", NumStr_N1, m_NoDataFlag );
        end;
     else
        m_Report.PrintHeader_supl_801( "N1_", NumStr_N1, m_NoDataFlag );
        m_Report.SetOnAutoFilter(SHEET_0801, "B13:AW13");
        //m_Report.SetAutoSize();
     end;
  END;

  MACRO EndReportS();
     m_Report.EndTable();
     ПечататьПромежуточныеИтогиСвод();
     m_Report.AddStandardFooter_Reg2014( "N1S_" );
     m_Report.ReplaceAndCalculate("=", "=");
     m_Report.ReplaceAndCalculate("f=", "=");
  END;

END;

PRIVATE CLASS CReservReg_802( Report:OBJECT )
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;
  var m_NoHeaderFlag:bool = true;

  /*отбираются облигации*/
  MACRO Where():STRING
     return " AND  RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", FinInstr.t_AvoirKind) > 0 ";
  END;

  MACRO REP0802 ()
     m_Report.SetActiveSheet( SHEET_0802 );

     m_Report.PrintHeader_rshb("N2_");

     m_Report.RegisterTable( "N2_MainTable", "N2_MainTableName",
                             "N2_Flag",
                             "N2_SecCode",
                             "N2_SecName",
                             "N2_Drez",
                             "N2_CodeB",
                             "N2_VN",
                             "N2_VPrB",
                             "N2_DZB",
                             "N2_DDB",
                             "N2_Qnty",
                             "N2_SumBvn",
                             "N2_SumBrub",
                             "N2_ComB",
                             "N2_AmortVN",
                             "N2_AmortRub",
                             "N2_SumBrez",
                             "N2_RezRub",
                             "N2_RezDif",
                             "N2_Rash",
                             "N2_Doh",
                             "N2_RezMrkt",
                             "N2_MrktRez",
                             "N2_DMrktRez",
                             "N2_ContB",
                             "N2_CostMrkt",
                             "N2_Control",
                             "N2_PrBnom",
                             "N2_MaxMrkt",
                             "N2_Val_MarketB",
                             "N2_MrktB",
                             "N2_DMrktB",
                             "N2_QuoteValueB",
                             "N2_DifB",
                             "N2_RC",
                             "N2_RC_Comment",
                             "N2_RFISS",
                             "N2_K_Control",
                             "N2_Control_Comment",
                             "N2_NomB",
                             "N2_NomRez",
                             "N2_CrVN_DZB",
                             "N2_CrRez",
                             "N2_CrBD",
                             "N2_DR",
                             "N2_Dqual",
                             "N2_TypeB",
                             "N2_SecType",
                             "N2_ContB_Dep",
                             "N2_ISIN"
                           );
      m_NoDataFlag = true;
  END;

  MACRO REP0802S ()
     m_Report.SetActiveSheet( SHEET_0802s );

     m_Report.PrintHeaderS2();

     m_Report.RegisterTable( "N2S_MainTable", "N2S_MainTableName",
                             "N2S_SecType",
                             "N2S_SecCode",
                             "N2S_SecName",
                             "N2S_RezRub31",
                             "N2S_RezRubS",
                             "N2S_RashS",
                             "N2S_DohS",
                             "N2S_RezDifS",
                             "N2S_RezControlS",
                             "N2S_QntyS",
                             "N2S_SumBvpS",
                             "N2S_SumBrubS",
                             "N2S_ISIN");

    m_Report.SetCellAutoSummaPoint( "",
                                    "N2S_RezRub31",2,
                                    "N2S_RezRubS",2,
                                    "N2S_RashS",2,
                                    "N2S_DohS", 2,
                                    "N2S_RezDifS", 2,
                                    "N2S_RezControlS", 2,
                                    "N2S_QntyS", 0,
                                    "N2S_SumBvpS", 2,
                                    "N2S_SumBrubS", 2
                                  );

  END;

  MACRO BeginReport()

    REP0802();

  END;

  MACRO ПечататьПромежуточныеИтоги()

     m_Report.SetSubtotal(31, 1048576,
                        "I23",
                        "J23",
                        "K23",
                        "L23",
                        "M23",
                        "N23",
                        "O23",
                        "P23",
                        "R23",
                        "S23",
                        "X23",
                        "Y23",
                        "AF23"
                        );
  END;

  MACRO ПечататьПромежуточныеИтогиСвод()

     m_Report.SetSubtotal(28, 1048576,
                        "D23",
                        "E23",
                        "F23",
                        "G23",
                        "H23",
                        "I23",
                        "J23",
                        "K23",
                        "L23"
                        );
  END;

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     var CurStrNumb = string(/*27*/1 + NumStr_N2);

     if( LineType == Строка_СтрокаДанных )
        m_Report.PrintTableLine_2Point( "N2_SecCode",  m_Report.SecCode(),         null, null,
                                 "N2_SecName",         m_Report.SecName(),         null, null,
                                 "N2_Drez",            m_Report.Drez(),            null, null,
                                 "N2_CodeB",           m_Report.CodeB(),           null, null,
                                 "N2_VN",              m_Report.VN(),              null, null,
                                 "N2_VPrB",            m_Report.VPrB(),            null, null,
                                 "N2_DZB",             m_Report.DZB(),             null, null,
                                 "N2_DDB",             m_Report.DDB(),             null, null,
                                 "N2_Qnty",            m_Report.Qnty(),            null, null,
                                 "N2_SumBvn",          m_Report.SumBvn(),          null, null,
                                 "N2_SumBrub",         m_Report.SumBrub(),         null, null,
                                 "N2_ComB",            m_Report.ComB(),            null, null,
                                 "N2_AmortVN",         m_Report.AmortVN(),         null, null,
                                 "N2_AmortRub",        m_Report.AmortRub(),        null, null,
                                 "N2_SumBrez",         iif(m_Report.SecType == AVOIR_TAXGROUP_INDEXNOM, m_Report.SetOneSignFormula( "("+C_SumBrub+CurStrNumb+"*(1-"+C_AmortVN+CurStrNumb+"/"+C_NomB+CurStrNumb+"/"+C_Qnty+CurStrNumb+")"+"-"+ C_DifB+CurStrNumb+"+"+ C_ComB+CurStrNumb+")-(("+C_NomB+CurStrNumb+"-1000)*"+C_Qnty+CurStrNumb+")", "", ""),
                                                                                                        m_Report.SetOneSignFormula( C_SumBrub+CurStrNumb+"*(1-"+C_AmortVN+CurStrNumb+"/"+C_NomB+CurStrNumb+"/"+C_Qnty+CurStrNumb+")" +"-"+ C_DifB+CurStrNumb +"+"+ C_ComB+CurStrNumb, "", "")), null, null,
                                 "N2_RezRub",          m_Report.SetIFFormula( "("+C_SumBrez+CurStrNumb+"-"+C_CostMrkt+CurStrNumb+")", 0, C_SumBrez+CurStrNumb+"-"+C_CostMrkt+CurStrNumb, "<=0"),                 null, null,
                                 "N2_RezDif",          "",                         null, null,
                                 "N2_Rash",            "",                         null, null,
                                 "N2_Doh",             "",                         null, null,
                                 "N2_RezMrkt",         double(m_Report.m_RezMrkt),    9, null,
                                 "N2_MrktRez",         m_Report.m_MrktRez,         null, null,
                                 "N2_DMrktRez",        m_Report.m_DMrktRez,        null, null,
                                 "N2_ContB",           m_Report.ContB(),           null, null,
                                 "N2_CostMrkt",        iif(m_Report.SecType == AVOIR_TAXGROUP_INDEXNOM, m_Report.SetOneSignFormula("("+C_RezMrkt+CurStrNumb+"*"+C_NomRez+CurStrNumb+"/100-("+C_NomRez+CurStrNumb+"-1000))*"+C_Qnty+CurStrNumb,"",""),
                                                                                   m_Report.SetOneSignFormula(C_RezMrkt+CurStrNumb+"*"+C_NomRez+CurStrNumb+"/100*"+C_Qnty+CurStrNumb+"*"+C_CrRez+CurStrNumb,"","")),        null, null,
                                 "N2_Control",         m_Report.SetIFFormula( "("+C_CostMrkt+CurStrNumb+"-"+C_SumBrez+CurStrNumb+")", 0, C_CostMrkt+CurStrNumb+"-"+C_SumBrez+CurStrNumb+"+"+C_RezRub+CurStrNumb, ">=0"),                 null, null,
                                 "N2_PrBnom",          m_Report.PrBnom(),          null, null,
                                 "N2_MaxMrkt",         m_Report.MaxMrkt(),         null, null,
                                 "N2_Val_MarketB",     m_Report.Val_MarketB(),     null, null,
                                 "N2_MrktB",           m_Report.MrktB(),           null, null,
                                 "N2_DMrktB",          m_Report.DMrktB(),          null, null,
                                 "N2_QuoteValueB",     m_Report.QuoteValueB(),        9, null,
                                 "N2_DifB",            m_Report.DifB(),            null, null,
                                 "N2_RC",              m_Report.RC(),              null, null,
                                 "N2_RC_Comment",      m_Report.RC_CommentB(),     null, null,
                                 "N2_RFISS",           m_Report.RFISS(),           null, null,
                                 "N2_K_Control",       m_Report.K_Control(),       null, null,
                                 "N2_Control_Comment", m_Report.Control_Comment(), null, null,
                                 "N2_NomB",            m_Report.NomB(),            null, null,
                                 "N2_NomRez",          m_Report.NomRez(),          null, null,
                                 "N2_CrVN_DZB",        m_Report.printCrVN_DZB(),   null, null,
                                 "N2_CrRez",           m_Report.printCrRez(),      null, null,
                                 "N2_CrBD",            m_Report.printCrBD(),       null, null,
                                 "N2_DR",              m_Report.DR(),              null, null,
                                 "N2_Dqual",           m_Report.Dqual(),           null, null,
                                 "N2_TypeB",           m_Report.TypeB(),           null, null,
                                 "N2_SecType",         m_Report.SecType(),         null, null,
                                 "N2_ContB_Dep",       m_Report.DepB(),            null, null,
                                 "N2_ISIN" ,           m_Report.ISIN(),            null, null
                               );
        NumStr_N2 = NumStr_N2 + 1;
        RezRubValue = Round(RezRubValue + m_Report.RezRubValue(), 2);
        m_NoDataFlag = false;

     elif( LineType == Строка_ДатаСозданияРезерва )
        m_Report.SetCurrentLineFont( 8, false, true );

        m_Report.PrintTableLine( "N2_SecCode",  "Дата",             null,
                                 "N2_SecName",  "создания резерва", null,
                                 "N2_Drez",     m_Report.Drez(),    null
                               );
        NumStr_N2 = NumStr_N2 + 1;
        xbeg = NumStr_N2 + 1;

        RezRubOldValue = RezRubValue;
        RezRubValue = 0;
        RashValue   = 0;
        DohValue    = 0;

        m_Report.SetCurrentLineFont( 8, false, false );

     elif( LineType == Строка_ИтогоЗаДатуРезерва )
        xend = NumStr_N2;

        if(StrLen(F1_Rash) > 1)
          F1_Rash = F1_Rash + "+";
        end;
        if(StrLen(F1_Doh) > 1)
          F1_Doh = F1_Doh + "+";
        end;

        if(m_Report.H2_1() == m_Report.H0_13())
          F2_RezDif = 0;
          F2_Rash   = 0;
          F2_Doh    = 0;

          RezDifValue    = 0;
          RezRubOldValue = 0;

        else
          F2_RezDif = "="+C_RezRub+CurStrNumb+"-"+C_RezRub+string(xRezRubPrevious);
          F2_Rash   = m_Report.SetIFFormula( C_RezDif+CurStrNumb, "0", C_RezDif+CurStrNumb, "<=0" );
          F2_Doh    = m_Report.SetIFFormula( C_RezDif+CurStrNumb, "0", "-"+C_RezDif+CurStrNumb, ">=0" );;
          F1_Rash   = F1_Rash + C_Rash+CurStrNumb;
          F1_Doh    = F1_Doh  + C_Doh+CurStrNumb;

          RezDifValue = Round(RezRubValue - RezRubOldValue, 2);
          RezRubOldValue = RezRubValue;

        end;

        if(RezDifValue < 0)
           RashValue = 0;
           DohValue  = abs(RezDifValue);
        elif(RezDifValue == 0)
           RashValue = 0;
           DohValue  = 0;
        else
           RashValue = RezDifValue;
           DohValue  = 0;
        end;

        xRezRubPrevious = NumStr_N2+1;

        m_Report.SetCurrentLineFont( 8, true, true );
        m_Report.PrintTableLine( "N2_SecCode",  "Итого по",           null,
                                 "N2_SecName",  m_Report.H1_1(),      null,
                                 "N2_Drez",     m_Report.H2_1(),      null,
                                 "N2_CodeB",    "",                   null,
                                 "N2_VN",       "",                   null,
                                 "N2_VPrB",     "",                   null,
                                 "N2_DZB",      "",                   null,
                                 "N2_DDB",      "",                   null,
                                 "N2_Qnty",     "",                   null,
                                 "N2_SumBvn",   "",                   null,
                                 "N2_SumBrub",  "",                   null,
                                 "N2_ComB",     "",                   null,
                                 "N2_AmortVN",  "",                   null,
                                 "N2_AmortRub", "",                   null,
                                 "N2_SumBrez",  "",                   null,                               
                                 "N2_RezRub",   IIF(xend < xbeg, m_Report.SetSUMFormula(C_RezRub+string(xend), C_RezRub+string(xend)), m_Report.SetSUMFormula(C_RezRub+string(xbeg), C_RezRub+string(xend)) ), null,
                                 "N2_RezDif",   F2_RezDif,            null,
                                 "N2_Rash",     F2_Rash,              null,
                                 "N2_Doh",      F2_Doh,               null

                               );
        NumStr_N2 = NumStr_N2 + 1;

        xbeg = 0;
        xend = 0;

     elif( LineType == Строка_ЗаголовокБумаги )
        m_Report.SetCurrentLineFont( 10, false, false );
        m_Report.PrintTableLine( "N2_SecCode",  "ЦБ",             null,
                                 "N2_SecName",  m_Report.H1_1(),  null
                               );
        NumStr_N2 = NumStr_N2 + 1;
        xbeg = 0;
        xend = 0;
        xRezRubPrevious = 0;

        F1_Rash = "=";
        F1_Doh  = "=";

        RezRubValue  = 0;
        m_NoHeaderFlag = false;

     elif( LineType == Строка_ИтогоЗаГод )
        m_Report.SetCurrentLineFont( 10, true, false );
        m_Report.SetCellFont("N2_Flag",10, true, false, null, REDCOLOR, GREYCOLOR );

        m_Report.PrintTableLine( "N2_Flag",    "N",               null,
                                 "N2_SecCode",  "Итого по",       null,
                                 "N2_SecName",  m_Report.H1_1(),  null,
                                 "N2_Drez",     "за год",         null,
                                 "N2_CodeB",    "",               null,
                                 "N2_VN",       "",               null,
                                 "N2_VPrB",     "",               null,
                                 "N2_DZB",      "",               null,
                                 "N2_DDB",      "",               null,
                                 "N2_Qnty",     "",               null,
                                 "N2_SumBvn",   "",               null,
                                 "N2_SumBrub",  "",               null,
                                 "N2_ComB",     "",               null,
                                 "N2_AmortVN",  "",               null,
                                 "N2_AmortRub", "",               null,
                                 "N2_SumBrez",  "",               null,
                                 "N2_RezRub",   "",               null,
                                 "N2_RezDif",   "",               null,
                                 "N2_Rash",     F1_Rash,          null,
                                 "N2_Doh",      F1_Doh,           null
                               );
        NumStr_N2 = NumStr_N2 + 1;

        F1_Rash = "";
        F1_Doh = "";

     elif( LineType == Строка_Итого )

        m_Report.SetCurrentLineFont( 9, true, false );
        m_Report.PrintTableLine( "N2_SecCode",  "Всего",   null
                               );
        NumStr_N2 = NumStr_N2 + 1;

        m_Report.SetCurrentLineFont( 9, false, false );
        m_Report.PrintTableLine( "N2_SecCode",  "в т.ч.", null );
        NumStr_N2 = NumStr_N2 + 1;

     elif( LineType == Строка_ИтогоПоВсемЦБ )
        m_Report.SetCurrentLineFont( 10, true, false );

     elif( LineType == Строка_НетДанных )
        m_Report.PrintTableLine( "N2_SecCode",  NoDataTxt,   null );

     end;
  END;

  MACRO ПечататьСтрокуТаблицыСвод( LineType:INTEGER )

     var CurStrNumb = string(/*27*/1 + NumStr_N2S);

     if( LineType == Строка_СтрокаДанных )
        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine( "N2S_SecType",          m_Report.SecType(),            null,
                                 "N2S_SecCode",          m_Report.SecCode(),            null,
                                 "N2S_SecName",          m_Report.Secname(),            null,
                                 "N2S_RezRub31",         m_Report.FSum_SecCode_Drez(SHEET_0802, C_RezRub, "="+C2_SecCode+CurStrNumb, "="+Cell_H0_13 ), null,
                                 "N2S_RezRubS",          m_Report.FSum_SecCode_Drez(SHEET_0802, C_RezRub, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N2S_RashS",            m_Report.FSum_SecName_2Drez(SHEET_0802, C_Rash, "="+C2_SecCode+CurStrNumb, ">"+Cell_Begin, Cond_NotYear ),     null,
                                 "N2S_DohS",             m_Report.FSum_SecName_2Drez(SHEET_0802, C_Doh, "="+C2_SecCode+CurStrNumb, ">"+Cell_Begin, Cond_NotYear ),     null,
                                 "N2S_RezDifS",          m_Report.SetOneSignFormula(
                                                                     C2_RezRub31+CurStrNumb, //   "D"+CurStrNumb,
                                                                     C2_RezRubS+CurStrNumb,   //   "E"+CurStrNumb,
                                                                    "-" ),              null,
                                 "N2S_RezControlS",      m_Report.SetThreeSignFormula(
                                                                     C2_RezRub31+CurStrNumb,   //   "D"+CurStrNumb,
                                                                     C2_RezRubS+CurStrNumb,   //   "E"+CurStrNumb,
                                                                     C2_RashS+CurStrNumb,   //   "F"+CurStrNumb,
                                                                     C2_DohS+CurStrNumb,   //   "G"+CurStrNumb,
                                                                    "-",
                                                                    "+",
                                                                    "-"),               null,
                                 "N2S_QntyS",            m_Report.FSum_SecCode_Drez(SHEET_0802, C_Qnty, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N2S_SumBvpS",           m_Report.FSum_SecCode_Drez(SHEET_0802, C_SumBvn, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N2S_SumBrubS",          m_Report.FSum_SecCode_Drez(SHEET_0802, C_SumBrub, "="+C2_SecCode+CurStrNumb, "="+Cell_End ), null,
                                 "N2S_ISIN",              m_Report.ISIN(),               null

                                 );
        NumStr_N2S = NumStr_N2S + 1;

     elif( LineType == Строка_Итого )
        m_Report.SetCurrentLineFont( 9, true, false );
        m_Report.PrintTableLine( "N2S_SecType",  "Всего", null);
        NumStr_N2S = NumStr_N2S + 1;

        m_Report.SetCurrentLineFont( 9, false, false );
        m_Report.PrintTableLine( "N2S_SecType",  "в т.ч.", null );
        NumStr_N2S = NumStr_N2S + 1;

     elif( LineType == Строка_ИтогоПоВсемЦБ )
        m_Report.SetCurrentLineFont( 10, true, false );
     end;
  END;

  MACRO EndReport();
     if(m_NoDataFlag)
        ПечататьСтрокуТаблицы(Строка_НетДанных);
     end;
     m_Report.EndTable();

     if(m_NoDataFlag) 
        if(m_NoHeaderFlag)
           m_Report.PrintHeader_supl_802( "N2_", NumStr_N2, m_NoDataFlag );
        else
           //лишние строки удаляем если была найдена хоть одна бумага
           //m_Report.DeleteRows(SHEET_0802, "14:"+string(13+NumStr_N2));
           m_Report.PrintHeader_supl_802( "N2_", NumStr_N2, m_NoDataFlag );
        end;
     else
        m_Report.PrintHeader_supl_802( "N2_", NumStr_N2, m_NoDataFlag );
        m_Report.SetOnAutoFilter(SHEET_0802, "B13:AW13");
        //m_Report.SetAutoSize();
     end;
  END;

  MACRO EndReportS();
     m_Report.EndTable();
     ПечататьПромежуточныеИтогиСвод();
     m_Report.AddStandardFooter_Reg2014( "N2S_" );
     m_Report.ReplaceAndCalculate("=", "=");
     m_Report.ReplaceAndCalculate("f=", "=");
  END;
  
END;

PRIVATE CLASS (DL_CReportTemplate) SP_ReservReg_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, FocreFormatRep:INTEGER )
  PRIVATE VAR m_ReportKind, m_RS, m_AvrRS, m_CurReservDate, m_WhereForAvr = null,
              m_CacheFinInstr = TX_CacheFinInstr(), m_H0_9 = "", m_H0_11 = "";
  VAR m_RezMrkt, m_MrktRez, m_DMrktRez, m_ValMrkt;
  VAR m_LastGetRezMrkt_Result = false, m_LastGetRezMrkt_FIID = -1, m_LastGetRezMrkt_CalcDate = DATE(0,0,0);
  VAR m_CrVPr_DDB = NULL;
  var m_InDrawing:bool;//в обращении на дату отчёта
  var m_WasInDrawing:bool;// была в обращении от даты DATE(31, 12, Year-1)


   macro Fill_Cell_Name_801_rshb()
      C_Flag              =     "A";
      C_SecCode	          =     "B";
      C_SecName	          =	"C";
      C_Drez	          =	"D";
      C_CodeB	          =	"E";
      C_VN	          =	"F";
      C_VprB	          =	"G";
      C_DZB	          =	"H";
      C_DDB	          =	"I";
      C_Qnty	          =	"J";
      C_SumBvp	          =	"K";
      C_SumBrub	          =	"L";
      C_ComB	          =	"M";
      C_SumBrez	          =	"N";
      C_RezRub	          =	"O";
      C_RezDif	          =	"P";
      C_Rash	          =	"Q";
      C_Doh	          =	"R";
      C_RezMrkt	          =	"S";
      C_MrktRez	          =	"T";
      C_DMrktRez	  =	"U";
      C_ValMrkt	          =	"V";
      C_ContB	          =	"W";
      C_CostMrkt	  =	"X";
      C_Control	          =	"Y";
      C_PrBvp	          =	"Z";
      C_MaxMrkt	          =	"AA";
      C_Val_MarketB	  =	"AB";
      C_MrktB	          =	"AC";
      C_DMrktB	          =	"AD";
      C_QuoteValueB	  =	"AE";
      C_DifB	          =	"AF";
      C_RC	          =	"AG";
      C_RC_Comment	  =	"AH";
      C_RFISS	          =	"AI";
      C_K_Control         =	"AJ";
      C_Control_Comment	  =	"AK";
      C_CrBZ	          =	"AL";
      C_Cr_Val_MrkBZ	  =	"AM";
      C_CrBZH0	          =	"AN";
      C_CrBD	          =	"AO";
      C_DR	          =	"AP";
      C_Dqual	          =	"AQ";
      C_TypeB	          =	"AR";
      C_SecType	          =	"AS";
      C_ContB_Dep	  =	"AT";
      C_ISIN	          =	"AU";

      C2_SecType    ="A";
      C2_SecCode    ="B";
      C2_SecName    ="C";
      C2_RezRub31   ="D";
      C2_RezRubS    ="E";
      C2_RashS      ="F";
      C2_DohS       ="G";
      C2_RezDifS    ="H";
      C2_RezControlS="I";
      C2_QntyS      ="J";
      C2_SumBvpS    ="K";
      C2_SumBrubS   ="L";
      C2_ISIN       ="M";

   end;

   macro Fill_Cell_Name_802_rshb()

      C_Flag         ="A";
      C_SecCode      ="B";
      C_SecName      ="C";
      C_Drez         ="D";
      C_CodeB        ="E";
      C_VN           ="F";
      C_VPrB         ="G";
      C_DZB          ="H";
      C_DDB          ="I";
      C_Qnty         ="J";
      C_SumBvn       ="K";
      C_SumBrub      ="L";
      C_ComB         ="M";
      C_AmortVN      ="N";
      C_AmortRub     ="O";
      C_SumBrez      ="P";
      C_RezRub       ="Q";
      C_RezDif       ="R";
      C_Rash         ="S";
      C_Doh          ="T";
      C_RezMrkt      ="U";
      C_MrktRez      ="V";
      C_DMrktRez     ="W";
      C_ContB        ="X";
      C_CostMrkt     ="Y";
      C_Control      ="Z";
      C_PrBnom       ="AA";
      C_MaxMrkt      ="AB";
      C_Val_MarketB  ="AC";
      C_MrktB        ="AD";
      C_DMrktB       ="AE";
      C_QuoteValueB  ="AF";
      C_DifB         ="AG";
      C_RC           ="AH";
      C_RC_Comment   ="AI";
      C_RFISS        ="AJ";
      C_K_Control    ="AK";
      C_Control_Comment ="AL";
      C_NomB         ="AM";
      C_NomRez       ="AN";
      C_CrVN_DZB     ="AO";
      C_CrRez        ="AP";
      C_CrBD         ="AQ";
      C_DR           ="AR";
      C_Dqual        ="AS";
      C_TypeB        ="AT";
      C_SecType      ="AU";
      C_ContB_Dep    ="AV";
      C_ISIN         ="AW";

      C2_SecType    ="A";
      C2_SecCode    ="B";
      C2_SecName    ="C";
      C2_RezRub31   ="D";
      C2_RezRubS    ="E";
      C2_RashS      ="F";
      C2_DohS       ="G";
      C2_RezDifS    ="H";
      C2_RezControlS="I";
      C2_QntyS      ="J";
      C2_SumBvpS    ="K";
      C2_SumBrubS   ="L";
      C2_ISIN       ="M";

   end;

   macro Fill_Cell_Name()
      if( (m_ReportKind == RESERVREG_0801)  )
         Fill_Cell_Name_801_rshb();
      elif( (m_ReportKind == RESERVREG_0802)  )
         Fill_Cell_Name_802_rshb();
      end;
   end;

   macro sumBeginLine()
      if( (m_ReportKind == RESERVREG_0801) or (m_ReportKind == RESERVREG_0802))
         return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb;
      end;
      return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
   end;

   macro FullRange(sheet, col):string
      var s:string = "";
      var e:integer = sumBeginLine() + MAXROWSHEET;
      s = "'" + sheet + "'!";
      s = s + "$" + col + "$" + sumBeginLine();
      s = s + ":$" + col + "$" + e;
      return s;
   end;

   macro GetColRange(sheet, col, rangeSize):string
      var s:string = "";
      var e:integer = sumBeginLine() + rangeSize - 1;
      if(rangeSize < 1) 
         return "";
      end;
      if((sheet == null) or (sheet = ""))
         s = "";
      else
         s = "'" + sheet + "'!";
      end;
      s = s + "$" + col + "$" + sumBeginLine();
      s = s + ":$" + col + "$" + e;
      return s;
   end;

   MACRO SetOLD_SUMIFSFormula_1Cond(FirstColumn, SecondColumn, ThirdColumn, point )
      var Formula = "";
      var SheetName = "";

      if (point == null) point = 2; end;

      if (m_UseTemplate)
         SheetName = m_ObjTemplateXLS.SheetName();

         if (m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS) 
            Formula = "ROUND(SUMPRODUCT";
         else
            Formula = "ОКРУГЛ(СУММПРОИЗВ";
         end;

         return "="+Formula+"(("+SecondColumn+ThirdColumn+")*1;("+FirstColumn+"));"+point+")";
      end;
   END;

   macro FSum_Col_NotFlag(sheet, col, rangeSize)
      var cond1 = "<>\"N\"";
      return this.SetOLD_SUMIFSFormula_1Cond(
            GetColRange(sheet, col, rangeSize),
            GetColRange(sheet, C_Flag, rangeSize),
            cond1
      );
   end;

   macro FSum_SecCode_Drez(sheet, col, cond1, cond2)
      return this.SetOLD_SUMIFSFormula(
            FullRange(sheet, col),
            FullRange(sheet, C_SecCode),
            cond1,
            FullRange(sheet, C_Drez),
            cond2 );
   end;

   macro FSum_SecName_2Drez(sheet, col, cond1, cond2, cond3)
      return this.SetOLD_SUMIFSFormula_3_cond(
            FullRange(sheet, col),
            FullRange(sheet, C_SecName),
            cond1,
            FullRange(sheet, C_Drez),
            cond2,
            FullRange(sheet, C_Drez),
            cond3);
   end;

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  MACRO PrintProtocol()
    var i = 0;
    if(Protocol.size)

      SetActiveSheet( "Протокол - необращающиеся цб" );
      RegisterTable( "N3_MainTable",
                     "N3_SecCode", "N3_SecName", "N3_CodeB", "N3_DZB", "N3_Drez");

      m_ProgressIndicator.Start(Protocol.size, "Протокол - необращающиеся цб", "Печать протокола");

      while(i<Protocol.size)
        PrintTableLine( "N3_SecCode",  Protocol[i].SecCode, null,               //1
                        "N3_SecName",  Protocol[i].SecName, null,               //2
                        "N3_CodeB",    Protocol[i].CodeB,   null,               //3
                        "N3_DZB",      Protocol[i].DZB,     null,               //4
                        "N3_Drez",     Protocol[i].Drez,    null                //5
                      );
        m_ProgressIndicator.Update(i = i + 1,Protocol.size);
      end;
      m_ProgressIndicator.Stop();
      EndTable();
      Protocol.size = 0;
    end;
  END;

  PRIVATE MACRO GetRezMrkt( FIID:INTEGER, CalcDate:DATE ):BOOL
     VAR RS, CurrentNominal, MinCourse, SPParams:TArray = TArray();
     VAR ValidFromDate = DATE(0,0,0), NumInList;
     var Select;
     var IsBond = false;

     if( (m_LastGetRezMrkt_Result   == true) AND
         (m_LastGetRezMrkt_FIID     == FIID) AND
         (m_LastGetRezMrkt_CalcDate == CalcDate)
       )
        return m_LastGetRezMrkt_Result;
     end;

     IsBond = (m_CacheFinInstr.GetAvrKindRoot( FIID ).m_AvrKindRoot == AVOIRISSKIND_BOND);

     /*минимальное значение из всех курсов вида "средневзвешенная цена" на самую позднюю  в период от NMonths до даты <DRez>.*/
     SPParams[0] = SQLParam( "pFromFI"         , FIID                 );
     SPParams[1] = SQLParam( "pToFI"           , m_AvrRS.FaceValueFI  );
     SPParams[2] = SQLParam( "pType"           , ПолучитьВидКурса(SP_RATETYPE_MediumPrice));
     SPParams[3] = SQLParam( "pDate"           , CalcDate             );
     SPParams[4] = SQLParam( "pNMonths"        , 3                    );
     SPParams[5] = SQLParam( "pRateID"         , V_INTEGER, RSDBP_OUT );
     SPParams[6] = SQLParam( "pSinceDate"      , V_DATE   , RSDBP_OUT );
     SPParams[7] = SQLParam( "pMarketCountry"  , "RUS"                ); //на российских биржах
     SPParams[8] = SQLParam( "pIsForeignMarket", 0                    );

     if(IsBond)
       SPParams[9] = SQLParam( "pOnlyRate", 1);
     else
       SPParams[9] = SQLParam( "pOnlyRate", 0);
     end;

     MinCourse   = execStoredFunc( "RSB_FIInstr.FI_GetMinRateMonth", V_DOUBLE, SPParams );

     if( MinCourse != NULL and (MinCourse > 0) )

        Select = RSDCommand(" SELECT rate.t_IsRelative, rate.t_fiid, " +
                            "        (CASE WHEN rate.t_Market_Place > 0 THEN (SELECT pt.t_ShortName FROM dparty_dbt pt WHERE pt.t_PartyID = rate.t_Market_Place) ELSE CHR(1) END) as Market_Place_ShortName " +
                            "   FROM dratedef_dbt rate " +
                            "  WHERE rate.t_RateID = ? "
                           );

        Select.addParam( "", RSDBP_IN, SPParams.value(5).value );
        Select.execute();

        RS = TRsbDataSet( Select );
        if( RS.MoveNext() )
           m_DMrktRez = SQL_ConvTypeDate( SPParams.value(6).value );
           m_MrktRez  = RS.Market_Place_ShortName;
         /*
           m_RezMrkt  = MinCourse;
          ААИ Айс 361185
          по ЧТЗ рыночную котировку необходимо отражать в валюте котировки*/
          if(m_AvrRS.FaceValueFI == RS.FIID)
            m_RezMrkt  = MinCourse;
          else
           SPParams[1] = SQLParam( "pToFI",RS.FIID);
           SPParams[5] = SQLParam( "pRateID", V_INTEGER, RSDBP_OUT );
           SPParams[6] = SQLParam( "pSinceDate", V_DATE   , RSDBP_OUT );
           m_RezMrkt = execStoredFunc( "RSB_FIInstr.FI_GetMinRateMonth", V_DOUBLE, SPParams );
          end;
           m_ValMrkt  = RS.FIID;

           m_LastGetRezMrkt_Result   = true;
           m_LastGetRezMrkt_FIID     = FIID;
           m_LastGetRezMrkt_CalcDate = CalcDate;
           m_InDrawing               = true;
           m_WasInDrawing            = true;

           return m_LastGetRezMrkt_Result;
        end;
     end;
     /*нет подходящего курса */
     m_DMrktRez = DATE(0,0,0);
     m_RezMrkt  = 0.0;
     m_MrktRez  = "не обращается";
     m_ValMrkt  = "";

     m_LastGetRezMrkt_Result = false;

     return m_LastGetRezMrkt_Result;
  END;

  MACRO GetAddWhereForAvr()
     VAR AvrFIID, AvrGroup, AddWhere = "",
         AvrFIIDList = null,
         AvrFIIDCount : Integer = 0,
         AvrFIIDAddWhere : String = "",
         WasSetSecurity : Bool = false,

         GNUList = null,
         GNUAddWhere : String = "",
         GNUCount : Integer = 0;

     if( m_WhereForAvr == null )
        /*ценные бумаги в соединенных сделках  должны удовлетворять условиям, заданным панели подготовки отчета*/
        if( not m_IsWebService )
           AvrFIIDList = TArray();
           AvrFIIDList[AvrFIIDList.Size] = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_AVRCODE, @m_H0_11);
        else
           AvrFIIDList = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_AVRCODE, @m_H0_11);
        end;
        if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
           if( AvrFIIDList.Size > 1 )
              m_H0_11 = "";
           end;
           while( AvrFIIDCount < AvrFIIDList.Size )
              if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
              and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
                 if( AvrFIIDAddWhere == "" )
                    AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
                 else
                    AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
                    m_H0_11 = m_H0_11 + ", ";
                 end;
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " q.FIID = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
                 if( AvrFIIDList.Size > 1 )
                    m_H0_11 = m_H0_11 + WebFormData.AvrFIIDList[AvrFIIDCount].CodeList;
                 end;
              end;
              AvrFIIDCount = AvrFIIDCount + 1;
           end;
           if( AvrFIIDAddWhere != "" )
              AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
              WasSetSecurity = true;
           end;
           AddWhere = AddWhere + AvrFIIDAddWhere;
        end;

        if( not m_IsWebService )
           GNUList = TArray();
           GNUList[GNUList.Size] = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_AVRGROUP,@m_H0_9 );
        else
           GNUList = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_AVRGROUP,@m_H0_9 );
        end;
        /*задана категория бумаги*/
        if( ( ValType( GNUList ) != V_UNDEF ) and ( GNUList.Size > 0 ) )
           if( GNUList.Size > 1 )
              m_H0_9 = "";
           end;
           CorrectGNUList(@GNUList);
           while( GNUCount < GNUList.Size )
              if( ( ValType( GNUList[GNUCount] ) == V_INTEGER )
              and ( GNUList[GNUCount] > 0 ) )
                 if( GNUAddWhere == "" )
                      GNUAddWhere = GNUAddWhere + " AND ( ";
                 else
                    GNUAddWhere = GNUAddWhere + " OR ";
                    m_H0_9 = m_H0_9 + ", ";
                 end;
                 GNUAddWhere = GNUAddWhere + " q.TaxGroup = " + String( GNUList[GNUCount] ) + " ";
                 if( GNUList.Size > 1 )
                    m_H0_9 = m_H0_9 + GNUList[GNUCount];
                 end;
              end;
              GNUCount = GNUCount + 1;
           end;
           if( GNUAddWhere != "" )
              GNUAddWhere = GNUAddWhere + " ) ";
           end;
           if( not WasSetSecurity )
              AddWhere = AddWhere + GNUAddWhere;
           end;
        end;
        m_WhereForAvr = AddWhere;
     end;

     return m_WhereForAvr;
  END;

  PRIVATE MACRO CreateQueryByAvoiriss( ObjReport:OBJECT ):STRING
     VAR AddWhere = "";

     AddWhere = GetAddWhereForAvr();
     if( (ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_EXCLUDE ) == "X") AND (ИсключаемыеИзОтчетаЦБ != "") )
        AddWhere = AddWhere + " AND q.AvrCode not in (" + ИсключаемыеИзОтчетаЦБ + ")";
     end;

     /*для акций (0801) t_DrawingDate не заполняется*/ 
     if( m_ReportKind != RESERVREG_0801 )
        AddWhere = AddWhere + " AND (q.DrawingDate >= " + GetSQLDate( DATE(1,1,ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_YEAR )) ) +
                                   " OR (q.Termless = 1 and q.DrawingDate = to_date('01.01.0001', 'dd.mm.yyyy'))) ";
     end;


     return "SELECT q.*" +
          "  FROM ("
          "          SELECT fininstr.t_FIID FIID, FinInstr.t_Issuer, FinInstr.t_FI_Code AvrCode, FinInstr.t_Name AvrName, FinInstr.t_FaceValueFI, av.t_TaxGroup TaxGroup, " +
          "                 decode(av.t_ISIN,chr(1),decode(av.t_LSIN,chr(1),'',av.t_LSIN),av.t_ISIN) ISIN, av.T_EndPlacementDate EndPlacementDate, " +
          "                 RSI_RSB_FIInstr.FI_GetNominalDrawingDate(FinInstr.t_FIID, av.t_Termless, "+GetSQLDate(this.H0_8())+") as DrawingDate, "+ /* 58.0*/
          "                 (case when av.t_Termless = 'X' then 1 else 0 end) Termless" +
          "            FROM DFININSTR_DBT FinInstr, davoiriss_dbt av " +
          "           WHERE FinInstr.t_FIID = av.t_FIID " + ObjReport.Where() + //AddWhere +
          "             AND av.t_TaxGroup <> 13 AND av.t_TaxGroup <> 35 AND av.t_TaxGroup <> 919 AND av.t_TaxGroup <> 943 AND av.t_TaxGroup <> 888 AND av.t_TaxGroup <> 999" +
          "             AND (RSB_SECUR.GetObjAttrName(" + OBJTYPE_AVOIRISS + ", 57, RSB_SECUR.GetMainObjAttrNoDate(" + OBJTYPE_AVOIRISS + ", LPAD(av.t_FIID, 10, '0'), 57)) <> 'Нет')" +
          "             AND (RSB_SECUR.GetRegBoolValueAsInt('SECUR\\НАЛОГОВЫЙ УЧЕТ\\V18') = 1 OR RSB_SECUR.GetMainObjAttrNoDate(" + OBJTYPE_AVOIRISS + ", LPAD(av.t_FIID, 10, '0'), 57) = 1)" +
          "       ) q" +
          "  WHERE 1=1 " + AddWhere;
  END;

  PRIVATE MACRO Get_str_PaymDateBuy(Type, DealPart)
        return
             " (NVL( (SELECT min(dlrq.t_FactDate) " +
           "          FROM ddlrq_dbt dlrq " +
           "         WHERE dlrq.t_DocKind    = DealBuy.t_BOfficeKind " +
           "           AND dlrq.t_DocID = DealBuy.t_DealID " +
           "           AND dlrq.t_Type    = " + string(Type) +
           "           AND dlrq.t_DealPart    = " + string(DealPart) +
             "           AND dlrq.t_State = " + string(DLRQ_STATE_EXEC) +
             "           AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
             "       ), " +
             "       (NVL( (SELECT min(dlrq.t_PlanDate) " +
             "                FROM ddlrq_dbt dlrq " +
             "               WHERE dlrq.t_DocKind    = DealBuy.t_BOfficeKind " +
             "                 AND dlrq.t_DocID = DealBuy.t_DealID " +
             "                 AND dlrq.t_Type    = " + string(Type) +
             "                 AND dlrq.t_DealPart    = " + string(DealPart) +
             "                 AND dlrq.t_FactDate = TO_DATE('01-01-0001','DD-MM-YYYY') " +
           "       ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
             "       )" +
             "     )" +
           " ) ";
  END;

  PRIVATE MACRO GetQueryRestWhere(FIID, ReservDate:DATE)
    var DealKind = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_DEALKIND );
    var AddWhere = "";
    VAR QueryRest;

    if(DealKind == RESERVREG_DEALKIND_ALL)
      AddWhere = AddWhere + " AND SourceLot.t_Type in ("+TXLOTS_BUY+","+TXLOTS_BACKREPO+","+TXLOTS_LOANGET+")";
    elif(DealKind == RESERVREG_DEALKIND_BUY)
      AddWhere = AddWhere + " AND SourceLot.t_Type in ("+TXLOTS_BUY+")";
    elif(DealKind == RESERVREG_DEALKIND_BACKREPO)
        AddWhere = AddWhere + " AND SourceLot.t_Type in ("+TXLOTS_BACKREPO+","+TXLOTS_LOANGET+")";
    end;

    QueryRest =
         "  WHERE TXRest.t_FIID  = " + string(FIID) + " AND " +
         "        SourceLot.t_ID = TXRest.t_SourceID " +
         AddWhere +
         "    AND ( TXRest.t_SALEDATE > " + GetSQLDate( ReservDate ) + " OR " +
         "          TXRest.t_SALEDATE IS NULL  OR" +
         "          TXRest.t_SALEDATE = " + GetSQLDate( DATE(0,0,0) ) +
         "        ) AND " +
         "        ( TXRest.t_BUYDATE <= " + GetSQLDate( ReservDate ) + " AND " +
         "          TXRest.t_BUYDATE <> " + GetSQLDate( DATE(0,0,0) ) +
         "        ) AND " +
         "        TXRest.t_Amount > 0 ";

     return QueryRest;
  END;


  PRIVATE MACRO CreateQueryByDate( ObjReport:OBJECT, FIID:INTEGER, ReservDate:DATE ):STRING
     var query = "", QueryRest = "", ContB_ID = "";

     QueryRest =
         "SELECT TXRest.t_SourceID, NVL(sum(TXRest.T_AMOUNT),0) AS Amount" +
         "  FROM DSCTXREST_DBT TXRest, " +
         "       DSCTXLOT_DBT  SourceLot " +
         GetQueryRestWhere(FIID, ReservDate) +
         " GROUP BY TXRest.t_SourceID";

     ContB_ID = " (case when DealBuy.t_MarketID <> -1 and DealBuy.t_PartyID = -1 then DealBuy.t_MarketID else DealBuy.t_PartyID end) ";

     query = "SELECT QueryRest.Amount, DealBuy.t_DealCodeTS AS DealBuyCodeTS, dlleg.t_CFI AS BuyPriceFIID, dlleg.t_Price AS BuyPrice, dlleg.t_Principal BuyAmount, " +
                 "       dlleg.t_Cost SumBmain, dlleg.t_NKD NkdBuy, dlleg.t_CFI VprB, DealBuy.t_Department AS DealBuyDepartment, " +
                 "       TXLotBuy.t_Type as TypeB, TXLotBuy.t_DealDate AS DealBuyDate, DealBuy.t_BofficeKind AS DealBuyBofficeKind, " +
                 Get_str_PaymDateBuy(DLRQ_TYPE_DELIVERY, 1) + " as t_BuyDate, " +
                 Get_str_PaymDateBuy(DLRQ_TYPE_PAYMENT, 1) + " as t_PaymDate, " +
                 "       DealBuy.t_DealID AS DealBuyID, rsb_secur.get_OperationGroup(BuyOper.t_SysTypes) AS DealBuyGroup, " +
                         ContB_ID +" AS BuyPartyID, " +
                 "       (select party.t_Name " +
                 "          from dparty_dbt party " +
                 "         where party.t_PartyID = "+ContB_ID+") AS BuyPartyName, " +
                 "       Rsb_SCTX.GetMarketPrice_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ) AS BuyMarketPrice,"+
                 "       NVL(Rsb_SCTX.GetVal_Market_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ), 0) AS Val_MarketB,"+
                 "       NVL((select t_fiid from dfininstr_dbt where t_fi_kind=1 and t_iso_number = "+
                 "          Rsb_SCTX.GetVal_Market_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ) and rownum = 1), 0) AS Val_MarketB_Fiid,"+
                 "       Rsb_SCTX.GetMarket_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ) AS BuyMarket,"+
                 "       Rsb_SCTX.GetDateMarket_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ) AS BuyDateMarket, "+
                 "       Rsb_SCTX.GetQuoteValue_NEW( TXLotBuy.t_ID, "+GetSQLDate(this.H0_8())+" ) AS QuoteValueB, "+
                 //"       Rsb_SCTX.CheckObjAttrPresenceByNum(3,74,'1',lpad("+ContB_ID+", 10, '0'),TXLotBuy.t_DEALDATE) DepB "
                 "       rsb_secur.GetMainObjAttr(3, lpad(" + ContB_ID + ", 10, '0'), 58, TXLotBuy.t_DEALDATE) DepB, "
                 "        CASE WHEN((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) THEN 1 ELSE 0 end as IsDUDealB, " +
                 "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) as ImportDUDate " +
                 "  FROM (" + QueryRest + ") QueryRest," +
                 "       DDL_TICK_DBT  DealBuy," +
                 "       DOPRKOPER_DBT BuyOper, " +
                 "       DDL_LEG_DBT   dlleg, " +
                 "       DSCTXLOT_DBT  TXLotBuy " +
                 " WHERE TXLotBuy.t_ID  = QueryRest.t_SourceID AND " +
                 "       TXLotBuy.t_DealID  = DealBuy.t_DealID AND " +
                 "       BuyOper.t_Kind_Operation = DealBuy.t_DealType AND " +
                 "       BuyOper.t_DocKind        = DealBuy.t_BOfficeKind AND " +
                 "       dlleg.t_LegKind = "+ string(LEG_KIND_DL_TICK) + " AND " +
                 "       dlleg.t_DealID  = DealBuy.t_DealID AND " +
                 "       dlleg.t_LegID   = 0 " +

                 "ORDER BY TXLotBuy.t_BuyDate";

     return query;
  END;

  PRIVATE MACRO GetFromForm_YEAR()
     return ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_YEAR );
  END;

  PRIVATE MACRO GetFromForm_GROWTH()
     return true;
  END;

  PRIVATE MACRO GetFromForm_PERIOD()
     var y, y2;
     ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_PERIOD, @y, @y2 );
     return y2;
  END;


   macro GetYear():string
     var y, y2;
     y2 = GetFromForm_YEAR();
     return string(y2);

   end;

   macro GetPeriodCode():string
      var code = "";
      var p, p2;
      var gr:bool = false;

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3)))
         code = "21";
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "31";
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "33";
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = "34";
      end;

      return code;
   end;

   macro GetPeriodTxt():string
      const ytxt = " ГОДА";
      const y2txt = " ГОД";
      const mtxt = " МЕСЯЦЕВ ";
      const m2txt = " МЕСЯЦА ";
      const qtxt = " КВАРТАЛ ";

      var code = "";
      var p, p2;
      var gr:bool = false;
      var y = GetYear();

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3))) // 1 кв
         code = "1"+qtxt+y+ytxt;
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "I ПОЛУГОДИЕ " + y + ytxt;
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "9" + mtxt + y + ytxt;
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = y + y2txt;
      elif((p2 == 1))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      elif(gr and (p2 > 1) and (p2 < 5))
         code = string(p2) + m2txt + y + ytxt;
      elif(gr and (p2 > 4) and (p2 < 12))
         code = string(p2) + mtxt + y + ytxt;
      elif((not gr) and (p2 > 13) and (p2 < 17))
         code = string(p2-12) + qtxt + y + ytxt;
      elif((not gr) and (p2 > 0) and (p2 < 13))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      end;

      return code;
   end;


  MACRO PrintHeader( FldPref:STRING )

     PrintFormatString( null,
            FldPref+"ДатаСоставления_H", string(Date() + " " + Time()), //  Дата составления
            FldPref+"Операционист_H" , Операционист(), 
            FldPref+"H0_A:l"  , this.H0_A(),   // Банк
            FldPref+"H0_B1:l" , this.H0_B1(),  // Инн
            FldPref+"H0_B2:l" , this.H0_B2(),  // КПП
            FldPref+"H0_3"   , this.H0_3(),
            FldPref+"H0_6"   , this.H0_6(),  // Имя отчета
            FldPref+"H0_7"   , this.H0_7(),  // за период с
            FldPref+"H0_8"   , this.H0_8(),  // по
            FldPref+"H0_13"  , this.H0_13(),  // КПОП
            FldPref+"H0_9"   , this.H0_9(),  // Группа налогового учета
            FldPref+"H0_11"  , this.H0_11()  // Выпуск ц/б
          );
  END;

  MACRO PrintHeader_rshb( FldPref:STRING )

     PrintFormatString( "",
                       FldPref+"Операционист_H",   oper_rshb(),
                       FldPref+"H0_Year",          GetYear(),
                       FldPref+"H0_PeriodCode",    GetPeriodCode(),
                       FldPref+"H0_PeriodTxt",     GetPeriodTxt()
                     );

  END;

   MACRO PrintHeader_supl_801( FldPref:STRING, rangeSize, m_NoDataFlag:bool )
      if(m_NoDataFlag)// DEF-49597. Заполнять формулы с нулевыми значениями даже если нет данных
         PrintFormatString( "",
                            FldPref+"H0_Rash",   SetOLD_SUMIFSFormula_1Cond("0", "A14", "<>\"N\""),
                            FldPref+"H0_Doh",    SetOLD_SUMIFSFormula_1Cond("0", "A14", "<>\"N\"")
                          );
      else
         PrintFormatString( "",
                            FldPref+"H0_Rash",   FSum_Col_NotFlag(null, C_Rash, rangeSize),
                            FldPref+"H0_Doh",    FSum_Col_NotFlag(null, C_Doh,  rangeSize)
                          );
      end;
   END;

   MACRO PrintHeader_supl_802( FldPref:STRING, rangeSize, m_NoDataFlag:bool )
      if(m_NoDataFlag)// DEF-49597. Заполнять формулы с нулевыми значениями даже если нет данных
         PrintFormatString( "",
                            FldPref+"H0_Rash",   SetOLD_SUMIFSFormula_1Cond("0", "A14", "<>\"N\""),
                            FldPref+"H0_Doh",    SetOLD_SUMIFSFormula_1Cond("0", "A14", "<>\"N\"")
                          );
      else
         PrintFormatString( "",
                            FldPref+"H0_Rash",   FSum_Col_NotFlag(null, C_Rash, rangeSize),
                            FldPref+"H0_Doh",    FSum_Col_NotFlag(null, C_Doh,  rangeSize)
                          );     
      end;
   END;

  MACRO PrintHeaderS1()

     PrintFormatString( null,
            "N1S_ДатаСоставления_H", string(Date() + " " + Time()),     //  Дата составления
            "N1S_Операционист_H" , Операционист() ,    // Операционист
            "N1S_H0_A:l" , this.H0_A(),  // Банк
            "N1S_H0_B1:l", this.H0_B1(),  // Инн
            "N1S_H0_B2:l", this.H0_B2(),  // КПП
            "N1S_H0_7"   , this.H0_7(),  // за период с
            "N1S_H0_8"   , this.H0_8(),  // по
            "N1S_H0_13"  , this.H0_13(),  // КПОП
            "N1S_K1"     , "f=F27-'"+SHEET_0801+"'!"+C_Rash+string(НОМЕР_СТРОКИ_ИТОГОВ_rshb),  // КПОП
            "N1S_K2"     , "f=G27-'"+SHEET_0801+"'!"+C_Doh +string(НОМЕР_СТРОКИ_ИТОГОВ_rshb)  // КПОП
          );
  END;

  MACRO PrintHeaderS2()

     PrintFormatString( null,
            "N2S_ДатаСоставления_H", string(Date() + " " + Time()),     //  Дата составления
            "N2S_Операционист_H" , Операционист() ,    // Операционист
            "N2S_H0_A:l" , this.H0_A(),  // Банк
            "N2S_H0_B1:l", this.H0_B1(),  // Инн
            "N2S_H0_B2:l", this.H0_B2(),  // КПП
            "N2S_H0_7"   , this.H0_7(),  // за период с
            "N2S_H0_8"   , this.H0_8(),  // по
            "N2S_H0_13"  , this.H0_13(),  // КПОП
            "N2S_K1"     , "f=F27-'"+SHEET_0802+"'!"+C_Rash+string(НОМЕР_СТРОКИ_ИТОГОВ_rshb),  // КПОП
            "N2S_K2"     , "f=G27-'"+SHEET_0802+"'!"+C_Doh +string(НОМЕР_СТРОКИ_ИТОГОВ_rshb)  // КПОП
          );
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
     VAR i = 0, AvrDataQuery, DataQuery, str, header = "", AvrDataQuery_NRec = 0, DataQuery_NRec = 0, AvrDataQuery_i= 0, DataQuery_i = 0;
     var IsExcel = true;
     var RestQuery = "";
     VAR Year = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_YEAR );
     VAR ByMonth = ReservReg_Form.GetFieldValue(PNFLD_RESERVREG_BY_MONTH);

     VAR ReservDates = TArray();
     if (ByMonth)
        ReservDates[ReservDates.Size] = DATE(31, 12, Year-1);
        ReservDates[ReservDates.Size] = DATE(31, 1, Year);
        if (GetDaysInYear(Year) == 366)
           ReservDates[ReservDates.Size] = DATE(29, 2, Year);
        else
           ReservDates[ReservDates.Size] = DATE(28, 2, Year);
        end;
        ReservDates[ReservDates.Size] = DATE(31, 3, Year);
        ReservDates[ReservDates.Size] = DATE(30, 4, Year);
        ReservDates[ReservDates.Size] = DATE(31, 5, Year);
        ReservDates[ReservDates.Size] = DATE(30, 6, Year);
        ReservDates[ReservDates.Size] = DATE(31, 7, Year);
        ReservDates[ReservDates.Size] = DATE(31, 8, Year);
        ReservDates[ReservDates.Size] = DATE(30, 9, Year);
        ReservDates[ReservDates.Size] = DATE(31, 10, Year);
        ReservDates[ReservDates.Size] = DATE(30, 11, Year);
        ReservDates[ReservDates.Size] = DATE(31, 12, Year);
     else
        ReservDates[ReservDates.Size] = DATE( 31, 12, Year-1 );
        ReservDates[ReservDates.Size] = DATE( 31,  3, Year );
        ReservDates[ReservDates.Size] = DATE( 30,  6, Year );
        ReservDates[ReservDates.Size] = DATE( 30,  9, Year );
        ReservDates[ReservDates.Size] = DATE( 31, 12, Year );
     end;

     Fill_Cell_Name();
     m_CacheFinInstr.Clear();

     m_LastGetRezMrkt_Result   = false;
     m_LastGetRezMrkt_FIID     = -1;
     m_LastGetRezMrkt_CalcDate = DATE(0,0,0);

     T_Dep.ClearArray();
     ObjReport.BeginReport();

     AvrDataQuery = CreateQueryByAvoiriss( ObjReport );

     if((ReservDates.Size > 0) AND (ReservDates[0] <= this.H0_8()))
       while( (i < ReservDates.Size) AND (ReservDates[i] <= this.H0_8()) )

         if(i > 0)
           RestQuery = RestQuery + " OR ";
         end;
         RestQuery = RestQuery + " Exists (SELECT TXRest.T_ID "
                               + "         FROM DSCTXREST_DBT TXRest, "
                               + "              DSCTXLOT_DBT  SourceLot "
                               +           GetQueryRestWhere("q.FIID", ReservDates[i]) + " AND ROWNUM = 1 ) ";
         i = i + 1;
       end;
     end;

     if(RestQuery != "")
       AvrDataQuery = AvrDataQuery + " AND ("+RestQuery+")";
     end;

     AvrDataQuery = AvrDataQuery + " order by q.TaxGroup, q.AvrCode";
     AvrDataQuery_NRec = SQL_GetNRecs( AvrDataQuery );
     header = "Выпуск регистра по резервам подвида " + iif(m_ReportKind == RESERVREG_0801,SHEET_0801,SHEET_0802);
     m_ProgressIndicator.Start(AvrDataQuery_NRec, header, header);
     /*по всем подходящим бумагам*/
     m_AvrRS = TRsbDataSet( AvrDataQuery );
     while( m_AvrRS.MoveNext() ) 
        if((m_AvrRS.Termless != 1) or (m_AvrRS.DrawingDate != date(0, 0, 0)))
           m_WasInDrawing = false;
           ObjReport.ПечататьСтрокуТаблицы( Строка_ЗаголовокБумаги );

           /*по дате резерва для бумаги*/
           i = 0;
           while( (i < ReservDates.Size) AND (ReservDates[i] <= this.H0_8()) ) 
              m_CurReservDate = ReservDates[i];
              ObjReport.ПечататьСтрокуТаблицы( Строка_ДатаСозданияРезерва );

              DataQuery = CreateQueryByDate( ObjReport, m_AvrRS.FIID, ReservDates[i] );

              /*Вызов прогресс-бара для любого количества очень тормозит отчет.
                Поэтому вычисляем кол-во.
              */
              DataQuery_NRec = SQL_GetNRecs( DataQuery );
              DataQuery_i = 0;
              if (DataQuery_NRec > 0)
                 str = "Отчет по бумаге " + m_AvrRS.AvrName + " за дату " + m_CurReservDate;

                 m_ProgressIndicator.Start(DataQuery_NRec, str, str);
                 m_RS = TRsbDataSet( DataQuery );

                 while( m_RS.MoveNext() ) 
                    this.ClearCacheOneRecord();
                    if( GetRezMrkt( m_AvrRS.FIID, m_CurReservDate ) or m_WasInDrawing )
                       ObjReport.ПечататьСтрокуТаблицы( Строка_СтрокаДанных );
                    else
                       if( not IsExcel)
                          MsgBox( "Бумага \""+ this.SecCode() +"\" не является обращающейся на ОРЦБ на дату "+this.DZB()+" (сделка \""+this.CodeB()+"\")" );
                       else
                          Protocol[Protocol.size] = ProtocolData(this.SecCode(), this.SecName(), this.CodeB(), this.DZB(), this.Drez());
                       end;
                    end;
                    DataQuery_i = DataQuery_i + 1;
                    m_ProgressIndicator.Update(DataQuery_i,DataQuery_NRec,str); // всего 3 парамера Update(index, count, text)
                 end;
                 m_ProgressIndicator.Stop();
              end;

              ObjReport.ПечататьСтрокуТаблицы( Строка_ИтогоЗаДатуРезерва );
              i = i + 1;
           end; /*по дате резерва для бумаги*/

           ObjReport.ПечататьСтрокуТаблицы( Строка_ИтогоЗаГод );
        else
           MsgBox("По облигации с признаком \"бессрочная\" " + m_AvrRS.ISIN + IIF((m_AvrRS.ISIN != "") and (m_AvrRS.AvrName != ""), ", ", "") + m_AvrRS.AvrName);
        end;

        m_ProgressIndicator.Update(AvrDataQuery_i = AvrDataQuery_i + 1,AvrDataQuery_NRec, header); // всего 3 парамера Update(index, count, text)
     end; /*по всем подходящим бумагам*/

     m_ProgressIndicator.Stop();
     ObjReport.EndReport();

     /*Сводный лист*/
     if( m_ReportKind == RESERVREG_0801 )
        ObjReport.REP0801S();
     elif( m_ReportKind == RESERVREG_0802 )
        ObjReport.REP0802S();
     end;

     ObjReport.ПечататьСтрокуТаблицыСвод( Строка_Итого );
     m_AvrRS = TRsbDataSet( AvrDataQuery );

     AvrDataQuery_NRec = SQL_GetNRecs( AvrDataQuery );
     header = "Выпуск сводного листа регистра по резервам подвида " + iif(m_ReportKind == RESERVREG_0801,SHEET_0801,SHEET_0802);
     m_ProgressIndicator.Start(AvrDataQuery_NRec, header, header);

     while( m_AvrRS.MoveNext() )
        if(AvrDataQuery_NRec > 0)
           if( GetRezMrkt( m_AvrRS.FIID, date(31,12,year-1)) or GetRezMrkt( m_AvrRS.FIID, date(31,3,year)) or GetRezMrkt( m_AvrRS.FIID, date(30,6,year)) or GetRezMrkt( m_AvrRS.FIID, date(30,9,year)) or GetRezMrkt( m_AvrRS.FIID, date(31,12,year)))
              ObjReport.ПечататьСтрокуТаблицыСвод( Строка_СтрокаДанных );
              m_ProgressIndicator.Update(AvrDataQuery_i = AvrDataQuery_i + 1,AvrDataQuery_NRec, header); // всего 3 парамера Update(index, count, text)
           end; /*по всем подходящим бумагам*/
        end;
     end;

     m_ProgressIndicator.Stop();
     ObjReport.EndReportS();
  END;

  PRIVATE MACRO CreateReportByKind( Kind:INTEGER )
     m_ReportKind = Kind;
     m_WhereForAvr = null;

     if( Kind == RESERVREG_0801 )
        ExecuteReport( CReservReg_801(this) );
     elif( Kind == RESERVREG_0802 )
        ExecuteReport( CReservReg_802(this) );
     end;
  END;

   MACRO SetOnAutoFilter(sheet, range)
     if( ExistsSheet( sheet ) )
         m_ObjTemplateXLS.SetAutoFilter(range, sheet);
     end;
   end;

   MACRO DeleteRows(sheet, range)
      if( ExistsSheet( sheet ) )
         m_ObjTemplateXLS.RemoveRow(range, sheet);
      end;
   end;


  PRIVATE MACRO SetAutoFilter()
     if( ExistsSheet( SHEET_0801s ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:M28", SHEET_0801s);
     end;

     if( ExistsSheet( SHEET_0802s ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:M28", SHEET_0802s);
     end;
  END;

  PRIVATE MACRO EndReport()
     EndReport();
     SetAutoFilter();
  END;

  PRIVATE MACRO Create()
     Protocol.size = 0;

     var SubKindList = null;
     var SubKindCount : Integer = 0;

     NumStr_N1  = 0;
     NumStr_N1S = 0;
     NumStr_N2  = 0;
     NumStr_N2S = 0;

     if( not m_IsWebService )
        SubKindList = TArray();
        SubKindList[SubKindList.Size] = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_SUBKIND );
     else
        SubKindList = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_SUBKIND );
     end;

     if( ( ValType( SubKindList ) != V_UNDEF )
     and ( SubKindList.Size > 0 )
     and ( ValType( SubKindList[SubKindCount] ) == V_INTEGER )
     and ( SubKindList[SubKindCount] != RESERVREG_ALL ) )
        while( SubKindCount < SubKindList.Size )
           CreateReportByKind( SubKindList[SubKindCount] );
           SubKindCount = SubKindCount + 1;
        end;
     else
        CreateReportByKind( RESERVREG_0801 );
        CreateReportByKind( RESERVREG_0802 );
     end;

     PrintProtocol();
  END;

  PRIVATE VAR m_DZB, m_PrBNom, m_ComB, m_AmortRub, m_AmortVN, m_CrVN_DZB, m_CrBZ, m_Cr_Val_MrkBZ, m_CrBZH0, m_MaxMrkt, m_Val_MarketB, m_QuoteValueB, m_Val_MarketB_Fiid,
              m_SumBvp, m_SumBvn, m_CostMrkt, m_CrB, m_SumBrub, m_CrVN_DDB, m_CrSpezB,
              m_CrBD, m_CrRez, m_NomB, m_NomRez, m_CrSZ, m_PrBvp, m_CrBP, m_DifB, m_RC, m_RFISS, m_K_Control, m_Control_Comment, m_DR, m_DQual,
              m_pwrtsum = TBFile( "pmwrtsum.dbt", "R", 0 ),
              m_DealBuy = TBFile( "dl_tick.dbt", "R", 0 );
  MACRO ClearCacheOneRecord()
     m_DZB             = null;
     m_PrBNom          = null;
     m_ComB            = null;
     m_DealBuy.Clear();
     m_pwrtsum.Clear();
     m_AmortRub        = null;
     m_AmortVN         = null;
     m_CrVN_DZB        = null;
     m_CrBZ            = null;
     m_Cr_Val_MrkBZ    = null;
     m_CrBZH0          = null;
     m_CrBD            = null;
     m_CrRez           = null;
     m_NomB            = null;
     m_NomRez          = null;
     m_CrSZ            = null;
     m_SumBvp          = null;
     m_SumBvn          = null;
     m_CostMrkt        = null;
     m_PrBvp           = null;
     m_CrBP            = null;
     m_DifB            = null;
     m_RC              = null;
     m_RFISS           = null;
     m_K_Control       = null;
     m_Control_Comment = null;
     m_DR              = null;
     m_DQual           = null;
     m_MaxMrkt         = null;
     m_Val_MarketB     = null;
     m_Val_MarketB_Fiid= null;
     m_QuoteValueB     = null;
     m_CrB             = null;
     m_SumBrub         = null;
     m_CrVN_DDB        = null;
     m_CrSpezB         = null;
     m_InDrawing       = false;
  END;

  PRIVATE MACRO GetDeal( Deal:TBFile, DealID:INTEGER ):BOOL
     Deal.Clear();
     Deal.rec.DealID = DealID;
     return Deal.GetEQ();
  END;

  MACRO DealBuy():TBFile
     if( m_DealBuy.rec.DealID == 0 )
        if( GetDeal( m_DealBuy, m_RS.DealBuyID ) == false )
           MsgBox( "Не найдена сделка по лоту налогового учета DSCTXLOT_DBT.t_DealID = " + string(m_RS.DealBuyID)  );
           m_DealBuy.Clear();
        end;
     end;
     return m_DealBuy;
  END;

  /*Наименование нашего банка*/
  MACRO H0_A():STRING
     return ПолучитьКороткоеИмяСубъекта( {OurBank} );
  END;

  /*ИНН нашего банка*/
  MACRO H0_B1()
     VAR INN;

     SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, null );
     return INN;
  END;

  /*КПП нашего банка*/
  MACRO H0_B2()
     VAR KPP;

     SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), null, KPP );
     return KPP;
  END;

  /*Константа, задаваемая в макросе формировании отчета. Значение константы -текст
       "01" - для подвида 0801
       "02" - для подвида 0802  */
  MACRO H0_3():STRING
     if( m_ReportKind == RESERVREG_0801 )
        return "01";
     else
        return "02";
     end;
  END;

  /*Название подвида регистра:*/
  MACRO H0_6():STRING
     if( m_ReportKind == RESERVREG_0801 )
        return "Расчет доходов (расходов) в виде восстановленного (созданного) резерва под обесценение акций и депозитарных расписок";
     else
        return "Расчет доходов (расходов) в виде восстановленного (созданного) резерва под обесценение облигаций";
     end;
  END;

  /*Первый день года из <H0_.8> */
  MACRO H0_7():DATE
     VAR Year;
     DateSplit( this.H0_8(), null, null, Year );

     return DATE(1,1,Year);
  END;

  /*Отчетная дата, указанная в форме запуска отчета*/
  MACRO H0_8():DATE
     return ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_ENDDATE );
  END;

  /*КПОП*/
  MACRO H0_13():DATE
     VAR Year = ReservReg_Form.GetFieldValue( PNFLD_RESERVREG_YEAR );
     return DATE( 31, 12, Year-1 );
  END;

  /*Группа налогового учета*/
  MACRO H0_9():STRING
    GetAddWhereForAvr();
    return m_H0_9;
  END;

  /*Выпуск ц/б*/
  MACRO H0_11():STRING
    GetAddWhereForAvr();
    return m_H0_11;
  END;

  /*Выпуск ц/б*/
  MACRO H1_1():STRING
     return m_AvrRS.AvrCode;
  END;

  /*Дата создания резерва*/
  MACRO H2_1():DATE
    return m_CurReservDate;
  END;

  MACRO SecCode():STRING
     return m_AvrRS.AvrCode;
  END;

  MACRO SecName():STRING
     return m_AvrRS.AvrName;
  END;

  MACRO Drez():DATE
     return m_CurReservDate;
  END;

  MACRO CodeB()
     return m_RS.DealBuyCodeTS;
  END;

  MACRO VN()
     return m_CacheFinInstr.GetISO( m_AvrRS.FaceValueFI ).m_Number;
  END;

  MACRO ValMrkt()
     return m_CacheFinInstr.GetISO( this.m_ValMrkt ).m_Number;
  END;

  MACRO PrintValMrkt()
     if( m_InDrawing )
       return m_CacheFinInstr.GetISO( this.m_ValMrkt ).m_Number;
     else
       return "";
     end;
  END;

  MACRO DZB()
     m_DZB = SQL_ConvTypeDate(m_RS.DealBuyDate);
     return m_DZB;
  END;

  MACRO DDB():DATE
     return SQL_ConvTypeDate(m_RS.BuyDate);
  END;

  MACRO PaymDate():DATE
     return SQL_ConvTypeDate(m_RS.PaymDate);
  END;

  MACRO Qnty():DOUBLE
     /*bug WinRep: точность денег всегда 2? приходится через double ...*/
     return double(m_RS.Amount);
  END;

  MACRO VprB():STRING
     return m_CacheFinInstr.GetISO( m_RS.VprB ).m_Number;
  END;

  MACRO PrBnom():DOUBLE
     if(m_ReportKind == RESERVREG_0802)
       m_PrBNom = m_RS.BuyPrice;
     end;
     return m_PrBNom;
  END;

  MACRO PrBvp():DOUBLE
     if(m_ReportKind == RESERVREG_0801)
        m_PrBvp = m_RS.BuyPrice;
     end;
     return m_PrBvp;
  END;


  PRIVATE MACRO BuyIsBack():BOOL
     return ( IsSale( int(m_RS.DealBuyGroup) ) OR IsAVRWRTOUT( int(m_RS.DealBuyGroup) ) );
  END;


  MACRO SumBvn():MONEY

    if(m_RS.VprB == m_AvrRS.FaceValueFI)
      m_SumBvn = this.SumBvp();
    else
      if(m_RS.VprB == NATCUR)
        m_SumBvn = this.SumBvp()/this.CrBD();
      elif(m_AvrRS.FaceValueFI == NATCUR)
        m_SumBvn = this.SumBvp()*this.CrBD();
      else
        m_SumBvn = this.SumBvp()/this.CrBP();
      end;
    end;

    m_SumBvn = round(m_SumBvn, 2);
    return m_SumBvn;
  END;


  MACRO SumBvp():MONEY
    m_SumBvp = round(m_RS.SumBmain*this.Qnty()/m_RS.BuyAmount, 2);
    return m_SumBvp;
  END;

  MACRO MaxMrkt():DOUBLE
     m_MaxMrkt = m_RS.BuyMarketPrice;
     return m_MaxMrkt;
  END;

  MACRO Val_MarketB():STRING
     m_Val_MarketB = m_RS.Val_MarketB;
     return m_Val_MarketB;
  END;

  MACRO Val_MarketB_Fiid():INTEGER
     m_Val_MarketB_Fiid = m_RS.Val_MarketB_Fiid;
     return m_Val_MarketB_Fiid;
  END;

  MACRO MrktB():STRING
     return SQL_ConvTypeStr( m_RS.BuyMarket );
  END;

  MACRO DMrktB():DATE
     return SQL_ConvTypeDate(m_RS.BuyDateMarket);
  END;

  MACRO QuoteValueB():DOUBLE
     m_QuoteValueB = m_RS.QuoteValueB;
     return m_QuoteValueB;
  END;

  MACRO ComB():MONEY
     // Банки, учитывающие комиссии, уплаченные при приобретении ценных бумаг, в расчете резервов
     if( SC_UseComInCalcReservReg() == true )
       /*1 / 1.18 - к-т для учета НДС. См. 105205.*/
       m_ComB = ( СуммаКомиссий( DealBuy().rec.DealID, DealBuy().rec.BOfficeKind, DDB(), NATCUR )) * (Qnty()/m_RS.BuyAmount);
       m_ComB = round(m_ComB, 2);
       return m_ComB;
     else
       return 0.0;
     end;
  END;

  MACRO IsDUDealB():INTEGER // Сдека ДУ
    if(ValType(m_RS.IsDUDealB) != V_UNDEF)
      return m_RS.IsDUDealB;
    end;
    return 0;
  END;


  MACRO ImportDUDate():DATE // Дата перехода права собств-ти при приобретении ЦБ для ДУ
     return SQL_ConvTypeDate(m_RS.ImportDUDate);
  END;

  MACRO AmortVN():MONEY
     if( m_ReportKind == RESERVREG_0802 )
       m_AmortVN = GetPartialSumByPeriod( m_AvrRS.FIID, Qnty(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1, DRez() );
     else
       m_AmortVN = 0;
     end;
     m_AmortVN = round(m_AmortVN, 2);
     return m_AmortVN;
  END;

  MACRO AmortRub():MONEY
     if( m_ReportKind == RESERVREG_0802 )
       m_AmortRub = GetPartialSumByPeriod_Rub( m_AvrRS.FIID, Qnty(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1, DRez() );
     else
       m_AmortRub = 0;
     end;

     m_AmortRub = round(m_AmortRub, 2);
     return m_AmortRub;
  END;


  MACRO CrVN_DZB():DOUBLE
     if(m_ReportKind == RESERVREG_0802)
       if(m_AvrRS.FaceValueFI == NATCUR)
          m_CrVN_DZB = 1.0;
       else
          m_CrVN_DZB = GetRateOnDateCrossDbl( this.DZB(), m_AvrRS.FaceValueFI, NATCUR, true );
       end;
     end;

     if((m_CrVN_DZB == NULL) or (m_CrVN_DZB == 0.0))
       m_CrVN_DZB = NULL;
       return 1.0;
     end;

     return m_CrVN_DZB;
  END;

  MACRO printCrVN_DZB():DOUBLE
     this.CrVN_DZB();
     return m_CrVN_DZB;
  END;

  MACRO CrVN_DDB():DOUBLE
     if(m_AvrRS.FaceValueFI == NATCUR)
        m_CrVN_DDB = 1.0;
     else
        m_CrVN_DDB = GetRateOnDateCrossDbl( this.DDB(), m_AvrRS.FaceValueFI, NATCUR, true );
     end;

     if((m_CrVN_DDB == NULL) or (m_CrVN_DDB == 0.0))
       m_CrVN_DDB = NULL;
       return 1.0;
     end;

     return m_CrVN_DDB;
  END;

  MACRO CrBZ():DOUBLE
     if(m_ReportKind == RESERVREG_0801)
       m_CrBZ = GetRateOnDateCrossDbl( this.DZB(), m_RS.VprB, NATCUR, true );
     end;

     if((m_CrBZ == NULL) or (m_CrBZ == 0.0))
       m_CrBZ = NULL;
       return 1.0;
     end;

     return m_CrBZ;
  END;

  MACRO printCrBZ():DOUBLE
     this.CrBZ();
     return m_CrBZ;
  END;

  MACRO Cr_Val_MrkBZ():DOUBLE
     var _Val_MarketB_FIID = IIF(Val_MarketB() == 0, m_AvrRS.FaceValueFI, Val_MarketB_Fiid());

     if(m_ReportKind == RESERVREG_0801)
         m_Cr_Val_MrkBZ = GetRateOnDateCrossDbl( this.DZB(), _Val_MarketB_FIID, NATCUR, true );
     end;

     if((m_Cr_Val_MrkBZ == NULL) or (m_Cr_Val_MrkBZ == 0.0))
       m_Cr_Val_MrkBZ = NULL;
       return 1.0;
     end;

     return m_Cr_Val_MrkBZ;
  END;

  MACRO printCr_Val_MrkBZ():DOUBLE
     this.Cr_Val_MrkBZ();
     return m_Cr_Val_MrkBZ;
  END;

  MACRO CrBZH0():DOUBLE
    if (this.m_ValMrkt == NATCUR)
      m_CrBZH0 = 1;
      return m_CrBZH0;
    end;

     if(m_ReportKind == RESERVREG_0801)
         m_CrBZH0 = GetRateOnDateCrossDbl( this.DRez(), this.m_ValMrkt, NATCUR, true );
     end;

     if((m_CrBZH0 == NULL) or (m_CrBZH0 == 0.0))
       m_CrBZH0 = 1;
       return 1.0;
     end;

     return m_CrBZH0;
  END;

  MACRO printCrBZH0():DOUBLE
     this.CrBZH0();
     return m_CrBZH0;
  END;

  MACRO NomB():DOUBLE
     m_NomB = GetFaceValue( m_AvrRS.FIID, iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()), true, false );
     return m_NomB;
  END;


  MACRO CrRez():DOUBLE
    if(m_AvrRS.FaceValueFI == NATCUR)
      m_CrRez = 1.0;
    else
      m_CrRez = GetRateOnDateCrossDbl( this.DRez(), m_AvrRS.FaceValueFI, NATCUR, true );
    end;

    if((m_CrRez == NULL) or (m_CrRez == 0.0))
       m_CrRez = NULL;
       return 1.0;
    end;

    return m_CrRez;
  END;

  MACRO printCrRez():DOUBLE
    this.CrRez();
    return m_CrRez;
  END;

  MACRO NomRez():DOUBLE
     m_NomRez = GetFaceValue(m_AvrRS.FIID, this.DRez(), true, false);
     return m_NomRez;
  END;

  /*Курс постановки на баланс (спец. Курс)*/
  MACRO CrSpezB():double
     if( m_CrSpezB == NULL )
        m_CrSpezB = ПолучитьКурсПостановкиНаБаланс(DealBuy());
     end;
     return m_CrSpezB;
  END;

  MACRO CrBD():DOUBLE

    if (m_CrBD != NULL)
      return m_CrBD;
    end;

    m_CrBD = CrSpezB();
    if ((m_CrBD == 0) or (m_CrBD == NULL))
      if (m_RS.VprB == NATCUR)
        m_CrBD = 1;
      else
        if (this.TypeB() == "B")
          m_CrBD = GetRateOnDateCrossDbl(mindate(this.DDB(), this.PaymDate()), m_RS.VprB, NATCUR, true);
        else
          m_CrBD = GetRateOnDateCrossDbl(this.DDB(), m_RS.VprB, NATCUR, true);
        end;
      end;
    end;

    return m_CrBD;
  END;

  MACRO printCrBD():DOUBLE
     this.CrBD();
     return m_CrBD;
  END;

  MACRO CrB():DOUBLE
     var CrBDate = iif(this.PaymDate()/*DP*/==ZeroDate,this.DDB(),min(this.DDB(),this.PaymDate()/*DP*/));
     m_CrB = GetRateOnDateCrossDbl( CrBDate, m_RS.VprB, NATCUR, true );
     return m_CrB;
  END;

  MACRO DifB():MONEY
    var SumMrkt = 0;
    m_DifB = 0;
    if( IsFilledNoteByDeal(this.DealBuy().rec.DealID,NOTEKIND_SECDEAL_REJECTMPRICE/*Отклонение от рыночной цены*/) )/*если заполнено примечание*/
      m_DifB = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_REJECTMPRICE);
      m_DifB = double(m_DifB)*this.Qnty()/m_RS.BuyAmount;
    elif ((this.MaxMrkt() == 0) or (StrUpr(this.MrktB) == "ФАКТ")
          or (StrUpr(this.MrktB) == "НЕКОНТРОЛИРУЕМАЯ СДЕЛКА")
          or (StrUpr(this.MrktB) == "БИРЖЕВАЯ СДЕЛКА"))
      m_DifB = 0;
    else
      if(m_ReportKind == RESERVREG_0801)
         SumMrkt = round(this.MaxMrkt() * this.Cr_Val_MrkBz()/this.CrBZ()*this.Qnty(), 2);
         if((this.SumBvp() - SumMrkt) > 0)
           m_DifB = (this.SumBvp() - SumMrkt) * this.CrBD();
         else
           m_DifB = 0;
         end;
      else
         if(m_AvrRS.FaceValueFI == NATCUR)
            SumMrkt = round(this.MaxMrkt() * this.NomB() / 100 * this.Qnty(), 2);
            if((this.SumBrub() - SumMrkt) > 0)
              m_DifB = this.SumBrub() - SumMrkt;
            else
              m_DifB = 0;
            end;
         else
            if(m_RS.VprB == NATCUR)
               SumMrkt = round(this.MaxMrkt() * this.NomB() / 100 * this.Qnty() * this.CrVN_DZB(), 2);
               if((this.SumBvp() - SumMrkt) > 0)
                 m_DifB = this.SumBvp() - SumMrkt;
               else
                 m_DifB = 0;
               end;
            else
              var V19 = 0;
              GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);

              SumMrkt = round(this.MaxMrkt() * this.NomB() / 100 * this.Qnty(), 2);
              if (V19 == 0)
                if ((this.SumBvp() - SumMrkt) > 0)
                  m_DifB = (this.SumBvp() - SumMrkt) * this.CrB();
                else
                  m_DifB = 0;
                end;
              elif ((V19 == 1) and (CrSpezB() != 0.0))
                if (this.SumBrub() - SumMrkt * this.CrVN_DZB() > 0)
                  m_DifB = max(round(this.SumBrub() - SumMrkt * this.CrVN_DDB(), 2), 0);
                else
                  m_DifB = 0;
                end;
              elif ((V19 == 1) and (CrSpezB() == 0.0))
                if ((this.SumBvp() - SumMrkt) > 0)
                  m_DifB = (this.SumBvp() - SumMrkt) * this.CrVN_DDB();
                else
                  m_DifB = 0;
                end;
              end;
            end;
         end;
      end;
    end;
    m_DifB = round(m_DifB, 2);
    return m_DifB;
  END;

  MACRO RC()
     GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), OBJATTR_SECDEAL_METHODDETECTPRICE, null, null, m_RC);
     return m_RC;
  END;

  MACRO RFISS()
     var RFISSID = 0;
     if(GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), OBJATTR_SECDEAL_FISSKIND, null, null, RFISSID))
       if(RFISSID == 1)
          m_RFISS = "Форвард";
       elif(RFISSID == 2)
          m_RFISS = "Фьючерс";
       elif(RFISSID == 3)
          m_RFISS = "Опцион";
       end;
     end;

     return m_RFISS;
  END;

  MACRO K_Control()
     GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), OBJATTR_SECDEAL_MORECONTROL, null, null, m_K_Control);
     return m_K_Control;
  END;

  MACRO Control_Comment():STRING
    m_Control_Comment = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_CONTROLCOMMENT);
    return m_Control_Comment;
  END;

  MACRO SecType()
     return m_AvrRS.TaxGroup;
  END;

  MACRO DR():DATE
    m_DR = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_DATEACCOUNTING);
    if((ValType(m_DR) != V_UNDEF) and (m_DR != ""))
      m_DR = date(m_DR);
    end;

    return m_DR;
  END;

  MACRO DQual():DATE
    m_DQual = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_REQUALREPO);
    if((ValType(m_DQual) != V_UNDEF) and (m_DQual != ""))
      m_DQual = date(m_DQual);
    end;

    return m_DQual;
  END;

  MACRO CrBP():DOUBLE
    var VprBrate=NULL;

    if((m_AvrRS.FaceValueFI == NATCUR) and (m_RS.VprB == NATCUR))
      m_CrBP = 1;
    elif((m_AvrRS.FaceValueFI == NATCUR) and (m_RS.VprB != NATCUR))
      VprBrate = GetRateOnDateCrossDbl( this.DDB(), m_RS.VprB, NATCUR, true );
      if((ValType(VprBrate) != V_UNDEF) AND (VprBrate != 0.0))
        m_CrBP = 1/VprBrate;
      else
        m_CrBP = 0.0;
      end;
    elif((m_AvrRS.FaceValueFI != NATCUR) and (m_RS.VprB != NATCUR))
      VprBrate = GetRateOnDateCrossDbl( this.DDB(), m_RS.VprB, NATCUR, true );
      if((ValType(VprBrate) != V_UNDEF) AND (VprBrate != 0.0))
        m_CrBP = GetRateOnDateCrossDbl( this.DDB(), m_AvrRS.FaceValueFI, NATCUR, true )/VprBrate;
      else
        m_CrBP = 0.0;
      end;
    else
      m_CrBP = GetRateOnDateCrossDbl( this.DDB(), m_AvrRS.FaceValueFI, NATCUR, true );
    end;

    if((m_CrBP == NULL) or (m_CrBP == 0.0))
       m_CrBP = NULL;
       return 1.0;
    end;

    return m_CrBP;
  END;

  MACRO TypeB():STRING //Код сделки приобретения

     if( m_RS.TypeB == TXLOTS_BUY )
        return "B";
     elif( m_RS.TypeB == TXLOTS_SALE )
        return "S";
     elif( m_RS.TypeB == TXLOTS_REPO )
        return "РП";
     elif( m_RS.TypeB == TXLOTS_BACKREPO )
        return "РО";
     elif( m_RS.TypeB == TXLOTS_LOANPUT )
        return "ЗП";
     elif( m_RS.TypeB == TXLOTS_LOANGET )
        return "ЗО";
     else
        return "";
     end;

  END;

  MACRO DepB():STRING
    if (m_RS.DepB != 0)
      return "Да";
    else
      return "Нет";
    end;
  END;

  /*Курс ЦБ РФ валюты цены договора на дату поставки ценных бумаг*/
  MACRO CrVPr_DDB():DOUBLE
    m_CrVPr_DDB = GetRateOnDateCrossDbl(this.DDB(), m_RS.VPrB, NATCUR, true);

    if ((m_CrVPr_DDB == NULL) or (m_CrVPr_DDB == 0.0))
      m_CrVPr_DDB = NULL;
      return 1.0;
    end;

    return m_CrVPr_DDB;
  END;

  MACRO SumBrub()
    if (m_ReportKind == RESERVREG_0801)
      m_SumBrub = Round(this.SumBvp() * this.CrBD(), 2);
    elif (m_ReportKind == RESERVREG_0802)
      var V19 = 0;
      GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
      if ((V19 == 1) and (CrSpezB() != 0.0) and (this.TypeB() == "B"))
        m_SumBrub = (this.SumBvp() + m_RS.NkdBuy * Qnty() / m_RS.BuyAmount)
                    * this.CrBD() - m_RS.NkdBuy * Qnty() / m_RS.BuyAmount
                    * this.CrVPr_DDB();
        m_SumBrub = Round(m_SumBrub, 2);
      else
        m_SumBrub = Round(this.SumBvp() * this.CrBD(), 2);
      end;
    end;
    return m_SumBrub;
  END;

  MACRO CostMrkt():MONEY
     if( m_ReportKind == RESERVREG_0801 )
        m_CostMrkt = this.m_RezMrkt*Qnty()*m_CrBZH0;
     else
        if( this.SecType == AVOIR_TAXGROUP_INDEXNOM ) 
          m_CostMrkt = numeric((this.m_RezMrkt * this.NomRez() / 100. - (this.NomRez() - OFZIN_StartFV)) * this.Qnty()); 
        else
          m_CostMrkt = numeric(this.m_RezMrkt * this.NomRez()/100* Qnty() * m_CrRez);
        end;
     end;

     m_CostMrkt = numeric(ЧислоCЗаданнойТочностью(m_CostMrkt, 4));
     m_CostMrkt = round(m_CostMrkt, 2);
     return m_CostMrkt;
  END;

  MACRO RezRubValue():MONEY

    var SumBrez = $0, RezRub = $0;

    if(m_ReportKind == RESERVREG_0801)
      SumBrez = Round(SumBrub() - this.DifB() + this.ComB(), 2);
      RezRub  = Round(SumBrez - this.CostMrkt(), 2);
    else
      SumBrez = Round(SumBrub() * (1 - this.AmortVN() / this.NomB() / this.Qnty()) - this.DifB() + this.ComB(), 2);
      if( this.SecType == AVOIR_TAXGROUP_INDEXNOM )
        SumBrez = SumBrez - (this.NomB-OFZIN_StartFV)*this.Qnty;
      end;
      RezRub  = Round(SumBrez - this.CostMrkt(), 2);
    end;

    if( RezRub <= 0)
      RezRub = 0;
    end;

    return RezRub;
  END;

  macro SetAutoSize() //Автоматическая ширина для столбцов
    if( (m_ReportKind == RESERVREG_0801)  )
       m_ObjTemplateXLS.SetAutoFit("C:AU", m_ObjTemplateXLS.SheetName());             
    elif( (m_ReportKind == RESERVREG_0802)  )
       m_ObjTemplateXLS.SetAutoFit("C:AW", m_ObjTemplateXLS.SheetName());             
    end;
  end;

  MACRO ContB():STRING // Контрагент по сделке приобретения
     return m_RS.BuyPartyName;
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Комментарий для категории <Способ определения РЦ>*/
  MACRO RC_CommentB():string
    var vRC_Comment = readNoteForObject(OBJTYPE_SECDEAL, UniID(this.DealBuy(), OBJTYPE_SECDEAL), 29, date(31,12,9999)); // не историчное примечание
    if((ValType(vRC_Comment) != V_UNDEF) and (vRC_Comment != ""))
      vRC_Comment = string(vRC_Comment);
    end;
    return vRC_Comment;
  END;

  MACRO ISIN()
     return m_AvrRS.ISIN;
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode, FocreFormatRep );
  SetRowFlushCount(2000);
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;
  WebFormData = FormData;

  if( stat )
    if( not IsWebService )
      ReservReg_Form = SP_ReservReg_Panel();
    else
      if( ValType( FormData ) != V_UNDEF )
        ReservReg_Form = WS_TX_ReservReg_Panel( FormData );
      else
        stat = false;
      end;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = ReservReg_Form.Run();
    end;

    if( stat )
      ReservReg_Report = SP_ReservReg_Report( null, "Report_TxReserv.xlsx", false, IsWebService, ReportHashCode, POI_MODE, BIGREPORT_MODE);
      ReservReg_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( ReservReg_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = ReservReg_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( ReservReg_Report.PrintMode() );
      end;
    end;
end;

  return FullReportFileNames;
END;
