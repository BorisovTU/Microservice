/*
$Name:        SCImpRateSPB21.mac
$Module:      Ценные бумаги
$Description: Загрузка курсов СПБ, XML формат SPB21
*/

IMPORT "XMLLoader.mac", "SCImpRate.mac";
import gtdlfun_u;

PRIVATE VAR   FlagCtrlBrk = false;
PRIVATE CONST CtrlBrkErr  = 17;

PRIVATE CONST Код_на_СПБ_ФинИн   = 22;
PRIVATE CONST Код_на_СПБ_Субъект = 76;


PRIVATE CONST RATE_KIND_MARKET     = 1;  /*курс вида "Рыночная цена"         */        
PRIVATE CONST RATE_KIND_MIN        = 2;  /*курс вида "Минимальная цена"      */
PRIVATE CONST RATE_KIND_MAX        = 3;  /*курс вида "Максимальная цена"     */
PRIVATE CONST RATE_KIND_WA         = 4;  /*курс вида "Средневзвешенная цена" */
PRIVATE CONST RATE_KIND_NKD1SEC    = 15; /*курс вида "НКД на одну бумагу"    */
PRIVATE CONST RATE_KIND_VOLUME     = 35; /*курс вида "(СПБ) Объём торгов"    */
PRIVATE CONST RATE_KIND_MARKET_TAX = 21; /*курс вида "Рыночная цена для НДФЛ"*/

PRIVATE CONST AVRKIND_EQUITY_SHARE              = "АКЦИИ ОБЫКНОВЕННЫЕ",
              AVRKIND_PREFERENCE_SHARE          = "АКЦИИ ПРИВИЛЕГИРОВАННЫЕ",
              AVRKIND_INVESTMENT_SHARE_OPEN     = "ПАЙ ОТКРЫТОГО ПИФ",
              AVRKIND_INVESTMENT_SHARE_CLOSE    = "ПАЙ ЗАКРЫТОГО ПИФ",
              AVRKIND_ETF                       = "ETF",
              AVRKIND_RDR                       = "RDR",
              AVRKIND_ADR                       = "ADR",
              AVRKIND_GDR                       = "GDR",
              AVRKIND_INVESTMENT_SHARE_INTERVAL = "ПАЙ ИНТЕРВАЛЬНОГО ПИФ",
              AVRKIND_MORTGAGE                  = "ИПОТЕЧНЫЙ ВЕКСЕЛЬ",
              AVRKIND_BOND_STATE                = "ГОСУДАРСТВЕННЫЕ ОБЛИГАЦИИ",
              AVRKIND_BOND_MUNICIPAL            = "МУНИЦИПАЛЬНЫЕ ОБЛИГАЦИИ",
              AVRKIND_BOND_CB                   = "ОБЛИГАЦИИ ЦЕНТРАЛЬНОГО БАНКА",
              AVRKIND_BOND_CORPORATE            = "КОРПОРАТИВНЫЕ ОБЛИГАЦИИ",
              AVRKIND_BOND_CREDIT               = "ОБЛИГАЦИИ КРЕДИТНОЙ ОРГАНИЗАЦИИ",
              AVRKIND_BOND_EXCHANGE             = "БИРЖЕВЫЕ ОБЛИГАЦИИ";

PRIVATE CLASS (SC_ImportRate) SC_ImportRateSPB21()

  PRIVATE CLASS DataRates
    var TradeDate:date,
        BoardID:string,
        SecurityId:string,
        FaceValue:double,
        SecCurrencyId:string,
        SecurityType:string,
        Decimals:integer,
        CurrencyId:string,
        AccruedInterest:double,
        TotalAmount:double,
        MaxDealPrice:double,
        MinDealPrice:double,
        WAPrice:double,
        MarketPrice3:double;

    macro Init()
      TradeDate = date(0,0,0);
      BoardID = SecurityId = SecCurrencyId = SecurityType = CurrencyId = "";
      Decimals = 0;
      AccruedInterest = TotalAmount = MaxDealPrice = MinDealPrice = WAPrice = MarketPrice3 = 0.0;
    end;

    macro InitRecords()
      SecurityId = SecCurrencyId = SecurityType = CurrencyId = "";
      Decimals = 0;
      AccruedInterest = TotalAmount = MaxDealPrice = MinDealPrice = WAPrice = MarketPrice3 = 0.0;
    end;
  END;

  PRIVATE VAR Rates = DataRates();

  private macro strImpDateSPB()
    var day, month, year;
    DateSplit(ImpDate(),day,month,year);

    return LZ(year,4) + "-" + LZ(month,2) + "-" + LZ(day,2);
  end;

  /* настраиваемый пользователем макрос формирования
     имен файла котировок и сделок с госбумагами с СПБ */
  MACRO GetDataFileName( datafilepath:@string, fname:@string ):BOOL
    var ErrStr = "";
    
    datafilepath = GetRegImportDirUSPB(strImpDate(), @ErrStr);

    var datafilemask = "?????_" + "SPB21_" + strImpDateSPB() + "_?_???" + ".xml";
    var List = TDirList ( datafilepath + datafilemask, "f" );

    List.Sort(0);

    if (List.Count == 0)
      fname = "";
      MsgBox( "Ошибка открытия файла данных. Не найден файл по маске " + datafilepath + datafilemask);
      return false;
    end;

    fname = List.name(0);
    return true;
  END;

  PRIVATE MACRO RunImp( RateKind:INTEGER, RateValue:DOUBLE ):INTEGER
    var imp_date, SecType, CurRate, IsDominant, IsRelative;

    if( Rates.TradeDate != date(0,0,0) )
      imp_date = Rates.TradeDate;
    else
      imp_date = ImpDate();
    end;

    SecType = StrUpr(Rates.SecurityType);

    if( RateKind == RATE_KIND_MARKET )
      IsDominant = true;
    else
    IsDominant = false;
    end;

    if( (Rates.CurrencyId == "PCT") and (RateKind != RATE_KIND_NKD1SEC) )
      IsRelative = true;
    else
    IsRelative = false;
    end;

    if( Rates.CurrencyId == "PCT" )
      CurRate = Rates.SecCurrencyId;
    else
    CurRate = Rates.CurrencyId;
    end;

    if( (in(SecType,                
              AVRKIND_BOND_STATE, 
              AVRKIND_BOND_MUNICIPAL, 
              AVRKIND_BOND_CB,
              AVRKIND_BOND_CORPORATE,
              AVRKIND_BOND_CREDIT,
            AVRKIND_BOND_EXCHANGE)) and (RateKind != RATE_KIND_NKD1SEC) )  //По сути избыточный блок, но пусть остается для соответствия ТЗ
        IsRelative = true;

      if( (RateKind == RATE_KIND_MARKET) or (RateKind == RATE_KIND_MARKET_TAX) )
          CurRate = Rates.SecCurrencyId;
        end;
    end;

    if( ImportOneCourse( Rates.SecurityId,        // Код ФИ (Базовый ФИ)
                         Код_на_СПБ_ФинИн,        // Вид кода ФИ (FICK_...)
                         RateKind,                // Вид курса
                         IsRelative,              // Признак относительной котировки
                         IsDominant,              // Признак основного курса
                         false,                   // Признак обратной котировки
                         1,                       // Масштаб курса
                         Rates.Decimals,          // Количество значащих цифр
                         imp_date,                // Дата установки курса
                         CurRate,                 // Код валюты котировки (Котируемый ФИ)
                         Код_на_СПБ_ФинИн,        // Вид кода валюты котировки (FICK_...)
                         MarketCode(),            // Код торговой площадки
                         Код_на_СПБ_Субъект,      // Вид кода субъекта торговой площадки (PTCK_...)
                         0,                       // Сектор торговой площадки
                         RateValue,               // Значение курса
                         null,                    // Возможность надежного определения справедливой стоимости
                         null                     // Rates.BoardID            // Режима торгов
                       ) == false )
      return 1;
    end;     
    return 0;

  OnError(ErObj)

    Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

    if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
    else
      RemProgress();
      RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
    end;
    return ErObj.Code;
  END;

  PRIVATE MACRO ImpNomForIndexNom():INTEGER

     var ErrMsg = "", imp_date;

     if( Rates.TradeDate != date(0,0,0) )
        imp_date = Rates.TradeDate;
     else
        imp_date = ImpDate();
     end;

     InstLoadModule("gtdlfun.mac");
     if( ExecMacro2("ЗагрузитьНоминалДляОФЗИНЗаДату", m_BaseAvoir, Rates.FaceValue, imp_date, @ErrMsg) != 0 ) 
        Warning("Ошибка загрузки номинала за дату по ц/б с кодом \""+ ПолучитьКодФинИн(m_BaseAvoir.rec.FIID)+"\"."+ErrMsg);
     elif( ErrMsg != "" )
        msgbox(ErrMsg);
     end;

     return 0;

  OnError(ErObj)

    Error( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );

    if(ErObj.Code == CtrlBrkErr)
      FlagCtrlBrk = true;
    else
      RemProgress();
      RunError( "Модуль: " + string(ErObj.Module) + "\nСтрока: " + string(ErObj.Line) + "\nКод ошибки: " + string(ErObj.Code) + "\n" + ErObj.Message );
    end;
    return ErObj.Code;
  END;

  MACRO LoadFromFile():bool
    var xml:object = ActiveX( "MSXML.DOMDocument" );
    var i, j, k, l;
    var node:object, child_RtsDoc:object, child_Report:object, child_Board:object, child_Security:object;
    var DOC_REQUISITES = false, REPORT = false;
    var BoardId;

    Rates.Init();

    /* откроем файл импорта */
    if( not xml.load( DataFileName() ) )
      return Error(string( "Неверный формат файла импорта|", DataFileName(), "|Невозможно загрузить xml-документ" ));
    end;

    node = xml.DocumentElement;
    i = 0;
    while( i < node.childNodes.length ) /* бегаем по RTS_DOC */
      child_RtsDoc = node.childNodes.item(i);
      if( child_RtsDoc and (child_RtsDoc.nodeType == CHILD_NODE) )
        if(child_RtsDoc.tagname == "DOC_REQUISITES")
          if(DOC_REQUISITES)
            return Error(string( DataFileName(), ": Блок RTS_DOC\DOC_REQUISITES должен присутствовать в единственном экземпляре"));
          end;
          DOC_REQUISITES = true;
        end;

        if( StrUpr(child_RtsDoc.tagname) == "REPORT" )
          if(REPORT)
            return Error(string( DataFileName(), ": Блок RTS_DOC\REPORT должен присутствовать в единственном экземпляре"));
          end;
          REPORT = true;

          Rates.TradeDate = date(0,0,0);
          if( ReadTagAttribut(child_RtsDoc, "TRADEDATE", V_DATE, Rates.TradeDate) == false )
            /* если не нашли дату торгов */
          end;

          if(GetDialogFlag())
            InitProgress(child_RtsDoc.childNodes.length, "Загрузка внешнего файла котировок", "Просмотр групп торговых инструментов...");
          end;
          j = 0;
          while( j < child_RtsDoc.childNodes.length )
            child_Report = child_RtsDoc.childNodes(j);
            if( child_Report and (child_Report.nodeType == CHILD_NODE) )
              if( StrUpr(child_Report.tagname) == "BOARD" )

                Rates.BoardID = "";
                if( ReadTagAttribut(child_Report, "BOARDID", V_STRING, Rates.BoardID) == false )
                end;

                if(GetDialogFlag())
                  InitProgress(child_Report.childNodes.length, Rates.BoardID, "Просмотр записей котировок...");
                end;

                k = 0;
                while(k < child_Report.childNodes.length )
                  child_Board = child_Report.childNodes(k);
                  if( child_Board and (child_Board.nodeType == CHILD_NODE) )
                    if( StrUpr(child_Board.tagname) == "SECURITY" )
                      Rates.InitRecords();
                      if( ReadTagAttribut(child_Board, "SECURITYID", V_STRING, Rates.SecurityId) == false )
                        /* если не нашли идентификатор инструмента */
                      end;
                      if( ReadTagAttribut(child_Board, "FACEVALUE", V_DOUBLE, Rates.FaceValue) == false )
                        /* если не нашли номинал */
                      end;
                      if( ReadTagAttribut(child_Board, "SECCURRENCYID", V_STRING, Rates.SecCurrencyId) == false )
                        /* если не нашли валюту номинала */
                      end;
                      if( ReadTagAttribut(child_Board, "SECURITYTYPE", V_STRING, Rates.SecurityType) == false )
                        /* если не нашли вид и тип ц/б */
                      end;
                      if( ReadTagAttribut(child_Board, "DECIMALS", V_INTEGER, Rates.Decimals) == false )
                        /* если не нашли число значимых знаков после запятой в ценах */
                      end;
                      if( ReadTagAttribut(child_Board, "CURRENCYID", V_STRING, Rates.CurrencyId) == false )
                        /* если не нашли код валюты цены */
                      end;
                      if( ReadTagAttribut(child_Board, "ACCRUEDINTEREST", V_DOUBLE, Rates.AccruedInterest) == false )
                        /* если не нашли НКД на дату отчета */
                      end;

                      l = 0;
                      while( l < child_Board.childNodes.length )
                        child_Security = child_Board.childNodes(l);
                        if( child_Security and (child_Security.nodeType == CHILD_NODE) )
                          if( StrUpr(child_Security.tagname) == "RESULT" )
                            if( ReadTagAttribut(child_Security, "TOTALAMOUNT", V_DOUBLE, Rates.TotalAmount) == false )
                              /* если не нашли общее количество ц/б по заключенным Договорам за Торговый день в Режиме основных торгов */
                            end;
                            if( ReadTagAttribut(child_Security, "MAXDEALPRICE", V_DOUBLE, Rates.MaxDealPrice) == false )
                              /* если не нашли максимальную цену договоров за день */
                            end;
                            if( ReadTagAttribut(child_Security, "MINDEALPRICE", V_DOUBLE, Rates.MinDealPrice) == false )
                              /* если не нашли минимальную цену договоров за день */
                            end;
                            if( ReadTagAttribut(child_Security, "WAPRICE", V_DOUBLE, Rates.WAPrice) == false )
                              /* если не нашли средневзвешенную цену */
                            end;
                            if( ReadTagAttribut(child_Security, "MARKETPRICE3", V_DOUBLE, Rates.MarketPrice3) == false )
                              /* если не нашли рыночную цену 3 */
                            end;

                            RunImp( RATE_KIND_MARKET,     Rates.MarketPrice3 );
                            RunImp( RATE_KIND_MIN,        Rates.MinDealPrice );
                            RunImp( RATE_KIND_MAX,        Rates.MaxDealPrice );
                            RunImp( RATE_KIND_WA,         Rates.WAPrice );
                            RunImp( RATE_KIND_NKD1SEC,    Rates.AccruedInterest );
                            RunImp( RATE_KIND_VOLUME,     Rates.TotalAmount );
                            RunImp( RATE_KIND_MARKET_TAX, Rates.MarketPrice3 );

                            ImpNomForIndexNom();

                          end;
                        end;
                        l = l + 1;
                      end;
                    end;
                  end;
                  k = k + 1;
                  UseProgress(k);
                  if( FlagCtrlBrk == true )
                    break;
                  end;
                end;
                RemProgress(); 
              end;
            end;
            j = j + 1;
            UseProgress(j);
            if( FlagCtrlBrk == true )
              break;
            end;
          end;
          RemProgress(); 
        end;
      end;
      i = i + 1;
      if( FlagCtrlBrk == true )
        RemProgress(); RemProgress();
        break;
      end;
    end;


    return true;

  OnError( RslErrObj )
    RemProgress();RemProgress();
    MsgBox( "Модуль: ", RslErrObj.Module, "\nСтрока: ", RslErrObj.Line, "\nКод ошибки: ", RslErrObj.Code, "\n", RslErrObj.Message );
    RunError;
  END;

  initSC_ImportRate( true, SPBEX_CODE );
END;

PRIVATE VAR Rate = SC_ImportRateSPB21();
if( Rate != NULL )
   Rate.Run();
end;

Exit(1);
