import SecInter, "dlquery.mac";

class SP_DealParm()
  
  var DealID:integer;           //ID сделки
  
  var DealType:integer;         //Вид операции
  
  var PartyID:integer;          //ID контрагента
  var FI_Code:string;           //Код ц/б
  var Portfolio:integer;        //Портфель
  var Amount:money;             //Количество
  var Cost:money;               //Стоимость
  var TypeCalc:string;          //Тип расчетов
  var SupplyDate:date;          //Плановая дата поставки
  var PayDate:date;             //Плановая дата оплаты
  var ClientID:integer;         //ID клиента
  var Department:integer;       //Филиал
  var Oper:integer;             //Исполнитель
  var FixSum:integer;           //Фиксированная цена/сумма сделки
  var TermInWorkDays:string;    //Признак, Срок в рабочих днях?
  var DealDate:date;            //Дата заключения
  var DealTime:time;            //Время заключения
  var SupplyTime:time;          //Время поставки
  var Country:string;           //Место заключения
  var SignContract:string;      //Признак подписания договора
  var CFI:integer;              //Валюта сделки (цены)
  var PayFI:integer;            //Валюта расчетов
  var NkdFI:integer;            //Валюта НКД
  var Point:integer;            //Точность цены
  var InPerc:string;            //Признак, цена задается в %
  var NKD:money;                //Сумма НКД
  var Avance:money;             //Сумма аванса
  var Deposit:money;            //Сумма задатка
  var AvDepDate:date;           //Плановая дата аванса/задатка
  var DealCode:string;          //Внутренний код сделки
  var DealCodeTS:string;        //Внешний код сделки
  var PayRegTax:string;         //Признак оплаты рег. сбора
  var Registrar:integer;        //Регистратор
  var DepositID:integer;        //Расчеты через депозитарий
  var ClientContrID:integer;    //ID договора с клиентом
  var BrokerContrID:integer;    //ID договора с брокером
  var BrokerID:integer;         //Посредник
  var Basis:integer;            //База расчета
  var PayWithBrocker:string;    //Признак Расчеты через брокера
  var Blocked:string;           //Признак Бокировка ц/б
  var CommDate:date;            //Дата оплаты комиссии
  var Price:money;              //Цена по первой части
  
  //2-ая часть
  var TypeCalc2:string;         //Тип расчетов
  var Cost2:money;              //Стоимость
  var SupplyDate2:date;         //Плановая дата поставки
  var PayDate2:date;            //Плановая дата оплаты
  var CFI2:integer;             //Валюта сделки (цены)
  var IncomeRate:double;        //Ставка (%)
  var ReturnIncomeKind:integer; //Способ возврата доходов по ц/б
  var PayRegTax2:string;        //Признак оплаты рег. сбора
  var Registrar2:integer;       //Регистратор
  var DepositID2:integer;       //Расчеты через депозитарий
  var NKD2:money;               //Сумма НКД
  var Avance2:money;            //Сумма аванса
  var Deposit2:money;           //Сумма задатка
  var AvDepDate2:date;          //Плановая дата аванса/задатка
  var SupplyTime2:time;         //Время поставки
                 

  DealID           = 0;
  DealType         = 0;
  PartyID          = -1;
  FI_Code          = "";
  Portfolio        = KINDPORT_UNDEF;
  Amount           = $0;
  Cost             = $0;
  TypeCalc         = "";
  SupplyDate       = date(0,0,0);
  PayDate          = date(0,0,0);
  ClientID         = -1;
  Department       = {OperDprt};
  Oper             = {oper};
  FixSum           = SP_FIXED_PRICE;
  TermInWorkDays   = "";
  DealDate         = {curdate};
  DealTime         = time();
  SupplyTime       = time();
  Country          = "RUS";
  SignContract     = UNSET_CHAR;
  CFI              = NATCUR;
  PayFI            = NATCUR;
  NkdFI            = NATCUR;
  Point            = 4;
  InPerc           = UNSET_CHAR;
  NKD              = $0;
  Avance           = $0;
  Deposit          = $0;
  AvDepDate        = date(0,0,0);
  DealCode         = "";
  DealCodeTS       = "";
  PayRegTax        = UNSET_CHAR;
  Registrar        = -1;
  DepositID        = -1;
  ClientContrID    = 0;
  BrokerContrID    = 0;
  BrokerID         = -1;
  Basis            = SP_KINDBASISCALC_365_CAL;
  PayWithBrocker   = UNSET_CHAR;
  Blocked          = UNSET_CHAR;
  CommDate         = date(0,0,0);
  Price            = $0;
  
  TypeCalc2        = "";
  Cost2            = $0;
  SupplyDate2      = date(0,0,0);
  PayDate2         = date(0,0,0);
  CFI2             = NATCUR;
  SupplyTime2      = time();
  IncomeRate       = 0.0;
  ReturnIncomeKind = 0;
  PayRegTax2       = UNSET_CHAR;
  Registrar2       = -1;
  DepositID2       = -1;
  NKD2             = $0;
  Avance2          = $0;
  Deposit2         = $0;
  AvDepDate2       = date(0,0,0);

end;

macro SP_InsUpdDeal(prm:SP_DealParm)

  var Select, DataSet;
  var tick = TRecHandler("dl_tick.dbt");
  var leg  = TRecHandler("dl_leg.dbt");
  var leg2 = TRecHandler("dl_leg.dbt");
  var fin  = TRecHandler("fininstr.dbt");
  var stat = 0;


  leg.Clear();
  leg2.Clear();
  if(prm.DealID != 0)
    Select = DL_RSDCommand("select * from ddl_tick_dbt where t_DealID = ?");
    Select.AddParam(prm.DealID);
    DataSet = Select.execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo( tick.rec );
    end;

    Select = DL_RSDCommand("select * from ddl_leg_dbt where t_DealID = ? and t_LegID = ? and t_LegKind = ?");
    Select.AddParam(prm.DealID);
    Select.AddParam(0);
    Select.AddParam(LEG_KIND_DL_TICK);
    DataSet = Select.execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo( leg.rec );
    end;

    Select = DL_RSDCommand("select * from ddl_leg_dbt where t_DealID = ? and t_LegID = ? and t_LegKind = ?");
    Select.AddParam(prm.DealID);
    Select.AddParam(0);
    Select.AddParam(LEG_KIND_DL_TICK_BACK);
    DataSet = Select.execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo( leg2.rec );
    end;
  else
    InitSPDeal(tick, DL_SECURITYDOC, prm.DealType, true);
  end;

  tick.rec.PartyID         = prm.PartyID;
  tick.rec.PortfolioID     = prm.Portfolio;
  tick.rec.ClientID        = prm.ClientID;
  tick.rec.Department      = prm.Department;     
  tick.rec.Oper            = prm.Oper;
  tick.rec.FixSum          = prm.FixSum;
  tick.rec.Flag3           = prm.TermInWorkDays;
  tick.rec.DealDate        = prm.DealDate;
  tick.rec.DealTime        = prm.DealTime;
  tick.rec.Country         = prm.Country;
  tick.rec.Flag2           = prm.SignContract;
  tick.rec.DealCode        = prm.DealCode;
  tick.rec.DealCodeTS      = prm.DealCodeTS;
  tick.rec.ClientContrID   = prm.ClientContrID;
  tick.rec.BrokerContrID   = prm.BrokerContrID;
  tick.rec.BrokerID        = prm.BrokerID;
  tick.rec.Blocked         = prm.Blocked;
  tick.rec.ReturnIncomeKind = prm.ReturnIncomeKind;
  tick.rec.CommDate        = prm.CommDate;
  tick.rec.Flag4           = prm.PayWithBrocker;

  if(prm.ReturnIncomeKind)
    tick.rec.Flag5 = SET_CHAR;
  end;

  if(ПолучитьФинИн( prm.FI_Code, fin ) == 0)
    leg.rec.PFI = leg.rec.DeliveringFIID = fin.rec.FIID;
  end;

  leg.rec.Principal    = prm.Amount;
  leg.rec.Cost         = prm.Cost;
  leg.rec.Formula      = CodeFor(prm.TypeCalc);
  
  if( prm.SupplyDate < prm.PayDate )
     leg.rec.MaturityIsPrincipal = "X";
  else
     leg.rec.MaturityIsPrincipal = "";
  end;

  if(prm.SupplyDate >= prm.PayDate)       
    leg.rec.Expiry = prm.SupplyDate;
    leg.rec.Maturity = prm.PayDate;
  else
    leg.rec.Expiry = prm.PayDate;
    leg.rec.Maturity = prm.SupplyDate;
  end;

  leg.rec.SupplyTime     = prm.SupplyTime;
  leg.rec.CFI            = prm.CFI;
  leg.rec.PayFIID        = prm.PayFI;
  leg.rec.NKDFIID        = prm.NkdFI;
  leg.rec.Point          = prm.Point;          
  leg.rec.RelativePrice  = prm.InPerc;
  leg.rec.NKD            = prm.NKD;
  leg.rec.TotalCost = leg.rec.Cost + leg.rec.NKD;
  leg.rec.Start          = prm.AvDepDate;
  leg.rec.PayRegTax      = prm.PayRegTax;
  leg.rec.Registrar      = prm.Registrar;
  leg.rec.DepositID      = prm.DepositID;
  leg.rec.Basis          = prm.Basis;
  leg.rec.price          = prm.price;

  if((ValType(prm.PayDate2) != V_UNDEF) and (prm.PayDate2 > date(0,0,0)))
    leg2.rec.Principal  = leg.rec.Principal;
    leg2.rec.PFI        = leg.rec.PFI;

    leg2.rec.IncomeRate = prm.IncomeRate;
    leg2.rec.Basis      = prm.Basis;
    
    leg2.rec.Formula     = CodeFor(prm.TypeCalc2);
    leg2.rec.Cost        = prm.Cost2;
    
    if( prm.SupplyDate2 < prm.PayDate2 )
       leg2.rec.MaturityIsPrincipal = "X";
    else
       leg2.rec.MaturityIsPrincipal = "";
    end;

    if(prm.SupplyDate2 >= prm.PayDate2)       
      leg2.rec.Expiry = prm.SupplyDate2;
      leg2.rec.Maturity = prm.PayDate2;
    else
      leg2.rec.Expiry = prm.PayDate2;
      leg2.rec.Maturity = prm.SupplyDate2;
    end;

    leg2.rec.SupplyTime  = prm.SupplyTime2;
    leg2.rec.CFI         = prm.CFI2;
    leg2.rec.PayFIID     = prm.PayFI;
    leg2.rec.NKDFIID     = prm.NkdFI;        
    leg2.rec.IncomeRate  = prm.IncomeRate;        
    leg2.rec.PayRegTax   = prm.PayRegTax2;        
    leg2.rec.Registrar   = prm.Registrar2;       
    leg2.rec.DepositID   = prm.DepositID2;       
    leg2.rec.NKD         = prm.NKD2;               
    leg2.rec.Start       = prm.AvDepDate2;
    leg2.rec.TotalCost   = leg2.rec.Cost + leg2.rec.NKD;
  end;           

  stat = SP_CreateDeal(tick, leg, leg2, prm.Avance, prm.Deposit, prm.Avance2, prm.Deposit2, true);

  if(not stat)
    prm.DealID = tick.rec.DealID;
  end;

  return stat;
  
end;
