/*
$Name:        cdrecords_rep.mac
$Module:      Ценные бумаги
$Description: Формирование ежедневного отчета по обработке выплат из Диасофта при погашении ц/б
*/
import "sprepfun.mac", "sqlconv.mac", "CbReport_h.mac", "scsrvrepfun.mac", "func_lib.mac", "nptxfun.mac";


PRIVATE CLASS (DL_CReportTemplate) Sp_CdRecords_Report(RepDate:date)
  private var m_RepDate = RepDate;
  
  PRIVATE MACRO BeginReport()
    SetIsShowAppl(false); //Всегда не показываем отчет на экран
    
    CreateTotalBook();
  END;

  MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO EndReport()
    SaveTotalbook();
    ReplaceAndCalculate();
  END;

  PRIVATE MACRO CreateSheetPaymentsOnDate()
    var SheetName = "Выплаты за дату";
    var query, cmd, DataSet;
    
    SetActiveSheet(SheetName);

    PrintFormatString( NULL, "N1_RepDate", m_RepDate);

    CopyAllSheetInTotalBook(SheetName, false, "N1_Header", 0, SheetName);

    RegisterTable( "N1_MainTable", NULL,
                   "N1_ID", 
                   "N1_GUID",  
                   "N1_RequestDate",   
                   "N1_RequestTime",   
                   "N1_ShortName",     
                   "N1_FullName",      
                   "N1_AgreementNumber",       
                   "N1_IsIIS", 
                   "N1_AgreementOpenDate",     
                   "N1_AgreementCloseDate",    
                   "N1_CorporateActionType",   
                   "N1_PaymentType",   
                   "N1_RecordPaymentID",       
                   "N1_RecordPaymentQtyID",    
                   "N1_OperationStatus",       
                   "N1_PaymentDate",   
                   "N1_ClientID_ObjectID",     
                   "N1_FinancialName", 
                   "N1_ISINRegistrationNumber",        
                   "N1_RecordSNOBID",  
                   "N1_TaxRate",       
                   "N1_TaxBase",       
                   "N1_IssuerCurrency",        
                   "N1_IssuerSum",     
                   "N1_ClientSum",     
                   "N1_ClientCurrency",        
                   "N1_KBK",   
                   "N1_ReturnTax",     
                   "N1_IndividualTax", 
                   "N1_TaxReductionSum",       
                   "N1_SumD1", 
                   "N1_SumD2", 
                   "N1_OffsetTax",     
                   "N1_AccountNumber", 
                   "N1_OperationDate", 
                   "N1_IsGetTax",      
                   "N1_CouponNumber",  
                   "N1_CouponStartDate",       
                   "N1_CouponEndDate", 
                   "N1_ProcResult",    
                   "N1_PayReceivedDate",       
                   "N1_FixingDate",    
                   "N1_Quantity",
                   "N1_Status",
                   "N1_Error",
                   "N1_PartyID",
                   "N1_ContractID",
                   "N1_FIID"
                   );

    query =   " select cd.*, TO_CHAR(cd.t_ID) as ID_str, TO_CHAR(cd.t_RecordPaymentID) as RecordPaymentID_str, TO_CHAR(cd.t_RecordPaymentQtyID) as RecordPaymentQtyID_str, "
            + "        NVL(na.t_szNameAlg, CHR(1)) as StatusName "
            + "   from dcdrecords_dbt cd "
            + "        left join dnamealg_dbt na ON na.t_iTypeAlg = 7341 and na.t_iNumberAlg = cd.t_Status "
            + "  where cd.t_RequestDate = ? "
            + "    and LOWER(cd.t_CorporateActionType) IN ('redm', 'bput') "
            + " order by cd.t_ID ASC";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_RepDate);

    DataSet = cmd.Execute();

    while(DataSet.moveNext())
      PrintTableLine("N1_ID",                     DataSet.ID_str,                   null,
                     "N1_GUID",                   DataSet.GUID,                     null,
                     "N1_RequestDate",            date(DataSet.RequestDate),        null,
                     "N1_RequestTime",            time(DataSet.RequestTime),        null,
                     "N1_ShortName",              DataSet.ShortName,                null,
                     "N1_FullName",               DataSet.FullName,                 null,
                     "N1_AgreementNumber",        DataSet.AgreementNumber,          null,
                     "N1_IsIIS",                  DataSet.IsIIS,                    null,
                     "N1_AgreementOpenDate",      date(DataSet.AgreementOpenDate),  null,
                     "N1_AgreementCloseDate",     date(DataSet.AgreementCloseDate), null,
                     "N1_CorporateActionType",    DataSet.CorporateActionType,      null,
                     "N1_PaymentType",            DataSet.PaymentType,              null,
                     "N1_RecordPaymentID",        DataSet.RecordPaymentID_str,      null,
                     "N1_RecordPaymentQtyID",     DataSet.RecordPaymentQtyID_str,   null,
                     "N1_OperationStatus",        DataSet.OperationStatus,          null,
                     "N1_PaymentDate",            date(DataSet.PaymentDate),        null,
                     "N1_ClientID_ObjectID",      DataSet.ClientID_ObjectID,        null,
                     "N1_FinancialName",          DataSet.FinancialName,            null,
                     "N1_ISINRegistrationNumber", DataSet.ISINRegistrationNumber,   null,
                     "N1_RecordSNOBID",           DataSet.RecordSNOBID,             null,
                     "N1_TaxRate",                DataSet.TaxRate,                  null,
                     "N1_TaxBase",                DataSet.TaxBase,                  null,
                     "N1_IssuerCurrency",         DataSet.IssuerCurrency,           null,
                     "N1_IssuerSum",              DataSet.IssuerSum,                null,
                     "N1_ClientSum",              DataSet.ClientSum,                null,
                     "N1_ClientCurrency",         DataSet.ClientCurrency,           null,
                     "N1_KBK",                    DataSet.KBK,                      null,
                     "N1_ReturnTax",              DataSet.ReturnTax,                null,
                     "N1_IndividualTax",          DataSet.IndividualTax,            null,
                     "N1_TaxReductionSum",        DataSet.TaxReductionSum,          null,
                     "N1_SumD1",                  DataSet.SumD1,                    null,
                     "N1_SumD2",                  DataSet.SumD2,                    null,
                     "N1_OffsetTax",              DataSet.OffsetTax,                null,
                     "N1_AccountNumber",          DataSet.AccountNumber,            null,
                     "N1_OperationDate",          date(DataSet.OperationDate),      null,
                     "N1_IsGetTax",               DataSet.IsGetTax,                 null,
                     "N1_CouponNumber",           DataSet.CouponNumber,             null,
                     "N1_CouponStartDate",        date(DataSet.CouponStartDate),    null,
                     "N1_CouponEndDate",          date(DataSet.CouponEndDate),      null,
                     "N1_ProcResult",             DataSet.ProcResult,               null,
                     "N1_PayReceivedDate",        date(DataSet.PayReceivedDate),    null,
                     "N1_FixingDate",             date(DataSet.FixingDate),         null,
                     "N1_Quantity",               DataSet.Quantity,                 null,
                     "N1_Status",                 DataSet.StatusName,               null,
                     "N1_Error",                  DataSet.Error,                    null,
                     "N1_PartyID",                DataSet.PartyID,                  null,
                     "N1_ContractID",             DataSet.ContractID,               null,
                     "N1_FIID",                   DataSet.FIID,                     null
                    );
    end;

    EndTable();
    CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
  END;

  
  PRIVATE MACRO CreateSheetPaymError()
    var SheetName = "Выплаты с ошибками";
    var query, cmd, DataSet;
    
    SetActiveSheet(SheetName);

    PrintFormatString( NULL, "N2_RepDate", m_RepDate);

    CopyAllSheetInTotalBook(SheetName, false, "N2_Header", 0, SheetName);

    RegisterTable( "N2_MainTable", NULL,
                   "N2_ID", 
                   "N2_GUID",  
                   "N2_RequestDate",   
                   "N2_RequestTime",   
                   "N2_ShortName",     
                   "N2_FullName",      
                   "N2_AgreementNumber",       
                   "N2_IsIIS", 
                   "N2_AgreementOpenDate",     
                   "N2_AgreementCloseDate",    
                   "N2_CorporateActionType",   
                   "N2_PaymentType",   
                   "N2_RecordPaymentID",       
                   "N2_RecordPaymentQtyID",    
                   "N2_OperationStatus",       
                   "N2_PaymentDate",   
                   "N2_ClientID_ObjectID",     
                   "N2_FinancialName", 
                   "N2_ISINRegistrationNumber",        
                   "N2_RecordSNOBID",  
                   "N2_TaxRate",       
                   "N2_TaxBase",       
                   "N2_IssuerCurrency",        
                   "N2_IssuerSum",     
                   "N2_ClientSum",     
                   "N2_ClientCurrency",        
                   "N2_KBK",   
                   "N2_ReturnTax",     
                   "N2_IndividualTax", 
                   "N2_TaxReductionSum",       
                   "N2_SumD1", 
                   "N2_SumD2", 
                   "N2_OffsetTax",     
                   "N2_AccountNumber", 
                   "N2_OperationDate", 
                   "N2_IsGetTax",      
                   "N2_CouponNumber",  
                   "N2_CouponStartDate",       
                   "N2_CouponEndDate", 
                   "N2_ProcResult",    
                   "N2_PayReceivedDate",       
                   "N2_FixingDate",    
                   "N2_Quantity",
                   "N2_Status",    
                   "N2_Error",     
                   "N2_PartyID",   
                   "N2_ContractID",
                   "N2_FIID"      
                   );

    query =   " select cd.*, TO_CHAR(cd.t_ID) as ID_str, TO_CHAR(cd.t_RecordPaymentID) as RecordPaymentID_str, TO_CHAR(cd.t_RecordPaymentQtyID) as RecordPaymentQtyID_str, "
            + "        NVL(na.t_szNameAlg, CHR(1)) as StatusName "
            + "   from dcdrecords_dbt cd "
            + "        left join dnamealg_dbt na ON na.t_iTypeAlg = 7341 and na.t_iNumberAlg = cd.t_Status"
            + "  where cd.t_Status <> "+CDRECORDS_STATUS_PROCESSED
            + "    and cd.t_RequestDate >= trunc(sysdate) - 10 "
            + "    and LOWER(cd.t_CorporateActionType) IN ('redm', 'bput') "
            + " order by cd.t_ID ASC";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_RepDate);

    DataSet = cmd.Execute();

    while(DataSet.moveNext())
      PrintTableLine("N2_ID",                     DataSet.ID_str,                   null,
                     "N2_GUID",                   DataSet.GUID,                     null,
                     "N2_RequestDate",            date(DataSet.RequestDate),        null,
                     "N2_RequestTime",            time(DataSet.RequestTime),        null,
                     "N2_ShortName",              DataSet.ShortName,                null,
                     "N2_FullName",               DataSet.FullName,                 null,
                     "N2_AgreementNumber",        DataSet.AgreementNumber,          null,
                     "N2_IsIIS",                  DataSet.IsIIS,                    null,
                     "N2_AgreementOpenDate",      date(DataSet.AgreementOpenDate),  null,
                     "N2_AgreementCloseDate",     date(DataSet.AgreementCloseDate), null,
                     "N2_CorporateActionType",    DataSet.CorporateActionType,      null,
                     "N2_PaymentType",            DataSet.PaymentType,              null,
                     "N2_RecordPaymentID",        DataSet.RecordPaymentID_str,      null,
                     "N2_RecordPaymentQtyID",     DataSet.RecordPaymentQtyID_str,   null,
                     "N2_OperationStatus",        DataSet.OperationStatus,          null,
                     "N2_PaymentDate",            date(DataSet.PaymentDate),        null,
                     "N2_ClientID_ObjectID",      DataSet.ClientID_ObjectID,        null,
                     "N2_FinancialName",          DataSet.FinancialName,            null,
                     "N2_ISINRegistrationNumber", DataSet.ISINRegistrationNumber,   null,
                     "N2_RecordSNOBID",           DataSet.RecordSNOBID,             null,
                     "N2_TaxRate",                DataSet.TaxRate,                  null,
                     "N2_TaxBase",                DataSet.TaxBase,                  null,
                     "N2_IssuerCurrency",         DataSet.IssuerCurrency,           null,
                     "N2_IssuerSum",              DataSet.IssuerSum,                null,
                     "N2_ClientSum",              DataSet.ClientSum,                null,
                     "N2_ClientCurrency",         DataSet.ClientCurrency,           null,
                     "N2_KBK",                    DataSet.KBK,                      null,
                     "N2_ReturnTax",              DataSet.ReturnTax,                null,
                     "N2_IndividualTax",          DataSet.IndividualTax,            null,
                     "N2_TaxReductionSum",        DataSet.TaxReductionSum,          null,
                     "N2_SumD1",                  DataSet.SumD1,                    null,
                     "N2_SumD2",                  DataSet.SumD2,                    null,
                     "N2_OffsetTax",              DataSet.OffsetTax,                null,
                     "N2_AccountNumber",          DataSet.AccountNumber,            null,
                     "N2_OperationDate",          date(DataSet.OperationDate),      null,
                     "N2_IsGetTax",               DataSet.IsGetTax,                 null,
                     "N2_CouponNumber",           DataSet.CouponNumber,             null,
                     "N2_CouponStartDate",        date(DataSet.CouponStartDate),    null,
                     "N2_CouponEndDate",          date(DataSet.CouponEndDate),      null,
                     "N2_ProcResult",             DataSet.ProcResult,               null,
                     "N2_PayReceivedDate",        date(DataSet.PayReceivedDate),    null,
                     "N2_FixingDate",             date(DataSet.FixingDate),         null,
                     "N2_Quantity",               DataSet.Quantity,                 null,
                     "N2_Status",                 DataSet.StatusName,               null,
                     "N2_Error",                  DataSet.Error,                    null,
                     "N2_PartyID",                DataSet.PartyID,                  null,
                     "N2_ContractID",             DataSet.ContractID,               null,
                     "N2_FIID",                   DataSet.FIID,                     null
                    ); 
    end;

    EndTable();
    CopyAllSheetInTotalBook(SheetName, false, GetTableRange(), 0, SheetName);
  END;

  PRIVATE MACRO Create()
    
    CreateSheetPaymentsOnDate();

    CreateSheetPaymError();
    
  END;

  MACRO Run()
    Run();

    for (var fileName, GetFullReportFileNames())
      return fileName;
    end;

    return "";
  END;

  initDL_CReportTemplate( NULL, "Report_CdRecords.xlsx", true, null, null, true ); 
END;


macro CreateCdRecordsRep()
  var cmd, DataSet, query = "";
  var RepDate = date(0,0,0);

  if(НаправлятьОтчетУНКДДиасофт() == false)
    return 0;
  end;

  cmd = DL_RSDCommand("select sysdate dt from dual");

  DataSet = cmd.execute();
  DataSet.moveNext();

  DtTmSplit(DataSet.dt, RepDate, null);

  RepDate = RepDate - 1;
  
  var RepObj = Sp_CdRecords_Report(RepDate);

  var FullFileNameXLSX = RepObj.Run();

  RepObj = NULL;

  if(not isStandAlone())
    FullFileNameXLSX = "$"+FullFileNameXLSX;
  end;
  
  if(FullFileNameXLSX != "")
    var day, mon, year;
    var hour, min, sec;
    var FileName, FileExt;
    
    DateSplit(date(), day, mon, year);
    TimeSplit(time(), hour, min, sec);
    
    var FromDir = SplitFile(FullFileNameXLSX, FileName, FileExt);
    
    var NewFileNameXLSX = "Отчет_по_обработке_выплат_по_КД_Диасофта_"+string(day:o:2)+string(mon:o:2)+string(year)+"_"+string(hour:f:2)+string(min:f:2)+string(sec:f:2) + ".xlsx";

    if(not RenameFile(FullFileNameXLSX, FromDir+NewFileNameXLSX))
      msgbox("Ошибка при переименовании файла отчета");
    else
      //Отправка файла
      var EMails = ПолучателиОтчетаУНКДДиасофт();

      if(EMails != "")
        var emailText, Subject, v_email_processor;
          
        query =   " select t_CorporateActionType, t_ISINRegistrationNumber, t_PaymentDate, "
                + "        count(1) as CntPayms, "
                + "        SUM(case when LOWER(t_OperationStatus) = 'активна' then 1 else 0 end) as CntActive, "
                + "        SUM(case when LOWER(t_OperationStatus) = 'отменена' then 1 else 0 end) as CntCancel, "
                + "        SUM(case when t_Status = "+CDRECORDS_STATUS_PROCESSED+" then 1 else 0 end) as CntOK, "
                + "        SUM(case when t_Status <> "+CDRECORDS_STATUS_PROCESSED+" then 1 else 0 end) as CntNotOK "
                + "   from dcdrecords_dbt "
                + "  where t_RequestDate = ? "
                + "    and LOWER(t_CorporateActionType) IN ('redm', 'bput')"
                + "  group by t_CorporateActionType, t_ISINRegistrationNumber, t_PaymentDate"
                + "  order by t_CorporateActionType, t_ISINRegistrationNumber, t_PaymentDate";
        
        cmd = DL_RSDCommand(query);

        cmd.AddParam(RepDate);

        DataSet = cmd.Execute();

        Subject = "Учет НДФЛ по операциям погашения ц/б в Диасофте за " + string(RepDate:f);

        emailText =   "<div>"
                    + "За "+string(RepDate:f)
                    + "<br><br>"
                    + "<table style=\"border-collapse: collapse; width: 95%;\" border=\"1\">"
                    + "<tbody>"
                    + "<tr>"
                    + "<td style=\"width: 5%; text-align: center;\"><b>Тип КД</b></td>"
                    + "<td style=\"width: 15%; text-align: center;\"><b>ISIN</b></td>"
                    + "<td style=\"width: 10%; text-align: center;\"><b>Дата выплаты</b></td>"
                    + "<td style=\"width: 15%; text-align: center;\"><b>Кол-во выплат по КД</b></td>"
                    + "<td style=\"width: 15%; text-align: center;\"><b>Из них: Активна</b></td>"
                    + "<td style=\"width: 15%; text-align: center;\"><b>Из них: Отменена</b></td>"
                    + "<td style=\"width: 10%; text-align: center;\"><b>Обработано успешно</b></td>"
                    + "<td style=\"width: 10%; text-align: center;\"><b>Ошибка обработки</b></td>"
                    + "</tr>";

        while(DataSet.moveNext())
          emailText = emailText + "<tr>"
                                + "<td style=\"width: 5%; text-align: center;\">"+DataSet.CorporateActionType+"</td>"
                                + "<td style=\"width: 15%; text-align: center;\">"+DataSet.ISINRegistrationNumber+"</td>"
                                + "<td style=\"width: 10%; text-align: center;\">"+string(date(DataSet.PaymentDate):f)+"</td>"
                                + "<td style=\"width: 15%; text-align: center;\">"+int(DataSet.CntPayms)+"</td>"
                                + "<td style=\"width: 15%; text-align: center;\">"+int(DataSet.CntActive)+"</td>"
                                + "<td style=\"width: 15%; text-align: center;\">"+int(DataSet.CntCancel)+"</td>"
                                + "<td style=\"width: 10%; text-align: center;\">"+int(DataSet.CntOK)+"</td>"
                                + "<td style=\"width: 10%; text-align: center;\">"+int(DataSet.CntNotOK)+"</td>"
                                + "</tr>";
        end;

        emailText = emailText 
                    + "</tbody></table>"
                    + "</div>";

        v_email_processor = c_email_proc_env();

        v_email_processor.m_add_email_to_list(EMails);

        v_email_processor.m_set_msg_head(Subject);
        v_email_processor.m_add_row_to_msg_text(emailText);

        if(NewFileNameXLSX != "")
          v_email_processor.m_add_attach_to_list(FromDir+NewFileNameXLSX);
        end;

        v_email_processor.m_save_to_submit_synch(true);
        v_email_processor.m_submit_email_synch();

      end;
    end;
  end;
end;
