/*
$Name:         scorc015.mac
$Module:       Ценные бумаги
$Description:  не используется
*/

/* Операция продажи ц/б на бирже (или через брокера)
   Шаг - Актуализация счетов внебаланса */

import InsCarryDoc, "sp_car.mac", "sp_carrl.mac";

macro ExecuteStep( doc, FDoc, DocKind )
  
  record deal(dl_tick);
  var    FD, i, dat, DealType, MarketAcc, FIRoles = TArray;;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( not FD.CheckCliring( true ) ) 
     return 1;
  end;

  GetOprDate( DATE_DEALDATE, dat );
  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( not IsClientDeal(deal) ) /*собственные сделки */ 
     if( not АктуализироватьСрочныеСчета( FD, dat ) )
        return 1;
     end;
  end;

  /*статус лота меняем на инициализирован*/
  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_CREATE, FD.DateArray[DATE_DEALDATE], FD ) )
     msgbox("Ошибка при изменении статуса лота");
     return 1;
  end;     

  if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_PLANE ) )
     msgbox("Ошибка при изменении статуса сделки");
     return 1;
  end;


  return 0;
end;

