/*
$Name:         scorc026.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция продажи, погашения ц/б на бирже (или через брокера)
   Актуализация счетов балансового учета. */

import InsCarryDoc, "sp_car.mac", "sp_carrl.mac", "sp_cars.mac";

macro ExecuteStep( doc, FDoc )
  
  record deal(dl_tick);
  var    FD, dat, ContrCateg, FIRoles = TArray, DealType;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( not FD.CheckCliring( true ) ) 
     return 1;
  end;

  if( deal.BofficeKind == DL_SECURITYDOC )  
     GetOprDate( FD.GetKindDate(DATE_DEALBEGINEXEC), dat );
  elif( deal.BofficeKind == DL_RETIREMENT )
     GetOprDate( FD.GetKindDate(DATE_DEALDATE), dat );

     /*статус лота меняем на запланирован. Для сделок это на открытии внебалансовых счетов*/
/*     if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_STATE, dat, PM_WRTSUM_PLANE) )
        msgbox("Ошибка при изменении статуса лота");
        return 1;
     end;                   */

     if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_PLANE ) )
        msgbox("Ошибка при изменении статуса сделки");
        return 1;
     end;

  end;

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( FD.IsOldDeal() )
     return 0;
  end;

  DealType     = FD.ВидСрочностиСделки();

  if( not IsClientDeal(deal) ) /*наша сделка*/

     if( FD.ВедетсяБалансУчетПоСделке() == true )
        if( (( not FD.IsExistAccount( "+Форвард, расчеты", null, true, null, null, null, dat ) ) AND
            ( not FD.OpenAccount( "+Форвард, расчеты", null, null, null, null, dat ) )) OR
            (( not FD.IsExistAccount( "-Форвард, расчеты", null, true, null, null, null, dat ) ) AND
            ( not FD.OpenAccount( "-Форвард, расчеты", null, null, null, null, dat) )) )
          return 1;
        end;
     end;
/*
     if( FD.ExistBack == true )
        ПолучитьРолиКатегорийПоДоговорам( FD, FIRoles );
        if( (not FD.ActualAccount( "Ц/б, договор", null, null, FIRoles, null, dat ) ) OR
            (not FD.OpenAccount( "Затраты, договор", null, null, FIRoles, null, dat ) )
          )
             return 1;
        end;
     end;
*/


     if( FI_IsCouponAvoiriss( FD.fininstr ) OR 
         ((FD.tick.rec.BofficeKind == DL_RETIREMENT) AND FI_IsBond(FD.fininstr)) )

        ПолучитьРолиКатегорийЗатрат( FD, FIRoles );
/*
        if( FD.KindPortf != KINDPORT_PROMISSORY ) 
           if( not FD.ActualAccount( "-НКД", null, null, FIRoles, null, dat ))
              return 1;
           end;
        end;

        if( not FD.ExistBack ) 
           if( not FD.OpenAccount( "+НКД", null, null, FIRoles[0], null, dat ) )
              return 1;
           end;
        else
           ПолучитьРолиКатегорийПоДоговорам( FD, FIRoles );
           if( not FD.OpenAccount( "-НКД, договор", null, null, FIRoles, null, dat ) )
              return 1;
           end;

           if( not FD.OpenAccount( "+НКД", null, null, FIROLE_BA, null, dat ) )
              return 1;
           end;
        end;    
*/
        if( not FD.OpenAccount( "+%ДЦ/б", null, null, null, null, dat) )   
           return 1;
        end;
     end;

     if( (not FD.OpenAccount( "+Маржа, ц/б", null, null, null, null, dat)) OR
         (not FD.OpenAccount( "-Маржа, ц/б", null, null, null, null, dat))
       )   
        return 1;
     end;

     /*
     if( FI_IsQuoted( FD.fininstr.rec.FIID, dat ) ) 
        if( (not FD.OpenAccount( "+Переоценка, ц/б", null, null, FIROLE_BA_RESALE, null, dat)) OR
            (not FD.OpenAccount( "-Переоценка, ц/б", null, null, FIROLE_BA_RESALE, null, dat)) )   
           return 1;
        end;
     end; 
     */
/*
     /*валюта оплаты не равна валюте цены*/
     if( ( NOT IsRET_ISSUE(FD.Group) ) AND
         ( FD.GetPayFIID() != FD.dl_leg.rec.CFI ) AND
         ( FD.ВедетсяБалансУчетПоСделке() OR FD.IsBack )
         ) 
       if( not FD.OpenAccount( "Прочие расходы", null, null, null, null, dat ) OR
           not FD.OpenAccount( "Прочие доходы", null, null, null, null, dat ) )
          return 1;
       end;
     end; 
*/
  else /*клиентская сделка*/
/*
     if( (not FD.OpenAccount( "+КВ, ц/б", null, null, null, null, dat ) ) )
        return 1;             
     end; 
*/
     if( not FD.OpenAccount( "-НДС", null, null, null, null, dat ) )   
        return 1;
     end;
  end;  

  ContrCateg = ПолучитьКатегориюСчетаКонтрагента( FD, true );

  if( (ContrCateg != "Корсчет") AND (ContrCateg != "") )
     if( not FD.OpenAccount( ContrCateg, null, null, null, null, dat) )
           return 1;
        end;
     end; 

  if( FD.ExistBack ) 
     ContrCateg = ПолучитьКатегориюСчетаКонтрагента( FD, false );

     if( (ContrCateg != "Корсчет") AND (ContrCateg != "") )
        if( not FD.OpenAccount( ContrCateg, null, null, null, null, dat) )
           return 1;
        end; 
     end;
  end; 

  return 0;
end;

