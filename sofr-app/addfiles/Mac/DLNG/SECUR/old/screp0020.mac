/*
$Name:         screp0020.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция РЕПО (ОРЦБ)
   Расчета коммисий  */
import InsCarryDoc, "sp_categ.mac", "sp_car.mac", "sp_carcm.mac";

macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);
  var     FD;
  var     Dc, Di, Dk, Dp;

  SetBuff( deal, FDoc ); 

  FD = SPFirstDoc( deal, false );

  GetOprDate( FD.GetKindDate(DATE_DEALDATE), Dc );
  GetOprDate( FD.GetKindDate(DATE_DEALEXEC), Di );

  if( Dc != Di )
     if( false)//ПоставитьСнятьВнебалансЧастьРЕПО( FD, FDoc, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.Amount, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, FD.DateArray[DATE_DEALDATE], true ) )
        return 1;
     end;
  else
     if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_BALANCE ) )
        msgbox("Ошибка при изменении статуса сделки");
        return 1;
     end;
  end;

  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_CREATE, FD.DateArray[DATE_DEALDATE], FD ) )
     msgbox("Ошибка при изменении статуса лота");
     return 1;
  end;     

  if( FD.tick.rec.BrokerID > 0 )/*если задан брокер, значит будут комиссии брокеру по договору с брокером*/

     Dk = FD.GetMinComPlanDateByDeal(null,FD.tick.rec.BrokerID);
     GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), Dp );

     if( (Dk != DATE(0,0,0)) and (Dk != Dp) )
        /*Переинитим дату "дата комиссии" по сделке значением Дк*/
        DefineOprDate( FD.GetKindDate(DATE_DEALCOMISS), Dk );
        /* КО = "Оплатить" */
        if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KO, SP_OPERSTATUS_SECURDEALS_KO_PAY) )
           msgbox( "Ошибка при установке статуса <Оплата комиссий> операции" );
           return 1;
        end;
     else
        /* КО = "Завершить" */
        if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KO, SP_OPERSTATUS_SECURDEALS_KO_FINISH) )
           msgbox( "Ошибка при установке статуса <Оплата комиссий> операции" );
           return 1;
        end;
     end;

  elif( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KO, SP_OPERSTATUS_SECURDEALS_KO_FINISH) )/* КО = "Завершить"*/
     msgbox( "Ошибка при установке статуса <Оплата комиссий> операции" );
     return 1;
  end;
  
  return 0;
end;
