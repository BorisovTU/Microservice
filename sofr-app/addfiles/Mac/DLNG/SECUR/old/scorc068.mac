/*
$Name:         scorc068.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция продажи ц/б на ОРЦБ     
   Шаг - списание лота */

import "sp_categ.mac", "scservop.mac", "sp_carrl.mac";

/*группа списания для операции*/
VAR    WriteOffGroups = TArray;   /*данные в массиве используются программой при выполнении шага*/      
VAR    WrtOffFirstLot:bool = false;/*Признак списывать сначала с лота по первой части для сделок покупки с обратной продажей*/ 

macro ExecuteStep( Doc, FDoc )

  record deal(dl_tick);
  var    FD, FD_1;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc ( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( FD.IsOldDeal() )
     return 0;
  end;

  if( FD.БылОтказОтИсполнения() != false ) /*был отказ от сделки*/
     return 0;
  end;

  /*В погашениях связывание может происходить и для тех лотов погашения, 
    где еще не произошла поставка ц/б*/
  if( deal.BofficeKind != DL_RETIREMENT )
     if( FD.pmwrtsum.rec.State < PM_WRTSUM_FORM )
        return SayErrorBuySale( deal, "При списании лот должен иметь статус поставлен или готов" );
     end;   
  end;

  if( bAND( FD.dl_leg.rec.BitMask, DL_LEG_ANOTHER_DEPOSITARY ) )
     return 0; /*на лоте признак "учет в другом депозитарии", ничего не делаем*/
  end; 

  if( ПолучитьГруппыСписания( FD, WriteOffGroups ) == false )
     return SayErrorBuySale( deal, "Ошибка при определении групп списания" );
  end; 

  if( IsBackExec(deal, SP_EXECUTE_STEP_SALE) )
     /*проверяем, куда велся учет в первой части сделки. Если не в инв. портфель,
       то сначала будем пытаться списать с лота по первой части */
     FD_1 = SPFirstDoc( deal, false );
     if( not FD_1.УчитыватьВИнвПортф() )
        WrtOffFirstLot = true;
     end;
  end;

  /*непосредственно списание (и проверка на готовность лота) выполняется программой на этом шаге*/ 
  return 0;
end;
