/*
$Name:         scso210.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция внебиржевой продажи ц/б
   шаг актуализации балансовых счетов */

import InsCarryDoc, "sp_class.mac", "sp_catac.mac", "sp_carrl.mac", "sp_car.mac", "sp_cars.mac";

macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);
  var  FD, dat;
  var  FIRoles = TArray;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( deal.BofficeKind == DL_SECURITYDOC )  
     GetOprDate( FD.GetKindDate(DATE_DEALBEGINEXEC), dat );
  elif( deal.BofficeKind == DL_RETIREMENT )
     GetOprDate( FD.GetKindDate(DATE_DEALDATE), dat );
  end;
  
  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( FD.IsOldDeal() )
     return 0;
  end;

  if( not IsClientDeal(FD.tick.rec) ) /*наша сделка*/

     if( FD.ВедетсяБалансУчетПоСделке() )
        if(( (( not FD.IsExistAccount( "+Форвард, расчеты", null, true, null, null, null, dat ) ) AND
            ( not FD.OpenAccount( "+Форвард, расчеты", null, null, null, null, dat ) )) OR
            (( not FD.IsExistAccount( "-Форвард, расчеты", null, true, null, null, null, dat ) ) AND
            ( not FD.OpenAccount( "-Форвард, расчеты", null, null, null, null, dat) )) )
          return 1;
        end;
     end;

     if( (not FD.ActualAccount( "НДC", null, null, FIRoles, null, dat )) OR
         (not FD.OpenAccount( "+%ДЦ/б", null, null, null, null, dat)) 
       )  
        return 1;
     end;

     if( not FD.ActualAccount( "Реализация, ц/б", null, null, FIRoles, null, dat ))
        return 1;
     end;

     /*if( FI_IsQuoted( FD.fininstr.rec.FIID, dat ) AND 
         (SP_WriteOffOnlySetPortofolio == false)
       ) 
        if( (not FD.OpenAccount( "+Переоценка, ц/б", null, null, FIROLE_BA_RESALE, null, dat)) OR
            (not FD.OpenAccount( "-Переоценка, ц/б", null, null, FIROLE_BA_RESALE, null, dat)) )   
           return 1;
        end;
     end; */
     
     if( (not FD.OpenAccount( "+Маржа, ц/б", null, null, null, null, dat)) OR
         (not FD.OpenAccount( "-Маржа, ц/б", null, null, null, null, dat)) )
        return 1;
     end;
  end;

  return 0;

end;
