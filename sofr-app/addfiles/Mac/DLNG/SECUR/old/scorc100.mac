/*
$Name:         scorc100.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция продажи ц/б на ОРЦБ     
   Шаг - отражение фин.результата   */

import InsCarryDoc, "sp_cars.mac", "sp_categ.mac", "scservop.mac";

macro ExecuteStep( Doc, FDoc )

  record deal(dl_tick);
  var    FD, dat, KindDate;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc ( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( deal.BofficeKind == DL_SECURITYDOC )
     GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat ); /*Дата поставки ц/б */
  else /*погашение*/
     /*погашение облигаций*/
     if( IsRET_ISSUE(FD.Group) ) 
        KindDate = DATE_DEALSETAVOIRISS; /*Дата списания*/
     else
        KindDate = DATE_DEALPAY; /*Дата погашения*/
     end;

     GetOprDate( KindDate, dat );
  end;

  if( dat > {curdate} )
    return SayErrorBuySale( deal, "Преждевременное выполнение шага запрещено." );
  end;

  return 0;

end;
