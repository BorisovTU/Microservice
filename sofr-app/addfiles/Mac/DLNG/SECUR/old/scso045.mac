/*
$Name:         scso045.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция внебиржевой продажи ц/б
   Шаг выбора - Вести внебалансовый учет? */
import InsCarryDoc, "sp_class.mac", "sp_car.mac";

macro ExecuteCaseStep( Kind_Operation, Number_Step, FDoc, KindDoc)

  record  deal(dl_tick);
  var     FD, FD1, NumStepSetOnOutBalance, NumStepActualBalAcc, dat, dat2, datavance;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );
   
  if( FD.БылОтказОтИсполнения() == false ) /*не было отказа от сделки\2ч*/   

     if( FD.IsBack == false )
        NumStepSetOnOutBalance = "50";
        NumStepActualBalAcc    = "70"; /*Ожидание исполнения */
     else
       NumStepSetOnOutBalance = "350";
       NumStepActualBalAcc    = "470"; /*Ожидание исполнения второй части*/
       /*дата учета первой части*/
     end;  

     if (FD.IsBack == true)
        FD1 = SPFirstDoc( deal, false ); /*по первой части*/

        GetOprDate( DATE_DEALBEGIN_2, dat );
        GetOprDate( DATE_DEALPAY_2 , dat2 );
        GetOprDate( DATE_DEALAVANCE_2, datavance); 

       /* запрос 91162
        Если (Дата начала 2 ч. != Дате оплаты 2 части)  и (Дата начала 2 ч. != Дате аванса 2 или аванса  2 ч. нет)
        и поставка по 1 части не исполнена, то не выполнять шаг: ошибка "Поставка по 1 части не исполнена"*/
        if ((dat != dat2) and ( ( dat != datavance) or (not FD.ExistAvance)) 
                          and (not ТОЗакрыто(FD1.GetRQ(DLRQ_TYPE_DELIVERY)) )                         
           )
          MsgBox ("Шаг \"Вести внебалансовый учет по второй части сделки ?\" не выполняется.\n Ожидается исполнение поставки по 1 части сделки.");
          return 1;
        end;
     end;

     return ОпределитьШагВнебалансовогоУчета( FD, NumStepActualBalAcc, NumStepSetOnOutBalance );
  else
     return "";
  end;  

end;
