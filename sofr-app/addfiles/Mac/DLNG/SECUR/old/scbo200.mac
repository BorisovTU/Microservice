/*
$Name:         scbo200.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция внебиржевой покупки ц/б
   шаг снятия сделки с внебалансового учета */

import InsCarryDoc, "sp_carou.mac", "sp_class.mac";

macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);
  var     FD, dat;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );

  GetOprDate( FD.GetKindDate(DATE_DEALBEGINEXEC), dat );

  if (FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.State == DLRQ_STATE_DELAYED)
     if ( dat < FD.GetAvoirissPlanDate( FD.dl_leg.rec ))
        msgbox ("Дата исполнения должна быть больше плановой даты поставки");
        return 1;
     end;
  end;

  if ( (FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.State == DLRQ_STATE_DELAYED) OR 
             ((FD.ExistAvance()) AND (FD.GetRQ(DLRQ_TYPE_AVANCE).rec.State == DLRQ_STATE_DELAYED)) )
     if( FD.ExistAvance() )
        if( dat < FD.DateArray[DATE_DEALAVANCE_PLAN] )
           msgbox( "Дата исполнения должна быть больше плановой даты аванса" );
           return 1;
        end;
     else if ( dat < FD.GetPayPlanDate(FD.dl_leg.rec) )
            msgbox ("Дата исполнения должна быть больше плановой даты оплаты");
            return 1;
         end;
     end;
  end;

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

//  if (СнятьСВнебаланса( FD, Dat, Doc ) != 0)
//    return 1;
//  end;

  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_BU, SP_OPERSTATUS_SECURDEALS_BU_RUN) ) 
     msgbox( "Ошибка при установке статуса <Балансовый учет> операции" );
     return 1;
  end;

  return 0;
end;
