/*
$Name:         scrou0110.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция РЕПО без признания ц/б (не ОРЦБ)
   Расчет комиссий     */

import InsCarryDoc, "sp_class.mac", "sp_car2.mac", "sp_carcm.mac";

macro ExecuteStep( doc, FDoc)
  record  deal(dl_tick);
  var     FD, FD2, NeedInsertDepoDraft = false, NeedInsertDepoDraft2 = false, err = 0, dat, dat2;
  var     Dc, Sum = $0, Dp, Dk;
  var     rq_money = TRecHandler("dlrq.dbt");

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, false );
  FD2 = SPFirstDoc( deal, true );

  rq_money = FD.GetRQ(DLRQ_TYPE_PAYMENT);

  if (FD.ExistAvance)
     GetOprDate( FD.GetKindDate(DATE_DEALAVANCE), dat );
     Sum = rq_money.rec.Amount + FD.GetRQ(DLRQ_TYPE_AVANCE).rec.Amount;
  else
     GetOprDate( FD.GetKindDate(DATE_DEALPAY), dat );
     Sum = rq_money.rec.Amount;
  end;
  
  GetOprDate( FD.GetKindDate(DATE_DEALDATE), Dc );
/*Если дата заключения сделки РЕПО не совпадает с датой оплаты (аванса) по 1 части,
  то ведется внебалансовый учет требований и обязательств по оплате сделок РЕПО на счетах Главы В*/ 
  if( Dc != dat )
     if( false) //ПоставитьСнятьВнебалансЧастьРЕПО( FD, FDoc, Sum, rq_money.rec.FIID, FD.DateArray[DATE_DEALDATE], true ) )
        return 1;
     end;
  else
     if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_BALANCE ) )
        msgbox("Ошибка при изменении статуса сделки");
        return 1;
     end;
  end;

  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_CREATE, FD.DateArray[DATE_DEALDATE], FD ) )
     msgbox("Ошибка при изменении статуса лота");
     return 1;
  end;

  if(СделкаСКлиентомКонтрагентом(deal))
    if( not ОбновитьЛот( FD.pmwrtsum_contr, PM_WRTSUM_UPDTMODE_CREATE, FD.DateArray[DATE_DEALDATE], FD, NULL, true ) )
      msgbox("Ошибка при изменении статуса лота клиента-контрагента");
      return 1;
    end;
  end;

  /*Если есть аванс по 1 ч А1 = "Оплатить", иначе А1 = "Завершить"*/
  if (FD.ExistAvance)
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A1, SP_OPERSTATUS_SECURDEALS_A1_PAY) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 1 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A1, SP_OPERSTATUS_SECURDEALS_A1_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 1 ч> операции" );
        return 1;
     end;
  end;

  /*О1 = "Оплатить"*/
  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_O1, SP_OPERSTATUS_SECURDEALS_O1_PAY) ) 
     msgbox( "Ошибка при установке статуса <Оплата по 1 ч> операции" );
     return 1;
  end;

  /*Если требуется предварительное формирование поручения по 1 ч. Ф1 = "Сформировать", иначе Ф1 = "Завершить"*/
  NeedInsertDepoDraft = НужноПредФормПоручДЕПО(FD, err);
  if (err > 0)
     msgbox( "Ошибка при определении необходимости предварительного формирования поручения" );
     return 1;
  end;

  if (NeedInsertDepoDraft == true)

     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D1, SP_OPERSTATUS_SECURDEALS_D1_FORM) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 1 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D1, SP_OPERSTATUS_SECURDEALS_D1_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 1 ч> операции" );
        return 1;
     end;
  end;

  /*П1 = "Поставить"*/
  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_P1, SP_OPERSTATUS_SECURDEALS_P1_SET) ) 
     msgbox( "Ошибка при установке статуса <Поставка по 1 ч> операции" );
     return 1;
  end;

  /*Если есть аванс по 2 ч А2 = "Оплатить", иначе А2 = "Завершить"*/
  if (FD2.ExistAvance)
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A2, SP_OPERSTATUS_SECURDEALS_A2_PAY) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 2 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_A2, SP_OPERSTATUS_SECURDEALS_A2_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Оплата аванса по 2 ч> операции" );
        return 1;
     end;
  end;

  /*Если требуется предварительное формирование поручения по 2 ч. Ф2 = "Сформировать", иначе Ф2 = "Завершить"*/
  NeedInsertDepoDraft2 = НужноПредФормПоручДЕПО(FD2, err);
  if (err > 0)
     msgbox( "Ошибка при определении необходимости предварительного формирования поручения" );
     return 1;
  end;

  if (NeedInsertDepoDraft2 == true)
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D2, SP_OPERSTATUS_SECURDEALS_D2_FORM) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 2 ч> операции" );
        return 1;
     end;
  else
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_D2, SP_OPERSTATUS_SECURDEALS_D2_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Формирование поручения по 2 ч> операции" );
        return 1;
     end;
  end;

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), Dp  ); /*дата поставки*/
  Dk = FD.GetMinComPlanDateByDeal();
  
  if( (Dk != DATE(0,0,0)) and (Dk != Dp) )
     /*Переинитим дату "дата комиссии" по сделке значением Дк*/
     DefineOprDate( FD.GetKindDate(DATE_DEALCOMISS), Dk );
     /* КО = "Оплатить" */
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KO, SP_OPERSTATUS_SECURDEALS_KO_PAY) )
        msgbox( "Ошибка при установке статуса <Оплата комиссий> операции" );
        return 1;
     end;
  else
     /* КО = "Завершить" */
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_KO, SP_OPERSTATUS_SECURDEALS_KO_FINISH) )
        msgbox( "Ошибка при установке статуса <Оплата комиссий> операции" );
        return 1;
     end;
  end;

  return 0;
end;
