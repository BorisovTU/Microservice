/*
$Name:         scorc065.mac
$Module:       Ценные бумаги
$Description:  не используется
*/
/* Операция продажи ц/б на ОРЦБ     
   Шаг - проверка режима списания   */
import InsCarryDoc, "sp_categ.mac", "sp_car.mac";

macro ExecuteCaseStep( Kind_Operation, Number_Step, FDoc, KindDoc)

  record deal(dl_tick);       
  var    FD, NumStepOnline, NumStepOffline, ContrNumber = ""; 

  SetBuff( deal, FDoc );
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( FD.БылОтказОтИсполнения() != false ) /*был отказ от сделки (для просроченной сделки)*/
     return 0;
  end;

  if( FD.IsBack == false )
     if( not FD.ExistBack )
        NumStepOnline  = "67";
        NumStepOffline = "66";
     else
        NumStepOnline  = "310";
        NumStepOffline = "315";
     end; 
  else
     NumStepOnline  = "610";
     NumStepOffline = "585";
  end;

  УстановитьДатуЗавершенияСделки( FD );

  if( FD.GetModeWriteOff( true ) != "X" ) /* "X" - online, "" - offline */
     return NumStepOffline; /*Расчет списания offline*/
  else
     if( deal.BofficeKind != DL_RETIREMENT ) /*В погашениях можно выполнять списание без комиссий*/
        if( ((not FD.ExistBack) OR FD.IsBack) AND FD.GetPeriodComOnFinalTrDay(false,@ContrNumber) )/*по договору есть периодические комиссии*/
           msgbox("По договору \""+ContrNumber+"\" есть периодические комиссии,| для которых у категории \"Расчет комиссий в БО ЦБ\" указано значение \"При завершении торгового дня\".|Нельзя продолжить сделку в режиме online.");
           return 1;
        end;
     end;
  end; 

  return NumStepOnline; /*Расчет списания online*/
end;

