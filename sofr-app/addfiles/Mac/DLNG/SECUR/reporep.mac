/*
$Name: reporep.mac 
$Module: Ценные бумаги
$Description: Отчет "Доходы и расходы по сделкам РЕПО"
*/
/*
Переписан и переведен в Excel: Макаров А.Г. 31.03.2006
*/
import "sp_class.mac", Проценты, "SpRepFun.mac", RsbDataSet, "globals.mac", "Reporep_Form.mac";
import "or_rep_h.mac";

/*var {CCYNatCur} = "руб";*/
private const ПЕРВЫЙ_КВАРТАЛ = 3,
              ПОЛУГОДИЕ = 6,                  
              ДЕВЯТЬ_МЕСЯЦЕВ = 9,
              ГОД = 12;

const ДОХОДЫ_ПО_РЕПО = 1,
      РАСХОДЫ_ПО_РЕПО = 2;

private const ALL = -1,
              SHARE = 1, 
              BOND = 2;

PRIVATE VAR m_Report;

private const
   StatProfit = "Выпуск отчета \"Доходы по сделкам РЕПО\"",
   StatCharge = "Выпуск отчета \"Расходы по сделкам РЕПО\"";

private file REPO_RepTmp( "reporep.tmp" ) key 0 WRITE;
private const ERROR = 1;
private var IsApp;
private var NRecs = 0;

private var ReportHeader =
"\n\n#######################################################################################################################################################\n" +
"#########################################\n" +
"###########################################################################################################################################################\n" +
"\n" +
"за период: ########################\n";

macro GetHeadTable(Data)

   var Head = "";
   if(Data.Mode == ДОХОДЫ_ПО_РЕПО)

      Head =
        "┌─────────────────────────┬───────────────┬────────────┬────────────┬────────────┬────────────┬───────────┬────────────┬────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬───────────┬────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────┬────────────────┬────────────────┬─────────────────────────────────────┬────────────────────────┬────────────┬────────────┐\n"+
        "│                         │               │            │            │            │            │           │            │            │                                                                                                                 │            │            │            │            │            │            │           │            │                                                                                                                                                                                                                                   │                                     │                │                │                                     │                        │            │            │\n"+
        "│      Объект сделки      │      №        │ Вид сделки │    Дата    │    Дата    │    Дата    │  Кол-во   │    Курс    │    Курс    │                                                 Сумма сделки                                                    │ Вид сделки │    Дата    │    Дата    │    Дата    │    Курс    │    Курс    │  Кол-во   │   Ставка   │                                                                                                                             Сумма сделки                                                                                          │                                     │    Курсовая    │   Нереализо-   │                                     │        Контрагент      │  Сделка    │  Ставка    │\n"+
        "│   (вид ценной бумаги)   │   договора    │ по 1 части │  поставки  │   оплаты   │ реализации │  ц/б шт.  │   на дату  │  на дату   │                                                                                                                 │ по 2 части │  поставки  │   оплаты   │ реализации │  на дату   │  на дату   │  ц/б шт.  │    РЕПО    │                                                                                                                                                                                                                                   │           Доходы по сделке          │     разница    │     ванная     │           Купонный доход            │      по сделке РЕПО    │   была     │   была     │\n"+
        "│                         │               │            │  1 части   │   1 части  │    лота    │           │   оплаты   │ реализации ├─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤            │  2 части   │   2 части  │    лота    │  оплаты    │ реализации │           │            ├─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤                                     │                │    курсовая    │                                     │                        │ урегули-   │ изменена   │\n"+
        "│                         │               │            │            │            │  1 части   │           │   1 части  │    лота    │              Стоимость              │                 НКД                 │                ВСЕГО                │            │            │            │  2 части   │  2 части   │    лота    │           │            │              Стоимость              │                 НКД                 │          Погашение купонов          │         Частичное погашение         │       Компенсационные взносы        │                ВСЕГО                │                                     │                │   разница от   │                                     │                        │  рована    │            │\n"+
        "│                         │               │            │            │            │            │           │            │  1 части   ├──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤            │            │            │            │            │  2 части   │           │            ├──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤                │   переоценки   ├──────────────────┬──────────────────┤                        │            │            │\n"+
        "│                         │               │            │            │            │            │           │            │            │       вал.       │        руб.      │       вал.       │        руб.      │       вал.       │        руб.      │            │            │            │            │            │            │           │            │       вал.       │       руб.       │       вал.       │       руб.       │       вал.       │        руб.      │       вал.       │        руб.      │       вал.       │        руб.      │       вал.       │        руб.      │       вал.       │        руб.      │                │                │       вал.       │        руб.      │                        │            │            │\n"+
        "├─────────────────────────┼───────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼────────────────┼────────────────┼──────────────────┼──────────────────┼────────────────────────┼────────────┼────────────┤\n"+
        "│           1             │       2       │      3     │      4     │      4а    │     4б     │     5     │     5a     │     5б     │         6        │        7         │         8        │         9        │        10        │        11        │     12     │     13     │    13б     │    13б     │     14     │    14a     │     22    │     23     │        24        │        25        │        26        │        27        │        28        │        29        │        30        │        31        │        32        │        33        │        34        │        35        │        38        │        39        │       40       │       41       │        42        │        43        │           44           │     45     │     46     │\n"+
        "├─────────────────────────┼───────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼────────────────┼────────────────┼──────────────────┼──────────────────┼────────────────────────┼────────────┼────────────┤";

   else

      Head =
        "┌─────────────────────────┬───────────────┬────────────┬────────────┬────────────┬────────────┬───────────┬────────────┬────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬───────────┬────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────┬───────────────────┬───────────────────┬────────────────┬────────────────┬─────────────────────────────────────┬────────────────────────┬────────────┬────────────┐\n"+
        "│                         │               │            │            │            │            │           │            │            │                                                                                                                 │            │            │            │            │            │            │           │            │                                                                                                                                                                                                                                   │                                     │     Учетная       │                   │                │                │                                     │                        │            │            │\n"+
        "│       Объект сделки     │      №        │ Вид сделки │    Дата    │    Дата    │    Дата    │  Кол-во   │    Курс    │    Курс    │                                                 Сумма сделки                                                    │ Вид сделки │    Дата    │    Дата    │    Дата    │    Курс    │    Курс    │   Кол-во  │   Ставка   │                                                                                                                             Сумма сделки                                                                                          │                                     │   ставка ЦБ РФ    │    Расходы по     │    Курсовая    │   Нереализо-   │                                     │        Контрагент      │  Сделка    │  Ставка    │\n"+
        "│    (вид ценной бумаги)  │   договора    │ по 1 части │  поставки  │   оплаты   │ реализации │  ц/б шт.  │   на дату  │  на дату   │                                                                                                                 │ по 2 части │  поставки  │   оплаты   │ реализации │  на дату   │  на дату   │   ц/б шт. │    РЕПО    │                                                                                                                                                                                                                                   │           Расходы по сделке         │                   │   сделке, прини-  │     разница    │     ванная     │           Купонный доход            │      по сделке РЕПО    │   была     │   была     │\n"+
        "│                         │               │            │  1 части   │   1 части  │    лота    │           │   оплаты   │ реализации ├─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤            │  2 части   │   2 части  │    лота    │  оплаты    │ реализации │           │            ├─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤                                     │                   │    маемые для     │                │    курсовая    │                                     │                        │ урегули-   │ изменена   │\n"+
        "│                         │               │            │            │            │  1 части   │           │   1 части  │    лота    │              Стоимость              │                 НКД                 │                ВСЕГО                │            │            │            │  2 части   │  2 части   │    лота    │           │            │              Стоимость              │                 НКД                 │          Погашение купонов          │         Частичное погашение         │       Компенсационные взносы        │                ВСЕГО                │                                     │                   │  налогообложения  │                │   разница от   │                                     │                        │  рована    │            │\n"+
        "│                         │               │            │            │            │            │           │            │  1 части   ├──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤            │            │            │            │            │  2 части   │           │            ├──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤                   │                   │                │   переоценки   ├──────────────────┬──────────────────┤                        │            │            │\n"+
        "│                         │               │            │            │            │            │           │            │            │       вал.       │       руб.       │       вал.       │       руб.       │       вал.       │        руб.      │            │            │            │            │            │            │           │            │       вал.       │       руб.       │       вал.       │       руб.       │       вал.       │        руб.      │       вал.       │        руб.      │       вал.       │        руб.      │       вал.       │        руб.      │       вал.       │        руб.      │                   │                   │                │                │         вал.     │        руб.      │                        │            │            │\n"+
        "├─────────────────────────┼───────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼───────────────────┼───────────────────┼────────────────┼────────────────┼──────────────────┼──────────────────┼────────────────────────┼────────────┼────────────┤\n"+
        "│            1            │       2       │      3     │      4     │      5     │      6     │     7     │      8     │      9     │         10       │        11        │        12        │        13        │        14        │        15        │     16     │     17     │     18     │     19     │     20     │     21     │     22    │     23     │        24        │        25        │        26        │        27        │        28        │        29        │        30        │        31        │        32        │        33        │        34        │        35        │        38        │        39        │        40         │         41        │       44       │       45       │          46      │        47        │           48           │     49     │     50     │\n"+
        "├─────────────────────────┼───────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───────────┼────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼───────────────────┼───────────────────┼────────────────┼────────────────┼──────────────────┼──────────────────┼────────────────────────┼────────────┼────────────┤";

   end;

   return Head;
end;

class SourceData( _Period:integer, _Year:integer,
                  _AvrIsGosMun:bool, _AvrIsNotGosMun:bool,
                  _NominateInRUR:bool, _NotNominateInRUR:bool, 
                  _AvrKind:integer, _BondKind:integer, _Apostr:bool,
                  _Mode:integer )

var   Period = _Period,                            /*Период*/
      Year = _Year,                                /*Год*/
      AvrIsGosMun  = _AvrIsGosMun,                 /*Гос. и мупицип. ц/б */
      AvrIsNotGosMun = _AvrIsNotGosMun,            /*Кроме гос. и муницип. ц/б */
      NominateInRUR = _NominateInRUR,              /*Номинированные в RUR*/
      NotNominateInRUR = _NotNominateInRUR,        /*Номинированные в иностранной валюте*/
      BondKind = _BondKind,                        /*Вид облигации*/
      AvrKind = _AvrKind,                          /*Вид ц/б*/
      Apostr = _Apostr,                            /*С апострофами*/
      Mode = _Mode;                                /*Режим выпуска отчета*/

var   BegDate:date,       /*Дата начала периода*/
      EndDate:date,       /*Дата конца периода*/
      PeriodName:string;  /*Наименование периода*/

var   WasPrintTableHead = false,   /*Флаг печати шапки таблицы*/
      ReportRun = false;

end;

/*
  Класс для хранения информации о связанных лотах:
  - Дата реализации лота
  - Количество ц/б"
  - Курс на дату реализации лота
  - Стоимость/вал.
  - НКД/вал.
*/
class TAllLinksData( _i, _DateRealize, _Amount, _Course, _Cost_val, _NKD_val, _differ )
   var
      i           = _i,
      DateRealize = _DateRealize,
      Amount      = _Amount,
      Course      = _Course,
      Cost_val    = _Cost_val,
      NKD_val     = _NKD_val,
      differ      = _differ;
end;

class (TArray) TLinksCollector
   /* Очистить массив. */
   macro ClearArray
      this.Size = 0;
   end;

   /* Добавить строчку в массив. */
   macro Add( i, DateRealize, Amount, Course, Cost_val, NKD_val, differ )
      this.(i) = TAllLinksData( i, DateRealize, Amount, Course, Cost_val, NKD_val, differ );
   end;
end; 

private var LinksData1 = TLinksCollector();/*по 1 части*/
private var LinksData2 = TLinksCollector();/*по 2 части*/

macro GetPeriod(Data)
   Data.BegDate = Date(1, 1, Data.Year);
   Data.EndDate = DateAfterCalenMonths(Data.BegDate, Data.Period) - 1; 
   if(Data.Period == ПЕРВЫЙ_КВАРТАЛ)
      Data.PeriodName = "I квартал " + string(Data.Year) + " года";
   elif(Data.Period == ПОЛУГОДИЕ)
      Data.PeriodName = "полугодие " + string(Data.Year) + " года";
   elif(Data.Period == ДЕВЯТЬ_МЕСЯЦЕВ)
      Data.PeriodName = "9 месяцев " + string(Data.Year) + " года";
   else
      Data.PeriodName = string(Data.Year) + " год";
   end;
end;

macro PrintHeadReport(Data)
   record party(party);
   var INN = "", KPP = "", Num, Name, BankName:string;

   if ( ПолучитьСубъекта ( {OurBank}, party ) != 0 ) 
      msgbox("Не могу получить анкету субъекта с ID = " + string({OurBank}));
      exit(1);
   end;

   SplitFullINN(ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, KPP);

   if(INN != "")
      INN = " ИНН " + INN;
   end;

   if(KPP != "")
      KPP = " КПП " + KPP;
   end;
   
   if(Data.Mode == ДОХОДЫ_ПО_РЕПО)
      Num = "9-1";
      Name = "Доходы по сделкам купли-продажи ценных бумаг с обязательным выкупом по второй части операций РЕПО";
      m_Report.SetActiveSheet( "9_1" );
   else
      Num = "9-2";
      Name = "Расходы по сделкам купли-продажи ценных бумаг с обязательным выкупом по второй части операций РЕПО";
      m_Report.SetActiveSheet( "9_2" );
   end;

   BankName = party.Name + "  " + INN + KPP;

   m_Report.PrintFormatString( ReportHeader,
                               "N_BankName:l", BankName,
                               "N_RegNum:l", "Аналитический регистр налогового учета №" + Num,
                               "N_RegName", Name,
                               "N_PeriodName", Data.PeriodName
                             );

   if( Data.Mode == ДОХОДЫ_ПО_РЕПО )
     m_Report.RegisterTable( "N_MainTable", GetHeadTable(Data),
                             "N_1",
                             "N_2",
                             "N_3",
                             "N_4",
                             "N_4a",
                             "N_4b",
                             "N_5",
                             "N_5a",
                             "N_5b",
                             "N_6",
                             "N_7",
                             "N_8",
                             "N_9",
                             "N_10",
                             "N_11",
                             "N_12",
                             "N_13",
                             "N_13a",
                             "N_13b",
                             "N_14",
                             "N_14a",
                             "N_22",
                             "N_23",
                             "N_24",
                             "N_25",
                             "N_26",
                             "N_27",
                             "N_28",
                             "N_29",
                             "N_30",
                             "N_31",
                             "N_32",
                             "N_33",
                             "N_34",
                             "N_35",
                             "N_38",
                             "N_39",
                             "N_40",
                             "N_41",
                             "N_42",
                             "N_43",
                             "N_44",
                             "N_45",
                             "N_46");      

   else
     m_Report.RegisterTable( "N_MainTable", GetHeadTable(Data),
                             "N_1",
                             "N_2",
                             "N_3",
                             "N_4",
                             "N_5",
                             "N_6",
                             "N_7",
                             "N_8",
                             "N_9",
                             "N_10",
                             "N_11",
                             "N_12",
                             "N_13",
                             "N_14",
                             "N_15",
                             "N_16",
                             "N_17",
                             "N_18",
                             "N_19",
                             "N_20",
                             "N_21",
                             "N_22",
                             "N_23",
                             "N_24",
                             "N_25",
                             "N_26",
                             "N_27",
                             "N_28",
                             "N_29",
                             "N_30",
                             "N_31",
                             "N_32",
                             "N_33",
                             "N_34",
                             "N_35",
                             "N_36",
                             "N_37",
                             "N_38",
                             "N_39",
                             "N_42",
                             "N_43",
                             "N_44",
                             "N_47",
                             "N_48",
                             "N_49",
                             "N_50");      
   end;
end;

macro DateInPeriod(Data, _Date)
   return Between( _Date, Data.BegDate, Data.EndDate );
end;

private macro ПолучитьДатуИсполненияЧасти( FD, ResDate )
   var PayDate, SetDate;

   if (FD.ExistAvance)
      if( ПлатежЗакрыт(FD.pm_avance.rec) )
         PayDate = FD.DateArray[DATE_DEALAVANCE];
      else
         PayDate = FD.DateArray[DATE_DEALAVANCE_PLAN];
      end;
   else
      if( ПлатежЗакрыт(FD.pm_money.rec) )
         PayDate = FD.DateArray[DATE_DEALPAY];
      else
         PayDate = FD.DateArray[DATE_DEALPAY_PLAN];
      end;
   end;

   if( ПлатежЗакрыт(FD.pm_avoir.rec) )
      SetDate = FD.DateArray[DATE_DEALSETAVOIRISS];
   else
      SetDate = FD.DateArray[DATE_DEALSETAVOIRISS_PLAN];
   end;

   ResDate = maxDate( PayDate, SetDate);

   SetParm( 1, ResDate );
end;

/* Возвращаем true, если на дату _Date часть по FD исполнена. */
macro ЧастьИсполнена( _Date, FD )
   var FactPayDate = Date(0,0,0), FactSetDate = Date(0,0,0), Disp_fact = Date(0,0,0);

   /*исполнением считается
        при отсутствии аванса по 1 (2) части максимальная из дат оплаты и поставки по 1 (2) части,
        при наличии аванса - максимальная из дат аванса и поставки по 1 (2) части
   */
   if (ПлатежЗакрыт(FD.pm_avoir.rec))
      FactSetDate = FD.DateArray[DATE_DEALSETAVOIRISS];
   end;

   if (FD.ExistAvance)
      if (ПлатежЗакрыт(FD.pm_avance.rec))
         FactPayDate = FD.DateArray[DATE_DEALAVANCE];
      end;
   else
      if (ПлатежЗакрыт(FD.pm_money.rec))
         FactPayDate = FD.DateArray[DATE_DEALPAY];
      end;
   end;

   Disp_fact = maxDate(FactPayDate, FactSetDate);

   if ((Disp_fact == Date(0,0,0)) or (Disp_fact > _Date))
      return false;
   else
      return true;
   end;
end;

private macro ЕстьПлановыеПогашенияВПериоде(FIID, fiid_from, Date1, Date2, _Sum, _Sum_Rur)

   var Query, DataSet;
   var Sum_K = 0.0, Sum = 0.0, Was = false, Sum_Rur = 0.0, Sum_K_Dbl = 0.0;

   Query =  RSDCommand(
            " SELECT t_DrawingDate " +
            "   FROM dfiwarnts_dbt " +
            "  WHERE t_FIID = ? " + 
               " and t_DrawingDate >= ? " +
               " and t_DrawingDate <= ? " );

   Query.addParam( "", RSDBP_IN, FIID );
   Query.addParam( "", RSDBP_IN, Date1 );
   Query.addParam( "", RSDBP_IN, Date2 );
   Query.execute();

   DataSet = TRsbDataSet(Query);

   while (DataSet.MoveNext())
      Was = true;
      Sum_K = MoneyToDouble(СуммаКупона(FIID, $1, ConvertSQLDate(DataSet.DrawingDate)));
      Sum = Sum + Sum_K;

      SmartConvertSumDbl( Sum_K_Dbl, Sum_K, ConvertSQLDate(DataSet.DrawingDate),
                       fiid_from, NATCUR, false );

      Sum_Rur = Sum_Rur + Sum_K_Dbl;
   end;

   SetParm(4, Sum );
   SetParm(5, Sum_Rur );
   return Was;
end;

/*разруливает, печатать ли нули, пробелы.*/
private macro Val(Variable, Need_Print_Zero)
  if (Need_Print_Zero == true)
     return Variable;
  else
     if (Variable == 0.0)
        return "";
     else
        return Variable;
     end;
  end;
end;

macro PrintReport(Data)
  
   record fininstr(fininstr);
   record avoiriss(avoiriss);
   file dl_tick(dl_tick);

   var IsApp = IIF(Data.Apostr, ":a", ""), Format;
   var Cost1_val= 0.0,    /*Стоимость первой части ВАЛЮТА*/
       Cost1_RUR= 0.0,    /*Стоимость первой части РУБ*/
       NKD1_val = 0.0,   /*НКД первой части ВАЛЮТА*/
       NKD1_RUR = 0.0;   /*НКД первой части РУБ*/

   var Cost2_val= 0.0,    /*Стоимость второй части ВАЛЮТА*/
       Cost2_RUR= 0.0,    /*Стоимость второй части РУБ*/   
       NKD2_val = 0.0,   /*НКД второй части ВАЛЮТА*/      
       NKD2_RUR = 0.0,   /*НКД второй части РУБ*/         
       REPO_Tax = 0;    /*Ставка РЕПО*/

   var ObjDeal = "";       /*Значение в поле "Объект сделки"*/

   var CurYear, 
       Inc_outl_val = 0.0,   /*Доходы по сделке ВАЛЮТА*/
       Inc_outl_RUR = 0.0,   /*Доходы по сделке РУБЛИ*/
       RateCB = 0,          /*Стаквка ЦБРФ*/
       VRate = 0,           /*Ставка для нормирования расходов*/
       Outl_For_Nalog = 0.0; /*Расходы по сделке для налогообложения*/

   var FD, FD_back, Point;
   var Dmin, Dpmin_Inc_outl, FactPayDate2 = Date(0,0,0), FactSetDate2 = Date(0,0,0), Disp2_fact = Date(0,0,0),
       DCoup_min = Date(0,0,0), DCoup_max = Date(0,0,0), DComp_min = Date(0,0,0), DComp_max = Date(0,0,0);

   var SfContrNum,          /*Номер договора */
       DealKind1,           /*Вид сделки по первой части*/
       DealKind2,           /*Вид сделки по второй части*/
       DateExec1,           /*Дата исполнения 1-ой части*/
       DatePay1Fact,        /*Дата факт. оплаты 1-ой части*/
       DateRealize,         /*Дата реализации 1-ой части*/
       DateRealize2,        /*Дата реализации 2-ой части*/
       DateExec2,           /*Дата исполнения 2-ой части*/
       DatePay2Fact,        /*Дата факт. оплаты 2-ой части*/
       Amount = 0,          /*Количество ц/б по сделке*/
       Course_5a = 0.0,      /*Курс в графу 5_a*/
       Course_5b = 0.0,      /*Курс в графу 5_b*/
       Course14 = 0.0,       /*курс в графу 14*/
       Course14a = 0.0,      /*курс в графу 14a*/
       All1_val = 0.0,       /*Всего 1-ая часть - ВАЛЮТА*/
       All1_RUR = 0.0,       /*Всего 1-ая часть - РУБ*/
       All2_val = 0.0,       /*Всего 2-ая часть - ВАЛЮТА*/
       All2_RUR = 0.0,       /*Всего 2-ая часть - РУБ*/
       SummPartDiff = 0.0,   /*Разница между полными суммами 1-ой и 2-ой части
                              в валюте цены сделки */
       Disp1,               /*Дата исполнения 1-ой части*/
       Disp2,               /*Дата исполнения 2-ой части*/
       REPOPeriod,          /*РЕПО период*/
       Ret_val = 0.0,             /*НКД, полученный при погашении купонов ВАЛ*/
       Ret_RUR = 0.0,             /*НКД, полученный при погашении купонов РУБ*/
       Partial_val = 0.0,         /*Доход по ЧП, полученный при ЧП ВАЛ*/
       Partial_RUR = 0.0,         /*Доход по ЧП, полученный при ЧП РУБ*/
       Comp_val = 0.0,            /*Сумма компенсационных платежей ВАЛ*/
       Comp_RUR = 0.0,            /*Сумма компенсационных платежей РУБ*/
       Course_differ = 0.0,       /*Курсовая разница*/
       NonRealizedCourse_differ = 0.0, /*Нереализованная курсовая разница*/
       Inc_Coup_val = 0.0, /*Купонный доход / вал*/
       Inc_Coup_RUR = 0.0, /*Купонный доход / руб*/
       PartyName = "",     /*Контрагент*/
       Was_Ureg = "",     /*отметка - была урегулирована*/
       ChangedIncomeRate = ""; /*Было ли изменение процентной ставки РЕПО*/

   var TempNKD2 = 0.0, TempSum2 = 0.0, TempNKD3 = 0.0, TempSum3 = 0.0;
   var ЕстьПлановыеПогашения = false;

   /*Итоговые переменные*/
   var Itog_Cost1_val=0.0, Itog_Cost1_RUR=0.0, Itog_NKD1_val = 0.0, Itog_NKD1_RUR = 0.0;
   var Itog_All1_val=0.0, Itog_All1_RUR=0.0, Itog_All2_val=0.0, Itog_All2_RUR=0.0;
   var Itog_Cost2_val=0.0, Itog_Cost2_RUR=0.0, Itog_NKD2_val = 0.0, Itog_NKD2_RUR = 0.0, 
       Itog_NKD_Ret_val = 0.0, Itog_NKD_Ret_RUR = 0.0, 
       Itog_Partial_val = 0.0, Itog_Partial_RUR = 0.0, 
       Itog_Comp_val = 0.0, Itog_Comp_RUR = 0.0, 
       Itog_val = 0.0, Itog_RUR = 0.0, 
       Itog_Outl_For_Nalog = 0.0,
       Itog_Course_differ = 0.0, Itog_NonRealizedCourse_differ = 0.0,
       Itog_Inc_Coup_val = 0.0, Itog_Inc_Coup_RUR = 0.0;

   var CurNum = 0, Ni, N_Sold, TempSum = 0.0, Note = "", Course_on_D13 = 0.0, N, NeedContinue;
   var Number_In_Arr = 0, i = 0;
   var DataSet, Query;

   /*Флажки - если true, то печатаем именно значение данной переменной, а не пробел в случае 0.*/
   var f_NKD1_val, f_NKD1_RUR, f_All1_val, f_NKD2_val, f_NKD2_RUR, f_All2_val,
       f_Ret_val, f_Ret_RUR, f_Partial_val, f_Partial_RUR, f_Comp_val, f_Comp_RUR, 
       f_Course_differ, 
       f_NonRealizedCourse_differ, f_Inc_Coup_val, f_Inc_Coup_RUR;

   var REPO_Rep_Query = " select * from dreporep_tmp where t_Dmin >= " + GetSQLDate(Date(0,0,0)) +
                        " order by t_Dmin "; /* по 0-му ключу */
   var REPO_Rep_DataSet = TRsbDataSet(REPO_Rep_Query);

   InitProgressBar(  NRecs,
                     IIF(Data.Mode == ДОХОДЫ_ПО_РЕПО, StatProfit, StatCharge),
                     "Печать отчета" );

   /*Перебираем данные во временном файле*/
   while(REPO_Rep_DataSet.MoveNext())

      Dmin = Date(REPO_Rep_DataSet.Dmin);

      Rewind(dl_tick);
      ClearRecord(dl_tick);
      dl_tick.DealID = REPO_Rep_DataSet.DealID;
      if(GetEQ(dl_tick) == false)
         Msgbox("Не найдена сделка с ID = ", string(REPO_Rep_DataSet.DealID));
         exit(1);
      end;

      /*Получим первичный документ по операции*/
      FD = SPFirstDoc(dl_tick);
      FD_back = SPFirstDoc(dl_tick, true);

      if( ПолучитьФинИн( FD.fininstr.rec.FIID, fininstr, avoiriss )) 
         MsgBox ("Отсутствует финансовый инструмент (FIID=", FD.fininstr.rec.FIID,")" );
      end;

      LinksData1.ClearArray();
      LinksData2.ClearArray();

      /*Объект сделки - имя ц/б*/
      ObjDeal = fininstr.Name;

      /*Номер договора - внешний код сделки*/
      SfContrNum = dl_tick.DealCodeTS;

      /*Вид сделки по первой части*/
      if(IsBuy(FD.Group))
         DealKind1 = "покупка";
      else
         DealKind1 = "продажа";
      end;

      /*Дата исполнения первой части - здесь фактическая дата поставки*/
      DateExec1 = FD.DateArray[DATE_DEALSETAVOIRISS];

      /*Дата факт. оплаты 1-ой части*/
      if (ПлатежЗакрыт(FD.pm_money.rec))
         DatePay1Fact = FD.DateArray[DATE_DEALPAY];
      else
         DatePay1Fact = Date(0,0,0);
      end;

      /*Курс*/
      /*Заполняется только для ц/б, валюта номинала и цена которых не совпадает с 
        рублями: выводится курс валюты цены сделки на дату оплаты 1 части */
      if ( (fininstr.FaceValueFI != NATCUR) OR (FD.dl_leg.rec.CFI != NATCUR) )

         SmartConvertSumDbl( Course_5a, 1.0, DatePay1Fact,
                          FD.dl_leg.rec.CFI, NATCUR, false );
      else
         Course_5a = 0.0;
      end;

      /*Количество ц/б по сделке*/
      Amount =  MoneyToInt(FD.dl_leg.rec.Principal);

      /*Дата исполнения 2-ой части*/
      /*Если статус лота 2 части на дату окончания отчетного периода = "поставлен", 
        то <A13> = фактической дате поставки ц/б по 2 части, иначе (лот не поставлен) 
        <A13>= плановой дате поставки по 2 части*/
      if(ПлатежЗакрыт(FD_back.pm_avoir.rec))
         DateExec2 = FD_back.pm_avoir.rec.ValueDate;
      else
         DateExec2 = FD_back.DateArray[DATE_DEALSETAVOIRISS_PLAN];
      end;

      /*Дата факт. оплаты 2-ой части*/
      if (ПлатежЗакрыт(FD_back.pm_money.rec))
         DatePay2Fact = FD_back.DateArray[DATE_DEALPAY];
      else
         DatePay2Fact = Date(0,0,0);
      end;

      /*A14 - Курс*/
      /*Если ВН = ВЦ = руб., то поле не заполняется, иначе выводится курс
        валюты цены (с точностью до 4-х знаков) на (минимальную из дат -
        фактическую дату оплаты по 2 части или дату окончания отчетного
        периода) */
      if( (FD.dl_leg.rec.CFI == NATCUR) and (fininstr.FaceValueFI == NATCUR) )
         Course14 = 0.0;
      else
         SmartConvertSumDbl( Course14, 1.0, 
                             IIF(DatePay2Fact == Date(0,0,0), Data.EndDate, MinDate(DatePay2Fact, Data.EndDate)),
                             FD.dl_leg.rec.CFI, NATCUR, false );
      end;

      N_Sold = 0;
      Cost1_val = 0.0;
      NKD1_val  = 0.0;
      All1_val = 0.0;
      Course_differ = 0.0;
      NonRealizedCourse_differ = 0.0;
      Number_In_Arr = 0;
      f_NKD1_val = false;
      f_NKD1_RUR = false;
      f_All1_val = false;
      f_Course_differ = false;
      
      /*Деление лота на части для полей А4а, А5, А5б, А6, А8*/
      if (IsBuy(FD.Group) AND (fininstr.FaceValueFI != NATCUR) AND (FD.dl_leg.rec.CFI != NATCUR) ) 

         Query = RSDCommand("Select lnk.t_Amount as Amount, sale.t_Date as SaleDate " + 
                 "  From dpmwrtsum_dbt sale, dpmwrtlnk_dbt lnk, dpmpaym_dbt paym " +
                 " Where lnk.t_BuyID = ? " +
                   " and sale.t_SumID = lnk.t_SaleID " + 
                   " and sale.t_DocKind = " + string(DLDOC_PAYMENT) +
                   " and sale.t_Date    < ? "  +
                   " and paym.t_PaymentID = sale.t_DocID " + 
                   " and (paym.t_PaymStatus >= " + string(PM_READY_TO_SEND) + 
                   "   or paym.t_PaymStatus  = " + string(PM_CLOSED_W_M_MOVEMENT) + ")");

         Query.addParam( "", RSDBP_IN, FD.pmwrtsum.rec.SumID );
         Query.addParam( "", RSDBP_IN, Data.EndDate );
         Query.execute();

         DataSet = TRsbDataSet(Query);
         while (DataSet.MoveNext())
            Number_In_Arr = Number_In_Arr + 1;
            DateRealize = Date(DataSet.SaleDate);

            SmartConvertSumDbl( Course_5b, 1.0, DateRealize,
                             FD.dl_leg.rec.CFI, NATCUR, false );

            Ni = MoneyToInt(DataSet.Amount);
            N_Sold = N_Sold + Ni;

            Cost1_val = MoneyToDouble(FD.dl_leg.rec.Cost * Ni / FD.dl_leg.rec.Principal);
            NKD1_val  = MoneyToDouble(FD.dl_leg.rec.NKD  * Ni / FD.dl_leg.rec.Principal);
            All1_val  = All1_val + NKD1_val + Cost1_val;

            /*Нереализованная курсовая разница - для обратного РЕПО*/
            NonRealizedCourse_differ = (Course_5b - Course_5a)*(Cost1_val + NKD1_val);

            LinksData1.Add(Number_In_Arr, DateRealize, Ni, Course_5b, Cost1_val, NKD1_val, NonRealizedCourse_differ);
         end;

         /*Если ц/б на лоте проданы частично или вообще не проданы.*/
         if (N_Sold < Amount) 
            Number_In_Arr = Number_In_Arr + 1;
            DateRealize = DateExec2;
            Cost1_val = MoneyToDouble(FD.dl_leg.rec.Cost * (Amount-N_Sold) / Amount);
            NKD1_val  = MoneyToDouble(FD.dl_leg.rec.NKD  * (Amount-N_Sold) / Amount);
            All1_val  = All1_val + NKD1_val + Cost1_val;

            NonRealizedCourse_differ = (Course14 - Course_5a)*(Cost1_val + NKD1_val);

            LinksData1.Add(Number_In_Arr, DateRealize, Amount-N_Sold, Course14, Cost1_val, NKD1_val, NonRealizedCourse_differ);
         end;

         Cost1_val = 0.0;
         NKD1_val  = 0.0;
         NonRealizedCourse_differ = 0.0;

      /*Ничего не выводим, заполняем нулями*/
      else
         if (FD.dl_leg.rec.CFI == NATCUR)
            Cost1_val = 0.0;
         else
            Cost1_val = MoneyToDouble(FD.dl_leg.rec.Cost);
         end;

         if( (FD.dl_leg.rec.CFI != NATCUR) AND (fininstr.FaceValueFI == NATCUR) )

            if (Course_5a != 0.0)
               NKD1_val = Round(FD.dl_leg.rec.NKD / Course_5a, 2);
            else
               NKD1_val = 0.0;
            end;
/*
            SmartConvertSumDbl(  NKD1_val, MoneyToDouble(FD.dl_leg.rec.NKD), DateExec1,
                              fininstr.FaceValueFI, FD.dl_leg.rec.CFI, false);
*/
         else
            if ( (fininstr.FaceValueFI != NATCUR) AND (IsSale(FD.Group)) ) 
               NKD1_val = MoneyToDouble(FD.dl_leg.rec.NKD);
            end;
         end;

         All1_val = All1_val + NKD1_val + Cost1_val;

         LinksData1.Add(1, Date(0, 0, 0), Amount, 0.0, Cost1_val, NKD1_val, 0.0);
      end;

      /*ставим true, если соотв. поле заполняется.*/
      /*Если ВЦ = руб. и ВН = руб, то поле не заполняется.*/
      if (not ((FD.dl_leg.rec.CFI == NATCUR) and (fininstr.FaceValueFI == NATCUR)))
         f_NKD1_val = true;
      end;

      if ((fininstr.FaceValueFI == NATCUR) or ((FD.dl_leg.rec.CFI == NATCUR) and (fininstr.FaceValueFI != NATCUR)))
         f_NKD1_RUR = true;
      end;

      if (FD.dl_leg.rec.CFI != NATCUR)
         f_All1_val = true;
         f_Course_differ = true;
      end;


      /*A7, A9*/
      /*НКД (рубли) по первой части*/
      /*Выводится НКД в руб. на дату поставки по 1 части сделки в руб., 
        (если валюта номинала - не рубли, то НКД переводится в руб. по курсу 
        на фактическую дату поставки 1 части)*/
      Cost1_RUR = 0.0;
      NKD1_RUR = 0.0;

      if (fininstr.FaceValueFI == NATCUR)
         NKD1_RUR = FD.dl_leg.rec.NKD; /*на дату поставки - значит просто из сделки.*/

         if (FD.dl_leg.rec.CFI == NATCUR)
            Cost1_RUR = FD.dl_leg.rec.Cost;
         else
            Cost1_RUR = MoneyToDouble(FD.dl_leg.rec.Cost * Course_5a);
         end;
      else
         if (FD.dl_leg.rec.CFI == NATCUR)
            NKD1_RUR = MoneyToDouble(NKD1_val*Course_5a);
            Cost1_RUR = MoneyToDouble(FD.dl_leg.rec.Cost * Course_5a);
         end;
      end;

      /*Всего по первой части*/
      if (FD.dl_leg.rec.CFI == NATCUR)
         All1_RUR = Cost1_RUR + NKD1_RUR;
      else
         All1_RUR = All1_val*Course_5a;
      end;


      /****************************** ВТОРАЯ ЧАСТЬ ************************/

      /*Вид сделки по второй части*/
      if(IsBuy(FD.Group))
         DealKind2 = "продажа";
      else
         DealKind2 = "покупка";
      end;

      N_Sold = 0;
      Cost2_val = 0.0;
      NKD2_val  = 0.0;
      All2_val  = 0.0;
      NonRealizedCourse_differ = 0.0;
      Number_In_Arr = 0;
      f_NKD2_val = false;
      f_NKD2_RUR = false;
      f_All2_val = false;
      f_NonRealizedCourse_differ = false;

      FactPayDate2 = Date(0,0,0);
      FactSetDate2 = Date(0,0,0);
      Disp2_fact = Date(0,0,0);

      /*DРmin - меньшая из дат - дата Dисп2.факт. или дата окончания отч. периода*/
      /*Dисп2.факт- максимальная из даты оплаты и  даты поставки по соответствующей части*/
      if (ПлатежЗакрыт(FD_back.pm_avoir.rec))
         FactSetDate2 = FD_back.DateArray[DATE_DEALSETAVOIRISS];
      end;

      if (FD_back.ExistAvance)
         if (ПлатежЗакрыт(FD_back.pm_avance.rec))
            FactPayDate2 = FD_back.DateArray[DATE_DEALAVANCE];
         end;
      else
         if (ПлатежЗакрыт(FD_back.pm_money.rec))
            FactPayDate2 = FD_back.DateArray[DATE_DEALPAY];
         end;
      end;

      Disp2_fact = maxDate(FactPayDate2, FactSetDate2);

      /*Деление лота на части для полей А4а, А5, А5б, А6, А8*/
      if ( IsSale(FD.Group) AND (fininstr.FaceValueFI != NATCUR) AND (FD_Back.dl_leg.rec.CFI != NATCUR) )
         i = 0;
         while (FD_back.pmwrtsum(i) != null)
            Query = RSDCommand("Select lnk.t_Amount as Amount, sale.t_Date as SaleDate " + 
                    "  From dpmwrtsum_dbt sale, dpmwrtlnk_dbt lnk, dpmpaym_dbt paym " +
                    " Where lnk.t_BuyID = ? " +
                      " and sale.t_SumID = lnk.t_SaleID " + 
                      " and sale.t_DocKind = " + string(DLDOC_PAYMENT) +
                      " and sale.t_Date    < ? " +
                      " and paym.t_PaymentID = sale.t_DocID " + 
                      " and (paym.t_PaymStatus >= " + string(PM_READY_TO_SEND) + 
                      "   or paym.t_PaymStatus  = " + string(PM_CLOSED_W_M_MOVEMENT) + ")");

            Query.addParam( "", RSDBP_IN, FD_back.pmwrtsum(i).rec.SumID );
            Query.addParam( "", RSDBP_IN, Data.EndDate );
            Query.execute();

            DataSet = TRsbDataSet(Query);
            while (DataSet.MoveNext())

               Number_In_Arr = Number_In_Arr + 1;
               DateRealize2 = Date(DataSet.SaleDate);

               SmartConvertSumDbl( Course14a, 1.0, DateRealize2,
                                FD_back.dl_leg.rec.CFI, NATCUR, false );

               Ni = MoneyToInt(DataSet.Amount);
               N_Sold = N_Sold + Ni;

               Cost2_val = MoneyToDouble(FD_back.dl_leg.rec.Cost * Ni / FD_back.dl_leg.rec.Principal);
               NKD2_val  = MoneyToDouble(FD_back.dl_leg.rec.NKD  * Ni / FD_back.dl_leg.rec.Principal);
               All2_val  = All2_val + NKD2_val + Cost2_val;

               LinksData2.Add(Number_In_Arr, DateRealize2, Ni, Course14a, Cost2_val, NKD2_val, 0.0);

               /*Нереализованная курсовая разница - для прямого РЕПО - сумма*/
               NonRealizedCourse_differ = NonRealizedCourse_differ + (Course14 - Course14a) * NKD2_val;
            end;

            i = i + 1;
         end;

         /*Идентично условию 1 из ТЗ*/
         if (IsSale(FD.Group) and FI_IsBond( FD.fininstr ))
            f_NonRealizedCourse_differ = true;
            if (((fininstr.FaceValueFI == NATCUR) AND (FD.dl_leg.rec.CFI == NATCUR)) OR (N_Sold == 0))
               f_NonRealizedCourse_differ = false;
            end;
         end;

         /*Если ц/б на лоте проданы частично или вообще не проданы.*/
         if (N_Sold < Amount) 
            Number_In_Arr = Number_In_Arr + 1;
            DateRealize2 = DateExec2;
            Cost2_val = MoneyToDouble(FD_back.dl_leg.rec.Cost * (Amount-N_Sold) / Amount);
            NKD2_val  = MoneyToDouble(FD_back.dl_leg.rec.NKD  * (Amount-N_Sold) / Amount);
            All2_val  = All2_val + NKD2_val + Cost2_val;

            SmartConvertSumDbl( Course_on_D13, 1.0, DateRealize2,
                             FD_back.dl_leg.rec.CFI, NATCUR, false );

            LinksData2.Add(Number_In_Arr, DateRealize2, Amount-N_Sold, Course_on_D13, Cost2_val, NKD2_val, 0.0);

            NonRealizedCourse_differ = NonRealizedCourse_differ + (Course14 - Course_on_D13) * NKD2_val;

         end;

         Cost2_val = 0.0;
         NKD2_val  = 0.0;

      /*Ничего не выводим, заполняем нулями*/
      else
         if (FD_back.dl_leg.rec.CFI == NATCUR)
            Cost2_val = 0.0;
         else
            if ((Disp2_fact <= Data.EndDate) and (Disp2_fact != Date(0,0,0)))
               Cost2_val = MoneyToDouble(FD_back.dl_leg.rec.Cost);
            end;
         end;

         if( (FD_back.dl_leg.rec.CFI != NATCUR) AND (fininstr.FaceValueFI == NATCUR) )

            SmartConvertSumDbl(  NKD2_val, MoneyToDouble(FD_back.dl_leg.rec.NKD), Dmin,
                              fininstr.FaceValueFI, FD_back.dl_leg.rec.CFI, false);
         else
            if ( (fininstr.FaceValueFI != NATCUR) AND (IsBuy(FD.Group)) ) 
               NKD2_val = MoneyToDouble(FD_back.dl_leg.rec.NKD);
            end;
         end;

         All2_val = All2_val + NKD2_val + Cost2_val;

         LinksData2.Add(1, Date(0, 0, 0), Amount, 0.0, Cost2_val, NKD2_val, 0.0);

      end;

      /*ставим true, если соотв. поле заполняется.*/
      /*Если ВЦ = руб. и ВН = руб, то поле не заполняется.*/
      if (not ((FD_back.dl_leg.rec.CFI == NATCUR) and (fininstr.FaceValueFI == NATCUR)))
         f_NKD2_val = true;
      end;

      if ((fininstr.FaceValueFI == NATCUR) or ((FD_back.dl_leg.rec.CFI == NATCUR) and (fininstr.FaceValueFI != NATCUR)))
         f_NKD2_RUR = true;
      end;

      if (FD_back.dl_leg.rec.CFI != NATCUR)
         f_All2_val = true;
      end;

      /*Если в ТЗ сказано, что не нужно заполнять, но он каким-то боком заполнился, то все равно обнуляем*/
      if (f_NonRealizedCourse_differ == false)
         NonRealizedCourse_differ = 0.0;
      end;

      NKD2_RUR = 0.0;
      Cost2_RUR = 0.0;
      if (fininstr.FaceValueFI == NATCUR)
         NKD2_RUR = НКД(FD.fininstr.rec.FIID, ToMoney(Amount), Dmin);
      else
         if (FD_back.dl_leg.rec.CFI == NATCUR)
            NKD2_RUR = MoneyToDouble(NKD2_val*Course14);
         end;
      end;

      DCoup_min = maxDate(DateExec1 + 1, Data.BegDate);
      DCoup_max = minDate(IIF( ПлатежЗакрыт(FD_back.pm_avoir.rec), 
                               FD_back.DateArray[DATE_DEALSETAVOIRISS], 
                               FD_back.DateArray[DATE_DEALSETAVOIRISS_PLAN]
                             ), Data.EndDate);

      /* A21, A22 - Погашение */
      Ret_RUR  = 0.0;
      Ret_val  = 0.0;
      f_Ret_val = false;
      f_Ret_RUR = false;

      if ((fininstr.FaceValueFI != NATCUR) OR (FD.dl_leg.rec.CFI != NATCUR))
         Ret_val = SP_GetCouponSumByPeriod( fininstr.FIID, FD.dl_leg.rec.Principal, DCoup_min, DCoup_max, "", FD.dl_leg.rec.CFI );
         f_Ret_val = true;
      end;

      Ret_RUR = GetCouponSumByPeriod_Rub( fininstr.FIID, FD.dl_leg.rec.Principal, DCoup_min, DCoup_max );
      f_Ret_RUR = true;

      /* A21а, A22а - ЧП */
      Partial_RUR  = 0.0;
      Partial_val  = 0.0;
      f_Partial_val = false;
      f_Partial_RUR = false;

      if ((fininstr.FaceValueFI != NATCUR) OR (FD.dl_leg.rec.CFI != NATCUR))
         Partial_val = SP_GetCouponSumByPeriod( fininstr.FIID, FD.dl_leg.rec.Principal, DCoup_min, DCoup_max, "X", FD.dl_leg.rec.CFI );
         f_Partial_val = true;
      end;

      Partial_RUR = GetPartialSumByPeriod_Rub( fininstr.FIID, FD.dl_leg.rec.Principal, DCoup_min, DCoup_max );
      f_Partial_RUR = true;

      DComp_min = maxDate(IIF( FD.ExistAvance, 
                               FD.DateArray[DATE_DEALAVANCE], 
                               FD.DateArray[DATE_DEALPAY]
                             ), Data.BegDate);
      DComp_max = minDate(IIF( ПлатежЗакрыт(FD_back.pm_money.rec), 
                               FD_back.DateArray[DATE_DEALPAY], 
                               FD_back.DateArray[DATE_DEALPAY_PLAN]
                             ), Data.EndDate);

      /* A21б, A22б - компенсацион. платежи */
      Comp_RUR  = 0.0;
      Comp_val  = 0.0;
      f_Comp_val = false;
      f_Comp_RUR = false;

      if (FD.dl_leg.rec.CFI != NATCUR)
         Comp_val = SP_GetPaymsSumByPeriod( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, PM_PURP_COMPENS, DComp_min, DComp_max );
         f_Comp_val = true;
      end;

      Comp_RUR = SP_GetPaymsSumByPeriod( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, PM_PURP_COMPENS, DComp_min, DComp_max, NATCUR );
      f_Comp_RUR = true;

      /* A16 - Ставка РЕПО*/
      /* Если дата исполнения по первой и второй части совпадают, то
         принимаем срок РЕПО равным одному дню. См. запрос #50668 */
      CurYear = Data.Year; /*Получим отчетный год*/
      ПолучитьДатуИсполненияЧасти( FD, Disp1 );
      ПолучитьДатуИсполненияЧасти( FD_back, Disp2 );

      REPOPeriod = Disp2 - Disp1;
      if( REPOPeriod == 0 )
         REPOPeriod = 1;  
      end;

      /*
        Получим базис расчета
        Basis = 0 : SP_KINDBASISCALC_365
        Basis = 1 : SP_KINDBASISCALC_360
        Basis = 2 : по календарю
      */
     
      if (FD.dl_leg.rec.Basis == 0)
         N = 365;
      elif (FD.dl_leg.rec.Basis == 1)
         N = 360;
      else
         N = GetDaysInYear(CurYear);
      end;
    

      if (Disp2_fact == Date(0,0,0))
         Dpmin_Inc_outl = Data.EndDate;
      else
         Dpmin_Inc_outl = minDate(Disp2_fact, Data.EndDate);
      end;

      TempSum = SP_GetPaymsSumByPeriod( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, PM_PURP_COMPENS, 
                                        Dpmin_Inc_outl, DateExec1, FD.dl_leg.rec.CFI, "", true ) +
                IIF(FD.tick.rec.ReturnIncomeKind != SP_RETURNINCOME_WRTOFF, 0, 
                    SP_GetCouponSumByPeriod( fininstr.FIID, FD.dl_leg.rec.Principal, 
                                        Dpmin_Inc_outl, DateExec1, "", FD.dl_leg.rec.CFI, "", null, true ) +
                    SP_GetCouponSumByPeriod( fininstr.FIID, FD.dl_leg.rec.Principal, 
                                        Dpmin_Inc_outl, DateExec1, "X", FD.dl_leg.rec.CFI, "", null, true )
                   );

      Inc_outl_val = 0.0;
      Inc_outl_RUR = 0.0;
      /* A23, A24 - Всего */
      /* A29 - Доходы/расходы по сделке ВАЛ*/
      /* A30 - Доходы/расходы по сделке РУБ*/
      /*All2_val = A17 + A19 (суммарно)*/
      if( FD.dl_leg.rec.CFI != NATCUR )
         if ((Disp2_fact <= Data.EndDate) and (Disp2_fact != Date(0,0,0)))
            if (FD.tick.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF)
               All2_val = All2_val + Ret_val + Partial_val + Comp_val;
            else
               All2_val = All2_val + Comp_val;
            end;

            Inc_outl_val = All2_val - All1_val;
         else

            REPO_Tax = FD_back.dl_leg.rec.IncomeRate;
            Inc_outl_val = All1_val * abs(REPO_Tax) / N
                              / 100 * (Dpmin_Inc_outl - DateExec1)
                            - abs(REPO_Tax) / N / 100 * TempSum;

            All2_val = All1_val + Inc_outl_val;

            Cost2_val = All2_val - NKD2_val - Comp_val -
                        IIF(FD.tick.rec.ReturnIncomeKind != SP_RETURNINCOME_WRTOFF, 0, Ret_val + Partial_val);
         end;

         Inc_outl_RUR = Inc_outl_val * Course14;
         All2_RUR = All2_val*Course14;
         Cost2_RUR = Cost2_val*Course14;

      else
         All2_val = 0.0;

         if ((Disp2_fact > Data.EndDate) or (Disp2_fact == Date(0,0,0)))

            REPO_Tax = FD_back.dl_leg.rec.IncomeRate;
            Inc_outl_RUR = All1_RUR * abs(REPO_Tax) / N
                                   / 100 * (Dpmin_Inc_outl - DateExec1)
                                 - abs(REPO_Tax) / N / 100 * TempSum;

            All2_RUR = All1_RUR + Inc_outl_RUR;

            if (FD.tick.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF)
               Cost2_RUR = All2_RUR - NKD2_RUR - Ret_RUR - Partial_RUR - Comp_RUR;
            else
               Cost2_RUR = All2_RUR - NKD2_RUR - Comp_RUR;
            end;
         else
            Cost2_RUR = MoneyToDouble(FD_back.dl_leg.rec.Cost);

            if (FD.tick.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF)
               All2_RUR = Cost2_RUR + NKD2_RUR + Ret_RUR + Partial_RUR + Comp_RUR;
            else
               All2_RUR = Cost2_RUR + NKD2_RUR + Comp_RUR;
            end;

            Inc_outl_RUR = ABS(All2_RUR - All1_RUR);
         end;
      end;

      if ((FD.tick.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF) or 
          (Disp2_fact > Data.EndDate) or 
          (Disp2_fact == Date(0,0,0))
         )
         REPO_Tax = FD_back.dl_leg.rec.IncomeRate;
      else
         if(FD.dl_leg.rec.CFI != NATCUR)
            REPO_Tax =  (All2_val - All1_val)*N*100
                        / (All1_val * REPOPeriod);
         else
            REPO_Tax =  (All2_RUR - All1_RUR)*N*100
                        / (All1_RUR * REPOPeriod);
         end;
      end;


      /* Считаем разницу между полными суммами по 2-ой и 1-ой части в
         валюте цены сделки. Запрос 49032. */
      if( FD.dl_leg.rec.CFI != NATCUR )
         SummPartDiff = All2_val - All1_val;
      else
         SummPartDiff = All2_RUR - All1_RUR;
      end;

      NeedContinue = false;
      if(Data.Mode == ДОХОДЫ_ПО_РЕПО)
         if( ((IsBUY(FD.Group)==true) AND (SummPartDiff >= 0))
             OR ((IsSALE(FD.Group)==true) AND (SummPartDiff < 0))
           )
            NeedContinue = true;
         end;
      else
         /* Режим: расходы по РЕПО */
         if( ((IsBUY(FD.Group)==true) AND (SummPartDiff < 0))
             OR ((IsSALE(FD.Group)==true) AND (SummPartDiff >= 0))
           )
            NeedContinue = true;
         end;
      end;

      /*Для оптимизации - если для данного отчета по сумме эта сделка не подходит - то не рассчитываем другие поля.*/
      if (NeedContinue == true)

         ЕстьПлановыеПогашения = ЕстьПлановыеПогашенияВПериоде(FD.fininstr.rec.FIID, FD.fininstr.rec.FaceValueFI, 
                                                               FD.pmwrtsum.rec.Date, FD_back.pm_avoir.rec.ValueDate, TempNKD2, TempNKD3); 
         /*Курсовая разница*/
         if(FD.dl_leg.rec.CFI != NATCUR)
            if( IsSale(FD.Group) )
               /* РЕПО продажа */
               Course_differ = (Course_5a - Course14)*All1_val;
            else
               /* РЕПО покупка */
               Course_differ = (Course14 - Course_5a)*All1_val;
            end;
         end;

         /*Учетная ставка ЦБ*/
         if(Data.Mode == РАСХОДЫ_ПО_РЕПО)
            /*Ставка ц/б*/
            if(FD.dl_leg.rec.CFI != NATCUR)
               if( GetRateFromValHist(FD.tick.rec.DealDate,2,@RateCB) != true )
                  Msgbox("Не найдена ставка для нормирования расходов по сделкам в ин. валюте  на ", FD.tick.rec.DealDate);
               end;
            else
               if (not СтавкаРефинансированияЦБ (NATCUR, FD.tick.rec.DealDate, RateCB))
                  Msgbox("Не найдена ставка рефинансирования ЦБ РФ на ", FD.tick.rec.DealDate);
               else
                  if( GetRateFromValHist(FD.tick.rec.DealDate,1,@VRate) != true )
                     Msgbox("Не найден коэффициент для нормирования расходов по сделкам в нац. валюте  на ", FD.tick.rec.DealDate);
                     RateCB = 0.0;
                  else
                     RateCB = VRate * RateCB;
                  end;
               end;
            end;
         end;

         /*Расходы по сделке, принимаемые для налогообложения*/
         if(abs(REPO_Tax) < abs(RateCB))
            Outl_For_Nalog = Inc_outl_RUR;
         else
            if(FD.dl_leg.rec.CFI == NATCUR)
               Outl_For_Nalog = All1_RUR * abs(REPO_Tax) / N / 100 * (Dpmin_Inc_outl - DateExec1) - TempSum * abs(REPO_Tax) / N / 100;
            else
               Outl_For_Nalog = All1_val*Course14 * abs(REPO_Tax) / N / 100 * (Dpmin_Inc_outl - DateExec1) - Course14 * TempSum * abs(REPO_Tax) / N / 100;
            end;
         end;

         /*Купонный доход */
         Inc_Coup_val = 0.0;
         Inc_Coup_RUR = 0.0;
         f_Inc_Coup_val = false;
         f_Inc_Coup_RUR = false;

         Inc_Coup_val = MoneyToDouble ( НКД(FD.fininstr.rec.FIID, ToMoney(Amount), Dmin) + 
                                  TempNKD2 * Amount - 
                                  НКД(FD.fininstr.rec.FIID, ToMoney(Amount), DateExec1)
                              );
         f_Inc_Coup_val = true;

         TempSum2 = 0.0;
         f_Inc_Coup_RUR = true;
         if ((Disp2_fact < Data.EndDate) and
             (Disp2_fact != Date(0,0,0)) and
             (ЕстьПлановыеПогашения == false)
            )
            SmartConvertSumDbl( TempSum2, 1.0, Data.EndDate,
                             fininstr.FaceValueFI, NATCUR, false );

            Inc_Coup_RUR  = Inc_Coup_val * TempSum2;
         else
            SmartConvertSumDbl( TempSum2, MoneyToDouble(НКД(FD.fininstr.rec.FIID, ToMoney(Amount), Dmin)), Dmin,
                             fininstr.FaceValueFI, NATCUR, false );

            SmartConvertSumDbl( TempSum3, 1.0, DateExec1,
                             fininstr.FaceValueFI, NATCUR, false );

            Inc_Coup_RUR = MoneyToDouble ( TempSum2 + TempNKD3 * Amount - 
                                     НКД(FD.fininstr.rec.FIID, ToMoney(Amount), DateExec1) * TempSum3
                                 );
         end;

         PartyName = ПолучитьКороткоеИмяСубъекта( dl_tick.PartyID );

         Note = readNoteForObject( OBJTYPE_SECDEAL, UniID( dl_tick, OBJTYPE_SECDEAL), 
                                   NOTEKIND_SECDEAL_REG_DEAL, FD.tick.rec.DealDate );
         if (Note != "")
            Was_Ureg = "V";
         else
            Was_Ureg = "";
         end;

         Query = RSDCommand("select count(1) ChangeCount "
               + "  from dsptkchng_dbt "
               + " where t_DealID = ? "
               + "   and t_OldIncomeRate != ? ");

         Query.addParam( "", RSDBP_IN, dl_tick.DealID );
         Query.addParam( "", RSDBP_IN, ЧислоCЗаданнойТочностью(FD_back.dl_leg.rec.IncomeRate,FD_back.dl_leg.rec.point) );
         Query.execute();

         DataSet = TRsbDataSet(Query);
         if (DataSet.MoveNext() and (DataSet.ChangeCount > 0))
            ChangedIncomeRate = "да";
         else
            ChangedIncomeRate = "нет";
         end;

         Point = FD.dl_leg.rec.Point;

         if(Data.Mode == ДОХОДЫ_ПО_РЕПО)

            if( ((IsBUY(FD.Group)==true) AND (SummPartDiff >= 0))
                OR ((IsSALE(FD.Group)==true) AND (SummPartDiff < 0))
              )

               /*может быть разделение ячеек по 1 части, иначе - по 2-й.*/
               if (IsBuy(FD.Group))

                  i = 1;
                  while (i < LinksData1.Size)
                     if (i != 1)
                        ObjDeal = "";
                        SfContrNum = "";
                        DealKind1 = "";
                        DateExec1 = Date(0, 0, 0);
                        DatePay1Fact = Date(0, 0, 0);
                        Course_5a = 0.0;
                        Cost1_RUR = 0.0;
                        NKD1_RUR = 0.0;
                        f_NKD1_RUR = false;
                        All1_val = 0.0;
                        f_All1_val = false;
                        All1_RUR = 0.0;
                        DealKind2 = "";
                        DateExec2 = Date(0, 0, 0);
                        DatePay2Fact = Date(0, 0, 0);
                        Course14 = 0.0;
                        Amount = 0.0;
                        REPO_Tax = 0.0;
                        Cost2_val = 0.0;
                        Cost2_RUR = 0.0;
                        NKD2_val = 0.0;
                        f_NKD2_val = false;
                        NKD2_RUR = 0.0;
                        f_NKD2_RUR = false;
                        Ret_val = 0.0;
                        f_Ret_val = false;
                        Ret_RUR = 0.0;
                        f_Ret_RUR = false;
                        Partial_val = 0.0;
                        f_Partial_val = false;
                        Partial_RUR = 0.0;
                        f_Partial_RUR = false;
                        Comp_val = 0.0;
                        f_Comp_val = false;
                        Comp_RUR = 0.0;
                        f_Comp_RUR = false;
                        All2_val = 0.0;
                        f_All2_val = false;
                        All2_RUR = 0.0;
                        Inc_outl_val = 0.0;
                        Inc_outl_RUR = 0.0;
                        Course_differ = 0.0;
                        f_Course_differ = false;
                        Inc_Coup_val = 0.0;
                        f_Inc_Coup_val = false;
                        Inc_Coup_RUR = 0.0;
                        f_Inc_Coup_RUR = false;
                        PartyName = "";
                        Was_Ureg = "";
                        ChangedIncomeRate = "";
                     end;

                     m_Report.PrintTableLine( "N_1",          ObjDeal,                     null,
                                              "N_2",          SfContrNum,                  null,
                                              "N_3",          DealKind1,                   null,
                                              "N_4",          DateExec1,                   null,
                                              "N_4a",         DatePay1Fact,                null,
                                              "N_4b",         LinksData1[i].DateRealize,   null,
                                              "N_5",          LinksData1[i].Amount,        null,
                                              "N_5a",         Val(Course_5a),              null,
                                              "N_5b",         Val(LinksData1[i].Course),   null,
                                              "N_6",          Val(LinksData1[i].Cost_val), null,
                                              "N_7",          Val(Cost1_RUR),              null,
                                              "N_8",          Val(LinksData1[i].NKD_val, f_NKD1_val), null,
                                              "N_9",          Val(NKD1_RUR, f_NKD1_RUR),   null,
                                              "N_10",         Val(All1_val, f_All1_val),   null,
                                              "N_11",         Val(All1_RUR),               null,
                                              /**************************** 2 часть *******************************/
                                              "N_12",         DealKind2,                   null,
                                              "N_13",         DateExec2,                   null,
                                              "N_13a",        DatePay2Fact,                null,
                                              "N_13b",        "",                          null,
                                              "N_14",         Val(Course14),               null,
                                              "N_14a",        "",                          null,
                                              "N_22",         Val(Amount),                 null,
                                              "N_23",         Val(REPO_Tax),               Point,
                                              "N_24",         Val(Cost2_val),              null,
                                              "N_25",         Val(Cost2_RUR),              null,
                                              "N_26",         Val(NKD2_val, f_NKD2_val),   null,
                                              "N_27",         Val(NKD2_RUR, f_NKD2_RUR),   null,
                                              "N_28",         Val(Ret_val, f_Ret_val),     null,
                                              "N_29",         Val(Ret_RUR, f_Ret_RUR),     null,
                                              "N_30",         Val(Partial_val, f_Partial_val), null,
                                              "N_31",         Val(Partial_RUR, f_Partial_RUR), null,
                                              "N_32",         Val(Comp_val, f_Comp_val),   null,
                                              "N_33",         Val(Comp_RUR, f_Comp_RUR),   null,
                                              "N_34",         Val(All2_val, f_All2_val),   null,
                                              "N_35",         Val(All2_RUR),               null,
                                              "N_38",         Val(Inc_outl_val),           null,
                                              "N_39",         Val(Inc_outl_RUR),           null,
                                              "N_40",         Val(Course_differ, f_Course_differ), null,
                                              "N_41",         LinksData1[i].differ,        null,
                                              "N_42",         Val(Inc_Coup_val, f_Inc_Coup_val), null,
                                              "N_43",         Val(Inc_Coup_RUR, f_Inc_Coup_RUR), null,
                                              "N_44",         PartyName,                   null,
                                              "N_45",         Was_Ureg,                    null,
                                              "N_46",         ChangedIncomeRate,           null);      

                         /*Данные для итоговой строки*/
           /*F6*/    Itog_Cost1_val = Itog_Cost1_val + LinksData1[i].Cost_val /*Cost1_val*/;
           /*F7*/    Itog_Cost1_RUR = Itog_Cost1_RUR + Cost1_RUR;
           /*F8*/    Itog_NKD1_val  = Itog_NKD1_val  + LinksData1[i].NKD_val /*NKD1_val*/;
           /*F9*/    Itog_NKD1_RUR  = Itog_NKD1_RUR  + NKD1_RUR;
           /*F10*/   Itog_All1_val  = Itog_All1_val  + All1_val;
           /*F11*/   Itog_All1_RUR  = Itog_All1_RUR  + All1_RUR;

           /*F17*/   Itog_Cost2_val = Itog_Cost2_val + Cost2_val;
           /*F18*/   Itog_Cost2_RUR = Itog_Cost2_RUR + Cost2_RUR;
           /*F19*/   Itog_NKD2_val  = Itog_NKD2_val + NKD2_val;
           /*F20*/   Itog_NKD2_RUR  = Itog_NKD2_RUR + NKD2_RUR;

           /*F21*/   Itog_NKD_Ret_val = Itog_NKD_Ret_val + Ret_val;
           /*F22*/   Itog_NKD_Ret_RUR = Itog_NKD_Ret_RUR + Ret_RUR;
                     Itog_Partial_val = Itog_Partial_val + Partial_val;
                     Itog_Partial_RUR = Itog_Partial_RUR + Partial_RUR;
                     Itog_Comp_val = Itog_Comp_val + Comp_val;
                     Itog_Comp_RUR = Itog_Comp_RUR + Comp_RUR;

           /*F23*/   Itog_All2_val = Itog_All2_val + All2_val;
           /*F24*/   Itog_All2_RUR = Itog_All2_RUR + All2_RUR;

           /*F29*/   Itog_val = Itog_val + Inc_outl_val;
           /*F30*/   Itog_RUR = Itog_RUR + Inc_outl_RUR;

           /*F31*/   Itog_Course_differ = Itog_Course_differ + Course_differ;
           /*F32*/   Itog_NonRealizedCourse_differ = Itog_NonRealizedCourse_differ + LinksData1[i].differ;
           /*F33*/   Itog_Inc_Coup_val = Itog_Inc_Coup_val + Inc_Coup_val; 
           /*F34*/   Itog_Inc_Coup_RUR = Itog_Inc_Coup_RUR + Inc_Coup_RUR;

                     i = i + 1;

                  end;

               else

                  i = 1;
                  while (i < LinksData2.Size)
                     if (i != 1)
                        ObjDeal = "";
                        SfContrNum = "";
                        DealKind1 = "";
                        DateExec1 = Date(0, 0, 0);
                        DatePay1Fact = Date(0, 0, 0);
                        Amount = 0.0;
                        Course_5a = 0.0;
                        Cost1_val = 0.0;
                        Cost1_RUR = 0.0;
                        NKD1_val = 0.0;
                        f_NKD1_val = false;
                        NKD1_RUR = 0.0;
                        f_NKD1_RUR = false;
                        All1_val = 0.0;
                        f_All1_val = false;
                        All1_RUR = 0.0;
                        DealKind2 = "";
                        DateExec2 = Date(0, 0, 0);
                        DatePay2Fact = Date(0, 0, 0);
                        Course14 = 0.0;
                        REPO_Tax = 0.0;
                        Cost2_RUR = 0.0;
                        NKD2_RUR = 0.0;
                        f_NKD2_RUR = false;
                        Ret_val = 0.0;
                        f_Ret_val = false;
                        Ret_RUR = 0.0;
                        f_Ret_RUR = false;
                        Partial_val = 0.0;
                        f_Partial_val = false;
                        Partial_RUR = 0.0;
                        f_Partial_RUR = false;
                        Comp_val = 0.0;
                        f_Comp_val = false;
                        Comp_RUR = 0.0;
                        f_Comp_RUR = false;
                        All2_val = 0.0;
                        f_All2_val = false;
                        All2_RUR = 0.0;
                        Inc_outl_val = 0.0;
                        Inc_outl_RUR = 0.0;
                        Course_differ = 0.0;
                        f_Course_differ = false;
                        NonRealizedCourse_differ = 0.0;
                        f_NonRealizedCourse_differ = false;
                        Inc_Coup_val = 0.0;
                        f_Inc_Coup_val = false;
                        Inc_Coup_RUR = 0.0;
                        f_Inc_Coup_RUR = false;
                        PartyName = "";
                        Was_Ureg = "";
                        ChangedIncomeRate = "";
                     end;

                     m_Report.PrintTableLine( "N_1",          ObjDeal,                     null,
                                              "N_2",          SfContrNum,                  null,
                                              "N_3",          DealKind1,                   null,
                                              "N_4",          DateExec1,                   null,
                                              "N_4a",         DatePay1Fact,                null,
                                              "N_4b",         "",                          null,
                                              "N_5",          Val(Amount),                 null,
                                              "N_5a",         Val(Course_5a),              null,
                                              "N_5b",         "",                          null,
                                              "N_6",          Val(Cost1_val),              null,
                                              "N_7",          Val(Cost1_RUR),              null,
                                              "N_8",          Val(NKD1_val, f_NKD1_val),   null,
                                              "N_9",          Val(NKD1_RUR, f_NKD1_RUR),   null,
                                              "N_10",         Val(All1_val, f_All1_val),   null,
                                              "N_11",         Val(All1_RUR),               null,
                                              /**************************** 2 часть *******************************/
                                              "N_12",         DealKind2,                   null,
                                              "N_13",         DateExec2,                   null,
                                              "N_13a",        DatePay2Fact,                null,
                                              "N_13b",        LinksData2[i].DateRealize,   null,
                                              "N_14",         Val(Course14),               null,
                                              "N_14a",        Val(LinksData2[i].Course),   null,
                                              "N_22",         LinksData2[i].Amount,        null,
                                              "N_23",         Val(REPO_Tax),               Point,
                                              "N_24",         Val(LinksData2[i].Cost_val), null,
                                              "N_25",         Val(Cost2_RUR),              null,
                                              "N_26",         Val(LinksData2[i].NKD_val, f_NKD2_val), null,
                                              "N_27",         Val(NKD2_RUR, f_NKD2_RUR),   null,
                                              "N_28",         Val(Ret_val, f_Ret_val),     null,
                                              "N_29",         Val(Ret_RUR, f_Ret_RUR),     null,
                                              "N_30",         Val(Partial_val, f_Partial_val), null,
                                              "N_31",         Val(Partial_RUR, f_Partial_RUR), null,
                                              "N_32",         Val(Comp_val, f_Comp_val),   null,
                                              "N_33",         Val(Comp_RUR, f_Comp_RUR),   null,
                                              "N_34",         Val(All2_val, f_All2_val),   null,
                                              "N_35",         Val(All2_RUR),               null,
                                              "N_38",         Val(Inc_outl_val),           null,
                                              "N_39",         Val(Inc_outl_RUR),           null,
                                              "N_40",         Val(Course_differ, f_Course_differ), null,
                                              "N_41",         Val(NonRealizedCourse_differ), null,
                                              "N_42",         Val(Inc_Coup_val, f_Inc_Coup_val), null,
                                              "N_43",         Val(Inc_Coup_RUR, f_Inc_Coup_RUR), null,
                                              "N_44",         PartyName,                   null,
                                              "N_45",         Was_Ureg,                    null,
                                              "N_46",         ChangedIncomeRate,           null);      

                         /*Данные для итоговой строки*/
           /*F6*/    Itog_Cost1_val = Itog_Cost1_val + Cost1_val;
           /*F7*/    Itog_Cost1_RUR = Itog_Cost1_RUR + Cost1_RUR;
           /*F8*/    Itog_NKD1_val  = Itog_NKD1_val  + NKD1_val;
           /*F9*/    Itog_NKD1_RUR  = Itog_NKD1_RUR  + NKD1_RUR;
           /*F10*/   Itog_All1_val  = Itog_All1_val  + All1_val;
           /*F11*/   Itog_All1_RUR  = Itog_All1_RUR  + All1_RUR;

           /*F17*/   Itog_Cost2_val = Itog_Cost2_val + LinksData2[i].Cost_val /*Cost2_val*/;
           /*F18*/   Itog_Cost2_RUR = Itog_Cost2_RUR + Cost2_RUR;
           /*F19*/   Itog_NKD2_val  = Itog_NKD2_val + LinksData2[i].NKD_val /*NKD2_val*/;
           /*F20*/   Itog_NKD2_RUR  = Itog_NKD2_RUR + NKD2_RUR;

           /*F21*/   Itog_NKD_Ret_val = Itog_NKD_Ret_val + Ret_val;
           /*F22*/   Itog_NKD_Ret_RUR = Itog_NKD_Ret_RUR + Ret_RUR;
                     Itog_Partial_val = Itog_Partial_val + Partial_val;
                     Itog_Partial_RUR = Itog_Partial_RUR + Partial_RUR;
                     Itog_Comp_val = Itog_Comp_val + Comp_val;
                     Itog_Comp_RUR = Itog_Comp_RUR + Comp_RUR;

           /*F23*/   Itog_All2_val = Itog_All2_val + All2_val;
           /*F24*/   Itog_All2_RUR = Itog_All2_RUR + All2_RUR;

           /*F29*/   Itog_val = Itog_val + Inc_outl_val;
           /*F30*/   Itog_RUR = Itog_RUR + Inc_outl_RUR;

           /*F31*/   Itog_Course_differ = Itog_Course_differ + Course_differ;
           /*F32*/   Itog_NonRealizedCourse_differ = Itog_NonRealizedCourse_differ + NonRealizedCourse_differ;
           /*F33*/   Itog_Inc_Coup_val = Itog_Inc_Coup_val + Inc_Coup_val; 
           /*F34*/   Itog_Inc_Coup_RUR = Itog_Inc_Coup_RUR + Inc_Coup_RUR;

                     i = i + 1;
                  end;
               end;

               Data.ReportRun = true;
            end;
         else
            /* Режим: расходы по РЕПО */
            if( ((IsBUY(FD.Group)==true) AND (SummPartDiff < 0))
                OR ((IsSALE(FD.Group)==true) AND (SummPartDiff >= 0))
              )

               /*может быть разделение ячеек по 1 части, иначе - по 2-й.*/
               if (IsBuy(FD.Group))

                  i = 1;
                  while (i < LinksData1.Size)
                     if (i != 1)
                        ObjDeal = "";
                        SfContrNum = "";
                        DealKind1 = "";
                        DateExec1 = Date(0, 0, 0);
                        DatePay1Fact = Date(0, 0, 0);
                        Course_5a = 0.0;
                        Cost1_RUR = 0.0;
                        NKD1_RUR = 0.0;
                        f_NKD1_RUR = false;
                        All1_val = 0.0;
                        f_All1_val = false;
                        All1_RUR = 0.0;
                        DealKind2 = "";
                        DateExec2 = Date(0, 0, 0);
                        DatePay2Fact = Date(0, 0, 0);
                        Course14 = 0.0;
                        Amount = 0.0;
                        REPO_Tax = 0.0;
                        Cost2_val = 0.0;
                        Cost2_RUR = 0.0;
                        NKD2_val = 0.0;
                        f_NKD2_val = false;
                        NKD2_RUR = 0.0;
                        f_NKD2_RUR = false;
                        Ret_val = 0.0;
                        f_Ret_val = false;
                        Ret_RUR = 0.0;
                        f_Ret_RUR = false;
                        Partial_val = 0.0;
                        f_Partial_val = false;
                        Partial_RUR = 0.0;
                        f_Partial_RUR = false;
                        Comp_val = 0.0;
                        f_Comp_val = false;
                        Comp_RUR = 0.0;
                        f_Comp_RUR = false;
                        All2_val = 0.0;
                        f_All2_val = false;
                        All2_RUR = 0.0;
                        Inc_outl_val = 0.0;
                        Inc_outl_RUR = 0.0;
                        RateCB = 0;
                        Outl_For_Nalog = 0.0;
                        Course_differ = 0.0;
                        f_Course_differ = false;
                        Inc_Coup_val = 0.0;
                        f_Inc_Coup_val = false;
                        Inc_Coup_RUR = 0.0;
                        f_Inc_Coup_RUR = false;
                        PartyName = "";
                        Was_Ureg = "";
                        ChangedIncomeRate = "";
                     end;

                     m_Report.PrintTableLine( "N_1",          ObjDeal,                     null,
                                              "N_2",          SfContrNum,                  null,
                                              "N_3",          DealKind1,                   null,
                                              "N_4",          DateExec1,                   null,
                                              "N_5",          DatePay1Fact,                null,
                                              "N_6",          LinksData1[i].DateRealize,   null,
                                              "N_7",          LinksData1[i].Amount,        null,
                                              "N_8",          Val(Course_5a),              null,
                                              "N_9",          Val(LinksData1[i].Course),   null,
                                              "N_10",         Val(LinksData1[i].Cost_val), null,
                                              "N_11",         Val(Cost1_RUR),              null,
                                              "N_12",         Val(LinksData1[i].NKD_val, f_NKD1_val), null,
                                              "N_13",         Val(NKD1_RUR, f_NKD1_RUR),   null,
                                              "N_14",         Val(All1_val, f_All1_val),   null,
                                              "N_15",         Val(All1_RUR),               null,
                                              /**************************** 2 часть *******************************/
                                              "N_16",         DealKind2,                   null,
                                              "N_17",         DateExec2,                   null,
                                              "N_18",         DatePay2Fact,                null,
                                              "N_19",         "",                          null,
                                              "N_20",         Val(Course14),               null,
                                              "N_21",         "",                          null,
                                              "N_22",         Val(Amount),                 null,
                                              "N_23",         Val(REPO_Tax),               Point,
                                              "N_24",         Val(Cost2_val),              null,
                                              "N_25",         Val(Cost2_RUR),              null,
                                              "N_26",         Val(NKD2_val, f_NKD2_val),   null,
                                              "N_27",         Val(NKD2_RUR, f_NKD2_RUR),   null,
                                              "N_28",         Val(Ret_val, f_Ret_val),     null,
                                              "N_29",         Val(Ret_RUR, f_Ret_RUR),     null,
                                              "N_30",         Val(Partial_val, f_Partial_val), null,
                                              "N_31",         Val(Partial_RUR, f_Partial_RUR), null,
                                              "N_32",         Val(Comp_val, f_Comp_val),   null,
                                              "N_33",         Val(Comp_RUR, f_Comp_RUR),   null,
                                              "N_34",         Val(All2_val, f_All2_val),   null,
                                              "N_35",         Val(All2_RUR),               null,
                                              "N_36",         Val(Inc_outl_val),           null,
                                              "N_37",         Val(Inc_outl_RUR),           null,
                                              "N_38",         Val(RateCB),                 null,
                                              "N_39",         Val(Outl_For_Nalog),         null,
                                              "N_42",         Val(Course_differ, f_Course_differ), null,
                                              "N_43",         LinksData1[i].differ,        null,
                                              "N_44",         Val(Inc_Coup_val, f_Inc_Coup_val), null,
                                              "N_47",         Val(Inc_Coup_RUR, f_Inc_Coup_RUR), null,
                                              "N_48",         PartyName,                   null,
                                              "N_49",         Was_Ureg,                    null,
                                              "N_50",         ChangedIncomeRate,           null);      

                         /*Данные для итоговой строки*/
           /*F6*/    Itog_Cost1_val = Itog_Cost1_val + LinksData1[i].Cost_val /*Cost1_val*/;
           /*F7*/    Itog_Cost1_RUR = Itog_Cost1_RUR + Cost1_RUR;
           /*F8*/    Itog_NKD1_val  = Itog_NKD1_val  + LinksData1[i].NKD_val /*NKD1_val*/;
           /*F9*/    Itog_NKD1_RUR  = Itog_NKD1_RUR  + NKD1_RUR;
           /*F10*/   Itog_All1_val  = Itog_All1_val  + All1_val;
           /*F11*/   Itog_All1_RUR  = Itog_All1_RUR  + All1_RUR;

           /*F17*/   Itog_Cost2_val = Itog_Cost2_val + Cost2_val;
           /*F18*/   Itog_Cost2_RUR = Itog_Cost2_RUR + Cost2_RUR;
           /*F19*/   Itog_NKD2_val  = Itog_NKD2_val + NKD2_val;
           /*F20*/   Itog_NKD2_RUR  = Itog_NKD2_RUR + NKD2_RUR;

           /*F21*/   Itog_NKD_Ret_val = Itog_NKD_Ret_val + Ret_val;
           /*F22*/   Itog_NKD_Ret_RUR = Itog_NKD_Ret_RUR + Ret_RUR;
                     Itog_Partial_val = Itog_Partial_val + Partial_val;
                     Itog_Partial_RUR = Itog_Partial_RUR + Partial_RUR;
                     Itog_Comp_val = Itog_Comp_val + Comp_val;
                     Itog_Comp_RUR = Itog_Comp_RUR + Comp_RUR;

           /*F23*/   Itog_All2_val = Itog_All2_val + All2_val;
           /*F24*/   Itog_All2_RUR = Itog_All2_RUR + All2_RUR;

           /*F27*/   Itog_val = Itog_val + Inc_outl_val;
           /*F28*/   Itog_RUR = Itog_RUR + Inc_outl_RUR;
           /*F30*/   Itog_Outl_For_Nalog = Itog_Outl_For_Nalog + Outl_For_Nalog;

           /*F33*/   Itog_Course_differ = Itog_Course_differ + Course_differ;
           /*F34*/   Itog_NonRealizedCourse_differ = Itog_NonRealizedCourse_differ + NonRealizedCourse_differ;
           /*F35*/   Itog_Inc_Coup_val = Itog_Inc_Coup_val + Inc_Coup_val; 
           /*F36*/   Itog_Inc_Coup_RUR = Itog_Inc_Coup_RUR + Inc_Coup_RUR;

                     i = i + 1;
                  end;

               else

                  i = 1;
                  while (i < LinksData2.Size)
                     if (i != 1)
                        ObjDeal = "";
                        SfContrNum = "";
                        DealKind1 = "";
                        DateExec1 = Date(0, 0, 0);
                        DatePay1Fact = Date(0, 0, 0);
                        Amount = 0.0;
                        Course_5a = 0.0;
                        Cost1_val = 0.0;
                        Cost1_RUR = 0.0;
                        NKD1_val = 0.0;
                        f_NKD1_val = false;
                        NKD1_RUR = 0.0;
                        f_NKD1_RUR = false;
                        All1_val = 0.0;
                        f_All1_val = false;
                        All1_RUR = 0.0;
                        DealKind2 = "";
                        DateExec2 = Date(0, 0, 0);
                        DatePay2Fact = Date(0, 0, 0);
                        Course14 = 0.0;
                        REPO_Tax = 0.0;
                        Cost2_RUR = 0.0;
                        NKD2_RUR = 0.0;
                        f_NKD2_RUR = false;
                        Ret_val = 0.0;
                        f_Ret_val = false;
                        Ret_RUR = 0.0;
                        f_Ret_RUR = false;
                        Partial_val = 0.0;
                        f_Partial_val = false;
                        Partial_RUR = 0.0;
                        f_Partial_RUR = false;
                        Comp_val = 0.0;
                        f_Comp_val = false;
                        Comp_RUR = 0.0;
                        f_Comp_RUR = false;
                        All2_val = 0.0;
                        f_All2_val = false;
                        All2_RUR = 0.0;
                        Inc_outl_val = 0.0;
                        Inc_outl_RUR = 0.0;
                        RateCB = 0.0;
                        Outl_For_Nalog = 0.0;
                        Course_differ = 0.0;
                        f_Course_differ = false;
                        NonRealizedCourse_differ = 0.0;
                        f_NonRealizedCourse_differ = false;
                        Inc_Coup_val = 0.0;
                        f_Inc_Coup_val = false;
                        Inc_Coup_RUR = 0.0;
                        f_Inc_Coup_RUR = false;
                        PartyName = "";
                        Was_Ureg = "";
                        ChangedIncomeRate = "";
                     end;

                     m_Report.PrintTableLine( "N_1",          ObjDeal,                     null,
                                              "N_2",          SfContrNum,                  null,
                                              "N_3",          DealKind1,                   null,
                                              "N_4",          DateExec1,                   null,
                                              "N_5",          DatePay1Fact,                null,
                                              "N_6",          "",                          null,
                                              "N_7",          Val(Amount),                 null,
                                              "N_8",          Val(Course_5a),              null,
                                              "N_9",          "",                          null,
                                              "N_10",         Val(Cost1_val),              null,
                                              "N_11",         Val(Cost1_RUR),              null,
                                              "N_12",         Val(NKD1_val, f_NKD1_val),   null,
                                              "N_13",         Val(NKD1_RUR, f_NKD1_RUR),   null,
                                              "N_14",         Val(All1_val, f_All1_val),   null,
                                              "N_15",         Val(All1_RUR),               null,
                                              /**************************** 2 часть *******************************/
                                              "N_16",         DealKind2,                   null,
                                              "N_17",         DateExec2,                   null,
                                              "N_18",         DatePay2Fact,                null,
                                              "N_19",         LinksData2[i].DateRealize,   null,
                                              "N_20",         Val(Course14),               null,
                                              "N_21",         Val(LinksData2[i].Course),   null,
                                              "N_22",         LinksData2[i].Amount,        null,
                                              "N_23",         Val(REPO_Tax),               Point,
                                              "N_24",         Val(LinksData2[i].Cost_val), null,
                                              "N_25",         Val(Cost2_RUR),              null,
                                              "N_26",         Val(LinksData2[i].NKD_val, f_NKD2_val), null,
                                              "N_27",         Val(NKD2_RUR, f_NKD2_RUR),   null,
                                              "N_28",         Val(Ret_val, f_Ret_val),     null,
                                              "N_29",         Val(Ret_RUR, f_Ret_RUR),     null,
                                              "N_30",         Val(Partial_val, f_Partial_val), null,
                                              "N_31",         Val(Partial_RUR, f_Partial_RUR), null,
                                              "N_32",         Val(Comp_val, f_Comp_val),   null,
                                              "N_33",         Val(Comp_RUR, f_Comp_RUR),   null,
                                              "N_34",         Val(All2_val, f_All2_val),   null,
                                              "N_35",         Val(All2_RUR),               null,
                                              "N_36",         Val(Inc_outl_val),           null,
                                              "N_37",         Val(Inc_outl_RUR),           null,
                                              "N_38",         Val(RateCB),                 null,
                                              "N_39",         Val(Outl_For_Nalog),         null,
                                              "N_42",         Val(Course_differ, f_Course_differ), null,
                                              "N_43",         Val(NonRealizedCourse_differ, f_NonRealizedCourse_differ), null,
                                              "N_44",         Val(Inc_Coup_val, f_Inc_Coup_val), null,
                                              "N_47",         Val(Inc_Coup_RUR, f_Inc_Coup_RUR), null,
                                              "N_48",         PartyName,                   null,
                                              "N_49",         Was_Ureg,                    null,
                                              "N_50",         ChangedIncomeRate,           null);      

                         /*Данные для итоговой строки*/
           /*F6*/    Itog_Cost1_val = Itog_Cost1_val + Cost1_val;
           /*F7*/    Itog_Cost1_RUR = Itog_Cost1_RUR + Cost1_RUR;
           /*F8*/    Itog_NKD1_val  = Itog_NKD1_val  + NKD1_val;
           /*F9*/    Itog_NKD1_RUR  = Itog_NKD1_RUR  + NKD1_RUR;
           /*F10*/   Itog_All1_val  = Itog_All1_val  + All1_val;
           /*F11*/   Itog_All1_RUR  = Itog_All1_RUR  + All1_RUR;

           /*F17*/   Itog_Cost2_val = Itog_Cost2_val + LinksData2[i].Cost_val /*Cost2_val*/;
           /*F18*/   Itog_Cost2_RUR = Itog_Cost2_RUR + Cost2_RUR;
           /*F19*/   Itog_NKD2_val  = Itog_NKD2_val + LinksData2[i].NKD_val /*NKD2_val*/;
           /*F20*/   Itog_NKD2_RUR  = Itog_NKD2_RUR + NKD2_RUR;

           /*F21*/   Itog_NKD_Ret_val = Itog_NKD_Ret_val + Ret_val;
           /*F22*/   Itog_NKD_Ret_RUR = Itog_NKD_Ret_RUR + Ret_RUR;
                     Itog_Partial_val = Itog_Partial_val + Partial_val;
                     Itog_Partial_RUR = Itog_Partial_RUR + Partial_RUR;
                     Itog_Comp_val = Itog_Comp_val + Comp_val;
                     Itog_Comp_RUR = Itog_Comp_RUR + Comp_RUR;

           /*F23*/   Itog_All2_val = Itog_All2_val + All2_val;
           /*F24*/   Itog_All2_RUR = Itog_All2_RUR + All2_RUR;

           /*F27*/   Itog_val = Itog_val + Inc_outl_val;
           /*F28*/   Itog_RUR = Itog_RUR + Inc_outl_RUR;
           /*F30*/   Itog_Outl_For_Nalog = Itog_Outl_For_Nalog + Outl_For_Nalog;

           /*F33*/   Itog_Course_differ = Itog_Course_differ + Course_differ;
           /*F34*/   Itog_NonRealizedCourse_differ = Itog_NonRealizedCourse_differ + NonRealizedCourse_differ;
           /*F35*/   Itog_Inc_Coup_val = Itog_Inc_Coup_val + Inc_Coup_val; 
           /*F36*/   Itog_Inc_Coup_RUR = Itog_Inc_Coup_RUR + Inc_Coup_RUR;

                     i = i + 1;
                  end;

               end;
               Data.ReportRun = true;
            end;
         end;
      end;

      UseProgress(CurNum = CurNum + 1);
   end;
   RemProgress;

   if(Data.ReportRun == true)
   /*Печатаем итоговую строку*/
      if(Data.Mode == ДОХОДЫ_ПО_РЕПО)
         m_Report.PrintTableLine( "N_1",          "",                          null,
                                  "N_2",          "Итого",                     null,
                                  "N_3",          "",                          null,
                                  "N_4",          "",                          null,
                                  "N_4a",         "",                          null,
                                  "N_4b",         "",                          null,
                                  "N_5",          "",                          null,
                                  "N_5a",         "",                          null,
                                  "N_5b",         "",                          null,
                                  "N_6",          Itog_Cost1_val,              null,
                                  "N_7",          Itog_Cost1_RUR,              null,
                                  "N_8",          Itog_NKD1_val,               null,
                                  "N_9",          Itog_NKD1_RUR,               null,
                                  "N_10",         Itog_All1_val,               null,
                                  "N_11",         Itog_All1_RUR,               null,
                                  /**************************** 2 часть *******************************/
                                  "N_12",         "",                          null,
                                  "N_13",         "",                          null,
                                  "N_13a",        "",                          null,
                                  "N_13b",        "",                          null,
                                  "N_14",         "",                          null,
                                  "N_14a",        "",                          null,
                                  "N_22",         "",                          null,
                                  "N_23",         "",                          null,
                                  "N_24",         Itog_Cost2_val,              null,
                                  "N_25",         Itog_Cost2_RUR,              null,
                                  "N_26",         Itog_NKD2_val,               null,
                                  "N_27",         Itog_NKD2_RUR,               null,
                                  "N_28",         Itog_NKD_Ret_val,            null,
                                  "N_29",         Itog_NKD_Ret_RUR,            null,
                                  "N_30",         Itog_Partial_val,            null,
                                  "N_31",         Itog_Partial_RUR,            null,
                                  "N_32",         Itog_Comp_val,               null,
                                  "N_33",         Itog_Comp_RUR,               null,
                                  "N_34",         Itog_All2_val,               null,
                                  "N_35",         Itog_All2_RUR,               null,
                                  "N_38",         Itog_val,                    null,
                                  "N_39",         Itog_RUR,                    null,
                                  "N_40",         Itog_Course_differ,          null,
                                  "N_41",         Itog_NonRealizedCourse_differ, null,
                                  "N_42",         Itog_Inc_Coup_val,           null,
                                  "N_43",         Itog_Inc_Coup_RUR,           null,
                                  "N_44",         "",                          null,
                                  "N_45",         "",                          null,
                                  "N_46",         "",                          null);      
      else
         m_Report.PrintTableLine( "N_1",          "",                          null,
                                  "N_2",          "Итого",                     null,
                                  "N_3",          "",                          null,
                                  "N_4",          "",                          null,
                                  "N_5",          "",                          null,
                                  "N_6",          "",                          null,
                                  "N_7",          "",                          null,
                                  "N_8",          "",                          null,
                                  "N_9",          "",                          null,
                                  "N_10",         Itog_Cost1_val,              null,
                                  "N_11",         Itog_Cost1_RUR,              null,
                                  "N_12",         Itog_NKD1_val,               null,
                                  "N_13",         Itog_NKD1_RUR,               null,
                                  "N_14",         Itog_All1_val,               null,
                                  "N_15",         Itog_All1_RUR,               null,
                                  /**************************** 2 часть *******************************/
                                  "N_16",         "",                          null,
                                  "N_17",         "",                          null,
                                  "N_18",         "",                          null,
                                  "N_19",         "",                          null,
                                  "N_20",         "",                          null,
                                  "N_21",         "",                          null,
                                  "N_22",         "",                          null,
                                  "N_23",         "",                          null,
                                  "N_24",         Itog_Cost2_val,              null,
                                  "N_25",         Itog_Cost2_RUR,              null,
                                  "N_26",         Itog_NKD2_val,               null,
                                  "N_27",         Itog_NKD2_RUR,               null,
                                  "N_28",         Itog_NKD_Ret_val,            null,
                                  "N_29",         Itog_NKD_Ret_RUR,            null,
                                  "N_30",         Itog_Partial_val,            null,
                                  "N_31",         Itog_Partial_RUR,            null,
                                  "N_32",         Itog_Comp_val,               null,
                                  "N_33",         Itog_Comp_RUR,               null,
                                  "N_34",         Itog_All2_val,               null,
                                  "N_35",         Itog_All2_RUR,               null,
                                  "N_36",         Itog_val,                    null,
                                  "N_37",         Itog_RUR,                    null,
                                  "N_38",         "",                          null,
                                  "N_39",         Itog_Outl_For_Nalog,         null,
                                  "N_42",         Itog_Course_differ,          null,
                                  "N_43",         Itog_NonRealizedCourse_differ, null,
                                  "N_44",         Itog_Inc_Coup_val,           null,
                                  "N_47",         Itog_Inc_Coup_RUR,           null,
                                  "N_48",         "",                          null,
                                  "N_49",         "",                          null,
                                  "N_50",         "",                          null);      
      end;
   end;

end;

macro FillReport(Data, FD, FD_back)

   var errcode, errtext;

   ClearRecord(REPO_RepTmp);

   REPO_RepTmp.DealID = FD.tick.rec.DealID;

   if( (FD_back.DateArray[DATE_DEALSETAVOIRISS] <= Data.EndDate)
       AND (ПлатежЗакрыт(FD_back.pm_avoir.rec)) )

      REPO_RepTmp.Dmin = FD_back.DateArray[DATE_DEALSETAVOIRISS];
   else
      REPO_RepTmp.Dmin = Data.EndDate;
   end;

   NRecs = NRecs + 1;

   if( not Insert( REPO_RepTmp ) )
      errcode = status(errtext);
      MsgBox( "Ошибка при вставке данных во временный файл (" + errcode + ") " + errtext);
      exit(1);
   end;
end;

macro CreateReport(Data)
   var
      Query, DataSet, dl_tick = TBFile( "dl_tick" ), FIID_Query = "",
      CheckBondKind = true, CheckNomFIID = true, CheckAvrKind = true, 
      OK = true, FD, FD_back;

   if (((not Data.NominateInRUR) and (not Data.NotNominateInRUR)) or
       ((Data.AvrKind == BOND) and (not Data.AvrIsGosMun) and (not Data.AvrIsNotGosMun))
      )
      FIID_Query = " and 1 = 2 "; /*ничего не подходит, ничего не возвращаем*/
   else

      if (Data.AvrIsGosMun and Data.AvrIsNotGosMun)
         CheckBondKind = false;
      end;

      if ((not Data.AvrIsGosMun) and (not Data.AvrIsNotGosMun))
         CheckBondKind = false;
      end;

      if (Data.NominateInRUR and Data.NotNominateInRUR)
         CheckNomFIID = false;
      end;

      if (Data.AvrKind == ALL)
         CheckAvrKind = false;
      end;

      if (CheckBondKind or CheckNomFIID or CheckAvrKind)
         if (CheckAvrKind)
            if (Data.AvrKind == SHARE)
               FIID_Query = FIID_Query + " and RSB_Secur.SecurKind(f.t_AvoirKind ) = " + string(AVOIRISSKIND_EQUITY_SHARE) + " ";
            elif (Data.AvrKind == BOND)
               FIID_Query = FIID_Query + " and RSB_Secur.SecurKind(f.t_AvoirKind ) = " + string(AVOIRISSKIND_ORDINARY_BOND) + " ";
               if (CheckBondKind)
                  if (Data.AvrIsGosMun)
                     FIID_Query = FIID_Query + " AND (RSB_FIInstr.FI_AvrKindsEQ(2, " + string(государственные) + ", f.t_AvoirKind) = 1 or ";
                     FIID_Query = FIID_Query + "      RSB_FIInstr.FI_AvrKindsEQ(2, " + string(муниципальные)   + ", f.t_AvoirKind) = 1 ) ";
                  elif (Data.AvrIsNotGosMun)
                     FIID_Query = FIID_Query + " AND RSB_FIInstr.FI_AvrKindsEQ(2, " + string(32) + ", f.t_AvoirKind) = 1 "; // Корпоративные
                  end;
               end;

               if (Data.BondKind > 0)
                  FIID_Query = FIID_Query + " AND RSB_FIInstr.FI_AvrKindsEQ(2, " + string(Data.BondKind) + ", f.t_AvoirKind) = 1 ";
               end;
            end;
         end;

         if (CheckNomFIID)
            if (Data.NominateInRUR)
               FIID_Query = FIID_Query + " and f.t_FaceValueFI = " + string(NATCUR);
            elif (Data.NotNominateInRUR)
               FIID_Query = FIID_Query + " and f.t_FaceValueFI != " + string(NATCUR);
            end;
         end;
      end;

   end;
   /* Сделки должны быть открытыми или закрытыми.
      Сделки должны быть только собственными. */

   Query = " Select d.t_DealID DealID "
         + "   From ddl_tick_dbt d, ddl_leg_dbt leg, dfininstr_dbt f "
         + "  Where d.t_BofficeKind = " + string(DL_SECURITYDOC)
         + "    and d.t_DealStatus >= " + string(DL_READIED)
         + "    and d.t_ClientID   <= 0 "
         + "    and d.t_DealID      = leg.t_DealID "
         + "    and leg.t_LegKind   = " + string(LEG_KIND_DL_TICK_BACK)
         + "    and leg.t_Pfi       = f.t_FIID "
         + FIID_Query;

   DataSet = TRsbDataSet( Query );

   InitProgressBar(  SQL_GetNRecs(Query),
                     IIF(Data.Mode == ДОХОДЫ_ПО_РЕПО, StatProfit, StatCharge),
                     "Создание отчета" );

   while( DataSet.MoveNext() )
      dl_tick.Clear();
      dl_tick.rec.DealID = DataSet.DealID;
      if(dl_tick.GetEQ() and IsREPO(GetOpGroup(dl_tick.rec)))

         /* Получим первичный документ по операции. */
         FD = SPFirstDoc( LEG_KIND_DL_TICK, DataSet.DealID );
         FD_back = SPFirstDoc( LEG_KIND_DL_TICK_BACK, DataSet.DealID );

         /*Должно выполняться хотя-бы одно условие:
           -  дата исполнения первой или второй части сделки входит в отчетный период
           -  по состоянию на дату окончания отчетного периода 1 часть сделки исполнена, 
              а 2-ая часть - не исполнена, причем исполнением считается:
                - в сделках РЕПО/покупка - фактическая дата оплаты,
                - в сделках РЕПО/продажа - фактическая дата поставки
         */
         if((DateInPeriod(Data, FD.DateArray[DATE_DEALEEND]) != true) AND 
            (DateInPeriod(Data, FD_back.DateArray[DATE_DEALEEND]) != true) AND
            (not((ЧастьИсполнена(Data.EndDate, FD)) AND   /* исполнена 1 часть */
                 (not ЧастьИсполнена(Data.EndDate, FD_back))   /*не исполнена 2 часть*/
                )
            )
           )
            OK = false;
         end;

         if(OK == true)
            FillReport(Data, FD, FD_back);
         end;
      end;

      UseProgressBar;
      OK = true;
   end;
   RemProgressBar;
end;
                                                                                                                                                                                                                                                                                                 
macro RepoReportRun(  Report:           OBJECT,
                      Period:           integer,
                      Year:             integer,
                      AvrIsGosMun:      bool,       /* Государственные и муниц. ц/б */
                      AvrIsNotGosMun:   bool,       /* Кроме гос. и муницип. ц/б */
                      NominateInRUR:    bool,
                      NotNominateInRUR: bool, 
                      AllFI:            bool,
                      ShareFI:          bool,
                      BondFI:           bool,
                      BondKind:         integer,
                      Apostr:           bool,
                      Mode:             integer
                      )

   var Data, errcode, errtext, AvrKind, TmpFName = GetWorkFileName("reporep");

   if (ShareFI)
      AvrKind = SHARE;
   elif (BondFI)
      AvrKind = BOND;
   else
      AvrKind = ALL;
   end;

   Data = SourceData(  Period, Year, AvrIsGosMun, AvrIsNotGosMun,
                       NominateInRUR, NotNominateInRUR,
                       AvrKind, BondKind, Apostr, Mode);

   m_Report = Report;
   IsApp = Apostr;

   ClearGlobalTmp( "dreporep_tmp" );

   Message( "Выполнение отчета " );

   GetPeriod(Data);
   PrintHeadReport(Data);

   CreateReport(Data);
   PrintReport(Data);
   m_Report.EndTable();

end;
