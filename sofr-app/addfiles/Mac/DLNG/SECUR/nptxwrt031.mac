/*
$Name: nptxwrt031.mac
$Module: Ценные бумаги
$Description: Запрос СНОБ для операций списания/зачисления денежных средств
*/

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac", "nptxcalcfun.mac", "nptxwrt_func.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

macro ExecuteStep( kind_oper, FDoc, DocKind, ID_Operation, ID_Step )
  record nptxop("nptxop");
  var ErrStr = "";
  var err = 0;
  var НОБ_опер = $0;
  var NumberOp = "";

  SetBuff( nptxop, FDoc );
  
  //Проверить необходимость запроса СНОБ
  CalcNOBoper(nptxop, @НОБ_опер);

  if(ЕстьНеисполненнаяПорожденнаяОперацияНОБ(nptxop.ID, @NumberOp))
    if(MsgBoxEx( "Порождённая операция расчёта НОБ № "+ NumberOp +" не выполнена. Продолжить выполнение текущей операции зачисления/списания? ",
                   MB_YES+MB_NO, IND_NO) != IND_YES )
       return 1;
    end;
  end;

  if(DL_InsertNPTXVAL(nptxop.DocKind, nptxop.ID, NPTXVAL_KIND_TB_Oper, date(0,0,0), time(0), НОБ_опер, 0) != 0)
    return Error( "Ошибка при сохранении значения СНОБ" );
  end;

  if(НОБ_опер != 0)
    err = STB_ExecuteGetAmountSNOBOnStep(nptxop.DocKind, nptxop.ID, nptxop.Client, nptxop.OperDate, ID_Operation, ID_Step, @ErrStr, IIF(nptxop.IIS == SET_CHAR, true, false), NULL, IIF(НОБ_опер < 0, true, false));
    if(ErrStr)
      Error(ErrStr);
    end;
  end;

  if(not err)
    if( not InsertOprStatus(460710, 1)) //Расчет сумм налога и вывода СНОБ = Выполнить
      return Error( "Ошибка при установке статуса вида \"Расчет сумм налога и вывода СНОБ\" операции" );        
    end;
  end;

  return err;
end;