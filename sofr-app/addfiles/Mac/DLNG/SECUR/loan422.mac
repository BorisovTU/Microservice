/*
$Name:        loan422.mac
$Module:      Ценные бумаги
$Description: Займ. Шаг "Досрочный возврат ц/б"
*/

import InsCarryDoc, "sp_car.mac", "sp_car2.mac";

/*глобальные структуры, через которые передаются изменения условий сделок*/
record SpChangeDlTick("dl_tick.dbt");    /*условия сделки*/
record SpChangeDlLeg("dl_leg.dbt");      /*условия первой части сделки*/
record SpChangeDlLegBack("dl_leg.dbt");  /*условия второй части сделки*/
record SpChangePmwrtsum("pmwrtsum.dbt"); /*лот по 1 части*/

var COUPON_SUM;
var CalcOperDate;
var ReturnIncome;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  record  deal(dl_tick);
  var FD, FD1, i = 0, Dknext;
  var rq_avoir = TRecHandler("dlrq.dbt");
  var FactDate = CalcOperDate;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, true );
  FD1 = SPFirstDoc( deal, false );

  if( FD.БылОтказОтИсполнения() != false )
     return 0;
  end;

  if( FD1.БылОтказОтИсполнения() != false )
     return 0;
  end;

  if(ПроверитьПорученияДепо(FD) == false)
    return 1;
  end;

  /*Установить дату расчётов на ТО %% */
  if(FD.ExistPC and (not ТОСквитовано(FD.GetRQ(DLRQ_TYPE_INCREPO))))
    FD.GetRQ(DLRQ_TYPE_INCREPO, 2).rec.Amount = ReturnIncome; 
    if( УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_INCREPO), DLRQ_STATE_EXEC, FactDate) != 0 )
      return 1;
    end;
  end;

  /*Установить дату расчётов на ТО поставки 2ч */
  if( УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_DELIVERY), DLRQ_STATE_EXEC, FactDate) != 0 )
    return 1;
  end;

  if( ВыполнитьНатуральныйУчетЦенныхБумаг( FD, Doc, FactDate, NULL ) != 0 )
     return 1;
  end; 


  /* Установить дату на строки графика в дату поставки 2ч. */
  if(DL_SetDateGrDeal( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, DLGR_DATEKIND_DELIVERY2, FactDate) != 0 )
    return 1;
  end;

  /* Установить опер. дату поставки 2ч */
  DefineOprDate( FD1.GetKindDate(DATE_DEALSETAVOIRISS_2), FactDate );

/********************************************
  /* Изменить тикет сделки на шаге операции */
  if( OprInsertSPTKCHNG(FactDate, SpChangeDlTick.ChangeKind, SpChangeDlTick, SpChangeDlLeg, SpChangeDlLegBack, COUPON_SUM) == false )
     return 1;
  end;
*/
 
  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERY2, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;
 
  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYPC, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;

  if(FD.tick.rec.IsPartyClient == SET_CHAR)
    if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERYCONTR, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
      return 1;
    end;
  end;

  return 0;
end;
