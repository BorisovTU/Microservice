/*
$Name:        incaccps.mac
$Module:      Ценные бумаги
$Description: Отчет "Доходы в виде начисленных процентов"
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : incaccps.mac
  Programmer  : Иванютин Р.Н.
  Операция    : Отчет "Доходы в виде начисленных процентов"
└───────────────────────────────────────────────────────────────────────────*/

import "sp_class.mac", "spRepFn2.mac", "or_rep_h.mac", "DLReport_h.mac", "incaccps_Form.mac";

private const
  /* Базисы расчета НКД */
  _AVOIRISSNKDBASE_365_Cal   = 0,  /* 365 в году, по календарю в месяце */
  _AVOIRISSNKDBASE_360_30    = 1,  /* 360 в году, 30 в месяце */
  _AVOIRISSNKDBASE_360_Cal   = 2,  /* 360 в году, по календарю в месяце */
  _AVOIRISSNKDBASE_365_30    = 3,  /* 365 в году, 30 в месяце */
  _AVOIRISSNKDBASE_Cal_Cal   = 4,  /* по календарю и в году и в месяце */
  _AVOIRISSNKDBASE_Cal_30    = 5,  /* по календарю в году, 30 в месяце */
  _AVOIRISSNKDBASE_Coup_Cal = 6,   /* дней в году по продолжительности купонных периодов, в месяце по календарю*/
  _AVOIRISSNKDBASE_365L_Cal = 7,   /* в месяце по календарю, в году по календарю по окончанию куп. периода */ 
  _AVOIRISSNKDBASE_364_Cal = 8,    /* в месяце по календарю, в году 364 */
  _AVOIRISSNKDBASE_360_30E = 9;    /* в месяце 30 дней, в году 360 дней (Eurobond)*/
                
private const ALL_FI = -1;

private var ReportHeader =
"\n\n#######################################################################################################################################################\n" +
"#########################################\n" +
"###########################################################################################################################################################\n" +
"\n" +
"за период: ########################\n";

private var
  Table1 = "┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n" +
           "│ 1. Обычные покупки                                                                                                                                                                                                                                                                                                                                                      │\n" +
           "├─────────────────────────┬────────────────────┬──────────────┬───────┬─────────┬──────┬──────┬────────────┬──────────┬──────────┬──────────┬───────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤\n" +
           "│                         │                    │              │       │         │Код   │Код   │            │          │          │          │     Период для начисления     │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │   Код   │прямо-│прямо-│            │   Дата   │   Дата   │  Дата    │           процентов           │     Начисленный процентный доход    │           Процентный расход         │           Погашаемые купоны         │      НКД при начале начисления      │    В предыдущем налоговом периоде   │\n" +
           "│Наименование ценных бумаг│      Эмитент       │   Номинал    │Процент│ покупки │го    │го    │ Количество │  начала  │ окончания│последнего│                               │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │         │РЕПО  │РЕПО/ │            │начисления│начисления│погашения ├──────────┬──────────┬─────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤\n" +
           "│                         │                    │              │       │         │      │продаж│            │          │          │ купона   │    с     │    по    │   дней  │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │\n" +
           "├─────────────────────────┼────────────────────┼──────────────┼───────┼─────────┼──────┼──────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤\n" +
           "│           1             │          2         │       3      │   4   │    5    │  6   │   7  │      8     │    9     │    10    │    11    │    12    │    13    │    14   │        15        │        16        │        17        │        18        │        19        │        20        │        21        │        22        │        23        │        24        │\n" +
           "├─────────────────────────┼────────────────────┼──────────┬───┼───────┼─────────┼──────┼──────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤",

  Table2 = "┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n" +
           "│ 2. Продано по прямому РЕПО (ранее куплено в обычных покупках)                                                                                                                                                                                                                                                                                                                       │\n" +
           "├─────────────────────────┬────────────────────┬──────────────┬───────┬───────────┬───────────┬───────────┬────────────┬──────────┬──────────┬──────────┬───────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤\n" +
           "│                         │                    │              │       │           │           │           │            │          │          │          │     Период для начисления     │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │  Код      │    Код    │  Код      │            │   Дата   │   Дата   │  Дата    │           процентов           │     Начисленный процентный доход    │           Процентный расход         │           Погашаемые купоны         │      НКД при начале начисления      │    В предыдущем налоговом периоде   │\n" +
           "│Наименование ценных бумаг│      Эмитент       │   Номинал    │Процент│  сделки   │  покупки  │  прямого  │ Количество │  начала  │ окончания│последнего│                               │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │  РЕПО     │           │  РЕПО     │            │начисления│начисления│погашения ├──────────┬──────────┬─────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤\n" +
           "│                         │                    │              │       │  списания │           │           │            │          │          │ купона   │    с     │    по    │   дней  │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │\n" +
           "├─────────────────────────┼────────────────────┼──────────────┼───────┼───────────┼───────────┼───────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤\n" +
           "│           1             │          2         │       3      │   4   │     5     │    5.1    │     6     │      7     │    8     │    9     │    10    │    11    │    12    │    13   │        14        │        15        │        16        │        17        │        18        │        19        │        20        │        21        │        22        │        23        │\n" +
           "├─────────────────────────┼────────────────────┼──────────┬───┼───────┼───────────┼───────────┼───────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤",   

  Table3 = "┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n" +
           "│ 3. Куплено по обратному РЕПО и продано в обычной продаже                                                                                                                                                                                                                                                                                                                │\n" +
           "├─────────────────────────┬────────────────────┬──────────────┬───────┬─────────┬──────┬──────┬────────────┬──────────┬──────────┬──────────┬───────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤\n" +
           "│                         │                    │              │       │         │      │Код   │            │          │          │          │     Период для начисления     │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │   Код   │Код   │обрат-│            │   Дата   │   Дата   │  Дата    │           процентов           │     Начисленный процентный доход    │           Процентный расход         │           Погашаемые купоны         │      НКД при начале начисления      │    В предыдущем налоговом периоде   │\n" +
           "│Наименование ценных бумаг│      Эмитент       │   Номинал    │Процент│ продажи │покуп-│ного  │ Количество │  начала  │ окончания│последнего│                               │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │         │ки    │РЕПО  │            │начисления│начисления│погашения ├──────────┬──────────┬─────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤\n" +
           "│                         │                    │              │       │         │      │      │            │          │          │ купона   │    с     │    по    │   дней  │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │\n" +
           "├─────────────────────────┼────────────────────┼──────────────┼───────┼─────────┼──────┼──────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤\n" +
           "│           1             │          2         │       3      │   4   │    5    │  6   │   7  │      8     │    9     │    10    │    11    │    12    │    13    │    14   │        15        │        16        │        17        │        18        │        19        │        20        │        21        │        22        │        23        │        24        │\n" +
           "├─────────────────────────┼────────────────────┼──────────┬───┼───────┼─────────┼──────┼──────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤",
  Table4 = "┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n" +
           "│ 4. Продано по прямому РЕПО (ранее куплено в обратном РЕПО)                                                                                                                                                                                                                                                                                                              │\n" +
           "├─────────────────────────┬────────────────────┬──────────────┬───────┬───────────┬───────────┬────────────┬──────────┬──────────┬──────────┬───────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤\n" +
           "│                         │                    │              │       │           │           │            │          │          │          │     Период для начисления     │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │  Код      │ Код       │            │   Дата   │   Дата   │  Дата    │           процентов           │     Начисленный процентный доход    │           Процентный расход         │           Погашаемые купоны         │      НКД при начале начисления      │    В предыдущем налоговом периоде   │\n" +
           "│Наименование ценных бумаг│      Эмитент       │   Номинал    │Процент│  прямого  │ покупки   │ Количество │  начала  │ окончания│последнего│                               │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │  РЕПО     │           │            │начисления│начисления│погашения ├──────────┬──────────┬─────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤\n" +
           "│                         │                    │              │       │           │           │            │          │          │ купона   │    с     │    по    │   дней  │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │\n" +
           "├─────────────────────────┼────────────────────┼──────────────┼───────┼───────────┼───────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤\n" +
           "│           1             │          2         │       3      │   4   │     5     │     6     │      7     │    8     │    9     │    10    │    11    │    12    │    13   │        14        │        15        │        16        │        17        │        18        │        19        │        20        │        21        │        22        │        23        │\n" +
           "├─────────────────────────┼────────────────────┼──────────┬───┼───────┼───────────┼───────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤",
  Table5 = "┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n" +
           "│ 5. Куплено по обратному РЕПО                                                                                                                                                                                                                                                                                                                                            │\n" +
           "├─────────────────────────┬────────────────────┬──────────────┬───────┬───────────────────────┬────────────┬──────────┬──────────┬──────────┬───────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┤\n" +
           "│                         │                    │              │       │                       │            │          │          │          │     Период для начисления     │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │                       │            │   Дата   │   Дата   │  Дата    │           процентов           │     Начисленный процентный доход    │           Процентный расход         │           Погашаемые купоны         │      НКД при начале начисления      │    В предыдущем налоговом периоде   │\n" +
           "│Наименование ценных бумаг│      Эмитент       │   Номинал    │Процент│       Код сделки      │ Количество │  начала  │ окончания│последнего│                               │                                     │                                     │                                     │                                     │                                     │\n" +
           "│                         │                    │              │       │                       │            │начисления│начисления│погашения ├──────────┬──────────┬─────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤\n" +
           "│                         │                    │              │       │                       │            │          │          │ купона   │    с     │    по    │   дней  │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │        ВН        │        руб.      │\n" +
           "├─────────────────────────┼────────────────────┼──────────────┼───────┼───────────────────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤\n" +
           "│           1             │          2         │       3      │   4   │           5           │      6     │    7     │    8     │    9     │    10    │    11    │    12   │        13        │        14        │        15        │        16        │        17        │        18        │        19        │        20        │        21        │        22        │\n" +
           "├─────────────────────────┼────────────────────┼──────────┬───┼───────┼───────────────────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤";

PRIVATE VAR m_Report;

private class (TBaseReportData) SourceData(
                 _Department:integer,
                 _Period:integer, _Year:integer, _AvrIsGos:bool, 
                 _Bond_Kind:integer, _AvrIsNotGos:bool,
                 _CirculateInMarket:bool, _NotCirculateInMarket:bool,
                 _NominateInRUR:bool, _NotNominateInRUR:bool, _IsBackRepo:bool)

   var
      Department = _Department,                    /*Подразделение*/
      AvrIsGos = _AvrIsGos,                        /*Гос. ц/б*/
      Bond_Kind = IIF(_Bond_Kind <= 0, ALL_FI, _Bond_Kind), /*Вид облигации*/
      AvrIsNotGos = _AvrIsNotGos,                  /*Не гос. ц/б*/
      CirculateInMarket = _CirculateInMarket,      /*Обращается на ОРЦБ*/
      NotCirculateInMarket = _NotCirculateInMarket,/*Не обращаются на ОРЦБ*/
      NominateInRUR = _NominateInRUR,              /*Номинированные в RUR*/
      NotNominateInRUR = _NotNominateInRUR,        /*Номинированные в иностранной валюте*/
      IsBackRepo = _IsBackRepo,                    /*Расчет начисленич по обратному Репо*/
      BegDate:date,                                /*Дата начала налогового периода*/
      EndDate:date,                                /*Дата конца налогового  периода*/
      RepBegDate:date,                             /*Дата начала отчетного периода*/
      RepEndDate:date,                             /*Дата конца отчетного периода*/
      PeriodName:string,                           /*Наименование периода*/
      TablePartHeadWasPrint = false, 
      ReportRun = false,
      Year = _Year;

   /*параметры для проверки валидности сделок, вычисляются для каждой сделки*/
   var 
      BondKind, 
      EmiKind, 
      IsState, 
      IsMunic;
   var
      f14Sum,
      f16Sum,
      f18Sum,
      f20Sum,
      f22Sum;
   var 
      f14GlSum,
      f16GlSum,
      f18GlSum,
      f20GlSum,
      f22GlSum;
   var 
      iCount;
   var 
      PrevNumRep;

   macro Init()
     f14Sum = 0;
     f16Sum = 0;
     f18Sum = 0;
     f20Sum = 0;
     f22Sum = 0;

     f14GlSum = 0;
     f16GlSum = 0;
     f18GlSum = 0;
     f20GlSum = 0;
     f22GlSum = 0;

     iCount = 0;

     PrevNumRep = -1;
  end;

  /* Конструктор */
  initTBaseReportData( true );

  Period_GetInterval( _Period, _Year, @BegDate,    @EndDate,    true  ); /* налоговый период */
  Period_GetInterval( _Period, _Year, @RepBegDate, @RepEndDate, false ); /* отчетный период */
  PeriodName = PeriodName_GetMonthsAndQuart( _Period, _Year, true );

  Init();
end;

private macro PrintHeadReport(Data, IsGos, NumRep)
  var INN = "", KPP = "";
  var RegNum:string, RepName:string, BankName:string;

  SplitFullINN(ПолучитьКодСубъекта({OurBank}, PTCK_INN), INN, KPP);

  if(INN != "")
    INN = " ИНН " + INN;
  end;

  if(KPP != "")
    KPP = " КПП " + KPP;
  end;

  if(IsGos == true)
    RegNum = "8-1";
    RepName = "Доходы в виде начисленных процентов по нереализованным ценным бумагам (государственные и муниципальные ценные бумаги)";
  else
    RegNum = "8-2";
    RepName = "Доходы в виде начисленных процентов по нереализованным ценным бумагам (кроме государственных и муниципальных ценных бумаг)";
  end;

  BankName = GetPartyFullNameByID( {OurBank}, true ) + "  " + INN + KPP;

  m_Report.SetActiveSheet( string(NumRep) );

  m_Report.PrintFormatString( ReportHeader,
                              "N" + string(NumRep) + "_BankName:l", BankName,
                              "N" + string(NumRep) + "_RegNum:l", "Аналитический регистр налогового учета №" + RegNum,
                              "N" + string(NumRep) + "_RegName", RepName,
                              "N" + string(NumRep) + "_PeriodName", Data.PeriodName
                            );
end;

private macro PrintHeadGroup(Data, IsGos, head, NumRep)
  if( not Data.TablePartHeadWasPrint )

    if( (Data.PrevNumRep == -1) or (Data.PrevNumRep != NumRep) )
      if( Data.PrevNumRep != -1 )
        m_Report.EndTable();
      end;
      Data.PrevNumRep = NumRep;
    end;

    PrintHeadReport(Data, IsGos, NumRep);

    if  ( NumRep == 1 )
      m_Report.RegisterTable( "N1_MainTable", Table1,
                              "N1_SecName",
                              "N1_IssuerName",
                              "N1_Nominal",
                              "N1_NominalCUR",
                              "N1_Percent",
                              "N1_BuyDealCode",
                              "N1_REPODealCode",
                              "N1_SaleDealCode",
                              "N1_Amount",
                              "N1_BegDate",
                              "N1_EndDate",
                              "N1_LastCoupDate",
                              "N1_PercBegDate",
                              "N1_PercEndDate",
                              "N1_PercDay",
                              "N1_NKDcur",
                              "N1_NKDrur",
                              "N1_PercOutlayCUR",
                              "N1_PercOutlayRUR",
                              "N1_DrawCoupCUR",
                              "N1_DrawCoupRUR",
                              "N1_NKDbegCUR",
                              "N1_NKDendRUR",
                              "N1_NKDprevCUR",
                              "N1_NKDprevRUR");      

    elif( NumRep == 2 )
      m_Report.RegisterTable( "N2_MainTable", Table2,
                              "N2_SecName",
                              "N2_IssuerName",
                              "N2_Nominal",
                              "N2_NominalCUR",
                              "N2_Percent",
                              "N2_REPOSaleCode",
                              "N2_BuyDealCode",
                              "N2_REPODealCode",
                              "N2_Amount",
                              "N2_BegDate",
                              "N2_EndDate",
                              "N2_LastCoupDate",
                              "N2_PercBegDate",
                              "N2_PercEndDate",
                              "N2_PercDay",
                              "N2_NKDcur",
                              "N2_NKDrur",
                              "N2_PercOutlayCUR",
                              "N2_PercOutlayRUR",
                              "N2_DrawCoupCUR",
                              "N2_DrawCoupRUR",
                              "N2_NKDbegCUR",
                              "N2_NKDendRUR",
                              "N2_NKDprevCUR",
                              "N2_NKDprevRUR");      
    elif( NumRep == 3 )
      m_Report.RegisterTable( "N3_MainTable", Table3,
                              "N3_SecName",
                              "N3_IssuerName",
                              "N3_Nominal",
                              "N3_NominalCUR",
                              "N3_Percent",
                              "N3_SaleDealCode",
                              "N3_BuyDealCode",
                              "N3_REPODealCode",
                              "N3_Amount",
                              "N3_BegDate",
                              "N3_EndDate",
                              "N3_LastCoupDate",
                              "N3_PercBegDate",
                              "N3_PercEndDate",
                              "N3_PercDay",
                              "N3_NKDcur",
                              "N3_NKDrur",
                              "N3_PercOutlayCUR",
                              "N3_PercOutlayRUR",
                              "N3_DrawCoupCUR",
                              "N3_DrawCoupRUR",
                              "N3_NKDbegCUR",
                              "N3_NKDendRUR",
                              "N3_NKDprevCUR",
                              "N3_NKDprevRUR");      
    elif( NumRep == 4 )
      m_Report.RegisterTable( "N4_MainTable", Table4,
                              "N4_SecName",
                              "N4_IssuerName",
                              "N4_Nominal",
                              "N4_NominalCUR",
                              "N4_Percent",
                              "N4_DRepoDealCode",
                              "N4_ORepoDealCode",
                              "N4_Amount",
                              "N4_BegDate",
                              "N4_EndDate",
                              "N4_LastCoupDate",
                              "N4_PercBegDate",
                              "N4_PercEndDate",
                              "N4_PercDay",
                              "N4_NKDcur",
                              "N4_NKDrur",
                              "N4_PercOutlayCUR",
                              "N4_PercOutlayRUR",
                              "N4_DrawCoupCUR",
                              "N4_DrawCoupRUR",
                              "N4_NKDbegCUR",
                              "N4_NKDendRUR",
                              "N4_NKDprevCUR",
                              "N4_NKDprevRUR");      
    elif( NumRep == 5 )
      m_Report.RegisterTable( "N5_MainTable", Table5,
                              "N5_SecName",
                              "N5_IssuerName",
                              "N5_Nominal",
                              "N5_NominalCUR",
                              "N5_Percent",
                              "N5_DealCode",
                              "N5_Amount",
                              "N5_BegDate",
                              "N5_EndDate",
                              "N5_LastCoupDate",
                              "N5_PercBegDate",
                              "N5_PercEndDate",
                              "N5_PercDay",
                              "N5_NKDcur",
                              "N5_NKDrur",
                              "N5_PercOutlayCUR",
                              "N5_PercOutlayRUR",
                              "N5_DrawCoupCUR",
                              "N5_DrawCoupRUR",
                              "N5_NKDbegCUR",
                              "N5_NKDendRUR",
                              "N5_NKDprevCUR",
                              "N5_NKDprevRUR");      
    end;

    Data.TablePartHeadWasPrint = true;
  end;
end;

private macro PrintTableLine( RepNum, Data, IsGos,
                              f01,f02,f031,f032,f04,f05_1,f05_2,f05_3,f06,f07,f08,f09,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22 )
  if  ( RepNum == 1 )
    PrintHeadGroup(Data, IsGos, "1. Обычные покупки", RepNum);
    m_Report.PrintTableLine( "N1_SecName",       f01,    null,
                             "N1_IssuerName",    f02,    null,
                             "N1_Nominal",       f031,   null,
                             "N1_NominalCUR",    f032,   null,
                             "N1_Percent",       f04,    null,
                             "N1_BuyDealCode",   f05_1,  null,
                             "N1_REPODealCode",  f05_2,  null,
                             "N1_SaleDealCode",  f05_3,  null,
                             "N1_Amount",        f06,    null,
                             "N1_BegDate",       f07,    null,
                             "N1_EndDate",       f08,    null,
                             "N1_LastCoupDate",  f09,    null,
                             "N1_PercBegDate",   f10,    null,
                             "N1_PercEndDate",   f11,    null,
                             "N1_PercDay",       f12,    null,
                             "N1_NKDcur",        f13,    null,
                             "N1_NKDrur",        f14,    null,
                             "N1_PercOutlayCUR", f15,    null,
                             "N1_PercOutlayRUR", f16,    null,
                             "N1_DrawCoupCUR",   f17,    null,
                             "N1_DrawCoupRUR",   f18,    null,
                             "N1_NKDbegCUR",     f19,    null,
                             "N1_NKDendRUR",     f20,    null,
                             "N1_NKDprevCUR",    f21,    null,
                             "N1_NKDprevRUR",    f22,    null
                           );
  elif( RepNum == 2 )
    PrintHeadGroup(Data, IsGos, "2. Продано по прямому РЕПО (ранее куплено в обычных покупках)", RepNum);

    m_Report.PrintTableLine( "N2_SecName",       f01,    null,
                             "N2_IssuerName",    f02,    null,
                             "N2_Nominal",       f031,   null,
                             "N2_NominalCUR",    f032,   null,
                             "N2_Percent",       f04,    null,
                             "N2_REPOSaleCode",  f05_1,  null,
                             "N2_BuyDealCode",   f05_2,  null,
                             "N2_REPODealCode",  f05_3,  null,
                             "N2_Amount",        f06,    null,
                             "N2_BegDate",       f07,    null,
                             "N2_EndDate",       f08,    null,
                             "N2_LastCoupDate",  f09,    null,
                             "N2_PercBegDate",   f10,    null,
                             "N2_PercEndDate",   f11,    null,
                             "N2_PercDay",       f12,    null,
                             "N2_NKDcur",        f13,    null,
                             "N2_NKDrur",        f14,    null,
                             "N2_PercOutlayCUR", f15,    null,
                             "N2_PercOutlayRUR", f16,    null,
                             "N2_DrawCoupCUR",   f17,    null,
                             "N2_DrawCoupRUR",   f18,    null,
                             "N2_NKDbegCUR",     f19,    null,
                             "N2_NKDendRUR",     f20,    null,
                             "N2_NKDprevCUR",    f21,    null,
                             "N2_NKDprevRUR",    f22,    null
                           );
  elif( RepNum == 3 )
    PrintHeadGroup(Data, IsGos, "3. Куплено по обратному РЕПО и продано в обычной продаже", RepNum);

    m_Report.PrintTableLine( "N3_SecName",       f01,    null,
                             "N3_IssuerName",    f02,    null,
                             "N3_Nominal",       f031,   null,
                             "N3_NominalCUR",    f032,   null,
                             "N3_Percent",       f04,    null,
                             "N3_SaleDealCode",  f05_1,  null,
                             "N3_BuyDealCode",   f05_2,  null,
                             "N3_REPODealCode",  f05_3,  null,
                             "N3_Amount",        f06,    null,
                             "N3_BegDate",       f07,    null,
                             "N3_EndDate",       f08,    null,
                             "N3_LastCoupDate",  f09,    null,
                             "N3_PercBegDate",   f10,    null,
                             "N3_PercEndDate",   f11,    null,
                             "N3_PercDay",       f12,    null,
                             "N3_NKDcur",        f13,    null,
                             "N3_NKDrur",        f14,    null,
                             "N3_PercOutlayCUR", f15,    null,
                             "N3_PercOutlayRUR", f16,    null,
                             "N3_DrawCoupCUR",   f17,    null,
                             "N3_DrawCoupRUR",   f18,    null,
                             "N3_NKDbegCUR",     f19,    null,
                             "N3_NKDendRUR",     f20,    null,
                             "N3_NKDprevCUR",    f21,    null,
                             "N3_NKDprevRUR",    f22,    null
                           );
  elif( RepNum == 4 )
    PrintHeadGroup(Data, IsGos, "4. Продано по прямому РЕПО (ранее куплено по обратному РЕПО)", RepNum);

    m_Report.PrintTableLine( "N4_SecName",       f01,    null,
                             "N4_IssuerName",    f02,    null,
                             "N4_Nominal",       f031,   null,
                             "N4_NominalCUR",    f032,   null,
                             "N4_Percent",       f04,    null,
                             "N4_DRepoDealCode", f05_1,  null,
                             "N4_ORepoDealCode", f05_2,  null,
                             "N4_Amount",        f06,    null,
                             "N4_BegDate",       f07,    null,
                             "N4_EndDate",       f08,    null,
                             "N4_LastCoupDate",  f09,    null,
                             "N4_PercBegDate",   f10,    null,
                             "N4_PercEndDate",   f11,    null,
                             "N4_PercDay",       f12,    null,
                             "N4_NKDcur",        f13,    null,
                             "N4_NKDrur",        f14,    null,
                             "N4_PercOutlayCUR", f15,    null,
                             "N4_PercOutlayRUR", f16,    null,
                             "N4_DrawCoupCUR",   f17,    null,
                             "N4_DrawCoupRUR",   f18,    null,
                             "N4_NKDbegCUR",     f19,    null,
                             "N4_NKDendRUR",     f20,    null,
                             "N4_NKDprevCUR",    f21,    null,
                             "N4_NKDprevRUR",    f22,    null
                           );
  elif( RepNum == 5 )
    PrintHeadGroup(Data, IsGos, "5. Куплено по обратному РЕПО", RepNum);

    m_Report.PrintTableLine( "N5_SecName",       f01,    null,
                             "N5_IssuerName",    f02,    null,
                             "N5_Nominal",       f031,   null,
                             "N5_NominalCUR",    f032,   null,
                             "N5_Percent",       f04,    null,
                             "N5_DealCode",      f05_1,  null,
                             "N5_Amount",        f06,    null,
                             "N5_BegDate",       f07,    null,
                             "N5_EndDate",       f08,    null,
                             "N5_LastCoupDate",  f09,    null,
                             "N5_PercBegDate",   f10,    null,
                             "N5_PercEndDate",   f11,    null,
                             "N5_PercDay",       f12,    null,
                             "N5_NKDcur",        f13,    null,
                             "N5_NKDrur",        f14,    null,
                             "N5_PercOutlayCUR", f15,    null,
                             "N5_PercOutlayRUR", f16,    null,
                             "N5_DrawCoupCUR",   f17,    null,
                             "N5_DrawCoupRUR",   f18,    null,
                             "N5_NKDbegCUR",     f19,    null,
                             "N5_NKDendRUR",     f20,    null,
                             "N5_NKDprevCUR",    f21,    null,
                             "N5_NKDprevRUR",    f22,    null
                            );
  end;
end;

private macro PrintFooter(Data)
end;

private macro GetFirstCouponByPeriod( FIID, DateBeg, WarntFirstDate:@variant, WarntDrawingDate:@variant )
  var sql, rsd;

  sql = RSDCommand(" SELECT * "
      + "   FROM "
      + "    (SELECT warnt.t_FirstDate, warnt.t_DrawingDate "
      + "       FROM dfiwarnts_dbt warnt "
      + "      WHERE warnt.t_FIID = ? and "
      + "            warnt.t_IsPartial <> 'X' and "
      + "            warnt.t_DrawingDate >= " + GetSQLDate(DateBeg)
      + "   ORDER BY warnt.t_DrawingDate ASC) "
      + "  WHERE ROWNUM = 1 ");

  sql.addParam( "", RSDBP_IN, FIID );
  sql.execute();

  rsd = TRsbDataSet(sql);
  if(rsd.MoveNext())
    WarntFirstDate  = SQL_ConvTypeDate(rsd.FirstDate);
    WarntDrawingDate = SQL_ConvTypeDate(rsd.DrawingDate);
    return true;
  end;

  return false;
end;

/* найти последний погашеаемй купон за период */
macro GetDrawingCoupon(Data, FIID, BegDate, EndDate, WarntDate)
  var sql, rsd;

  sql = RSDCommand(" SELECT * "
      + "   FROM "
      + "    (SELECT warnt.t_DrawingDate "
      + "       FROM dfiwarnts_dbt warnt "
      + "      WHERE warnt.t_FIID = ? and "
      + "            warnt.t_IsPartial <> 'X' and "
      + "            warnt.t_DrawingDate > ? and "
      + "            warnt.t_DrawingDate <= ? "
      + "   ORDER BY warnt.t_DrawingDate DESC) "
      + " WHERE ROWNUM = 1 ");

  sql.addParam( "", RSDBP_IN, FIID );
  sql.addParam( "", RSDBP_IN, BegDate );
  sql.addParam( "", RSDBP_IN, EndDate );
  sql.execute();
  
  rsd = TRsbDataSet(sql);
  if(rsd.MoveNext())
    if( ValType(WarntDate) != V_UNDEF )
      WarntDate = SQL_ConvTypeDate(rsd.DrawingDate);
      SetParm(4, WarntDate);
    end;
    return true;
  end;

  return false;
end;

macro GetCouponSumByPeriodInRUR( FIID, FaceValueFI, Amount, DateBeg, DateEnd )
  var sql, rsd;
  var Coupon,
      Sum = $0;

  sql = RSDCommand(" SELECT warnt.* "
                 + "   FROM dfiwarnts_dbt warnt "
                 + "  WHERE warnt.t_FIID = ? and "
                 + "        warnt.t_IsPartial != 'X' and "
                 + "        warnt.t_DrawingDate <= ? and "
                 + "        warnt.t_DrawingDate >= ? "
                 + " ORDER BY warnt.t_DrawingDate ASC ");

  sql.addParam( "", RSDBP_IN, FIID );
  sql.addParam( "", RSDBP_IN, DateEnd );
  sql.addParam( "", RSDBP_IN, DateBeg );
  sql.execute();

  rsd = TRsbDataSet(sql);
  while(rsd.MoveNext())
    if( (FaceValueFI != -1) and (FaceValueFI != NATCUR) )
      SmartConvertSum(Coupon, СуммаКупона(FIID, Amount, SQL_ConvTypeDate(rsd.DrawingDate)),
                      SQL_ConvTypeDate(rsd.DrawingDate), FaceValueFI, NATCUR, false);
    else
      Coupon = СуммаКупона(FIID, Amount, SQL_ConvTypeDate(rsd.DrawingDate));
    end;

    Sum = Sum + Coupon;
  end;

  return Sum;
end;

private macro PrintLine( Data,
                         IsState,    /*признак гос. ц/б */
                         NumPart,    /*номер печатаемого раздела*/
                         FIID,       /*ц/б*/
                         DealNum_1,  /*номер сделки 1*/
                         DealNum_2,  /*номер сделки 2*/
                         DealNum_3,  /*номер сделки 3*/
                         Amount,     /*кол-во*/
                         BegDate,    /*дата начала начисления*/
                         EndDate,    /*дата окончания начисления*/
                         SaleFinishDate, /* дата окончательной продажи */
                         BuyDate     /*дата исходной покупки*/
                       )
  var sql, rsd, sql2, rsd2;
  var FaceValue = 0, Percent;
  var DateBegPerc, DateEndPerc, 
      tWarntLastDate = date(0,0,0),
      WarntLastDate = date(0,0,0), 
      WarntFirstDate = date(0,0,0),
      WarntFirstFirstDate = date(0,0,0),
      WarntFirstLastDate = date(0,0,0),
      WarntLastPrevDate, PercNum = 0;
  var BegVal = $0, EndVal = $0, BegRub = $0, EndRub = $0;
  var NKD_Val = 0, NKD_rub = 0;
  var NKD_Val_beg = 0, NKD_rub_beg = 0;
  var NKD_Val_prev = 0, NKD_rub_prev = 0;
  var cup_Val = 0, cup_rub = 0;
  var q, year, tdate;
  var IsCalcNKD = false;

  FaceValue = GetFaceValue(FIID, IIF(EndDate != date(0,0,0), EndDate, Data.EndDate) );

  macro CalcPercent(_rsd)
    var sql, rsd;
    var FaceValue_, perc = 0;
   if( not FI_IsCouponAvoiriss(FIID) )
      if( _rsd.IncomeRate != 0 )
        perc = _rsd.IncomeRate;
      elif( FaceValue != 0 )
        perc = _rsd.IncomeVolume * 36500.0 / _rsd.FaceValue / (SQL_ConvTypeDate(_rsd.FinDrawingDate) - SQL_ConvTypeDate(_rsd.FinIssued));
      end;
   else
      sql = RSDCommand(" SELECT * "
          + "   FROM (SELECT (CASE WHEN warnt.t_IncomeRate <> 0 THEN warnt.t_IncomeRate "
          + "                      ELSE warnt.t_IncomeVolume END) CoupPerc, "
          + "        t_DrawingDate, t_FirstDate, t_IncomeRate, t_IncomeVolume "
          + "           FROM dfiwarnts_dbt warnt "
          + "          WHERE warnt.t_FIID = ? and "
          + "                warnt.t_IsPartial != 'X' and "
          + "                warnt.t_DrawingDate >= ? and "
          + "                warnt.t_FirstDate <= ? "
          + "       ORDER BY warnt.t_DrawingDate DESC) "
          + "  WHERE ROWNUM = 1 ");

      sql.addParam( "", RSDBP_IN, FIID );
      sql.addParam( "", RSDBP_IN, IIF(EndDate!=date(0,0,0), EndDate, Data.EndDate) );
      sql.addParam( "", RSDBP_IN, IIF(EndDate!=date(0,0,0), EndDate, Data.EndDate) );
      sql.execute();

      rsd = TRsbDataSet(sql);
      if(rsd.MoveNext())
        if(rsd.IncomeRate == 0)
          FaceValue_ = GetFaceValue(FIID, SQL_ConvTypeDate(rsd.FirstDate));

          perc = rsd.CoupPerc * 36500.0 / FaceValue_ /
                 (SQL_ConvTypeDate(rsd.DrawingDate) - SQL_ConvTypeDate(rsd.FirstDate) + 1);
        else
          perc = rsd.CoupPerc;
        end;
      end;
    end;

    return perc;
  end;

  sql = RSDCommand("SELECT fin.t_Name FinName, "
      + "       fin.t_FaceValueFI FaceValueFI, fin.t_AvoirKind, fin.t_DrawingDate FinDrawingDate, fin.t_Issued FinIssued, "
      + "       avr.t_NKDBase_Kind NKDBase_Kind, avr.t_IncomeRate, avr.t_IncomeVolume, avr.t_IncomeVolume, fin.t_FaceValue, "
      + "       finface.t_Ccy FaceName, "
      + "       isspt.t_ShortName IssName, "
      + "       (NVL((SELECT * "
      + "               FROM "
      + "                (SELECT warnt.t_DrawingDate "
      + "                   FROM dfiwarnts_dbt warnt "
      + "                  WHERE warnt.t_FIID = ? and "
      + "                        warnt.t_IsPartial != 'X' and "
      + "                        warnt.t_DrawingDate <= ? and "
      + "                        warnt.t_FirstDate <= ? \n"
      + "               ORDER BY warnt.t_DrawingDate DESC) "
      + "              WHERE ROWNUM = 1), TO_DATE('01-01-0001','DD-MM-YYYY'))) WarntLastPrevDate "
      + "  FROM dfininstr_dbt fin, dfininstr_dbt finface, davoiriss_dbt avr, dparty_dbt isspt "
      + " WHERE fin.t_FIID = ? and "
      + "       avr.t_FIID = fin.t_FIID and "
      + "       finface.t_FIID = fin.t_FaceValueFI and "
      + "       isspt.t_PartyID = (CASE WHEN fin.t_Issuer = ? THEN ? ELSE fin.t_Issuer END) ");

  sql.addParam( "", RSDBP_IN, FIID );
  sql.addParam( "", RSDBP_IN, Data.BegDate-1 );
  sql.addParam( "", RSDBP_IN, Data.BegDate-1 );
  sql.addParam( "", RSDBP_IN, FIID );
  sql.addParam( "", RSDBP_IN, {OurBank} );
  sql.addParam( "", RSDBP_IN, {OurBank} );
  sql.execute();

  rsd = TRsbDataSet(sql);
  if(rsd.MoveNext())
    sql2 = RSDCommand(" SELECT * "
         + "   FROM "
         + "    (SELECT warnt.t_FirstDate, warnt.t_DrawingDate "
         + "       FROM dfiwarnts_dbt warnt "
         + "      WHERE warnt.t_FIID = ? and "
         + "            warnt.t_IsPartial != 'X' and "
         + "            warnt.t_DrawingDate <= ? and "
         + "            warnt.t_FirstDate <= ? and "
         + "            warnt.t_DrawingDate >= ? "
         + "   ORDER BY warnt.t_DrawingDate DESC) "
         + "  WHERE ROWNUM = 1 ");

    sql2.addParam( "", RSDBP_IN, FIID );
    sql2.addParam( "", RSDBP_IN, IIF(EndDate!=date(0,0,0), min(Data.RepEndDate, EndDate), Data.RepEndDate) );
    sql2.addParam( "", RSDBP_IN, IIF(EndDate!=date(0,0,0), min(Data.RepEndDate, EndDate), Data.RepEndDate) );
    sql2.addParam( "", RSDBP_IN, BegDate );
    sql2.execute();
    
    rsd2 = TRsbDataSet(sql2);
    if(rsd2.MoveNext())
      WarntFirstDate = SQL_ConvTypeDate(rsd2.FirstDate);
      if( (SQL_ConvTypeDate(rsd2.DrawingDate) >= BegDate) and 
          (SQL_ConvTypeDate(rsd2.DrawingDate) <= IIF(EndDate!=date(0,0,0), min(Data.RepEndDate, EndDate), Data.RepEndDate)) )
        WarntLastDate = SQL_ConvTypeDate(rsd2.DrawingDate);
      end;
    end;

    sql2 = RSDCommand(" SELECT * "
         + "   FROM "
         + "    (SELECT warnt.t_FirstDate, warnt.t_DrawingDate "
         + "       FROM dfiwarnts_dbt warnt "
         + "      WHERE warnt.t_FIID = ? and "
         + "            warnt.t_IsPartial != 'X' and "
         + "            warnt.t_DrawingDate <= ? and "
         + "            warnt.t_FirstDate <= ? and "
         + "            warnt.t_DrawingDate >= ? "
         + "   ORDER BY warnt.t_DrawingDate ASC) "
         + "  WHERE ROWNUM = 1 ");

    sql2.addParam( "", RSDBP_IN, FIID );
    sql2.addParam( "", RSDBP_IN, Data.EndDate ); 
    sql2.addParam( "", RSDBP_IN, Data.EndDate ); 
    sql2.addParam( "", RSDBP_IN, Data.BegDate ); 
   
    sql2.execute();

    rsd2 = TRsbDataSet(sql2);
    if(rsd2.MoveNext())
      WarntFirstFirstDate = SQL_ConvTypeDate(rsd2.FirstDate);
      WarntFirstLastDate = SQL_ConvTypeDate(rsd2.DrawingDate);
    end;

    WarntLastPrevDate = SQL_ConvTypeDate(rsd.WarntLastPrevDate);
    /* считаем период начисления процентов, дней в зависмости от базы */
    if( (NumPart==1) or (NumPart==5) )
      DateBegPerc = max(BegDate,WarntLastDate);
    elif( (NumPart==2) and IsState )
      DateBegPerc = BegDate;
    else
      DateBegPerc = BegDate;
    end;

    if( IsState or (NumPart==4) or (NumPart==5) )
      DateEndPerc = IIF(EndDate==date(0,0,0), Data.EndDate, min(EndDate,Data.EndDate) );
    else
      /* для вывода строк по 3-ему разделу исп. правила V3 */
      if( NumPart==3 ) 
        if( (EndDate == date(0,0,0)) or (EndDate > Data.RepEndDate) )
          DateEndPerc = Data.RepEndDate;
        elif( (EndDate >= Data.BegDate) and (EndDate <= Data.RepEndDate) )
          if( Date_InEqQuarter(BegDate, EndDate) )
            if( GetDrawingCoupon(Data, FIID, BegDate, EndDate) )
              DateEndPerc = WarntLastDate;
            else
              return false;
            end;
          elif( Date_GetQuarter(EndDate) == 1 )
            if( GetDrawingCoupon(Data, FIID, Data.BegDate, EndDate) )
              DateEndPerc = WarntLastDate;
            else
              return false;
            end;
          else
            if( GetDrawingCoupon(Data, FIID, Data.RepBegDate-1, EndDate) )
              DateEndPerc = WarntLastDate;
            else
              DateEndPerc = Data.RepBegDate-1;
            end;
          end;
        else
          return false;
        end;
      elif( (NumPart == 1) or (NumPart == 2) )
        /* Расчет DateEndPerc совмещен с проверкой по правилам V1 */
        if( (ValType(SaleFinishDate) != V_UNDEF) and (SaleFinishDate != date(0,0,0)) and
            (SaleFinishDate >= Data.BegDate) and (SaleFinishDate <= Data.RepEndDate) )
          if( Date_InEqQuarter(BuyDate, SaleFinishDate) )
            if( not GetDrawingCoupon(Data, FIID, BuyDate, SaleFinishDate, tWarntLastDate) )
              return false;
            elif( BegDate < tWarntLastDate )
              DateEndPerc = min(EndDate, tWarntLastDate);
            else
              return false;
            end;
          else
            q = Date_GetQuarter(SaleFinishDate);
            DateSplit(SaleFinishDate, null, null, year);
            if(   q == 1 )
              tdate = date(31,12,year-1);
            elif( q == 2 )
              tdate = date(31,03,year);
            elif( q == 3 )
              tdate = date(30,06,year);
            else
              tdate = date(30,09,year);
            end;

            if( q == 1 )
              if( not GetDrawingCoupon(Data, FIID, Data.BegDate, SaleFinishDate, tWarntLastDate) )
                return false;
              elif( BegDate < max(tWarntLastDate, tdate) )
                DateEndPerc = min(max(tWarntLastDate,tdate), EndDate);
              else
                return false;
              end;
            else 
              if( not GetDrawingCoupon(Data, FIID, BuyDate, SaleFinishDate, tWarntLastDate) ) 
                if( BegDate <= tdate )
                  if(NumPart != 2)
                     DateBegPerc =  IIF(WarntLastDate != date(0,0,0),WarntLastDate,BegDate);
                  end;
                  DateEndPerc = min(EndDate, tdate);
                else
                  return false;
                end;
              elif( BegDate <= max(tWarntLastDate, tdate) ) 
                DateEndPerc = min(max(tWarntLastDate,tdate), EndDate);
              else
                return false;
              end;
            end;
          end;
        elif( (ValType(SaleFinishDate) == V_UNDEF) or
              ((ValType(SaleFinishDate) != V_UNDEF) and (SaleFinishDate == date(0,0,0))) or
              ((ValType(SaleFinishDate) != V_UNDEF) and (SaleFinishDate > Data.RepEndDate)) )
          if(NumPart != 2) 
            DateBegPerc = max(BegDate, WarntLastDate);
          end;
          DateEndPerc = IIF(EndDate!=date(0,0,0), min(Data.RepEndDate, EndDate), Data.RepEndDate);
        else
          return false;
        end;
      end;
    end;

    if( DateEndPerc >= DateBegPerc )
      if( (rsd.NKDBase_Kind == _AVOIRISSNKDBASE_360_30)
          or (rsd.NKDBase_Kind == _AVOIRISSNKDBASE_365_30)
          or (rsd.NKDBase_Kind == _AVOIRISSNKDBASE_Cal_30)
          or (rsd.NKDBase_Kind == _AVOIRISSNKDBASE_360_30E) 
        )
        PercNum = NDays30Correct(DateBegPerc, DateEndPerc);
      else
        PercNum = DateEndPerc - DateBegPerc;
      end;
    end;

    Percent = CalcPercent(rsd);

    /* Вычисляем погашаемые купоны */
    if( DateEndPerc != date(0,0,0) )
      if( (NumPart == 1) and (DateEndPerc > Data.BegDate) )
        if (BegDate < Data.BegDate)
          cup_Val = GetCouponSumByPeriod       (FIID,                  Amount, Data.BegDate, DateEndPerc);
          if(rsd.FaceValueFI == NATCUR)
            cup_rub = cup_Val;
          else
            cup_rub = GetCouponSumByPeriodInRUR(FIID, rsd.FaceValueFI, Amount, Data.BegDate, DateEndPerc);
          end;
        else
          cup_Val = GetCouponSumByPeriod       (FIID,                  Amount, BegDate+1, DateEndPerc);
          if(rsd.FaceValueFI == NATCUR)
            cup_rub = cup_Val;
          else
            cup_rub = GetCouponSumByPeriodInRUR(FIID, rsd.FaceValueFI, Amount, BegDate+1, DateEndPerc);
          end;
        end;
        InitError();
      elif( (DateBegPerc != date(0,0,0)) and ((NumPart == 2) or (NumPart == 3) or (NumPart == 4)) )
        cup_Val = GetCouponSumByPeriod       (FIID,                  Amount, IIF(WarntLastDate!=Data.EndDate,DateBegPerc+1,BegDate), DateEndPerc);
        if(rsd.FaceValueFI == NATCUR)
          cup_rub = cup_Val;
        else
          cup_rub = GetCouponSumByPeriodInRUR(FIID, rsd.FaceValueFI, Amount, IIF(WarntLastDate!=Data.EndDate,DateBegPerc+1,BegDate), DateEndPerc);
        end;
        InitError();
      end
    end;

    /* НКД на начало начисления */
    if( cup_rub != 0 )
      if( NumPart == 1 )
        if(BegDate >= WarntFirstFirstDate) 
          NKD_Val_beg = НКД(FIID, money(Amount), BegDate);
          if(rsd.FaceValueFI == NATCUR)
            NKD_rub_beg = NKD_Val_beg;
          else
            SmartConvertSum(NKD_rub_beg, NKD_Val_beg, BegDate, rsd.FaceValueFI, NATCUR, false);
          end;
        end;
      elif( (NumPart == 2) or (NumPart == 3) or (NumPart == 4) )
        NKD_Val_beg = НКД(FIID, money(Amount), BegDate);
        if(rsd.FaceValueFI == NATCUR)
          NKD_rub_beg = NKD_Val_beg;
        else
          SmartConvertSum(NKD_rub_beg, NKD_Val_beg, BegDate, rsd.FaceValueFI, NATCUR, false);
        end;
      end;
    end;

    /* Вычисляем НКД */
    if( (NumPart == 1) or (NumPart == 5) )
      NKD_Val = НКД(FIID, money(Amount), DateEndPerc) - НКД(FIID, money(Amount), DateBegPerc);
    else
      NKD_Val = НКД(FIID, money(Amount), DateEndPerc) - НКД(FIID, money(Amount), DateBegPerc) + cup_Val;
    end;
    if(rsd.FaceValueFI == NATCUR)
      NKD_rub = NKD_Val;
    else
      IsCalcNKD = false;
      if( (NumPart == 1) or (NumPart == 5) )
        if( ((((EndDate != Date(0,0,0)) and (EndDate < Data.EndDate)) or (WarntLastDate != date(0,0,0)))) and
            ( ( (EndDate != Date(0,0,0)) and 
                (DateEndPerc != date(0,0,0)) and 
                (EndDate == DateEndPerc) and 
                (Not IsState) 
              ) or IsState 
            )
          )
          IsCalcNKD = true;
        end;
      else
        if( ((EndDate != Date(0,0,0)) and (EndDate < Data.EndDate)) or (cup_rub != 0) ) 
          IsCalcNKD = true;
        end;
      end;
      if( IsCalcNKD )
        SmartConvertSum(BegVal, НКД(FIID, money(Amount), DateBegPerc), DateBegPerc, rsd.FaceValueFI, NATCUR, false);
        SmartConvertSum(EndVal, НКД(FIID, money(Amount), DateEndPerc), DateEndPerc, rsd.FaceValueFI, NATCUR, false);
        if( (NumPart == 2) or (NumPart == 3) or (NumPart == 4) )
          NKD_rub = EndVal - BegVal + cup_rub;
        else
          NKD_rub = EndVal - BegVal;
        end;
      else
        SmartConvertSum(NKD_rub, NKD_Val, DateEndPerc, rsd.FaceValueFI, NATCUR, false);
      end;
    end;

    /* НКД в предыдущем налоговом периоде */
    if( NumPart == 1 )
      if( (BegDate != Date(0,0,0)) and (BegDate < Data.BegDate) )
        if( (DateEndPerc != Date(0,0,0)) and (DateEndPerc < Data.BegDate) )
          NKD_Val_prev = NKD_Val;
        else
          NKD_Val_prev = НКД(FIID, money(Amount), Data.BegDate-1) - НКД(FIID, money(Amount), max(BegDate,WarntLastPrevDate));
        end;
        if(rsd.FaceValueFI == NATCUR)
          NKD_rub_prev = NKD_Val_prev;
        else
          if( (DateEndPerc != Date(0,0,0)) and (DateEndPerc < Data.BegDate) )
            NKD_Rub_prev = NKD_Rub;
          else
            SmartConvertSum(NKD_rub_prev, NKD_Val_prev, Data.BegDate-1, rsd.FaceValueFI, NATCUR, false);
          end;
        end;
      end;
    elif((NumPart == 2) or (NumPart == 3) or (NumPart == 4))
      if( (DateBegPerc != Date(0,0,0)) and (DateBegPerc < Data.BegDate) )
        NKD_Val_prev = НКД(FIID, money(Amount), Data.BegDate-1) - НКД(FIID, money(Amount), DateBegPerc) + 
                       GetCouponSumByPeriod(FIID, Amount, DateBegPerc, Data.BegDate-1);
        if(rsd.FaceValueFI == NATCUR)
          NKD_rub_prev = NKD_Val_prev;
        else
          if( GetDrawingCoupon(Data, FIID, DateBegPerc, Data.BegDate-1) )
            SmartConvertSum(BegVal, НКД(FIID, money(Amount), DateBegPerc),    DateBegPerc,    rsd.FaceValueFI, NATCUR, false);
            SmartConvertSum(EndVal, НКД(FIID, money(Amount), Data.BegDate-1), Data.BegDate-1, rsd.FaceValueFI, NATCUR, false);

            NKD_rub_prev = GetCouponSumByPeriodInRUR(FIID, rsd.FaceValueFI, Amount, DateBegPerc, Data.BegDate-1);
            NKD_rub_prev = NKD_rub_prev + EndVal - BegVal;
          else
            SmartConvertSum(NKD_rub_prev, NKD_Val_prev, Data.BegDate-1, rsd.FaceValueFI, NATCUR, false);
          end;
        end;
      end;
    elif(NumPart == 5)
      if( (DateBegPerc != Date(0,0,0)) and (DateBegPerc < Data.BegDate) )
        NKD_Val_prev = НКД(FIID, money(Amount), Data.BegDate-1) - НКД(FIID, money(Amount), max(DateBegPerc,WarntLastPrevDate));
        if(rsd.FaceValueFI == NATCUR)
          NKD_rub_prev = NKD_Val_prev;
        else
          SmartConvertSum(NKD_rub_prev, NKD_Val_prev, Data.BegDate-1, rsd.FaceValueFI, NATCUR, false);
        end;
      end;
    end;


    PrintTableLine(NumPart, Data, IsState,
          /*   1 */ rsd.FinName,
          /*   2 */ rsd.IssName,
          /*   3 */ FaceValue,
          /*   3 */ rsd.FaceName,
          /*   4 */ Percent+"%",
          /* 5.1 */ string(DealNum_1),
          /* 5.2 */ string(DealNum_2),
          /* 5.3 */ string(DealNum_3),
          /*   6 */ Amount,
          /*   7 */ BegDate,
          /*   8 */ EndDate,
          /*   9 */ IIF(NumPart==1, IIF(WarntLastDate>BegDate,WarntLastDate,""), WarntLastDate),
          /*  10 */ DateBegPerc,
          /*  11 */ DateEndPerc,
          /*  12 */ PercNum,
          /*  13 */ IIF(NumPart!=3, NKD_Val, 0.0),
          /*  14 */ IIF(NumPart!=3, NKD_rub, 0.0),
          /*  15 */ IIF(NumPart==3, NKD_Val, 0.0),
          /*  16 */ IIF(NumPart==3, NKD_rub, 0.0),
          /*  17 */ IIF(NumPart<5, cup_Val, 0.0),
          /*  18 */ IIF(NumPart<5, cup_rub, 0.0),
          /*  19 */ IIF(NumPart<5, NKD_Val_beg, 0.0),
          /*  20 */ IIF(NumPart<5, NKD_rub_beg, 0.0),
          /*  21 */ NKD_Val_prev,
          /*  22 */ NKD_rub_prev
                  );

    if( NumPart!=3 )
      Data.f14Sum = Data.f14Sum + NKD_rub;
    else
      Data.f16Sum = Data.f16Sum + NKD_rub;
    end;
    if( NumPart!=5 )
      Data.f18Sum = Data.f18Sum + cup_rub;
      Data.f20Sum = Data.f20Sum + NKD_rub_beg;
    end;
    Data.f22Sum = Data.f22Sum + NKD_rub_prev;

    if( NumPart <= 3 )
      if( NumPart!=3 ) 
        Data.f14GlSum = Data.f14GlSum + NKD_rub;
      else
        Data.f16GlSum = Data.f16GlSum + NKD_rub;
      end;
      if( NumPart!=5 )
        Data.f18GlSum = Data.f18GlSum + cup_rub;
      end;  
      Data.f20GlSum = Data.f20GlSum + NKD_rub_beg;
      Data.f22GlSum = Data.f22GlSum + NKD_rub_prev;
    end;

    Data.ReportRun = true;
  end;

  return true;
end;

private macro PrintTotalLine( Data, IsState, 
                              NumPart /* номер печатаемого раздела */ )
  if( Data.TablePartHeadWasPrint )
    PrintTableLine(NumPart, Data, IsState,
          /*   1 */ "ИТОГО по " + NumPart + " разделу",
          /*   2 */ "",
          /*   3 */ "",
          /*   3 */ "",
          /*   4 */ "",
          /* 5.1 */ "",
          /* 5.2 */ "",
          /* 5.3 */ "",
          /*   6 */ "",
          /*   7 */ "",
          /*   8 */ "",
          /*   9 */ "",
          /*  10 */ "",
          /*  11 */ "",
          /*  12 */ "",
          /*  13 */ "",
          /*  14 */ Data.f14Sum,
          /*  15 */ "",
          /*  16 */ Data.f16Sum,
          /*  17 */ "",
          /*  18 */ Data.f18Sum,
          /*  19 */ "",
          /*  20 */ Data.f20Sum,
          /*  21 */ "",
          /*  22 */ Data.f22Sum
                  );
  end;

  Data.f14Sum = 0;
  Data.f16Sum = 0;
  Data.f18Sum = 0;
  Data.f20Sum = 0;
  Data.f22Sum = 0;
end;

private macro PrintGlobalTotalLine( Data, IsState, NumPart )
  if(Data.ReportRun)

    PrintTableLine(NumPart, Data, IsState,
          /*   1 */ "Итого",
          /*   2 */ "",
          /*   3 */ "",
          /*   3 */ "",
          /*   4 */ "",
          /* 5.1 */ "",
          /* 5.2 */ "",
          /* 5.3 */ "",
          /*   6 */ "",
          /*   7 */ "",
          /*   8 */ "",
          /*   9 */ "",
          /*  10 */ "",
          /*  11 */ "",
          /*  12 */ "",
          /*  13 */ "",
          /*  14 */ Data.f14GlSum,
          /*  15 */ "",
          /*  16 */ Data.f16GlSum,
          /*  17 */ "",
          /*  18 */ Data.f18GlSum,
          /*  19 */ "",
          /*  20 */ Data.f20GlSum,
          /*  21 */ "",
          /*  22 */ Data.f22GlSum
                  );
  end;

  Data.f14GlSum = 0;
  Data.f16GlSum = 0;
  Data.f18GlSum = 0;
  Data.f20GlSum = 0;
  Data.f22GlSum = 0;
end;

private macro ApplyFilterSQL( MainTableAlias, LegTableAlias, LegTableLeftJoin, Data, IsGos, FIID  )
  var sql = "";

  sql = sql
      + IIF( ValType(FIID) != V_UNDEF, " AND " + MainTableAlias + ".t_FIID = " + FIID, "" )
      + " AND RSB_Secur.SecurKind( fin.t_AvoirKind ) = " + string(AVOIRISSKIND_ORDINARY_BOND);
  
  if( Data.Department > 0 )
    if( not LegTableLeftJoin )
      sql = sql
          + " AND " + LegTableAlias + ".t_Department = " + Data.Department;
    else
      /* LegTableAlias может и не быть */
      sql = sql
          + " AND (" + LegTableAlias + ".t_Department = " + Data.Department 
          +      " OR " + LegTableAlias + ".t_Department IS NULL)"; /* а можно и просто "+" поставить */
    end;
  end;

  /*Проверяем в чем номинировалась наша бумажка*/
  if( (Data.NominateInRUR == true) and (Data.NotNominateInRUR == false) )
    sql = sql
        + " and fin.t_FaceValueFI = " + string(NATCUR);
  elif( (Data.NominateInRUR == false) and (Data.NotNominateInRUR == true) )
    sql = sql
        + " and fin.t_FaceValueFI <> " + string(NATCUR);
  end;


  /*"Обращается на ОРЦБ" или нет*/
  if( (Data.CirculateInMarket == true) and (Data.NotCirculateInMarket == true) )
    /* если установлены оба признака, то это значит все ц\б, и условия не накладываем */
  else
    if( (Data.CirculateInMarket == true) or (Data.NotCirculateInMarket == true) )
      sql = sql + " AND ";

      if( Data.NotCirculateInMarket == true )
        sql = sql + " NOT ";
      end;

      sql = sql
          + " Exists(SELECT attr.t_GroupID "
          +          " FROM dobjatcor_dbt attr "
          +         " WHERE attr.t_ObjectType = " + string(OBJTYPE_AVOIRISS)
          +           " AND attr.t_GroupID = " + string(OBJGROUP_CIRCINMARKET)
          +           " AND attr.t_Object = LPAD(fin.t_FIID, 10, '0') "
          +           " AND attr.t_General = CHR(88) "
          +           " AND attr.t_ValidToDate >= " + GetSQLDate(Data.RepEndDate) + " ) ";
    end;
  end;

  if (IsGos)
     sql = sql + " AND (RSB_FIInstr.FI_AvrKindsEQ(2, " + string(государственные) + ", fin.t_AvoirKind) = 1 or ";
     sql = sql + "      RSB_FIInstr.FI_AvrKindsEQ(2, " + string(муниципальные)   + ", fin.t_AvoirKind) = 1 ) ";
  else
     sql = sql + " AND RSB_FIInstr.FI_AvrKindsEQ(2, " + string(32) + ", fin.t_AvoirKind) = 1 "; // Корпоративные
  end;

  if (Data.Bond_Kind > 0)
     sql = sql + " AND RSB_FIInstr.FI_AvrKindsEQ(2, " + string(Data.Bond_Kind) + ", fin.t_AvoirKind) = 1 ";
  end;

  return sql;
end;

/* получить фактическую (или расчетную, если нет фактической) дату 
   поставки 2-й части сделки прямого/обратного РЕПО */
private macro GetRepoD2( IsBackRepo, RepoTableAlias, LegTableAlias )
  var sql;

  if( IsBackRepo )
    sql = " DECODE(" + RepoTableAlias + ".t_SaleDate, TO_DATE('01-01-0001','DD-MM-YYYY'), " + LegTableAlias + ".t_Maturity, " + RepoTableAlias + ".t_SaleDate) ";
  else
    sql = " DECODE(" + RepoTableAlias + ".t_BuyDate, TO_DATE('01-01-0001','DD-MM-YYYY'), " + LegTableAlias + ".t_Maturity, " + RepoTableAlias + ".t_BuyDate) ";
  end;

  return sql;
end;

private macro ПечатьОтчета(Data, IsState, FIID)
   var sql, rsd;

   /* Часть 1. Обычные покупки */ 
   sql = RSDCommand(" SELECT lot.t_FIID, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_SourceID),CHR(0)) SourceNum, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_BuyID),CHR(0)) BuyNum, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_SaleID),CHR(0)) SaleNum, "
       +        " rest.t_Amount, "
       +        " rest.t_BuyDate, "
       +        " rest.t_SaleDate, "
       +        " rest.t_DestDate, "
       +        " rest.t_SourceDate "
       +   " FROM dsctxrest_dbt rest, "
       +        " dsctxlot_dbt lot, "
       +        " dfininstr_dbt fin, "
       +        " ddl_tick_dbt dl "
       +  " WHERE rest.t_BuyDate <= ? "
       +    " AND (rest.t_SaleDate = TO_DATE('01-01-0001','DD-MM-YYYY') "
       +      " OR (rest.t_SaleDate >= ? AND rest.t_SaleDate >= rest.t_BuyDate) "
       +        " ) "
       +    " AND rest.t_Amount > 0 "
       +    " AND lot.t_ID = rest.t_SourceID "
       +    " AND lot.t_Type = ? "
       +    " AND fin.t_FIID = lot.t_FIID "
       +    " AND dl.t_DealID = lot.t_DealID "
       + ApplyFilterSQL( "rest", "dl", false, Data, IsState, FIID )
       + " ORDER BY rest.t_FIID, "
       +          " rest.t_SourceDate, "
       +          " SourceNum, BuyNum, SaleNum ");

   sql.addParam( "", RSDBP_IN, Data.RepEndDate );
   sql.addParam( "", RSDBP_IN, Data.BegDate );
   sql.addParam( "", RSDBP_IN, TXLOTS_BUY );
   sql.execute();

   rsd = TRsbDataSet(sql);
   Data.TablePartHeadWasPrint = false;

   while(rsd.MoveNext())
     PrintLine( Data,
                IsState,
                1, 
                Int(rsd.t_FIID),
                rsd.SourceNum,
                rsd.BuyNum,
                rsd.SaleNum ,
                Money(rsd.Amount),
                date(rsd.BuyDate),
                date(rsd.SaleDate),
                date(rsd.DestDate),
                date(rsd.SourceDate) );

     UseProgress(Data.iCount = Data.iCount + 1);
   end;
   if( Data.TablePartHeadWasPrint )
     PrintTotalLine(Data, IsState, 1);
   end;

   /* Часть 2. Продано по прямому репо (ранее куплено в обычных покупках) */
   Data.TablePartHeadWasPrint = false;
   sql = RSDCommand(" SELECT rest.t_FIID, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_SaleID),CHR(0)) SaleNum, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_SourceID),CHR(0)) SourceNum, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_Lot2ID),CHR(0)) DirRepo, "
       +        " ( " + GetRepoD2(false, "drepo", "leg") + ") legDate, "
       +        " rest.t_Amount, "
       +        " rest.t_SaleDate, "
       +        " rest.t_DestDate, "
       +        " rest.t_SourceDate "
       +   " FROM dsctxrest_dbt rest, "
       +        " dsctxlot_dbt drepo, "
       +        " dfininstr_dbt fin, "
       +        " ddl_tick_dbt dl, "
       +        " ddl_leg_dbt leg "
       +  " WHERE rest.t_Type IN (" + string(TXREST_B_DR) + ", " + 
                                      string(TXREST_DR_DR) + ") "
       +    " AND rest.t_SaleDate <= ? "
       +    " AND (rest.t_DestDate = TO_DATE('01-01-0001','DD-MM-YYYY') "
       +       " OR rest.t_DestDate >= ? ) "
       +    " AND drepo.t_ID = DECODE(rest.t_Lot2ID, 0, rest.t_SaleID, rest.t_Lot2ID) "
       +    " AND drepo.t_Type = " + string(TXLOTS_REPO)
       +    " AND " + GetRepoD2(false, "drepo", "leg") + " >= ? "
       +    " AND rest.t_Amount > 0 "
       +    " AND fin.t_FIID = rest.t_FIID "
       +    " AND dl.t_DealID = drepo.t_DealID "
       +    " AND leg.t_DealID = drepo.t_DealID "
       +    " AND leg.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK)
       +    " AND leg.t_LegId = 0 "
       + ApplyFilterSQL( "rest", "dl", false, Data, IsState, FIID )
       + " ORDER BY rest.t_FIID, "
       +          " rest.t_SaleDate, "
       +          " SaleNum, SourceNum ");

   sql.addParam( "", RSDBP_IN, Data.RepEndDate );
   sql.addParam( "", RSDBP_IN, Data.BegDate );
   sql.addParam( "", RSDBP_IN, Data.BegDate );
   sql.execute();

   rsd = TRsbDataSet(sql);
   while(rsd.MoveNext())
     PrintLine(Data, 
               IsState,
               2, 
               Int(rsd.t_FIID),
               rsd.SaleNum,
               rsd.SourceNum,
               IIF(rsd.DirRepo != "", rsd.DirRepo, rsd.SaleNum),
               Money(rsd.Amount), 
               date(rsd.SaleDate),
               date(rsd.legDate),
               date(rsd.DestDate),
               date(rsd.SourceDate));

     UseProgress(Data.iCount = Data.iCount + 1);
   end;
   if( Data.TablePartHeadWasPrint )
     PrintTotalLine(Data, IsState, 2);
   end;

   /* Часть 3. Куплено по обратному РЕПО и продано в обычной продаже */
   sql = RSDCommand(" SELECT rest.t_FIID, "
       +        " lot.t_DealCode SaleNum, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_BuyID),CHR(0)) BuyNum, "
       +        " NVL((SELECT l.t_DealCode "
       +               " FROM dsctxlot_dbt l "
       +              " WHERE l.t_ID = rest.t_SourceID),CHR(0)) SourceNum, "
       +        " rest.t_Amount, "
       +        " rest.t_SaleDate, "
       +        " rest.t_BuyDate "
       +   " FROM dsctxrest_dbt rest, "
       +        " dsctxlot_dbt lot, "
       +        " dfininstr_dbt fin, "
       +        " ddl_tick_dbt dl "
       +  " WHERE rest.t_Type IN (" + string(TXREST_Open) + ", "
                                    + string(TXREST_Closed) + ") "
       +    " AND rest.t_SaleDate <= ? "
       +    " AND (rest.t_BuyDate = TO_DATE('01-01-0001','DD-MM-YYYY') "
       +      " OR rest.t_BuyDate >= ? ) "
       +    " AND rest.t_Amount > 0 "
       +    " AND lot.t_ID = rest.t_SaleID "
       +    " AND fin.t_FIID = rest.t_FIID "
       +    " AND dl.t_DealID(+) = lot.t_DealID "
       + ApplyFilterSQL( "rest", "dl", true, Data, IsState, FIID )
       + " ORDER BY rest.t_FIID, "
       +          " rest.t_SaleDate, "
       +          " SaleNum, BuyNum, SourceNum ");

   sql.addParam( "", RSDBP_IN, Data.RepEndDate );
   sql.addParam( "", RSDBP_IN, Data.BegDate );
   sql.execute();

   rsd = TRsbDataSet(sql);
   Data.TablePartHeadWasPrint = false;
   while(rsd.MoveNext()) 
     PrintLine(Data,
               IsState,
               3, 
               Int(rsd.t_FIID),
               rsd.SaleNum,
               rsd.BuyNum,
               rsd.SourceNum,
               Money(rsd.Amount), 
               date(rsd.SaleDate),
               date(rsd.BuyDate));

     UseProgress(Data.iCount = Data.iCount + 1);
   end;
   if( Data.TablePartHeadWasPrint )
     PrintTotalLine(Data, IsState, 3);
     /*PrintGlobalTotalLine(Data, IsState, 3);*/
   end;

   if( Data.IsBackRepo )
     /* Часть 4. Продано по прямому РЕПО (ранее куплено по Обратному РЕПО) */
     sql = RSDCommand(" SELECT dr.t_DealCode saleNum, "
         +        " orp.t_DealCode buyNum, "
         +        " dr.t_FIID, "
         +        " lnk.t_Amount, "
         +        " lnk.t_Date fDate, "
         +        " ( " + GetRepoD2(false, "dr", "drleg") + " ) drlegDate, "
         +        " ( " + GetRepoD2(true, "orp", "orleg") + " ) orlegDate "
         +   " FROM dsctxlnk_dbt lnk, "
         +        " dsctxlot_dbt dr, "
         +        " dsctxlot_dbt orp, "
         +        " dfininstr_dbt fin, "
         +        " ddl_tick_dbt ordl, "
         +        " ddl_leg_dbt orleg, "
         +        " ddl_tick_dbt drdl, "
         +        " ddl_leg_dbt drleg "
         +  " WHERE lnk.t_Type IN (" + string(TXLNK_DELREPO) + ", " + 
                                       string(TXLNK_SUBSTREPO) + ", " +
                                       string(TXLNK_SUBSTLOAN) + ") "
         +    " AND lnk.t_Date <= ? "
         +    " AND dr.t_ID = lnk.t_SaleID "
         +    " AND orp.t_ID = lnk.t_BuyID "
         +    " AND dr.t_Type = " + TXLOTS_REPO
         +    " AND orp.t_Type  = " + TXLOTS_BACKREPO

         +    " AND drdl.t_DealID = dr.t_DealID "
         +    " AND drleg.t_DealID = dr.t_DealID "
         +    " AND drleg.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK)
         +    " AND drleg.t_LegId = 0 "

         +    " AND ordl.t_DealID = orp.t_DealID "
         +    " AND orleg.t_DealID = orp.t_DealID "
         +    " AND orleg.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK)
         +    " AND orleg.t_LegId = 0 "

         +    " AND ( (" + GetRepoD2(false, "dr", "drleg") + " BETWEEN ? AND " + GetRepoD2(true, "orp", "orleg") + ") "
         +       " OR (" + GetRepoD2(false, "dr", "drleg") + " >= " + GetRepoD2(true, "orp", "orleg") 
         +       " AND " + GetRepoD2(true, "orp", "orleg") + " >= ? ) "
         +        " ) "

         +    " AND fin.t_FIID = dr.t_FIID "
         + ApplyFilterSQL( "dr", "ordl", false, Data, IsState, FIID )
         + " ORDER BY dr.t_FIID, "
         +          " dr.t_SaleDate, "
         +          " SaleNum, buyNum ");

     sql.addParam( "", RSDBP_IN, Data.RepEndDate );
     sql.addParam( "", RSDBP_IN, Data.BegDate );
     sql.addParam( "", RSDBP_IN, Data.BegDate );
     sql.execute();

     rsd = TRsbDataSet(sql);
     Data.TablePartHeadWasPrint = false;

     while(rsd.MoveNext())
       PrintLine(Data, 
                 IsState,
                 4, 
                 Int(rsd.t_FIID),
                 rsd.saleNum,
                 rsd.buyNum,
                 "",
                 Money(rsd.Amount), 
                 date(rsd.fDate),
                 min(date(rsd.drlegDate), date(rsd.orlegDate)));

       UseProgress(Data.iCount = Data.iCount + 1);
     end;
     if( Data.TablePartHeadWasPrint )
       PrintTotalLine(Data, IsState, 4);
     end;

     /* Часть 5. Куплено по обратному РЕПО */
     sql = RSDCommand(" SELECT buy.t_FIID, "
         +        " buy.t_Amount, "
         +        " buy.t_DealCode, "
         +        " buy.t_BuyDate, "
         +        " ( " + GetRepoD2(true, "buy", "leg") + ") legDate "
         +   " FROM dsctxlot_dbt buy, "
         +        " dfininstr_dbt fin, "
         +        " ddl_tick_dbt dl, "
         +        " ddl_leg_dbt leg "
         +  " WHERE buy.t_Type = " + string(TXLOTS_BACKREPO)
         +    " AND buy.t_BuyDate <= ? "
         +    " AND " + GetRepoD2(true, "buy", "leg") + " >= ? "
         +    " AND fin.t_FIID = buy.t_FIID "
         + ApplyFilterSQL( "buy", "dl", false, Data, IsState, FIID )
         +    " AND dl.t_DealID = buy.t_DealID "
         +    " AND leg.t_DealID = buy.t_DealID "
         +    " AND leg.t_LegKind = " + string(LEG_KIND_DL_TICK_BACK)
         +    " AND leg.t_LegId = 0 "
         + " ORDER BY buy.t_FIID, "
         +          " buy.t_BuyDate, "
         +          " buy.t_DealCode ");

     sql.addParam( "", RSDBP_IN, Data.RepEndDate );
     sql.addParam( "", RSDBP_IN, Data.BegDate );
     sql.execute();

     rsd = TRsbDataSet(sql);
     Data.TablePartHeadWasPrint = false;
     while(rsd.MoveNext())
       PrintLine(Data,
                 IsState,
                 5, 
                 Int(rsd.t_FIID),
                 rsd.t_DealCode,
                 "",
                 "",
                 Money(rsd.Amount), 
                 date(rsd.BuyDate),
                 date(rsd.legDate));

       UseProgress(Data.iCount = Data.iCount + 1);
     end;
     if( Data.TablePartHeadWasPrint )
       PrintTotalLine(Data, IsState, 5);
     end;
   end;

   if( Data.ReportRun )
     m_Report.EndTable();
   end;

end;

/*
private macro ПроверитьСоотвКатегВидОбл()
   record avoiriss(avoiriss);
   var
      fininstr = TBFile( "fininstr", "R", 2 ),
      EmiKind, BondKind, MakeReport = true;

   fininstr.Clear();
   fininstr.AddFilter(  "t_FI_Kind = " + string(FIKIND_AVOIRISS) );

   while( fininstr.Next )
     if( FI_IsBond(fininstr) ) /*Облигация*/
       if( ПолучитьФинИн( fininstr.rec.FIID, null, avoiriss) )      
         RunError("Отсутствует финансовый инструмент (FIID=", fininstr.rec.FIID ,")");
       end;
       /*Получим значение категории "Вид облигаций"*/
       BondKind = ПолучитьВидОблигации(avoiriss); 
       EmiKind = MC_GetKindIssuer(fininstr.rec.Issuer);
       if((EmiKind == 100) OR (EmiKind == 101) OR 
          (EmiKind == 102) OR (EmiKind == 103)) /*Орган гос власти или местного управления*/
         if(BondKind == 0) /*Не задана, а должна быть задана*/
           GetTrue(MakeReport, "Для облигации " + "\"" + fininstr.rec.Name + "\"" +" не задано значение категории \"Вид облигации\"| Продолжить выполнение отчета ?");
         elif(корпоративные(BondKind))
           GetTrue(MakeReport, "Для облигации " + "\"" + fininstr.rec.Name + "\"" +" значение категории \"Вид облигации\" | не должно быть \"Корпоративная\". Продолжить выполнение отчета ?");
         end;
         if(MakeReport == false)
           exit(1);
         end;
       end;
     end;
   end;

   return true;
end;
*/

macro ReportRun( Report:OBJECT,
                 Department:integer,
                 Period:integer, 
                 Year:integer,
                 AvrIsGos:bool, 
                 Bond_Kind:integer,
                 AvrIsNotGos:bool,
                 CirculateInMarket:bool,
                 NotCirculateInMarket:bool,
                 NominateInRUR:bool,
                 NotNominateInRUR:bool, 
                 AvrID:integer, 
                 IsBackRepo:bool)

  var Data = SourceData(Department, Period, Year, AvrIsGos, Bond_Kind, AvrIsNotGos,
                        CirculateInMarket, NotCirculateInMarket,
                        NominateInRUR, NotNominateInRUR, IsBackRepo);

  var rsd, sql, i = 0;
  var FIID = IIF(AvrID == ALL_FI, NULL, AvrID);

  m_Report = Report;

/*  ПроверитьСоотвКатегВидОбл();*/

  /* печатаем отчет */
  if(AvrIsGos == true)
    InitProgress( -1, "Отчет \"Доходы в виде начисленных процентов гос. и муниципальных ц\б\"", "Печать отчета 8-1" );

    ПечатьОтчета(Data, true, FIID);
    if(Data.ReportRun == true)
      PrintFooter(Data);
      Data.ReportRun = false;
    else
      PrintHeadGroup(Data, true, "", 1);
      msgbox("Нет данных, удовлетворяющих параметрам отчета");
    end;

    RemProgress();
  end;

  if(AvrIsNotGos == true)
    InitProgress( -1, "Отчет \"Доходы в виде начисленных процентов кроме гос. и муниципальных ц\б\"", "Печать отчета 8-2" );

    ПечатьОтчета(Data, false, FIID);
    if(Data.ReportRun == true)
      PrintFooter(Data);
    else
      PrintHeadGroup(Data, false, "", 1);
      msgbox("Нет данных, удовлетворяющих параметрам отчета");
    end;

    RemProgress();
  end;
end;
