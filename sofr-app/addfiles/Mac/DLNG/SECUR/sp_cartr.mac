/*
$Name:        sp_cartr.mac
$Module:      Ценные бумаги
$Description: Процедуры для проводок в операциях перемещения ценных бумаг
*/
IMPORT "sp_car.mac";

PRIVATE MACRO AvrIsShare( FI )
   return (FI_IsInvestmentShare(FI) OR FI_IsShare( FI ) );
END;

MACRO ПолучитьРолиФининструментовДляПереводов( FD, CatCode, FIRole, IsSource:bool, IsPD:bool, IsDD:bool, IsBPP:bool )

   var OperSubKind = FD.comm.rec.OperSubKind;

   FIRole(0) = null;
   FIRole(1) = null;
   FIRole(2) = null;

   if( (CatCode == "Наш портфель ц/б") or (CatCode == "Наш портфель ПКУ, ц/б") or (CatCode == "Ц/б, БПП") or (CatCode == "Ц/б, Корзина БПП") or (CatCode == "Уплаченный НКД, БПП") or (CatCode == "Уплач. НКД, Корзина БПП") )
      if( OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PUDP;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_RETIRE_TO_SALE )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PUDP;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TO_CONTROL )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = FIROLE_BA_TP;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BAINCONTR;
            FIRole(1) = FIROLE_BAINCONTR;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_FROM_CONTROL )
         if( IsSource )
            FIRole(0) = FIROLE_BAINCONTR;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            if( FD.comm_trans.rec.InPortofolio1 == KINDPORT_TRADE )
               FIRole(0) = FIROLE_BA_TP;
            else
               FIRole(0) = FIROLE_BA_PPR;
            end;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_UNRETIRE )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = FIROLE_BA_TP;
            FIRole(2) = FIROLE_BA_PUDP;
         else
            FIRole(0) = FIROLE_BAINPROMISSORY;
            FIRole(1) = FIROLE_BAINPROMISSORY;
            FIRole(2) = FIROLE_BAINPROMISSORY;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2129) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2014)
          )
         if( IsSource )
            FIRole(0) = FIROLE_BA_TP;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PUDP;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2129) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2014)
          )
         if( IsSource )
            FIRole(0) = FIROLE_BA_TP;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2129) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2014)
          )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PUDP;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      end; 
   elif( CatCode == "Начисл.ПДД, ц/б" )
      // IsSource = true - исходный портфель, иначе целевой.
      if( OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE )
         if( IsSource )
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_RETIRE_TO_SALE )
         if( IsSource )
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TO_CONTROL ) // это только для акций
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_FROM_CONTROL ) // это только для акций
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_UNRETIRE ) // "Начисл.ПДД, ц/б" открывается по исходному портфелю. IsSource не смотрим
         FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE  , IsDD, IsPD, IsBPP );
         FIRole(1) = GetFIRoleByPortfolio( KINDPORT_TRADE , IsDD, IsPD, IsBPP );
         FIRole(2) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP );
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2014))
         if( IsSource )
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_TRADE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2014))
         if( IsSource )
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_TRADE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2014))
         if( IsSource )
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP );
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      end; 
   elif( (CatCode == "Премия, ц/б") or (CatCode == "Уплаченный НКД") )
      // IsSource = true - исходный портфель, иначе целевой.
      if( OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE )
         if( IsSource )
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE, IsDD, IsPD, IsBPP, false, true );
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP, false, true );
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_RETIRE_TO_SALE )
         if( IsSource )
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP, false, true );
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE, IsDD, IsPD, IsBPP, false, true );
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TO_CONTROL ) // это только для акций
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_FROM_CONTROL ) // это только для акций
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_UNRETIRE ) // "Премия, ц/б" открывается по исходному портфелю. IsSource не смотрим
         FIRole(0) = GetFIRoleByPortfolio( KINDPORT_SALE  , IsDD, IsPD, IsBPP, false, true );
         FIRole(1) = GetFIRoleByPortfolio( KINDPORT_TRADE , IsDD, IsPD, IsBPP, false, true );
         FIRole(2) = GetFIRoleByPortfolio( KINDPORT_RETIRE, IsDD, IsPD, IsBPP, false, true );

      elif( OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2129)
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2129)
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2129)
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2014)
         if( IsSource )
            if(IsBPP)
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_TP_BPP_PAID, FIROLE_BONUS_TP_BPP);
            else
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_TP_PAID, FIROLE_BONUS_TP);
            end;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            if(IsBPP)
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PUDP_BPP_PAID, FIROLE_BONUS_PUDP_BPP);
            else
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PUDP_PAID, FIROLE_BONUS_PUDP);
            end;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2014)
         if( IsSource )
            if(IsBPP)
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_TP_BPP_PAID, FIROLE_BONUS_TP_BPP);
            else
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_TP_PAID, FIROLE_BONUS_TP);
            end;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            if(IsBPP)
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PPR_BPP_PAID, FIROLE_BONUS_PPR_BPP);
            else
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PPR_PAID, FIROLE_BONUS_PPR);
            end;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2014)
         if( IsSource )
            if(IsBPP)
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PPR_BPP_PAID, FIROLE_BONUS_PPR_BPP);
            else
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PPR_PAID, FIROLE_BONUS_PPR);
            end;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            if(IsBPP)
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PUDP_BPP_PAID, FIROLE_BONUS_PUDP_BPP);
            else
              FIRole(0) = IIF(CatCode == "Премия, ц/б", FIROLE_BONUS_PUDP_PAID, FIROLE_BONUS_PUDP);
            end;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      end; 
   elif( (CatCode == "-Переоценка, ц/б") OR ( CatCode == "+Переоценка, ц/б") OR ( CatCode == "-Переоценка, ц/б ССПУ_ЦБ") OR ( CatCode == "+Переоценка, ц/б ССПУ_ЦБ") OR ( CatCode == "-Переоценка, ц/б СССД_ЦБ") OR ( CatCode == "+Переоценка, ц/б СССД_ЦБ") )
      if( OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = null;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_RETIRE_TO_SALE )
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TO_CONTROL )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = FIROLE_BA_TP;
            FIRole(2) = null;
         else
            FIRole(0) = null;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_FROM_CONTROL )
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_UNRETIRE )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = FIROLE_BA_TP;
            FIRole(2) = null;
         else
            FIRole(0) = null;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2014))
         if( IsSource )
            FIRole(0) = FIROLE_BA_TP;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PUDP;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2014))
         if( IsSource )
            FIRole(0) = FIROLE_BA_TP;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2014) )
         if( IsSource )
            FIRole(0) = FIROLE_BA_PPR;
            FIRole(1) = null;
            FIRole(2) = null;
         else
            FIRole(0) = FIROLE_BA_PUDP;
            FIRole(1) = null;
            FIRole(2) = null;
         end;
      end; 

   elif( (CatCode == "-ПО ДК") OR ( CatCode == "+ПО ДК") OR ( CatCode == "-ПО ДК 2014") OR ( CatCode == "+ПО ДК 2014") )
      /*непортфельные*/
      FIRole(0) = FIROLE_BA_PPR;
      FIRole(1) = null;
      FIRole(2) = null;

   elif( CatCode == "%НДоход, ц/б" )
      if( OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE )
         FIRole(0) = FIROLE_BA;
         FIRole(1) = FIROLE_BA;
         FIRole(2) = FIROLE_BA;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_RETIRE_TO_SALE )
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_TO_CONTROL )
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_FROM_CONTROL )
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( OperSubKind == DLCOMM_OPERSUBKIND_UNRETIRE )
         FIRole(0) = FIROLE_BA;
         FIRole(1) = FIROLE_BA;
         FIRole(2) = FIROLE_BA;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2014))
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2014) )
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      elif( (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2129) OR (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2014) )
         FIRole(0) = null;
         FIRole(1) = null;
         FIRole(2) = null;
      end; 
                           
   elif( (CatCode == "-Маржа, ц/б") OR ( CatCode == "+Маржа, ц/б") )
      /*непортфельные*/
      FIRole(0) = FIROLE_BA;
      FIRole(1) = null;
      FIRole(2) = null;
      
   end;   
END;


PRIVATE MACRO ПолучитьСуммуПеревода( AccBuffOutCur, AccBuffInCur, Dir, Dat )

   if( Dir > 0 )
      return Abs(GetRestAccount( AccBuffOutCur, Dat ));
   else
      return Abs(GetRestAccount( AccBuffInCur, Dat ));
   end;
END;


/* CarryNums - требуемое кол-во проводок  */
/* Sums - массив с суммами проводок       */
MACRO ВыполнитьПроводкиДляПеревода( FD_comm, 
                                    doc, 
                                    FIID, 
                                    FIID_Dt, 
                                    FIID_Kt, 
                                    CatCodeOUT, 
                                    CatCodeIN, 
                                    ValueDate, 
                                    Sums, 
                                    Ground, 
                                    Dir, 
                                    CarryNums, 
                                    PairAccOUT, 
                                    PairAccIN,
                                    _IsSourceOut:bool,
                                    _IsSourceIn:bool, 
                                    _IsPD:bool, // признак - при открытии счетов учитывать, что процентный доход
                                    _IsDD:bool, // признак - при открытии счетов учитывать, что дисконтный доход
                                    _IsBPP:bool,// признак - при открытии счетов учитывать, что по счетам БПП
                                    FD_Deal
                                  )


   var FIRoleIN  = TArray(3), FIRoleOut  = TArray(3);
   var AcntIN    = TArray(3), AcntOut    = TArray(3); 
   var AccBuffIN = TArray(3), AccBuffOut = TArray(3); 
   var i; /*счетчик ролей*/
   var AcntOutCur = "", AcntInCur = "";
   var CarrySum:money = $0;
   var FD;

   //FD - это док-т, по которому открываются счета
   if (FD_Deal != null)
      FD = FD_Deal;
   else
      FD = FD_comm;
   end;

   // А вообще, флажки _IsPD, _IsDD, _IsBPP можно использовать как Flag1, Flag2, Flag3, тогда эту проверку прибить.
   if (_IsPD and _IsDD)
      msgbox("Ошибка при выполнении проводки. Нельзя открыть счет по процентному и дисконтному доходу одновременно");
      return 1;
   end;

   record AccBuffOutCur(account);
   record AccBuffInCur(account);

   //идем от счета источника
   if(_IsSourceOut)
     i = 0;
     ПолучитьРолиФининструментовДляПереводов( FD_comm, CatCodeOUT, FIRoleOUT, _IsSourceOut, _IsPD, _IsDD, _IsBPP );
     while( i < 3 )

        AccBuffOut(i) = TRecHandler("account.dbt");         
        AccBuffOut(i).Clear();

        if( FIRoleOUT( i ) != null )
           /*Списываем со счета старого портфеля - этот счет уже должен быть*/
           FD.IsExistAccount( CatCodeOUT, AcntOUT(i), true, FIRoleOUT(i), AccBuffOut(i), PairAccOUT ); 

        end;
        i = i + 1;
     end;

     i = 0;
     ПолучитьРолиФининструментовДляПереводов( FD_comm, CatCodeIN, FIRoleIN, _IsSourceIn, _IsPD, _IsDD, _IsBPP );
     while( i < 3 )

        AccBuffIn(i) = TRecHandler("account.dbt");         
        AccBuffIn(i).Clear();

        if( (FIRoleIN( i ) != null) and (AccBuffOut(i) != null) and (AccBuffOut( i ).rec.Account != "")) //нет смысла открывать счет, если нет счета источника

           /*Зачисляем на счет нового портфеля - этот счет здесь открываем*/
           if( not FD.OpenAccount( CatCodeIN, AcntIN(i), false, FIRoleIN(i), AccBuffIn(i), ValueDate, null, null, null, PairAccIn ) )
             return 1;
           end;

        end;
        i = i + 1;
     end;

   elif(_IsSourceIn)
     i = 0;
     ПолучитьРолиФининструментовДляПереводов( FD_comm, CatCodeIN, FIRoleIN, _IsSourceIn, _IsPD, _IsDD, _IsBPP );
     while( i < 3 )

        AccBuffIn(i) = TRecHandler("account.dbt");         
        AccBuffIn(i).Clear();

        if( FIRoleIN( i ) != null )
           /*Зачисляем на счет старого портфеля - этот счет уже должен быть*/
           FD.IsExistAccount( CatCodeIN, AcntIN(i), true, FIRoleIN(i), AccBuffIn(i), PairAccIn ); 
        end;
        i = i + 1;
     end;

     i = 0;
     ПолучитьРолиФининструментовДляПереводов( FD_comm, CatCodeOUT, FIRoleOUT, _IsSourceOut, _IsPD, _IsDD, _IsBPP );
     while( i < 3 )

        AccBuffOut(i) = TRecHandler("account.dbt");         
        AccBuffOut(i).Clear();

        if( (FIRoleOUT( i ) != null) and (AccBuffIn(i) != null) and (AccBuffIn( i ).rec.Account != "")) //нет смысла открывать счет, если нет счета источника
           /*Списываем со счета нового портфеля - этот счет здесь открываем*/
           if( not FD.OpenAccount( CatCodeOUT, AcntOUT(i), false, FIRoleOUT(i), AccBuffOut(i), ValueDate, null, null, null, PairAccOUT ) )
             return 1;
           end;
        end;
        i = i + 1;
     end;

   end;

   i = 0; 
   while( i < 3 )

      if( AcntOUT( i ) != null )
         AcntOutCur = AcntOUT(i);
         Copy( AccBuffOutCur, AccBuffOut( i ) );
      end;
      if( AcntIN( i ) != null )
         AcntInCur  = AcntIN(i);
         Copy( AccBuffInCur, AccBuffIN( i ) );
      end;
      /*один из счетов должен быть задан*/
      if( (AcntOUT( i ) != null) OR (AcntIN( i ) != null) )
         if( (i < CarryNums) AND (AcntOutCur != "") AND (AcntInCur != "") AND (AcntOutCur != AcntInCur) )

            if( (Sums == null) OR (Sums( i ) != 0) )

               if( Sums == null )
                 CarrySum = ПолучитьСуммуПеревода( AccBuffOutCur, AccBuffInCur, Dir, ValueDate );
               else
                 CarrySum = Sums( i );
               end;

               if( (CarrySum != NULL) AND (CarrySum != $0)) 

                  if(not ПроводкаПоКатегориямУчета( FD, 
                         AccBuffOutCur, AccBuffInCur, 
                         ValueDate,                   /* Дата */
                         AccBuffOutCur.Chapter,       /* Глава */
                         FIID,                        /* Валюта */
                         CarrySum,                    /* Сумма */
                         doc,                         /* Документ */
                         INPCARRY,                    /* Result_Carry */
                         " 1",                        /* Kind_Oper */
                         FD_comm.comm.rec.CommCode,        /* Numb_Document */
                         Ground,                      /* Ground */
                         null, null, null,
                         FIID_Dt, FIID_Kt
                        ))
                      return 1;
                  end;
               end;

            end;

         end;
      end;

      i = i + 1;
   end;

   return 0;
END;

MACRO IsTransferLocal( OperSubKind:integer )
   return ( (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE) OR 
            (OperSubKind == DLCOMM_OPERSUBKIND_RETIRE_TO_SALE) 
          );
END;

MACRO IsTransferGlobal( OperSubKind:integer )
   return ( (OperSubKind == DLCOMM_OPERSUBKIND_TO_CONTROL  ) OR 
            (OperSubKind == DLCOMM_OPERSUBKIND_FROM_CONTROL) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_UNRETIRE    ) 
          );
END;

/*Кризисные перемещения*/
MACRO IsTransferCris( OperSubKind:integer )
   return ( (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2129) OR 
            (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2129  ) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2129 ) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_RETIRE_2014) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_TRADE_TO_SALE_2014  ) OR
            (OperSubKind == DLCOMM_OPERSUBKIND_SALE_TO_RETIRE_2014 )   
          );
END;

private macro Перемещение_ПолучитьКурсФИ( FD, Type, _Date, CursDate, err )
   var RateDef = TRecHandler("ratedef");
   var CourceDbl1 = 0.0;
   var CourceDbl2 = 0.0;
   var CourceDbl = 0.0;
   var sql, rsd;
   var CursDate1 = date(0,0,0);
   var CursDate2 = date(0,0,0);

   ClearRecord(RateDef.rec);

   SetParm(3, date(0,0,0));
   SetParm(4, true);  

   sql = RSDCommand(" SELECT * "
                  + "   FROM dratedef_dbt "
                  + "  WHERE t_OtherFI = ? "
                  + "    AND t_Type = ? "
                  + "  ORDER BY t_IsDominant DESC "); /* первым будет основной */

   sql.addParam( "", RSDBP_IN, FD.fininstr.rec.FIID );
   sql.addParam( "", RSDBP_IN, Type );
   sql.execute();

   rsd = TRsbDataSet(sql);
   if( rsd.MoveNext() )
     RateDef = rsd.GetRecord();

     if( (ConvSumDbl(CourceDbl1, 1.0, _Date, FD.fininstr.rec.FIID, RateDef.FIID, false, Type, CursDate1) == true) and
         (ConvSumCrossDbl(CourceDbl2, 1.0, _Date, RateDef.FIID, FD.fininstr.rec.FaceValueFI, false, 0, CursDate2) == true) )
       CourceDbl = CourceDbl1 * CourceDbl2;
       SetParm(3, CursDate1);
       SetParm(4, false);
     end;
   end;

   return CourceDbl;
end;

macro Перемещение_ПолучитьКурсПереоценки(FD, CourceDate, _Course)
   var Dbl_Course = 0.0, SinceDate, erFlag, Course = $0;

   /*Определим курс вида "Текущая справедливая стоимость".*/
   Dbl_Course = GetRateOnDate( CourceDate, FD.fininstr.rec.FIID, FD.fininstr.rec.FaceValueFI, false, ПолучитьВидКурса(SP_RATETYPE_RightCost), erFlag, SinceDate );
   if( erFlag == true )
     Dbl_Course = Перемещение_ПолучитьКурсФИ( FD, ПолучитьВидКурса(SP_RATETYPE_RightCost), CourceDate, SinceDate, erFlag );
   end;

   if( erFlag == false )

      if (SinceDate == CourceDate)
         Course = ToMoney(Dbl_Course);
      else

         if( isOprMultiExec() == false )
            if( GetTrue( true, "Для ц/б " + FD.fininstr.rec.FI_Code + 
                      " не задан курс вида \"Справедливая стоимость\" за дату операции " + CourceDate + ". Взять последний введенный курс?" ) == false )
               return 1;
            else
               Course = ToMoney(Dbl_Course);
            end;

         else
            Course = ToMoney(Dbl_Course);
         end;
      end;
   end;

   if (erFlag)
      msgbox("Не могу получить значение курса вида \"Справедливая стоимость\" для ц/б " + 
             FD.fininstr.rec.FI_Code + " за дату " + string(CourceDate)
            );
      return 1;
   end;
   SetParm(2, Course);

   return 0;
end;