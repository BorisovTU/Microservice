 /*
 $Name: DefAcc60301.mac
 $Module: Ценные бумаги
 $Description: Расшифровка по счету 60302
 */
import "DLReport_h.mac", "dlquery.mac", "DefAcc60302_Form.mac", "dldlngfun.mac","SpRepFun.mac";

PRIVATE CONST POI_MODE = FALSE;
PRIVATE CONST PTCK_CFT = 101;
private const CHAPT1 = 1;
private var B1_MAIN = 0,  /*Основная ставка*/
            B1_15   = 1;  /*Повышенная ставка*/
PRIVATE VAR Progress = TProgressBar;

PRIVATE MACRO GetSumSumRefund():DOUBLE
   var cmd, DataSet;  
   cmd = DL_RSDCommand("SELECT NVL(SUM(t_TaxSum),0) Sum FROM drep60302_tmp " );
   DataSet = cmd.Execute();                                                                                
   if( DataSet.MoveNext() )
      return DataSet.Sum;
   end;
   return 0.0;
END;

PRIVATE MACRO GetSumSumApplication():DOUBLE
   var cmd, DataSet;  
   cmd = DL_RSDCommand("SELECT NVL(SUM(t_DeclareSum), 0) Sum FROM drep60302_tmp" );
   DataSet = cmd.Execute();                                                                                
   if( DataSet.MoveNext() )
      return DataSet.Sum;
   end;
   return 0.0;
END;

PRIVATE MACRO GetRest():DOUBLE
   var cmd, DataSet;  
   cmd = DL_RSDCommand("SELECT t_Rest FROM drep60302_tmp WHERE ROWNUM = 1" );
   DataSet = cmd.Execute();                                                                                
   if( DataSet.MoveNext() )
      return DataSet.Rest;
   end;
   return 0.0;
END;

CLASS (DL_CReportTemplate) DefAcc60302_Report()
   private var m_SheetName, m_KindRep, m_Prefix;
   private var m_RepDate;
   private var m_BlockNum  = 1;
   private var m_BlockName = "";
   private var m_categ = "";
   private var m_liter = "";
   private var m_account = "";

   private macro PrintMode()
      return DL_OUTREPORT_EXCEL;
   end;

   macro BeginReport()
      CreateTotalBook();
   end;

   macro fillTable(categ:string);

     var cmd, DataSet;  
     var cmdUpd;
     var ID:integer = 0;
     Progress.Init( 9, "Выполняется обработка данных", "Обработка данных"  );
     // Вставляем все проводки от даты отчета и раньше с нарастающим итогом  
     cmd = RSDCommand( " INSERT INTO DREP60302_TMP ( " +
                                    " T_ACCOUNT, " +               
                                    " T_DATETRN, " +               
                                    " T_NAME, " +                  
                                    " T_CONTRNUMBER, " +           
                                    " T_TAXSUM, " +                
                                    " T_ACCOUNT2, " +              
                                    " T_CLIENTID, " +
                                    " T_CONTRID, " +
                                    " T_ACCTRNID, " +
                                    " T_TOTAL, " +
                                    " T_REST, " +
                                    " T_ID) " +
                                    " WITH acc " +
                                    "      AS (SELECT DISTINCT doc.t_account, doc.t_Currency, doc.t_Chapter " +
                                    "                                    FROM dmcaccdoc_dbt doc, dmccateg_dbt cat " +
                                    "                                   WHERE     doc.t_catnum = cat.t_number " +
                                    "                                         AND doc.t_catid = cat.t_id " +
                                    "                                         AND cat.t_leveltype = 1 " +
                                    "                                         AND cat.t_code = ?  ) " +
                                    " SELECT acc.t_account, " +
                                    "        trn.t_date_carry, " +
                                    "        CHR(1), " +
                                    "        CHR(1), " +
                                    "        trn.t_sum_natcur, " +
                                    "        trn.T_ACCOUNT_RECEIVER, " +
                                    "        -1, " +
                                    "        0, " +
                                    "        trn.t_acctrnid, " +    
                                    "        coalesce(sum(trn.t_sum_natcur) over (order by  trn.t_Date_Carry DESC, trn.t_AccTrnID DESC " + 
                                    "            rows between unbounded preceding and current row), " + 
                                    "          0) as total, " + 
                                    "        ABS(rsb_account.restac(acc.t_Account, acc.t_Currency, ?, acc.t_Chapter, null)) Rest, " + 
                                    "        row_number() over(ORDER BY trn.t_Date_Carry DESC, trn.t_AccTrnID DESC) num " + 
                                    "   FROM dacctrn_dbt trn, acc " +
                                    "  WHERE trn.t_Chapter = 1  " +
                                    "        AND trn.t_State = 1  " +
                                    "        AND trn.T_ACCOUNT_PAYER = acc.t_account " +                                                                               
                                    "        AND trn.T_ACCOUNT_RECEIVER NOT LIKE ('60301%') " +
                                    "        AND trn.t_Date_Carry <= ? " +
                                    "  ORDER BY trn.t_Date_Carry DESC, trn.t_AccTrnID DESC "
                                    );
     
     cmd.addParam( "", RSDBP_IN, categ);
     cmd.addParam( "", RSDBP_IN, m_RepDate );
     cmd.addParam( "", RSDBP_IN, m_RepDate );
     SQL_Execute( cmd, "", false );
     Progress.Use();

     // поиск проводки, после которой не нужно выводить информацию
     cmd = DL_RSDCommand("SELECT MIN(T_ID) ID FROM drep60302_tmp WHERE T_TOTAL > T_REST" );
     DataSet = cmd.Execute();                                                                                
     if( DataSet.MoveNext() )
       ID =  DataSet.ID;
     end;

     // удаляем лишние проводки
     cmd = RSDCommand("DELETE FROM drep60302_tmp WHERE T_ID > ?" );
     cmd.addParam( "", RSDBP_IN, ID);
     SQL_Execute( cmd, "", false );
     Progress.Use();

     // обновляем данные по самой поздней проводке, частичое вхождение
     cmdUpd = RSDCommand( " Update  DREP60302_TMP rep SET T_TAXSUM = T_TAXSUM - (T_TOTAL-T_REST) WHERE T_ID = ?" );
     cmdUpd.addParam( "", RSDBP_IN, ID);
     cmdUpd.execute();
     Progress.Use();

     //обновление клиентов
     cmdUpd = RSDCommand( " Update  DREP60302_TMP rep SET (rep.t_clientID, rep.t_IIS, rep.t_ClientCode ) = (" +
                          " SELECT  Distinct  nptxop.t_Client, nptxop.t_IIS, NVL(obj.t_code, CHR(1)) " +
                          "   FROM  " +
                          "        doproper_dbt op, " +                                   
                          "        doprdocs_dbt odoc, " +
                          "        dnptxop_dbt nptxop, " +                                 
                          "        dobjcode_dbt obj " +                                 
                          "  WHERE" +  
                          "         odoc.t_ID_Operation = op.t_ID_Operation " +         
                          "        AND odoc.t_DocKind = 1 " +                              
                          "        AND odoc.t_acctrnid = rep.t_acctrnid " +               
                          "        AND op.t_DocKind = nptxop.t_dockind " +             
                          "        AND op.t_DocumentID = LPAD (nptxop.t_id, 34, '0') " +
                          "        AND obj.t_ObjectType(+) = " + string(OBJTYPE_PARTY) +
                          "        AND obj.t_CodeKind(+) = " + string(PTCK_CLIENT) +   // код клиента вида 1
                          "        AND nptxop.t_Client = obj.t_ObjectID(+) " 
                          "        AND ROWNUM = 1  ) "  );
     cmdUpd.execute();
     Progress.Use();

     //обновление ФИО
     cmdUpd = RSDCommand( " Update  DREP60302_TMP SET t_Name = ( SELECT pt.t_name from dparty_dbt pt Where pt.t_partyID = t_clientID) "  );
     cmdUpd.execute();
     Progress.Use();

     // обновление данных по ДБО
     cmdUpd = RSDCommand( "UPDATE DREP60302_TMP rep " +
                          "  SET (t_ContrNumber, t_contrid, t_EKK) = " +
                          "     (SELECT sf.t_number,  NVL(dl.t_dlcontrid, 0),  RSB_SECUR.SC_GetDlObjCodeOnDate(207, 1, dl.t_dlcontrid, ? ) EKK " +
                          "        FROM dsfcontr_dbt sf,ddlcontr_dbt dl " +
                          "       WHERE sf.t_partyID    = rep.t_clientID " +                                      
                          "         AND sf.t_ID =  dl.t_sfcontrid " +                                                    
                          "         AND sf.t_servkind = 0 " +                                                  
                          "         AND sf.t_servkindsub = 0 " +                                                 
                          "         AND dl.t_IIS = rep.t_IIS " +
                          "         AND sf.t_dateClose = TO_DATE('01,01,0001','DD.MM.YYYY') " +                                                  
                          "         AND ROWNUM = 1) "
                         );
     cmdUpd.addParam( "", RSDBP_IN, {curdate});
     
     cmdUpd.execute();
     Progress.Use();

     // тут не проверяем на открытые, т.к. открытые должны был обновиться выше 
     cmdUpd = RSDCommand( "UPDATE DREP60302_TMP rep " +
                          "  SET (t_ContrNumber, t_contrid, t_EKK) = " +
                          "     (SELECT sf.t_number || ' закрыт',  dl.t_dlcontrid, " +
                          "             NVL((SELECT q.t_Code " + 
                          "                    FROM (SELECT dlo.t_Code, dlo.t_BankDate, MAX(dlo.t_BankDate) OVER() as MaxBankDate " +
                          "                            FROM ddlobjcode_dbt dlo " +
                          "                           WHERE dlo.t_ObjectType = 207 " +
                          "                             AND dlo.t_ObjectID = dl.t_DlContrID " +
                          "                             AND dlo.t_CodeKind = 1 " +
                          "                         ) q "
                          "                   WHERE q.t_BankDate = q.MaxBankDate " +
                          "                     AND ROWNUM = 1 "
                          "                 ), CHR(1) ) EKK "
                          "        FROM dsfcontr_dbt sf,ddlcontr_dbt dl " +
                          "       WHERE sf.t_partyID    = rep.t_clientID " +                                      
                          "         AND sf.t_ID =  dl.t_sfcontrid " +                                                    
                          "         AND sf.t_servkind = 0 " +                                                  
                          "         AND sf.t_servkindsub = 0 " +                                                 
                          "         AND dl.t_IIS = rep.t_IIS " +
                          "         AND sf.t_dateClose = " + 
                          "               (SELECT MAX (sf1.t_dateClose) " +
                          "                  FROM dsfcontr_dbt sf1, ddlcontr_dbt dl1 " +
                          "                 WHERE     sf1.t_partyID = sf.t_partyID " +
                          "                       AND sf1.t_ID = dl1.t_sfcontrid " +
                          "                       AND sf1.t_servkind = sf.t_servkind " +
                          "                       AND sf1.t_servkindsub = sf.t_servkindsub " +
                          "                       AND dl1.t_IIS = dl.t_IIS) " +                                                 
                          "         AND ROWNUM = 1) " +
                          "  WHERE (rep.t_contrid IS NULL OR rep.t_contrid = 0)"
                         );
     cmdUpd.execute();
     Progress.Use();

     //обновляем данные по заявкам
     cmdUpd = RSDCommand( "UPDATE DREP60302_TMP rep " +
                          "   SET (t_declareid, t_declaredate, t_declaresum) =" +
                          "         (SELECT nptxop.t_ID, nptxop.t_OperDate, " + IIF(categ == "НДФЛ к возврату", "nptxop.t_TaxToPay", "nptxop.t_TaxDp") +
                          "            FROM dnptxop_dbt nptxop" +
                          "           WHERE     nptxop.t_DocKind = "+DL_RETREQ+" AND nptxop.t_Status IN ("+DLNPTXRETREQ_EXECUTED+") " +
                          "                 AND nptxop.t_Client = rep.t_ClientID" +
                          "                 AND nptxop.t_OperDate = (Select MAX(op.t_OperDate)  FROM dnptxop_dbt op" +
                          "                                 WHERE op.t_DocKind = "+DL_RETREQ+" AND op.t_Status IN ("+DLNPTXRETREQ_EXECUTED+") AND op.t_Client = rep.t_ClientID " +  
                          "                                   /*  AND op.t_OperDate<= rep.t_Datetrn */)" +
                          "                 AND ROWNUM = 1 )" 
                         );


     cmdUpd.addParam( "", RSDBP_IN, {OurBank});
     cmdUpd.execute();
     Progress.Remove();

   END;

   private macro PrintRep()
      var TmpDataDS, TmpDataQuery, TmpDataSelect;
      var cnt = 0, i = 0;
      var F04 = 0.0, F06 = 0.0;
 
      var ContrNumbers:string;
      record m_AccBuf(account);

      ClearGlobalTmp( "drep60302_tmp" );
      fillTable(m_categ);
      TmpDataQuery =   " SELECT t_account as account, "
                     + "        t_dateTrn as dateTrn, "
                     + "        t_EKK as EKK, "
                     + "        t_ClientCode as IDClient, "
                     + "        t_name as name, "
                     + "        t_contrNumber as contrNumber, "
                     + "        NVL(t_declareDate, TO_DATE('01.01.0001','DD.MM.YYYY') ) as declareDate, "
                     + "        NVL(t_declareSum, 0) as declareSum, "
                     + "        t_taxSum as taxSum "
                     + " FROM drep60302_tmp"
                     + " ORDER BY T_ID DESC"       
                     ;
      TmpDataSelect = DL_RSDCommand(TmpDataQuery);
      cnt = TmpDataSelect.GetCount();
      if(cnt > 0)
        F04 = GetSumSumApplication();
        F06 = GetRest();
        CopyAllSheetInTotalBook(m_SheetName, false, m_Prefix +"Header", 0, NULL, false);
        PrintFormatString(NULL, m_Prefix +"F0.4", F04,
                                m_Prefix +"F0.6", F06
                          );
        CopyAllSheetInTotalBook(m_SheetName, false, m_Prefix +"Itog", 0);
        RegisterTable( m_Prefix +"MainTable", NULL,
                       m_Prefix +"Client",
                       m_Prefix +"Contract",
                       m_Prefix +"EKK",
                       m_Prefix +"IdClient",
                       m_Prefix +"DateApplication",
                       m_Prefix +"SumApplication",
                       m_Prefix +"DateRefund",
                       m_Prefix +"SumRefund");
        InitProgress(cnt, "Отбор данных для протокола", "Отбор данных для протокола");
        TmpDataDS = TmpDataSelect.execute();
        while(TmpDataDS.MoveNext())
           PrintTableLine(m_Prefix +"Client",            TmpDataDS.name,                   NULL,
                          m_Prefix +"Contract",          TmpDataDS.contrNumber,            NULL,
                          m_Prefix +"EKK",               TmpDataDS.EKK,                    NULL,
                          m_Prefix +"IdClient",          TmpDataDS.IDClient,               NULL,
                          m_Prefix +"DateApplication",   date( TmpDataDS.declareDate),     NULL,
                          m_Prefix +"SumApplication",    TmpDataDS.declareSum,             NULL,
                          m_Prefix +"DateRefund",        date(TmpDataDS.dateTrn),          NULL,
                          m_Prefix +"SumRefund",         TmpDataDS.taxSum,                 NULL);
           UseProgress(i);
           i = i + 1;
        end;
        RemProgress();
        EndTable();
        CopyAllSheetInTotalBook(m_SheetName, false, GetTableRange(), 0, NULL, false);
      else
        PrintFormatString(m_SheetName, m_Prefix +"NoData", "Нет данных для отчета"); 
        CopyAllSheetInTotalBook(m_SheetName, false, m_Prefix +"NoData", 0);
      end;
      AddStandardFooter( m_Prefix );
      CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix +"Footer", 1 );
   end;

   private macro ExecuteReport()
      UseNewSheetInTotalBook();
      SetActiveSheet( m_SheetName );
      PrintFormatString(NULL, m_Prefix +"H1", m_RepDate);
      CopyAllSheetInTotalBook(m_SheetName, false, m_Prefix +"TotalHeader", 0);
      PrintRep();
   end;

   macro Create()
      m_RepDate = m_Form.BeginDate;

      if(m_Form.isTax13 == SET_CHAR)
         m_SheetName = "Основная ставка";
         m_KindRep = B1_MAIN;
         m_Prefix = "N1_";
         m_categ = "НДФЛ к возврату";
         ExecuteReport();
      end;
      if(m_Form.isTax15 == SET_CHAR)
         m_SheetName = "Повышенная ставка";
         m_KindRep = B1_15;
         m_Prefix = "N2_";
         m_categ = "НДФЛ к возврату_15%";
         ExecuteReport();
      end;;

   end;

   macro EndReport()
      SaveTotalBook();
   end;

  initDL_CReportTemplate(DefAcc60302_Panel(), "Report_DefAcc60302.xls", null, false, null, POI_MODE);
END;

DefAcc60302_Report().Run;
exit(1);
