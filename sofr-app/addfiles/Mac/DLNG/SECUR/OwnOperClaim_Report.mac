/*
$Name:        OwnOperClaim_Report.mac
$Module:      Ценные бумаги
$Description: Отчет "Отчет по собственным операциям в разрезе заявок"
*/

import "OwnOperClaim_Form.mac", "secinter.mac", SFInter, FIInter;

//Если вдруг проверка категории "Квалификация в качестве ценной бумаги" снова понадобится, то просто тут выставить false
PRIVATE VAR DISABLE_CHECK_GROUP28 = true; 

PRIVATE CLASS (DL_CReportTemplate) OwnOperClaim_Report()
   var m_Quartal;
   var m_Year;
   var m_BegDate, m_EndDate;
   var m_IsFormProtocol = UNSET_CHAR;
   var TotalSum = 0;
   var Executer = DepoExecuter({oper});

   PRIVATE MACRO Операционист()
       var RS = TRsbDataSet("SELECT person.t_Name " +
                            "  FROM dperson_dbt person " +
                            " WHERE person.t_Oper = " + string({oper})
                           );
  
       if( RS.MoveNext() )
          return RS.Name;
       end;
       return "";
   END;
  
   PRIVATE MACRO ДолжностьОперациониста()
       var RS = TRsbDataSet("SELECT officer.t_Post " +
                            "  FROM dofficer_dbt officer, dperson_dbt person " +
                            " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                            "       person.t_Oper = " + string({oper}) + " AND " +
                            "       officer.t_PersonID = person.t_PartyID "
                           );
  
       if( RS.MoveNext() )
          return RS.Post;
       end;
       return "Ответственный сотрудник";
   END;

   PRIVATE MACRO BeginReport()
      m_Quartal = m_Form.GetFieldValue(PNFLD_OWNOPER_PERIOD);
      m_Year = m_Form.GetFieldValue(PNFLD_OWNOPER_YEAR);
      m_IsFormProtocol = m_Form.GetFieldValue(PNFLD_OWNOPER_PROT);

      Period_GetInterval(m_Quartal+12, m_Year, @m_BegDate, @m_EndDate);
   END;

   PRIVATE MACRO EndReport()
   END;

   //Печать листа "Отчет"
   PRIVATE MACRO PrintReport()
      var i = 1;
      var nominal:NUMERIC = 0;
      var result;

      TotalSum = 0;

      SetActiveSheet("Отчет");

      PrintFormatString(NULL, "N2_D1", m_Quartal + " квартал",
                              "N2_Year", m_Year);

      RegisterTable("N2_MainTable", NULL, "N2_A1",
                                          "N2_A2",
                                          "N2_A3",
                                          "N2_A4",
                                          "N2_A5",
                                          "N2_A6",
                                          "N2_A7",
                                          "N2_A8",
                                          "N2_A9",
                                          "N2_A10",
                                          "N2_A11",
                                          "N2_A12",
                                          "N2_A13",
                                          "N2_A14",
                                          "N2_A15",
                                          "N2_A16");

      var ReportDataQuery =   " select tick.t_DealCodeTS, tick.t_DealDate,"
                            + "        (case when RSB_SECUR.IsBuy(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1"
                            + "              then 'Покупка' "
                            + "              when RSB_SECUR.IsSale(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1"
                            + "              then 'Продажа'"
                            + "         end"
                            + "        ) as t_DealType, "
                            + "        av.t_ISIN,"
                            + "        dl_leg.t_Principal,"
                            + "        fininstr.t_FaceValue,"
                            + "        fininstr.T_FIID,"
                            + "        (case when dl_leg.t_RelativePrice = chr(88)"
                            + "              then dl_leg.t_Price / 100.0 * fininstr.t_FaceValue"
                            + "              else dl_leg.t_Price"
                            + "         end"
                            + "        ) as t_Price,"
                            + "        curFI.t_CCY as t_CurCode,"
                            + "        RSI_RSB_FIINSTR.ConvSum(1, curFI.t_FIID, " + string(NATCUR) + ", tick.t_DealDate) as t_Cource,"
                            + "        dl_leg.t_Cost,"
                            + "        RSI_RSB_FIINSTR.ConvSum(dl_leg.t_Cost, curFI.t_FIID, " + string(NATCUR) + ", tick.t_DealDate) as t_CostRub,"
                            + "        obj.T_CODE AS t_MMVBCode"
                            + " from ddl_tick_dbt tick,"
                            + "      ddl_leg_dbt dl_leg,"
                            + "      davoiriss_dbt av,"
                            + "      dfininstr_dbt fininstr,"
                            + "      dfininstr_dbt curFI,"
                            + "      dparty_dbt issuer,"
                            + "      dobjatcor_dbt objatcor,"
                            + "      dobjcode_dbt obj"
                            + " where tick.t_ClientID = -1"
                            + "   and tick.t_BOfficeKind = " + string(DL_SECURITYDOC)
                            + "   and tick.t_DealStatus in (" + string(DL_CLOSED) + ", " + string(DL_READIED) + ")"
                            + "   and tick.t_DealDate between ? and ?"
                            + "   and RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 0"
                            + "   and (RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1"
                            + "        or RSB_SECUR.IsBroker(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1 "
                            + "           and tick.t_MarketID > 0)"
                            + "   and dl_leg.t_DealID = tick.t_DealID"
                            + "   and dl_leg.t_LegID = 0"
                            + "   and dl_leg.t_LegKind = 0"
                            + "   and (dl_leg.t_RejectDate > ? or dl_leg.t_RejectDate = to_date('01.01.0001', 'dd.mm.yyyy'))"
                            + "   and fininstr.t_FIID = dl_leg.t_PFI"
                            + "   and av.t_FIID = fininstr.t_FIID"
                            + "   and curFI.t_FIID = dl_leg.t_CFI"
                            + "   and issuer.t_PartyID = fininstr.t_Issuer";
      if (not DISABLE_CHECK_GROUP28)
         ReportDataQuery = ReportDataQuery  
                            + "   and ("
                            + "          ("
                            + "             issuer.t_NotResident = chr(88)"
                            + "             and ("
                            + "                    select nvl(objatcor.t_AttrID, 1)"
                            + "                    from dobjatcor_dbt objatcor"
                            + "                    where objatcor.t_Object (+) = LPAD(fininstr.t_FIID, 10, '0')"
                            + "                      and objatcor.t_ObjectType (+) = " + string(OBJTYPE_AVOIRISS)
                            + "                      and objatcor.t_GroupID (+) = 28"
                            + "                 ) = 1"
                            + "          )"
                            + "          or issuer.t_NotResident <> chr(88)"
                            + "       )";
      end;                      
      ReportDataQuery = ReportDataQuery 
                            + "   and objatcor.t_ObjectType = " + string(OBJTYPE_SECDEAL)
                            + "   and objatcor.t_Object = LPAD(tick.t_DealID, 34, '0')"
                            + "   and objatcor.t_GroupID = 52"
                            + "   and objatcor.t_AttrID = 2"
                            + "   and obj.t_AUTOKEY(+) = RSB_FIInstr.FI_GetObjCodeOnDate(fininstr.T_FIID, "+string(OBJTYPE_FININSTR)+", 11, ?)"
                            + " order by tick.t_DealDate";

      var ReportDataSelect = DL_RSDCommand(ReportDataQuery);
      ReportDataSelect.AddParam(m_BegDate);
      ReportDataSelect.AddParam(m_EndDate);
      ReportDataSelect.AddParam(m_EndDate);
      ReportDataSelect.AddParam({curdate});
      var ReportDS = ReportDataSelect.execute();

      while(ReportDS.MoveNext())
         result = FI_GetCurrentNominal(SQL_ConvTypeInteger(ReportDS.Fiid),SQL_ConvTypeDate(ReportDS.DealDate),nominal);
         nominal = IIF(result,NUMERIC(nominal),$0);
         PrintTableLine("N2_A1", i,                                   NULL,
                        "N2_A2", ReportDS.DealCodeTS,                 NULL,
                        "N2_A3", SQL_ConvTypeDate(ReportDS.DealDate), NULL,
                        "N2_A4", ReportDS.DealType,                   NULL,
                        "N2_A5", ReportDS.ISIN,                       NULL,
                        "N2_A51", ReportDS.MMVBCode,                  NULL,
                        "N2_A6", ReportDS.Principal,                  NULL,
                        "N2_A7", nominal,                             5,
                        "N2_A8", ReportDS.Price,                      NULL,
                        "N2_A9", ReportDS.CurCode,                    NULL,
                        "N2_A10", ReportDS.Cource,                    NULL,
                        "N2_A11", ReportDS.Cost,                      NULL,
                        "N2_A12", ReportDS.CostRub,                   NULL,
                        "N2_A13", "Поставка против платежа" ,         NULL,
                        "N2_A14", "Неттинг" ,                         NULL,
                        "N2_A15", "Платежное поручение" ,             NULL,
                        "N2_A16", "Нет" ,                             NULL);
         i = i + 1;
         TotalSum = TotalSum + ReportDS.CostRub;
      end;

      EndTable();
      PrintFormatString(NULL, "N2_A12_1", TotalSum);
      PrintFormatString(NULL, "N2_Executor", "Исполнитель: " + Executer.Name );
      PrintFormatString(NULL, "N2_Telephone", "Тел.: " + Executer.PhoneNumber );
      PrintFormatString(NULL, "N2_DateCreate", "Дата составления: " + string({curdate}) );
   END;

   //Печать листа "Итоговое значение"
   PRIVATE MACRO PrintTotalValue()
      SetActiveSheet("Итоговое значение");

      PrintFormatString(NULL, "N1_D1", m_Quartal + " квартал",
                              "N1_Year", m_Year);

      PrintFormatString(NULL, "N1_A1", TotalSum);

      /*PrintFormatString(NULL, "N1_ДолжностьОперациониста", ДолжностьОперациониста(),
                              "N1_Операционист", Операционист());*/

      PrintFormatString(NULL, "N1_Executor", "Исполнитель: " + Executer.Name );
      PrintFormatString(NULL, "N1_Telephone", "Тел.: " + Executer.PhoneNumber );
      PrintFormatString(NULL, "N1_DateCreate", "Дата составления: " + string({curdate}) );
   END;

   //Печать листа "Протокол"
   PRIVATE MACRO PrintProtocol()
      var CostRubSum = 0, i = 1, nominal, result;

      SetActiveSheet("Протокол");
      PrintFormatString(NULL, "N3_D1", m_Quartal + " квартал",
                              "N3_Year", m_Year);

      RegisterTable("N3_MainTable", NULL, "N3_A1", "N3_A2", "N3_A3", "N3_A4", "N3_A5", "N3_A6", "N3_A7", "N3_A8", "N3_A9", "N3_A10", "N3_A11", "N3_A12", "N3_A13",
                                          "N3_A14", "N3_A15", "N3_A16", "N3_A17", "N3_A18", "N3_A19", "N3_A20", "N3_A21", "N3_A22", "N3_A23", "N3_A24", "N3_A25",
                                          "N3_A26", "N3_A27", "N3_A28", "N3_A29");

      var ProtocolDataQuery =   " select tick.t_DealCodeTS, tick.t_DealDate,"
                              + "        market.t_ShortName as t_MarketName,"
                              + "        (case when tick.t_PortfolioID = " + string(KINDPORT_CLIENT)
                              + "              then 'Клиентская'"
                              + "              else 'Собственная'"
                              + "         end"
                              + "        ) as t_ClientOwnDeal,"
                              + "        fininstr.t_Name as t_AvoirName,"
                              + "        (case when RSB_SECUR.IsBuy(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1"
                              + "              then 'Покупка' "
                              + "              when RSB_SECUR.IsSale(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1"
                              + "              then 'Продажа'"
                              + "         end"
                              + "        ) as t_DealType, "
                              + "        (case when tick.t_CloseDate = to_date('01.01.0001', 'dd.mm.yyyy')"
                              + "              then 0"
                              + "              else tick.t_CloseDate - tick.t_DealDate"
                              + "         end"
                              + "        ) as t_Term,"
                              + "        av.t_ISIN,"
                              + "        dl_leg.t_Principal,"
                              + "        fininstr.t_FaceValue,"
                              + "        fininstr.t_Fiid,"
                              + "        (case when dl_leg.t_RelativePrice = chr(88)"
                              + "              then dl_leg.t_Price / 100.0 * fininstr.t_FaceValue"
                              + "              else dl_leg.t_Price"
                              + "         end"
                              + "        ) as t_Price,"
                              + "        curFI.t_CCY as t_CurCode,"
                              + "        RSI_RSB_FIINSTR.ConvSum(1, curFI.t_FIID, " + string(NATCUR) + ", tick.t_DealDate) as t_Cource,"
                              + "        dl_leg.t_Cost,"
                              + "        RSI_RSB_FIINSTR.ConvSum(dl_leg.t_Cost, curFI.t_FIID, " + string(NATCUR) + ", tick.t_DealDate) as t_CostRub,"
                              + "        dl_leg.t_TotalCost,"
                              + "        RSI_RSB_FIINSTR.ConvSum(dl_leg.t_TotalCost, curFI.t_FIID, " + string(NATCUR) + ", tick.t_DealDate) as t_TotalCostRub,"
                              + "        ("
                              + "           select nvl(sum(com.t_Sum), 0)"
                              + "           from ddlcomis_dbt com"
                              + "           where com.t_FeeType = " + string(SF_FEE_TYPE_PERIOD)
                              + "             and com.t_ComNumber = 60"
                              + "             and com.t_DocKind = tick.t_BOfficeKind"
                              + "             and com.t_DocID = tick.t_DealID"
                              + "        ) as t_ComSum,"
                              + "        ("
                              + "           select nvl(sum(comKlir.t_Sum), 0)"
                              + "           from ddlcomis_dbt comKlir"
                              + "           where comKlir.t_FeeType = " + string(SF_FEE_TYPE_PERIOD)
                              + "             and comKlir.t_ComNumber = 61"
                              + "             and comKlir.t_DocKind = tick.t_BOfficeKind"
                              + "             and comKlir.t_DocID = tick.t_DealID"
                              + "     ) as t_ComKlirSum,"
                              + "        avrkinds.t_Name as t_AvoirKind,"
                              + "        dl_leg.t_NKD,"
                              + "        RSI_RSB_FIINSTR.ConvSum(dl_leg.t_NKD, curFI.t_FIID, " + string(NATCUR) + ", tick.t_DealDate) as t_NKDRub,"
                              + "        obj.T_CODE AS t_MMVBCode"
                              + " from ddl_tick_dbt tick,"
                              + "      ddl_leg_dbt dl_leg,"
                              + "      davoiriss_dbt av,"
                              + "      dfininstr_dbt fininstr,"
                              + "      dfininstr_dbt curFI,"
                              + "      dparty_dbt issuer,"
                              + "      dparty_dbt market,"
                              + "      davrkinds_dbt avrkinds,"
                              + "      dobjatcor_dbt objatcor,"
                              + "      dobjcode_dbt obj"
                              + " where tick.t_ClientID = -1"
                              + "   and tick.t_BOfficeKind = " + string(DL_SECURITYDOC)
                              + "   and tick.t_DealStatus in (" + string(DL_CLOSED) + ", " + string(DL_READIED) + ")"
                              + "   and tick.t_DealDate between ? and ?"
                              + "   and RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 0"
                              + "   and (RSB_SECUR.IsExchange( RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1"
                              + "        or RSB_SECUR.IsBroker(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1 "
                              + "           and tick.t_MarketID > 0)"
                              + "   and dl_leg.t_DealID = tick.t_DealID"
                              + "   and dl_leg.t_LegID = 0"
                              + "   and dl_leg.t_LegKind = 0"
                              + "   and (dl_leg.t_RejectDate > ? or dl_leg.t_RejectDate = to_date('01.01.0001', 'dd.mm.yyyy'))"
                              + "   and fininstr.t_FIID = dl_leg.t_PFI"
                              + "   and av.t_FIID = fininstr.t_FIID"
                              + "   and curFI.t_FIID = dl_leg.t_CFI"
                              + "   and issuer.t_PartyID = fininstr.t_Issuer";
      if (not DISABLE_CHECK_GROUP28)
        ProtocolDataQuery = ProtocolDataQuery  
                              + "   and ("
                              + "          ("
                              + "             issuer.t_NotResident = chr(88)"
                              + "             and ("
                              + "                    select nvl(objatcor.t_AttrID, 1)"
                              + "                    from dobjatcor_dbt objatcor"
                              + "                    where objatcor.t_Object (+) = LPAD(fininstr.t_FIID, 10, '0')"
                              + "                      and objatcor.t_ObjectType (+) = " + string(OBJTYPE_AVOIRISS)
                              + "                      and objatcor.t_GroupID (+) = 28"
                              + "                 ) = 1"
                              + "          )"
                              + "          or issuer.t_NotResident <> chr(88)"
                              + "       )";
      end;                      
      ProtocolDataQuery = ProtocolDataQuery 
                              + "   and market.t_PartyID = tick.t_MarketID"
                              + "   and avrkinds.t_FI_KIND = fininstr.t_FI_KIND"
                              + "   and avrkinds.t_AvoirKind = fininstr.t_AvoirKind"
                              + "   and objatcor.t_ObjectType = " + string(OBJTYPE_SECDEAL)
                              + "   and objatcor.t_Object = LPAD(tick.t_DealID, 34, '0')"
                              + "   and objatcor.t_GroupID = 52"
                              + "   and objatcor.t_AttrID = 2"
                              + "   and obj.t_AUTOKEY(+) = RSB_FIInstr.FI_GetObjCodeOnDate(fininstr.T_FIID, "+string(OBJTYPE_FININSTR)+", 11, ?)"
                              + " order by tick.t_DealDate";

      var ProtocolDataSelect = DL_RSDCommand(ProtocolDataQuery);
      ProtocolDataSelect.AddParam(m_BegDate);
      ProtocolDataSelect.AddParam(m_EndDate);
      ProtocolDataSelect.AddParam(m_EndDate);
      ProtocolDataSelect.AddParam({curdate});

      var ProtocolDataSet = ProtocoldataSelect.execute();
      while(ProtocolDataSet.MoveNext())
         result = FI_GetCurrentNominal(SQL_ConvTypeInteger(ProtocolDataSet.Fiid),SQL_ConvTypeDate(ProtocolDataSet.DealDate),nominal);
         nominal = IIF(result,nominal,$0);
         PrintTableLine("N3_A1", i,                                          NULL,
                        "N3_A2", ProtocolDataSet.DealCodeTS,                 NULL,
                        "N3_A3", SQL_ConvTypeDate(ProtocolDataSet.DealDate), NULL,
                        "N3_A4", "Безадресная",                              NULL,
                        "N3_A5", ProtocolDataSet.MarketName,                 NULL,
                        "N3_A6", ProtocolDataSet.ClientOwnDeal,              NULL,
                        "N3_A7", ProtocolDataSet.AvoirName,                  NULL,
                        "N3_A8", ProtocolDataSet.ISIN,                       NULL,
                        "N3_A81", ProtocolDataSet.MMVBCode,                  NULL,
                        "N3_A9", "Купля-продажа",                            NULL,
                        "N3_A10", ProtocolDataSet.DealType,                  NULL,
                        "N3_A11", ProtocolDataSet.Term,                      NULL,
                        "N3_A12", nominal,                                   5,
                        "N3_A13", ProtocolDataSet.Price,                     NULL,
                        "N3_A14", ProtocolDataSet.Principal,                 NULL,
                        "N3_A15", ProtocolDataSet.CurCode,                   NULL,
                        "N3_A16", ProtocolDataSet.Cource,                    NULL,
                        "N3_A17", ProtocolDataSet.Cost,                      NULL,
                        "N3_A18", ProtocolDataSet.CostRub,                   NULL,
                        "N3_A19", ProtocolDataSet.TotalCost,                 NULL,
                        "N3_A20", ProtocolDataSet.TotalCostRub,              NULL,
                        "N3_A21", ProtocolDataSet.ComSum,                    NULL,
                        "N3_A22", ProtocolDataSet.ComKlirSum,                NULL,
                        "N3_A23", ProtocolDataSet.AvoirKind,                 NULL,
                        "N3_A24", ProtocolDataSet.NKD,                       NULL,
                        "N3_A25", ProtocolDataSet.NKDRub,                    NULL,
                        "N3_A26", "Поставка против платежа" ,                NULL,
                        "N3_A27", "Неттинг" ,                                NULL,
                        "N3_A28", "Платежное поручение" ,                    NULL,
                        "N3_A29", "Нет" ,                                    NULL);

         CostRubSum = CostRubSum + ProtocolDataSet.CostRub;
         i = i + 1;
      end;

      EndTable;
      PrintFormatString(NULL, "N3_A18_1", CostRubSum);
      PrintFormatString(NULL, "N3_Executor", "Исполнитель: " + Executer.Name );
      PrintFormatString(NULL, "N3_Telephone", "Тел.: " + Executer.PhoneNumber );
      PrintFormatString(NULL, "N3_DateCreate", "Дата составления: " + string({curdate}) );
   END;

   PRIVATE MACRO Create()
      PrintReport();
      PrintTotalValue();
      if(m_IsFormProtocol == SET_CHAR)
         PrintProtocol();
      end;
   END;

   initDL_CReportTemplate( OwnOperClaim_Panel(), "Report_OwnOperClaim.xls" );
   SetPrintMode(DL_OUTREPORT_EXCEL);
END;

macro ReportRun()
   DL_CallInsertStat(DL_OUTREPORT_EXCEL);
   OwnOperClaim_Report().Run();

   Exit(1);
end;
