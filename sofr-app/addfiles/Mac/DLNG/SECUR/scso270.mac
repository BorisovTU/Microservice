/*
$Name:        scso270.mac
$Module:      Ценные бумаги
$Description: Шаг исполнения обязательств
*/

import InsCarryDoc, "sp_car2.mac";
import "dl_check_mt300.mac"; //Simanov

private macro CheckConfirmStatus(DraftID, PlanerStart)//DAN
  const DraftKind = 8;
  var query, Select, Transport, Stat;
  var ConfNumber;
  var FactValueDate;
  var InstrStatus;
  var msg_txt;  

  if (valtype({curdate}) == v_undef)
    GetCmdLineParm("date", {curdate}, V_STRING);
  end;

  query = "begin\n ? := RSP_SECURITY.GetConfirmParams(?,?,?,?,?,?,?,?);\n end; ";

  Select = RSDCommand( query );

  Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );

  Select.AddParam("p_DraftKind", RSDBP_IN, DraftKind );
  Select.AddParam("p_DraftID", RSDBP_IN, DraftID );
  Select.AddParam("p_Number", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Date", RSDBP_OUT, V_DATE );
  Select.AddParam("p_TypeIn", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Status", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Reason", RSDBP_OUT, V_STRING );
  Select.AddParam("p_Comment", RSDBP_OUT, V_STRING );
  Select.Execute();

  ConfNumber    = SQL_ConvTypeStr(Select.value("p_Number"));
  FactValueDate = SQL_ConvTypeDate(Select.value("p_Date"));
  InstrStatus   = SQL_ConvTypeInteger(Select.value("p_Status"));

  if(SQL_ConvTypeStr(Select.value("p_TypeIn")) == "" and (SQL_ConvTypeInteger(Select.value("p_Stat")) != 0))
    msg_txt ="По сделке не получено входящее подтверждение. \nИсполнить шаг принудительно?" ;
  elif (SQL_ConvTypeInteger(Select.value("p_Stat")) != 0)
    msg_txt ="По сделке не получено входящее подтверждение MT" + SQL_ConvTypeStr(Select.value("p_TypeIn")) + ". \nИсполнить шаг принудительно?" ;  
  end;

  if(SQL_ConvTypeInteger(Select.value("p_Stat")) != 0)
     if(not PlanerStart)
       if(MsgBoxEx(msg_txt, MB_YES + MB_NO, IND_YES) == IND_YES )
         return 0;
       end;
     end;
    return 1;
  end;

    return 0;
end;

macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step)

  record deal(dl_tick);
  var    FD, dat, BalCost = $0, NKDConv = $0;
  var requestTimeout = 0, BOfficeKind = 0, DealID = 0, PFI = -1;
  var ОжиданиеЗапроса = false;
  var PlanerStart = false;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) ); 

  //16.01.20 Simanov. Если способ заключения сделки - "телефон" - должно быть сквитовано входящее подтверждение (МТ518)
  if (not Sec_check_kvit_mt (FD.tick.rec.DealID, FD.tick.rec.DealCode))
    return 1;
  end;
  
//DAN при запуске из планировщика определяем CURDATE  
  if (valtype({curdate}) == v_undef)
    GetCmdLineParm("date", {curdate}, V_STRING);
    PlanerStart = True;
  end;

  if( deal.BofficeKind == DL_SECURITYDOC )
     GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat );
  else /*погашение*/
     GetOprDate( FD.GetKindDate(DATE_DEALDATE), dat ); /*Дата погашения*/
  end;

  if( (dat > {curdate}) and (PlanerStart == false))
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  elif ((dat != {curdate}) and (PlanerStart != false))
    return 1;
  end;
/*dan вызывает ошибку автоисполнения планировщиком*/
//DAN Ищем сквитованное подтверждение 
//  if (CheckConfirmStatus(FD.tick.rec.DealID, PlanerStart))
//    return 1;
//  end;

  if( FD.БылОтказОтИсполнения() != false ) /*был отказ от сделки (для просроченной сделки)*/
      return 0;
  end;

  if(ПроверитьПорученияДепо(FD) == false)
    return 1;
  end;

  if( not УчетДвиженияЦенныхБумаг( FD, Doc, dat ) )
     return 1;
  end;

  if(((FD.ExistAvance()) and (FD.DateArray[DATE_DEALAVANCE] > dat)) or (FD.DateArray[DATE_DEALPAY] > dat))
    if( not СконвертироватьСуммыСделки(FD, dat, true) )
       return 1;
    end;
  end;

  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERY, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;

  if(СделкаСКлиентомКонтрагентом(FD.tick))
    if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERYCONTR, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
      return 1;
    end;
  end;

  if (ПРОВЕРКА_РЕПОЗИТАРНЫХ_ПАРАМЕТРОВ( FD.tick, @ОжиданиеЗапроса, @requestTimeout, @BOfficeKind, @DealID, @PFI ) and
      (IsOUTEXCHANGE(FD.Group)) and IsCloseContr(BOfficeKind, DealID))
    var CurrRQ = TRecHandler( "dlrq" );
    var OtherRQ = TRecHandler( "dlrq" );
    CurrRQ = FD.GetRQ(DLRQ_TYPE_DELIVERY);
    OtherRQ = FD.GetRQ(DLRQ_TYPE_PAYMENT);

    // Если другое ТО было ранее исполнено, то добавлять строку в график не нужно
    // Если другое ТО отложено, на просрочке или не исполнено, то оно становится закрывающим
    if( OtherRQ.rec.State != 2 )
      // Если другое ТО просрочено
      if( OtherRQ.rec.State == DLRQ_STATE_OVERDUE )
        if( ОжиданиеЗапроса and requestTimeout)
          if(DL_InsertGrDeal( BOfficeKind, DealID, DLGR_TEMPL_EXECDELAYMSGWTHREQUEST, GetDateAfterWorkDays(OtherRQ.rec.PlanDate, requestTimeout, FD.ПолучитьКалендСвязанный()) , time(0,0,0), PFI) != 0 )
            return 1;
          end;
          if( DL_SetDateGrDeal( BOfficeKind, DealID, DLGR_DATEKIND_CLOSEDEAL, date(31,12,9999)) != 0 )
            return 1;
          end;
        else
          if(DL_InsertGrDeal( BOfficeKind, DealID, DLGR_TEMPL_EXECDELAYMSG, OtherRQ.rec.PlanDate, time(0,0,0), PFI) != 0 )
            return 1;
          end;
          if( DL_SetDateGrDeal( BOfficeKind, DealID, DLGR_DATEKIND_CLOSEDEAL, date(31,12,9999)) != 0 )
            return 1;
          end;
        end;
      elif( OtherRQ.rec.State == DLRQ_STATE_DELAYED ) // Если другое ТО отложено
        if( ОжиданиеЗапроса and requestTimeout)
          if(DL_InsertGrDeal( BOfficeKind, DealID, DLGR_TEMPL_EXECHOLDMSGWTHREQUEST, GetDateAfterWorkDays(OtherRQ.rec.ChangeDate, requestTimeout, FD.ПолучитьКалендСвязанный()) , time(0,0,0), PFI) != 0 )
            return 1;
          end;
          if( DL_SetDateGrDeal( BOfficeKind, DealID, DLGR_DATEKIND_CLOSEDEAL, date(31,12,9999)) != 0 )
            return 1;
          end;
        else
          if(DL_InsertGrDeal( BOfficeKind, DealID, DLGR_TEMPL_EXECHOLDMSG, OtherRQ.rec.ChangeDate, time(0,0,0), PFI) != 0 )
            return 1;
          end;
          if( DL_SetDateGrDeal( BOfficeKind, DealID, DLGR_DATEKIND_CLOSEDEAL, date(31,12,9999)) != 0 )
            return 1;
          end;
        end;
      end;
    // Если другое ТО было ранее исполнено и текущее ТО исполняется досрочно, то нужно отправить сообщение
    elif( CurrRQ.rec.PlanDate < getCloseDate(BOfficeKind, DealID) )
      if( ОжиданиеЗапроса and requestTimeout)
        if( DL_UpdateGrDealAcc( BOfficeKind, DealID, PFI, DLGR_TEMPL_CLOSECONTRWTHREQUEST, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
          return 1;
        end;
        if(DL_InsertGrDeal( BOfficeKind, DealID, DLGR_TEMPL_EARLYEXECMSGWTHREQUEST, GetDateAfterWorkDays(CurrRQ.rec.PlanDate, requestTimeout, FD.ПолучитьКалендСвязанный()), date(0,0,0), PFI) != 0 )
          return 1;
        end;
      else
        if( DL_UpdateGrDealAcc( BOfficeKind, DealID, PFI, DLGR_TEMPL_CLOSECONTR, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
          return 1;
        end;
        if(DL_InsertGrDeal( BOfficeKind, DealID, DLGR_TEMPL_EARLYEXECMSG, CurrRQ.rec.PlanDate, date(0,0,0), FD.tick.rec.PFI) != 0 )
          return 1;
        end;
      end;
    end;
  end;

  if( FD.IsOldDeal() )
     /* П1 = "Завершить" */
     if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_P1, SP_OPERSTATUS_SECURDEALS_P1_FINISH) ) 
        msgbox( "Ошибка при установке статуса <Поставка по 1 ч> операции" );
        return 1;
     end;
  end;

  return 0;
end;
