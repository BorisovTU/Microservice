/**
  @file nptxsnobver010.mac
  @brief Шаг отбора записей хранилища СОФР операции технической сверки СНОБ

  #menu
  - БО ЦБ\Налоговый учет\НДФЛ\СНОБ\Операции технической сверки СНОБ

  #tag
  - functional_block: СНОБ
  - code_type: GUI
  - code_type: Operation
  - Сверка
  - Техническая сверка

  #link
  [BIQ-7294. Анализ. Техническая сверка] (https://sdlc.go.rshbank.ru/confluence/pages/viewpage.action?pageId=223940937)

  #changeLog
  |date      |author       |tasks    |note                                                             |
  |----------|-------------|---------|-----------------------------------------------------------------|
  |30.11.2023|Хромеев Д. С.|BOSS-1489|BOSS-48.9 СОФР. Реализация Технической сверки данных. Разработка.|
*/

import "nptxsnobverfun.mac";

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

MACRO ExecuteStep(doc, FDoc, DocKind, ID_Operation, ID_Step)
   var err = 0;
   var nptxsnobver = TRecHandler("nptxsnobver.dbt");

   SetBuff(nptxsnobver, FDoc);

   if (HasSnobverWithMessageByDate(nptxsnobver.rec.operdate))
     return Error("Уже существует сверка за " + nptxsnobver.rec.operdate + ". Выполнение невозможно.");
   end;

   var deleteQuery = " DELETE " +
                     " FROM DNPTXSNOBVERTB_DBT " +
                     " WHERE t_BatchID = ? ";

   var cmdDel = RSDCommand(deleteQuery);
   cmdDel.AddParam("", RSDBP_IN, nptxsnobver.rec.ID);
   SQL_Execute(cmdDel);

   var insertQuery = " INSERT INTO DNPTXSNOBVERTB_DBT ( " +
                     "                                   t_ID, " +
                     "                                   t_BatchID, " +
                     "                                   t_ClientID, " +
                     "                                   t_StartDate, " +
                     "                                   t_EndDate, " +
                     "                                   t_Operation_ID, " +
                     "                                   t_Event_ID, " +
                     "                                   t_Return_Canceled, " +
                     "                                   t_Record_Found, " +
                     "                                   t_Record_ID, " +
                     "                                   t_Record_Requested, " +
                     "                                   t_Error, " +
                     "                                   t_record_status, " +
                     "                                   t_storstate, " +
                     "                                   t_Checked " +
                     "                                ) " +
                     "                            SELECT 0, " + //t_ID
                     "                                   ?, " + //t_BatchID
                     "                                   tb.t_ClientID, " + //t_ClientID
                     "                                   ?, " + //t_StartDate
                     "                                   ?, " + //t_EndDate
                     "                                   tb.T_INITIAL_DOCID, " + //t_Operation_ID
                     "                                   tb.t_TBID, " + //t_Event_ID
                     "                                   ?, " + //t_Return_Canceled
                     "                                   CHR(0), " + //t_Record_Found
                     "                                   CHR(1), " + //t_Record_ID
                     "                                   CHR(0), " + //t_Record_Requested
                     "                                   CHR(1), " + //t_Error
                     "                                   CHR(0), " + //t_record_status
                     "                                   tb.T_STORSTATE, " + //t_storstate
                     "                                   CHR(0) " + //t_Checked
                     "                            FROM DNPTXTOTALBASE_DBT tb   " +
                     "                          WHERE (tb.T_INCDATE between ? and ? AND tb.T_STORSTATE = 1) " +
                     "                             OR (NVL(tb.t_CancelDate,TO_DATE('01.01.0001','DD.MM.YYYY')) between ? and ?) " +
                     "                             OR (NVL(tb.t_SendDate,TO_DATE('01.01.0001','DD.MM.YYYY')) between ? and ? AND tb.T_STORSTATE = 1) " +
                     "                       order by tb.t_IncDate ";

   var cmd = RSDCommand(insertQuery);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.ID);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.BeginDate);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.EndDate);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.ReturnCanceled);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.BeginDate);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.EndDate);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.BeginDate);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.EndDate);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.BeginDate);
   cmd.AddParam("", RSDBP_IN, nptxsnobver.rec.EndDate);
   SQL_Execute(cmd);

   return err;
END;
