/*
$Name:        nptxcalc080.mac
$Module:      Ценные бумаги
$Description: Расчет НОБ для НДФЛ. Шаг "Расчет НДР 6 уровня"
*/

/* Операция расчета НОБ для НДФЛ
   Шаг "Расчет НДР 6 уровня"*/
IMPORT InsCarryDoc, "secinter.mac", "nptxcalcfun.mac";

PRIVATE VAR Oper = TRecHandler( "nptxop.dbt" );

PRIVATE MACRO Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr, 10 );
  MsgBox( ErrStr );
  return 1;
END;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR OperationStatus;
  VAR Stat = 0;
  VAR vBegDate:DATE, 
      vEndDate:DATE;
  VAR query, cmd, DataSet;
  VAR count;

  Oper.SetRecordAddr( FDoc );

  ClearGTT_DNPTXOBJ_TMP();
  if(Oper.rec.Recalc == SET_CHAR)//если пересчет, то по периодам пересчитываем НДР с 3 по 7 уровень.
    vBegDate = Oper.rec.BegRecalcDate;
    query = GetIncomeDateQuery(Oper.rec.ID, NPTXOPSTEP8, Oper.rec.EndRecalcDate);
    cmd = DL_RSDCommand(query);        
    count = cmd.GetCount();
    DataSet = cmd.Execute();
    if((DataSet.moveNext()) AND (not stat))
      vEndDate = DataSet.t_operdate;
      if(vEndDate != Oper.rec.OperDate)
        Oper.rec.subkind_operation = DL_TXBASECALC_OPTYPE_NORMAL;
      end;
      if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
        stat = CreateTaxObjectsIIS6(Oper, ID_Step);
      else
        stat = CreateTaxObjects6(Oper, ID_Step, vBegDate, vEndDate);
      end;
    end;
    if(not stat)
      stat = DL_NPTX_StartInsertTaxObject(Oper.rec.ID, ID_Step);
    end;
    if(not stat)
      stat = DL_NPTX_PutMsg( string(date(vEndDate)), 1000 + count );
    end;
    DL_NPTX_SaveOperLog( Oper.rec.ID, (NPTXOPSTEP8*1000) + count );
  else
    stat = DL_NPTX_PutMsg( "Расчет НДР 6 уровня", 40 );
    if( not stat )
       if((Oper.rec.SubKind_Operation == DL_TXBASECALC_OPTYPE_CLOSE_IIS) and IsCalcNOBCloseISS() and (Oper.rec.Contract > 0))
         stat = CreateTaxObjectsIIS6(Oper, ID_Step);
       else
         stat = CreateTaxObjects6(Oper, ID_Step);
       end;
  
       if(not stat)
         stat = DL_NPTX_StartInsertTaxObject(Oper.rec.ID, ID_Step);
       end;
  
       DL_NPTX_SaveOperLog( Oper.rec.ID, 80 );
  
       if(not stat)
         OperationStatus = 7; //Расчет НДР7
         if( not InsertOprStatus( 46052 /*Расчет НОБ*/, OperationStatus) ) 
           return Error( "Ошибка при установке статуса операции" );
         end;
       end;
    end;
  end;

  return stat;
END;
