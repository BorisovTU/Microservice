/*******************************************************************************
 DESCRIPTION  :   Отчет "МСФО8"
 PROGRAMMED BY:   Сагиян С.Г.
 CREATION DATE:    13.06.2019
*******************************************************************************/
IMPORT  "spCache.mac", "msfo8_form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "cb_sql.mac", "sprepfun.mac", "oralib", "MoCommon.mac","ws_txreportform.mac";;
    
PRIVATE VAR   T_Dep:T_Dep_Collector;

PRIVATE VAR   OD1_Form;
PRIVATE VAR   OD1_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб

PRIVATE VAR   NFinRez;
PRIVATE VAR   NNDFL;

PRIVATE VAR ReportHeader = " \n"; 
                                                                                                                                                                                                                                                                                                                             
PRIVATE VAR TableHeader = " \n"; 
VAR accplus, ACCMINUS;

VAR RepDate;
                                                                                                                                   
PRIVATE CLASS (DL_CReportTemplate) SP_OD1_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  PRIVATE VAR F0_6, F0_9, F0_11; /*суммы строки "Итого"*/
  PRIVATE VAR m_TotalAmountPoint = 0;
  PRIVATE VAR v_account = "", v_amount;
  var RS;

  var cmdtemp, rstemp;

  PRIVATE VAR v_BuyCost, v_BuyNKD, v_BuyTotalCost, v_SaleCost, v_SaleNKD, v_SaleTotalCost, v_ComS, v_ComB, v_FinRez;
  PRIVATE VAR v_s_BuyCost, v_s_BuyNKD, v_s_BuyTotalCost, v_s_SaleCost, v_s_SaleNKD, v_s_SaleTotalCost, v_s_ComS, v_s_ComB, v_s_FinRez;
  VAR PrevFI, PrevS;
  VAR ProgressValue = CTxProgressValue();

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
  
  /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END;

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintLine( P1,P2,P3,P4,P5,P6,P7,P8,P9,P10,P11,P12,P13,P14,P15,P16,P17,P18,P19,P20,P21,P22,P23,P24,P25,P26,P27,P28,P29,P30,P31,P32,P33,P34,P35,P36,P37,P38,P39,P40,P41,P42,P43,P44,P45,P46,P47,P48,P49,P50,P51,P52,P55)
     this.PrintTableLine( 
          /*1 */     "Filial",      P2  , null, 
          /*2 */     "ISIN",        P8  , null, 
          /*3 */     "GosReg",      P9  , null, 
          /*4 */     "FICode",      P1  , null, 
          /*5 */     "Emitent",     P7  , null, 
          /*6 */     "AccBal",      P3  , null, 
          /*7 */     "Acc",         P4  , null, 
          /*8 */     "FIName",      P5  , null, 
          /*9 */     "Seria",       P6  , null, 
          /*10*/     "Amount",      P11 , null, 
          /*11*/     "NomFI",       P10 , null, 
          /*12*/     "NominalRUR",  P12 , null, 
          /*13*/     "Nominal",     P13 , null, 
          /*14*/     "BalCostRUR",  P14 , null, 
          /*15*/     "BalCost",     P22 , null, 
          /*16*/     "BalCostMinus",P23 , null, 
          /*17*/     "Discont",     P19 , null, 
          /*18*/     "UNKD",        P16 , null,
          /*18*/     "Premia",      P18 , null, 
          /*19*/     "PKD",         P17 , null, 
          /*20*/     "Pereots",     P20 , null, 
          /*21*/     "LastCost",    P24 , null, 
          /*22*/     "Dohod",       P25 , null, 
          /*23*/     "DrawingDate", P26 , null, 
          /*24*/     "CoupProc",    P27 , null, 
          /*25*/     "CoupPeriod",  P28 , null, 
          /*26*/     "NearDate",    P29 , null, 
          /*27*/     "DayS",        P30 , null, 
          /*28*/     "Cost1",       P31 , null, 
          /*29*/     "Cost2",       P32 , null, 
          /*30*/     "Reserv",      P21 , null, 
          /*31*/     "ReservMSFO",  P41 , null, 
          /*32*/     "Country1",    P34 , null, 
          /*33*/     "Country2",    P35 , null, 
          /*34*/     "Country3",    P36 , null, 
          /*35*/     "Portf",       P37 , null, 
          /*36*/     "FIRate",      P39 , null, 
          /*37*/     "DohodEff",    P40 , null, 
          /*38*/     "FPRSBU1",     P42 , null, 
          /*39*/     "FPRSBU2",     P43 , null, 
          /*40*/     "PereotsChange", P44 , null, 
          /*41*/     "NaDoh",       P45 , null, 
          /*42*/     "NaRash",      P46 , null, 
          /*43*/     "FPRSBU3",     P47 , null,
          /*43*/     "TT1",         P48 , null,
          /*49*/     "RatePlace",   P49 , null,
          /*50*/     "ActPlace",    P50 , null,
          /*51*/     "Ierarh",      P51 , null
       );           
  END;

  PRIVATE MACRO GetRate(fi, rtype, ddate, facevaluefi)
     VAR cmd1, rs1, cmd2, rs2;
     cmd1 = RSDCommand("select t_rate/power(10,t_point) RetVal, t_sincedate RetDate from dratedef_dbt rh where t_otherfi = ? and t_type = ? and rh.t_sincedate <= ? and rh.t_fiid = ? ");

     cmd1.AddParam( "", RSDBP_IN, fi );	  
     cmd1.AddParam( "", RSDBP_IN, rtype );	  
     cmd1.AddParam( "", RSDBP_IN, ddate );	  
     cmd1.AddParam( "", RSDBP_IN, facevaluefi );

     RS1 = TRsbDataSet( cmd1 );
     IF ((RS1.MoveNext) and ( RS1.RetDate <= ddate))
		return rs1.RetVal;
     else
	     cmd2 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratehist_dbt rh where rh.t_rateid in " +
                           " (select t_rateid from dratedef_Dbt where t_otherfi=? and t_type=? and t_fiid = ? ) " + 
                           " and  rh.t_sincedate = (select max(l.t_sincedate) from dratehist_dbt l where l.t_rateid = rh.t_rateid and l.t_sincedate <= ?) ");

	     cmd2.AddParam( "", RSDBP_IN, fi );	  
	     cmd2.AddParam( "", RSDBP_IN, rtype );	  
	     cmd2.AddParam( "", RSDBP_IN, facevaluefi );	  
	     cmd2.AddParam( "", RSDBP_IN, ddate );	  
	     RS2 = TRsbDataSet( cmd2 );
	     IF (RS2.MoveNext)
		     return rs2.RetVal;        
	     end;
	     return 0;
     end;
  END;


  macro getCORRINTTOEIR (fininstr, Data)                                                                 
                                                                                                           
     var sql = " SELECT  SUM (NVL (CORRINTTOEIR, 0)) CORRINTTOEIR " +                                      
               "         FROM DPORTFOLIO_TMP t " +                                                         
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +                                                               
               "              T_FIID, " +                                                                  
               "              T_PARTYID, " +                                                               
               "              T_AVKINDSHNAME, " +                                                          
               "              T_ACCOUNT, " +                                                               
               "              T_BALANCE ";                                                                 
                                                                                                           
      var cmd = rsdCommand(sql);                                                                           
      cmd.addParam("", RSDBP_IN, RS.PORTFOLIO);                                                            
      cmd.addParam("", RSDBP_IN, RS.FIID);                                                                 
      cmd.addParam("", RSDBP_IN, RS.ACCOUNT);                                                              
      cmd.addParam("", RSDBP_IN, repDate);                                                                 
      cmd.Execute();                                                                                       
      var getData = TRsbDataSet(cmd);                                                                      
                                                                                                           
      if(getData.MoveNext)                                                                                 
       return getData.Value(0);                                                                            
      else                                                                                                 
       return 0;                                                                                           
      end;                                                                                                 
                                                                                                           
  End;                                                                                                   

  PRIVATE MACRO GetRateAccur(fi, rtype, ddate, facevaluefi)
     VAR cmd1, rs1, cmd2, rs2;
     cmd1 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratehist_dbt rh where rh.t_rateid in " +
                       " (select t_rateid from dratedef_Dbt where t_otherfi=? and t_type=? and t_fiid=?) " + 
                       " and  rh.t_sincedate =  ? ");

     cmd1.AddParam( "", RSDBP_IN, fi );	  
     cmd1.AddParam( "", RSDBP_IN, rtype );	  
     cmd1.AddParam( "", RSDBP_IN, ddate );	  
     cmd1.AddParam( "", RSDBP_IN, facevaluefi );

     RS1 = TRsbDataSet( cmd1 );
     IF (RS1.MoveNext)
		return rs1.RetVal;
     else
	     cmd2 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratedef_dbt rh where t_otherfi = ? and t_type = ? and rh.t_sincedate = ? and t_fiid=? ");

	     cmd2.AddParam( "", RSDBP_IN, fi );	  
	     cmd2.AddParam( "", RSDBP_IN, rtype );	  
	     cmd2.AddParam( "", RSDBP_IN, ddate );
            cmd2.AddParam( "", RSDBP_IN, facevaluefi );	  
	     RS2 = TRsbDataSet( cmd2 );
	     IF (RS2.MoveNext)
		return rs2.RetVal;        
	     end;
	     return 0;
     end;
  END; 

  PRIVATE MACRO BeginReport()

     VAR AvrKindShowValue = "";

     this.SetActiveSheet( "МСФО8" );
     this.PrintFormatString( ReportHeader,
                     "H0_1"  , OD1_Form.GetFieldValue( PNFLD_OD1_DATE )
                   );

     this.RegisterTable( "MainTable", "",
	          /*1 */     "Filial",      
          	  /*2 */     "ISIN",        
	          /*3 */     "GosReg",      
	          /*4 */     "FICode",      
	          /*5 */     "Emitent",     
	          /*6 */     "AccBal",      
	          /*7 */     "Acc",         
	          /*8 */     "FIName",      
	          /*9 */     "Seria",       
	          /*10*/     "Amount",      
	          /*11*/     "NomFI",       
	          /*12*/     "NominalRUR",  
	          /*13*/     "Nominal",     
	          /*14*/     "BalCostRUR",  
	          /*15*/     "BalCost",     
	          /*16*/     "BalCostMinus",
	          /*17*/     "Discont",     
	          /*18*/     "UNKD",      
	          /*18*/     "Premia",      
	          /*19*/     "PKD",         
	          /*20*/     "Pereots",     
	          /*21*/     "LastCost",    
	          /*22*/     "Dohod",       
	          /*23*/     "DrawingDate", 
	          /*24*/     "CoupProc",    
	          /*25*/     "CoupPeriod",  
	          /*26*/     "NearDate",    
	          /*27*/     "DayS",        
	          /*28*/     "Cost1",       
	          /*29*/     "Cost2",       
	          /*30*/     "Reserv",      
	          /*31*/     "ReservMSFO",  
	          /*32*/     "Country1",    
	          /*33*/     "Country2",    
	          /*34*/     "Country3",    
	          /*35*/     "Portf",       
	          /*36*/     "FIRate",      
	          /*37*/     "DohodEff",    
	          /*38*/     "FPRSBU1",     
	          /*39*/     "FPRSBU2",     
	          /*40*/     "PereotsChange"
	          /*41*/     "NaDoh",       
	          /*42*/     "NaRash",      
	          /*43*/     "FPRSBU3",
              /*44*/     "TT1", 
	          /*45*/     "RatePlace",
	          /*46*/     "ActPlace",
	          /*47*/     "Ierarh"
       );      
  END;

  MACRO ПечататьПромежуточныеИтоги()
  END;

  PRIVATE MACRO EndReport()
     this.EndTable();
     ПечататьПромежуточныеИтоги();
  END;

  /*511-П_Признак активности и ликвидности рынка (да/нет)*/
  private macro get511SignLiquidMarket(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 64 "+     //категория 511-П_Признак активности и ликвидности рынка
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;
  end;

  /*511-П_Уровень иерархии оценки (1/2/3)*/
  private macro get511GradeLevel(inSecID)
        var sql="select a.t_name "+
                "from dobjattr_dbt a "+
                "join dobjatcor_dbt c on a.t_objecttype = c.t_objecttype and a.t_groupid = c.t_groupid and a.t_attrid = c.t_attrid "+
                "where c.t_objecttype = 12 "+   //ценная бумага
                  "and c.t_groupid = 65 "+     //категория 511-П_Уровень иерархии оценки
                  "and c.t_object = lpad( :inSecID, 10, '0') "+
                  "and c.t_validtodate = to_date('31.12.9999', 'dd.mm.yyyy')";

	    var cmd = rsdCommand(sql);
	    cmd.addParam(":inSecID", RSDBP_IN, inSecID);
	    cmd.Execute();
	    var getData = TRsbDataSet(cmd);

        var rs = rsdRecordSet(cmd);
        if (rs.MoveNext)
            return rs.Value(0);
        else
            return "---";
        end;

  end;

  /* Получить Открытое количество ЦБ */

  macro getAvarAmount

     if (v_amount > 0) return v_amount;
     end;     
  
     var sql = " SELECT  SUM (NVL (T_AVRAMOUNT, 0)) T_AVRAMOUNT " +
               "         FROM DPORTFOLIO_TMP t " +
               "         Where t.t_portfid = ? and t.t_fiid = ? and t.t_account =  ? and t.report_dt = ?" +
               "     GROUP BY T_PORTFID, " +
               "              T_FIID, " +
               "              T_PARTYID, " +
               "              T_AVKINDSHNAME, " +
               "              T_ACCOUNT, " +
               "              T_BALANCE ";

      var cmd = rsdCommand(sql);
      cmd.addParam("", RSDBP_IN, rs.PORTFOLIO);
      cmd.addParam("", RSDBP_IN, rs.FIID);
      cmd.addParam("", RSDBP_IN, rs.ACCOUNT_NUMBER_2);
      cmd.addParam("", RSDBP_IN, repDate);
      cmd.Execute();
      var getData = TRsbDataSet(cmd);
      
      if(getData.MoveNext)
		v_amount = getData.Value(0);
       		return v_amount;  
      else 
       return 0;
      end;

  End;

  PRIVATE MACRO FICode   
	return rs.avrcode;  
  END;
  
  PRIVATE MACRO Filial   
	return "0000";
	return rs.depname;  
  END;  

  PRIVATE MACRO AccBal   
	return rs.ACCOUNT_NUMBER_1;  
  END;  

  PRIVATE MACRO Acc   
	return rs.ACCOUNT_NUMBER_2;  
  END;  

  PRIVATE MACRO FIName   
	return rs.kname;  
  END;  

  PRIVATE MACRO Seria   
	return rs.avrname;  
  END;  

  PRIVATE MACRO Emitent   
	return rs.issuer; // + " (" + rs.issuerid + ")";  
  END;  

  PRIVATE MACRO ISIN   
	return rs.isin;  
  END;  

  PRIVATE MACRO GosReg   
	return rs.lsin;  
  END;  

  PRIVATE MACRO NomFI   
	return rs.currency;  
  END;  

  PRIVATE MACRO Amount   

	return getAvarAmount;
	return rs.amount;  
  END;  

  PRIVATE MACRO NominalRUR   
	var RetVal;
	if (rs.facevaluefi != NATCUR)
	        SmartConvertSumDbl(RetVal, rs.NominalVal*amount, repdate, rs.facevaluefi, NATCUR, false);
	else 
		RetVal = rs.NominalVal*amount;
	end;
	return RetVal;  
  END;  

  PRIVATE MACRO Nominal   
	if (rs.facevaluefi != NATCUR)
		return rs.NominalVal*amount;
	end;
	return 0;  
  END;  

  PRIVATE MACRO BalCostRUR
	var RetVal;
    return rs.balcost; 
  END;   

  PRIVATE MACRO SumRUR   
	return rs.dealcostsum;
  END;  

  PRIVATE MACRO UNKD   
	return rs.unkd_with_coupon; 	
  END;  

  PRIVATE MACRO PKD   
	return rs.COUPON_AMOUNT; 
  END;  

  PRIVATE MACRO Premia   
	return rs.premium_amount; 
  END;  

  PRIVATE MACRO Discont   
	return rs.discount_amount; 
  END;  

  PRIVATE MACRO Pereots   
	return rs.overvalue; 
  END;  

  PRIVATE MACRO Reserv   
	return rs.reserve_amount; 
  END;  

  PRIVATE MACRO BalCost 
	var RetVal;
	if (rs.facevaluefi != NATCUR)  
	        SmartConvertSumDbl(RetVal, rs.BalCost, repdate, NATCUR, rs.facevaluefi, false);
		return RetVal;  
	else 
		return 0;
	end; 
  END;  

  PRIVATE MACRO Balcostminus   
	return rs.BalCost-UNKD-PKD-discont-premia;   
  END; 

  PRIVATE MACRO LastCost 
    var cl;                                                                                                   
    if ((rs.avoirkind == 28) OR (rs.avoirkind == 39) OR (rs.avoirkind == 41) OR (rs.avoirkind == 43) ) 
         cl = GetRate(rs.fiid, 23, repdate, rs.facevaluefi);    // Блумберг                                        
         if (cl == 0)                                                                              
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // Мотивированное суждение                 
         end;                                                                                      
         if (cl == 0)                                                                              
             cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);  // Средневзвешенная                           
         end;                                                                                      
    else                                                                                              
         cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);     // Средневзвешенная                                
         if (cl == 0)                                                                              
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // Мотивированное суждение                 
         end;                                                                                      
    end;                                                                                              
    if (rs.ficode == 2010015091376)
        cl=0.0;  
    end;    
    if (rs.ficode == 2010015155540)
        cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  
    end;    
                                                                                          
    return cl;                                                                                             
  END;  

  PRIVATE MACRO Dohod   
    return "";  
  END;  

  PRIVATE MACRO DrawingDate   
    return rs.t_DrawingDate;  
  END;  


  PRIVATE MACRO dmain
    if (rs.d1 != 0) return RS.d1;
    elif (rs.d2 != 0) return RS.d2;
    else return 0;
    end;
  END;

  PRIVATE MACRO CoupProc   
    var rate = rs.coupincomerate;
    var vol = rs.coupincomevolume;
    if (rate == 0) 
        if ( dmain == 0 ) 
             return 0;
        end;
        rate = round(vol / rs.NominalVal * 100 * 365 / dmain, 2);
    end; 

    return rate;   
  END;  

  PRIVATE MACRO CoupPeriod_try
    var RetVal;
    var d = dmain;
    var h, j;
    var counter = 0;  // если сразу не найдем период, надо поимкать предыдущий купон и посмотреть на его период.

    while (counter < 2)
        if   ((d > 27) and (d < 33) ) RetVal = "ежемесячный";
        elif ((d > 70) and (d < 95) ) RetVal = "ежеквартальный";
        elif ((d > 170) and (d < 190) ) RetVal = "полугодовой";
        elif ((d > 359) and (d < 365) ) RetVal = "годовой";
        else 
    
            h = RSDCommand("select (w1.t_drawingdate - w1.t_firstdate + 1) days from  dfiwarnts_dbt w1 where  t_ispartial = CHR (0) and  w1.t_fiid=" + rs.fiid + " and w1.t_drawingdate = " +
                          " (SELECT MAX (t.t_drawingdate) FROM dfiwarnts_dbt t WHERE t.t_fiid = w1.t_fiid AND t_ispartial = CHR (0) AND t.t_drawingdate < " + GetSQLDate( RepDate ) + ")");
            j = TRSBDataSet(h);
            if (j.movenext)
                d = j.days;
            end;
            counter = counter - 1;
        end;
        counter = counter + 2;
    end;

    return RetVal;  
  END;  

  PRIVATE MACRO CoupPeriod
    return CoupPeriod_try;
  END;  

  PRIVATE MACRO NearDate   
    return rs.coupdrawingdate;  
  END;  

  PRIVATE MACRO DayS   
    return rs.days;  
  END;  

  PRIVATE MACRO Cost1   
    return LastCost;
  END;  

  PRIVATE MACRO Cost2   
    var cl, cd = 0.0;
                                                                                                                                                                                                                                                                      
    if ((rs.avoirkind == 28) OR (rs.avoirkind == 39) OR (rs.avoirkind == 41) OR (rs.avoirkind == 43) )    
         cl = GetRate(rs.fiid, 23, repdate, rs.facevaluefi);    // Блумберг                                                                    
         if (cl == 0)                                                                                                          
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // Мотивированное суждение
             cd = 1;                                             
         end;                                                                                                                  
         if (cl == 0)                                                                                                          
             cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);  // Средневзвешенная                                                       
         end;                                                                                                                  
    else                                                                                                                          
         cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);     // Средневзвешенная                                                            
         if (cl == 0)                                                                                                          
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // Мотивированное суждение 
             cd = 1;                                            
         end;                                                                                                                  
    end;                                                                                                                          
                                                                                    
    if (rs.ficode == 2010015091376)
        cl=0.0;  
    end;    
    if (rs.ficode == 2010015155540)
        cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  
    end;    
                                                                                                                          
    if (cd == 1)                                                                                                                             
        cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);
        return cl;
    end;                                                                                                                           
    return "0.0";                                                                                                                            
      
  END;  

  PRIVATE MACRO Cost3   
    return "";  
  END;  

  PRIVATE MACRO Country1   
    if (rs.flag_mez > 0) 
        return "";  
    end;

    if (rs.issuer_country == "Российская Федерация")
        return "Россия";  
    end;
    return "";
  END;  

  PRIVATE MACRO Country2   
    if (rs.flag_mez > 0) 
        return "";  
    end;

    if (rs.issuer_country != "Российская Федерация")
        return rs.issuer_country;  
    end;
    return "";
  END;  

  PRIVATE MACRO Country3   
    if (rs.flag_mez > 0) 
        return "Международная организация";
    else 
        return "";  
    end;
  END;  

  PRIVATE MACRO Portf   
    if (rs.portfolio == 5) return 3;
    elif (rs.portfolio == 1) return 1;
    elif (rs.portfolio == 2) return 2;
    elif (rs.portfolio == 7) return 2;
    else return "Н/Д";
    end;
  END;  

  PRIVATE MACRO AgName   
    return "";  
  END;  

  PRIVATE MACRO FIRate

      if (rs.ISSUER_RATING_MOODYS == NULL)
         rs.ISSUER_RATING_MOODYS= "-";
       end;
      if (rs.ISSUER_RATING_SP == NULL)  
             rs.ISSUER_RATING_SP= "-";                  
         end;                             
      if (rs.ISSUER_RATING_FITCH == NULL)  
          rs.ISSUER_RATING_FITCH= "-" ;                  
         end;                             
     return " SP: " + rs.ISSUER_RATING_SP+ " / " + " MOODYS: " + rs.ISSUER_RATING_MOODYS+ " / " + " FITCH: " + rs.ISSUER_RATING_FITCH;
             
  END;  
  
  PRIVATE MACRO DohodEff
      return 0;                         
  END;  

  PRIVATE MACRO ReservMSFO   
    return "";  
  END;  

  PRIVATE MACRO GETACCOUNTS
    var h, j, dd, mm, yyyy;
    DateSplit( repdate, dd, mm, yyyy);
    h = RSDCommand("select distinct t_account acc from DMCACCDOC_DBT where substr(t_account,1,5) in ('10603','10605') and t_catid in (493,494) and t_iscommon=chr(88) and t_fiid=? order by 1");
    h.addParam("", RSDBP_IN, rs.t_fiid);
    j = TRSBDataSet(h);
    j.movenext;
    accplus  = j.acc;
    j.movenext;
    accminus = j.acc;
    return;  
  END;  

  PRIVATE MACRO FPRSBU1   
    var h, s=0.0 , j, dd, mm, yyyy;
    DateSplit( repdate, dd, mm, yyyy);     
    if (rs.portfolio == 1)
        if (rs.ficode == 2010015115799)
            return s;
        end;
        if ( rs.ficode == 2010015134826)
            return s;
        end;  
        h = RSDCommand("select t_account, sum(rsi_rsb_account.RestA(t_Account, ?, 1, 0)) over(partition by t_fiid) rest from DMCACCDOC_DBT where substr(t_account,1,5) in ('10603','10605') and t_catid in (493,494) and t_iscommon=chr(88) and t_fiid=?"); 
        h.addParam("", RSDBP_IN, date(31,12,2018));                                                                                                                                                                                                         
        h.addParam("", RSDBP_IN, rs.t_fiid);                                                                                                                                                                                       
        j = TRSBDataSet(h);                                                                                                                                                                                                                                 
        if (j.movenext)                                                                                                                                                                                                                                     
            return (j.rest);                                                                                                                                                                                                                            
        end;
    end; 
    if (rs.portfolio == 2)     
        h = RSDCommand("select t_account, sum(rsi_rsb_account.RestA(t_Account, ?, 1, 0)) over(partition by t_fiid) rest from DMCACCDOC_DBT where substr(t_account,1,5) in ('10603','10605') and t_catid in (493,494) and t_iscommon=chr(88) and t_fiid=?"); 
        h.addParam("", RSDBP_IN, date(31,12,2018));                                                                                                                                                                                                         
        h.addParam("", RSDBP_IN, rs.t_fiid);                                                                                                                                                                                       
        j = TRSBDataSet(h);                                                                                                                                                                                                                                 
        if (j.movenext)                                                                                                                                                                                                                                     
            return (j.rest);                                                                                                                                                                                                                            
        end;
    end;
    return s;
   END;  

  PRIVATE MACRO FPRSBU2   
    var h, j;
         
    if (rs.portfolio == 7)
        h = RSDCommand("  select t_account,(SELECT sum(overvalue)  "+                               
                       "    FROM DPORTFOLIO_TMP    "+                                
                       "   WHERE     t_account = ?  "+                            
                       "    AND t_portfid = ?    "+                            
                       "    AND  report_dt = ? ) ov "+                                
                       "  from DPORTFOLIO_TMP   where t_account = ? and t_portfid = ? and report_dt = ? ");                           
        h.addParam("", RSDBP_IN, rs.ACCOUNT_NUMBER_2); 
        h.addParam("", RSDBP_IN, rs.portfolio);
        h.addParam("", RSDBP_IN, repdate); 
        h.addParam("", RSDBP_IN, rs.ACCOUNT_NUMBER_2); 
        h.addParam("", RSDBP_IN, rs.portfolio);
        h.addParam("", RSDBP_IN, repdate);                                         
        j = TRSBDataSet(h);                                               
        if (j.movenext)                                                   
            return (j.ov);                                            
        end;                                                              
    end;
    if (rs.portfolio == 2)
        h = RSDCommand("  select t_account,(SELECT sum(overvalue)  "+                               
                       "    FROM DPORTFOLIO_TMP    "+                                
                       "   WHERE     t_account = ?  "+                            
                       "    AND t_portfid = ?    "+                            
                       "    AND  report_dt = ? ) ov "+                                
                       "  from DPORTFOLIO_TMP   where t_account = ? and t_portfid = ? and report_dt = ? ");                           
        h.addParam("", RSDBP_IN, rs.ACCOUNT_NUMBER_2); 
        h.addParam("", RSDBP_IN, rs.portfolio);
        h.addParam("", RSDBP_IN, repdate); 
        h.addParam("", RSDBP_IN, rs.ACCOUNT_NUMBER_2); 
        h.addParam("", RSDBP_IN, rs.portfolio);
        h.addParam("", RSDBP_IN, repdate);                                         
        j = TRSBDataSet(h);                                               
        if (j.movenext)                                                   
            return (j.ov);                                            
        end;                                                              
    end;
    return 0;  
  END;  

  PRIVATE MACRO NaDoh   
    var h, j, dd, mm, yyyy, h1, j1, rez=0;
    DateSplit( repdate, dd, mm, yyyy);
    if (rs.portfolio == 2)
        h = RSDCommand( "select * from dacctrn_dbt where t_date_carry between ? and ? " +
                        "and t_chapter=1  and substr(t_account_payer,1,5) in ('50220','50221','61210') and substr(t_account_receiver, 1,5) in ('50220','50221','61210') " +
                        "and t_account_payer in (select t_account from dmcaccdoc_dbt where t_fiid=?) " +
                        "and t_account_receiver in (select t_account from dmcaccdoc_dbt where t_fiid=?) " );
        h.addParam("", RSDBP_IN, date(1,1,yyyy));
        h.addParam("", RSDBP_IN, repdate);
        h.addParam("", RSDBP_IN, rs.t_fiid);
        h.addParam("", RSDBP_IN, rs.t_fiid);
        j = TRSBDataSet(h);
             if (j.movenext)
                 h1 = RSDCommand( "select nvl(sum(smm),0) rez from(  " +
                                  "select  nvl(sum(t_sum_natcur),0) smm from dacctrn_dbt where t_date_carry between ? and ? " +
                                  "and t_chapter=1  and t_state=1 and  t_account_payer like '70606%' and t_account_receiver in (?,?) " +
                                  "union " +
                                  "select  -nvl(sum(t_sum_natcur),0) smm from dacctrn_dbt where t_date_carry between ? and ? " +
                                  "and t_chapter=1  and t_state=1 and  t_account_payer like '70601%' and t_account_receiver in (?,?) " +
                                  "union " +
                                  "select  -nvl(sum(t_sum_natcur),0) smm from dacctrn_dbt where t_date_carry between ? and ? " +
                                  "and t_chapter=1  and t_state=1 and  t_account_payer in (?,?) and  t_account_receiver like '70601%' " +
                                  "union " +
                                  "select  nvl(sum(t_sum_natcur),0) smm from dacctrn_dbt where t_date_carry between ? and ? " +
                                  "and t_chapter=1  and t_state=1 and  t_account_payer in (?,?) and  t_account_receiver like '70606%' " +
                                 ")  " );
        
                 h1.addParam("", RSDBP_IN, date(1,1,yyyy));
                 h1.addParam("", RSDBP_IN, repdate);
                 h1.addParam("", RSDBP_IN, accminus);
                 h1.addParam("", RSDBP_IN, accplus);
                 h1.addParam("", RSDBP_IN, date(1,1,yyyy));
                 h1.addParam("", RSDBP_IN, repdate);
                 h1.addParam("", RSDBP_IN, accminus);
                 h1.addParam("", RSDBP_IN, accplus);
                 h1.addParam("", RSDBP_IN, date(1,1,yyyy));
                 h1.addParam("", RSDBP_IN, repdate);
                 h1.addParam("", RSDBP_IN, accminus);
                 h1.addParam("", RSDBP_IN, accplus);
                 h1.addParam("", RSDBP_IN, date(1,1,yyyy));
                 h1.addParam("", RSDBP_IN, repdate);
                 h1.addParam("", RSDBP_IN, accminus);
                 h1.addParam("", RSDBP_IN, accplus);
        
                 j1 = TRSBDataSet(h1);
                 if (j1.movenext)
                     rez = rez + j1.rez;
                 end;
             end;
             return rez;
             
             h1 = RSDCommand( "select nvl(sum(smm),0) rez from(  " +
                              "select  t_sum_natcur smm from dacctrn_dbt where t_date_carry between ? and ? " +
                              "and t_chapter=1  and t_state=1 and  t_account_payer = ? and substr(t_account_receiver, 1,5) in ('70601') " +
                              "union " +
                              "select  -t_sum_natcur smm from dacctrn_dbt where t_date_carry between ? and ? " +
                              "and t_chapter=1  and t_state=1 and  substr(t_account_payer, 1,5) in ('70606') and  t_account_receiver = ?   " +
                            ")  " );

             h1.addParam("", RSDBP_IN, date(1,1,yyyy));
             h1.addParam("", RSDBP_IN, repdate);
             h1.addParam("", RSDBP_IN, accplus);
             h1.addParam("", RSDBP_IN, date(1,1,yyyy));
             h1.addParam("", RSDBP_IN, repdate);
             h1.addParam("", RSDBP_IN, accminus);

             j1 = TRSBDataSet(h1);
             if (j1.movenext)
                 rez = rez + j1.rez;
             end;

             return rez;
    end;
    return 0;      
  END;
  
  PRIVATE MACRO PereotsChange
      return  FPRSBU2 - FPRSBU1 - NaDoh; 
  END;                                   

  PRIVATE MACRO NaRash   
    var h, j, dd, mm, yyyy, h1, j1,;
    DateSplit( repdate, dd, mm, yyyy);

    //    + Дт 706* Кт 10605*
    //    - Дт 10603* Кт 706*
    //    при этом проводки по счетам 50220/50221 корреспондируют со счетом 50505

    h = RSDCommand(    "select * from dacctrn_dbt where t_date_carry between ? and ? " +
                       "and t_chapter=1  and substr(t_account_payer,1,5) in ('50220') and substr(t_account_receiver, 1,5) in ('50505') " +
                       "and t_account_payer in (select t_account from dmcaccdoc_dbt where t_fiid=?) " +
                       "and t_account_receiver in (select t_account from dmcaccdoc_dbt where t_fiid=?) " );
    h.addParam("", RSDBP_IN, date(1,1,yyyy));
    h.addParam("", RSDBP_IN, repdate);
    h.addParam("", RSDBP_IN, rs.t_fiid);
    h.addParam("", RSDBP_IN, rs.t_fiid);
    j = TRSBDataSet(h);
    if (j.movenext)
        h1 = RSDCommand( "select nvl(sum(smm),0) rez from(  " +
                         "select  t_sum_natcur smm from dacctrn_dbt where t_date_carry between ? and ? " +
                         "and t_chapter=1  and t_state=1 and  substr(t_account_payer, 1,3) in ('706') and  t_account_receiver = ?   " +
                         "union " +
                         "select  -t_sum_natcur smm from dacctrn_dbt where t_date_carry between ? and ? " +
                         "and t_chapter=1  and t_state=1 and  t_account_payer = ? and substr(t_account_receiver, 1,3) in ('706') " +
                         ")  " );
        
        h1.addParam("", RSDBP_IN, date(1,1,yyyy));
        h1.addParam("", RSDBP_IN, repdate);
        h1.addParam("", RSDBP_IN, accminus);
        h1.addParam("", RSDBP_IN, date(1,1,yyyy));
        h1.addParam("", RSDBP_IN, repdate);
        h1.addParam("", RSDBP_IN, accplus);
        
        j1 = TRSBDataSet(h1);
        if (j1.movenext)
            return(j1.rez);
        end;
    end;
    return 0;  
  END;  

  PRIVATE MACRO FPRSBU3   
    return NaRash + NaDoh + PereotsChange + FPRSBU1 - FPRSBU2;  
  END;            

  PRIVATE MACRO Comment   
    return "";  
  END;  

  PRIVATE MACRO RatePlace
    var cl= 0.0; 
    var cd;                                                                                                               
    
    if ((rs.avoirkind == 28) OR (rs.avoirkind == 39) OR (rs.avoirkind == 41) OR (rs.avoirkind == 43))     
         cl = GetRate(rs.fiid, 23, repdate, rs.facevaluefi);    // Блумберг
         cd  = "Bloomberg";                                          
         if (cl == 0)                                                                                  
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // Мотивированное суждение 
             cd = "Мотивированное суждение ";                   
         end;                                                                                          
         if (cl == 0)                                                                                  
             cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);  // Средневзвешенная 
             cd = " ММВБ" ;
         end;                                                                                          
    else                                                                                                  
         cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);     //  Средневзвешенная  
         cd = " ММВБ" ;                                
         if (cl == 0)                                                                                  
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // Мотивированное суждение
             cd = "Мотивированное суждение " ;                    
         end;                                                                                          
    end; 
    if (rs.ficode == 2010015091376)     
        cl=0.0;                                                                                                                      
    end;                                
    if (cl == 0.0)
        return "Н/Д"
    end;                                                 
    if (rs.ficode == 2010015155540)                      
        cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);
        cd = "Мотивированное суждение "         
    end;                                                 
                                                                                                    
    return cd;                                                                                                
  END;                                                                                                                

  PRIVATE MACRO ActPlace
    var cl;                                                                                                     
    var cd;                                                                                                    
                                                                                                              
    if ((rs.avoirkind == 28) OR (rs.avoirkind == 39) OR (rs.avoirkind == 41) OR (rs.avoirkind == 43) or (rs.avoirkind == 42))  
         cl = GetRate(rs.fiid, 23, repdate, rs.facevaluefi);    // cd  = "Bloomberg";                               
         cd  = "Да";                                                                         
         if (cl == 0)                                                                               
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // cd = " ММВБ" ;                              
             cd = "Нет" ;                                                                             
         end;                                                                                       
         if (cl == 0)                                                                               
             cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);  // cd = "Мотивированное суждение ";         
             cd = "Да";                                                   
         end;                                                                                       
    else                                                                                               
         cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);     // cd = "Мотивированное суждение ";              
         cd = "Да";                                                           
         if (cl == 0)                                                                               
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // cd = " ММВБ" ;                              
             cd = "Нет" ;                                                                               
         end;                                                                                                        
    end;                                                                                              
    if (rs.ficode == 2010015091376)    
        cl=0.0;                    
    end;                               
    if (cl == 0.0)                    
        return "Н/Д"                      
    end;                               
    if (rs.ficode == 2010015155540)                   
        cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);       
        cd = "Нет "             
    end;                                                
                                                                                               
    return cd;                                                                                                 
     
  END;  

  PRIVATE MACRO Ierarh   
    var cl;                                                                                                                       
    var cd;                                                                                                             
                                                                                                                           
    if ((rs.avoirkind == 28) OR (rs.avoirkind == 39) OR (rs.avoirkind == 41) OR (rs.avoirkind == 43) or (rs.avoirkind == 42))           
         cl = GetRate(rs.fiid, 23, repdate, rs.facevaluefi);    // cd  = "Bloomberg";                                        
         cd  = "1";                                                                                         
         if (cl == 0)                                                                                        
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // cd = " ММВБ" ;                                       
             cd = "2" ;                                                                                        
         end;                                                                                                
         if (cl == 0)                                                                                        
             cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);  // cd = "Мотивированное суждение ";                  
             cd = "1";                                                                                 
         end;                                                                                                
    else                                                                                                        
         cl = GetRate(rs.fiid, 4, repdate, rs.facevaluefi);     // cd = "Мотивированное суждение ";                       
         cd = "1";                                                                                        
         if (cl == 0)                                                                                        
             cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);  // cd = " ММВБ" ;                                       
             cd = "2" ;                                                                                        
         end;                                                                                                       
    end; 
    if (rs.ficode == 2010015091376)    
        cl=0.0;                    
    end;                               
    if (cl == 0.0)                    
        return "Н/Д"                      
    end;
    if (rs.ficode == 2010015155540)                                                  
        cl = GetRate(rs.fiid, 1001, repdate, rs.facevaluefi);       
        cd = "2 "                                                                                           
    end;                                                                                                                                                   
    return cd;                                                                                                          
  END;  
  
  PRIVATE MACRO Cost4   
    return "";  
  END;  
                 
  PRIVATE MACRO Create()
     VAR dl_leg      = TRecHandler( "dl_leg.dbt" );
     VAR DataQuery;
     VAR DealBuy;
     VAR AddWhere:string = "";
     VAR AvrFIID:integer, AvrKind:integer;       
     VAR QntySold:money = $0, SumBvpr:money = $0;
     VAR NKD:money = $0;
     VAR BuyDealTime:time, BuyPrice:double = 0.0;
     VAR StrNumbDeal1, StrNumbDeal2;
     VAR IsBlock;
            
     OD1_Form.GetFieldValue( PNFLD_OD1_DATE, @RepDate );

     NFinRez = 0;
     NNDFL = 0;

     // Проверка наличия данных
     cmdtemp = RSDCommand("select * from tRSHB_Portfolio_PKL_2CHD where report_dt = ?");
     cmdtemp.AddParam("", RSDBP_IN, RepDate);
     rstemp = TRSBDataSet(cmdtemp);
     if (not rstemp.movenext)
         cmdtemp = RSDCommand("begin rsFillPortfolio (?); end;");
         cmdtemp.addParam( "", RSDBP_IN, repDate );
         cmdtemp.Execute();
     end;

     DataQuery = "select e.portfolio, codes.t_code avrcode, substr(e.account_number_2,10,4)  depname, e.account_number_2  account, nvl(round(war.t_incomerate,t_incomepoint), 0) coupincomerate, nvl(war.t_incomevolume, 0) coupincomevolume, " +
                 " e.*, fi.t_fiid, fi.t_facevaluefi, fi.t_avoirkind avoirkind, fi.t_fi_code ficode, e.balance_price BalCost, (select count(*) from dpartyown_dbt where t_partykind=52 and t_partyid=fi.t_issuer ) flag_mez, fi.t_issuer issuerid, " +
                 "rsi_rsb_fiinstr.ConvSum((select sum(y.amount) from DPORTFOLIO_TMP y where y.t_account=e.account_number_2  and y.t_fiid=fi.t_fiid and y.t_portfid=e.portfolio and y.report_dt = e.report_dt), fi.t_facevaluefi ,0," + GetSQLDate( RepDate ) + ") dealcostsum, " +
                 " nvl((war.t_drawingdate - war.t_firstdate + 1), 0) as d1, " +
                 " nvl((select w1.t_drawingdate - w1.t_firstdate + 1 from  dfiwarnts_dbt w1 where  t_ispartial = CHR (0) and  fi.t_fiid = w1.t_fiid  and w1.t_drawingdate = " +
                 " (SELECT MIN (t.t_drawingdate) FROM dfiwarnts_dbt t WHERE t.t_fiid = fi.t_fiid AND t_ispartial = CHR (0)  AND t.t_drawingdate > " + GetSQLDate( RepDate ) + ")), 0) as d2, " +
                 "nvl(to_char(war.t_drawingdate,'dd.mm.yyyy'),'') coupdrawingdate, to_char(e.repay_dt,'dd.mm.yyyy') t_drawingdate, fi.t_fi_code, e.fi_group kname, /*e.security_name*/ fi.t_name avrname, e.issuer issuer, e.isin isin, e.reg_number lsin, e.currency facevaluefi, rsb_fiinstr.FI_GetNominalOnDate(fi.t_fiid, " + GetSQLDate( RepDate ) + ", 0) NominalVal, (war.t_drawingdate - " + GetSQLDate( RepDate ) + ") days " +
                 "from tRSHB_Portfolio_PKL_2CHD e, dfiwarnts_dbt war, dobjcode_dbt codes, dfininstr_Dbt fi, davrkinds_dbt kinds, davoiriss_dbt avr " +
                 "where e.report_dt = " + GetSQLDate( RepDate ) + " and fi.t_fiid = war.t_fiid(+) and war.t_ispartial(+)=chr(0) and   war.t_drawingdate(+) >= " + GetSQLDate( RepDate ) + " and war.t_firstdate(+) <= " + GetSQLDate( RepDate ) +  
                 " and codes.t_objectid(+)=fi.t_fiid and codes.t_codekind(+)=103 and t_objecttype(+)=9 and fi.t_fiid = avr.t_fiid " +
                 "and e.isin=avr.t_isin   and avr.t_isin <> chr(1) and kinds.t_fi_kind=2 and fi.t_avoirkind=kinds.t_avoirkind and kinds.t_root=17 and e.account_number_2 like '50%'" +
                 " union " +
                 "select e.portfolio, codes.t_code avrcode, substr(e.account_number_2,10,4)  depname, e.account_number_2  account, nvl(round(war.t_incomerate,t_incomepoint), 0) coupincomerate, nvl(war.t_incomevolume, 0) coupincomevolume, " +
                 " e.*, fi.t_fiid, fi.t_facevaluefi, fi.t_avoirkind avoirkind,fi.t_fi_code ficode, e.balance_price BalCost, (select count(*) from dpartyown_dbt where  t_partykind=52 and t_partyid=fi.t_issuer  ) flag_mez, fi.t_issuer issuerid, " +
                 "rsi_rsb_fiinstr.ConvSum((select sum(y.amount) from DPORTFOLIO_TMP y where y.t_account=e.account_number_2 and y.t_fiid=fi.t_fiid  and y.t_portfid=e.portfolio  and y.report_dt = e.report_dt), fi.t_facevaluefi ,0," + GetSQLDate( RepDate ) + ") dealcostsum, " +
                 " nvl((war.t_drawingdate - war.t_firstdate + 1), 0) as d1, " +
                 " nvl((select w1.t_drawingdate - w1.t_firstdate + 1 from  dfiwarnts_dbt w1 where  t_ispartial = CHR (0) and  fi.t_fiid = w1.t_fiid  and w1.t_drawingdate = " +
                 " (SELECT MIN (t.t_drawingdate) FROM dfiwarnts_dbt t WHERE t.t_fiid = fi.t_fiid AND t_ispartial = CHR (0)  AND t.t_drawingdate > " + GetSQLDate( RepDate ) + ")), 0) as d2, " +
                 "nvl(to_char(war.t_drawingdate,'dd.mm.yyyy'),'') coupdrawingdate, to_char(e.repay_dt,'dd.mm.yyyy') t_drawingdate, fi.t_fi_code, e.fi_group kname, /*e.security_name*/ fi.t_name avrname, e.issuer issuer, e.isin isin, e.reg_number lsin, e.currency facevaluefi, rsb_fiinstr.FI_GetNominalOnDate(fi.t_fiid, " + GetSQLDate( RepDate ) + ", 0) NominalVal, (war.t_drawingdate - " + GetSQLDate( RepDate ) + ") days " +
                 "from tRSHB_Portfolio_PKL_2CHD e, dfiwarnts_dbt war, dobjcode_dbt codes, dfininstr_Dbt fi, davrkinds_dbt kinds " +
                 "where e.report_dt = " + GetSQLDate( RepDate ) + " and fi.t_fiid = war.t_fiid(+) and war.t_ispartial(+)=chr(0) and   war.t_drawingdate(+) >= " + GetSQLDate( RepDate ) + " and war.t_firstdate(+) <= " + GetSQLDate( RepDate ) +  
                 "and codes.t_objectid(+)=fi.t_fiid and codes.t_codekind(+)=103 and t_objecttype(+)=9 " +
                 "and fi.t_name = e.security_name and kinds.t_fi_kind=2 and fi.t_avoirkind=kinds.t_avoirkind and kinds.t_root=17 and e.account_number_2 like '50%'" +
                 " order by account ";

     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Current = 0;

     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"\"Остаток ценных бумаг в портфеле\"" , HTML_StSheetName);
     end;
     PrevFi = 0;
     PrevS = 0;
     v_s_BuyCost = 0; v_s_BuyNKD = 0; v_s_BuyTotalCost = 0; v_s_SaleCost = 0; v_s_SaleNKD = 0; v_s_SaleTotalCost = 0; v_s_ComS = 0; v_s_ComB = 0; v_s_FinRez = 0;

     RS = TRsbDataSet( DataQuery );
     while( RS.MoveNext() )
            GETACCOUNTS;
            v_account = "";
            v_amount = 0;
            m_IsDataExist = true;
            PrintLine( /*1 */     FICode,
                       /*2 */     Filial,
                       /*3 */     AccBal,
                       /*4 */     Acc,
                       /*5 */     FIName,
                       /*6 */     Seria,
                       /*7 */     Emitent,
                       /*8 */     ISIN,
                       /*9 */     GosReg,
                       /*10*/     NomFI,
                       /*11*/     Amount,
                       /*12*/     NominalRUR,
                       /*13*/     Nominal,
                       /*14*/     BalCostRUR,
                       /*15*/     SumRUR,
                       /*16*/     UNKD,
                       /*17*/     PKD,
                       /*18*/     Premia,
                       /*19*/     Discont,
                       /*20*/     Pereots,
                       /*21*/     Reserv,
                       /*22*/     BalCost,
                       /*23*/     Balcostminus,
                       /*24*/     LastCost,
                       /*25*/     Dohod,
                       /*26*/     DrawingDate,
                       /*27*/     CoupProc,
                       /*28*/     CoupPeriod,
                       /*29*/     NearDate,
                       /*30*/     DayS,
                       /*31*/     Cost1,
                       /*32*/     Cost2,
                       /*33*/     Cost3,
                       /*34*/     Country1,
                       /*35*/     Country2,
                       /*36*/     Country3,
                       /*37*/     Portf,
                       /*38*/     AgName,
                       /*39*/     FIRate,
                       /*40*/     DohodEff,
                       /*41*/     ReservMSFO,
                       /*42*/     FPRSBU1,
                       /*43*/     FPRSBU2,
                       /*44*/     PereotsChange,
                       /*45*/     NaDoh,
                       /*46*/     NaRash,
                       /*47*/     FPRSBU3,
                       /*48*/     getCORRINTTOEIR(RS.fiid, RepDate),
                       /*49*/     RatePlace,
                       /*50*/     ActPlace,
                       /*51*/     Ierarh,
                       /*52*/     Cost4,
                                  0
                     );

            ProgressValue.Current = ProgressValue.Current + 1;
            ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;
     ProgressIndicator.Stop();

  END;
  
  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  OD1_Form = DL_OD1_Panel();

  stat = OD1_Form.Run();

  if( stat )
      OD1_Report = SP_OD1_Report( null, "Report_msfo8.xls", null, IsWebService, ReportHashCode );
      OD1_Report.Run();

      Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  end;

  return FullReportFileNames;
END;
