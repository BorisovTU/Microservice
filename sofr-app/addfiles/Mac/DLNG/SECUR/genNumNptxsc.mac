/*
genNumNptxsc.mac
Геращенков А.А, 15.05.2020
Пользовательский макрос референса 168 - "Номер списания/зачисления денежных средств"

Разделение нумерации операций списания и зачисления денежных средств

1. создать пользовательские последовательности для операции списания денежных средств аналогично дистрибутивному 181 - "Номер списания/зачисления денежных средств"
2. создать пользовательские референсы для операции списания и зачисления денежных средств аналогично дистрибутивному 168 - "Номер списания/зачисления денежных средств"
   в пользовательском референсе для операции списания денежных средств выбрать пользовательский описатель последовательности, созданный в п.1;
   в пользовательском референсе для операции зачисления денежных средств выбрать описатель последовательности 181 - "Номер списания/зачисления денежных средств"
   указать номера пользовательских референсов в константах REF_TO_SPIS, REF_TO_ZACH. 
2. изменить дистрибутивный описатель референса 168 - "Номер списания/зачисления денежных средств" указав: 
   тип расчета референса - "С использованием макроса""
   имя макрофайла        - "genNumNptxsc.mac"
   имя макропроцедуры    - "genNum"
3. в описателях последовательности для операции списания задать текущие значения счетчика, соответствующее последнему номеру операции списания денежных средств (Alt+H/Enter/поле "Последние значение")
*/

IMPORT RSD;
IMPORT dpinter;
IMPORT BankInter;
IMPORT RsbDataSet;
IMPORT SPinter;
IMPORT "globals.mac";
IMPORT cb_sql;

PRIVATE RECORD nptxop  ( nptxop );     //GAA

PRIVATE CONST REF_TO_SPIS = 1000014;
PRIVATE CONST REF_TO_ZACH = 1000015;

PRIVATE MACRO genReftoSpis(Contract) // контракт (для определения единого кода)
   var ref = "", Dt1 ;

   if (generateReference(REF_TO_SPIS, ref, 0, nptxop) != 0)    //gaa
   end;

   Dt1 = TRsbDataSet(" select t_code from ddlobjcode_dbt where t_objecttype = 207 and t_codekind = 1 and t_objectid = ( " + 
                       " select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid =  " +Contract+ " )  ");

   if (Dt1.movenext())
      return Dt1.t_code+"/"+ ref;
   else
      return ref;
   end;

END;

PRIVATE MACRO genReftoZach()
   var ref = "";
   
   if (generateReference(REF_TO_ZACH, ref) != 0)          //gaa
   end;

   return ref;
END;

PRIVATE MACRO isOperZach(kind , subkind)      // возможно kind лишний
  if(kind == 2037)
    if (subkind == 20)  
       return false;     
    else
       return  true;
    end;
  end; 
END;

/* Аналог оператора ?: в си. */
PRIVATE MACRO IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else
      return value_false;
   end;
END;

MACRO genNum( Value, ObjKind, AddrBuf )
   var isZach = false;
   SetBuff (nptxop, AddrBuf);

   if (isZach == false) 
      isZach = isOperZach( nptxop.kind_operation, nptxop.subkind_operation);
   end;

   if ( isZach )
      return genReftoZach();
   else
      return genReftoSpis(nptxop.Contract);
   end;
END;
/*
MACRO MassGenNum ()
   var isClientOperation = false;
   var sql_cl, sql_b, cmd_cl, cmd_b, ref_cl, ref_b, DataSet;

   var rs = TRsbDataSet("select * from DOPRTEMP_tmp ");
   sql_execute("delete DREFGENPRM_TMP_TMP");
   sql_execute("insert into DREFGENPRM_TMP_TMP (select * from drefgenprm1_tmp)");
   sql_execute("delete drefgenprm1_tmp");
   while (rs.movenext())
          sql_cl = "select /*gr.t_recipient, spg.t_SPGROUNDID*/ * from dspground_tmp spg, ddpgrrep_dbt gr "
                " where spg.T_SPGROUNDID = gr.t_ID and gr.t_SourceDocID = ? AND gr.t_SourceDocKind = ? and spg.t_Xld = CHR(1) order by spg.t_SPgroundID ";
          cmd_cl = RSDCommand( sql_cl );
          cmd_cl.addParam( "", RSDBP_IN, rs.OrderID );
          cmd_cl.addParam( "", RSDBP_IN, rs.DOCKIND );
          cmd_cl.Execute();
          DataSet = TRsbDataSet(cmd_cl);
          while(DataSet.moveNext())
                 isClientOperation = false;
                 if (isClientOperation == false) 
                       //isClientOperation = m_isClientJournal(rs.DOCUMENTID);
                       isClientOperation = isClientJournal_out(DataSet.recipient);
                 end;

                 if ( isClientOperation )
                      ref_cl = genReftoClient();
                 else
                      ref_cl = genReftoBank(date(DataSet.registrdate));
                 end;
                 
                 sql_execute("insert into drefgenprm1_tmp (select * from DREFGENPRM_TMP_TMP where T_OBJECTID = " + DataSet.SPGROUNDID + ")");
                 sql_b = "UPDATE drefgenprm1_tmp SET t_RefNum = ?, T_METERDATE = ? where T_OBJECTID = ? ";

                 cmd_b = RSDCommand( sql_b );
                 cmd_b.addParam( "", RSDBP_IN, ref_cl );
                 cmd_b.addParam( "", RSDBP_IN, {curdate});
                 cmd_b.addParam( "", RSDBP_IN, DataSet.SPGROUNDID );
                 SQL_Execute( cmd_b );
          end;
   end;       

   return 0;
END; */