/**                                                                                                             
 @file InvestDescription_Form.mac                                                                                           
 @brief Форма ввода параметров для отчета "Расшифровка оценки портфеля"  

 #menu 
  - БО ЦБ\Отчеты\РСХБ\Инвест.советник\Расшифровка оценки портфеля                                                                                                                                                                                                                          
                                                                                                                
 # tag                                                                                                          
 - functional_block:Отчетность_Внутренняя   
 - functional_block:Отчетность_Клиент                                                                                                                                                       
 - code_type:Report                                                                                                
                                                                                                                
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2024.01.17 |Жиц М.В.       |BIQ-14887           |Создание макроса для обработки формы                                                                                                                                                 
*/ 

import "DlRepForm_h.mac", SFInter;

PRIVATE CONST PNFLD_INVDESCR_BEGDATE  = 0,   
              PNFLD_INVDESCR_ENDDATE  = 1,  
              PNFLD_INVDESCR_CLNTCODE = 2,
              PNFLD_INVDESCR_CLNTNAME = 3,    
              PNFLD_INVDESCR_CONTRACT = 4; 

PRIVATE CONST H_PNFLD_CONTRACT = 100;

PRIVATE CONST COMMISS_INVEST_ADVISER = "ИнвестСоветник"; 

/**
 @brief Класс параметров запуска отчета Расшифровка оценки портфеля
*/                    
CLASS InvestDescriptionParams()
  var BegDate:date = {curdate},             //Дата начала периода
      EndDate:date = {curdate},             //Дата окончания периода
      ClientID:integer = -1,                //Индентификатор клиента
      DlContrID:integer = -1,               //Идентификатор ДБО
      ComNumber:integer = 0,                //Номер комиссии
      FeeType:integer = SF_FEE_TYPE_PERIOD, //Тип взимания комиссии
      PrintRep:bool = false,                //Признак вывода отчетов на экран
      ContrNumber:string = "";              //Номер ДБО
END;

/**
 @brief Получим номер комиссии по коду
 @param[in] ComCode код комиссии
 @return номер комиссии
*/                    
MACRO GetCommissNumber(ComCode:string):integer
  var cmd;

  cmd = RSDCommand("BEGIN ? := RSB_BASESUM.GetCommissNumber(:p_ComCode); END;");
  cmd.addParam("Number", RSDBP_OUT, V_INTEGER); 
  cmd.addParam("", RSDBP_IN, ComCode);
  cmd.execute();

  return cmd.value("Number");
END;

/**
 @brief Обработчик поля "Дата с"
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO FldProc_BeginDate(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  if(Cmd == DLG_INIT) /*Установка значения в поле*/
    if(FldRealValue == null) /*инициализация по умолчанию*/
      FldRealValue = {curdate};
    end;
    FldShowValue = FldRealValue;
  elif(Cmd == DLG_CHANGEVALUE) 
    FldRealValue = FldShowValue;
    if((FldRealValue != null) AND (pThis.GetLinkedValue(DL_PNFLD_ENDDATE) != null))
      if(FldRealValue > pThis.GetLinkedValue(DL_PNFLD_ENDDATE))
        pThis.SetLinkedValue(DL_PNFLD_ENDDATE, FldRealValue);
      end;
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

/**
 @brief Обработчик поля "Дата по"
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO FldProc_EndDate(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  if(Cmd == DLG_INIT) /*Установка значения в поле*/
    if(FldRealValue == null) /*инициализация по умолчанию*/
      FldRealValue = {curdate};
    end;
    FldShowValue = FldRealValue;
  elif(Cmd == DLG_CHANGEVALUE) 
    FldRealValue = FldShowValue;
    if((FldRealValue != NULL) AND (pThis.GetLinkedValue(DL_PNFLD_BEGINDATE) != null))
      if(FldRealValue < pThis.GetLinkedValue(DL_PNFLD_BEGINDATE))
        pThis.SetLinkedValue(DL_PNFLD_BEGINDATE, FldRealValue);
      end;
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

/**
 @brief Обработчик поля по-умолчанию
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO Default(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null) /*инициализация по умолчанию*/
      FldRealValue = "";
    end;
    FldShowValue = FldRealValue;
  elif(Cmd == DLG_CHANGEVALUE) /*значение поля было изменено*/
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

/**
 @brief Поиск субъекта по его коду
 @param[in] CodeKind вид кода
 @param[in] Code код субъекта
 @return идентификатор субъекта
*/                    
PRIVATE MACRO ПолучитьСубъектаПоКоду(CodeKind:integer, Code:string):integer
  var cmd, DataSet;
  var PartyID:integer = -1;
  
  cmd = DL_RSDCommand(" select objcode.t_ObjectID " +
                      "   from dobjcode_dbt objcode " +
                      "  where objcode.t_ObjectType = " + OBJTYPE_PARTY +
                      "    and objcode.t_CodeKind = ? " +
                      "    and objcode.t_State = 0 " +
                      "    and objcode.t_Code = ? ");
  cmd.AddParam(CodeKind);
  cmd.AddParam(Code);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    PartyID = DataSet.ObjectID;
  end;

  return PartyID;
END;

/**
 @brief Обработчик поля "Клиент"
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO FldProc_Client(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT):INTEGER
  var Party    = TRecHandler("party.dbt");
  var partcode = TBFile("partcode.dbt", "R", 0);
  var saveFldRealValue = FldRealValue;
  var PartyID:integer = -1;

  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
    end;
    if(FldRealValue <= 0)
      FldShowValue = STR_ALLVALUE;
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
    else
      partcode.Clear();
      partcode.rec.PartyID  = FldRealValue;
      partcode.rec.CodeKind = PTCK_CONTR;
      if(partcode.GetEQ())
        FldShowValue = partcode.rec.Code;
        if(ПолучитьСубъекта(FldRealValue, Party) == 0)
          pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, Party.rec.ShortName);
        end;
      end;
    end;
  elif(Cmd == DLG_CHANGEVALUE) /*значение поля было изменено*/
    if((FldShowValue == STR_ALLVALUE) OR (FldShowValue == ""))
      FldRealValue = -1;
      FldShowValue = STR_ALLVALUE;
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
    else
      PartyID = ПолучитьСубъектаПоКоду(PTCK_CONTR, FldShowValue); 
      if(PartyID > -1)
        FldRealValue = PartyID;
        if(ПолучитьСубъекта(FldRealValue, Party) == 0)
          pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, Party.rec.ShortName);
        end;
      else
        FldRealValue = -1;
        FldShowValue = STR_ALLVALUE;
        pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
      end;
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = STR_ALLVALUE;
    pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, STR_ALLVALUE);
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3)) /*Вызов листалки и заполнение FldShowValue и FldRealValue*/
    Party = TRecHandler("party.dbt");
    if(ListPT(Party, PTCK_CONTR, "", PTLIST_STOCKDLCLIENT, PTCK_ALL) == true) 
      FldRealValue = Party.rec.PartyID;
      partcode.Clear();
      partcode.rec.PartyID  = Party.rec.PartyID;
      partcode.rec.CodeKind = PTCK_CONTR;
      if(partcode.GetEQ())
        FldShowValue = partcode.rec.Code;
      end;
      pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_NAME, Party.rec.ShortName);
    end;
  end;

  if(saveFldRealValue != FldRealValue)
    if(pThis.GetLinkedValue(H_PNFLD_CONTRACT) != -1)
      pThis.SetLinkedValue(H_PNFLD_CONTRACT, -1);
    end;
  end;

  return CM_DEFAULT;
END;

/**
 @brief Листалка ДБО
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @param[in] X координата левого верхнего угла отображения листалки по горизонтали
 @param[in] Y координата левого верхнего угла отображения листалки по вертикали
 @param[in/out] PartyID идентификатор клиента
 @param[in] Department подразделение банка
 @param[in] BegDate дата начала расчета
*/                    
PRIVATE MACRO ListDlContr(FldShowValue:@VARIANT, FldRealValue:@VARIANT, X:INTEGER, Y:INTEGER, PartyID:@INTEGER, Department:integer, BegDate:date)
  var Choice, i = 0, flag = false; 
  var Select;
  Select = "select sfc.t_id, sfc.t_DateBegin, sfc.t_DateClose, sfc.t_Number, prt1.t_ShortName ClientName, prt1.t_PartyID as t_PartyID, sfc.t_Department as t_Department, " + 
           "   (CASE WHEN sfc.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sfc.t_DateClose > "+GetSQLDate(BegDate)+" THEN 'Открыт' ELSE 'Закрыт' END) as t_StatusName, " +
           "   dlc.t_IIS, dlc.t_DlContrID, " +
           "   (CASE WHEN dlc.t_UseSubAcc = 'X' THEN CHR(0) ELSE 'X' END) EDP "
           "  from ddlcontr_dbt dlc, dsfcontr_dbt sfc, dparty_dbt prt1 "+
           " where sfc.t_ID = dlc.t_SfContrID " +
           "   and prt1.t_PartyID = sfc.t_partyID " ;

  if(PartyID > 0)
    Select = Select + " and sfc.T_PARTYID = " + PartyID;
  end;

  if((Department != null) and (Department > 0))
    Select = Select + "   and sfc.t_Department = "+string(Department)+
                      "   and sfc.t_Branch = 0";
  end;

  Choice = DL_Scroll(Select,
                     "Договора брокерского обслуживания", X, Y,
                     "t_Number",     "№ договора",
                     "ClientName",   "Клиент",
                     "t_DateBegin",  "Дата открытия",
                     "t_DateClose",  "Дата закрытия",
                     "t_StatusName", "Статус",
                     "t_IIS",        "ИИС",
                     "EDP",          "ЕДП"
                    );

  if(Choice != NULL)
    FldRealValue = Choice.Value("t_DlContrID"); 
    FldShowValue = Choice.Value("t_Number");
    PartyID      = Choice.Value("t_PartyID");
  end;
END;

/**
 @brief Обработчик поля "№ договора"
 @param[in] pThis параметры формы
 @param[in] Cmd код действия
 @param[in] Key код клавиши
 @param[in/out] FldShowValue отображаемое значение поля
 @param[in/out] FldRealValue реальное значение поля
 @return код дальнейшего действия
*/                    
PRIVATE MACRO FldProc_Contract_BO_Dep(pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var ClientID = pThis.GetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE);
  var BegDate  = pThis.GetLinkedValue(DL_PNFLD_BEGINDATE);

  if(Cmd == DLG_INIT)
    if(FldRealValue == null)
      FldRealValue = -1;
    end;
    if(FldRealValue <= 0)
      FldShowValue = STR_ALLVALUE;
    end;
  elif((Cmd == DLG_KEY) AND (Key == KEY_SPACE)) 
    FldRealValue = -1;
    FldShowValue = STR_ALLVALUE;
  elif((Cmd == DLG_KEY) AND (Key == KEY_F3))
    ListDlContr(@FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), @ClientID, {OperDprt}, BegDate);
    pThis.SetLinkedValue(DL_PNFLD_CLIENT_STOCKDL_CODE, ClientID);
  end;

  return CM_DEFAULT;
END;

/**
 @brief Класс формы для отчета Расшифровка оценки портфеля
*/                    
CLASS (DL_CPanel) InvestDescription_Panel()
  private var m_FormData = InvestDescriptionParams(); //Параметры запуска отчета

  /**
   @brief Инициализация параметров формы, назначения обработчиков полей
  */                    
  PRIVATE MACRO Init()
    AddFieldProc(0, PNFLD_INVDESCR_BEGDATE,   DL_PNFLD_BEGINDATE,           @FldProc_BeginDate,       m_FormData.BegDate); 
    AddFieldProc(0, PNFLD_INVDESCR_ENDDATE,   DL_PNFLD_ENDDATE,             @FldProc_EndDate,         m_FormData.EndDate);                 
    AddFieldProc(0, PNFLD_INVDESCR_CLNTCODE,  DL_PNFLD_CLIENT_STOCKDL_CODE, @FldProc_Client,          m_FormData.ClientID);
    AddFieldProc(0, PNFLD_INVDESCR_CLNTNAME,  DL_PNFLD_CLIENT_STOCKDL_NAME, @Default,                 m_FormData.ClientID);
    AddFieldProc(0, PNFLD_INVDESCR_CONTRACT,  H_PNFLD_CONTRACT,             @FldProc_Contract_BO_Dep, m_FormData.DlContrID);
  END;

  /**
   @brief Проверка параметров формы
   @return true, если проверка пройдена успешно
   @return false, если в процессе проверки были обнаружены ошибки
  */                    
  PRIVATE MACRO Check():BOOL
    return true;
  END;

  /**
   @brief Получение параметров панели
   @return параметры панели 
  */ 
  MACRO GetParams()
    return m_FormData;
  END;

  /**
   @brief Запуск формы с последующей записью полученных параметров
   @return true, если форма отработала успешно и была подтверждена по F2
   @return false, если в процессе работы формы возникли ошибки или из нее вышли по Esc
  */                    
  MACRO Run()
    var stat = Run();

    m_FormData.BegDate   = GetFieldValue(PNFLD_INVDESCR_BEGDATE);
    m_FormData.EndDate   = GetFieldValue(PNFLD_INVDESCR_ENDDATE);
    m_FormData.ClientID  = GetFieldValue(PNFLD_INVDESCR_CLNTCODE);
    m_FormData.DlContrID = GetFieldValue(PNFLD_INVDESCR_CONTRACT);
    m_FormData.ComNumber = GetCommissNumber(COMMISS_INVEST_ADVISER);

    return stat;
  END;
  
  initDL_CPanel("sp_rep.lbr", "INVDESCR"); 
END;
