/*
$Name:         securown040.mac
$Module:       Ценные бумаги
$Description:  Шаг - Исполнение
*/
IMPORT InsCarryDoc, "sp_class.mac", "oprmassexec.mac";


PRIVATE MACRO __ExecuteStep( FD:SPFirstDoc, dat:DATE ):INTEGER

  if( FD != NULL ) // единичное исполнение
     if( ПроверитьТОНаПросроченность(FD.GetRQ(DLRQ_TYPE_DELIVERY), "поставке", true) == false )
        return 1;
     end;

     if( ПроверитьТОНаПросроченность(FD.GetRQ(DLRQ_TYPE_PAYMENT), "оплате", true) == false )
        return 1;
     end;

     if(УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_DELIVERY), DLRQ_STATE_EXEC, Dat) != 0)
       return 1;
     end;

     if(УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_PAYMENT), DLRQ_STATE_EXEC, Dat) != 0)
       return 1;
     end;

     if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERYOWN, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
       return 1;
     end;

     if(DL_ExecDealMarketTestOwn(FD.tick.rec.DealID, FD.tick.rec.DealDate) != 0)
       return 1;
     end;

  else
          
     if( SC_MassRQCheckOverdue(DLRQ_TYPE_DELIVERY, 1, "поставке") != 0 )
        return 1;
     end;

     if( SC_MassRQCheckOverdue(DLRQ_TYPE_PAYMENT, 1, "оплате") != 0 )
        return 1;
     end;

     if( SP_Mass_SaveRqStatus_ExecOper(1) != 0 )
        return 1;
     end;

     if( SP_Mass_UpdateRqStatus_ExecOper( DATE_DEALSETAVOIRISS, 1, DL_SECUROWN ) != 0)
       return 1;
     end;

     if( SP_Mass_SaveDLGRDEAL( DLGR_TEMPL_DELIVERYOWN, DLGR_ACCKIND_BACKOFFICE ) != 0)
       return 1;
     end;

     if( SP_Mass_UpdateGrDealAcc( DLGR_TEMPL_DELIVERYOWN, DLGR_ACCKIND_BACKOFFICE, DLGRACC_STATE_FACTEXEC ) != 0 )
       return 1;
     end;
     
     if( SP_Mass_SaveDealMarketTestOwn()!= 0 )
       return 1;
     end;

     if( SP_Mass_ExecDealMarketTestOwn() != 0 )
       return 1;
     end;

  end;

  return 0;
end;

macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step )

  record deal(dl_tick);
  var    FD, dat;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc ( deal, false );
  
  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat );

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( not FD.CheckCliring( false ) ) 
     return 1;
  end;

  if(CheckTransfer(FD) != 0)
    return 1;
  end;

  return __ExecuteStep( FD, dat );
end;

/* Массовое исполнение БИРЖЕВЫХ сделок с одной частью. В дистрибутиве это операция
  3143 - Покупка ц/б биржевая
*/
MACRO MassExecuteStep()
  return __ExecuteStep( NULL );
END;
