/*
$Name:        DifNDRCar.mac
$Module:      Ценные бумаги
$Description: Отчет "Расхождения между бух. учетом НДФЛ и объектами НДР"
*/

import "DifNDRCar_Form.mac", "DlReport_h.mac", "oralib.mac", "cb_sql.mac";

var Form = DifNDRCar_Form();

CLASS (DL_CReportTemplate) DifNDRCar_Report()
   var m_BegDate:Date,
       m_EndDate:Date;

   macro BeginReport()
      m_BegDate = Date(Form.GetFieldValue(DIFNDRCAR_BEGDATE));
      m_EndDate = Date(Form.GetFieldValue(DIFNDRCAR_ENDDATE));
   end;

   macro PrintHeader()
      PrintFormatString(NULL, "N1_H0_1", string(m_BegDate:f));
      PrintFormatString(NULL, "N1_H0_2", string(m_EndDate:f));

      var Year;
      DateSplit(m_EndDate, NULL, NULL, Year);
      PrintFormatString(NULL, "N1_Year", string(Year));
   end;

   macro Create()
      var Num:Integer = 1;
      var sessId = GetDBSessionID();
   
      PrintHeader();

      RegisterTable("N1_MainTable",
                    NULL,
                    "N1_Num",
                    "N1_OperDate",
                    "N1_Client",
                    "N1_Contract",
                    "N1_AccDeb",
                    "N1_AccCred",
                    "N1_BalSumRub",
                    "N1_ObjectType",
                    "N1_TaxPaid",
                    "N1_DifSumRub");

      BegAction(2000, "Удаление старых буферных данных", false);
      execSQL( "delete from DDIFNDRTMP_DBT where t_SessionId = " + String(sessId:0:0) + " or t_date < TRUNC(SYSDATE)" );
      EndAction();

      var query = " INSERT INTO DDIFNDRTMP_DBT (T_SESSIONID, " +
                  "                             T_DOCID, " +
                  "                             T_OPERDATE, " +
                  "                             T_PERSONID, " +
                  "                             T_CLIENT, " +
                  "                             T_CONTRACT, " +
                  "                             T_ACCDEB, " +
                  "                             T_ACCCRED, " +
                  "                             T_BALSUMRUB, " +
                  "                             T_OBJECTTYPE, " +
                  "                             T_TAXPAID, " +
                  "                             T_ACCTRNID, " +
                  "                             T_OBJID) " +
                  "select "+ String(sessId:0:0) + ","+
                  "       q.t_DocID, " +
                  "       q.t_OperDate, " +
                  "       persn.t_PersonID, " +
                  "       persn.t_Name1 || ' ' || persn.t_Name2 || ' ' || persn.t_Name3 as t_Client, " +
                  "       nvl(sfcontr.t_Number, chr(0)) as t_Contract, " +
                  "       q.t_AccDeb, " +
                  "       q.t_AccCred, " +
                  "       q.t_BalSumRub, " +
                  "       nvl(nptxkind.t_Code, chr(0)) as t_ObjectType, " +
                  "       q.t_TaxPaid, " +
                  "       q.t_AccTrnID, " +
                  "       q.t_ObjID " +
                  "from ( " +
                  //1.	операции вывода денежных средств и удержания НДФЛ, дата операции которых попадает в заданный в панели операции период;
                  "        select nptxop.t_ID as t_DocID, " +
                  "               nptxop.t_OperDate, " +
                  "               nptxop.t_Client, " +
                  "               ( " +
                  "                  case nptxobj.t_AnaliticKind6 " +
                  "                     when " + string(TXOBJ_KIND6020) +
                  "                     then ( " +
                  "                             case " +
                  "                                when nvl(nptxobj.t_Analitic6, 0) > 0 " +
                  "                                then nptxobj.t_Analitic6 " +
                  "                                else nvl(nptxop.t_Contract, 0) " +
                  "                              end " +
                  "                          ) " +
                  "                     else nvl(nptxop.t_Contract, 0) " +
                  "                  end " +
                  "               ) as t_Contract, " +
                  "               nvl(acctrn.t_Account_Payer, chr(0)) as t_AccDeb, " +
                  "               nvl(acctrn.t_Account_Receiver, chr(0)) as t_AccCred, " +
                  "               ( " +
                  "                  case " +
                  "                     when substr(acctrn.t_Account_Payer, 1, 5) in ('30601', '30606') and substr(acctrn.t_Account_Receiver, 1, 5) = '60301' " +
                  "                     then nvl(acctrn.t_Sum_NatCur, 0) " +
                  "                     else nvl(acctrn.t_Sum_NatCur, 0) * -1 " +
                  "                  end " +
                  "               ) as t_BalSumRub, " +
                  "               nvl(nptxobj.t_Kind, 0) as t_ObjectType, " +
                  "               nvl(nptxobj.t_Sum0, 0) as t_TaxPaid, " +
                  "               nvl(acctrn.t_AccTrnID, 0) as t_AccTrnID, " +
                  "               nvl(nptxobj.t_ObjID, 0) as t_ObjID " +
                  "        from dnptxop_dbt nptxop " +
                  "             inner join " +
                  "             ( " +
                  "                ( " +
                  "                   dnptxop_dbt nptxop_1 " +
                  "                   inner join dnptxobdc_dbt obdc " +
                  "                         on obdc.t_DocID = nptxop_1.t_ID " +
                  "                   inner join dnptxobj_dbt nptxobj " +
                  "                         on nptxobj.t_ObjID = obdc.t_ObjID " +
                  "                         and nptxobj.t_Kind in( " + string(TXOBJ_PAIDGENERAL) + ", " +
                                                                       string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                       string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                       string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                       string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                       string(TXOBJ_PAIDGENERAL_15_IIS) +
                  "                                              ) " +
                  "                ) " +
                  "                full outer join " +
                  "                ( " +
                  "                   dnptxop_dbt nptxop_2 " +
                  "                   inner join dmccateg_dbt mccateg on mccateg.t_LevelType = 1 and mccateg.t_Code IN ('НДФЛ к перечислению', 'НДФЛ к возврату', 'НДФЛ к перечислению, FLR', 'НДФЛ к перечислению, FLN', 'НДФЛ к перечислению 15%', 'НДФЛ к возврату 15%') " +
                  "                   inner join doproper_dbt oproper " +
                  "                              on oproper.t_DocKind = nptxop_2.t_DocKind " +
                  "                              and to_number(oproper.t_DocumentID) = nptxop_2.t_ID " +
                  "                   inner join doprdocs_dbt oprdocs " +
                  "                              on oprdocs.t_ID_Operation = oproper.t_ID_Operation " +
                  "                   inner join dacctrn_dbt acctrn " +
                  "                              on acctrn.t_AccTrnID = oprdocs.t_AccTrnID " +
                  "                              and (SUBSTR (acctrn.t_Account_Payer, 1, 5), SUBSTR (acctrn.t_Account_Receiver, 1, 5)) != (select '60301', '30102' from dual) "+
                  "                   inner join dmcaccdoc_dbt mcaccdoc " +
                  "                              on  mcaccdoc.t_DocKind = 0 " + 
                  "                              and mcaccdoc.t_DocID = 0 " + 
                  "                              and mcaccdoc.t_IsCommon = 'X' " +
                  "                              and mcaccdoc.t_CatID = mccateg.t_ID " +
                  "                              and ( " +
                  "                                     ( " +
                  "                                        SUBSTR (acctrn.t_Account_Payer, 1, 5) IN('30601', '30606') " +
                  "                                        and mcaccdoc.t_Account = acctrn.t_Account_Receiver " +
                  "                                     ) " +
                  "                                  or ( " +
                  "                                        SUBSTR (acctrn.t_Account_Payer, 1, 5) in('60301', '60302') " +
                  "                                        and mcaccdoc.t_Account = acctrn.t_Account_Payer " +
                  "                                     ) " +
                  "                                  ) " +     
                  "                ) " +
                  "                on nptxop_2.t_ID = nptxop_1.t_ID " +
                  "                and ( " +
                  "                       ( " +
                  "                          mccateg.t_Code in('НДФЛ к перечислению', 'НДФЛ к возврату', 'НДФЛ к перечислению, FLR', 'НДФЛ к перечислению, FLN') " +
                  "                          and nptxobj.t_Kind in( " + string(TXOBJ_PAIDGENERAL) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                        string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                        string(TXOBJ_PAIDSPECIAL_IIS) +
                  "                                               ) " +
                  "                       ) " +
                  "                    or ( " +
                  "                          mccateg.t_Code in('НДФЛ к перечислению 15%', 'НДФЛ к возврату 15%') " +
                  "                          and nptxobj.t_Kind in( " + string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_IIS) +
                  "                                               ) " +
                  "                       ) " +
                  "                    ) " +
                  "             ) " +
                  "             on nptxop.t_ID = nvl(nptxop_1.t_ID, nptxop_2.t_ID) " +
                  "        where ( " +
                  "                 ( " +
                  "                    nptxop.t_DocKind = " + string(DL_WRTMONEY) +
                  "                    and nptxop.t_SubKind_Operation = 20 " + //операции списания д/с
                  "                 ) " +
                  "                 or nptxop.t_DocKind = " + string(DL_HOLDNDFL) + //операции удержания НДФЛ
                  "              ) " +
                  "          and nptxop.t_OperDate between "+GetSQLDate(m_BegDate)+" and "+GetSQLDate(m_EndDate)+" " +
                  "          and mcaccdoc.t_DepartmentID = acctrn.t_Department " +
                  "        union all " +
                  //Пользовательские объекты НДР и проводки
                  "        select 0 as t_DocID, " +
                  "               nvl(q_nptxobj.t_Date, q_acctrn.t_Date_Carry) as t_OperDate, " +
                  "               nvl(q_nptxobj.t_Client, q_acctrn.t_Client) as t_Client, " +
                  "               ( " +
                  "                  case q_nptxobj.t_AnaliticKind6" +
                  "                     when " + string(TXOBJ_KIND6020) +
                  "                     then nvl(q_nptxobj.t_Analitic6, 0) " +
                  "                     else 0 " +
                  "                  end " +
                  "               ) as t_Contract, " +
                  "               nvl(q_acctrn.t_Account_Payer, chr(0)) as t_AccDeb, " +
                  "               nvl(q_acctrn.t_Account_Receiver, chr(0)) as t_AccCred, " +
                  "               nvl(q_acctrn.t_Sum_NatCur, 0) as t_BalSumRub, " +
                  "               nvl(q_nptxobj.t_Kind, 0) as t_ObjectType, " +
                  "               nvl(q_nptxobj.t_Sum0, 0) as t_TaxPaid, " +
                  "               nvl(q_acctrn.t_AccTrnID, 0) as t_AccTrnID, " +
				      "               nvl(q_nptxobj.t_ObjID, 0) as t_ObjID " +
                  "        from ( " +
                  "                select acctrn.t_Date_Carry, " +
                  "                       accountPayer.t_Client, " +
                  "                       acctrn.t_Account_Payer, " +
                  "                       acctrn.t_Account_Receiver, " +
                  "                       acctrn.t_Sum_NatCur, " +
                  "                       acctrn.t_AcctrnID " +
                  "                from dacctrn_dbt acctrn, daccount_dbt accountPayer " +
                  "                where acctrn.t_Date_Carry between "+GetSQLDate(m_BegDate)+" and "+GetSQLDate(m_EndDate)+" " +
                  "                  and (SUBSTR (acctrn.t_Account_Payer, 1, 5), SUBSTR (acctrn.t_Account_Receiver, 1, 5)) != (select '60301', '30102' from dual) "+
                  "                  and not exists( " +
                  "                                   select 1 " +
                  "                                   from doprdocs_dbt oprdocs " +
                  "                                   where oprdocs.t_AccTrnID = acctrn.t_AccTrnID " +
                  "                                ) " +
                  "                  and ( " +
                  "                         ( " +
                  "                            acctrn.t_AccountID_Payer = accountPayer.t_AccountID " +
                  "                            and substr(acctrn.t_Account_Payer, 1, 5) in('30601', '30606') " +
                  "                            and ( " +
                  "                                   acctrn.t_Account_Receiver like '60301%40' " +
                  "                                   or acctrn.t_Account_Receiver like '60301%69' " +
                  "                                ) " +
                  "                         ) " +
                  "                      or ( " +
                  "                            acctrn.t_AccountID_Receiver = accountPayer.t_AccountID " +
                  "                            and substr(acctrn.t_Account_Payer, 1, 5) in('60301', '60302') " +
                  "                            and substr(acctrn.t_Account_Receiver, 1, 5) not in ('60301', '60302') " +
                  "                         ) " +
                  "                      ) " +
                  "             ) q_acctrn " +
                  "        full outer join ( " +
                  "                           select nptxobj.t_Date, " +
                  "                                  nptxobj.t_Client, " +
                  "                                  nptxobj.t_AnaliticKind6, " +
                  "                                  nptxobj.t_Analitic6, " +
                  "                                  nptxobj.t_Kind, " +
                  "                                  nptxobj.t_Sum0, " +
                  "                                  nptxobj.t_ObjID " +
                  "                           from dnptxobj_dbt nptxobj " +
                  "                           where nptxobj.t_Date between "+GetSQLDate(m_BegDate)+" and "+GetSQLDate(m_EndDate)+" " +
                  "                             and nptxobj.t_Kind in( " + string(TXOBJ_PAIDGENERAL) + ", " +
                                                                           string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                           string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                           string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                           string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                           string(TXOBJ_PAIDGENERAL_15_IIS) +
                  "                                                  ) " +
                  "                             and nptxobj.t_User = chr(88) " +
                  "                             and nptxobj.t_FromOutSyst <> chr(88) " +
                  "                        ) q_nptxobj " +
                  "                        on q_nptxobj.t_Client = q_acctrn.t_Client " +
                  "                        and q_nptxobj.t_Date = q_acctrn.t_Date_Carry " +
                  "     ) q, " +
                  "     dpersn_dbt persn, " +
                  "     dsfcontr_dbt sfcontr, " +
                  "     dnptxkind_dbt nptxkind " +
                  "where persn.t_PersonID = q.t_Client " +
                  "  and sfcontr.t_ID(+) = q.t_Contract " +
                  "  and nptxkind.t_Element(+) = q.t_ObjectType ";

      var bgSql = BackgroundSQLExecuter(query);
      bgSql.Run("Отбор данных в отчет");
      bgSql = null;

      query = "select DISTINCT * from DDIFNDRTMP_DBT WHERE T_SESSIONID = " + String(sessId:0:0) +
              " order by t_OperDate, t_DocID, t_AccTrnID, t_ObjID";
      var cmd = DL_RSDCommand(query);
      var count = cmd.GetCount();

      if(count > 0)
         var DataSet = cmd.Execute();
         RemProgress();

         var OldAccTrnID = -1, OldObjID = -1, AccDeb = "", AccCred = "", BalSumRub = 0, ObjectType = "", TaxPaid = 0;
         var BalSumRub_All = $0;
         InitProgress(count, "Расхождения между бух. учетом НДФЛ и объектами НДР", "Расхождения между бух. учетом НДФЛ и объектами НДР");
         while(DataSet.MoveNext())
            if(OldAccTrnID != DataSet.AccTrnID)
               OldAccTrnID = DataSet.AccTrnID;
               AccDeb = DataSet.AccDeb;
               AccCred = DataSet.AccCred;
               BalSumRub = DataSet.BalSumRub;
            else
               AccDeb = "";
               AccCred = "";
               BalSumRub = 0;
            end;

            if(OldObjID != DataSet.ObjID)
               OldObjID = DataSet.ObjID;
               ObjectType = DataSEt.ObjectType;
               TaxPaid = DAtaSet.TaxPaid;
            else
               ObjectType = "";
               TaxPaid = 0;
            end;

            PrintTableLine("N1_Num", string(Num), NULL,
                           "N1_OperDate", string(Date(DataSet.OperDate):f), NULL,
                           "N1_Client", string(DataSet.Client), NULL,
                           "N1_Contract", DataSet.Contract, NULL,
                           "N1_AccDeb", AccDeb, NULL,
                           "N1_AccCred", AccCred, NULL,
                           "N1_BalSumRub", string(BalSumRub), NULL,
                           "N1_ObjectType", ObjectType, NULL,
                           "N1_TaxPaid", string(TaxPaid), NULL,
                           "N1_DifSumRub", BalSumRub - TaxPaid, NULL);

            BalSumRub_All = BalSumRub_All + BalSumRub - TaxPaid;

            UseProgress(Num);
            Num = Num + 1;
         end;

         RemProgress();
      else
         RemProgress();
         PrintFormatString(NULL, "N1_NoData", "Нет данных для выполнения отчета");
      end;

      EndTable();

      PrintFormatString(NULL, "N1_F0_10", F(FormulaSum() + "(J15:J" + string(14 + count) + ")"));
   end;

   macro EndReport()
      ReplaceAndCalculate("formula=", "=");
   end;

   initDL_CReportTemplate(NULL, "Report_DifNDRCar.xlsx", NULL, NULL, NULL, false);
   SetPrintMode(DL_OUTREPORT_EXCEL);
END;

while(Form.Run())
   DifNDRCar_Report().Run();
end;

Exit(1);