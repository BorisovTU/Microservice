/*
$Name:        sp_carb.mac
$Module:      Ценные бумаги
$Description: Процедуры для проводок в операциях покупки ценных бумаг
*/
IMPORT "sp_catac.mac", "sp_car.mac", "insdpdr.mac";

/* Делаем проводки по оплате ц/б (без просрочки) при покупке.
   Платеж по контрактиву должен быть актуализирован, счет контрагента заполнен.
   Возвращаем false в случае ошибки.
      FD          -  SPFirstDoc по сделке
      ChangeDate  -  дата изменения
      Doc         -  документ */
macro СделатьПроводкиПоОплате_БезПросрочки_ПриПокупке( FD, ChangeDate, Doc )

   var chapter:integer = 1, Bonus0 = $0, NKD = $0;
   var PayerAccountBuff = TRecHandler( "account" );
   var ReceiverAccountBuff = TRecHandler( "account" );
   var PayFIID_Bonus0 = $0, PayFIID_NKD = $0, PayAmount = $0;

   
   if (ОтдельныйУчетУплНКД() and 
       (not IsREPO(FD.Group)) and 
       (FD.Kind != DL_TRUSTDOC) and
       (not IsClientDeal(FD.tick.rec)) and // Отсюда и ниже - условия, при которых в платеже по к/а счет "Наш портфель ц/б" из MACRO ЗаполнитьНашСчетВПлатежеПоКонтрактиву( FD, dat )
       (FD.BuySale == DEAL_TYPE_BUY) and
       (not FD.ВедетсяБалансУчетПоСделке()) and
       (not FD.ExistBack) and
       (not FD.DealAsResultDVExe)
      )


      if(УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_PAYMENT), DLRQ_STATE_EXEC, ChangeDate) != 0)
         return 1;
      end;

   else
      /* Делаем одну проводку. */
      if( ОбработатьТОПоОплате( FD, ChangeDate, Doc ) != 0 )
         return false;
      end;
   end;

   return true;
end;

macro УчетСебестоимостиВРЕПО( FD, Doc, dat, IsCompensWrt:BOOL, ID_Step )
  var DebFIID, CredFIID, Portfolio, IsOverdue = false, CatOD;
  var Summ = $0, SummTO = $0, TO_FIID, FD_1, Dp, Ds;
  var SummTP = $0, SummPPR = $0, SummPUDP = $0, SummOD = $0, i = 0, NKD_PVO = $0, Bonus_PVO = $0;
  var BonusTP = $0, BonusPPR = $0, BonusPUDP = $0;
  var NKDTP = $0, NKDPPR = $0, NKDPUDP = $0;
  var query, cmd, rsd, SQLQuery;

  private record DebAcc( account );
  private record CredAcc( account );



   return 0; 
end;
