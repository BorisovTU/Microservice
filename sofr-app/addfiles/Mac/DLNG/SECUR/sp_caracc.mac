/**
 @file      mac\dlng\secur\sp_caracc.mac
 @brief     Функции для проводок в операциях с ценными бумагами

 #menu 
  - БО ЦБ

 # tag
 - code_type:GUI 

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |19.11.2025 |Велигжанин А.В.|DEF-104821                                      |Актуализация изменений по DEF-104821 для release-124.0
 |19.11.2025 |Велигжанин А.В.|DEF-104821                                      |Вырезание изменений по DEF-104821 из release-123.0
 |07.11.2025 |Велигжанин А.В.|DEF-104821                                      |Для проводки по НКД пересчет делается по курсу на дату 
 |           |               |                                                |заключения сделки (ранее было на дату проводки)

*/
/*
$Name:        sp_caracc.mac
$Module:      Ценные бумаги
$Description: Функции для проводок в операциях с ценными бумагами
*/

IMPORT "secinter.mac", "spserv.mac", "mc_lib.mac", "dlcarry.inc", "sp_catfn.mac", "sp_catac.mac", "sp_carsf.mac", "sp_voop.mac", "spserv.mac", "dltransf.mac", "sp_carin.mac",
       "spRepFn2.mac", "dl_car.mac", "sp_grfun.mac", "sp_car.mac", "screpocalc.mac", "pm_const.mac", "nutxfun.mac", "nptxcalcfun.mac", "msesdata.mac";
IMPORT "role_model.mac";//ролевая модель

//Подвиды проводок
const GETRESTACC_DEBET           = 1;  //В проводке взять остаток по счету дебета
const GETRESTACC_CREDIT          = 2;  //В проводке взять остаток по счету кредита
const USED_PLUSTP_DEBET          = 3;  //По дебету используется счет +Переоценка, ц/б (ТП) // полож. п/о в ТП
const USED_PLUSTP_CREDIT         = 4;  //По кредиту используется счет +Переоценка, ц/б (ТП) // полож. п/о в ТП
const USED_MINUSTP_DEBET         = 5;  //По дебету используется счет -Переоценка, ц/б (ТП) // отриц. п/о в ТП
const USED_MINUSTP_CREDIT        = 6;  //По кредиту используется счет -Переоценка, ц/б (ТП) // отриц. п/о в ТП
const USED_PLUSPPR_DEBET         = 7;  //По дебету используется счет +Переоценка, ц/б (ППР) // полож. п/о в ППР
const USED_PLUSPPR_CREDIT        = 8;  //По кредиту используется счет +Переоценка, ц/б (ППР) // полож. п/о в ППР
const USED_MINUSPPR_DEBET        = 9;  //По дебету используется счет -Переоценка, ц/б (ППР) // отриц. п/о в ППР
const USED_MINUSPPR_CREDIT       = 10; //По кредиту используется счет -Переоценка, ц/б (ППР) // отриц. п/о в ППР
const USED_PLUSDK_DEBET          = 11; //По дебету используется счет + ПО ДК // отриц. разн. в добав. капитале
const USED_PLUSDK_CREDIT         = 12; //По кредиту используется счет + ПО ДК // отриц. разн. в добав. капитале
const USED_MINUSDK_DEBET         = 13; //По дебету используется счет - ПО ДК // полож. разн. в добав. капитале
const USED_MINUSDK_CREDIT        = 14; //По кредиту используется счет - ПО ДК // полож. разн. в добав. капитале
const USED_MINUSEXCHANGE_DEBET   = 15; //По дебету используется счет - Биржа  
const USED_MINUSEXCHANGE_CREDIT  = 16; //По кредиту используется счет - Биржа 

var ПроводкиБУ = NULL; //объект класса SecurAccountingCarry

CLASS (TArray) ЦБ_CуммыПоПортфелюПоСделке()

  PRIVATE CLASS CуммыПоСделке( _DealID:integer, _SummTP:money, _SummPPR:money, _SummPUDP:money, _SummPKU:money )
     var DealID   = _DealID;
     var SummTP   = _SummTP;
     var SummPPR  = _SummPPR;
     var SummPUDP = _SummPUDP;
     var SummPKU  = _SummPKU;
  END;

  MACRO ClearArray()
     this.Size = 0;
  END;

  MACRO AddSum( _DealID:integer, _SummTP:money, _SummPPR:money, _SummPUDP:money, _SummPKU:money )
     var Ex:bool = false;
     var i:integer = 0;

     while( i < this.Size )
        if( this.(i).DealID == _DealID )
           this.(i).SummTP   = this.(i).SummTP   + _SummTP;
           this.(i).SummPPR  = this.(i).SummPPR  + _SummPPR;
           this.(i).SummPUDP = this.(i).SummPUDP + _SummPUDP;
           this.(i).SummPKU  = this.(i).SummPKU  + _SummPKU;
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     if( Ex == false )
        this.(this.size) = CуммыПоСделке(_DealID, _SummTP, _SummPPR, _SummPUDP, _SummPKU);
     end;
  END;

  MACRO GetSum( _DealID:integer, _SummTP:@money, _SummPPR:@money, _SummPUDP:@money, _SummPKU:@money )
     var i:integer = 0;

     if( _SummTP != NULL )
        _SummTP = 0.0;
     end;
     if( _SummPPR != NULL )
        _SummPPR = 0.0;
     end;
     if( _SummPUDP != NULL )
        _SummPUDP = 0.0;
     end;
     if( _SummPKU != NULL )
        _SummPKU = 0.0;
     end;

     while( i < this.Size )
        if( this.(i).DealID == _DealID )
           if( _SummTP != NULL )
              _SummTP = this.(i).SummTP;
           end;
           if( _SummPPR != NULL )
              _SummPPR = this.(i).SummPPR;
           end;
           if( _SummPUDP != NULL )
              _SummPUDP = this.(i).SummPUDP;
           end;
           if( _SummPKU != NULL )
              _SummPKU = this.(i).SummPKU;
           end;
           break;
        end;
        i = i + 1;
     end;
  END;

  this.Size = 0;
END;

//класс с данными для списка ошибок в протоколе
class CSC_AccountingRepErr(_DealCode:string, _ErrCode:integer, _ErrStr:string)
  var DealCode = _DealCode;
  var ErrCode  = _ErrCode;
  var ErrStr   = _ErrStr;
end;

// Получить ошибки/сообщения из временной таблицы при выполнении СО
MACRO SP_SetWarningLogTmp(RepErrArr)
  if(RepErrArr == null)
    RepErrArr = TArray();
  end;

  var query, cmd, DataSet, SplitArr;

  query = "SELECT T_WARNING FROM DSCREPLOG_TMP";
  cmd = DL_RSDCommand(query);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    SplitArr = SplitString(DataSet.Warning, "~");
    if(SplitArr.size == 3)
       RepErrArr[RepErrArr.size] = CSC_AccountingRepErr(SplitArr[0]/*DealCode*/, SplitArr[1]/*ErrCode*/, SplitArr[2]/*Msg*/);
    end;
  end;

  return RepErrArr;
END;

//данные для вставки отложенных проводок на остаток по счету
class TAccountingAccTrnData(ForRestAcc:integer, AccTrnData, dlgrdoc, Koef, IsLastCarry:bool)
  var m_ForRestAcc = ForRestAcc; //По какому счету брать остаток (1 - по дебету, 2 - по кредиту)
  var m_AccTrnData = AccTrnData; //Данные для проводки
  var m_grdoc      = dlgrdoc;    //Документ проводки по строке графика
  var m_Koef        = 1.0;        //доля от остатка, которая должна пойти в проводку
  var m_IsLastCarry = false;      //последняя проводка, на которую пойдет остаток округления

  if( (Koef != null) and (Koef > 0.0) )
     m_Koef = Koef;
  end;

  if( IsLastCarry != null )
     m_IsLastCarry = IsLastCarry;
  end;
end;

class TMsesAccountingAccTrnData(_Payer,_Receiver)
  var Payer = _Payer;
  var Receiver = _Receiver;
  macro GetStrId()
    return string(Payer) + ":::" + string(Receiver);
  end;
end;

//данные для вставки сумм переоценки
class TRegistrValue(DocKind:integer, DocID:integer, Kind:integer, Sum:money, SumFIID:integer, ValueDate:date, ServDocId:integer, GrpId:integer)
  var m_DocKind = DocKind;
  var m_DocID   = DocID;
  var m_Kind    = Kind;
  var m_Sum     = Sum;
  var m_SumFIID = SumFIID;
  var m_Date    = ValueDate;
  var m_ServDocID = ServDocId;
  var m_grpId     = GrpId;

  macro GetStrId()
    return string(m_DocKind) + ":::" + string(m_DocID) + ":::" + string(m_Kind) + ":::" + string(m_SumFIID) + ":::" + string(m_Date);
end;
end;

class TRegistrValueComiss(DocKind:integer, DocID:integer, Kind:integer, Sum:money, SumFIID:integer, ValueDate:date, ServDocId:integer, GrpId:integer)
  var m_DocKind = DocKind;
  var m_DocID   = DocID;
  var m_Kind    = Kind;
  var m_Sum     = Sum;
  var m_SumFIID = SumFIID;
  var m_Date    = ValueDate;
  var m_ServDocID = ServDocId;
  var m_grpId     = GrpId;

  macro GetStrId()
    return string(m_DocKind) + ":::" + string(m_DocID) + ":::" + string(m_Kind) + ":::" + string(m_SumFIID) + ":::" + string(m_Date);
  end;
end;

//Данные для отказа по 2ч ОРЕПО
class TBuyREPORejectParm()
  var BalanceAcc  = NULL; //Счет списания (+ОД или треб. с н.с.)
  var CurrentRest = $0;   //Текущий остаток на счете в ВН
  var InRest      = $0;   //Исходный остаток на счете в ВН
  var OverSumPF   = $0;   //Сумма переоценки в ВР
  var CurrSumSettl= $0;   //Сумма урегулированной разницы
  var Sнд         = $0;
  var Sод         = $0;
end;

CLASS TDLSUM( _DocKind:INTEGER, _DocID:INTEGER, _Kind:INTEGER, _CommDate:DATE, _Sum:MONEY, _NDS:MONEY, _Currency:INTEGER, _GrpID:INTEGER, _FIID:INTEGER )
  VAR DocKind    = _DocKind,
      DocID      = _DocID,   
      Kind       = _Kind,    
      Currency   = _Currency,
      CommDate   = _CommDate,
      Sum        = _Sum,     
      NDS        = _NDS,     
      GrpID      = _GrpID,
      FIID       = _FIID;
  macro GetStrId()
    return string(DocKind) + ":::" + string(DocID) + ":::" + string(Kind) + ":::" + string(CommDate) + ":::" + string(Currency) + ":::" + string(FIID);
  end;
END;

PRIVATE CLASS TAccResTrnData( _GrDealID:integer,        //идентификатор строки графика
                              _InAccount,               //record исходный счет, по которому считаться обороты
                              _IsDebetIfPlus:bool,      //если оборот положительный, то исходный счет по дебету
                              _Direct:integer,          //1 или -1, что 1, если обороты по дебету счетать с плюсом.
                              _PlusResAcc,              //record счета для проводки, если оборот положительный
                              _MinusResAcc,             //record счета для проводки, если оборот отрицательный
                              _Chapter:integer,         //глава счетов
                              _Ground:string,           //основание проводки
                              _dat:date,                //дата проводки
                              _Kind_Oper,
                              _Numb_Document,
                              _Koef:double,             //доля от остатка, которая должна пойти в проводку
                              _IsLastCarry:bool         //последняя проводка, на которую пойдет остаток округления     
                            )
   var GrDealID         = _GrDealID,
       IsDebetIfPlus    = _IsDebetIfPlus,   
       Direct           = _Direct,          
       Chapter          = _Chapter,         
       Ground           = _Ground,          
       dat              = _dat,
       Kind_Oper        = _Kind_Oper,    
       Numb_Document    = _Numb_Document,
       Koef             = 1.0,
       IsLastCarry      = false;

   var InAcc       = TRecHandler("account.dbt");
   var PlusResAcc  = TRecHandler("account.dbt");
   var MinusResAcc = TRecHandler("account.dbt");

   copy(InAcc,       _InAccount);
   copy(PlusResAcc,  _PlusResAcc);
   copy(MinusResAcc, _MinusResAcc);

   var Sum = $0; //сумма оборота         
   
   if( (_Koef != null) and (_Koef > 0.0) )
      Koef = _Koef;
   end;

   if( _IsLastCarry != null )
      IsLastCarry = _IsLastCarry;
   end;

   macro InAccount()
     return InAcc.rec;
   end;

   macro PlusResAccount()
     return PlusResAcc.rec;
   end;

   macro MinusResAccount()
     return MinusResAcc.rec;
   end;

END;

class SecurAccountingCarry(ServDocKind, ServDocID, MsesPrcId)
  private var m_ServDocKind;  //Вид ПД сервисной операции
  private var m_ServDocID;    //ID ПД сервисной операции
  private var m_GrpID;        //ID группы
  private var m_SubGrpID;     //ID подгруппы
  private var m_GrDealID;     //Текущая обрабатываемая строка графика
  private var m_SourceType;   //Тип источника проводки
  private var m_AccountingTrnBatch = NULL; //Объект массового выполнения проводок
  private var m_AccountingGrDocArr = TArray( false, 1000, 1000); //Массив документы строк графика, соотвествтующие проводкам
  private var m_AccountingForRestAccTrnDataArr = TArray( false, 1000, 1000 ); //Массив проводок на остаток по счету
  private var m_AccountingDocOffArr = TArray( false, 1000, 1000 ); //Массив сводных проводок
  private var m_ArrRegistrValue = TArray( false, 1000, 1000 ); //Массив регистра переоценки
  private var m_ArrComissValue = TArray( false, 1000, 1000 ); //Массив регистра комиссий
  private var m_ArrGrDealID = TArray( false, 1000, 1000 ); //Массив обработанных строк графика, для которых требуется обновление статуса учета
  private var m_ArrDLSUM    = TArray( false, 1000, 1000 ); //Массив DLSUM
  private var m_CurrAvrFIID = -1;
  private var m_dlgrdocCache = RsbSQLInsert("dlgrdoc.dbt");
  private var m_AccountingResTrnArr = TArray( false, 1000, 1000 ); //Массив данных для проводок на оборот
  private var m_CуммыПоПортфелюПоСделке = NULL;
  private var m_grp = TBFile("pmwrtgrp.dbt");
  private var m_NUTaxObj = NULL;

  private var m_msesPrcId = MsesPrcId;

/*ak - w487*/
  private var m_AccountingTrnBatchLink = tarray(); /*Проводки для связки*/
  class link
    var ind;
    var paymentid
  end;

  /*Добавить проводку для связки*/
  macro AddAccountingTrnBatchLink(ind, paymentid)
    m_AccountingTrnBatchLink[m_AccountingTrnBatchLink.size] = link;
    m_AccountingTrnBatchLink[m_AccountingTrnBatchLink.size-1].ind = ind;
    m_AccountingTrnBatchLink[m_AccountingTrnBatchLink.size-1].paymentid = paymentid;
  end;

  /*Для проводки нужна связка*/
  macro TrnInAccountingTrnBatchLink(ind)
    var i = 0;
    while(i < m_AccountingTrnBatchLink.size)
      if(m_AccountingTrnBatchLink[i].ind == ind)
        return m_AccountingTrnBatchLink[i].paymentid
      elif(m_AccountingTrnBatchLink[i].ind > ind)
        return 0;
      end;
      i = i + 1;
    end;
    return 0;
  end;

  /*Получить число проводок по остатку счета*/
  macro GetAccountingTrnBatchSize()
    if(m_AccountingTrnBatch == NULL)
      return 0;
    else
      return m_AccountingTrnBatch.size;
    end;
  end;
/*~ak*/

  PRIVATE MACRO ИзменитьСтатусВидаУчета():INTEGER
     var err = 0;

     if(m_ArrGrDealID.Size > 0)

       var ins = RsbSQLInsert("INSERT INTO DSCINACCGR_TMP (t_GrDealID) VALUES (?)", 1, m_ArrGrDealID.Size );
       ins.AddParam( V_INTEGER, m_ArrGrDealID );
       if(not ins.Insert())
         err = 1;
       end;

       if(not err)
         var sql =  "DECLARE "
                  + "BEGIN "
                  + "  FOR one_rec IN (SELECT t_GrDealID "
                  + "                      FROM DSCINACCGR_TMP "
                  + "                   ) LOOP "
                  + "     RSI_DLGR.RSI_UpdateGrDealAccByID( one_rec.t_GrDealID, "+DLGR_ACCKIND_ACCOUNTING+", "+DLGRACC_STATE_FACTEXEC+", NULL, 0); "
                  + "  END LOOP; "

                  + "  RSI_DLGR.RSI_ExecCommitDLGR; "
                  + "END; ";
           
         var cmd = RSDCommand(sql);

         cmd.Execute();
       end;
     end;

     return err;
  END;

  MACRO SetGrDealID( GrDealID:INTEGER )
     m_ArrGrDealID[m_ArrGrDealID.Size] = GrDealID;
  END;

  PRIVATE MACRO СохранитьСуммы():INTEGER
     VAR cmd, i = 0, ExecStr = "";

     if (m_msesPrcId == null)

     while( i < m_ArrDLSUM.size )                                        
        ExecStr = ExecStr + " RSI_DLGR.SetDLSUM(" + m_ArrDLSUM[i].DocKind +","
                                                  + m_ArrDLSUM[i].DocID +","
                                                  + m_ArrDLSUM[i].Kind +","             
                                                  + m_ArrDLSUM[i].Currency +","        
                                                  + GetSQLDate( m_ArrDLSUM[i].CommDate ) +","
                                                  + string( m_ArrDLSUM[i].Sum ) +","
                                                  + string( m_ArrDLSUM[i].NDS ) +","
                                                  + m_ArrDLSUM[i].GrpID +","
                                                  + m_ArrDLSUM[i].FIID +
                                              ");";
        i = i + 1;
     end;

     if( ExecStr != "" )
        cmd = RSDCommand( "DECLARE BEGIN "+ ExecStr + " END; " );
        cmd.execute();
     end; 
     end;
     
     return 0;
  END;

  MACRO SetDLSUM( DocKind:INTEGER, DocID:INTEGER, Kind:INTEGER, CommDate:DATE, Sum:MONEY, NDS:MONEY, Currency:INTEGER, _FIID:INTEGER )
     var i = 0;
     var FIID:integer = -1;

     if( _FIID != null )
        FIID = _FIID;
     end;

     if (m_msesPrcId != null)
        var obj = TDLSUM( DocKind, DocID, Kind, CommDate, Sum, NDS, Currency, this.GetGrpID(), FIID );

        var sesData = MSesData(m_msesPrcId);
        sesData.LockByObjClassName(obj);

        var fromDbData = sesData.GetObjFromDbByObj(obj);
        if (fromDbData != null)
           fromDbData.Sum = fromDbData.Sum + Sum;
           fromDbData.NDS = fromDbData.NDS + NDS;
           sesData.StoreOrReplObj(fromDbData);
        else
           sesData.StoreOrReplObj(obj);
        end;

        sesData = null;
     else

     while( i < m_ArrDLSUM.Size )
        if(     (m_ArrDLSUM[i].DocKind  == DocKind)
            AND (m_ArrDLSUM[i].DocID    == DocID)
            AND (m_ArrDLSUM[i].Kind     == Kind)
            AND (m_ArrDLSUM[i].CommDate == CommDate)
            AND (m_ArrDLSUM[i].Currency == Currency)
            AND (m_ArrDLSUM[i].FIID     == FIID)
          )
           m_ArrDLSUM[i].Sum = m_ArrDLSUM[i].Sum + Sum;
           m_ArrDLSUM[i].NDS = m_ArrDLSUM[i].NDS + NDS;
           return;
        end;
        i = i + 1;
     end;

     m_ArrDLSUM[m_ArrDLSUM.Size] = TDLSUM( DocKind, DocID, Kind, CommDate, Sum, NDS, Currency, this.GetGrpID(), FIID );
     end;
  END;

  MACRO GetDLSUM( DocKind:INTEGER, DocID:INTEGER, SumKind:INTEGER, _Date:DATE, _FIID:INTEGER ):TDLSUM
     var fRec:TDLSUM = NULL, i = 0;
     var FIID:integer = -1;
     var sesData = null;

     if( _FIID != null )
        FIID = _FIID;
     end;

     var arr = null;

     if (m_msesPrcId != null)
       sesData = MSesData(m_msesPrcId);
       sesData.LockByClassName("TDLSUM");
       arr = sesData.GetObjListByClassName("TDLSUM");
     else
       arr = m_ArrDLSUM;
     end;

     while( i < arr.Size )
        if(     (arr[i].DocKind == DocKind)
            AND (arr[i].DocID   == DocID)
            AND (arr[i].Kind    == SumKind)
            AND (arr[i].FIID    == FIID)
          )
           if( fRec == NULL )
             fRec = arr[i];
           elif( arr[i].CommDate > fRec.CommDate )
             fRec = arr[i];
           end;

           if( fRec.CommDate == _Date )
              break;
           end;
        end;
        i = i + 1;
     end;

     if( not fRec )
        fRec = TDLSUM( DocKind, DocID, SumKind, _Date, NULL, NULL, NULL, NULL, FIID ); 
        fRec.Sum = ПолучитьПоследнююСумму( DocKind, DocID, SumKind, fRec.CommDate, fRec.Currency, FIID );
     end;

     return fRec;
  end;

  //установить текущую обрабатываемую строку графика
  macro SetGrDealData(GrDealID, GrpID, FIID, SourceType, SubGrpID)
    var GrDealGrDoc = TRecHandler("dlgrdoc.dbt");
    
    m_GrDealID   = GrDealID;   
    m_SourceType = SourceType; 

    m_SubGrpID = 0;
    if(ValType(SubGrpID) != 0)
      m_SubGrpID = SubGrpID;
    end;

    if(GrpID == 0)
      m_grp.Clear();
    elif(m_GrpID != GrpID)
      m_grp.Clear();

      if(GrpID > 0)
        m_grp.rec.ID = GrpID;
        m_grp.GetEQ();
      end;
    end;

    m_GrpID = GrpID;
    m_CurrAvrFIID = FIID;

    if (m_GrDealID > 0)
      GrDealGrDoc.rec.GrDealID    = GrDealID;
      GrDealGrDoc.rec.DocKind     = 0;
      GrDealGrDoc.rec.DocID       = 0;
      GrDealGrDoc.rec.ServDocKind = m_ServDocKind;
      GrDealGrDoc.rec.ServDocID   = m_ServDocID; 
      GrDealGrDoc.rec.GrpID       = GrpID;
      GrDealGrDoc.rec.SourceType  = m_SourceType;
      m_dlgrdocCache.AddRecord(GrDealGrDoc);
    end;
  end;

  macro GetGrpID()
    return m_GrpID;
  end;

  macro GetServDocID()
    return m_ServDocID;
  end;

  macro GetServDocKind()
    return m_ServDocKind;
  end;

  macro GetGrDealID()
    return m_GrDealID;
  end;

  macro GetCurrAvrFIID();
    return m_CurrAvrFIID;
  end;

  private macro AddRegistrValue(Mode:integer, accTrnData)
    var i = 0, Kind = 0;
    var find = false;
    var arr = TArray();
    var Sum:money = $0;
    var SumFIID:integer = -1;
    var DocKind:integer = 0;
    var DocID:integer = 0;
    var grdeal = TBFile("dlgrdeal.dbt");

    DocKind = DLDOC_ISSUE;  
    DocID   = m_CurrAvrFIID;

    if( (Mode == USED_PLUSTP_DEBET) OR (Mode == USED_PLUSTP_CREDIT))
      Kind    = DL_VALUE_KIND_PLUSTP;
      Sum     = IIF((Mode == USED_PLUSTP_DEBET), accTrnData.SumPayer, accTrnData.SumReceiver) * IIF((Mode == USED_PLUSTP_DEBET), -1, 1);
      SumFIID = IIF((Mode == USED_PLUSTP_DEBET), accTrnData.FIIDPayer, accTrnData.FIIDReceiver);
    end;

    if( (Mode == USED_MINUSTP_DEBET) OR (Mode == USED_MINUSTP_CREDIT))
      Kind    = DL_VALUE_KIND_MINUSTP;
      Sum     = IIF((Mode == USED_MINUSTP_DEBET), accTrnData.SumPayer, accTrnData.SumReceiver) * IIF((Mode == USED_MINUSTP_DEBET), -1, 1);
      SumFIID = IIF((Mode == USED_MINUSTP_DEBET), accTrnData.FIIDPayer, accTrnData.FIIDReceiver);
    end;

    if( (Mode == USED_PLUSPPR_DEBET) OR (Mode == USED_PLUSPPR_CREDIT))
      Kind    = DL_VALUE_KIND_PLUSPPR;
      Sum     = IIF((Mode == USED_PLUSPPR_DEBET), accTrnData.SumPayer, accTrnData.SumReceiver) * IIF((Mode == USED_PLUSPPR_DEBET), -1, 1);
      SumFIID = IIF((Mode == USED_PLUSPPR_DEBET), accTrnData.FIIDPayer, accTrnData.FIIDReceiver);
    end;

    if( (Mode == USED_MINUSPPR_DEBET) OR (Mode == USED_MINUSPPR_CREDIT))
      Kind    = DL_VALUE_KIND_MINUSPPR;
      Sum     = IIF((Mode == USED_MINUSPPR_DEBET), accTrnData.SumPayer, accTrnData.SumReceiver) * IIF((Mode == USED_MINUSPPR_DEBET), -1, 1);
      SumFIID = IIF((Mode == USED_MINUSPPR_DEBET), accTrnData.FIIDPayer, accTrnData.FIIDReceiver);
    end;

    if( (Mode == USED_PLUSDK_DEBET) OR (Mode == USED_PLUSDK_CREDIT))
      Kind    = DL_VALUE_KIND_PLUSDK;
      Sum     = IIF((Mode == USED_PLUSDK_DEBET), accTrnData.SumPayer, accTrnData.SumReceiver) * IIF((Mode == USED_PLUSDK_DEBET), -1, 1);
      SumFIID = IIF((Mode == USED_PLUSDK_DEBET), accTrnData.FIIDPayer, accTrnData.FIIDReceiver);
    end;

    if( (Mode == USED_MINUSDK_DEBET) OR (Mode == USED_MINUSDK_CREDIT))
      Kind    = DL_VALUE_KIND_MINUSDK;
      Sum     = IIF((Mode == USED_MINUSDK_DEBET), accTrnData.SumPayer, accTrnData.SumReceiver) * IIF((Mode == USED_MINUSDK_DEBET), -1, 1);
      SumFIID = IIF((Mode == USED_MINUSDK_DEBET), accTrnData.FIIDPayer, accTrnData.FIIDReceiver);
    end;

    if( (Mode == USED_MINUSEXCHANGE_DEBET) OR (Mode == USED_MINUSEXCHANGE_CREDIT))
      Kind    = DL_VALUE_KIND_MINUSEXCHANGE;
      Sum     = IIF((Mode == USED_MINUSEXCHANGE_DEBET), accTrnData.SumPayer, accTrnData.SumReceiver) * IIF((Mode == USED_MINUSEXCHANGE_DEBET), -1, 1);
      SumFIID = IIF((Mode == USED_MINUSEXCHANGE_DEBET), accTrnData.FIIDPayer, accTrnData.FIIDReceiver);

      grdeal.Clear();
      grdeal.rec.ID = m_GrDealID;
      if(grdeal.GetEQ())
        DocKind = grdeal.rec.DocKind;  
        DocID   = grdeal.rec.DocID;
      end;
    end;

    if((DocKind > 0) and (Kind > 0))
      if(Kind == DL_VALUE_KIND_MINUSEXCHANGE)
        arr = m_ArrComissValue;
      else
        arr = m_ArrRegistrValue;
      end;

      if (m_msesPrcId != null)
         var regValToAdd;
         if (Kind == DL_VALUE_KIND_MINUSEXCHANGE)
            regValToAdd = TRegistrValueComiss(DocKind, DocID, Kind, Sum, SumFIID, accTrnData.Date_Carry, m_ServDocID, m_GrpID);
         else
            regValToAdd = TRegistrValue(DocKind, DocID, Kind, Sum, SumFIID, accTrnData.Date_Carry, m_ServDocID, m_GrpID);
         end;

         var sesData = MSesData(m_msesPrcId);
         sesData.LockByObjClassName(regValToAdd);

         var fromDbData = sesData.GetObjFromDbByObj(regValToAdd);
         if (fromDbData != null)
            fromDbData.m_Sum = fromDbData.m_Sum + Sum;
            sesData.StoreOrReplObj(fromDbData);
         else
            sesData.StoreOrReplObj(regValToAdd);
         end;

         sesData = null;
      else
      while(i < arr.size)

        if((arr[i].m_DocKind == DocKind) and (arr[i].m_DocID == DocID) and (arr[i].m_Kind == Kind) and (arr[i].m_SumFIID == SumFIID) and (arr[i].m_Date == accTrnData.Date_Carry))
          find = true;
          arr[i].m_Sum = arr[i].m_Sum + Sum;
          break;
        end;

        i = i + 1;
      end;

      if(find == false)
        arr[arr.size] = TRegistrValue(DocKind, DocID, Kind, Sum, SumFIID, accTrnData.Date_Carry);
      end;
    end;
  end;
  end;

  //добавить проводку в обработку
  macro Add(accTrnData, Mode, Koef, IsLastCarry)

    if((Mode == GETRESTACC_DEBET) or (Mode == GETRESTACC_CREDIT))
      var m_grdoc = TRecHandler("dlgrdoc");

      m_grdoc.Clear();

      m_grdoc.rec.GrDealID     = m_GrDealID;
      m_grdoc.rec.DocKind      = DLDOC_CARRY;
      m_grdoc.rec.DocID        = 0;
      m_grdoc.rec.ServDocKind  = m_ServDocKind;
      m_grdoc.rec.ServDocID    = m_ServDocID;
      m_grdoc.rec.GrpID        = m_GrpID;
      m_grdoc.rec.SourceType   = m_SourceType; 

      //чтобы не было повторной проводки по одному и тому же счету
      var j = 0, already_exists_restacc = false;
      if (m_msesPrcId == null)
      while ( j < m_AccountingForRestAccTrnDataArr.size )
         if( ((Mode == GETRESTACC_DEBET) and (accTrnData.AccountPayer == m_AccountingForRestAccTrnDataArr[j].m_accTrnData.AccountPayer)) and
             (/*(Mode == GETRESTACC_CREDIT) and*/ (accTrnData.AccountReceiver == m_AccountingForRestAccTrnDataArr[j].m_accTrnData.AccountReceiver)) )
            already_exists_restacc = true;
            break;
         end;
         j = j + 1;
      end;
      else
        var sesData = MSesData(m_msesPrcId);
        var obj = TMsesAccountingAccTrnData(accTrnData.AccountPayer, accTrnData.AccountReceiver);
        sesData.LockByObjStrId(obj);
        var fromDbData = sesData.GetObjFromDbByObj(obj);
        if (fromDbData != null)
           already_exists_restacc = true;
        else
          sesData.StoreOrReplObj(obj);
        end;
        sesData = null;
      end;

      if( not already_exists_restacc )
         m_AccountingForRestAccTrnDataArr[m_AccountingForRestAccTrnDataArr.size] = TAccountingAccTrnData(Mode, accTrnData, m_grdoc, Koef, IsLastCarry);
      end;
    else
      var i = m_AccountingGrDocArr.size;

      m_AccountingTrnBatch.AddAccTransaction( accTrnData, NULL, 0, 0 );

      m_AccountingGrDocArr[i] = TRecHandler("dlgrdoc.dbt");

      m_AccountingGrDocArr[i].Clear();

      m_AccountingGrDocArr[i].rec.GrDealID     = m_GrDealID;
      m_AccountingGrDocArr[i].rec.DocKind      = DLDOC_CARRY;
      m_AccountingGrDocArr[i].rec.DocID        = 0;
      m_AccountingGrDocArr[i].rec.ServDocKind  = m_ServDocKind;
      m_AccountingGrDocArr[i].rec.ServDocID    = m_ServDocID;
      m_AccountingGrDocArr[i].rec.GrpID        = m_GrpID;
      m_AccountingGrDocArr[i].rec.SourceType   = m_SourceType; 

      AddRegistrValue(Mode, accTrnData);

    end;
  end;

  macro AddRegValOver(Mode, accTrnData)
      AddRegistrValue(Mode, accTrnData);
  end;

  macro AddNuTaxObj(Sum, SumFIID, PayFIID, dat)
    if(DL_UseNUTX() == true)
      var grdeal = TBFile("dlgrdeal.dbt");
      var S = $0, S0 = $0;
      
      if(m_NUTaxObj == NULL)
        var TaxGroup = GetTaxGroupNUTX(m_CurrAvrFIID, dat);

        m_NUTaxObj = TInsertTaxObjectNUTX(0, 0, m_ServDocKind, m_ServDocID, m_GrpID, TaxGroup);
      end;

      grdeal.Clear();
      grdeal.rec.ID = m_GrDealID;
      if(grdeal.GetEQ())
        if(PayFIID == SumFIID)
          S = Sum;
        else
          SmartConvertSum( S, Sum, date(dat), SumFIID, PayFIID, true );
        end;

        if(SumFIID == NATCUR)
          S0 = Sum;
        end;

        m_NUTaxObj.Add( dat,         
                        m_grp.rec.Party,
                        GetFactReceiverForNUTX(m_grp.rec.Party),       
                        NUTXOBJ_DIR_OUT,    
                        6,        
                        UNSET_CHAR,         
                        NUTXOBJ_PAIDTAX,         
                        S,          
                        PayFIID,
                        S0,         
                        TXOBJ_KIND1010, //Сделка              
                        grdeal.rec.DocID,                        
                        0,                                    
                        -1,                                   
                        TXOBJ_KIND3010, //Ц/б                 
                        m_CurrAvrFIID,                         
                        0,                                    
                        -1,                                   
                        TXOBJ_KIND5010, //Налоговая группа    
                        m_NUTaxObj.m_TaxGroup,                            
                        0, 
                        -1,    
                        "Удержанный налог"          
                      );
      end;
    end;
  end;

  MACRO AddNPTXObj(Sum, SumFIID, PayFIID, dat)
    //НДР, создаваемые в СО БУ, вяжем к группе обработки, чтобы не добавлять в НДР отдельное поле GrpID
    CreateTaxObjects_NPTXCarry(Sum, m_GrpID, -1, m_GrpID, m_SubGrpID, m_grp.rec.Party, dat, m_CurrAvrFIID);
  END;

  //добавить проводку на оборот в рамках строки графика
  macro AddResTrn(accResTrnData)
    m_AccountingResTrnArr[m_AccountingResTrnArr.size] = accResTrnData;
  end;

  //добавить сводную проводку 
  macro AddDocOff(accTrnData, spdocoff, Mode)
    spdocoff.rec.GrpID      = m_GrpID;
    spdocoff.rec.ServOperID = m_ServDocID;

    m_AccountingDocOffArr[m_AccountingDocOffArr.size] = spdocoff;

    AddRegistrValue(Mode, accTrnData);
    
    if(m_AccountingDocOffArr.size >= 1000)
      if(this.SaveDocOff() != 0)
        return 1;
      end;
    end;

    return 0;
  end;

  //вставить сводные проводки
  macro SaveDocOff()
    var err = 0;
    var spdocoffCache = RsbSQLInsert("spdocoff.dbt");
          
    if(m_AccountingDocOffArr.size > 0)
      spdocoffCache.AddRecordArray(m_AccountingDocOffArr);
      
      if(not spdocoffCache.insert())
        err = 1;
      end;

      m_AccountingDocOffArr.size = 0;
    end;
    return err;
  end;

  //Получить сумму регистра переоценки на дату
  macro GetOverRegistrValue(Kind:integer, ValueDate:date, Account:string )
    var query, cmd, DataSet;
    var Sum1 = $0, Sum2 = $0;
    var i = 0;

    query = "select rsi_dlgr.RSI_GetOverRegistrValue(?, ?, ?, ?, ?) s from dual";
    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_CurrAvrFIID);
    cmd.AddParam(Kind);
    cmd.AddParam(ValueDate);
    cmd.AddParam(NATCUR);
    cmd.AddParam(Account);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Sum1 = money(DataSet.s);
    end;

    var sesData = null;
    var arr = null;

    if (m_msesPrcId != null)
      sesData = MSesData(m_msesPrcId);
      sesData.LockByClassName("TRegistrValue");
      arr = sesData.GetObjListByClassName("TRegistrValue");
    else
      arr = m_ArrRegistrValue;
      end;

    while(i < arr.size)

      if(arr[i].m_Kind == Kind)
        Sum2 = Sum2 + arr[i].m_Sum;
      end;

      i = i + 1;
    end;

    sesData = null;

    return (Sum1 + Sum2);
  end;

  //исполнить проводки
  macro Execute(RepErrArr)
    var err = 0;
    var i = 0, j = 0;
    var nCarry = 0, cntErr = 0;
    var arrErrCode, arrErrMessage;
    var accTrn : RsbAccTransactionData;
    var dl_valueCache = RsbSQLInsert("dl_value.dbt");
    var dl_value = NULL;
    var resExecute = false;
    var ClosedAcc = "";
    var PrevSum = $0;
    var msesDataDeleter = MSesDeleteDataOnDestructor(m_msesPrcId);
    msesDataDeleter.AddClassDataToDel("TRegistrValue");
    msesDataDeleter.AddClassDataToDel("TRegistrValueComiss");
    msesDataDeleter.AddClassDataToDel("TDLSUM");

    SQL_Execute(" DELETE FROM DSCINACCGR_TMP ", null, false );

    err = СохранитьСуммы();

    if( (not err) AND (m_AccountingTrnBatch != NULL) )
      resExecute = m_AccountingTrnBatch.Execute(ACCTRN_EXEC_MODE_ONE_PACK);
      //Переносим ID проводок
      nCarry = m_AccountingTrnBatch.GetResult( arrErrCode, arrErrMessage );
      while(i < nCarry)
        accTrn = m_AccountingTrnBatch.GetAccTransaction(i);
  
        if( arrErrCode[i] == 0 )
          m_AccountingGrDocArr[i].rec.DocID = accTrn.AccTrnID;
/*ak - w487*/
          var paymentid = TrnInAccountingTrnBatchLink(i);
          if(paymentid > 0)
            //msgboxex("accTrn.AccTrnID="+accTrn.AccTrnID+"|paymentid="+paymentid);
            var cmdl = RSDCommand("insert into dpmdocs_dbt(t_paymentid, t_keeptechfields, t_pmaddpiid, t_reason, t_acctrnid) values(?, chr(88), 0, 1, ?)");
            cmdl.AddParam("paymentid", RSDBP_IN, paymentid);
            cmdl.AddParam("acctrnid", RSDBP_IN, accTrn.AccTrnID);
            cmdl.execute();
          end;
/*~ak*/

          j = 0;
          while(j < m_AccountingResTrnArr.size)
            if(m_AccountingResTrnArr[j].GrDealID == m_AccountingGrDocArr[i].rec.GrDealID)
              if(m_AccountingResTrnArr[j].InAccount.Account == accTrn.AccountPayer)
                m_AccountingResTrnArr[j].Sum = m_AccountingResTrnArr[j].Sum + m_AccountingResTrnArr[j].Direct * accTrn.SumPayer;
              elif(m_AccountingResTrnArr[j].InAccount.Account == accTrn.AccountReceiver)
                m_AccountingResTrnArr[j].Sum = m_AccountingResTrnArr[j].Sum - m_AccountingResTrnArr[j].Direct * accTrn.SumReceiver;
              end;
            end;
            j = j + 1;
          end;

        else
          if (arrErrCode[i] != ACCTRN_PACKAGE_ERROR_NUMBER)
            if(arrErrCode[i] == ERR_CLOSED_PAYERACC)
              ClosedAcc = accTrn.AccountPayer;
            elif(arrErrCode[i] == ERR_CLOSED_RECEIVERACC)
              ClosedAcc = accTrn.AccountReceiver;
            end;
            RepErrArr[RepErrArr.size] = CSC_AccountingRepErr(accTrn.Numb_Document, arrErrCode[i], "Ошибка при выполнении проводки \""+accTrn.Ground+"\". " + arrErrMessage[i] + " " + ClosedAcc);
            ClosedAcc = "";
            err = 1;
          end;
        end;
  
        i = i + 1;
      end;
      // выведем реальные ошибки
      if (not resExecute)
        i = 0;
        arrErrCode.size = 0;
        arrErrMessage.size = 0;
        cntErr = m_AccountingTrnBatch.GetAddError(arrErrCode, arrErrMessage);
        while ( i < cntErr)
          if (arrErrCode[i] != 0)
            RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", arrErrCode[i], "Ошибка при выполнении проводки. " + arrErrMessage[i]);
            err = 1;
          end;

          i = i + 1;
        end;  
      end;
      m_dlgrdocCache.AddRecordArray(m_AccountingGrDocArr);
    end;

    //теперь проводки на остаток
    if((not err) and (m_AccountingForRestAccTrnDataArr.size > 0))
      var ForRestAcc = 0;
      var AccTrnData;
      var AccForRestTrnBatch = RsbBatchAccTrn;
      var CopyAccountingForRestAccTrnDataArr;
      var Summ = $0;
      
      PrevSum = $0;
      
      i = 0;
      CopyAccountingForRestAccTrnDataArr = TArray(m_AccountingForRestAccTrnDataArr);
      m_AccountingForRestAccTrnDataArr.size = 0;
      while(i < CopyAccountingForRestAccTrnDataArr.size)
        
        ForRestAcc = CopyAccountingForRestAccTrnDataArr[i].m_ForRestAcc;
        AccTrnData = CopyAccountingForRestAccTrnDataArr[i].m_AccTrnData;
        Summ = $0;

        if(ForRestAcc == GETRESTACC_DEBET)
          OprGetAccountRest( AccTrnData.Chapter, 
                             AccTrnData.FIIDPayer, 
                             AccTrnData.AccountPayer, 
                             AccTrnData.Date_Carry, 
                             Summ );

          if( CopyAccountingForRestAccTrnDataArr[i].m_IsLastCarry == true )
             Summ = Summ - PrevSum;
             PrevSum = $0;
          elif( CopyAccountingForRestAccTrnDataArr[i].m_Koef != 1 )
             Summ = round(money(Summ * CopyAccountingForRestAccTrnDataArr[i].m_Koef),2);
             PrevSum = PrevSum + Summ;
          end;

          AccTrnData.SumPayer = money(AccTrnData.SumPayer + ABS(Summ));

          if(AccTrnData.FIIDPayer == AccTrnData.FIIDReceiver)
            AccTrnData.SumReceiver = AccTrnData.SumPayer;
          end;
        elif(ForRestAcc == GETRESTACC_CREDIT)
          OprGetAccountRest( AccTrnData.Chapter, 
                             AccTrnData.FIIDReceiver, 
                             AccTrnData.AccountReceiver, 
                             AccTrnData.Date_Carry, 
                             Summ );

          if( CopyAccountingForRestAccTrnDataArr[i].m_IsLastCarry == true )
             Summ = Summ - PrevSum;
             PrevSum = $0;
          elif( CopyAccountingForRestAccTrnDataArr[i].m_Koef != 1 )
             Summ = round(money(Summ * CopyAccountingForRestAccTrnDataArr[i].m_Koef),2);
             PrevSum = PrevSum + Summ;
          end;

          AccTrnData.SumReceiver = money(AccTrnData.SumReceiver + ABS(Summ));
          if(AccTrnData.FIIDPayer == AccTrnData.FIIDReceiver)
            AccTrnData.SumPayer = AccTrnData.SumReceiver;
          end;
        end;
        
        if((AccTrnData.SumPayer != $0) or (AccTrnData.SumReceiver != $0))
          if( not CheckMultyCarrySum( AccTrnData.FIIDPayer, AccTrnData.FIIDReceiver, AccTrnData.SumPayer, AccTrnData.SumReceiver, AccTrnData.Date_Carry ) )
            msgbox("Ошибка при определении сумм мультивалютной проводки на остаток по счету.");
          end;
        end;

        if((AccTrnData.SumPayer != $0) and (AccTrnData.SumReceiver != $0))

          AccForRestTrnBatch.AddAccTransaction( AccTrnData, NULL, 0, 0 );

          m_AccountingForRestAccTrnDataArr[m_AccountingForRestAccTrnDataArr.size] = CopyAccountingForRestAccTrnDataArr[i];
        end;

        i = i + 1;
      end;
      
      resExecute = AccForRestTrnBatch.Execute(ACCTRN_EXEC_MODE_ONE_PACK);
      //Переносим ID проводок
      i = 0;
      nCarry = AccForRestTrnBatch.GetResult( arrErrCode, arrErrMessage );
      while(i < nCarry)
        accTrn = AccForRestTrnBatch.GetAccTransaction(i);
        if( arrErrCode[i] == 0 )
          m_AccountingForRestAccTrnDataArr[i].m_grdoc.rec.DocID = accTrn.AccTrnID;
          m_dlgrdocCache.AddRecord(m_AccountingForRestAccTrnDataArr[i].m_grdoc);

          j = 0;
          while(j < m_AccountingResTrnArr.size)
            if(m_AccountingResTrnArr[j].GrDealID == m_AccountingForRestAccTrnDataArr[i].m_grdoc.rec.GrDealID)
              if(m_AccountingResTrnArr[j].InAccount.Account == accTrn.AccountPayer)
                m_AccountingResTrnArr[j].Sum = m_AccountingResTrnArr[j].Sum + m_AccountingResTrnArr[j].Direct * accTrn.SumPayer;
              elif(m_AccountingResTrnArr[j].InAccount.Account == accTrn.AccountReceiver)
                m_AccountingResTrnArr[j].Sum = m_AccountingResTrnArr[j].Sum - m_AccountingResTrnArr[j].Direct * accTrn.SumReceiver;
              end;
            end;
            j = j + 1;
          end;

        else
          if (arrErrCode[i] != ACCTRN_PACKAGE_ERROR_NUMBER)
            if(arrErrCode[i] == ERR_CLOSED_PAYERACC)
              ClosedAcc = accTrn.AccountPayer;
            elif(arrErrCode[i] == ERR_CLOSED_RECEIVERACC)
              ClosedAcc = accTrn.AccountReceiver;
            end;
            RepErrArr[RepErrArr.size] = CSC_AccountingRepErr(accTrn.Numb_Document, arrErrCode[i], "Ошибка при выполнении проводки \""+accTrn.Ground+"\". " + arrErrMessage[i] + " " + ClosedAcc);
            ClosedAcc = "";
            err = 1;
          end;
        end;
  
        i = i + 1;
      end;
      // выведем реальные ошибки
      if (not resExecute)
        i = 0;
        arrErrCode.size = 0;
        arrErrMessage.size = 0;
        cntErr = AccForRestTrnBatch.GetAddError(arrErrCode, arrErrMessage);
        while ( i < cntErr)
          if (arrErrCode[i] != 0)
            RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", arrErrCode[i], "Ошибка при выполнении проводки. " + arrErrMessage[i]);
            err = 1;
          end;

          i = i + 1;
        end;  
      end;
    end;

    //формируем и исполняем проводки на обороты
    if((not err) and (m_AccountingResTrnArr.size > 0))
      var accResTrnData;
      var accResTrnGrDocArr = TArray();
      var AccountingResTrnBatch = RsbBatchAccTrn;
      var sum = $0;

      PrevSum = $0;
      
      j = 0;
      while((not err) and (j < m_AccountingResTrnArr.size))

        if(m_AccountingResTrnArr[j].Sum != 0)
          accResTrnData = RsbAccTransactionData;

          accResTrnData.Chapter         = m_AccountingResTrnArr[j].InAccount.Chapter;
          accResTrnData.Date_Carry      = m_AccountingResTrnArr[j].dat;
          accResTrnData.Numb_Document   = m_AccountingResTrnArr[j].Numb_Document;
          accResTrnData.ResultCarry     = 1;
          accResTrnData.Kind_Oper       = m_AccountingResTrnArr[j].Kind_Oper;
          accResTrnData.Ground          = m_AccountingResTrnArr[j].Ground;
          accResTrnData.Department      = {OperDprt};
          accResTrnData.Oper            = {oper};

          if( m_AccountingResTrnArr[j].IsLastCarry == true )
             m_AccountingResTrnArr[j].Sum = m_AccountingResTrnArr[j].Sum - PrevSum;
             PrevSum = $0;
          elif( m_AccountingResTrnArr[j].Koef != 1 )
             m_AccountingResTrnArr[j].Sum = round(money(m_AccountingResTrnArr[j].Sum * m_AccountingResTrnArr[j].Koef),2);
             PrevSum = PrevSum + m_AccountingResTrnArr[j].Sum;
          end;

          if(m_AccountingResTrnArr[j].Sum > 0)
            sum = m_AccountingResTrnArr[j].Sum;
            if(m_AccountingResTrnArr[j].InAccount.Code_Currency != m_AccountingResTrnArr[j].PlusResAccount.Code_Currency)
              if( SmartConvertSum(sum, sum, m_AccountingResTrnArr[j].dat, m_AccountingResTrnArr[j].InAccount.Code_Currency, m_AccountingResTrnArr[j].PlusResAccount.Code_Currency, true ) != true )
                err = 1;
              end;
            end;

            if(m_AccountingResTrnArr[j].IsDebetIfPlus)
              accResTrnData.FIIDPayer       = m_AccountingResTrnArr[j].InAccount.Code_Currency;
              accResTrnData.FIIDReceiver    = m_AccountingResTrnArr[j].PlusResAccount.Code_Currency;
              accResTrnData.SumPayer        = m_AccountingResTrnArr[j].Sum;
              accResTrnData.SumReceiver     = sum;
              accResTrnData.AccountPayer    = m_AccountingResTrnArr[j].InAccount.Account;
              accResTrnData.AccountReceiver = m_AccountingResTrnArr[j].PlusResAccount.Account;

              accResTrnData.Shifr_Oper      = DL_GetShifrOper(m_AccountingResTrnArr[j].Chapter, m_AccountingResTrnArr[j].InAccount, m_AccountingResTrnArr[j].PlusResAccount);

            else
              accResTrnData.FIIDPayer       = m_AccountingResTrnArr[j].PlusResAccount.Code_Currency;
              accResTrnData.FIIDReceiver    = m_AccountingResTrnArr[j].InAccount.Code_Currency;
              accResTrnData.SumPayer        = sum;
              accResTrnData.SumReceiver     = m_AccountingResTrnArr[j].Sum;
              accResTrnData.AccountPayer    = m_AccountingResTrnArr[j].PlusResAccount.Account;
              accResTrnData.AccountReceiver = m_AccountingResTrnArr[j].InAccount.Account;

              accResTrnData.Shifr_Oper      = DL_GetShifrOper(m_AccountingResTrnArr[j].Chapter, m_AccountingResTrnArr[j].PlusResAccount, m_AccountingResTrnArr[j].InAccount);
            end;
          else
            sum = ABS(m_AccountingResTrnArr[j].Sum);
            if(m_AccountingResTrnArr[j].InAccount.Code_Currency != m_AccountingResTrnArr[j].MinusResAccount.Code_Currency)
              if( SmartConvertSum(sum, sum, m_AccountingResTrnArr[j].dat, m_AccountingResTrnArr[j].InAccount.Code_Currency, m_AccountingResTrnArr[j].MinusResAccount.Code_Currency, true ) != true )
                err = 1;
              end;
            end;

            if(m_AccountingResTrnArr[j].IsDebetIfPlus) 
              accResTrnData.FIIDPayer       = m_AccountingResTrnArr[j].MinusResAccount.Code_Currency;
              accResTrnData.FIIDReceiver    = m_AccountingResTrnArr[j].InAccount.Code_Currency;
              accResTrnData.SumPayer        = sum;
              accResTrnData.SumReceiver     = ABS(m_AccountingResTrnArr[j].Sum);
              accResTrnData.AccountPayer    = m_AccountingResTrnArr[j].MinusResAccount.Account;
              accResTrnData.AccountReceiver = m_AccountingResTrnArr[j].InAccount.Account;

              accResTrnData.Shifr_Oper      = DL_GetShifrOper(m_AccountingResTrnArr[j].Chapter, m_AccountingResTrnArr[j].MinusResAccount, m_AccountingResTrnArr[j].InAccount);
            else
              accResTrnData.FIIDPayer       = m_AccountingResTrnArr[j].InAccount.Code_Currency;
              accResTrnData.FIIDReceiver    = m_AccountingResTrnArr[j].MinusResAccount.Code_Currency;
              accResTrnData.SumPayer        = ABS(m_AccountingResTrnArr[j].Sum);
              accResTrnData.SumReceiver     = sum;
              accResTrnData.AccountPayer    = m_AccountingResTrnArr[j].InAccount.Account;
              accResTrnData.AccountReceiver = m_AccountingResTrnArr[j].MinusResAccount.Account;

              accResTrnData.Shifr_Oper      = DL_GetShifrOper(m_AccountingResTrnArr[j].Chapter, m_AccountingResTrnArr[j].InAccount, m_AccountingResTrnArr[j].MinusResAccount);
            end;
            
          end;

          AccountingResTrnBatch.AddAccTransaction( accResTrnData, NULL, 0, 0 );

          i = accResTrnGrDocArr.size;

          accResTrnGrDocArr[i] = TRecHandler("dlgrdoc.dbt");

          accResTrnGrDocArr[i].Clear();

          accResTrnGrDocArr[i].rec.GrDealID     = m_AccountingResTrnArr[j].GrDealID;
          accResTrnGrDocArr[i].rec.DocKind      = DLDOC_CARRY;
          accResTrnGrDocArr[i].rec.DocID        = 0;
          accResTrnGrDocArr[i].rec.ServDocKind  = m_ServDocKind;
          accResTrnGrDocArr[i].rec.ServDocID    = m_ServDocID;
          accResTrnGrDocArr[i].rec.GrpID        = m_GrpID;
          accResTrnGrDocArr[i].rec.SourceType   = DLGR_SOURCETYPE_NORMAL; 

        end;

        j = j + 1;
      end;

      if( (not err) AND (AccountingResTrnBatch != NULL) )
        resExecute = AccountingResTrnBatch.Execute(ACCTRN_EXEC_MODE_ONE_PACK);
        //Переносим ID проводок
        nCarry = AccountingResTrnBatch.GetResult( arrErrCode, arrErrMessage );
        i = 0;
        while(i < nCarry)
          accTrn = AccountingResTrnBatch.GetAccTransaction(i);
    
          if( arrErrCode[i] == 0 )
            accResTrnGrDocArr[i].rec.DocID = accTrn.AccTrnID;
          else
            if (arrErrCode[i] != ACCTRN_PACKAGE_ERROR_NUMBER)
              RepErrArr[RepErrArr.size] = CSC_AccountingRepErr(accTrn.Numb_Document, arrErrCode[i], "Ошибка при выполнении проводки \""+accTrn.Ground+"\". " + arrErrMessage[i]);
              err = 1;
            end;
          end;
    
          i = i + 1;
        end;
        // выведем реальные ошибки
        if (not resExecute)
          i = 0;
          arrErrCode.size = 0;
          arrErrMessage.size = 0;
          cntErr = AccountingResTrnBatch.GetAddError(arrErrCode, arrErrMessage);
          while ( i < cntErr)
            if (arrErrCode[i] != 0)
              RepErrArr[RepErrArr.size] = CSC_AccountingRepErr("", arrErrCode[i], "Ошибка при выполнении проводки. " + arrErrMessage[i]);
              err = 1;
            end;

            i = i + 1;
          end;  
        end;
        m_dlgrdocCache.AddRecordArray(accResTrnGrDocArr);
      end;
    end;

    //вставка привязок проводок к строкам графиков
    if(not err)
      if(not m_dlgrdocCache.insert())
        err = 1;
      end;
    end;

    //занести данные в регистр переоценки
    if((not err) and (m_ArrRegistrValue.size > 0) and (m_GrpID > 0) and (m_msesPrcId == null))
      i = 0;
      while(i < m_ArrRegistrValue.size)

        dl_value = TRecHandler("dl_value.dbt");
        dl_value.Clear();

        dl_value.rec.DocKind      = m_ArrRegistrValue[i].m_DocKind;
        dl_value.rec.DocID        = m_ArrRegistrValue[i].m_DocID;  
        dl_value.rec.Kind         = m_ArrRegistrValue[i].m_Kind;
        dl_value.rec.Date         = m_ArrRegistrValue[i].m_Date;
        dl_value.rec.Sum          = m_ArrRegistrValue[i].m_Sum;
        dl_value.rec.SumFIID      = m_ArrRegistrValue[i].m_SumFIID;
        dl_value.rec.ID_Operation = m_ServDocID;
        dl_value.rec.ID_Step      = -1;
        dl_value.rec.GrpID        = m_GrpID;

        dl_valueCache.AddRecord(dl_value);

        i = i + 1;
      end;

    end;

    //занести данные в регистр по комиссиям
    if((not err) and (m_ArrComissValue.size > 0) and (m_GrpID > 0) and (m_msesPrcId == null))
      i = 0;
      while(i < m_ArrComissValue.size)

        dl_value = TRecHandler("dl_value.dbt");
        dl_value.Clear();

        dl_value.rec.DocKind      = m_ArrComissValue[i].m_DocKind;
        dl_value.rec.DocID        = m_ArrComissValue[i].m_DocID;
        dl_value.rec.Kind         = m_ArrComissValue[i].m_Kind;
        dl_value.rec.Date         = m_ArrComissValue[i].m_Date;
        dl_value.rec.Sum          = m_ArrComissValue[i].m_Sum;
        dl_value.rec.SumFIID      = m_ArrComissValue[i].m_SumFIID;
        dl_value.rec.ID_Operation = m_ServDocID;
        dl_value.rec.ID_Step      = -1;
        dl_value.rec.GrpID        = m_GrpID;

        dl_valueCache.AddRecord(dl_value);

        i = i + 1;
      end;
    end;

    if(not err)
      if(not dl_valueCache.insert())
        err = 1;
        msgbox("Ошибка при сохранении сумм");
      end;
    end;

    if(not err)
      if(m_NUTaxObj != NULL)
        m_NUTaxObj.Save();
      end;
    end;

    if( not err )
       err = ИзменитьСтатусВидаУчета();
    end;

    if (not err)
      msesDataDeleter.Success();
    end;

    return err;
  end;

  macro ДобавитьCуммыПоПортфелюПоСделке( _DealID:integer, _SummTP:money, _SummPPR:money, _SummPUDP:money, _SummPKU:money )
     m_CуммыПоПортфелюПоСделке.AddSum( _DealID, _SummTP, _SummPPR, _SummPUDP, _SummPKU );
  end;

  macro ПолучитьCуммыПоПортфелюПоСделке( _DealID:integer, _SummTP:@money, _SummPPR:@money, _SummPUDP:@money, _SummPKU:@money )
     m_CуммыПоПортфелюПоСделке.GetSum( _DealID, @_SummTP, @_SummPPR, @_SummPUDP, @_SummPKU );
  end;

  macro clear()
    m_GrpID                               = 0;
    m_SubGrpID                            = 0;
    m_GrDealID                            = 0;
    m_SourceType                          = DLGR_SOURCETYPE_NORMAL;
    m_AccountingTrnBatch                  = RsbBatchAccTrn;
    m_AccountingGrDocArr.size             = 0;
    m_AccountingForRestAccTrnDataArr.size = 0;
    m_AccountingDocOffArr.size            = 0;
    m_ArrRegistrValue.size                = 0;
    m_ArrComissValue.size                 = 0;
    m_ArrGrDealID.size                    = 0;
    m_ArrDLSUM.size                       = 0;
    m_CurrAvrFIID                         = -1;
    m_dlgrdocCache                        = RsbSQLInsert("dlgrdoc.dbt");
    m_AccountingResTrnArr.size            = 0;
    m_CуммыПоПортфелюПоСделке             = ЦБ_CуммыПоПортфелюПоСделке();

    m_grp.Clear();
    m_NUTaxObj                            = NULL;

    ClearGlobalTmp( "dpmwrtsum_tmp" );
  end;

  m_ServDocKind = ServDocKind;
  m_ServDocID   = ServDocID;
  this.clear();
end;

macro БУ_ПроводкаНаОборот(InAccount,               //record исходный счет, по которому считаться обороты             
                          IsDebetIfPlus:bool,      //если оборот положительный, то исходный счет по дебету    
                          Direct:integer,          //1 или -1, что 1, если обороты по дебету счетать с плюсом.
                          PlusResAcc,              //record счета для проводки, если оборот положительный  
                          MinusResAcc,             //record счета для проводки, если оборот отрицательный  
                          Chapter:integer,         //глава счетов                                             
                          Ground:string,           //основание проводки                                       
                          dat:date,                //дата проводки                                            
                          Kind_Oper,
                          Numb_Document,
                          Koef:double,             //доля от остатка, которая должна пойти в проводку
                          IsLastCarry:bool         //последняя проводка, на которую пойдет остаток округления     
                         )

  ПроводкиБУ.AddResTrn(TAccResTrnData( ПроводкиБУ.GetGrDealID(),
                                       InAccount,          
                                       IsDebetIfPlus,      
                                       Direct,          
                                       PlusResAcc,  
                                       MinusResAcc, 
                                       Chapter,         
                                       Ground,          
                                       dat,
                                       Kind_Oper,
                                       Numb_Document,
                                       Koef,
                                       IsLastCarry
                                     ));
  return true;
end;


MACRO БУ_СохранитьСуммуКомиссии( DocKind:INTEGER, DocID:INTEGER, Kind:INTEGER, CommDate:DATE, Sum:MONEY, NDS:MONEY, Currency:INTEGER, FIID:INTEGER ):BOOL
  ПроводкиБУ.SetDLSUM( DocKind, DocID, Kind, CommDate, Sum, NDS, Currency, FIID );
  return true;
END;

MACRO БУ_ПолучитьПоследнююСумму(DocKind, DocID, SumKind, _Date, Currency, FIID)
  VAR Summa = ПроводкиБУ.GetDLSUM(DocKind, DocID, SumKind, _Date, FIID);
   
  if( _Date != null )
     SetParm(3, Summa.CommDate );
  end;

  if( Currency != null )
     SetParm( 4, Summa.Currency );
  end;
  return Summa.Sum;
end;

/*Используется в переоценке НВПИ и в сделках из 1 части при выполнении проводок по переоценке НВПИ*/
macro БУ_ПолучитьИСохранитьТекущуюСуммуТОвВР(FD, dat, RQID, _str_err)
   var Sum = $0, str_err = "", str_pm_name = "";

   if ((FD.ExistAvance()) and (RQID == FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID))
      Sum = СуммаАвансаВР(FD);
      str_pm_name = "авансу";
   elif (RQID == FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID)
      Sum = СуммаОплатыВР(FD);
      str_pm_name = "оплате";
   elif (RQID == FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID)
      Sum = СуммаПоставкиВР(FD);
      str_pm_name = "поставке";
   else
      str_err = "Неверное ТО по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(3, str_err);
      return $0;
   end;

   if( not SmartConvertSum( Sum, Sum, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
      str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());
      SetParm(3, str_err);
      return $0;
   end;

   if( not БУ_СохранитьСуммуКомиссии( DLDOC_PAYMENT, RQID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, 
                                   dat, Sum, $0, FD.GetPayFIID() ) )
      str_err = "Ошибка при сохранении суммы по Т/О по " + str_pm_name;
      SetParm(3, str_err);
      return $0;
   end; 

   SetParm(3, "");
   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках РЕПО при выполнении проводок по переоценке НВПИ*/
macro БУ_ПолучитьИСохранитьТекущуюСуммуТОвВРпоРЕПО(FD, dat, rq, _str_err)
   var Sum = $0, str_err = "", str_pm_name = "";

   Sum = rq.rec.Amount;
   if ((FD.ExistAvance()) and (rq.rec.ID == FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID))
      str_pm_name = "авансу";
   elif (rq.rec.ID == FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID)
      str_pm_name = "оплате";
   else
      str_err = "Неверное ТО по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(3, str_err);
      return $0;
   end;

   if(FD.IsBack)
      str_err = str_err + "2ч ";
   end;

   if( not SmartConvertSum( Sum, Sum, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
      str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());
      SetParm(3, str_err);
      return $0;
   end;

   if( not БУ_СохранитьСуммуКомиссии( DLDOC_PAYMENT, rq.rec.ID, DLSUM_KIND_SUM_CLAIMS_LIABILITE, 
                                   dat, Sum, $0, FD.GetPayFIID() ) )
      str_err = "Ошибка при сохранении суммы по Т/О по " + str_pm_name;
      SetParm(3, str_err);
      return $0;
   end; 

   SetParm(3, "");
   return Sum;
end;

/*Используется в переоценке НВПИ и в сделках РЕПО при выполнении проводок по переоценке НВПИ*/
macro БУ_ПолучитьИСохранитьТекущуюСуммуПроцентовПоРЕПО(FD, dat, Kind, _str_err, Sum_CFI)

   var Sum = $0, str_err = "";

   Sum = Sum_CFI;

   if( not SmartConvertSum( Sum, Sum, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false) )
      str_err = "Ошибка при получении информации о курсе " + ПолучитьКодФинИн(FD.dl_leg.rec.CFI) + " к " + ПолучитьКодФинИн(FD.GetPayFIID());
      SetParm(3, str_err);
      return $0;
   end;

   if( not БУ_СохранитьСуммуКомиссии( DL_SECURITYDOC, FD.tick.rec.DealID, Kind, 
                                   dat, Sum, $0, FD.GetPayFIID() ) )
      str_err = "Ошибка при сохранении суммы процентов по сделке с кодом " + string(FD.tick.rec.DealCode);
      SetParm(3, str_err);
      return $0;
   end; 

   SetParm(3, "");
   return Sum;
end;

macro БУ_СниматьСВнебаланса(FD, CheckDate:date)
  var query, cmd, DataSet;
  var cnt = 0;

   query =   " select count(1) cnt "
           + "   from ddlgracc_dbt gracc, ddlgrdeal_dbt grdeal "
           + "  where grdeal.t_DocKind = ? "
           + "    and grdeal.t_DocID = ? "
           + "    and grdeal.t_TemplNum = " + DLGR_TEMPL_OFFBALANCE
           + "    and gracc.t_GrDealID = grdeal.t_ID "
           + "    and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
           + "    and (   (gracc.t_State = " + DLGRACC_STATE_FACTEXEC + ") "
           + "         or (gracc.t_State = " + DLGRACC_STATE_PLAN + " and grdeal.t_PlanDate = ?)"
           + "        )";
   cmd = DL_RSDCommand(query);
   cmd.AddParam(FD.tick.rec.BOfficeKind);
   cmd.AddParam(FD.tick.rec.DealID);
   cmd.AddParam(CheckDate);

   DataSet = cmd.Execute();
   if(DataSet.moveNext())
     cnt = int(DataSet.cnt);
   end;

   return cnt;
end;

private MACRO БУ_ДобавитьСводнуюПроводку( FD:SPFirst, accTrnData, AccountPayer:VARIANT, AccountReceiver:VARIANT, DateCarry:DATE, SummaDebet:MONEY, SummaCredit:MONEY, Result_Carry, Ground:STRING, Mode:integer, Error:@string )

   Error = "";
    
   if( AccountPayer.Chapter == 5 )
      Error = " Для вставки сводного поручения ДЕПО должна использоваться функция ДобавитьСводноеПоручениеДЕПО";
      return false;
   end;

   var spdocoff =  TRecHandler("spdocoff.dbt");
   
   spdocoff.Clear();

   spdocoff.rec.PartyID = FD.tick.rec.MarketID;
   
   spdocoff.rec.OfficeID          = FD.GetParametr(MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE, DateCarry); /*Сектор*/
   spdocoff.rec.Chapter           = AccountPayer.Chapter; /*Глава*/
   spdocoff.rec.Date_Carry        = DateCarry; /*Дата проводки*/
   spdocoff.rec.Currency_Payer    = AccountPayer.Code_Currency; /*Валюта счета плательщика*/
   spdocoff.rec.Account_Payer     = AccountPayer.Account; /*Счет плательщика*/
   spdocoff.rec.Sum_Payer         = SummaDebet; /*Сумма по счету плательщика*/
   spdocoff.rec.Currency_Receiver = AccountReceiver.Code_Currency; /*Валюта счета получателя*/
   spdocoff.rec.Account_Receiver  = AccountReceiver.Account; /*Счет получателя*/
   spdocoff.rec.Sum_Receiver      = SummaCredit; /*Сумма по счету получателя*/
   spdocoff.rec.State             = SPDOCOFF_STATE_PREPARED; /*Статус */
   spdocoff.rec.MarketSchemeID    = FD.GetMarketSchemeID(); /* Схема расчетов с биржей*/
   spdocoff.rec.GroundKind        = ПолучитьНомерОснованияСводнПроводки( FD, AccountPayer, AccountReceiver, Result_Carry, Ground);
   
   if( IsClientDeal(FD.tick.rec)  )
      spdocoff.rec.IsClientCarry  = SET_CHAR;
   else
      spdocoff.rec.IsClientCarry  = UNSET_CHAR;
   end;

   spdocoff.rec.DealID     = FD.tick.rec.DealID;

   if(ПроводкиБУ.AddDocOff(accTrnData, spdocoff, Mode) != 0)
     return false;
   end;

   return true;
END;

/* Проводка по категориям учета (в том числе и мультивалютная)
   СчетДебет,СчетКредит - если тип V_STRING то категории, иначе record ACCOUNT*/
MACRO БУ_ПроводкаПоКатегориямУчета( FD, СчетДебет, СчетКредит, ДатаВалютирования,
                                    Chapter ,FIID, СуммаОперации, 
                                    Result_Carry, Kind_Oper,Numb_Document,Ground,
                                    Mode, //для выполнения проводки на остаток по счету (1 - по счету дебета, 2 - по счету кредита, иначе на переданную сумму )
                                    FIRolePayer, FIRoleReceiver,
                                    СчетДебетFIID, СчетКредитFIID, FIID2, СуммаОперации2,
                                    PaymID_type, 
                                    IsSummaryCarry, /*Признак сводной проводки*/
                                    IsInnerCarry,   /*Признак провордки по ВУ*/
                                    ВидРО, DebAccNumber:@string, CredAccNumber:@string, NatSum:@money,
                                    DebPairAcc, CredPairAcc, 
                                    Koef,           /*28 - доля от остатка, которая должна пойти в проводку(используется в проводках на остаток)*/
                                    IsLastCarry:bool,/*29 - true - значит, последняя проводка в группе проводок, на которую пойдет остаток округления(используется в проводках на остаток)*/ 
                                    SumEquivalentCarry /*сумма эквивалент в нацвалюте*/
                                  )
   var stat:bool = true, CуммаДебет = $0, СуммаКредит  = $0;

   var tr, NoCarry:bool = false;
   var Error = "";
   
   record AccountPayer(account);
   record AccountReceiver(account);

   if ( FD != NULL )
    if ((FD.tick != NULL) AND (Numb_Document == ""))
       Numb_Document = FD.tick.rec.DealCode;
    end;
   end;

   macro SayCarryError( error )
     MsgBox(error);
     return false;
   end;

   if( IsSummaryCarry == null )
     IsSummaryCarry = false;
   end;

   if((ValType(Mode) != V_INTEGER))
     Mode = 0;
   end;

   if( (СуммаОперации == null) AND (СуммаОперации2 == null) )  
     return SayCarryError( "В проводке не задана ни одна из сумм." );
   end;
     
   /*оставить только копейки для первой суммы, если она задана*/
   if( СуммаОперации != null )
     if( Chapter != 5 ) /*количество ц/б может быть дробным*/
        СуммаОперации = money( round( СуммаОперации, 2 ) );    
     end;
     if( (СуммаОперации < $0) and ((Mode != GETRESTACC_DEBET) AND (Mode != GETRESTACC_CREDIT)) )
        return SayCarryError( "Сумма проводки < 0." );
     end;
   else  
    СуммаОперации = $0;
   end;
   /*для второй суммы, если она задана*/
   if( СуммаОперации2 != null )
     if( Chapter != 5 ) /*количество ц/б может быть дробным*/
        СуммаОперации2 = money( round( СуммаОперации2, 2 ) );
     end;
     if( (СуммаОперации2 < $0) and ((Mode != GETRESTACC_DEBET) AND (Mode != GETRESTACC_CREDIT)) )
        return SayCarryError( "Вторая сумма проводки < 0." );
     end;
   else
    СуммаОперации2 = $0;
   end;

   if( (СуммаОперации == $0) AND (СуммаОперации2 == $0) AND ((Mode != GETRESTACC_DEBET) AND (Mode != GETRESTACC_CREDIT)))  
     return true;
   end;

   if( ValType(СчетДебет) == V_STRING ) /*задан через категорию*/
     if ((СчетДебет == "+Форвард, прочие") or (СчетДебет == "-Форвард, прочие"))
        if(not FD.OpenAccount( СчетДебет, null, true, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, null, DebPairAcc) )
           if( not FD.ReOpenAccount( СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, DebPairAcc) )
             return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
           end;
        end;
     else
       if( (not FD.IsExistAccount( СчетДебет, null, true, FIRolePayer, AccountPayer, null, ДатаВалютирования, СчетДебетFIID)) and
           (not FD.OpenAccount( СчетДебет, null, true, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, null, DebPairAcc)) )
           if( not FD.ReOpenAccount( СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, DebPairAcc) )
             return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
           end;
       end;
     end;
   else
     copy( AccountPayer, СчетДебет );
   end;

   if( ValType(СчетКредит) == V_STRING ) /*задан через категорию*/
      if ((СчетКредит == "+Форвард, прочие") or (СчетКредит == "-Форвард, прочие"))
        if(not FD.OpenAccount( СчетКредит, null, true, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, null, CredPairAcc) )
          if( not FD.ReOpenAccount(СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, CredPairAcc) )
            return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
          end;
        end;
      else
        if( (not FD.IsExistAccount( СчетКредит, null, true, FIRoleReceiver, AccountReceiver, null, ДатаВалютирования, СчетКредитFIID)) and
            (not FD.OpenAccount( СчетКредит, null, true, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, null, CredPairAcc)) )
          if( not FD.ReOpenAccount(СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, CredPairAcc) )
            return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
          end;
        end;
      end;
   else
     copy( AccountReceiver, СчетКредит );
   end;

   if( AccountPayer.Code_Currency == AccountReceiver.Code_Currency)

     /*задана только вторая сумма в валюте одного из счетов*/
     if( (FIID == null) AND (FIID2 != null) )
        FIID = FIID2;
     elif( (FIID == null) AND (FIID2 == null) )
        return SayCarryError("Не задана ни одна из валют проводки.");
     end;

     if( (FIID != AccountPayer.Code_Currency) AND
         (FIID != AccountReceiver.Code_Currency) )
        return SayCarryError( "В проводке не совпадают валюты счетов: " 
                               + string(AccountPayer.Code_Currency) + " " + string( AccountReceiver.Code_Currency ) +
                              "| и валюта документа: " + string(FIID) );
     end;

     if( СуммаОперации != $0 )
        CуммаДебет = СуммаКредит = СуммаОперации;
     elif( СуммаОперации2 != $0 )
        CуммаДебет = СуммаКредит = СуммаОперации2;
     end;
     
   else /* валюты разные - мультивалютная проводка */
      
     СуммаКредит = $0;
     CуммаДебет  = $0;
     
     /*задана одна сумма в валюте одного из счетов*/
     if( (FIID != null) AND (FIID2 == null) )
        if( FIID == AccountPayer.Code_Currency )
           CуммаДебет  = СуммаОперации;
        else
           СуммаКредит = СуммаОперации;
        end;
     /*задана только вторая сумма в валюте одного из счетов*/
     elif( (FIID2 != null) AND (FIID == null) )
        if( FIID2 == AccountPayer.Code_Currency )
           CуммаДебет  = СуммаОперации2;
        else
           СуммаКредит = СуммаОперации2;
        end;
     /*заданы обе суммы в валютах счетов по которым выполняем проводку*/
     elif( (FIID2 != null) AND (FIID != null) )                         
       if( FIID == AccountPayer.Code_Currency ) 
          CуммаДебет  = СуммаОперации;
       elif( FIID2 == AccountPayer.Code_Currency ) 
          CуммаДебет  = СуммаОперации2;
       end;

       if( FIID == AccountReceiver.Code_Currency ) 
          СуммаКредит = СуммаОперации;
       elif( FIID2 == AccountReceiver.Code_Currency ) 
          СуммаКредит = СуммаОперации2;
       end;
     else
        return SayCarryError("Не задана ни одна из валют проводки.");
     end;

     if( ((Mode != GETRESTACC_DEBET) AND (Mode != GETRESTACC_CREDIT)) AND (not CheckMultyCarrySum( AccountPayer.Code_Currency, AccountReceiver.Code_Currency,
                                 CуммаДебет, СуммаКредит, ДатаВалютирования )) )
        return SayCarryError("Ошибка при определении сумм мультивалютной проводки.");
     end;

   end;

   var accTrnData = RsbAccTransactionData;


    
//  NoCarry = true;
   If(NoCarry == false)
      accTrnData.Chapter         = Chapter;
      accTrnData.Date_Carry      = DL_SetCarryDateWithQuestion(FD, ДатаВалютирования, false);
/*  if((FD.Kind == DL_SECUROWN) or (FD.Kind == DL_AVRWRTOWN)  or  (FD.Kind == DL_RETIREMENT_OWN))
    accTrnData.Number_Pack  = 20/*СЭБ*/;
  else 
    accTrnData.Number_Pack  = 10/*БОЦБ*/;
  end;
*/
      accTrnData.Number_Pack  = 10/*БОЦБ*/;

      if (index(Ground,"писание оценочного резерва") > 0)
          accTrnData.Number_Pack  = 10/*125*//*Восстановление резервов*/;
      end;

/*DAN.Ролевая модель Определяем конечного операциониста для проводки */
      var retvalGetMO = GetMainOperInGroup(FD.Kind);
      if (retvalGetMO > 0)
	accTrnData.Oper = retvalGetMO;
      else
         accTrnData.Oper = {Oper};
      end;
/*DAN*/


      accTrnData.Numb_Document   = Numb_Document;
      accTrnData.ResultCarry     = 1;
      accTrnData.Kind_Oper       = Kind_Oper;
      accTrnData.Ground          = Ground;
      accTrnData.Department      = {OperDprt};
//      accTrnData.Oper            = {oper};
      accTrnData.FIIDPayer       = AccountPayer.Code_Currency;
      accTrnData.FIIDReceiver    = AccountReceiver.Code_Currency;
      accTrnData.SumPayer        = CуммаДебет;
      accTrnData.SumReceiver     = СуммаКредит;
      accTrnData.AccountPayer    = AccountPayer.Account;
      accTrnData.AccountReceiver = AccountReceiver.Account;
      accTrnData.Shifr_Oper      = DL_GetShifrOper(Chapter, AccountPayer, AccountReceiver);
      accTrnData.AddOFRSymbol(SC_GetOFRRecID(FD, AccountPayer, AccountReceiver, FIRolePayer, FIRoleReceiver, ДатаВалютирования));

   if(SumEquivalentCarry != null)
     accTrnData.SumEquivalentCarry = SumEquivalentCarry;
   end;

      if( (IsSummaryCarry == false) AND 
          НужнаСводнаяПроводка( FD, СчетДебет, СчетКредит, Chapter )
        )

         stat = БУ_ДобавитьСводнуюПроводку( FD, accTrnData, AccountPayer, AccountReceiver, ДатаВалютирования, CуммаДебет, IIF(AccountPayer.Code_Currency == AccountReceiver.Code_Currency,$0,СуммаКредит), Result_Carry, Ground, Mode, @Error );
         if( not stat ) 
            return SayCarryError("Ошибка при вставке документа сводной проводки."+Error);
         end;
      else
         ПроводкиБУ.Add(accTrnData, Mode, Koef, IsLastCarry);
      end;
   end;
   /*-------------------------------------------------------------------------*/  
   if( DebAccNumber != null )
      DebAccNumber = tr.AccountPayer;
   end;

   if( CredAccNumber != null )
      CredAccNumber = tr.AccountReceiver;
   end;

   if( NatSum != null )
      if( tr.FIIDPayer == NATCUR )
         NatSum = tr.SumPayer;
      elif( tr.FIIDReceiver == NATCUR )
         NatSum = tr.SumReceiver;
      else
         NatSum = $0.0;
      end;
   end;

   if( not stat ) 
      return SayCarryError("Ошибка при вставке документа проводки.");
   end;

   return stat;
END;

private macro GetAccountID(acc, chapter, codeCur):integer
   var dataSet, accID=0;
   var cmd = DL_RSDCommand("SELECT t_accountID FROM daccount_dbt " +
                           " WHERE t_account       = ? " + /*1*/
                           "   AND t_chapter       = ? " + /*2*/
                           "   AND t_Code_Currency = ? "   /*3*/
                          );

   cmd.AddParam(acc);     /*1*/
   cmd.AddParam(chapter); /*2*/
   cmd.AddParam(codeCur); /*3*/
   dataSet = cmd.Execute();
   if(dataSet.moveNext())
     accID = dataSet.accountID;
   end;
   return accID;
end;

private macro isTransferDLGRDOC(dealID, servDocKind, servDocID, grpID, newAccID):bool
   var cnt = 0;
   var dataSet;
   var cmd = DL_RSDCommand("SELECT count(1) cnt FROM ddlgrdoc_dbt " +
                           " WHERE t_DocKind     = " + String(DLDOC_ACCOUNT) +
                           "   AND t_GrDealID    = ? " + /*1*/
                           "   AND t_ServDocKind = ? " + /*2*/
                           "   AND t_ServDocID   = ? " + /*3*/
                           "   AND t_GrpID       = ? " + /*4*/
                           "   AND t_DocID       = ? " + /*5*/
                           "   AND t_SourceType = 10 "
                          );

   cmd.AddParam(dealID);      /*1*/
   cmd.AddParam(servDocKind); /*2*/
   cmd.AddParam(servDocID);   /*3*/
   cmd.AddParam(grpID);       /*4*/
   cmd.AddParam(newAccID);    /*5*/
   
   dataSet = cmd.Execute();
   if(dataSet.moveNext())
     cnt = int(dataSet.cnt);
   end;

   return (cnt!=0);
end;

private macro TransferOD( FD, CategOD, OldOD, dat, isA, NewAccount:@STRING )
   VAR NewOD = TRecHandler( "account" );
   var dlgrdocCache = null;

   NewAccount = "";

   if( OldOD.rec.account != "" )
      if( not FD.ActualCheckPeriod( CategOD, null, null, null, NewOD, dat, null, null, null )) 
         return 1;
      end;

      if(NewOD.rec.Account != OldOD.rec.Account) 
         if (NewOD.rec.AccountID == 0) /* Пока при новом открытии счета accountId нулевой :( */
            NewOD.rec.AccountID = GetAccountID(NewOD.rec.Account, NewOD.rec.Chapter, NewOD.rec.Code_Currency);
         end;

         if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                               IIF(isA, NewOD, OldOD),              /* Деб */
                                               IIF(isA, OldOD, NewOD),              /* Кредит */
                                               dat,                                 /* Дата */
                                               1,                                   /* Глава */
                                               OldOD.rec.Code_Currency,             /* Валюта */
                                               ABS(GetRestAccount(OldOD.rec, dat)), /* Сумма */
                                               INPCARRY,                            /* Result_Carry */
                                               " 1",                                /* Kind_Oper */
                                               FD.tick.rec.DealCode,                /* Numb_Document */
                                               "Перенос остатка счета категории " + CategOD + " по сделке " + FD.tick.rec.DealCode /* Ground */
                                             )
           )
            return 1;
         end;

         /* Создать связку для отката */
         if ((NewOD.rec.AccountID != 0) and 
             (not isTransferDLGRDOC(ПроводкиБУ.GetGrDealID(), ПроводкиБУ.GetServDocKind(),
                                    ПроводкиБУ.GetServDocID(), ПроводкиБУ.GetGrpID(), NewOD.rec.AccountID)) ) // а вдруг запись вставилась, а проводка не провелась?
            dlgrdocCache = RsbSQLInsert("dlgrdoc.dbt");

            var dlgrdoc = TRecHandler("dlgrdoc.dbt");

            dlgrdoc.rec.DocKind     = DLDOC_ACCOUNT;
            dlgrdoc.rec.GrDealID    = ПроводкиБУ.GetGrDealID();
            dlgrdoc.rec.ServDocKind = ПроводкиБУ.GetServDocKind();
            dlgrdoc.rec.ServDocID   = ПроводкиБУ.GetServDocID();
            dlgrdoc.rec.GrpID       = ПроводкиБУ.GetGrpID();
            dlgrdoc.rec.DocID       = OldOD.rec.AccountID;
            dlgrdoc.rec.SourceType  = 9;

            dlgrdocCache.AddRecord(dlgrdoc);
            dlgrdoc.rec.DocID       = NewOD.rec.AccountID;
            dlgrdoc.rec.SourceType  = 10;
            dlgrdocCache.AddRecord(dlgrdoc);
            if (not dlgrdocCache.insert())
               msgbox("Ошибка при изменении срочности ОД");
               return 1;
            end;
         end;
         NewAccount = NewOD.rec.Account;
      end;
   end;

   return 0;
end;

MACRO БУ_ИзменитьСрочностьОД( Dat:DATE, FD:SPFirstDoc, FD2:SPFirstDoc, PlOD:TRecHandler, PlOD_2:TRecHandler, MnOD:TRecHandler, MnOD_2:TRecHandler, 
                              Save_BegDateP:DATE, Save_FinDateP:DATE, Save_BegDateM:DATE, Save_FinDateM:DATE ):INTEGER
  var  NewAccountOD;

  SC_GetDateOD( IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД"), FD, FD2, @FD.BegDate, @FD.FinDate );
  FD2.BegDate  = FD.BegDate;
  FD2.FinDate = FD.FinDate;
   
  if(( FD.BegDate != Save_BegDateP) or ( FD.FinDate != Save_FinDateP))
     if( TransferOD( FD, IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД"), PlOD, dat, true, @NewAccountOD ) != 0 )
        return 1;
     end;

     if (PlOD_2.rec.Account!=PlOD.rec.Account)
        if(TransferOD( FD2, IIF(FD.НуженСчетКорзина(), "+ОД, Корзина", "+ОД"), PlOD_2, dat, true, @NewAccountOD ) != 0 )
            return 1;
        end;
     end;
  end;

  SC_GetDateOD( IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД"), FD, FD2, @FD.BegDate, @FD.FinDate );
  FD2.BegDate  = FD.BegDate;
  FD2.FinDate = FD.FinDate;
  if(( FD.BegDate != Save_BegDateM) or ( FD.FinDate != Save_FinDateM))
     if( TransferOD( FD, IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД"), MnOD, dat, false, @NewAccountOD ) != 0 )
        return 1;
     end;    

     if (MnOD_2.rec.Account!=MnOD.rec.Account)
        if( TransferOD( FD2, IIF(FD.НуженСчетКорзина(), "-ОД, Корзина", "-ОД"), MnOD_2, dat, false, @NewAccountOD ) != 0 )
           return 1;
        end;
     end;
  end;
  return 0;
END;


/* Проводки постановки сделки на баланс (для операций покупки/продажи)*/
MACRO БУ_ПоставитьНаБаланс( FD, Dat, _chapter )
  record  СчетУчета( account );
  record  СчетУчета2( account );
  var    DealSum = $0;
  record AccDebet(account);
  record AccKredit(account);
  var AccPFI = TRecHandler("account");
  var    chapter:integer = 1; 
var OtherSum = $0, OtherFIID = -1;    
  var Ground = "";
  PRIVATE VAR fininstr = TRecHandler( "fininstr" );
  if( _chapter != null )
     chapter = _chapter;
  end;

  /*получим сумму сделки*/
  if( not SmartConvertSum( DealSum, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), true))
     return 1;
  end;

  if(IsOUTEXCHANGE(FD.Group) and (FD.tick.rec.RequestID > 0))
    //Эта сделка исполняет частичную поставку/оплату для сделки с идентификатором FD.tick.rec.RequestID
    var mainFD = SPFirstDoc(LEG_KIND_DL_TICK, FD.tick.rec.RequestID);

    if( mainFD.IsExistAccount( "-Форвард, прочие", null, true, FIROLE_FICOM, СчетУчета, null, dat ) and
        mainFD.IsExistAccount( "+Форвард, прочие", null, true, FIROLE_FIREQ, СчетУчета2, null, dat )
      )

      //Количество ц/б, которому соответствует остаток на счете
      //Это будет количество из родительской сделке (сколько там осталось) плюс количество из текущей сделки (сколько частично исполняем)
      var TotalAmount = mainFD.dl_leg.rec.Principal + FD.dl_leg.rec.Principal;
      var Сумма1 = round(ABS( GetRestAccount( СчетУчета, dat ) ) * FD.dl_leg.rec.Principal / TotalAmount, 2);
      var Сумма2 = round(ABS( GetRestAccount( СчетУчета2, dat ) ) * FD.dl_leg.rec.Principal / TotalAmount, 2);

      /*выполняем проводки на остатки по счетам*/
      mainFD.SetFIIDForCorAccNum(СчетУчета.Code_Currency);
      if( not БУ_ПроводкаПоКатегориямУчета( mainFD, 
             СчетУчета, "СчКорреспГлаваГ", /* Деб , Кредит*/
             dat,                   /* Дата */
             4,                     /* Глава */
             СчетУчета.Code_Currency,/* Валюта */
             Сумма1,        /* Сумма */
             INPCARRY,              /* Result_Carry */
             " 1",                  /* Kind_Oper */
             FD.tick.rec.DealCode,  /* Numb_Document */
             "Снятие с внебалансового учета обязательств по сделке " +mainFD.tick.rec.DealCode,/* Ground */
             null, 
             null, FIROLE_CORACC_PASSIVE)
        )
          return 1;
      end;

      mainFD.SetFIIDForCorAccNum(СчетУчета2.Code_Currency);
      if( not БУ_ПроводкаПоКатегориямУчета( mainFD, 
             "СчКорреспГлаваГ", СчетУчета2, /* Деб , Кредит*/
             dat,                   /* Дата */
             4,                     /* Глава */
             СчетУчета2.Code_Currency,  /* Валюта */
             Сумма2,                /* Сумма */
             INPCARRY,              /* Result_Carry */
             " 1",                  /* Kind_Oper */
             FD.tick.rec.DealCode,  /* Numb_Document */
             "Снятие с внебалансового учета требований по сделке " +mainFD.tick.rec.DealCode,/* Ground */
             null, 
             FIROLE_CORACC_ACTIVE, null, 
             null, null,
             СчетУчета2.Code_Currency,
             Сумма2)
        )
          return 1;
      end;
    end;
  end;

  if( (( not FD.IsExistAccount("+Форвард, расчеты", null, true, null, AccDebet, MC_PAIRACCMODE_OPEN, dat, FD.GetPayFIID()) ) AND
      ( not FD.OpenAccount("+Форвард, расчеты", null, null, null, AccDebet, dat, FD.GetPayFIID(), null, null, MC_PAIRACCMODE_OPEN) )) OR
      ( ( not FD.IsExistAccount("-Форвард, расчеты", null, true, null, AccKredit, MC_PAIRACCMODE_OPEN, dat, FD.GetPayFIID()) ) AND
      ( not FD.OpenAccount("-Форвард, расчеты", null, null, null, AccKredit, dat, FD.GetPayFIID(), null, null, MC_PAIRACCMODE_OPEN) ))
       )
       return 1;
     end;
     ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
     If(IsSALE(FD.Group))
            Ground = "Сделка продажи ценной бумаги " + GetFinName(fininstr.rec) + " № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
     else           
            Ground = "Сделка покупки ценной бумаги " + GetFinName(fininstr.rec) + " № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
     end;
  if((FD.dl_leg.rec.CFI != AccDebet.Code_Currency) and (FD.GetPayFIID() != AccDebet.Code_Currency))
    if( not SmartConvertSum( OtherSum, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, AccDebet.Code_Currency, true))
       return 1;
    end;

    OtherFIID = AccDebet.Code_Currency;
  elif((FD.dl_leg.rec.CFI != AccKredit.Code_Currency) and (FD.GetPayFIID() != AccKredit.Code_Currency))
    if( not SmartConvertSum( OtherSum, FD.dl_leg.rec.TotalCost, dat, FD.dl_leg.rec.CFI, AccKredit.Code_Currency, true))
       return 1;
    end;

    OtherFIID = AccKredit.Code_Currency;
  elif((FD.dl_leg.rec.CFI == AccDebet.Code_Currency) or (FD.dl_leg.rec.CFI == AccKredit.Code_Currency))
    OtherSum  = FD.dl_leg.rec.TotalCost;
    OtherFIID = FD.dl_leg.rec.CFI;
  else
    OtherSum  = DealSum;
    OtherFIID = FD.GetPayFIID();
  end;

     if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            AccDebet, AccKredit,  /* КатегДеб , КатегКредит*/
            dat,                  /* Дата */
            chapter ,                   /* Глава */
            FD.GetPayFIID(),      /* Валюта */
            DealSum,              /* Сумма */
            INPCARRY,             /* Result_Carry */
            " 1",                 /* Kind_Oper */
            FD.tick.rec.DealCode,        /* Numb_Document */
            Ground, /*"Отражение требований и обязательств на балансе"*/ /* Ground */
         null, 
         null, null, 
         null, null,
         OtherFIID, OtherSum
           ))
         return 1;
     end;

    var Dп = FD.DateArray[DATE_DEALSETAVOIRISS];
    var Dо = FD.DateArray[DLGR_DATEKIND_PAYMENT];

  if( (FD.tick.rec.IsPFI == SET_CHAR) and (IsBUY(FD.Group) or (IsSALE(FD.Group) ) ) and (FD.Kind != DL_TRUSTDOC) )
     var СС_ПФИ_new:money = $0, СС_ПФИ_old:money = $0, СП_ПФИ = $0, IsFill = false, IsAccounted = false;
     var DebCat, CredCat;

   if( FD.tick.rec.OriginID == CodeFor("Ю") )
        СС_ПФИ_new = FD.GetFrValSumLastAccountedOnDate(dat);
        if( IsBUY(FD.Group) and (СС_ПФИ_new < $0) )
           if( not FD.GetDV_PFI_ACC(true,@AccPFI) )
              return 1;
           end;
           Ground = "ПФИ(). Списание справедливой стоимости по сделке N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + ". К/агент: " + UserGetPartyShortName(FD.tick.rec.partyid);

           if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                 AccPFI,AccDebet,
                                                 dat,                      /* Дата */
                                                 1,                            /* Глава */
                                                 NATCUR,                /* Валюта */
                                                 abs(СС_ПФИ_new),                         /* Сумма */
                                                 INPCARRY,                 /* Result_Carry */
                                                 " 1",                     /* Kind_Oper */
                                                 "",                           /* Numb_Document */
                                                 Ground/*"Прекращение признания производного финансового инструмента"*/
                                               )
             )
              return 1;
           end;
        elif( IsSALE(FD.Group) and (СС_ПФИ_new > 0) and (Dп >  Dо)) 
             if( not FD.GetDV_PFI_ACC(true,@AccPFI) )
                 return 1;
             end;

                if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                AccKredit, AccPFI,
                                                dat,                      /* Дата */
                                                1,                            /* Глава */
                                                NATCUR,                /* Валюта */
                                                abs(СС_ПФИ_new),                         /* Сумма */
                                                INPCARRY,                 /* Result_Carry */
                                                " 1",                     /* Kind_Oper */
                                                "",                           /* Numb_Document */
                                                "Прекращение признания производного финансового инструмента"
                                               )
                   )
                    return 1;
                end;

        end;
     else
        СС_ПФИ_new = FD.GetFrValSumByDate(dat,@IsFill,@IsAccounted);
        if( IsFill and (not IsAccounted) )
           СС_ПФИ_old = FD.GetFrValSumLastAccountedOnDate(dat,@IsFill);
           if( not IsFill )
              msgbox("Не заполнено значение справедливой стоимости по сделке №"+FD.tick.rec.DealCode+" за ближайшую прошлую дату");
           end;
           СП_ПФИ = СС_ПФИ_new - СС_ПФИ_old;
           /*делаем переоценку*/
           if( СП_ПФИ != $0 )
              if( СП_ПФИ > 0 )
                 DebCat  = "+ПФИ";
                 CredCat = "Доходы ПФИ";
                 Ground = "Положительная переоценка справедливой стоимости ПФИ";
              else
                 DebCat  = "Расходы ПФИ";
                 CredCat = "-ПФИ";
                 Ground = "Отрицательная переоценка справедливой стоимости ПФИ";
              end;
              if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                    DebCat,CredCat,
                                                    dat,                   /* Дата */
                                                    1,                     /* Глава */
                                                    NATCUR,                /* Валюта */
                                                    abs(СП_ПФИ),           /* Сумма */
                                                    INPCARRY,
                                                    " 1", 
                                                    "",
                                                    Ground
                                                  )
                )
                 return 1;      
              end;
              /*на запись СС ПФИ ставим признак учета*/
              if( DL_SetAccountedFrVAL(FD.tick.rec.DealID,FD.tick.rec.BofficeKind,Dat,ПроводкиБУ.GetServDocID(),0,ПроводкиБУ.GetGrpID()) != 0 )
                 return 1;
              end;
              if(РАБОТА_С_РЕПОЗИТАРИЕМ())
                if(SP_InsertGrDealFairValueRevaluation(FD, Dat))
                  return 1;
                end;
              end;
           end;
        elif( not IsFill )
           /*формируем сообщение для вывода в протокол*/
           msgbox("Не заполнено значение справедливой стоимости по сделке №"+FD.tick.rec.DealCode+" за "+string(dat));
           СС_ПФИ_new = FD.GetFrValSumLastAccountedOnDate(dat);
        end;

        if( СС_ПФИ_new != $0 )
           if( СС_ПФИ_new > 0 )
           if( IsBUY(FD.Group) )
              DebCat  = AccDebet;
           else
              DebCat  = "Реализация, ц/б";
        end;
           CredCat = "+ПФИ";
        else
           DebCat  = "-ПФИ";
           if( IsBUY(FD.Group) )
                 CredCat = AccDebet;
           else
              CredCat  = "Реализация, ц/б";
              end;
           end;

           Ground = "ПФИ(). Списание справедливой стоимости по сделке N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + ". К/агент: " + UserGetPartyShortName(FD.tick.rec.partyid);

           if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                              DebCat,CredCat,
                                                 dat,                      /* Дата */
                                              1,                            /* Глава */
                                              NATCUR,                /* Валюта */
                                                 abs(СС_ПФИ_new),                         /* Сумма */
                                                 INPCARRY,                 /* Result_Carry */
                                                 " 1",                     /* Kind_Oper */
                                              "",                           /* Numb_Document */
                                              Ground/*"Прекращение признания производного финансового инструмента"*/
                                               )
             )
              return 1;
           end;
        end;
     end;
  end;

  return 0;
END;

PRIVATE MACRO БУ_ПроводкаСписанияРезерва( CodePC:string, RolePC:integer, FD:OBJECT, Dat:DATE, ReservAcc:VARIANT, ReservFIRole:INTEGER, Reserv:MONEY, Ground:STRING ):BOOL

   if( Reserv != 0 )
      if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            ReservAcc, CodePC, /* Деб, КатегКредит */
                                            Dat,                     /* Дата */
                                            1,                       /* Глава */
                                            NATCUR,                  /* Валюта */
                                            ABS(Reserv),             /* Сумма */
                                            INPCARRY,                /* Result_Carry */
                                            " 1",                    /* Kind_Oper */
                                            FD.tick.rec.DealCode,    /* Numb_Document */
                                            Ground,                  /* Ground */
                                            null,
                                            ReservFIRole, RolePC
                                          )
        )
          return false;      
      end;
   end;

   return true;
END;

PRIVATE VAR ReservAcc = TRecHandler( "account" );  /*счет резерва*/
PRIVATE MACRO БУ_СписатьОстатокРезервДоговор( CodePC:string, FD:SPFirstDoc, Dat:DATE, FIRole:INTEGER, Ground:STRING, IsAvance:BOOL ):BOOL
  VAR Reserv, LastDate;

  if( FD.IsExistAccount( "Резерв, договор", null, true, FIRole, ReservAcc, null, Dat ) )
      if( IsBUY(FD.Group) AND IsTwoPart(FD.Group) AND (FIRole == FIROLE_RESERV_ROR) )
         if( (IsAvance) )
            if(FD.ExistAvance())
              Reserv = БУ_ПолучитьПоследнююСумму( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_RESERV_BACKREPO, LastDate );
              if( not БУ_СохранитьСуммуКомиссии( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_RESERV_BACKREPO, Dat, $0, $0, NATCUR ) )
                 return false;
              end; 
            end;
         else
            Reserv = БУ_ПолучитьПоследнююСумму( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DLSUM_KIND_RESERV_BACKREPO, LastDate );
            if( not БУ_СохранитьСуммуКомиссии( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DLSUM_KIND_RESERV_BACKREPO, Dat, $0, $0, NATCUR ) )
               return false;      
            end; 
         end;
      else
         Reserv = ABS(GetRestAccount( ReservAcc.rec, Dat ));
      end;

      if( Reserv != 0 )
         if( БУ_ПроводкаСписанияРезерва("+"+CodePC, FIROLE_BA, FD, Dat, ReservAcc, FIRole, Reserv, Ground + " Сделка " + FD.tick.rec.DealCode) == false )
            return false;
         end;
      end;
  end;

  return true;
END;

PRIVATE MACRO БУ_СписатьОстатокОцРезервДоговор( CodePC:string, FD:SPFirstDoc, Dat:DATE, FIRole:INTEGER, Ground:STRING, IsAvance:BOOL ):BOOL
  VAR Reserv, LastDate;

  if( FD.IsExistAccount( "+КОР_Резерв, договор_проч", null, true, FIRole, ReservAcc, null, Dat ) )
      /*if( IsBUY(FD.Group) AND IsTwoPart(FD.Group) AND (FIRole == FIROLE_RESERV_ROR) )
         if( (IsAvance) )
            if(FD.ExistAvance())
              Reserv = БУ_ПолучитьПоследнююСумму( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_RESERV_BACKREPO, LastDate );
              if( not БУ_СохранитьСуммуКомиссии( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID, DLSUM_KIND_RESERV_BACKREPO, Dat, $0, $0, NATCUR ) )
                 return false;
              end; 
            end;
         else
            Reserv = БУ_ПолучитьПоследнююСумму( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DLSUM_KIND_RESERV_BACKREPO, LastDate );
            if( not БУ_СохранитьСуммуКомиссии( DLDOC_PAYMENT, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID, DLSUM_KIND_RESERV_BACKREPO, Dat, $0, $0, NATCUR ) )
               return false;      
            end; 
         end;
      else*/
         Reserv = ABS(GetRestAccount( ReservAcc.rec, Dat ));
         if(Reserv == 0)
           if( FD.IsExistAccount( "-КОР_Резерв, договор_проч", null, true, FIRole, ReservAcc, null, Dat ) )
             Reserv = ABS(GetRestAccount( ReservAcc.rec, Dat ));
           end;
         end;
      //end;

      if( Reserv != 0 )
         if( БУ_ПроводкаСписанияРезерва( "+"+CodePC, FIROLE_BA, FD, Dat, ReservAcc, FIRole, Reserv, Ground + " Сделка " + FD.tick.rec.DealCode) == false )
            return false;
         end;
      end;
  end;

  return true;
END;

PRIVATE MACRO СписатьОстатокРезерваПоТребованиям( CodePC:string, FD:SPFirstDoc, Dat:DATE, IsAvance:BOOL, FIRole:INTEGER, Ground:STRING ):BOOL

  VAR RQID, LastDate, Reserv, SaveSumma,
      KindReserv = IIF( FIRole == FIROLE_RESERV_RSOP, DLSUM_KIND_RESERV_DELAY, DLSUM_KIND_RESERV_OVERDUE );

  if( FD.BuySale == DEAL_TYPE_SALE )
     /*требования - аванс или оплата*/
     if( IsAvance == true )
       if(FD.ExistAvance())
         RQID = FD.GetRQ(DLRQ_TYPE_AVANCE).rec.ID;
       end
     else
        RQID = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.ID;
     end;
  else
     /*требования - поставка*/
     RQID = FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.ID;
  end;

  if( RQID > 0 ) 
     Reserv = БУ_ПолучитьПоследнююСумму( DLDOC_PAYMENT, RQID, KindReserv, LastDate );

     if( Reserv != 0 )
        if( БУ_ПроводкаСписанияРезерва("+"+CodePC, FIROLE_BA, FD, Dat, "Резерв, договор", FIRole, Reserv, Ground + " Сделка " + FD.tick.rec.DealCode) == false )
           return false;
        end;

        if(Reserv > 0)
           if( БУ_ПроводкаСписанияРезерва("+"+CodePC, FIROLE_BA, FD, Dat, "-КОР_Резерв, договор_проч", FIRole, Reserv, Ground + " Сделка " + FD.tick.rec.DealCode) == false )
              return false;
           end;
        else
           if( БУ_ПроводкаСписанияРезерва("+"+CodePC, FIROLE_BA, FD, Dat, "+КОР_Резерв, договор_проч", FIRole, Reserv, Ground + " Сделка " + FD.tick.rec.DealCode) == false )
              return false;
           end;
        end;

        /*После списания создается нулевая сумма того же вида*/
        if( LastDate == Dat ) /*Сумма сохраняется нарастающим итогом*/
           SaveSumma = -Reserv;
        else
           SaveSumma = $0;
        end;
        if( not БУ_СохранитьСуммуКомиссии( DLDOC_PAYMENT, RQID, KindReserv, Dat, SaveSumma, $0, NATCUR ) )
           return false;      
        end; 
     end;
  end;

  return true;
END;

/*Списание резерва по вложениям в ц/б по продаваемым лотам*/
PRIVATE MACRO БУ_СписаниеРезерваЦБПоПРЕПО2ч_ПоПортфелю( FD:OBJECT, dat:DATE, Portfolio:integer, FIID:integer ):BOOL
  var ReservAmount = $0, LastDate = Date(0,0,0);

  ReservAmount = БУ_ПолучитьПоследнююСумму( DL_SECURITYDOC, FD.tick.rec.DealID, GetDlSumKindResSaleRepo2(Portfolio), LastDate, null, FIID );

  if (LastDate > dat)
     MsgBox("Дата последней суммы резерва по требованиям (РПР) " + string(LastDate) + " для сделки с кодом " + string(FD.tick.rec.DealCode) + " не должна быть больше даты операции " + string(dat));
     return false;
  end;

  if( ReservAmount != $0 )
     if( БУ_ПроводкаСписанияРезерва("+РС, д/с", FIROLE_BA, FD, Dat, "Резерв ц/б", РолиСчРезерваПоТр2чПРЕПО(Portfolio), ReservAmount, "Списание резерва по требованиям по 2 части ПР. Сделка " + FD.tick.rec.DealCode) == false )
        return false;
     end;

     if( not БУ_СохранитьСуммуКомиссии( DL_SECURITYDOC, FD.tick.rec.DealID, GetDlSumKindResSaleRepo2(Portfolio), Dat, $0, $0, NATCUR, FIID ) )
        msgbox( "Ошибка при сохранении суммы резерва по требованиям по 2 части ПР" );      
        return false;
     end; 
  end;

  return true;
END;

PRIVATE MACRO БУ_СписаниеРезерваЦБПоПРЕПО2ч_ПоЦБ( FD:OBJECT, dat:DATE, FIID:integer ):BOOL
  if( not БУ_СписаниеРезерваЦБПоПРЕПО2ч_ПоПортфелю(FD,dat,KINDPORT_TRADE, FIID) )
     return false;
  end;

  if( not БУ_СписаниеРезерваЦБПоПРЕПО2ч_ПоПортфелю(FD,dat,KINDPORT_SALE, FIID) )
     return false;
  end;

  if( not БУ_СписаниеРезерваЦБПоПРЕПО2ч_ПоПортфелю(FD,dat,KINDPORT_RETIRE, FIID) )
     return false;
  end;
  return true;
END;

/*Списание резерва по вложениям в ц/б по продаваемым лотам*/
PRIVATE MACRO БУ_СписаниеРезерваЦБПоПРЕПО2ч( FD:OBJECT, dat:DATE ):BOOL

  if( IsBasket(FD.Group) )
     if( not БУ_СписаниеРезерваЦБПоПРЕПО2ч_ПоЦБ( FD, dat, FD.CurPFI() ) )
     return false;
  end;
  else
     if( not БУ_СписаниеРезерваЦБПоПРЕПО2ч_ПоЦБ( FD, dat ) )
        return false;
     end;
  end;

  return true;
END;

PRIVATE MACRO СписатьРезервПоТребованию( FD:SPFirstDoc, Dat:DATE, IsAvance:BOOL ):BOOL
  /*Резерв по требованиям по сделкам с отсрочкой платежа*/
  if( (FD.ExistBack == false) and (not IsLOAN(FD.Group))) /*в сделках  покупки/продажи*/

     if( СписатьОстатокРезерваПоТребованиям("РС, д/с", FD, Dat, IsAvance, FIROLE_RESERV_RSOP, "Списание резерва по сделкам с отсрочкой платежа.") == false )
        return false;
     end;

     if( IsOUTEXCHANGE(FD.Group) )
        if( СписатьОстатокРезерваПоТребованиям("РС, д/с", FD, Dat, IsAvance, FIROLE_RESERV_RPT, "Списание резерва по просроченным требованиям.") == false )
           return false;
        end;
     end;
  end;

  /*Резерв по условным обязательствам кредитного характера*/
  if( IsBUY(FD.Group) AND IsTwoPart(FD.Group) ) /*списывается в сделках ОР*/
      if( FD.IsBack == false ) /*по первой части*/
         if( БУ_СписатьОстатокРезервДоговор("РС, РУОКХОР", FD, Dat, FIROLE_RESERV_RUOKXOR, "Списание резерва по условным обязательствам кредитного характера.") == false )
            return false;
         end;
      else /*по второй части*/
         if( БУ_СписатьОстатокРезервДоговор("РС,д/с%", FD, Dat, FIROLE_RESERV_ROR, "Списание резерва по требованиям по 2 части ОР.", IsAvance) == false )
            return false;
         end;

         if( БУ_СписатьОстатокРезервДоговор("РС,д/с%", FD, Dat, FIROLE_RESERV_RPOR, "Списание резерва по получению процентных доходов.") == false )
            return false;
         end;

         if( БУ_СписатьОстатокОцРезервДоговор("КОР_РС,д/с%", FD, Dat, FIROLE_OTHPLACEDMONEY, "Списание оценочного резерва по требованиям по 2 части ОР.") == false )
            return false;
         end;

         if( БУ_СписатьОстатокОцРезервДоговор("КОР_РС,д/с%", FD, Dat, FIROLE_RORPOR, "Списание оценочного резерва по получению процентных доходов.") == false )
            return false;
         end;

         if( БУ_СписатьОстатокОцРезервДоговор("КОР_РС,д/с%", FD, Dat, FIROLE_ROZ, "Списание оценочного резерва по неотнесённым на расходы существенным затратам.") == false )
            return false;
         end;

         if( БУ_СписатьОстатокОцРезервДоговор("КОР_РС,д/с%", FD, Dat, FIROLE_ROKOR, "Списание оценочного резерва по корректировкам.") == false )
            return false;
         end;

         if( FD.СделкаОРЦБ() == false )
            if( СписатьОстатокРезерваПоТребованиям("РС,д/с%", FD, Dat, IsAvance, FIROLE_RESERV_RPT, "Списание резерва по просроченным требованиям.") == false )
               return false;
            end;

            if( БУ_СписатьОстатокРезервДоговор("РС,д/с%", FD, Dat, FIROLE_RESERV_RPTP, "Списание резерва по просроченным процентным требованиям.") == false )
               return false;
            end;

            if( СписатьОстатокРезерваПоТребованиям("КОР_РС,д/с%", FD, Dat, IsAvance, FIROLE_RORPT, "Списание оценочного резерва по просроченным требованиям.") == false )
               return false;
            end;

            if( БУ_СписатьОстатокОцРезервДоговор("КОР_РС,д/с%", FD, Dat, FIROLE_RORPTP, "Списание оценочного резерва по просроченным процентным требованиям по сделкам обратного РЕПО.") == false )
               return false;
            end;
         end;
      end;
  end;

  if( IsSALE(FD.Group) AND IsTwoPart(FD.Group) AND (not (IsBasket(FD.Group) and IsOUTEXCHANGE(FD.Group))) ) /*списывается в сделках ПР*/

     if( БУ_СписаниеРезерваЦБПоПРЕПО2ч( FD, Dat ) == false )
        return false;
     end;

     if( БУ_СписатьОстатокРезервДоговор("РС,д/с%", FD, Dat, FIROLE_RESERV_SALEREPO2_PVO, "Списание резерва по требованиям по 2 части ПР.", IsAvance) == false )
        return false;
     end;
  end;

  return true;
END;

/*Списание резерва по вложениям в ц/б по продаваемым лотам*/
MACRO БУ_СписаниеРезерваПоЦБ( FD:OBJECT/*SPFirstDoc*/, dat:DATE, KindPortf:INTEGER, ReservAmountBuy:MONEY, IncomeReservBuy:MONEY, EstReserveBuy:MONEY , SumReservInFR:@MONEY):BOOL
  VAR ReservAcc = TRecHandler( "account" );  /*счет резерва*/
  VAR FIRole = null, FIRolePDD = null;
  VAR CodePC:string, RolePC:integer;
  var ErrCode, OptionValue:bool;
  var CatDeb, CatCred, CatCorr;
  var CheckResSum = $0;
  var SumResFR = $0;
  var IsBond = false;
  var isReserv = true;

  var ground = "";
  GetRegistryValue( "SECUR\\МСФО\\61210 ПРИ ВЫБЫТИИ ДЛЯ РВП И ОР", V_BOOL, OptionValue, ErrCode );
  if ( (ErrCode != 0) )
     OptionValue = false;
  end;

  if( (KindPortf == KINDPORT_SALE) and ( FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind)))  
    OptionValue = false;    // долговая бумага в СССД не должна идти на реализацию    
    IsBond = true;
  end;

  if( (IsSALE(FD.Group) and IsTwoPart(FD.Group)) )  // Для ПРЕПО не смотрим на значение настройки
    OptionValue = false;
  end;

//  if( not (IsBasket(FD.Group) and IsOUTEXCHANGE(FD.Group)) )
        ПолучитьРолиДляСписаниеРезерваПоЦБ(KindPortf,@FIRole,@FIRolePDD,@CodePC,@RolePC, IsBond);
     if( (ReservAmountBuy != 0) OR (IncomeReservBuy != 0) )
        if( (not IsRET_ISSUE(FD.Group)) or (not ((KindPortf == KINDPORT_SSSD) and (not FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind)))) )
           if( БУ_ПроводкаСписанияРезерва( IIF(OptionValue, "Реализация, ц/б", CodePC), RolePC, FD, Dat, "Резерв ц/б", FIRole,
                                         ReservAmountBuy,
                                         " Восстановление резерва по вложениям в ц/б "  + GetFinName(FD.fininstr.rec)  /*PDV 498206*/ 
                                       ) == false
             )
              return false;
           end;
        end;
        if( БУ_ПроводкаСписанияРезерва( IIF(OptionValue, "Реализация, ц/б", "+РС,ц/б"), FIRolePDD, FD, Dat, "Резерв ц/б", FIRolePDD,
                                         IncomeReservBuy,
                                         " Списание резерва по начисленному ПДД ц/б по продаваемым лотам "  + GetFinName(FD.fininstr.rec)  
                                       ) == false
            )
           return false;
        end;
        SumResFR = SumResFR - IIF(OptionValue,  ReservAmountBuy + IncomeReservBuy, 0); 

        if( (KindPortf == KINDPORT_SALE) and (not FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind)) and (not IsRET_ISSUE(FD.Group)) ) /* не долговые, долевые*/
          if(  БУ_ПроводкаСписанияРезерва( "-Кор_Резерв, ЦБ", FIRole, FD, Dat, IIF(OptionValue, "Реализация, ц/б", "-КОР_РС, д/с"), RolePC,
                                           ReservAmountBuy,
                                           " Восстановление резерва по вложениям в ц/б " + GetFinName(FD.fininstr.rec)  
                                         ) == false
            )
             return false;
          end;
          SumResFR = SumResFR + IIF(OptionValue,  ReservAmountBuy , 0); //если сюда зашли, значит на реализацию зачислили и тут же списали 
        end;
  
     end;

       isReserv = true;
     if ( (KindPortf == KINDPORT_PROMISSORY) or (KindPortf == KINDPORT_RETIRE) or (KindPortf == KINDPORT_CONTR) or ( (KindPortf == KINDPORT_SALE) and ( FI_IsAvrKindBond(FD.fininstr.rec.AvoirKind))) )
        
        if(EstReserveBuy != 0)
        CatCorr = IIF (((KindPortf == KINDPORT_PROMISSORY) or (KindPortf == KINDPORT_CONTR)), "КОР_РС, д/с", "КорОР_ЦБ");
//BPV        if( FD.IsExistAccount( "-Кор_Резерв, ЦБ", null, true, null, ReservAcc, null, dat, NATCUR ) )
        if( FD.IsExistAccount( "-Кор_Резерв, ЦБ", null, true, Firole/*null*/, ReservAcc, MC_PAIRACCMODE_MANUAL, dat, NATCUR ) )

           CheckResSum = money(GetRestAccount(ReservAcc.rec, dat) );
           if ( CheckResSum != 0 )
              CatDeb  = "-Кор_Резерв, ЦБ";
              CatCred = IIF(OptionValue == false, "+"+CatCorr, "Реализация, ц/б");
              FIRole = GetFIRoleByPortfolio(KindPortf);
              RolePC = IIF (CatCred == "+КорОР_ЦБ", GetFIRoleByPortfolio(KindPortf), null);
           else
             isReserv = false;
           end;
           Ground = "Списание оценочного резерва по ЦБ " + GetFinName(FD.fininstr.rec) + ", портфель " + KindPortf + "-я категория";

             if( isReserv )
              if( (БУ_ПроводкаСписанияРезерва( CatCred, RolePC, FD, Dat, CatDeb, FIRole,
                                        EstReserveBuy,
                                         Ground/*"Списание оценочного резерва"*/
                                       ) == false
                  ) )
                 return false;
              end;
                SumResFR = SumResFR - ABS(IIF(OptionValue,  EstReserveBuy, 0));   // минус резерв
           end;
        end;
  
          isReserv = true;
        CheckResSum = 0;
//BPV        if( FD.IsExistAccount( "+Кор_Резерв, ЦБ", null, true, null, ReservAcc, null, dat, NATCUR ) )
        if( FD.IsExistAccount( "+Кор_Резерв, ЦБ", null, true, Firole/*null*/, ReservAcc, MC_PAIRACCMODE_MANUAL, dat, NATCUR ) )

           CheckResSum = money(GetRestAccount(ReservAcc.rec, dat) );
           if (CheckResSum != 0)
              CatCred  = "+Кор_Резерв, ЦБ";
              CatDeb = IIF(OptionValue == false, "-"+CatCorr, "Реализация, ц/б");
              RolePC = GetFIRoleByPortfolio(KindPortf);
                FIRole = IIF (CatDeb == "-КорОР_ЦБ", GetFIRoleByPortfolio(KindPortf), null);
           else
             isReserv = false;
           end;

             if( isReserv )
           Ground = "Списание оценочного резерва по ЦБ " + GetFinName(FD.fininstr.rec) + ", портфель " + KindPortf + "-я категория";
              if( (БУ_ПроводкаСписанияРезерва( CatCred, RolePC, FD, Dat, CatDeb, FIRole,
                                        EstReserveBuy,
                                         Ground/*"Списание оценочного резерва"*/
                                       ) == false
                  ))
                 return false;
              end;
                SumResFR = SumResFR + ABS(IIF(OptionValue,  EstReserveBuy, 0));     // плюс резерв
           end;
         end;    
       end;
     end;
  //end;
  if( SumReservInFR != NULL )
     SumReservInFR = SumResFR;
  end;
  return true;
END;

/*Списать резерв по сделке*/
MACRO БУ_СписатьРезерв( FD:SPFirstDoc, Dat:DATE, IsAvance:BOOL ):BOOL
   /*Списание резерва при исполнении требований*/
   if( СписатьРезервПоТребованию( FD, Dat, IsAvance ) == false )
      return false;
   end;
   return true;
END;

/*получить очередную роль из массива*/
PRIVATE MACRO GetNextFIRoleFromArray( FIRoles, i, loop, make_car, _FIRole )

   if( (FIRoles != null) AND (ValType( FIRoles ) == V_GENOBJ) ) /*массив ролей*/  

      if(FIRoles[i] != null)            
        loop     = true;                    
        make_car = true;
        _FIRole  = FIRoles[i];
      else
        loop     = false;                    
        make_car = false;
        _FIRole  = null;
      end;
      i = i + 1;    

   else
      loop       = false; /*перебор не нужен, только одна роль задана*/
      make_car   = true;
      _FIRole    = FIRoles;
   end;
   setparm( 1, i        );
   setparm( 2, loop     );
   setparm( 3, make_car );
   setparm( 4, _FIRole  );
END;

MACRO БУ_УчетПредварительныхЗатрат( FD, dat, _CarrySum_PreOutlay, _PreOutlayFIID:INTEGER, _CatDebetACC:STRING, _DebetACCFIID:INTEGER, _Ground:STRING )
   var AccPreOutlay = TRecHandler( "account" );
   var CarrySum_PreOutlay = $0, StrGround = NULL, PreOutlayFIID, CatDebetACC, DebetACCFIID, DebFiRole = null;

   if( _CarrySum_PreOutlay != null )
      CarrySum_PreOutlay   = _CarrySum_PreOutlay;
      //if( _Ground == NULL )
         //(!!!) закомментировано по 140614
        //StrGround = "Учет изменения предварительных затрат";      
      //end;
   else
      CarrySum_PreOutlay   = FD.tick.rec.PreOutlay;
      //if( _Ground == NULL )
         //(!!!) закомментировано по 140614
         //StrGround = "Учет предварительных затрат";
      //end;
   end;

   if( _Ground == NULL)
      StrGround = "Учет предварительных затрат";
   end;      

   if( IsClientDeal(FD.tick.rec) OR (CarrySum_PreOutlay == $0)/* OR ((FD.ТипПортфеля() == KINDPORT_TRADE) and (not IsBUY(FD.Group)))*/ )
      return true;
   end;

   if( _Ground != NULL )
      StrGround = _Ground;
   end;

   if( _PreOutlayFIID == NULL )
      PreOutlayFIID = NATCUR;
   else
      PreOutlayFIID = _PreOutlayFIID;
   end;

   if( _CatDebetACC == NULL )
      if( FD.ТипПортфеля() == KINDPORT_CONTR )
         CatDebetACC = "Наш портфель ПКУ, ц/б";
      elif( FD.ТипПортфеля() == KINDPORT_TRADE )
         CatDebetACC = "-КВ, затраты, ц/б";
      else
         CatDebetACC = "Наш портфель ц/б";
      end;
      DebFiRole = GetFIRoleByPortfolio(FD.pmwrtsum.rec.GroupID);
   else
      CatDebetACC = _CatDebetACC;
   end;

   if( _DebetACCFIID == NULL )
      if( (FD.ТипПортфеля() == KINDPORT_CONTR) or (FD.ТипПортфеля() == KINDPORT_TRADE) )
         DebetACCFIID = NATCUR;
      else
        DebetACCFIID = FD.GetAccFIID(CatDebetACC);
      end;
   else
      DebetACCFIID = _DebetACCFIID;
   end;

   var convPreOutlaySum = CarrySum_PreOutlay;
   ConvSumCross( convPreOutlaySum, CarrySum_PreOutlay, dat, PreOutlayFIID, DebetACCFIID );
   /*если есть счет и его остаток не 0, то надо учитывать*/
   /*if( FD.IsExistAccount( "Предв.затраты, ц/б", null, true, null, AccPreOutlay, null, dat, PreOutlayFIID ) AND
       (GetRestAccount( AccPreOutlay.rec, dat ) != 0) )*/
      
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           CatDebetACC, "Предв.затраты, ц/б", /* КатегДеб , КатегКредит*/
                                           dat,                   /* Дата */
                                           1 ,                    /* Глава */
                                           DebetACCFIID,          /* Валюта */
                                           convPreOutlaySum,      /* Сумма предварительных затрат */
                                           INPCARRY,              /* Result_Carry */
                                           " 1",                  /* Kind_Oper */
                                           FD.tick.rec.DealCode,  /* Numb_Document */
                                           StrGround, /* Ground */
                                           NULL, DebFiRole, NULL, 
                                           DebetACCFIID, NATCUR
                                         )
        )
          return false;
      end;
   //end;

   return true;
END;

macro ПолучитьТОПоСтрокеГрафика( GrDealID:integer, RqType:integer/*сейчас не используется*/, DlRq:TRecHandler ):integer
  var query, cmd, DataSet;

  query = " select rq.* " +
          "   from ddlrq_dbt rq " +
          "  where rq.t_ID = Rsb_Secur.SC_GetRQByGrDeal(?) ";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(GrDealID);

  DataSet = cmd.Execute();
  if( DataSet.moveNext() )
     DataSet.GetRecord().CopyTo( DlRq.rec );
  else
     return 1;
  end;

  return 0;
end;

private macro GetPortfolioSumByRQ(FD,
                                  RQID:integer,
                                  LotStatus:integer,
                                  IsCompensWrt:bool,
                                  DiscountIncomeTP:@variant,
                                  InterestIncomeTP:@variant,
                                  DiscountIncomePPR:@variant,
                                  InterestIncomePPR:@variant,
                                  DiscountIncomePUDP:@variant,
                                  InterestIncomePUDP:@variant
                                 )
  var RSD, SQLQuery;

  SQLQuery = DL_RSDCommand(  " select v.t_Portfolio, v.t_DiscountIncome, v.t_InterestIncome, v.t_BegBonus, v.t_Bonus, v.t_OldBonus"
                           + "   from v_scwrthistex v "
                           + "  where v.t_DocKind       = " + DLDOC_PAYMENT
                           + "    and v.t_DocID         = ? "
                           + "    and v.t_FIID          = ? "
                           + "    and v.t_Department    = ? "
                           + "    and v.t_State         = ? " 
                           + "    and v.t_ID_Operation  = ? "
                           + "    and v.t_ID_Step       = -1 "
                           + IIF(IsCompensWrt," and V.T_ACTION = ? ", " and V.T_ACTION != ?")
                           + "    and v.t_Instance      = ( select nvl(min(v2.t_Instance),0) " 
                           + "                                from v_scwrthistex v2 " 
                           + "                               where v2.t_SumID        = v.t_SumID " 
                           + "                                 and v2.t_State        = v.t_State " 
                           + "                                 and v2.t_ID_Operation = v.t_ID_Operation " 
                           + "                                 and v2.t_ID_Step      = v.t_ID_Step ) "
                          );

  SQLQuery.addParam( RQID );
  SQLQuery.addParam( FD.CurPFI() );
  SQLQuery.addParam( FD.tick.rec.Department );
  SQLQuery.addParam( LotStatus );
  SQLQuery.addParam( ПроводкиБУ.GetServDocID() );
  SQLQuery.addParam( PM_WRTSUM_UPDTMODE_CDELIVERY );

  RSD = SQLQuery.Execute();
  while( RSD.MoveNext() )
     if( RSD.rec.Portfolio == KINDPORT_TRADE )
        DiscountIncomeTP = DiscountIncomeTP + RSD.rec.DiscountIncome;
        InterestIncomeTP = InterestIncomeTP + RSD.rec.InterestIncome;
     elif( RSD.rec.Portfolio == KINDPORT_SALE )
        DiscountIncomePPR = DiscountIncomePPR + RSD.rec.DiscountIncome;
        InterestIncomePPR = InterestIncomePPR + RSD.rec.InterestIncome;
     elif( RSD.rec.Portfolio == KINDPORT_RETIRE )
        DiscountIncomePUDP = DiscountIncomePUDP + RSD.rec.DiscountIncome;
        InterestIncomePUDP = InterestIncomePUDP + RSD.rec.InterestIncome;
     end;
  end;

end;

macro БУ_ВыполнитьПроводкиПереводаНачисленногоДоходаВПрямомРЕПО( FD, dat:date, IsCompensWrt:BOOL, GrDealID:integer ):bool
   var Bpp1 = false, Bpp2 = false, /* признак - с какой стороны БПП */
       DiscountIncomeTP = $0,  InterestIncomeTP   = $0,
       DiscountIncomePPR = $0, InterestIncomePPR  = $0,
       DiscountIncomePUDP = $0,InterestIncomePUDP = $0;
   var RSD, SQLQuery, v_ActionPrev:integer = 0;
   var dlrq = TRecHandler("dlrq.dbt");
   Var  Ground = "";
   if (FD.IsBack AND (IsSALE(FD.Group)))
      Bpp2 = true;
   else
      Bpp1 = true;
   end;

   if(FD.ExistsRQ(DLRQ_TYPE_DELIVERY, 2, FD.CurPFI()))
     var LotStatus,
         rq_1 = NULL,
         rq_2 = FD.GetRQ(DLRQ_TYPE_DELIVERY, 2, FD.CurPFI() );

     if((not IsBasket(FD.Group)) OR (IsBasket(FD.Group) AND FD.ExistsRQ(DLRQ_TYPE_DELIVERY, 1, FD.CurPFI())))
       rq_1 = FD.GetRQ(DLRQ_TYPE_DELIVERY, 1, FD.CurPFI() );
     end;

     if( (rq_1 != NULL) and (rq_1.rec.FactDate == rq_2.rec.FactDate) ) // внутридневное РЕПО
        LotStatus = PM_WRTSUM_FORM;
     else
        LotStatus = IIF(FD.IsBack, PM_WRTSUM_FORM, PM_WRTSUM_SALE_BPP);
     end;
     
     GetPortfolioSumByRQ(FD, rq_2.rec.ID, LotStatus, IsCompensWrt, @DiscountIncomeTP, @InterestIncomeTP, @DiscountIncomePPR, @InterestIncomePPR, @DiscountIncomePUDP, @InterestIncomePUDP);
   end;

   if(IsCompensWrt)
     
     //получить ТО текущей комппоставки
     if(ПолучитьТОПоСтрокеГрафика(GrDealID, NULL, dlrq) == 0)
       GetPortfolioSumByRQ(FD, dlrq.rec.ID, IIF(FD.IsBack, PM_WRTSUM_FORM, PM_WRTSUM_SALE_BPP), IsCompensWrt, @DiscountIncomeTP, @InterestIncomeTP, @DiscountIncomePPR, @InterestIncomePPR, @DiscountIncomePUDP, @InterestIncomePUDP);
     end;
   end;

   if( DiscountIncomeTP > 0 )
     If(not Bpp2)
         If(IsBasket(FD.group))
            Ground = "Перенос начисленного дисконта по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного дисконта по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         else
            Ground = "Перенос начисленного дисконта по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного дисконта по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         end;
     else
         If(IsBasket(FD.group))
            Ground = "Перенос начисленного дисконта по ЦБ проданным без прек. признания по второй части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для начисленного дисконта по " + GetFinName(FD.fininstr.rec);
         else
            Ground = "Перенос начисленного дисконта по ЦБ проданным без прек. признания по второй части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для начисленного дисконта по " + GetFinName(FD.fininstr.rec);
         end;
     end;
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             DiscountIncomeTP,            /* Сумма  */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             Ground/*"Перенос дисконтного дохода ССПУ_ЦБ"*/,
             null,
             GetFIRoleByPortfolio( KINDPORT_TRADE, true, false, Bpp1 ),
             GetFIRoleByPortfolio( KINDPORT_TRADE, true, false, Bpp2 )
            ) 
        )
          return false;
      end;
   end;

   if( InterestIncomeTP > 0 )

      If(not Bpp2)
         If(IsBasket(FD.group))
            Ground = "Перенос начисленного купона по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного купона по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         else
            Ground = "Перенос начисленного купона по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного купона по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         end;
      else
         If(IsBasket(FD.group))
            Ground = "Перенос ПКД со счета вложений для ПКД для проданных без прек. признания по второй части сделки прямого РЕПО с корзиной №" + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для ПКД по " + GetFinName(FD.fininstr.rec);
         else
            Ground = "Перенос ПКД со счета вложений для ПКД для проданных без прек. признания по второй части сделки прямого РЕПО №" + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для ПКД по " + GetFinName(FD.fininstr.rec);
         end;
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             InterestIncomeTP,            /* Сумма  */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             Ground/*"Перенос процентного дохода ССПУ_ЦБ"*/,
             null,
             GetFIRoleByPortfolio( KINDPORT_TRADE, false, true, Bpp1 ),
             GetFIRoleByPortfolio( KINDPORT_TRADE, false, true, Bpp2 )
            ) 
        )
          return false;
      end;
   end;

   if( DiscountIncomePPR > 0 )
      If(not Bpp2)
         If(IsBasket(FD.group))
            Ground = "Перенос начисленного дисконта по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного дисконта по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         else
            Ground = "Перенос начисленного дисконта по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного дисконта по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         end;
      else
         If(IsBasket(FD.group))
            Ground = "Перенос начисленного дисконта по ЦБ проданным без прек. признания по второй части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для начисленного дисконта по " + GetFinName(FD.fininstr.rec);
         else
            Ground = "Перенос начисленного дисконта по ЦБ проданным без прек. признания по второй части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для начисленного дисконта по " + GetFinName(FD.fininstr.rec);
         end;
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             DiscountIncomePPR,           /* Сумма  */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             Ground/*"Перенос дисконтного дохода СССД_ЦБ"*/,
             null,
             GetFIRoleByPortfolio( KINDPORT_SALE, true, false, Bpp1 ),
             GetFIRoleByPortfolio( KINDPORT_SALE, true, false, Bpp2 )
            ) 
        )
          return false;
      end;
   end;

   if( InterestIncomePPR > 0 )
      If(not Bpp2)
         If(IsBasket(FD.group))
            Ground = "Перенос начисленного купона по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного купона по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО с корзиной № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         else
            Ground = "Перенос начисленного купона по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного купона по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
         end;
      else
         If(IsBasket(FD.group))
            Ground = "Перенос ПКД со счета вложений для ПКД для проданных без прек. признания по второй части сделки прямого РЕПО с корзиной №" + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для ПКД по " + GetFinName(FD.fininstr.rec);
         else
            Ground = "Перенос ПКД со счета вложений для ПКД для проданных без прек. признания по второй части сделки прямого РЕПО №" + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для ПКД по " + GetFinName(FD.fininstr.rec);
         end;
      end;
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             InterestIncomePPR,           /* Сумма  */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             Ground/*"Перенос процентного дохода СССД_ЦБ"*/,
             null,
             GetFIRoleByPortfolio( KINDPORT_SALE, false, true, Bpp1 ),
             GetFIRoleByPortfolio( KINDPORT_SALE, false, true, Bpp2 )
            ) 
        )
          return false;
      end;
   end;

   if( DiscountIncomePUDP > 0 )
      If(not Bpp2)
         Ground = "Перенос начисленного дисконта по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного дисконта по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
      else
         Ground = "Перенос начисленного дисконта по ЦБ проданным без прек. признания по второй части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для начисленного дисконта по " + GetFinName(FD.fininstr.rec);
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             DiscountIncomePUDP,           /* Сумма  */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             Ground/*"Перенос дисконтного дохода АС_ЦБ"*/,
             null,
             GetFIRoleByPortfolio( KINDPORT_RETIRE, true, false, Bpp1 ),
             GetFIRoleByPortfolio( KINDPORT_RETIRE, true, false, Bpp2 )
            ) 
        )
          return false;
      end;
   end;

   if( InterestIncomePUDP > 0 )
      If(not Bpp2)
         Ground = "Перенос начисленного купона по " + GetFinName(FD.fininstr.rec) + " на счет вложений для начисленного купона по ЦБ проданным без прек. признания по первой части сделки прямого РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
      else
         Ground = "Перенос ПКД со счета вложений для ПКД для проданных без прек. признания по второй части сделки прямого РЕПО №" + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " на счет вложений для ПКД по " + GetFinName(FD.fininstr.rec);
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
             "Начисл.ПДД, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
             dat,                         /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             InterestIncomePUDP,           /* Сумма  */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             Ground/*"Перенос процентного дохода АС_ЦБ"*/,
             null,
             GetFIRoleByPortfolio( KINDPORT_RETIRE, false, true, Bpp1 ),
             GetFIRoleByPortfolio( KINDPORT_RETIRE, false, true, Bpp2 )
            ) 
        )
          return false;
      end;
   end;

   return true;
end;

private macro СкорректироватьСуммуДляПросрочки(FD, dat);
  var correct_sum = 0.0, str_err = "";
  if( IsTwoPart(FD.Group) and IsSALE(FD.Group) and FD.IsBack
      and (FD.dl_leg.rec.IncomeRate < 0.0) and (ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_PAYMENT))) )
    correct_sum = ПолучитьУчтеннуюСуммуПроцентовПоРЕПО(FD, dat, DLSUM_KIND_SUM_TO_PERCENT, str_err);
    if (str_err != "")
       msgbox(str_err);
    end;
  end;
  return correct_sum;
end;

macro НеФормироватьПроводкиПоТО(DlRq:TRecHandler)
  var НеФормироватьПроводкиПоТО = false;
  
/*ak - w487: не смотрим на интегрированный режим
  if((ИнтегрированныйРежим()) and*/
  if(
/*~ak*/
     (DlRq.rec.Kind == DLRQ_KIND_COMMIT) and
     (DlRq.rec.SubKind == DLRQ_SUBKIND_CURRENCY) and
     (DlRq.rec.State == DLRQ_STATE_EXEC) and
     (DlRq.rec.RqAccID > 0)               
    )

    var rqacc = TRecHandler("dlrqacc.dbt");
    ПолучитПлатежныеРеквизитыПоТО(DlRq, rqacc);

/*ak - w487: по внешним платежам формируем проводки
    if((rqacc.rec.BankID > 0) and (rqacc.rec.BankID > {OurBank}))
      НеФормироватьПроводкиПоТО = true;
    end;
~ak*/
  end;

  return НеФормироватьПроводкиПоТО;
end;

/* обработать любое денежное ТО */
/* FD может быть и не по сделке !!!*/
MACRO БУ_ОбработатьДенежноеТО( DlRq, DebetAccount, CreditAccount, FD, dat, StrGround, _IsDelimNKD, _IsUNITrnREPO2Cl, _NeedNUTX, _IsUNITrnREPO2_Own )

  var chapter:integer = 1, Amount = $0, AmountDec = $0, NKDAmount = $0, AmountRur = $0, NKDAmountRur = $0, IsDelimNKD = false, IsUNITrnREPO2Cl = false, NeedNUTX = false, IsUNITrnREPO2_Own = false, ConvertDate = dat;
  var ConvertNkdDate = FD.DateArray[DATE_DEALDATE];  // DEF-104821
  var amountDiff = $0;
  var PayFIID = -1;
  var AmountRurNote = $0;
  var Code, DlDate, CarryGround;
  var NoteNRDAmount = $0, NoteNRDAmountSum = $0;
  var DecisionDate = date(0,0,0), // Дата принятия решения по невозмещаемым активам 
      NonRefundActive = false;    // Невозмещаемый актив CCBO-8438
  var UseAmountRur = false;
  
  DecisionDate = readNoteForObject( OBJTYPE_AVOIRISS, L_Z( Int(FD.fininstr.rec.FIID), 10 ), 108 );
  if ((ValType(DecisionDate) == V_DATE) and (DecisionDate != date(0,0,0)))
     NonRefundActive = true;
  end;
  
  var EuroClearAcc;
  var EuroClearAccBuf = TRecHandler("account");
  EuroClearAccBuf.Clear();

  if( _IsDelimNKD != null )/*НКД отдельной проводкой*/
     IsDelimNKD = _IsDelimNKD;
  end;                                                     
  if( _IsUNITrnREPO2Cl != null )/*Единая проводка по 2 части кл РЕПО*/
     IsUNITrnREPO2Cl = _IsUNITrnREPO2Cl;
  end;

  if( _NeedNUTX != null )/*Удержать налог с ЮН*/
     NeedNUTX = _NeedNUTX;
  end;

  if( _IsUNITrnREPO2_Own != null )/*Единый платеж по 2 части соб. РЕПО*/
     IsUNITrnREPO2_Own = _IsUNITrnREPO2_Own;
  end;


  if( (DlRq.rec.State != DLRQ_STATE_REJECT) and (DlRq.rec.Netting == UNSET_CHAR) and (not ТОСквитовано(DlRq)) ) /*если платеж не отказан */

     if(НеФормироватьПроводкиПоТО(DlRq) == false)
       PayFIID = FD.GetPayFIID();
       if((DebetAccount.rec.Code_Currency == CreditAccount.rec.Code_Currency) and (DebetAccount.rec.Code_Currency != PayFIID))
         PayFIID = DebetAccount.rec.Code_Currency;
       end;
       
       var TaxMain = $0, TaxMain0 = $0, _TaxMain = $0, _TaxMainRur = $0;
       var TaxNKD = $0, TaxNKD0 = $0, _TaxNKD = 0, _TaxNKDRur = 0;

       if((NeedNUTX == true) and (FD.tick.rec.ClientID > 0) )
         if(dlrq.rec.Type == DLRQ_TYPE_PAYMREPOCOUP)
           NUTX_GetClientDealTaxCoup(FD.tick.rec.DealID, FD.tick.rec.ClientID, dat, @TaxMain, @TaxMain0);
         elif(dlrq.rec.Type == DLRQ_TYPE_INCREPO)
           NUTX_GetClientDealDueTax(FD.tick.rec.DealID, FD.tick.rec.ClientID, @TaxMain, @TaxMain0);
         else
           NUTX_GetClientDealTax(FD.tick.rec.DealID, FD.tick.rec.ClientID, string(NUTAXGROUP_40+","+NUTAXGROUP_50), @TaxMain, @TaxMain0);
           NUTX_GetClientDealTax(FD.tick.rec.DealID, FD.tick.rec.ClientID, string(NUTAXGROUP_15+","+NUTAXGROUP_20), @TaxNKD,  @TaxNKD0);
         end;
       end;

       
       if (IsRET_COUPON(FD.Group) and NonRefundActive and (PayFIID == NATCUR))
          ConvertDate = dat-1;
       end;

       SmartConvertSum(Amount, DlRq.rec.Amount, ConvertDate,  DlRq.rec.FIID, PayFIID, false);
       
       if (NonRefundActive OR (IsRET_ISSUE(FD.Group) OR IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group)))
         AmountRurNote = readNoteForObject( OBJTYPE_RETIRE, L_Z( Int(FD.tick.rec.DealID), 34 ), 102 );
         if ((ValType(AmountRurNote) == V_MONEY))
           AmountRur = AmountRurNote;
           if((AmountRur != 0) AND (IsRET_ISSUE(FD.Group) OR IsRET_COUPON(FD.Group) OR IsRET_PARTLY(FD.Group)))
             UseAmountRur = true;
           end;
         else
           SmartConvertSum(AmountRur, DlRq.rec.Amount, ConvertDate,  DlRq.rec.FIID, NATCUR, false);
         end;
         SmartConvertSum(AmountDec, DlRq.rec.Amount, IIF(UseAmountRur AND (not NonRefundActive), ConvertDate, DecisionDate),  DlRq.rec.FIID, NATCUR, false);
       end;

       if( IsBasket(FD.Group) )
          NKDAmount = FD.NKD_ALL(dat,PayFIID);
       elif(FD.dl_leg != null)
          NKDAmount = FD.dl_leg.rec.NKD;
       end;

       if((PayFIID == NATCUR) AND (not UseAmountRur))
          Amount = Amount - TaxMain0;
       elif(TaxMain > 0)
          if (NonRefundActive OR UseAmountRur)
             SmartConvertSum(_TaxMainRur, TaxMain, ConvertDate, FD.GetPayFIID(), NATCUR, false);
             AmountRur = AmountRur - _TaxMainRur;
             SmartConvertSum(_TaxMainRur, TaxMain, IIF(UseAmountRur AND (not NonRefundActive), ConvertDate, DecisionDate), FD.GetPayFIID(), NATCUR, false);
             AmountDec = AmountDec - _TaxMainRur;
          end;
          SmartConvertSum(_TaxMain, TaxMain, ConvertDate, FD.GetPayFIID(), FD.NKDFIID(), false);
          Amount = Amount - _TaxMain;
       end;

       if( IsDelimNKD)
         if(NKDAmount > 0.)
           if( IsBasket(FD.Group) )
              Amount = Amount - NKDAmount;
           else
              if (NonRefundActive OR UseAmountRur)
                 SmartConvertSum(NKDAmountRur, NKDAmount, ConvertNkdDate, FD.NKDFIID(), NATCUR, false); // DEF-104821
                 AmountRur = AmountRur - NKDAmountRur;
                 SmartConvertSum(NKDAmountRur, NKDAmount, IIF(UseAmountRur AND (not NonRefundActive), ConvertNkdDate, DecisionDate), FD.NKDFIID(), NATCUR, false);
                 AmountDec = AmountDec - NKDAmountRur;
              end;
              SmartConvertSum(NKDAmount, NKDAmount, ConvertNkdDate, FD.NKDFIID(), PayFIID, false); // DEF-104821
              Amount = Amount - NKDAmount;
           end;

           if(TaxNKD > 0)
             if (NonRefundActive)
                SmartConvertSum(_TaxNKDRur, TaxNKD, ConvertNkdDate, FD.GetPayFIID(), NATCUR, false); // DEF-104821
                NKDAmountRur = NKDAmountRur - _TaxNKDRur; 
             end;
             SmartConvertSum(_TaxNKD, TaxNKD, ConvertNkdDate, FD.GetPayFIID(), FD.NKDFIID(), false); // DEF-104821
             NKDAmount = NKDAmount - _TaxNKD; 
           end;
         end;
       else
         if((PayFIID == NATCUR) AND (not UseAmountRur))
           Amount = Amount - TaxNKD0;
         elif(TaxNKD > 0)
           if (NonRefundActive OR UseAmountRur)
              SmartConvertSum(_TaxNKDRur, TaxNKD, ConvertDate, FD.GetPayFIID(), NATCUR, false);
              AmountRur = AmountRur - _TaxNKDRur;
              SmartConvertSum(_TaxNKDRur, TaxNKD, IIF(UseAmountRur AND (not NonRefundActive), ConvertDate, DecisionDate), FD.GetPayFIID(), NATCUR, false);
              AmountDec = AmountDec - _TaxNKDRur;
           end;
           SmartConvertSum(_TaxNKD, TaxNKD, ConvertDate, FD.GetPayFIID(), PayFIID, false);
           Amount = Amount - _TaxNKD;
         end;
       end;

       if( IsUNITrnREPO2Cl )
          if(FD.dl_leg.rec.IncomeRate > 0.0)
             Amount = Amount + FD.dl_leg.rec.ReturnIncome;
          else
             Amount = Amount - FD.dl_leg.rec.ReturnIncome;
          end;
       end;
       if( (IsUNITrnREPO2_Own) and (FD.IsBack()) and (FD.ExistPC()) and (IsUnitREPO2_Own(FD.GetRQ(DLRQ_TYPE_INCREPO), FD)) )
         var Начисленные_проценты = $0;
         Начисленные_проценты = FD.GetRQPayAmount(DLRQ_TYPE_INCREPO, dat);
         Amount = Amount - Начисленные_проценты;
       end;

       var Sод_rest = СкорректироватьСуммуДляПросрочки(FD, dat);

       /*ak - w487: сохраним число проводок*/
       var acctrnind;
       if(FD.tick != NULL)
         acctrnind = ПроводкиБУ.GetAccountingTrnBatchSize();
       end;
       /*~ak*/

       /*KD*/
        NoteNRDAmount = 0;
        NoteNRDAmountSum = 0;
        if(FD.tick != NULL)
           if(FD.tick.rec.bofficekind == 117)
              NoteNRDAmount = ReadNoteForObject(FD.tick.rec.bofficekind, UniID(FD.Tick, FD.tick.rec.bofficekind), 101, dat);
              If(NoteNRDAmount != 0)
                 NoteNRDAmountSum = round(amount/fd.dl_leg.rec.principal * NoteNRDAmount, 2);
                 EuroClearAcc = ПолучитьКоррсчетПоКоррсхеме(FD.tick.rec.bofficekind, FD.tick.rec.dealid, PayFIID, 72832 );

                 if ((EuroClearAcc == "") or (GetAccount( 1, PayFIID, EuroClearAcc, EuroClearAccBuf, false ) == 0))
                    NoteNRDAmount = 0;
                    NoteNRDAmountSum = 0;
                 else
                    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                         EuroClearAccBuf, CreditAccount, /* КатегДеб , КатегКредит*/
                                                         dat,                  /* Дата */
                                                         chapter,              /* Глава */
                                                         PayFIID,              /* Валюта */
                                                         NoteNRDAmountSum,    /* Сумма  */
                                                         INPCARRY,             /* Result_Carry */
                                                         " 1",                 /* Kind_Oper */
                                                         "",                   /* Numb_Document */
                                                         StrGround, null,null,null,
                                                         DebetAccount.rec.Code_Currency, CreditAccount.rec.Code_Currency     /* валюты счетов: Дт - Кт */ 
                                                       )
                    )
                        return 1;
                    end;

                 end;
              end;
           end;
        end;

       /*End KD*/
       var SumPayment = Amount - Sод_rest - NoteNRDAmountSum;
       if((FD.GetPayFIID() != FD.FaceFIID()) and (CreditAccount == "+РасчетыПогаш") and (IsRET_COUPON(FD.Group)))
         var Note102RetSum = readNoteForObject( OBJTYPE_RETIRE, L_Z( Int(FD.tick.rec.DealID), 34 ), 102 );
         if ((ValType(Note102RetSum) == V_MONEY) and (Note102RetSum != 0))
           SumPayment = Note102RetSum;
         else
           SmartConvertSum (SumPayment,  Money(SumPayment), dat, FD.FaceFIID(), FD.GetPayFIID(), true);
         end;
       end;

       /*делаем проводку на сумму платежа*/ 
       if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            DebetAccount, CreditAccount, /* КатегДеб , КатегКредит*/
                                            dat,                  /* Дата */
                                            chapter,              /* Глава */
                                            PayFIID,              /* Валюта */
                                            IIF((IsRET_COUPON(FD.Group)) and (PayFIID == NATCUR) and (NonRefundActive OR UseAmountRur), AmountRur, SumPayment),  /* Сумма  */
                                            INPCARRY,             /* Result_Carry */
                                            " 1",                 /* Kind_Oper */
                                            "",                   /* Numb_Document */
                                            StrGround, null,null,null,
                                            DebetAccount.rec.Code_Currency, CreditAccount.rec.Code_Currency,     /* валюты счетов: Дт - Кт */ 
                                            IIF(((IsRET_COUPON(FD.Group)) and (PayFIID != NATCUR) and (NonRefundActive OR UseAmountRur)), NATCUR, IIF(((CreditAccount.rec.Code_Currency != NATCUR) AND (PayFIID == NATCUR) AND UseAmountRur), CreditAccount.rec.Code_Currency, null)),
                                            IIF(((IsRET_COUPON(FD.Group)) and (PayFIID != NATCUR) and (NonRefundActive OR UseAmountRur)), AmountRur, IIF(((CreditAccount.rec.Code_Currency != NATCUR) AND (PayFIID == NATCUR) AND UseAmountRur), DlRq.rec.Amount, null))
                                          )
       )
           return 1;
       end;
       
       if (NonRefundActive)
          AmountDiff = AmountRur - AmountDec;
       end;
       	   
       if (IsRET_COUPON(FD.Group) and NonRefundActive)
          if (AmountDiff < 0)
             if (not БУ_ПроводкаПоКатегориямУчета(FD,                                                                                              
                                                "-ПереоценкаА", CreditAccount, /* КатегДеб , КатегКредит*/                                         
                                                dat,                  /* Дата */                                                                 
                                                chapter,              /* Глава */                                                                
                                                NATCUR,              /* Валюта */                                                               
                                                abs(AmountDiff),            /* Сумма  */                                            
                                                INPCARRY,             /* Result_Carry */                                                         
                                                " 1",                 /* Kind_Oper */                                                            
                                                "",                   /* Numb_Document */                                                        
                                                "Расходы от переоценки средств, поступивших от погашения купона по ЦБ " + FD.avoiriss.rec.ISIN + " " + GetFinName(FD.fininstr.rec) + " (заблокированный актив по указанию ЦБ РФ 6379-У)", 
                                                null, null, null,                                                                       
                                                0, CreditAccount.rec.Code_Currency     /* валюты счетов: Дт - Кт */
                                                ))
                 return 1;
             end;
          else
             if (not БУ_ПроводкаПоКатегориямУчета(FD,                                                                                              
                                                CreditAccount, "+ПереоценкаА", /* КатегДеб , КатегКредит*/                                         
                                                dat,                  /* Дата */                                                                 
                                                chapter,              /* Глава */                                                                
                                                NATCUR,              /* Валюта */                                                               
                                                abs(AmountDiff),            /* Сумма  */                                            
                                                INPCARRY,             /* Result_Carry */                                                         
                                                " 1",                 /* Kind_Oper */                                                            
                                                "",                   /* Numb_Document */                                                        
                                                "Доходы от переоценки средств, поступивших от погашения купона по ЦБ " + FD.avoiriss.rec.ISIN + " " + GetFinName(FD.fininstr.rec) + " (заблокированный актив по указанию ЦБ РФ 6379-У)", 
                                                null, null, null,                                                                       
                                                CreditAccount.rec.Code_Currency, 0     /* валюты счетов: Дт - Кт */
                                                ))
                 return 1;
             end;
          end;

       end;

       /*ak - w487: добавили проводки*/
       if((FD.tick != NULL) and (acctrnind < ПроводкиБУ.GetAccountingTrnBatchSize()))
         /*После исполнения первой проводки (та которая под комментарием /*делаем проводку на сумму платежа*/) 
           получить id созданной проводки и  создать запись в dpmdocs_dbt  -  связку проводки и платежа. 
           Платеж искать через FD, по корреспондируемым счетам и сумме проводки/платежа.*/
         var cmdP = DL_RSDCommand("select t_paymentid "
                                + "from dpmpaym_dbt "
                                + "where t_dockind = ? and "
                                + "      t_documentid = ? and "
                                + "      t_futurepayeraccount = ? and "
                                + "      t_futurereceiveraccount = ? and "
                                + "      t_amount = ?");
         cmdP.AddParam(FD.tick.rec.bofficekind);
         cmdP.AddParam(FD.tick.rec.dealid);
         cmdP.AddParam(DebetAccount.rec.account);
         cmdP.AddParam(CreditAccount.rec.account);
         cmdP.AddParam(Amount - Sод_rest);
         var DataSetP = cmdP.Execute();
         if(DataSetP.moveNext())
           while(acctrnind < ПроводкиБУ.GetAccountingTrnBatchSize())
             ПроводкиБУ.AddAccountingTrnBatchLink(acctrnind, DataSetP.value("t_paymentid"));
             acctrnind = acctrnind + 1;
           end;
         end;
       end;
       /*~ak*/

       if( IsDelimNKD AND (NKDAmount > 0.) )
            GetDlContrCode(FD.tick.rec.clientcontrid, Code, DlDate);

           if(IsREPO(FD.Group))
               CarryGround = "Пкд по Репо. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate+ " по брок.дог." + Code + " от " + DlDate;
           elif((IsSALE(FD.Group)) and (not IsREPO(FD.Group)) )
               CarryGround = "ПКД при продаже. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate+ " по брок.дог." + Code + " от " + DlDate;
           elif((IsBUY(FD.Group)) and (not IsREPO(FD.Group)) )      
               CarryGround = "ПКД при покупке. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate+ " по брок.дог." + Code + " от " + DlDate;
           end;

              
          if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                               DebetAccount, CreditAccount, /* КатегДеб , КатегКредит*/
                                               dat,                  /* Дата */
                                               chapter,              /* Глава */
                                               PayFIID,              /* Валюта */
                                               NKDAmount,            /* Сумма  */
                                               INPCARRY,             /* Result_Carry */
                                               " 1",                 /* Kind_Oper */
                                               "",                   /* Numb_Document */
                                               CarryGround, 0,null,null,
                                               DebetAccount.rec.Code_Currency, CreditAccount.rec.Code_Currency     /* валюты счетов: Дт - Кт */ 
                                             )
            )
              return 1;
          end;
       end;

       if((TaxMain0 + TaxNKD0) > 0)
         var CtAccount = TRecHandler("account.dbt");
  
         if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, true, null, CtAccount, dat, NATCUR ) ) 
             MsgBox( "Ошибка при определении счета по категории <-Бюджет, ф.налоги>." );
             return 1;
         end;

         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                              DebetAccount, CtAccount,        /* КатегДеб , КатегКредит*/
                                              dat,                            /* Дата */
                                              Chapter,                        /* Глава */
                                              NATCUR,                         /* Валюта */
                                              (TaxMain0 + TaxNKD0),           /* Сумма  Счист*/
                                              INPCARRY,                       /* Result_Carry */
                                              " 1",                           /* Kind_Oper */
                                              "",                             /* Numb_Document */
                                              "Удержание налога",
                                              null, 
                                              null,
                                              null,
                                              DebetAccount.rec.Code_Currency, NATCUR 
                                            )
           )
             return 1;
         end;

         ПроводкиБУ.AddNuTaxObj(TaxMain0 + TaxNKD0, NATCUR, PayFIID, dat);
       end;
     end;
  end;
   
  return 0;
end;

MACRO БУ_ОбработатьТОПоОплате( FD, dat )

  var IsDelimNKD = false, IsUNITrnREPO2Cl = false, IsUNITrnREPO2Own = false, StrGround = "";
  var DtAccount = TRecHandler("account");
  var CtAccount = TRecHandler("account");
  var AccountBuff = TRecHandler("account");
  var dlrq;
  var NeedNUTX = false;
  var Code, DlDate; 
  PRIVATE VAR fininstr = TRecHandler( "fininstr" );

  if(IsLoan(FD.Group))
    StrGround = "Сумма ТО по оплате процентов";
    dlrq = FD.GetRQ(DLRQ_TYPE_INCREPO);
  else
    StrGround = "Сумма ТО по оплате сделки";
    dlrq = FD.GetRQ(DLRQ_TYPE_PAYMENT);
  end;

  if( (not FI_IsKSU(FD.fininstr)) AND ОтдельныйУчетУплНКД_Клиента() AND IsClientDeal(FD.tick.rec) AND (FD.NKD_ALL(dat) > 0.) )
     StrGround = ClNotNKDCarryGround;
     IsDelimNKD = true;
  end;

  if(ЕдинаяПроводкаПо2ЧастиКлРЕПО() and IsClientDeal(FD.tick.rec) and IsREPO(FD.Group) and
    (FD.dl_leg.rec.ReturnIncome != 0.0) AND FD.ExistPC)
     IsUNITrnREPO2Cl = true;
  end;

  if (FD.IsBack())//bpv
     if(FD.ExistPC and ((IsBasket(FD.Group)) OR (IsUnitREPO2_Own(FD.GetRQ(DLRQ_TYPE_INCREPO, 2), FD))))
       IsUNITrnREPO2Own = true;
     end;
  end;

  DtAccount.Clear();
  CtAccount.Clear();
/**/
  If(IsClientDeal(FD.tick.rec))
     GetDlContrCode(FD.tick.rec.clientcontrid, Code, DlDate);

     if(IsREPO(FD.Group))
//РАСЧЕТЫ ПО СДЕЛКАМ покупок НА ПАО МОСКОВСКАЯ БИРЖА ЗА {Дата исполнения} {Отчет}
         StrGround = "Репо. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate+ " по брок.дог." + Code + " от " + DlDate;
     elif((IsSALE(FD.Group)) and (not IsREPO(FD.Group)) )
         StrGround = "Продажа. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate+ " по брок.дог." + Code + " от " + DlDate;
     elif((IsBUY(FD.Group)) and (not IsREPO(FD.Group)) )      
         StrGround = "Покупка. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate+ " по брок.дог." + Code + " от " + DlDate;
     end;
  else
     ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
     
     If(IsSALE(FD.Group))
        if(IsREPO(FD.Group))
           If(not FD.isback)
              if(IsBasket(FD.Group))
                 StrGround = "Постановка полученной от контрагента " + UserGetPartyShortName(FD.tick.rec.partyid) + " по сделке прямого репо без прек. признания с корзиной № " + UserGetDealCode(FD) + " ЦБ " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate + " суммы на счета прочих привлеченных средств";
              else
                 StrGround = "Постановка полученной от контрагента " + UserGetPartyShortName(FD.tick.rec.partyid) + " по сделке прямого репо без прек. признания № " + UserGetDealCode(FD) + " ЦБ " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate + " суммы на счета прочих привлеченных средств";
              end;
           else
              if(IsBasket(FD.Group))
                 StrGround = "Оплата второй части сделки прямого РЕПО без прек. признания с корзиной № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;
              else
                 StrGround = "Оплата второй части сделки прямого РЕПО без прек. признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate;
              end;
           end;
        else
           StrGround =  "Расчеты по требованиям по поставке денежных средств при продаже ЦБ " + " по сделке № "+ UserGetDealCode(FD) + ". Контрагент "  + UserGetPartyShortName(FD.tick.rec.partyid);/*20.11.19 RAS 499656*/
           //StrGround =  "Расчеты по требованиям по поставке денежных средств при продаже ЦБ. Контрагент "  + UserGetPartyShortName(FD.tick.rec.partyid);  /*PDV 493705*/
//"Сделка продажи ценной бумаги " + GetFinName(fininstr.rec) + " № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
        end;
     else
        if(IsREPO(FD.Group))
           If(not FD.isback)
              StrGround = "Размещение денежных средств по сделке обратного РЕПО без признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate + ". Контрагент - " + UserGetPartyShortName(FD.tick.rec.partyid);  
           else
//       Оплата второй части сделки обратного РЕПО без признания № 2849521745 с ЦБ SBER_ от 29/06/2018
              StrGround = "Оплата второй части сделки обратного РЕПО без признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(fininstr.rec) + " от " + FD.tick.rec.dealdate + ". Контрагент - " + UserGetPartyShortName(FD.tick.rec.partyid);  
           end;
        else
           StrGround = "Расчеты по обязательствам по поставке денежных средств при покупке ЦБ " + " по сделке № "+ UserGetDealCode(FD) + ". Контрагент " + UserGetPartyShortName(FD.tick.rec.partyid);/*20.11.19 RAS 499656*/
           //StrGround = "Расчеты по обязательствам по поставке денежных средств при покупке ЦБ. Контрагент " + UserGetPartyShortName(FD.tick.rec.partyid);    /*PDV 493705*/
//"Сделка покупки ценной бумаги " + GetFinName(fininstr.rec) + " № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
        end;
     end;
  end;

  if( not ТОСквитовано(dlrq) )
     if(ПолучитьСчетКонтрагентаПоТООплаты( dlrq, FD, dat, DtAccount, CtAccount ) != 0)
       return 1;
     end;
    
     if( not IsClientDeal(FD.tick.rec) )
       var SaveBeforeProlong = FD.BeforeProlong;
    
       if( FD.БылоДосрочноеИсполнение() and (not FD.БылоОтложенноеИсполнение()) )
         FD.BeforeProlong = true; //чтобы взять существующий срочный счет (например, +ОД)
       end;
       
       if( ПолучитьНашСчетТОПоОплате( dlrq, FD, dat, DtAccount, CtAccount ) != 0)
         return 1;
       end;
    
       FD.BeforeProlong = SaveBeforeProlong;
     else
         
       if( ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), AccountBuff) != 0)
         return 1;
       end;
       if(DtAccount.rec.Account == "")
         DtAccount = AccountBuff;
       else
         CtAccount = AccountBuff;
       end;
     end;
     
     if(((IsSALE(FD.Group)) and (not IsREPO(FD.Group)) or IsUNITrnREPO2Cl) and (not IsControlOrg(FD.tick.rec.ClientID)))
       NeedNUTX = true;
     end;
     
     if( БУ_ОбработатьДенежноеТО( dlrq, DtAccount, CtAccount, FD, dat, StrGround, IsDelimNKD, IsUNITrnREPO2Cl, NeedNUTX, IsUNITrnREPO2Own) != 0 )
        return 1;
     end;
  end;
 
  return 0; 
END;

MACRO БУ_ОбработатьТОАвансаЗадатка( FD, dat, IsAvance )

  var DebetAccount  = TRecHandler("account");
  var CreditAccount = TRecHandler("account");
  var DlRq = TRecHandler("dlrq");
  var ErrStr = "", IsSale;  
  var str_text = "", FD1;
  var Dc, Di;

  if( ((IsAvance == true) AND (FD.ExistAvance == true)) OR
      ((IsAvance == false) AND (FD.ExistDeposit == true)) )

     if( FD.BuySale == DEAL_TYPE_SALE )
        IsSale = true;
     else 
        IsSale = false;
     end;

     if( IsAvance == true )
       str_text = "авансу";
     else
       str_text = "задатку";
     end;

     if( (IsAvance == true) and (FD.ExistAvance == true))
       DlRq = FD.GetRQ(DLRQ_TYPE_AVANCE);
     else
       DlRq = FD.GetRQ(DLRQ_TYPE_DEPOSIT);
     end;

     if(ПолучитьСчетаТОПоАвансуЗадатку( DlRq, FD, dat, IsSale, DebetAccount, CreditAccount ) != 0)
       return 1;
     end;

     str_text = "Аванс/задаток по сделке № " + string(FD.tick.rec.DealCode);

     if( (not ТОСквитовано(DlRq)) and (БУ_ОбработатьДенежноеТО( DlRq, DebetAccount, CreditAccount, FD, dat, str_text ) != 0) )
        return 1;
     end; 
     
     if( IsAvance == true )
        if( not БУ_СписатьРезерв( FD, Dat, true ) )
           return 1;
        end;
     end;

  else
     msgbox ("Отсутствует платеж по авансу или задатку");
     return 1;
  end;

  return 0; 
END;


/* USER Проводки фиксации комиссий */

macro БУ_ПроводкиФиксацииКомиссий(FD, Dat, _chapter )
Var sql, Dataset;
  var    chapter:integer = 1;
  var GroundCom = ""; 
  var Code, DlDate;
  if( _chapter != null )
     chapter = _chapter;
  end;
       
       If( (IsClientDeal(FD.tick.rec)) and ( (not IsREPO(FD.Group)) or (IsREPO(FD.Group) and not FD.IsBack)  )) 
          sql = RSDCommand( "select min(comis.T_ID), comis.T_Immaterial, comis.T_DATE, comis.T_PLANPAYDATE, sum(comis.T_SUM) T_SUM, sum(comis.T_NDS) T_NDS, SfCom.t_FIID_Comm, /*SfCom.t_Code,*/ SfCom.t_ReceiverID " +       
                            "  from DDLCOMIS_DBT comis, dsfcomiss_dbt SfCom, ddl_tick_dbt tick " +
                            " where comis.T_DOCKIND = ? " +
                            "   and comis.T_DOCID   = ? " +
                            "   and comis.t_IsBankExpenses != 'X' "+
                            "   and SfCom.t_FeeType = comis.T_FEETYPE " +
                            "   and SfCom.t_Number  = comis.T_COMNUMBER " +
                            "   and sfcom.T_SERVICEKIND = ? "
                            "     AND tick.t_bofficekind = comis.T_DOCKIND " +
                            "     AND tick.t_DealId = comis.T_DOCID " +
                            "     AND sfcom.t_code != decode(RSB_SECUR.GetGeneralMainObjAttr(101,LPAD (tick.t_DealId , 34, '0'),115,tick.t_Dealdate), 1, 'СПбБиржКлир', chr(1)) " +
                            "GROUP BY comis.T_Immaterial, comis.T_DATE, comis.T_PLANPAYDATE, SfCom.t_FIID_Comm, SfCom.t_ReceiverID " 
                          );

          sql.addParam( "", RSDBP_IN, FD.tick.rec.BofficeKind );
          sql.addParam( "", RSDBP_IN, FD.tick.rec.DealID );
          sql.addParam( "", RSDBP_IN, PTSK_STOCKDL );

          sql.execute();                                 
                                                            
          DataSet = TRsbDataSet(sql);                    
                                                      
          while(DataSet.MoveNext())
               GetDlContrCode(FD.tick.rec.clientcontrid, Code, DlDate);

              if(dataset.ReceiverID != {ourbank})
                   GroundCom = "Начисление комиссии биржи. Сделка N " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " " + GetFinName(FD.fininstr.rec) + " по брок.дог." + Code + " от " + DlDate + ". НДС не облагается";
//                 GroundCom = "Комиссия Биржи. Клиентская. Сделка N " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + "по ЦБ " + GetFinName(FD.fininstr.rec);
                 if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            "+РасчетыКомисс1", "+Биржа", /* КатегДеб , КатегКредит*/
                                            dat,                  /* Дата */
                                            chapter,              /* Глава */
                                            dataset.FIID_Comm/*FD.GetPayFIID()*/,      /* Валюта */
                                            dataset.sum,          /* Сумма  */
                                            INPCARRY,             /* Result_Carry */
                                            " 1",                 /* Kind_Oper */
                                            "",                   /* Numb_Document */
                                            GroundCom/*"Комиссия Биржи. Клиентская. Сделка N " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + "по ЦБ " + GetFinName(FD.fininstr.rec)*/,
                                             0,null,null,
                                             dataset.FIID_Comm/*FD.GetPayFIID()*/, /*FD.GetPayFIID()*/dataset.FIID_Comm     /* валюты счетов: Дт - Кт */ 
                                          )
                    )
                      return 1;
                  end;
              else


                 GroundCom = "Брокерская комиссия. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate /*KOA ID : 534182 dat*/ + " " + GetFinName(FD.fininstr.rec) + " по брок.дог." + Code + " от " + DlDate + ". НДС не облагается";

                 if(not БУ_ПроводкаПоКатегориямУчета( FD, /*FIROLE_COMISS_CLIENT*/
                                            "+РасчетыКомисс1", "+КВ, ц/б", /* КатегДеб , КатегКредит*/
                                            dat,                  /* Дата */
                                            chapter,              /* Глава */
                                            FD.GetPayFIID(),      /* Валюта */
                                            dataset.sum,          /* Сумма  */
                                            INPCARRY,             /* Result_Carry */
                                            " 1",                 /* Kind_Oper */
                                            "",                   /* Numb_Document */
                                            GroundCom/*"Комиссия . Клиентская. Сделка N " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + "по ЦБ " + GetFinName(FD.fininstr.rec)*/,
                                             0,null,FIROLE_COMISS_CLIENT/*null*/,
                                             FD.GetPayFIID(), 0     /* валюты счетов: Дт - Кт */ 
                                          )
                    )
                      return 1;
                  end;

              end;

          end;
       End;
End;


macro БУ_ПроводкиФиксацииКомиссийКлирингСПБ(FD, Dat, _chapter )
Var sql, Dataset;
  var    chapter:integer = 1;
  var GroundCom = ""; 
  var Code, DlDate;
  if( _chapter != null )
     chapter = _chapter;
  end;
       
       If( (IsClientDeal(FD.tick.rec)) and ( (not IsREPO(FD.Group)) or (IsREPO(FD.Group) and not FD.IsBack)  )) 
          sql = RSDCommand( "select min(comis.T_ID), comis.T_Immaterial, comis.T_DATE, comis.T_PLANPAYDATE, sum(comis.T_SUM) T_SUM, sum(comis.T_NDS) T_NDS, SfCom.t_FIID_Comm, /*SfCom.t_Code,*/ SfCom.t_ReceiverID " +       
                            "  from DDLCOMIS_DBT comis, dsfcomiss_dbt SfCom, ddl_tick_dbt tick " +
                            " where comis.T_DOCKIND = ? " +
                            "   and comis.T_DOCID   = ? " +
                            "   and comis.t_IsBankExpenses != 'X' "+
                            "   and SfCom.t_FeeType = comis.T_FEETYPE " +
                            "   and SfCom.t_Number  = comis.T_COMNUMBER " +
                            "   and sfcom.T_SERVICEKIND = ? "
                            "     AND tick.t_bofficekind = comis.T_DOCKIND " +
                            "     AND tick.t_DealId = comis.T_DOCID " +
                            "     AND sfcom.t_code = decode(RSB_SECUR.GetGeneralMainObjAttr(101,LPAD (tick.t_DealId , 34, '0'),115,tick.t_Dealdate), 1, 'СПбБиржКлир', chr(1)) " +
                            "   and comis.T_DATE   = ? " +
                            "GROUP BY comis.T_Immaterial, comis.T_DATE, comis.T_PLANPAYDATE, SfCom.t_FIID_Comm, SfCom.t_ReceiverID " 
                          );

          sql.addParam( "", RSDBP_IN, FD.tick.rec.BofficeKind );
          sql.addParam( "", RSDBP_IN, FD.tick.rec.DealID );
          sql.addParam( "", RSDBP_IN, PTSK_STOCKDL );
          sql.addParam( "", RSDBP_IN, Dat );

          sql.execute();                                 
                                                            
          DataSet = TRsbDataSet(sql);                    
                                                      
          while(DataSet.MoveNext())
               GetDlContrCode(FD.tick.rec.clientcontrid, Code, DlDate);

                      GroundCom = "Начисление комиссии биржи. Сделка N " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " " + GetFinName(FD.fininstr.rec) + " по брок.дог." + Code + " от " + DlDate + ". НДС не облагается";
   //                 GroundCom = "Комиссия Биржи. Клиентская. Сделка N " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + "по ЦБ " + GetFinName(FD.fininstr.rec);
                    if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                               "+РасчетыКомисс1", "+Биржа", /* КатегДеб , КатегКредит*/
                                               dat,                  /* Дата */
                                               chapter,              /* Глава */
                                               dataset.FIID_Comm/*FD.GetPayFIID()*/,      /* Валюта */
                                               dataset.sum,          /* Сумма  */
                                               INPCARRY,             /* Result_Carry */
                                               " 1",                 /* Kind_Oper */
                                               "",                   /* Numb_Document */
                                               GroundCom/*"Комиссия Биржи. Клиентская. Сделка N " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + "по ЦБ " + GetFinName(FD.fininstr.rec)*/,
                                                0,null,null,
                                                dataset.FIID_Comm/*FD.GetPayFIID()*/, /*FD.GetPayFIID()*/dataset.FIID_Comm     /* валюты счетов: Дт - Кт */ 
                                             )
                       )
                         return 1;
                     end;

          end;
       End;
End;


macro БУ_ПроводкиПостановкиНаБаланс(FD, Dat)

  if( БУ_ПоставитьНаБаланс( FD, dat) != 0 )
    return 1;
  end;

  if(IsSALE(FD.Group) and IsTODAY(FD.Group))
    if( not БУ_СписатьРезерв( FD, Dat ) )
      return 1;
    end;
  end;

  return 0;
end;

/*IsWrt - Признак полного списания: 1-да, 0-нет*/
macro БУ_ВыполнитьНачислениеПоДенЛотуРепо(FD, dat:date, GrDealID:integer, _IsWrt:integer)
  var AccountReceiver = TRecHandler( "account" );
  var AccountPayer = TRecHandler( "account" );
  var IsExistsDebetAcc = false, IsExistsCreditAcc = false, CatDebet = "", CatCredit = "";
  var DebFIID, CredFIID;
  var SдоначОР = $0, S_СЗ = $0, SдоначПроцДоЭПС = $0, SсписПроцДоЭПС = $0, SCorrEstRes = $0; 
  var Sдонач_НацВ = $0, Sпред_вц = $0, Sum_CFI = $0, v_PrevDate = ZeroDate;
  var Select, DataSet, IsWrt = 0, Err = "";
  var ЭтоПРЕПО = IsSALE(FD.Group);

  if( IsClientDeal(FD.tick.rec) )
     return true;
  end;

  if( _IsWrt != null )
     IsWrt = _IsWrt;
  end;

  Sum_CFI = БУ_ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT_CFI, v_PrevDate);
  /*на дату предыдущего расчета*/
  Sпред_вц = ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT_CFI, v_PrevDate-1);

  if( SmartConvertSum( Sдонач_НацВ, Sum_CFI-Sпред_вц, dat, FD.dl_leg.rec.CFI, NATCUR, true ) != true )
     return false;
  end;
  /*Начисление выполняем во временную таблицу*/
  if( DL_WRTAccrueParmREPOTmp(IsWrt, Sдонач_НацВ, dat, FD.Tick.rec.DealID, GrDealID) != 0 )
     Err = GetErrMsg();
     if( Err != "" )
        msgbox(Err);
     end;
     return false;
  end;

  Select = DL_RSDCommand( "SELECT TMP.T_DEFDIFFADD, "
                         +"       TMP.T_WRTOUTLAYADD, "
                         +"       (TMP.T_CORRINTTOEIR - LOT.T_CORRINTTOEIR) DeltaCORRINTTOEIR, "
                         +"       (TMP.T_WRTCORRINTTOEIR + LOT.T_CORRVALUE - TMP.T_CORRVALUE) as AllCorrValue, "
                         +"       LOT.T_CORRESTRESERVE "
                         +"  FROM DPMWRTSUM_TMP TMP, DPMWRTSUM_DBT LOT "
                         +" WHERE TMP.T_GRDEALID = ? "
                         +"   AND LOT.T_SUMID = TMP.T_SUMID "
                        );

  Select.AddParam(GrDealID);

  DataSet = Select.Execute();

  if(DataSet.moveNext())

     SдоначОР = SQL_ConvTypeSum(DataSet.DEFDIFFADD);
     S_СЗ = SQL_ConvTypeSum(DataSet.WRTOUTLAYADD);
     SдоначПроцДоЭПС = SQL_ConvTypeSum(DataSet.DeltaCORRINTTOEIR); 
     SсписПроцДоЭПС = SQL_ConvTypeSum(DataSet.AllCorrValue); 
     SCorrEstRes    = SQL_ConvTypeSum(DataSet.CORRESTRESERVE);

     /*оценочный резерв только в ОРЕПО*/
     if( (not ЭтоПРЕПО) and (SCorrEstRes != $0) )
        CatDebet = "+КОР_Резерв, договор_проч";
        CatCredit = "+КОР_РС,д/с%";
       
        ClearRecord(AccountPayer.rec);
        IsExistsDebetAcc = false;
        if( FD.IsExistAccount( CatDebet, null, true, null, AccountPayer, null, dat ) )
           IsExistsDebetAcc = true;
        end;

        ClearRecord(AccountReceiver.rec);
        IsExistsCreditAcc = false;
        if( FD.IsExistAccount( CatCredit, null, true, null, AccountReceiver, null, dat ) )
           IsExistsCreditAcc = true;
        end;

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
               iif(IsExistsDebetAcc,AccountPayer,CatDebet), iif(IsExistsCreditAcc,AccountReceiver,CatCredit),         /* КатегДеб , КатегКредит*/
               dat,         /* Дата */
               1,                     /* Глава */
               NATCUR,             /* Валюта */
               ABS(SCorrEstRes),                   /* Сумма */
               INPCARRY,                    /* Result_Carry */
               " 1",                        /* Kind_Oper */
               "",                          /* Numb_Document */
               "Списание резерва по прочим размещенным средствам"
              ) 
          )
           return false;
        end;

     end;

     if( SдоначОР != $0 )

        if( SдоначОР > $0 )
           if( ЭтоПРЕПО )
              CatDebet = "-КСт, ПривлСрАС";
              CatCredit = "+Дох, ПривлСр";
           else
              CatDebet = "-КСт, РазмещСрАС";
              CatCredit = "+Дох, РазмещСр";
           end;
        else
           if( ЭтоПРЕПО )
              CatDebet = "-Расх, ПривлСр";
              CatCredit = "+КСт, ПривлСрАС";
           else
              CatDebet = "-Расх, РазмещСр";
              CatCredit = "+КСт, РазмещСрАС";
           end;
        end;

        ClearRecord(AccountPayer.rec);
        IsExistsDebetAcc = false;
        if( FD.IsExistAccount( CatDebet, null, true, null, AccountPayer, null, dat ) )
           IsExistsDebetAcc = true;
        end;

        ClearRecord(AccountReceiver.rec);
        IsExistsCreditAcc = false;
        if( FD.IsExistAccount( CatCredit, null, true, null, AccountReceiver, null, dat ) )
           IsExistsCreditAcc = true;
        end;

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
               iif(IsExistsDebetAcc,AccountPayer,CatDebet), iif(IsExistsCreditAcc,AccountReceiver,CatCredit),         /* КатегДеб , КатегКредит*/
               dat,         /* Дата */
               1,                     /* Глава */
               NATCUR,             /* Валюта */
               ABS(SдоначОР),                   /* Сумма */
               INPCARRY,                    /* Result_Carry */
               " 1",                        /* Kind_Oper */
               "",                          /* Numb_Document */
               "Списание отсроченной разницы"
              ) 
          )
           return false;
        end;
     end;

     if( SдоначПроцДоЭПС != $0 )

        if( SдоначПроцДоЭПС < $0 )
           if( ЭтоПРЕПО )
              CatDebet = "-КСт, ПривлСрАС";
              CatCredit = "-Корр, ПРепо";
           else
              CatDebet = "-КСт, РазмещСрАС";
              CatCredit = "-Корр, ОРепо";
           end;
        else
           if( ЭтоПРЕПО )
              CatDebet = "+Корр, ПРепо";
              CatCredit = "+КСт, ПривлСрАС";
           else
              CatDebet = "+Корр, ОРепо";
              CatCredit = "+КСт, РазмещСрАС";
           end;
        end;
       
        ClearRecord(AccountPayer.rec);
        IsExistsDebetAcc = false;
        if( FD.IsExistAccount( CatDebet, null, true, null, AccountPayer, null, dat ) )
           IsExistsDebetAcc = true;
        end;

        ClearRecord(AccountReceiver.rec);
        IsExistsCreditAcc = false;
        if( FD.IsExistAccount( CatCredit, null, true, null, AccountReceiver, null, dat ) )
           IsExistsCreditAcc = true;
        end;

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
               iif(IsExistsDebetAcc,AccountPayer,CatDebet), iif(IsExistsCreditAcc,AccountReceiver,CatCredit),         /* КатегДеб , КатегКредит*/
               dat,         /* Дата */
               1,                     /* Глава */
               NATCUR,             /* Валюта */
               ABS(SдоначПроцДоЭПС),                   /* Сумма */
               INPCARRY,                    /* Result_Carry */
               " 1",                        /* Kind_Oper */
               "",                          /* Numb_Document */
               "Корректировка % до ЭПС"
              ) 
          )
           return false;
        end;
     end;

/*     if( S_СЗ != $0 )

        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
               iif(ЭтоПРЕПО,"-КВ проц.расход, ц/б","-КВ проц.доход, ц/б"), "Затраты, Репо",         /* КатегДеб , КатегКредит*/
               dat,         /* Дата */
               1,                     /* Глава */
               NATCUR,             /* Валюта */
               abs(S_СЗ),                   /* Сумма */
               INPCARRY,                    /* Result_Carry */
               " 1",                        /* Kind_Oper */
               "",                          /* Numb_Document */
               "Списание существенных затрат"
              ) 
          )
           return false;
        end;
     end;
  */
     if( IsWrt == 1 )

        ClearRecord(AccountPayer.rec);
        IsExistsDebetAcc = false;
        if( FD.IsExistAccount( iif(ЭтоПРЕПО,"-Корр, ПРепо","-Корр, ОРепо"), null, true, null, AccountPayer, MC_PAIRACCMODE_MANUAL, dat ) )
           IsExistsDebetAcc = true;
        end;

        ClearRecord(AccountReceiver.rec);
        IsExistsCreditAcc = false;
        if( FD.IsExistAccount( iif(ЭтоПРЕПО,"+Корр, ПРепо","+Корр, ОРепо"), null, true, null, AccountReceiver, MC_PAIRACCMODE_MANUAL, dat ) )
           IsExistsCreditAcc = true;
        end;

        if( IsExistsDebetAcc )
           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                  AccountPayer, iif(ЭтоПРЕПО,"+Дох, ПривлСр","+Дох, РазмещСр"),         /* КатегДеб , КатегКредит*/
                  dat,         /* Дата */
                  1,                     /* Глава */
                  NATCUR,             /* Валюта */
                  $0,                   /* Сумма */
                  INPCARRY,                    /* Result_Carry */
                  " 1",                        /* Kind_Oper */
                  "",                          /* Numb_Document */
                  "Списание СС по сделке",
                  GETRESTACC_DEBET
                 ) 
             )
              return false;
           end;
        end;

        if( IsExistsCreditAcc )
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                  iif(ЭтоПРЕПО,"-Расх, ПривлСр","-Расх, РазмещСр"), AccountReceiver,         /* КатегДеб , КатегКредит*/
               dat,         /* Дата */
               1,                     /* Глава */
               NATCUR,             /* Валюта */
                  $0,                   /* Сумма */
               INPCARRY,                    /* Result_Carry */
               " 1",                        /* Kind_Oper */
               "",                          /* Numb_Document */
                  "Списание СС по сделке",
                  GETRESTACC_CREDIT
              ) 
          )
           return false;
        end;
     end;

  end;

  end;

  return true;                                  
end;

/*
IsWrt - Признак полного списания (1 - да, 0 - нет)
*/
macro БУ_ВыполнитьДоначислениеПроцентовВРепо(FD2, dat, _IsWrt:integer)
  var rq_avance1 = TRecHandler("dlrq");
  var rq_money1 = TRecHandler("dlrq");
  var rq_avance2 = TRecHandler("dlrq");
  var rq_money2 = TRecHandler("dlrq");
  var rq_pc2 = TRecHandler("dlrq");
  var CatDebet = "", CatCredit = "", ground, Sдонач_вр = $0, R = $0;
  var Sпред_вр = $0, Sum_CFI = $0, Sum_PayFIID = $0;
  var DebFIID, CredFIID;
  var IsOverdue = false, IsWrt = 0;
  var FD = SPFirstDoc( FD2.tick, false );

  if( IsClientDeal(FD.tick.rec) or (FD.dl_leg.rec.IncomeRate == 0.0) or (not FD.ExistPC) )
     return true;
  end;

  if( _IsWrt != null )
     IsWrt = _IsWrt;
  end;

  if( ТОБылоПросрочено(FD2.GetRQ(DLRQ_TYPE_INCREPO) ) )
     IsOverdue = true;
  end;

  Sпред_вр = БУ_ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT);

  if( IsWrt != 0 )/*случай полного списания*/
     Sum_CFI = FD2.GetRQ(DLRQ_TYPE_INCREPO).rec.Amount;
     if( SmartConvertSum( Sum_PayFIID, Sum_CFI, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), true ) != true )
        return false;
     end;
  else/*случай доначисления процентов на дату*/
     if(FD.ExistRqMoney())
       rq_money1 = FD.GetRQ(DLRQ_TYPE_PAYMENT);
     end;
    
     if(FD.ExistAvance())
       rq_avance1 = FD.GetRQ(DLRQ_TYPE_AVANCE);
     elif(FD.ExistDeposit())
       rq_avance1 = FD.GetRQ(DLRQ_TYPE_DEPOSIT);
     end;
    
     if(FD2.ExistRqMoney())
       rq_money2 = FD2.GetRQ(DLRQ_TYPE_PAYMENT);
     end;
    
     if(FD2.ExistAvance())
       rq_avance2 = FD2.GetRQ(DLRQ_TYPE_AVANCE);
     elif(FD2.ExistDeposit())
       rq_avance2 = FD2.GetRQ(DLRQ_TYPE_DEPOSIT);
     end;
    
     if(FD2.ExistPC())
       rq_pc2 = FD2.GetRQ(DLRQ_TYPE_INCREPO);
     end;
     /*вычисляется S% в ВЦ на дату операции по формуле из ТЗ на операцию начисления */
     Sum_CFI = SP_GetPercentSum( rq_avance1, rq_money1, rq_avance2, rq_money2, rq_pc2, FD.dl_leg, FD2.dl_leg, FD.Group, dat, true );
     /*если ВЦ!=ВР выполняется конвертация в ВР*/
     if( SmartConvertSum( Sum_PayFIID, Sum_CFI, dat, 
                          FD.dl_leg.rec.CFI, FD.GetPayFIID(), true ) != true )
        return false;
     end;    
  end;

  Sдонач_вр = Sum_PayFIID - Sпред_вр;
  if( Sдонач_вр > $0 )
  if( not БУ_СохранитьСуммуКомиссии( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT_CFI, dat, Sum_CFI, $0, FD.dl_leg.rec.CFI ) )
     msgbox("Ошибка при сохранении суммы процентов по сделке с кодом " + string(FD.tick.rec.DealCode));
     return false;
  end;

  if( not БУ_СохранитьСуммуКомиссии( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT, dat, Sum_PayFIID, $0, FD.GetPayFIID() ) )
     msgbox("Ошибка при сохранении суммы процентов по сделке с кодом " + string(FD.tick.rec.DealCode));
     return false;
  end;

//  ground = "Доначисление процентов";
    ground = "";
//Начисление процентов на расходы по первой части сделки  РЕПО без прек. признания № 2849284668  с ЦБ RUS-47 (контр. НКО НКЦ (АО)) от 29/06/2018.
  /*
  Если Прямое репо и Ставка > 0 или Обратное РЕПО и Ставка < 0  
  */
  if(((FD.dl_leg.rec.IncomeRate > 0.0) and IsSALE(FD.Group)) or
     ((FD.dl_leg.rec.IncomeRate < 0.0) and IsBUY(FD.Group))
    )
     CatDebet  = "-%Пкр"; 
     DebFIID   = NATCUR;
     if( IsOverdue )
        CatCredit = "-% с н.с.";
     else
        CatCredit = "-% к погашению";
     end;
     CredFIID  = FD.GetPayFIID();

     If(IsSALE(FD.Group))
        ground = "Начисление процентов на расходы по первой части сделки РЕПО без прек. признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec) + "(контр. " +/*GAA:500801*/UserGetPartyShortName(FD.tick.rec.partyid) + ") от " + FD.tick.rec.dealdate;
     else
        ground = "Начисление процентов на расходы по первой части сделки обратного РЕПО № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec) + "(контр. " + /*GAA:500801*/UserGetPartyShortName(FD.tick.rec.partyid) + ") от " + FD.tick.rec.dealdate;
     end;
  else
     if( IsOverdue )
        CatDebet = "+% с н.с.";
     else
        CatDebet = "+% к погашению";
     end;
     DebFIID  = FD.GetPayFIID();

     CatCredit = "+%Пкр";
     CredFIID   = NATCUR;
     If(IsSALE(FD.Group))
        ground = "Начисление процентов на доходы по первой части сделки РЕПО без прек. признания № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec) + "(контр. " + /*GAA:500801*/UserGetPartyShortName(FD.tick.rec.partyid) + ") от " + FD.tick.rec.dealdate;  
     else
        ground = "Начисление процентов на доходы по первой части сделки обратного РЕПО № " + UserGetDealCode(FD) + " с ЦБ " + GetFinName(FD.fininstr.rec) + "(контр. " + /*GAA:500801*/UserGetPartyShortName(FD.tick.rec.partyid) + ") от " + FD.tick.rec.dealdate;  
     end;

  end;

  if(not БУ_ПроводкаПоКатегориямУчета( FD2, 
         CatDebet, CatCredit,         /* КатегДеб , КатегКредит*/
         dat,                         /* Дата */
         1,                           /* Глава */
         FD.GetPayFIID(),             /* Валюта */
         Sдонач_вр,                   /* Сумма*/
         INPCARRY,                    /* Result_Carry */
         " 1",                        /* Kind_Oper */
         "",                          /* Numb_Document */
         ground,
         null,
         null, null,
         DebFIID, CredFIID
        ) 
    )
      return false;
  end;
  end;

  return true;
end;

macro БУ_ОбработатьКомпенсационныйПлатежТО(FD:SPFirstDoc, dat:DATE, GrDealID:INTEGER)
  var DlRq = TRecHandler("dlrq"),
      PaySum, PayFIID = FD.GetPayFIID();
  
  var PayerAccountBuff = TRecHandler("account");
  var ReceiverAccountBuff = TRecHandler("account");

  if(ПолучитьТОПоСтрокеГрафика(GrDealID, DLRQ_TYPE_COMPPAYM, DlRq) != 0)
    return 1;
  end;

  if( ТОСквитовано(DlRq) )/*ТО сквитовано, значит, проводка по нему не нужна*/
    return 0;
  end;

  if( not ТОЗакрыто(DlRq) )/*просто выводим сообщение и проводку по ТО не делаем, т.к. ТО должно быть сквитовано, а для сквитованного проводка по ТО не нужна*/
//    msgbox("По сделке с кодом \""+FD.tick.rec.DealCode+"\" ТО с ID = "+DlRq.rec.ID+" требуется исполнить квитовкой");
    return 0;
  end;

  if(ПолучитьСчетаКомпенсационногоТО(DlRq, FD, dat, PayerAccountBuff, ReceiverAccountBuff) != 0)
    return 1;
  end;

  /*Ищем сумму в ВР*/
  if( dlrq.rec.FIID != PayFIID )
     SmartConvertSum(PaySum, dlrq.rec.Amount, dat, dlrq.rec.FIID, PayFIID, true);
  else
     PaySum = dlrq.rec.Amount;
  end;

  /*Для ОРЦБ проводку делаем по категориям , а не по ТО
    Для НЕ ОРЦБ проводку делает ядро по платежу*/
  if( FD.СделкаОРЦБ() )
     if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                           PayerAccountBuff, ReceiverAccountBuff, /* КатегДеб , КатегКредит*/
                                           dat,                  /* Дата */
                                           1,                    /* Глава */
                                           PayFIID,              /* Валюта */
                                           PaySum,               /* Сумма  */
                                           INPCARRY,             /* Result_Carry */
                                           " 1",                 /* Kind_Oper */
                                           "",                   /* Numb_Document */
                                           "Сумма компенсационного платежа "
                                         )
       )
        return 1;
     end;
  else/*не ОРЦБ*/
     if( БУ_ОбработатьДенежноеТО(DlRq, PayerAccountBuff, ReceiverAccountBuff, FD, dat, "Сумма компенсационного платежа ") != 0 )
        return 1;
     end;
  end;

  return 0;
end;

macro БУ_ПроводкиУчетаКомпенсационногоПлатежа(FD, Dat, GrDealID)

  if(БУ_ОбработатьКомпенсационныйПлатежТО(FD, dat, GrDealID) != 0)
    return 1;
  end;

  if( not БУ_ВыполнитьДоначислениеПроцентовВРепо(FD, dat) )
     return 1;
  end;
  if( not БУ_ВыполнитьНачислениеПоДенЛотуРепо(FD, dat, GrDealID) )
     return 1;
  end;

  return 0;
end;

private macro calcTaxPayTaxCoup(GrDealID: Integer, dlrq_type: Integer, onDate: date, TaxPay: @money, TaxCoup: @money): bool
    var dlrq = TRecHandler("dlrq");
    if( ПолучитьТОПоСтрокеГрафика(GrDealID, dlrq_type, dlrq) != 0 )
        return false;
    end;
    
    var  tick = TBFile("dl_tick.dbt","r",1);
    tick.clear();
    tick.rec.DealID = dlrq.rec.DocID;
    tick.KeyNum = 0;
    if ( not tick.GetEQ() )
        return false;
    end;

    var clientID: Integer = IIF(tick.rec.ClientID<=0, {OurBank}, tick.rec.ClientID);
    var FactReceiverID: Integer = GetFactReceiverForNUTX(clientID);

    var clientRec   = TBFile("party.dbt");
    var factRcvrRec = TBFile("party.dbt");
    var partyRec    = TBFile("party.dbt");

    if ( ( ПолучитьСубъекта(clientID, clientRec) != 0) or (ПолучитьСубъекта(FactReceiverID, factRcvrRec) != 0) )
        return false;
    end;

    var clientIsNeres: bool = IsInstNeresForNUTX(clientID, onDate);
    var factIsNeres  : bool = IsInstNeresForNUTX(FactReceiverID, onDate);
    
    const LegalPerson   = 1;  // юрик
    const NaturalPerson = 2;  // физик

    // если Если клиент и фактический получатель по сделке  - юридическое лицо-нерезидент
    if ( (LegalPerson == clientRec.rec.legalForm) and (LegalPerson == factRcvrRec.rec.legalForm) and (true == clientIsNeres) )
        NUTX_GetClientDealDueTax1(tick.rec.DealID, tick.rec.ClientID, @TaxPay, @TaxCoup);
    // Если по сделке клиент - юридическое лицо - нерезидент и фактический по-лучатель по сделке - физ.лицо и покупатель 1 части РЕПО
    elif ( (LegalPerson == clientRec.rec.legalForm) and (true == clientIsNeres) and (NaturalPerson == factRcvrRec.rec.legalForm)  )
        var partyID = tick.rec.PartyID;
        if ( (partyID <= 0) )
            var Group = GetOperationGroup ( tick.rec.DealType ); 
            if( IsEXCHANGE( Group ) == true )/*биржевая сделка*/
                partyID = tick.rec.MarketID;
            end;
        end;

        if ( ПолучитьСубъекта(partyID, partyRec) != 0 )
            return false;
        end;

        var TaxSumBuy  = dlrq.rec.TaxSumBuy;
        var TaxSumSell = dlrq.rec.TaxSumSell;

        if ( NaturalPerson == partyRec.rec.legalForm )
            TaxCoup = TaxSumBuy + max(TaxSumSell-TaxSumBuy, 0); 
            TaxPay  = max (TaxSumSell  - TaxSumBuy, 0);
        else 
            TaxCoup = TaxSumBuy + TaxSumSell;
            TaxPay = TaxSumSell;
        end;
    
    else
        TaxPay = TaxCoup = 0;
    end;

    return true;
end;

private macro ПроводкиНЕБиржевогоПРЕПОПоУчетуКупона(FD:SPFirstDoc, dat:DATE, GrDealID:INTEGER, dlrq:TRecHandler,  dlRqType:INTEGER, ReturnIncomeKind ): integer
    var TaxCoup = $0; var TaxPay = $0;
    var accountDbt  = TRecHandler("account");
    var accountCrd  = TRecHandler("account");

    if ( not calcTaxPayTaxCoup(GrDealID, dlRqType, dat, @TaxPay , @TaxCoup ) )
        return 1;
    end;

    if( ReturnIncomeKind == SP_RETURNINCOME_PAYMENT ) // Выплата
        if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), accountDbt) != 0)
            return 1;
        end;
        if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, IIF(FD.tick.rec.ClientID > 0, FD.tick.rec.ClientID, {OurBank} ),
                                                                             DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), accountCrd) != 0)
            return 1;
        end;       
        if ( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            accountDbt, accountCrd,    /* КатегДеб , КатегКредит*/
                                            dat,                            /* Дата */
                                            1,                              /* Глава */
                                            NATCUR,                        /* Валюта */
                                            TaxCoup,                         /* Сумма  Счист*/
                                            INPCARRY,                       /* Result_Carry */
                                            " 1",                           /* Kind_Oper */
                                            "",                             /* Numb_Document */
                                            "Учёт купона",
                                            null, 
                                            null,
                                            null,
                                            accountDbt.rec.Code_Currency, accountCrd.rec.Code_Currency 
                                            )
            )
                return 1;
        end;

        if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, true, null, accountCrd, dat, NATCUR ) ) 
            MsgBox( "Ошибка при определении счета по категории <-Бюджет, ф.налоги>." );
            return 1;
        end;
        if ( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            accountDbt, accountCrd,    /* КатегДеб , КатегКредит*/
                                            dat,                            /* Дата */
                                            1,                              /* Глава */
                                            NATCUR,                        /* Валюта */
                                            TaxPay,                         /* Сумма  Счист*/
                                            INPCARRY,                       /* Result_Carry */
                                            " 1",                           /* Kind_Oper */
                                            "",                             /* Numb_Document */
                                            "Удержание налога",
                                            null, 
                                            null,
                                            null,
                                            accountDbt.rec.Code_Currency, accountCrd.rec.Code_Currency 
                                            )
            )
                return 1;
        end;

        if(TaxPay > 0)
           ПроводкиБУ.AddNPTXObj(TaxPay,  NATCUR, FD.GetPayFIID(), dat);
        end;

    elif ( ReturnIncomeKind == SP_RETURNINCOME_WRTOFF )  // Способ возвра-та = уменьшение суммы основно-го долга

        if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, IIF(FD.tick.rec.ClientID > 0, FD.tick.rec.ClientID, {OurBank} ),
                                                                             DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), accountDbt) != 0)
            return 1;
        end;  
        if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, true, null, accountCrd, dat, NATCUR ) ) 
            MsgBox( "Ошибка при определении счета по категории <-Бюджет, ф.налоги>." );
            return 1;
        end;   
        if ( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            accountDbt, accountCrd,    /* КатегДеб , КатегКредит*/
                                            dat,                            /* Дата */
                                            1,                              /* Глава */
                                            NATCUR,                        /* Валюта */
                                            TaxPay,                         /* Сумма  Счист*/
                                            INPCARRY,                       /* Result_Carry */
                                            " 1",                           /* Kind_Oper */
                                            "",                             /* Numb_Document */
                                            "Удержание налога",
                                            null, 
                                            null,
                                            null,
                                            accountDbt.rec.Code_Currency, accountCrd.rec.Code_Currency 
                                            )
            )
                return 1;
        end;

        if(TaxPay > 0)
           ПроводкиБУ.AddNPTXObj(TaxPay,  NATCUR, FD.GetPayFIID(), dat);
        end;
    end;
end;

private macro ПроводкиБиржевогоПРЕПОПоУчетуКупона(FD:SPFirstDoc, dat:DATE, GrDealID:INTEGER, dlrq:TRecHandler,  dlRqType:INTEGER, ReturnIncomeKind ): integer
    var TaxCoup = $0; var TaxPay = $0;
    var Amount = $0;
    var accountDbt  = TRecHandler("account");
    var accountCrd  = TRecHandler("account");

        if ( not calcTaxPayTaxCoup(GrDealID, dlRqType, dat, @TaxPay , @TaxCoup ) )
            return 1;
        end;
    
    if( ReturnIncomeKind == SP_RETURNINCOME_PAYMENT )
    
        var fiw = TRecHandler("fiwarnts.dbt");
        if (FI_GetCouponOnDate(FD.CurPFI(), dat, fiw) != 0)
            msgbox("Не найден купон с ID\""+FD.CurPFI()+"\"");
            return 1;
        end;

        Amount = fiw.rec.IncomeVolume / fiw.rec.IncomeScale * FD.dl_leg.rec.Principal - TaxCoup;

        if (  FD.tick.rec.BrokerID > 0 ) // Способ возврата = выплата по к/с, брокер указан
            
            if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.BrokerID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), accountDbt) != 0)
                return 1;
            end;
            var ClientID = IIF(FD.tick.rec.ClientID <= 0, {OurBank}, FD.tick.rec.ClientID);
            if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID,  ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), accountCrd) != 0)
                return 1;
            end;

            if ( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            accountDbt, accountCrd,    /* КатегДеб , КатегКредит*/
                                            dat,                            /* Дата */
                                            1,                              /* Глава */
                                            FD.dl_leg.rec.CFI,              /* Валюта */
                                            Amount,                         /* Сумма  Счист*/
                                            INPCARRY,                       /* Result_Carry */
                                            " 1",                           /* Kind_Oper */
                                            "",                             /* Numb_Document */
                                            "Зачисление дохода клиенту",
                                            null, 
                                            null,
                                            null,
                                            accountDbt.rec.Code_Currency, accountCrd.rec.Code_Currency 
                                            )
            )
                return 1;
            end;

            if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, true, null, accountCrd, dat, NATCUR ) ) 
                MsgBox( "Ошибка при определении счета по категории <-Бюджет, ф.налоги>." );
                return 1;
            end;

            if ( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            accountDbt, accountCrd,    /* КатегДеб , КатегКредит*/
                                            dat,                             /* Дата */
                                            1,                               /* Глава */
                                            NATCUR,                         /* Валюта */
                                            TaxPay,                          /* Сумма  Счист*/
                                            INPCARRY,                        /* Result_Carry */
                                            " 1",                            /* Kind_Oper */
                                            "",                              /* Numb_Document */
                                            "Удержание налога",
                                            null, 
                                            null,
                                            null,
                                            accountDbt.rec.Code_Currency, NATCUR 
                                            )
            )
                return 1;
            end;

        else // Способ возвра-та = выплата по к/с, брокер НЕ указан

            if( not FD.OpenAccount( "+Биржа", null, true, null, accountDbt, dat, FD.dl_leg.rec.CFI ) ) 
                MsgBox( "Ошибка при определении счета по категории <+Биржа>." );
                return 1;
            end;
            ClientID = IIF(FD.tick.rec.ClientID <= 0, {OurBank}, FD.tick.rec.ClientID);
            if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), accountCrd) != 0)
                return 1;
            end;

            if ( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            accountDbt, accountCrd,    /* КатегДеб , КатегКредит*/
                                            dat,                            /* Дата */
                                            1,                              /* Глава */
                                            FD.dl_leg.rec.CFI,              /* Валюта */
                                            Amount,                         /* Сумма  Счист*/
                                            INPCARRY,                       /* Result_Carry */
                                            " 1",                           /* Kind_Oper */
                                            "",                             /* Numb_Document */
                                            "Зачисление дохода клиенту",
                                            null, 
                                            null,
                                            null,
                                            accountDbt.rec.Code_Currency, accountCrd.rec.Code_Currency 
                                            )
            )
                return 1;
            end;

            if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, true, null, accountCrd, dat, NATCUR ) ) 
                MsgBox( "Ошибка при определении счета по категории <-Бюджет, ф.налоги>." );
                return 1;
            end;
            if ( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                            accountDbt, accountCrd,    /* КатегДеб , КатегКредит*/
                                            dat,                            /* Дата */
                                            1,                              /* Глава */
                                            NATCUR,                        /* Валюта */
                                            TaxPay,                         /* Сумма  Счист*/
                                            INPCARRY,                       /* Result_Carry */
                                            " 1",                           /* Kind_Oper */
                                            "",                             /* Numb_Document */
                                            "Удержание налога",
                                            null, 
                                            null,
                                            null,
                                            accountDbt.rec.Code_Currency, accountCrd.rec.Code_Currency 
                                            )
            )
                return 1;
            end;
        end;
    end;

    if(TaxPay > 0)
       ПроводкиБУ.AddNPTXObj(TaxPay, NATCUR, FD.GetPayFIID(), dat);
    end;

    return 0;
end;

macro БУ_ОбработатьТОПоКупонуЧП(FD:SPFirstDoc, dat:DATE, GrDealID:INTEGER, Type:INTEGER, _NeedNUTX:bool)
  var DlRq = TRecHandler("dlrq");
  var GrDealPrm = TRecHandler("dlgrdealprm.dbt");
  var pt = TRecHandler("party.dbt");
  var GroundStr = "";
  var NeedNUTX = false;
  var Amount = $0;

  var PayerAccountBuff    = TRecHandler("account");
  var ReceiverAccountBuff = TRecHandler("account");

  if( _NeedNUTX != null )/*Удержать налог с ЮН*/
     NeedNUTX = _NeedNUTX;
  end;

  if( Type == DLRQ_TYPE_PAYMREPOCOUP )
     GroundStr = "по выплате купонного дохода ";
  else
     GroundStr = "по выплате дохода по ЧП ";
  end;

  if( ПолучитьТОПоСтрокеГрафика(GrDealID, Type, DlRq) != 0 )
     return 1;
  end;

  if( ПолучитьПараметрыПоСтрокеГрафика(GrDealID, GrDealPrm) != 0 )
     GrDealPrm.rec.ReturnIncomeKind = FD.tick.rec.ReturnIncomeKind;
  end;

  if( GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_PAYMENT )

 /*КД Выплату по ТО не делаем */
       return 0;

    if( ТОСквитовано(DlRq) )/*ТО сквитовано, значит, проводка по нему не нужна*/
      return 0;
    end;
   
    if( not ТОЗакрыто(DlRq) )/*просто выводим сообщение и проводку по ТО не делаем, т.к. ТО должно быть сквитовано, а для сквитованного проводка по ТО не нужна*/
//      msgbox("По сделке с кодом \""+FD.tick.rec.DealCode+"\" ТО с ID = "+DlRq.rec.ID+" требуется исполнить квитовкой");
      return 0;
    end;
    
    if(ПолучитьСчетаТОПоКупонуЧП(DlRq, FD, dat, PayerAccountBuff, ReceiverAccountBuff) != 0)
      return 1;
    end;

    if( БУ_ОбработатьДенежноеТО( DlRq, PayerAccountBuff, ReceiverAccountBuff, FD, dat, "Сумма ТО " + GroundStr, NULL, NULL, _NeedNUTX ) != 0 )
       return 1;
    end;

  elif(GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF)
    var TaxCoup = $0, TaxPay = $0;

    if ( not calcTaxPayTaxCoup(GrDealID, Type, dat, @TaxPay , @TaxCoup ) )
        return 1;
    end;

    if((TaxPay > 0) and (IsInstNeresForNUTX(dlrq.rec.FactReceiverID, date) == true))
      if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), PayerAccountBuff) != 0)
        return 1;
      end;

      if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, true, null, ReceiverAccountBuff, dat, NATCUR ) ) 
          MsgBox( "Ошибка при определении счета по категории <-Бюджет, ф.налоги>." );
          return 1;
      end;

      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           PayerAccountBuff, ReceiverAccountBuff,    /* КатегДеб , КатегКредит*/
                                           dat,                            /* Дата */
                                           1,                              /* Глава */
                                           NATCUR,                         /* Валюта */
                                           TaxPay,                         /* Сумма  Счист*/
                                           INPCARRY,                       /* Result_Carry */
                                           " 1",                           /* Kind_Oper */
                                           "",                             /* Numb_Document */
                                           "Удержание налога",
                                           null, 
                                           null,
                                           null,
                                           PayerAccountBuff.rec.Code_Currency, NATCUR 
                                         )
        )
          return 1;
      end;

      if(TaxPay > 0)
        ПроводкиБУ.AddNuTaxObj(TaxPay, NATCUR, FD.GetPayFIID(), dat);
      end;
    end;
  end;

  return 0;
end;

macro REPOAmortCalcKindEIR(dealid)
   var Select = DL_RSDCommand(" select LOT.*                                              " +
                              "    from DPMWRTSUM_DBT LOT, DDL_TICK_DBT TK, DDLRQ_DBT RQ1 " +
                              "   where TK.T_DEALID = :DealID                             " +
                              "     and TK.T_BOFFICEKIND = "+DL_SECURITYDOC+"             " +
                              "     and RQ1.T_DOCKIND = TK.T_BOFFICEKIND                  " +
                              "     and RQ1.T_DOCID = TK.T_DEALID                         " +
                              "     and RQ1.T_TYPE = "+DLRQ_TYPE_PAYMENT+"                " +
                              "     and RQ1.T_DEALPART = 1                                " +
                              "     and LOT.T_DOCKIND = "+DLDOC_PAYMENT+"                 " +
                              "     and LOT.T_DOCID = RQ1.T_ID                            " +
                              "     and LOT.T_KIND = "+PM_WRTSUM_KIND_RCURR+"             " +
                              "     and LOT.T_AMORTCALCKIND = 2/* ЭПС */                  ");

   Select.AddParam(dealid);

   var DataSet = Select.Execute();

   if(DataSet.moveNext())
       return true;
   end;

   return false;
end;

private macro СписаниеНачисленногоДохода(FD2, dat, COUPON_SUM, IsPartial)
   var query, cmd, DataSet, Sum;
   var ground = "Списание начисленного дохода по ц/б, проданным из портфеля ПВО: ";
   var DebCat = IIF(IsBasket(FD2.Group), "-ОД, Корзина", "-ОД");

   query =   " select (lot2.t_BalanceCostBD - lot1.t_BalanceCostBD) as ChangeBalanceCostBD "
           + "   from v_scwrthistex lot1, v_scwrthistex lot2 "
           + "  where lot1.t_SumID = ? "
           + "    and lot1.t_ChangeDate = ? "
           + "    and lot1.t_Action = " + IIF(IsPartial, PM_WRTSUM_UPDTMODE_PARTIAL, PM_WRTSUM_UPDTMODE_COUPON)
           + "    and lot2.t_SumID = lot1.t_SumID "
           + "    and lot2.t_Instance = lot1.t_Instance - 1";

   cmd = DL_RSDCommand(query);

   cmd.AddParam(FD2.PmWrtSum.rec.SumID);
   cmd.AddParam(dat);

   DataSet = cmd.Execute();

   if(DataSet.moveNext())
      Sum = money(DataSet.ChangeBalanceCostBD); 
      if(Sum > 0)
      ground = ground + IIF(IsPartial, "списание ЧП", "списание купона");
        if( not БУ_ПроводкаПоКатегориямУчета( FD2, DebCat, "+Расчеты",
                                            dat,
                                            1,
                                              FD2.FaceFIID(),
                                            Sum,
                                              INPCARRY, " 1", FD2.tick.rec.DealCode, ground,
                                            null, null, FIROLE_EMIT_INC_TR,
                                              FD2.FaceFIID(), FD2.fininstr.rec.FaceValueFI
                                          )
        )
           return false;
      end;
   end;
   end;

   return true;
end;

macro БУ_ПроводкиПоУчетуКупонаВОбратномРепо( FD, dat, GrDealID )
   var ground = "", Sum = $0, WrtOffAmountOR = $0;
   var COUPON_SUM;
   var DlRq = TRecHandler("dlrq.dbt");
   var GrDealPrm = TRecHandler("dlgrdealprm.dbt");
   var FD2 = SPFirstDoc( LEG_KIND_DL_TICK_BACK, FD.tick.rec.DealID );

   if( ПолучитьТОПоСтрокеГрафика(GrDealID, DLRQ_TYPE_PAYMREPOCOUP, DlRq) != 0 )
     return 1;
   end;

   COUPON_SUM = DlRq.rec.Amount;

   if( FD.FaceFIID() != DlRq.rec.FIID )
      if( SmartConvertSum(COUPON_SUM, COUPON_SUM, dat, DlRq.rec.FIID, FD.FaceFIID(), true) == false )
         return 1;
      end;
   end;

   if( not IsClientDeal(FD.tick.rec) )
      Sum = COUPON_SUM - БУ_ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.dl_leg.rec.DealID, DLSUM_KIND_SUM_COUPON_INCOME_BACK);
      ground = "Доначисление купонного дохода";
      if( not БУ_ПроводкаПоКатегориямУчета( FD, "+Расчеты", "-Расчеты",
                                            dat,
                                            1,
                                            FD.fininstr.rec.FaceValueFI,
                                            Sum,
                                            INPCARRY, " 1", FD.tick.rec.DealCode, ground,
                                            null, FIROLE_EMIT_INC_TR, FIROLE_EMIT_INC_OB,
                                            FD.fininstr.rec.FaceValueFI, FD.fininstr.rec.FaceValueFI
                                          )
        )
         return 1;
      end;

      if( ПолучитьПараметрыПоСтрокеГрафика(GrDealID, GrDealPrm) != 0 )
         GrDealPrm.rec.ReturnIncomeKind = FD.tick.rec.ReturnIncomeKind;
      end;

      if( GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF )
         Sum = COUPON_SUM;
         ground = "Списание полученного купонного дохода";
         if( not БУ_ПроводкаПоКатегориямУчета( FD, "-Расчеты", "+ОД",
                                               dat,
                                               1, 
                                               FD.FaceFIID(),
                                               Sum,
                                               INPCARRY, " 1", FD.tick.rec.DealCode, ground,
                                               null, FIROLE_EMIT_INC_OB, null,
                                               FD.fininstr.rec.FaceValueFI, FD.GetPayFIID()
                                             )
           )
            return 1;
         end;
      end;

      if( not СписаниеНачисленногоДохода(FD2, dat, COUPON_SUM, false) )
         return 1;
      end;
   end;
/*
   if( not IsClientDeal(FD.tick.rec) )
      WrtOffAmountOR = GetWrtOffAmountOR(FD, dat);
      if( WrtOffAmountOR > $0 )
         Sum = COUPON_SUM / FD.dl_leg.rec.Principal * WrtOffAmountOR;
         ground = "Списание полученного купонного дохода";
         if( not БУ_ПроводкаПоКатегориямУчета( FD, "-Маржа, ц/б", "+Расчеты", 
                                               dat,
                                               1, 
                                               FD.fininstr.rec.FaceValueFI,
                                               Sum, 
                                               INPCARRY, " 1", FD.tick.rec.DealCode, ground, 
                                               null, GetFIRoleByPortfolio(KINDPORT_SALE), FIROLE_EMIT_INC_TR,
                                               NATCUR, FD.fininstr.rec.FaceValueFI
                                             )
           )
            return 1;
         end;
      end;
   end;
*/
   if( БУ_ОбработатьТОПоКупонуЧП(FD, dat, GrDealID, DLRQ_TYPE_PAYMREPOCOUP) != 0 )
     return 1;
   end;

   if(REPOAmortCalcKindEIR(FD.tick.rec.Dealid)) 
      if( not БУ_ВыполнитьДоначислениеПроцентовВРепо(FD2, dat) )
         return 1;
      end;
      if( not БУ_ВыполнитьНачислениеПоДенЛотуРепо(FD, dat, GrDealID) )
         return 1;
      end;
   end;

   return 0;
end;

macro БУ_ПроводкиПоУчетуКупонаВПрямомРепо( FD, dat, GrDealID )
   VAR AccCredit = "", FIIDCredit, j = 0, CatDebet, Bpp = false, AccDebet, FIIDDebet, Глава;
   var PortfolioSum = TDataPortfSumCoupon(); /* сбор сумм лотов по портфелям */
   var DlRq = TRecHandler("dlrq.dbt");
   var GrDealPrm = TRecHandler("dlgrdealprm.dbt");
   var FD2 = SPFirstDoc( LEG_KIND_DL_TICK_BACK, FD.tick.rec.DealID );
   var ground = "";

   FD2.SetCurPFI(FD.CurPFI());

   if( ПолучитьТОПоСтрокеГрафика(GrDealID, DLRQ_TYPE_PAYMREPOCOUP, DlRq) != 0 )
     return 1;
   end;

   if( not IsClientDeal(FD.tick.rec) )

      if (ТОЗакрыто(FD2.GetRQ(DLRQ_TYPE_DELIVERY)))
//       Bpp = false;
         Bpp = true;
      else
         Bpp = true;
      end;

      var cmd, dataSet;

      cmd = DL_RSDCommand(" select t_Kind, t_Sum " +
                          "   from ddlsum_dbt " +
                          "  Where t_DocKind  = ? " +
                          "    and t_DocID    = ? " +
                          "    and t_Date     = ? " + 
                          "    and t_Currency = ? " +
                          "    and t_FIID     = ? " );

      cmd.AddParam(DL_SECURITYDOC);
      cmd.AddParam(FD2.tick.rec.DealID);
      cmd.AddParam(dat);
      cmd.AddParam(FD2.fininstr.rec.FaceValueFI);
      cmd.AddParam(FD2.CurPFI());

      dataSet = cmd.Execute();
      while( dataSet.moveNext() )
         PortfolioSum.AddLine2(dataSet.Kind, dataSet.Sum);
      end;

      j = 0;
      while( j < PortfolioSum.Size )

         if( PortfolioSum(j).Portfolio != KINDPORT_BACK ) /* не из ПВО */

            if( PortfolioSum(j).BonusAdd != 0 )

               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     "-Премия, ц/б", "Премия, ц/б", /* КатегДеб, КатегКредит */
                                                     dat,                         /* Дата */
                                                     Глава,                       /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     PortfolioSum(j).BonusAdd,    /* Сумма  SдоначПр*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     "",                          /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     "Доначисление премии",
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, false, false, Bpp, false, true),
                                                     GetFIRoleByPortfolioBonus(PortfolioSum(j).Portfolio,Bpp)
                                                   )
                 )
                  return 1;
               end;

            end;

            if(PortfolioSum(j).DiscountIncomeAdd != 0 )
               Глава = 1;
                Ground = "Доначисление дисконтного дохода по " + GetFinName(FD.fininstr.rec) + " по прямому РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;

               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     "Начисл.ПДД, ц/б", "+%ДЦ/б",       /* КатегДеб, КатегКредит*/
                                                     dat,                         /* Дата */
                                                     Глава,                       /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).DiscountIncomeAdd),   /* Сумма  Sдонач.ДД*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Доначисление дисконтного дохода"*/,
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false, Bpp),
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false),
                                                     FD.fininstr.rec.FaceValueFI, NATCUR
                                                   )
                 )
                  return 1;
               end;
            end;

            if( (PortfolioSum(j).IncomeSum - PortfolioSum(j).NKD - PortfolioSum(j).InterestIncomeSum + PortfolioSum(j).InterestIncomeAdd) != 0 )

               AccDebet  = "Начисл.ПДД, ц/б";
               AccCredit  = "+%ДЦ/б";
               Глава = 1;
                Ground = "Доначисление купонного дохода по " + GetFinName(FD.fininstr.rec) + " по прямому РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;

               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                                                     dat,                         /* Дата */
                                                     Глава,                       /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).IncomeSum - PortfolioSum(j).NKD - PortfolioSum(j).InterestIncomeSum + PortfolioSum(j).InterestIncomeAdd),   /* Сумма  Sдонач.ПД*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Доначисление купонного дохода"*/,
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, false, true, Bpp),
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, false, true),
                                                     FD.fininstr.rec.FaceValueFI, NATCUR
                                                   )
                 )
                  return 1;
               end;
            end;

            var AccounttedDefDiffAdd = PortfolioSum(j).AccountedDefDiffAdd;
            if( AccounttedDefDiffAdd != 0 )
               AccDebet  = IIF(AccounttedDefDiffAdd > 0, "-КорЭПС_%, ц/б", "-Маржа, ц/б");   
               AccCredit = IIF(AccounttedDefDiffAdd > 0, "+Маржа, ц/б", "+КорЭПС_%, ц/б"); 
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                      dat,                         /* Дата */
                      1,                           /* Глава */
                      NATCUR,                      /* Валюта */
                      abs(AccounttedDefDiffAdd),   /* Сумма корректировки до ЭПС*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Корректировка отсроченной разницы"
                     ) 
                 )
                   return 1;
               end;   
            end;
           
            var CorrIntToEIRAdd = PortfolioSum(j).CorrIntToEIRAdd;
            /*
            if( CorrIntToEIRAdd != 0 )
               AccDebet  = IIF(CorrIntToEIRAdd > 0, "+Корректировка, ц/б", "-КорЭПС_%, ц/б");
               AccCredit = IIF(CorrIntToEIRAdd > 0, "+КорЭПС_%, ц/б", "-Корректировка, ц/б");  
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                      dat,                         /* Дата */
                      1,                           /* Глава */
                      NATCUR,                      /* Валюта */
                      abs(CorrIntToEIRAdd),        /* Сумма корректировки до ЭПС*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Корректировка % до ЭПС", null,
                      GetFIRoleByPortfolio(PortfolioSum(j).Portfolio),
                      GetFIRoleByPortfolio(PortfolioSum(j).Portfolio)
                     ) 
                 )
                   return 1;
               end;            
            end;*/

         end;

         if( ПолучитьПараметрыПоСтрокеГрафика(GrDealID, GrDealPrm) != 0 )
            GrDealPrm.rec.ReturnIncomeKind = FD.tick.rec.ReturnIncomeKind;
         end;

         /* списание */
         if( GrDealPrm.rec.ReturnIncomeKind != 0 ) /* задан способ возврата */

            FIIDDebet = FD.fininstr.rec.FaceValueFI;
            if (GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF)
               CatDebet = "-ОД";
               FIIDDebet = FD.GetPayFIID();
            elif(GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_PAYMENT)
               CatDebet = "+Расчеты";
               FIIDDebet = DlRq.rec.FIID;
            else
               CatDebet = "Undef";
            end;

            if (PortfolioSum(j).Portfolio != KINDPORT_BACK) // не из ПВО
                Ground = "Списание начисленного купона по " + GetFinName(FD.fininstr.rec) + " по прямому РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " при погашении купона ";

               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     CatDebet, "Начисл.ПДД, ц/б", /* КатегДеб , КатегКредит*/
                                                     dat,                         /* Дата */
                                                     1,                           /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).IncomeSum - PortfolioSum(j).NKD),  /* Сумма  начисленного ПД */
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Списание купонного дохода"*/,
                                                     null,
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, false, true, Bpp),
                                                     FIIDDebet, FD.fininstr.rec.FaceValueFI
                                                   )
                 )
                  return 1;
               end;

               var NKDCatCred:string = "";
               if(ВедениеСчетовБПППоВыпуску() == true)
                 if(ОтдельныйУчетУплНКД())
                      NKDCatCred = "Уплаченный НКД";
                   else
                      NKDCatCred = "Наш портфель ц/б";
                   end;
                 else
                 if(ОтдельныйУчетУплНКД())
                      NKDCatCred = IIF(IsBasket(FD.Group), "Уплач. НКД, Корзина БПП", "Уплаченный НКД, БПП");
                 else
                    NKDCatCred = IIF(IsBasket(FD.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
                 end;
               end;

                Ground = "Списание уплаченного купона по " + GetFinName(FD.fininstr.rec) + " по прямому РЕПО № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " при погашении купона ";

               if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                     CatDebet, NKDCatCred,        /* КатегДеб, КатегКредит*/
                                                     dat,                         /* Дата */
                                                     1,                           /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).NKD),    /* Сумма уплаченного НКД */
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     Ground/*"Списание купонного дохода"*/,
                                                     null, null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, false, true, Bpp),
                                                     FIIDDebet, FD.fininstr.rec.FaceValueFI
                                                    ) 
                 )
                  return 1;
               end;

            else
               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     CatDebet, "+Расчеты",        /* КатегДеб , КатегКредит*/
                                                     dat,                         /* Дата */
                                                     1,                           /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).IncomeSum),/* Сумма  - сумма купона по 1 цб* кол-во ц/б , проданное из ПВО*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     "Списание суммы купона",
                                                     null,
                                                     null,
                                                     FIROLE_EMIT_INC_TR,
                                                     FIIDDebet, FD.fininstr.rec.FaceValueFI
                                                    )
                 )
                  return 1;
               end;

            end;
         end;

         j = j + 1;
      end;
   end; 
/*КД*/
   if( БУ_ОбработатьТОПоКупонуЧП(FD, dat, GrDealID, DLRQ_TYPE_PAYMREPOCOUP, true) != 0 )
     return 1;
   end;

   if( IsClientDeal(FD.tick.rec) )
   if( ПолучитьПараметрыПоСтрокеГрафика(GrDealID, GrDealPrm) == 0 )
    if (  FD.СделкаОРЦБ() )
/*
        if ( ПроводкиБиржевогоПРЕПОПоУчетуКупона(FD, dat , GrDealID, DlRq,  DLRQ_TYPE_PAYMREPOCOUP, GrDealPrm.rec.ReturnIncomeKind)  ) 
          return 1;
        end;
*/
    else
        if ( ПроводкиНЕБиржевогоПРЕПОПоУчетуКупона(FD, dat, GrDealID, DlRq, DLRQ_TYPE_PAYMREPOCOUP, GrDealPrm.rec.ReturnIncomeKind) )
          return 1;
        end;
    end;
  end;
   end;

   if(REPOAmortCalcKindEIR(FD.tick.rec.Dealid)) 
      if( not БУ_ВыполнитьДоначислениеПроцентовВРепо(FD2, dat) )
         return 1;
      end;
      if( not БУ_ВыполнитьНачислениеПоДенЛотуРепо(FD, dat, GrDealID) )
         return 1;
      end;
   end;

   return 0;
end;

macro БУ_ПроводкиПоУчетуЧПВОбратномРепо(FD, dat, GrDealID)
   var ground = "", Sum = $0, WrtOffAmountOR = $0;
   var DlRq = TRecHandler("dlrq.dbt");
   var GrDealPrm = TRecHandler("dlgrdealprm.dbt");
   var FD2 = SPFirstDoc( LEG_KIND_DL_TICK_BACK, FD.tick.rec.DealID );
   var COUPON_SUM;

   if( ПолучитьТОПоСтрокеГрафика(GrDealID, DLRQ_TYPE_PAYMREPOPART, DlRq) != 0 )
     return 1;
   end;

   COUPON_SUM = DlRq.rec.Amount;

   if( FD.FaceFIID() != DlRq.rec.FIID )
      if( SmartConvertSum(COUPON_SUM, COUPON_SUM, dat, DlRq.rec.FIID, FD.FaceFIID(), true) == false )
         return 1;
      end;
   end;

   if( not IsClientDeal(FD.tick.rec) )
      Sum = COUPON_SUM - БУ_ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.dl_leg.rec.DealID, DLSUM_KIND_SUM_PARTIAL_INCOME_BACK, null, null, IIF(IsBasket(FD.Group), FD.CurPFI(), null));
      ground = "Доначисление дохода по ЧП";
      if( not БУ_ПроводкаПоКатегориямУчета( FD, "+Расчеты", "-Расчеты", 
                                            dat,
                                            1, 
                                            FD.fininstr.rec.FaceValueFI,
                                            Abs(Sum),
                                            INPCARRY, " 1", FD.tick.rec.DealCode, ground, 
                                            null, FIROLE_EMIT_INC_TR, FIROLE_EMIT_INC_OB,
                                            FD.fininstr.rec.FaceValueFI, FD.fininstr.rec.FaceValueFI
                                          )
        )
         return 1;
      end;

      if( ПолучитьПараметрыПоСтрокеГрафика(GrDealID, GrDealPrm) != 0 )
         GrDealPrm.rec.ReturnIncomeKind = FD.tick.rec.ReturnIncomeKind;
      end;

      if( GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF )
         Sum = COUPON_SUM;
         ground = "Списание полученного дохода по ЧП";
         if( not БУ_ПроводкаПоКатегориямУчета( FD, "-Расчеты", "+ОД",
                                               dat,
                                               1, 
                                               FD.FaceFIID(),
                                               Abs(Sum), 
                                               INPCARRY, " 1", FD.tick.rec.DealCode, ground, 
                                               null, FIROLE_EMIT_INC_OB, null,
                                               FD.fininstr.rec.FaceValueFI, FD.GetPayFIID()
                                             )
           )
            return 1;
         end;
      end;

      if( not СписаниеНачисленногоДохода(FD2, dat, COUPON_SUM, true) )
         return 1;
      end;
   end;
/*
   if( not IsClientDeal(FD.tick.rec) )
      WrtOffAmountOR = GetWrtOffAmountOR(FD, dat);
      if (WrtOffAmountOR > $0)
         Sum = COUPON_SUM / FD.dl_leg.rec.Principal * WrtOffAmountOR;
         ground = "Списание полученного дохода по ЧП";
         if( not БУ_ПроводкаПоКатегориямУчета( FD, "-Маржа, ц/б", "+Расчеты", 
                                               dat,
                                               1, 
                                               FD.fininstr.rec.FaceValueFI,
                                               Abs(Sum), 
                                               INPCARRY, " 1", FD.tick.rec.DealCode, ground, 
                                               null, null, FIROLE_EMIT_INC_TR,
                                               NATCUR, FD.fininstr.rec.FaceValueFI
                                             )
           )
            return 1;
         end;
      end;
   end;
*/
   if( БУ_ОбработатьТОПоКупонуЧП(FD, dat, GrDealID, DLRQ_TYPE_PAYMREPOPART) != 0 )
     return 1;
   end;

   if( not БУ_ВыполнитьДоначислениеПроцентовВРепо(FD2, dat) )
      return 1;
   end;
   if( not БУ_ВыполнитьНачислениеПоДенЛотуРепо(FD, dat, GrDealID) )
      return 1;
   end;

   return 0;
end;

macro БУ_ПроводкиПоУчетуЧПВПрямомРепо( FD, dat, GrDealID )
   VAR CatCred = "", AccCredit = "", FIIDCredit, j = 0, CatDebet, Bpp = false, AccDebet, FIIDDebet, Глава;
   var DlRq = TRecHandler("dlrq.dbt");
   var GrDealPrm = TRecHandler("dlgrdealprm.dbt");
   var FD2 = SPFirstDoc( LEG_KIND_DL_TICK_BACK, FD.tick.rec.DealID );
   var Query, cmd, DataSet;
   var PortfolioSum = TDataPortfSumPartial(); /* сбор сумм лотов по портфелям */   
   var DebSum = $0;
   
   FD2.SetCurPFI(FD.CurPFI());
   
   if( ПолучитьТОПоСтрокеГрафика(GrDealID, DLRQ_TYPE_PAYMREPOPART, DlRq) != 0 )
     return 1;
   end;

   if( not IsClientDeal(FD.tick.rec) )

      AccDebet  = "Начисл.ПДД, ц/б";
      FIIDDebet = FD.fininstr.rec.FaceValueFI;

      AccCredit  = "+%ДЦ/б";
      FIIDCredit = NATCUR;

      Глава = 1;

      if( ТОЗакрыто(FD2.GetRQ(DLRQ_TYPE_DELIVERY)) )
         Bpp = false;
      else
         Bpp = true;
      end;

      /* соберем суммы по портфелям */
      cmd = DL_RSDCommand(" select t_Kind, t_Sum " +
                          "   from ddlsum_dbt  " +
                          "  Where t_DocKind  = ? " +
                          "    and t_DocID    = ? " +
                          "    and t_Date     = ? " + 
                          "    and t_Currency = ? " +
                          "    and t_FIID     = ? " );

      cmd.AddParam(DL_SECURITYDOC);
      cmd.AddParam(FD2.tick.rec.DealID);
      cmd.AddParam(dat);
      cmd.AddParam(FD2.fininstr.rec.FaceValueFI);
      cmd.AddParam(FD2.CurPFI());

      dataSet = cmd.Execute();
      while (dataSet.moveNext())
        PortfolioSum.AddLine2(dataSet.Kind, dataSet.Sum);
      end;

      j = 0;
      while (j < PortfolioSum.size)
         if (PortfolioSum(j).Portfolio != KINDPORT_BACK) /* не из ПВО */

            if( PortfolioSum(j).DiscountIncomeAdd != $0 ) 
               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     AccDebet, AccCredit,               /* КатегДеб, КатегКредит*/
                                                     dat,                               /* Дата */
                                                     Глава,                             /* Глава */
                                                     FD.fininstr.rec.FaceValueFI,       /* Валюта */
                                                     PortfolioSum(j).DiscountIncomeAdd, /* Сумма  Sдонач.ДДi*/
                                                     INPCARRY,                          /* Result_Carry */
                                                     " 1",                              /* Kind_Oper */
                                                     "",                                /* Numb_Document */
                                                     "Доначисление дисконтного дохода",
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false, Bpp),
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false),
                                                     FIIDDebet, FIIDCredit
                                                   )
                 )
                  return 1;
               end;
            end;

            if( CheckCalcDiscountWithoutPartly() and (PortfolioSum(j).Discount0_korr != $0) ) 
               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     AccDebet, AccCredit,               /* КатегДеб, КатегКредит*/
                                                     dat,                               /* Дата */
                                                     Глава,                             /* Глава */
                                                     FD.fininstr.rec.FaceValueFI,       /* Валюта */
                                                     PortfolioSum(j).Discount0_korr,    /* Сумма Дисконт0_корр*/
                                                     INPCARRY,                          /* Result_Carry */
                                                     " 1",                              /* Kind_Oper */
                                                     "",                                /* Numb_Document */
                                                     "Дополнительное начисление дисконтного дохода",
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false, Bpp),
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false),
                                                     FIIDDebet, FIIDCredit
                                                   )
                 )
                  return 1;
               end;
            end;

            var BonusAdd = PortfolioSum(j).BonusAdd;
            if( BonusAdd != 0 )
               if( not БУ_ПроводкаПоКатегориямУчета( FD,
                                                  "-Премия, ц/б", "Премия, ц/б", /* КатегДеб, КатегКредит */
                                                  dat,                               /* Дата */
                                                  1,                                 /* Глава */
                                                  FD.fininstr.rec.FaceValueFI,       /* Валюта */
                                                  abs(BonusAdd),                     /* Сумма */
                                                  INPCARRY,                          /* Result_Carry */
                                                  " 1",                              /* Kind_Oper */
                                                  "",                                /* Numb_Document */
                                                  "Списание начисленной премии на расходы",
                                                  null,
                                                  GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, false, false, Bpp, false, true),
                                                  GetFIRoleByPortfolioBonus(PortfolioSum(j).Portfolio, Bpp)
                                                )
                 )
                  return 1;
               end;
            end;

            var AccounttedDefDiffAdd = PortfolioSum(j).AccountedDefDiffAdd + PortfolioSum(j).DefDiff0_korr;
            if( AccounttedDefDiffAdd != 0 )
               AccDebet  = IIF(AccounttedDefDiffAdd > 0, "-КорЭПС_%, ц/б", "-Маржа, ц/б");   
               AccCredit = IIF(AccounttedDefDiffAdd > 0, "+Маржа, ц/б", "+КорЭПС_%, ц/б"); 
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                      dat,                         /* Дата */
                      1,                           /* Глава */
                      NATCUR,                      /* Валюта */
                      abs(AccounttedDefDiffAdd),   /* Сумма корректировки до ЭПС*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Корректировка отсроченной разницы"
                     ) 
                 )
                   return 1;
               end;   
            end;
           
            var CorrIntToEIRAdd = PortfolioSum(j).CorrIntToEIRAdd;
            if( CorrIntToEIRAdd != 0 )
               AccDebet  = IIF(CorrIntToEIRAdd > 0, "+Корректировка, ц/б", "-КорЭПС_%, ц/б");
               AccCredit = IIF(CorrIntToEIRAdd > 0, "+КорЭПС_%, ц/б", "-Корректировка, ц/б");  
               if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                      AccDebet, AccCredit,         /* КатегДеб , КатегКредит*/
                      dat,                         /* Дата */
                      1,                           /* Глава */
                      NATCUR,                      /* Валюта */
                      abs(CorrIntToEIRAdd),        /* Сумма корректировки до ЭПС*/
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Корректировка % до ЭПС", null,
                      GetFIRoleByPortfolio(PortfolioSum(j).Portfolio),
                      GetFIRoleByPortfolio(PortfolioSum(j).Portfolio)
                     ) 
                 )
                   return 1;
               end;            
            end;

         end;

         if( ПолучитьПараметрыПоСтрокеГрафика(GrDealID, GrDealPrm) != 0 )
            GrDealPrm.rec.ReturnIncomeKind = FD.tick.rec.ReturnIncomeKind;
         end;

         // списание
         if( GrDealPrm.rec.ReturnIncomeKind != 0 ) // задан способ возврата

            FIIDDebet = FD.fininstr.rec.FaceValueFI;
            if( GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_WRTOFF )
               CatDebet = "-ОД";
               FIIDDebet = FD.GetPayFIID();
            elif( GrDealPrm.rec.ReturnIncomeKind == SP_RETURNINCOME_PAYMENT )
               CatDebet = "+Расчеты";
            else
               CatDebet = "Undef";
            end;
            if (PortfolioSum(j).Portfolio != KINDPORT_BACK) // не из ПВО
               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     CatDebet, "Начисл.ПДД, ц/б", /* КатегДеб , КатегКредит*/
                                                     dat,                         /* Дата */
                                                     1,                           /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).DiscountIncomeSum), /* Сумма  начисленного ДД */
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     "Списание дисконтного дохода и сумм амортизации",
                                                     null,
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false, Bpp),
                                                     FIIDDebet, FD.fininstr.rec.FaceValueFI
                                                   )
                 )
                  return 1;
               end;


               if(ВедениеСчетовБПППоВыпуску() == true)
                 CatCred = "Наш портфель ц/б";
               else
                 CatCred = IIF(IsBasket(FD.Group), "Ц/б, Корзина БПП", "Ц/б, БПП");
               end;

               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     CatDebet, CatCred,           /* КатегДеб , КатегКредит*/
                                                     dat,                         /* Дата */
                                                     1,                           /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).IncomeSum - PortfolioSum(j).DiscountIncomeSum), /* Сумма  - разница между полученной суммой ЧП и начисленным ДД */
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     "Списание дисконтного дохода и сумм амортизации",
                                                     null,
                                                     null,
                                                     GetFIRoleByPortfolio(PortfolioSum(j).Portfolio, true, false, Bpp),
                                                     FIIDDebet, FD.fininstr.rec.FaceValueFI
                                                   )
                 )
                  return 1;
               end;
            else
               if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                                     CatDebet, "+Расчеты",        /* КатегДеб , КатегКредит*/
                                                     dat,                         /* Дата */
                                                     1,                           /* Глава */
                                                     FD.fininstr.rec.FaceValueFI, /* Валюта */
                                                     Abs(PortfolioSum(j).IncomeSum),              /* Сумма  - сумма ЧП по 1 цб* кол-во ц/б, проданное из ПВО*/
                                                     INPCARRY,                    /* Result_Carry */
                                                     " 1",                        /* Kind_Oper */
                                                     "",                          /* Numb_Document */
                                                     "Списание суммы ЧП",
                                                     null,
                                                     null,
                                                     FIROLE_EMIT_INC_TR,
                                                     FIIDDebet, FD.fininstr.rec.FaceValueFI
                                                   )
                 )
                  return 1;
               end;
            end;
         end;

         j = j + 1;
      end; 
   end; 
   
   if( БУ_ОбработатьТОПоКупонуЧП(FD, dat, GrDealID, DLRQ_TYPE_PAYMREPOPART) != 0 )
     return 1;
   end;

   if( not БУ_ВыполнитьДоначислениеПроцентовВРепо(FD2, dat) )
      return 1;
   end;
   if( not БУ_ВыполнитьНачислениеПоДенЛотуРепо(FD, dat, GrDealID) )
      return 1;
   end;

   return 0;
end;

macro БУ_УчетПоставкиПриПогашенииЦБ( FD, dat )
   var MarketAcc = "", Amount = $0;
   var PayerAccountBuff = TRecHandler( "account" );
   var ReceiverAccountBuff = TRecHandler( "account" );
   var ReceiverAccount, ReceiverFIID;
   var rq_money = TRecHandler("dlrq.dbt");
   var GroundPog = "";
   var summa = $0, currency = NATCUR;
   rq_money = FD.GetRQ(DLRQ_TYPE_PAYMENT);

   if( БУ_УчетПредварительныхЗатрат(FD, dat, FD.tick.rec.PREOUTLAY, FD.tick.rec.PREOUTLAYFIID) == false )
      return 1;
   end;

   /*Сумму заносить без НКД для купонных ц/б - см. 138113*/ 
      if (FD.tick.rec.Number_Coupon != "")
         Amount = rq_money.rec.Amount - FD.dl_leg.rec.NKD;
      else
         Amount = rq_money.rec.Amount;
      end;

   if( ( IsBROKER(FD.Group) ) OR (FD.СделкаОРЦБ()) )
      /*переинициализируем платежи, если надо выполняем необходимые конвертации сумм*/ 

      if( ПолучитьСчетКонтрагентаПоТООплаты( rq_money, FD, dat, PayerAccountBuff, ReceiverAccountBuff ) != 0)
        return 1;
      end;

      if( not IsClientDeal(FD.tick.rec) )
         /*в неклиентских по кредиту счет "Реализация, ц/б(НацВ)"*/
         ReceiverAccount = СчетПолученияСредствЗаПогашение( FD, null, true );
         ReceiverFIID = NATCUR;
      else
         if( ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), ReceiverAccountBuff) != 0)
           return 1;
         end;

         ReceiverAccount = ReceiverAccountBuff;
         ReceiverFIID = ReceiverAccountBuff.rec.Code_Currency;//FD.GetPayFIID();
      end;
      if( FD.FaceFIID() != ReceiverFIID)
          if( not SmartConvertSum( summa, Amount, dat, FD.FaceFIID, ReceiverFIID, true))
              return false;
          end;
          currency = ReceiverFIID;
      else
          summa = Amount;
      end; 
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            PayerAccountBuff, ReceiverAccount,/* КатегДеб , КатегКредит*/
            dat,                  /* Дата */
            1,                   /* Глава */
               currency,             /* Валюта */
               summa,                /* Сумма  */
            INPCARRY,             /* Result_Carry */
            " 1",                 /* Kind_Oper */
            "",                   /* Numb_Document */
            "Сумма контрактива", null,null,null,
            rq_money.rec.FIID, ReceiverFIID    /* валюты счетов: Дт - Кт */ 
           ) )
         return 1;
      end;
      
      if( FD.tick.rec.Number_Coupon != "")
         summa = FD.dl_leg.rec.NKD;
         currency = FD.dl_leg.rec.NKDFIID;

         if( FD.NKDFIID() != FD.GetPayFIID())
             if( not SmartConvertSum( summa, FD.dl_leg.rec.NKD, dat, FD.NKDFIID(), FD.GetPayFIID(), true))
                 return false;
             end;
             currency = FD.GetPayFIID();
         end; 

         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
               PayerAccountBuff, IIF( not IsClientDeal(FD.tick.rec), ReceiverAccount, ReceiverAccountBuff),/* КатегДеб , КатегКредит*/
               dat,                  /* Дата */
               1,                   /* Глава */
               currency,              /* Валюта */
               summa,                 /* Сумма  */
               INPCARRY,             /* Result_Carry */
               " 1",                 /* Kind_Oper */
               "",                   /* Numb_Document */
               "Сумма НКД", null,null,null,
               FD.GetPayFIID(), IIF( not IsClientDeal(FD.tick.rec),  ReceiverFIID, FD.GetPayFIID())     /* валюты счетов: Дт - Кт */ 
              ) )
            return 1;
         end;
      end;

   else
      if( not IsClientDeal(FD.tick.rec) )
          if( rq_money.rec.FIID != FD.GetPayFIID())
              if( not SmartConvertSum( summa, Amount, dat, rq_money.rec.FIID, FD.GetPayFIID(), true))
                 return false;
              end;
              Amount = summa;
         end;
         summa = FD.dl_leg.rec.NKD;
         currency = FD.dl_leg.rec.NKDFIID;

         if( FD.NKDFIID() != FD.GetPayFIID())
             if( not SmartConvertSum( summa, FD.dl_leg.rec.NKD, dat, FD.NKDFIID(), FD.GetPayFIID(), true))
                 return false;
             end;
             currency = FD.GetPayFIID();
         end; 

         GroundPog = "Выплата купонного дохода по ЦБ " + GetFinName(FD.fininstr.rec) + ", гос. рег. " + User_GetLsin(FD.fininstr.rec.fiid);

         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                СчетСписанияСредствЗаПогашение( FD ), СчетПолученияСредствЗаПогашение( FD, null, true ),/* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                currency,                    /* Валюта */
                summa,                       /* Сумма */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                GroundPog,/*"Зачисление средств владельца ц/б"*/
                null, null, null, 
                IIF(((СчетСписанияСредствЗаПогашение( FD ) == "+Расчеты") or (СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш")), FD.FaceFIID, FD.GetPayFIID()), IIF(СчетПолученияСредствЗаПогашение( FD, null, true ) == "Реализация, ц/б", NATCUR, FD.GetPayFIID())   
               ) 
           )
             return 1;
         end;

         GroundPog = "Выплата номинальной стоимости при погашении по ЦБ " + GetFinName(FD.fininstr.rec) + ", гос. рег. " + User_GetLsin(FD.fininstr.rec.fiid);

         if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                СчетСписанияСредствЗаПогашение( FD ), СчетПолученияСредствЗаПогашение( FD, null, true ),/* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                FD.GetPayFIID(),             /* Валюта */
                Amount,                      /* Сумма */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                GroundPog/*"Зачисление средств владельца ц/б"*/
               , null,null,null,
                IIF(((СчетСписанияСредствЗаПогашение( FD ) == "+Расчеты") or (СчетСписанияСредствЗаПогашение( FD ) == "+РасчетыПогаш")), FD.FaceFIID, FD.GetPayFIID()), IIF(СчетПолученияСредствЗаПогашение( FD, null, true ) == "Реализация, ц/б", NATCUR, FD.GetPayFIID())   
               ) 
           )
             return 1;
         end;
      end;
   end;

   return 0;
end;

macro БУ_ПроводкиОплатыПриПогашенииЦБ(FD, dat)
   var MarketAcc = "", Amount = $0;
   var PayerAccountBuff = TRecHandler( "account" );
   var ReceiverAccountBuff = TRecHandler( "account" );
   var PayerCat = "";
   var ReceiverCat = "";
   var AccountBuff = TRecHandler("account");
   var rq_money = TRecHandler("dlrq.dbt");
   var summa = $0, currency = NATCUR;
   var GroundPog = "";
   if( FD.tick.rec.CarryWrt != SET_CHAR )
      return 0;
   end;

   if( (not IsClientDeal(FD.tick.rec)) AND (IsBROKER(FD.Group) OR FD.СделкаОРЦБ()) )
      return 0; /*208856*/
   end;

   rq_money = FD.GetRQ(DLRQ_TYPE_PAYMENT);
   
   if( ТОСквитовано(rq_money) )/*если ТО сквитовано, то проводка по ТО не нужна*/
      return 0;
   end;
   
   if( not IsClientDeal(FD.tick.rec) )
     if( ПолучитьНашСчетТОПоОплате( rq_money, FD, dat, PayerAccountBuff, ReceiverAccountBuff, @PayerCat, @ReceiverCat ) != 0)
       return 1;
     end;
   else
     if( ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), AccountBuff) != 0)
       return 1;
     end;

     if(SP_RqIsSale( rq_money, FD.tick ))
       ReceiverAccountBuff = AccountBuff;
     else
       PayerAccountBuff = AccountBuff;
     end;
   end;

   if( ПолучитьСчетКонтрагентаПоТООплаты( rq_money, FD, dat, PayerAccountBuff, ReceiverAccountBuff ) != 0)
     return 1;
   end;

   /*Сумму заносить без НКД для купонных ц/б - см. 138113*/
      if (FD.tick.rec.Number_Coupon != "")
         Amount = rq_money.rec.Amount - FD.dl_leg.rec.NKD;
      else
         Amount = rq_money.rec.Amount;
      end;  

   summa = Amount;
   currency = rq_money.rec.FIID;

   if( FD.FaceFIID() != FD.GetPayFIID())
     if( not SmartConvertSum( summa, Amount, dat, FD.FaceFIID, FD.GetPayFIID(), true))
        return false;
     end;
     currency = FD.GetPayFIID();
   end; 

   if( not IsClientDeal(FD.tick.rec) )

      GroundPog = "Выплата номинальной стоимости при погашении по ЦБ " + GetFinName(FD.fininstr.rec) + ", гос. рег. " + User_GetLsin(FD.fininstr.rec.fiid) + ", количество " + UserGetKol(FD.dl_leg.rec.Principal, FD.fininstr.rec.avoirkind) + ".";
      if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            PayerAccountBuff, ReceiverAccountBuff,/* КатегДеб , КатегКредит*/
            dat,                  /* Дата */
            1,                   /* Глава */
            currency,  /* Валюта */
            summa,               /* Сумма  */
            INPCARRY,             /* Result_Carry */
            " 1",                 /* Kind_Oper */
            "",                   /* Numb_Document */
            GroundPog/*"Сумма ТО по оплате"*/, null,null,null,
            rq_money.rec.FIID, IIF(((ReceiverCat == "+Расчеты") or (ReceiverCat == "+РасчетыПогаш")), FD.FaceFIID, FD.GetPayFIID())     /* валюты счетов: Дт - Кт */ 
           ) )
         return 1;
      end;

      summa = FD.dl_leg.rec.NKD;
      currency = rq_money.rec.FIID;

      if( FD.NKDFIID() != FD.GetPayFIID())
        if( not SmartConvertSum( summa, FD.dl_leg.rec.NKD, dat, FD.NKDFIID(), FD.GetPayFIID(), true))
           return false;
        end;
        currency = FD.GetPayFIID();
      end;

         if( FD.tick.rec.Number_Coupon != "" )
         GroundPog = "Выплата купонного дохода по ЦБ " + GetFinName(FD.fininstr.rec) + ", гос. рег. " + User_GetLsin(FD.fininstr.rec.fiid) + ", количество " + UserGetKol(FD.dl_leg.rec.Principal, FD.fininstr.rec.avoirkind) + ".";
            if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                  PayerAccountBuff, ReceiverAccountBuff,/* КатегДеб , КатегКредит*/
                  dat,                  /* Дата */
                  1,                   /* Глава */
                  currency,  /* Валюта */
                  summa,     /* Сумма  */
                  INPCARRY,             /* Result_Carry */
                  " 1",                 /* Kind_Oper */
                  "",                   /* Numb_Document */
                  GroundPog/*"Сумма НКД"*/, null,null,null,
                  rq_money.rec.FIID, IIF(((ReceiverCat == "+Расчеты") or (ReceiverCat == "+РасчетыПогаш")), FD.FaceFIID, FD.GetPayFIID())     /* валюты счетов: Дт - Кт */ 
                 ) )
               return 1;
            end;
         end;    
   END; 
   return 0;
end;
