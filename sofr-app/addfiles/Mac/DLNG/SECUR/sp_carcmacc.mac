/*
$Name:        sp_carcmacc.mac
$Module:      Ценные бумаги
$Description: Процедуры для проводок по суммам комиссий в операциях с ценными бумагами
*/
IMPORT "sp_caracc.mac", "scservop.mac", "sccomiss.mac", "sp_voop.mac", "dlcontrfunc.mac";

MACRO БУ_РольДляКатегорииРасчеты( FD )
   if( IsOUTEXCHANGE( FD.Group ) )
      return FIROLE_SETTL_CONTR;
   end;
   return null;
END;

PRIVATE MACRO GETACCOUNTKOM(ID, Curr)
    var Select, DataSet, Query;
  var DtAccount = TRecHandler("account");
    Query =  "select doc.* from dmccateg_dbt cat, dmcaccdoc_dbt doc where cat.t_LevelType = 1 and cat.t_number = 201 and doc.t_CatID = cat.t_ID and doc.t_clientcontrid = ? and doc.t_currency = ? and doc.t_iscommon = 'X'";
    Select = DL_RSDCommand(Query);
    Select.AddParam(ID);
    Select.AddParam(Curr);

    DataSet = Select.Execute(Query);
    if(DataSet.MoveNext())
       if(GetAccount(1, Curr, DataSet.account , DtAccount, false ) == 0)
           return false;
       else
          setparm(2, DtAccount);
          return true;
       end;
    end;
    return false;

END;

MACRO БУ_РольДляКатегорииКлиринговыйСчет( FD )
   if( IsClientDeal(FD.tick.rec) )
      return FIROLE_MONEYSOURCE_CLIENT;
   else
      return FIROLE_MONEYSOURCE_OWN;
   end;
END;

private macro ОпределитьСущественностьЗатрат(FD, DataSet, ЗатратыСущественные:@bool):integer
  var pRQ;
  var CostRUB = $0, SumNoNDSRUB = $0, PortfolioID = KINDPORT_UNDEF;

  ЗатратыСущественные = false;

  if( IsREPO(FD.Group) )
     if( IsSALE(FD.Group) )
        PortfolioID = KINDPORT_CURR_AC_BPP;
     else
        PortfolioID = KINDPORT_CURR_AC_PVO;
     end;
  else
     PortfolioID = FD.tick.rec.PortfolioID;
  end;

  pRQ = FD.GetRQ(DLRQ_TYPE_PAYMENT,1).rec;

  if( SmartConvertSum(CostRUB, money(pRQ.Amount), pRQ.PlanDate, pRQ.FIID, NATCUR, true) != true )
     return 1;
  end;

  /*по ТЗ существенность считаем по сумме комиссий без НДС*/
  if( SmartConvertSum(SumNoNDSRUB, money(DataSet.Sum-DataSet.NDS), date(DataSet.PLANPAYDATE), DataSet.FIID_Comm, NATCUR, true) != true )
     return 1;
  end;
  if( IsEssentialSumByContrCost(pRQ.PlanDate,PortfolioID,SumNoNDSRUB,CostRUB) == 1 )
    ЗатратыСущественные = true;
  end;

  return 0; 
end;

private macro БУ_УчетЗатратПоКомиссии( FD, DataSet, CarDate:DATE, RatePVO:DOUBLE, ЗатратыСущественные:bool, CommNotPVO:@MONEY ):BOOL

  MACRO ПроводкиВПокупке( CatCredit:STRING, FIRoleCredit:INTEGER, CredFIID:INTEGER, ОднаПроводка:bool ):BOOL
     var Sum = IIF(ОднаПроводка, money(DataSet.Sum), money(DataSet.Sum-DataSet.NDS) );
     var DebCateg:string = IIF((not ЗатратыСущественные) or (FD.ТипПортфеля() == KINDPORT_TRADE), "-КВ, затраты, ц/б", IIF(FD.ТипПортфеля() == KINDPORT_CONTR, "Наш портфель ПКУ, ц/б", "Наш портфель ц/б"));
     var DebFIID = IIF((not ЗатратыСущественные) or (FD.ТипПортфеля() == KINDPORT_TRADE), NATCUR, FD.ВалютаНоминалаПКУ(DebCateg));
     var tmpSum = Sum;
     Var ground = "";
     PRIVATE VAR fininstr = TRecHandler( "fininstr" );

     If(not ЗатратыСущественные)
        Ground = "Отнесение на расходы несущественной комиссии торговой системы на покупку ценной бумаги " + GetFinName(fininstr.rec) + " по сделке № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
     else
        Ground = "Отнесение на счет вложений существенной комиссии торговой системы на покупку ценной бумаги " + GetFinName(fininstr.rec) + " по сделке № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;
     end;
//Отнесение на расходы несущественной комиссии торговой системы на покупку ценной бумаги SU29008RMFS8 по сделке 2849768656 от 02/07/2018
     ConvSumCross( Sum, tmpSum, CarDate, int(DataSet.FIID_Comm), DebFIID );
/*Не делать по переходящим*/
     If(FD.tick.rec.dealdate >= MGRDate)
     if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                           DebCateg, CatCredit,     /* КатегДеб, КатегКредит*/
                                           CarDate,                 /* Дата */
                                           1 ,                      /* Глава */
                                           DebFIID,                 /* Валюта */
                                           Sum,                     /* Сумма */
                                           SPCOMMISSION,            /* Result_Carry */
                                           " 1",                    /* Kind_Oper */
                                           FD.tick.rec.DealCode,    /* Numb_Document */
                                           Ground/*"Учет затрат по комиссии "*//* + DataSet.Code*/, /* Ground */
                                           /*IIF((CatCredit=="-Биржа"), USED_MINUSEXCHANGE_CREDIT, 0)*/0,
                                           null, FIRoleCredit,
                                           DebFIID, CredFIID
                                         )
       )
        return not SayErrorBuySale( FD.tick.rec, SC_GetCarryError() );
     end;
     end;
     if( not ОднаПроводка )
        if( not БУ_ПроводкаПоКатегориямУчета( FD,                           
                                              "+НДС", CatCredit,        /* КатегДеб , КатегКредит*/      
                                              CarDate,                  /* Дата */                       
                                              1 ,                       /* Глава */                      
                                              int(DataSet.FIID_Comm),   /* Валюта */
                                              money(DataSet.NDS),       /* Сумма */                      
                                              SPCOMMISSION,             /* Result_Carry */               
                                              " 1",                     /* Kind_Oper */                  
                                              FD.tick.rec.DealCode,     /* Numb_Document */              
                                              "Учет затрат по НДС с комиссии "/* + DataSet.Code*/,/* Ground */                   
                                              /*IIF((CatCredit=="-Биржа"), USED_MINUSEXCHANGE_CREDIT, 0)*/0,
                                              null, FIRoleCredit,
                                              NATCUR, CredFIID                                            
                                             )
          )                                                         
           return not SayErrorBuySale( FD.tick.rec, SC_GetCarryError() );
        end;

        if( not БУ_ПроводкаПоКатегориямУчета( FD,                           
                                              "-Налог", "+НДС",         /* КатегДеб , КатегКредит*/      
                                              CarDate,                  /* Дата */                       
                                              1 ,                       /* Глава */                      
                                              int(DataSet.FIID_Comm),   /* Валюта */
                                              money(DataSet.NDS),       /* Сумма */                      
                                              SPCOMMISSION,             /* Result_Carry */               
                                              " 1",                     /* Kind_Oper */                  
                                              FD.tick.rec.DealCode,     /* Numb_Document */              
                                              "Отнесение НДС на расходы",/* Ground */                   
                                              /*IIF((CatCredit=="-Биржа"), USED_MINUSEXCHANGE_CREDIT, 0)*/0,
                                              null, null,
                                              NATCUR, NATCUR                                            
                                             )
          )                                                         
           return not SayErrorBuySale( FD.tick.rec, SC_GetCarryError() );
        end;

     end;
     return true;
  END;

  MACRO ПроводкиВПродаже( CatCredit:STRING, FIRoleCredit:INTEGER, CommNotPVO:MONEY, CommPVO:MONEY, CredFIID:INTEGER ):BOOL
     Var ground = "";
     PRIVATE VAR fininstr = TRecHandler( "fininstr" );

     if(CommNotPVO != $0)
     ПолучитьФинИн( FD.tick.rec.PFI, fininstr );
     Ground = "Отнесение на счет реализации комиссии торговой системы на продажу ценной бумаги " + GetFinName(fininstr.rec) + " по сделке № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;

   If(FD.tick.rec.dealdate > MGRDate)
       if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                             /*IIF((not ЗатратыСущественные), IIF(IsEXCHANGE(FD.Group), "-КВ, др", "-КВ, ц/б"), */"Реализация, ц/б"/*)*/, CatCredit,   /* КатегДеб , КатегКредит*/
                                             CarDate,                 /* Дата */
                                             1 ,                      /* Глава */
                                             int(DataSet.FIID_Comm),  /* Валюта */
                                             CommNotPVO,              /* Сумма */
                                             SPCOMMISSION,            /* Result_Carry */
                                             " 1",                    /* Kind_Oper */
                                             FD.tick.rec.DealCode,    /* Numb_Document */
                                             Ground/*"Учет затрат по комиссии "*//* + DataSet.Code*/,   /* Ground */
                                             /*IIF((CatCredit=="-Биржа"), USED_MINUSEXCHANGE_CREDIT, 0)*/0, 
                                             NULL, FIRoleCredit, 
                                             NATCUR, CredFIID
                                           )
         )
          return not SayErrorBuySale( FD.tick.rec, SC_GetCarryError() );
       end;
     end;
   end;
     if(CommPVO != $0)
        ПолучитьФинИн( FD.tick.rec.PFI, fininstr );

        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                              /*IIF(IsEXCHANGE(FD.Group), "-КВ, др", "-КВ, ц/б")*/"Реализация, ц/б", CatCredit,  /* КатегДеб , КатегКредит*/
                                              CarDate,                 /* Дата */
                                              1 ,                      /* Глава */
                                              int(DataSet.FIID_Comm),  /* Валюта */
                                              CommPVO,                 /* Сумма */
                                              SPCOMMISSION,            /* Result_Carry */
                                              " 1",                    /* Kind_Oper */
                                              FD.tick.rec.DealCode,    /* Numb_Document */
                                              "Учет затрат по комиссии "/* + DataSet.Code */+ ", приходящихся на ц/б, проданные из ПВО. ЦБ " + GetFinName(fininstr.rec) + " по сделке № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate,   /* Ground */
                                              /*IIF((CatCredit=="-Биржа"), USED_MINUSEXCHANGE_CREDIT, 0)*/0, 
                                              NULL, FIRoleCredit, 
                                              NATCUR, CredFIID
                                            )
          )
           return not SayErrorBuySale( FD.tick.rec, SC_GetCarryError() );
        end;
     end;

     if(money(DataSet.NDS) != $0)
        if( not БУ_ПроводкаПоКатегориямУчета( FD, 
                                              "+НДС", CatCredit,        /* КатегДеб , КатегКредит*/
                                              CarDate,                  /* Дата */
                                              1 ,                       /* Глава */
                                              int(DataSet.FIID_Comm),   /* Валюта */
                                              money(DataSet.NDS),       /* Сумма */
                                              SPCOMMISSION,             /* Result_Carry */
                                              " 1",                     /* Kind_Oper */
                                              FD.tick.rec.DealCode,     /* Numb_Document */
                                              "Учет затрат по НДС с комиссии "/* + DataSet.Code*/,/* Ground */                   
                                              /*IIF((CatCredit=="-Биржа"), USED_MINUSEXCHANGE_CREDIT, 0)*/0, 
                                              null, FIRoleCredit, 
                                              NATCUR, CredFIID
                                            )
          )
           return not SayErrorBuySale( FD.tick.rec, SC_GetCarryError() );
        end;
     end;

     return true;
  END;

  VAR CatCredit = NULL, FIRoleCredit, CredFIID = int(DataSet.FIID_Comm), 
      CommPVO = $0, PreOutlayPVO = $0, 
      Dp = FD.DateArray[DATE_DEALSETAVOIRISS],
      Dk = date(DataSet.PlanPayDate),
      ОднаПроводка = false,
      PreOutlayNotPVO = $0;

  FD.DateArray[DATE_DEALCOMISS] = Dk;
  CommNotPVO = $0;

  if( IsClientDeal(FD.tick.rec) OR IsREPO(FD.Group) )
     return 0;
  end;

  /*Проводки 1С*/
  if( IsBuy( FD.Group ) )
     if( Dk > Dp )
        CatCredit = "-Расчеты";
        FIRoleCredit = БУ_РольДляКатегорииРасчеты( FD );
     elif( Dk == Dp ) 
        if( ( not IsBROKER( FD.Group ) ) AND ( not FD.СделкаОРЦБ() ) AND (not CheckComissOver50905()) )
           CatCredit   = "+Расчеты";
           FIRoleCredit = БУ_РольДляКатегорииРасчеты( FD );
        elif( IsBROKER( FD.Group ) )
           CatCredit  = "Брокер";
        elif( FD.СделкаОРЦБ() )
           if( УчетБиржКомиссииНаКлирСчете() and (not ЗатратыСущественные) )
              CatCredit = "Клиринговый счет (комис.)";
              FIRoleCredit = БУ_РольДляКатегорииКлиринговыйСчет( FD );
           else
              CatCredit = "+Биржа";
           end;
        end;
     elif( Dk <  Dp )
        if( not CheckComissOver50905() )
           CatCredit   = "+Расчеты";
           FIRoleCredit = БУ_РольДляКатегорииРасчеты( FD );
        else
           CatCredit = "Предв.затраты, ц/б";
           CredFIID = NATCUR;
        end;
        if( УчетНДСВМоментОплатыКом() )
           ОднаПроводка = true;
        end;
     end;

     if( CatCredit != NULL )
        if( ПроводкиВПокупке( CatCredit, FIRoleCredit, CredFIID, ОднаПроводка, ЗатратыСущественные ) == false )
           return 1;
        end;
     end;
  else /*Продажи, погашения*/

     if( Dk > Dp )
        CatCredit   = "-Расчеты";
        FIRoleCredit = БУ_РольДляКатегорииРасчеты( FD );

     elif( Dk <  Dp )
        if( not CheckComissOver50905() )
        CatCredit   = "+Расчеты";
        FIRoleCredit = БУ_РольДляКатегорииРасчеты( FD );
        else
           CatCredit = "Предв.затраты, ц/б";
           CredFIID = NATCUR;
        end;

     elif( Dk == Dp) /*Dк = Dп и сделка на ОРЦБ или через брокера*/

        if( (FD.СделкаОРЦБ() == true) )
           if( УчетБиржКомиссииНаКлирСчете() and (not ЗатратыСущественные) )
              CatCredit = "Клиринговый счет (комис.)";
              FIRoleCredit = БУ_РольДляКатегорииКлиринговыйСчет( FD );
           else
              CatCredit = "+Биржа";
           end;
        elif( IsBROKER( FD.Group ) )
           CatCredit  = "Брокер";

        elif( IsOUTEXCHANGE( FD.Group ) OR  /*внебиржевая сделка или (биржевая и не ОРЦБ) */
              ( IsEXCHANGE( FD.Group ) AND 
                (FD.СделкаОРЦБ() == false)
              )
            )
           CatCredit  = "+Расчеты";
           FIRoleCredit = БУ_РольДляКатегорииРасчеты( FD );
        end;
     end;

     if( CatCredit != NULL )
        if (CatCredit == "Предв.затраты, ц/б")
           PreOutlayNotPVO = money(FD.tick.rec.PreOutlay);
           if( RatePVO != null )   
              PreOutlayNotPVO = ROUND(PreOutlayNotPVO*RatePVO, 2);
              PreOutlayPVO = money(FD.tick.rec.PreOutlay) - PreOutlayNotPVO;
           end;      
        end;
        if( RatePVO == null )
           CommNotPVO = money(DataSet.Sum) - money(DataSet.NDS) + PreOutlayNotPVO;
        else
           CommNotPVO = ROUND( (money(DataSet.Sum) - money(DataSet.NDS))*RatePVO, 2 ) + PreOutlayNotPVO;
        end;
        CommPVO = (money(DataSet.Sum) - money(DataSet.NDS) - CommNotPVO) + PreOutlayPVO;

        if( CommPVO < $0 )
           CommPVO = $0;
        end;

        if( ПроводкиВПродаже( CatCredit, FIRoleCredit, CommNotPVO, CommPVO, CredFIID, ЗатратыСущественные ) == false )
           return 1;
        end;
     end;
  end; 
  CommNotPVO = CommNotPVO + CommPVO;
  return 0;
end;

macro БУ_УчетЗатратПоКомиссиямСделки( FD, CarDate:DATE, RatePVO:DOUBLE, CommNotPVO:@MONEY, СommFIID:@INTEGER ):BOOL
  var sql, DataSet, CommNotPVO_, СommFIID_, AllCommNotPVO, AllСommFIID, ExistCom = false;
  var ЗатратыСущественные = false;

  sql = RSDCommand( "select min(comis.T_ID), comis.T_Immaterial, comis.T_PLANPAYDATE, sum(comis.T_SUM) T_SUM, sum(comis.T_NDS) T_NDS, SfCom.t_FIID_Comm, /*SfCom.t_Code,*/ SfCom.t_ReceiverID " +       
                    "  from DDLCOMIS_DBT comis, dsfcomiss_dbt SfCom " +
                    " where comis.T_DOCKIND = ? " +
                    "   and comis.T_DOCID   = ? " +
                    "   and SfCom.t_FeeType = comis.T_FEETYPE " +
                    "   and SfCom.t_Number  = comis.T_COMNUMBER " +
                    "   and sfcom.T_SERVICEKIND = ? "
                    "GROUP BY comis.T_Immaterial, comis.T_PLANPAYDATE, SfCom.t_FIID_Comm, SfCom.t_ReceiverID " 
                  );
  sql.addParam( "", RSDBP_IN, FD.tick.rec.BofficeKind );
  sql.addParam( "", RSDBP_IN, FD.tick.rec.DealID );
  sql.addParam( "", RSDBP_IN, PTSK_STOCKDL );

  sql.execute();                                 
                                                    
  DataSet = TRsbDataSet(sql);                    
                                              
  while(DataSet.MoveNext())

     if( ОпределитьСущественностьЗатрат( FD, DataSet, @ЗатратыСущественные ) != 0 )
        return 1;
     end;

     if( БУ_УчетЗатратПоКомиссии( FD, DataSet, CarDate, RatePVO, ЗатратыСущественные, @CommNotPVO_ ) != 0)
        return 1;
     end;
/*
     if( not ЗатратыСущественные )/*учитываем только существенные*/
        continue;
     end;
*/
     //первый вход
     if(not ExistCom)
        AllCommNotPVO = CommNotPVO_;
        AllСommFIID = int(DataSet.FIID_Comm);
     else
        if( SmartConvertSum( CommNotPVO_, CommNotPVO_, CarDate, int(DataSet.FIID_Comm), AllСommFIID, true ) == false )
           return 1;
        end; 
        AllCommNotPVO = AllCommNotPVO + CommNotPVO_;
     end;
     ExistCom = true;
  end;                                           

  if (ExistCom)
     CommNotPVO = AllCommNotPVO;
     СommFIID   = AllСommFIID;
  else
     CommNotPVO = $0;
     СommFIID   = NATCUR;
  end;

  return 0;
end; 

macro БУ_ОплатитьКомиссию( FD, dat, DataSet )
  var pRQ;
  var ОднаПроводка = true;
  var DtAccount = TRecHandler("account");
  var CtAccount = TRecHandler("account");
  var ВидРО = 0;
  var Sum = $0, CategCode = "", Mode = 0;
  var FiRole = 0;
  var GroundCom = "";
  var Code, DlDate;
  pRQ = FD.GetRQByCom(DataSet.ID,true);
  var DtAccountKlCom = TRecHandler("account");
  Var notetxt;
  var ComEqRUB;/*CHVA 518805*/
  if( pRQ.rec.ID <= 0 )
     return 1;
  end;

  //кусочек проводок 2З - оплата клиентских комиссий банку
  if( IsClientDeal(FD.tick.rec) and (int(DataSet.ReceiverID) == {OurBank})) // клиентская комиссия банку
     if( ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, DataSet.PartyID, DLRQ_SUBKIND_CURRENCY, pRQ.rec.FIID, DtAccount) != 0)
        return 1;
     end;

     GetDlContrCode(FD.tick.rec.clientcontrid, Code, DlDate);
     GroundCom = "Брокерская комиссия. Сделка № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate /* KOA ID : 534182 dat */ + " " + GetFinName(FD.fininstr.rec) + " по брок.дог." + Code + " от " + DlDate + ". НДС не облагается";

//          Только по переходящим сделкам
            If(FD.tick.rec.dealdate < date("01.01.2019"))
                 if(not БУ_ПроводкаПоКатегориямУчета( FD, /*FIROLE_COMISS_CLIENT*/
                                            "+РасчетыКомисс1", "+КВ, ц/б", /* КатегДеб , КатегКредит*/
                                            dat,                  /* Дата */
                                            1,              /* Глава */
                                            FD.GetPayFIID(),      /* Валюта */
                                            money(DataSet.Sum),          /* Сумма  */
                                            INPCARRY,             /* Result_Carry */
                                            " 1",                 /* Kind_Oper */
                                            "",                   /* Numb_Document */
                                            GroundCom/*"Комиссия . Клиентская. Сделка N " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + "по ЦБ " + GetFinName(FD.fininstr.rec)*/,
                                             0,null,FIROLE_COMISS_CLIENT/*null*/,
                                             FD.GetPayFIID(), 0     /* валюты счетов: Дт - Кт */ 
                                          )
                    )
                      return 1;
                  end;
            end;

/* Было Отложенное исполнение с пересчетом комиссии */

         notetxt = readNoteForObject(OBJTYPE_SECDEAL, L_Z(FD.tick.rec.dealid, 34 ), 203);
         if(notetxt != 0)
               
             /* CHVA 518805 проводка должна быть по курсу за дату начисления комиссии*/
           if (DataSet.FIID_Comm != NATCUR)
            if( SmartConvertSum(ComEqRUB, money(notetxt), DataSet.date, DataSet.FIID_Comm, NATCUR, true) != true )
               return 1;
            end;
           end;
             /*CHVA 518805*/

             if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                    "+КВ, ц/б", "+РасчетыКомисс1", 
                    dat,                 /* Дата */ 
                    1,                   /* Глава */
                    int(DataSet.FIID_Comm),/* Валюта */
                    money(notetxt),  /* Сумма */
                    SPCOMMISSION,        /* Result_Carry */
                    " 1",                /* Kind_Oper */
                    FD.tick.rec.DealCode,/* Numb_Document */
                    "Корректировка начисления комиссии в связи с отложенным исполнением сделки ", /*"Сумма комиссии " + DataSet.Code,*/         /* Ground */
                    null,FIROLE_COMISS_CLIENT,FIROLE_COMISS_CLIENT,
                    NATCUR,DataSet.FIID_Comm/*NATCUR*/,
                    IIF(ComEqRUB != null,NATCUR,null),ComEqRUB                    /*CHVA 518805*/ 
                   ) )
                 return 1;
             end;

         end;


     if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            DtAccount, "+РасчетыКомисс1"/*"+КВ, ц/б"*/,/* КатегДеб , КатегКредит*/
            dat,                 /* Дата */
            1,                   /* Глава */
            int(DataSet.FIID_Comm),/* Валюта */
            money(DataSet.Sum),  /* Сумма */
            SPCOMMISSION,        /* Result_Carry */
            " 1",                /* Kind_Oper */
            FD.tick.rec.DealCode,/* Numb_Document */
            GroundCom, /*"Сумма комиссии " + DataSet.Code,*/         /* Ground */
            null,null,FIROLE_COMISS_CLIENT,
            DtAccount.rec.Code_Currency,DataSet.FIID_Comm/*NATCUR*/
           ) )
         return 1;
     end;

     if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            DtAccount, "-НДС",/* КатегДеб , КатегКредит*/
            dat,                 /* Дата */
            1,                   /* Глава */
            int(DataSet.FIID_Comm),/* Валюта */
            money(DataSet.NDS),  /* Сумма */
            SPCOMMISSION,        /* Result_Carry */
            " 1",                /* Kind_Oper */
            FD.tick.rec.DealCode,/* Numb_Document */
            "Сумма комиссии "/* + DataSet.Code*/,         /* Ground */
            null,null,null,
            DtAccount.rec.Code_Currency,NATCUR
           ) )
         return 1;
     end;
  elif(IsClientDeal(FD.tick.rec) and (DataSet.IsBankExpenses == SET_CHAR) and (DataSet.PartyID == {OurBank}))
     
     GetDlContrCode(FD.tick.rec.clientcontrid, Code, DlDate);
     
     if(int(DataSet.FIID_Comm) == NATCUR)
       if(int(DataSet.ReceiverID) == MMVB_ID()) //ММВБ
         FiRole = FIROLE_OPCL_MOEX_NAT;
       elif(int(DataSet.ReceiverID) == SPB_ID()) //СПБ
         FiRole = FIROLE_OPCL_SPB_NAT;
       end;
     else
       if(int(DataSet.ReceiverID) == MMVB_ID()) //ММВБ
         FiRole = FIROLE_OPCL_MOEX_FRG;
       elif(int(DataSet.ReceiverID) == SPB_ID()) //СПБ
         FiRole = FIROLE_OPCL_SPB_FRG;
       end;
     end;

     if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            "-КВ, др, кл", "-Расчеты",/* КатегДеб , КатегКредит*/
            dat,                 /* Дата */
            1,                   /* Глава */
            int(DataSet.FIID_Comm),/* Валюта */
            money(DataSet.Sum),  /* Сумма */
            SPCOMMISSION,        /* Result_Carry */
            " 1",                /* Kind_Oper */
            FD.tick.rec.DealCode,/* Numb_Document */
            "Начисление комиссии биржи. Сделка N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + " " + GetFinName(FD.fininstr.rec) + " по брок.дог." + Code + " от " + DlDate + ". НДС не облагается", /* Ground */
            null,FiRole,null,
            NATCUR,int(DataSet.FIID_Comm)
           ) )
         return 1;
     end;

     if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            "-Расчеты", "+Биржа", /* КатегДеб , КатегКредит*/
            dat,                 /* Дата */
            1,                   /* Глава */
            int(DataSet.FIID_Comm),/* Валюта */
            money(DataSet.Sum),  /* Сумма */
            SPCOMMISSION,        /* Result_Carry */
            " 1",                /* Kind_Oper */
            FD.tick.rec.DealCode,/* Numb_Document */
            "Комиссия биржи. Сделка N " + UserGetDealCode(FD) + " от " + FD.tick.rec.DealDate + " " + GetFinName(FD.fininstr.rec) + " по брок.дог." + Code + " от " + DlDate + ". НДС не облагается", /* Ground */
            null,null,null,
            int(DataSet.FIID_Comm), int(DataSet.FIID_Comm)
           ) )
         return 1;
     end;

  else
  /* остаток проводок 2З и все 1З */

     var Dk = date(DataSet.PlanPayDate);    
     FD.DateArray[DATE_DEALCOMISS] = Dk;

     if( ПолучитьСчетКонтрагентаПоТООплатыКомиссии( pRQ, FD, dat, CtAccount, int(DataSet.ReceiverID), @CategCode ) != 0)
        msgbox("Ошибка при определении счета контрагента по ТО оплаты комиссии");
        return 1;
     end;

     if( CategCode == "+Биржа" )
//        Mode = USED_MINUSEXCHANGE_CREDIT;
     end;

     if( not IsClientDeal(FD.tick.rec) )
        if( ПолучитьНашСчетТОПоОплатеКомиссии(FD, dat, DtAccount, @ОднаПроводка, pRQ) != 0 )
           msgbox("Ошибка при определении счета ТО по оплате комиссии");
           return 1;
        end;                                                                              
     else     
        if( ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, DataSet.PartyID, DLRQ_SUBKIND_CURRENCY, pRQ.rec.FIID, DtAccount) != 0)
           msgbox("Ошибка при получения счета субъекта \"" + ПолучитьКороткоеИмяСубъекта(DataSet.PartyID) + "\" по сделке");
           return 1;
        end;
     end;

     
     if( IsClientDeal(FD.tick.rec) )
        GetDlContrCode(FD.tick.rec.clientcontrid, Code, DlDate);
        GroundCom = "Комиссия биржи. Сделка N " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + " " + GetFinName(FD.fininstr.rec) + " по брок.дог." + Code + " от " + DlDate + ". НДС не облагается";
//        groundCom = "Возмещение комиссии Биржи. Клиентская. Сделка N " + FD.tick.rec.dealcode + " от " + FD.tick.rec.dealdate + " по ЦБ " + GetFinName(FD.fininstr.rec);

           Sum = IIF(ОднаПроводка, money(DataSet.Sum), money(DataSet.Sum-DataSet.NDS) );
        var Dк = FD.DateArray[DATE_DEALCOMISS];
        var Dп = FD.DateArray[DATE_DEALSETAVOIRISS];

        if ( (Dк < Dп) and ( CheckComissOver50905() ) )
          Sum = money( Sum + FD.tick.rec.PreOutlay); 
        end;
//             DtAccountKlCom
//        FD.IsExistAccount("ДС клиента, ц/б" , null, true, null, DtAccountKlCom, null, dat, DataSet.FIID_Comm);
 // 
           IF( (GETACCOUNTKOM(FD.tick.rec.clientcontrid, DataSet.FIID_Comm, DtAccountKlCom)) and (DtAccount.rec.Code_Currency != 0) ) 

                 if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                        DtAccountKlCom/*"+РасчетыКомисс"*/, "+РасчетыКомисс1",/*CtAccount,*//* КатегДеб , КатегКредит*/
                        dat,                 /* Дата */
                        1,                   /* Глава */
                        int(DataSet.FIID_Comm),/* Валюта */
                        Sum,              /* Сумма */
                        SPCOMMISSION,        /* Result_Carry */
                        " 1",                /* Kind_Oper */
                        FD.tick.rec.DealCode,/* Numb_Document */
         //               "Сумма комиссии "/* + DataSet.Code*/,         /* Ground */
                        groundCom,
                        Mode,null,null,
                        DtAccountKlCom.rec.Code_Currency,CtAccount.rec.Code_Currency
                       ) )
                     return 1; // в случае ошибки сообщение будет в стеке ошибок
                 end;


           ELSE


                 if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                        DtAccount/*"+РасчетыКомисс"*/, "+РасчетыКомисс1",/*CtAccount,*//* КатегДеб , КатегКредит*/
                        dat,                 /* Дата */
                        1,                   /* Глава */
                        int(DataSet.FIID_Comm),/* Валюта */
                        Sum,              /* Сумма */
                        SPCOMMISSION,        /* Result_Carry */
                        " 1",                /* Kind_Oper */
                        FD.tick.rec.DealCode,/* Numb_Document */
         //               "Сумма комиссии "/* + DataSet.Code*/,         /* Ground */
                        groundCom,
                        Mode,null,null,
                        DtAccount.rec.Code_Currency,CtAccount.rec.Code_Currency
                       ) )
                     return 1; // в случае ошибки сообщение будет в стеке ошибок
                 end;
           END;
     else
       // groundCom = "Комиссия бирже ";
       /*28.04.2020 RAS 509186*/
        var dealTypeGround = " ";
        if( FD.tick.rec.dealtype == 12127 )
          dealTypeGround = "прямого РЕПО ";
        elif( FD.tick.rec.dealtype == 12122 )
          dealTypeGround = "обратного РЕПО ";
        elif( FD.tick.rec.dealtype == 12123 )
          dealTypeGround = "обратного РЕПО с КСУ ";
        elif( FD.tick.rec.dealtype == 12128 )
          dealTypeGround = "прямого РЕПО с КСУ ";
        elif( (FD.tick.rec.dealtype == 12143) or (FD.tick.rec.dealtype == 12144) or (FD.tick.rec.dealtype == 12198) )
          dealTypeGround = "покупки ";
        elif( (FD.tick.rec.dealtype == 12153) or (FD.tick.rec.dealtype == 12154) or (FD.tick.rec.dealtype == 12199) )
          dealTypeGround = "продажи ";
        end;
        groundCom = "Комиссия торговой системы по сделке " + dealTypeGround + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + ", ценная бумага " + GetFinName(FD.fininstr.rec);
        /*If(IsBuy( FD.Group ))
           groundCom = "Учет комиссии торговой системы на покупку ценной бумаги " + GetFinName(FD.fininstr.rec) + " по сделке " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;  //'Отнесение на расходы несущественной комиссии торговой системы на покупку ценной бумаги SU29008RMFS8 по сделке 2849768656 от 02/07/2018
        else
            groundCom = "Учет комиссии торговой системы на продажу ценной бумаги " + GetFinName(FD.fininstr.rec) + " по сделке " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate;  //'Отнесение на расходы несущественной комиссии торговой системы на покупку ценной бумаги SU29008RMFS8 по сделке 2849768656 от 02/07/2018
        end;*/
        /*~RAS*/
        if( DtAccount.rec.Account )

           Sum = IIF(ОднаПроводка, money(DataSet.Sum), money(DataSet.Sum-DataSet.NDS) );
/*
           If(IsClientDeal(FD.tick.rec))
              If(DataSet.number == 60)
                 GroundCom = "Биржевая комиссия на ПАО Московская биржа ММВБ-РТС при расчетах с Клиентом " + ПолучитьКороткоеИмяСубъекта(DataSet.PartyID)
                             + " по сделке № " + FD.tick.rec.DealCode + " за " + dat;
              elIf(DataSet.number == 61)
                 GroundCom = "Клиринговая комиссия на ПАО Московская биржа ММВБ-РТС при расчетах с Клиентом " + ПолучитьКороткоеИмяСубъекта(DataSet.PartyID)
                             + " по сделке № " + FD.tick.rec.DealCode + " за " + dat;
              elIf(DataSet.number == 62)
                 GroundCom = "Комиссия за ИТС на ПАО Московская биржа ММВБ-РТС при расчетах с Клиентом " + ПолучитьКороткоеИмяСубъекта(DataSet.PartyID)
                             + " по сделке № " + FD.tick.rec.DealCode + " за " + dat;
              end;
           else
              GroundCom= "Сумма комиссии " + DataSet.Code;        
           end;
*/
           if(not БУ_ПроводкаПоКатегориямУчета( FD, 
                  DtAccount, CtAccount,/* КатегДеб , КатегКредит*/
                  dat,                 /* Дата */
                  1,                   /* Глава */
                  int(DataSet.FIID_Comm),/* Валюта */
                  Sum,              /* Сумма */
                  SPCOMMISSION,        /* Result_Carry */
                  " 1",                /* Kind_Oper */
                  FD.tick.rec.DealCode,/* Numb_Document */
                  GroundCom, /*"Сумма комиссии " + DataSet.Code,*/         /* Ground */
                  Mode,null,null,
                  DtAccount.rec.Code_Currency,CtAccount.rec.Code_Currency
                 ) )
               return 1; // в случае ошибки сообщение будет в стеке ошибок
           end;
        end;
     end;

     if( not ОднаПроводка )
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
               "+НДС", CtAccount,   /* КатегДеб , КатегКредит*/
               dat,                 /* Дата */
               1,                   /* Глава */
               int(DataSet.FIID_Comm),/* Валюта */
               money(DataSet.NDS),  /* Сумма */
               SPCOMMISSION,        /* Result_Carry */
               " 1",                /* Kind_Oper */
               FD.tick.rec.DealCode,/* Numb_Document */
               "НДС с комиссии "/* + DataSet.Code*/,   /* Ground */
               Mode,null,null,
               NATCUR,CtAccount.rec.Code_Currency
              ))
            return 1; // в случае ошибки сообщение будет в стеке ошибок
        end;
     end;

     FD.DlComis.rec.ID = int(DataSet.ID);
  end;

  return 0;
end;

macro БУ_УчетВРасходахКомиссииРЕПО( FD, dat, DataSet )
  var pRQ;
  var CostRUB = $0, SumWithNDSRUB = $0, SumNoNDSRUB = $0, NdsRUB = $0;
  var ЗатратыСущественные = false;
  var Ground = "";

  if( IsClientDeal(FD.tick.rec) )
     return 0;
  end;

  pRQ = FD.GetRQByCom(DataSet.ID,true);
  
  if( pRQ.rec.ID <= 0 )
     return 1;
  end;

  /*существенность опеределяем только для комиссий по 1 части (т.е. для регсбора по 2 части считаем, что затраты несущественные)*/
  if( pRQ.rec.DealPart == 1 )
     if( ОпределитьСущественностьЗатрат( FD, DataSet, @ЗатратыСущественные ) != 0 )
        return 1;
     end;
  end;

  /*сумма комиссии с НДС*/
  if( SmartConvertSum(SumWithNDSRUB, money(DataSet.Sum), dat, DataSet.FIID_Comm, NATCUR, true) != true )
     return 1;
  end;

  if( DataSet.NDS > $0 )
     /*сумма комиссии без НДС*/
     if( SmartConvertSum(SumNoNDSRUB, money(DataSet.Sum-DataSet.NDS), dat, DataSet.FIID_Comm, NATCUR, true) != true )
        return 1;
     end;
  else
     SumNoNDSRUB = SumWithNDSRUB;
  end;
  /*28.04.2020 RAS 509186*/
  //Ground = "Отнесение на расходы несущественной комиссии торговой системы на покупку ценной бумаги " + GetFinName(FD.fininstr.rec) + " по сделке " + UserGetDealCode(FD) +" от " + FD.tick.rec.dealdate;
    var dealTypeGround = " ";
    if( FD.tick.rec.dealtype == 12127 )
      dealTypeGround = "прямого РЕПО ";
    elif( FD.tick.rec.dealtype == 12122 )
      dealTypeGround = "обратного РЕПО ";
    elif( FD.tick.rec.dealtype == 12123 )
      dealTypeGround = "обратного РЕПО с КСУ ";
    elif( FD.tick.rec.dealtype == 12128 )
      dealTypeGround = "прямого РЕПО с КСУ ";
    elif( (FD.tick.rec.dealtype == 12143) or (FD.tick.rec.dealtype == 12144) or (FD.tick.rec.dealtype == 12198) )
      dealTypeGround = "покупки ";
    elif( (FD.tick.rec.dealtype == 12153) or (FD.tick.rec.dealtype == 12154) or (FD.tick.rec.dealtype == 12199) )
      dealTypeGround = "продажи ";
    end;
    Ground = "Несущественная комиссия торговой системы по сделке " + dealTypeGround + " № " + UserGetDealCode(FD) + " от " + FD.tick.rec.dealdate + ". ЦБ " + GetFinName(FD.fininstr.rec) + ".";
  /*~RAS*/

  if(not БУ_ПроводкаПоКатегориямУчета( FD, 
         "Затраты, Репо", "РасРасх, Репо",/* КатегДеб , КатегКредит*/
         dat,                 /* Дата */
         1,                   /* Глава */
         NATCUR,              /* Валюта */
         SumWithNDSRUB,                 /* Сумма */
         SPCOMMISSION,        /* Result_Carry */
         " 1",                /* Kind_Oper */
         FD.tick.rec.DealCode,/* Numb_Document */
         Ground/*"Отнесение на расходы комиссии "*//* + DataSet.Code*/         /* Ground */
        ) )
      return 1;
  end;

  if( ЗатратыСущественные == false )
     /*сумма комиссии без НДС*/
     if(not БУ_ПроводкаПоКатегориямУчета( FD, 
            iif(IsSALE(FD.Group),"-КВ проц.расход, ц/б","-КВ проц.доход, ц/б"), "Затраты, Репо",/* КатегДеб , КатегКредит*/
            dat,                 /* Дата */
            1,                   /* Глава */
            NATCUR,              /* Валюта */
            SumNoNDSRUB,                 /* Сумма */
            SPCOMMISSION,        /* Result_Carry */
            " 1",                /* Kind_Oper */
            FD.tick.rec.DealCode,/* Numb_Document */
            Ground/*"Отнесение на расходы комиссии "*//* + DataSet.Code*/         /* Ground */
           ) )
         return 1;
     end;
     if( DataSet.NDS > $0 )
        if( SmartConvertSum(NdsRUB, money(DataSet.NDS), dat, DataSet.FIID_Comm, NATCUR, true) != true )
           return 1;
        end;
        if(not БУ_ПроводкаПоКатегориямУчета( FD, 
               "+НДС", "Затраты, Репо",   /* КатегДеб , КатегКредит*/
               dat,                 /* Дата */
               1,                   /* Глава */
               NATCUR,              /* Валюта */
               NdsRUB,                 /* Сумма */
               SPCOMMISSION,        /* Result_Carry */
               " 1",                /* Kind_Oper */
               FD.tick.rec.DealCode,/* Numb_Document */
               "Учет НДС при отнесении на расходы комиссии "/* + DataSet.Code*/   /* Ground */
              ))
            return 1;
        end;
     end;
  end;

  return 0;
end;

macro БУ_ОбработатьТОпоКомиссиям( FD, dat, pReceiver_:integer, pPayer_:integer, pIsBankExpenses:bool ) // проводки 1З, 2З - проводки оплаты комиссий

  var query, sql, DataSet;

  var pReceiver:integer = -1;
  var pPayer:integer = -1;
  var ЭтоКомиссияКлКонтрагента = false;

  if( (pReceiver_!=null) and (pReceiver_ > 0) )
     pReceiver = pReceiver_;
  end;

  if( (pPayer_!=null) and (pPayer_ > 0) )
     pPayer = pPayer_;
  end;

  if( (pPayer > 0) and (pPayer == FD.tick.rec.PartyID) )
     ЭтоКомиссияКлКонтрагента = true;
  end;

  if(pIsBankExpenses == NULL)
    pIsBankExpenses = false;
  end;

  sql = DL_RSDCommand(query);

  query =  "select min(comis.T_comnumber) t_comnumber, min(comis.T_ID) t_id, comis.T_Immaterial, comis.T_PLANPAYDATE, sum(comis.T_SUM) t_sum, sum(comis.T_NDS) t_nds, SfCom.t_FIID_Comm, /*SfCom.t_Code,*/ SfCom.t_ReceiverID, comis.t_IsBankExpenses, SfContr.t_PartyID, comis.t_date" +  /*CHVA 58805*/     
                    "  from DDLCOMIS_DBT comis, dsfcomiss_dbt SfCom, dsfcontr_dbt SfContr "+
                    " where comis.T_DOCKIND = ? "+
                    "   and comis.T_DOCID = ? "+
          "   and comis.t_IsBankExpenses = " + IIF(pIsBankExpenses==true, "'X'", "CHR(0)") +
                    "   and SfCom.t_FeeType       = comis.T_FEETYPE " +
                    "   and SfCom.t_Number        = comis.T_COMNUMBER " +
          "   and sfcom.T_SERVICEKIND   = " + PTSK_STOCKDL +
                    "   and SfContr.t_ID = comis.T_CONTRACT " +
                    IIF(pReceiver>0," and NVL((select M.T_RECEIVERID from DSFCOMISS_DBT M "+
                    "                           where M.T_FEETYPE = comis.T_FEETYPE "+
                    "                             AND M.T_NUMBER  = comis.T_COMNUMBER ),0) = " +string(pReceiver),"");
                  
  sql.addParam(FD.tick.rec.BofficeKind );
  sql.addParam(FD.tick.rec.DealID );

  if(pPayer>0)
    query = query + " and SfContr.t_PartyID = ? ";
    sql.addParam(pPayer );
  end;

  if(pIsBankExpenses == false)
    query = query + " and comis.T_PLANPAYDATE = ? ";
    sql.addParam(dat );
  end;

  query = query + "GROUP BY comis.T_Immaterial, comis.T_PLANPAYDATE, SfCom.t_FIID_Comm, SfCom.t_ReceiverID, comis.t_IsBankExpenses, SfContr.t_PartyID, comis.t_date "; /*CHVA 518805*/

                                                  
  DataSet = sql.execute(query);                    
                                              
  while(DataSet.MoveNext())

     if( IsREPO(FD.Group) and (ЭтоКомиссияКлКонтрагента == false) and (БУ_УчетВРасходахКомиссииРЕПО( FD, dat, DataSet ) != 0) )
        return 1;
     end;

     if(БУ_ОплатитьКомиссию( FD, dat, DataSet ) != 0)
        return 1;
     end;

  end;                                           

  return 0;
end;