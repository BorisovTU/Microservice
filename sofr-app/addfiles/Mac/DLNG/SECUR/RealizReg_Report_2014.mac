/*
$Name:             RealizReg_Report_2014.mac
$Module:           АРНУ
$Description:      Отчет "Регистры по реализации_2014" (НУ)
*/

IMPORT "RealizReg_Form_2014.mac", "RegistrReport.mac", "ws_txreportform.mac";

/*Здесь можно через "," в апострофах указать код (FININSTR.FI_Code) ценных бумаг, которые будут исключаться из отчета.
  Например:
    ИсключаемыеИзОтчетаЦБ = "'1','2','3'"
*/
PRIVATE VAR RealizReg_Form;
PRIVATE VAR RealizReg_Report;
PRIVATE VAR WebMenuItem; // Информация о запуске отчета из веб

PRIVATE VAR   ArrFIIDAdd = TArray; // массив бумаг для дополнительных строк, по всем листам кроме необращающихся
PRIVATE VAR   SecondStart = false; // признак второго старта по некотируемым, если галочка "некотируемые" не взведена

PRIVATE CONST BLUECOLOR  = RGB(255,255,204);

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА = 26;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ = 29;

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_biq12386 = 13;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_biq12386 = 14;

PRIVATE CONST ИсключаемыеИзОтчетаЦБ = "";
PRIVATE CONST ItogsLineName = "Всего:";
private const NoDataTxt = "ДАННЫХ НЕТ";

PRIVATE CONST SHEET_0211   = "0211";
PRIVATE CONST SHEET_0211s  = "0211_Свод";
PRIVATE CONST SHEET_0212   = "0212";
PRIVATE CONST SHEET_0212s  = "0212_Свод";
PRIVATE CONST SHEET_0213   = "0213";
PRIVATE CONST SHEET_0215   = "0215";
PRIVATE CONST SHEET_0215s  = "0215_Свод";
PRIVATE CONST SHEET_0216   = "0216";

/*имена ячеек по столбцам*/

PRIVATE VAR C_Qnty      = "F",/*совпадает для 211 и 212 и 215*/
            C_SecCode_2 = "C",/*совпадает для 211 и 212 и 215*/
            C_SecCode   = "A",/*совпадает для 211 и 212 и 215*/
            C_DifS      = "",
            C_SumBrub   = "",
            C_SumSvp = "",
            C_SumBvp = "",
            C_CrSD = "",
            C_CrBD = "",
            C_ComS = "",
            C_NDSComS = "",
            C_SumBtax = "",
            C_ComB = "",
            C_NDSComB = "",
            C_DifB = "",
            C_SumSrub = "",
            C_RashAll = "",
            C_Fin_Res = "",
            C_Taxe_All = "",
            C_NkdPrevVN = "",
            C_CoupVN = "",
            C_NkdSvp = "",
            C_AmortVNrep = "",
            C_NkdBvp = "",
            C_NKDminusRub = "",
            C_NkdRepRub = "",
            C_NkdRepRub1 = "",
            C_NkdRepRub2 = "",
            C_SumBvp_exps = "",
            C_SumAllRub = "",
            C_Taxe_NKD = "",
            C_Taxe_Amort = "",
            C_DifSumBRub = "",
            C_KSumBvn = "",
            C_AmortVN  = "",
            C_AmortVN_before = "",
            C_AmortVN_after = "",
            C_AmortVNPer = "",
            C_Nom_DDB = "",
            C_SumBNRub = "",
            C_NkdBSellRub = "",
            C_DifSumBRub_AmortPrev = "",
            C_SecType = "",
            C_NkdBrepRub = "",
            C_CodeS = "",
            C_NkdSrub = "",
            C_AmortRubrep = "",
            C_NkdBPrevRub = "",
            C_NkdPrevRub = "",
            C_CoupRub = "",
            C_SellType = "",
            C_NomH01 = "",
            C_NomH02 = "",
            C_NkdRepRubAll = "",
            C_NkdOwnVN = "",
            C_NKDownRub = "",
            C_NkdBefRub = "",
            C_NkdBefVN = "";


private macro SplitBySpace(str:string, str1:@string, str2:@string)
  var idx;

  str = Trim(str);
  idx = Index(str, " ");
  if(idx > 0)
    str1 = SubStr(str, 1, idx);
    str2 = SubStr(str, idx);
  else
    str1 = str;
    str2 = "";
  end;
end;

private macro ConvetFIO(full:string):string
  // var full = GetOperRecByID({oper}).Name;
  // var full = "  Фамилия  Имя   Отчество ";
  var idx1, idx2;
  var SurName = "";
  var FName = "";
  var SName = "";

  SplitBySpace(full, @SurName, @full);  
  SplitBySpace(full, @FName, @full);  
  SplitBySpace(full, @SName, @full);  

  if(StrLen(FName) > 0)
    FName = SubStr(FName, 1, 1) + ".";
  else
    FName = "";
  end;

  if(StrLen(SName) > 0)
    SName = SubStr(SName, 1, 1) + ".";
  else
    SName = "";
  end;

  return FName+SName+" "+SurName;
end;

private macro Oper_rshb():string
  var fio = GetOperRecByID({oper}).Name;
  return ConvetFIO(fio);
end;


PRIVATE MACRO GetNumTaxGroup(Name : string) : string
  var retval = "";
  var exec = RSDCommand( "select t_Element from dllvalues_dbt where t_List = 2903 and T_NAME = ? ");
      exec.addParam( "", RSDBP_IN, Name);
      exec.execute();

  var rs = TRsbDataSet( exec );
      if(rs.MoveNext())
        retval = string(SQL_ConvTypeInteger(rs.Element));
      end;
      return retval;
END;

PRIVATE MACRO WhereCondBond()
  return " AV.t_TaxGroup <> 0 " +
         " AND RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", FI.t_AvoirKind ) > 0 ";
         //" AND exists(SELECT fiw.t_FIID FROM dfiwarnts_dbt fiw WHERE fiw.t_IsPartial != 'X' AND FI.t_FIID = fiw.t_FIID ) ";/*проверяем, что ц\б купонная*/
END;

/*сделки с акциями, паями и депозитарными расписками*/
PRIVATE MACRO WhereCond211()
  /*с RSB_FIInstr.FI_AvrKindsEQ очень тормозит, поэтому так*/
  return " FI.t_FI_KIND = "+ FIKIND_AVOIRISS + " AND " +
         " ( FI.t_AvoirKind = "+AVOIRISSKIND_SHARE+" OR " +
         "   FI.t_AvoirKind = "+AVOIRISSKIND_EQUITY_SHARE+" OR "+
         "   FI.t_AvoirKind = "+AVOIRISSKIND_PREFERENCE_SHARE+" OR "+
         "   FI.t_AvoirKind = "+AVOIRISSKIND_DEPOSITORY_RECEIPT+" OR "+
         "   FI.t_AvoirKind = "+AVOIRISSKIND_AMERICAN_DEPREC+" OR "+
         "   FI.t_AvoirKind = "+AVOIRISSKIND_GLOBAL_DEPREC+" OR "+
         "   FI.t_AvoirKind = "+AVOIRISSKIND_RUSSIAN_DEPREC+" OR "+
         "   FI.t_AvoirKind = "+AVOIRISSKIND_EUROPEAN_DEPREC+" OR "+
         "   FI.t_AvoirKind = "+AVOIRISSKIND_INVESTMENT_SHARE+")";
END;

PRIVATE MACRO WhereCond212()
  return WhereCondBond() + " AND FI.t_FaceValueFI = " + NATCUR +
                           " AND AV.t_TaxGroup in (1, 3, 5, 7, 9, 11, 15, 17, 18, 19, 21, 25, 29, 101, 109)";
END;

PRIVATE MACRO WhereCond215()
  return WhereCondBond() + " AND FI.t_FaceValueFI != " + NATCUR +
                           " AND AV.t_TaxGroup in (31, 32, 33, 43, 130)";
END;

PRIVATE CLASS CRealizReg_211( Report:OBJECT )
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;

  MACRO QntyPrecision():INTEGER // точность кол-ва
     return m_Report.SumPrecision;
  END;

  MACRO Where():STRING
     /*0211 отбираются сделки с акциями, паями и депозитарными расписками */
     return WhereCond211();
  END;

  MACRO PaintStr()
     m_Report.SetCurrentLineFont( 8, true, false );
     m_Report.SetCellFont("N1_SumSrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N1_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N1_SumBtax", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N1_RashAll", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N1_Taxe_All",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N1_Fin_Res", 8, true, false, null, null, BLUECOLOR );
  END;

  MACRO BeginReport()
     m_Report.SetRowFlushCount(1000);
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );
     m_Report.PrintHeader_biq12386( "N1_", SHEET_0211, m_Report.GetNumSheet(), "" );
     m_Report.RegisterTable( "N1_MainTable", "N1_TableHeader",
                             "N1_Dummy1", 
                             "N1_SecCode", "N1_SecName",      "N1_CodeS",            "N1_DZS",          "N1_DDS",              "N1_Qnty",
                             "N1_VN",      "N1_VPrS",         "N1_PrSvp",            "N1_SumSvp",       "N1_SumSrub",          "N1_DifS",
                             "N1_CodeB",   "N1_DZB",          "N1_DDB",              "N1_VPrB",         "N1_PrBvp",            "N1_SumBvp",
                             "N1_SumBrub", "N1_DifB",         "N1_SumBtax",          "N1_ComS",         "N1_ComB",             "N1_NDSComS",         "N1_NDSComB",             "N1_RashAll",
                             "N1_RFISSS",  "N1_RFISSB",       "N1_DRS",              "N1_CrSD",         "N1_CrSZ",             "N1_Cr_Val_MrkSZ",
                             "N1_DPS_DDS", "N1_MinMrkt",      "N1_Val_MarketS",      "N1_MrktS",        "N1_DMrktS",           "N1_QuoteValueS",
                             "N1_RCS",     "N1_K_ControlS",   "N1_Control_CommentS", "N1_ComS_Another", "N1_DRB",              "N1_CrBD",
                             "N1_CrBZ",    "N1_Cr_Val_MrkBZ", "N1_DPB_DDB",          "N1_MaxMrkt",      "N1_Val_MarketB",      "N1_MrktB",
                             "N1_DMrktB",  "N1_QuoteValueB",  "N1_RCB",              "N1_K_ControlB",   "N1_Control_CommentB", "N1_ComB_Another",
                             "N1_DqualS",  "N1_DqualB",       "N1_ContS",            "N1_ContB",        "N1_SecType",          "N1_Taxe_All",
                             "N1_Fin_Res", "N1_SecLax",       "N1_ISIN",             "N1_APS",          "N1_APB",              "N1_DGO"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                                "N1_Qnty",
                                "N1_SumSvp",
                                "N1_SumSrub",
                                "N1_DifS",
                                "N1_SumBvp",
                                "N1_SumBrub",
                                "N1_DifB",
                                "N1_SumBtax",
                                "N1_ComS",
                                "N1_ComB",
                                "N1_NDSComS",
                                "N1_NDSComB",
                                "N1_RashAll",
                                "N1_DPS_DDS",
                                "N1_DPB_DDB",
                                "N1_Taxe_All",
                                "N1_Fin_Res"
                              );

     m_NoDataFlag = true;
     m_Report.SetCopyAutoSumRange("$A$7:BQ7");
  END;

  MACRO EndReport()
      if(m_NoDataFlag)
         this.PrintNoData();
      end;

      m_Report.EndTable();
      m_Report.ReplaceFormulaAndCalculate();
      m_Report.SetCopyAutoSumRange(null);

      if(not m_NoDataFlag)
         m_Report.SetOnAutoFilter(SHEET_0211, "B13:BQ13");
      end;
  END;

  macro PrintNoData()
     m_Report.PrintTableLine("N1_SecCode", NoDataTxt, null);
  end;

  MACRO Print()
     m_NoDataFlag = false;
     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
                          "N1_Dummy1",             " ",                         null,
          /* 1   */       "N1_SecCode",            m_Report.SecCode(),          null,
          /* 2   */       "N1_SecName",            m_Report.SecName(),          null,
          /* 3   */       "N1_CodeS",              m_Report.CodeS(),            null,
          /* 4   */       "N1_DZS",                m_Report.DZS(),              null,
          /* 5   */       "N1_DDS",                m_Report.DDS(),              null,
          /* 6   */       "N1_Qnty",               m_Report.printQnty(),        null,
          /* 7   */       "N1_VN",                 m_Report.VN(),               null,
          /* 8   */       "N1_VPrS",               m_Report.VPrSNumber(),       null,
          /* 9   */       "N1_PrSvp",              m_Report.printPrSvp(),       null,
          /* 10  */       "N1_SumSvp",             m_Report.SumSvp(),           null,
          /* 11  */       "N1_SumSrub",            m_Report.SumSrub(),          null,/*ф-ла*/
          /* 12  */       "N1_DifS",               m_Report.DifS(),             null,
          /* 13  */       "N1_CodeB",              m_Report.CodeB(),            null,
          /* 14  */       "N1_DZB",                m_Report.DZB(),              null,
          /* 15  */       "N1_DDB",                m_Report.DDB(),              null,
          /* 16  */       "N1_VPrB",               m_Report.VPrBNumber(),       null,
          /* 17  */       "N1_PrBvp",              m_Report.printPrBvp(),       null,
          /* 18  */       "N1_SumBvp",             m_Report.SumBvp(),           null,
          /* 19  */       "N1_SumBrub",            m_Report.SumBrub(),          null,/*ф-ла*/
          /* 20  */       "N1_DifB",               m_Report.DifB(),             null,
          /* 21  */       "N1_SumBtax",            m_Report.SumBtax(),          null,/*ф-ла*/
          /* 22  */       "N1_ComS",               m_Report.ComS(),             null,
          /* 23  */       "N1_ComB",               m_Report.ComB(),             null,
          /* 22.1*/       "N1_NDSComS",            m_Report.NDSComS(),          null,
          /* 23.1*/       "N1_NDSComB",            m_Report.NDSComB(),          null,
          /* 24  */       "N1_RashAll",            m_Report.RashAll(),          null,/*ф-ла*/
          /* 25  */       "N1_RFISSS",             m_Report.RFISSS(),           null,
          /* 26  */       "N1_RFISSB",             m_Report.RFISSB(),           null,
          /* S1  */       "N1_DRS",                m_Report.DRS(),              null,
          /* S2  */       "N1_CrSD",               m_Report.printCrSD_F(),      null,/*ф-ла*/
          /* S3  */       "N1_CrSZ",               m_Report.printCrSZ_F(),      null,
          /* S4  */       "N1_Cr_Val_MrkSZ",       m_Report.printCr_Val_MrkSZ(),null,
          /* S5  */       "N1_DPS_DDS",            m_Report.DPS_DDS(),          null,
          /* S6  */       "N1_MinMrkt",            m_Report.printMinMrkt(),     null,
          /* S7  */       "N1_Val_MarketS",        m_Report.Val_MarketS(),      null,
          /* S8  */       "N1_MrktS",              m_Report.MrktS(),            null,
          /* S9  */       "N1_DMrktS",             m_Report.DMrktS(),           null,
          /* S10 */       "N1_QuoteValueS",        m_Report.printQuoteValueS(), null,
          /* S11 */       "N1_RCS",                m_Report.RCS(),              null,
          /* S12 */       "N1_K_ControlS",         m_Report.K_ControlS(),       null,
          /* S13 */       "N1_Control_CommentS",   m_Report.Control_CommentS(), null,
          /* S14 */       "N1_ComS_Another",       m_Report.ComS_Another(),     null,
          /* B1  */       "N1_DRB",                m_Report.DRB(),              null,
          /* B2  */       "N1_CrBD",               m_Report.printCrBD_F(),        null,/*ф-ла*/
          /* B3  */       "N1_CrBZ",               m_Report.printCrBZ_F(),      null,
          /* B4  */       "N1_Cr_Val_MrkBZ",       m_Report.printCr_Val_MrkBZ(),null,
          /* B5  */       "N1_DPB_DDB",            m_Report.DPB_DDB(),          null,
          /* B6  */       "N1_MaxMrkt",            m_Report.printMaxMrkt(),     null,
          /* B7  */       "N1_Val_MarketB",        m_Report.Val_MarketB(),      null,
          /* B8  */       "N1_MrktB",              m_Report.MrktB(),            null,
          /* B9  */       "N1_DMrktB",             m_Report.DMrktB(),           null,
          /* B10 */       "N1_QuoteValueB",        m_Report.printQuoteValueB(), null,
          /* B11 */       "N1_RCB",                m_Report.RCB(),              null,
          /* B12 */       "N1_K_ControlB",         m_Report.K_ControlB(),       null,
          /* B13 */       "N1_Control_CommentB",   m_Report.Control_CommentB(), null,
          /* B14 */       "N1_ComB_Another",       m_Report.ComB_Another(),     null,
          /* Т1  */       "N1_DqualS",             m_Report.DqualS(),           null,
          /* Т2  */       "N1_DqualB",             m_Report.DqualB(),           null,
          /* Т3  */       "N1_ContS",              m_Report.ContS(),            null,
          /* Т4  */       "N1_ContB",              m_Report.ContB(),            null,
          /* Т5  */       "N1_SecType",            m_Report.SecType(),          null,
          /* Т6  */       "N1_Taxe_All",           m_Report.Taxe_All(),         null,/*ф-ла*/
          /* V1  */       "N1_Fin_Res",            m_Report.Fin_Res(),          null,/*ф-ла */
          /* V2  */       "N1_SecLax",             m_Report.SecLax(),           null,
          /* R1  */       "N1_ISIN",               m_Report.ISIN(),             null,
          /* M1  */       "N1_APS",                m_Report.APS(),              null,
          /* M2  */       "N1_APB",                m_Report.APB(),              null,
          /* T7  */       "N1_DGO",                m_Report.DGO(),              null

                  );
  END;

END;

/*сводная вкладка 211*/
PRIVATE CLASS CRealizReg_211_Cons( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet_cons() );
     m_Report.PrintHeader_cons( "N11_", SHEET_0211s, m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N11_MainTable", "N11_TableHeader",
                   /* a */   "N11_RegNum",
                   /* b */   "N11_SecType",
                   /* c */   "N11_SecCode",
                   /* 1 */   "N11_SecName",
                   /* 2 */   "N11_Fin_Res",
                   /* 3 */   "N11_DifB",
                   /* 4 */   "N11_DifS",
                   /* 5 */   "N11_ComS_ComB",
                   /* 6 */   "N11_Taxe_All",
                   /* 7 */   "N11_Taxe_All_2",
                   /* 8 */   "N11_Taxe_All_3",
                   /* 9 */   "N11_Qnty",
                   /* 10*/   "N11_SumSrub",
                   /* 11*/   "N11_RashAll",
                   /* 12*/   "N11_SumSvp",
                   /* 13*/   "N11_SumBvp",
                   /* d */   "N11_ISIN"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                                "N11_Fin_Res",
                                "N11_DifB",
                                "N11_DifS",
                                "N11_ComS_ComB",
                                "N11_Taxe_All",
                                "N11_Taxe_All_2",
                                "N11_Taxe_All_3",
                                "N11_Qnty",
                                "N11_SumSrub",
                                "N11_RashAll",
                                "N11_SumSvp",
                                "N11_SumBvp"
                              );

     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N11_RegNum",   "211",         null,
                              "N11_SecType",  IIF(StrUpr(m_Report.H0_9())=="ВСЕ","",GetNumTaxGroup(m_Report.H0_9())), null,
                              "N11_SecCode",  m_Report.GetCCons(), null,
                              "N11_SecName",  ItogsLineName, null );
     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N11_SecName",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     /*подошвы для сводной нет*/
  END;

  MACRO Print(TaxGroup,FI_Code:string,Name:string,ISIN:string)
     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
                             "N11_RegNum",      "211",                                                   null,
                             "N11_SecType",     TaxGroup,                                                null,
                             "N11_SecCode",     FI_Code,                                                 null,
                             "N11_SecName",     Name,                                                    null,
                             "N11_Fin_Res",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Fin_Res),      null,
                             "N11_DifB",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifB),         null,
                             "N11_DifS",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifS),         null,
                             "N11_ComS_ComB",   m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_ComS, NULL, NULL, C_ComB, NULL, NULL),null,
                             "N11_Taxe_All",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_All),     null,
                             "N11_Taxe_All_2",  m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_All),     null,
                             "N11_Taxe_All_3",  0,                                                       null,/*не заполняется пока*/
                             "N11_Qnty",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Qnty),         null,
                             "N11_SumSrub",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSrub),      null,
                             "N11_RashAll",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_RashAll),      null,
                             "N11_SumSvp",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSvp),       null,
                             "N11_SumBvp",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumBvp),       null,
                             "N11_ISIN",        ISIN,                                                    null
                            );
  end;

END;

PRIVATE CLASS CRealizReg_212( Report:OBJECT )
  VAR m_Report = Report;

  MACRO QntyPrecision():INTEGER //  точность кол-ва
     return m_Report.SumPrecision;
  END;

  MACRO Where():STRING
     return WhereCond212();
  END;

  MACRO PaintStr()
     m_Report.SetCurrentLineFont( 8, true, false );
     m_Report.SetCellFont("N2_SumSrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_SumAllrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_NkdRepRub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_AmortVNrep", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_DifSumBRub",           8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_SumBNRub",             8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_DifSumBRub_AmortPrev", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_SumBRub_AmortPrev",    8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N2_RashAll",    8, true, false, null, null, DefaultBkGrColor );

     m_Report.SetCellFont("N2_AmortVN",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N2_KSumBvn",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N2_SumBvp_exps",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N2_Taxe_All",  8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N2_Taxe_Amort",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N2_Taxe_NKD",  8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N2_Fin_Res",   8, true, false, null, null, BLUECOLOR );

     m_Report.SetCellFont("N2_PlusNom_IN",   8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N2_MinusNom_IN",  8, true, false, null, null, BLUECOLOR );
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );

     m_Report.PrintHeader( "N2_", SHEET_0212, m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N2_MainTable", "N2_TableHeader",
                             "N2_SecCode",
                             "N2_SecName",
                             "N2_CodeS",
                             "N2_DZS",
                             "N2_DDS",
                             "N2_Qnty",
                             "N2_PrSNom",
                             "N2_SumSrub",
                             "N2_NkdSvp",
                             "N2_SumAllrub",
                             "N2_NKDminusRub",
                             "N2_DifS",
                             "N2_NkdRepRub",
                             "N2_NkdRepRub1",
                             "N2_NkdRepRub2",
                             "N2_AmortVNrep",
                             "N2_CodeB",
                             "N2_DZB",
                             "N2_DDB",
                             "N2_PrBnom",
                             "N2_SumBrub",
                             "N2_NkdBvp",
                             "N2_DifSumBRub",
                             "N2_SumBNRub",
                             "N2_DifSumBRub_AmortPrev",
                             "N2_SumBRub_AmortPrev",
                             "N2_ComS",
                             "N2_ComB",
                             "N2_NDSComS",
                             "N2_NDSComB",
                             "N2_RashAll",
                             "N2_Nom__DDS",
                             "N2_Nom__DDB",
                             "N2_RFISSS",
                             "N2_RFISSB",
                             "N2_SellType",
                             "N2_DRS",
                             "N2_CrSD",
                             "N2_SumSvp",
                             "N2_MinMrkt",
                             "N2_Val_MarketS",
                             "N2_MrktS",
                             "N2_DMrktS",
                             "N2_QuoteValueS",
                             "N2_RCS",
                             "N2_K_ControlS",
                             "N2_Control_CommentS",
                             "N2_ComS_Another",
                             "N2_DRB",
                             "N2_CrBD",
                             "N2_SumBvp",
                             "N2_MaxMrkt",
                             "N2_Val_MarketB",
                             "N2_MrktB",
                             "N2_DMrktB",
                             "N2_QuoteValueB",
                             "N2_RCB",
                             "N2_K_ControlB",
                             "N2_Control_CommentB",
                             "N2_ComB_Another",
                             "N2_DifB",
                             "N2_NkdBprevRub",
                             "N2_NkdBrepRub",
                             "N2_NkdBsellRub",
                             "N2_ifCoupPrev",
                             "N2_Tprev",
                             "N2_NkdPrevVN",
                             "N2_CoupVN",
                             "N2_LastCoupDate",
                             "N2_ControlNKD",
                             "N2_AmortVN",
                             "N2_AmortVN_before",
                             "N2_AmortVN_after",
                             "N2_AmortVNPer",
                             "N2_KSumBvn",
                             "N2_SumBvp_exps",
                             "N2_DqualS",
                             "N2_DqualB",
                             "N2_ContS",
                             "N2_ContB",
                             "N2_SecType",
                             "N2_Taxe_All",
                             "N2_Taxe_Amort",
                             "N2_Taxe_NKD",
                             "N2_Fin_Res",
                             "N2_SecLax",
                             "N2_NkdRepRubAll",
                             "N2_ISIN",
                             "N2_Nom_H01",
                             "N2_Nom_H02",
                             "N2_PlusNom_IN",
                             "N2_MinusNom_IN",
                             "N2_Nom_IN_Before",
                             "N2_APS",
                             "N2_APB",
                             "N2_DGO"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                             "N2_Qnty",
                             "N2_SumSrub",
                             "N2_NkdSvp",
                             "N2_SumAllrub",
                             "N2_NKDminusRub",
                             "N2_DifS",
                             "N2_NkdRepRub",
                             "N2_NkdRepRub1",
                             "N2_NkdRepRub2",
                             "N2_AmortVNrep",
                             "N2_SumBrub",
                             "N2_NkdBvp",
                             "N2_DifSumBRub",
                             "N2_SumBNRub",
                             "N2_DifSumBRub_AmortPrev",
                             "N2_SumBRub_AmortPrev",
                             "N2_ComS",
                             "N2_ComB",
                             "N2_NDSComS",
                             "N2_NDSComB",
                             "N2_RashAll",
                             "N2_DifB",
                             "N2_NkdBrepRub",
                             "N2_NkdBsellRub",
                             "N2_Tprev",
                             "N2_NkdPrevVN",
                             "N2_CoupVN",
                             "N2_AmortVN",
                             "N2_AmortVN_before",
                             "N2_AmortVN_after",
                             "N2_AmortVNPer",
                             "N2_SumBvp_exps",
                             "N2_Taxe_All",
                             "N2_Taxe_Amort",
                             "N2_Taxe_NKD",
                             "N2_Fin_Res",
                             "N2_NkdRepRubAll",
                             "N2_PlusNom_IN",
                             "N2_MinusNom_IN",
                             "N2_Nom_IN_Before"
                              );

     this.PaintStr();
     m_Report.PrintTableLine( "N2_SecCode",  ItogsLineName, null );
     this.PaintStr();
     m_Report.PrintTableLine( "N2_SecCode:l",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     m_Report.AddStandardFooter_Reg2014( "N2_" );
  END;
                                           
  MACRO Print()

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
            /* 1    */        "N2_SecCode",                m_Report.SecCode(),              null,
            /* 2    */        "N2_SecName",                m_Report.SecName(),              null,
            /* 3    */        "N2_CodeS",                  m_Report.CodeS(),                null,
            /* 4    */        "N2_DZS",                    m_Report.DZS(),                  null,
            /* 5    */        "N2_DDS",                    m_Report.DDS(),                  null,
            /* 6    */        "N2_Qnty",                   m_Report.printQnty(),            null,
            /* 7    */        "N2_PrSNom",                 m_Report.printPrSNom(),          null,
            /* 8    */        "N2_SumSrub",                m_Report.SumSrub(),              null,/*ф-ла*/
            /* 9    */        "N2_NkdSvp",                 m_Report.NkdSvp(),               null,
            /* 10   */        "N2_SumAllrub",              m_Report.SumAllrub(),            null,/*ф-ла*/
            /* 11   */        "N2_NKDminusRub",            m_Report.NKDminusRub(),          null,
            /* 12   */        "N2_DifS",                   m_Report.DifS(),                 null,
            /* 13   */        "N2_NkdRepRub",              m_Report.NkdRepRub(),            null,
            /* 13_1 */        "N2_NkdRepRub1",             m_Report.NkdRepRub1(),           null,
            /* 13_2 */        "N2_NkdRepRub2",             m_Report.NkdRepRub2(),           null,
            /* 14   */        "N2_AmortVNrep",             m_Report.AmortVNrep(),           null,/*ф-ла*/
            /* 15   */        "N2_CodeB",                  m_Report.CodeB(),                null,
            /* 16   */        "N2_DZB",                    m_Report.DZB(),                  null,
            /* 17   */        "N2_DDB",                    m_Report.DDB(),                  null,
            /* 18   */        "N2_PrBnom",                 m_Report.printPrBnom(),          null,
            /* 19   */        "N2_SumBrub",                m_Report.SumBrub(),              null,/*ф-ла*/
            /* 20   */        "N2_NkdBvp",                 m_Report.NkdBvp(),               null,
            /* 21   */        "N2_DifSumBRub",             m_Report.DifSumBRub(),           null,/*ф-ла*/
            /* 22   */        "N2_SumBNRub",               m_Report.SumBNRub(),             null,/*ф-ла*/
            /* 22_1 */        "N2_DifSumBRub_AmortPrev",   m_Report.DifSumBRub_AmortPrev(), null,/*ф-ла*/
            /* 22_2 */        "N2_SumBRub_AmortPrev",      m_Report.SumBRub_AmortPrev(),    null,/*ф-ла*/
            /* 23   */        "N2_ComS",                   m_Report.ComS(),                 null,
            /* 24   */        "N2_ComB",                   m_Report.ComB(),                 null,
            /* 23.1 */        "N2_NDSComS",                m_Report.NDSComS(),              null,
            /* 24.1 */        "N2_NDSComB",                m_Report.NDSComB(),              null,
            /* 25   */        "N2_RashAll",                m_Report.RashAll(),              null,/*ф-ла*/
            /* 26   */        "N2_Nom__DDS",               m_Report.printNomS(),            null,
            /* 27   */        "N2_Nom__DDB",               m_Report.printNomBDU(),          null,
            /* 28   */        "N2_RFISSS",                 m_Report.RFISSS(),               null,
            /* 29   */        "N2_RFISSB",                 m_Report.RFISSB(),               null,
            /* S0   */        "N2_SellType",               m_Report.SellType(),             null,
            /* S1   */        "N2_DRS",                    m_Report.DRS(),                  null,
            /* S2   */        "N2_CrSD",                   m_Report.printCrSD_F(),          null,/*ф-ла*/
            /* S3   */        "N2_SumSvp",                 m_Report.SumSvp(),               null,
            /* S4   */        "N2_MinMrkt",                m_Report.printMinMrkt(),         null,
            /* S5   */        "N2_Val_MarketS",            m_Report.Val_MarketS(),          null,
            /* S6   */        "N2_MrktS",                  m_Report.MrktS(),                null,
            /* S7   */        "N2_DMrktS",                 m_Report.DMrktS(),               null,
            /* S8   */        "N2_QuoteValueS",            m_Report.printQuoteValueS(),     null,
            /* S9   */        "N2_RCS",                    m_Report.RCS(),                  null,
            /* S10  */        "N2_K_ControlS",             m_Report.K_ControlS(),           null,
            /* S11  */        "N2_Control_CommentS",       m_Report.Control_CommentS(),     null,
            /* S12  */        "N2_ComS_Another",           m_Report.ComS_Another(),         null,
            /* B1   */        "N2_DRB",                    m_Report.DRB(),                  null,
            /* B2   */        "N2_CrBD",                   m_Report.printCrBD_F(),          null,/*ф-ла*/
            /* B3   */        "N2_SumBvp",                 m_Report.SumBvp(),               null,
            /* B4   */        "N2_MaxMrkt",                m_Report.printMaxMrkt(),         null,
            /* B5   */        "N2_Val_MarketB",            m_Report.Val_MarketB(),          null,
            /* B6   */        "N2_MrktB",                  m_Report.MrktB(),                null,
            /* B7   */        "N2_DMrktB",                 m_Report.DMrktB(),               null,
            /* B8   */        "N2_QuoteValueB",            m_Report.printQuoteValueB(),     null,
            /* B9   */        "N2_RCB",                    m_Report.RCB(),                  null,
            /* B10  */        "N2_K_ControlB",             m_Report.K_ControlB(),           null,
            /* B11  */        "N2_Control_CommentB",       m_Report.Control_CommentB(),     null,
            /* B12  */        "N2_ComB_Another",           m_Report.ComB_Another(),         null,
            /* B13  */        "N2_DifB",                   m_Report.DifB(),                 null,
            /* К1   */        "N2_NkdBprevRub",            m_Report.NkdBprevRub(),          null,
            /* К2   */        "N2_NkdBrepRub",             m_Report.NkdBrepRub(),           null,
            /* К3   */        "N2_NkdBsellRub",            m_Report.NkdBsellRub(),          null,
            /* К4   */        "N2_ifCoupPrev",             m_Report.ifCoupPrev(),           null,
            /* К5   */        "N2_Tprev",                  m_Report.Tprev(),                null,
            /* К6   */        "N2_NkdPrevVN",              m_Report.NkdPrevVN(),            null,
            /* К7   */        "N2_CoupVN",                 m_Report.CoupVN(),               null,
            /* К8   */        "N2_LastCoupDate",           m_Report.LastCoupDate(),         null,
            /* К9   */        "N2_ControlNKD",             m_Report.ControlNKD(),           null,
            /* А1   */        "N2_AmortVN",                m_Report.AmortVN(),              null,/*ф-ла*/
            /* А2   */        "N2_AmortVN_before",         m_Report.AmortVN_before(),       null,
            /* А3   */        "N2_AmortVN_after",          m_Report.AmortVN_after(),        null,
            /* А4   */        "N2_AmortVNPer",             m_Report.AmortVNPer(),           null,
            /* А5   */        "N2_KSumBvn",                m_Report.KSumBvn(),              null,/*ф-ла*/
            /* А6   */        "N2_SumBvp_exps",            m_Report.SumBvp_exps(),          null,/*ф-ла*/
            /* Т1   */        "N2_DqualS",                 m_Report.DqualS(),               null,
            /* Т2   */        "N2_DqualB",                 m_Report.DqualB(),               null,
            /* Т3   */        "N2_ContS",                  m_Report.ContS(),                null,
            /* Т4   */        "N2_ContB",                  m_Report.ContB(),                null,
            /* Т5   */        "N2_SecType",                m_Report.SecType(),              null,
            /* Т6   */        "N2_Taxe_All",               m_Report.Taxe_All(),             null,/*ф-ла*/
            /* Т7   */        "N2_Taxe_Amort",             m_Report.Taxe_Amort(),           null,/*ф-ла*/
            /* Т8   */        "N2_Taxe_NKD",               m_Report.Taxe_NKD(),             null,/*ф-ла*/
            /* V1   */        "N2_Fin_Res",                m_Report.Fin_Res(),              null,/*ф-ла*/
            /* V2   */        "N2_SecLax",                 m_Report.SecLax(),               null,
            /* V3   */        "N2_NkdRepRubAll",           m_Report.NkdRepRubAll(),         null,/*ф-ла*/
            /* R1   */        "N2_ISIN",                   m_Report.ISIN(),                 null,
            /* Т9   */        "N2_Nom_H01",                iif(m_Report.TaxGroup() == 15, m_Report.Nom_H01(), null),              null,
            /* Т10  */        "N2_Nom_H02",                iif(m_Report.TaxGroup() == 15, m_Report.Nom_H02(), null),              null,
            /* Т11  */        "N2_PlusNom_IN",             iif(m_Report.TaxGroup() == 15, m_Report.PlusNom_IN(), null),           null,/*ф-ла*/
            /* Т12  */        "N2_MinusNom_IN",            iif(m_Report.TaxGroup() == 15, m_Report.MinusNom_IN(), null),          null,/*ф-ла*/
            /* Т13  */        "N2_Nom_IN_Before",          iif(m_Report.TaxGroup() == 15, m_Report.Nom_IN_Before(), null),        null,
            /* M1   */        "N2_APS",                    m_Report.APS(),                  null,
            /* M2   */        "N2_APB",                    m_Report.APB(),                  null,
            /* T14  */        "N2_DGO",                    m_Report.DGO(),                  null
                 );
  END;

  MACRO PrintAdd(FIID, FI_Code, Name, TaxGroup, Kind)

     var CoupVN:money = m_Report.SumWarnKind(FIID, Kind);

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
            /* 1    */        "N2_SecCode",                FI_Code,                         null,
            /* 2    */        "N2_SecName",                Name,                            null,
            /* 3    */        "N2_CodeS",                  Kind,                            null,
            /* 4    */        "N2_DZS",                    null,                            null,
            /* 5    */        "N2_DDS",                    null,                            null,
            /* 6    */        "N2_Qnty",                   0,                               null,
            /* 7    */        "N2_PrSNom",                 0,                               null,
            /* 8    */        "N2_SumSrub",                0,                               null,/*ф-ла*/
            /* 9    */        "N2_NkdSvp",                 0,                               null,
            /* 10   */        "N2_SumAllrub",              0,                               null,/*ф-ла*/
            /* 11   */        "N2_NKDminusRub",            0,                               null,
            /* 12   */        "N2_DifS",                   0,                               null,
            /* 13   */        "N2_NkdRepRub",              m_Report.NkdRepRub(),            null,/*Формула выводится и в тех случаях, когда <CodeS> равно <1> или <2>.*/
            /* 13   */        "N2_NkdRepRub1",             0,                               null,
            /* 13   */        "N2_NkdRepRub2",             0,                               null,
            /* 14   */        "N2_AmortVNrep",             0,                               null,/*ф-ла*/
            /* 15   */        "N2_CodeB",                  null,                            null,
            /* 16   */        "N2_DZB",                    null,                            null,
            /* 17   */        "N2_DDB",                    null,                            null,
            /* 18   */        "N2_PrBnom",                 0,                               null,
            /* 19   */        "N2_SumBrub",                0,                               null,/*ф-ла*/
            /* 20   */        "N2_NkdBvp",                 0,                               null,
            /* 21   */        "N2_DifSumBRub",             0,                               null,/*ф-ла*/
            /* 22   */        "N2_SumBNRub",               0,                               null,/*ф-ла*/
            /* 22_1 */        "N2_DifSumBRub_AmortPrev",   0,                               null,/*ф-ла*/
            /* 22_2 */        "N2_SumBRub_AmortPrev",      0,                               null,/*ф-ла*/
            /* 23   */        "N2_ComS",                   0,                               null,
            /* 24   */        "N2_ComB",                   0,                               null,
            /* 23.1 */        "N2_NDSComS",                0,                               null,
            /* 24.1 */        "N2_NDSComB",                0,                               null,
            /* 25   */        "N2_RashAll",                0,                               null,/*ф-ла*/
            /* 26   */        "N2_Nom__DDS",               0,                               null,
            /* 27   */        "N2_Nom__DDB",               0,                               null,
            /* 28   */        "N2_RFISSS",                 null,                            null,
            /* 29   */        "N2_RFISSB",                 null,                            null,
            /* S0   */        "N2_SellType",               null,                            null,
            /* S1   */        "N2_DRS",                    null,                            null,
            /* S2   */        "N2_CrSD",                   0,                               null,/*ф-ла*/
            /* S3   */        "N2_SumSvp",                 0,                               null,
            /* S4   */        "N2_MinMrkt",                0,                               null,
            /* S5   */        "N2_Val_MarketS",            null,                            null,
            /* S6   */        "N2_MrktS",                  null,                            null,
            /* S7   */        "N2_DMrktS",                 null,                            null,
            /* S8   */        "N2_QuoteValueS",            0,                               null,
            /* S9   */        "N2_RCS",                    null,                            null,
            /* S10  */        "N2_K_ControlS",             null,                            null,
            /* S11  */        "N2_Control_CommentS",       null,                            null,
            /* S12  */        "N2_ComS_Another",           0,                               null,
            /* B1   */        "N2_DRB",                    null,                            null,
            /* B2   */        "N2_CrBD",                   0,                               null,/*ф-ла*/
            /* B3   */        "N2_SumBvp",                 0,                               null,
            /* B4   */        "N2_MaxMrkt",                0,                               null,
            /* B5   */        "N2_Val_MarketB",            null,                            null,
            /* B6   */        "N2_MrktB",                  null,                            null,
            /* B7   */        "N2_DMrktB",                 null,                            null,
            /* B8   */        "N2_QuoteValueB",            0,                               null,
            /* B9   */        "N2_RCB",                    null,                            null,
            /* B10  */        "N2_K_ControlB",             null,                            null,
            /* B11  */        "N2_Control_CommentB",       null,                            null,
            /* B12  */        "N2_ComB_Another",           0,                               null,
            /* B13  */        "N2_DifB",                   0,                               null,
            /* К1   */        "N2_NkdBprevRub",            0,                               null,
            /* К2   */        "N2_NkdBrepRub",             0,                               null,
            /* К3   */        "N2_NkdBsellRub",            0,                               null,
            /* К4   */        "N2_ifCoupPrev",             0,                               null,
            /* К5   */        "N2_Tprev",                  0,                               null,
            /* К6   */        "N2_NkdPrevVN",              0,                               null,
            /* К7   */        "N2_CoupVN",                 CoupVN,                          null,
            /* К8   */        "N2_LastCoupDate",           null,                            null,
            /* К9   */        "N2_ControlNKD",             0,                               null,
            /* А1   */        "N2_AmortVN",                0,                               null,/*ф-ла*/
            /* А2   */        "N2_AmortVN_before",         0,                               null,
            /* А3   */        "N2_AmortVN_after",          0,                               null,
            /* А4   */        "N2_AmortVNPer",             0,                               null,
            /* А5   */        "N2_KSumBvn",                0,                               null,/*ф-ла*/
            /* А6   */        "N2_SumBvp_exps",            0,                               null,/*ф-ла*/
            /* Т1   */        "N2_DqualS",                 null,                            null,
            /* Т2   */        "N2_DqualB",                 null,                            null,
            /* Т3   */        "N2_ContS",                  null,                            null,
            /* Т4   */        "N2_ContB",                  null,                            null,
            /* Т5   */        "N2_SecType",                TaxGroup,                        null,
            /* Т6   */        "N2_Taxe_All",               0,                               null,/*ф-ла*/
            /* Т7   */        "N2_Taxe_Amort",             0,                               null,/*ф-ла*/
            /* Т8   */        "N2_Taxe_NKD",               0,                               null,/*ф-ла*/
            /* V1   */        "N2_Fin_Res",                0,                               null,/*ф-ла*/
            /* V2   */        "N2_SecLax",                 0,                               null,
            /* V3   */        "N2_NkdRepRubAll",           0,                               null,
            /* R1   */        "N2_ISIN",                   null,                            null,
            /* Т9   */        "N2_Nom_H01",                0,                               null,
            /* Т10  */        "N2_Nom_H02",                0,                               null,
            /* Т11  */        "N2_PlusNom_IN",             0,                               null,/*ф-ла*/
            /* Т12  */        "N2_MinusNom_IN",            0,                               null,/*ф-ла*/
            /* Т13  */        "N2_Nom_IN_Before",          0,                               null,
            /* M1   */        "N2_APS",                    null,                            null,
            /* M2   */        "N2_APB",                    null,                            null,
            /* T14  */        "N2_DGO",                    null,                            null
                 );
  END;

END;

/*сводная вкладка 212*/
PRIVATE CLASS CRealizReg_212_Cons( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()

     m_Report.SetActiveSheet( m_Report.GetNumSheet_cons() );

     m_Report.RegisterTable( "N21_MainTable", "N21_TableHeader",
                   /* a  */  "N21_RegNum",
                   /* b  */  "N21_SecType",
                   /* c  */  "N21_SecCode",
                   /* 1  */  "N21_SecName",
                   /* 2  */  "N21_Fin_Res",
                   /* 3  */  "N21_DifSumBRub",
                   /* 4  */  "N21_DifS",
                   /* 5  */  "N21_ComS_ComB",
                   /* 6  */  "N21_Taxe_All",
                   /* 7  */  "N21_Taxe_Amort",
                   /* 8  */  "N21_Taxe_NKD",
                   /* 9  */  "N21_Qnty",
                   /* 10 */  "N21_SumAllRub",
                   /* 11 */  "N21_RashAll",
                   /* 12 */  "N21_SumSvp",
                   /* 13 */  "N21_SumBvp_exps",
                   /* 14 */  "N21_NkdRepRub1",
                   /* 15 */  "N21_NkdRepRub2",
                   /* 16 */  "N21_NKDminusRub",
                   /* 17 */  "N21_NkdSvp",
                   /* 18 */  "N21_NkdBvp",
                   /* 19 */  "N21_AmortVNrep",
                   /* 20 */  "N21_CoupVN_NkdSvp",
                   /* 21 */  "N21_NkdPrevVN",
                   /* 22 */  "N21_NkdRepRubAll",
                   /* d  */  "N21_ISIN"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                   /* 2  */  "N21_Fin_Res",
                   /* 3  */  "N21_DifSumBRub",
                   /* 4  */  "N21_DifS",
                   /* 5  */  "N21_ComS_ComB",
                   /* 6  */  "N21_Taxe_All",
                   /* 7  */  "N21_Taxe_Amort",
                   /* 8  */  "N21_Taxe_NKD",
                   /* 9  */  "N21_Qnty",
                   /* 10 */  "N21_SumAllRub",
                   /* 11 */  "N21_RashAll",
                   /* 12 */  "N21_SumSvp",
                   /* 13 */  "N21_SumBvp_exps",
                   /* 14 */  "N21_NkdRepRub1",
                   /* 15 */  "N21_NkdRepRub2",
                   /* 16 */  "N21_NKDminusRub",
                   /* 17 */  "N21_NkdSvp",
                   /* 18 */  "N21_NkdBvp",
                   /* 19 */  "N21_AmortVNrep",
                   /* 20 */  "N21_CoupVN_NkdSvp",
                   /* 21 */  "N21_NkdPrevVN",
                   /* 22 */  "N21_NkdRepRubAll"
                              );

     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N21_RegNum",   "212",         null,
                              "N21_SecType",  IIF(StrUpr(m_Report.H0_9())=="ВСЕ","",GetNumTaxGroup(m_Report.H0_9())), null,
                              "N21_SecCode",  m_Report.GetCCons(), null,
                              "N21_SecName",  ItogsLineName, null );
     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N21_SecName",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     /*подошвы для сводной нет*/
  END;
                                    
  MACRO Print(TaxGroup,FI_Code:string,Name:string,ISIN:string)

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
                             "N21_RegNum",        "212",                                                  null,
                             "N21_SecType",       TaxGroup,                                               null,
                             "N21_SecCode",       FI_Code,                                                null,
                             "N21_SecName",       Name,                                                   null,
                             "N21_Fin_Res",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Fin_Res),     null,
                             "N21_DifSumBRub",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifSumBRub),  null,
                             "N21_DifS",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifS),        null,
                             "N21_ComS_ComB",     m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_ComS, NULL, NULL, C_ComB, NULL, NULL), null,
                             "N21_Taxe_All",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_All),    null,
                             "N21_Taxe_Amort",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_Amort),  null,
                             "N21_Taxe_NKD",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_NKD),    null,
                             "N21_Qnty",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Qnty),        null,
                             "N21_SumAllRub",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumAllRub),   null,
                             "N21_RashAll",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_RashAll),     null,
                             "N21_SumSvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSvp),      null,
                             "N21_SumBvp_exps",   m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumBvp_exps), null,
                             "N21_NkdRepRub1",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdRepRub1),  null,
                             "N21_NkdRepRub2",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdRepRub2),  null,
                             "N21_NKDminusRub",   m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NKDminusRub), null,
                             "N21_NkdSvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdSvp),      null,
                             "N21_NkdBvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdBvp),      null,
                             "N21_AmortVNrep",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_AmortVNrep),  null,
                             "N21_CoupVN_NkdSvp", m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_CoupVN, C_CodeS, "<>\"2\"", C_NkdSvp, C_SellType, "=1"),null,
                             "N21_NkdPrevVN",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdPrevVN),   null,
                             "N21_NkdRepRubAll",  m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdRepRubAll),null,
                             "N21_ISIN",          ISIN,                                                   null
                            );
  end;

END;

PRIVATE CLASS CRealizReg_215( Report:OBJECT )
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;

  MACRO QntyPrecision():INTEGER //  точность кол-ва
     return m_Report.SumPrecision;
  END;

  MACRO Where():STRING
     return WhereCond215();
  END;

  MACRO PaintStr()
     m_Report.SetCurrentLineFont( 8, true, false );
     m_Report.SetCellFont("N5_SumSrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_SumAllrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_NkdRepRub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_AmortVNrep", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_DifSumBRub",           8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_SumBNRub",             8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_DifSumBRub_AmortPrev", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_SumBRub_AmortPrev",    8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N5_RashAll",    8, true, false, null, null, DefaultBkGrColor );

     m_Report.SetCellFont("N5_AmortVN",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N5_KSumBvn",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N5_SumBvp_exps",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N5_SumBvpPrev_exps",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N5_Taxe_All",  8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N5_Taxe_Amort",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N5_Taxe_NKD",  8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N5_Fin_Res",   8, true, false, null, null, BLUECOLOR );
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );
     m_Report.PrintHeader_0215( "N5_", SHEET_0215, m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N5_MainTable", "N5_TableHeader",
                             "N5_Dummy1", 
                             "N5_SecCode",
                             "N5_SecName",
                             "N5_CodeS",
                             "N5_DZS",
                             "N5_DDS",
                             "N5_Qnty",
                             "N5_VN",
                             "N5_VPrS",
                             "N5_PrSNom",
                             "N5_SumSvp",
                             "N5_SumSrub",
                             "N5_NkdSvp",
                             "N5_NkdSrub",
                             "N5_SumAllrub",
                             "N5_NKDminusRub",
                             "N5_DifS",
                             "N5_NkdRepRub",
                             "N5_AmortVNrep",
                             "N5_AmortRubrep",
                             "N5_CodeB",
                             "N5_DZB",
                             "N5_DDB",
                             "N5_VPrB",
                             "N5_PrBnom",
                             "N5_SumBvp",
                             "N5_SumBrub",
                             "N5_NkdBvp",
                             "N5_NkdBrub",
                             "N5_DifSumBRub",
                             "N5_SumBNRub",
                             "N5_DifSumBRub_AmortPrev",
                             "N5_SumBRub_AmortPrev",
                             "N5_ComS",
                             "N5_ComB",
                             "N5_NDSComS",
                             "N5_NDSComB",
                             "N5_RashAll",
                             "N5_Nom_DDS",
                             "N5_Nom_DDB",
                             "N5_RFISSS",
                             "N5_RFISSB",
                             "N5_SellType",
                             "N5_DRS",
                             "N5_CrSD",
                             "N5_DPS_DDS",
                             "N5_MinMrkt",
                             "N5_Val_MarketS",
                             "N5_MrktS",
                             "N5_DMrktS",
                             "N5_QuoteValueS",
                             "N5_RCS",
                             "N5_K_ControlS",
                             "N5_Control_CommentS",
                             "N5_ComS_Another",
                             "N5_DRB",
                             "N5_CrBD",
                             "N5_DPB_DDB",
                             "N5_MaxMrkt",
                             "N5_Val_MarketB",
                             "N5_MrktB",
                             "N5_DMrktB",
                             "N5_QuoteValueB",
                             "N5_RCB",
                             "N5_K_ControlB",
                             "N5_Control_CommentB",
                             "N5_ComB_Another",
                             "N5_DifB",
                             "N5_NkdBprevRub",
                             "N5_NkdBrepRub",
                             "N5_NkdBsellRub",
                             "N5_ifCoupPrev",
                             "N5_Tprev",
                             "N5_NkdPrevVN",
                             "N5_NkdPrevRub",
                             "N5_CoupVN",
                             "N5_CoupRub",
                             "N5_LastCoupDate",
                             "N5_AmortVN",
                             "N5_AmortVN_before",
                             "N5_AmortVN_after",
                             "N5_AmortVNPer",
                             "N5_KSumBvn",
                             "N5_SumBvp_exps",
                             "N5_SumBvpPrev_exps",
                             "N5_DqualS",
                             "N5_DqualB",
                             "N5_ContS",
                             "N5_ContB",
                             "N5_SecType",
                             "N5_Taxe_All",
                             "N5_Taxe_Amort",
                             "N5_Taxe_NKD",
                             "N5_Fin_Res",
                             "N5_SecLax",
                             "N5_NkdRepRubAll",
                             "N5_ISIN",
                             "N5_APS",
                             "N5_APB",
                             "N5_DGO"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                             "N5_Qnty",
                             "N5_SumSvp",
                             "N5_SumSrub",
                             "N5_NkdSvp",
                             "N5_NkdSrub",
                             "N5_SumAllrub",
                             "N5_NKDminusRub",
                             "N5_DifS",
                             "N5_NkdRepRub",
                             "N5_AmortVNrep",
                             "N5_AmortRubrep",
                             "N5_SumBvp",
                             "N5_SumBrub",
                             "N5_NkdBvp",
                             "N5_NkdBrub",
                             "N5_DifSumBRub",
                             "N5_SumBNRub",
                             "N5_DifSumBRub_AmortPrev",
                             "N5_SumBRub_AmortPrev",
                             "N5_ComS",
                             "N5_ComB",
                             "N5_NDSComS",
                             "N5_NDSComB",
                             "N5_RashAll",
                             "N5_DPS_DDS",
                             "N5_DPB_DDB",
                             "N5_DifB",
                             "N5_NkdBprevRub",
                             "N5_NkdBrepRub",
                             "N5_NkdBsellRub",
                             "N5_ifCoupPrev",
                             "N5_Tprev",
                             "N5_NkdPrevVN",
                             "N5_NkdPrevRub",
                             "N5_CoupVN",
                             "N5_CoupRub",
                             "N5_AmortVN",
                             "N5_AmortVN_before",
                             "N5_AmortVN_after",
                             "N5_AmortVNPer",
                             "N5_SumBvp_exps",
                             "N5_SumBvpPrev_exps",
                             "N5_Taxe_All",
                             "N5_Taxe_Amort",
                             "N5_Taxe_NKD",
                             "N5_Fin_Res",
                             "N5_NkdRepRubAll"
                              );

     m_NoDataFlag = true;
     m_Report.SetCopyAutoSumRange("$A$7:CV7");

  END;

  MACRO EndReport()
      if(m_NoDataFlag)
         this.PrintNoData();
      end;

      m_Report.EndTable();
      m_Report.ReplaceFormulaAndCalculate();
      m_Report.SetCopyAutoSumRange(null);

      if(not m_NoDataFlag)
         m_Report.SetOnAutoFilter(SHEET_0215, "B13:CV13");
      end;
  END;

  macro PrintNoData()
     m_Report.PrintTableLine( "N5_SecCode",  NoDataTxt, null );
  end;

  MACRO Print()
     m_NoDataFlag = false;
     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(

              /* 1    */        "N5_SecCode",                m_Report.SecCode(),              null,
              /* 2    */        "N5_SecName",                m_Report.SecName(),              null,
              /* 3    */        "N5_CodeS",                  m_Report.CodeS(),                null,
              /* 4    */        "N5_DZS",                    m_Report.DZS(),                  null,
              /* 5    */        "N5_DDS",                    m_Report.DDS(),                  null,
              /* 6    */        "N5_Qnty",                   m_Report.printQnty(),            null,
              /* 7    */        "N5_VN",                     m_Report.VN(),                   null,
              /* 8    */        "N5_VPrS",                   m_Report.VPrSNumber(),           null,
              /* 9    */        "N5_PrSNom",                 m_Report.printPrSNom(),          null,
              /* 10   */        "N5_SumSvp",                 m_Report.SumSvp(),               null,
              /* 11   */        "N5_SumSrub",                m_Report.SumSrub(),              null,/*ф-ла*/
              /* 12   */        "N5_NkdSvp",                 m_Report.NkdSvp(),               null,
              /* 13   */        "N5_NkdSrub",                m_Report.NkdSrub(),              null,
              /* 14   */        "N5_SumAllrub",              m_Report.SumAllrub(),            null,/*ф-ла*/
              /* 15   */        "N5_NKDminusRub",            m_Report.NKDminusRub(),          null,
              /* 16   */        "N5_DifS",                   m_Report.DifS(),                 null,
              /* 17   */        "N5_NkdRepRub",              m_Report.NkdRepRub(),            null,
              /* 18   */        "N5_AmortVNrep",             m_Report.AmortVNrep(),           null,/*ф-ла*/
              /* 19   */        "N5_AmortRubrep",            m_Report.AmortRubrep(),          null,
              /* 20   */        "N5_CodeB",                  m_Report.CodeB(),                null,
              /* 21   */        "N5_DZB",                    m_Report.DZB(),                  null,
              /* 22   */        "N5_DDB",                    m_Report.DDB(),                  null,
              /* 23   */        "N5_VPrB",                   m_Report.VPrBNumber(),           null,
              /* 24   */        "N5_PrBnom",                 m_Report.printPrBnom(),          null,
              /* 25   */        "N5_SumBvp",                 m_Report.SumBvp(),               null,
              /* 26   */        "N5_SumBrub",                m_Report.SumBrub(),              null,/*ф-ла*/
              /* 27   */        "N5_NkdBvp",                 m_Report.NkdBvp(),               null,
              /* 28   */        "N5_NkdBrub",                m_Report.NkdBrub(),              null,
              /* 29   */        "N5_DifSumBRub",             m_Report.DifSumBRub(),           null,/*ф-ла*/
              /* 30   */        "N5_SumBNRub",               m_Report.SumBNRub(),             null,/*ф-ла*/
              /* 30_1 */        "N5_DifSumBRub_AmortPrev",   m_Report.DifSumBRub_AmortPrev(), null,/*ф-ла*/
              /* 30_2 */        "N5_SumBRub_AmortPrev",      m_Report.SumBRub_AmortPrev(),    null,/*ф-ла*/
              /* 31   */        "N5_ComS",                   m_Report.ComS(),                 null,
              /* 32   */        "N5_ComB",                   m_Report.ComB(),                 null,
              /* 31.1 */        "N5_NDSComS",                m_Report.NDSComS(),              null,
              /* 32.1 */        "N5_NDSComB",                m_Report.NDSComB(),              null,
              /* 33   */        "N5_RashAll",                m_Report.RashAll(),              null,/*ф-ла*/
              /* 34   */        "N5_Nom_DDS",                m_Report.printNomS(),            null,
              /* 35   */        "N5_Nom_DDB",                m_Report.printNomBDU(),          null,
              /* 36   */        "N5_RFISSS",                 m_Report.RFISSS(),               null,
              /* 37   */        "N5_RFISSB",                 m_Report.RFISSB(),               null,
              /* S0   */        "N5_SellType",               m_Report.SellType(),             null,
              /* S1   */        "N5_DRS",                    m_Report.DRS(),                  null,
              /* S2   */        "N5_CrSD",                   m_Report.printCrSD_F(),          null,
              /* S3   */        "N5_DPS_DDS",                m_Report.DPS_DDS(),              null,
              /* S4   */        "N5_MinMrkt",                m_Report.printMinMrkt(),         null,
              /* S5   */        "N5_Val_MarketS",            m_Report.Val_MarketS(),          null,
              /* S6   */        "N5_MrktS",                  m_Report.MrktS(),                null,
              /* S7   */        "N5_DMrktS",                 m_Report.DMrktS(),               null,
              /* S8   */        "N5_QuoteValueS",            m_Report.printQuoteValueS(),     null,
              /* S9   */        "N5_RCS",                    m_Report.RCS(),                  null,
              /* S10  */        "N5_K_ControlS",             m_Report.K_ControlS(),           null,
              /* S11  */        "N5_Control_CommentS",       m_Report.Control_CommentS(),     null,
              /* S12  */        "N5_ComS_Another",           m_Report.ComS_Another(),         null,
              /* B1   */        "N5_DRB",                    m_Report.DRB(),                  null,
              /* B2   */        "N5_CrBD",                   m_Report.printCrBD_F(),          null,
              /* B3   */        "N5_DPB_DDB",                m_Report.DPB_DDB(),              null,
              /* B4   */        "N5_MaxMrkt",                m_Report.printMaxMrkt(),         null,
              /* B5   */        "N5_Val_MarketB",            m_Report.Val_MarketB(),          null,
              /* B6   */        "N5_MrktB",                  m_Report.MrktB(),                null,
              /* B7   */        "N5_DMrktB",                 m_Report.DMrktB(),               null,
              /* B8   */        "N5_QuoteValueB",            m_Report.printQuoteValueB(),     null,
              /* B9   */        "N5_RCB",                    m_Report.RCB(),                  null,
              /* B10  */        "N5_K_ControlB",             m_Report.K_ControlB(),           null,
              /* B11  */        "N5_Control_CommentB",       m_Report.Control_CommentB(),     null,
              /* B12  */        "N5_ComB_Another",           m_Report.ComB_Another(),         null,
              /* B13  */        "N5_DifB",                   m_Report.DifB(),                 null,
              /* К1   */        "N5_NkdBprevRub",            m_Report.NkdBprevRub(),          null,
              /* К2   */        "N5_NkdBrepRub",             m_Report.NkdBrepRub(),           null,
              /* К3   */        "N5_NkdBsellRub",            m_Report.NkdBsellRub(),          null,
              /* К4   */        "N5_ifCoupPrev",             m_Report.ifCoupPrev(),           null,
              /* К5   */        "N5_Tprev",                  m_Report.Tprev(),                null,
              /* К6   */        "N5_NkdPrevVN",              m_Report.NkdPrevVN(),            null,
              /* К7   */        "N5_NkdPrevRub",             m_Report.NkdPrevRub(),           null,
              /* К8   */        "N5_CoupVN",                 m_Report.CoupVN(),               null,
              /* К9   */        "N5_CoupRub",                m_Report.CoupRub(),              null,
              /* К10  */        "N5_LastCoupDate",           m_Report.LastCoupDate(),         null,
              /* А1   */        "N5_AmortVN",                m_Report.AmortVN(),              null,/*ф-ла*/
              /* А2   */        "N5_AmortVN_before",         m_Report.AmortVN_before(),       null,
              /* А3   */        "N5_AmortVN_after",          m_Report.AmortVN_after(),        null,
              /* А4   */        "N5_AmortVNPer",             m_Report.AmortVNPer(),           null,
              /* А5   */        "N5_KSumBvn",                m_Report.KSumBvn(),              null,/*ф-ла*/
              /* А6   */        "N5_SumBvp_exps",            m_Report.SumBvp_exps(),          null,/*ф-ла*/
              /* А7   */        "N5_SumBvpPrev_exps",        m_Report.SumBvpPrev_exps(),      null,/*ф-ла*/
              /* Т1   */        "N5_DqualS",                 m_Report.DqualS(),               null,
              /* Т2   */        "N5_DqualB",                 m_Report.DqualB(),               null,
              /* Т3   */        "N5_ContS",                  m_Report.ContS(),                null,
              /* Т4   */        "N5_ContB",                  m_Report.ContB(),                null,
              /* Т5   */        "N5_SecType",                m_Report.SecType(),              null,
              /* Т6   */        "N5_Taxe_All",               m_Report.Taxe_All(),             null,/*ф-ла*/
              /* Т7   */        "N5_Taxe_Amort",             m_Report.Taxe_Amort(),           null,/*ф-ла*/
              /* Т8   */        "N5_Taxe_NKD",               m_Report.Taxe_NKD(),             null,/*ф-ла*/
              /* V1   */        "N5_Fin_Res",                m_Report.Fin_Res(),              null,/*ф-ла*/
              /* V2   */        "N5_SecLax",                 m_Report.SecLax(),               null,
              /* V3   */        "N5_NkdRepRubAll",           m_Report.NkdRepRubAll(),         null,/*ф-ла*/
              /* R1   */        "N5_ISIN",                   m_Report.ISIN(),                 null,
              /* M1   */        "N5_APS",                    m_Report.APS(),                  null,
              /* M2   */        "N5_APB",                    m_Report.APB(),                  null,
              /* T9   */        "N5_DGO",                    m_Report.DGO(),                  null
                   );

  END;

  MACRO PrintAdd(FIID, FI_Code, Name, TaxGroup, Kind, FaceValueFI)

     var CoupVN:money  = m_Report.SumWarnKind(FIID, Kind),
         CoupRub:money = m_Report.SumWarnKind(FIID, Kind, NATCUR);

     m_NoDataFlag = false;
     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
              /* 1    */        "N5_SecCode",                FI_Code,                         null,
              /* 2    */        "N5_SecName",                Name,                            null,
              /* 3    */        "N5_CodeS",                  Kind,                            null,
              /* 4    */        "N5_DZS",                    null,                            null,
              /* 5    */        "N5_DDS",                    null,                            null,
              /* 6    */        "N5_Qnty",                   0,                               null,
              /* 7    */        "N5_VN",                     null,                            null,
              /* 8    */        "N5_VPrS",                   null,                            null,
              /* 9    */        "N5_PrSNom",                 0,                               null,
              /* 10   */        "N5_SumSvp",                 0,                               null,
              /* 11   */        "N5_SumSrub",                0,                               null,/*ф-ла*/
              /* 12   */        "N5_NkdSvp",                 0,                               null,
              /* 13   */        "N5_NkdSrub",                0,                               null,
              /* 14   */        "N5_SumAllrub",              0,                               null,/*ф-ла*/
              /* 15   */        "N5_NKDminusRub",            0,                               null,
              /* 16   */        "N5_DifS",                   0,                               null,
              /* 17   */        "N5_NkdRepRub",              m_Report.NkdRepRub(),            null,/*Формула выводится и в тех случаях, когда <CodeS> равно <1> или <2>.*/
              /* 18   */        "N5_AmortVNrep",             0,                               null,/*ф-ла*/
              /* 19   */        "N5_AmortRubrep",            0,                               null,
              /* 20   */        "N5_CodeB",                  null,                            null,
              /* 21   */        "N5_DZB",                    null,                            null,
              /* 22   */        "N5_DDB",                    null,                            null,
              /* 23   */        "N5_VPrB",                   null,                            null,
              /* 24   */        "N5_PrBnom",                 0,                               null,
              /* 25   */        "N5_SumBvp",                 0,                               null,
              /* 26   */        "N5_SumBrub",                0,                               null,/*ф-ла*/
              /* 27   */        "N5_NkdBvp",                 0,                               null,
              /* 28   */        "N5_NkdBrub",                0,                               null,
              /* 29   */        "N5_DifSumBRub",             0,                               null,/*ф-ла*/
              /* 30   */        "N5_SumBNRub",               0,                               null,/*ф-ла*/
              /* 30_1 */        "N5_DifSumBRub_AmortPrev",   0,                               null,/*ф-ла*/
              /* 30_2 */        "N5_SumBRub_AmortPrev",      0,                               null,/*ф-ла*/
              /* 31   */        "N5_ComS",                   0,                               null,
              /* 32   */        "N5_ComB",                   0,                               null,
              /* 31.1 */        "N5_NDSComS",                0,                               null,
              /* 32.1 */        "N5_NDSComB",                0,                               null,
              /* 33   */        "N5_RashAll",                0,                               null,/*ф-ла*/
              /* 34   */        "N5_Nom_DDS",                0,                               null,
              /* 35   */        "N5_Nom_DDB",                0,                               null,
              /* 36   */        "N5_RFISSS",                 null,                            null,
              /* 37   */        "N5_RFISSB",                 null,                            null,
              /* S0   */        "N5_SellType",               null,                            null,
              /* S1   */        "N5_DRS",                    null,                            null,
              /* S2   */        "N5_CrSD",                   0,                               null,
              /* S3   */        "N5_DPS_DDS",                0,                               null,
              /* S4   */        "N5_MinMrkt",                0,                               null,
              /* S5   */        "N5_Val_MarketS",            null,                            null,
              /* S6   */        "N5_MrktS",                  null,                            null,
              /* S7   */        "N5_DMrktS",                 null,                            null,
              /* S8   */        "N5_QuoteValueS",            0,                               null,
              /* S9   */        "N5_RCS",                    null,                            null,
              /* S10  */        "N5_K_ControlS",             null,                            null,
              /* S11  */        "N5_Control_CommentS",       null,                            null,
              /* S12  */        "N5_ComS_Another",           0,                               null,
              /* B1   */        "N5_DRB",                    null,                            null,
              /* B2   */        "N5_CrBD",                   0,                               null,
              /* B3   */        "N5_DPB_DDB",                0,                               null,
              /* B4   */        "N5_MaxMrkt",                0,                               null,
              /* B5   */        "N5_Val_MarketB",            null,                            null,
              /* B6   */        "N5_MrktB",                  null,                            null,
              /* B7   */        "N5_DMrktB",                 null,                            null,
              /* B8   */        "N5_QuoteValueB",            0,                               null,
              /* B9   */        "N5_RCB",                    null,                            null,
              /* B10  */        "N5_K_ControlB",             null,                            null,
              /* B11  */        "N5_Control_CommentB",       null,                            null,
              /* B12  */        "N5_ComB_Another",           0,                               null,
              /* B13  */        "N5_DifB",                   0,                               null,
              /* К1   */        "N5_NkdBprevRub",            0,                               null,
              /* К2   */        "N5_NkdBrepRub",             0,                               null,
              /* К3   */        "N5_NkdBsellRub",            0,                               null,
              /* К4   */        "N5_ifCoupPrev",             0,                               null,
              /* К5   */        "N5_Tprev",                  0,                               null,
              /* К6   */        "N5_NkdPrevVN",              0,                               null,
              /* К7   */        "N5_NkdPrevRub",             0,                               null,
              /* К8   */        "N5_CoupVN",                 CoupVN,                          null,
              /* К9   */        "N5_CoupRub",                CoupRub,                         null,
              /* К10  */        "N5_LastCoupDate",           null,                            null,
              /* А1   */        "N5_AmortVN",                0,                               null,/*ф-ла*/
              /* А2   */        "N5_AmortVN_before",         0,                               null,
              /* А3   */        "N5_AmortVN_after",          0,                               null,
              /* А4   */        "N5_AmortVNPer",             0,                               null,
              /* А5   */        "N5_KSumBvn",                0,                               null,/*ф-ла*/
              /* А6   */        "N5_SumBvp_exps",            0,                               null,/*ф-ла*/
              /* А7   */        "N5_SumBvpPrev_exps",        0,                               null,/*ф-ла*/
              /* Т1   */        "N5_DqualS",                 null,                            null,
              /* Т2   */        "N5_DqualB",                 null,                            null,
              /* Т3   */        "N5_ContS",                  null,                            null,
              /* Т4   */        "N5_ContB",                  null,                            null,
              /* Т5   */        "N5_SecType",                TaxGroup,                        null,
              /* Т6   */        "N5_Taxe_All",               0,                               null,/*ф-ла*/
              /* Т7   */        "N5_Taxe_Amort",             0,                               null,/*ф-ла*/
              /* Т8   */        "N5_Taxe_NKD",               0,                               null,/*ф-ла*/
              /* V1   */        "N5_Fin_Res",                0,                               null,/*ф-ла*/
              /* V2   */        "N5_SecLax",                 0,                               null,
              /* V3   */        "N5_NkdRepRubAll",           0,                               null,
              /* R1   */        "N5_ISIN",                   null,                            null,
              /* M1   */        "N5_APS",                    null,                            null,
              /* M2   */        "N5_APB",                    null,                            null,
              /* T9   */        "N5_DGO",                    null,                            null
                 );
  END;

END;

/*сводная вкладка 215*/
PRIVATE CLASS CRealizReg_215_Cons( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()

     m_Report.SetActiveSheet( m_Report.GetNumSheet_cons() );

     m_Report.PrintHeader_cons( "N51_", SHEET_0215s, m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N51_MainTable", "N51_TableHeader",
                   /* a  */  "N51_RegNum",
                   /* b  */  "N51_SecType",
                   /* c  */  "N51_SecCode",
                   /* 1  */  "N51_SecName",
                   /* 2  */  "N51_Fin_Res",
                   /* 3  */  "N51_DifSumBRub",
                   /* 4  */  "N51_DifS",
                   /* 5  */  "N51_ComS_ComB",
                   /* 6  */  "N51_Taxe_All",
                   /* 7  */  "N51_Taxe_Amort",
                   /* 8  */  "N51_Taxe_NKD",
                   /* 9  */  "N51_Qnty",
                   /* 10 */  "N51_SumAllRub",
                   /* 11 */  "N51_RashAll",
                   /* 12 */  "N51_SumSvp",
                   /* 13 */  "N51_SumBvp_exps",
                   /* 14 */  "N51_NkdRepRub",
                   /* 15 */  "N51_NKDminusRub",
                   /* 16 */  "N51_NkdSvp",
                   /* 17 */  "N51_NkdBvp",
                   /* 18 */  "N51_AmortVNrep",
                   /* 19 */  "N51_CoupVN_NkdSvp",
                   /* 20 */  "N51_NkdPrevRub",
                   /* 21 */  "N51_NkdRepRubAll",
                   /* d  */  "N51_ISIN"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                   /* 2  */  "N51_Fin_Res",
                   /* 3  */  "N51_DifSumBRub",
                   /* 4  */  "N51_DifS",
                   /* 5  */  "N51_ComS_ComB",
                   /* 6  */  "N51_Taxe_All",
                   /* 7  */  "N51_Taxe_Amort",
                   /* 8  */  "N51_Taxe_NKD",
                   /* 9  */  "N51_Qnty",
                   /* 10 */  "N51_SumAllRub",
                   /* 11 */  "N51_RashAll",
                   /* 12 */  "N51_SumSvp",
                   /* 13 */  "N51_SumBvp_exps",
                   /* 14 */  "N51_NkdRepRub",
                   /* 15 */  "N51_NKDminusRub",
                   /* 16 */  "N51_NkdSvp",
                   /* 17 */  "N51_NkdBvp",
                   /* 18 */  "N51_AmortVNrep",
                   /* 19 */  "N51_CoupVN_NkdSvp",
                   /* 20 */  "N51_NkdPrevRub",
                   /* 21 */  "N51_NkdRepRubAll"
                              );

     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N51_RegNum",   "215",         null,
                              "N51_SecType",  IIF(StrUpr(m_Report.H0_9())=="ВСЕ","",GetNumTaxGroup(m_Report.H0_9())), null,
                              "N51_SecCode",  m_Report.GetCCons(), null,
                              "N51_SecName",  ItogsLineName, null );
     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N51_SecName",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     /*подошвы для сводной нет*/
  END;

  MACRO Print(TaxGroup,FI_Code:string,Name:string,ISIN:string)

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
                             "N51_RegNum",        "215",                                                  null,
                             "N51_SecType",       TaxGroup,                                               null,
                             "N51_SecCode",       FI_Code,                                                null,
                             "N51_SecName",       Name,                                                   null,
                             "N51_Fin_Res",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Fin_Res),     null,
                             "N51_DifSumBRub",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifSumBRub),  null,
                             "N51_DifS",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifS),        null,
                             "N51_ComS_ComB",     m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_ComS, NULL, NULL, C_ComB, NULL, NULL), null,
                             "N51_Taxe_All",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_All),    null,
                             "N51_Taxe_Amort",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_Amort),  null,
                             "N51_Taxe_NKD",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Taxe_NKD),    null,
                             "N51_Qnty",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Qnty),        null,
                             "N51_SumAllRub",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumAllRub),   null,
                             "N51_RashAll",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_RashAll),     null,
                             "N51_SumSvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSvp),      null,
                             "N51_SumBvp_exps",   m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumBvp_exps), null,
                             "N51_NkdRepRub",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdRepRub),   null,
                             "N51_NKDminusRub",   m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NKDminusRub), null,
                             "N51_NkdSvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdSvp),      null,
                             "N51_NkdBvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdBvp),      null,
                             "N51_AmortVNrep",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_AmortVNrep),  null,
                             "N51_CoupVN_NkdSvp", m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_CoupVN, NULL, NULL, C_NkdSvp, C_SellType, "=1"), null,
                             "N51_NkdPrevRub",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdPrevRub),  null,
                             "N51_NkdRepRubAll",  m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdRepRubAll),null,
                             "N51_ISIN",          ISIN,                                                   null
                            );
  end;

END;

PRIVATE CLASS CRealizReg_213( Report:OBJECT )
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;

  MACRO QntyPrecision():INTEGER // точность кол-ва
     return m_Report.SumPrecision;
  END;

  MACRO Where():STRING
     /*0213 - дисконтные облигации, номинированные в рублях*/
     return " AV.t_TaxGroup <> 0 " +
            " AND RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", FI.t_AvoirKind ) > 0 " +
            " AND Rsb_SCTX.TXIsDiscountAvoir(AV.t_TaxGroup) = 1 "+
            " AND FI.t_FaceValueFI = " + NATCUR;
  END;

  MACRO PaintStr()
     m_Report.SetCurrentLineFont( 8, true, false );
     m_Report.SetCellFont("N3_SumSrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N3_NkdRepRub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N3_SumAllrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N3_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N3_RashAll", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N3_Taxe_All",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N3_Taxe_Amort", 8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N3_Taxe_NKD", 8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N3_SecLax", 8, true, false, null, null, BLUECOLOR );
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );
     m_Report.PrintHeader_0213( "N3_", SHEET_0213, m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N3_MainTable", "N3_TableHeader",
                             "N3_Dummy1",
                             "N3_SecCode",   
                             "N3_SecName",   
                             "N3_CodeS",     
                             "N3_DZS",       
                             "N3_DDS",       
                             "N3_Nom",       
                             "N3_DAuс",      
                             "N3_Dexp",      
                             "N3_PrAucNom",  
                             "N3_Qnty",      
                             "N3_PrSNom",    
                             "N3_SumSrub",   
                             "N3_NkdBefVN",  
                             "N3_NKDownVN", 
                             "N3_NkdRepRub", 
                             "N3_SumAllrub", 
                             "N3_MinMrkt",   
                             "N3_MrktS",     
                             "N3_DMrktS",    
                             "N3_DifS",      
                             "N3_ComS",
                             "N3_NDSComS",       
                             "N3_CodeB",     
                             "N3_DZB",       
                             "N3_DDB",       
                             "N3_PrBnom",    
                             "N3_SumBrub",   
                             "N3_MaxMrkt",   
                             "N3_MrktB",     
                             "N3_DMrktB",    
                             "N3_DifB",      
                             "N3_SumBtax",   
                             "N3_ComB",
                             "N3_NDSComB",       
                             "N3_RashAll",   
                             "N3_DqualS",    
                             "N3_DqualB",    
                             "N3_ContS",     
                             "N3_ContB",     
                             "N3_SecType",   
                             "N3_Taxe_All",  
                             "N3_Taxe_Amort",
                             "N3_Taxe_NKD",  
                             "N3_SecLax",
                             "N3_ISIN",
                             "N3_DGO"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                                "N3_Qnty",
                                "N3_SumSrub",
                                "N3_NkdBefVN",
                                "N3_NKDownVN",     
                                "N3_NkdRepRub",    
                                "N3_SumAllrub",
                                "N3_DifS",
                                "N3_ComS",
                                "N3_NDSComS",
                                "N3_SumBrub",
                                "N3_DifB",  
                                "N3_SumBtax",       
                                "N3_ComB",
                                "N3_NDSComB",  
                                "N3_RashAll",
                                "N3_Taxe_All",      
                                "N3_Taxe_Amort",    
                                "N3_Taxe_NKD"
                              );

     m_NoDataFlag = true;
     m_Report.SetCopyAutoSumRange("$A$7:AU7");
  END;

  MACRO EndReport()
      if(m_NoDataFlag)
         this.PrintNoData();
      end;
      m_Report.EndTable();
      m_Report.ReplaceFormulaAndCalculate();
      m_Report.SetCopyAutoSumRange(null);

      if(not m_NoDataFlag)
         m_Report.SetOnAutoFilter(SHEET_0213, "B13:AV13");
      end;
  END;


  macro PrintNoData()
      m_Report.PrintTableLine( "N3_SecCode",  NoDataTxt, null );

  end;

  MACRO Dauc():DATE //  Дата размещения ц/б
     var Avoir = TBFile("avoiriss.dbt", "R", 0);
     Avoir.Clear();
     Avoir.rec.FIID = m_Report.m_RS.t_FIID;
     if(Avoir.GetEQ())
        return SQL_ConvTypeDate( Avoir.rec.BegPlacementDate );
     else
        return SQL_ConvTypeDate( date(0, 0, 0) );
     end;
  END;

  MACRO Print()
     m_NoDataFlag = false;
     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine( "N3_SecCode",    m_Report.SecCode(),          null,
                              "N3_SecName",    m_Report.SecName(),          null,
                              "N3_CodeS",      m_Report.CodeS(),            null,
                              "N3_DZS",        m_Report.DZS(),              null,
                              "N3_DDS",        m_Report.DDS(),              null,
                              "N3_Nom",        m_Report.Nom(),              null,
                              "N3_DAuс",       /*m_Report.*/Dauc(),             null,
                              "N3_Dexp",       m_Report.Dexp(),             null,
                              "N3_PrAucNom",   m_Report.printPrAucNom(),    null,
                              "N3_Qnty",       m_Report.printQnty(),        null,
                              "N3_PrSNom",     m_Report.printPrSNom(),      null,
                              "N3_SumSrub",    m_Report.SumSrub(),          null,/*ф-ла*/
                              "N3_NkdBefVN",   m_Report.NkdBefVN(),         null,
                              "N3_NKDownVN",   m_Report.NKDownVN(),         null, 
                              "N3_NkdRepRub",  m_Report.NkdRepRub(),        null,        
                              "N3_SumAllrub",  m_Report.SumAllrub(),        null,/*ф-ла*/
                              "N3_MinMrkt",    m_Report.printMinMrkt(),     null,
                              "N3_MrktS",      m_Report.MrktS(),            null,
                              "N3_DMrktS",     m_Report.DMrktS(),           null,
                              "N3_DifS",       m_Report.DifS(),             null,
                              "N3_ComS",       m_Report.ComS(),             null,
                              "N3_NDSComS",    m_Report.NDSComS(),          null,
                              "N3_CodeB",      m_Report.CodeB(),            null,
                              "N3_DZB",        m_Report.DZB(),              null,
                              "N3_DDB",        m_Report.DDB(),              null,
                              "N3_PrBnom",     m_Report.printPrBnom(),      null,
                              "N3_SumBrub",    m_Report.SumBrub(),          null,/*ф-ла*/
                              "N3_MaxMrkt",    m_Report.printMaxMrkt(),     null,
                              "N3_MrktB",      m_Report.MrktB(),            null,
                              "N3_DMrktB",     m_Report.DMrktB(),           null,
                              "N3_DifB",       m_Report.DifB(),             null,
                              "N3_SumBtax",    m_Report.SumBtax(),          null,/*ф-ла*/
                              "N3_ComB",       m_Report.ComB(),             null,
                              "N3_NDSComB",    m_Report.NDSComB(),          null,
                              "N3_RashAll",    m_Report.RashAll(),          null,/*ф-ла*/
                              "N3_DqualS",     m_Report.DqualS(),           null,
                              "N3_DqualB",     m_Report.DqualB(),           null,
                              "N3_ContS",      m_Report.ContS(),            null,
                              "N3_ContB",      m_Report.ContB(),            null,
                              "N3_SecType",    m_Report.SecType(),          null,        
                              "N3_Taxe_All",   m_Report.Taxe_All(),         null,/*ф-ла*/
                              "N3_Taxe_Amort", m_Report.Taxe_Amort(),       null,/*ф-ла*/
                              "N3_Taxe_NKD",   m_Report.Taxe_NKD(),         null,/*ф-ла*/
                              "N3_SecLax",     m_Report.SecLax(),           null,
                              "N3_ISIN",       m_Report.ISIN(),             null,
                              "N3_DGO",        m_Report.DGO(),              null
                            );
  END;

END;

PRIVATE CLASS CRealizReg_216( Report:OBJECT )
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;

  MACRO QntyPrecision():INTEGER // точность кол-ва
     return m_Report.SumPrecision;
  END;

  MACRO Where():STRING
     /*0216 - дисконтные облигации, номинированные в иностранной валюте*/
     return " AV.t_TaxGroup <> 0 " +
            " AND RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", FI.t_AvoirKind ) > 0 " +
            " AND Rsb_SCTX.TXIsDiscountAvoir(AV.t_TaxGroup) = 1 "+
            " AND FI.t_FaceValueFI != " + NATCUR;
  END;

  MACRO PaintStr()
     m_Report.SetCurrentLineFont( 8, true, false );
     m_Report.SetCellFont("N6_SumSrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N6_NkdBefRub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N6_NkdRepRub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N6_SumAllrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N6_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N6_RashAll", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N6_Taxe_All",8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N6_Taxe_Amort", 8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N6_Taxe_NKD", 8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N6_SecLax", 8, true, false, null, null, BLUECOLOR );
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );
     m_Report.PrintHeader_0216( "N6_", SHEET_0216, m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N6_MainTable", "N6_TableHeader",
                             "N6_Dummy1",
                             "N6_SecCode",   
                             "N6_SecName",   
                             "N6_CodeS",     
                             "N6_DZS",       
                             "N6_DDS",       
                             "N6_Nom",       
                             "N6_VN",        
                             "N6_VPrS",      
                             "N6_DAuс",      
                             "N6_Dexp",      
                             "N6_Qnty",      
                             "N6_PrSnom",   
                             "N6_SumSvp",    
                             "N6_SumSrub",  
                             "N6_NkdBefVN",  
                             "N6_NkdBefRub", 
                             "N6_NKDownVN", 
                             "N6_NKDownRub",
                             "N6_NkdRepRub", 
                             "N6_SumAllrub", 
                             "N6_MinMrkt",   
                             "N6_MrktS",     
                             "N6_DMrktS",    
                             "N6_DifS",      
                             "N6_ComS",
                             "N6_NDSComS",       
                             "N6_CodeB",     
                             "N6_DZB",       
                             "N6_DDB",       
                             "N6_PrBnom",    
                             "N6_VPrB",      
                             "N6_SumBvp",    
                             "N6_SumBrub",   
                             "N6_MaxMrkt",   
                             "N6_MrktB",     
                             "N6_DMrktB",    
                             "N6_DifB",      
                             "N6_SumBtax",   
                             "N6_ComB",
                             "N6_NDSComB",       
                             "N6_RashAll",  
                             "N6_CrSD",      
                             "N6_CrBD",      
                             "N6_DqualS",    
                             "N6_DqualB",    
                             "N6_ContS",     
                             "N6_ContB",     
                             "N6_SecType",   
                             "N6_Taxe_All",  
                             "N6_Taxe_Amort",
                             "N6_Taxe_NKD",  
                             "N6_SecLax",
                             "N6_ISIN",
                             "N6_DGO"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                                "N6_Qnty",
                                "N6_SumSrub",
                                "N6_NkdBefVN",
                                "N6_NkdBefRub",
                                "N6_NKDownVN",     
                                "N6_NKDownRub",
                                "N6_NkdRepRub",    
                                "N6_SumAllrub",
                                "N6_DifS",
                                "N6_ComS",
                                "N6_NDSComS",
                                "N6_SumBrub",
                                "N6_DifB",  
                                "N6_SumBtax",       
                                "N6_ComB",
                                "N6_NDSComB",   
                                "N6_RashAll",
                                "N6_Taxe_All",      
                                "N6_Taxe_Amort",    
                                "N6_Taxe_NKD"
                              );

     m_NoDataFlag = true;
     m_Report.SetCopyAutoSumRange("$A$7:AU7");

  END;

  MACRO EndReport()
      if(m_NoDataFlag)
         this.PrintNoData();
      end;
      m_Report.EndTable();
      m_Report.ReplaceFormulaAndCalculate();
      m_Report.SetCopyAutoSumRange(null);

      if(not m_NoDataFlag)
         m_Report.SetOnAutoFilter(SHEET_0216, "B13:BC13");
      end;
  END;

  macro PrintNoData()
      m_Report.PrintTableLine( "N6_SecCode",  NoDataTxt, null );
  end;

  MACRO Dauc():DATE //  Дата размещения ц/б
     var Avoir = TBFile("avoiriss.dbt", "R", 0);
     Avoir.Clear();
     Avoir.rec.FIID = m_Report.m_RS.t_FIID;
     if(Avoir.GetEQ())
        return SQL_ConvTypeDate( Avoir.rec.BegPlacementDate );
     else
        return SQL_ConvTypeDate( date(0, 0, 0) );
     end;
  END;

  MACRO Print()
      m_NoDataFlag = false;
     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine( "N6_SecCode",     m_Report.SecCode(),          null,
                              "N6_SecName",     m_Report.SecName(),          null,
                              "N6_CodeS",       m_Report.CodeS(),            null,
                              "N6_DZS",         m_Report.DZS(),              null,
                              "N6_DDS",         m_Report.DDS(),              null,
                              "N6_Nom",         m_Report.Nom(),              null,
                              "N6_VN",          m_Report.VN(),               null,
                              "N6_VPrS",        m_Report.VPrSNumber(),       null,
                              "N6_DAuс",        /*m_Report.*/Dauc(),             null,
                              "N6_Dexp",        m_Report.Dexp(),             null,
                              "N6_Qnty",        m_Report.printQnty(),        null,        
                              "N6_PrSnom",      m_Report.printPrSNom(),      null,        
                              "N6_SumSvp",      m_Report.SumSvp(),           null,
                              "N6_SumSrub",     m_Report.SumSrub(),          null,/*ф-ла*/
                              "N6_NkdBefVN",    m_Report.NkdBefVN(),         null,
                              "N6_NkdBefRub",   m_Report.NkdBefRub(),        null,
                              "N6_NKDownVN",    m_Report.NKDownVN(),         null,
                              "N6_NKDownRub",   m_Report.NKDownRub(),        null,
                              "N6_NkdRepRub",   m_Report.NkdRepRub(),        null,        
                              "N6_SumAllrub",   m_Report.SumAllrub(),        null,/*ф-ла*/
                              "N6_MinMrkt",     m_Report.printMinMrkt(),     null,        
                              "N6_MrktS",       m_Report.MrktS(),            null,        
                              "N6_DMrktS",      m_Report.DMrktS(),           null,        
                              "N6_DifS",        m_Report.DifS(),             null,        
                              "N6_ComS",        m_Report.ComS(),             null,
                              "N6_NDSComS",     m_Report.NDSComS(),          null,
                              "N6_CodeB",       m_Report.CodeB(),            null,
                              "N6_DZB",         m_Report.DZB(),              null,
                              "N6_DDB",         m_Report.DDB(),              null,
                              "N6_PrBnom",      m_Report.printPrBnom(),      null,
                              "N6_VPrB",        m_Report.VPrBNumber(),       null,
                              "N6_SumBvp",      m_Report.SumBvp(),           null,
                              "N6_SumBrub",     m_Report.SumBrub(),          null,/*ф-ла*/
                              "N6_MaxMrkt",     m_Report.printMaxMrkt(),     null,
                              "N6_MrktB",       m_Report.MrktB(),            null,
                              "N6_DMrktB",      m_Report.DMrktB(),           null,
                              "N6_DifB",        m_Report.DifB(),             null,
                              "N6_SumBtax",     m_Report.SumBtax(),          null,/*ф-ла*/
                              "N6_ComB",        m_Report.ComB(),             null, 
                              "N6_NDSComB",     m_Report.NDSComB(),          null,         
                              "N6_RashAll",     m_Report.RashAll(),          null,/*ф-ла*/
                              "N6_CrSD",        m_Report.printCrSD_F(),      null,
                              "N6_CrBD",        m_Report.printCrBD_F(),      null,
                              "N6_DqualS",      m_Report.DqualS(),           null,
                              "N6_DqualB",      m_Report.DqualB(),           null,
                              "N6_ContS",       m_Report.ContS(),            null,
                              "N6_ContB",       m_Report.ContB(),            null,
                              "N6_SecType",     m_Report.SecType(),          null,        
                              "N6_Taxe_All",    m_Report.Taxe_All(),         null,/*ф-ла*/
                              "N6_Taxe_Amort",  m_Report.Taxe_Amort(),       null,/*ф-ла*/
                              "N6_Taxe_NKD",    m_Report.Taxe_NKD(),         null,/*ф-ла*/
                              "N6_SecLax",      m_Report.SecLax(),           null,
                              "N6_ISIN",        m_Report.ISIN(),             null,
                              "N6_DGO",         m_Report.DGO(),              null
                            );
  END;

END;

PRIVATE CLASS (TX_RegistrReport) SP_RealizReg_Report_2014( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, ForceFormatRep:INTEGER )
  PRIVATE VAR m_RunByQuoted = false, m_RunByNoQuoted = false, m_RunByTech = false, m_RunByFISS = false;
  PRIVATE VAR m_IsPrintByQuoted = false;
  PRIVATE VAR m_IsPrintByNoQuoted = false;
  PRIVATE VAR m_IsPrintByTech = false;
  PRIVATE VAR m_INN, m_KPP;
  PRIVATE VAR m_CurrStrNum = 0;
  PRIVATE VAR m_SHEET_1 = "", m_SHEET_2 = "";/*основная и сводная вкладки*/
  PRIVATE VAR m_IsPrintByFISS = false;
  PRIVATE VAR m_SCTXUseCommAsOutlay = SCTXUseCommAsOutlay();

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/

  PRIVATE VAR m_NkdBvp,
              m_AmortVNPer,
              m_AmortVN_after,
              m_AmortVN_before,
              m_AmortRubrep,
              m_NkdSvp,
              m_Cr_Val_MrkSZ,
              m_Cr_Val_MrkBZ,
              m_CrSpezB,
              m_CrSpezS,
              m_DDB;

  PRIVATE VAR m_FI_NRecs,
              m_FI_CurNRec;

   private var m_CopyAutoSumRange = null;

  MACRO IsDataExist()
     return m_IsDataExist();
  END;

  MACRO Fill_Cell_Name()

     if( m_ReportKind == REALIZREG_0211 )
        C_Qnty                = "G";
        C_SecCode_2           = "C";
        C_SecCode             = "B";
        C_DifS                 = "M";
        C_SumBrub              = "T";
        C_SumSvp               = "K";
        C_SumBvp               = "S";
        C_CrSD                 = "AE";
        C_CrBD                 = "AS";
        C_ComS                 = "W";
        C_SumBtax              = "V";
        C_ComB                 = "X";
        C_DifB                 = "U";
        C_SumSrub              = "L";
        C_RashAll              = "AA";
        C_Fin_Res              = "BL";
        C_Taxe_All             = "BK";

     elif( m_ReportKind == REALIZREG_0212 )
        C_Qnty      = "F";/*совпадает для 211 и 212 и 215*/
        C_SecCode_2 = "C";/*совпадает для 211 и 212 и 215*/
        C_SecCode   = "A";/*совпадает для 211 и 212 и 215*/

        C_DifS                 = "L";
        C_SumBrub              = "U";
        C_SumSvp               = "AM";
        C_RashAll              = "AE";
        C_Taxe_All             = "CD";
        C_ComB                 = "AB";
        C_ComS                 = "AA";
        C_Fin_Res              = "CG";
        C_SumBvp               = "AY";
        C_DifB                 = "BI";
        C_CrBD                 = "AX";
        C_SumSrub              = "H";
        C_CrSD                 = "AL";
        C_NkdPrevVN            = "BO";
        C_CoupVN               = "BP";
        C_NkdSvp               = "I";
        C_AmortVNrep           = "P";
        C_NkdBvp               = "V";
        C_NKDminusRub          = "K";
        C_NkdRepRub            = "M";
        C_NkdRepRub1           = "N";
        C_NkdRepRub2           = "O";
        C_SumBvp_exps          = "BX";
        C_SumAllRub            = "J";
        C_Taxe_NKD             = "CF";
        C_Taxe_Amort           = "CE";
        C_DifSumBRub           = "W";
        C_KSumBvn              = "BW";
        C_AmortVN              = "BS";
        C_AmortVN_before       = "BT";
        C_AmortVN_after        = "BU";
        C_AmortVNPer           = "BV";
        C_Nom_DDB              = "AG";
        C_SumBNRub             = "X";
        C_NkdBSellRub          = "BL";
        C_DifSumBRub_AmortPrev = "Y";
        C_SecType              = "CC";
        C_CodeS                = "C";
        C_NkdBrepRub           = "BK";
        C_SellType             = "AJ";
        C_NkdRepRubAll         = "CI";
        C_NomH01               = "CK";
        C_NomH02               = "CL";

     elif( m_ReportKind == REALIZREG_0215 )
        C_Qnty      = "G";/*совпадает для 211 и 212 и 215*/
        C_SecCode_2 = "C";/*совпадает для 211 и 212 и 215*/
        C_SecCode   = "B";/*совпадает для 211 и 212 и 215*/

        C_SumSvp               = "K";
        C_SumSrub              = "L";
        C_NkdSrub              = "N";
        C_SumAllRub            = "O";
        C_NKDminusRub          = "P";
        C_DifS                 = "Q";
        C_NkdRepRub            = "R";
        C_AmortRubrep          = "T";
        C_SumBvp               = "Z";
        C_SumBrub              = "AA";
        C_DifSumBRub           = "AD";
        C_SumBNRub             = "AE";
        C_DifSumBRub_AmortPrev = "AF";
        C_ComS                 = "AH";
        C_ComB                 = "AI";
        C_RashAll              = "AL";
        C_Nom_DDB              = "AN";
        C_CrSD                 = "AS"; //
        C_CrBD                 = "BE";
        C_DifB                 = "BP";
        C_NkdBPrevRub          = "BQ";
        C_NkdBrepRub           = "BR";
        C_NkdBSellRub          = "BS";
        C_CoupRub              = "BY";
        C_AmortVN              = "CA";
        C_AmortVN_before       = "CB";
        C_AmortVN_after        = "CC";
        C_AmortVNPer           = "CD";
        C_KSumBvn              = "CE";
        C_SumBvp_exps          = "CF";
        C_Taxe_Amort           = "CN";
        C_Taxe_NKD             = "CO";
        C_Fin_Res              = "CP";
        C_Taxe_All             = "CM";
        C_NkdSvp               = "M";
        C_NkdBvp               = "AB";
        C_AmortVNrep           = "S";
        C_CoupVN               = "BX";
        C_NkdPrevRub           = "BW";
        C_SecType              = "CL";
        C_SellType             = "AQ";
        C_NkdRepRubAll         = "CR";

     elif( m_ReportKind == REALIZREG_0213 )
        C_Qnty      = "G";/*совпадает для 211 и 212 и 215*/
        C_SecCode_2 = "C";/*совпадает для 211 и 212 и 215*/
        C_SecCode   = "B";/*совпадает для 211 и 212 и 215*/

        C_SumSrub              = "M";
        C_NkdOwnVN             = "O";
        C_NkdBefVN             = "N";
        C_NkdRepRub            = "P";
        C_SumBrub              = "AB";
        C_DifB                 = "AF";
        C_ComS                 = "V";
        C_SumBtax              = "AG";
        C_ComB                 = "AH";
        C_Taxe_Amort           = "AQ";
        C_Taxe_NKD             = "AR";
        C_SumAllRub            = "Q";
        C_DifS                 = "U";
        C_RashAll              = "AJ";

     elif( m_ReportKind == REALIZREG_0216 )
        C_Qnty      = "G";/*совпадает для 211 и 212 и 215*/
        C_SecCode_2 = "C";/*совпадает для 211 и 212 и 215*/
        C_SecCode   = "B";/*совпадает для 211 и 212 и 215*/

        C_SumSrub              = "O";
        C_NKDownRub            = "S";
        C_NkdBefVN             = "P";
        C_NkdBefRub            = "Q";
        C_NkdRepRub            = "T";
        C_SumSvp               = "N";
        C_SumBrub              = "AH";
        C_DifB                 = "AL";
        C_ComS                 = "Z";
        C_SumBtax              = "AM";
        C_ComB                 = "AN";
        C_Taxe_Amort           = "AY";
        C_Taxe_NKD             = "AZ";
        C_SumAllRub            = "U";
        C_DifS                 = "Y";
        C_RashAll              = "AP";
        C_CrSD                 = "AQ";
        C_SumBvp               = "AG";
        C_CrBD                 = "AR";

     end;

  END;

  MACRO ClearCacheOneRecord()
    this.ClearCacheOneRecord();
    m_ifCoupPrev     = null;
    m_NkdBvp         = null;
    m_AmortVNPer     = null;
    m_AmortVN_after  = null;
    m_AmortVN_before = null;
    m_AmortRubrep    = null;
    m_NkdSvp         = null;
    m_Cr_Val_MrkSZ   = null;
    m_Cr_Val_MrkBZ   = null;
    m_CrSpezB        = null;
    m_CrSpezS        = null;
    m_DDB            = null;
  END;

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  MACRO GetNumSheet()
     return m_SHEET_1;
  END;

  MACRO GetNumSheet_cons()
     return m_SHEET_2;
  END;

  /*Наименование нашего банка*/
  MACRO H0_A():STRING
     return ПолучитьКороткоеИмяСубъекта( {OurBank} );
  END;

  MACRO H0_B_INN()
     if( m_INN == null )
        SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), m_INN, m_KPP );
     end;
     return m_INN;
  END;

  MACRO H0_B_KPP()
     if( m_KPP == null )
        SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), m_INN, m_KPP );
     end;
     return m_KPP;
  END;

  /*Начало отчетного периода */
  MACRO H0_7():DATE
     return date(m_H07);
  END;

  /*Отчетная дата, указанная в форме запуска отчета*/
  MACRO H0_8():DATE
     return date(m_H08);
  END;

  /*Выпуск ц/б*/
  MACRO H0_11():STRING
     return RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_AVRNAME_2014 );
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
     var ByQuoted = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_BYQUOTED_2014 );
     var ByNoQuoted = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_BYNOQUOTED_2014 );
     var ByTech = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_BYTECH_2014 );
     var ByFISS = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_FISS_2014 );

     if (SecondStart)
        m_RunByQuoted = false;
        m_RunByNoQuoted = true;
        m_RunByTech   = false;
        m_RunByFISS   = false;
     else
        if((ByQuoted == SET_CHAR) and (m_IsPrintByQuoted == false))
          m_IsPrintByQuoted = true;

          m_RunByQuoted = true;
          m_RunByNoQuoted = false;
          m_RunByTech   = false;
          m_RunByFISS   = false;
        elif((ByNoQuoted == SET_CHAR) and (m_IsPrintByNoQuoted == false))
          m_IsPrintByNoQuoted = true;

          m_RunByQuoted = false;
          m_RunByNoQuoted = true;
          m_RunByTech   = false;
          m_RunByFISS   = false;
        elif((ByTech == SET_CHAR) and (m_IsPrintByTech == false))
          m_IsPrintByTech = true;

          m_RunByQuoted = false;
          m_RunByNoQuoted = false;
          m_RunByTech   = true;
          m_RunByFISS   = false;
        elif( (ByFISS == SET_CHAR) and (m_IsPrintByFISS == false) )
          m_IsPrintByFISS = true;

          m_RunByQuoted = false;
          m_RunByNoQuoted = false;
          m_RunByTech   = false;
          m_RunByFISS   = true;
        end;
     end;

     m_H07 = RealizReg_Form.GetFieldValue(PNFLD_REALIZREG_BEGINDATE_2014);
     m_H08 = RealizReg_Form.GetFieldValue(PNFLD_REALIZREG_ENDDATE_2014);
  END;

  PRIVATE MACRO SetAutoFilter()
     if( ExistsSheet( SHEET_0211s ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:Q28", SHEET_0211s);
     end;

     if( ExistsSheet( SHEET_0212 ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:CR28", SHEET_0212);
     end;

     if( ExistsSheet( SHEET_0212s ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:Z28", SHEET_0212s);
     end;

     if( ExistsSheet( SHEET_0215s ) )
        m_ObjTemplateXLS.SetAutoFilter("A28:Y28", SHEET_0215s);
     end;
  END;

   MACRO SetOnAutoFilter(sheet, range)
     if( ExistsSheet( sheet ) )
         m_ObjTemplateXLS.SetAutoFilter(range, sheet);
     end;
  end;

  MACRO ПечататьПромежуточныеИтоги_0211()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_biq12386,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_biq12386,
                        "G23",
                        "K23",
                        "L23",
                        "M23",
                        "S23",
                        "T23",
                        "U23",
                        "V23",
                        "W23",
                        "X23",
                        "Y23",
                        "Z23",
                        "AA23",
                        "AH23",
                        "AV23",
                        "BK23",
                        "BL23"
                    );
  END;

  MACRO ПечататьПромежуточныеИтоги_0211_SVOD()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",
                        "H22",
                        "I22",
                        "J22",
                        "K22",
                        "L22",
                        "M22",
                        "N22",
                        "O22",
                        "P22"
                    );     /*PDV*/
  END;

  MACRO ПечататьПромежуточныеИтоги_0212()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "F23",
                        "H23",
                        "I23",
                        "J23",
                        "K23",
                        "L23",
                        "M23",
                        "N23",
                        "O23",
                        "P23",
                        "U23",
                        "V23",
                        "W23",
                        "X23",
                        "Y23",
                        "Z23",
                        "AA23",
                        "AB23",
                        "AE23",
                        "BI23",
                        "BK23",
                        "BL23",
                        "BN23",
                        "BO23",
                        "BP23",
                        "BR23",
                        "BS23",
                        "BT23",
                        "BU23",
                        "BV23",
                        "BX23",
                        "CD23",
                        "CE23",
                        "CF23",
                        "CG23",
                        "CM23",
                        "CN23",
                        "CO23"
                    );
  END;

  MACRO ПечататьПромежуточныеИтоги_0212_SVOD()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",
                        "H22",
                        "I22",
                        "J22",
                        "K22",
                        "L22",
                        "M22",
                        "N22",
                        "O22",
                        "P22",
                        "Q22",
                        "R22",
                        "S22",
                        "T22",
                        "U22",
                        "V22",
                        "W22",
                        "X22",
                        "Y22"
                    );          
  END;

  MACRO ПечататьПромежуточныеИтоги_0215()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "F23",
                        "J23",
                        "K23",
                        "L23",
                        "M23",
                        "N23",
                        "O23",
                        "P23",
                        "Q23",
                        "R23",
                        "S23",
                        "Y23",
                        "Z23",
                        "AA23",
                        "AB23",
                        "AC23",
                        "AD23",
                        "AE23",
                        "AF23",
                        "AG23",
                        "AH23",
                        "AK23",
                        "AS23",
                        "BE23",
                        "BO23",
                        "BP23",
                        "BQ23",
                        "BR23",
                        "BS23",
                        "BT23",
                        "BU23",
                        "BV23",
                        "BW23",
                        "BX23",
                        "BZ23",
                        "CA23",
                        "CB23",
                        "CC23",
                        "CE23",
                        "CF23",
                        "CL23",
                        "CM23",
                        "CN23",
                        "CO23"
                    );       /*PDV*/
  END;

  MACRO ПечататьПромежуточныеИтоги_0215_SVOD()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",
                        "H22",
                        "I22",
                        "J22",
                        "K22",
                        "L22",
                        "M22",
                        "N22",
                        "O22",
                        "P22",
                        "Q22",
                        "R22",
                        "S22",
                        "T22",
                        "U22",
                        "V22",
                        "W22",
                        "X22"
                    );     
  END;

  MACRO ПечататьПромежуточныеИтоги_0213()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "J23",
                        "L23",
                        "M23",
                        "N23",
                        "O23",
                        "P23",
                        "T23",
                        "U23",
                        "AA23",
                        "AE23",
                        "AF23",
                        "AG23",
                        "AI23",
                        "AO23",
                        "AP23",
                        "AQ23"
                    );/*PDV*/
  END;

  MACRO ПечататьПромежуточныеИтоги_0216()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "K23",
                        "N23",
                        "O23",
                        "P23",
                        "Q23",
                        "R23",
                        "S23",
                        "T23",
                        "X23",
                        "Y23",
                        "AG23",
                        "AK23",
                        "AL23",
                        "AM23",
                        "AO23",
                        "AW23",
                        "AX23",
                        "AY23"
                    );     /*PDV*/
  END;

  PRIVATE MACRO OnAfterFirstAutoFill()
     if( m_ObjTemplateXLS.SheetName() == SHEET_0211 )
        //this.ПечататьПромежуточныеИтоги_0211();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0211s )
        this.ПечататьПромежуточныеИтоги_0211_SVOD();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0212 )
        this.ПечататьПромежуточныеИтоги_0212();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0212s )
        this.ПечататьПромежуточныеИтоги_0212_SVOD();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0215s )
        this.ПечататьПромежуточныеИтоги_0215_SVOD();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0213 )
         //this.ПечататьПромежуточныеИтоги_0213();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0216 )
        //this.ПечататьПромежуточныеИтоги_0216(); 
     end;
  END;

  PRIVATE MACRO DelPortfolioColumn()
     if( ExistsSheet( SHEET_0211 ) )
        m_ObjTemplateXLS.RemoveColumn("BO:BP", SHEET_0211);
     end;

     if( ExistsSheet( SHEET_0212 ) )
        m_ObjTemplateXLS.RemoveColumn("CP:CQ", SHEET_0212);
     end;

     if( ExistsSheet( SHEET_0215 ) )
        m_ObjTemplateXLS.RemoveColumn("CT:CU", SHEET_0215);
     end;
  END;

   MACRO DeleteRows(sheet, range)
      if( ExistsSheet( sheet ) )
         m_ObjTemplateXLS.RemoveRow(range, sheet);
      end;
   end;

  PRIVATE MACRO EndReport()
    EndReport();
    SetAutoFilter();
    if(not SCTXNeedUsePortfolio())
      //если не нужно использовать портфели в учете, то удалим соответствующие колонки из отчета с помощью экселевского макроса
      DelPortfolioColumn();
    end;
  END;

  MACRO GetCCons()
     var CCons = "";

     if( m_RunByNoQuoted )
        CCons = "N";
     elif( m_RunByFISS )
        CCons = "F";
     elif( m_RunByTech )
        CCons = "T";
     end;

     return CCons;
  END;

  MACRO CReport_DataExist()
       return ((m_RunByQuoted == true) or (m_RunByNoQuoted == true) or (m_RunByTech == true)or (m_RunByFISS == true));
  END;

  /*Группа налогового учета*/
  MACRO H0_9():STRING
     var GroupName = "";
     RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_AVRGROUP_2014, @GroupName );
     return GroupName;
  END;

  MACRO SetCurrentStrNumber()
     m_CurrStrNum = this.НомерТекущейСтроки();
  END;

  /*получить адрес ячейки*/
  MACRO GetSumSvp():STRING
     return (C_SumSvp+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBvp():STRING
     return (C_SumBvp+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetCrSD():STRING
     return (C_CrSD+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetCrBD():STRING
     return (C_CrBD+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetComS():STRING
     return (C_ComS+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNDSComS():STRING
     return (C_NDSComS+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBtax():STRING
     return (C_SumBtax+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetComB():STRING
     return (C_ComB+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNDSComB():STRING
     return (C_NDSComB+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBrub():STRING
     return (C_SumBrub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetDifB():STRING
     return (C_DifB+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumSrub():STRING
     return (C_SumSrub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetDifS():STRING
     return (C_DifS+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetRashAll():STRING
     return (C_RashAll+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetTaxe_All():STRING
     return (C_Taxe_All+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumAllRub():STRING
     return (C_SumAllRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNKDminusRub():STRING
     return (C_NKDminusRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdRepRub():STRING
     return (C_NkdRepRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdRepRub1():STRING
     return (C_NkdRepRub1+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdRepRub2():STRING
     return (C_NkdRepRub2+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetDifSumBRub():STRING
     return (C_DifSumBRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetTaxe_Amort():STRING
     return (C_Taxe_Amort+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetTaxe_NKD():STRING
     return (C_Taxe_NKD+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBvp_exps():STRING
     return (C_SumBvp_exps+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetKSumBvn():STRING
     return (C_KSumBvn+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortVN():STRING
     return (C_AmortVN+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortVN_before():STRING
     return (C_AmortVN_before+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortVN_after():STRING
     return (C_AmortVN_after+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortVNPer():STRING
     return (C_AmortVNPer+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNom_DDB():STRING
     return (C_Nom_DDB+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetQnty():STRING
     return (C_Qnty+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSumBNRub():STRING
     return (C_SumBNRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdBSellRub():STRING
     return (C_NkdBSellRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetDifSumBRub_AmortPrev():STRING
     return (C_DifSumBRub_AmortPrev+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSecType():STRING
     return (C_SecType+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdSvp():STRING
     return (C_NkdSvp+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdSrub():STRING
     return (C_NkdSrub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortVNrep():STRING
     return (C_AmortVNrep+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetAmortRubrep():STRING
     return (C_AmortRubrep+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetCoupVN():STRING
     return (C_CoupVN+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetCoupRub():STRING
     return (C_CoupRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdPrevVN():STRING
     return (C_NkdPrevVN+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdPrevRub():STRING
     return (C_NkdPrevRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdBrepRub():STRING
     return (C_NkdBrepRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetSellType():STRING
     return (C_SellType+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNomH01():STRING
     return (C_NomH01+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNomH02():STRING
     return (C_NomH02+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdRepRubAll():STRING
     return (C_NkdRepRubAll+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdOwnVN():STRING
     return (C_NkdOwnVN+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNKDownRub():STRING
     return (C_NKDownRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdBefVN():STRING
     return (C_NkdBefVN+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNkdBefRub():STRING
     return (C_NkdBefRub+string(m_CurrStrNum));
  END;

  MACRO GetSubKindReg()
     var Quoted = "";

     if( m_RunByQuoted == true )
        Quoted = "Обращающиеся на Бирже";
     elif( m_RunByTech == true )
        Quoted = "Технические сделки реализации";
     elif( m_RunByNoQuoted == true )
        Quoted = "Не обращающиеся на Бирже";
     elif( m_RunByFISS == true )
        Quoted = "Сделки ПФИ";
     end;

     return Quoted;
  END;

  MACRO GetSubKindReg_biq12386():string
     var Quoted = "";

     if( m_RunByQuoted == true )
        Quoted = "АР-07-0211-Обр-Разные";
     elif( m_RunByNoQuoted == true )
        Quoted = "АР-07-0211-неОбр-Разные";
     end;

     return Quoted;
  END;

  macro GetYear():string
     var display_val, year;
     RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_YEAR_2014, @display_val, @year );
     return string(year);
  end;

  macro GetPeriodCode():string
      //N1_H0_PeriodCode
      var code = "";
      var display_val, growth_realval, period;
      var growth:bool = false;

      RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_GROWTH_2014, @display_val, @growth_realval );
      if(growth_realval == "X")
         growth = true;
      end;
      RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_PERIOD_2014, @display_val, @period );
      // значения period 1-12 номер месяца, 13-16 кварталы I-IV
      if(period == 13)
         code = "21";
      elif(growth and ((period == 14) or (period == 6)))
         code = "31";
      elif(growth and ((period == 15) or (period == 9)))
         code = "33";
      elif(growth and ((period == 16) or (period == 12)))
         code = "34";
      end;

      return code;
  end;

  macro GetPeriodTxt():string
      //N1_H0_PeriodTxt
      const ytxt = " ГОДА";
      const y2txt = " ГОД";
      const mtxt = " МЕСЯЦЕВ ";
      const qtxt = " КВАРТАЛ ";

      var code = "";
      var display_val, period, growth_realval;
      var growth:bool = false;
      var y = GetYear();

      RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_GROWTH_2014, @display_val, @growth_realval );
      if(growth_realval == "X")
         growth = true;
      end;
      RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_PERIOD_2014, @display_val, @period );
      // значения period 1-12 номер месяца, 13-16 кварталы I-IV
      if((period == 13) or (growth and (period == 3))) // 1 кв
         code = "1"+qtxt+y+ytxt;
      elif(growth and ((period == 14) or (period == 6)))
         code = "I ПОЛУГОДИЕ " + y + ytxt;
      elif(growth and ((period == 15) or (period == 9)))
         code = "9" + mtxt + y + ytxt;
      elif(growth and ((period == 16) or (period == 12)))
         code = y + y2txt;
      elif(growth and (period > 0) and (period < 12))
         code = string(period) + mtxt + y + ytxt;
      elif((not growth) and (period > 13) and (period < 17))
         code = string(period-12) + qtxt + y + ytxt;
      elif((not growth) and (period > 0) and (period < 13))
         code = StrUpr( MonName(period) ) + " " + y + ytxt;
      end;

      return code;
  end;

  macro GetAnRegister():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0211-Обр-Разные";
    elif( m_RunByNoQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0211-неОбр-Разные";
    end;

    return Quoted;
  end;

  macro GetAnRegister_0215():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0215-Обр-Разные";
    elif( m_RunByNoQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0215-неОбр-Разные";
    end;

    return Quoted;
  end;

  macro GetAnRegister_0213():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0213-Обр-Разные";
    elif( m_RunByNoQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0213-неОбр-Разные";
    end;

    return Quoted;
  end;

  macro GetAnRegister_0216():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0216-Обр-Разные";
    elif( m_RunByNoQuoted == true )
      Quoted = "Аналитический регистр № АР-07-0216-неОбр-Разные";
    end;

    return Quoted;
  end;

  macro GetAnRegisterTxt():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Реализация акций, паев и депозитарных расписок (обращающиеся на ОРЦБ)";
    elif( m_RunByNoQuoted == true )
      Quoted = "Реализация акций, паев и депозитарных расписок (не обращающиеся на ОРЦБ)";
    end;

    return Quoted;
  end;

  macro GetAnRegisterTxt_0215():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Реализация (погашение) купонных облигаций, в иностранной валюте (обращающиеся на ОРЦБ)";
    elif( m_RunByNoQuoted == true )
      Quoted = "Реализация (погашение) купонных облигаций, в иностранной валюте (не обращающиеся на ОРЦБ)";
    end;

    return Quoted;
  end;

  macro GetAnRegisterTxt_0213():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Реализация (погашение) дисконтных облигаций, в рублях (обращающиеся на ОРЦБ)";
    elif( m_RunByNoQuoted == true )
      Quoted = "Реализация (погашение) дисконтных облигаций, в рублях (не обращающиеся на ОРЦБ)";
    end;

    return Quoted;
  end;

  macro GetAnRegisterTxt_0216():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Реализация (погашение) дисконтных облигаций, в иностранной валюте (обращающиеся на ОРЦБ)";
    elif( m_RunByNoQuoted == true )
      Quoted = "Реализация (погашение) дисконтных облигаций, в иностранной валюте (не обращающиеся на ОРЦБ)";
    end;

    return Quoted;
  end;

  macro GetCodeNU():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "1-070000-ИАР-07-1/1";
    elif( m_RunByNoQuoted == true )
      Quoted = "1-070000-ИАР-07-1/11";
    end;

    return Quoted;
  end;

  macro GetCodeNU2():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "4-070000-ИАР-07-7/1";
    elif( m_RunByNoQuoted == true )
      Quoted = "4-070000-ИАР-07-7/11";
    end;

    return Quoted;
  end;

  macro GetCodeNU_N():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "1-070000-ИАР-07-1/9";
    elif( m_RunByNoQuoted == true )
      Quoted = "1-070000-ИАР-07-1/19";
    end;

    return Quoted;
  end;

  macro GetCodeNU_O():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "1-070000-ИАР-07-1/8";
    elif( m_RunByNoQuoted == true )
      Quoted = "1-070000-ИАР-07-1/18";
    end;

    return Quoted;
  end;

  macro GetCodeNU_AL():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "4-070000-ИАР-07-7/8";
    elif( m_RunByNoQuoted == true )
      Quoted = "4-070000-ИАР-07-7/18";
    end;

    return Quoted;
  end;

  macro GetCodeNU_BR():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "4-070000-ИАР-07-7/9";
    elif( m_RunByNoQuoted == true )
      Quoted = "4-070000-ИАР-07-7/19";
    end;

    return Quoted;
  end;

  macro GetCodeNU_BW():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "5-070300-ИАР-07-10/3";
    elif( m_RunByNoQuoted == true )
      Quoted = "5-070300-ИАР-07-10/6";
    end;

    return Quoted;
  end;

  macro GetCodeNU_BY():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "2-010301-ИАР-07-3/5";
    elif( m_RunByNoQuoted == true )
      Quoted = "2-010301-ИАР-07-3/8";
    end;

    return Quoted;
  end;

  macro GetCodeNU_0213N():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "5-070300-ИАР-07-10/13";
    elif( m_RunByNoQuoted == true )
      Quoted = "5-070300-ИАР-07-10/15";
    end;

    return Quoted;
  end;

  macro GetCodeNU_0213Q():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "1-070000-ИАР-07-1/7";
    elif( m_RunByNoQuoted == true )
      Quoted = "1-070000-ИАР-07-1/17";
    end;

    return Quoted;
  end;

  macro GetCodeNU_0213AJ():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "4-070000-ИАР-07-7/7";
    elif( m_RunByNoQuoted == true )
      Quoted = "4-070000-ИАР-07-7/17";
    end;

    return Quoted;
  end;

  macro GetCodeNU_0216Q():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "5-070300-ИАР-07-10/14";
    elif( m_RunByNoQuoted == true )
      Quoted = "5-070300-ИАР-07-10/16";
    end;

    return Quoted;
  end;

  macro GetCodeNU_0216U():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "1-070000-ИАР-07-1/10";
    elif( m_RunByNoQuoted == true )
      Quoted = "1-070000-ИАР-07-1/20";
    end;

    return Quoted;
  end;

  macro GetCodeNU_0216AP():string
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "4-070000-ИАР-07-7/10";
    elif( m_RunByNoQuoted == true )
      Quoted = "4-070000-ИАР-07-7/20";
    end;

    return Quoted;
  end;

  MACRO GetSubKindReg_0215():string
    var Quoted = "";

    if( m_RunByQuoted == true )
        Quoted = "АР-07-0215-Обр-Разные";
    elif( m_RunByNoQuoted == true )
        Quoted = "АР-07-0215-неОбр-Разные";
    end;

    return Quoted;
  END;

  MACRO GetSubKindReg_0213():string
    var Quoted = "";

    if( m_RunByQuoted == true )
        Quoted = "АР-07-0213-Обр-Разные";
    elif( m_RunByNoQuoted == true )
        Quoted = "АР-07-0213-неОбр-Разные";
    end;

    return Quoted;
  END;

  MACRO GetSubKindReg_0216():string
    var Quoted = "";

    if( m_RunByQuoted == true )
        Quoted = "АР-07-0216-Обр-Разные";
    elif( m_RunByNoQuoted == true )
        Quoted = "АР-07-0216-неОбр-Разные";
    end;

    return Quoted;
  END;


  MACRO PrintHeader( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
    PrintFormatString( "",
                      FldPref+"ДатаСоставления", string(Date())+" "+string(Time()),
                      FldPref+"НомерОпера",      string({oper}),
                      FldPref+"Операционист",    GetOperRecByID({oper}).Name,
                      FldPref+"H0_A:l",          this.H0_A(),
                      FldPref+"H0_B_INN",        this.H0_B_INN(),
                      FldPref+"H0_B_KPP",        this.H0_B_KPP(),
                      FldPref+"H0_3",            H03,
                      FldPref+"H0_7",            this.H0_7(),
                      FldPref+"H0_8",            this.H0_8(),
                      FldPref+"H0_9",            this.H0_9(),
                      FldPref+"H0_11",           this.H0_11(),
                      FldPref+"H0_13",           GetSubKindReg()
                    );
  END;

  MACRO PrintHeader_biq12386( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
    PrintFormatString( "",
                      FldPref+"Операционист",     Oper_rshb(),
                      FldPref+"H0_Year",          GetYear(),
                      FldPref+"H0_PeriodCode",    GetPeriodCode(),
                      FldPref+"H0_PeriodTxt",     GetPeriodTxt(),
                      FldPref+"H0_AnRegistr",     GetAnRegister(),
                      FldPref+"H0_AnRegistrTxt",  GetAnRegisterTxt(),
                      FldPref+"H0_CodeNU",        GetCodeNU(),
                      FldPref+"H0_CodeNU2",       GetCodeNU2(),
                      FldPref+"H0_13",            GetSubKindReg_biq12386()
                    );
  END;

  MACRO PrintHeader_0215( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
    PrintFormatString( "",
                      FldPref+"Операционист",     Oper_rshb(),
                      FldPref+"H0_Year",          GetYear(),
                      FldPref+"H0_PeriodCode",    GetPeriodCode(),
                      FldPref+"H0_PeriodTxt",     GetPeriodTxt(),
                      FldPref+"H0_AnRegistr",     GetAnRegister_0215(),
                      FldPref+"H0_AnRegistrTxt",  GetAnRegisterTxt_0215(),
                      FldPref+"H0_13",            GetSubKindReg_0215(),
                      FldPref+"CodeNU_N",      GetCodeNU_N(),
                      FldPref+"CodeNU_O",      GetCodeNU_O(),
                      FldPref+"CodeNU_AL",     GetCodeNU_AL(),
                      FldPref+"CodeNU_BR",     GetCodeNU_BR(),
                      FldPref+"CodeNU_BW",     GetCodeNU_BW(),
                      FldPref+"CodeNU_BY",     GetCodeNU_BY()
                    );
  END;

  MACRO PrintHeader_0213( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
    PrintFormatString( "",
                      FldPref+"Операционист",     Oper_rshb(),
                      FldPref+"H0_Year",          GetYear(),
                      FldPref+"H0_PeriodCode",    GetPeriodCode(),
                      FldPref+"H0_PeriodTxt",     GetPeriodTxt(),
                      FldPref+"H0_AnRegistr",     GetAnRegister_0213(),
                      FldPref+"H0_AnRegistrTxt",  GetAnRegisterTxt_0213(),
                      FldPref+"H0_13",            GetSubKindReg_0213(),
                      FldPref+"H0_CodeNU_N",      GetCodeNU_0213N(),
                      FldPref+"H0_CodeNU_Q",      GetCodeNU_0213Q(),
                      FldPref+"H0_CodeNU_AJ",     GetCodeNU_0213AJ()
                    );
  END;

  MACRO PrintHeader_0216( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
    PrintFormatString( "",
                      FldPref+"Операционист",     Oper_rshb(),
                      FldPref+"H0_Year",          GetYear(),
                      FldPref+"H0_PeriodCode",    GetPeriodCode(),
                      FldPref+"H0_PeriodTxt",     GetPeriodTxt(),
                      FldPref+"H0_AnRegistr",     GetAnRegister_0216(),
                      FldPref+"H0_AnRegistrTxt",  GetAnRegisterTxt_0216(),
                      FldPref+"H0_13",            GetSubKindReg_0216(),
                      FldPref+"H0_CodeNU_Q",      GetCodeNU_0216Q(),
                      FldPref+"H0_CodeNU_U",      GetCodeNU_0216U(),
                      FldPref+"H0_CodeNU_AP",     GetCodeNU_0216AP()
                    );
  END;

  MACRO PrintHeader_cons( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
    PrintFormatString( "",
                      FldPref+"ДатаСоставления", string(Date())+" "+string(Time()),
                      FldPref+"НомерОпера",      string({oper}),
                      FldPref+"Операционист",    GetOperRecByID({oper}).Name,
                      FldPref+"H0_A:l",          this.H0_A(),
                      FldPref+"H0_B_INN",        this.H0_B_INN(),
                      FldPref+"H0_B_KPP",        this.H0_B_KPP(),
                      FldPref+"H0_7",            this.H0_7(),
                      FldPref+"H0_8",            this.H0_8(),
                      FldPref+"H0_9",            this.H0_9(),
                      FldPref+"H0_11",           this.H0_11()
                    );
  END;

  macro SetCopyAutoSumRange(r)
    m_CopyAutoSumRange = r;
  end;

  PRIVATE MACRO GetFormulaSummREG_rshb()
    var i = 0, StrSumm = "", BeginRow, CellAddr;
    
    while( i < m_NumCellAutoSumm.Size )

        CellAddr = m_ReportTable.AddressDiapazon.GetCell( 0, NC( m_NumCellAutoSumm[i] ) );

        if( m_ReportTable.AddressDiapazon.GetNumbRow() > 0 )
          StrSumm = m_ReportTable.GetFormulaSummREG( CellAddr, null, m_ReportTable.bRowTable, m_ReportTable.bRowTable+m_ReportTable.AddressDiapazon.GetNumbRow()-1 );
        else
          StrSumm = "";
        end;

        if( m_FormulaSumm[i] == null ) /*для первой вкладки*/
          m_FormulaSumm[i] = "";
        elif( substr(StrSumm, 1,1) == "=" )
          StrSet( StrSumm, 1, "+" );
        end;
        m_FormulaSumm[i] = m_FormulaSumm[i] + StrSumm;
        i = i + 1;
    end;
  END;


  macro PrintLineAutoSumma_rshb()
    var Address;
    var i = 0, OldSheet;
  
    if((m_CopyAutoSumRange == null) or (m_CopyAutoSumRange == ""))
      return;
    end;

    if( not m_UseTemplate )
      return;
    end;

    if( m_ItogLineName != NULL ) // в первой строке таблицы
      OldSheet = m_ObjTemplateXLS.SheetName();
      m_ObjTemplateXLS.SheetChange( m_FirstSheetName );
    end;

    while( i < m_NumCellAutoSumm.Size )
      Address = CAddressDiapazon(m_CopyAutoSumRange).GetCell(0, NC( m_NumCellAutoSumm[i] ) );
      m_ObjTemplateXLS.SetValue_NameCell( Address, m_FormulaSumm[i] );
      i = i + 1;
    end;

    if( m_ItogLineName != NULL ) // в первой строке таблицы
      m_ObjTemplateXLS.SheetChange( OldSheet );
    end;

  end;

  macro PrintLineAutoSumma()
    if((m_CopyAutoSumRange == null) or (m_CopyAutoSumRange == ""))
        PrintLineAutoSumma();
    else
        PrintLineAutoSumma_rshb();
    end;
  end;

  MACRO PrSvp():DOUBLE // Цена реализации - в валюте
     var PrSvp = this.PrSvp();
     return PrSvp;
  END;

  MACRO DifS():money
     var RetVal:money = $0.0;

     if ( (m_RS.TechDealSale != 0) OR (this.IsDUDealS() == 1) ) // техническая
          RetVal = $0.0;
     elif( m_RS.IsPriceDifNoteS )/*если заполнено примечание*/
        if( this.QS() != 0 )
           RetVal = SQL_ConvTypeSum(m_RS.PriceDifNoteS) / this.QS() * this.Qnty();
        end;
     else
        if( (StrUpr(MrktS()) == "НЕКОНТРОЛИРУЕМАЯ СДЕЛКА") or (MinMrkt() == 0) or (StrUpr(MrktS()) == "ФАКТ")
           or (StrUpr(MrktS()) == "БИРЖЕВАЯ СДЕЛКА"))
           RetVal = $0.0;
        else
          var V19 = 0;
          var SumSrub:money = $0.0;
          var SumMrkt:money = $0.0;

          GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
          if (m_ReportKind == REALIZREG_0213)
            SumSrub = round(this.SumSvp(),2);
          elif ((V19 == 1) and (m_ReportKind == REALIZREG_0215))
            SumSrub = (SumSvp() + NkdSvp()) * CrSD() - NkdSrub;
          else 
            SumSrub = SumSvp() * CrSD();
          end;

           if( m_ReportKind == REALIZREG_0211 )

              if( CrSZ() != 0 )
                 SumMrkt = MinMrkt() * this.Cr_Val_MrkSZ() / CrSZ() * this.Qnty();
              end;

              if( (SumMrkt - SumSvp()) > 0 )
                 RetVal = (SumMrkt - SumSvp()) * this.CrSD();
              else
                 RetVal = $0.0;
              end;

           elif( m_ReportKind == REALIZREG_0212 )

              SumMrkt = MinMrkt() * this.NomS() / 100 * this.Qnty();

              if( (SumMrkt - SumSrub) > 0 )
                RetVal = SumMrkt - SumSrub;
              else
                RetVal = $0.0;
              end;

           elif( m_ReportKind == REALIZREG_0215 )

              if(this.VPrS() == NATCUR)
                SumMrkt = MinMrkt() * this.NomS() / 100 * this.Qnty() * this.CrDZS();
                if( (SumMrkt - SumSrub) > 0 )
                  RetVal = SumMrkt - SumSrub;
                else
                  RetVal = $0.0;
                end;
              else
                SumMrkt = MinMrkt() * this.NomS() / 100 * this.Qnty();
                if (V19 == 0)
                  if( (SumMrkt - this.SumSvp()) > 0 )
                    RetVal = (SumMrkt - this.SumSvp())*this.CrSD();
                  else
                    RetVal = $0.0;
                  end;
                elif ((V19 == 1) and (this.CrSpezS() != 0.0))
                  if (SumMrkt * CrDZS() - SumSrub > 0)
                    RetVal = max(SumMrkt * this.CrDDS() - SumSrub, 0);
                  else
                    RetVal = 0;
                  end;
                elif ((V19 == 1) and (this.CrSpezS() == 0.0))
                  if( (SumMrkt - this.SumSvp()) > 0 )
                    RetVal = (SumMrkt - this.SumSvp())*this.CrDDS();
                  else
                    RetVal = $0.0;
                  end;
                end;
              end;
           elif( m_ReportKind == REALIZREG_0213 )

              SumMrkt = MinMrkt() * this.Nom() / 100 * this.Qnty();
              if ((SumMrkt - SumSrub) > 0)
                RetVal = SumMrkt - SumSrub;
              else
                RetVal = $0.0;
              end;

           elif( m_ReportKind == REALIZREG_0216 )

              if(this.VPrS() == NATCUR)
                 SumMrkt = MinMrkt() * this.Nom() / 100 * this.Qnty() * this.CrDZS();
                 if( (SumMrkt - SumSvp()) > 0 )
                    RetVal = SumMrkt - SumSvp();
                 else
                    RetVal = $0.0;
                 end;
              else
                 SumMrkt = MinMrkt() * this.NomS() / 100 * this.Qnty();
                 if( (SumMrkt - SumSvp()) > 0 )
                    RetVal = (SumMrkt - this.SumSvp())*this.CrSD();
                 else
                    RetVal = $0.0;
                 end;
              end;
           end;
        end;
     end;

     return RetVal;
  END;

  MACRO DifB():money
     var RetVal:money = $0.0;

     if ( (m_RS.TechDealBuy != 0) OR (this.IsDUDealS() == 1)) // техническая
        RetVal = $0.0;
     elif( m_RS.IsPriceDifNoteB )/*если заполнено примечание*/
        if( this.QB() != 0 )
           RetVal = SQL_ConvTypeSum(m_RS.PriceDifNoteB) / this.QB() * this.Qnty();
        end;
     else
        if( (StrUpr(MrktB()) == "НЕКОНТРОЛИРУЕМАЯ СДЕЛКА") or (MaxMrkt() == 0) or (StrUpr(MrktB()) == "ФАКТ")
           or (StrUpr(MrktB()) == "БИРЖЕВАЯ СДЕЛКА"))
           RetVal = $0.0;
        else
          var V19 = 0;
          var SumBrub:money = $0.0;
          var SumMrkt:money = $0.0;
          
          GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
          if (m_ReportKind == REALIZREG_0213)
            SumBrub = round(this.SumBvp(),2);
          elif ((V19 == 1) and (m_ReportKind == REALIZREG_0215))
            SumBrub = (SumBvp() + this.NkdBvp()) * CrBD() - NkdBrub;
          else 
            SumBrub = SumBvp() * CrBD();
          end;

           if( m_ReportKind == REALIZREG_0211 )
              if( CrBZ() != 0 )
                SumMrkt = MaxMrkt() * this.Cr_Val_MrkBZ() / CrBZ() * this.Qnty();
              end;

              if( (SumBvp() - SumMrkt) > 0 )
                RetVal = (SumBvp() - SumMrkt) * this.CrBD();
              else
                RetVal = $0.0;
              end;
           elif( m_ReportKind == REALIZREG_0212 )

              SumMrkt = MaxMrkt() * this.NomB() / 100 * this.Qnty();

              if ((SumBrub - SumMrkt) > 0)
                RetVal = SumBrub - SumMrkt;
              else
                RetVal = $0.0;
              end;

           elif( m_ReportKind == REALIZREG_0215 )

              if(this.VPrB() == NATCUR)
                SumMrkt = MaxMrkt() * this.NomB() / 100 * this.Qnty() * this.CrDZB();
                if ((SumBrub - SumMrkt) > 0)
                  RetVal = SumBrub - SumMrkt;
                else
                  RetVal = $0.0;
                end;
              else
                SumMrkt = MaxMrkt() * this.NomB() / 100 * this.Qnty();
                if (V19 == 0)
                  if ((this.SumBvp() - SumMrkt) > 0)
                    RetVal = (this.SumBvp() - SumMrkt)*this.CrBD();
                  else
                    RetVal = $0.0;
                  end;
                elif ((V19 == 1) and (this.CrSpezB() != 0.0))
                  if (SumBrub - SumMrkt * this.CrDZB() > 0)
                    RetVal = max(SumBrub - SumMrkt * this.CrDDB(), 0);
                  else
                    RetVal = $0.0;
                  end;
                elif ((V19 == 1) and (this.CrSpezB() == 0.0))
                  if ((this.SumBvp() - SumMrkt) > 0)
                    RetVal = (this.SumBvp() - SumMrkt)*this.CrDDB();
                  else
                    RetVal = $0.0;
                  end;
                end;
              end;

           elif( m_ReportKind == REALIZREG_0213 )

              SumMrkt = MaxMrkt() * this.Nom() / 100 * this.Qnty();

              if( (SumBrub - SumMrkt) > 0 )
                 RetVal = SumBrub - SumMrkt;
              else
                 RetVal = $0.0;
              end;

           elif( m_ReportKind == REALIZREG_0216 )

              if(this.VPrB() == NATCUR)
                 SumMrkt = MaxMrkt() * this.Nom() / 100 * this.Qnty() * this.CrDZB();
                 if( (this.SumBvp() - SumMrkt) > 0 )
                    RetVal = this.SumBvp() - SumMrkt;
                 else
                    RetVal = $0.0;
                 end;
              else
                 SumMrkt = MaxMrkt() * this.NomB() / 100 * this.Qnty();
                 if( (this.SumBvp() - SumMrkt) > 0 )
                    RetVal = (this.SumBvp() - SumMrkt)*this.CrBD();
                 else
                    RetVal = $0.0;
                 end;
              end;

           end;

        end;
     end;

     return RetVal;
  END;

  MACRO ComS():MONEY //  Комиссия, уплаченная при реализации
    if( m_ComS == NULL )
      if(this.IsDUDealS() == 1)
        m_ComS = $0.0;
      else
        m_ComS = (m_RS.CommSale * (this.Qnty()/this.QS())) + this.ComS_Another();
      end;
    end;
    return m_ComS;
  END;

  MACRO ComB():MONEY //Комиссия, уплаченная при приобретении
    if( m_ComB == NULL )
       if(this.IsDUDealS() == 1)
          m_ComB = $0.0;
       elif(this.IsDUDealB() == 1)
          m_ComB = SQL_ConvTypeSum(m_RS.SpendDU) * this.Qnty()/this.QB();
       elif( ((m_ReportKind == REALIZREG_0212) or (m_ReportKind == REALIZREG_0215)) and (m_SCTXUseCommAsOutlay) )
          var vKSumBvn = 0.0;
          if( (this.AmortVN_after() != $0) and (this.AmortVN_before() == $0) )
             vKSumBvn = (this.AmortVN_after()-this.AmortVNPer())/this.NomB()/this.Qnty();
          end;
          m_ComB = (m_RS.CommBuy * Qnty()/this.QB()) * (1 - vKSumBvn) + this.ComB_Another();
       else
          m_ComB = (m_RS.CommBuy * Qnty()/this.QB()) + this.ComB_Another();
       end;
    end;
    return m_ComB;
  END;

  MACRO NDSComS():MONEY //  Комиссия, уплаченная при реализации
    if( m_NDSComS == NULL )
      m_NDSComS = (m_RS.NDSCommSale * (this.Qnty()/this.QS()));
    end;
    return m_NDSComS;
  END;

  MACRO ISIN()
     var exec, DataSet;
     exec = RSDCommand(" select av.t_ISIN, av.t_LSIN "+
                       " FROM  DAVOIRISS_DBT av "+
                       " where "+ m_RS.t_FIID + " = av.t_FIID ");
     exec.execute();
     DataSet = TRsbDataSet(exec);

     if(DataSet.MoveNext())
       if (DataSet.ISIN != "")
          return "" + DataSet.ISIN;
       else 
          return "" + DataSet.LSIN;
       end;
     else
        return "";
     end;
  END;

  MACRO NDSComB():MONEY //Комиссия, уплаченная при приобретении
    if( m_NDSComB == NULL )
      m_NDSComB = (m_RS.NDSCommBuy * Qnty()/this.QB());
    end;
    return m_NDSComB;
  END;

  MACRO DPS():DATE
     if( m_DPS == null )
        m_DPS = SQL_ConvTypeSum(m_RS.DPS);
     end;
     return m_DPS;
  END;

  MACRO DPB():DATE
     if( m_DPB == null )
        m_DPB = SQL_ConvTypeSum(m_RS.DPB);
     end;
     return m_DPB;
  END;

  /*Если фактическое ТО по оплате в сделке <CodeS> отсутствует, то <DPS-DDS> = 0, иначе <DPS-DDS> = <DPS> - <DDS>.
    <DPS> =  Дата фактического ТО по оплате в сделке <CodeS> (если ТО несколько, то самая ранняя).*/
  MACRO DPS_DDS()
     var  v_DPS_DDS = this.DPS();
     if( v_DPS_DDS==ZeroDate )
        return 0;
     end;

     return (v_DPS_DDS - this.DDS());
  END;

  /*Если фактическое ТО по оплате в сделке <CodeS> отсутствует, то <DPS-DDS> = 0, иначе <DPS-DDS> = <DPS> - <DDS>.
    <DPS> =  Дата фактического ТО по оплате в сделке <CodeS> (если ТО несколько, то самая ранняя).*/
  MACRO DPB_DDB()
     var  v_DPB_DDB = this.DPB();
     if( v_DPB_DDB==ZeroDate )
        return 0;
     end;

     return (v_DPB_DDB - this.DDB());
  END;

  /*Параметр Val_Market_New для сделок <CodeS>*/
  MACRO Val_MarketS()
    if(this.IsDUDealS() == 1) return "";
    end;
    return SQL_ConvTypeStr(m_RS.SaleVal_Market);
  END;

  /*Параметр Val_Market_New для сделок <CodeS>*/
  MACRO Val_MarketB()
    if(IsDUDealS() == 1) return "";
    end;
    return SQL_ConvTypeStr(m_RS.BuyVal_Market);
  END;

  /*Ед. изм.*/
  MACRO Cr_Val_MrkSZ()

     if( m_Cr_Val_MrkSZ == null )
        m_Cr_Val_MrkSZ = 0.0;
        var ISO = IIF(StrIsNumber(Val_MarketS()), int(Val_MarketS()), Val_MarketS());
        if( ISO != "" )
        if( ISO == 810 ) ISO = 643; end;
           if( ISO == "%" )
              m_Cr_Val_MrkSZ = this.CrDZS();
           else
              m_Cr_Val_MrkSZ = GetRateOnDateCrossDbl(this.DZS(), m_CacheISO.GetFIID( ISO ).m_FIID, NATCUR, true);
           end;
        end;
     end;

     return m_Cr_Val_MrkSZ;
  END;

  MACRO printCr_Val_MrkSZ()
     return ВыводЧерезФормулу(this.Cr_Val_MrkSZ());
  END;

  MACRO Cr_Val_MrkBZ()

     if( m_Cr_Val_MrkBZ == null )
        m_Cr_Val_MrkBZ = 0.0;
        var ISO = IIF(StrIsNumber(Val_MarketB()), int(Val_MarketB()), Val_MarketB());
         if( ISO != "" )
         if( ISO == 810 ) ISO = 643; end;
           if( ISO == "%" )
              m_Cr_Val_MrkBZ = this.CrDZB();
              else
              m_Cr_Val_MrkBZ = GetRateOnDateCrossDbl(this.DZB(), m_CacheISO.GetFIID( ISO ).m_FIID, NATCUR, true);
           end;
        end;
     end;

     return m_Cr_Val_MrkBZ;
  END;

  MACRO printCr_Val_MrkBZ()
     return ВыводЧерезФормулу(this.Cr_Val_MrkBZ());
  END;

  MACRO QuoteValueS()
    if(IsDUDealS() == 1) return 0; 
    end;
    return m_RS.SaleMarketQuoteValue;
  END;

  MACRO QuoteValueB()
    if(IsDUDealS() == 1) return 0;
    end;
    return m_RS.BuyMarketQuoteValue;
  END;

  /*Курс постановки на баланс (спец. Курс)*/
  MACRO CrSpezB():double
     if( m_CrSpezB == NULL )
        m_CrSpezB = ПолучитьКурсПостановкиНаБаланс(DealBuy(), SQL_ConvTypeInteger(m_RS.BuyLot_RQID));
     end;
     return m_CrSpezB;
  END;

  /* Курс пересчета ст-ти приобретения в рублевый эквивалент */
  MACRO CrBD():DOUBLE
    if (m_CrBD == NULL)
      m_CrBD = CrSpezB();
      if (m_CrBD != $0.0)
        return m_CrBD;
      else
        if (this.VprB() == NATCUR)
          m_CrBD = 1.0;
        else
          m_CrBD = GetRateOnDateCrossDbl(IIF(this.DPB() != ZeroDate,
                                             min(this.DPB(), this.DDB()),
                                         this.DDB()),
                                         this.VprB(),
                                         NATCUR,
                                         true);
        end;
      end;
    end;

    if (m_CrBD == NULL)
      m_CrBD = 0.0;
    end;

    return m_CrBD;
  END;
  
  /*Курс постановки на баланс (спец. Курс)*/
  MACRO CrSpezS():double
     if( m_CrSpezS == NULL )
        m_CrSpezS = ПолучитьКурсПостановкиНаБаланс(DealSale(), SQL_ConvTypeInteger(m_RS.SaleLot_RQID));
     end;
     return m_CrSpezS;
  END;

  /* Курс пересчета ст-ти реализации в рублевый эквивалент */
  MACRO CrSD():DOUBLE
    if (m_CrSD == NULL)
      m_CrSD = CrSpezS();
      if (m_CrSD != $0.0)
        return m_CrSD;
      else
        if (VprS() == NATCUR)
          m_CrSD = 1.0;
        else
          m_CrSD = GetRateOnDateCrossDbl(IIF(DPS() != ZeroDate, 
                                             min(DPS(), DDS()),
                                         DDS()),
                                         VprS(),
                                         NATCUR,
                                         true);
        end;
      end;
    end;

    if (m_CrSD == NULL)
      m_CrSD = 0.0;
    end;

    return m_CrSD;
  END;

  /*Для 211,212,215 ! Формула - <SumSrub> = < SumSvp >*<СrSD>) ( гр.11= гр.10*гр.S2)*/
  MACRO SumSrub() // Стоимость реализации - в рублях
     if( m_ReportKind == REALIZREG_0213 )
        return round(this.SumSvp(),2);
     end;
     if (m_ReportKind == REALIZREG_0215)
      var V19 = 0;
      GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
      if ((V19 == 1) and (this.CrSpezS() != 0.0))
        return F("(" + GetSumSvp() + "+" + NkdSvp() + ") *" + this.GetCrSD()
                 + "-" + this.NkdSrub());
      end;
    end;
     return F(GetSumSvp()+"*"+GetCrSD());
  END;

  /*НКД полученный при реализации (погашении) - сумма, руб.*/
  MACRO NkdSrub():MONEY // НКД полученный при реализации (погашении) - Сумма, руб.
     var RegVal = 0;
     var CourseDate;

     GetRegistryvalue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V22", V_INTEGER, RegVal, NULL);
     if((RegVal == 0) OR (this.IsDUDealS() == 1))
        CourseDate = DDS();
     elif(RegVal == 1)
        CourseDate = IIF(DDS() < DPS(), DDS(), DPS());
     elif(RegVal == 2)
        CourseDate = IIF(DDS() > DPS(), DDS(), DPS());
     end;
  
     if(this.VPrS() == NATCUR)
        return this.NkdSvp();
     else
        return round(this.NkdSvp() * GetRateOnDateCrossDbl(CourseDate, this.VPrS(), NATCUR, true),2);
     end;
  END;

  /*НКД уплаченный при приобретении - Сумма, руб.*/
  MACRO NkdBrub():MONEY // НКД полученный при реализации (погашении) - Сумма, руб.
     var RegVal = 0;
     var CourseDate;

     GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V21", V_INTEGER, RegVal, NULL);
     if(RegVal == 0)
        CourseDate = DDB();
     elif(RegVal == 1)
        CourseDate = IIF(DDB() < DPB(), DDB(), DPB());
     elif(RegVal == 2)
        CourseDate = IIF(DDB() > DPB(), DDB(), DPB());
     end;
     if(this.VPrB() == NATCUR)
        return this.NkdBvp();
     else
       if(this.IsDUDealB() == 1)
         return round(this.NkdBvp() * GetRateOnDateCrossDbl(this.ImportDUDate(), this.VPrB(), NATCUR, true),2);
       end;
       return round(this.NkdBvp() * GetRateOnDateCrossDbl(CourseDate, this.VPrB(), NATCUR, true),2);
     end;
  END;

  /*Для 211,212,215 !Формула     <SumBrub> = <SumBvp>* <CrBD>*/
  MACRO SumBrub() // Стоимость приобретения - Сумма, руб
    if (m_ReportKind == REALIZREG_0213)
      return round(this.SumBvp(),2);
    end;
    if (m_ReportKind == REALIZREG_0215)
      var V19 = 0;
      if(this.IsDUDealS() == 1)
        return F(0);
      end;
      GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
      if ((V19 == 1) and (this.CrSpezB() != 0.0))
        return F("(" + GetSumBvp() + "+" + this.NkdBvp() + ") *" + GetCrBD()
                 + "-" + NkdBrub());
      end;
    end;
    return F(GetSumBvp()+"*"+GetCrBD());
  END;

  /*Для 211 "Формула! <SumBtax>=<SumBrub>-<DifB> */
  MACRO SumBtax() // Стоимость приобретенных ценных бумаг, принимаемая для целей налогообложения
     if(this.IsDUDealS() == 1)
       return 0;
     end;
     return F(GetSumBrub()+"-"+GetDifB());
  END;

  /*!Формула  */
  MACRO RashAll():string
     if(this.IsDUDealS() == 1)
       return 0;
     end;
     // Расходы, принимаемые для целей налогообложения в отчетном налоговом периоде, руб.
     if( (m_ReportKind == REALIZREG_0211) or (m_ReportKind == REALIZREG_0213) or (m_ReportKind == REALIZREG_0216) )
        return F(GetComS()+"+"+GetSumBtax()+"+"+GetComB());
     end;

     /*212,215*/
     return F(GetSumBNRub()+"+"+GetComS()+"+"+GetComB()+"+"+GetNkdBSellRub());
  END;

  /*Формула!*/
  MACRO Taxe_All() // Прибыль (+)/ убыток (-) для целей налогообложения, руб.

     if( m_ReportKind == REALIZREG_0211 )
        return F(GetSumSrub()+"+"+GetDifS()+"-"+GetRashAll());
     end;

     /*212,215*/
     return F(GetTaxe_Amort()+"+"+GetTaxe_NKD());
  END;

  /*Формула! <Fin_Res>= <SumSrub> - <SumBrub> */
  MACRO Fin_Res() // Фин. рез для выверки, руб

     if( m_ReportKind == REALIZREG_0211 )
        return F(GetSumSrub()+"-"+GetSumBrub());
     end;

     /*212,215*/
     return F(GetSumAllrub()+"-"+GetNKDminusRub()+"+"+GetNkdRepRub()+"-"+GetRashAll()+"+"+GetDifSumBRub()+"+"+GetComS()+"+"+GetComB());
  END;

  MACRO SecLax():string // Признак льготного налогообложения
     var RetVal:string = "";

     if( m_RS.IsFavourIncome == 1 )
        RetVal = "284.2.2.1";
     elif( m_RS.IsFavourIncome == 2 )
        RetVal = "284.2.2.4";
     elif( m_RS.IsFavourIncome == 3 )
        RetVal = "284.2.1.1.1";
     elif( m_RS.IsFavourIncome == 4 )
        RetVal = "284.2.1.1.2";
     end;

     return RetVal;
  END;

  MACRO Nom_H01()
    return GetFaceValue( m_RS.t_FIID, MAX(this.H0_7(),this.DDB()), true, false );
  END;
      
  MACRO Nom_H02()
    return GetFaceValue( m_RS.t_FIID, this.DDS(), true, false );
  END;
      
  MACRO PlusNom_IN()
    return F(FormulaIF()+"("+GetNomH02()+">"+GetNomH01()+";("+GetNomH02()+"-"+GetNomH01()+")*"+GetQnty()+";"+"0)");
  END;
    
  MACRO MinusNom_IN() 
    return F(FormulaIF()+"("+GetNomH02()+"<"+GetNomH01()+";-("+GetNomH02()+"-"+GetNomH01()+")*"+GetQnty()+";"+"0)");
  END;

  MACRO Nom_IN_Before()
    if(this.DDB() < this.H0_7())
      return (GetFaceValue( m_RS.t_FIID, this.H0_7()-1, true, false ) - GetFaceValue( m_RS.t_FIID, this.DDB(), true, false )) * this.Qnty();
    end;

    return 0; 
  END;

  MACRO ДДУн():DATE 
     return iif(this.IsDUDealB() == 1, MAX(MAX( this.H0_7(), this.DDB()+1 ), this.ImportDUDate()), MAX( this.H0_7(), this.DDB()+1 ));
  END;

  // Дата перехода права собств-ти при приобретении ц/б
  MACRO DDB():DATE
     if(m_DDB == NULL)
      m_DDB = SQL_ConvTypeDate(m_RS.BuyDate);

      if(this.DGO() != ZeroDate)
        var sql = "SELECT (CASE " +
                             " WHEN rq.T_FACTDATE = TO_DATE('01.01.0001','DD.MM.YYYY') THEN rq.T_PLANDATE " +
                              "            ELSE  rq.T_FACTDATE " +
                              "        END)    AS t_DeliveryDate " +
                              "  FROM ddlrq_dbt rq " +
                  " WHERE rq.T_DOCKIND = " + DealBuy().rec.BofficeKind +
                    " AND rq.T_DOCID = " + m_RS.DealBuyID +
                    " AND rq.T_TYPE = " + DLRQ_TYPE_DELIVERY +
                    " AND rq.T_DEALPART = 1 ";

        var commCmd = DL_RSDCommand(sql);
        var commDS = commCmd.Execute();

        if(commDS.MoveNext())
          m_DDB = SQL_ConvTypeDate(commDS.DeliveryDate);
        end;
        end;
     end;

     return m_DDB;
  END;

  MACRO PrSNom():DOUBLE //  Цена реализации, % от номинала
     if( m_PrSNom == NULL )
       if( IsRET_ISSUE(int(m_RS.DealSaleGroup)) )
          m_PrSNom = 100;
       else
          if(m_RS.SaleRelativePrice == UNSET_CHAR)
            if (this.NomS() != 0.0)
               if( (m_ReportKind == REALIZREG_0212) or (m_ReportKind == REALIZREG_0213) )
                   m_PrSNom = this.DealSalePrice() * 100.0 / this.NomS();
               elif( (m_ReportKind == REALIZREG_0215) or (m_ReportKind == REALIZREG_0216) )
                  if(this.VPrS() == NATCUR)
                     m_PrSNom = this.DealSalePrice() * 100.0 / this.NomS() / CrDDS();
                  else
                     m_PrSNom = this.DealSalePrice() * 100.0 / this.NomS();
                  end;
               end;
            else
               m_PrSNom = 0.0;
            end;
          else
            m_PrSNom = this.DealSalePrice();
          end;
       end;
     end;

     return m_PrSNom;
  END;

  /*используется как лог выражение в формуле*/
  MACRO ЛогВыражениеДляЛьготных()
     return FormulaOR()+"("+GetSecType()+"=1;"+GetSecType()+"=2;"+GetSecType()+"=3;"+GetSecType()+"=4;"+GetSecType()+"=5;"+GetSecType()+"=6;"+GetSecType()+"=7;"+GetSecType()+"=8;"+GetSecType()+"=11;"+
                            GetSecType()+"=21;"+GetSecType()+"=31)";
  END;

  /*используется как лог выражение в формуле*/
  MACRO ЛогВыражениеДляОбычных()
     return FormulaOR()+"("+GetSecType()+"=9;"+GetSecType()+"=10;"+GetSecType()+"=19;"+GetSecType()+"=32;"+GetSecType()+"=33;"+GetSecType()+"=34;"+GetSecType()+"=43;"+GetSecType()+"=919;"+GetSecType()+"=943)";
  END;

  MACRO SecTypeCond_212_1()
     return FormulaOR()+"("+GetSecType()+"=9;"+GetSecType()+"=19)";
  END;

  MACRO SecTypeCond_212_2()
     return FormulaOR()+"("+GetSecType()+"=1;"+GetSecType()+"=3;"+GetSecType()+"=5;"+GetSecType()+"=7;"+GetSecType()+"=11;"+GetSecType()+"=15;"+GetSecType()+"=21)";
  END;

  MACRO SecTypeCond_215_1()
     return FormulaOR()+"("+GetSecType()+"=32;"+GetSecType()+"=33;"+GetSecType()+"=43)";
  END;

  MACRO SecTypeCond_215_2()
     return FormulaOR()+"("+GetSecType()+"=31)";
  END;

  /*212,215
   ! Формула
  */
  MACRO SumAllrub()
     if (this.IsDUDealS() == 1)
       return 0;
     end;
     if( m_ReportKind == REALIZREG_0212 )
        return F(GetSumSrub() + "+" + GetAmortVNrep());
     elif( m_ReportKind == REALIZREG_0215 )
        return F(GetSumSrub() + "+" + GetAmortRubrep());
     elif( m_ReportKind == REALIZREG_0213 )
        return F(GetSumSrub() + "-" + GetNkdOwnVN());
     elif( m_ReportKind == REALIZREG_0216 )
        return F(GetSumSrub() + "-" + GetNKDownRub());
     end;
  END;

  /*Выручка от реализации (погашения) для целей налогообложения - в том числе: суммы % дохода, учтенные при налогообложении до начала текущего отчетного (налогового) периода*/
  MACRO NKDminusRub():MONEY
     return 0;
  END;

  /*Для 212:
   ! Формула
  */
  MACRO NkdRepRub()
     if( m_ReportKind == REALIZREG_0212 )
        return F(GetNkdSvp() + "+" + GetCoupVN() + "-" + GetNkdPrevVN() + "-" + GetNkdBrepRub());
     elif( m_ReportKind == REALIZREG_0215 )
        return F(GetNkdSrub() + "+" + GetCoupRub() + "-" + GetNkdPrevRub() + "-" + GetNkdBrepRub());
     elif( m_ReportKind == REALIZREG_0213 )
        return F(GetNKDownVN() + "-" + GetNkdBefVN());
     elif( m_ReportKind == REALIZREG_0216 )
        return F(GetNKDownRub() + "-" + GetNkdBefRub());
     end;
  END;

  MACRO NkdRepRub_17( Preferential:bool ):money
     var RetVal = $0.0, RetVal_VP = $0.0;
     var i = 0;

     while( i < m_TaxPeriods.m_Periods.Size )
        if( m_TaxPeriods.m_Periods[i].Preferential == Preferential )

           // + (если D2 = <DDS>, то <NkdSvp>
           if( m_TaxPeriods.m_Periods[i].EndDate == this.DDS() )
              RetVal_VP = RetVal_VP + this.NkdSvp();
           else
              RetVal = RetVal + НКД(m_RS.t_FIID, 1, m_TaxPeriods.m_Periods[i].EndDate);
           end;

           // - (если D1 = <DDB>, то <NkdBvp>)
           if( m_TaxPeriods.m_Periods[i].BegDate == this.DDB() )
              RetVal_VP = RetVal_VP - this.NkdBvp();
           else
              RetVal = RetVal - НКД(m_RS.t_FIID, 1, m_TaxPeriods.m_Periods[i].BegDate);
           end;

           RetVal = RetVal + GetCouponSumByPeriod(m_RS.FIID, 1, m_TaxPeriods.m_Periods[i].BegDate+1, m_TaxPeriods.m_Periods[i].EndDate, null, this.ExcludeDateCouponPeriod());

        end;
        i = i + 1;
     end;

     RetVal = RetVal * this.Qnty() + RetVal_VP;

     return RetVal;
  END;

  MACRO NkdRepRub1()
    var RetVal;

    if( (this.SecType() == 1) or (this.SecType() == 3) or (this.SecType() == 5) or (this.SecType() == 7) or
        (this.SecType() == 11) or (this.SecType() == 15) or (this.SecType() == 21) or (this.SecType() == 31) )
       RetVal = F(GetNkdRepRub());
    elif( (this.SecType() == 9) or (this.SecType() == 18) or (this.SecType() == 19) or (this.SecType() == 29) or
          (this.SecType() == 32) or (this.SecType() == 33) or (this.SecType() == 43) )
       RetVal = $0.0;
    elif( this.SecType() == 17 )
       RetVal = NkdRepRub_17(true);
    else
       RetVal = $0.0;
    end;

    return RetVal;
  END;

  MACRO NkdRepRub2()
    var RetVal;

    if( (this.SecType() == 1) or (this.SecType() == 3) or (this.SecType() == 5) or (this.SecType() == 7) or
        (this.SecType() == 11) or (this.SecType() == 15) or (this.SecType() == 21) or (this.SecType() == 31) )
       RetVal = $0.0;
    elif( (this.SecType() == 9) or (this.SecType() == 18) or (this.SecType() == 19) or (this.SecType() == 29) or
          (this.SecType() == 32) or (this.SecType() == 33) or (this.SecType() == 43) )
       RetVal = F(GetNkdRepRub());
    elif( this.SecType() == 17 )
       RetVal = NkdRepRub_17(false);
    else
       RetVal = $0.0;
    end;

    return RetVal;
  END;

  MACRO ControlNKD()
     if( this.SecType() == 17 )
        return F(GetNkdRepRub() + "-(" + GetNkdRepRub1() + "+" + GetNkdRepRub2() + ")");
     else
        return 0;
     end;
  END;

  /*212,215
   ! Формула Если <AmortVN_before> > 0, то <AmortVNrep> = <AmortVN>, иначе <AmortVNrep> = <AmortVNPer> */
  MACRO AmortVNrep()
    return F(FormulaIF()+"("+GetAmortVN_before()+">0;"+GetAmortVN()+";"+GetAmortVNPer()+")");
  END;

  /*Доходы, выплаченные эми-тентом при частичном пога-шении номинала, учитывае-мые в отчетном (налоговом) периоде - сумма, руб.*/
  MACRO AmortRubrep():MONEY
     if( m_AmortRubrep == null )
        m_AmortRubrep = 0;
        if(this.IsDUDealS() == 1)
           m_AmortRubrep = $0.0;
        elif (this.AmortVN_before() > 0)
           if(this.DDB() < Date(1,1,2015) )
              m_AmortRubrep = GetPartialSumByPeriod_Rub( m_RS.FIID, this.Qnty(), this.DDB()+1, min(this.DDS(),DATE(31,12,2014)), null, this.GetDrawingDate() );
           end;
           m_AmortRubrep = m_AmortRubrep + GetPartialSumByPeriod_Rub( m_RS.FIID, this.Qnty(), max(this.DDB()+1,DATE(1,1,2015)), this.DDS(), null, this.GetDrawingDate() );
        else
           m_AmortRubrep = GetPartialSumByPeriod_Rub( m_RS.FIID, this.Qnty(), max(this.DDB()+1,this.H0_7()), this.DDS(), null, this.GetDrawingDate() );
        end;
     end;
     return m_AmortRubrep;
  END;

  /*Цена приобретения, в % от номинала*/
  MACRO PrBnom ():double
     if( m_PrBNom == NULL )
        m_PrBNom = this.DealBuyPrice();
        if( m_RS.BuyRelativePrice != SET_CHAR)
           if( (m_ReportKind == REALIZREG_0212) or (m_ReportKind == REALIZREG_0213) )
              m_PrBNom = m_PrBNom *100 / this.NomB();

           elif( (m_ReportKind == REALIZREG_0215) or (m_ReportKind == REALIZREG_0216) )
              if(this.VPrB() == NATCUR)
                 m_PrBNom = m_PrBNom *100 / this.NomB() / this.CrDDB();
              else
                 m_PrBNom = m_PrBNom *100 / this.NomB();
              end;
           end;
        end;
     end;

     return m_PrBNom;
  END;

  /*НКД уплаченный при приобретении, руб*/
  MACRO NkdBvp():MONEY
     if(m_NkdBvp == null)
       if(this.IsDUDealB() == 1)
         this.NKDBuy();
       end;
       /*если не включен режим хранилища данных для налогового учета и 215 регистр*/
       if( ( CheckTaxDepositoryMode() == false ) and ( m_ReportKind == REALIZREG_0215 ) and (this.VPrB() == NATCUR))
         m_NkdBvp = money(this.NKDBuy()*this.Qnty()/this.QB()) * this.CrDDB();
       else
        m_NkdBvp = money(this.NKDBuy()*this.Qnty()/this.QB());
       end;
     end;
     return m_NkdBvp;
  END;

  /*212,215
   ! Формула ! <DifSumBRub> = <DifB>*(1 - <KSumBvn>) */
  MACRO DifSumBRub()
    if(this.IsDUDealS() == 1)
      return F(0);
    end;
    return F(GetDifB()+"*(1-"+GetKSumBvn()+")");
  END;

  /*212,215
   ! Формула <SumBNRub> = <SumBvp_exps>*<CrBD>-<DifSumBRub> */
  MACRO SumBNRub()
    if(this.IsDUDealS() == 1)
      return F(0);
    end;
    if (m_ReportKind == REALIZREG_0215)
      var V19 = 0;
      GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
      if (V19 == 1)
        return F(GetSumBrub() + "- (" + GetSumBrub() + "*" + GetKSumBvn()
                 + ")-" + GetDifSumBRub());
      end;
    end;
    return F(GetSumBvp_exps()+"*"+GetCrBD()+"-"+GetDifSumBRub());
  END;

  /*212,215
   ! Формула <DifSumBRub_AmortPrev> = <DifB> * <KSumBvn> */
  MACRO DifSumBRub_AmortPrev()
    if(this.IsDUDealS() == 1)
      return F(0);
    end;
    return F(GetDifB()+"*"+GetKSumBvn());
  END;

  /*212,215
   ! Формула <SumBRub_AmortPrev> = <SumBrub> * <KSumBvn> - <DifSumBRub_AmortPrev> */
  MACRO SumBRub_AmortPrev()
    if(this.IsDUDealS() == 1)
      return F(0);
    end;
    return F(GetSumBrub()+"*"+GetKSumBvn()+"-"+GetDifSumBRub_AmortPrev());
  END;

  MACRO ifCoup_( dat:date ):integer
     var RetVal = 0;
     var sql = RSDCommand(" SELECT Count(fiw.t_DrawingDate) Nrec " +
                          "   FROM dfiwarnts_dbt fiw " +
                          "  WHERE fiw.t_FIID         =  ? AND " +
                          "        fiw.t_IsPartial   != 'X' AND " +
                          "        fiw.t_DrawingDate  > ? AND " +
                          "        fiw.t_DrawingDate <= ? "
                         );
     sql.addParam( "", RSDBP_IN, m_RS.FIID );
     sql.addParam( "", RSDBP_IN, iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()) );
     sql.addParam( "", RSDBP_IN, dat );
     sql.execute();

     var vRS = TRsbDataSet( sql );

     if( vRS.MoveNext() and (vRS.Nrec > 0) )
        RetVal = 1;
     end;

     return RetVal;
  END;

  /*Отметка о наличии выплат НКД от эмитента до начала налогового периода (1 - да, 0 - нет)*/
  MACRO ifCoupPrev():integer
     if( m_ifCoupPrev == null )
        m_ifCoupPrev = ifCoup_(this.H0_7()-1);
     end;

     return m_ifCoupPrev;
  END;

  /* НКД, уплаченный при приобретении, уменьшающий процентные доходы, руб. - прошлых налоговых периодов */
  MACRO NkdBprevRub():MONEY
     var RetVal:money = $0.0;

     if( this.ifCoupPrev() == 1 )
        if( m_ReportKind == REALIZREG_0212 )
           RetVal = this.NkdBvp();
        elif( m_ReportKind == REALIZREG_0215 )
           RetVal = this.NkdBrub();
        end;
     end;

     return RetVal;
  END;

  /*НКД, уплаченный при приобретении, уменьшающий процентные доходы текущего налогового периода, руб*/
  MACRO NkdBrepRub():MONEY
     var RetVal:money = $0.0;

     if( this.ifCoupPrev() == 0 )
        if( m_ReportKind == REALIZREG_0212 )
           RetVal = this.NkdBvp();
        elif( m_ReportKind == REALIZREG_0215 )
           RetVal = this.NkdBrub();
        end;
     end;

     return RetVal;
  END;

  /*НКД, уплаченный при приобретении, уменьшающий доходы от реализации (погашения), руб.*/
  MACRO NkdBsellRub():MONEY
     return 0;
  END;

  MACRO CouponSum04_06(Amount, DataBegin, DateEnd, ToRUB):MONEY
    var v_CoupVN = $0.0;
    var DateN1 = date("01.01.2022");
    var DateK1 = date("31.12.2023");

    if ( (m_RS.IsCashMode == "X") and (DateEnd <= Date(31, 12, DendYear)) and ((this.H0_8() < date("01.01.2025")) and (this.H0_8() >= date("01.01.2022"))) )
      if( (this.DDS() >= DateN1) and (this.DDS() <= DateK1))
        v_CoupVN = GetCouponSumByPeriodWithOperStat(m_RS.FIID, Amount, DataBegin, DateEnd, "", IIF(ToRUB, NATCUR, NULL), null, GetDrawingDate(), null, null, null, true);
      elif ( (this.H0_8() >= Date(01, 01, DendYear)) and (this.H0_8() <= Dend-1) )
        v_CoupVN = IIF(ToRUB,
                       GetCouponSumByPeriod_Rub(m_RS.FIID, Amount, DataBegin, DateEnd, m_RS.FaceValueFI, null, this.ExcludeDateCouponPeriod()),
                       GetCouponSumByPeriod(m_RS.FIID, Amount, DataBegin, DateEnd, null, this.ExcludeDateCouponPeriod())
                       );
      elif ( (this.H0_8() >=  Dend) and (this.H0_8() <= Date(31, 12, DendYear)) )
        v_CoupVN = IIF(ToRUB,
                       GetCouponSumByPeriod_Rub(m_RS.FIID, Amount, DataBegin, DateEnd, m_RS.FaceValueFI, null, this.ExcludeDateCouponPeriod()),
                       GetCouponSumByPeriod(m_RS.FIID, Amount, DataBegin, DateEnd, null, this.ExcludeDateCouponPeriod())
                       );
        v_CoupVN = v_CoupVN + GetCouponSumByPeriodWithOperStat(m_RS.FIID, Amount, DateN1, DateK1, "", IIF(ToRUB, NATCUR, NULL), null, this.ExcludeDateCouponPeriod(), null, null, null, false);
      end;
    else
      v_CoupVN = IIF(ToRUB,
                     GetCouponSumByPeriod_Rub(m_RS.FIID, Amount, DataBegin, DateEnd, m_RS.FaceValueFI, null, this.ExcludeDateCouponPeriod(), NULL, NULL, true ),
                     GetCouponSumByPeriod( m_RS.FIID, Amount, DataBegin, DateEnd, null, this.ExcludeDateCouponPeriod(), NULL, true)
                     );
    end;
    return v_CoupVN;
  END;

  MACRO CoupVN():MONEY //  Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде (кроме купона, полученного при погашении бумаги) :
    if( m_CoupVN == NULL )
      m_CoupVN = CouponSum04_06(this.Qnty(), ДДУн(), this.DDS());
    end;
    return m_CoupVN;
  END;

  MACRO CoupRub():MONEY // Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде (кроме купона, полученного при погашении бумаги) - сумма, руб
     if( m_CoupRub == NULL )
        m_CoupRub = CouponSum04_06(this.Qnty(), ДДУн(), this.DDS(), true);
     end;
     return m_CoupRub;
  END;

  /*Для 212
      Заполняется только если <DDB> < <H0.7>
      Если Dк-1 > DDB
      <NkdPrevVN>=(НКД на дату <H0.7>-1 по количеству <Qnty>)
      Иначе <NkdPrevVN>=(НКД на дату <H0.7>-1 по количеству <Qnty>) - <NkdBvp>
    Для 215
      Заполняется только если <DDB> < <H0.7>:
      Если Dк-1 > DDB
      <NkdPrevVN>=(НКД на дату <H0.7>-1 по количеству <Qnty>)
      Иначе <NkdPrevVN>=(НКД на дату <H0.7>-1 по количеству <Qnty>) - NkdBVN.

    При этом :
      если валюта сделки = валюте номинала, то NkdBVN = <NkdBvp> ,
      если валюта сделки= рубли РФ, то NkdBVN = <NkdBvp>/курс ЦБ РФ на дату <DDB>.
  */
  MACRO NkdPrevVN():MONEY
    var v_NkdBvn;
    var DateN1 = date("01.01.2022");
    var DateK1 = date("31.12.2023");
    var FirstCouponDate = FirstCouponWithOperStat(m_RS.t_FIID, DateN1, DateK1);

    if( m_NkdPrevVN == NULL )
      if( iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()) < this.H0_7() )
        if( m_ReportKind == REALIZREG_0212 )
          v_NkdBvn = this.NkdBvp();
        elif( m_ReportKind == REALIZREG_0215 )
           if( this.VprB() == m_RS.FaceValueFI )
             v_NkdBvn = this.NkdBvp();
           elif( this.VprB() == NATCUR )
             v_NkdBvn = this.NkdBvp() / this.CrDDB();
           end;
        end;

        if( (m_RS.IsCashMode == "X") and (this.DDS() <= DateK1) and ((this.H0_8() < date("01.01.2025")) and (this.H0_8() >= date("01.01.2022"))) )
          var DDSYear:INTEGER;
          DateSplit(this.DDS(), NULL, NULL, DDSYear);
          if( (iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()) < DateN1) and (this.DDS() >= DateN1) and (this.DDS() <= DateK1) and 
              ( (FirstCouponDate != NULL) and (FirstCouponDate >= date(01, 01, DDSYear)) and (FirstCouponDate <= date(31, 12, DDSYear)) ) 
            )
            if (this.ДкForPeriod(DateN1, DateK1)-1 > this.DDB())
              m_NkdPrevVN = НКД( m_RS.t_FIID, this.Qnty(), date("31.12.2021"));
            else
              m_NkdPrevVN = НКД( m_RS.t_FIID, this.Qnty(), date("31.12.2021")) - v_NkdBvn;
            end;
          else  
            m_NkdPrevVN = $0;
          end;
        else
          if(this.Дк()-1 > iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()))
            m_NkdPrevVN = НКД( m_RS.t_FIID, this.Qnty(), this.H0_7()-1);
          else
            m_NkdPrevVN = НКД( m_RS.t_FIID, this.Qnty(), this.H0_7()-1) - v_NkdBvn;
          end;
        end;
      else
        m_NkdPrevVN = $0;
      end;
     end;
     return round(m_NkdPrevVN,2);
  END;

  /*
    Заполняется только если <DDB> < <H0.7>
    <NkdPrevRub>=<NkdPrevVn>*курс на дату (<H0.7>-1)
  */
  MACRO NkdPrevRub():MONEY
    if( (m_RS.IsCashMode == "X") and (this.DDB() < date("01.01.2022")) and ((this.H0_8() < date("01.01.2025")) and (this.H0_8() >= date("01.01.2022"))) )
      return this.NkdPrevVN() * GetRateOnDateCrossDbl( date("31.12.2021"), m_RS.FaceValueFI, NATCUR, true);
    end;
    return this.NkdPrevVN() * GetRateOnDateCrossDbl(this.H0_7()-1, m_RS.FaceValueFI, NATCUR, true);
  END;

  MACRO LastCoupDate():DATE
    return GetMaxCouponDrawingDateInPeriod(m_RS.t_FIID, this.Дн(), this.DDS(), this.GetDrawingDate(), SET_CHAR);
  END;

  MACRO TaxGroup():INTEGER
    return m_RS.TaxGroup;
  END;

  /*212,215
   ! Формула <AmortVN> = <AmortVN_before> + <AmortVN_after> */
  MACRO AmortVN()
     return F(GetAmortVN_before()+"+"+GetAmortVN_after());
  END;

  /*Доходы, выплаченные эми-тентом при частичном пога-шении номинала в валюте номинала - до 01.01.2015г.*/
  MACRO AmortVN_before():MONEY
     if( m_AmortVN_before == null )
         m_AmortVN_before = 0;
        if(this.DDB() < Date(1,1,2015) )
           m_AmortVN_before = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1, min(this.DDS(),DATE(31,12,2014)), null, this.GetDrawingDate() );
        end;
     end;
     return m_AmortVN_before;
  END;

  /*Доходы, выплаченные эми-тентом при частичном пога-шении номинала в валюте номинала - с 01.01.2015 - всего*/
  MACRO AmortVN_after():MONEY
     if( m_AmortVN_after == null )
        m_AmortVN_after = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), max(iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1,DATE(1,1,2015)), this.DDS(), null, this.GetDrawingDate() );
     end;
     return m_AmortVN_after;
  END;

  /*Доходы, выплаченные эми-тентом при частичном пога-шении номинала в валюте номинала - За отчетный (налоговый) период*/
  MACRO AmortVNPer():MONEY
     if( m_AmortVNPer == null )
        m_AmortVNPer = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), max(iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())+1,this.H0_7()), this.DDS(), null, this.GetDrawingDate() );
     end;
     return m_AmortVNPer;
  END;

  /*212,215
    ! Формула
       Если <AmortVN> = 0, то <KSumBvn> = 0.
       Иначе: если <AmortVN_before> = 0, то <KSumBvn> = (<AmortVN_after> - <AmortVNPer>) / <Nom_DDB> / <Qnty>, иначе <KSumBvn> = 0.
       Рассчитанное значение НЕ округлять!*/
  MACRO KSumBvn()
     return F(FormulaIF()+"("+GetAmortVN()+"=0;0;"+FormulaIF()+"("+GetAmortVN_before()+"=0;("+GetAmortVN_after()+"-"+GetAmortVNPer()+")/"+GetNom_DDB()+"/"+GetQnty()+";0))");
  END;

  /*212,215
   ! Формула <SumBvp_exps> = <SumBvp> - (<SumBvp>*<KSumBvn>) */
  MACRO SumBvp_exps()
    if(this.IsDUDealS() == 1)
       return F(0);
    end;
    return F(GetSumBvp()+"-("+GetSumBvp()+"*"+GetKSumBvn()+")");
  END;

  /*215
   ! Формула <SumBvpPrev_exps> = <SumBvp>*<KSumBvn> */
  MACRO SumBvpPrev_exps()
    if(this.IsDUDealS() == 1)
      return F(0);
    end;
    return F(+GetSumBvp()+"*"+GetKSumBvn());
  END;

  /*212,215
   ! Формула <Taxe_Amort> = <SumAllRub> + <DifS> - <RashAll> */
  MACRO Taxe_Amort()
     return F(GetSumAllRub()+"+"+GetDifS()+"-"+GetRashAll());
  END;

  /*212,215
   ! Формула <Taxe_NKD> = <NkdRepRub> - <NKDminusRub> */
  MACRO Taxe_NKD()
     if( (m_ReportKind == REALIZREG_0212) or (m_ReportKind == REALIZREG_0215) )
        return F(GetNkdRepRub()+"-"+GetNKDminusRub());
     end;
     return F(GetNkdRepRub());
  END;

  MACRO GetDrawingDateFact():DATE
     if(this.ExpiryDate() == ZeroDate)
        return IIF(IsRET_ISSUE(int(m_RS.DealSaleGroup)),this.DDS(),this.Dexp());
     end;
     return this.ExpiryDate();
  END;

  MACRO NkdSvp():MONEY //  НКД полученный при реализации (погашении), в валюте сделки
     if(m_NkdSvp == null)
        /*если не включен режим хранилища данных для налогового учета и 215 регистр*/
        if( m_RS.SBofficeKind != DL_RETIREMENT )
           if(( CheckTaxDepositoryMode() == false ) and ( m_ReportKind == REALIZREG_0215 ) and (this.VPrS() == NATCUR) )
              m_NkdSvp = NkdSvp() * this.CrDDS();
           else
              m_NkdSvp = NkdSvp();
           end;
        else/*Для погашений (НКД всегда в валюте номинала)*/
           m_NkdSvp = NkdSvp();
           if( m_NkdSvp == $0.0 )
              m_NkdSvp = GetCouponSumByPeriod( m_RS.FIID, this.Qnty(), this.GetDrawingDateFact(), this.GetDrawingDateFact() );
           end;
        end;
     end;
     return m_NkdSvp;
  END;

  MACRO APS():STRING
    return DL_GetValueName( OBJTYPE_KINDPORT, m_RS.SalePortf );
  END;

  MACRO APB():STRING
    return DL_GetValueName( OBJTYPE_KINDPORT, m_RS.BuyPortf );
  END;

  /*212,215*/
  MACRO NkdRepRubAll():MONEY
     var vNkdRepRubAll = $0;
     if( m_ReportKind == REALIZREG_0212 )
        vNkdRepRubAll = NkdSvp() + CoupVN();
        if( (this.ifCoupPrev() == 0) OR (this.DDB() >= this.H0_7()) OR (this.ImportDUDate() >= this.H0_7()))
           vNkdRepRubAll = vNkdRepRubAll - this.NkdBvp();
        end;
        vNkdRepRubAll = vNkdRepRubAll - this.NkdPrevVN();
     elif( m_ReportKind == REALIZREG_0215 )
        vNkdRepRubAll = NkdSrub() + CoupRub();
        if( (this.ifCoupPrev() == 0) OR (this.DDB() >= this.H0_7()) OR (this.ImportDUDate() >= this.H0_7()))
           vNkdRepRubAll = vNkdRepRubAll - this.NkdBrub();
        end;
        vNkdRepRubAll = vNkdRepRubAll - this.NkdPrevRub();
     end;
     return vNkdRepRubAll;
  END;

  MACRO SaveFIIDForForm_cons(FIID:integer)
     var query, exec;
     query =   " INSERT INTO dspprtcst_tmp ( T_FIID ) VALUES (?) ";
     exec = RSDCommand(query);
     exec.addParam( "", RSDBP_IN, FIID );
     exec.execute();
  END;

  MACRO SumWarnKind( FIID:integer, Kind:string, ToFIID:integer ):money
     var RetVal:money = $0.0;

     var exec = RSDCommand( " SELECT warn.t_ChargeDate, warn.t_IncomeVolume, warn.t_IncomeFI " +
                            "   FROM dfiflwarn_dbt warn " +
                            "  WHERE warn.t_FIID = ? " +
                            "    AND warn.t_ChargeDate >= ? " +
                            "    AND warn.t_ChargeDate <= ? " +
                            "    AND warn.t_IncomeCode = ? " );
     exec.addParam( "", RSDBP_IN, FIID );
     exec.addParam( "", RSDBP_IN, this.H0_7() );
     exec.addParam( "", RSDBP_IN, this.H0_8() );
     exec.addParam( "", RSDBP_IN, Kind );
     exec.execute();

     var rs = TRsbDataSet( exec );
     while( rs.MoveNext() )
        if( (ToFIID == NULL) or (SQL_ConvTypeInteger(rs.IncomeFI) == ToFIID) )
           RetVal = RetVal + SQL_ConvTypeSum(rs.IncomeVolume);
        else
           var Tmp:money = $0.0;
           if( SmartConvertSum(Tmp, SQL_ConvTypeSum(rs.IncomeVolume), SQL_ConvTypeDate(rs.ChargeDate), SQL_ConvTypeInteger(rs.IncomeFI), ToFIID, true) == true )
              RetVal = RetVal + Tmp;
           end;
        end;
     end;

     return RetVal;
  END;

  MACRO ExistsWarnKind( FIID:integer, Kind:string ):bool
     var RetVal:bool = false;

     var exec = RSDCommand( " SELECT count(1) cnt " +
                            "   FROM dfiflwarn_dbt " +
                            "  WHERE t_FIID = ? " +
                            "    AND t_ChargeDate >= ? " +
                            "    AND t_ChargeDate <= ? " +
                            "    AND t_IncomeCode = ? " );
     exec.addParam( "", RSDBP_IN, FIID );
     exec.addParam( "", RSDBP_IN, this.H0_7() );
     exec.addParam( "", RSDBP_IN, this.H0_8() );
     exec.addParam( "", RSDBP_IN, Kind );
     exec.execute();

     var rs = TRsbDataSet( exec );
     if( rs.MoveNext() and (rs.cnt > 0) )
        RetVal = true;
     end;

     return RetVal;
  END;

  MACRO НетОстатковЦБ_ПоСделкам( FIID:integer ):bool
     var RetVal:bool = false;

     var exec = RSDCommand( " select (Rest.Amount + RepoRest.Amount) as Amount from "+
                            "  (SELECT NVL(sum(TXRest.T_AMOUNT),0) AS Amount "+
                            "     FROM DSCTXREST_DBT TXRest," +
                            "          DSCTXLOT_DBT  currTXBuyLot, DSCTXLOT_DBT  TXBuyLot " +
                            "    WHERE currTXBuyLot.t_ID = TXRest.t_SourceID AND " +
                            "          TXBuyLot.t_ID = currTXBuyLot.t_BegLotID AND "+
                            "          TXRest.T_FIID = ? AND "+
                            "          TXBuyLot.t_Type = " + string(TXLOTS_BUY)+ " AND " +
                            "          TXRest.t_BUYDATE <= ? AND " +
                            "          TXRest.t_BUYDATE <> to_date('01.01.0001','DD.MM.YYYY') AND " +
                            "          ( TXRest.t_SALEDATE IS NULL  OR " +
                            "            TXRest.t_SALEDATE = to_date('01.01.0001','DD.MM.YYYY') OR " +
                            "            TXRest.t_SALEDATE > ? " +
                            "          ) " +
                            "  ) Rest, "+/*в остатке*/
                            "  (SELECT NVL(sum(lnk.t_Amount - rsb_sctx.TXGetSumSCTXLSOnDate(lnk.t_ID, ?)),0) AS Amount "+
                            "     from dsctxlnk_dbt lnk, " +
                            "          dsctxlot_dbt TXBuyLot, " +
                            "          dsctxlot_dbt currbuylot, " +
                            "          dsctxlot_dbt currsalelot " +
                            "    where lnk.t_Type in (" + string(TXLNK_DELREPO) + "," + string(TXLNK_SUBSTREPO) + "," + string(TXLNK_LOANPUT) + "," + string(TXLNK_SUBSTLOAN) + ") and " +
                            "          currbuylot.t_ID = lnk.t_BuyID and " +
                            "          TXBuyLot.t_ID = currbuylot.t_BegLotID and " +
                            "          TXBuyLot.T_FIID = ? AND "+
                            "          TXBuyLot.t_Type = " + string(TXLOTS_BUY)+ " AND " +
                            "          currsalelot.t_ID = lnk.t_SaleID and " +
                            "          lnk.t_Date <= ? and " +
                            "          (lnk.t_BegDate = to_date('01.01.0001', 'DD.MM.YYYY') or lnk.t_BegDate <= ?) and " +
                            "          (lnk.t_EndDate = to_date('01.01.0001', 'DD.MM.YYYY') or lnk.t_EndDate > ?) and " +
                            "          (    currsalelot.t_BuyDate = to_date('01.01.0001', 'DD.MM.YYYY') " +
                            "            or currsalelot.t_BuyDate > ? "
                            "          ) " +/*в размещении*/
                            "  ) RepoRest "
                          );

     exec.addParam( "", RSDBP_IN, FIID );
     exec.addParam( "", RSDBP_IN, this.H0_8() );
     exec.addParam( "", RSDBP_IN, this.H0_8() );

     exec.addParam( "", RSDBP_IN, this.H0_8() );
     exec.addParam( "", RSDBP_IN, FIID );
     exec.addParam( "", RSDBP_IN, this.H0_8() );
     exec.addParam( "", RSDBP_IN, this.H0_8() );
     exec.addParam( "", RSDBP_IN, this.H0_8() );
     exec.addParam( "", RSDBP_IN, this.H0_8() );

     exec.execute();

     var rs = TRsbDataSet( exec );
     if( rs.MoveNext() and (SQL_ConvTypeSum(rs.Amount) == $0) )
        RetVal = true;
     end;

     return RetVal;
  END;

  //PrintRep == true - признак печати отчёта (сначала запускаем в режиме PrintRep == false - проверка для формирования массива бумаг, по которым выводим дополнительные строки)
  PRIVATE MACRO ПечатьДополнительныхСтрок( ObjReport:OBJECT, FIID, FI_Code, Name, TaxGroup, FaceValueFI, PrintRep )
     var Kind = "", i = 0;
     if( НетОстатковЦБ_ПоСделкам(FIID) == true )
        Kind = "1";
        if( ExistsWarnKind(FIID,Kind) )
           if(PrintRep)
              ObjReport.PrintAdd(FIID, FI_Code, Name, TaxGroup, Kind,FaceValueFI);
              SaveFIIDForForm_cons(FIID);
              i = 0;
              while (i < ArrFIIDAdd.size)
                 if (ArrFIIDAdd[i] == FIID)
                    ArrFIIDAdd[i] = -1; // повторно не печатать то, что попадёт в отчёт как необращающиеся
                 end;
                 i = i + 1;
              end;
           else
              ArrFIIDAdd[ArrFIIDAdd.size] = FIID;
              SaveFIIDForForm_cons(FIID);
              m_IsDataExist = true;
           end;
        end;
        Kind = "2";
        if( ExistsWarnKind(FIID,Kind) )
           if(PrintRep)
              ObjReport.PrintAdd(FIID, FI_Code, Name, TaxGroup, Kind,FaceValueFI);
              SaveFIIDForForm_cons(FIID);
              i = 0;
              while (i < ArrFIIDAdd.size)
                 if (ArrFIIDAdd[i] == FIID)
                    ArrFIIDAdd[i] = -1; // повторно не печатать то, что попадёт в отчёт как необращающиеся
                 end;
                 i = i + 1;
              end;
           else
              ArrFIIDAdd[ArrFIIDAdd.size] = FIID;
              SaveFIIDForForm_cons(FIID);
              m_IsDataExist = true;
           end;
        end;
     end;
  END;

  PRIVATE MACRO GetAddWhereForAvr()

     VAR AddWhere = "";
     VAR AvrFIIDList = null;
     VAR AvrFIIDCount : Integer = 0;
     VAR AvrFIIDAddWhere : String = "";
     VAR WasSetSecurity : Bool = false;
     VAR GNUList = null;
     VAR GNUAddWhere : String = "";
     VAR GNUCount : Integer = 0;

     /*ценные бумаги в соединенных сделках  должны удовлетворять условиям, заданным панели подготовки отчета*/
     if( not m_IsWebService )
        AvrFIIDList = TArray();
        AvrFIIDList[AvrFIIDList.Size] = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_AVRCODE_2014 );
     else
        AvrFIIDList = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_AVRCODE_2014 );
     end;
     if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
        while( AvrFIIDCount < AvrFIIDList.Size )
           if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
           and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
              if( AvrFIIDAddWhere == "" )
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
              else
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
              end;
              AvrFIIDAddWhere = AvrFIIDAddWhere + " FI.t_FIID = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
           end;
           AvrFIIDCount = AvrFIIDCount + 1;
        end;
        if( AvrFIIDAddWhere != "" )
           AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
           WasSetSecurity = true;
        end;
        AddWhere = AddWhere + AvrFIIDAddWhere;
     end;

     /*если не задана бумага*/
     if( not WasSetSecurity )

        if( not m_IsWebService )
           GNUList = TArray();
           GNUList[GNUList.Size] = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_AVRGROUP_2014 );
        else
           GNUList = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_AVRGROUP_2014 );
        end;
        /*задана категория бумаги*/
        if( ( ValType( GNUList ) != V_UNDEF ) and ( GNUList.Size > 0 ) )
           while( GNUCount < GNUList.Size )
              if( ( ValType( GNUList[GNUCount] ) == V_INTEGER )
              and ( GNUList[GNUCount] > 0 ) )
                 if( GNUAddWhere == "" )
                    GNUAddWhere = GNUAddWhere + " AND ( ";
                 else
                    GNUAddWhere = GNUAddWhere + " OR ";
                 end;
                 GNUAddWhere = GNUAddWhere + " AV.t_TaxGroup = " + String( GNUList[GNUCount] ) + " ";
              end;
              GNUCount = GNUCount + 1;
           end;
           if( GNUAddWhere != "" )
              GNUAddWhere = GNUAddWhere + " ) ";
           end;
           AddWhere = AddWhere + GNUAddWhere;
        end;
     end;

     AddWhere = AddWhere + " AND AV.t_TaxGroup <> 888 and AV.t_TaxGroup <> 999 and AV.t_TaxGroup <> 919 and AV.t_TaxGroup <> 943 ";

     if( (RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_EXCLUDE_2014 ) == "X") AND (ИсключаемыеИзОтчетаЦБ != "") )
        AddWhere = AddWhere + " AND FI.t_FI_Code not in (" + ИсключаемыеИзОтчетаЦБ + ")";
     end;

     return AddWhere;
  END;

  MACRO GetSaleIsTechDealWhereTmp()
     return " SaleLotData.t_TechDeal > 0 ";
  END;

  MACRO GetSaleIsFISSDealWhereTmp()
     return  " SaleLotData.t_FISSDeal > 0 ";
  END;

  PRIVATE MACRO GetAddWhereForDealTmp()

     VAR AddWhere = "";
     VAR AvrFIIDList = null;
     VAR AvrFIIDCount : Integer = 0;
     VAR AvrFIIDAddWhere : String = "";
     VAR WasSetSecurity : Bool = false;
     VAR GNUList = null;
     VAR GNUAddWhere : String = "";
     VAR GNUCount : Integer = 0;
     VAR SaleIsTechDealWhere = "";
     VAR SaleIsFISSDealWhere = "";

     //У сделки категория "Является технической сделкой" имеет значение 2 - Техническая сделка (ГО)
     SaleIsTechDealWhere = GetSaleIsTechDealWhereTmp();

     SaleIsFISSDealWhere = GetSaleIsFISSDealWhereTmp();

     if( m_RunByQuoted == true )
        AddWhere = AddWhere + " AND SaleLotData.t_ifMarket = 'X' AND NOT (" + SaleIsTechDealWhere + ")"+ " AND NOT (" + SaleIsFISSDealWhere + ")";
     end;
     if ( m_RunByTech == true )
        AddWhere = AddWhere + " AND (" + SaleIsTechDealWhere + ")";
     end;
     if ( m_RunByNoQuoted == true )
        AddWhere = AddWhere + " AND SaleLotData.t_ifMarket != 'X' AND NOT (" + SaleIsTechDealWhere + ")"+ " AND NOT (" + SaleIsFISSDealWhere + ")";
     end;

     if ( m_RunByFISS == true )
        /*отбираются все сделки, где на сделке продажи установлен классификатор "Вид ФИСС".*/
        AddWhere = AddWhere + " AND " + SaleIsFISSDealWhere;
     end;

     return AddWhere;

  END;

  MACRO GetAddWhereExistsWarnKind()
     return " and exists( SELECT t_FIID " +
            "               FROM dfiflwarn_dbt " +
            "              WHERE t_FIID = FI.t_FIID " +
            "                AND t_ChargeDate >= " + GetSQLDate( m_H07 ) +
            "                AND t_ChargeDate <= " + GetSQLDate(m_H08) +
            "                AND t_IncomeCode in('1','2') " +
            "           ) ";
  END;

  /*Значение поля <Код> категории сделки <Вид ФИСС> (фьючерс, форвард, опцион) по сделке <CodeS>*/
  MACRO RFISSS()
     return SQL_ConvTypeStr(m_RS.RFISSS);
  END;

  /*Значение поля <Код> категории сделки <Вид ФИСС> (фьючерс, форвард, опцион) по сделке <CodeB>*/
  MACRO RFISSB()
     return SQL_ConvTypeStr(m_RS.RFISSB);
  END;

  /*Значение примечания "Дата в учете" сделки <CodeS>*/
  MACRO DRS()
    if( SQL_ConvTypeDATE(m_RS.DRS) != Date(0,0,0) )
       return SQL_ConvTypeDATE(m_RS.DRS);
    end;
  END;
 
 /*Значение примечания "Дата в учете" сделки <CodeB>*/
  MACRO DRB()
    if( SQL_ConvTypeDATE(m_RS.DRB) != Date(0,0,0) )
       return SQL_ConvTypeDATE(m_RS.DRB);
    end;
  END;

  /*Значение поля <Код> категории <Сделка подлежит дополнительному контролю> по сделке <CodeS>*/
  MACRO K_ControlS():string
    if( m_K_ControlS == null )
       m_K_ControlS = SQL_ConvTypeStr(m_RS.K_ControlS);
    end;
    return m_K_ControlS;
  END;

  /*Значение поля <Код> категории <Сделка подлежит дополнительному контролю> по сделке <CodeB>*/
  MACRO K_ControlB():string
    if( m_K_ControlB == null )
       m_K_ControlB = SQL_ConvTypeStr(m_RS.K_ControlB);
    end;

    if((m_RS.LnkType == TXLNK_CLSREPO) OR (m_RS.LnkType == TXLNK_CLSLOAN))
       if(m_K_ControlB != "")
          m_K_ControlB = m_K_ControlB + ", ";
       end;
       
       m_K_ControlB = m_K_ControlB + "ЗКП";
    end;
    return m_K_ControlB;
  END;

  /*Значение поля <Код> категории сделки <Способ определения РЦ>*/
  MACRO RCB():string
    return SQL_ConvTypeStr(m_RS.RCB);
  END;

  /*Значение поля <Код> категории сделки <Способ определения РЦ>*/
  MACRO RCS():string
    return SQL_ConvTypeStr(m_RS.RCS);
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Коммента-рий для категории <Сделка подлежит дополнительному контролю>>*/
  MACRO Control_CommentB():string
    var m_Control_CommentB = SQL_ConvTypeStr(m_RS.Control_CommentB);

    if((m_RS.LnkType == TXLNK_CLSREPO) OR (m_RS.LnkType == TXLNK_CLSLOAN))
       if(m_Control_CommentB != "")
          m_Control_CommentB = m_Control_CommentB + ", ";
       end;

       m_Control_CommentB = m_Control_CommentB + "Закрытие короткой позиции";
    end;

    return m_Control_CommentB;
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Коммента-рий для категории <Сделка подлежит дополнительному контролю>>*/
  MACRO Control_CommentS():string
    return SQL_ConvTypeStr(m_RS.Control_CommentS);
  END;

  MACRO DqualB():DATE
    if( SQL_ConvTypeDATE(m_RS.DqualB) != Date(0,0,0) )
       return SQL_ConvTypeDATE(m_RS.DqualB);
    end;
  END;                                                                                    

  MACRO DqualS():DATE
    if( SQL_ConvTypeDATE(m_RS.DqualS) != Date(0,0,0) )
       return SQL_ConvTypeDATE(m_RS.DqualS);
    end;
  END;

  /*Значение примечания сделки "Прочие комиссии" по сделке  <CodeB> *<Qnty> /QB*/
  MACRO ComB_Another()
     if( m_ComB_Another == null )
        m_ComB_Another = $0;
        if( this.QB() != 0.0 )
           if(this.IsDUDealS() == 1)
             return m_RS.CommBuy * Qnty()/this.QB();
           end;
           m_ComB_Another = SQL_ConvTypeSum(m_RS.ComB_Another) * this.Qnty()/this.QB();
        end;
     end;
     return m_ComB_Another;
  END;

  /*Значение примечания сделки "Прочие комиссии" по сделке  <CodeS> *<Qnty> /QS*/
  MACRO ComS_Another()
     if( m_ComS_Another == null )
        m_ComS_Another = $0;
        if( this.QS() != 0.0 )
           if(this.IsDUDealS() == 1)
             return m_RS.CommSale * (this.Qnty()/this.QS());
           end;
           m_ComS_Another = SQL_ConvTypeSum(m_RS.ComS_Another) * this.Qnty()/this.QS();
        end;
     end;
     return m_ComS_Another;
  END;

  MACRO printPrAucNom():STRING //  Цена размещения в % от номинала
     if( ЛьготнаяОблигация( m_RS.TaxGroupType ) )
        return ЧислоCЗаданнойТочностью(this.PrAucNom(), 5);
     end;
  END;

  MACRO NKDownVN():MONEY //  Процентный доход за период с даты приобретения по дату реализации :
     if( m_NKDownVN == NULL )
        if( ЛьготнаяОблигация( m_RS.TaxGroupType ) )
           m_NKDownVN = this.Qnty()*this.Nom() * (1-0.01*this.PrAucNom()) * (this.DDS()-iif(this.IsDUDealS() == 1, this.ImportDUDate(), this.DDB())) 
                         / (this.Dexp()-this.Dauc());
        else
           m_NKDownVN = this.Qnty()*this.Nom() * (1-0.01*this.PrBNom()) * (this.DDS()-iif(this.IsDUDealS() == 1, this.ImportDUDate(), this.DDB())) 
                         / (this.Dexp()-iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()));
        end;
     end;
     return m_NKDownVN;
  END;

  MACRO NKDownRub():MONEY
     VAR NkdRUR = $0;
     SmartConvertSum( NkdRUR, this.NKDownVN(), this.DDS(), m_RS.FaceValueFI, NATCUR, true );
     return NkdRUR;
  END;

  MACRO DGO():DATE // Дата глобальной операции
     return SQL_ConvTypeDate(m_RS.DGO);
  END;

  PRIVATE MACRO LoadDataInTMP(FI)
    var query = "";
    var header = "Отбор данных по "+GetSQLString(FI.AvrCode)+" ( "+m_FI_CurNRec+" из "+m_FI_NRecs+") для регистра "+m_SHEET_1+" ( "+GetSubKindReg()+" )";

    SQL_Truncate( "DREALIZREG_TMP" );

    query = 
      " DECLARE \n"
    + " PartyID NUMBER; \n"
    + " TYPE realiz_t IS TABLE OF DREALIZREG_TMP%ROWTYPE; \n"
    + "    g_realiz_ins realiz_t := realiz_t(); \n"
    + "    realiz DREALIZREG_TMP%rowtype; \n"
    + " BEGIN \n"
    + " FOR one_rec IN (SELECT DISTINCT TXLotSale.t_ID LotSaleID, "
    + "                        TXLotSale.t_SALEDATE AS SaleDate, "
    + "                        DealSale.t_BofficeKind, DealSale.t_DealID,  DealSale.t_PartyID, DealSale.t_MarketID, DealSale.t_DealDate  "
    + "           FROM DSCTXLNK_DBT TXLink, DSCTXLOT_DBT TXLotSale, DDL_TICK_DBT DealSale, dsctxlot_dbt TXLotBuy "
    + "          WHERE ( (TXLink.t_Date BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate(m_H08) 
    + "                    AND (TXLink.T_BEGDATE IS NULL OR TXLink.T_BEGDATE = " + GetSQLDate( DATE(0,0,0) ) + ")"
    + "                  ) "
    + "                  OR (TXLink.T_BEGDATE BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate( m_H08 )+")"
    + "                ) "
    + "            AND ("
    + "                   TXLink.t_Type = " + TXLNK_DELIVER
    + "                   OR ("
    + "                         TXLink.t_Type in (" + TXLNK_CLSREPO + ", " + TXLNK_CLSLOAN + ")"
    + "                         AND ("
    + "                                TXLink.t_EndDate IS NULL "
    + "                                OR TXLink.t_EndDate = " + GetSQLDate( DATE(0,0,0) )
    + "                                OR TXLink.t_EndDate > " + GetSQLDate( m_H08 )
    + "                             ) AND "
    + "                         TXLotBuy.t_VirtualType = " + TXVDEAL_REAL + " AND "
    + "                         TXLotBuy.t_BuyDate < TXLotSale.t_SaleDate "
    + "                      )"
    + "                )"
    + "            AND TXLink.t_FIID = "+SQL_ConvTypeInteger(FI.FIID)+" \n"
    + "            AND TXLotSale.t_ID = TXLink.t_SaleID "
    + "            AND TXLotSale.t_Origin <> "+ TXLOTORIGIN_PORTFTRANSFER
    + "            AND TXLotBuy.t_ID = TXLink.t_BuyID"
    + "            AND DealSale.t_DealID = CASE TXLotSale.t_VirtualType WHEN 1 THEN TXLotSale.t_DealID ELSE (select t_DealID from dsctxlot_dbt  where t_ID = TXLotSale.t_RealID) END ) \n" //рекомендация Рыжикова
    + "      LOOP \n"
    + "        realiz.t_LotID          := one_rec.LotSaleID; \n"
    + "        realiz.t_ifMarket       := Rsb_SCTX.ifMarket_NEW(realiz.t_LotID); \n"
    + "        realiz.t_MarketPrice    := Rsb_SCTX.GetMarketPrice_New(realiz.t_LotID); \n"
    + "        realiz.t_Val_Market     := Rsb_SCTX.GetVal_Market_New(realiz.t_LotID); \n"
    + "        realiz.t_DateMarket     := Rsb_SCTX.GetDateMarket_New(realiz.t_LotID); \n"
    + "        realiz.t_Market         := Rsb_SCTX.GetMarket_New(realiz.t_LotID); \n"
    + "        realiz.t_QuoteValue     := Rsb_SCTX.GetQuoteValue_New(realiz.t_LotID); \n"
    + "        realiz.t_ComSum         := Rsb_SCTX.TXGetComissionsSum(one_rec.t_DealID, one_rec.t_BOfficeKind, one_rec.SALEDATE, 0); \n"
    + "        realiz.t_NDSComSum      := Rsb_SCTX.TXGetNDSComSum(one_rec.t_DealID, one_rec.t_BOfficeKind, one_rec.SALEDATE, 0); \n"
    + "        if( (one_rec.t_PartyID = -1) and one_rec.t_MarketID > 0 ) then \n"
    + "           PartyID := one_rec.t_MarketID; \n"
    + "        else \n"
    + "           PartyID := one_rec.t_PartyID; \n"
    + "        end if; \n"
    + "        begin \n"
    + "             SELECT t_name into realiz.t_PARTYName\n"
    + "               FROM dparty_dbt \n"
    + "              WHERE t_PartyID = PartyID; \n"
    + "        EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_PARTYName := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "             SELECT COUNT(1) into realiz.t_TechDeal\n"
    + "               FROM dobjatcor_dbt objatcor \n"
    + "              WHERE objatcor.t_ObjectType = 101 \n"
    + "                AND objatcor.t_GroupID = 24 \n" 
    + "                AND objatcor.t_AttrID = 2 \n" 
    + "                AND objatcor.t_Object = LPAD( one_rec.t_DealID, 34, '0' ); \n"
    + "        EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_TechDeal := 0; \n"
    + "        end; \n"
    + "        begin  \n"
    + "            Select to_number(ATTR.T_NUMINLIST), ATTR.T_NAME into realiz.t_FISSDeal, realiz.t_FISSDealName \n"
    + "              From dobjatcor_dbt AtCor, dobjattr_dbt Attr \n" 
    + "             Where AtCor.t_ObjectType = 101 \n"
    + "               And AtCor.t_GroupID    = "+OBJGROUP_TICKFIIS+" \n"
    + "               And AtCor.t_Object     = LPAD(one_rec.t_DealID, 34, '0' ) \n"
    + "               And Attr.t_AttrID      = AtCor.t_AttrID \n" 
    + "               And Attr.t_ObjectType  = AtCor.t_ObjectType \n"
    + "               And Attr.t_GroupID     = AtCor.t_GroupID; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_FISSDeal := 0; \n"
    + "                                              realiz.t_FISSDealName := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "            select rsb_struct.getdate(t_Text)  into realiz.t_DR \n"
    + "              from dnotetext_dbt \n"
    + "             where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "               and t_ObjectType = 101 \n"
    + "               and t_NoteKind = "+NOTEKIND_SECDEAL_DATEIN+"; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_DR := TO_DATE ('01.01.0001','DD.MM.YYYY'); \n"
    + "        end; \n"   
    + "        begin \n"                
    + "            Select ATTR.T_NUMINLIST into realiz.t_ControlCat \n"
    + "              From dobjatcor_dbt AtCor, dobjattr_dbt Attr \n" 
    + "             Where AtCor.t_ObjectType in(101, 117) \n"
    + "               And AtCor.t_GroupID    = "+OBJGROUP_TICKCONTROL+" \n"
    + "               And AtCor.t_Object     = LPAD(one_rec.t_DealID, 34, '0' ) \n"
    + "               And Attr.t_AttrID      = AtCor.t_AttrID  \n"
    + "               And Attr.t_ObjectType  = AtCor.t_ObjectType \n"
    + "               And Attr.t_GroupID     = AtCor.t_GroupID ; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_ControlCat := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "            Select ATTR.T_NUMINLIST into realiz.t_RC \n"
    + "                         From dobjatcor_dbt AtCor, dobjattr_dbt Attr \n" 
    + "                        Where AtCor.t_ObjectType = 101 \n"
    + "                          And AtCor.t_GroupID    = "+OBJGROUP_TICKRC+" \n"
    + "                          And AtCor.t_Object     = LPAD(one_rec.t_DealID, 34, '0' ) \n"
    + "                          And Attr.t_AttrID      = AtCor.t_AttrID  \n"
    + "                          And Attr.t_ObjectType  = AtCor.t_ObjectType \n"
    + "                          And Attr.t_GroupID     = AtCor.t_GroupID; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_RC := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "          select rsb_struct.getString(t_Text)  into realiz.t_ControlNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType in(101, 117) \n"
    + "             and t_NoteKind = "+NOTEKIND_SECDEAL_CONTROLCOMMENT+"; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_ControlNote := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "          select rsb_struct.getdate(t_Text) into realiz.t_Dqual \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101  \n"
    + "             and t_NoteKind = "+NOTEKIND_SECDEAL_REQUALREPO+"; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_Dqual := TO_DATE ('01.01.0001','DD.MM.YYYY'); \n"
    + "        end; \n"
    + "        begin \n"
    + "          select rsb_struct.getMoney(t_Text) into realiz.t_AnotherComNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101 \n"
    + "             and t_NoteKind = "+NOTEKIND_SECDEAL_OHTCOMISS+"; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_AnotherComNote := 0; \n"
    + "        end; \n"
    + "        begin  \n"
    + "          select rsb_struct.getMoney(t_Text) into realiz.t_PriceDifNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101 \n"
    + "             and t_NoteKind = 27; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_PriceDifNote := 0; \n"
    + "        end; \n"
    + "        begin \n"
    + "          select count(1) into realiz.t_IsPriceDifNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101 \n"
    + "             and t_NoteKind = 27;  \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_IsPriceDifNote := 0; \n"
    + "        end; \n"
    + "        begin \n"
    + "          SELECT NVL(min(t_FactDate),TO_DATE ('01.01.0001','DD.MM.YYYY')) into realiz.t_DP \n"
    + "            FROM ddlrq_dbt \n"
    + "           WHERE t_DocKind  = one_rec.t_BofficeKind AND \n" 
    + "                 t_DocID    = one_rec.t_DealID AND \n" 
    + "                 t_DealPart = 1 AND \n"
    + "                 t_Type in(RSI_DLRQ.DLRQ_TYPE_AVANCE,RSI_DLRQ.DLRQ_TYPE_DEPOSIT,RSI_DLRQ.DLRQ_TYPE_PAYMENT) AND \n"
    + "                 t_FactDate != TO_DATE('01-01-0001','DD-MM-YYYY'); \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_DP := TO_DATE ('01.01.0001','DD.MM.YYYY'); \n"
    + "        end; \n"
    + "        g_realiz_ins.extend; \n"
    + "        g_realiz_ins(g_realiz_ins.LAST) := realiz; \n"
    + "      END LOOP; \n"    
    + "      FOR one_rec IN (SELECT DISTINCT TXLotBuy.t_ID LotBuyID, TXLotBuy.t_BuyDATE, DealBuy.t_BOfficeKind, DealBuy.t_DealID, DealBuy.t_PartyID, DealBuy.t_MarketID, DealBuy.t_DealDate \n"
    + "           FROM DSCTXLNK_DBT TXLink, DSCTXLOT_DBT TXLotSale, DSCTXLOT_DBT TXLotBuy, DDL_TICK_DBT DealBuy \n"
    + "          WHERE ( (TXLink.t_Date BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate(m_H08) 
    + "                       AND (TXLink.T_BEGDATE IS NULL OR TXLink.T_BEGDATE = " + GetSQLDate( DATE(0,0,0) ) +")\n"
    + "                      ) \n"
    + "                     OR (TXLink.T_BEGDATE BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate( m_H08 )+")\n"
    + "                    ) \n"
    + "                AND ("
    + "                       TXLink.t_Type = " + TXLNK_DELIVER
    + "                       OR ("
    + "                             TXLink.t_Type in (" + TXLNK_CLSREPO + ", " + TXLNK_CLSLOAN + ")"
    + "                             AND ("
    + "                                    TXLink.t_EndDate IS NULL"
    + "                                    OR TXLink.t_EndDate = " + GetSQLDate( DATE(0,0,0) )
    + "                                    OR TXLink.t_EndDate > " + GetSQLDate(m_H08)
    + "                                 )"
    + "                             AND TXLotBuy.t_VirtualType = " + TXVDEAL_REAL
    + "                             AND TXLotBuy.t_BuyDate < TXLotSale.t_SaleDate"
    + "                          )"
    + "                    )"
    + "                AND TXLink.t_FIID = "+SQL_ConvTypeInteger(FI.FIID)+" \n"
    + "                AND TXLotSale.t_ID = TXLink.t_SaleID \n"
    + "                AND TXLotSale.t_Origin <> "+ TXLOTORIGIN_PORTFTRANSFER
    + "                AND TXLotBuy.t_ID = TXLink.t_BuyID \n"
    + "                and DealBuy.t_DealID = TXLotBuy.t_DealID) \n"
    + "      LOOP \n"
    + "        realiz.t_LotID          := one_rec.LotBuyID; \n"
    + "        realiz.t_ifMarket       := CHR(0); \n"
    + "        realiz.t_MarketPrice    := Rsb_SCTX.GetMarketPrice_New(realiz.t_LotID); \n"
    + "        realiz.t_Val_Market     := Rsb_SCTX.GetVal_Market_New(realiz.t_LotID); \n"
    + "        realiz.t_DateMarket     := Rsb_SCTX.GetDateMarket_New(realiz.t_LotID); \n"
    + "        realiz.t_Market         := Rsb_SCTX.GetMarket_New(realiz.t_LotID); \n"
    + "        realiz.t_QuoteValue     := Rsb_SCTX.GetQuoteValue_New(realiz.t_LotID); \n"
    + "        realiz.t_ComSum         := Rsb_SCTX.TXGetComissionsSum(one_rec.t_DealID, one_rec.t_BOfficeKind, one_rec.t_BuyDATE, 0); \n"
    + "        realiz.t_NDSComSum      := Rsb_SCTX.TXGetNDSComSum(one_rec.t_DealID, one_rec.t_BOfficeKind, one_rec.t_BuyDATE, 0); \n"
    + "        if( (one_rec.t_PartyID = -1) and one_rec.t_MarketID > 0 ) then \n"
    + "           PartyID := one_rec.t_MarketID; \n"
    + "        else \n"
    + "           PartyID := one_rec.t_PartyID; \n"
    + "        end if; \n"
    + "        begin \n"
    + "             SELECT t_name into realiz.t_PARTYName\n"
    + "               FROM dparty_dbt \n"
    + "              WHERE t_PartyID = PartyID; \n"
    + "        EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_PARTYName := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "             SELECT COUNT(1) into realiz.t_TechDeal\n"
    + "               FROM dobjatcor_dbt objatcor \n"
    + "              WHERE objatcor.t_ObjectType = 101 \n"
    + "                AND objatcor.t_GroupID = 24 \n" 
    + "                AND objatcor.t_AttrID = 2 \n" 
    + "                AND objatcor.t_Object = LPAD( one_rec.t_DealID, 34, '0' ); \n"
    + "        EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_TechDeal := 0; \n"
    + "        end; \n"
    + "        begin  \n"
    + "            Select to_number(ATTR.T_NUMINLIST), ATTR.T_NAME into realiz.t_FISSDeal, realiz.t_FISSDealName \n"
    + "              From dobjatcor_dbt AtCor, dobjattr_dbt Attr \n" 
    + "             Where AtCor.t_ObjectType = 101 \n"
    + "               And AtCor.t_GroupID    = "+OBJGROUP_TICKFIIS+" \n"
    + "               And AtCor.t_Object     = LPAD(one_rec.t_DealID, 34, '0' ) \n"
    + "               And Attr.t_AttrID      = AtCor.t_AttrID \n" 
    + "               And Attr.t_ObjectType  = AtCor.t_ObjectType \n"
    + "               And Attr.t_GroupID     = AtCor.t_GroupID; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_FISSDeal := 0; \n"
    + "                                              realiz.t_FISSDealName := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "            select rsb_struct.getdate(t_Text)  into realiz.t_DR \n"
    + "              from dnotetext_dbt \n"
    + "             where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "               and t_ObjectType = 101 \n"
    + "               and t_NoteKind = "+NOTEKIND_SECDEAL_DATEIN+"; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_DR := TO_DATE ('01.01.0001','DD.MM.YYYY'); \n"
    + "        end; \n"   
    + "        begin \n"                
    + "            Select ATTR.T_NUMINLIST into realiz.t_ControlCat \n"
    + "              From dobjatcor_dbt AtCor, dobjattr_dbt Attr \n" 
    + "             Where AtCor.t_ObjectType in(101, 117) \n"
    + "               And AtCor.t_GroupID    = "+OBJGROUP_TICKCONTROL+" \n"
    + "               And AtCor.t_Object     = LPAD(one_rec.t_DealID, 34, '0' ) \n"
    + "               And Attr.t_AttrID      = AtCor.t_AttrID  \n"
    + "               And Attr.t_ObjectType  = AtCor.t_ObjectType \n"
    + "               And Attr.t_GroupID     = AtCor.t_GroupID ; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_ControlCat := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "            Select ATTR.T_NUMINLIST into realiz.t_RC \n"
    + "                         From dobjatcor_dbt AtCor, dobjattr_dbt Attr \n" 
    + "                        Where AtCor.t_ObjectType = 101 \n"
    + "                          And AtCor.t_GroupID    = "+OBJGROUP_TICKRC+" \n"
    + "                          And AtCor.t_Object     = LPAD(one_rec.t_DealID, 34, '0' ) \n"
    + "                          And Attr.t_AttrID      = AtCor.t_AttrID  \n"
    + "                          And Attr.t_ObjectType  = AtCor.t_ObjectType \n"
    + "                          And Attr.t_GroupID     = AtCor.t_GroupID; \n"
    + "            EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_RC := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "          select rsb_struct.getString(t_Text)  into realiz.t_ControlNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType in(101, 117) \n"
    + "             and t_NoteKind = "+NOTEKIND_SECDEAL_CONTROLCOMMENT+"; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_ControlNote := chr(1); \n"
    + "        end; \n"
    + "        begin \n"
    + "          select rsb_struct.getdate(t_Text) into realiz.t_Dqual \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101  \n"
    + "             and t_NoteKind = "+NOTEKIND_SECDEAL_REQUALREPO+"; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_Dqual := TO_DATE ('01.01.0001','DD.MM.YYYY'); \n"
    + "        end; \n"
    + "        begin \n"
    + "          select rsb_struct.getMoney(t_Text) into realiz.t_AnotherComNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101 \n"
    + "             and t_NoteKind = "+NOTEKIND_SECDEAL_OHTCOMISS+"; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_AnotherComNote := 0; \n"
    + "        end; \n"
    + "        begin  \n"
    + "          select rsb_struct.getMoney(t_Text) into realiz.t_PriceDifNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101 \n"
    + "             and t_NoteKind = 27; \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_PriceDifNote := 0; \n"
    + "        end; \n"
    + "        begin \n"
    + "          select count(1) into realiz.t_IsPriceDifNote \n"
    + "            from dnotetext_dbt \n"
    + "           where t_DocumentID = LPAD( one_rec.t_DealID, 34, '0' ) \n"
    + "             and t_ObjectType = 101 \n"
    + "             and t_NoteKind = 27;  \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_IsPriceDifNote := 0; \n"
    + "        end; \n"
    + "        begin \n"
    + "          SELECT NVL(min(t_FactDate),TO_DATE ('01.01.0001','DD.MM.YYYY')) into realiz.t_DP \n"
    + "            FROM ddlrq_dbt \n"
    + "           WHERE t_DocKind  = one_rec.t_BofficeKind AND \n" 
    + "                 t_DocID    = one_rec.t_DealID AND \n" 
    + "                 t_DealPart = 1 AND \n"
    + "                 t_Type in(RSI_DLRQ.DLRQ_TYPE_AVANCE,RSI_DLRQ.DLRQ_TYPE_DEPOSIT,RSI_DLRQ.DLRQ_TYPE_PAYMENT) AND \n"
    + "                 t_FactDate != TO_DATE('01-01-0001','DD-MM-YYYY'); \n"
    + "          EXCEPTION WHEN NO_DATA_FOUND THEN realiz.t_DP := TO_DATE ('01.01.0001','DD.MM.YYYY'); \n"
    + "        end; \n"
    + "        g_realiz_ins.extend; \n"
    + "        g_realiz_ins(g_realiz_ins.LAST) := realiz; \n"
    + "      END LOOP; \n"      
    + "      IF g_realiz_ins IS NOT EMPTY THEN \n"
    + "          FORALL i IN g_realiz_ins.FIRST .. g_realiz_ins.LAST \n"
    + "               INSERT INTO DREALIZREG_TMP \n"
    + "                    VALUES g_realiz_ins(i); \n"
    + "          g_realiz_ins.delete; \n"
    + "      END IF; \n" 
    + " END; \n";

    m_ProgressIndicator.Start(1, header, header);
    m_ProgressIndicator.Update(0,1,header); // всего 3 парамера Update(index, count, text)

    SQL_Execute(query, "Подготовка данных", false);

    m_ProgressIndicator.Stop();

  END;

  //PrintRep == true - признак печати отчёта (сначала запускаем в режиме PrintRep == false - проверка для формирования массива бумаг, по которым выводим дополнительные строки)
  PRIVATE MACRO ExecuteReportByAddWhere( FI, ObjReport:OBJECT, PrintRep )

     VAR DataQuery;
     VAR strSelect;
     VAR strSelect0;
     VAR strOrder;
     VAR TaxGroupType = 0;
     VAR NRecs = 0, CurNRecs = 0, header = "";

     LoadDataInTMP(FI);

     var cmd = DL_RSDCommand("select Rsb_SCTX.TXGetBondKind(?) TaxGroupType from dual");
     cmd.AddParam(SQL_ConvTypeInteger(FI.TaxGroup));
     var ds = cmd.Execute();
     if(ds.moveNext())
       TaxGroupType = int(ds.TaxGroupType);
     end;

     strSelect0 = " SELECT /*+ORDERED */ TXLink.t_Date ";

     strSelect = " SELECT /*+ORDERED */ TXLink.t_Date, TXLink.t_Amount," +

                 "        SaleLotData.t_PARTYName as PartyNameSale, " +
                 "        BuyLotData.t_PARTYName as PartyNameBuy, " +

                 "        SaleLotData.t_ComSum as CommSale, " +
                 "        BuyLotData.t_ComSum as CommBuy, " +

                 "        SaleLotData.t_NDSComSum as NDSCommSale, " +
                 "        BuyLotData.t_NDSComSum as NDSCommBuy, " +

                 "        TXLink.t_FIID, "+GetSQLString(FI.AvrCode)+" AvrCode, "+GetSQLString(FI.AvrName)+" AvrName, CAST("+SQL_ConvTypeInteger(FI.FaceValueFI)+" AS NUMBER(10)) t_FaceValueFI, CAST("+SQL_ConvTypeInteger(FI.TaxGroup)+" AS NUMBER(10)) TaxGroup, " +
                          GetSQLDate(FI.DrawingDate)+" t_DrawingDate, " +
                 "        CAST("+SQL_ConvTypeInteger(FI.SumPrecision)+" AS NUMBER(10)) t_SumPrecision, "+GetSQLDate(FI.Issued)+" t_Issued, CAST("+SQL_ConvTypeInteger(FI.AvoirKind)+" AS NUMBER(10)) t_AvoirKind, "+
                          GetSQLDate(FI.ExpiryDate)+" t_ExpiryDate, " +
                 "        TXLotSale.t_DealID AS DealSaleID, TXLotSale.t_DEALDATE AS DealSaleDate, "+
                 "        TXLotSale.t_SALEDATE AS SaleDate, "+
                 "        TXLotSale.t_Portfolio as SalePortf, TXLotSale.t_DEALCODETS AS DealSaleCodeTS,TXLotSale.t_PriceFIID AS SalePriceFIID,LegS.t_Price AS SalePrice, LegS.t_Principal AS SaleAmount,"+
                 "        TXLotBuy.t_Portfolio as BuyPortf, TXLotBuy.t_DealID  AS DealBuyID,  TXLotBuy.t_DEALDATE AS  DealBuyDate,  TXLotBuy.t_BuyDATE AS BuyDate, TXLotBuy.t_DEALCODETS  AS DealBuyCodeTS, TXLotBuy.t_PriceFIID AS BuyPriceFIID,LegB.t_Price AS BuyPrice, LegB.t_Principal AS BuyAmount,"+
                 "        DataSale.DealSaleGroup AS DealSaleGroup, DealSale.t_Department AS DealSaleDepartment," +
                 "        DataBuy.DealBuyGroup AS DealBuyGroup, DealBuy.t_Department AS DealBuyDepartment,"+

                 "        SaleLotData.t_MarketPrice AS SaleMarketPrice, " +
                 "        SaleLotData.t_Val_Market AS SaleVal_Market, " +
                 "        SaleLotData.t_DateMarket AS SaleDateMarket, "+
                 "        SaleLotData.t_Market AS SaleMarket, "+
                 "        SaleLotData.t_QuoteValue AS SaleMarketQuoteValue, "+
                 "        BuyLotData.t_MarketPrice AS BuyMarketPrice, " +
                 "        BuyLotData.t_Val_Market AS BuyVal_Market, " +
                 "        BuyLotData.t_DateMarket AS BuyDateMarket, "+
                 "        BuyLotData.t_Market AS BuyMarket, "+
                 "        BuyLotData.t_QuoteValue AS BuyMarketQuoteValue, "+


                 "        LegS.t_NKD as NKDSale, LegS.t_Price as DealSalePrice, LegS.t_Cost as SDealCost, LegS.t_CFI as VprS, LegS.t_RelativePrice as SaleRelativePrice, "+
                 "        LegB.t_NKD as NKDBuy, LegB.t_Price as DealBuyPrice, LegB.t_Cost as BDealCost, LegB.t_CFI as VprB, LegB.t_RelativePrice as BuyRelativePrice, "+

                 TaxGroupType + " as TaxGroupType, "+

                 "        SaleLotData.t_TechDeal AS TechDealSale, " +
                 "        BuyLotData.t_TechDeal AS TechDealBuy, " +

                 "        DealSale.t_BOfficeKind AS SBOfficeKind, " +
                 "        DealBuy.t_BOfficeKind  AS BBOfficeKind, " +

                 "        SaleLotData.t_FISSDealName as RFISSS, " +
                 "        BuyLotData.t_FISSDealName as RFISSB, " +

                 "        SaleLotData.t_DR as DRS, " +
                 "        BuyLotData.t_DR as DRB, " +

                 "        SaleLotData.t_ControlCat as K_ControlS, " +
                 "        BuyLotData.t_ControlCat as K_ControlB, " +

                 "        SaleLotData.t_RC as RCS, " +
                 "        BuyLotData.t_RC as RCB, " +

                 "        SaleLotData.t_ControlNote as Control_CommentS, " +
                 "        BuyLotData.t_ControlNote as Control_CommentB, " +

                 "        SaleLotData.t_Dqual as DqualS, " +
                 "        BuyLotData.t_Dqual as DqualB, " +

                 "        SaleLotData.t_AnotherComNote as ComS_Another, " +
                 "        BuyLotData.t_AnotherComNote as ComB_Another, " +

                 "        SaleLotData.t_PriceDifNote as PriceDifNoteS, " +
                 "        BuyLotData.t_PriceDifNote as PriceDifNoteB, " +

                 "        SaleLotData.t_IsPriceDifNote as IsPriceDifNoteS, " +
                 "        BuyLotData.t_IsPriceDifNote as IsPriceDifNoteB, " +

                 "        SaleLotData.t_DP as DPS, " +
                 "        BuyLotData.t_DP as DPB, " +

                 "        CASE WHEN((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) THEN 1 ELSE 0 end as IsDUDealB, " +
                 "        CASE WHEN(DealSale.t_DealType = 32742) THEN 1 ELSE 0 end as IsDUDealS, " +

                 "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) as ImportDUDate, " +

                 "        npto.IsFavourIncome(TXLotSale.t_SALEDATE, TXLotBuy.t_BuyDATE, TXLotBuy.t_FIID) as IsFavourIncome, " +

                 "        TXLotBuy.t_RQID BuyLot_RQID,  " +
                 "        TXLotSale.t_RQID SaleLot_RQID,  " +
                 "        TXLink.t_Type  LnkType, " +
                 "        (case when av.t_Termless = 'X' then 1 else 0 end) Termless, " +

                 IIF ( ((m_ReportKind == REALIZREG_0212) or (m_ReportKind == REALIZREG_0215)),
                        " (select nvl(max(ret.t_DealDate), to_date('01.01.0001', 'dd.mm.yyyy')) " +
                          "  from ddl_tick_dbt ret " +
                          " where ret.t_PFI = av.t_FIID " +
                          "   and ret.t_Bofficekind = " + DL_RETIREMENT +
                          "   and ret.t_DealStatus > 0 " +
                          "   and RSB_SECUR.IsRet_Issue(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(ret.t_DealType, ret.t_BofficeKind)))=1 " +
                        " ) as t_IssDrawingDate, ", 
                        ""
                     ) +
                 "        NVL((SELECT GO.t_SaleDate " +
                 "               FROM DSCTXGO_DBT GO, DSCTXGOFI_DBT GOFI " +
                 "              WHERE (av.t_FIID = GO.t_FIID OR av.t_FIID = GOFI.t_NewFIID) " +
                 "                AND GO.t_DocKind IN ("+DL_ISSUE_UNION+", "+DL_CHGAVRNOM+")" +
                 "                AND GO.t_Kind IN ("+TXLOTORIGIN_GLOBCONVERT+", "+TXLOTORIGIN_MODIFFACEVALUE+")" +
                 "                AND GOFI.t_GOID = GO.t_ID " +
                 "                AND ROWNUM < 2), TO_DATE('01.01.0001', 'DD.MM.YYYY') "
                 "        ) DGO, "
                 "        CASE WHEN RSB_SECUR.GetMainObjAttr(12, LPAD (av.t_FIID, 10, '0'), 131, TRIM(SYSDATE)) = 2 THEN chr(88) ELSE chr(0) end as IsCashMode, "
                 "        NVL((SELECT t_sum FROM ddlsum_dbt where t_dockind = 127 AND t_kind = 1100 AND t_docid = DealBuy.t_DealId),0) as SpendDU";

     DataQuery = "   FROM DREALIZREG_TMP BuyLotData, " +
                 "        DSCTXLOT_DBT  TXLotBuy," +
                 "        DDL_TICK_DBT  DealBuy," +
                 "        ( Select BuyOper.t_Kind_Operation, BuyOper.t_DocKind, " +
                 "                 rsb_secur.get_OperationGroup(BuyOper.t_SysTypes) as DealBuyGroup, " +
                 "                 (CASE WHEN " +
                 "                            ((Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(BuyOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsAvrWrtOut(rsb_secur.get_OperationGroup(BuyOper.t_SysTypes))=1) " +
                 "                            ) " +
                 "                       THEN 2 " +
                 "                       ELSE 0 END " +
                 "                 ) as LegKindBuy " +
                 "            From " +
                 "                 doprkoper_dbt BuyOper " +
                 "           where BuyOper.t_dockind in(101,117,127,155) "+
                 "        ) DataBuy, " +

                 "        ddl_leg_dbt   LegB, " +
                 "        DSCTXLNK_DBT  TXLink,"+
                 "        DSCTXLOT_DBT  TXLotSale," +
                 "        DDL_TICK_DBT  DealSale," +
                 "        ( Select SaleOper.t_Kind_Operation, SaleOper.t_DocKind, " +
                 "                 rsb_secur.get_OperationGroup(SaleOper.t_SysTypes) as DealSaleGroup, " +
                 "                 (CASE WHEN " +
                 "                            ((Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsAvrWrtIn(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                            ) " +
                 "                       THEN 2 " +
                 "                       ELSE 0 END " +
                 "                 ) as LegKindSale " +
                 "            From " +
                 "                 doprkoper_dbt SaleOper " +
                 "           where SaleOper.t_dockind in(101,117,127,155) "+
                 "        ) DataSale, " +

                 "        ddl_leg_dbt   LegS, " +
                 "        DREALIZREG_TMP SaleLotData, " +
                 "        davoiriss_dbt av " +
                 "  WHERE TXLink.t_FIID = "+SQL_ConvTypeInteger(FI.FIID)+ " AND " +
                 "        ( ( TXLink.t_Date BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate(m_H08) + " AND " +
                 "            ( TXLink.T_BEGDATE IS NULL  OR " +
                 "              TXLink.T_BEGDATE = " + GetSQLDate( DATE(0,0,0) ) +
                 "            ) " +
                 "          ) OR " +
                 "          ( TXLink.T_BEGDATE BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate( m_H08 ) +
                 "          ) " +
                 "        ) AND " +
                 "        ( TXLink.t_Type = " + TXLNK_DELIVER +
                 "          OR (" +
                 "                TXLink.t_Type in (" + TXLNK_CLSREPO + ", " + TXLNK_CLSLOAN + ")" +
                 "                AND (" +
                 "                       TXLink.t_EndDate IS NULL" +
                 "                       OR TXLink.t_EndDate = " + GetSQLDate( DATE(0,0,0) ) +
                 "                       OR TXLink.t_EndDate > " + GetSQLDate(m_H08) +
                 "                    )" +
                 "                AND TXLotBuy.t_VirtualType = 1 " +
                 "                AND TXLotBuy.t_BuyDate < TXLotSale.t_SaleDate " +
                 "             )" +
                 "        ) AND " +
                 "        TXLotSale.t_ID = TXLink.t_SaleID AND " +
                 "        TXLotBuy.t_ID  = TXLink.t_BuyID AND " +
                 "        SaleLotData.t_LotID = TXLotSale.t_ID AND " +
                 "        BuyLotData.t_LotID = TXLotBuy.t_ID " +
                          GetAddWhereForDealTmp() +
                 "        AND DealSale.t_DealID = CASE TXLotSale.t_VirtualType WHEN 1 THEN TXLotSale.t_DealID ELSE (select t_DealID from dsctxlot_dbt  where t_ID = TXLotSale.t_RealID) END AND" + //рекомендация Рыжикова
                 "        TXLotBuy.t_DealID  = DealBuy.t_DealID AND " +
                 "        DataSale.t_Kind_Operation = DealSale.t_DealType AND " +
                 "        DataBuy.t_Kind_Operation  = DealBuy.t_DealType AND " +
                 "        LegS.t_DealID             = TXLotSale.t_DealID AND " +
                 "        LegS.t_LegKind            = DataSale.LegKindSale AND " +
                 "        LegS.t_LegID              = 0 AND " +
                 "        LegB.t_DealID             = TXLotBuy.t_DealID AND " +
                 "        LegB.t_LegKind            = DataBuy.LegKindBuy AND " +
                 "        LegB.t_LegID              = 0 AND "
                 "        av.t_FIID                 = " + SQL_ConvTypeInteger(FI.FIID);

     strOrder = "  order by SaleDate, DealSaleDate, TXLotSale.t_DEALTIME, DealSaleCodeTS, BuyDate, DealBuyDate, TXLotBuy.t_DEALTIME, DealBuyCodeTS"; 

     header = "Подсчёт количества записей для "+GetSQLString(FI.AvrCode)+" ( "+m_FI_CurNRec+" из "+m_FI_NRecs+") для регистра "+m_SHEET_1+" ( "+GetSubKindReg()+" )";
     m_ProgressIndicator.Start(1, header, header);
     m_ProgressIndicator.Update(0,1,header); // всего 3 парамера Update(index, count, text)
     NRecs = SQL_GetNRecs( strSelect0 + DataQuery );
     m_ProgressIndicator.Stop();

     if (NRecs > 0)
        if( (not PrintRep) and ((m_ReportKind == REALIZREG_0212) or (m_ReportKind == REALIZREG_0215)) )
           header = "Проверка необходимости формирования строк по дополнительному процентному доходу по "+GetSQLString(FI.AvrCode)+" ( "+m_FI_CurNRec+" из "+m_FI_NRecs+") для регистра "+m_SHEET_1+" ( "+GetSubKindReg()+" )";
           m_ProgressIndicator.Start(1, header, header);
           m_ProgressIndicator.Update(0,1,header); // всего 3 парамера Update(index, count, text)
           ПечатьДополнительныхСтрок(ObjReport, FI.FIID, FI.AvrCode, FI.AvrName, FI.TaxGroup, int(FI.FaceValueFI), PrintRep);/*печатьдополнительных по выпуску получается после основных - пока сделано так по согласованию*/
           m_ProgressIndicator.Stop();
        else
           SaveFIIDForForm_cons(SQL_ConvTypeInteger(FI.FIID));
           CurNRecs = 0;
           header = "Формирование отчёта по "+GetSQLString(FI.AvrCode)+" ( "+m_FI_CurNRec+" из "+m_FI_NRecs+") для регистра "+m_SHEET_1+" ( "+GetSubKindReg()+" )";
           m_ProgressIndicator.Start(NRecs, header, header);
           m_RS = TRsbDataSet( strSelect + DataQuery + strOrder );
           while( m_RS.MoveNext() )
              if((m_RS.Termless != 1) or (m_RS.DrawingDate != date(0, 0, 0)))
              ClearCacheOneRecord();
              // найдём льготные/нельготные периоды
              if( (m_RS.TaxGroup == 17) and (m_ReportKind == REALIZREG_0212) )
                 m_TaxPeriods.Clear();
                 m_TaxPeriods.Init(m_RS.FIID, max(H0_7()-1, DDB()), this.DDS());
              end;
              m_IsDataExist = true;
              ObjReport.Print();
              CurNRecs = CurNRecs + 1;
              m_ProgressIndicator.Update(CurNRecs,NRecs,header); // всего 3 парамера Update(index, count, text)
              else
                 MsgBox("По облигации с признаком \"бессрочная\" " + FI.ISIN + IIF((FI.ISIN != "") and (FI.AvrName != ""), ", ", "") + FI.AvrName + " нельзя определить дату погашения/оферты");
              end;
           end;
           m_ProgressIndicator.Stop();
        end;

     end;

  END;

  PRIVATE MACRO ExecuteReportByFI( ObjReport:OBJECT, PrintRep )

     VAR DataQuery;
     VAR strSelect;
     VAR strSelect0;
     VAR strSelFin, strOrder;
     VAR cmd, FI;

     strSelFin =   "         SELECT distinct FI.t_FI_Code AS AvrCode, "
                 + "                FI.t_Name AS AvrName,  "
                 + "                RSI_RSB_FIInstr.FI_GetNominalDrawingDate(FI.t_FIID, av.t_Termless, "+GetSQLDate(m_H08)+") AS t_DrawingDate, "
                 + "                FI.t_ExpiryDate, "
                 + "                FI.t_FIID, "
                 + "                (CASE  WHEN (t_AvoirKind = "+AVOIRISSKIND_INVESTMENT_SHARE+") "
                 + "                  THEN  inv.t_FormValueFIID "
                 + "                 ELSE  FI.t_FaceValueFI END) AS t_FaceValueFi, "
                 + "                FI.t_AvoirKind, "
                 + "                FI.t_SumPrecision, "
                 + "                FI.t_Issued, "
                 + "                av.t_TaxGroup TaxGroup, "
                 + "                av.t_ISIN, "
                 + "                FI.t_IsAdditional "
                 + "          FROM dfininstr_dbt FI "
                 + "          LEFT OUTER JOIN davrinvst_dbt inv ON inv.t_FIID = FI.t_FIID "
                 + "          INNER JOIN DAVOIRISS_DBT av ON av.t_FIID = FI.t_FIID "
                 + "         WHERE " + ObjReport.Where() + GetAddWhereForAvr();

     if( (not PrintRep) and ((m_ReportKind == REALIZREG_0212) or (m_ReportKind == REALIZREG_0215)) )
        strSelFin = strSelFin + GetAddWhereExistsWarnKind();/*условие для строк о дополнительном процентном доходе (расходе)*/
     end;

     DataQuery = "  and exists( select TXLink.t_FIId from DSCTXLNK_DBT  TXLink, DSCTXLOT_DBT TXLotB, DSCTXLOT_DBT TXLotS " +
                 "               where TXLotB.t_ID = TXLink.t_BuyID AND " +
                 "                     TXLotS.t_ID = TXLink.t_SaleID AND " +
                 "                     TXLink.t_FIId = FI.t_FIID AND " +
                 "                     ( ( TXLink.t_Date BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate(m_H08) + " AND " +
                 "                        ( TXLink.T_BEGDATE IS NULL  OR " +
                 "                          TXLink.T_BEGDATE = " + GetSQLDate( DATE(0,0,0) ) +
                 "                        ) " +
                 "                       ) OR " +
                 "                       ( TXLink.T_BEGDATE BETWEEN " + GetSQLDate( m_H07 ) + " AND " + GetSQLDate( m_H08 ) +
                 "                       ) " +
                 "                     ) " +
                 "                     AND " +
                 "                     (" +
                 "                        TXLink.t_Type = " + TXLNK_DELIVER +
                 "                        OR" +
                 "                        (" +
                 "                           TXLink.t_Type in (" + TXLNK_CLSREPO + ", " + TXLNK_CLSLOAN + ") AND" +
                 "                           (" +
                 "                              TXLink.t_EndDate = " + GetSQLDate( DATE(0,0,0) ) + " OR " +
                 "                              TXLink.t_EndDate IS NULL OR" +
                 "                              TXLink.t_EndDate > " + GetSQLDate( m_H08 ) +
                 "                           ) AND " +
                 "                           TXLotB.t_VirtualType = " + TXVDEAL_REAL + " AND " +
                 "                           TXLotB.t_BuyDate < TXLotS.t_SaleDate" +
                 "                        )" +
                 "                     )" +
                 "            )" +
                 "  order by TaxGroup, AvrCode";

     cmd = DL_RSDCommand( strSelFin + DataQuery );

     m_FI_NRecs = cmd.GetCount();
     if (m_FI_NRecs > 0)
        m_FI_CurNRec = 1;
        FI = cmd.execute();
        while( FI.MoveNext() )
           ExecuteReportByAddWhere(FI, ObjReport, PrintRep);
           m_FI_CurNRec = m_FI_CurNRec + 1;
        end;
     end;

  END;

  //PrintRep == true - признак печати отчёта (сначала запускаем в режиме PrintRep == false - проверка для формирования массива бумаг, по которым выводим дополнительные строки)
  PRIVATE MACRO ExecuteReport212_215( ObjReport:OBJECT, PrintRep )
     VAR QueryRest, DataQuery, DataFIID, i = 0;
     var PrevFIID = -1;

     if (not SecondStart)
        ExecuteReportByFI( ObjReport, PrintRep );
     end;

     if( PrintRep and m_RunByNoQuoted )
        i = 0;
        PrevFIID = -1;
        while (i < ArrFIIDAdd.size)
           if ((ArrFIIDAdd[i] != PrevFIID) and (ArrFIIDAdd[i] > 0)) // может оказаться -1 если доп. строки по этой бумаге уже напечатаны!
              DataQuery = " SELECT fininstr.t_FIID, fininstr.t_FI_Code, fininstr.t_Name, av.t_TaxGroup, fininstr.t_FaceValueFI "+
                          "   FROM dfininstr_dbt fininstr, " +
                          "        davoiriss_dbt av " +
                          "  WHERE av.t_FIID = fininstr.t_FIID and fininstr.t_FIID = " + string(ArrFIIDAdd[i]);

              DataFIID = TRsbDataSet( DataQuery );
              while( DataFIID.MoveNext() )
                 if( ((m_ReportKind == REALIZREG_0212) and (DataFIID.FaceValueFI == NATCUR)) or
                     ((m_ReportKind == REALIZREG_0215) and (DataFIID.FaceValueFI != NATCUR))
                   )
                    PrevFIID = DataFIID.FIID;

                    ПечатьДополнительныхСтрок(ObjReport, DataFIID.FIID, DataFIID.FI_Code, DataFIID.Name, DataFIID.TaxGroup, DataFIID.FaceValueFI, PrintRep);/*печатьдополнительных по выпуску получается после основных - пока сделано так по согласованию*/
                 end;
              end;
           end;
           i = i + 1;
        end;
     end;
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )

     ExecuteReport();

     SQL_Truncate( "dspprtcst_tmp" );

     ObjReport.BeginReport();

     if((m_RunByQuoted == true) or (m_RunByNoQuoted == true) or (m_RunByTech == true) or (m_RunByFISS == true))

       if( (m_ReportKind == REALIZREG_0211) or (m_ReportKind == REALIZREG_0213) or (m_ReportKind == REALIZREG_0216) )
          if (not SecondStart)
             ExecuteReportByFI( ObjReport, true );
          end;
       else
          if (not SecondStart) // предварительный запуск для 212 и 215 - только проверка.
             ExecuteReport212_215( ObjReport, false );
          end;
          ExecuteReport212_215( ObjReport, true ); // печать для 212 и 215
       end;

     end;
     ObjReport.EndReport();

     ReplaceFormulaAndCalculate();
  END;

  macro HeaderEndLine()
    if( (m_ReportKind == REALIZREG_0211) or (m_ReportKind == REALIZREG_0213) or (m_ReportKind == REALIZREG_0215) or (m_ReportKind == REALIZREG_0216) )
        return НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_biq12386;
    end;
    return НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
  end;

  macro SumBeginLine()
    if( (m_ReportKind == REALIZREG_0211) or (m_ReportKind == REALIZREG_0213) or (m_ReportKind == REALIZREG_0215) or (m_ReportKind == REALIZREG_0216) )
        return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_biq12386;
    end;
    return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
  end;

    /*можно использовать не один критерий отбора строк, а два (реально используется только в 212)
    Если критерий один - используется ф-ла СУММЕСЛИ, если больше одного - СУММПРОИЗВ (было бы проще использовать СУММЕСЛИМН, но мы пока работаем в режиме совместимости до 2007, а СУММЕСЛИМН появилась после 2007)
    Для вторго критерия задаем ColName_2 - имя столбца, WhereCond_2 - условие*/
  macro ТекстФормулыПоВсемСделкамДляВыпуска(CellName:string, ColName_2:string, WhereCond_2:string)
     VAR i = 0, j = 0, NumSheet1 = 0, NumSheet2 = 0, FormulaStr = "", BeginRow_1 = 0, BeginRow_2 = 0, SummBeginRow_1 = 0, SummBeginRow_2 = 0;
     VAR ЗаданВторойКритерий = false;

     if( (ColName_2 != null) and (WhereCond_2 != null) and (ColName_2 != "") and (WhereCond_2 != "") )
        ЗаданВторойКритерий = true;
     end;

     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) )
           NumSheet1 = i;
           break;
        end;
        i = i + 1;
     end;

     i = 0;
     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_2) )
           NumSheet2 = i;
           break;
        end;
        i = i + 1;
     end;

     i = NumSheet1;
     while( i < NumSheet2 )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) ) /*для первой вкладки*/
           BeginRow_1 = HeaderEndLine(); // НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_1 = SumBeginLine(); // НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_1 = 1;
           SummBeginRow_1 = 2;
        end;

        if( StrUpr(m_UsedSheet[m_UsedSheet.size-1]) == StrUpr(m_SHEET_2) )/*для первой(начиная с m_SHEET_2) вкладки*/
           BeginRow_2 = НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_2 = НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_2 = 1;
           SummBeginRow_2 = 2;
        end;

        if( FormulaStr != "" )
           FormulaStr = FormulaStr + "+";
        end;

        if( ЗаданВторойКритерий )
           FormulaStr = FormulaStr + FormulaSUMPRODUCT()+"(('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+"=$"+C_SecCode_2+"$"+(m_ReportTable.bRowTable + getCurrentRow())+")*('"+m_UsedSheet[i]+"'!$"+ColName_2+"$"+SummBeginRow_1+":$"+ColName_2+"$"+string(BeginRow_1+MAXROWSHEET)+WhereCond_2+");'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        else
           FormulaStr = FormulaStr + FormulaSUMIF()+"('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+";\"=\"&$"+C_SecCode_2+"$"+SummBeginRow_2+":$"+C_SecCode_2+"$"+string(BeginRow_2+MAXROWSHEET)+";'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        end;

        i = i + 1;
     end;

     return "formula=" + FormulaStr;
  end;

  macro ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(CellName_1:string, ColName_1:string, WhereCond_1:string, CellName_2:string, ColName_2:string, WhereCond_2:string)
     VAR FormulaStr1 = ТекстФормулыПоВсемСделкамДляВыпуска(CellName_1, ColName_1, WhereCond_1);
     VAR FormulaStr2 = "";
     VAR i = 0, j = 0, NumSheet1 = 0, NumSheet2 = 0, FormulaStr = "", BeginRow_1 = 0, BeginRow_2 = 0, SummBeginRow_1 = 0, SummBeginRow_2 = 0;
     VAR ЗаданВторойКритерий = false;

     if( (ColName_2 != null) and (WhereCond_2 != null) and (ColName_2 != "") and (WhereCond_2 != "") )
        ЗаданВторойКритерий = true;
     end;

     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) )
           NumSheet1 = i;
           break;
        end;
        i = i + 1;
     end;

     i = 0;
     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_2) )
           NumSheet2 = i;
           break;
        end;
        i = i + 1;
     end;

     i = NumSheet1;
     while( i < NumSheet2 )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) ) /*для первой вкладки*/
           BeginRow_1 = HeaderEndLine(); // НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_1 = SumBeginLine(); // НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_1 = 1;
           SummBeginRow_1 = 2;
        end;

        if( StrUpr(m_UsedSheet[m_UsedSheet.size-1]) == StrUpr(m_SHEET_2) )/*для первой(начиная с m_SHEET_2) вкладки*/
           BeginRow_2 = НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_2 = НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_2 = 1;
           SummBeginRow_2 = 2;
        end;

        if( FormulaStr2 != "" )
           FormulaStr2 = FormulaStr2 + "+";
        end;

        if( ЗаданВторойКритерий )
           FormulaStr2 = FormulaStr2 + FormulaSUMPRODUCT()+"(('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+"=$"+C_SecCode_2+"$"+(m_ReportTable.bRowTable + getCurrentRow())+")*('"+m_UsedSheet[i]+"'!$"+ColName_2+"$"+SummBeginRow_1+":$"+ColName_2+"$"+string(BeginRow_1+MAXROWSHEET)+WhereCond_2+");'"+m_UsedSheet[i]+"'!$"+CellName_2+"$"+SummBeginRow_1+":$"+CellName_2+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        else
           FormulaStr2 = FormulaStr2 + FormulaSUMIF()+"('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+";\"=\"&$"+C_SecCode_2+"$"+SummBeginRow_2+":$"+C_SecCode_2+"$"+string(BeginRow_2+MAXROWSHEET)+";'"+m_UsedSheet[i]+"'!$"+CellName_2+"$"+SummBeginRow_1+":$"+CellName_2+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        end;

        i = i + 1;
     end;

     return FormulaStr1 + "+" + FormulaStr2;
  end;

  macro ФормулаПоВсемСделкамДляВыпуска(CellName:string)
     return ТекстФормулыПоВсемСделкамДляВыпуска(CellName);
  end;

  macro PrintForm_Cons(ObjReport:OBJECT)
     var exec, DataSet;
     exec = RSDCommand(" select fin.t_FI_Code, fin.t_Name, av.t_TaxGroup, "+
                       "        (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) AS t_ISIN "+
                       "   from dspprtcst_tmp t, dfininstr_dbt fin, DAVOIRISS_DBT av "+
                       "  where fin.t_FIID = t.t_FIID "+
                       "    AND fin.t_FIID = av.t_FIID "+
                       "  group by fin.t_FI_Code, fin.t_Name, av.t_TaxGroup, "+
                       "           (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) "+
                       "  order by av.t_TaxGroup, fin.t_FI_Code");
     exec.execute();
     DataSet = TRsbDataSet(exec);

     while(DataSet.MoveNext())
        m_IsDataExist = true;
        ObjReport.Print(DataSet.TaxGroup, DataSet.FI_Code, DataSet.Name, DataSet.ISIN);
     end;
  end;

  PRIVATE MACRO PrintConsolidated( ObjReport:OBJECT )
     ObjReport.BeginReport();
     this.PrintForm_Cons(ObjReport);
     ReplaceFormulaAndCalculate();
     ObjReport.EndReport();
  END;

  PRIVATE MACRO CreateReportByKind( Kind:INTEGER )
    m_ReportKind = Kind;

    Fill_Cell_Name();

    if( Kind == REALIZREG_0211 )
       m_SHEET_1 = SHEET_0211;
       m_SHEET_2 = SHEET_0211s;
       ExecuteReport( CRealizReg_211(this) );
       PrintConsolidated( CRealizReg_211_Cons(this) );
    elif( Kind == REALIZREG_0212 )
       m_SHEET_1 = SHEET_0212;
       m_SHEET_2 = SHEET_0212s;
       ExecuteReport( CRealizReg_212(this) );
       PrintConsolidated( CRealizReg_212_Cons(this) );
    elif( Kind == REALIZREG_0213 )
       m_SHEET_1 = SHEET_0213;
       m_SHEET_2 = "";/*Сводного нет*/
       ExecuteReport( CRealizReg_213(this) );
    elif( Kind == REALIZREG_0215 )
       m_SHEET_1 = SHEET_0215;
       m_SHEET_2 = SHEET_0215s;
       ExecuteReport( CRealizReg_215(this) );
       PrintConsolidated( CRealizReg_215_Cons(this) );
    elif( Kind == REALIZREG_0216 )
       m_SHEET_1 = SHEET_0216;
       m_SHEET_2 = "";/*Сводного нет*/
       ExecuteReport( CRealizReg_216(this) );
    end;

  END;

  PRIVATE MACRO CreateReportByAll()
    CreateReportByKind( REALIZREG_0211 );
    CreateReportByKind( REALIZREG_0212 );
    CreateReportByKind( REALIZREG_0213 );
    CreateReportByKind( REALIZREG_0215 );
    CreateReportByKind( REALIZREG_0216 );
  END;

  PRIVATE MACRO Create()
     var SubKindList = null;
     var SubKindCount : Integer = 0;

     if( not m_IsWebService )
        SubKindList = TArray();
        SubKindList[SubKindList.Size] = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_SUBKIND_2014 );
     else
        SubKindList = RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_SUBKIND_2014 );
     end;

     if( ( ValType( SubKindList ) != V_UNDEF )
     and ( SubKindList.Size > 0 )
     and ( ValType( SubKindList[SubKindCount] ) == V_INTEGER )
     and ( SubKindList[SubKindCount] != REALIZREG_ALL ) )
        while( SubKindCount < SubKindList.Size )
           CreateReportByKind( SubKindList[SubKindCount] );
           SubKindCount = SubKindCount + 1;
        end;
     else
        CreateReportByAll();
     end;
  END;

   /*По замечаниям ГПБ убрано наименование листа из формулы итогов*/
   MACRO GetFormulaSumm()
      if((m_CopyAutoSumRange == null) or (m_CopyAutoSumRange == ""))
         GetFormulaSummREG();
      else
         GetFormulaSummREG_rshb();
      end;
   END;

  initTX_RegistrReport( Form, TemplateName, true, false, null, true, true /*UseBigReportMode*/, ForceFormatRep );
  SetRowFlushCount(2000);
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var NumCopy = 0;
  var FullReportFileNames = TArray();
  var FullReportFileNames_Add = TArray();
  WebMenuItem = menuItem;

    if( not IsWebService )
      RealizReg_Form = SP_RealizReg_Panel();
    else
      if( ValType(FormData) != V_UNDEF )
        RealizReg_Form = WS_TX_RealizReg_Panel( FormData );
      else
        stat = false;
      end;
    end;

  while( stat )
    if( not IsWebService )
      stat = RealizReg_Form.Run();
    end;

    NumCopy = 0;
    ArrFIIDAdd.size = 0;
    SecondStart = false;

    if( stat )
      if( RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_BYQUOTED_2014 ) == SET_CHAR )
        NumCopy = NumCopy + 1;
      end;

      if( RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_BYNOQUOTED_2014 ) == SET_CHAR )
        NumCopy = NumCopy + 1;
      end;

      if( RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_FISS_2014 ) == SET_CHAR )
        NumCopy = NumCopy + 1;
      end;

      if( RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_BYTECH_2014 ) == SET_CHAR )
        NumCopy = NumCopy + 1;
      end;

      RealizReg_Report = SP_RealizReg_Report_2014( null, "Report_TxRealizReg_2014.xlsx", false, IsWebService, ReportHashCode, true, false);
      RealizReg_Report.Run( NumCopy );

      if( ( not RealizReg_Form.GetFieldValue( PNFLD_REALIZREG_BYNOQUOTED_2014 ) ) and (ArrFIIDAdd.size > 0) )
        SecondStart = true;
        var RealizReg_Report_Add = SP_RealizReg_Report_2014( null, "Report_TxRealizReg_2014.xlsx", false, IsWebService, ReportHashCode, true, false );
        RealizReg_Report_Add.Run();
        FullReportFileNames_Add = RealizReg_Report_Add.GetFullReportFileNames();
      end;

      if( IsWebService )
        Dl_CallInsertStat( RealizReg_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
           FullReportFileNames = RealizReg_Report.GetFullReportFileNames();
        var i = 0;
        if( FullReportFileNames_Add.Size() > 0 )
           while( i < FullReportFileNames_Add.Size() )
              FullReportFileNames[FullReportFileNames.Size()] = FullReportFileNames_Add[i];
              i = i + 1;
           end;
        end;
        stat = false;
      else
        Dl_CallInsertStat( RealizReg_Report.PrintMode() );
      end;

      RealizReg_Report = NULL;
    end;
  end;

  return FullReportFileNames;
END;
