/*
$Name:         scotcown030.mac
$Module:       Ценные бумаги
$Description:  Операция внебиржевой продажи/покупки ВО. Шаг "Оплата комисии"
*/

IMPORT InsCarryDoc, "sp_class.mac";

macro ExecuteStep( doc, FDoc)
  record tick (dl_tick);
  var FD, dat;
  var err = 0;
  var query, cmd, DataSet;
  var rRqAcc = TRecHandler("dlrqacc.dbt");
  var rSA    = TRecHandler("settacc.dbt");
  var dlcomis= TRecHandler("dlcomis.dbt");
  var SfContrID = 0;


  SetBuff(tick, FDoc ); 

  FD = SPFirstDoc(tick, false, true );

  if( FD.БылОтказОтИсполнения() != false ) /*был отказ от сделки*/
     return 0;
  end;

  GetOprDate( DATE_DEALPAY, dat );

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if((FD.tick.rec.Flag3 == SET_CHAR) and (FD.tick.rec.SumPay > 0))
    query =   " select sfcontr.t_ID "
            + "   from dsfcontr_dbt sfcontr "
            + "  where sfcontr.t_ObjectType = " + SF_SECUROWN
            + "    and sfcontr.t_Object = ? "
            + "    and sfcontr.t_ServKind = " + PTSK_STOCKDL
            + "    and sfcontr.t_PartyID = ? "
            + "    and sfcontr.t_ContractorID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(FD.tick.rec.DealCode);
    cmd.AddParam(FD.tick.rec.PartyID);
    cmd.AddParam({OurBank});

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      SfContrID = DataSet.ID;
    end; 

    if(SfContrID == 0)
      msgbox("Не найден договор обслуживания с контрагентом");
      err = 1;
    else
      query =   " select concom.t_CommNumber, cm.t_FIID_COMM, cm.t_PayNDS, cm.t_ReceiverID "
              + "   from dsfconcom_dbt concom, dsfcomiss_dbt cm "
              + "  where concom.t_ObjectType = " + OBJTYPE_SFCONTR
              + "    and concom.t_ObjectID = ? " 
              + "    and concom.t_FeeType = " + SF_FEE_TYPE_SINGLE
              + "    and (concom.t_DateBegin = "+GetSQLDate(date(0,0,0))+" or concom.t_DateBegin <= ?) "
              + "    and cm.t_FeeType = concom.t_FeeType "
              + "    and cm.t_Number = concom.t_CommNumber "
              + "    and cm.t_Code = ? ";

      cmd = DL_RSdCommand(query);

      cmd.AddParam(SfContrID);
      cmd.AddParam(dat);
      cmd.AddParam(ПолучитьКодКомиссииЭмитентаВО());

      DataSet = cmd.Execute();
      
      if(not DataSet.MoveNext())
        msgbox("Не найдена комисиия эмитента у договора обслуживания");
        err = 1;
      else
      /*  rRqAcc.Clear();
        if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, DataSet.ReceiverID, DLRQ_SUBKIND_CURRENCY, DataSet.t_FIID_COMM, DLRQ_TYPE_COMISS, rRqAcc) != 0) //нет подходящих платежных реквизитов
          rSA.Clear();
          if(SP_GetPartySETTACC(DataSet.ReceiverID, 0, DataSet.FIID_COMM, FIKIND_CURRENCY, 0, rSA) == 0)
            //создать новые платежные реквизиты
            rRqAcc.rec.ID               = 0;     
            rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;     
            rRqAcc.rec.DocID            = FD.tick.rec.DealID;     
            rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
            rRqAcc.rec.Type             = DLRQ_TYPE_COMISS;     
            rRqAcc.rec.Party            = DataSet.ReceiverID;     
            rRqAcc.rec.FIID             = rSA.rec.FIID;                 
            rRqAcc.rec.BankID           = rSA.rec.BankID;               
            rRqAcc.rec.Chapter          = rSA.rec.Chapter;              
            rRqAcc.rec.Account          = rSA.rec.Account;         
            rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;         
            rRqAcc.rec.BankCode         = rSA.rec.BankCode;        
            rRqAcc.rec.BankName         = rSA.rec.BankName;        
            rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;           
            rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;     
            rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;    
            rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;    
            rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;         

            if( DL_InsertDLRQACC(rRqAcc) )
              msgbox("Ошибка вставки платежных реквизитов для комиссии с номером \""+DataSet.CommNumber+"\" по сделке с ID = "+string(FD.tick.rec.DealID)+": "+GetErrMsg());
              err = 1;
            end;
          else
            msgbox("Не найдена СПИ по деньгам для субъекта с ID = "+DataSet.ReceiverID);
            err = 1;
          end;
        end;*/

        if(not err)
          dlcomis.Clear();
          dlcomis.rec.DOCKIND     = FD.tick.rec.BofficeKind;
          dlcomis.rec.DOCID       = FD.tick.rec.DealID;
          dlcomis.rec.CONTRACT    = SfContrID;
          dlcomis.rec.FEETYPE     = SF_FEE_TYPE_SINGLE;
          dlcomis.rec.COMNUMBER   = DataSet.CommNumber;
          dlcomis.rec.SUM         = FD.tick.rec.SumPay; 
          dlcomis.rec.NDS         = 0;
          dlcomis.rec.DATE        =
          dlcomis.rec.PLANPAYDATE = 
          dlcomis.rec.FACTPAYDATE = dat;
          dlcomis.rec.INPUTMEDIUM = GetInputMedium(INPUTMEDIUM_CALC);

          dlcomis.rec.IMMATERIAL  = UNSET_CHAR;
                      
          if( not OprInsertDLCOMIS( dlcomis ) )
            msgbox(GetErrMsg());
            err = 1;
          end;
        end;
      end;
    end;

    if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYCOM, DLGR_ACCKIND_INNER, date(0,0,0), DLGRACC_STATE_NOTNEED) != 0 )
      return 1;
    end;
  end;

  return err;

END;