/*
$Name: ws_monitorexecution.mac
$Module: АРНУ 
$Description: WEB_АРНУ_Функции выполнения события  
*/
import "sp_imp.mac";
import SPInter, "secinter.mac", "sp_ptick.mac", "ws_QIValidPeriod.mac";
import ws_file;
import "dpcorpop.mac", "ws_partycommon.mac", "dlntfd.mac", "spcomcalc.mac";

private record RetireDst("dl_tick.dbt");
private record RetireLnk("dl_tklnk.dbt");
private record Retire("dl_tick.dbt");
private record Leg("dl_leg.dbt");
private record Fin("fininstr.dbt");

const Issue  = 2021;
const Coupon = 2022;
const Partly = 2027;

macro exec_fun1() : bool
  if(Int(Mod(Random(10),2)) == 0)
    return true;
  else
    return false;
  end
end;

macro exec_fun2() : bool
  if(Int(Mod(Random(10),3)) == 0)
    return true;
  else
    return false;
  end
end;

macro exec_fun3() : bool
  if(Int(Mod(Random(10),4)) == 0)
    return false;
  else
    return true;
  end
end;

// Выбор макрофайла
macro ScSelectMacFile(param)
  var full_name = "", file_name, file_ext;

  if(SelectFile(full_name,"*.mac",null,0,false))
    SplitFile(full_name, file_name, file_ext);
    full_name="..\\txtfile\\" + param + ".tmp";
    SetOutPut(full_name);
    println(StrLwr(String(file_name, file_ext)));
    SetOutput(null,true);
    MsgBox(String("Выбран файл: ", file_name, file_ext));
  end;
end;


// Ищет файл по имени param и возвращает имя макроса прочитанное в этом файле
macro ScGetMacFileName(param)
  var path_file, file_str = "";

  if((param != null) and (param != ""))
    path_file = FindPath(param+".tmp","..\\txtfile");
    if(path_file != "")
      var ob = TStreamDoc (path_file, "r");
      ob.readLine(@file_str);
      ob = null; //закрывает файл, иначе не удаляется
      RemoveFile(path_file);
    end;
  end;
  return file_str; 
end;

//Погашение купонов/чп/выпусков
macro exec_retires(MonitorDate, DealType) : bool
  var tick = TRecHandler("dl_tick.dbt");
  var leg  = TRecHandler("dl_leg.dbt");
  var query, q, str_where, ds, dss, stat = 0, count = 0, i = 0;

  if((DealType == Coupon) or (DealType == Partly))
    if(DealType == Coupon )
      str_where = "  AND WR.T_ISPARTIAL <> CHR(88)";
    elif(DealType == Partly)
      str_where = "  AND WR.T_ISPARTIAL = CHR(88)";
    end;
    query = RSDCommand("SELECT COUNT(FI.T_FIID) AS CNT " + 
                       "FROM DFININSTR_DBT FI " + 
                       "     INNER JOIN DFIWARNTS_DBT WR ON FI.T_FIID = WR.T_FIID " + 
                       "WHERE WR.T_DRAWINGDATE <= ? " + 
                       "  AND TRUSTAPI.RSI_IsBond(FI.T_FIID) = 1 " + 
                       "  AND RSB_PMWRTOFF.WRTGetPortfolioAmount(1, FI.T_FIID, -1, 0, -1, -1, WR.T_LISTDATE, 1, 0, 0) > 0 " + 
                       "  AND WR.T_SPISCLOSED <> CHR(88) " + str_where );
  elif(DealType == Issue)
    query = RSDCommand("SELECT COUNT(FI.T_FIID) AS CNT " + 
                       "FROM DFININSTR_DBT FI " + 
                       "     INNER JOIN DAVOIRISS_DBT AV ON FI.T_FIID = AV.T_FIID " + 
                       "WHERE FI.T_DRAWINGDATE <= ? " + 
                       "  AND TRUSTAPI.RSI_IsBond(FI.T_FIID) = 1 " + 
                       "  AND RSB_PMWRTOFF.WRTGetPortfolioAmount(1, FI.T_FIID, -1, 0, -1, -1, AV.T_LISTDATE, 1, 0, 0) > 0 " + 
                       "  AND AV.T_SPISCLOSED <> CHR(88) " );
  end;

  query.addParam( "", RSDBP_IN, MonitorDate );
  query.execute();

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if( ds.MoveNext() )
    count = int(ds.Cnt);
  end;

  if((DealType == Coupon) or (DealType == Partly))
    query = RSDCommand("SELECT FI.T_FIID, FI.T_FI_CODE, FI.T_NAME, AV.T_ISIN, WR.T_NUMBER, AV.T_LSIN, WR.T_LISTDATE, WR.T_DRAWINGDATE, " + 
                       "       CASE WHEN WR.T_ISPARTIAL = CHR(88) THEN 'ЧП' ELSE 'Купон' END AS KIND_PAY, " + 
                       "       FI.T_ISGENERALIZED, FI.T_FACEVALUEFI " + 
                       "FROM DFININSTR_DBT FI " + 
                       "     INNER JOIN DFIWARNTS_DBT WR ON FI.T_FIID = WR.T_FIID " + 
                       "     INNER JOIN DAVOIRISS_DBT AV ON FI.T_FIID = AV.T_FIID " + 
                       "WHERE WR.T_DRAWINGDATE <= ? " + 
                       "  AND TRUSTAPI.RSI_IsBond(FI.T_FIID) = 1 " + 
                       "  AND RSB_PMWRTOFF.WRTGetPortfolioAmount(1, FI.T_FIID, -1, 0, -1, -1, WR.T_LISTDATE, 1, 0, 0) > 0 " + 
                       "  AND WR.T_SPISCLOSED <> CHR(88) " + str_where + " ORDER BY FI.T_FIID" );
  elif(DealType == Issue)
    query = RSDCommand("SELECT FI.T_FIID, FI.T_FI_CODE, FI.T_NAME, AV.T_ISIN, '' AS T_NUMBER, AV.T_LSIN, AV.T_LISTDATE, FI.T_DRAWINGDATE, " + 
                       "       'Полное погашение' AS KIND_PAY, " + 
                       "       FI.T_ISGENERALIZED, FI.T_FACEVALUEFI " + 
                       "FROM DFININSTR_DBT FI " + 
                       "     INNER JOIN DAVOIRISS_DBT AV ON FI.T_FIID = AV.T_FIID " + 
                       "WHERE FI.T_DRAWINGDATE <= ? " + 
                       "  AND TRUSTAPI.RSI_IsBond(FI.T_FIID) = 1 " + 
                       "  AND RSB_PMWRTOFF.WRTGetPortfolioAmount(1, FI.T_FIID, -1, 0, -1, -1, AV.T_LISTDATE, 1, 0, 0) > 0 " + 
                       "  AND AV.T_SPISCLOSED <> CHR(88) ORDER BY FI.T_FIID" );
  end;

  query.addParam( "", RSDBP_IN, MonitorDate );
  query.execute();

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  
  InitProgress(count,null,"Распределение сумм погашений");

  while( ds.MoveNext() )
    var prm = SP_DealParm();

    q = RSDCommand("SELECT COUNT(T.T_DEALID) AS CNT FROM DDL_TICK_DBT T " +
                   "WHERE T.T_BOFFICEKIND = ? " +
                   "  AND T.T_DEALTYPE = ? " +
                   "  AND T.T_DEALDATE = ? " +
                   "  AND (T.T_NUMBER_COUPON = ? OR T.T_NUMBER_PARTLY = ? ) " +
                   "  AND T.T_PFI = ? ");

    q.addParam( "", RSDBP_IN, DL_RETIREMENT_DST );
    q.addParam( "", RSDBP_IN, DealType );
    q.addParam( "", RSDBP_IN, MonitorDate );
    q.addParam( "", RSDBP_IN, ds.Number );
    q.addParam( "", RSDBP_IN, ds.Number );
    q.addParam( "", RSDBP_IN, ds.FIID );
    q.execute();
    dss = TRsbDataSet(q, RSDVAL_CLIENT, RSDVAL_STATIC);
    dss.MoveNext();
    // Есть ли уже такой документ;
    if(int(dss.Cnt) == 0 )
      InitSPDeal(tick, DL_RETIREMENT_DST, DealType, true);
      tick.rec.BofficeKind      = DL_RETIREMENT_DST;
      tick.rec.DealCode         = "";//Generate_DealCode( DL_RETIREMENT_DST, {curdate} ); 
      tick.rec.PartyID          = prm.PartyID;
      tick.rec.PortfolioID      = prm.Portfolio;
      tick.rec.ClientID         = prm.ClientID;
      tick.rec.Department       = prm.Department;     
      tick.rec.Oper             = prm.Oper;
      tick.rec.FixSum           = prm.FixSum;
      tick.rec.Flag3            = prm.TermInWorkDays;
      tick.rec.DealDate         = prm.DealDate;
      tick.rec.DealTime         = prm.DealTime;
      tick.rec.Country          = UNSET_CHAR;
      tick.rec.Flag2            = prm.SignContract;
      tick.rec.DealCodeTS       = prm.DealCodeTS;
      tick.rec.ClientContrID    = prm.ClientContrID;
      tick.rec.BrokerContrID    = prm.BrokerContrID;
      tick.rec.BrokerID         = prm.BrokerID;
      tick.rec.Blocked          = prm.Blocked;
      tick.rec.ReturnIncomeKind = prm.ReturnIncomeKind;
      tick.rec.CommDate         = Date(0,0,0);
      tick.rec.Flag4            = prm.PayWithBrocker;
      tick.rec.Flag5            = UNSET_CHAR;
      tick.rec.CarryWrt         = SET_CHAR;
      if(DealType == Coupon)
        tick.rec.Number_Coupon  = ds.Number;  
      end;
      if(DealType == Partly)
        tick.rec.Number_Partly  = ds.Number;  
      end;
      leg.rec.PFI               = ds.Fiid;
      leg.rec.Principal         = prm.Amount;
      leg.rec.Cost              = prm.Cost;
      leg.rec.Formula           = CodeFor(prm.TypeCalc);
      leg.rec.MaturityIsPrincipal = "";
      leg.rec.Expiry            = {curdate};
      leg.rec.Maturity          = {curdate};
      leg.rec.SupplyTime        = prm.SupplyTime;
      leg.rec.CFI               = ds.FaceValueFI;
      leg.rec.PayFIID           = leg.rec.CFI;
      leg.rec.NKDFIID           = ds.FaceValueFI;
      leg.rec.Point             = prm.Point;          
      leg.rec.RelativePrice     = prm.InPerc;
      leg.rec.NKD               = prm.NKD;
      leg.rec.TotalCost         = $0;
      leg.rec.Start             = ds.ListDate;                  
      leg.rec.PayRegTax         = prm.PayRegTax;
      leg.rec.Registrar         = prm.Registrar;
      leg.rec.DepositID         = prm.DepositID;
      leg.rec.Basis             = prm.Basis;
      if( SQL_ConvTypeStr(ds.IsGeneralized) == SET_CHR )
        leg.rec.DeliveringFIID = ALLFININSTR;
      else
        leg.rec.DeliveringFIID = ds.Fiid;;
      end;
      
      // Calc params:
      var Group = GetOperationGroup( tick.rec.DealType );
      var Amount:money = $0;
      SP_CalcRetireAmount(tick, leg, Amount, Group, -1);
      // данные, которые меняются в SP_CalcRetireAmount
      leg.rec.Principal = Amount;

      var IsCoupon = DealType == Coupon;
      SP_CalcDL_LEG_NKD(tick, leg, {curdate}, IsCoupon);
      // данные, которые меняются в SP_CalcDL_LEG_NKD
      //leg.rec.NKD
      //leg.rec.TotalCost

      var Curr_nominal:double = GetFaceValue(ds.Fiid, leg.rec.Expiry);
      var leg_b  = TRecHandler("dl_leg.dbt");
      //var Rq = TRecHandler("dlrq");
      SP_RecalcSum( tick, leg, Curr_nominal, /*PanelDeal.Deal.SumPayNoAvance*/ $0, /*PanelDeal.Deal.SumAvance*/ $0, /*IsBackSale*/ false,
              /*GetSysNumField( PanelDeal.Deal )*/ 36, /*ChangeIncomeRate*/ false, /*PanelDeal.Deal.SumPayNoAvance_b*/ $0,
              /*PanelDeal.Deal.SumAvance_b*/ $0, leg_b, /*DlRqAvance1*/ null, /*DlRqMoney1*/ null, /*DlRqAvance2*/ null, /*DlRqMoney2*/ null,
              /*DlRqPercent*/ null, /*PanelDeal.RecalcDealParam*/ true );
      // данные, которые меняются в SP_RecalcSum
      //leg.rec.Cost
      //leg.rec.Price
      //leg.rec.TotalCost;

      stat = SP_CreateDeal( tick, leg, null, null, null, null, null, true, 0, false);
    end;
    i = i + 1;
    UseProgress(i)
  end;
  RemProgress();

  str_where = String(" T.T_DEALTYPE = ", DealType, " AND T.T_DEALDATE = TO_DATE('", SubStr(String({curdate}),1,10), "','dd.mm.yyyy') AND T.T_OPER = ", {oper});

  SC_RetiresCreateSumm(str_where);

  return stat;
end;

macro exec_retires_coupon(EventsDate : string)
  return exec_retires(Date(EventsDate), Coupon);
end;

macro exec_retires_partly(EventsDate : string)
  return exec_retires(Date(EventsDate), Partly);
end;

macro exec_retires_issue(EventsDate : string)
  return exec_retires(Date(EventsDate), Issue);
end;


// Учет купонов/чп
macro exec_accounting(MonitorDate, KindPay, OTC) : bool
  var query, str_where, type_paym = "", ds, listdeals = "", stat = 0;

  if(KindPay == Coupon)
    str_where = "  AND WR.T_ISPARTIAL <> CHR(88) ";
    type_paym = "4 ";
  elif(KindPay == Partly)
    str_where = "  AND WR.T_ISPARTIAL = CHR(88) ";
    type_paym = "5 ";
  end;

  if(OTC)
    str_where = str_where + " AND Rsb_Secur.IsOutExchange(Opr.oGrp) = 1 ";
  else
    str_where = str_where + " AND Rsb_Secur.IsExchange(Opr.oGrp) = 1 ";
  end;

  query = RSDCommand("SELECT DISTINCT TI.T_DEALID "
                     "FROM (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup(t_SysTypes) oGrp FROM doprkoper_dbt) Opr, " +
                     "DFIWARNTS_DBT WR " +
                     "INNER JOIN DFININSTR_DBT FI    ON WR.T_FIID = FI.T_FIID " +
                     "INNER JOIN DDLRQ_DBT RQ        ON WR.T_FIID = RQ.T_FIID " + 
                     "INNER JOIN DDL_TICK_DBT TI     ON RQ.T_DOCID = TI.T_DEALID " +
                     "WHERE WR.T_DRAWINGDATE <= ? " +
                     "  AND TRUSTAPI.RSI_IsBond(FI.T_FIID) = 1 " +
                     "  AND Opr.t_Kind_Operation = TI.t_DealType " +
                     "  AND Opr.t_DocKind = TI.t_BOfficeKind " +
                     "  AND TI.t_DealStatus = 10 " +
                     "  AND WR.T_SPISCLOSED <> CHR(88) " +
                     "  AND RQ.T_DEALPART = 2 " + str_where +
                     "  AND ((RQ.T_FACTDATE >= WR.T_LISTDATE) OR (RQ.T_FACTDATE = TO_DATE('01.01.0001', 'dd.mm.yyyy'))) " + 
                     "  AND NOT EXISTS (SELECT *  FROM DDLRQ_DBT RQ2 " +
                     "                  WHERE RQ2.T_DOCKIND = RQ.T_DOCKIND " +
                     "                    AND RQ2.T_DOCID = RQ.T_DOCID " +
                     "                    AND RQ2.T_TYPE = " + type_paym +
                     "                    AND CASE WHEN RSI_RSBCALENDAR.ISWORKDAY(WR.T_DRAWINGDATE) = 0 THEN CASE WHEN RQ2.T_FACTDATE >= WR.T_DRAWINGDATE AND RQ2.T_FACTDATE <= RSI_RSBCALENDAR.GETDATEAFTERWORKDAY(WR.T_DRAWINGDATE, 1) THEN 1 ELSE 0 END ELSE " +
                     "                                                                                       CASE WHEN RQ2.T_FACTDATE = WR.T_DRAWINGDATE THEN 1 ELSE 0 END END = 1) " + 
                     "ORDER BY TI.T_DEALID");

  query.addParam( "", RSDBP_IN, MonitorDate );
  query.execute();

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  while( ds.MoveNext() )
    listdeals = listdeals + String(ds.DealID,","); 
  end;
  if(listdeals != "")
    listdeals = Substr(listdeals,1,StrLen(listdeals)-1);
    str_where = String(" T.T_DEALID IN (", listdeals, ")");
  else
    str_where = "";
  end;
 
  SC_browse_deals(str_where);

  return stat;
end;

macro exec_acc_coupon_otc(EventsDate : string)
  return exec_accounting(Date(EventsDate), Coupon, true);
end;

macro exec_acc_partly_otc(EventsDate : string)
  return exec_accounting(Date(EventsDate), Partly, true);
end;

macro exec_acc_coupon(EventsDate : string)
  return exec_accounting(Date(EventsDate), Coupon, false);
end;

macro exec_acc_partly(EventsDate : string)
  return exec_accounting(Date(EventsDate), Partly, false);
end;

// Проверка справочников выплат (нулевая ставка купонов/чп)
PRIVATE CLASS (DL_CReportTemplate) Guidepaym_ReportXls(MonitorDate, KindPay_)
  var MonDate;
  var KindPay;
  var IsWebservice = true;

  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;                                                                                                                                                                         

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
     this.SetActiveSheet( "Список выплат с нулевой ставкой" );
     this.RegisterTable("N1_MainTable", "", "N1_Fiid", "N1_Name", "N1_LSIN", "N1_ISIN", "N1_Kind_pay", "N1_Number", "N1_ListDate", "N1_DrawingDate" );
  END;

  PRIVATE MACRO EndReport()
     EndTable();
  END;

  PRIVATE MACRO PrintReportLine(DataSet)
     this.PrintTableLine(
                        "N1_Fiid:c",        string( DataSet.Fiid ),         null,
                        "N1_Name:c",        string( DataSet.Name ),         null,
                        "N1_LSIN:c",        string( DataSet.LSIN ),         null,
                        "N1_ISIN:c",        string( DataSet.ISIN ),         null, 
                        "N1_Kind_pay:c",    string( DataSet.Kind_pay ),     null,
                        "N1_Number:c",      string( DataSet.Number ),       null,
                        "N1_ListDate:c",    date(   DataSet.ListDate ),     null,
                        "N1_DrawingDate:c", date(   DataSet.DrawingDate ),  null );    
  END;

  PRIVATE MACRO Create()
     var itDate;
     var report = "";
     var Rate, ErrCode, str_where;
                  
     GetRegistryValue( "SECUR\\СРОК ПРОВЕР. СТАВ. ПЕРЕД ВЫПЛАТ",  V_INTEGER, Rate,  ErrCode );

     if(KindPay == Coupon)
       str_where = "  AND WR.T_ISPARTIAL <> CHR(88) AND WR.T_INCOMEVOLUME = 0 ";
     elif(KindPay == Partly)
       str_where = "  AND WR.T_ISPARTIAL = CHR(88)";
     end;
   
     var Select = Dl_RSDCommand("SELECT WR.T_FIID, FI.T_NAME, AV.T_ISIN, AV.T_LSIN, CASE WHEN WR.T_ISPARTIAL = CHR(88) THEN 'ЧП' ELSE 'Купон' END AS KIND_PAY, " +
                                "       WR.T_NUMBER, WR.T_LISTDATE, WR.T_DRAWINGDATE " + 
                                "FROM DFIWARNTS_DBT WR, DFININSTR_DBT FI, DAVOIRISS_DBT AV " +
                                "WHERE WR.T_FIID = FI.T_FIID " +
                                "  AND WR.T_FIID = AV.T_FIID " +
                                "  AND WR.T_INCOMERATE = 0 " +
                                "  AND (WR.T_DRAWINGDATE - ?) <= ? " +
                                "  AND TRUSTAPI.RSI_IsBond(FI.T_FIID) = 1 " +
                                "  AND RSB_DEPO.GETAVOIRSERVSTATEONDATE(AV.T_FIID, ?, ?) = 1 " + str_where );
     Select.addParam(MonDate);
     Select.addParam(Rate);
     Select.addParam(MonDate);
     Select.addParam({OperDprt});

     var DataSet = Select.Execute() ;

     while(DataSet.moveNext() )     
       /*Печать строки*/
       PrintReportLine(DataSet);
     end; 
  END;

  MonDate = MonitorDate;
  KindPay = KindPay_;
  initDL_CReportTemplate( null, "Report_exec_guidepaym.xls", null, IsWebservice);
END; /*CLASS Exec_guidepaym_ReportXls*/

// Выпуск отчета нулевая ставка купонов/чп
macro report_guidepaym(MonitorDate, KindPay) : string; 
  var query, str_where, ds, stat = 0, report = "", cmd, Rate, ErrCode;

  GetRegistryValue( "SECUR\\СРОК ПРОВЕР. СТАВ. ПЕРЕД ВЫПЛАТ",  V_INTEGER, Rate,  ErrCode );

  if(KindPay == Coupon)
    str_where = "  AND WR.T_ISPARTIAL <> CHR(88) AND WR.T_INCOMEVOLUME = 0 ";
  elif(KindPay == Partly)
    str_where = "  AND WR.T_ISPARTIAL = CHR(88)";
  end;

  query = RSDCommand("SELECT WR.T_FIID, FI.T_NAME, AV.T_ISIN, AV.T_LSIN, CASE WHEN WR.T_ISPARTIAL = CHR(88) THEN 'ЧП' ELSE 'Купон' END AS KIND_PAY, " +
                     "       WR.T_NUMBER, WR.T_LISTDATE, WR.T_DRAWINGDATE " + 
                     "FROM DFIWARNTS_DBT WR, DFININSTR_DBT FI, DAVOIRISS_DBT AV " +
                     "WHERE WR.T_FIID = FI.T_FIID " +
                     "  AND WR.T_FIID = AV.T_FIID " +
                     "  AND WR.T_INCOMERATE = 0 " +
                     "  AND (WR.T_DRAWINGDATE - ?) <= ? " +
                     "  AND TRUSTAPI.RSI_IsBond(FI.T_FIID) = 1 " +
                     "  AND RSB_DEPO.GETAVOIRSERVSTATEONDATE(AV.T_FIID, ?, ?) = 1 " + 
                     str_where);

  query.addParam( "", RSDBP_IN, MonitorDate);
  query.addParam( "", RSDBP_IN, Rate);
  query.addParam( "", RSDBP_IN, MonitorDate);
  query.addParam( "", RSDBP_IN, {OperDprt});

  query.execute();

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  while( ds.MoveNext() )
    report = report + String("  ",ds.Fiid:9," | ",ds.Name:30, " | ", ds.Lsin:15, " | ", ds.Isin:15, " | ", ds.Kind_pay:10, " | ", ds.Number:7, " | ", SubStr(String(ds.ListDate),1,10):10, " | ", SubStr(String(ds.DrawingDate),1,10):10,"\n");
  end;

  if(report != "")
    report = 
    " ---------------------------------------------------------------------------------------------------------------------------------\n" +
    "    Код     |           Наименование         |     Номер       |      ISIN       |    Вид     |    №    | Дата сбора |  Дата      \n" +    
    "  выпуска   |             выпуска            | гос.регистрации |                 |  выплаты   | выплаты |  реестра   | выплаты    \n" +    
    " ---------------------------------------------------------------------------------------------------------------------------------\n" + 
    report + 
    " ---------------------------------------------------------------------------------------------------------------------------------\n";
  end;
  
  return report;
end;

macro exec_guidepaym(MonitorDate,KindPay)
  var FullNames = TArray(), Report;

  Report = Guidepaym_ReportXls(MonitorDate,KindPay);
  Report.Run();
  FullNames = Report.GetFullReportFileNames(); 

  return CreateFileContainer(FullNames[0]);

/*
  var protocol = report_guidepaym(MonitorDate, KindPay);

  SetOutput( string("..\\txtfile\\protocol_", Random(998)+1,".txt"), false );

  println(protocol);

  var prevName = SetOutput( null, true );
  var FC = CreateFileContainer(ConvertTxt2Html(prevName));
  RemoveFile(prevName);
  RemoveFile(prevName + ".html");
  return FC;
*/
end;

macro exec_guidepaym_coupon(MonitorDate)
  return exec_guidepaym(MonitorDate,Coupon);  
end;

macro exec_guidepaym_partly(MonitorDate)
  return exec_guidepaym(MonitorDate,Partly);  
end;

// Выполнение расчета комиссий
macro exec_run_calc_comiss(MonitorDate)
  var filename = string("..\\txtfile\\protocol_",{oper},".txt");
  var report = "exec";

  SetOutPut(filename);
  if(RunComCalc(MonitorDate,-1,-1,-1,-1,1,false,@report) == 0)
    SetOutput (NULL,TRUE);
    var FC = CreateFileContainer(ConvertTxt2Html(filename));
    RemoveFile(filename);
    RemoveFile(filename + ".html");
    return FC;
  end;
end;

macro GetSQL_UnprocessedObjects_OpDL_COMMDOC(MonitorDate)
   return 
     " SELECT contr.t_ID t_sfcontrID, " +
     "        concom.t_CommNumber, " + 
     "        comiss.t_Code CODE, " + 
     "        contr.t_Number CONTRNUMBER, " + 
     "        (CASE WHEN contr.t_partyID < 1 or contr.t_partyID = " + {OurBank} + " THEN chr(0) ELSE rsi_rsbparty.PT_GetPartyCode (contr.t_partyID, " + PTCK_CONTR + ") END) CODEPAYER, " +
     "        (CASE WHEN contr.t_partyID < 1 or contr.t_partyID = " + {OurBank} + " THEN chr(0) ELSE (SELECT t_Name FROM dparty_dbt WHERE t_PartyID = contr.t_partyID) END) PAYER, " +
     "        (SELECT COUNT (1) " +
     "         FROM DSFDEFCOM_DBT def " +
     "         WHERE def.T_COMMNUMBER = concom.t_CommNumber " +
     "           and def.T_CONID = concom.t_ObjectID " +
     "           and def.T_DATEFEE = " + GetSQLDate(MonitorDate) +
     "        ) t_defComCount " +
     " FROM dsfcontr_dbt contr, dsfConCom_dbt concom, dSfComiss_dbt comiss " +
     " WHERE contr.t_ServKind = " + PTSK_STOCKDL +
     "   and (contr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY') or (contr.t_DateClose >= " + GetSQLDate(MonitorDate) + ")) " +
     "   and concom.t_ObjectType = " + OBJTYPE_SFCONTR +
     "   and concom.t_feeType = " + SF_FEE_TYPE_PERIOD +
     "   and concom.t_ObjectID = contr.t_ID " +
     "   and concom.t_status = " + 0/*SF_ACTIVE*/ +
     "   and comiss.t_feeType = concom.t_feeType " +
     "   and comiss.t_ServiceKind = contr.t_ServKind " +
     "   and comiss.t_Number = concom.t_CommNumber " +
     "   and comiss.t_FormAlg != " + SFCOMISS_FORMALG_MANUAL;
end;

// Расчет периодических комиссий
macro exec_comiss_DL_COMMDOC(MonitorDate)
  var query, cmd, DataSet, ds, stat = 0, str_select = "", str_where = "";
  var filename = "", EventName = "", message = "";                                                                                                    
  var comm = Tbfile("dl_comm", "W", 0);
  var unprocessed_objects:bool = false, unprocessed_operations_count:integer = 0;
  EventName = "Расчет периодических комиссий";
  message = "Ошибка при выполнении события <" + EventName  + ">. Не найден файл отчета.";

  cmd = DL_RSDCommand();
  DataSet = cmd.execute(GetSQL_UnprocessedObjects_OpDL_COMMDOC(MonitorDate));
  
  while( DataSet.MoveNext() )
    if( (DataSet.defComCount == 0) and SC_NeedCalcCom(DataSet.sfcontrID, DataSet.CommNumber, MonitorDate, OBJGROUP_SFCOM_CALCBYBO, "TDF"/*SFCOM_CALCBYBO_FINALTRADEDAY*/) )
      unprocessed_objects = true;
      break;
    end;
  end;

  // Если есть необработанные объекты
  if( unprocessed_objects )
     str_select =
        " SELECT " +
        "   comm.t_DocumentID " +
        " FROM " +
        "   DDL_COMM_DBT comm " +
        " WHERE " +
        "       comm.t_DocKind = " + RCB_DL_COMMDOC +
        "   AND comm.t_CommStatus = " + DL_COMM_PREPARING +
        "   AND comm.t_CommDate = " + GetSQLDate(MonitorDate) +
        "   AND comm.t_Division = " + {OperDprt} +
        "   AND comm.t_OperSubKind = 0 " +
        "   AND comm.t_ClientID = " + UnknownParty +
        "   AND comm.t_ContractID = " + UnknownParty +
        "   AND comm.t_PartyID = " + UnknownParty +
        "   AND comm.t_IssuerID = " + UnknownParty +
        "   AND comm.t_Currency = " + ALLFININSTR +
        "   AND comm.t_CreateReport = chr(88) ";
 
     unprocessed_operations_count = SQL_GetNRecs(str_select);
     // Если есть необработанные операции с параметрами по умолчанию
     if( unprocessed_operations_count > 0 )
        str_where = "0";

        query = RSDCommand( str_select );
        query.execute();

        ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
        if( ds.MoveNext() )
           str_where = string(ds.DocumentID); // возьмем подходящую
        end;
     else // создадим новую, с параметрами по умолчанию
        comm.Clear();
        comm.rec.CommCode = GetCommCodeNewByPrm( RCB_OBJTYPE_SECURSERVOP, RCB_REFOBJ_SVOP_PERIODCOMM );
        comm.rec.DocKind      = RCB_DL_COMMDOC;
        comm.rec.OperSubKind  = 0;
        comm.rec.CommStatus   = DL_COMM_PREPARING;
        comm.rec.CommDate     = MonitorDate;
        comm.rec.Division     = {OperDprt};
        comm.rec.Oper         = {oper};
        comm.rec.ClientID     = UnknownParty;
        comm.rec.ContractID   = UnknownParty;
        comm.rec.PartyID      = UnknownParty;
        comm.rec.IssuerID     = UnknownParty;
        comm.rec.Currency     = UnknownParty;
        comm.rec.CreateReport = SET_CHAR;        

        stat = SC_CreateDlCommOperation( comm );

        if( stat == 0 )
           str_where = string(comm.rec.DocumentID);
        end;
     end;

     if( stat == 0 )
        SC_ServOperExecuteSilent( RCB_DL_COMMDOC, comm.rec.DocumentID );
     end;
  else
     message = "Событие <" + EventName + "> было обработано ранее.";
  end;

  filename = string("..\\txtfile\\svoprep.",UserNumber);
  if(ExistFile(filename))
    return CreateFileContainer(ConvertTxt2Html(filename));
  else
    SetOutPut(filename);
    println(message);
    SetOutput (NULL,TRUE);
    var FC = CreateFileContainer(ConvertTxt2Html(filename));
    RemoveFile(filename);
    RemoveFile(filename + ".html");
    return FC;
  end;
end;

// Комиссии
macro exec_comiss(MonitorDate, DocKind)
  var query, cmd, DataSet, ds, stat = 0, CommCode = "", IsDataExists = false;
  var filename = "", EventName = "", message = "";                                                                                                    
  var comm = Tbfile("dl_comm", "W", 0);

  if(DocKind == RCB_DL_SPOPER_COMISS) 
    EventName = "Экспорт комиссий в ПЗО";
  end;

  message = "Ошибка при выполнении события <" + EventName  + ">. Не найден файл отчета.";

  cmd = DL_RSDCommand();                                                                                              
  
  query = "SELECT t.T_DOCUMENTID, t.T_DOCKIND, t.T_OPER, t.T_COMMCODE " +
          "  FROM DDL_COMM_DBT t, DSFCOMISS_DBT sfcomiss, DSFCONCOM_DBT sfconcom, DSFCONTR_DBT sfcontr " +
          " WHERE t.T_DOCKIND = ? " + 
          "   AND t.T_COMMSTATUS < 2 " + 
          "   AND sfcontr.T_ID (+) = t.T_CONTRACTID " + 
          "   AND sfconcom.T_ID (+) = t.T_DOCUMENTID " +
          "   AND sfcomiss.T_FEETYPE (+) = sfconcom.T_FEETYPE " +
          "   AND sfcomiss.T_NUMBER (+) = sfconcom.T_COMMNUMBER " +
          "   AND t.T_COMMDATE = ?  " +
          " ORDER BY t.T_DOCKIND, t.T_COMMSTATUS, t.T_OPERATIONKIND, t.T_DOCUMENTID ";

  cmd.addParam(DocKind); 
  cmd.addParam(MonitorDate);        

  DataSet = cmd.execute(query);

  if( DataSet.MoveNext() )
    CommCode = DataSet.CommCode;
    SC_ServOperExecuteSilent( DocKind, DataSet.DocumentID );
  else
    // Если нет закрытых комиссий за дату монитора, то добавляем комиссию
    query = "SELECT Count(t.T_DOCUMENTID) as count_comiss " +
            "  FROM DDL_COMM_DBT t " +
            " WHERE t.T_DOCKIND = ? " + 
            "   AND t.T_COMMSTATUS = 2 " + 
            "   AND t.T_COMMDATE = ?  ";

    cmd.addParam(DocKind); 
    cmd.addParam(MonitorDate);        

    ds = cmd.execute(query);
    
    if( ds.MoveNext() )
      if(Int(ds.Count_Comiss) == 0) 
        comm.Clear();
        comm.rec.DocKind      = DocKind;
        comm.rec.Oper         = {oper};
        comm.rec.ClientID     = UnknownParty;
        comm.rec.CommDate     = MonitorDate;
        comm.rec.CommStatus   = DL_COMM_PREPARING;
        comm.rec.CreateReport = SET_CHAR;

        if(DocKind == RCB_DL_SPOPER_COMISS) 
          comm.rec.CommCode     = GetCommCodeNewByPrm(RCB_OBJTYPE_COMMISS_DV, RCB_REFOBJ_SVOP_TRANSFER);
        end;
        
        CommCode = comm.rec.CommCode;    

        stat = SC_CreateDlCommOperation( comm );

        if( stat == 0 )
          SC_ServOperExecuteSilent( DocKind, comm.rec.DocumentID );
        end;
      else
        message = "Событие <" + EventName + "> было обработано ранее.";
      end;
    end;
  end;

  if(DocKind == RCB_DL_SPOPER_COMISS) 
    filename = string("..\\txtfile\\spfc_",CommCode,".",UserNumber);
  end;
  if(ExistFile(filename))
    return CreateFileContainer(ConvertTxt2Html(filename));
  else
    SetOutPut(filename);
    println(message);
    SetOutput (NULL,TRUE);
    var FC = CreateFileContainer(ConvertTxt2Html(filename));
    RemoveFile(filename);
    RemoveFile(filename + ".html");
    return FC;
  end;
end;

macro exec_calc_period_comiss(MonitorDate)
  return exec_comiss_DL_COMMDOC(MonitorDate);
end;

macro exec_exp_comiss_pzo(MonitorDate)
  return exec_comiss(MonitorDate, RCB_DL_SPOPER_COMISS); 
end;

// Проверить существование операции расчета выплат (Депозитарий)
private macro exists_dp_corpop(MonitorDate:Date, KindPay, Fiid, Owner, Number ) : bool
  var str_select = "", query, ds;

  str_select = "SELECT corpop.t_DocumentID "
     " FROM "
        " DDPCORPOP_DBT corpop, "
        " DDPREGSTR_DBT regstr, "
        " ddppmacfi_dbt pmacfi "
     " WHERE "
         " regstr.t_DocumentID = corpop.t_DocumentID "
         " AND pmacfi.t_DocumentID = corpop.t_DocumentID "
         " AND corpop.t_DocKind = ? "
         " AND corpop.t_Kind_Operation = ? "
         " AND corpop.t_Date = ? "
         " AND corpop.t_PaymentType = ? "
         " AND pmacfi.t_Fiid = ? "
         " AND regstr.t_StoragePlace = ? "
         + IIF((KindPay == DP_CRPPAYMENTTYPE_COUPON) or (KindPay == DP_CRPPAYMENTTYPE_NOMINAL), " AND corpop.t_WarrantNum = ? ", "");

  query = RSDCommand( str_select );

  query.addParam( "", RSDBP_IN, 870 );
  query.addParam( "", RSDBP_IN, 4780 );
  query.addParam( "", RSDBP_IN, MonitorDate );
  query.addParam( "", RSDBP_IN, KindPay ); // тип выплаты
  query.addParam( "", RSDBP_IN, Fiid );
  query.addParam( "", RSDBP_IN, Owner );
  if((KindPay == DP_CRPPAYMENTTYPE_COUPON) or (KindPay == DP_CRPPAYMENTTYPE_NOMINAL))
    query.addParam( "", RSDBP_IN, Number ); // номер купона/чп/дивиденда
  end;
  query.execute();

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if( ds.MoveNext() )
    return true;
  end;

  return false;
end;


//Погашение купонов/чп/выпуска/дивидендов (Депозитарий)
macro exec_dp_retires(MonitorDate, KindPay) : bool
  var query, ds, stat = 0, count = 0, i = 0, str_cond = "", str_select = "";

  if((KindPay == DP_CRPPAYMENTTYPE_COUPON)
  or (KindPay == DP_CRPPAYMENTTYPE_DIVIDENDS) )
    str_cond = "  AND WR.T_ISPARTIAL <> CHR(88)";
  elif(KindPay == DP_CRPPAYMENTTYPE_NOMINAL)
    str_cond = "  AND WR.T_ISPARTIAL = CHR(88)";
  end;

  if( (KindPay == DP_CRPPAYMENTTYPE_COUPON)
  or (KindPay == DP_CRPPAYMENTTYPE_NOMINAL)
  or (KindPay == DP_CRPPAYMENTTYPE_DIVIDENDS) )
    str_select = "SELECT DISTINCT "
	" acc_depo.t_AutoKey, acc_depo.t_owner, fin.t_FIID, wr.t_Number "
	" FROM daccount_dbt acc, "
	" ddepoacnt_dbt acc_depo, "
	" dfininstr_dbt fin, "
	" DFIWARNTS_DBT wr "
	" WHERE acc.t_Chapter = ? "
	" AND fin.t_FIID = acc.t_Code_Currency "
	+ str_cond +
        " AND wr.T_FIID = fin.T_FIID "
        " AND wr.T_DRAWINGDATE <= ? "
        " AND wr.T_ISCLOSED <> CHR (88) "
	" AND acc_depo.t_AutoKey = acc.t_Deporoot "
	" AND acc_depo.T_KIND = ? "
	" AND RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, " + IIF(KindPay == DP_CRPPAYMENTTYPE_DIVIDENDS, AVOIRISSKIND_SHARE, AVOIRISSKIND_BOND) + ", fin.t_AvoirKind) = 1 "
	" AND rsb_depo.GetAvoirServStateOnDate(fin.T_FIID, ?, ? ) = 1 "
	" AND rsb_account.restac (acc.t_Account, acc.t_Code_Currency, wr.t_ListDate, acc.t_Chapter, NULL) <> 0 " 
	" ORDER BY fin.t_FIID, acc_depo.t_owner ";
  elif( KindPay == DP_CRPPAYMENTTYPE_ISSUE )
    str_select = "SELECT DISTINCT "
	" acc_depo.t_AutoKey, acc_depo.t_owner, fin.t_FIID, '' t_Number "
	" FROM daccount_dbt acc, "
	" ddepoacnt_dbt acc_depo, "
	" davoiriss_dbt avr, "
	" dfininstr_dbt fin "
	" WHERE acc.t_Chapter = ? "
	" AND fin.t_FIID = acc.t_Code_Currency "
	" AND fin.t_FIID = avr.t_FIID "
	" AND fin.T_DRAWINGDATE <= ? " 
	" AND fin.T_ISCLOSED <> CHR (88) "
	" AND acc_depo.t_AutoKey = acc.t_Deporoot "
	" AND acc_depo.T_KIND = ? "
	" AND rsb_depo.GetAvoirServStateOnDate(fin.T_FIID, ?, ? ) = 1 "
	" AND rsb_account.restac (acc.t_Account, acc.t_Code_Currency, avr.t_ListDate, acc.t_Chapter, NULL) <> 0 " 
	" ORDER BY fin.t_FIID, acc_depo.t_owner ";
  end;

  query = RSDCommand( "SELECT COUNT(*) nRecs FROM (" + str_select + ")" );

  query.addParam( "", RSDBP_IN, 5 ); //по 5-й главе (CHAPT5)
  query.addParam( "", RSDBP_IN, MonitorDate );
  query.addParam( "", RSDBP_IN, 1 ); /* Активные счета Депо (SIDEBALANCE_ACTIVE) */
  query.addParam( "", RSDBP_IN, MonitorDate );
  query.addParam( "", RSDBP_IN, {NumDprt} );
  query.execute();

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);

  if( ds.MoveNext() )
    count = int(ds.nRecs);
  end;

  query = RSDCommand( str_select );

  query.addParam( "", RSDBP_IN, 5 ); //по 5-й главе (CHAPT5)
  query.addParam( "", RSDBP_IN, MonitorDate );
  query.addParam( "", RSDBP_IN, 1 ); /* Активные счета Депо (SIDEBALANCE_ACTIVE) */
  query.addParam( "", RSDBP_IN, MonitorDate );
  query.addParam( "", RSDBP_IN, {NumDprt} );
  query.execute();

  ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
  
  InitProgress(count, null, "Обработка объектов");

  var newopid:Integer = 0;
  var str_where = ""; // id созданных операций
  var st:Integer = 0;
  var AutoKeyList:TArray = TArray(); // счета
  var OwnerList:TArray = TArray();   // места хранения
  var FiidList:TArray = TArray();    // ц/б
  var NumberList:TArray = TArray();  // номер купона/чп/дивиденда

  SetDialogFlag(0);
  if( ds.MoveNext() )
    FiidList[0] = ds.Fiid;
    OwnerList[0] = ds.Owner;
    AutoKeyList[0] = ds.AutoKey;
    NumberList[0] = ds.Number;
  end;
  // отбираем данные о местах хранения и счетах для конкретной ц/б (Fiid и Owner одинаковые, AutoKey разные)
  while( ds.MoveNext() )
    if( (OwnerList[OwnerList.size-1] != ds.Owner)
    or (FiidList[FiidList.size-1] != ds.Fiid)
    or (NumberList[NumberList.size-1] != ds.Number))
      if(not exists_dp_corpop(MonitorDate, KindPay, FiidList[FiidList.size-1], OwnerList[OwnerList.size-1], NumberList[NumberList.size-1]))
        st = DP_CreateCorpop(MonitorDate, KindPay, newopid, FiidList[FiidList.size-1], OwnerList[OwnerList.size-1], AutoKeyList, NumberList[NumberList.size-1]);
        if(st != 0)
          PT_PrintDebug( "ws_monitorexecution.mac.log", "Код ошибки: " + string(st));
        end;
      end;
	  // очищаем
      FiidList = TArray(); OwnerList = TArray();
      AutoKeyList = TArray(); NumberList = TArray();
    end;

    FiidList[FiidList.size] = ds.Fiid;
    OwnerList[OwnerList.size] = ds.Owner;
    AutoKeyList[AutoKeyList.size] = ds.AutoKey;
    NumberList[NumberList.size] = ds.Number;

    i = i + 1;
    UseProgress(i)
  end;
  if(FiidList.size > 0)
    if(not exists_dp_corpop(MonitorDate, KindPay, FiidList[FiidList.size-1], OwnerList[OwnerList.size-1], NumberList[NumberList.size-1]))
      st = DP_CreateCorpop(MonitorDate, KindPay, newopid, FiidList[FiidList.size-1], OwnerList[OwnerList.size-1], AutoKeyList, NumberList[NumberList.size-1]);
      if(st != 0)
        PT_PrintDebug( "ws_monitorexecution.mac.log", "Код ошибки: " + string(st));
      end;
    end;
  end;
  RemProgress();
  SetDialogFlag(1);

  str_where = " dpcorpop.t_Date = " + GetSQLDate(MonitorDate) + " AND dpcorpop.t_PaymentType = " + string(KindPay) + " AND dpcorpop.t_Oper = " + string({oper});
  // Отобразить скроллинг операций расчета выплат в депозитарии
  DP_BrowseCorpop(str_where);

  return stat;
end;


macro exec_dp_retires_coupon(EventsDate : string)
  return exec_dp_retires(Date(EventsDate), DP_CRPPAYMENTTYPE_COUPON);
end;

macro exec_dp_retires_partly(EventsDate : string)
  return exec_dp_retires(Date(EventsDate), DP_CRPPAYMENTTYPE_NOMINAL);
end;

macro exec_dp_retires_issue(EventsDate : string)
  return exec_dp_retires(Date(EventsDate), DP_CRPPAYMENTTYPE_ISSUE);
end;

macro exec_dp_retires_dividend(EventsDate : string)
  return exec_dp_retires(Date(EventsDate), DP_CRPPAYMENTTYPE_DIVIDENDS);
end;

/*События монитора. Проверки статуса КИ*/
macro ExecuteQIValidPeriod(MonitorDate)
  if( MonitorDate == null )
    RunError( "Не задан обязательный параметр функции: Дата монитора" );
  end;

  return ExecQIValidPeriodReport( Date( MonitorDate ) );
end;

// Создать FC с сообщением, если нет данных для обработки события
private macro CreateFCProcessedOp(filename:String, message)
   File protocol_file() txt WRITE;
   var FC;

   if( Open(protocol_file, filename) )
      SetOutPut(filename);
      println(message);
      SetOutput (NULL,TRUE);
      Close( filename );
      FC = CreateFileContainer(ConvertTxt2Html(filename));
      RemoveFile(filename);
      RemoveFile(filename + ".html");
   end;

   return FC;
end;

//строка с видами строк графика, относящимся к клиенту-контрагенту
private var CCTemplsStr = DLGR_TEMPL_DELIVERYCONTR + ", " +
                          DLGR_TEMPL_DELIVERYCONTR2 + ", " +
                          DLGR_TEMPL_COMPDELIVERYCONTR + ", " +
                          DLGR_TEMPL_PAYCOMCONTR;


// Проверить необходимость установки флага "Неттинг" в СО БУ
macro GetDefaultFlagNetting(MonitorDate) 
  var DataSet, cmd;
  var retval = false;

  cmd = DL_RSDCommand("select rsi_dlgr.RSI_GetDefaultFlagNetting(?) as DefaultFlagNetting from dual");
  cmd.AddParam(MonitorDate);

  DataSet = cmd.Execute();
  if((DataSet.moveNext()) and (DataSet.DefaultFlagNetting > 0))
    retval = true;
  end;

  return retval;
end;

// Проверить необходимость установки флага "Расчеты на бирже" в СО БУ
macro GetDefaultFlagCalcExchange(comm) 
  var DataSet, cmd;
  var retval = false;

  cmd = DL_RSDCommand("select rsi_dlgr.RSI_GetDefaultFlagCalcExchange(?,?,?,?,?,?,?) as DefaultFlagCalcExchange from dual");
  cmd.AddParam(comm.rec.CommDate);
  cmd.AddParam(comm.rec.ClientID);
  cmd.AddParam(comm.rec.ContractID);
  cmd.AddParam(comm.rec.AvoirKind);
  cmd.AddParam(comm.rec.FIID);
  cmd.AddParam(comm.rec.Currency);
  cmd.AddParam(IIF(comm.rec.Flag1 == SET_CHAR, 1, 0));

  DataSet = cmd.Execute();
  if((DataSet.moveNext()) and (DataSet.DefaultFlagCalcExchange > 0))
    retval = true;
  end;

  return retval;
end;

macro GetSQL_UnprocessedObjects_OpAcc(MonitorDate)
   return 
     " select distinct q.t_DealID t_DocID, q.t_BofficeKind t_DocKind, q.t_DealDate, q.t_DealCode, q.ClientID t_ClientID, RSB_SECUR.GetDealTypeName( q.t_DealType ) t_OprKindName, "
   + "                 q.FiCode, q.FiName, q.ClientCode, q.ClientName "
   + "   from (" 
   + "        (select /*+INDEX(gracc ddlgracc_dbt_idx1)*/ tk.t_ClientID ClientID, tk.t_DealID, tk.t_BofficeKind, tk.t_DealDate, tk.t_DealType, tk.t_DealCode, "
   + "                (SELECT t_fi_code FROM dfininstr_dbt WHERE  t_fiid = tk.t_PFI ) FiCode, "
   + "                (SELECT t_name FROM dfininstr_dbt WHERE  t_fiid = tk.t_PFI ) FiName, "
   + "                rsi_rsbparty.PT_GetPartyCode(tk.t_ClientID, " + PTCK_CONTR + ") ClientCode, "
   + "                (select t_Name from dparty_dbt where t_PartyID = tk.t_ClientID) ClientName "
   + "           from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
   + "          where grdeal.t_PlanDate = " + GetSQLDate(date(MonitorDate))
   + "            and grdeal.t_TemplNum NOT IN (" + CCTemplsStr + ")"
   + "            and grdeal.t_TemplNum <> " + DLGR_TEMPL_TRANSFER
   + "            and gracc.t_GrDealID = grdeal.t_ID "
   + "            and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
   + "            and gracc.t_State = " + DLGRACC_STATE_PLAN
   + "            and tk.t_DealID = grdeal.t_DocID "
   + "            and tk.t_BOfficeKind = grdeal.t_DocKind "
   + "            and tk.t_BOfficeKind IN (" + DL_SECURITYDOC + "," + DL_RETIREMENT + "," + DL_AVRWRT + ") "
   + "            and tk.t_Department = " + {NumDprt}
   + "        ) UNION "
   + "        (select /*+INDEX(gracc ddlgracc_dbt_idx1)*/ tk.t_PartyID ClientID, tk.t_DealID, tk.t_BofficeKind, tk.t_DealDate, tk.t_DealType, tk.t_DealCode, "
   + "                (SELECT t_fi_code FROM dfininstr_dbt WHERE  t_fiid = tk.t_PFI ) FiCode, "
   + "                (SELECT t_name FROM dfininstr_dbt WHERE  t_fiid = tk.t_PFI ) FiName, "
   + "                rsi_rsbparty.PT_GetPartyCode(tk.t_PartyID, " + PTCK_CONTR + ") ClientCode, "
   + "                (select t_Name from dparty_dbt where t_PartyID = tk.t_PartyID) ClientName "
   + "           from ddl_tick_dbt tk, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
   + "          where grdeal.t_PlanDate = " + GetSQLDate(date(MonitorDate))
   + "            and grdeal.t_TemplNum IN (" + CCTemplsStr + ")"
   + "            and grdeal.t_TemplNum <> " + DLGR_TEMPL_TRANSFER
   + "            and gracc.t_GrDealID = grdeal.t_ID "
   + "            and gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
   + "            and gracc.t_State = " + DLGRACC_STATE_PLAN
   + "            and tk.t_DealID = grdeal.t_DocID "
   + "            and tk.t_BOfficeKind = grdeal.t_DocKind "
   + "            and tk.t_BOfficeKind = " + DL_SECURITYDOC
   + "            and tk.t_IsPartyClient = 'X' "
   + "            and tk.t_Department = " + {NumDprt} +
   IIF(GetDefaultFlagNetting(MonitorDate), 
     "        ) UNION "
   + "        (SELECT "
   + "            ntg.t_Contractor ClientID, "
   + "            ntg.t_NettingID t_DealID, "
   + "            ntg.t_DocKind t_BofficeKind, "
   + "            ntg.t_SigningDate t_DealDate, "
   + "            ntg.t_Kind_Operation t_DealType, "
   + "            ntg.t_DealNumber t_DealCode, "
   + "            (CASE WHEN ntg.t_FI_Kind = 2 THEN (SELECT t_fi_code FROM dfininstr_dbt WHERE  t_fiid = ntg.t_BaseFIID) ELSE '' END ) FiCode, "
   + "            (CASE WHEN ntg.t_FI_Kind = 2 THEN (SELECT t_name FROM dfininstr_dbt WHERE  t_fiid = ntg.t_BaseFIID ) ELSE '' END ) FiName, "
   + "            rsi_rsbparty.PT_GetPartyCode(ntg.t_Contractor, " + PTCK_CONTR + ") ClientCode, "
   + "            (select t_Name from dparty_dbt where t_PartyID = ntg.t_Contractor) ClientName "
   + "           FROM ddl_nett_dbt ntg, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc "
   + "          WHERE grdeal.t_PlanDate = " + GetSQLDate(date(MonitorDate))
   + "            AND ntg.t_DocKind = grdeal.t_DocKind "
   + "            AND ntg.t_NettingID = grdeal.t_DocID "
   + "            AND ntg.t_Department = " + {NumDprt}
   + "            AND gracc.t_GrDealID = grdeal.t_ID "
   + "            AND gracc.t_AccNum = " + DLGR_ACCKIND_ACCOUNTING
   + "            AND gracc.t_State = " + DLGRACC_STATE_PLAN
   + "        )", " ) " ) 
   + "       ) q "
   + "  order by t_DealDate, t_DealCode, t_BofficeKind ";
end;

// СО БУ 
macro exec_OperationsAccounting(EventsDate)

   var query, ds, stat = 0, str_select = "", str_where = "", FC;
   var unprocessed_objects:integer = 0, unprocessed_operations_count:integer = 0;
   var comm = Tbfile("dl_comm", "W", 0);

   unprocessed_objects = SQL_GetNRecs(GetSQL_UnprocessedObjects_OpAcc(EventsDate));

   if( unprocessed_objects > 0 )
      comm.Clear();
      comm.rec.Oper         = {oper};
      comm.rec.DocKind      = DL_SCACCOUNTING;
      comm.rec.CommStatus   = DL_COMM_PREPARING;
      comm.rec.CommDate     = EventsDate;
      comm.rec.Division     = {NumDprt};
      comm.rec.ClientID     = UnknownParty;
      comm.rec.FIID         = ALLFININSTR;
      comm.rec.Currency     = ALLFININSTR;
      comm.rec.PartyID      = UnknownParty;
      comm.rec.IssuerID     = UnknownParty;
      comm.rec.NewFIID      = ALLFININSTR;
      comm.rec.Flag2        = IIF(GetDefaultFlagNetting(EventsDate), SET_CHAR, UNSET_CHAR);
      comm.rec.Flag4        = IIF(GetDefaultFlagCalcExchange(comm), SET_CHAR, UNSET_CHAR);
      comm.rec.CreateReport = SET_CHAR;
 
      str_select =
              " SELECT "
            + "   comm.t_DocumentID "
            + " FROM "
            + "   DDL_COMM_DBT comm "
            + " WHERE "
            + "       comm.t_DocKind = " + string(DL_SCACCOUNTING)
            + "   AND comm.t_CommStatus = " + string(DL_COMM_PREPARING)
            + "   AND comm.t_CommDate = " + GetSQLDate(EventsDate)
            + "   AND comm.t_Division = " + string({NumDprt})
            + "   AND comm.t_ClientID = -1 "
            + "   AND comm.t_ContractID = 0 "
            + "   AND comm.t_AvoirKind = 0 "
            + "   AND comm.t_Fiid = -1 "
            + "   AND comm.t_Currency = -1 "
            + "   AND comm.t_Flag1 = chr(0) "
            + "   AND comm.t_Flag2 = " + IIF(comm.rec.Flag2 == SET_CHAR, "chr(88)", "chr(0)") 
            + "   AND comm.t_Flag3 = chr(0) "
            + "   AND comm.t_Flag4 = " + IIF(comm.rec.Flag4 == SET_CHAR, "chr(88)", "chr(0)") 
            + "   AND comm.t_CreateReport = chr(88) ";

      unprocessed_operations_count = SQL_GetNRecs(str_select);

      if( unprocessed_operations_count > 0 )
         str_where = "0";

         query = RSDCommand( str_select );
         query.execute();

         ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
         if( ds.MoveNext() )
            str_where = string(ds.DocumentID);
         end;
      else
         comm.rec.CommCode     = GetCommCodeNewByPrm(RCB_OBJTYPE_SECURSERVOP, RCB_REFOBJ_SVOP_SCACCOUNTING );

         stat = SC_CreateDlCommOperation( comm );

         if( stat == 0 )
            str_where = string(comm.rec.DocumentID);
         end;
      end;

      if( stat == 0 )
         // Отобразить скроллинг СО БУ
         //stat = SC_BrowseServOper(DL_SCACCOUNTING, str_where);

         stat = SC_ServOperExecuteSilent( DL_SCACCOUNTING, Int(str_where) );

         var CommData = TRsbDataSet( "SELECT * FROM ddl_comm_dbt WHERE t_DocumentID = " + str_where );
         var dl_comm = TRecHandler("dl_comm.dbt");

         if( CommData.MoveNext() )
            CommData.GetRecord().CopyTo( dl_comm.rec );

            FC = ExecMacroFile("scstartacc.mac", "WebPrintAccountingByXML", dl_comm, DL_OUTREPORT_STD);
         end;
      end;
   end;

   // Если не было данных для обработки
   if( (stat == 0) and (FC == null) )
      FC = CreateFCProcessedOp(string("..\\txtfile\\svop_inacc.",UserNumber), "Для события <Бухгалтерский учет> нет данных для обработки.");
   end;

   //return stat;
   return FC;
end;

macro GetSQL_UnprocessedObjects_OpInAcc(MonitorDate)
   return 
     " SELECT DISTINCT "
   + "        td.t_DocID, "
   + "        td.t_DealCode, "
   + "        td.t_DocKind, "
   + "        td.t_DealDate, "
   + "        td.t_ClientID, "
   + "        RSB_SECUR.GetDealTypeName( td.t_Kind_Operation ) t_OprKindName, "
   + "        (SELECT t_fi_code FROM dfininstr_dbt WHERE t_fiid = td.t_PFI) FiCode, "
   + "        (SELECT t_name FROM dfininstr_dbt WHERE t_fiid = td.t_PFI) FiName, "
   + "        rsi_rsbparty.PT_GetPartyCode (td.t_ClientID, " + PTCK_CONTR + ") ClientCode, "
   + "        (SELECT t_Name FROM dparty_dbt WHERE t_PartyID = td.t_ClientID) ClientName "
   + " FROM "
   + "        dv_sctotaldeals td, "
   + "        ddlgrdeal_dbt grdeal, "
   + "        ddlgracc_dbt gracc_inn, " 
   + "        ddlgracc_dbt gracc_bo "
   + " WHERE "
   + "            td.t_Department = " + {NumDprt}
   + "        AND grdeal.t_DocKind = td.t_DocKind "
   + "        AND grdeal.t_DocID = td.t_DocID "
   + "        AND grdeal.t_PlanDate = " + GetSQLDate(date(MonitorDate))
   + "        AND gracc_inn.t_GrDealID = grdeal.t_ID "
   + "        AND gracc_inn.t_AccNum = " + DLGR_ACCKIND_INNER
   + "        AND gracc_inn.t_State = " + DLGRACC_STATE_PLAN
   + "        AND gracc_bo.t_GrDealID = grdeal.t_ID "
   + "        AND gracc_bo.t_AccNum = " + DLGR_ACCKIND_BACKOFFICE
   + "        AND gracc_bo.t_State IN (" + DLGRACC_STATE_NOTNEED + ", " + DLGRACC_STATE_FACTEXEC + ") "
   + "        AND (   td.t_DocKind = " + DL_NTGSEC
   + "             OR (    td.t_DocKind <> " + DL_NTGSEC
   + "                 AND Exists (SELECT 1 FROM ddl_leg_dbt LEG "
   + "                              WHERE LEG.T_DEALID = td.T_DOCID "
   + "                                AND LEG.T_LEGKIND = " + LEG_KIND_DL_TICK
   + "                                AND LEG.T_LEGID = 0 "
   + "                                AND LEG.T_OPERSTATE > " + DL_LEG_PREPARING
   + "                            ) "
   + "                )"
   + "            ) "
   + " ORDER BY td.t_DealDate, td.t_DealCode, td.t_DocKind ";
end;

// СО ВУ 
macro exec_OperationsInAccounting(EventsDate)

   var query, ds, stat = 0, str_select = "", str_where = "", FC;
   var unprocessed_objects:integer = 0, unprocessed_operations_count:integer  = 0;
   var comm = Tbfile("dl_comm", "W", 0);

   unprocessed_objects = SQL_GetNRecs(GetSQL_UnprocessedObjects_OpInAcc(EventsDate));

   if( unprocessed_objects > 0 )
      str_select =
              " SELECT "
            + "   comm.t_DocumentID "
            + " FROM "
            + "   DDL_COMM_DBT comm "
            + " WHERE "
            + "       comm.t_DocKind = " + string(DL_INACCSRVOP)
            + "   AND comm.t_CommStatus = " + string(DL_COMM_PREPARING)
            + "   AND comm.t_CommDate = " + GetSQLDate(EventsDate)
            + "   AND comm.t_Division = " + string({NumDprt})
            + "   AND comm.t_OperationKind = 0 "
            + "   AND comm.t_AvoirKind = 0 "
            + "   AND comm.t_Fiid = -1 "
            + "   AND comm.t_ContractKind = -1 "
            + "   AND comm.t_OperSubKind = 0 "
            + "   AND comm.t_Deal1 = 0 "
            + "   AND comm.t_ClientID = -1 "
            + "   AND comm.t_ContractID = 0 "
            + "   AND comm.t_Flag1 = chr(0) "
            + "   AND comm.t_CreateReport = chr(88) ";

      unprocessed_operations_count = SQL_GetNRecs(str_select);

      if( unprocessed_operations_count > 0 )
         str_where = "0";

         query = RSDCommand( str_select );
         query.execute();

         ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
         if( ds.MoveNext() )
            str_where = string(ds.DocumentID);
         end;
      else
         comm.Clear();
         
         comm.rec.CommCode     = GetCommCodeNewByPrm(RCB_OBJTYPE_SECURSERVOP, RCB_REFOBJ_SVOP_INACCSRVOP );
         comm.rec.DocKind      = DL_INACCSRVOP;
         comm.rec.Oper         = {oper};
         comm.rec.ClientID     = UnknownParty;
         comm.rec.CommDate     = EventsDate;
         comm.rec.CommStatus   = DL_COMM_PREPARING;
         comm.rec.FIID         = ALLFININSTR;
         comm.rec.PartyID      = UnknownParty;
         comm.rec.IssuerID     = UnknownParty;
         comm.rec.Division     = {NumDprt};
         comm.rec.NewFIID      = ALLFININSTR;
         comm.rec.ContractKind = SP_SECDEALTYPE_ALL;
         comm.rec.CreateReport = SET_CHAR;

         stat = SC_CreateDlCommOperation( comm );

         if( stat == 0 )
            str_where = string(comm.rec.DocumentID);
         end;
      end;

      if( stat == 0 )
         // Отобразить скроллинг СО ВУ
         //stat = SC_BrowseServOper(DL_INACCSRVOP, str_where);

         stat = SC_ServOperExecuteSilent( DL_INACCSRVOP, Int(str_where) );

         var CommData = TRsbDataSet( "SELECT * FROM ddl_comm_dbt WHERE t_DocumentID = " + str_where );
         var dl_comm = TRecHandler("dl_comm.dbt");

         if( CommData.MoveNext() )
            CommData.GetRecord().CopyTo( dl_comm.rec );

            FC = ExecMacroFile("scstartcnv.mac", "WebPrintInAccByXML", dl_comm, DL_OUTREPORT_STD);
         end;
      end;
   end;
   // Если не было данных для обработки
   if( (stat == 0) and (FC == null) )
      FC = CreateFCProcessedOp(string("..\\txtfile\\svop_inacc.",UserNumber), "Для события <Внутренний учет> нет данных для обработки.");
   end;

   //return stat;
   return FC;
end;

macro GetSQL_UnprocessedObjects_OpDepAcc(MonitorDate)
   return 
     " SELECT DISTINCT "
   + "        td.t_DocID, "
   + "        td.t_DealCode, "
   + "        td.t_DocKind, "
   + "        td.t_DealDate, "
   + "        td.t_ClientID, "
   + "        RSB_SECUR.GetDealTypeName( td.t_Kind_Operation ) t_OprKindName, "
   + "        (SELECT t_fi_code FROM dfininstr_dbt WHERE t_fiid = td.t_PFI) FiCode, "
   + "        (SELECT t_name FROM dfininstr_dbt WHERE t_fiid = td.t_PFI) FiName, "
   + "        rsi_rsbparty.PT_GetPartyCode (td.t_ClientID, " + PTCK_CONTR + ") ClientCode, "
   + "        (SELECT t_Name FROM dparty_dbt WHERE t_PartyID = td.t_ClientID) ClientName "
   + " FROM "
   + "        dv_sctotaldeals td, "
   + "        ddlgrdeal_dbt grdeal, "
   + "        ddlgracc_dbt gracc " 
   + " WHERE "
   + "            gracc.t_GrDealID = grdeal.t_ID "
   + "        AND grdeal.t_PlanDate = " + GetSQLDate(date(MonitorDate))
   + "        AND gracc.t_AccNum = " + DLGR_ACCKIND_CUSTODY
   + "        AND gracc.t_State = " + DLGRACC_STATE_PLAN
   + "        AND td.t_DocID = grdeal.t_DocID "
   + "        AND td.t_DocKind = grdeal.t_DocKind "
   + "        AND td.t_DocKind IN (" + DL_SECURITYDOC + "," + DL_RETIREMENT + "," + DL_AVRWRT + ", " + DL_NTGSEC + ") "
   + "        AND td.t_Department = " + {NumDprt}
   + " ORDER BY td.t_DealDate, td.t_DealCode, td.t_DocKind ";
end;

// СО ДУ 
macro exec_OperationsDepAccounting(EventsDate)

   var query, ds, stat = 0, str_select = "", str_where = "", FC;
   var unprocessed_objects:integer = 0, unprocessed_operations_count:integer  = 0;
   var comm = Tbfile("dl_comm", "W", 0);

   unprocessed_objects = SQL_GetNRecs(GetSQL_UnprocessedObjects_OpDepAcc(EventsDate));

   if( unprocessed_objects > 0 )
      str_select =
              " SELECT "
            + "   comm.t_DocumentID "
            + " FROM "
            + "   DDL_COMM_DBT comm "
            + " WHERE "
            + "       comm.t_DocKind = " + string(DL_DEPOACCSRVOP)
            + "   AND comm.t_CommStatus = " + string(DL_COMM_PREPARING)
            + "   AND comm.t_CommDate = " + GetSQLDate(EventsDate)
            + "   AND comm.t_Division = " + string({NumDprt})
            + "   AND comm.t_Deal1 = 0 "
            + "   AND comm.t_OperSubKind = 0 "
            + "   AND comm.t_MarketSchemeID = 0 "
            + "   AND comm.t_ClientID = -1 "
            + "   AND comm.t_ContractID = 0 "
            + "   AND comm.t_CreateReport = chr(88) ";

      unprocessed_operations_count = SQL_GetNRecs(str_select);

      if( unprocessed_operations_count > 0 )
         str_where = "0";

         query = RSDCommand( str_select );
         query.execute();

         ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
         if( ds.MoveNext() )
            str_where = string(ds.DocumentID);
         end;
      else
         comm.Clear();
         
         comm.rec.CommCode     = GetCommCodeNewByPrm(RCB_OBJTYPE_SECURSERVOP, RCB_REFOBJ_SVOP_DEPOSRVOP );
         comm.rec.DocKind      = DL_DEPOACCSRVOP;
         comm.rec.Oper         = {oper};
         comm.rec.ClientID     = UnknownParty;
         comm.rec.CommDate     = EventsDate;
         comm.rec.CommStatus   = DL_COMM_PREPARING;
         comm.rec.FIID         = ALLFININSTR;
         comm.rec.PartyID      = UnknownParty;
         comm.rec.IssuerID     = UnknownParty;
         comm.rec.Division     = {NumDprt};
         comm.rec.NewFIID      = ALLFININSTR;
         comm.rec.CreateReport = SET_CHAR;

         stat = SC_CreateDlCommOperation( comm );

         if( stat == 0 )
            str_where = string(comm.rec.DocumentID);
         end;
      end;

      if( stat == 0 )
         // Отобразить скроллинг СО ДУ
         //stat = SC_BrowseServOper(DL_DEPOACCSRVOP, str_where);

         stat = SC_ServOperExecuteSilent( DL_DEPOACCSRVOP, Int(str_where) );

         var CommData = TRsbDataSet( "SELECT * FROM ddl_comm_dbt WHERE t_DocumentID = " + str_where );
         var dl_comm = TRecHandler("dl_comm.dbt");

         if( CommData.MoveNext() )
            CommData.GetRecord().CopyTo( dl_comm.rec );

            FC = ExecMacroFile("scstartdepo.mac", "WebPrintDepoByXML", dl_comm, DL_OUTREPORT_STD);
         end;
      end;
   end;

   // Если не было данных для обработки
   if( (stat == 0) and (FC == null) )
      FC = CreateFCProcessedOp(string("..\\txtfile\\svop_inacc.",UserNumber), "Для события <Отправка поручений в депозитарий> нет данных для обработки.");
   end;

   //return stat;
   return FC;
end;

macro GetSQL_UnprocessedObjects_OpOverValue(MonitorDate)
   return 
     " SELECT "
   + "        fin.t_FIID, "
   + "        fin.t_FI_Code, "
   + "        fin.t_Name, "
   + "        (CASE "
   + "            WHEN ( (SELECT COUNT (1) AS ExistsOvervl "
   + "                      FROM DOPRSTEP_DBT oprstep, "
   + "                           DOPROPER_DBT oproper, "
   + "                           DDL_COMM_DBT comm "
   + "                     WHERE oproper.t_DocKind = " + DLDOC_ISSUE
   + "                           AND oproper.t_DocumentID = LPAD (TO_CHAR (fin.t_FIID), 34, '0') "
   + "                           AND oprstep.t_ID_operation = oproper.t_ID_operation "
   + "                           AND oprstep.t_IsExecute = 'X' "
   + "                           AND oprstep.t_ServDocKind = " + DL_OVERVALUE
   + "                           AND oprstep.t_ServDocKind = comm.t_DocKind "
   + "                           AND oprstep.t_ServDocID = comm.t_DocumentID "
   + "                           AND comm.t_CommDate >= " + GetSQLDate(date(MonitorDate)) + ") = 1) "
   + "            THEN "
   + "               0 "
   + "            ELSE "
   + "               CASE "
   + "                  WHEN RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_TRADE + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0 "
   + "                       AND (SELECT NVL (SUM (ROUND (L.T_OVERCHANGE, 2)), 0) "
   + "                              FROM DPMWRTLNK_DBT L, "
   + "                                   DPMWRTSUM_DBT B, "
   + "                                   DPMWRTSUM_DBT S "
   + "                             WHERE L.T_CREATEDATE = " + GetSQLDate(date(MonitorDate))
   + "                                   AND L.T_KIND IN (10, 60, 20, 50) " // PMWRTLINK_KIND_DISCARD, PMWRTLINK_KIND_DISCARDBD, PMWRTLINK_KIND_RETISSUE, PMWRTLINK_KIND_PORTFOLIO
   + "                                   AND S.T_SUMID = L.T_SALEID "
   + "                                   AND B.T_SUMID = L.T_BUYID "
   + "                                   AND S.T_KIND NOT IN (200, 290, 240) " // WRTSUM_KIND_RRWAS1, WRTSUM_KIND_RRAS1, WRTSUM_KIND_LPS
   + "                                   AND S.T_DEPARTMENT = " + {NumDprt}
   + "                                   AND S.T_FIID = fin.t_FIID "
   + "                                   AND S.T_PARTY = -1 "
   + "                                   AND B.T_PORTFOLIO = " + KINDPORT_TRADE
   + "                                   AND S.T_CONTRACT = 0) = 0 "
   + "                  THEN "
   + "                     CASE "
   + "                        WHEN rsi_rsb_fiinstr.FI_ExistNOSS (fin.T_FIID, " + GetSQLDate(date(MonitorDate)) + ", 27) = 0 "
   + "                             OR (    (RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_SALE + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0) "
   + "                                 AND  (RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_BACK + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0) "
   + "                                 AND  (RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_BASICDEBT + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0)) THEN 0 "
   + "                        ELSE 1 "
   + "                     END "
   + "                  ELSE "
   + "                     1 "
   + "               END "
   + "         END) "
   + "           t_NEED_OVERVALUE_PAPERS "
   + " FROM "
   + "        davoiriss_dbt avr, "
   + "        dfininstr_dbt fin, "
   + "        davrkinds_dbt avrkind " 
   + " WHERE "
   + "            fin.t_FIID = avr.t_FIID "
   + "        AND avrkind.t_AvoirKind = fin.t_AvoirKind "
   + "        AND avrkind.t_Fi_Kind = fin.t_Fi_Kind "
   + "        AND fin.t_Fi_Kind = " + FIKIND_AVOIRISS
   + "        AND fin.t_AvoirKind != " + AVOIRISSKIND_BASKET
   + "        AND avrkind.t_IsIndividual != CHR(88) "
   + "        AND RSB_FIINSTR.FI_GETSTATUS (fin.t_FIID, " + GetSQLDate(date(MonitorDate)) + ") = " + FI_STATE_INCIRCULATION
   + "        AND " + IIF( CheckTaxDepositoryMode(), " fin.t_IsClosed != CHR(88) ", " avr.t_SPIsClosed != CHR(88) " )
   + "        AND ( (CASE "
   + "               WHEN rsi_rsb_fiinstr.FI_ExistNOSS (fin.T_FIID, " + GetSQLDate(date(MonitorDate)) + ", 27) = 1 "
   + "               THEN "
   + "                  CASE "
   + "                     WHEN (EXISTS "
   + "                              (SELECT L.t_SumID "
   + "                                 FROM dpmwrtsum_dbt L "
   + "                                WHERE     L.t_Department = " + {NumDprt}
   + "                                      AND L.t_Party = -1 "
   + "                                      AND L.t_Contract = 0 "
   + "                                      AND L.t_Buy_Sale IN (" + PM_WRITEOFF_SUM_BUY + "," + PM_WRITEOFF_SUM_SALE + ") "
   + "                                      AND L.t_EnterDate <= " + GetSQLDate(date(MonitorDate))
   + "                                      AND L.t_FIID = fin.t_FIID "
   + "                                      AND L.t_AmountBD > 0 "
   + "                                      AND L.t_State = " + PM_WRTSUM_NOTFORM
   + "                                      AND L.t_Date >= " + GetSQLDate(date(MonitorDate)) + ")) "
   + "                          OR (EXISTS "
   + "                                 (SELECT L.t_SumID "
   + "                                    FROM dpmwrtsum_dbt L, "
   + "                                         dpmwrtbc_dbt B "
   + "                                   WHERE     L.t_Department = " + {NumDprt}
   + "                                         AND L.t_Party = -1 "
   + "                                         AND L.t_Contract = 0 "
   + "                                         AND L.t_Buy_Sale IN (" + PM_WRITEOFF_SUM_BUY + "," + PM_WRITEOFF_SUM_SALE + ") "
   + "                                         AND L.t_EnterDate <= " + GetSQLDate(date(MonitorDate))
   + "                                         AND L.t_ChangeDate >= " + GetSQLDate(date(MonitorDate))
   + "                                         AND B.t_FIID = fin.t_FIID "
   + "                                         AND B.t_SumID = L.t_SumID "
   + "                                         AND B.t_AmountBD > 0 "
   + "                                         AND B.t_State = " + PM_WRTSUM_NOTFORM
   + "                                         AND B.t_Date >= " + GetSQLDate(date(MonitorDate)) + ")) "
   + "                     THEN "
   + "                        1 "
   + "                     ELSE "
   + "                        0 "
   + "                  END "
   + "               ELSE "
   + "                  0 "
   + "            END) = 1 "
   + "          OR (CASE "
   + "              WHEN (SELECT COUNT (1) AS ExistsOvervl "
   + "                 FROM DOPRSTEP_DBT oprstep, "
   + "                   DOPROPER_DBT oproper, "
   + "                   DDL_COMM_DBT comm "
   + "             WHERE oproper.t_DocKind = " + DLDOC_ISSUE
   + "                   AND oproper.t_DocumentID = LPAD (TO_CHAR (fin.t_FIID), 34, '0') "
   + "                   AND oprstep.t_ID_operation = oproper.t_ID_operation "
   + "                   AND oprstep.t_IsExecute = 'X' "
   + "                   AND oprstep.t_ServDocKind = " + DL_OVERVALUE
   + "                   AND oprstep.t_ServDocKind = comm.t_DocKind "
   + "                   AND oprstep.t_ServDocID = comm.t_DocumentID "
   + "                   AND comm.t_CommDate >= " + GetSQLDate(date(MonitorDate)) + ") = 1 "
   + "              THEN "
   + "                 0 "
   + "              ELSE "
   + "                 CASE "
   + "                    WHEN RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_TRADE + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0 "
   + "                         AND (SELECT NVL ( "
   + "                                        SUM (ROUND (L.T_OVERCHANGE, 2)), "
   + "                                        0) "
   + "                                FROM DPMWRTLNK_DBT L, "
   + "                                     DPMWRTSUM_DBT B, "
   + "                                     DPMWRTSUM_DBT S "
   + "                               WHERE L.T_CREATEDATE = " + GetSQLDate(date(MonitorDate))
   + "                                     AND L.T_KIND IN (10, 60, 20, 50) " // PMWRTLINK_KIND_DISCARD, PMWRTLINK_KIND_DISCARDBD, PMWRTLINK_KIND_RETISSUE, PMWRTLINK_KIND_PORTFOLIO
   + "                                     AND S.T_SUMID = L.T_SALEID "
   + "                                     AND B.T_SUMID = L.T_BUYID "
   + "                                     AND S.T_KIND NOT IN (200, 290, 240) " // WRTSUM_KIND_RRWAS1, WRTSUM_KIND_RRAS1, WRTSUM_KIND_LPS
   + "                                     AND S.T_DEPARTMENT = " + {NumDprt}
   + "                                     AND S.T_FIID = fin.t_FIID "
   + "                                     AND S.T_PARTY = -1 "
   + "                                     AND B.T_PORTFOLIO = " + KINDPORT_TRADE
   + "                                     AND S.T_CONTRACT = 0) = 0 "
   + "                    THEN "
   + "                       CASE "
   + "                          WHEN rsi_rsb_fiinstr.FI_ExistNOSS (fin.T_FIID, " + GetSQLDate(date(MonitorDate)) + ", 27) = 0 "
   + "                               OR (    (RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_SALE + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0) "
   + "                                   AND (RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_BACK + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0) "
   + "                                   AND (RSB_PMWRTOFF.WRTGetPortfolioAmount (" + {NumDprt} + ", fin.t_FIID, -1, 0, " + KINDPORT_BASICDEBT + ", -1, " + GetSQLDate(date(MonitorDate)) + ", 1, 0, 1) = 0)) "
   + "                         THEN "
   + "                                  0 "
   + "                          ELSE 1 "
   + "                       END "
   + "                    ELSE "
   + "                       1 "
   + "                 END "
   + "              END) = 1) "
   + " ORDER BY fin.t_FI_Code ";
end;

// СО ТСС 
macro exec_OperationsOverValue(EventsDate)

   var query, ds, stat = 0, str_select = "", str_where = "", FC;
   var unprocessed_objects:integer = 0, unprocessed_operations_count:integer  = 0;
   var comm = Tbfile("dl_comm", "W", 0);

    unprocessed_objects = SQL_GetNRecs(GetSQL_UnprocessedObjects_OpOverValue(EventsDate));

   if( unprocessed_objects > 0 )
      str_select =
              " SELECT "
            + "   comm.t_DocumentID "
            + " FROM "
            + "   DDL_COMM_DBT comm "
            + " WHERE "
            + "       comm.t_DocKind = " + string(DL_OVERVALUE)
            + "   AND comm.t_CommStatus = " + string(DL_COMM_PREPARING)
            + "   AND comm.t_CommDate = " + GetSQLDate(EventsDate)
            + "   AND comm.t_Division = " + string({NumDprt})
            + "   AND comm.t_OperSubKind = " + SC_OVERVALUE_ALL
            + "   AND comm.t_ClientID = -1 "
            + "   AND comm.t_ContractID = -1 "
            + "   AND comm.t_AvoirKind = 0 "
            + "   AND comm.t_Fiid = -1 "
            + "   AND comm.t_Flag1 = chr(88) "
            + "   AND comm.t_Flag2 = chr(0) "
            + "   AND comm.t_Flag3 = chr(0) "
            + "   AND comm.t_Flag4 = chr(0) "
            + "   AND comm.t_Flag5 = chr(88) "
            + "   AND comm.t_Flag6 = chr(0) "
            + "   AND comm.t_CreateReport = chr(88) ";

      unprocessed_operations_count = SQL_GetNRecs(str_select);

      if( unprocessed_operations_count > 0 )
         str_where = "0";

         query = RSDCommand( str_select );
         query.execute();

         ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
         if( ds.MoveNext() )
            str_where = string(ds.DocumentID);
         end;
      else
         comm.Clear();

         comm.rec.CommCode     = GetCommCodeNewByPrm(RCB_OBJTYPE_SECURSERVOP, RCB_REFOBJ_SVOP_OVERVALUE );
         comm.rec.DocKind      = DL_OVERVALUE;
         comm.rec.Oper         = {oper};
         comm.rec.Division     = {NumDprt};
         comm.rec.OperSubKind  = SC_OVERVALUE_ALL;
         comm.rec.ClientID     = UnknownParty;
         comm.rec.ContractID   = UnknownParty;
         comm.rec.CommDate     = EventsDate;
         comm.rec.CommStatus   = DL_COMM_PREPARING;
         comm.rec.FIID         = ALLFININSTR;
         comm.rec.PartyID      = UnknownParty;
         comm.rec.IssuerID     = UnknownParty;
         comm.rec.Currency     = ALLFININSTR;
         comm.rec.CreateReport = SET_CHAR;
         comm.rec.Flag1        = SET_CHAR;
         comm.rec.Flag5        = SET_CHAR;

         stat = SC_CreateDlCommOperation( comm );

         if( stat == 0 )
            str_where = string(comm.rec.DocumentID);
         end;
      end;

      if( stat == 0 )
         // Отобразить скроллинг СО ТСС
         //stat = SC_BrowseServOper(DL_OVERVALUE, str_where);

         stat = SC_ServOperExecuteSilent( DL_OVERVALUE, Int(str_where) );
         
         var CommData = TRsbDataSet( "SELECT * FROM ddl_comm_dbt WHERE t_DocumentID = " + str_where );
         var dl_comm = TRecHandler("dl_comm.dbt");

         if( CommData.MoveNext() )
            CommData.GetRecord().CopyTo( dl_comm.rec );

            var ptr = GetMemAddrFrom(dl_comm);
            FC = ExecMacroFile("spordres.mac", "WebPrintSvOpByXML", ptr);   
         end;
      end;
   end;

   // Если не было данных для обработки
   if( (stat == 0) and (FC == null) )
      FC = CreateFCProcessedOp(string("..\\txtfile\\svop_inacc.",UserNumber), "Для события <Переоценка ТСС> нет данных для обработки.");
   end;

   //return stat;
   return FC;
end;

macro GetSQL_UnprocessedObjects_OpOverValueNVPI(MonitorDate)
   return 
     " SELECT "
   + "        d.t_DealID DealID, "
   + "        d.t_dealCode, "
   + "        d.t_BofficeKind DocKind, "
   + "        d.t_DealDate, "
   + "        OperData.OperGroup "
   + "   FROM "
   + "        ddl_tick_dbt d, "
   + "        (SELECT oper.t_Kind_Operation, "
   + "                oper.t_DocKind, "
   + "                rsb_secur.get_OperationGroup (oper.t_SysTypes) AS OperGroup "
   + "           FROM doprkoper_dbt oper) OperData "
   + "  WHERE     d.t_BofficeKind = " + DL_SECURITYDOC
   + "        AND d.t_DealStatus = " + DL_READIED
   + "        AND d.t_DealDate <= " + GetSQLDate(date(MonitorDate))
   + "        AND OperData.t_Kind_Operation = d.t_DealType "
   + "        AND OperData.t_DocKind = d.t_BOfficeKind "
   + "        AND Rsb_Secur.IsRet_Coupon (OperData.OperGroup) != 1 "
   + "        AND d.t_ClientID = -1 "
   + "        AND EXISTS "
   + "               (SELECT 1 "
   + "                  FROM ddl_leg_dbt leg "
   + "                 WHERE     leg.t_DealID = d.t_DealID "
   + "                       AND leg.t_LegKind = 0 "
   + "                       AND leg.t_CFI <> " + NATCUR + ") "
/*
   + " UNION "
   + " SELECT "
   + "        nett.t_NettingID DealID, "
   + "        nett.t_DealNumber t_dealCode, "
   + "        nett.t_DocKind DocKind, "
   + "        nett.t_SigningDate  t_DealDate, "
   + "        0 OperGroup "
   + " FROM "
   + "     DDL_NETT_DBT nett "
   + " WHERE "
   + "         nett.t_IdentProgram = 14 " // !??
   + "     AND nett.t_DocKind = " + DL_NTGSEC
   + "     AND nett.t_Status = " + 10 // NTG_OPEN
   + "     AND nett.t_FI_KIND = " + FIKIND_CURRENCY
*/
   + " ORDER BY t_DealDate, DocKind ";
end;

// СО НВПИ 
macro exec_OperationsOverValueNVPI(EventsDate)

   var query, ds, stat = 0, str_select = "", str_where = "", FD, FD2, ErrCode, RegValue, Flag2 = false, NeedExecute = false, FC;
   var unprocessed_objects:bool = false, unprocessed_operations_count:integer  = 0;
   var comm = Tbfile("dl_comm", "W", 0);
   Flag2 = true;

   query = RSDCommand( GetSQL_UnprocessedObjects_OpOverValueNVPI(EventsDate) );
   query.execute();

   ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
   while( ds.MoveNext() )
      if( ds.DocKind == DL_SECURITYDOC )
         FD = SPFirstDoc( ds.DocKind, ds.DealID );
         if(FD.ExistBack)
            FD2 = SPFirstDoc( LEG_KIND_DL_TICK_BACK, ds.DealID );
         end;

         if( SP_DealNeedOverValueNVPI( EventsDate, FD.tick ) != 0 )
            NeedExecute = false;
         else
            NeedExecute = true;
         end;

         if( (Flag2 == true) and (NeedExecute == false) )
            if( SP_RepoNeedOverValueNVPI( EventsDate, FD.tick ) != 0 )
               NeedExecute = false;
            else
               NeedExecute = true;
            end;
         end;

         if( not NeedExecute )
            continue;
         end;

         unprocessed_objects = true;
         break;
      elif( ds.DocKind == DL_NTGSEC )
         FD = DL_NettingDoc( ds.DocKind, ds.DealID );
   
         if( SP_NtgNeedOvervalueNVPI( EventsDate, FD.dl_nett() ) != 0 )
            continue;
         end;

         unprocessed_objects = true;
         break;
      end;
   end;

   if( unprocessed_objects == true )
      str_select =
              " SELECT "
            + "   comm.t_DocumentID "
            + " FROM "
            + "   DDL_COMM_DBT comm "
            + " WHERE "
            + "       comm.t_DocKind = " + string(DL_OVERVALUE_NVPI)
            + "   AND comm.t_CommStatus = " + string(DL_COMM_PREPARING)
            + "   AND comm.t_CommDate = " + GetSQLDate(EventsDate)
            + "   AND comm.t_Division = " + string({NumDprt})
            + "   AND comm.t_Flag2 = " + IIF( Flag2, "chr(88)", "chr(0)" )
            + "   AND comm.t_Flag3 = chr(88) "
            + "   AND comm.t_Flag4 = chr(0) "
            + "   AND comm.t_CreateReport = chr(88) ";

      unprocessed_operations_count = SQL_GetNRecs(str_select);

      if( unprocessed_operations_count > 0 )
         str_where = "0";

         query = RSDCommand( str_select );
         query.execute();

         ds = TRsbDataSet(query, RSDVAL_CLIENT, RSDVAL_STATIC);
         if( ds.MoveNext() )
            str_where = string(ds.DocumentID);
         end;
      else
         comm.Clear();

         comm.rec.CommCode     = GetCommCodeNewByPrm(RCB_OBJTYPE_SECURSERVOP, RCB_REFOBJ_SVOP_OVERVALUE_NVPI );
         comm.rec.DocKind      = DL_OVERVALUE_NVPI;
         comm.rec.Oper         = {oper};
         comm.rec.Division     = {NumDprt};
         comm.rec.ClientID     = UnknownParty;
         comm.rec.ContractID   = UnknownParty;
         comm.rec.CommDate     = EventsDate;
         comm.rec.CommStatus   = DL_COMM_PREPARING;
         comm.rec.FIID         = ALLFININSTR;
         comm.rec.PartyID      = UnknownParty;
         comm.rec.IssuerID     = UnknownParty;
         comm.rec.Currency     = ALLFININSTR;
         comm.rec.CreateReport = SET_CHAR;
         comm.rec.Flag2        = IIF(Flag2, SET_CHAR, UNSET_CHAR);
         comm.rec.Flag3        = SET_CHAR;
         comm.rec.Flag4        = SET_CHAR;

         stat = SC_CreateDlCommOperation( comm );

         if( stat == 0 )
            str_where = string(comm.rec.DocumentID);
         end;
      end;

      if( stat == 0 )
         // Отобразить скроллинг СО НВПИ
         //stat = SC_BrowseServOper(DL_OVERVALUE_NVPI, str_where);

         stat = SC_ServOperExecuteSilent( DL_OVERVALUE_NVPI, Int(str_where) );

         var CommData = TRsbDataSet( "SELECT * FROM ddl_comm_dbt WHERE t_DocumentID = " + str_where );
         var dl_comm = TRecHandler("dl_comm.dbt");

         if( CommData.MoveNext() )
            CommData.GetRecord().CopyTo( dl_comm.rec );

            var ptr = GetMemAddrFrom(dl_comm);
            FC = ExecMacroFile("spordres.mac", "WebPrintSvOpByXML", ptr);   
         end;
      end;
   end;

   // Если не было данных для обработки
   if( (stat == 0) and (FC == null) )
      FC = CreateFCProcessedOp(string("..\\txtfile\\svop_inacc.",UserNumber), "Для события <Переоценка НВПИ> нет данных для обработки.");
   end;

   //return stat;
   return FC;
end;